<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5877669">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5877724">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5877778">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5877829">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="5877898">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="5877912">//</span><br>
<span class="lineno"></span><span class="comment" id="5877915">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="5877986">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="5878047">//</span><br>
<span class="lineno"></span><span class="comment" id="5878050">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5878099">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="5878131">package</span>&nbsp;<span class="ident" id="5878139">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5878144">import</span>&nbsp;<span class="op" id="5878151">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5878154">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5878177">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5878187">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5878194">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5878200">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5878211">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5878219">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5878226">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5878229">var</span>&nbsp;<span class="ident" id="5878233">drivers</span>&nbsp;<span class="op" id="5878241">=</span>&nbsp;<span class="builtinfunc" id="5878243">make</span><span class="op" id="5878247">(</span><span class="keyword" id="5878248">map</span><span class="op" id="5878251">[</span><span class="builtintype" id="5878252">string</span><span class="op" id="5878258">]</span><span class="ident" id="5878259">driver</span><span class="op" id="5878265">.</span><span class="ident" id="5878266">Driver</span><span class="op" id="5878272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5878275">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5878343">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="5878414">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="5878428">func</span>&nbsp;<span class="ident" id="5878433">Register</span><span class="op" id="5878441">(</span><span class="ident" id="5878442">name</span>&nbsp;<span class="builtintype" id="5878447">string</span><span class="op" id="5878453">,</span>&nbsp;<span class="ident" id="5878455">driver</span>&nbsp;<span class="ident" id="5878462">driver</span><span class="op" id="5878468">.</span><span class="ident" id="5878469">Driver</span><span class="op" id="5878475">)</span>&nbsp;<span class="op" id="5878477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878480">if</span>&nbsp;<span class="ident" id="5878483">driver</span>&nbsp;<span class="op" id="5878490">==</span>&nbsp;<span class="ident" id="5878493">nil</span>&nbsp;<span class="op" id="5878497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5878501">panic</span><span class="op" id="5878506">(</span><span class="string" id="5878507">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="5878536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878542">if</span>&nbsp;<span class="ident" id="5878545">_</span><span class="op" id="5878546">,</span>&nbsp;<span class="ident" id="5878548">dup</span>&nbsp;<span class="op" id="5878552">:=</span>&nbsp;<span class="ident" id="5878555">drivers</span><span class="op" id="5878562">[</span><span class="ident" id="5878563">name</span><span class="op" id="5878567">]</span><span class="op" id="5878568">;</span>&nbsp;<span class="ident" id="5878570">dup</span>&nbsp;<span class="op" id="5878574">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5878578">panic</span><span class="op" id="5878583">(</span><span class="string" id="5878584">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="5878625">+</span>&nbsp;<span class="ident" id="5878627">name</span><span class="op" id="5878631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878637">drivers</span><span class="op" id="5878644">[</span><span class="ident" id="5878645">name</span><span class="op" id="5878649">]</span>&nbsp;<span class="op" id="5878651">=</span>&nbsp;<span class="ident" id="5878653">driver</span><br>
<span class="lineno"></span><span class="op" id="5878660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5878663">func</span>&nbsp;<span class="ident" id="5878668">unregisterAllDrivers</span><span class="op" id="5878688">(</span><span class="op" id="5878689">)</span>&nbsp;<span class="op" id="5878691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878694">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878709">drivers</span>&nbsp;<span class="op" id="5878717">=</span>&nbsp;<span class="builtinfunc" id="5878719">make</span><span class="op" id="5878723">(</span><span class="keyword" id="5878724">map</span><span class="op" id="5878727">[</span><span class="builtintype" id="5878728">string</span><span class="op" id="5878734">]</span><span class="ident" id="5878735">driver</span><span class="op" id="5878741">.</span><span class="ident" id="5878742">Driver</span><span class="op" id="5878748">)</span><br>
<span class="lineno"></span><span class="op" id="5878750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5878753">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="5878826">func</span>&nbsp;<span class="ident" id="5878831">Drivers</span><span class="op" id="5878838">(</span><span class="op" id="5878839">)</span>&nbsp;<span class="op" id="5878841">[</span><span class="op" id="5878842">]</span><span class="builtintype" id="5878843">string</span>&nbsp;<span class="op" id="5878850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878853">var</span>&nbsp;<span class="ident" id="5878857">list</span>&nbsp;<span class="op" id="5878862">[</span><span class="op" id="5878863">]</span><span class="builtintype" id="5878864">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878872">for</span>&nbsp;<span class="ident" id="5878876">name</span>&nbsp;<span class="op" id="5878881">:=</span>&nbsp;<span class="keyword" id="5878884">range</span>&nbsp;<span class="ident" id="5878890">drivers</span>&nbsp;<span class="op" id="5878898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878902">list</span>&nbsp;<span class="op" id="5878907">=</span>&nbsp;<span class="builtinfunc" id="5878909">append</span><span class="op" id="5878915">(</span><span class="ident" id="5878916">list</span><span class="op" id="5878920">,</span>&nbsp;<span class="ident" id="5878922">name</span><span class="op" id="5878926">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878932">sort</span><span class="op" id="5878936">.</span><span class="ident" id="5878937">Strings</span><span class="op" id="5878944">(</span><span class="ident" id="5878945">list</span><span class="op" id="5878949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878952">return</span>&nbsp;<span class="ident" id="5878959">list</span><br>
<span class="lineno"></span><span class="op" id="5878964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5878967">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5879037">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="5879109">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5879163">type</span>&nbsp;<span class="ident" id="5879168">RawBytes</span>&nbsp;<span class="op" id="5879177">[</span><span class="op" id="5879178">]</span><span class="builtintype" id="5879179">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5879185">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5879237">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5879287">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="5879328">//</span><br>
<span class="lineno"></span><span class="comment" id="5879331">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="5879352">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="5879423">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5879431">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5879448">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="5879471">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="5879484">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5879505">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5879511">//</span><br>
<span class="lineno"></span><span class="keyword" id="5879514">type</span>&nbsp;<span class="ident" id="5879519">NullString</span>&nbsp;<span class="keyword" id="5879530">struct</span>&nbsp;<span class="op" id="5879537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879540">String</span>&nbsp;<span class="builtintype" id="5879547">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879555">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="5879562">bool</span>&nbsp;<span class="comment" id="5879567">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5879606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5879609">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5879651">func</span>&nbsp;<span class="op" id="5879656">(</span><span class="ident" id="5879657">ns</span>&nbsp;<span class="op" id="5879660">*</span><span class="ident" id="5879661">NullString</span><span class="op" id="5879671">)</span>&nbsp;<span class="ident" id="5879673">Scan</span><span class="op" id="5879677">(</span><span class="ident" id="5879678">value</span>&nbsp;<span class="keyword" id="5879684">interface</span><span class="op" id="5879693">{</span><span class="op" id="5879694">}</span><span class="op" id="5879695">)</span>&nbsp;<span class="builtintype" id="5879697">error</span>&nbsp;<span class="op" id="5879703">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879706">if</span>&nbsp;<span class="ident" id="5879709">value</span>&nbsp;<span class="op" id="5879715">==</span>&nbsp;<span class="ident" id="5879718">nil</span>&nbsp;<span class="op" id="5879722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879726">ns</span><span class="op" id="5879728">.</span><span class="ident" id="5879729">String</span><span class="op" id="5879735">,</span>&nbsp;<span class="ident" id="5879737">ns</span><span class="op" id="5879739">.</span><span class="ident" id="5879740">Valid</span>&nbsp;<span class="op" id="5879746">=</span>&nbsp;<span class="string" id="5879748">&#34;&#34;</span><span class="op" id="5879750">,</span>&nbsp;<span class="ident" id="5879752">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879760">return</span>&nbsp;<span class="ident" id="5879767">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879775">ns</span><span class="op" id="5879777">.</span><span class="ident" id="5879778">Valid</span>&nbsp;<span class="op" id="5879784">=</span>&nbsp;<span class="ident" id="5879786">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879792">return</span>&nbsp;<span class="ident" id="5879799">convertAssign</span><span class="op" id="5879812">(</span><span class="op" id="5879813">&amp;</span><span class="ident" id="5879814">ns</span><span class="op" id="5879816">.</span><span class="ident" id="5879817">String</span><span class="op" id="5879823">,</span>&nbsp;<span class="ident" id="5879825">value</span><span class="op" id="5879830">)</span><br>
<span class="lineno"></span><span class="op" id="5879832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5879835">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5879884">func</span>&nbsp;<span class="op" id="5879889">(</span><span class="ident" id="5879890">ns</span>&nbsp;<span class="ident" id="5879893">NullString</span><span class="op" id="5879903">)</span>&nbsp;<span class="ident" id="5879905">Value</span><span class="op" id="5879910">(</span><span class="op" id="5879911">)</span>&nbsp;<span class="op" id="5879913">(</span><span class="ident" id="5879914">driver</span><span class="op" id="5879920">.</span><span class="ident" id="5879921">Value</span><span class="op" id="5879926">,</span>&nbsp;<span class="builtintype" id="5879928">error</span><span class="op" id="5879933">)</span>&nbsp;<span class="op" id="5879935">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879938">if</span>&nbsp;<span class="op" id="5879941">!</span><span class="ident" id="5879942">ns</span><span class="op" id="5879944">.</span><span class="ident" id="5879945">Valid</span>&nbsp;<span class="op" id="5879951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879955">return</span>&nbsp;<span class="ident" id="5879962">nil</span><span class="op" id="5879965">,</span>&nbsp;<span class="ident" id="5879967">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879975">return</span>&nbsp;<span class="ident" id="5879982">ns</span><span class="op" id="5879984">.</span><span class="ident" id="5879985">String</span><span class="op" id="5879991">,</span>&nbsp;<span class="ident" id="5879993">nil</span><br>
<span class="lineno"></span><span class="op" id="5879997">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5880000">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5880051">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5880100">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5880164">type</span>&nbsp;<span class="ident" id="5880169">NullInt64</span>&nbsp;<span class="keyword" id="5880179">struct</span>&nbsp;<span class="op" id="5880186">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880189">Int64</span>&nbsp;<span class="ident" id="5880195">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880202">Valid</span>&nbsp;<span class="builtintype" id="5880208">bool</span>&nbsp;<span class="comment" id="5880213">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5880251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5880254">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="5880296">func</span>&nbsp;<span class="op" id="5880301">(</span><span class="ident" id="5880302">n</span>&nbsp;<span class="op" id="5880304">*</span><span class="ident" id="5880305">NullInt64</span><span class="op" id="5880314">)</span>&nbsp;<span class="ident" id="5880316">Scan</span><span class="op" id="5880320">(</span><span class="ident" id="5880321">value</span>&nbsp;<span class="keyword" id="5880327">interface</span><span class="op" id="5880336">{</span><span class="op" id="5880337">}</span><span class="op" id="5880338">)</span>&nbsp;<span class="builtintype" id="5880340">error</span>&nbsp;<span class="op" id="5880346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880349">if</span>&nbsp;<span class="ident" id="5880352">value</span>&nbsp;<span class="op" id="5880358">==</span>&nbsp;<span class="ident" id="5880361">nil</span>&nbsp;<span class="op" id="5880365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880369">n</span><span class="op" id="5880370">.</span><span class="ident" id="5880371">Int64</span><span class="op" id="5880376">,</span>&nbsp;<span class="ident" id="5880378">n</span><span class="op" id="5880379">.</span><span class="ident" id="5880380">Valid</span>&nbsp;<span class="op" id="5880386">=</span>&nbsp;<span class="num" id="5880388">0</span><span class="op" id="5880389">,</span>&nbsp;<span class="ident" id="5880391">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880399">return</span>&nbsp;<span class="ident" id="5880406">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880411">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880414">n</span><span class="op" id="5880415">.</span><span class="ident" id="5880416">Valid</span>&nbsp;<span class="op" id="5880422">=</span>&nbsp;<span class="ident" id="5880424">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880430">return</span>&nbsp;<span class="ident" id="5880437">convertAssign</span><span class="op" id="5880450">(</span><span class="op" id="5880451">&amp;</span><span class="ident" id="5880452">n</span><span class="op" id="5880453">.</span><span class="ident" id="5880454">Int64</span><span class="op" id="5880459">,</span>&nbsp;<span class="ident" id="5880461">value</span><span class="op" id="5880466">)</span><br>
<span class="lineno"></span><span class="op" id="5880468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5880471">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="5880520">func</span>&nbsp;<span class="op" id="5880525">(</span><span class="ident" id="5880526">n</span>&nbsp;<span class="ident" id="5880528">NullInt64</span><span class="op" id="5880537">)</span>&nbsp;<span class="ident" id="5880539">Value</span><span class="op" id="5880544">(</span><span class="op" id="5880545">)</span>&nbsp;<span class="op" id="5880547">(</span><span class="ident" id="5880548">driver</span><span class="op" id="5880554">.</span><span class="ident" id="5880555">Value</span><span class="op" id="5880560">,</span>&nbsp;<span class="builtintype" id="5880562">error</span><span class="op" id="5880567">)</span>&nbsp;<span class="op" id="5880569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880572">if</span>&nbsp;<span class="op" id="5880575">!</span><span class="ident" id="5880576">n</span><span class="op" id="5880577">.</span><span class="ident" id="5880578">Valid</span>&nbsp;<span class="op" id="5880584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880588">return</span>&nbsp;<span class="ident" id="5880595">nil</span><span class="op" id="5880598">,</span>&nbsp;<span class="ident" id="5880600">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880608">return</span>&nbsp;<span class="ident" id="5880615">n</span><span class="op" id="5880616">.</span><span class="ident" id="5880617">Int64</span><span class="op" id="5880622">,</span>&nbsp;<span class="ident" id="5880624">nil</span><br>
<span class="lineno">120</span><span class="op" id="5880628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5880631">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5880685">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5880736">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="5880800">type</span>&nbsp;<span class="ident" id="5880805">NullFloat64</span>&nbsp;<span class="keyword" id="5880817">struct</span>&nbsp;<span class="op" id="5880824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880827">Float64</span>&nbsp;<span class="builtintype" id="5880835">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880844">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5880852">bool</span>&nbsp;<span class="comment" id="5880857">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5880897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5880900">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5880942">func</span>&nbsp;<span class="op" id="5880947">(</span><span class="ident" id="5880948">n</span>&nbsp;<span class="op" id="5880950">*</span><span class="ident" id="5880951">NullFloat64</span><span class="op" id="5880962">)</span>&nbsp;<span class="ident" id="5880964">Scan</span><span class="op" id="5880968">(</span><span class="ident" id="5880969">value</span>&nbsp;<span class="keyword" id="5880975">interface</span><span class="op" id="5880984">{</span><span class="op" id="5880985">}</span><span class="op" id="5880986">)</span>&nbsp;<span class="builtintype" id="5880988">error</span>&nbsp;<span class="op" id="5880994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880997">if</span>&nbsp;<span class="ident" id="5881000">value</span>&nbsp;<span class="op" id="5881006">==</span>&nbsp;<span class="ident" id="5881009">nil</span>&nbsp;<span class="op" id="5881013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881017">n</span><span class="op" id="5881018">.</span><span class="ident" id="5881019">Float64</span><span class="op" id="5881026">,</span>&nbsp;<span class="ident" id="5881028">n</span><span class="op" id="5881029">.</span><span class="ident" id="5881030">Valid</span>&nbsp;<span class="op" id="5881036">=</span>&nbsp;<span class="num" id="5881038">0</span><span class="op" id="5881039">,</span>&nbsp;<span class="ident" id="5881041">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881049">return</span>&nbsp;<span class="ident" id="5881056">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881064">n</span><span class="op" id="5881065">.</span><span class="ident" id="5881066">Valid</span>&nbsp;<span class="op" id="5881072">=</span>&nbsp;<span class="ident" id="5881074">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881080">return</span>&nbsp;<span class="ident" id="5881087">convertAssign</span><span class="op" id="5881100">(</span><span class="op" id="5881101">&amp;</span><span class="ident" id="5881102">n</span><span class="op" id="5881103">.</span><span class="ident" id="5881104">Float64</span><span class="op" id="5881111">,</span>&nbsp;<span class="ident" id="5881113">value</span><span class="op" id="5881118">)</span><br>
<span class="lineno"></span><span class="op" id="5881120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="5881123">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5881172">func</span>&nbsp;<span class="op" id="5881177">(</span><span class="ident" id="5881178">n</span>&nbsp;<span class="ident" id="5881180">NullFloat64</span><span class="op" id="5881191">)</span>&nbsp;<span class="ident" id="5881193">Value</span><span class="op" id="5881198">(</span><span class="op" id="5881199">)</span>&nbsp;<span class="op" id="5881201">(</span><span class="ident" id="5881202">driver</span><span class="op" id="5881208">.</span><span class="ident" id="5881209">Value</span><span class="op" id="5881214">,</span>&nbsp;<span class="builtintype" id="5881216">error</span><span class="op" id="5881221">)</span>&nbsp;<span class="op" id="5881223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881226">if</span>&nbsp;<span class="op" id="5881229">!</span><span class="ident" id="5881230">n</span><span class="op" id="5881231">.</span><span class="ident" id="5881232">Valid</span>&nbsp;<span class="op" id="5881238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881242">return</span>&nbsp;<span class="ident" id="5881249">nil</span><span class="op" id="5881252">,</span>&nbsp;<span class="ident" id="5881254">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881259">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881262">return</span>&nbsp;<span class="ident" id="5881269">n</span><span class="op" id="5881270">.</span><span class="ident" id="5881271">Float64</span><span class="op" id="5881278">,</span>&nbsp;<span class="ident" id="5881280">nil</span><br>
<span class="lineno"></span><span class="op" id="5881284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5881287">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5881335">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="5881383">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5881447">type</span>&nbsp;<span class="ident" id="5881452">NullBool</span>&nbsp;<span class="keyword" id="5881461">struct</span>&nbsp;<span class="op" id="5881468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881471">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="5881477">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881483">Valid</span>&nbsp;<span class="builtintype" id="5881489">bool</span>&nbsp;<span class="comment" id="5881494">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5881531">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5881534">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5881576">func</span>&nbsp;<span class="op" id="5881581">(</span><span class="ident" id="5881582">n</span>&nbsp;<span class="op" id="5881584">*</span><span class="ident" id="5881585">NullBool</span><span class="op" id="5881593">)</span>&nbsp;<span class="ident" id="5881595">Scan</span><span class="op" id="5881599">(</span><span class="ident" id="5881600">value</span>&nbsp;<span class="keyword" id="5881606">interface</span><span class="op" id="5881615">{</span><span class="op" id="5881616">}</span><span class="op" id="5881617">)</span>&nbsp;<span class="builtintype" id="5881619">error</span>&nbsp;<span class="op" id="5881625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881628">if</span>&nbsp;<span class="ident" id="5881631">value</span>&nbsp;<span class="op" id="5881637">==</span>&nbsp;<span class="ident" id="5881640">nil</span>&nbsp;<span class="op" id="5881644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881648">n</span><span class="op" id="5881649">.</span><span class="ident" id="5881650">Bool</span><span class="op" id="5881654">,</span>&nbsp;<span class="ident" id="5881656">n</span><span class="op" id="5881657">.</span><span class="ident" id="5881658">Valid</span>&nbsp;<span class="op" id="5881664">=</span>&nbsp;<span class="ident" id="5881666">false</span><span class="op" id="5881671">,</span>&nbsp;<span class="ident" id="5881673">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881681">return</span>&nbsp;<span class="ident" id="5881688">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881696">n</span><span class="op" id="5881697">.</span><span class="ident" id="5881698">Valid</span>&nbsp;<span class="op" id="5881704">=</span>&nbsp;<span class="ident" id="5881706">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881712">return</span>&nbsp;<span class="ident" id="5881719">convertAssign</span><span class="op" id="5881732">(</span><span class="op" id="5881733">&amp;</span><span class="ident" id="5881734">n</span><span class="op" id="5881735">.</span><span class="ident" id="5881736">Bool</span><span class="op" id="5881740">,</span>&nbsp;<span class="ident" id="5881742">value</span><span class="op" id="5881747">)</span><br>
<span class="lineno"></span><span class="op" id="5881749">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5881752">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5881801">func</span>&nbsp;<span class="op" id="5881806">(</span><span class="ident" id="5881807">n</span>&nbsp;<span class="ident" id="5881809">NullBool</span><span class="op" id="5881817">)</span>&nbsp;<span class="ident" id="5881819">Value</span><span class="op" id="5881824">(</span><span class="op" id="5881825">)</span>&nbsp;<span class="op" id="5881827">(</span><span class="ident" id="5881828">driver</span><span class="op" id="5881834">.</span><span class="ident" id="5881835">Value</span><span class="op" id="5881840">,</span>&nbsp;<span class="builtintype" id="5881842">error</span><span class="op" id="5881847">)</span>&nbsp;<span class="op" id="5881849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881852">if</span>&nbsp;<span class="op" id="5881855">!</span><span class="ident" id="5881856">n</span><span class="op" id="5881857">.</span><span class="ident" id="5881858">Valid</span>&nbsp;<span class="op" id="5881864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881868">return</span>&nbsp;<span class="ident" id="5881875">nil</span><span class="op" id="5881878">,</span>&nbsp;<span class="ident" id="5881880">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881888">return</span>&nbsp;<span class="ident" id="5881895">n</span><span class="op" id="5881896">.</span><span class="ident" id="5881897">Bool</span><span class="op" id="5881901">,</span>&nbsp;<span class="ident" id="5881903">nil</span><br>
<span class="lineno"></span><span class="op" id="5881907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5881910">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="5881951">type</span>&nbsp;<span class="ident" id="5881956">Scanner</span>&nbsp;<span class="keyword" id="5881964">interface</span>&nbsp;<span class="op" id="5881974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5881977">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882026">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882030">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882091">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882109">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882113">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882126">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882141">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882153">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882167">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882181">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882198">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882227">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882231">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882294">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882327">Scan</span><span class="op" id="5882331">(</span><span class="ident" id="5882332">src</span>&nbsp;<span class="keyword" id="5882336">interface</span><span class="op" id="5882345">{</span><span class="op" id="5882346">}</span><span class="op" id="5882347">)</span>&nbsp;<span class="builtintype" id="5882349">error</span><br>
<span class="lineno"></span><span class="op" id="5882355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5882358">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="5882422">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5882493">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="5882528">var</span>&nbsp;<span class="ident" id="5882532">ErrNoRows</span>&nbsp;<span class="op" id="5882542">=</span>&nbsp;<span class="ident" id="5882544">errors</span><span class="op" id="5882550">.</span><span class="ident" id="5882551">New</span><span class="op" id="5882554">(</span><span class="string" id="5882555">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="5882583">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5882586">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="5882649">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="5882717">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="5882732">//</span><br>
<span class="lineno"></span><span class="comment" id="5882735">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5882802">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="5882873">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="5882943">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5883006">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5883069">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5883130">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="5883200">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="5883243">type</span>&nbsp;<span class="ident" id="5883248">DB</span>&nbsp;<span class="keyword" id="5883251">struct</span>&nbsp;<span class="op" id="5883258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883261">driver</span>&nbsp;<span class="ident" id="5883268">driver</span><span class="op" id="5883274">.</span><span class="ident" id="5883275">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883283">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5883290">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883299">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5883312">sync</span><span class="op" id="5883316">.</span><span class="ident" id="5883317">Mutex</span>&nbsp;<span class="comment" id="5883323">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883353">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5883366">[</span><span class="op" id="5883367">]</span><span class="op" id="5883368">*</span><span class="ident" id="5883369">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883381">connRequests</span>&nbsp;<span class="op" id="5883394">[</span><span class="op" id="5883395">]</span><span class="keyword" id="5883396">chan</span>&nbsp;<span class="ident" id="5883401">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883414">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5883427">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883432">pendingOpens</span>&nbsp;<span class="builtintype" id="5883445">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883450">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883498">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883564">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883643">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883716">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883739">openerCh</span>&nbsp;<span class="keyword" id="5883748">chan</span>&nbsp;<span class="keyword" id="5883753">struct</span><span class="op" id="5883759">{</span><span class="op" id="5883760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883763">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5883772">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883778">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5883787">map</span><span class="op" id="5883790">[</span><span class="ident" id="5883791">finalCloser</span><span class="op" id="5883802">]</span><span class="ident" id="5883803">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883811">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="5883820">map</span><span class="op" id="5883823">[</span><span class="op" id="5883824">*</span><span class="ident" id="5883825">driverConn</span><span class="op" id="5883835">]</span><span class="builtintype" id="5883836">string</span>&nbsp;<span class="comment" id="5883843">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883889">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="5883898">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5883921">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883974">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="5883983">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5884006">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="5884030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5884033">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5884084">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="5884153">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="5884218">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="5884235">type</span>&nbsp;<span class="ident" id="5884240">driverConn</span>&nbsp;<span class="keyword" id="5884251">struct</span>&nbsp;<span class="op" id="5884258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884261">db</span>&nbsp;<span class="op" id="5884264">*</span><span class="ident" id="5884265">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884270">sync</span><span class="op" id="5884274">.</span><span class="ident" id="5884275">Mutex</span>&nbsp;&nbsp;<span class="comment" id="5884282">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884303">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5884315">driver</span><span class="op" id="5884321">.</span><span class="ident" id="5884322">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884328">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5884340">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884346">finalClosed</span>&nbsp;<span class="builtintype" id="5884358">bool</span>&nbsp;<span class="comment" id="5884363">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884392">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5884404">map</span><span class="op" id="5884407">[</span><span class="ident" id="5884408">driver</span><span class="op" id="5884414">.</span><span class="ident" id="5884415">Stmt</span><span class="op" id="5884419">]</span><span class="builtintype" id="5884420">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5884427">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884448">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5884459">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884465">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5884476">[</span><span class="op" id="5884477">]</span><span class="keyword" id="5884478">func</span><span class="op" id="5884482">(</span><span class="op" id="5884483">)</span>&nbsp;<span class="comment" id="5884485">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884543">dbmuClosed</span>&nbsp;<span class="builtintype" id="5884554">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5884563">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="5884619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5884622">func</span>&nbsp;<span class="op" id="5884627">(</span><span class="ident" id="5884628">dc</span>&nbsp;<span class="op" id="5884631">*</span><span class="ident" id="5884632">driverConn</span><span class="op" id="5884642">)</span>&nbsp;<span class="ident" id="5884644">releaseConn</span><span class="op" id="5884655">(</span><span class="ident" id="5884656">err</span>&nbsp;<span class="builtintype" id="5884660">error</span><span class="op" id="5884665">)</span>&nbsp;<span class="op" id="5884667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884670">dc</span><span class="op" id="5884672">.</span><span class="ident" id="5884673">db</span><span class="op" id="5884675">.</span><span class="ident" id="5884676">putConn</span><span class="op" id="5884683">(</span><span class="ident" id="5884684">dc</span><span class="op" id="5884686">,</span>&nbsp;<span class="ident" id="5884688">err</span><span class="op" id="5884691">)</span><br>
<span class="lineno"></span><span class="op" id="5884693">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="5884696">func</span>&nbsp;<span class="op" id="5884701">(</span><span class="ident" id="5884702">dc</span>&nbsp;<span class="op" id="5884705">*</span><span class="ident" id="5884706">driverConn</span><span class="op" id="5884716">)</span>&nbsp;<span class="ident" id="5884718">removeOpenStmt</span><span class="op" id="5884732">(</span><span class="ident" id="5884733">si</span>&nbsp;<span class="ident" id="5884736">driver</span><span class="op" id="5884742">.</span><span class="ident" id="5884743">Stmt</span><span class="op" id="5884747">)</span>&nbsp;<span class="op" id="5884749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884752">dc</span><span class="op" id="5884754">.</span><span class="ident" id="5884755">Lock</span><span class="op" id="5884759">(</span><span class="op" id="5884760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884763">defer</span>&nbsp;<span class="ident" id="5884769">dc</span><span class="op" id="5884771">.</span><span class="ident" id="5884772">Unlock</span><span class="op" id="5884778">(</span><span class="op" id="5884779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5884782">delete</span><span class="op" id="5884788">(</span><span class="ident" id="5884789">dc</span><span class="op" id="5884791">.</span><span class="ident" id="5884792">openStmt</span><span class="op" id="5884800">,</span>&nbsp;<span class="ident" id="5884802">si</span><span class="op" id="5884804">)</span><br>
<span class="lineno">260</span><span class="op" id="5884806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5884809">func</span>&nbsp;<span class="op" id="5884814">(</span><span class="ident" id="5884815">dc</span>&nbsp;<span class="op" id="5884818">*</span><span class="ident" id="5884819">driverConn</span><span class="op" id="5884829">)</span>&nbsp;<span class="ident" id="5884831">prepareLocked</span><span class="op" id="5884844">(</span><span class="ident" id="5884845">query</span>&nbsp;<span class="builtintype" id="5884851">string</span><span class="op" id="5884857">)</span>&nbsp;<span class="op" id="5884859">(</span><span class="ident" id="5884860">driver</span><span class="op" id="5884866">.</span><span class="ident" id="5884867">Stmt</span><span class="op" id="5884871">,</span>&nbsp;<span class="builtintype" id="5884873">error</span><span class="op" id="5884878">)</span>&nbsp;<span class="op" id="5884880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884883">si</span><span class="op" id="5884885">,</span>&nbsp;<span class="ident" id="5884887">err</span>&nbsp;<span class="op" id="5884891">:=</span>&nbsp;<span class="ident" id="5884894">dc</span><span class="op" id="5884896">.</span><span class="ident" id="5884897">ci</span><span class="op" id="5884899">.</span><span class="ident" id="5884900">Prepare</span><span class="op" id="5884907">(</span><span class="ident" id="5884908">query</span><span class="op" id="5884913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884916">if</span>&nbsp;<span class="ident" id="5884919">err</span>&nbsp;<span class="op" id="5884923">==</span>&nbsp;<span class="ident" id="5884926">nil</span>&nbsp;<span class="op" id="5884930">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5884934">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5885001">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5885031">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5885036">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5885093">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5885156">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5885213">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5885218">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5885274">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5885323">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5885368">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5885412">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5885461">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885507">if</span>&nbsp;<span class="ident" id="5885510">dc</span><span class="op" id="5885512">.</span><span class="ident" id="5885513">openStmt</span>&nbsp;<span class="op" id="5885522">==</span>&nbsp;<span class="ident" id="5885525">nil</span>&nbsp;<span class="op" id="5885529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885534">dc</span><span class="op" id="5885536">.</span><span class="ident" id="5885537">openStmt</span>&nbsp;<span class="op" id="5885546">=</span>&nbsp;<span class="builtinfunc" id="5885548">make</span><span class="op" id="5885552">(</span><span class="keyword" id="5885553">map</span><span class="op" id="5885556">[</span><span class="ident" id="5885557">driver</span><span class="op" id="5885563">.</span><span class="ident" id="5885564">Stmt</span><span class="op" id="5885568">]</span><span class="builtintype" id="5885569">bool</span><span class="op" id="5885573">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885581">dc</span><span class="op" id="5885583">.</span><span class="ident" id="5885584">openStmt</span><span class="op" id="5885592">[</span><span class="ident" id="5885593">si</span><span class="op" id="5885595">]</span>&nbsp;<span class="op" id="5885597">=</span>&nbsp;<span class="ident" id="5885599">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885608">return</span>&nbsp;<span class="ident" id="5885615">si</span><span class="op" id="5885617">,</span>&nbsp;<span class="ident" id="5885619">err</span><br>
<span class="lineno"></span><span class="op" id="5885623">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="5885626">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5885656">func</span>&nbsp;<span class="op" id="5885661">(</span><span class="ident" id="5885662">dc</span>&nbsp;<span class="op" id="5885665">*</span><span class="ident" id="5885666">driverConn</span><span class="op" id="5885676">)</span>&nbsp;<span class="ident" id="5885678">closeDBLocked</span><span class="op" id="5885691">(</span><span class="op" id="5885692">)</span>&nbsp;<span class="keyword" id="5885694">func</span><span class="op" id="5885698">(</span><span class="op" id="5885699">)</span>&nbsp;<span class="builtintype" id="5885701">error</span>&nbsp;<span class="op" id="5885707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885710">dc</span><span class="op" id="5885712">.</span><span class="ident" id="5885713">Lock</span><span class="op" id="5885717">(</span><span class="op" id="5885718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885721">defer</span>&nbsp;<span class="ident" id="5885727">dc</span><span class="op" id="5885729">.</span><span class="ident" id="5885730">Unlock</span><span class="op" id="5885736">(</span><span class="op" id="5885737">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885740">if</span>&nbsp;<span class="ident" id="5885743">dc</span><span class="op" id="5885745">.</span><span class="ident" id="5885746">closed</span>&nbsp;<span class="op" id="5885753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885757">return</span>&nbsp;<span class="keyword" id="5885764">func</span><span class="op" id="5885768">(</span><span class="op" id="5885769">)</span>&nbsp;<span class="builtintype" id="5885771">error</span>&nbsp;<span class="op" id="5885777">{</span>&nbsp;<span class="keyword" id="5885779">return</span>&nbsp;<span class="ident" id="5885786">errors</span><span class="op" id="5885792">.</span><span class="ident" id="5885793">New</span><span class="op" id="5885796">(</span><span class="string" id="5885797">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="5885830">)</span>&nbsp;<span class="op" id="5885832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885838">dc</span><span class="op" id="5885840">.</span><span class="ident" id="5885841">closed</span>&nbsp;<span class="op" id="5885848">=</span>&nbsp;<span class="ident" id="5885850">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885856">return</span>&nbsp;<span class="ident" id="5885863">dc</span><span class="op" id="5885865">.</span><span class="ident" id="5885866">db</span><span class="op" id="5885868">.</span><span class="ident" id="5885869">removeDepLocked</span><span class="op" id="5885884">(</span><span class="ident" id="5885885">dc</span><span class="op" id="5885887">,</span>&nbsp;<span class="ident" id="5885889">dc</span><span class="op" id="5885891">)</span><br>
<span class="lineno">295</span><span class="op" id="5885893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5885896">func</span>&nbsp;<span class="op" id="5885901">(</span><span class="ident" id="5885902">dc</span>&nbsp;<span class="op" id="5885905">*</span><span class="ident" id="5885906">driverConn</span><span class="op" id="5885916">)</span>&nbsp;<span class="ident" id="5885918">Close</span><span class="op" id="5885923">(</span><span class="op" id="5885924">)</span>&nbsp;<span class="builtintype" id="5885926">error</span>&nbsp;<span class="op" id="5885932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885935">dc</span><span class="op" id="5885937">.</span><span class="ident" id="5885938">Lock</span><span class="op" id="5885942">(</span><span class="op" id="5885943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885946">if</span>&nbsp;<span class="ident" id="5885949">dc</span><span class="op" id="5885951">.</span><span class="ident" id="5885952">closed</span>&nbsp;<span class="op" id="5885959">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885963">dc</span><span class="op" id="5885965">.</span><span class="ident" id="5885966">Unlock</span><span class="op" id="5885972">(</span><span class="op" id="5885973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885977">return</span>&nbsp;<span class="ident" id="5885984">errors</span><span class="op" id="5885990">.</span><span class="ident" id="5885991">New</span><span class="op" id="5885994">(</span><span class="string" id="5885995">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="5886028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5886031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886034">dc</span><span class="op" id="5886036">.</span><span class="ident" id="5886037">closed</span>&nbsp;<span class="op" id="5886044">=</span>&nbsp;<span class="ident" id="5886046">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886052">dc</span><span class="op" id="5886054">.</span><span class="ident" id="5886055">Unlock</span><span class="op" id="5886061">(</span><span class="op" id="5886062">)</span>&nbsp;<span class="comment" id="5886064">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5886124">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886177">dc</span><span class="op" id="5886179">.</span><span class="ident" id="5886180">db</span><span class="op" id="5886182">.</span><span class="ident" id="5886183">mu</span><span class="op" id="5886185">.</span><span class="ident" id="5886186">Lock</span><span class="op" id="5886190">(</span><span class="op" id="5886191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886194">dc</span><span class="op" id="5886196">.</span><span class="ident" id="5886197">dbmuClosed</span>&nbsp;<span class="op" id="5886208">=</span>&nbsp;<span class="ident" id="5886210">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886216">fn</span>&nbsp;<span class="op" id="5886219">:=</span>&nbsp;<span class="ident" id="5886222">dc</span><span class="op" id="5886224">.</span><span class="ident" id="5886225">db</span><span class="op" id="5886227">.</span><span class="ident" id="5886228">removeDepLocked</span><span class="op" id="5886243">(</span><span class="ident" id="5886244">dc</span><span class="op" id="5886246">,</span>&nbsp;<span class="ident" id="5886248">dc</span><span class="op" id="5886250">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886253">dc</span><span class="op" id="5886255">.</span><span class="ident" id="5886256">db</span><span class="op" id="5886258">.</span><span class="ident" id="5886259">mu</span><span class="op" id="5886261">.</span><span class="ident" id="5886262">Unlock</span><span class="op" id="5886268">(</span><span class="op" id="5886269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5886272">return</span>&nbsp;<span class="ident" id="5886279">fn</span><span class="op" id="5886281">(</span><span class="op" id="5886282">)</span><br>
<span class="lineno"></span><span class="op" id="5886284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5886287">func</span>&nbsp;<span class="op" id="5886292">(</span><span class="ident" id="5886293">dc</span>&nbsp;<span class="op" id="5886296">*</span><span class="ident" id="5886297">driverConn</span><span class="op" id="5886307">)</span>&nbsp;<span class="ident" id="5886309">finalClose</span><span class="op" id="5886319">(</span><span class="op" id="5886320">)</span>&nbsp;<span class="builtintype" id="5886322">error</span>&nbsp;<span class="op" id="5886328">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886331">dc</span><span class="op" id="5886333">.</span><span class="ident" id="5886334">Lock</span><span class="op" id="5886338">(</span><span class="op" id="5886339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5886343">for</span>&nbsp;<span class="ident" id="5886347">si</span>&nbsp;<span class="op" id="5886350">:=</span>&nbsp;<span class="keyword" id="5886353">range</span>&nbsp;<span class="ident" id="5886359">dc</span><span class="op" id="5886361">.</span><span class="ident" id="5886362">openStmt</span>&nbsp;<span class="op" id="5886371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886375">si</span><span class="op" id="5886377">.</span><span class="ident" id="5886378">Close</span><span class="op" id="5886383">(</span><span class="op" id="5886384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5886387">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886390">dc</span><span class="op" id="5886392">.</span><span class="ident" id="5886393">openStmt</span>&nbsp;<span class="op" id="5886402">=</span>&nbsp;<span class="ident" id="5886404">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886410">err</span>&nbsp;<span class="op" id="5886414">:=</span>&nbsp;<span class="ident" id="5886417">dc</span><span class="op" id="5886419">.</span><span class="ident" id="5886420">ci</span><span class="op" id="5886422">.</span><span class="ident" id="5886423">Close</span><span class="op" id="5886428">(</span><span class="op" id="5886429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886432">dc</span><span class="op" id="5886434">.</span><span class="ident" id="5886435">ci</span>&nbsp;<span class="op" id="5886438">=</span>&nbsp;<span class="ident" id="5886440">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886445">dc</span><span class="op" id="5886447">.</span><span class="ident" id="5886448">finalClosed</span>&nbsp;<span class="op" id="5886460">=</span>&nbsp;<span class="ident" id="5886462">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886468">dc</span><span class="op" id="5886470">.</span><span class="ident" id="5886471">Unlock</span><span class="op" id="5886477">(</span><span class="op" id="5886478">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886482">dc</span><span class="op" id="5886484">.</span><span class="ident" id="5886485">db</span><span class="op" id="5886487">.</span><span class="ident" id="5886488">mu</span><span class="op" id="5886490">.</span><span class="ident" id="5886491">Lock</span><span class="op" id="5886495">(</span><span class="op" id="5886496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886499">dc</span><span class="op" id="5886501">.</span><span class="ident" id="5886502">db</span><span class="op" id="5886504">.</span><span class="ident" id="5886505">numOpen</span><span class="op" id="5886512">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886516">dc</span><span class="op" id="5886518">.</span><span class="ident" id="5886519">db</span><span class="op" id="5886521">.</span><span class="ident" id="5886522">maybeOpenNewConnections</span><span class="op" id="5886545">(</span><span class="op" id="5886546">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886549">dc</span><span class="op" id="5886551">.</span><span class="ident" id="5886552">db</span><span class="op" id="5886554">.</span><span class="ident" id="5886555">mu</span><span class="op" id="5886557">.</span><span class="ident" id="5886558">Unlock</span><span class="op" id="5886564">(</span><span class="op" id="5886565">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5886569">return</span>&nbsp;<span class="ident" id="5886576">err</span><br>
<span class="lineno"></span><span class="op" id="5886580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="5886583">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5886631">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5886698">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="5886720">type</span>&nbsp;<span class="ident" id="5886725">driverStmt</span>&nbsp;<span class="keyword" id="5886736">struct</span>&nbsp;<span class="op" id="5886743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886746">sync</span><span class="op" id="5886750">.</span><span class="ident" id="5886751">Locker</span>&nbsp;<span class="comment" id="5886758">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886778">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5886790">driver</span><span class="op" id="5886796">.</span><span class="ident" id="5886797">Stmt</span><br>
<span class="lineno"></span><span class="op" id="5886802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5886805">func</span>&nbsp;<span class="op" id="5886810">(</span><span class="ident" id="5886811">ds</span>&nbsp;<span class="op" id="5886814">*</span><span class="ident" id="5886815">driverStmt</span><span class="op" id="5886825">)</span>&nbsp;<span class="ident" id="5886827">Close</span><span class="op" id="5886832">(</span><span class="op" id="5886833">)</span>&nbsp;<span class="builtintype" id="5886835">error</span>&nbsp;<span class="op" id="5886841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5886844">ds</span><span class="op" id="5886846">.</span><span class="ident" id="5886847">Lock</span><span class="op" id="5886851">(</span><span class="op" id="5886852">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5886855">defer</span>&nbsp;<span class="ident" id="5886861">ds</span><span class="op" id="5886863">.</span><span class="ident" id="5886864">Unlock</span><span class="op" id="5886870">(</span><span class="op" id="5886871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5886874">return</span>&nbsp;<span class="ident" id="5886881">ds</span><span class="op" id="5886883">.</span><span class="ident" id="5886884">si</span><span class="op" id="5886886">.</span><span class="ident" id="5886887">Close</span><span class="op" id="5886892">(</span><span class="op" id="5886893">)</span><br>
<span class="lineno"></span><span class="op" id="5886895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5886898">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="5886952">type</span>&nbsp;<span class="ident" id="5886957">depSet</span>&nbsp;<span class="keyword" id="5886964">map</span><span class="op" id="5886967">[</span><span class="keyword" id="5886968">interface</span><span class="op" id="5886977">{</span><span class="op" id="5886978">}</span><span class="op" id="5886979">]</span><span class="builtintype" id="5886980">bool</span>&nbsp;<span class="comment" id="5886985">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5887007">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="5887072">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="5887106">type</span>&nbsp;<span class="ident" id="5887111">finalCloser</span>&nbsp;<span class="keyword" id="5887123">interface</span>&nbsp;<span class="op" id="5887133">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5887136">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5887199">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887256">finalClose</span><span class="op" id="5887266">(</span><span class="op" id="5887267">)</span>&nbsp;<span class="builtintype" id="5887269">error</span><br>
<span class="lineno"></span><span class="op" id="5887275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="5887278">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5887349">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="5887417">func</span>&nbsp;<span class="op" id="5887422">(</span><span class="ident" id="5887423">db</span>&nbsp;<span class="op" id="5887426">*</span><span class="ident" id="5887427">DB</span><span class="op" id="5887429">)</span>&nbsp;<span class="ident" id="5887431">addDep</span><span class="op" id="5887437">(</span><span class="ident" id="5887438">x</span>&nbsp;<span class="ident" id="5887440">finalCloser</span><span class="op" id="5887451">,</span>&nbsp;<span class="ident" id="5887453">dep</span>&nbsp;<span class="keyword" id="5887457">interface</span><span class="op" id="5887466">{</span><span class="op" id="5887467">}</span><span class="op" id="5887468">)</span>&nbsp;<span class="op" id="5887470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5887473">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887537">db</span><span class="op" id="5887539">.</span><span class="ident" id="5887540">mu</span><span class="op" id="5887542">.</span><span class="ident" id="5887543">Lock</span><span class="op" id="5887547">(</span><span class="op" id="5887548">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887551">defer</span>&nbsp;<span class="ident" id="5887557">db</span><span class="op" id="5887559">.</span><span class="ident" id="5887560">mu</span><span class="op" id="5887562">.</span><span class="ident" id="5887563">Unlock</span><span class="op" id="5887569">(</span><span class="op" id="5887570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887573">db</span><span class="op" id="5887575">.</span><span class="ident" id="5887576">addDepLocked</span><span class="op" id="5887588">(</span><span class="ident" id="5887589">x</span><span class="op" id="5887590">,</span>&nbsp;<span class="ident" id="5887592">dep</span><span class="op" id="5887595">)</span><br>
<span class="lineno"></span><span class="op" id="5887597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5887600">func</span>&nbsp;<span class="op" id="5887605">(</span><span class="ident" id="5887606">db</span>&nbsp;<span class="op" id="5887609">*</span><span class="ident" id="5887610">DB</span><span class="op" id="5887612">)</span>&nbsp;<span class="ident" id="5887614">addDepLocked</span><span class="op" id="5887626">(</span><span class="ident" id="5887627">x</span>&nbsp;<span class="ident" id="5887629">finalCloser</span><span class="op" id="5887640">,</span>&nbsp;<span class="ident" id="5887642">dep</span>&nbsp;<span class="keyword" id="5887646">interface</span><span class="op" id="5887655">{</span><span class="op" id="5887656">}</span><span class="op" id="5887657">)</span>&nbsp;<span class="op" id="5887659">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887662">if</span>&nbsp;<span class="ident" id="5887665">db</span><span class="op" id="5887667">.</span><span class="ident" id="5887668">dep</span>&nbsp;<span class="op" id="5887672">==</span>&nbsp;<span class="ident" id="5887675">nil</span>&nbsp;<span class="op" id="5887679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887683">db</span><span class="op" id="5887685">.</span><span class="ident" id="5887686">dep</span>&nbsp;<span class="op" id="5887690">=</span>&nbsp;<span class="builtinfunc" id="5887692">make</span><span class="op" id="5887696">(</span><span class="keyword" id="5887697">map</span><span class="op" id="5887700">[</span><span class="ident" id="5887701">finalCloser</span><span class="op" id="5887712">]</span><span class="ident" id="5887713">depSet</span><span class="op" id="5887719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5887722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887725">xdep</span>&nbsp;<span class="op" id="5887730">:=</span>&nbsp;<span class="ident" id="5887733">db</span><span class="op" id="5887735">.</span><span class="ident" id="5887736">dep</span><span class="op" id="5887739">[</span><span class="ident" id="5887740">x</span><span class="op" id="5887741">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5887744">if</span>&nbsp;<span class="ident" id="5887747">xdep</span>&nbsp;<span class="op" id="5887752">==</span>&nbsp;<span class="ident" id="5887755">nil</span>&nbsp;<span class="op" id="5887759">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887763">xdep</span>&nbsp;<span class="op" id="5887768">=</span>&nbsp;<span class="builtinfunc" id="5887770">make</span><span class="op" id="5887774">(</span><span class="ident" id="5887775">depSet</span><span class="op" id="5887781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887785">db</span><span class="op" id="5887787">.</span><span class="ident" id="5887788">dep</span><span class="op" id="5887791">[</span><span class="ident" id="5887792">x</span><span class="op" id="5887793">]</span>&nbsp;<span class="op" id="5887795">=</span>&nbsp;<span class="ident" id="5887797">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5887803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887806">xdep</span><span class="op" id="5887810">[</span><span class="ident" id="5887811">dep</span><span class="op" id="5887814">]</span>&nbsp;<span class="op" id="5887816">=</span>&nbsp;<span class="ident" id="5887818">true</span><br>
<span class="lineno"></span><span class="op" id="5887823">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="5887826">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="5887878">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5887927">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5887997">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="5888045">func</span>&nbsp;<span class="op" id="5888050">(</span><span class="ident" id="5888051">db</span>&nbsp;<span class="op" id="5888054">*</span><span class="ident" id="5888055">DB</span><span class="op" id="5888057">)</span>&nbsp;<span class="ident" id="5888059">removeDep</span><span class="op" id="5888068">(</span><span class="ident" id="5888069">x</span>&nbsp;<span class="ident" id="5888071">finalCloser</span><span class="op" id="5888082">,</span>&nbsp;<span class="ident" id="5888084">dep</span>&nbsp;<span class="keyword" id="5888088">interface</span><span class="op" id="5888097">{</span><span class="op" id="5888098">}</span><span class="op" id="5888099">)</span>&nbsp;<span class="builtintype" id="5888101">error</span>&nbsp;<span class="op" id="5888107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888110">db</span><span class="op" id="5888112">.</span><span class="ident" id="5888113">mu</span><span class="op" id="5888115">.</span><span class="ident" id="5888116">Lock</span><span class="op" id="5888120">(</span><span class="op" id="5888121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888124">fn</span>&nbsp;<span class="op" id="5888127">:=</span>&nbsp;<span class="ident" id="5888130">db</span><span class="op" id="5888132">.</span><span class="ident" id="5888133">removeDepLocked</span><span class="op" id="5888148">(</span><span class="ident" id="5888149">x</span><span class="op" id="5888150">,</span>&nbsp;<span class="ident" id="5888152">dep</span><span class="op" id="5888155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888158">db</span><span class="op" id="5888160">.</span><span class="ident" id="5888161">mu</span><span class="op" id="5888163">.</span><span class="ident" id="5888164">Unlock</span><span class="op" id="5888170">(</span><span class="op" id="5888171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888174">return</span>&nbsp;<span class="ident" id="5888181">fn</span><span class="op" id="5888183">(</span><span class="op" id="5888184">)</span><br>
<span class="lineno">390</span><span class="op" id="5888186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5888189">func</span>&nbsp;<span class="op" id="5888194">(</span><span class="ident" id="5888195">db</span>&nbsp;<span class="op" id="5888198">*</span><span class="ident" id="5888199">DB</span><span class="op" id="5888201">)</span>&nbsp;<span class="ident" id="5888203">removeDepLocked</span><span class="op" id="5888218">(</span><span class="ident" id="5888219">x</span>&nbsp;<span class="ident" id="5888221">finalCloser</span><span class="op" id="5888232">,</span>&nbsp;<span class="ident" id="5888234">dep</span>&nbsp;<span class="keyword" id="5888238">interface</span><span class="op" id="5888247">{</span><span class="op" id="5888248">}</span><span class="op" id="5888249">)</span>&nbsp;<span class="keyword" id="5888251">func</span><span class="op" id="5888255">(</span><span class="op" id="5888256">)</span>&nbsp;<span class="builtintype" id="5888258">error</span>&nbsp;<span class="op" id="5888264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5888267">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888335">xdep</span><span class="op" id="5888339">,</span>&nbsp;<span class="ident" id="5888341">ok</span>&nbsp;<span class="op" id="5888344">:=</span>&nbsp;<span class="ident" id="5888347">db</span><span class="op" id="5888349">.</span><span class="ident" id="5888350">dep</span><span class="op" id="5888353">[</span><span class="ident" id="5888354">x</span><span class="op" id="5888355">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888358">if</span>&nbsp;<span class="op" id="5888361">!</span><span class="ident" id="5888362">ok</span>&nbsp;<span class="op" id="5888365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5888369">panic</span><span class="op" id="5888374">(</span><span class="ident" id="5888375">fmt</span><span class="op" id="5888378">.</span><span class="ident" id="5888379">Sprintf</span><span class="op" id="5888386">(</span><span class="string" id="5888387">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="5888423">,</span>&nbsp;<span class="ident" id="5888425">x</span><span class="op" id="5888426">)</span><span class="op" id="5888427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888434">l0</span>&nbsp;<span class="op" id="5888437">:=</span>&nbsp;<span class="builtinfunc" id="5888440">len</span><span class="op" id="5888443">(</span><span class="ident" id="5888444">xdep</span><span class="op" id="5888448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5888451">delete</span><span class="op" id="5888457">(</span><span class="ident" id="5888458">xdep</span><span class="op" id="5888462">,</span>&nbsp;<span class="ident" id="5888464">dep</span><span class="op" id="5888467">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888471">switch</span>&nbsp;<span class="builtinfunc" id="5888478">len</span><span class="op" id="5888481">(</span><span class="ident" id="5888482">xdep</span><span class="op" id="5888486">)</span>&nbsp;<span class="op" id="5888488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888491">case</span>&nbsp;<span class="ident" id="5888496">l0</span><span class="op" id="5888498">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5888502">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5888542">panic</span><span class="op" id="5888547">(</span><span class="ident" id="5888548">fmt</span><span class="op" id="5888551">.</span><span class="ident" id="5888552">Sprintf</span><span class="op" id="5888559">(</span><span class="string" id="5888560">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="5888597">,</span>&nbsp;<span class="ident" id="5888599">dep</span><span class="op" id="5888602">,</span>&nbsp;<span class="ident" id="5888604">x</span><span class="op" id="5888605">)</span><span class="op" id="5888606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888609">case</span>&nbsp;<span class="num" id="5888614">0</span><span class="op" id="5888615">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5888619">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5888646">delete</span><span class="op" id="5888652">(</span><span class="ident" id="5888653">db</span><span class="op" id="5888655">.</span><span class="ident" id="5888656">dep</span><span class="op" id="5888659">,</span>&nbsp;<span class="ident" id="5888661">x</span><span class="op" id="5888662">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888666">return</span>&nbsp;<span class="ident" id="5888673">x</span><span class="op" id="5888674">.</span><span class="ident" id="5888675">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888687">default</span><span class="op" id="5888694">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5888698">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888724">return</span>&nbsp;<span class="keyword" id="5888731">func</span><span class="op" id="5888735">(</span><span class="op" id="5888736">)</span>&nbsp;<span class="builtintype" id="5888738">error</span>&nbsp;<span class="op" id="5888744">{</span>&nbsp;<span class="keyword" id="5888746">return</span>&nbsp;<span class="ident" id="5888753">nil</span>&nbsp;<span class="op" id="5888757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888760">}</span><br>
<span class="lineno">415</span><span class="op" id="5888762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5888765">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="5888837">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5888899">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="5888963">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="5889040">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="5889116">var</span>&nbsp;<span class="ident" id="5889120">connectionRequestQueueSize</span>&nbsp;<span class="op" id="5889147">=</span>&nbsp;<span class="num" id="5889149">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5889158">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="5889227">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5889297">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="5889342">//</span><br>
<span class="lineno"></span><span class="comment" id="5889345">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5889413">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="5889485">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5889555">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="5889589">//</span><br>
<span class="lineno"></span><span class="comment" id="5889592">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5889662">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="5889733">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="5889742">//</span><br>
<span class="lineno"></span><span class="comment" id="5889745">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5889814">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="5889880">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="5889946">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="5889961">func</span>&nbsp;<span class="ident" id="5889966">Open</span><span class="op" id="5889970">(</span><span class="ident" id="5889971">driverName</span><span class="op" id="5889981">,</span>&nbsp;<span class="ident" id="5889983">dataSourceName</span>&nbsp;<span class="builtintype" id="5889998">string</span><span class="op" id="5890004">)</span>&nbsp;<span class="op" id="5890006">(</span><span class="op" id="5890007">*</span><span class="ident" id="5890008">DB</span><span class="op" id="5890010">,</span>&nbsp;<span class="builtintype" id="5890012">error</span><span class="op" id="5890017">)</span>&nbsp;<span class="op" id="5890019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890022">driveri</span><span class="op" id="5890029">,</span>&nbsp;<span class="ident" id="5890031">ok</span>&nbsp;<span class="op" id="5890034">:=</span>&nbsp;<span class="ident" id="5890037">drivers</span><span class="op" id="5890044">[</span><span class="ident" id="5890045">driverName</span><span class="op" id="5890055">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890058">if</span>&nbsp;<span class="op" id="5890061">!</span><span class="ident" id="5890062">ok</span>&nbsp;<span class="op" id="5890065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890069">return</span>&nbsp;<span class="ident" id="5890076">nil</span><span class="op" id="5890079">,</span>&nbsp;<span class="ident" id="5890081">fmt</span><span class="op" id="5890084">.</span><span class="ident" id="5890085">Errorf</span><span class="op" id="5890091">(</span><span class="string" id="5890092">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="5890136">,</span>&nbsp;<span class="ident" id="5890138">driverName</span><span class="op" id="5890148">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890154">db</span>&nbsp;<span class="op" id="5890157">:=</span>&nbsp;<span class="op" id="5890160">&amp;</span><span class="ident" id="5890161">DB</span><span class="op" id="5890163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890167">driver</span><span class="op" id="5890173">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5890177">driveri</span><span class="op" id="5890184">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890188">dsn</span><span class="op" id="5890191">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5890198">dataSourceName</span><span class="op" id="5890212">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890216">openerCh</span><span class="op" id="5890224">:</span>&nbsp;<span class="builtinfunc" id="5890226">make</span><span class="op" id="5890230">(</span><span class="keyword" id="5890231">chan</span>&nbsp;<span class="keyword" id="5890236">struct</span><span class="op" id="5890242">{</span><span class="op" id="5890243">}</span><span class="op" id="5890244">,</span>&nbsp;<span class="ident" id="5890246">connectionRequestQueueSize</span><span class="op" id="5890272">)</span><span class="op" id="5890273">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890277">lastPut</span><span class="op" id="5890284">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5890287">make</span><span class="op" id="5890291">(</span><span class="keyword" id="5890292">map</span><span class="op" id="5890295">[</span><span class="op" id="5890296">*</span><span class="ident" id="5890297">driverConn</span><span class="op" id="5890307">]</span><span class="builtintype" id="5890308">string</span><span class="op" id="5890314">)</span><span class="op" id="5890315">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890321">go</span>&nbsp;<span class="ident" id="5890324">db</span><span class="op" id="5890326">.</span><span class="ident" id="5890327">connectionOpener</span><span class="op" id="5890343">(</span><span class="op" id="5890344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890347">return</span>&nbsp;<span class="ident" id="5890354">db</span><span class="op" id="5890356">,</span>&nbsp;<span class="ident" id="5890358">nil</span><br>
<span class="lineno"></span><span class="op" id="5890362">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5890365">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="5890427">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5890470">func</span>&nbsp;<span class="op" id="5890475">(</span><span class="ident" id="5890476">db</span>&nbsp;<span class="op" id="5890479">*</span><span class="ident" id="5890480">DB</span><span class="op" id="5890482">)</span>&nbsp;<span class="ident" id="5890484">Ping</span><span class="op" id="5890488">(</span><span class="op" id="5890489">)</span>&nbsp;<span class="builtintype" id="5890491">error</span>&nbsp;<span class="op" id="5890497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890500">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890563">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890622">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890636">dc</span><span class="op" id="5890638">,</span>&nbsp;<span class="ident" id="5890640">err</span>&nbsp;<span class="op" id="5890644">:=</span>&nbsp;<span class="ident" id="5890647">db</span><span class="op" id="5890649">.</span><span class="ident" id="5890650">conn</span><span class="op" id="5890654">(</span><span class="op" id="5890655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890658">if</span>&nbsp;<span class="ident" id="5890661">err</span>&nbsp;<span class="op" id="5890665">!=</span>&nbsp;<span class="ident" id="5890668">nil</span>&nbsp;<span class="op" id="5890672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890676">return</span>&nbsp;<span class="ident" id="5890683">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890691">db</span><span class="op" id="5890693">.</span><span class="ident" id="5890694">putConn</span><span class="op" id="5890701">(</span><span class="ident" id="5890702">dc</span><span class="op" id="5890704">,</span>&nbsp;<span class="ident" id="5890706">nil</span><span class="op" id="5890709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890712">return</span>&nbsp;<span class="ident" id="5890719">nil</span><br>
<span class="lineno"></span><span class="op" id="5890723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="5890726">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="5890786">//</span><br>
<span class="lineno"></span><span class="comment" id="5890789">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5890850">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5890900">func</span>&nbsp;<span class="op" id="5890905">(</span><span class="ident" id="5890906">db</span>&nbsp;<span class="op" id="5890909">*</span><span class="ident" id="5890910">DB</span><span class="op" id="5890912">)</span>&nbsp;<span class="ident" id="5890914">Close</span><span class="op" id="5890919">(</span><span class="op" id="5890920">)</span>&nbsp;<span class="builtintype" id="5890922">error</span>&nbsp;<span class="op" id="5890928">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890931">db</span><span class="op" id="5890933">.</span><span class="ident" id="5890934">mu</span><span class="op" id="5890936">.</span><span class="ident" id="5890937">Lock</span><span class="op" id="5890941">(</span><span class="op" id="5890942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890945">if</span>&nbsp;<span class="ident" id="5890948">db</span><span class="op" id="5890950">.</span><span class="ident" id="5890951">closed</span>&nbsp;<span class="op" id="5890958">{</span>&nbsp;<span class="comment" id="5890960">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890990">db</span><span class="op" id="5890992">.</span><span class="ident" id="5890993">mu</span><span class="op" id="5890995">.</span><span class="ident" id="5890996">Unlock</span><span class="op" id="5891002">(</span><span class="op" id="5891003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891007">return</span>&nbsp;<span class="ident" id="5891014">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891019">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5891022">close</span><span class="op" id="5891027">(</span><span class="ident" id="5891028">db</span><span class="op" id="5891030">.</span><span class="ident" id="5891031">openerCh</span><span class="op" id="5891039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891042">var</span>&nbsp;<span class="ident" id="5891046">err</span>&nbsp;<span class="builtintype" id="5891050">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891057">fns</span>&nbsp;<span class="op" id="5891061">:=</span>&nbsp;<span class="builtinfunc" id="5891064">make</span><span class="op" id="5891068">(</span><span class="op" id="5891069">[</span><span class="op" id="5891070">]</span><span class="keyword" id="5891071">func</span><span class="op" id="5891075">(</span><span class="op" id="5891076">)</span>&nbsp;<span class="builtintype" id="5891078">error</span><span class="op" id="5891083">,</span>&nbsp;<span class="num" id="5891085">0</span><span class="op" id="5891086">,</span>&nbsp;<span class="builtinfunc" id="5891088">len</span><span class="op" id="5891091">(</span><span class="ident" id="5891092">db</span><span class="op" id="5891094">.</span><span class="ident" id="5891095">freeConn</span><span class="op" id="5891103">)</span><span class="op" id="5891104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891107">for</span>&nbsp;<span class="ident" id="5891111">_</span><span class="op" id="5891112">,</span>&nbsp;<span class="ident" id="5891114">dc</span>&nbsp;<span class="op" id="5891117">:=</span>&nbsp;<span class="keyword" id="5891120">range</span>&nbsp;<span class="ident" id="5891126">db</span><span class="op" id="5891128">.</span><span class="ident" id="5891129">freeConn</span>&nbsp;<span class="op" id="5891138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891142">fns</span>&nbsp;<span class="op" id="5891146">=</span>&nbsp;<span class="builtinfunc" id="5891148">append</span><span class="op" id="5891154">(</span><span class="ident" id="5891155">fns</span><span class="op" id="5891158">,</span>&nbsp;<span class="ident" id="5891160">dc</span><span class="op" id="5891162">.</span><span class="ident" id="5891163">closeDBLocked</span><span class="op" id="5891176">(</span><span class="op" id="5891177">)</span><span class="op" id="5891178">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891184">db</span><span class="op" id="5891186">.</span><span class="ident" id="5891187">freeConn</span>&nbsp;<span class="op" id="5891196">=</span>&nbsp;<span class="ident" id="5891198">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891203">db</span><span class="op" id="5891205">.</span><span class="ident" id="5891206">closed</span>&nbsp;<span class="op" id="5891213">=</span>&nbsp;<span class="ident" id="5891215">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891221">for</span>&nbsp;<span class="ident" id="5891225">_</span><span class="op" id="5891226">,</span>&nbsp;<span class="ident" id="5891228">req</span>&nbsp;<span class="op" id="5891232">:=</span>&nbsp;<span class="keyword" id="5891235">range</span>&nbsp;<span class="ident" id="5891241">db</span><span class="op" id="5891243">.</span><span class="ident" id="5891244">connRequests</span>&nbsp;<span class="op" id="5891257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5891261">close</span><span class="op" id="5891266">(</span><span class="ident" id="5891267">req</span><span class="op" id="5891270">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891276">db</span><span class="op" id="5891278">.</span><span class="ident" id="5891279">mu</span><span class="op" id="5891281">.</span><span class="ident" id="5891282">Unlock</span><span class="op" id="5891288">(</span><span class="op" id="5891289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891292">for</span>&nbsp;<span class="ident" id="5891296">_</span><span class="op" id="5891297">,</span>&nbsp;<span class="ident" id="5891299">fn</span>&nbsp;<span class="op" id="5891302">:=</span>&nbsp;<span class="keyword" id="5891305">range</span>&nbsp;<span class="ident" id="5891311">fns</span>&nbsp;<span class="op" id="5891315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891319">err1</span>&nbsp;<span class="op" id="5891324">:=</span>&nbsp;<span class="ident" id="5891327">fn</span><span class="op" id="5891329">(</span><span class="op" id="5891330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891334">if</span>&nbsp;<span class="ident" id="5891337">err1</span>&nbsp;<span class="op" id="5891342">!=</span>&nbsp;<span class="ident" id="5891345">nil</span>&nbsp;<span class="op" id="5891349">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891354">err</span>&nbsp;<span class="op" id="5891358">=</span>&nbsp;<span class="ident" id="5891360">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891373">return</span>&nbsp;<span class="ident" id="5891380">err</span><br>
<span class="lineno"></span><span class="op" id="5891384">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5891387">const</span>&nbsp;<span class="ident" id="5891393">defaultMaxIdleConns</span>&nbsp;<span class="op" id="5891413">=</span>&nbsp;<span class="num" id="5891415">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5891418">func</span>&nbsp;<span class="op" id="5891423">(</span><span class="ident" id="5891424">db</span>&nbsp;<span class="op" id="5891427">*</span><span class="ident" id="5891428">DB</span><span class="op" id="5891430">)</span>&nbsp;<span class="ident" id="5891432">maxIdleConnsLocked</span><span class="op" id="5891450">(</span><span class="op" id="5891451">)</span>&nbsp;<span class="builtintype" id="5891453">int</span>&nbsp;<span class="op" id="5891457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891460">n</span>&nbsp;<span class="op" id="5891462">:=</span>&nbsp;<span class="ident" id="5891465">db</span><span class="op" id="5891467">.</span><span class="ident" id="5891468">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891477">switch</span>&nbsp;<span class="op" id="5891484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891487">case</span>&nbsp;<span class="ident" id="5891492">n</span>&nbsp;<span class="op" id="5891494">==</span>&nbsp;<span class="num" id="5891497">0</span><span class="op" id="5891498">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891502">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891576">return</span>&nbsp;<span class="ident" id="5891583">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891604">case</span>&nbsp;<span class="ident" id="5891609">n</span>&nbsp;<span class="op" id="5891611">&lt;</span>&nbsp;<span class="num" id="5891613">0</span><span class="op" id="5891614">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891618">return</span>&nbsp;<span class="num" id="5891625">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891628">default</span><span class="op" id="5891635">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891639">return</span>&nbsp;<span class="ident" id="5891646">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891649">}</span><br>
<span class="lineno"></span><span class="op" id="5891651">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="5891654">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5891724">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="5891744">//</span><br>
<span class="lineno"></span><span class="comment" id="5891747">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="5891819">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="5891896">//</span><br>
<span class="lineno"></span><span class="comment" id="5891899">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="5891947">func</span>&nbsp;<span class="op" id="5891952">(</span><span class="ident" id="5891953">db</span>&nbsp;<span class="op" id="5891956">*</span><span class="ident" id="5891957">DB</span><span class="op" id="5891959">)</span>&nbsp;<span class="ident" id="5891961">SetMaxIdleConns</span><span class="op" id="5891976">(</span><span class="ident" id="5891977">n</span>&nbsp;<span class="builtintype" id="5891979">int</span><span class="op" id="5891982">)</span>&nbsp;<span class="op" id="5891984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891987">db</span><span class="op" id="5891989">.</span><span class="ident" id="5891990">mu</span><span class="op" id="5891992">.</span><span class="ident" id="5891993">Lock</span><span class="op" id="5891997">(</span><span class="op" id="5891998">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892001">if</span>&nbsp;<span class="ident" id="5892004">n</span>&nbsp;<span class="op" id="5892006">&gt;</span>&nbsp;<span class="num" id="5892008">0</span>&nbsp;<span class="op" id="5892010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892014">db</span><span class="op" id="5892016">.</span><span class="ident" id="5892017">maxIdle</span>&nbsp;<span class="op" id="5892025">=</span>&nbsp;<span class="ident" id="5892027">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892030">}</span>&nbsp;<span class="keyword" id="5892032">else</span>&nbsp;<span class="op" id="5892037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5892041">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892067">db</span><span class="op" id="5892069">.</span><span class="ident" id="5892070">maxIdle</span>&nbsp;<span class="op" id="5892078">=</span>&nbsp;<span class="op" id="5892080">-</span><span class="num" id="5892081">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5892087">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892132">if</span>&nbsp;<span class="ident" id="5892135">db</span><span class="op" id="5892137">.</span><span class="ident" id="5892138">maxOpen</span>&nbsp;<span class="op" id="5892146">&gt;</span>&nbsp;<span class="num" id="5892148">0</span>&nbsp;<span class="op" id="5892150">&amp;&amp;</span>&nbsp;<span class="ident" id="5892153">db</span><span class="op" id="5892155">.</span><span class="ident" id="5892156">maxIdleConnsLocked</span><span class="op" id="5892174">(</span><span class="op" id="5892175">)</span>&nbsp;<span class="op" id="5892177">&gt;</span>&nbsp;<span class="ident" id="5892179">db</span><span class="op" id="5892181">.</span><span class="ident" id="5892182">maxOpen</span>&nbsp;<span class="op" id="5892190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892194">db</span><span class="op" id="5892196">.</span><span class="ident" id="5892197">maxIdle</span>&nbsp;<span class="op" id="5892205">=</span>&nbsp;<span class="ident" id="5892207">db</span><span class="op" id="5892209">.</span><span class="ident" id="5892210">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892219">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892222">var</span>&nbsp;<span class="ident" id="5892226">closing</span>&nbsp;<span class="op" id="5892234">[</span><span class="op" id="5892235">]</span><span class="op" id="5892236">*</span><span class="ident" id="5892237">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892249">idleCount</span>&nbsp;<span class="op" id="5892259">:=</span>&nbsp;<span class="builtinfunc" id="5892262">len</span><span class="op" id="5892265">(</span><span class="ident" id="5892266">db</span><span class="op" id="5892268">.</span><span class="ident" id="5892269">freeConn</span><span class="op" id="5892277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892280">maxIdle</span>&nbsp;<span class="op" id="5892288">:=</span>&nbsp;<span class="ident" id="5892291">db</span><span class="op" id="5892293">.</span><span class="ident" id="5892294">maxIdleConnsLocked</span><span class="op" id="5892312">(</span><span class="op" id="5892313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892316">if</span>&nbsp;<span class="ident" id="5892319">idleCount</span>&nbsp;<span class="op" id="5892329">&gt;</span>&nbsp;<span class="ident" id="5892331">maxIdle</span>&nbsp;<span class="op" id="5892339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892343">closing</span>&nbsp;<span class="op" id="5892351">=</span>&nbsp;<span class="ident" id="5892353">db</span><span class="op" id="5892355">.</span><span class="ident" id="5892356">freeConn</span><span class="op" id="5892364">[</span><span class="ident" id="5892365">maxIdle</span><span class="op" id="5892372">:</span><span class="op" id="5892373">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892377">db</span><span class="op" id="5892379">.</span><span class="ident" id="5892380">freeConn</span>&nbsp;<span class="op" id="5892389">=</span>&nbsp;<span class="ident" id="5892391">db</span><span class="op" id="5892393">.</span><span class="ident" id="5892394">freeConn</span><span class="op" id="5892402">[</span><span class="op" id="5892403">:</span><span class="ident" id="5892404">maxIdle</span><span class="op" id="5892411">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892417">db</span><span class="op" id="5892419">.</span><span class="ident" id="5892420">mu</span><span class="op" id="5892422">.</span><span class="ident" id="5892423">Unlock</span><span class="op" id="5892429">(</span><span class="op" id="5892430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892433">for</span>&nbsp;<span class="ident" id="5892437">_</span><span class="op" id="5892438">,</span>&nbsp;<span class="ident" id="5892440">c</span>&nbsp;<span class="op" id="5892442">:=</span>&nbsp;<span class="keyword" id="5892445">range</span>&nbsp;<span class="ident" id="5892451">closing</span>&nbsp;<span class="op" id="5892459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892463">c</span><span class="op" id="5892464">.</span><span class="ident" id="5892465">Close</span><span class="op" id="5892470">(</span><span class="op" id="5892471">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892474">}</span><br>
<span class="lineno"></span><span class="op" id="5892476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5892479">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="5892559">//</span><br>
<span class="lineno">550</span><span class="comment" id="5892562">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="5892637">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="5892705">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="5892727">//</span><br>
<span class="lineno"></span><span class="comment" id="5892730">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="5892802">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="5892835">func</span>&nbsp;<span class="op" id="5892840">(</span><span class="ident" id="5892841">db</span>&nbsp;<span class="op" id="5892844">*</span><span class="ident" id="5892845">DB</span><span class="op" id="5892847">)</span>&nbsp;<span class="ident" id="5892849">SetMaxOpenConns</span><span class="op" id="5892864">(</span><span class="ident" id="5892865">n</span>&nbsp;<span class="builtintype" id="5892867">int</span><span class="op" id="5892870">)</span>&nbsp;<span class="op" id="5892872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892875">db</span><span class="op" id="5892877">.</span><span class="ident" id="5892878">mu</span><span class="op" id="5892880">.</span><span class="ident" id="5892881">Lock</span><span class="op" id="5892885">(</span><span class="op" id="5892886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892889">db</span><span class="op" id="5892891">.</span><span class="ident" id="5892892">maxOpen</span>&nbsp;<span class="op" id="5892900">=</span>&nbsp;<span class="ident" id="5892902">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892905">if</span>&nbsp;<span class="ident" id="5892908">n</span>&nbsp;<span class="op" id="5892910">&lt;</span>&nbsp;<span class="num" id="5892912">0</span>&nbsp;<span class="op" id="5892914">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892918">db</span><span class="op" id="5892920">.</span><span class="ident" id="5892921">maxOpen</span>&nbsp;<span class="op" id="5892929">=</span>&nbsp;<span class="num" id="5892931">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892937">syncMaxIdle</span>&nbsp;<span class="op" id="5892949">:=</span>&nbsp;<span class="ident" id="5892952">db</span><span class="op" id="5892954">.</span><span class="ident" id="5892955">maxOpen</span>&nbsp;<span class="op" id="5892963">&gt;</span>&nbsp;<span class="num" id="5892965">0</span>&nbsp;<span class="op" id="5892967">&amp;&amp;</span>&nbsp;<span class="ident" id="5892970">db</span><span class="op" id="5892972">.</span><span class="ident" id="5892973">maxIdleConnsLocked</span><span class="op" id="5892991">(</span><span class="op" id="5892992">)</span>&nbsp;<span class="op" id="5892994">&gt;</span>&nbsp;<span class="ident" id="5892996">db</span><span class="op" id="5892998">.</span><span class="ident" id="5892999">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893008">db</span><span class="op" id="5893010">.</span><span class="ident" id="5893011">mu</span><span class="op" id="5893013">.</span><span class="ident" id="5893014">Unlock</span><span class="op" id="5893020">(</span><span class="op" id="5893021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893024">if</span>&nbsp;<span class="ident" id="5893027">syncMaxIdle</span>&nbsp;<span class="op" id="5893039">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893043">db</span><span class="op" id="5893045">.</span><span class="ident" id="5893046">SetMaxIdleConns</span><span class="op" id="5893061">(</span><span class="ident" id="5893062">n</span><span class="op" id="5893063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893066">}</span><br>
<span class="lineno"></span><span class="op" id="5893068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5893071">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="5893099">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="5893174">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="5893233">func</span>&nbsp;<span class="op" id="5893238">(</span><span class="ident" id="5893239">db</span>&nbsp;<span class="op" id="5893242">*</span><span class="ident" id="5893243">DB</span><span class="op" id="5893245">)</span>&nbsp;<span class="ident" id="5893247">maybeOpenNewConnections</span><span class="op" id="5893270">(</span><span class="op" id="5893271">)</span>&nbsp;<span class="op" id="5893273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893276">numRequests</span>&nbsp;<span class="op" id="5893288">:=</span>&nbsp;<span class="builtinfunc" id="5893291">len</span><span class="op" id="5893294">(</span><span class="ident" id="5893295">db</span><span class="op" id="5893297">.</span><span class="ident" id="5893298">connRequests</span><span class="op" id="5893310">)</span>&nbsp;<span class="op" id="5893312">-</span>&nbsp;<span class="ident" id="5893314">db</span><span class="op" id="5893316">.</span><span class="ident" id="5893317">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893331">if</span>&nbsp;<span class="ident" id="5893334">db</span><span class="op" id="5893336">.</span><span class="ident" id="5893337">maxOpen</span>&nbsp;<span class="op" id="5893345">&gt;</span>&nbsp;<span class="num" id="5893347">0</span>&nbsp;<span class="op" id="5893349">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893353">numCanOpen</span>&nbsp;<span class="op" id="5893364">:=</span>&nbsp;<span class="ident" id="5893367">db</span><span class="op" id="5893369">.</span><span class="ident" id="5893370">maxOpen</span>&nbsp;<span class="op" id="5893378">-</span>&nbsp;<span class="op" id="5893380">(</span><span class="ident" id="5893381">db</span><span class="op" id="5893383">.</span><span class="ident" id="5893384">numOpen</span>&nbsp;<span class="op" id="5893392">+</span>&nbsp;<span class="ident" id="5893394">db</span><span class="op" id="5893396">.</span><span class="ident" id="5893397">pendingOpens</span><span class="op" id="5893409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893413">if</span>&nbsp;<span class="ident" id="5893416">numRequests</span>&nbsp;<span class="op" id="5893428">&gt;</span>&nbsp;<span class="ident" id="5893430">numCanOpen</span>&nbsp;<span class="op" id="5893441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893446">numRequests</span>&nbsp;<span class="op" id="5893458">=</span>&nbsp;<span class="ident" id="5893460">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893476">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893479">for</span>&nbsp;<span class="ident" id="5893483">numRequests</span>&nbsp;<span class="op" id="5893495">&gt;</span>&nbsp;<span class="num" id="5893497">0</span>&nbsp;<span class="op" id="5893499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893503">db</span><span class="op" id="5893505">.</span><span class="ident" id="5893506">pendingOpens</span><span class="op" id="5893518">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893523">numRequests</span><span class="op" id="5893534">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893539">db</span><span class="op" id="5893541">.</span><span class="ident" id="5893542">openerCh</span>&nbsp;<span class="op" id="5893551">&lt;-</span>&nbsp;<span class="keyword" id="5893554">struct</span><span class="op" id="5893560">{</span><span class="op" id="5893561">}</span><span class="op" id="5893562">{</span><span class="op" id="5893563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893566">}</span><br>
<span class="lineno">585</span><span class="op" id="5893568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5893571">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="5893642">func</span>&nbsp;<span class="op" id="5893647">(</span><span class="ident" id="5893648">db</span>&nbsp;<span class="op" id="5893651">*</span><span class="ident" id="5893652">DB</span><span class="op" id="5893654">)</span>&nbsp;<span class="ident" id="5893656">connectionOpener</span><span class="op" id="5893672">(</span><span class="op" id="5893673">)</span>&nbsp;<span class="op" id="5893675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893678">for</span>&nbsp;<span class="keyword" id="5893682">range</span>&nbsp;<span class="ident" id="5893688">db</span><span class="op" id="5893690">.</span><span class="ident" id="5893691">openerCh</span>&nbsp;<span class="op" id="5893700">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893704">db</span><span class="op" id="5893706">.</span><span class="ident" id="5893707">openNewConnection</span><span class="op" id="5893724">(</span><span class="op" id="5893725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893728">}</span><br>
<span class="lineno"></span><span class="op" id="5893730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5893733">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="5893760">func</span>&nbsp;<span class="op" id="5893765">(</span><span class="ident" id="5893766">db</span>&nbsp;<span class="op" id="5893769">*</span><span class="ident" id="5893770">DB</span><span class="op" id="5893772">)</span>&nbsp;<span class="ident" id="5893774">openNewConnection</span><span class="op" id="5893791">(</span><span class="op" id="5893792">)</span>&nbsp;<span class="op" id="5893794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893797">ci</span><span class="op" id="5893799">,</span>&nbsp;<span class="ident" id="5893801">err</span>&nbsp;<span class="op" id="5893805">:=</span>&nbsp;<span class="ident" id="5893808">db</span><span class="op" id="5893810">.</span><span class="ident" id="5893811">driver</span><span class="op" id="5893817">.</span><span class="ident" id="5893818">Open</span><span class="op" id="5893822">(</span><span class="ident" id="5893823">db</span><span class="op" id="5893825">.</span><span class="ident" id="5893826">dsn</span><span class="op" id="5893829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893832">db</span><span class="op" id="5893834">.</span><span class="ident" id="5893835">mu</span><span class="op" id="5893837">.</span><span class="ident" id="5893838">Lock</span><span class="op" id="5893842">(</span><span class="op" id="5893843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893846">defer</span>&nbsp;<span class="ident" id="5893852">db</span><span class="op" id="5893854">.</span><span class="ident" id="5893855">mu</span><span class="op" id="5893857">.</span><span class="ident" id="5893858">Unlock</span><span class="op" id="5893864">(</span><span class="op" id="5893865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893868">if</span>&nbsp;<span class="ident" id="5893871">db</span><span class="op" id="5893873">.</span><span class="ident" id="5893874">closed</span>&nbsp;<span class="op" id="5893881">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893885">if</span>&nbsp;<span class="ident" id="5893888">err</span>&nbsp;<span class="op" id="5893892">==</span>&nbsp;<span class="ident" id="5893895">nil</span>&nbsp;<span class="op" id="5893899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893904">ci</span><span class="op" id="5893906">.</span><span class="ident" id="5893907">Close</span><span class="op" id="5893912">(</span><span class="op" id="5893913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893921">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893929">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893932">db</span><span class="op" id="5893934">.</span><span class="ident" id="5893935">pendingOpens</span><span class="op" id="5893947">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893951">if</span>&nbsp;<span class="ident" id="5893954">err</span>&nbsp;<span class="op" id="5893958">!=</span>&nbsp;<span class="ident" id="5893961">nil</span>&nbsp;<span class="op" id="5893965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893969">db</span><span class="op" id="5893971">.</span><span class="ident" id="5893972">putConnDBLocked</span><span class="op" id="5893987">(</span><span class="ident" id="5893988">nil</span><span class="op" id="5893991">,</span>&nbsp;<span class="ident" id="5893993">err</span><span class="op" id="5893996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894000">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894008">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894011">dc</span>&nbsp;<span class="op" id="5894014">:=</span>&nbsp;<span class="op" id="5894017">&amp;</span><span class="ident" id="5894018">driverConn</span><span class="op" id="5894028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894032">db</span><span class="op" id="5894034">:</span>&nbsp;<span class="ident" id="5894036">db</span><span class="op" id="5894038">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894042">ci</span><span class="op" id="5894044">:</span>&nbsp;<span class="ident" id="5894046">ci</span><span class="op" id="5894048">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894054">if</span>&nbsp;<span class="ident" id="5894057">db</span><span class="op" id="5894059">.</span><span class="ident" id="5894060">putConnDBLocked</span><span class="op" id="5894075">(</span><span class="ident" id="5894076">dc</span><span class="op" id="5894078">,</span>&nbsp;<span class="ident" id="5894080">err</span><span class="op" id="5894083">)</span>&nbsp;<span class="op" id="5894085">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894089">db</span><span class="op" id="5894091">.</span><span class="ident" id="5894092">addDepLocked</span><span class="op" id="5894104">(</span><span class="ident" id="5894105">dc</span><span class="op" id="5894107">,</span>&nbsp;<span class="ident" id="5894109">dc</span><span class="op" id="5894111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894115">db</span><span class="op" id="5894117">.</span><span class="ident" id="5894118">numOpen</span><span class="op" id="5894125">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894129">}</span>&nbsp;<span class="keyword" id="5894131">else</span>&nbsp;<span class="op" id="5894136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894140">ci</span><span class="op" id="5894142">.</span><span class="ident" id="5894143">Close</span><span class="op" id="5894148">(</span><span class="op" id="5894149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894152">}</span><br>
<span class="lineno">620</span><span class="op" id="5894154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5894157">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5894216">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="5894285">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="5894346">type</span>&nbsp;<span class="ident" id="5894351">connRequest</span>&nbsp;<span class="keyword" id="5894363">struct</span>&nbsp;<span class="op" id="5894370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894373">conn</span>&nbsp;<span class="op" id="5894378">*</span><span class="ident" id="5894379">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894391">err</span>&nbsp;&nbsp;<span class="builtintype" id="5894396">error</span><br>
<span class="lineno"></span><span class="op" id="5894402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="5894405">var</span>&nbsp;<span class="ident" id="5894409">errDBClosed</span>&nbsp;<span class="op" id="5894421">=</span>&nbsp;<span class="ident" id="5894423">errors</span><span class="op" id="5894429">.</span><span class="ident" id="5894430">New</span><span class="op" id="5894433">(</span><span class="string" id="5894434">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5894459">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5894462">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="5894515">func</span>&nbsp;<span class="op" id="5894520">(</span><span class="ident" id="5894521">db</span>&nbsp;<span class="op" id="5894524">*</span><span class="ident" id="5894525">DB</span><span class="op" id="5894527">)</span>&nbsp;<span class="ident" id="5894529">conn</span><span class="op" id="5894533">(</span><span class="op" id="5894534">)</span>&nbsp;<span class="op" id="5894536">(</span><span class="op" id="5894537">*</span><span class="ident" id="5894538">driverConn</span><span class="op" id="5894548">,</span>&nbsp;<span class="builtintype" id="5894550">error</span><span class="op" id="5894555">)</span>&nbsp;<span class="op" id="5894557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894560">db</span><span class="op" id="5894562">.</span><span class="ident" id="5894563">mu</span><span class="op" id="5894565">.</span><span class="ident" id="5894566">Lock</span><span class="op" id="5894570">(</span><span class="op" id="5894571">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894574">if</span>&nbsp;<span class="ident" id="5894577">db</span><span class="op" id="5894579">.</span><span class="ident" id="5894580">closed</span>&nbsp;<span class="op" id="5894587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894591">db</span><span class="op" id="5894593">.</span><span class="ident" id="5894594">mu</span><span class="op" id="5894596">.</span><span class="ident" id="5894597">Unlock</span><span class="op" id="5894603">(</span><span class="op" id="5894604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894608">return</span>&nbsp;<span class="ident" id="5894615">nil</span><span class="op" id="5894618">,</span>&nbsp;<span class="ident" id="5894620">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894637">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894712">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894775">if</span>&nbsp;<span class="ident" id="5894778">db</span><span class="op" id="5894780">.</span><span class="ident" id="5894781">maxOpen</span>&nbsp;<span class="op" id="5894789">&gt;</span>&nbsp;<span class="num" id="5894791">0</span>&nbsp;<span class="op" id="5894793">&amp;&amp;</span>&nbsp;<span class="ident" id="5894796">db</span><span class="op" id="5894798">.</span><span class="ident" id="5894799">numOpen</span>&nbsp;<span class="op" id="5894807">&gt;=</span>&nbsp;<span class="ident" id="5894810">db</span><span class="op" id="5894812">.</span><span class="ident" id="5894813">maxOpen</span>&nbsp;<span class="op" id="5894821">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5894824">len</span><span class="op" id="5894827">(</span><span class="ident" id="5894828">db</span><span class="op" id="5894830">.</span><span class="ident" id="5894831">freeConn</span><span class="op" id="5894839">)</span>&nbsp;<span class="op" id="5894841">==</span>&nbsp;<span class="num" id="5894844">0</span>&nbsp;<span class="op" id="5894846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894850">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894911">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894985">req</span>&nbsp;<span class="op" id="5894989">:=</span>&nbsp;<span class="builtinfunc" id="5894992">make</span><span class="op" id="5894996">(</span><span class="keyword" id="5894997">chan</span>&nbsp;<span class="ident" id="5895002">connRequest</span><span class="op" id="5895013">,</span>&nbsp;<span class="num" id="5895015">1</span><span class="op" id="5895016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895020">db</span><span class="op" id="5895022">.</span><span class="ident" id="5895023">connRequests</span>&nbsp;<span class="op" id="5895036">=</span>&nbsp;<span class="builtinfunc" id="5895038">append</span><span class="op" id="5895044">(</span><span class="ident" id="5895045">db</span><span class="op" id="5895047">.</span><span class="ident" id="5895048">connRequests</span><span class="op" id="5895060">,</span>&nbsp;<span class="ident" id="5895062">req</span><span class="op" id="5895065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895069">db</span><span class="op" id="5895071">.</span><span class="ident" id="5895072">maybeOpenNewConnections</span><span class="op" id="5895095">(</span><span class="op" id="5895096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895100">db</span><span class="op" id="5895102">.</span><span class="ident" id="5895103">mu</span><span class="op" id="5895105">.</span><span class="ident" id="5895106">Unlock</span><span class="op" id="5895112">(</span><span class="op" id="5895113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895117">ret</span>&nbsp;<span class="op" id="5895121">:=</span>&nbsp;<span class="op" id="5895124">&lt;-</span><span class="ident" id="5895126">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895132">return</span>&nbsp;<span class="ident" id="5895139">ret</span><span class="op" id="5895142">.</span><span class="ident" id="5895143">conn</span><span class="op" id="5895147">,</span>&nbsp;<span class="ident" id="5895149">ret</span><span class="op" id="5895152">.</span><span class="ident" id="5895153">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895162">if</span>&nbsp;<span class="ident" id="5895165">c</span>&nbsp;<span class="op" id="5895167">:=</span>&nbsp;<span class="builtinfunc" id="5895170">len</span><span class="op" id="5895173">(</span><span class="ident" id="5895174">db</span><span class="op" id="5895176">.</span><span class="ident" id="5895177">freeConn</span><span class="op" id="5895185">)</span><span class="op" id="5895186">;</span>&nbsp;<span class="ident" id="5895188">c</span>&nbsp;<span class="op" id="5895190">&gt;</span>&nbsp;<span class="num" id="5895192">0</span>&nbsp;<span class="op" id="5895194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895198">conn</span>&nbsp;<span class="op" id="5895203">:=</span>&nbsp;<span class="ident" id="5895206">db</span><span class="op" id="5895208">.</span><span class="ident" id="5895209">freeConn</span><span class="op" id="5895217">[</span><span class="num" id="5895218">0</span><span class="op" id="5895219">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5895223">copy</span><span class="op" id="5895227">(</span><span class="ident" id="5895228">db</span><span class="op" id="5895230">.</span><span class="ident" id="5895231">freeConn</span><span class="op" id="5895239">,</span>&nbsp;<span class="ident" id="5895241">db</span><span class="op" id="5895243">.</span><span class="ident" id="5895244">freeConn</span><span class="op" id="5895252">[</span><span class="num" id="5895253">1</span><span class="op" id="5895254">:</span><span class="op" id="5895255">]</span><span class="op" id="5895256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895260">db</span><span class="op" id="5895262">.</span><span class="ident" id="5895263">freeConn</span>&nbsp;<span class="op" id="5895272">=</span>&nbsp;<span class="ident" id="5895274">db</span><span class="op" id="5895276">.</span><span class="ident" id="5895277">freeConn</span><span class="op" id="5895285">[</span><span class="op" id="5895286">:</span><span class="ident" id="5895287">c</span><span class="op" id="5895288">-</span><span class="num" id="5895289">1</span><span class="op" id="5895290">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895294">conn</span><span class="op" id="5895298">.</span><span class="ident" id="5895299">inUse</span>&nbsp;<span class="op" id="5895305">=</span>&nbsp;<span class="ident" id="5895307">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895314">db</span><span class="op" id="5895316">.</span><span class="ident" id="5895317">mu</span><span class="op" id="5895319">.</span><span class="ident" id="5895320">Unlock</span><span class="op" id="5895326">(</span><span class="op" id="5895327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895331">return</span>&nbsp;<span class="ident" id="5895338">conn</span><span class="op" id="5895342">,</span>&nbsp;<span class="ident" id="5895344">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895353">db</span><span class="op" id="5895355">.</span><span class="ident" id="5895356">numOpen</span><span class="op" id="5895363">++</span>&nbsp;<span class="comment" id="5895366">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895385">db</span><span class="op" id="5895387">.</span><span class="ident" id="5895388">mu</span><span class="op" id="5895390">.</span><span class="ident" id="5895391">Unlock</span><span class="op" id="5895397">(</span><span class="op" id="5895398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895401">ci</span><span class="op" id="5895403">,</span>&nbsp;<span class="ident" id="5895405">err</span>&nbsp;<span class="op" id="5895409">:=</span>&nbsp;<span class="ident" id="5895412">db</span><span class="op" id="5895414">.</span><span class="ident" id="5895415">driver</span><span class="op" id="5895421">.</span><span class="ident" id="5895422">Open</span><span class="op" id="5895426">(</span><span class="ident" id="5895427">db</span><span class="op" id="5895429">.</span><span class="ident" id="5895430">dsn</span><span class="op" id="5895433">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895436">if</span>&nbsp;<span class="ident" id="5895439">err</span>&nbsp;<span class="op" id="5895443">!=</span>&nbsp;<span class="ident" id="5895446">nil</span>&nbsp;<span class="op" id="5895450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895454">db</span><span class="op" id="5895456">.</span><span class="ident" id="5895457">mu</span><span class="op" id="5895459">.</span><span class="ident" id="5895460">Lock</span><span class="op" id="5895464">(</span><span class="op" id="5895465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895469">db</span><span class="op" id="5895471">.</span><span class="ident" id="5895472">numOpen</span><span class="op" id="5895479">--</span>&nbsp;<span class="comment" id="5895482">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895516">db</span><span class="op" id="5895518">.</span><span class="ident" id="5895519">mu</span><span class="op" id="5895521">.</span><span class="ident" id="5895522">Unlock</span><span class="op" id="5895528">(</span><span class="op" id="5895529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895533">return</span>&nbsp;<span class="ident" id="5895540">nil</span><span class="op" id="5895543">,</span>&nbsp;<span class="ident" id="5895545">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895553">db</span><span class="op" id="5895555">.</span><span class="ident" id="5895556">mu</span><span class="op" id="5895558">.</span><span class="ident" id="5895559">Lock</span><span class="op" id="5895563">(</span><span class="op" id="5895564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895567">dc</span>&nbsp;<span class="op" id="5895570">:=</span>&nbsp;<span class="op" id="5895573">&amp;</span><span class="ident" id="5895574">driverConn</span><span class="op" id="5895584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895588">db</span><span class="op" id="5895590">:</span>&nbsp;<span class="ident" id="5895592">db</span><span class="op" id="5895594">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895598">ci</span><span class="op" id="5895600">:</span>&nbsp;<span class="ident" id="5895602">ci</span><span class="op" id="5895604">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895610">db</span><span class="op" id="5895612">.</span><span class="ident" id="5895613">addDepLocked</span><span class="op" id="5895625">(</span><span class="ident" id="5895626">dc</span><span class="op" id="5895628">,</span>&nbsp;<span class="ident" id="5895630">dc</span><span class="op" id="5895632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895635">dc</span><span class="op" id="5895637">.</span><span class="ident" id="5895638">inUse</span>&nbsp;<span class="op" id="5895644">=</span>&nbsp;<span class="ident" id="5895646">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895652">db</span><span class="op" id="5895654">.</span><span class="ident" id="5895655">mu</span><span class="op" id="5895657">.</span><span class="ident" id="5895658">Unlock</span><span class="op" id="5895664">(</span><span class="op" id="5895665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895668">return</span>&nbsp;<span class="ident" id="5895675">dc</span><span class="op" id="5895677">,</span>&nbsp;<span class="ident" id="5895679">nil</span><br>
<span class="lineno">680</span><span class="op" id="5895683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5895686">var</span>&nbsp;<span class="op" id="5895690">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895693">errConnClosed</span>&nbsp;<span class="op" id="5895707">=</span>&nbsp;<span class="ident" id="5895709">errors</span><span class="op" id="5895715">.</span><span class="ident" id="5895716">New</span><span class="op" id="5895719">(</span><span class="string" id="5895720">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5895775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895778">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5895792">=</span>&nbsp;<span class="ident" id="5895794">errors</span><span class="op" id="5895800">.</span><span class="ident" id="5895801">New</span><span class="op" id="5895804">(</span><span class="string" id="5895805">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="5895858">)</span><br>
<span class="lineno">685</span><span class="op" id="5895860">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5895863">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5895935">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="5895952">//</span><br>
<span class="lineno">690</span><span class="comment" id="5895955">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5896031">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="5896071">//</span><br>
<span class="lineno"></span><span class="comment" id="5896074">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="5896131">func</span>&nbsp;<span class="op" id="5896136">(</span><span class="ident" id="5896137">db</span>&nbsp;<span class="op" id="5896140">*</span><span class="ident" id="5896141">DB</span><span class="op" id="5896143">)</span>&nbsp;<span class="ident" id="5896145">connIfFree</span><span class="op" id="5896155">(</span><span class="ident" id="5896156">wanted</span>&nbsp;<span class="op" id="5896163">*</span><span class="ident" id="5896164">driverConn</span><span class="op" id="5896174">)</span>&nbsp;<span class="op" id="5896176">(</span><span class="op" id="5896177">*</span><span class="ident" id="5896178">driverConn</span><span class="op" id="5896188">,</span>&nbsp;<span class="builtintype" id="5896190">error</span><span class="op" id="5896195">)</span>&nbsp;<span class="op" id="5896197">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896200">db</span><span class="op" id="5896202">.</span><span class="ident" id="5896203">mu</span><span class="op" id="5896205">.</span><span class="ident" id="5896206">Lock</span><span class="op" id="5896210">(</span><span class="op" id="5896211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896214">defer</span>&nbsp;<span class="ident" id="5896220">db</span><span class="op" id="5896222">.</span><span class="ident" id="5896223">mu</span><span class="op" id="5896225">.</span><span class="ident" id="5896226">Unlock</span><span class="op" id="5896232">(</span><span class="op" id="5896233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896236">if</span>&nbsp;<span class="ident" id="5896239">wanted</span><span class="op" id="5896245">.</span><span class="ident" id="5896246">dbmuClosed</span>&nbsp;<span class="op" id="5896257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896261">return</span>&nbsp;<span class="ident" id="5896268">nil</span><span class="op" id="5896271">,</span>&nbsp;<span class="ident" id="5896273">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896288">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896291">if</span>&nbsp;<span class="ident" id="5896294">wanted</span><span class="op" id="5896300">.</span><span class="ident" id="5896301">inUse</span>&nbsp;<span class="op" id="5896307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896311">return</span>&nbsp;<span class="ident" id="5896318">nil</span><span class="op" id="5896321">,</span>&nbsp;<span class="ident" id="5896323">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896339">idx</span>&nbsp;<span class="op" id="5896343">:=</span>&nbsp;<span class="op" id="5896346">-</span><span class="num" id="5896347">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896350">for</span>&nbsp;<span class="ident" id="5896354">ii</span><span class="op" id="5896356">,</span>&nbsp;<span class="ident" id="5896358">v</span>&nbsp;<span class="op" id="5896360">:=</span>&nbsp;<span class="keyword" id="5896363">range</span>&nbsp;<span class="ident" id="5896369">db</span><span class="op" id="5896371">.</span><span class="ident" id="5896372">freeConn</span>&nbsp;<span class="op" id="5896381">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896385">if</span>&nbsp;<span class="ident" id="5896388">v</span>&nbsp;<span class="op" id="5896390">==</span>&nbsp;<span class="ident" id="5896393">wanted</span>&nbsp;<span class="op" id="5896400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896405">idx</span>&nbsp;<span class="op" id="5896409">=</span>&nbsp;<span class="ident" id="5896411">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896417">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896428">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896431">if</span>&nbsp;<span class="ident" id="5896434">idx</span>&nbsp;<span class="op" id="5896438">&gt;=</span>&nbsp;<span class="num" id="5896441">0</span>&nbsp;<span class="op" id="5896443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896447">db</span><span class="op" id="5896449">.</span><span class="ident" id="5896450">freeConn</span>&nbsp;<span class="op" id="5896459">=</span>&nbsp;<span class="builtinfunc" id="5896461">append</span><span class="op" id="5896467">(</span><span class="ident" id="5896468">db</span><span class="op" id="5896470">.</span><span class="ident" id="5896471">freeConn</span><span class="op" id="5896479">[</span><span class="op" id="5896480">:</span><span class="ident" id="5896481">idx</span><span class="op" id="5896484">]</span><span class="op" id="5896485">,</span>&nbsp;<span class="ident" id="5896487">db</span><span class="op" id="5896489">.</span><span class="ident" id="5896490">freeConn</span><span class="op" id="5896498">[</span><span class="ident" id="5896499">idx</span><span class="op" id="5896502">+</span><span class="num" id="5896503">1</span><span class="op" id="5896504">:</span><span class="op" id="5896505">]</span><span class="op" id="5896506">...</span><span class="op" id="5896509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896513">wanted</span><span class="op" id="5896519">.</span><span class="ident" id="5896520">inUse</span>&nbsp;<span class="op" id="5896526">=</span>&nbsp;<span class="ident" id="5896528">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896535">return</span>&nbsp;<span class="ident" id="5896542">wanted</span><span class="op" id="5896548">,</span>&nbsp;<span class="ident" id="5896550">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896555">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5896558">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5896628">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5896705">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5896774">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5896794">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896840">return</span>&nbsp;<span class="ident" id="5896847">nil</span><span class="op" id="5896850">,</span>&nbsp;<span class="ident" id="5896852">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="5896864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5896867">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="5896905">var</span>&nbsp;<span class="ident" id="5896909">putConnHook</span>&nbsp;<span class="keyword" id="5896921">func</span><span class="op" id="5896925">(</span><span class="op" id="5896926">*</span><span class="ident" id="5896927">DB</span><span class="op" id="5896929">,</span>&nbsp;<span class="op" id="5896931">*</span><span class="ident" id="5896932">driverConn</span><span class="op" id="5896942">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="5896945">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="5897017">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5897089">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="5897108">func</span>&nbsp;<span class="op" id="5897113">(</span><span class="ident" id="5897114">db</span>&nbsp;<span class="op" id="5897117">*</span><span class="ident" id="5897118">DB</span><span class="op" id="5897120">)</span>&nbsp;<span class="ident" id="5897122">noteUnusedDriverStatement</span><span class="op" id="5897147">(</span><span class="ident" id="5897148">c</span>&nbsp;<span class="op" id="5897150">*</span><span class="ident" id="5897151">driverConn</span><span class="op" id="5897161">,</span>&nbsp;<span class="ident" id="5897163">si</span>&nbsp;<span class="ident" id="5897166">driver</span><span class="op" id="5897172">.</span><span class="ident" id="5897173">Stmt</span><span class="op" id="5897177">)</span>&nbsp;<span class="op" id="5897179">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897182">db</span><span class="op" id="5897184">.</span><span class="ident" id="5897185">mu</span><span class="op" id="5897187">.</span><span class="ident" id="5897188">Lock</span><span class="op" id="5897192">(</span><span class="op" id="5897193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897196">defer</span>&nbsp;<span class="ident" id="5897202">db</span><span class="op" id="5897204">.</span><span class="ident" id="5897205">mu</span><span class="op" id="5897207">.</span><span class="ident" id="5897208">Unlock</span><span class="op" id="5897214">(</span><span class="op" id="5897215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897218">if</span>&nbsp;<span class="ident" id="5897221">c</span><span class="op" id="5897222">.</span><span class="ident" id="5897223">inUse</span>&nbsp;<span class="op" id="5897229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897233">c</span><span class="op" id="5897234">.</span><span class="ident" id="5897235">onPut</span>&nbsp;<span class="op" id="5897241">=</span>&nbsp;<span class="builtinfunc" id="5897243">append</span><span class="op" id="5897249">(</span><span class="ident" id="5897250">c</span><span class="op" id="5897251">.</span><span class="ident" id="5897252">onPut</span><span class="op" id="5897257">,</span>&nbsp;<span class="keyword" id="5897259">func</span><span class="op" id="5897263">(</span><span class="op" id="5897264">)</span>&nbsp;<span class="op" id="5897266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897271">si</span><span class="op" id="5897273">.</span><span class="ident" id="5897274">Close</span><span class="op" id="5897279">(</span><span class="op" id="5897280">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897284">}</span><span class="op" id="5897285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897288">}</span>&nbsp;<span class="keyword" id="5897290">else</span>&nbsp;<span class="op" id="5897295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897299">c</span><span class="op" id="5897300">.</span><span class="ident" id="5897301">Lock</span><span class="op" id="5897305">(</span><span class="op" id="5897306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897310">defer</span>&nbsp;<span class="ident" id="5897316">c</span><span class="op" id="5897317">.</span><span class="ident" id="5897318">Unlock</span><span class="op" id="5897324">(</span><span class="op" id="5897325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897329">if</span>&nbsp;<span class="op" id="5897332">!</span><span class="ident" id="5897333">c</span><span class="op" id="5897334">.</span><span class="ident" id="5897335">finalClosed</span>&nbsp;<span class="op" id="5897347">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897352">si</span><span class="op" id="5897354">.</span><span class="ident" id="5897355">Close</span><span class="op" id="5897360">(</span><span class="op" id="5897361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897368">}</span><br>
<span class="lineno"></span><span class="op" id="5897370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="5897373">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="5897445">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="5897487">const</span>&nbsp;<span class="ident" id="5897493">debugGetPut</span>&nbsp;<span class="op" id="5897505">=</span>&nbsp;<span class="ident" id="5897507">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5897514">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="5897566">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5897636">func</span>&nbsp;<span class="op" id="5897641">(</span><span class="ident" id="5897642">db</span>&nbsp;<span class="op" id="5897645">*</span><span class="ident" id="5897646">DB</span><span class="op" id="5897648">)</span>&nbsp;<span class="ident" id="5897650">putConn</span><span class="op" id="5897657">(</span><span class="ident" id="5897658">dc</span>&nbsp;<span class="op" id="5897661">*</span><span class="ident" id="5897662">driverConn</span><span class="op" id="5897672">,</span>&nbsp;<span class="ident" id="5897674">err</span>&nbsp;<span class="builtintype" id="5897678">error</span><span class="op" id="5897683">)</span>&nbsp;<span class="op" id="5897685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897688">db</span><span class="op" id="5897690">.</span><span class="ident" id="5897691">mu</span><span class="op" id="5897693">.</span><span class="ident" id="5897694">Lock</span><span class="op" id="5897698">(</span><span class="op" id="5897699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897702">if</span>&nbsp;<span class="op" id="5897705">!</span><span class="ident" id="5897706">dc</span><span class="op" id="5897708">.</span><span class="ident" id="5897709">inUse</span>&nbsp;<span class="op" id="5897715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897719">if</span>&nbsp;<span class="ident" id="5897722">debugGetPut</span>&nbsp;<span class="op" id="5897734">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897739">fmt</span><span class="op" id="5897742">.</span><span class="ident" id="5897743">Printf</span><span class="op" id="5897749">(</span><span class="string" id="5897750">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="5897801">,</span>&nbsp;<span class="ident" id="5897803">dc</span><span class="op" id="5897805">,</span>&nbsp;<span class="ident" id="5897807">stack</span><span class="op" id="5897812">(</span><span class="op" id="5897813">)</span><span class="op" id="5897814">,</span>&nbsp;<span class="ident" id="5897816">db</span><span class="op" id="5897818">.</span><span class="ident" id="5897819">lastPut</span><span class="op" id="5897826">[</span><span class="ident" id="5897827">dc</span><span class="op" id="5897829">]</span><span class="op" id="5897830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5897838">panic</span><span class="op" id="5897843">(</span><span class="string" id="5897844">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="5897889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897895">if</span>&nbsp;<span class="ident" id="5897898">debugGetPut</span>&nbsp;<span class="op" id="5897910">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897914">db</span><span class="op" id="5897916">.</span><span class="ident" id="5897917">lastPut</span><span class="op" id="5897924">[</span><span class="ident" id="5897925">dc</span><span class="op" id="5897927">]</span>&nbsp;<span class="op" id="5897929">=</span>&nbsp;<span class="ident" id="5897931">stack</span><span class="op" id="5897936">(</span><span class="op" id="5897937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897943">dc</span><span class="op" id="5897945">.</span><span class="ident" id="5897946">inUse</span>&nbsp;<span class="op" id="5897952">=</span>&nbsp;<span class="ident" id="5897954">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897962">for</span>&nbsp;<span class="ident" id="5897966">_</span><span class="op" id="5897967">,</span>&nbsp;<span class="ident" id="5897969">fn</span>&nbsp;<span class="op" id="5897972">:=</span>&nbsp;<span class="keyword" id="5897975">range</span>&nbsp;<span class="ident" id="5897981">dc</span><span class="op" id="5897983">.</span><span class="ident" id="5897984">onPut</span>&nbsp;<span class="op" id="5897990">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897994">fn</span><span class="op" id="5897996">(</span><span class="op" id="5897997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898003">dc</span><span class="op" id="5898005">.</span><span class="ident" id="5898006">onPut</span>&nbsp;<span class="op" id="5898012">=</span>&nbsp;<span class="ident" id="5898014">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898020">if</span>&nbsp;<span class="ident" id="5898023">err</span>&nbsp;<span class="op" id="5898027">==</span>&nbsp;<span class="ident" id="5898030">driver</span><span class="op" id="5898036">.</span><span class="ident" id="5898037">ErrBadConn</span>&nbsp;<span class="op" id="5898048">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5898052">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5898086">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5898157">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5898226">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898250">db</span><span class="op" id="5898252">.</span><span class="ident" id="5898253">maybeOpenNewConnections</span><span class="op" id="5898276">(</span><span class="op" id="5898277">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898281">db</span><span class="op" id="5898283">.</span><span class="ident" id="5898284">mu</span><span class="op" id="5898286">.</span><span class="ident" id="5898287">Unlock</span><span class="op" id="5898293">(</span><span class="op" id="5898294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898298">dc</span><span class="op" id="5898300">.</span><span class="ident" id="5898301">Close</span><span class="op" id="5898306">(</span><span class="op" id="5898307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898311">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898322">if</span>&nbsp;<span class="ident" id="5898325">putConnHook</span>&nbsp;<span class="op" id="5898337">!=</span>&nbsp;<span class="ident" id="5898340">nil</span>&nbsp;<span class="op" id="5898344">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898348">putConnHook</span><span class="op" id="5898359">(</span><span class="ident" id="5898360">db</span><span class="op" id="5898362">,</span>&nbsp;<span class="ident" id="5898364">dc</span><span class="op" id="5898366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898372">added</span>&nbsp;<span class="op" id="5898378">:=</span>&nbsp;<span class="ident" id="5898381">db</span><span class="op" id="5898383">.</span><span class="ident" id="5898384">putConnDBLocked</span><span class="op" id="5898399">(</span><span class="ident" id="5898400">dc</span><span class="op" id="5898402">,</span>&nbsp;<span class="ident" id="5898404">nil</span><span class="op" id="5898407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898410">db</span><span class="op" id="5898412">.</span><span class="ident" id="5898413">mu</span><span class="op" id="5898415">.</span><span class="ident" id="5898416">Unlock</span><span class="op" id="5898422">(</span><span class="op" id="5898423">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898427">if</span>&nbsp;<span class="op" id="5898430">!</span><span class="ident" id="5898431">added</span>&nbsp;<span class="op" id="5898437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898441">dc</span><span class="op" id="5898443">.</span><span class="ident" id="5898444">Close</span><span class="op" id="5898449">(</span><span class="op" id="5898450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898453">}</span><br>
<span class="lineno"></span><span class="op" id="5898455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="5898458">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="5898538">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="5898558">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="5898632">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5898706">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="5898748">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="5898794">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5898840">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5898911">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5898981">func</span>&nbsp;<span class="op" id="5898986">(</span><span class="ident" id="5898987">db</span>&nbsp;<span class="op" id="5898990">*</span><span class="ident" id="5898991">DB</span><span class="op" id="5898993">)</span>&nbsp;<span class="ident" id="5898995">putConnDBLocked</span><span class="op" id="5899010">(</span><span class="ident" id="5899011">dc</span>&nbsp;<span class="op" id="5899014">*</span><span class="ident" id="5899015">driverConn</span><span class="op" id="5899025">,</span>&nbsp;<span class="ident" id="5899027">err</span>&nbsp;<span class="builtintype" id="5899031">error</span><span class="op" id="5899036">)</span>&nbsp;<span class="builtintype" id="5899038">bool</span>&nbsp;<span class="op" id="5899043">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899046">if</span>&nbsp;<span class="ident" id="5899049">c</span>&nbsp;<span class="op" id="5899051">:=</span>&nbsp;<span class="builtinfunc" id="5899054">len</span><span class="op" id="5899057">(</span><span class="ident" id="5899058">db</span><span class="op" id="5899060">.</span><span class="ident" id="5899061">connRequests</span><span class="op" id="5899073">)</span><span class="op" id="5899074">;</span>&nbsp;<span class="ident" id="5899076">c</span>&nbsp;<span class="op" id="5899078">&gt;</span>&nbsp;<span class="num" id="5899080">0</span>&nbsp;<span class="op" id="5899082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899086">req</span>&nbsp;<span class="op" id="5899090">:=</span>&nbsp;<span class="ident" id="5899093">db</span><span class="op" id="5899095">.</span><span class="ident" id="5899096">connRequests</span><span class="op" id="5899108">[</span><span class="num" id="5899109">0</span><span class="op" id="5899110">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899114">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899180">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899234">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5899264">copy</span><span class="op" id="5899268">(</span><span class="ident" id="5899269">db</span><span class="op" id="5899271">.</span><span class="ident" id="5899272">connRequests</span><span class="op" id="5899284">,</span>&nbsp;<span class="ident" id="5899286">db</span><span class="op" id="5899288">.</span><span class="ident" id="5899289">connRequests</span><span class="op" id="5899301">[</span><span class="num" id="5899302">1</span><span class="op" id="5899303">:</span><span class="op" id="5899304">]</span><span class="op" id="5899305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899309">db</span><span class="op" id="5899311">.</span><span class="ident" id="5899312">connRequests</span>&nbsp;<span class="op" id="5899325">=</span>&nbsp;<span class="ident" id="5899327">db</span><span class="op" id="5899329">.</span><span class="ident" id="5899330">connRequests</span><span class="op" id="5899342">[</span><span class="op" id="5899343">:</span><span class="ident" id="5899344">c</span><span class="op" id="5899345">-</span><span class="num" id="5899346">1</span><span class="op" id="5899347">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899351">if</span>&nbsp;<span class="ident" id="5899354">err</span>&nbsp;<span class="op" id="5899358">==</span>&nbsp;<span class="ident" id="5899361">nil</span>&nbsp;<span class="op" id="5899365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899370">dc</span><span class="op" id="5899372">.</span><span class="ident" id="5899373">inUse</span>&nbsp;<span class="op" id="5899379">=</span>&nbsp;<span class="ident" id="5899381">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5899388">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899392">req</span>&nbsp;<span class="op" id="5899396">&lt;-</span>&nbsp;<span class="ident" id="5899399">connRequest</span><span class="op" id="5899410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899415">conn</span><span class="op" id="5899419">:</span>&nbsp;<span class="ident" id="5899421">dc</span><span class="op" id="5899423">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899428">err</span><span class="op" id="5899431">:</span>&nbsp;&nbsp;<span class="ident" id="5899434">err</span><span class="op" id="5899437">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5899441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899445">return</span>&nbsp;<span class="ident" id="5899452">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5899458">}</span>&nbsp;<span class="keyword" id="5899460">else</span>&nbsp;<span class="keyword" id="5899465">if</span>&nbsp;<span class="ident" id="5899468">err</span>&nbsp;<span class="op" id="5899472">==</span>&nbsp;<span class="ident" id="5899475">nil</span>&nbsp;<span class="op" id="5899479">&amp;&amp;</span>&nbsp;<span class="op" id="5899482">!</span><span class="ident" id="5899483">db</span><span class="op" id="5899485">.</span><span class="ident" id="5899486">closed</span>&nbsp;<span class="op" id="5899493">&amp;&amp;</span>&nbsp;<span class="ident" id="5899496">db</span><span class="op" id="5899498">.</span><span class="ident" id="5899499">maxIdleConnsLocked</span><span class="op" id="5899517">(</span><span class="op" id="5899518">)</span>&nbsp;<span class="op" id="5899520">&gt;</span>&nbsp;<span class="builtinfunc" id="5899522">len</span><span class="op" id="5899525">(</span><span class="ident" id="5899526">db</span><span class="op" id="5899528">.</span><span class="ident" id="5899529">freeConn</span><span class="op" id="5899537">)</span>&nbsp;<span class="op" id="5899539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899543">db</span><span class="op" id="5899545">.</span><span class="ident" id="5899546">freeConn</span>&nbsp;<span class="op" id="5899555">=</span>&nbsp;<span class="builtinfunc" id="5899557">append</span><span class="op" id="5899563">(</span><span class="ident" id="5899564">db</span><span class="op" id="5899566">.</span><span class="ident" id="5899567">freeConn</span><span class="op" id="5899575">,</span>&nbsp;<span class="ident" id="5899577">dc</span><span class="op" id="5899579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899583">return</span>&nbsp;<span class="ident" id="5899590">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5899596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899599">return</span>&nbsp;<span class="ident" id="5899606">false</span><br>
<span class="lineno">820</span><span class="op" id="5899612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5899615">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5899691">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5899743">const</span>&nbsp;<span class="ident" id="5899749">maxBadConnRetries</span>&nbsp;<span class="op" id="5899767">=</span>&nbsp;<span class="num" id="5899769">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="5899773">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="5899846">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5899913">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5899936">func</span>&nbsp;<span class="op" id="5899941">(</span><span class="ident" id="5899942">db</span>&nbsp;<span class="op" id="5899945">*</span><span class="ident" id="5899946">DB</span><span class="op" id="5899948">)</span>&nbsp;<span class="ident" id="5899950">Prepare</span><span class="op" id="5899957">(</span><span class="ident" id="5899958">query</span>&nbsp;<span class="builtintype" id="5899964">string</span><span class="op" id="5899970">)</span>&nbsp;<span class="op" id="5899972">(</span><span class="op" id="5899973">*</span><span class="ident" id="5899974">Stmt</span><span class="op" id="5899978">,</span>&nbsp;<span class="builtintype" id="5899980">error</span><span class="op" id="5899985">)</span>&nbsp;<span class="op" id="5899987">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899990">var</span>&nbsp;<span class="ident" id="5899994">stmt</span>&nbsp;<span class="op" id="5899999">*</span><span class="ident" id="5900000">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900006">var</span>&nbsp;<span class="ident" id="5900010">err</span>&nbsp;<span class="builtintype" id="5900014">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900021">for</span>&nbsp;<span class="ident" id="5900025">i</span>&nbsp;<span class="op" id="5900027">:=</span>&nbsp;<span class="num" id="5900030">0</span><span class="op" id="5900031">;</span>&nbsp;<span class="ident" id="5900033">i</span>&nbsp;<span class="op" id="5900035">&lt;</span>&nbsp;<span class="ident" id="5900037">maxBadConnRetries</span><span class="op" id="5900054">;</span>&nbsp;<span class="ident" id="5900056">i</span><span class="op" id="5900057">++</span>&nbsp;<span class="op" id="5900060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900064">stmt</span><span class="op" id="5900068">,</span>&nbsp;<span class="ident" id="5900070">err</span>&nbsp;<span class="op" id="5900074">=</span>&nbsp;<span class="ident" id="5900076">db</span><span class="op" id="5900078">.</span><span class="ident" id="5900079">prepare</span><span class="op" id="5900086">(</span><span class="ident" id="5900087">query</span><span class="op" id="5900092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900096">if</span>&nbsp;<span class="ident" id="5900099">err</span>&nbsp;<span class="op" id="5900103">!=</span>&nbsp;<span class="ident" id="5900106">driver</span><span class="op" id="5900112">.</span><span class="ident" id="5900113">ErrBadConn</span>&nbsp;<span class="op" id="5900124">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900129">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900143">return</span>&nbsp;<span class="ident" id="5900150">stmt</span><span class="op" id="5900154">,</span>&nbsp;<span class="ident" id="5900156">err</span><br>
<span class="lineno"></span><span class="op" id="5900160">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="5900163">func</span>&nbsp;<span class="op" id="5900168">(</span><span class="ident" id="5900169">db</span>&nbsp;<span class="op" id="5900172">*</span><span class="ident" id="5900173">DB</span><span class="op" id="5900175">)</span>&nbsp;<span class="ident" id="5900177">prepare</span><span class="op" id="5900184">(</span><span class="ident" id="5900185">query</span>&nbsp;<span class="builtintype" id="5900191">string</span><span class="op" id="5900197">)</span>&nbsp;<span class="op" id="5900199">(</span><span class="op" id="5900200">*</span><span class="ident" id="5900201">Stmt</span><span class="op" id="5900205">,</span>&nbsp;<span class="builtintype" id="5900207">error</span><span class="op" id="5900212">)</span>&nbsp;<span class="op" id="5900214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5900217">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5900267">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5900327">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5900383">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5900443">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5900506">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900567">dc</span><span class="op" id="5900569">,</span>&nbsp;<span class="ident" id="5900571">err</span>&nbsp;<span class="op" id="5900575">:=</span>&nbsp;<span class="ident" id="5900578">db</span><span class="op" id="5900580">.</span><span class="ident" id="5900581">conn</span><span class="op" id="5900585">(</span><span class="op" id="5900586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900589">if</span>&nbsp;<span class="ident" id="5900592">err</span>&nbsp;<span class="op" id="5900596">!=</span>&nbsp;<span class="ident" id="5900599">nil</span>&nbsp;<span class="op" id="5900603">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900607">return</span>&nbsp;<span class="ident" id="5900614">nil</span><span class="op" id="5900617">,</span>&nbsp;<span class="ident" id="5900619">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900627">dc</span><span class="op" id="5900629">.</span><span class="ident" id="5900630">Lock</span><span class="op" id="5900634">(</span><span class="op" id="5900635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900638">si</span><span class="op" id="5900640">,</span>&nbsp;<span class="ident" id="5900642">err</span>&nbsp;<span class="op" id="5900646">:=</span>&nbsp;<span class="ident" id="5900649">dc</span><span class="op" id="5900651">.</span><span class="ident" id="5900652">prepareLocked</span><span class="op" id="5900665">(</span><span class="ident" id="5900666">query</span><span class="op" id="5900671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900674">dc</span><span class="op" id="5900676">.</span><span class="ident" id="5900677">Unlock</span><span class="op" id="5900683">(</span><span class="op" id="5900684">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900687">if</span>&nbsp;<span class="ident" id="5900690">err</span>&nbsp;<span class="op" id="5900694">!=</span>&nbsp;<span class="ident" id="5900697">nil</span>&nbsp;<span class="op" id="5900701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900705">db</span><span class="op" id="5900707">.</span><span class="ident" id="5900708">putConn</span><span class="op" id="5900715">(</span><span class="ident" id="5900716">dc</span><span class="op" id="5900718">,</span>&nbsp;<span class="ident" id="5900720">err</span><span class="op" id="5900723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900727">return</span>&nbsp;<span class="ident" id="5900734">nil</span><span class="op" id="5900737">,</span>&nbsp;<span class="ident" id="5900739">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900747">stmt</span>&nbsp;<span class="op" id="5900752">:=</span>&nbsp;<span class="op" id="5900755">&amp;</span><span class="ident" id="5900756">Stmt</span><span class="op" id="5900760">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900764">db</span><span class="op" id="5900766">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5900771">db</span><span class="op" id="5900773">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900777">query</span><span class="op" id="5900782">:</span>&nbsp;<span class="ident" id="5900784">query</span><span class="op" id="5900789">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900793">css</span><span class="op" id="5900796">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5900800">[</span><span class="op" id="5900801">]</span><span class="ident" id="5900802">connStmt</span><span class="op" id="5900810">{</span><span class="op" id="5900811">{</span><span class="ident" id="5900812">dc</span><span class="op" id="5900814">,</span>&nbsp;<span class="ident" id="5900816">si</span><span class="op" id="5900818">}</span><span class="op" id="5900819">}</span><span class="op" id="5900820">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900826">db</span><span class="op" id="5900828">.</span><span class="ident" id="5900829">addDep</span><span class="op" id="5900835">(</span><span class="ident" id="5900836">stmt</span><span class="op" id="5900840">,</span>&nbsp;<span class="ident" id="5900842">stmt</span><span class="op" id="5900846">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900849">db</span><span class="op" id="5900851">.</span><span class="ident" id="5900852">putConn</span><span class="op" id="5900859">(</span><span class="ident" id="5900860">dc</span><span class="op" id="5900862">,</span>&nbsp;<span class="ident" id="5900864">nil</span><span class="op" id="5900867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900870">return</span>&nbsp;<span class="ident" id="5900877">stmt</span><span class="op" id="5900881">,</span>&nbsp;<span class="ident" id="5900883">nil</span><br>
<span class="lineno"></span><span class="op" id="5900887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5900890">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="5900943">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="5901004">func</span>&nbsp;<span class="op" id="5901009">(</span><span class="ident" id="5901010">db</span>&nbsp;<span class="op" id="5901013">*</span><span class="ident" id="5901014">DB</span><span class="op" id="5901016">)</span>&nbsp;<span class="ident" id="5901018">Exec</span><span class="op" id="5901022">(</span><span class="ident" id="5901023">query</span>&nbsp;<span class="builtintype" id="5901029">string</span><span class="op" id="5901035">,</span>&nbsp;<span class="ident" id="5901037">args</span>&nbsp;<span class="op" id="5901042">...</span><span class="keyword" id="5901045">interface</span><span class="op" id="5901054">{</span><span class="op" id="5901055">}</span><span class="op" id="5901056">)</span>&nbsp;<span class="op" id="5901058">(</span><span class="ident" id="5901059">Result</span><span class="op" id="5901065">,</span>&nbsp;<span class="builtintype" id="5901067">error</span><span class="op" id="5901072">)</span>&nbsp;<span class="op" id="5901074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901077">var</span>&nbsp;<span class="ident" id="5901081">res</span>&nbsp;<span class="ident" id="5901085">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901093">var</span>&nbsp;<span class="ident" id="5901097">err</span>&nbsp;<span class="builtintype" id="5901101">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901108">for</span>&nbsp;<span class="ident" id="5901112">i</span>&nbsp;<span class="op" id="5901114">:=</span>&nbsp;<span class="num" id="5901117">0</span><span class="op" id="5901118">;</span>&nbsp;<span class="ident" id="5901120">i</span>&nbsp;<span class="op" id="5901122">&lt;</span>&nbsp;<span class="ident" id="5901124">maxBadConnRetries</span><span class="op" id="5901141">;</span>&nbsp;<span class="ident" id="5901143">i</span><span class="op" id="5901144">++</span>&nbsp;<span class="op" id="5901147">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901151">res</span><span class="op" id="5901154">,</span>&nbsp;<span class="ident" id="5901156">err</span>&nbsp;<span class="op" id="5901160">=</span>&nbsp;<span class="ident" id="5901162">db</span><span class="op" id="5901164">.</span><span class="ident" id="5901165">exec</span><span class="op" id="5901169">(</span><span class="ident" id="5901170">query</span><span class="op" id="5901175">,</span>&nbsp;<span class="ident" id="5901177">args</span><span class="op" id="5901181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901185">if</span>&nbsp;<span class="ident" id="5901188">err</span>&nbsp;<span class="op" id="5901192">!=</span>&nbsp;<span class="ident" id="5901195">driver</span><span class="op" id="5901201">.</span><span class="ident" id="5901202">ErrBadConn</span>&nbsp;<span class="op" id="5901213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901218">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901229">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901232">return</span>&nbsp;<span class="ident" id="5901239">res</span><span class="op" id="5901242">,</span>&nbsp;<span class="ident" id="5901244">err</span><br>
<span class="lineno"></span><span class="op" id="5901248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5901251">func</span>&nbsp;<span class="op" id="5901256">(</span><span class="ident" id="5901257">db</span>&nbsp;<span class="op" id="5901260">*</span><span class="ident" id="5901261">DB</span><span class="op" id="5901263">)</span>&nbsp;<span class="ident" id="5901265">exec</span><span class="op" id="5901269">(</span><span class="ident" id="5901270">query</span>&nbsp;<span class="builtintype" id="5901276">string</span><span class="op" id="5901282">,</span>&nbsp;<span class="ident" id="5901284">args</span>&nbsp;<span class="op" id="5901289">[</span><span class="op" id="5901290">]</span><span class="keyword" id="5901291">interface</span><span class="op" id="5901300">{</span><span class="op" id="5901301">}</span><span class="op" id="5901302">)</span>&nbsp;<span class="op" id="5901304">(</span><span class="ident" id="5901305">res</span>&nbsp;<span class="ident" id="5901309">Result</span><span class="op" id="5901315">,</span>&nbsp;<span class="ident" id="5901317">err</span>&nbsp;<span class="builtintype" id="5901321">error</span><span class="op" id="5901326">)</span>&nbsp;<span class="op" id="5901328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901331">dc</span><span class="op" id="5901333">,</span>&nbsp;<span class="ident" id="5901335">err</span>&nbsp;<span class="op" id="5901339">:=</span>&nbsp;<span class="ident" id="5901342">db</span><span class="op" id="5901344">.</span><span class="ident" id="5901345">conn</span><span class="op" id="5901349">(</span><span class="op" id="5901350">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901353">if</span>&nbsp;<span class="ident" id="5901356">err</span>&nbsp;<span class="op" id="5901360">!=</span>&nbsp;<span class="ident" id="5901363">nil</span>&nbsp;<span class="op" id="5901367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901371">return</span>&nbsp;<span class="ident" id="5901378">nil</span><span class="op" id="5901381">,</span>&nbsp;<span class="ident" id="5901383">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901391">defer</span>&nbsp;<span class="keyword" id="5901397">func</span><span class="op" id="5901401">(</span><span class="op" id="5901402">)</span>&nbsp;<span class="op" id="5901404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901408">db</span><span class="op" id="5901410">.</span><span class="ident" id="5901411">putConn</span><span class="op" id="5901418">(</span><span class="ident" id="5901419">dc</span><span class="op" id="5901421">,</span>&nbsp;<span class="ident" id="5901423">err</span><span class="op" id="5901426">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901429">}</span><span class="op" id="5901430">(</span><span class="op" id="5901431">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901435">if</span>&nbsp;<span class="ident" id="5901438">execer</span><span class="op" id="5901444">,</span>&nbsp;<span class="ident" id="5901446">ok</span>&nbsp;<span class="op" id="5901449">:=</span>&nbsp;<span class="ident" id="5901452">dc</span><span class="op" id="5901454">.</span><span class="ident" id="5901455">ci</span><span class="op" id="5901457">.</span><span class="op" id="5901458">(</span><span class="ident" id="5901459">driver</span><span class="op" id="5901465">.</span><span class="ident" id="5901466">Execer</span><span class="op" id="5901472">)</span><span class="op" id="5901473">;</span>&nbsp;<span class="ident" id="5901475">ok</span>&nbsp;<span class="op" id="5901478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901482">dargs</span><span class="op" id="5901487">,</span>&nbsp;<span class="ident" id="5901489">err</span>&nbsp;<span class="op" id="5901493">:=</span>&nbsp;<span class="ident" id="5901496">driverArgs</span><span class="op" id="5901506">(</span><span class="ident" id="5901507">nil</span><span class="op" id="5901510">,</span>&nbsp;<span class="ident" id="5901512">args</span><span class="op" id="5901516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901520">if</span>&nbsp;<span class="ident" id="5901523">err</span>&nbsp;<span class="op" id="5901527">!=</span>&nbsp;<span class="ident" id="5901530">nil</span>&nbsp;<span class="op" id="5901534">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901539">return</span>&nbsp;<span class="ident" id="5901546">nil</span><span class="op" id="5901549">,</span>&nbsp;<span class="ident" id="5901551">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901561">dc</span><span class="op" id="5901563">.</span><span class="ident" id="5901564">Lock</span><span class="op" id="5901568">(</span><span class="op" id="5901569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901573">resi</span><span class="op" id="5901577">,</span>&nbsp;<span class="ident" id="5901579">err</span>&nbsp;<span class="op" id="5901583">:=</span>&nbsp;<span class="ident" id="5901586">execer</span><span class="op" id="5901592">.</span><span class="ident" id="5901593">Exec</span><span class="op" id="5901597">(</span><span class="ident" id="5901598">query</span><span class="op" id="5901603">,</span>&nbsp;<span class="ident" id="5901605">dargs</span><span class="op" id="5901610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901614">dc</span><span class="op" id="5901616">.</span><span class="ident" id="5901617">Unlock</span><span class="op" id="5901623">(</span><span class="op" id="5901624">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901628">if</span>&nbsp;<span class="ident" id="5901631">err</span>&nbsp;<span class="op" id="5901635">!=</span>&nbsp;<span class="ident" id="5901638">driver</span><span class="op" id="5901644">.</span><span class="ident" id="5901645">ErrSkip</span>&nbsp;<span class="op" id="5901653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901658">if</span>&nbsp;<span class="ident" id="5901661">err</span>&nbsp;<span class="op" id="5901665">!=</span>&nbsp;<span class="ident" id="5901668">nil</span>&nbsp;<span class="op" id="5901672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901678">return</span>&nbsp;<span class="ident" id="5901685">nil</span><span class="op" id="5901688">,</span>&nbsp;<span class="ident" id="5901690">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901702">return</span>&nbsp;<span class="ident" id="5901709">driverResult</span><span class="op" id="5901721">{</span><span class="ident" id="5901722">dc</span><span class="op" id="5901724">,</span>&nbsp;<span class="ident" id="5901726">resi</span><span class="op" id="5901730">}</span><span class="op" id="5901731">,</span>&nbsp;<span class="ident" id="5901733">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901746">dc</span><span class="op" id="5901748">.</span><span class="ident" id="5901749">Lock</span><span class="op" id="5901753">(</span><span class="op" id="5901754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901757">si</span><span class="op" id="5901759">,</span>&nbsp;<span class="ident" id="5901761">err</span>&nbsp;<span class="op" id="5901765">:=</span>&nbsp;<span class="ident" id="5901768">dc</span><span class="op" id="5901770">.</span><span class="ident" id="5901771">ci</span><span class="op" id="5901773">.</span><span class="ident" id="5901774">Prepare</span><span class="op" id="5901781">(</span><span class="ident" id="5901782">query</span><span class="op" id="5901787">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901790">dc</span><span class="op" id="5901792">.</span><span class="ident" id="5901793">Unlock</span><span class="op" id="5901799">(</span><span class="op" id="5901800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901803">if</span>&nbsp;<span class="ident" id="5901806">err</span>&nbsp;<span class="op" id="5901810">!=</span>&nbsp;<span class="ident" id="5901813">nil</span>&nbsp;<span class="op" id="5901817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901821">return</span>&nbsp;<span class="ident" id="5901828">nil</span><span class="op" id="5901831">,</span>&nbsp;<span class="ident" id="5901833">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901841">defer</span>&nbsp;<span class="ident" id="5901847">withLock</span><span class="op" id="5901855">(</span><span class="ident" id="5901856">dc</span><span class="op" id="5901858">,</span>&nbsp;<span class="keyword" id="5901860">func</span><span class="op" id="5901864">(</span><span class="op" id="5901865">)</span>&nbsp;<span class="op" id="5901867">{</span>&nbsp;<span class="ident" id="5901869">si</span><span class="op" id="5901871">.</span><span class="ident" id="5901872">Close</span><span class="op" id="5901877">(</span><span class="op" id="5901878">)</span>&nbsp;<span class="op" id="5901880">}</span><span class="op" id="5901881">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901884">return</span>&nbsp;<span class="ident" id="5901891">resultFromStatement</span><span class="op" id="5901910">(</span><span class="ident" id="5901911">driverStmt</span><span class="op" id="5901921">{</span><span class="ident" id="5901922">dc</span><span class="op" id="5901924">,</span>&nbsp;<span class="ident" id="5901926">si</span><span class="op" id="5901928">}</span><span class="op" id="5901929">,</span>&nbsp;<span class="ident" id="5901931">args</span><span class="op" id="5901935">...</span><span class="op" id="5901938">)</span><br>
<span class="lineno"></span><span class="op" id="5901940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5901943">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="5902008">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="5902069">func</span>&nbsp;<span class="op" id="5902074">(</span><span class="ident" id="5902075">db</span>&nbsp;<span class="op" id="5902078">*</span><span class="ident" id="5902079">DB</span><span class="op" id="5902081">)</span>&nbsp;<span class="ident" id="5902083">Query</span><span class="op" id="5902088">(</span><span class="ident" id="5902089">query</span>&nbsp;<span class="builtintype" id="5902095">string</span><span class="op" id="5902101">,</span>&nbsp;<span class="ident" id="5902103">args</span>&nbsp;<span class="op" id="5902108">...</span><span class="keyword" id="5902111">interface</span><span class="op" id="5902120">{</span><span class="op" id="5902121">}</span><span class="op" id="5902122">)</span>&nbsp;<span class="op" id="5902124">(</span><span class="op" id="5902125">*</span><span class="ident" id="5902126">Rows</span><span class="op" id="5902130">,</span>&nbsp;<span class="builtintype" id="5902132">error</span><span class="op" id="5902137">)</span>&nbsp;<span class="op" id="5902139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902142">var</span>&nbsp;<span class="ident" id="5902146">rows</span>&nbsp;<span class="op" id="5902151">*</span><span class="ident" id="5902152">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902158">var</span>&nbsp;<span class="ident" id="5902162">err</span>&nbsp;<span class="builtintype" id="5902166">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902173">for</span>&nbsp;<span class="ident" id="5902177">i</span>&nbsp;<span class="op" id="5902179">:=</span>&nbsp;<span class="num" id="5902182">0</span><span class="op" id="5902183">;</span>&nbsp;<span class="ident" id="5902185">i</span>&nbsp;<span class="op" id="5902187">&lt;</span>&nbsp;<span class="ident" id="5902189">maxBadConnRetries</span><span class="op" id="5902206">;</span>&nbsp;<span class="ident" id="5902208">i</span><span class="op" id="5902209">++</span>&nbsp;<span class="op" id="5902212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902216">rows</span><span class="op" id="5902220">,</span>&nbsp;<span class="ident" id="5902222">err</span>&nbsp;<span class="op" id="5902226">=</span>&nbsp;<span class="ident" id="5902228">db</span><span class="op" id="5902230">.</span><span class="ident" id="5902231">query</span><span class="op" id="5902236">(</span><span class="ident" id="5902237">query</span><span class="op" id="5902242">,</span>&nbsp;<span class="ident" id="5902244">args</span><span class="op" id="5902248">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902252">if</span>&nbsp;<span class="ident" id="5902255">err</span>&nbsp;<span class="op" id="5902259">!=</span>&nbsp;<span class="ident" id="5902262">driver</span><span class="op" id="5902268">.</span><span class="ident" id="5902269">ErrBadConn</span>&nbsp;<span class="op" id="5902280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902285">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5902293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5902296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902299">return</span>&nbsp;<span class="ident" id="5902306">rows</span><span class="op" id="5902310">,</span>&nbsp;<span class="ident" id="5902312">err</span><br>
<span class="lineno">930</span><span class="op" id="5902316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5902319">func</span>&nbsp;<span class="op" id="5902324">(</span><span class="ident" id="5902325">db</span>&nbsp;<span class="op" id="5902328">*</span><span class="ident" id="5902329">DB</span><span class="op" id="5902331">)</span>&nbsp;<span class="ident" id="5902333">query</span><span class="op" id="5902338">(</span><span class="ident" id="5902339">query</span>&nbsp;<span class="builtintype" id="5902345">string</span><span class="op" id="5902351">,</span>&nbsp;<span class="ident" id="5902353">args</span>&nbsp;<span class="op" id="5902358">[</span><span class="op" id="5902359">]</span><span class="keyword" id="5902360">interface</span><span class="op" id="5902369">{</span><span class="op" id="5902370">}</span><span class="op" id="5902371">)</span>&nbsp;<span class="op" id="5902373">(</span><span class="op" id="5902374">*</span><span class="ident" id="5902375">Rows</span><span class="op" id="5902379">,</span>&nbsp;<span class="builtintype" id="5902381">error</span><span class="op" id="5902386">)</span>&nbsp;<span class="op" id="5902388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902391">ci</span><span class="op" id="5902393">,</span>&nbsp;<span class="ident" id="5902395">err</span>&nbsp;<span class="op" id="5902399">:=</span>&nbsp;<span class="ident" id="5902402">db</span><span class="op" id="5902404">.</span><span class="ident" id="5902405">conn</span><span class="op" id="5902409">(</span><span class="op" id="5902410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902413">if</span>&nbsp;<span class="ident" id="5902416">err</span>&nbsp;<span class="op" id="5902420">!=</span>&nbsp;<span class="ident" id="5902423">nil</span>&nbsp;<span class="op" id="5902427">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902431">return</span>&nbsp;<span class="ident" id="5902438">nil</span><span class="op" id="5902441">,</span>&nbsp;<span class="ident" id="5902443">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5902448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902452">return</span>&nbsp;<span class="ident" id="5902459">db</span><span class="op" id="5902461">.</span><span class="ident" id="5902462">queryConn</span><span class="op" id="5902471">(</span><span class="ident" id="5902472">ci</span><span class="op" id="5902474">,</span>&nbsp;<span class="ident" id="5902476">ci</span><span class="op" id="5902478">.</span><span class="ident" id="5902479">releaseConn</span><span class="op" id="5902490">,</span>&nbsp;<span class="ident" id="5902492">query</span><span class="op" id="5902497">,</span>&nbsp;<span class="ident" id="5902499">args</span><span class="op" id="5902503">)</span><br>
<span class="lineno"></span><span class="op" id="5902505">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="5902508">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5902563">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="5902624">func</span>&nbsp;<span class="op" id="5902629">(</span><span class="ident" id="5902630">db</span>&nbsp;<span class="op" id="5902633">*</span><span class="ident" id="5902634">DB</span><span class="op" id="5902636">)</span>&nbsp;<span class="ident" id="5902638">queryConn</span><span class="op" id="5902647">(</span><span class="ident" id="5902648">dc</span>&nbsp;<span class="op" id="5902651">*</span><span class="ident" id="5902652">driverConn</span><span class="op" id="5902662">,</span>&nbsp;<span class="ident" id="5902664">releaseConn</span>&nbsp;<span class="keyword" id="5902676">func</span><span class="op" id="5902680">(</span><span class="builtintype" id="5902681">error</span><span class="op" id="5902686">)</span><span class="op" id="5902687">,</span>&nbsp;<span class="ident" id="5902689">query</span>&nbsp;<span class="builtintype" id="5902695">string</span><span class="op" id="5902701">,</span>&nbsp;<span class="ident" id="5902703">args</span>&nbsp;<span class="op" id="5902708">[</span><span class="op" id="5902709">]</span><span class="keyword" id="5902710">interface</span><span class="op" id="5902719">{</span><span class="op" id="5902720">}</span><span class="op" id="5902721">)</span>&nbsp;<span class="op" id="5902723">(</span><span class="op" id="5902724">*</span><span class="ident" id="5902725">Rows</span><span class="op" id="5902729">,</span>&nbsp;<span class="builtintype" id="5902731">error</span><span class="op" id="5902736">)</span>&nbsp;<span class="op" id="5902738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902741">if</span>&nbsp;<span class="ident" id="5902744">queryer</span><span class="op" id="5902751">,</span>&nbsp;<span class="ident" id="5902753">ok</span>&nbsp;<span class="op" id="5902756">:=</span>&nbsp;<span class="ident" id="5902759">dc</span><span class="op" id="5902761">.</span><span class="ident" id="5902762">ci</span><span class="op" id="5902764">.</span><span class="op" id="5902765">(</span><span class="ident" id="5902766">driver</span><span class="op" id="5902772">.</span><span class="ident" id="5902773">Queryer</span><span class="op" id="5902780">)</span><span class="op" id="5902781">;</span>&nbsp;<span class="ident" id="5902783">ok</span>&nbsp;<span class="op" id="5902786">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902790">dargs</span><span class="op" id="5902795">,</span>&nbsp;<span class="ident" id="5902797">err</span>&nbsp;<span class="op" id="5902801">:=</span>&nbsp;<span class="ident" id="5902804">driverArgs</span><span class="op" id="5902814">(</span><span class="ident" id="5902815">nil</span><span class="op" id="5902818">,</span>&nbsp;<span class="ident" id="5902820">args</span><span class="op" id="5902824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902828">if</span>&nbsp;<span class="ident" id="5902831">err</span>&nbsp;<span class="op" id="5902835">!=</span>&nbsp;<span class="ident" id="5902838">nil</span>&nbsp;<span class="op" id="5902842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902847">releaseConn</span><span class="op" id="5902858">(</span><span class="ident" id="5902859">err</span><span class="op" id="5902862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902867">return</span>&nbsp;<span class="ident" id="5902874">nil</span><span class="op" id="5902877">,</span>&nbsp;<span class="ident" id="5902879">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5902885">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902889">dc</span><span class="op" id="5902891">.</span><span class="ident" id="5902892">Lock</span><span class="op" id="5902896">(</span><span class="op" id="5902897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902901">rowsi</span><span class="op" id="5902906">,</span>&nbsp;<span class="ident" id="5902908">err</span>&nbsp;<span class="op" id="5902912">:=</span>&nbsp;<span class="ident" id="5902915">queryer</span><span class="op" id="5902922">.</span><span class="ident" id="5902923">Query</span><span class="op" id="5902928">(</span><span class="ident" id="5902929">query</span><span class="op" id="5902934">,</span>&nbsp;<span class="ident" id="5902936">dargs</span><span class="op" id="5902941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902945">dc</span><span class="op" id="5902947">.</span><span class="ident" id="5902948">Unlock</span><span class="op" id="5902954">(</span><span class="op" id="5902955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902959">if</span>&nbsp;<span class="ident" id="5902962">err</span>&nbsp;<span class="op" id="5902966">!=</span>&nbsp;<span class="ident" id="5902969">driver</span><span class="op" id="5902975">.</span><span class="ident" id="5902976">ErrSkip</span>&nbsp;<span class="op" id="5902984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902989">if</span>&nbsp;<span class="ident" id="5902992">err</span>&nbsp;<span class="op" id="5902996">!=</span>&nbsp;<span class="ident" id="5902999">nil</span>&nbsp;<span class="op" id="5903003">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903009">releaseConn</span><span class="op" id="5903020">(</span><span class="ident" id="5903021">err</span><span class="op" id="5903024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903030">return</span>&nbsp;<span class="ident" id="5903037">nil</span><span class="op" id="5903040">,</span>&nbsp;<span class="ident" id="5903042">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903054">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903115">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903139">rows</span>&nbsp;<span class="op" id="5903144">:=</span>&nbsp;<span class="op" id="5903147">&amp;</span><span class="ident" id="5903148">Rows</span><span class="op" id="5903152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903158">dc</span><span class="op" id="5903160">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5903171">dc</span><span class="op" id="5903173">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903179">releaseConn</span><span class="op" id="5903190">:</span>&nbsp;<span class="ident" id="5903192">releaseConn</span><span class="op" id="5903203">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903209">rowsi</span><span class="op" id="5903214">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5903222">rowsi</span><span class="op" id="5903227">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903232">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903237">return</span>&nbsp;<span class="ident" id="5903244">rows</span><span class="op" id="5903248">,</span>&nbsp;<span class="ident" id="5903250">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903263">dc</span><span class="op" id="5903265">.</span><span class="ident" id="5903266">Lock</span><span class="op" id="5903270">(</span><span class="op" id="5903271">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903274">si</span><span class="op" id="5903276">,</span>&nbsp;<span class="ident" id="5903278">err</span>&nbsp;<span class="op" id="5903282">:=</span>&nbsp;<span class="ident" id="5903285">dc</span><span class="op" id="5903287">.</span><span class="ident" id="5903288">ci</span><span class="op" id="5903290">.</span><span class="ident" id="5903291">Prepare</span><span class="op" id="5903298">(</span><span class="ident" id="5903299">query</span><span class="op" id="5903304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903307">dc</span><span class="op" id="5903309">.</span><span class="ident" id="5903310">Unlock</span><span class="op" id="5903316">(</span><span class="op" id="5903317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903320">if</span>&nbsp;<span class="ident" id="5903323">err</span>&nbsp;<span class="op" id="5903327">!=</span>&nbsp;<span class="ident" id="5903330">nil</span>&nbsp;<span class="op" id="5903334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903338">releaseConn</span><span class="op" id="5903349">(</span><span class="ident" id="5903350">err</span><span class="op" id="5903353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903357">return</span>&nbsp;<span class="ident" id="5903364">nil</span><span class="op" id="5903367">,</span>&nbsp;<span class="ident" id="5903369">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903378">ds</span>&nbsp;<span class="op" id="5903381">:=</span>&nbsp;<span class="ident" id="5903384">driverStmt</span><span class="op" id="5903394">{</span><span class="ident" id="5903395">dc</span><span class="op" id="5903397">,</span>&nbsp;<span class="ident" id="5903399">si</span><span class="op" id="5903401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903404">rowsi</span><span class="op" id="5903409">,</span>&nbsp;<span class="ident" id="5903411">err</span>&nbsp;<span class="op" id="5903415">:=</span>&nbsp;<span class="ident" id="5903418">rowsiFromStatement</span><span class="op" id="5903436">(</span><span class="ident" id="5903437">ds</span><span class="op" id="5903439">,</span>&nbsp;<span class="ident" id="5903441">args</span><span class="op" id="5903445">...</span><span class="op" id="5903448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903451">if</span>&nbsp;<span class="ident" id="5903454">err</span>&nbsp;<span class="op" id="5903458">!=</span>&nbsp;<span class="ident" id="5903461">nil</span>&nbsp;<span class="op" id="5903465">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903469">dc</span><span class="op" id="5903471">.</span><span class="ident" id="5903472">Lock</span><span class="op" id="5903476">(</span><span class="op" id="5903477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903481">si</span><span class="op" id="5903483">.</span><span class="ident" id="5903484">Close</span><span class="op" id="5903489">(</span><span class="op" id="5903490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903494">dc</span><span class="op" id="5903496">.</span><span class="ident" id="5903497">Unlock</span><span class="op" id="5903503">(</span><span class="op" id="5903504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903508">releaseConn</span><span class="op" id="5903519">(</span><span class="ident" id="5903520">err</span><span class="op" id="5903523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903527">return</span>&nbsp;<span class="ident" id="5903534">nil</span><span class="op" id="5903537">,</span>&nbsp;<span class="ident" id="5903539">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903548">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903607">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903629">rows</span>&nbsp;<span class="op" id="5903634">:=</span>&nbsp;<span class="op" id="5903637">&amp;</span><span class="ident" id="5903638">Rows</span><span class="op" id="5903642">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903646">dc</span><span class="op" id="5903648">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5903659">dc</span><span class="op" id="5903661">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903665">releaseConn</span><span class="op" id="5903676">:</span>&nbsp;<span class="ident" id="5903678">releaseConn</span><span class="op" id="5903689">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903693">rowsi</span><span class="op" id="5903698">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5903706">rowsi</span><span class="op" id="5903711">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903715">closeStmt</span><span class="op" id="5903724">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5903728">si</span><span class="op" id="5903730">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903733">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903736">return</span>&nbsp;<span class="ident" id="5903743">rows</span><span class="op" id="5903747">,</span>&nbsp;<span class="ident" id="5903749">nil</span><br>
<span class="lineno"></span><span class="op" id="5903753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5903756">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="5903829">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="5903898">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="5903930">func</span>&nbsp;<span class="op" id="5903935">(</span><span class="ident" id="5903936">db</span>&nbsp;<span class="op" id="5903939">*</span><span class="ident" id="5903940">DB</span><span class="op" id="5903942">)</span>&nbsp;<span class="ident" id="5903944">QueryRow</span><span class="op" id="5903952">(</span><span class="ident" id="5903953">query</span>&nbsp;<span class="builtintype" id="5903959">string</span><span class="op" id="5903965">,</span>&nbsp;<span class="ident" id="5903967">args</span>&nbsp;<span class="op" id="5903972">...</span><span class="keyword" id="5903975">interface</span><span class="op" id="5903984">{</span><span class="op" id="5903985">}</span><span class="op" id="5903986">)</span>&nbsp;<span class="op" id="5903988">*</span><span class="ident" id="5903989">Row</span>&nbsp;<span class="op" id="5903993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903996">rows</span><span class="op" id="5904000">,</span>&nbsp;<span class="ident" id="5904002">err</span>&nbsp;<span class="op" id="5904006">:=</span>&nbsp;<span class="ident" id="5904009">db</span><span class="op" id="5904011">.</span><span class="ident" id="5904012">Query</span><span class="op" id="5904017">(</span><span class="ident" id="5904018">query</span><span class="op" id="5904023">,</span>&nbsp;<span class="ident" id="5904025">args</span><span class="op" id="5904029">...</span><span class="op" id="5904032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904035">return</span>&nbsp;<span class="op" id="5904042">&amp;</span><span class="ident" id="5904043">Row</span><span class="op" id="5904046">{</span><span class="ident" id="5904047">rows</span><span class="op" id="5904051">:</span>&nbsp;<span class="ident" id="5904053">rows</span><span class="op" id="5904057">,</span>&nbsp;<span class="ident" id="5904059">err</span><span class="op" id="5904062">:</span>&nbsp;<span class="ident" id="5904064">err</span><span class="op" id="5904067">}</span><br>
<span class="lineno"></span><span class="op" id="5904069">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="5904072">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="5904139">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="5904154">func</span>&nbsp;<span class="op" id="5904159">(</span><span class="ident" id="5904160">db</span>&nbsp;<span class="op" id="5904163">*</span><span class="ident" id="5904164">DB</span><span class="op" id="5904166">)</span>&nbsp;<span class="ident" id="5904168">Begin</span><span class="op" id="5904173">(</span><span class="op" id="5904174">)</span>&nbsp;<span class="op" id="5904176">(</span><span class="op" id="5904177">*</span><span class="ident" id="5904178">Tx</span><span class="op" id="5904180">,</span>&nbsp;<span class="builtintype" id="5904182">error</span><span class="op" id="5904187">)</span>&nbsp;<span class="op" id="5904189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904192">var</span>&nbsp;<span class="ident" id="5904196">tx</span>&nbsp;<span class="op" id="5904199">*</span><span class="ident" id="5904200">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904204">var</span>&nbsp;<span class="ident" id="5904208">err</span>&nbsp;<span class="builtintype" id="5904212">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904219">for</span>&nbsp;<span class="ident" id="5904223">i</span>&nbsp;<span class="op" id="5904225">:=</span>&nbsp;<span class="num" id="5904228">0</span><span class="op" id="5904229">;</span>&nbsp;<span class="ident" id="5904231">i</span>&nbsp;<span class="op" id="5904233">&lt;</span>&nbsp;<span class="ident" id="5904235">maxBadConnRetries</span><span class="op" id="5904252">;</span>&nbsp;<span class="ident" id="5904254">i</span><span class="op" id="5904255">++</span>&nbsp;<span class="op" id="5904258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904262">tx</span><span class="op" id="5904264">,</span>&nbsp;<span class="ident" id="5904266">err</span>&nbsp;<span class="op" id="5904270">=</span>&nbsp;<span class="ident" id="5904272">db</span><span class="op" id="5904274">.</span><span class="ident" id="5904275">begin</span><span class="op" id="5904280">(</span><span class="op" id="5904281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904285">if</span>&nbsp;<span class="ident" id="5904288">err</span>&nbsp;<span class="op" id="5904292">!=</span>&nbsp;<span class="ident" id="5904295">driver</span><span class="op" id="5904301">.</span><span class="ident" id="5904302">ErrBadConn</span>&nbsp;<span class="op" id="5904313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904318">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904332">return</span>&nbsp;<span class="ident" id="5904339">tx</span><span class="op" id="5904341">,</span>&nbsp;<span class="ident" id="5904343">err</span><br>
<span class="lineno"></span><span class="op" id="5904347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="5904350">func</span>&nbsp;<span class="op" id="5904355">(</span><span class="ident" id="5904356">db</span>&nbsp;<span class="op" id="5904359">*</span><span class="ident" id="5904360">DB</span><span class="op" id="5904362">)</span>&nbsp;<span class="ident" id="5904364">begin</span><span class="op" id="5904369">(</span><span class="op" id="5904370">)</span>&nbsp;<span class="op" id="5904372">(</span><span class="ident" id="5904373">tx</span>&nbsp;<span class="op" id="5904376">*</span><span class="ident" id="5904377">Tx</span><span class="op" id="5904379">,</span>&nbsp;<span class="ident" id="5904381">err</span>&nbsp;<span class="builtintype" id="5904385">error</span><span class="op" id="5904390">)</span>&nbsp;<span class="op" id="5904392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904395">dc</span><span class="op" id="5904397">,</span>&nbsp;<span class="ident" id="5904399">err</span>&nbsp;<span class="op" id="5904403">:=</span>&nbsp;<span class="ident" id="5904406">db</span><span class="op" id="5904408">.</span><span class="ident" id="5904409">conn</span><span class="op" id="5904413">(</span><span class="op" id="5904414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904417">if</span>&nbsp;<span class="ident" id="5904420">err</span>&nbsp;<span class="op" id="5904424">!=</span>&nbsp;<span class="ident" id="5904427">nil</span>&nbsp;<span class="op" id="5904431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904435">return</span>&nbsp;<span class="ident" id="5904442">nil</span><span class="op" id="5904445">,</span>&nbsp;<span class="ident" id="5904447">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904452">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904455">dc</span><span class="op" id="5904457">.</span><span class="ident" id="5904458">Lock</span><span class="op" id="5904462">(</span><span class="op" id="5904463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904466">txi</span><span class="op" id="5904469">,</span>&nbsp;<span class="ident" id="5904471">err</span>&nbsp;<span class="op" id="5904475">:=</span>&nbsp;<span class="ident" id="5904478">dc</span><span class="op" id="5904480">.</span><span class="ident" id="5904481">ci</span><span class="op" id="5904483">.</span><span class="ident" id="5904484">Begin</span><span class="op" id="5904489">(</span><span class="op" id="5904490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904493">dc</span><span class="op" id="5904495">.</span><span class="ident" id="5904496">Unlock</span><span class="op" id="5904502">(</span><span class="op" id="5904503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904506">if</span>&nbsp;<span class="ident" id="5904509">err</span>&nbsp;<span class="op" id="5904513">!=</span>&nbsp;<span class="ident" id="5904516">nil</span>&nbsp;<span class="op" id="5904520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904524">db</span><span class="op" id="5904526">.</span><span class="ident" id="5904527">putConn</span><span class="op" id="5904534">(</span><span class="ident" id="5904535">dc</span><span class="op" id="5904537">,</span>&nbsp;<span class="ident" id="5904539">err</span><span class="op" id="5904542">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904546">return</span>&nbsp;<span class="ident" id="5904553">nil</span><span class="op" id="5904556">,</span>&nbsp;<span class="ident" id="5904558">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904566">return</span>&nbsp;<span class="op" id="5904573">&amp;</span><span class="ident" id="5904574">Tx</span><span class="op" id="5904576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904580">db</span><span class="op" id="5904582">:</span>&nbsp;&nbsp;<span class="ident" id="5904585">db</span><span class="op" id="5904587">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904591">dc</span><span class="op" id="5904593">:</span>&nbsp;&nbsp;<span class="ident" id="5904596">dc</span><span class="op" id="5904598">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904602">txi</span><span class="op" id="5904605">:</span>&nbsp;<span class="ident" id="5904607">txi</span><span class="op" id="5904610">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904613">}</span><span class="op" id="5904614">,</span>&nbsp;<span class="ident" id="5904616">nil</span><br>
<span class="lineno"></span><span class="op" id="5904620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5904623">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="5904675">func</span>&nbsp;<span class="op" id="5904680">(</span><span class="ident" id="5904681">db</span>&nbsp;<span class="op" id="5904684">*</span><span class="ident" id="5904685">DB</span><span class="op" id="5904687">)</span>&nbsp;<span class="ident" id="5904689">Driver</span><span class="op" id="5904695">(</span><span class="op" id="5904696">)</span>&nbsp;<span class="ident" id="5904698">driver</span><span class="op" id="5904704">.</span><span class="ident" id="5904705">Driver</span>&nbsp;<span class="op" id="5904712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904715">return</span>&nbsp;<span class="ident" id="5904722">db</span><span class="op" id="5904724">.</span><span class="ident" id="5904725">driver</span><br>
<span class="lineno"></span><span class="op" id="5904732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5904735">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="5904781">//</span><br>
<span class="lineno"></span><span class="comment" id="5904784">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="5904845">//</span><br>
<span class="lineno"></span><span class="comment" id="5904848">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5904909">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="5904945">type</span>&nbsp;<span class="ident" id="5904950">Tx</span>&nbsp;<span class="keyword" id="5904953">struct</span>&nbsp;<span class="op" id="5904960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904963">db</span>&nbsp;<span class="op" id="5904966">*</span><span class="ident" id="5904967">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5904972">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5905041">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905073">dc</span>&nbsp;&nbsp;<span class="op" id="5905077">*</span><span class="ident" id="5905078">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905090">txi</span>&nbsp;<span class="ident" id="5905094">driver</span><span class="op" id="5905100">.</span><span class="ident" id="5905101">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5905106">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5905170">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5905223">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905238">done</span>&nbsp;<span class="builtintype" id="5905243">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5905250">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5905327">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905378">stmts</span>&nbsp;<span class="keyword" id="5905384">struct</span>&nbsp;<span class="op" id="5905391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905395">sync</span><span class="op" id="5905399">.</span><span class="ident" id="5905400">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905408">v</span>&nbsp;<span class="op" id="5905410">[</span><span class="op" id="5905411">]</span><span class="op" id="5905412">*</span><span class="ident" id="5905413">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905419">}</span><br>
<span class="lineno"></span><span class="op" id="5905421">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="5905424">var</span>&nbsp;<span class="ident" id="5905428">ErrTxDone</span>&nbsp;<span class="op" id="5905438">=</span>&nbsp;<span class="ident" id="5905440">errors</span><span class="op" id="5905446">.</span><span class="ident" id="5905447">New</span><span class="op" id="5905450">(</span><span class="string" id="5905451">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="5905511">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5905514">func</span>&nbsp;<span class="op" id="5905519">(</span><span class="ident" id="5905520">tx</span>&nbsp;<span class="op" id="5905523">*</span><span class="ident" id="5905524">Tx</span><span class="op" id="5905526">)</span>&nbsp;<span class="builtinfunc" id="5905528">close</span><span class="op" id="5905533">(</span><span class="op" id="5905534">)</span>&nbsp;<span class="op" id="5905536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905539">if</span>&nbsp;<span class="ident" id="5905542">tx</span><span class="op" id="5905544">.</span><span class="ident" id="5905545">done</span>&nbsp;<span class="op" id="5905550">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5905554">panic</span><span class="op" id="5905559">(</span><span class="string" id="5905560">&#34;double&nbsp;close&#34;</span><span class="op" id="5905574">)</span>&nbsp;<span class="comment" id="5905576">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905598">tx</span><span class="op" id="5905600">.</span><span class="ident" id="5905601">done</span>&nbsp;<span class="op" id="5905606">=</span>&nbsp;<span class="ident" id="5905608">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905614">tx</span><span class="op" id="5905616">.</span><span class="ident" id="5905617">db</span><span class="op" id="5905619">.</span><span class="ident" id="5905620">putConn</span><span class="op" id="5905627">(</span><span class="ident" id="5905628">tx</span><span class="op" id="5905630">.</span><span class="ident" id="5905631">dc</span><span class="op" id="5905633">,</span>&nbsp;<span class="ident" id="5905635">nil</span><span class="op" id="5905638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905641">tx</span><span class="op" id="5905643">.</span><span class="ident" id="5905644">dc</span>&nbsp;<span class="op" id="5905647">=</span>&nbsp;<span class="ident" id="5905649">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905654">tx</span><span class="op" id="5905656">.</span><span class="ident" id="5905657">txi</span>&nbsp;<span class="op" id="5905661">=</span>&nbsp;<span class="ident" id="5905663">nil</span><br>
<span class="lineno"></span><span class="op" id="5905667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5905670">func</span>&nbsp;<span class="op" id="5905675">(</span><span class="ident" id="5905676">tx</span>&nbsp;<span class="op" id="5905679">*</span><span class="ident" id="5905680">Tx</span><span class="op" id="5905682">)</span>&nbsp;<span class="ident" id="5905684">grabConn</span><span class="op" id="5905692">(</span><span class="op" id="5905693">)</span>&nbsp;<span class="op" id="5905695">(</span><span class="op" id="5905696">*</span><span class="ident" id="5905697">driverConn</span><span class="op" id="5905707">,</span>&nbsp;<span class="builtintype" id="5905709">error</span><span class="op" id="5905714">)</span>&nbsp;<span class="op" id="5905716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905719">if</span>&nbsp;<span class="ident" id="5905722">tx</span><span class="op" id="5905724">.</span><span class="ident" id="5905725">done</span>&nbsp;<span class="op" id="5905730">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905734">return</span>&nbsp;<span class="ident" id="5905741">nil</span><span class="op" id="5905744">,</span>&nbsp;<span class="ident" id="5905746">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905760">return</span>&nbsp;<span class="ident" id="5905767">tx</span><span class="op" id="5905769">.</span><span class="ident" id="5905770">dc</span><span class="op" id="5905772">,</span>&nbsp;<span class="ident" id="5905774">nil</span><br>
<span class="lineno"></span><span class="op" id="5905778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="5905781">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="5905832">func</span>&nbsp;<span class="op" id="5905837">(</span><span class="ident" id="5905838">tx</span>&nbsp;<span class="op" id="5905841">*</span><span class="ident" id="5905842">Tx</span><span class="op" id="5905844">)</span>&nbsp;<span class="ident" id="5905846">closePrepared</span><span class="op" id="5905859">(</span><span class="op" id="5905860">)</span>&nbsp;<span class="op" id="5905862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905865">tx</span><span class="op" id="5905867">.</span><span class="ident" id="5905868">stmts</span><span class="op" id="5905873">.</span><span class="ident" id="5905874">Lock</span><span class="op" id="5905878">(</span><span class="op" id="5905879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905882">for</span>&nbsp;<span class="ident" id="5905886">_</span><span class="op" id="5905887">,</span>&nbsp;<span class="ident" id="5905889">stmt</span>&nbsp;<span class="op" id="5905894">:=</span>&nbsp;<span class="keyword" id="5905897">range</span>&nbsp;<span class="ident" id="5905903">tx</span><span class="op" id="5905905">.</span><span class="ident" id="5905906">stmts</span><span class="op" id="5905911">.</span><span class="ident" id="5905912">v</span>&nbsp;<span class="op" id="5905914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905918">stmt</span><span class="op" id="5905922">.</span><span class="ident" id="5905923">Close</span><span class="op" id="5905928">(</span><span class="op" id="5905929">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905935">tx</span><span class="op" id="5905937">.</span><span class="ident" id="5905938">stmts</span><span class="op" id="5905943">.</span><span class="ident" id="5905944">Unlock</span><span class="op" id="5905950">(</span><span class="op" id="5905951">)</span><br>
<span class="lineno"></span><span class="op" id="5905953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5905956">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="5905991">func</span>&nbsp;<span class="op" id="5905996">(</span><span class="ident" id="5905997">tx</span>&nbsp;<span class="op" id="5906000">*</span><span class="ident" id="5906001">Tx</span><span class="op" id="5906003">)</span>&nbsp;<span class="ident" id="5906005">Commit</span><span class="op" id="5906011">(</span><span class="op" id="5906012">)</span>&nbsp;<span class="builtintype" id="5906014">error</span>&nbsp;<span class="op" id="5906020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906023">if</span>&nbsp;<span class="ident" id="5906026">tx</span><span class="op" id="5906028">.</span><span class="ident" id="5906029">done</span>&nbsp;<span class="op" id="5906034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906038">return</span>&nbsp;<span class="ident" id="5906045">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5906056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906059">defer</span>&nbsp;<span class="ident" id="5906065">tx</span><span class="op" id="5906067">.</span><span class="builtinfunc" id="5906068">close</span><span class="op" id="5906073">(</span><span class="op" id="5906074">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906077">tx</span><span class="op" id="5906079">.</span><span class="ident" id="5906080">dc</span><span class="op" id="5906082">.</span><span class="ident" id="5906083">Lock</span><span class="op" id="5906087">(</span><span class="op" id="5906088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906091">err</span>&nbsp;<span class="op" id="5906095">:=</span>&nbsp;<span class="ident" id="5906098">tx</span><span class="op" id="5906100">.</span><span class="ident" id="5906101">txi</span><span class="op" id="5906104">.</span><span class="ident" id="5906105">Commit</span><span class="op" id="5906111">(</span><span class="op" id="5906112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906115">tx</span><span class="op" id="5906117">.</span><span class="ident" id="5906118">dc</span><span class="op" id="5906120">.</span><span class="ident" id="5906121">Unlock</span><span class="op" id="5906127">(</span><span class="op" id="5906128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906131">if</span>&nbsp;<span class="ident" id="5906134">err</span>&nbsp;<span class="op" id="5906138">!=</span>&nbsp;<span class="ident" id="5906141">driver</span><span class="op" id="5906147">.</span><span class="ident" id="5906148">ErrBadConn</span>&nbsp;<span class="op" id="5906159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906163">tx</span><span class="op" id="5906165">.</span><span class="ident" id="5906166">closePrepared</span><span class="op" id="5906179">(</span><span class="op" id="5906180">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5906183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906186">return</span>&nbsp;<span class="ident" id="5906193">err</span><br>
<span class="lineno"></span><span class="op" id="5906197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5906200">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="5906236">func</span>&nbsp;<span class="op" id="5906241">(</span><span class="ident" id="5906242">tx</span>&nbsp;<span class="op" id="5906245">*</span><span class="ident" id="5906246">Tx</span><span class="op" id="5906248">)</span>&nbsp;<span class="ident" id="5906250">Rollback</span><span class="op" id="5906258">(</span><span class="op" id="5906259">)</span>&nbsp;<span class="builtintype" id="5906261">error</span>&nbsp;<span class="op" id="5906267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906270">if</span>&nbsp;<span class="ident" id="5906273">tx</span><span class="op" id="5906275">.</span><span class="ident" id="5906276">done</span>&nbsp;<span class="op" id="5906281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906285">return</span>&nbsp;<span class="ident" id="5906292">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5906303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906306">defer</span>&nbsp;<span class="ident" id="5906312">tx</span><span class="op" id="5906314">.</span><span class="builtinfunc" id="5906315">close</span><span class="op" id="5906320">(</span><span class="op" id="5906321">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906324">tx</span><span class="op" id="5906326">.</span><span class="ident" id="5906327">dc</span><span class="op" id="5906329">.</span><span class="ident" id="5906330">Lock</span><span class="op" id="5906334">(</span><span class="op" id="5906335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906338">err</span>&nbsp;<span class="op" id="5906342">:=</span>&nbsp;<span class="ident" id="5906345">tx</span><span class="op" id="5906347">.</span><span class="ident" id="5906348">txi</span><span class="op" id="5906351">.</span><span class="ident" id="5906352">Rollback</span><span class="op" id="5906360">(</span><span class="op" id="5906361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906364">tx</span><span class="op" id="5906366">.</span><span class="ident" id="5906367">dc</span><span class="op" id="5906369">.</span><span class="ident" id="5906370">Unlock</span><span class="op" id="5906376">(</span><span class="op" id="5906377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906380">if</span>&nbsp;<span class="ident" id="5906383">err</span>&nbsp;<span class="op" id="5906387">!=</span>&nbsp;<span class="ident" id="5906390">driver</span><span class="op" id="5906396">.</span><span class="ident" id="5906397">ErrBadConn</span>&nbsp;<span class="op" id="5906408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5906412">tx</span><span class="op" id="5906414">.</span><span class="ident" id="5906415">closePrepared</span><span class="op" id="5906428">(</span><span class="op" id="5906429">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5906432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5906435">return</span>&nbsp;<span class="ident" id="5906442">err</span><br>
<span class="lineno"></span><span class="op" id="5906446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5906449">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="5906519">//</span><br>
<span class="lineno"></span><span class="comment" id="5906522">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="5906598">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="5906665">//</span><br>
<span class="lineno"></span><span class="comment" id="5906668">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="5906743">func</span>&nbsp;<span class="op" id="5906748">(</span><span class="ident" id="5906749">tx</span>&nbsp;<span class="op" id="5906752">*</span><span class="ident" id="5906753">Tx</span><span class="op" id="5906755">)</span>&nbsp;<span class="ident" id="5906757">Prepare</span><span class="op" id="5906764">(</span><span class="ident" id="5906765">query</span>&nbsp;<span class="builtintype" id="5906771">string</span><span class="op" id="5906777">)</span>&nbsp;<span class="op" id="5906779">(</span><span class="op" id="5906780">*</span><span class="ident" id="5906781">Stmt</span><span class="op" id="5906785">,</span>&nbsp;<span class="builtintype" id="5906787">error</span><span class="op" id="5906792">)</span>&nbsp;<span class="op" id="5906794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5906797">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5906860">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5906918">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5906982">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907045">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907101">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907162">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907224">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907283">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907343">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907403">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907462">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5907526">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907567">dc</span><span class="op" id="5907569">,</span>&nbsp;<span class="ident" id="5907571">err</span>&nbsp;<span class="op" id="5907575">:=</span>&nbsp;<span class="ident" id="5907578">tx</span><span class="op" id="5907580">.</span><span class="ident" id="5907581">grabConn</span><span class="op" id="5907589">(</span><span class="op" id="5907590">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5907593">if</span>&nbsp;<span class="ident" id="5907596">err</span>&nbsp;<span class="op" id="5907600">!=</span>&nbsp;<span class="ident" id="5907603">nil</span>&nbsp;<span class="op" id="5907607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5907611">return</span>&nbsp;<span class="ident" id="5907618">nil</span><span class="op" id="5907621">,</span>&nbsp;<span class="ident" id="5907623">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5907628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907632">dc</span><span class="op" id="5907634">.</span><span class="ident" id="5907635">Lock</span><span class="op" id="5907639">(</span><span class="op" id="5907640">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907643">si</span><span class="op" id="5907645">,</span>&nbsp;<span class="ident" id="5907647">err</span>&nbsp;<span class="op" id="5907651">:=</span>&nbsp;<span class="ident" id="5907654">dc</span><span class="op" id="5907656">.</span><span class="ident" id="5907657">ci</span><span class="op" id="5907659">.</span><span class="ident" id="5907660">Prepare</span><span class="op" id="5907667">(</span><span class="ident" id="5907668">query</span><span class="op" id="5907673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907676">dc</span><span class="op" id="5907678">.</span><span class="ident" id="5907679">Unlock</span><span class="op" id="5907685">(</span><span class="op" id="5907686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5907689">if</span>&nbsp;<span class="ident" id="5907692">err</span>&nbsp;<span class="op" id="5907696">!=</span>&nbsp;<span class="ident" id="5907699">nil</span>&nbsp;<span class="op" id="5907703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5907707">return</span>&nbsp;<span class="ident" id="5907714">nil</span><span class="op" id="5907717">,</span>&nbsp;<span class="ident" id="5907719">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5907724">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907728">stmt</span>&nbsp;<span class="op" id="5907733">:=</span>&nbsp;<span class="op" id="5907736">&amp;</span><span class="ident" id="5907737">Stmt</span><span class="op" id="5907741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907745">db</span><span class="op" id="5907747">:</span>&nbsp;<span class="ident" id="5907749">tx</span><span class="op" id="5907751">.</span><span class="ident" id="5907752">db</span><span class="op" id="5907754">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907758">tx</span><span class="op" id="5907760">:</span>&nbsp;<span class="ident" id="5907762">tx</span><span class="op" id="5907764">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907768">txsi</span><span class="op" id="5907772">:</span>&nbsp;<span class="op" id="5907774">&amp;</span><span class="ident" id="5907775">driverStmt</span><span class="op" id="5907785">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907790">Locker</span><span class="op" id="5907796">:</span>&nbsp;<span class="ident" id="5907798">dc</span><span class="op" id="5907800">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907805">si</span><span class="op" id="5907807">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907813">si</span><span class="op" id="5907815">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5907819">}</span><span class="op" id="5907820">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907824">query</span><span class="op" id="5907829">:</span>&nbsp;<span class="ident" id="5907831">query</span><span class="op" id="5907836">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5907839">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907842">tx</span><span class="op" id="5907844">.</span><span class="ident" id="5907845">stmts</span><span class="op" id="5907850">.</span><span class="ident" id="5907851">Lock</span><span class="op" id="5907855">(</span><span class="op" id="5907856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907859">tx</span><span class="op" id="5907861">.</span><span class="ident" id="5907862">stmts</span><span class="op" id="5907867">.</span><span class="ident" id="5907868">v</span>&nbsp;<span class="op" id="5907870">=</span>&nbsp;<span class="builtinfunc" id="5907872">append</span><span class="op" id="5907878">(</span><span class="ident" id="5907879">tx</span><span class="op" id="5907881">.</span><span class="ident" id="5907882">stmts</span><span class="op" id="5907887">.</span><span class="ident" id="5907888">v</span><span class="op" id="5907889">,</span>&nbsp;<span class="ident" id="5907891">stmt</span><span class="op" id="5907895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5907898">tx</span><span class="op" id="5907900">.</span><span class="ident" id="5907901">stmts</span><span class="op" id="5907906">.</span><span class="ident" id="5907907">Unlock</span><span class="op" id="5907913">(</span><span class="op" id="5907914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5907917">return</span>&nbsp;<span class="ident" id="5907924">stmt</span><span class="op" id="5907928">,</span>&nbsp;<span class="ident" id="5907930">nil</span><br>
<span class="lineno"></span><span class="op" id="5907934">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="5907937">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="5908000">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5908026">//</span><br>
<span class="lineno"></span><span class="comment" id="5908029">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="5908041">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5908123">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5908131">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="5908157">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5908165">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="5908225">func</span>&nbsp;<span class="op" id="5908230">(</span><span class="ident" id="5908231">tx</span>&nbsp;<span class="op" id="5908234">*</span><span class="ident" id="5908235">Tx</span><span class="op" id="5908237">)</span>&nbsp;<span class="ident" id="5908239">Stmt</span><span class="op" id="5908243">(</span><span class="ident" id="5908244">stmt</span>&nbsp;<span class="op" id="5908249">*</span><span class="ident" id="5908250">Stmt</span><span class="op" id="5908254">)</span>&nbsp;<span class="op" id="5908256">*</span><span class="ident" id="5908257">Stmt</span>&nbsp;<span class="op" id="5908262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5908265">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5908327">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5908390">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5908445">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908500">if</span>&nbsp;<span class="ident" id="5908503">tx</span><span class="op" id="5908505">.</span><span class="ident" id="5908506">db</span>&nbsp;<span class="op" id="5908509">!=</span>&nbsp;<span class="ident" id="5908512">stmt</span><span class="op" id="5908516">.</span><span class="ident" id="5908517">db</span>&nbsp;<span class="op" id="5908520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908524">return</span>&nbsp;<span class="op" id="5908531">&amp;</span><span class="ident" id="5908532">Stmt</span><span class="op" id="5908536">{</span><span class="ident" id="5908537">stickyErr</span><span class="op" id="5908546">:</span>&nbsp;<span class="ident" id="5908548">errors</span><span class="op" id="5908554">.</span><span class="ident" id="5908555">New</span><span class="op" id="5908558">(</span><span class="string" id="5908559">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="5908613">)</span><span class="op" id="5908614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908620">dc</span><span class="op" id="5908622">,</span>&nbsp;<span class="ident" id="5908624">err</span>&nbsp;<span class="op" id="5908628">:=</span>&nbsp;<span class="ident" id="5908631">tx</span><span class="op" id="5908633">.</span><span class="ident" id="5908634">grabConn</span><span class="op" id="5908642">(</span><span class="op" id="5908643">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908646">if</span>&nbsp;<span class="ident" id="5908649">err</span>&nbsp;<span class="op" id="5908653">!=</span>&nbsp;<span class="ident" id="5908656">nil</span>&nbsp;<span class="op" id="5908660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908664">return</span>&nbsp;<span class="op" id="5908671">&amp;</span><span class="ident" id="5908672">Stmt</span><span class="op" id="5908676">{</span><span class="ident" id="5908677">stickyErr</span><span class="op" id="5908686">:</span>&nbsp;<span class="ident" id="5908688">err</span><span class="op" id="5908691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908697">dc</span><span class="op" id="5908699">.</span><span class="ident" id="5908700">Lock</span><span class="op" id="5908704">(</span><span class="op" id="5908705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908708">si</span><span class="op" id="5908710">,</span>&nbsp;<span class="ident" id="5908712">err</span>&nbsp;<span class="op" id="5908716">:=</span>&nbsp;<span class="ident" id="5908719">dc</span><span class="op" id="5908721">.</span><span class="ident" id="5908722">ci</span><span class="op" id="5908724">.</span><span class="ident" id="5908725">Prepare</span><span class="op" id="5908732">(</span><span class="ident" id="5908733">stmt</span><span class="op" id="5908737">.</span><span class="ident" id="5908738">query</span><span class="op" id="5908743">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908746">dc</span><span class="op" id="5908748">.</span><span class="ident" id="5908749">Unlock</span><span class="op" id="5908755">(</span><span class="op" id="5908756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908759">txs</span>&nbsp;<span class="op" id="5908763">:=</span>&nbsp;<span class="op" id="5908766">&amp;</span><span class="ident" id="5908767">Stmt</span><span class="op" id="5908771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908775">db</span><span class="op" id="5908777">:</span>&nbsp;<span class="ident" id="5908779">tx</span><span class="op" id="5908781">.</span><span class="ident" id="5908782">db</span><span class="op" id="5908784">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908788">tx</span><span class="op" id="5908790">:</span>&nbsp;<span class="ident" id="5908792">tx</span><span class="op" id="5908794">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908798">txsi</span><span class="op" id="5908802">:</span>&nbsp;<span class="op" id="5908804">&amp;</span><span class="ident" id="5908805">driverStmt</span><span class="op" id="5908815">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908820">Locker</span><span class="op" id="5908826">:</span>&nbsp;<span class="ident" id="5908828">dc</span><span class="op" id="5908830">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908835">si</span><span class="op" id="5908837">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908843">si</span><span class="op" id="5908845">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908849">}</span><span class="op" id="5908850">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908854">query</span><span class="op" id="5908859">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908865">stmt</span><span class="op" id="5908869">.</span><span class="ident" id="5908870">query</span><span class="op" id="5908875">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908879">stickyErr</span><span class="op" id="5908888">:</span>&nbsp;<span class="ident" id="5908890">err</span><span class="op" id="5908893">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5908896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908899">tx</span><span class="op" id="5908901">.</span><span class="ident" id="5908902">stmts</span><span class="op" id="5908907">.</span><span class="ident" id="5908908">Lock</span><span class="op" id="5908912">(</span><span class="op" id="5908913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908916">tx</span><span class="op" id="5908918">.</span><span class="ident" id="5908919">stmts</span><span class="op" id="5908924">.</span><span class="ident" id="5908925">v</span>&nbsp;<span class="op" id="5908927">=</span>&nbsp;<span class="builtinfunc" id="5908929">append</span><span class="op" id="5908935">(</span><span class="ident" id="5908936">tx</span><span class="op" id="5908938">.</span><span class="ident" id="5908939">stmts</span><span class="op" id="5908944">.</span><span class="ident" id="5908945">v</span><span class="op" id="5908946">,</span>&nbsp;<span class="ident" id="5908948">txs</span><span class="op" id="5908951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5908954">tx</span><span class="op" id="5908956">.</span><span class="ident" id="5908957">stmts</span><span class="op" id="5908962">.</span><span class="ident" id="5908963">Unlock</span><span class="op" id="5908969">(</span><span class="op" id="5908970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5908973">return</span>&nbsp;<span class="ident" id="5908980">txs</span><br>
<span class="lineno">1215</span><span class="op" id="5908984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5908987">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="5909038">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="5909076">func</span>&nbsp;<span class="op" id="5909081">(</span><span class="ident" id="5909082">tx</span>&nbsp;<span class="op" id="5909085">*</span><span class="ident" id="5909086">Tx</span><span class="op" id="5909088">)</span>&nbsp;<span class="ident" id="5909090">Exec</span><span class="op" id="5909094">(</span><span class="ident" id="5909095">query</span>&nbsp;<span class="builtintype" id="5909101">string</span><span class="op" id="5909107">,</span>&nbsp;<span class="ident" id="5909109">args</span>&nbsp;<span class="op" id="5909114">...</span><span class="keyword" id="5909117">interface</span><span class="op" id="5909126">{</span><span class="op" id="5909127">}</span><span class="op" id="5909128">)</span>&nbsp;<span class="op" id="5909130">(</span><span class="ident" id="5909131">Result</span><span class="op" id="5909137">,</span>&nbsp;<span class="builtintype" id="5909139">error</span><span class="op" id="5909144">)</span>&nbsp;<span class="op" id="5909146">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909149">dc</span><span class="op" id="5909151">,</span>&nbsp;<span class="ident" id="5909153">err</span>&nbsp;<span class="op" id="5909157">:=</span>&nbsp;<span class="ident" id="5909160">tx</span><span class="op" id="5909162">.</span><span class="ident" id="5909163">grabConn</span><span class="op" id="5909171">(</span><span class="op" id="5909172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909175">if</span>&nbsp;<span class="ident" id="5909178">err</span>&nbsp;<span class="op" id="5909182">!=</span>&nbsp;<span class="ident" id="5909185">nil</span>&nbsp;<span class="op" id="5909189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909193">return</span>&nbsp;<span class="ident" id="5909200">nil</span><span class="op" id="5909203">,</span>&nbsp;<span class="ident" id="5909205">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5909210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909214">if</span>&nbsp;<span class="ident" id="5909217">execer</span><span class="op" id="5909223">,</span>&nbsp;<span class="ident" id="5909225">ok</span>&nbsp;<span class="op" id="5909228">:=</span>&nbsp;<span class="ident" id="5909231">dc</span><span class="op" id="5909233">.</span><span class="ident" id="5909234">ci</span><span class="op" id="5909236">.</span><span class="op" id="5909237">(</span><span class="ident" id="5909238">driver</span><span class="op" id="5909244">.</span><span class="ident" id="5909245">Execer</span><span class="op" id="5909251">)</span><span class="op" id="5909252">;</span>&nbsp;<span class="ident" id="5909254">ok</span>&nbsp;<span class="op" id="5909257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909261">dargs</span><span class="op" id="5909266">,</span>&nbsp;<span class="ident" id="5909268">err</span>&nbsp;<span class="op" id="5909272">:=</span>&nbsp;<span class="ident" id="5909275">driverArgs</span><span class="op" id="5909285">(</span><span class="ident" id="5909286">nil</span><span class="op" id="5909289">,</span>&nbsp;<span class="ident" id="5909291">args</span><span class="op" id="5909295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909299">if</span>&nbsp;<span class="ident" id="5909302">err</span>&nbsp;<span class="op" id="5909306">!=</span>&nbsp;<span class="ident" id="5909309">nil</span>&nbsp;<span class="op" id="5909313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909318">return</span>&nbsp;<span class="ident" id="5909325">nil</span><span class="op" id="5909328">,</span>&nbsp;<span class="ident" id="5909330">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5909336">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909340">dc</span><span class="op" id="5909342">.</span><span class="ident" id="5909343">Lock</span><span class="op" id="5909347">(</span><span class="op" id="5909348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909352">resi</span><span class="op" id="5909356">,</span>&nbsp;<span class="ident" id="5909358">err</span>&nbsp;<span class="op" id="5909362">:=</span>&nbsp;<span class="ident" id="5909365">execer</span><span class="op" id="5909371">.</span><span class="ident" id="5909372">Exec</span><span class="op" id="5909376">(</span><span class="ident" id="5909377">query</span><span class="op" id="5909382">,</span>&nbsp;<span class="ident" id="5909384">dargs</span><span class="op" id="5909389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909393">dc</span><span class="op" id="5909395">.</span><span class="ident" id="5909396">Unlock</span><span class="op" id="5909402">(</span><span class="op" id="5909403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909407">if</span>&nbsp;<span class="ident" id="5909410">err</span>&nbsp;<span class="op" id="5909414">==</span>&nbsp;<span class="ident" id="5909417">nil</span>&nbsp;<span class="op" id="5909421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909426">return</span>&nbsp;<span class="ident" id="5909433">driverResult</span><span class="op" id="5909445">{</span><span class="ident" id="5909446">dc</span><span class="op" id="5909448">,</span>&nbsp;<span class="ident" id="5909450">resi</span><span class="op" id="5909454">}</span><span class="op" id="5909455">,</span>&nbsp;<span class="ident" id="5909457">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5909463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909467">if</span>&nbsp;<span class="ident" id="5909470">err</span>&nbsp;<span class="op" id="5909474">!=</span>&nbsp;<span class="ident" id="5909477">driver</span><span class="op" id="5909483">.</span><span class="ident" id="5909484">ErrSkip</span>&nbsp;<span class="op" id="5909492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909497">return</span>&nbsp;<span class="ident" id="5909504">nil</span><span class="op" id="5909507">,</span>&nbsp;<span class="ident" id="5909509">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5909515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5909518">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909522">dc</span><span class="op" id="5909524">.</span><span class="ident" id="5909525">Lock</span><span class="op" id="5909529">(</span><span class="op" id="5909530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909533">si</span><span class="op" id="5909535">,</span>&nbsp;<span class="ident" id="5909537">err</span>&nbsp;<span class="op" id="5909541">:=</span>&nbsp;<span class="ident" id="5909544">dc</span><span class="op" id="5909546">.</span><span class="ident" id="5909547">ci</span><span class="op" id="5909549">.</span><span class="ident" id="5909550">Prepare</span><span class="op" id="5909557">(</span><span class="ident" id="5909558">query</span><span class="op" id="5909563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909566">dc</span><span class="op" id="5909568">.</span><span class="ident" id="5909569">Unlock</span><span class="op" id="5909575">(</span><span class="op" id="5909576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909579">if</span>&nbsp;<span class="ident" id="5909582">err</span>&nbsp;<span class="op" id="5909586">!=</span>&nbsp;<span class="ident" id="5909589">nil</span>&nbsp;<span class="op" id="5909593">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909597">return</span>&nbsp;<span class="ident" id="5909604">nil</span><span class="op" id="5909607">,</span>&nbsp;<span class="ident" id="5909609">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5909614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909617">defer</span>&nbsp;<span class="ident" id="5909623">withLock</span><span class="op" id="5909631">(</span><span class="ident" id="5909632">dc</span><span class="op" id="5909634">,</span>&nbsp;<span class="keyword" id="5909636">func</span><span class="op" id="5909640">(</span><span class="op" id="5909641">)</span>&nbsp;<span class="op" id="5909643">{</span>&nbsp;<span class="ident" id="5909645">si</span><span class="op" id="5909647">.</span><span class="ident" id="5909648">Close</span><span class="op" id="5909653">(</span><span class="op" id="5909654">)</span>&nbsp;<span class="op" id="5909656">}</span><span class="op" id="5909657">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909661">return</span>&nbsp;<span class="ident" id="5909668">resultFromStatement</span><span class="op" id="5909687">(</span><span class="ident" id="5909688">driverStmt</span><span class="op" id="5909698">{</span><span class="ident" id="5909699">dc</span><span class="op" id="5909701">,</span>&nbsp;<span class="ident" id="5909703">si</span><span class="op" id="5909705">}</span><span class="op" id="5909706">,</span>&nbsp;<span class="ident" id="5909708">args</span><span class="op" id="5909712">...</span><span class="op" id="5909715">)</span><br>
<span class="lineno">1250</span><span class="op" id="5909717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5909720">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="5909785">func</span>&nbsp;<span class="op" id="5909790">(</span><span class="ident" id="5909791">tx</span>&nbsp;<span class="op" id="5909794">*</span><span class="ident" id="5909795">Tx</span><span class="op" id="5909797">)</span>&nbsp;<span class="ident" id="5909799">Query</span><span class="op" id="5909804">(</span><span class="ident" id="5909805">query</span>&nbsp;<span class="builtintype" id="5909811">string</span><span class="op" id="5909817">,</span>&nbsp;<span class="ident" id="5909819">args</span>&nbsp;<span class="op" id="5909824">...</span><span class="keyword" id="5909827">interface</span><span class="op" id="5909836">{</span><span class="op" id="5909837">}</span><span class="op" id="5909838">)</span>&nbsp;<span class="op" id="5909840">(</span><span class="op" id="5909841">*</span><span class="ident" id="5909842">Rows</span><span class="op" id="5909846">,</span>&nbsp;<span class="builtintype" id="5909848">error</span><span class="op" id="5909853">)</span>&nbsp;<span class="op" id="5909855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909858">dc</span><span class="op" id="5909860">,</span>&nbsp;<span class="ident" id="5909862">err</span>&nbsp;<span class="op" id="5909866">:=</span>&nbsp;<span class="ident" id="5909869">tx</span><span class="op" id="5909871">.</span><span class="ident" id="5909872">grabConn</span><span class="op" id="5909880">(</span><span class="op" id="5909881">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909884">if</span>&nbsp;<span class="ident" id="5909887">err</span>&nbsp;<span class="op" id="5909891">!=</span>&nbsp;<span class="ident" id="5909894">nil</span>&nbsp;<span class="op" id="5909898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909902">return</span>&nbsp;<span class="ident" id="5909909">nil</span><span class="op" id="5909912">,</span>&nbsp;<span class="ident" id="5909914">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5909919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5909922">releaseConn</span>&nbsp;<span class="op" id="5909934">:=</span>&nbsp;<span class="keyword" id="5909937">func</span><span class="op" id="5909941">(</span><span class="builtintype" id="5909942">error</span><span class="op" id="5909947">)</span>&nbsp;<span class="op" id="5909949">{</span><span class="op" id="5909950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5909953">return</span>&nbsp;<span class="ident" id="5909960">tx</span><span class="op" id="5909962">.</span><span class="ident" id="5909963">db</span><span class="op" id="5909965">.</span><span class="ident" id="5909966">queryConn</span><span class="op" id="5909975">(</span><span class="ident" id="5909976">dc</span><span class="op" id="5909978">,</span>&nbsp;<span class="ident" id="5909980">releaseConn</span><span class="op" id="5909991">,</span>&nbsp;<span class="ident" id="5909993">query</span><span class="op" id="5909998">,</span>&nbsp;<span class="ident" id="5910000">args</span><span class="op" id="5910004">)</span><br>
<span class="lineno">1260</span><span class="op" id="5910006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5910009">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="5910082">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="5910151">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="5910183">func</span>&nbsp;<span class="op" id="5910188">(</span><span class="ident" id="5910189">tx</span>&nbsp;<span class="op" id="5910192">*</span><span class="ident" id="5910193">Tx</span><span class="op" id="5910195">)</span>&nbsp;<span class="ident" id="5910197">QueryRow</span><span class="op" id="5910205">(</span><span class="ident" id="5910206">query</span>&nbsp;<span class="builtintype" id="5910212">string</span><span class="op" id="5910218">,</span>&nbsp;<span class="ident" id="5910220">args</span>&nbsp;<span class="op" id="5910225">...</span><span class="keyword" id="5910228">interface</span><span class="op" id="5910237">{</span><span class="op" id="5910238">}</span><span class="op" id="5910239">)</span>&nbsp;<span class="op" id="5910241">*</span><span class="ident" id="5910242">Row</span>&nbsp;<span class="op" id="5910246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910249">rows</span><span class="op" id="5910253">,</span>&nbsp;<span class="ident" id="5910255">err</span>&nbsp;<span class="op" id="5910259">:=</span>&nbsp;<span class="ident" id="5910262">tx</span><span class="op" id="5910264">.</span><span class="ident" id="5910265">Query</span><span class="op" id="5910270">(</span><span class="ident" id="5910271">query</span><span class="op" id="5910276">,</span>&nbsp;<span class="ident" id="5910278">args</span><span class="op" id="5910282">...</span><span class="op" id="5910285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5910288">return</span>&nbsp;<span class="op" id="5910295">&amp;</span><span class="ident" id="5910296">Row</span><span class="op" id="5910299">{</span><span class="ident" id="5910300">rows</span><span class="op" id="5910304">:</span>&nbsp;<span class="ident" id="5910306">rows</span><span class="op" id="5910310">,</span>&nbsp;<span class="ident" id="5910312">err</span><span class="op" id="5910315">:</span>&nbsp;<span class="ident" id="5910317">err</span><span class="op" id="5910320">}</span><br>
<span class="lineno"></span><span class="op" id="5910322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="5910325">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5910389">type</span>&nbsp;<span class="ident" id="5910394">connStmt</span>&nbsp;<span class="keyword" id="5910403">struct</span>&nbsp;<span class="op" id="5910410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910413">dc</span>&nbsp;<span class="op" id="5910416">*</span><span class="ident" id="5910417">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910429">si</span>&nbsp;<span class="ident" id="5910432">driver</span><span class="op" id="5910438">.</span><span class="ident" id="5910439">Stmt</span><br>
<span class="lineno"></span><span class="op" id="5910444">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="5910447">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5910536">type</span>&nbsp;<span class="ident" id="5910541">Stmt</span>&nbsp;<span class="keyword" id="5910546">struct</span>&nbsp;<span class="op" id="5910553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910556">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910571">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5910581">*</span><span class="ident" id="5910582">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5910588">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910611">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5910621">string</span>&nbsp;<span class="comment" id="5910628">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910654">stickyErr</span>&nbsp;<span class="builtintype" id="5910664">error</span>&nbsp;&nbsp;<span class="comment" id="5910671">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910730">closemu</span>&nbsp;<span class="ident" id="5910738">sync</span><span class="op" id="5910742">.</span><span class="ident" id="5910743">RWMutex</span>&nbsp;<span class="comment" id="5910751">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910807">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910847">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5910852">*</span><span class="ident" id="5910853">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910857">txsi</span>&nbsp;<span class="op" id="5910862">*</span><span class="ident" id="5910863">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910876">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910883">sync</span><span class="op" id="5910887">.</span><span class="ident" id="5910888">Mutex</span>&nbsp;<span class="comment" id="5910894">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5910930">closed</span>&nbsp;<span class="builtintype" id="5910937">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5910944">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911004">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911064">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911117">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5911170">css</span>&nbsp;<span class="op" id="5911174">[</span><span class="op" id="5911175">]</span><span class="ident" id="5911176">connStmt</span><br>
<span class="lineno"></span><span class="op" id="5911185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5911188">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="5911255">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5911316">func</span>&nbsp;<span class="op" id="5911321">(</span><span class="ident" id="5911322">s</span>&nbsp;<span class="op" id="5911324">*</span><span class="ident" id="5911325">Stmt</span><span class="op" id="5911329">)</span>&nbsp;<span class="ident" id="5911331">Exec</span><span class="op" id="5911335">(</span><span class="ident" id="5911336">args</span>&nbsp;<span class="op" id="5911341">...</span><span class="keyword" id="5911344">interface</span><span class="op" id="5911353">{</span><span class="op" id="5911354">}</span><span class="op" id="5911355">)</span>&nbsp;<span class="op" id="5911357">(</span><span class="ident" id="5911358">Result</span><span class="op" id="5911364">,</span>&nbsp;<span class="builtintype" id="5911366">error</span><span class="op" id="5911371">)</span>&nbsp;<span class="op" id="5911373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5911376">s</span><span class="op" id="5911377">.</span><span class="ident" id="5911378">closemu</span><span class="op" id="5911385">.</span><span class="ident" id="5911386">RLock</span><span class="op" id="5911391">(</span><span class="op" id="5911392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911395">defer</span>&nbsp;<span class="ident" id="5911401">s</span><span class="op" id="5911402">.</span><span class="ident" id="5911403">closemu</span><span class="op" id="5911410">.</span><span class="ident" id="5911411">RUnlock</span><span class="op" id="5911418">(</span><span class="op" id="5911419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911423">var</span>&nbsp;<span class="ident" id="5911427">res</span>&nbsp;<span class="ident" id="5911431">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911439">for</span>&nbsp;<span class="ident" id="5911443">i</span>&nbsp;<span class="op" id="5911445">:=</span>&nbsp;<span class="num" id="5911448">0</span><span class="op" id="5911449">;</span>&nbsp;<span class="ident" id="5911451">i</span>&nbsp;<span class="op" id="5911453">&lt;</span>&nbsp;<span class="ident" id="5911455">maxBadConnRetries</span><span class="op" id="5911472">;</span>&nbsp;<span class="ident" id="5911474">i</span><span class="op" id="5911475">++</span>&nbsp;<span class="op" id="5911478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5911482">dc</span><span class="op" id="5911484">,</span>&nbsp;<span class="ident" id="5911486">releaseConn</span><span class="op" id="5911497">,</span>&nbsp;<span class="ident" id="5911499">si</span><span class="op" id="5911501">,</span>&nbsp;<span class="ident" id="5911503">err</span>&nbsp;<span class="op" id="5911507">:=</span>&nbsp;<span class="ident" id="5911510">s</span><span class="op" id="5911511">.</span><span class="ident" id="5911512">connStmt</span><span class="op" id="5911520">(</span><span class="op" id="5911521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911525">if</span>&nbsp;<span class="ident" id="5911528">err</span>&nbsp;<span class="op" id="5911532">!=</span>&nbsp;<span class="ident" id="5911535">nil</span>&nbsp;<span class="op" id="5911539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911544">if</span>&nbsp;<span class="ident" id="5911547">err</span>&nbsp;<span class="op" id="5911551">==</span>&nbsp;<span class="ident" id="5911554">driver</span><span class="op" id="5911560">.</span><span class="ident" id="5911561">ErrBadConn</span>&nbsp;<span class="op" id="5911572">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911578">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5911590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911595">return</span>&nbsp;<span class="ident" id="5911602">nil</span><span class="op" id="5911605">,</span>&nbsp;<span class="ident" id="5911607">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5911613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5911618">res</span><span class="op" id="5911621">,</span>&nbsp;<span class="ident" id="5911623">err</span>&nbsp;<span class="op" id="5911627">=</span>&nbsp;<span class="ident" id="5911629">resultFromStatement</span><span class="op" id="5911648">(</span><span class="ident" id="5911649">driverStmt</span><span class="op" id="5911659">{</span><span class="ident" id="5911660">dc</span><span class="op" id="5911662">,</span>&nbsp;<span class="ident" id="5911664">si</span><span class="op" id="5911666">}</span><span class="op" id="5911667">,</span>&nbsp;<span class="ident" id="5911669">args</span><span class="op" id="5911673">...</span><span class="op" id="5911676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5911680">releaseConn</span><span class="op" id="5911691">(</span><span class="ident" id="5911692">err</span><span class="op" id="5911695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911699">if</span>&nbsp;<span class="ident" id="5911702">err</span>&nbsp;<span class="op" id="5911706">!=</span>&nbsp;<span class="ident" id="5911709">driver</span><span class="op" id="5911715">.</span><span class="ident" id="5911716">ErrBadConn</span>&nbsp;<span class="op" id="5911727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911732">return</span>&nbsp;<span class="ident" id="5911739">res</span><span class="op" id="5911742">,</span>&nbsp;<span class="ident" id="5911744">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5911750">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5911753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5911756">return</span>&nbsp;<span class="ident" id="5911763">nil</span><span class="op" id="5911766">,</span>&nbsp;<span class="ident" id="5911768">driver</span><span class="op" id="5911774">.</span><span class="ident" id="5911775">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="5911786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5911789">func</span>&nbsp;<span class="ident" id="5911794">resultFromStatement</span><span class="op" id="5911813">(</span><span class="ident" id="5911814">ds</span>&nbsp;<span class="ident" id="5911817">driverStmt</span><span class="op" id="5911827">,</span>&nbsp;<span class="ident" id="5911829">args</span>&nbsp;<span class="op" id="5911834">...</span><span class="keyword" id="5911837">interface</span><span class="op" id="5911846">{</span><span class="op" id="5911847">}</span><span class="op" id="5911848">)</span>&nbsp;<span class="op" id="5911850">(</span><span class="ident" id="5911851">Result</span><span class="op" id="5911857">,</span>&nbsp;<span class="builtintype" id="5911859">error</span><span class="op" id="5911864">)</span>&nbsp;<span class="op" id="5911866">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5911869">ds</span><span class="op" id="5911871">.</span><span class="ident" id="5911872">Lock</span><span class="op" id="5911876">(</span><span class="op" id="5911877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5911880">want</span>&nbsp;<span class="op" id="5911885">:=</span>&nbsp;<span class="ident" id="5911888">ds</span><span class="op" id="5911890">.</span><span class="ident" id="5911891">si</span><span class="op" id="5911893">.</span><span class="ident" id="5911894">NumInput</span><span class="op" id="5911902">(</span><span class="op" id="5911903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5911906">ds</span><span class="op" id="5911908">.</span><span class="ident" id="5911909">Unlock</span><span class="op" id="5911915">(</span><span class="op" id="5911916">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911920">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5911984">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5912058">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912087">if</span>&nbsp;<span class="ident" id="5912090">want</span>&nbsp;<span class="op" id="5912095">!=</span>&nbsp;<span class="op" id="5912098">-</span><span class="num" id="5912099">1</span>&nbsp;<span class="op" id="5912101">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5912104">len</span><span class="op" id="5912107">(</span><span class="ident" id="5912108">args</span><span class="op" id="5912112">)</span>&nbsp;<span class="op" id="5912114">!=</span>&nbsp;<span class="ident" id="5912117">want</span>&nbsp;<span class="op" id="5912122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912126">return</span>&nbsp;<span class="ident" id="5912133">nil</span><span class="op" id="5912136">,</span>&nbsp;<span class="ident" id="5912138">fmt</span><span class="op" id="5912141">.</span><span class="ident" id="5912142">Errorf</span><span class="op" id="5912148">(</span><span class="string" id="5912149">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="5912185">,</span>&nbsp;<span class="ident" id="5912187">want</span><span class="op" id="5912191">,</span>&nbsp;<span class="builtinfunc" id="5912193">len</span><span class="op" id="5912196">(</span><span class="ident" id="5912197">args</span><span class="op" id="5912201">)</span><span class="op" id="5912202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912205">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912209">dargs</span><span class="op" id="5912214">,</span>&nbsp;<span class="ident" id="5912216">err</span>&nbsp;<span class="op" id="5912220">:=</span>&nbsp;<span class="ident" id="5912223">driverArgs</span><span class="op" id="5912233">(</span><span class="op" id="5912234">&amp;</span><span class="ident" id="5912235">ds</span><span class="op" id="5912237">,</span>&nbsp;<span class="ident" id="5912239">args</span><span class="op" id="5912243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912246">if</span>&nbsp;<span class="ident" id="5912249">err</span>&nbsp;<span class="op" id="5912253">!=</span>&nbsp;<span class="ident" id="5912256">nil</span>&nbsp;<span class="op" id="5912260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912264">return</span>&nbsp;<span class="ident" id="5912271">nil</span><span class="op" id="5912274">,</span>&nbsp;<span class="ident" id="5912276">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912281">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912285">ds</span><span class="op" id="5912287">.</span><span class="ident" id="5912288">Lock</span><span class="op" id="5912292">(</span><span class="op" id="5912293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912296">resi</span><span class="op" id="5912300">,</span>&nbsp;<span class="ident" id="5912302">err</span>&nbsp;<span class="op" id="5912306">:=</span>&nbsp;<span class="ident" id="5912309">ds</span><span class="op" id="5912311">.</span><span class="ident" id="5912312">si</span><span class="op" id="5912314">.</span><span class="ident" id="5912315">Exec</span><span class="op" id="5912319">(</span><span class="ident" id="5912320">dargs</span><span class="op" id="5912325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912328">ds</span><span class="op" id="5912330">.</span><span class="ident" id="5912331">Unlock</span><span class="op" id="5912337">(</span><span class="op" id="5912338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912341">if</span>&nbsp;<span class="ident" id="5912344">err</span>&nbsp;<span class="op" id="5912348">!=</span>&nbsp;<span class="ident" id="5912351">nil</span>&nbsp;<span class="op" id="5912355">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912359">return</span>&nbsp;<span class="ident" id="5912366">nil</span><span class="op" id="5912369">,</span>&nbsp;<span class="ident" id="5912371">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912379">return</span>&nbsp;<span class="ident" id="5912386">driverResult</span><span class="op" id="5912398">{</span><span class="ident" id="5912399">ds</span><span class="op" id="5912401">.</span><span class="ident" id="5912402">Locker</span><span class="op" id="5912408">,</span>&nbsp;<span class="ident" id="5912410">resi</span><span class="op" id="5912414">}</span><span class="op" id="5912415">,</span>&nbsp;<span class="ident" id="5912417">nil</span><br>
<span class="lineno"></span><span class="op" id="5912421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="5912424">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5912493">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5912559">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5912598">func</span>&nbsp;<span class="op" id="5912603">(</span><span class="ident" id="5912604">s</span>&nbsp;<span class="op" id="5912606">*</span><span class="ident" id="5912607">Stmt</span><span class="op" id="5912611">)</span>&nbsp;<span class="ident" id="5912613">connStmt</span><span class="op" id="5912621">(</span><span class="op" id="5912622">)</span>&nbsp;<span class="op" id="5912624">(</span><span class="ident" id="5912625">ci</span>&nbsp;<span class="op" id="5912628">*</span><span class="ident" id="5912629">driverConn</span><span class="op" id="5912639">,</span>&nbsp;<span class="ident" id="5912641">releaseConn</span>&nbsp;<span class="keyword" id="5912653">func</span><span class="op" id="5912657">(</span><span class="builtintype" id="5912658">error</span><span class="op" id="5912663">)</span><span class="op" id="5912664">,</span>&nbsp;<span class="ident" id="5912666">si</span>&nbsp;<span class="ident" id="5912669">driver</span><span class="op" id="5912675">.</span><span class="ident" id="5912676">Stmt</span><span class="op" id="5912680">,</span>&nbsp;<span class="ident" id="5912682">err</span>&nbsp;<span class="builtintype" id="5912686">error</span><span class="op" id="5912691">)</span>&nbsp;<span class="op" id="5912693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912696">if</span>&nbsp;<span class="ident" id="5912699">err</span>&nbsp;<span class="op" id="5912703">=</span>&nbsp;<span class="ident" id="5912705">s</span><span class="op" id="5912706">.</span><span class="ident" id="5912707">stickyErr</span><span class="op" id="5912716">;</span>&nbsp;<span class="ident" id="5912718">err</span>&nbsp;<span class="op" id="5912722">!=</span>&nbsp;<span class="ident" id="5912725">nil</span>&nbsp;<span class="op" id="5912729">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912733">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912744">s</span><span class="op" id="5912745">.</span><span class="ident" id="5912746">mu</span><span class="op" id="5912748">.</span><span class="ident" id="5912749">Lock</span><span class="op" id="5912753">(</span><span class="op" id="5912754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912757">if</span>&nbsp;<span class="ident" id="5912760">s</span><span class="op" id="5912761">.</span><span class="ident" id="5912762">closed</span>&nbsp;<span class="op" id="5912769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912773">s</span><span class="op" id="5912774">.</span><span class="ident" id="5912775">mu</span><span class="op" id="5912777">.</span><span class="ident" id="5912778">Unlock</span><span class="op" id="5912784">(</span><span class="op" id="5912785">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912789">err</span>&nbsp;<span class="op" id="5912793">=</span>&nbsp;<span class="ident" id="5912795">errors</span><span class="op" id="5912801">.</span><span class="ident" id="5912802">New</span><span class="op" id="5912805">(</span><span class="string" id="5912806">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5912832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912836">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5912844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5912848">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5912908">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5912940">if</span>&nbsp;<span class="ident" id="5912943">s</span><span class="op" id="5912944">.</span><span class="ident" id="5912945">tx</span>&nbsp;<span class="op" id="5912948">!=</span>&nbsp;<span class="ident" id="5912951">nil</span>&nbsp;<span class="op" id="5912955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912959">s</span><span class="op" id="5912960">.</span><span class="ident" id="5912961">mu</span><span class="op" id="5912963">.</span><span class="ident" id="5912964">Unlock</span><span class="op" id="5912970">(</span><span class="op" id="5912971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5912975">ci</span><span class="op" id="5912977">,</span>&nbsp;<span class="ident" id="5912979">err</span>&nbsp;<span class="op" id="5912983">=</span>&nbsp;<span class="ident" id="5912985">s</span><span class="op" id="5912986">.</span><span class="ident" id="5912987">tx</span><span class="op" id="5912989">.</span><span class="ident" id="5912990">grabConn</span><span class="op" id="5912998">(</span><span class="op" id="5912999">)</span>&nbsp;<span class="comment" id="5913001">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913042">if</span>&nbsp;<span class="ident" id="5913045">err</span>&nbsp;<span class="op" id="5913049">!=</span>&nbsp;<span class="ident" id="5913052">nil</span>&nbsp;<span class="op" id="5913056">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913061">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5913070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913074">releaseConn</span>&nbsp;<span class="op" id="5913086">=</span>&nbsp;<span class="keyword" id="5913088">func</span><span class="op" id="5913092">(</span><span class="builtintype" id="5913093">error</span><span class="op" id="5913098">)</span>&nbsp;<span class="op" id="5913100">{</span><span class="op" id="5913101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913105">return</span>&nbsp;<span class="ident" id="5913112">ci</span><span class="op" id="5913114">,</span>&nbsp;<span class="ident" id="5913116">releaseConn</span><span class="op" id="5913127">,</span>&nbsp;<span class="ident" id="5913129">s</span><span class="op" id="5913130">.</span><span class="ident" id="5913131">txsi</span><span class="op" id="5913135">.</span><span class="ident" id="5913136">si</span><span class="op" id="5913138">,</span>&nbsp;<span class="ident" id="5913140">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5913145">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913149">for</span>&nbsp;<span class="ident" id="5913153">i</span>&nbsp;<span class="op" id="5913155">:=</span>&nbsp;<span class="num" id="5913158">0</span><span class="op" id="5913159">;</span>&nbsp;<span class="ident" id="5913161">i</span>&nbsp;<span class="op" id="5913163">&lt;</span>&nbsp;<span class="builtinfunc" id="5913165">len</span><span class="op" id="5913168">(</span><span class="ident" id="5913169">s</span><span class="op" id="5913170">.</span><span class="ident" id="5913171">css</span><span class="op" id="5913174">)</span><span class="op" id="5913175">;</span>&nbsp;<span class="ident" id="5913177">i</span><span class="op" id="5913178">++</span>&nbsp;<span class="op" id="5913181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913185">v</span>&nbsp;<span class="op" id="5913187">:=</span>&nbsp;<span class="ident" id="5913190">s</span><span class="op" id="5913191">.</span><span class="ident" id="5913192">css</span><span class="op" id="5913195">[</span><span class="ident" id="5913196">i</span><span class="op" id="5913197">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913201">_</span><span class="op" id="5913202">,</span>&nbsp;<span class="ident" id="5913204">err</span>&nbsp;<span class="op" id="5913208">:=</span>&nbsp;<span class="ident" id="5913211">s</span><span class="op" id="5913212">.</span><span class="ident" id="5913213">db</span><span class="op" id="5913215">.</span><span class="ident" id="5913216">connIfFree</span><span class="op" id="5913226">(</span><span class="ident" id="5913227">v</span><span class="op" id="5913228">.</span><span class="ident" id="5913229">dc</span><span class="op" id="5913231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913235">if</span>&nbsp;<span class="ident" id="5913238">err</span>&nbsp;<span class="op" id="5913242">==</span>&nbsp;<span class="ident" id="5913245">nil</span>&nbsp;<span class="op" id="5913249">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913254">s</span><span class="op" id="5913255">.</span><span class="ident" id="5913256">mu</span><span class="op" id="5913258">.</span><span class="ident" id="5913259">Unlock</span><span class="op" id="5913265">(</span><span class="op" id="5913266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913271">return</span>&nbsp;<span class="ident" id="5913278">v</span><span class="op" id="5913279">.</span><span class="ident" id="5913280">dc</span><span class="op" id="5913282">,</span>&nbsp;<span class="ident" id="5913284">v</span><span class="op" id="5913285">.</span><span class="ident" id="5913286">dc</span><span class="op" id="5913288">.</span><span class="ident" id="5913289">releaseConn</span><span class="op" id="5913300">,</span>&nbsp;<span class="ident" id="5913302">v</span><span class="op" id="5913303">.</span><span class="ident" id="5913304">si</span><span class="op" id="5913306">,</span>&nbsp;<span class="ident" id="5913308">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5913314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913318">if</span>&nbsp;<span class="ident" id="5913321">err</span>&nbsp;<span class="op" id="5913325">==</span>&nbsp;<span class="ident" id="5913328">errConnClosed</span>&nbsp;<span class="op" id="5913342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5913347">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913396">s</span><span class="op" id="5913397">.</span><span class="ident" id="5913398">css</span><span class="op" id="5913401">[</span><span class="ident" id="5913402">i</span><span class="op" id="5913403">]</span>&nbsp;<span class="op" id="5913405">=</span>&nbsp;<span class="ident" id="5913407">s</span><span class="op" id="5913408">.</span><span class="ident" id="5913409">css</span><span class="op" id="5913412">[</span><span class="builtinfunc" id="5913413">len</span><span class="op" id="5913416">(</span><span class="ident" id="5913417">s</span><span class="op" id="5913418">.</span><span class="ident" id="5913419">css</span><span class="op" id="5913422">)</span><span class="op" id="5913423">-</span><span class="num" id="5913424">1</span><span class="op" id="5913425">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913430">s</span><span class="op" id="5913431">.</span><span class="ident" id="5913432">css</span>&nbsp;<span class="op" id="5913436">=</span>&nbsp;<span class="ident" id="5913438">s</span><span class="op" id="5913439">.</span><span class="ident" id="5913440">css</span><span class="op" id="5913443">[</span><span class="op" id="5913444">:</span><span class="builtinfunc" id="5913445">len</span><span class="op" id="5913448">(</span><span class="ident" id="5913449">s</span><span class="op" id="5913450">.</span><span class="ident" id="5913451">css</span><span class="op" id="5913454">)</span><span class="op" id="5913455">-</span><span class="num" id="5913456">1</span><span class="op" id="5913457">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913462">i</span><span class="op" id="5913463">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5913468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5913472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913475">s</span><span class="op" id="5913476">.</span><span class="ident" id="5913477">mu</span><span class="op" id="5913479">.</span><span class="ident" id="5913480">Unlock</span><span class="op" id="5913486">(</span><span class="op" id="5913487">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5913491">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5913568">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5913642">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5913655">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5913659">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913728">dc</span><span class="op" id="5913730">,</span>&nbsp;<span class="ident" id="5913732">err</span>&nbsp;<span class="op" id="5913736">:=</span>&nbsp;<span class="ident" id="5913739">s</span><span class="op" id="5913740">.</span><span class="ident" id="5913741">db</span><span class="op" id="5913743">.</span><span class="ident" id="5913744">conn</span><span class="op" id="5913748">(</span><span class="op" id="5913749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913752">if</span>&nbsp;<span class="ident" id="5913755">err</span>&nbsp;<span class="op" id="5913759">!=</span>&nbsp;<span class="ident" id="5913762">nil</span>&nbsp;<span class="op" id="5913766">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913770">return</span>&nbsp;<span class="ident" id="5913777">nil</span><span class="op" id="5913780">,</span>&nbsp;<span class="ident" id="5913782">nil</span><span class="op" id="5913785">,</span>&nbsp;<span class="ident" id="5913787">nil</span><span class="op" id="5913790">,</span>&nbsp;<span class="ident" id="5913792">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5913797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5913801">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5913869">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913929">s</span><span class="op" id="5913930">.</span><span class="ident" id="5913931">mu</span><span class="op" id="5913933">.</span><span class="ident" id="5913934">Lock</span><span class="op" id="5913938">(</span><span class="op" id="5913939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913942">for</span>&nbsp;<span class="ident" id="5913946">_</span><span class="op" id="5913947">,</span>&nbsp;<span class="ident" id="5913949">v</span>&nbsp;<span class="op" id="5913951">:=</span>&nbsp;<span class="keyword" id="5913954">range</span>&nbsp;<span class="ident" id="5913960">s</span><span class="op" id="5913961">.</span><span class="ident" id="5913962">css</span>&nbsp;<span class="op" id="5913966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5913970">if</span>&nbsp;<span class="ident" id="5913973">v</span><span class="op" id="5913974">.</span><span class="ident" id="5913975">dc</span>&nbsp;<span class="op" id="5913978">==</span>&nbsp;<span class="ident" id="5913981">dc</span>&nbsp;<span class="op" id="5913984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5913989">s</span><span class="op" id="5913990">.</span><span class="ident" id="5913991">mu</span><span class="op" id="5913993">.</span><span class="ident" id="5913994">Unlock</span><span class="op" id="5914000">(</span><span class="op" id="5914001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5914006">return</span>&nbsp;<span class="ident" id="5914013">dc</span><span class="op" id="5914015">,</span>&nbsp;<span class="ident" id="5914017">dc</span><span class="op" id="5914019">.</span><span class="ident" id="5914020">releaseConn</span><span class="op" id="5914031">,</span>&nbsp;<span class="ident" id="5914033">v</span><span class="op" id="5914034">.</span><span class="ident" id="5914035">si</span><span class="op" id="5914037">,</span>&nbsp;<span class="ident" id="5914039">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5914045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5914048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914051">s</span><span class="op" id="5914052">.</span><span class="ident" id="5914053">mu</span><span class="op" id="5914055">.</span><span class="ident" id="5914056">Unlock</span><span class="op" id="5914062">(</span><span class="op" id="5914063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5914067">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914132">dc</span><span class="op" id="5914134">.</span><span class="ident" id="5914135">Lock</span><span class="op" id="5914139">(</span><span class="op" id="5914140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914143">si</span><span class="op" id="5914145">,</span>&nbsp;<span class="ident" id="5914147">err</span>&nbsp;<span class="op" id="5914151">=</span>&nbsp;<span class="ident" id="5914153">dc</span><span class="op" id="5914155">.</span><span class="ident" id="5914156">prepareLocked</span><span class="op" id="5914169">(</span><span class="ident" id="5914170">s</span><span class="op" id="5914171">.</span><span class="ident" id="5914172">query</span><span class="op" id="5914177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914180">dc</span><span class="op" id="5914182">.</span><span class="ident" id="5914183">Unlock</span><span class="op" id="5914189">(</span><span class="op" id="5914190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5914193">if</span>&nbsp;<span class="ident" id="5914196">err</span>&nbsp;<span class="op" id="5914200">!=</span>&nbsp;<span class="ident" id="5914203">nil</span>&nbsp;<span class="op" id="5914207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914211">s</span><span class="op" id="5914212">.</span><span class="ident" id="5914213">db</span><span class="op" id="5914215">.</span><span class="ident" id="5914216">putConn</span><span class="op" id="5914223">(</span><span class="ident" id="5914224">dc</span><span class="op" id="5914226">,</span>&nbsp;<span class="ident" id="5914228">err</span><span class="op" id="5914231">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5914235">return</span>&nbsp;<span class="ident" id="5914242">nil</span><span class="op" id="5914245">,</span>&nbsp;<span class="ident" id="5914247">nil</span><span class="op" id="5914250">,</span>&nbsp;<span class="ident" id="5914252">nil</span><span class="op" id="5914255">,</span>&nbsp;<span class="ident" id="5914257">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5914262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914265">s</span><span class="op" id="5914266">.</span><span class="ident" id="5914267">mu</span><span class="op" id="5914269">.</span><span class="ident" id="5914270">Lock</span><span class="op" id="5914274">(</span><span class="op" id="5914275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914278">cs</span>&nbsp;<span class="op" id="5914281">:=</span>&nbsp;<span class="ident" id="5914284">connStmt</span><span class="op" id="5914292">{</span><span class="ident" id="5914293">dc</span><span class="op" id="5914295">,</span>&nbsp;<span class="ident" id="5914297">si</span><span class="op" id="5914299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914302">s</span><span class="op" id="5914303">.</span><span class="ident" id="5914304">css</span>&nbsp;<span class="op" id="5914308">=</span>&nbsp;<span class="builtinfunc" id="5914310">append</span><span class="op" id="5914316">(</span><span class="ident" id="5914317">s</span><span class="op" id="5914318">.</span><span class="ident" id="5914319">css</span><span class="op" id="5914322">,</span>&nbsp;<span class="ident" id="5914324">cs</span><span class="op" id="5914326">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914329">s</span><span class="op" id="5914330">.</span><span class="ident" id="5914331">mu</span><span class="op" id="5914333">.</span><span class="ident" id="5914334">Unlock</span><span class="op" id="5914340">(</span><span class="op" id="5914341">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5914345">return</span>&nbsp;<span class="ident" id="5914352">dc</span><span class="op" id="5914354">,</span>&nbsp;<span class="ident" id="5914356">dc</span><span class="op" id="5914358">.</span><span class="ident" id="5914359">releaseConn</span><span class="op" id="5914370">,</span>&nbsp;<span class="ident" id="5914372">si</span><span class="op" id="5914374">,</span>&nbsp;<span class="ident" id="5914376">nil</span><br>
<span class="lineno"></span><span class="op" id="5914380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="5914383">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="5914453">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="5914498">func</span>&nbsp;<span class="op" id="5914503">(</span><span class="ident" id="5914504">s</span>&nbsp;<span class="op" id="5914506">*</span><span class="ident" id="5914507">Stmt</span><span class="op" id="5914511">)</span>&nbsp;<span class="ident" id="5914513">Query</span><span class="op" id="5914518">(</span><span class="ident" id="5914519">args</span>&nbsp;<span class="op" id="5914524">...</span><span class="keyword" id="5914527">interface</span><span class="op" id="5914536">{</span><span class="op" id="5914537">}</span><span class="op" id="5914538">)</span>&nbsp;<span class="op" id="5914540">(</span><span class="op" id="5914541">*</span><span class="ident" id="5914542">Rows</span><span class="op" id="5914546">,</span>&nbsp;<span class="builtintype" id="5914548">error</span><span class="op" id="5914553">)</span>&nbsp;<span class="op" id="5914555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914558">s</span><span class="op" id="5914559">.</span><span class="ident" id="5914560">closemu</span><span class="op" id="5914567">.</span><span class="ident" id="5914568">RLock</span><span class="op" id="5914573">(</span><span class="op" id="5914574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5914577">defer</span>&nbsp;<span class="ident" id="5914583">s</span><span class="op" id="5914584">.</span><span class="ident" id="5914585">closemu</span><span class="op" id="5914592">.</span><span class="ident" id="5914593">RUnlock</span><span class="op" id="5914600">(</span><span class="op" id="5914601">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5914605">var</span>&nbsp;<span class="ident" id="5914609">rowsi</span>&nbsp;<span class="ident" id="5914615">driver</span><span class="op" id="5914621">.</span><span class="ident" id="5914622">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5914628">for</span>&nbsp;<span class="ident" id="5914632">i</span>&nbsp;<span class="op" id="5914634">:=</span>&nbsp;<span class="num" id="5914637">0</span><span class="op" id="5914638">;</span>&nbsp;<span class="ident" id="5914640">i</span>&nbsp;<span class="op" id="5914642">&lt;</span>&nbsp;<span class="ident" id="5914644">maxBadConnRetries</span><span class="op" id="5914661">;</span>&nbsp;<span class="ident" id="5914663">i</span><span class="op" id="5914664">++</span>&nbsp;<span class="op" id="5914667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914671">dc</span><span class="op" id="5914673">,</span>&nbsp;<span class="ident" id="5914675">releaseConn</span><span class="op" id="5914686">,</span>&nbsp;<span class="ident" id="5914688">si</span><span class="op" id="5914690">,</span>&nbsp;<span class="ident" id="5914692">err</span>&nbsp;<span class="op" id="5914696">:=</span>&nbsp;<span class="ident" id="5914699">s</span><span class="op" id="5914700">.</span><span class="ident" id="5914701">connStmt</span><span class="op" id="5914709">(</span><span class="op" id="5914710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5914714">if</span>&nbsp;<span class="ident" id="5914717">err</span>&nbsp;<span class="op" id="5914721">!=</span>&nbsp;<span class="ident" id="5914724">nil</span>&nbsp;<span class="op" id="5914728">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5914733">if</span>&nbsp;<span class="ident" id="5914736">err</span>&nbsp;<span class="op" id="5914740">==</span>&nbsp;<span class="ident" id="5914743">driver</span><span class="op" id="5914749">.</span><span class="ident" id="5914750">ErrBadConn</span>&nbsp;<span class="op" id="5914761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5914767">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5914779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5914784">return</span>&nbsp;<span class="ident" id="5914791">nil</span><span class="op" id="5914794">,</span>&nbsp;<span class="ident" id="5914796">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5914802">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914807">rowsi</span><span class="op" id="5914812">,</span>&nbsp;<span class="ident" id="5914814">err</span>&nbsp;<span class="op" id="5914818">=</span>&nbsp;<span class="ident" id="5914820">rowsiFromStatement</span><span class="op" id="5914838">(</span><span class="ident" id="5914839">driverStmt</span><span class="op" id="5914849">{</span><span class="ident" id="5914850">dc</span><span class="op" id="5914852">,</span>&nbsp;<span class="ident" id="5914854">si</span><span class="op" id="5914856">}</span><span class="op" id="5914857">,</span>&nbsp;<span class="ident" id="5914859">args</span><span class="op" id="5914863">...</span><span class="op" id="5914866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5914870">if</span>&nbsp;<span class="ident" id="5914873">err</span>&nbsp;<span class="op" id="5914877">==</span>&nbsp;<span class="ident" id="5914880">nil</span>&nbsp;<span class="op" id="5914884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5914889">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5914950">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914974">rows</span>&nbsp;<span class="op" id="5914979">:=</span>&nbsp;<span class="op" id="5914982">&amp;</span><span class="ident" id="5914983">Rows</span><span class="op" id="5914987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5914993">dc</span><span class="op" id="5914995">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915000">dc</span><span class="op" id="5915002">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915008">rowsi</span><span class="op" id="5915013">:</span>&nbsp;<span class="ident" id="5915015">rowsi</span><span class="op" id="5915020">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5915026">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5915054">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915059">s</span><span class="op" id="5915060">.</span><span class="ident" id="5915061">db</span><span class="op" id="5915063">.</span><span class="ident" id="5915064">addDep</span><span class="op" id="5915070">(</span><span class="ident" id="5915071">s</span><span class="op" id="5915072">,</span>&nbsp;<span class="ident" id="5915074">rows</span><span class="op" id="5915078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915083">rows</span><span class="op" id="5915087">.</span><span class="ident" id="5915088">releaseConn</span>&nbsp;<span class="op" id="5915100">=</span>&nbsp;<span class="keyword" id="5915102">func</span><span class="op" id="5915106">(</span><span class="ident" id="5915107">err</span>&nbsp;<span class="builtintype" id="5915111">error</span><span class="op" id="5915116">)</span>&nbsp;<span class="op" id="5915118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915124">releaseConn</span><span class="op" id="5915135">(</span><span class="ident" id="5915136">err</span><span class="op" id="5915139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915145">s</span><span class="op" id="5915146">.</span><span class="ident" id="5915147">db</span><span class="op" id="5915149">.</span><span class="ident" id="5915150">removeDep</span><span class="op" id="5915159">(</span><span class="ident" id="5915160">s</span><span class="op" id="5915161">,</span>&nbsp;<span class="ident" id="5915163">rows</span><span class="op" id="5915167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5915172">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5915177">return</span>&nbsp;<span class="ident" id="5915184">rows</span><span class="op" id="5915188">,</span>&nbsp;<span class="ident" id="5915190">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5915196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915201">releaseConn</span><span class="op" id="5915212">(</span><span class="ident" id="5915213">err</span><span class="op" id="5915216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5915220">if</span>&nbsp;<span class="ident" id="5915223">err</span>&nbsp;<span class="op" id="5915227">!=</span>&nbsp;<span class="ident" id="5915230">driver</span><span class="op" id="5915236">.</span><span class="ident" id="5915237">ErrBadConn</span>&nbsp;<span class="op" id="5915248">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5915253">return</span>&nbsp;<span class="ident" id="5915260">nil</span><span class="op" id="5915263">,</span>&nbsp;<span class="ident" id="5915265">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5915271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5915274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5915277">return</span>&nbsp;<span class="ident" id="5915284">nil</span><span class="op" id="5915287">,</span>&nbsp;<span class="ident" id="5915289">driver</span><span class="op" id="5915295">.</span><span class="ident" id="5915296">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="5915307">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="5915310">func</span>&nbsp;<span class="ident" id="5915315">rowsiFromStatement</span><span class="op" id="5915333">(</span><span class="ident" id="5915334">ds</span>&nbsp;<span class="ident" id="5915337">driverStmt</span><span class="op" id="5915347">,</span>&nbsp;<span class="ident" id="5915349">args</span>&nbsp;<span class="op" id="5915354">...</span><span class="keyword" id="5915357">interface</span><span class="op" id="5915366">{</span><span class="op" id="5915367">}</span><span class="op" id="5915368">)</span>&nbsp;<span class="op" id="5915370">(</span><span class="ident" id="5915371">driver</span><span class="op" id="5915377">.</span><span class="ident" id="5915378">Rows</span><span class="op" id="5915382">,</span>&nbsp;<span class="builtintype" id="5915384">error</span><span class="op" id="5915389">)</span>&nbsp;<span class="op" id="5915391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915394">ds</span><span class="op" id="5915396">.</span><span class="ident" id="5915397">Lock</span><span class="op" id="5915401">(</span><span class="op" id="5915402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915405">want</span>&nbsp;<span class="op" id="5915410">:=</span>&nbsp;<span class="ident" id="5915413">ds</span><span class="op" id="5915415">.</span><span class="ident" id="5915416">si</span><span class="op" id="5915418">.</span><span class="ident" id="5915419">NumInput</span><span class="op" id="5915427">(</span><span class="op" id="5915428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915431">ds</span><span class="op" id="5915433">.</span><span class="ident" id="5915434">Unlock</span><span class="op" id="5915440">(</span><span class="op" id="5915441">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5915445">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5915509">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5915583">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5915612">if</span>&nbsp;<span class="ident" id="5915615">want</span>&nbsp;<span class="op" id="5915620">!=</span>&nbsp;<span class="op" id="5915623">-</span><span class="num" id="5915624">1</span>&nbsp;<span class="op" id="5915626">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5915629">len</span><span class="op" id="5915632">(</span><span class="ident" id="5915633">args</span><span class="op" id="5915637">)</span>&nbsp;<span class="op" id="5915639">!=</span>&nbsp;<span class="ident" id="5915642">want</span>&nbsp;<span class="op" id="5915647">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5915651">return</span>&nbsp;<span class="ident" id="5915658">nil</span><span class="op" id="5915661">,</span>&nbsp;<span class="ident" id="5915663">fmt</span><span class="op" id="5915666">.</span><span class="ident" id="5915667">Errorf</span><span class="op" id="5915673">(</span><span class="string" id="5915674">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="5915716">,</span>&nbsp;<span class="ident" id="5915718">want</span><span class="op" id="5915722">,</span>&nbsp;<span class="builtinfunc" id="5915724">len</span><span class="op" id="5915727">(</span><span class="ident" id="5915728">args</span><span class="op" id="5915732">)</span><span class="op" id="5915733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5915736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915740">dargs</span><span class="op" id="5915745">,</span>&nbsp;<span class="ident" id="5915747">err</span>&nbsp;<span class="op" id="5915751">:=</span>&nbsp;<span class="ident" id="5915754">driverArgs</span><span class="op" id="5915764">(</span><span class="op" id="5915765">&amp;</span><span class="ident" id="5915766">ds</span><span class="op" id="5915768">,</span>&nbsp;<span class="ident" id="5915770">args</span><span class="op" id="5915774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5915777">if</span>&nbsp;<span class="ident" id="5915780">err</span>&nbsp;<span class="op" id="5915784">!=</span>&nbsp;<span class="ident" id="5915787">nil</span>&nbsp;<span class="op" id="5915791">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5915795">return</span>&nbsp;<span class="ident" id="5915802">nil</span><span class="op" id="5915805">,</span>&nbsp;<span class="ident" id="5915807">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5915812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915816">ds</span><span class="op" id="5915818">.</span><span class="ident" id="5915819">Lock</span><span class="op" id="5915823">(</span><span class="op" id="5915824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915827">rowsi</span><span class="op" id="5915832">,</span>&nbsp;<span class="ident" id="5915834">err</span>&nbsp;<span class="op" id="5915838">:=</span>&nbsp;<span class="ident" id="5915841">ds</span><span class="op" id="5915843">.</span><span class="ident" id="5915844">si</span><span class="op" id="5915846">.</span><span class="ident" id="5915847">Query</span><span class="op" id="5915852">(</span><span class="ident" id="5915853">dargs</span><span class="op" id="5915858">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5915861">ds</span><span class="op" id="5915863">.</span><span class="ident" id="5915864">Unlock</span><span class="op" id="5915870">(</span><span class="op" id="5915871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5915874">if</span>&nbsp;<span class="ident" id="5915877">err</span>&nbsp;<span class="op" id="5915881">!=</span>&nbsp;<span class="ident" id="5915884">nil</span>&nbsp;<span class="op" id="5915888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5915892">return</span>&nbsp;<span class="ident" id="5915899">nil</span><span class="op" id="5915902">,</span>&nbsp;<span class="ident" id="5915904">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5915909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5915912">return</span>&nbsp;<span class="ident" id="5915919">rowsi</span><span class="op" id="5915924">,</span>&nbsp;<span class="ident" id="5915926">nil</span><br>
<span class="lineno">1495</span><span class="op" id="5915930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5915933">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="5916007">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="5916084">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="5916164">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="5916236">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="5916308">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="5916321">//</span><br>
<span class="lineno"></span><span class="comment" id="5916324">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="5916342">//</span><br>
<span class="lineno"></span><span class="comment" id="5916345">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5916365">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="5916418">func</span>&nbsp;<span class="op" id="5916423">(</span><span class="ident" id="5916424">s</span>&nbsp;<span class="op" id="5916426">*</span><span class="ident" id="5916427">Stmt</span><span class="op" id="5916431">)</span>&nbsp;<span class="ident" id="5916433">QueryRow</span><span class="op" id="5916441">(</span><span class="ident" id="5916442">args</span>&nbsp;<span class="op" id="5916447">...</span><span class="keyword" id="5916450">interface</span><span class="op" id="5916459">{</span><span class="op" id="5916460">}</span><span class="op" id="5916461">)</span>&nbsp;<span class="op" id="5916463">*</span><span class="ident" id="5916464">Row</span>&nbsp;<span class="op" id="5916468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5916471">rows</span><span class="op" id="5916475">,</span>&nbsp;<span class="ident" id="5916477">err</span>&nbsp;<span class="op" id="5916481">:=</span>&nbsp;<span class="ident" id="5916484">s</span><span class="op" id="5916485">.</span><span class="ident" id="5916486">Query</span><span class="op" id="5916491">(</span><span class="ident" id="5916492">args</span><span class="op" id="5916496">...</span><span class="op" id="5916499">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916502">if</span>&nbsp;<span class="ident" id="5916505">err</span>&nbsp;<span class="op" id="5916509">!=</span>&nbsp;<span class="ident" id="5916512">nil</span>&nbsp;<span class="op" id="5916516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916520">return</span>&nbsp;<span class="op" id="5916527">&amp;</span><span class="ident" id="5916528">Row</span><span class="op" id="5916531">{</span><span class="ident" id="5916532">err</span><span class="op" id="5916535">:</span>&nbsp;<span class="ident" id="5916537">err</span><span class="op" id="5916540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5916543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916546">return</span>&nbsp;<span class="op" id="5916553">&amp;</span><span class="ident" id="5916554">Row</span><span class="op" id="5916557">{</span><span class="ident" id="5916558">rows</span><span class="op" id="5916562">:</span>&nbsp;<span class="ident" id="5916564">rows</span><span class="op" id="5916568">}</span><br>
<span class="lineno"></span><span class="op" id="5916570">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="5916573">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5916604">func</span>&nbsp;<span class="op" id="5916609">(</span><span class="ident" id="5916610">s</span>&nbsp;<span class="op" id="5916612">*</span><span class="ident" id="5916613">Stmt</span><span class="op" id="5916617">)</span>&nbsp;<span class="ident" id="5916619">Close</span><span class="op" id="5916624">(</span><span class="op" id="5916625">)</span>&nbsp;<span class="builtintype" id="5916627">error</span>&nbsp;<span class="op" id="5916633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5916636">s</span><span class="op" id="5916637">.</span><span class="ident" id="5916638">closemu</span><span class="op" id="5916645">.</span><span class="ident" id="5916646">Lock</span><span class="op" id="5916650">(</span><span class="op" id="5916651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916654">defer</span>&nbsp;<span class="ident" id="5916660">s</span><span class="op" id="5916661">.</span><span class="ident" id="5916662">closemu</span><span class="op" id="5916669">.</span><span class="ident" id="5916670">Unlock</span><span class="op" id="5916676">(</span><span class="op" id="5916677">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916681">if</span>&nbsp;<span class="ident" id="5916684">s</span><span class="op" id="5916685">.</span><span class="ident" id="5916686">stickyErr</span>&nbsp;<span class="op" id="5916696">!=</span>&nbsp;<span class="ident" id="5916699">nil</span>&nbsp;<span class="op" id="5916703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916707">return</span>&nbsp;<span class="ident" id="5916714">s</span><span class="op" id="5916715">.</span><span class="ident" id="5916716">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5916727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5916730">s</span><span class="op" id="5916731">.</span><span class="ident" id="5916732">mu</span><span class="op" id="5916734">.</span><span class="ident" id="5916735">Lock</span><span class="op" id="5916739">(</span><span class="op" id="5916740">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916743">if</span>&nbsp;<span class="ident" id="5916746">s</span><span class="op" id="5916747">.</span><span class="ident" id="5916748">closed</span>&nbsp;<span class="op" id="5916755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5916759">s</span><span class="op" id="5916760">.</span><span class="ident" id="5916761">mu</span><span class="op" id="5916763">.</span><span class="ident" id="5916764">Unlock</span><span class="op" id="5916770">(</span><span class="op" id="5916771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916775">return</span>&nbsp;<span class="ident" id="5916782">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5916787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5916790">s</span><span class="op" id="5916791">.</span><span class="ident" id="5916792">closed</span>&nbsp;<span class="op" id="5916799">=</span>&nbsp;<span class="ident" id="5916801">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916808">if</span>&nbsp;<span class="ident" id="5916811">s</span><span class="op" id="5916812">.</span><span class="ident" id="5916813">tx</span>&nbsp;<span class="op" id="5916816">!=</span>&nbsp;<span class="ident" id="5916819">nil</span>&nbsp;<span class="op" id="5916823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5916827">s</span><span class="op" id="5916828">.</span><span class="ident" id="5916829">txsi</span><span class="op" id="5916833">.</span><span class="ident" id="5916834">Close</span><span class="op" id="5916839">(</span><span class="op" id="5916840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5916844">s</span><span class="op" id="5916845">.</span><span class="ident" id="5916846">mu</span><span class="op" id="5916848">.</span><span class="ident" id="5916849">Unlock</span><span class="op" id="5916855">(</span><span class="op" id="5916856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916860">return</span>&nbsp;<span class="ident" id="5916867">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5916872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5916875">s</span><span class="op" id="5916876">.</span><span class="ident" id="5916877">mu</span><span class="op" id="5916879">.</span><span class="ident" id="5916880">Unlock</span><span class="op" id="5916886">(</span><span class="op" id="5916887">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916891">return</span>&nbsp;<span class="ident" id="5916898">s</span><span class="op" id="5916899">.</span><span class="ident" id="5916900">db</span><span class="op" id="5916902">.</span><span class="ident" id="5916903">removeDep</span><span class="op" id="5916912">(</span><span class="ident" id="5916913">s</span><span class="op" id="5916914">,</span>&nbsp;<span class="ident" id="5916916">s</span><span class="op" id="5916917">)</span><br>
<span class="lineno"></span><span class="op" id="5916919">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="5916922">func</span>&nbsp;<span class="op" id="5916927">(</span><span class="ident" id="5916928">s</span>&nbsp;<span class="op" id="5916930">*</span><span class="ident" id="5916931">Stmt</span><span class="op" id="5916935">)</span>&nbsp;<span class="ident" id="5916937">finalClose</span><span class="op" id="5916947">(</span><span class="op" id="5916948">)</span>&nbsp;<span class="builtintype" id="5916950">error</span>&nbsp;<span class="op" id="5916956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5916959">s</span><span class="op" id="5916960">.</span><span class="ident" id="5916961">mu</span><span class="op" id="5916963">.</span><span class="ident" id="5916964">Lock</span><span class="op" id="5916968">(</span><span class="op" id="5916969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916972">defer</span>&nbsp;<span class="ident" id="5916978">s</span><span class="op" id="5916979">.</span><span class="ident" id="5916980">mu</span><span class="op" id="5916982">.</span><span class="ident" id="5916983">Unlock</span><span class="op" id="5916989">(</span><span class="op" id="5916990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5916993">if</span>&nbsp;<span class="ident" id="5916996">s</span><span class="op" id="5916997">.</span><span class="ident" id="5916998">css</span>&nbsp;<span class="op" id="5917002">!=</span>&nbsp;<span class="ident" id="5917005">nil</span>&nbsp;<span class="op" id="5917009">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5917013">for</span>&nbsp;<span class="ident" id="5917017">_</span><span class="op" id="5917018">,</span>&nbsp;<span class="ident" id="5917020">v</span>&nbsp;<span class="op" id="5917022">:=</span>&nbsp;<span class="keyword" id="5917025">range</span>&nbsp;<span class="ident" id="5917031">s</span><span class="op" id="5917032">.</span><span class="ident" id="5917033">css</span>&nbsp;<span class="op" id="5917037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5917042">s</span><span class="op" id="5917043">.</span><span class="ident" id="5917044">db</span><span class="op" id="5917046">.</span><span class="ident" id="5917047">noteUnusedDriverStatement</span><span class="op" id="5917072">(</span><span class="ident" id="5917073">v</span><span class="op" id="5917074">.</span><span class="ident" id="5917075">dc</span><span class="op" id="5917077">,</span>&nbsp;<span class="ident" id="5917079">v</span><span class="op" id="5917080">.</span><span class="ident" id="5917081">si</span><span class="op" id="5917083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5917088">v</span><span class="op" id="5917089">.</span><span class="ident" id="5917090">dc</span><span class="op" id="5917092">.</span><span class="ident" id="5917093">removeOpenStmt</span><span class="op" id="5917107">(</span><span class="ident" id="5917108">v</span><span class="op" id="5917109">.</span><span class="ident" id="5917110">si</span><span class="op" id="5917112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5917116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5917120">s</span><span class="op" id="5917121">.</span><span class="ident" id="5917122">css</span>&nbsp;<span class="op" id="5917126">=</span>&nbsp;<span class="ident" id="5917128">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5917133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5917136">return</span>&nbsp;<span class="ident" id="5917143">nil</span><br>
<span class="lineno"></span><span class="op" id="5917147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5917150">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="5917223">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="5917283">//</span><br>
<span class="lineno"></span><span class="comment" id="5917286">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5917329">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5917340">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="5917366">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5917391">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="5917413">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5917440">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="5917479">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="5917494">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5917503">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="5917573">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="5917584">type</span>&nbsp;<span class="ident" id="5917589">Rows</span>&nbsp;<span class="keyword" id="5917594">struct</span>&nbsp;<span class="op" id="5917601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5917604">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5917616">*</span><span class="ident" id="5917617">driverConn</span>&nbsp;<span class="comment" id="5917628">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5917684">releaseConn</span>&nbsp;<span class="keyword" id="5917696">func</span><span class="op" id="5917700">(</span><span class="builtintype" id="5917701">error</span><span class="op" id="5917706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5917709">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917721">driver</span><span class="op" id="5917727">.</span><span class="ident" id="5917728">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5917735">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5917745">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5917751">lastcols</span>&nbsp;&nbsp;<span class="op" id="5917761">[</span><span class="op" id="5917762">]</span><span class="ident" id="5917763">driver</span><span class="op" id="5917769">.</span><span class="ident" id="5917770">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5917777">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5917787">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5917799">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5917834">closeStmt</span>&nbsp;<span class="ident" id="5917844">driver</span><span class="op" id="5917850">.</span><span class="ident" id="5917851">Stmt</span>&nbsp;<span class="comment" id="5917856">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="5917899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5917902">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="5917977">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5918057">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="5918137">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="5918155">//</span><br>
<span class="lineno"></span><span class="comment" id="5918158">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="5918237">func</span>&nbsp;<span class="op" id="5918242">(</span><span class="ident" id="5918243">rs</span>&nbsp;<span class="op" id="5918246">*</span><span class="ident" id="5918247">Rows</span><span class="op" id="5918251">)</span>&nbsp;<span class="ident" id="5918253">Next</span><span class="op" id="5918257">(</span><span class="op" id="5918258">)</span>&nbsp;<span class="builtintype" id="5918260">bool</span>&nbsp;<span class="op" id="5918265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5918268">if</span>&nbsp;<span class="ident" id="5918271">rs</span><span class="op" id="5918273">.</span><span class="ident" id="5918274">closed</span>&nbsp;<span class="op" id="5918281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5918285">return</span>&nbsp;<span class="ident" id="5918292">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5918299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5918302">if</span>&nbsp;<span class="ident" id="5918305">rs</span><span class="op" id="5918307">.</span><span class="ident" id="5918308">lastcols</span>&nbsp;<span class="op" id="5918317">==</span>&nbsp;<span class="ident" id="5918320">nil</span>&nbsp;<span class="op" id="5918324">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5918328">rs</span><span class="op" id="5918330">.</span><span class="ident" id="5918331">lastcols</span>&nbsp;<span class="op" id="5918340">=</span>&nbsp;<span class="builtinfunc" id="5918342">make</span><span class="op" id="5918346">(</span><span class="op" id="5918347">[</span><span class="op" id="5918348">]</span><span class="ident" id="5918349">driver</span><span class="op" id="5918355">.</span><span class="ident" id="5918356">Value</span><span class="op" id="5918361">,</span>&nbsp;<span class="builtinfunc" id="5918363">len</span><span class="op" id="5918366">(</span><span class="ident" id="5918367">rs</span><span class="op" id="5918369">.</span><span class="ident" id="5918370">rowsi</span><span class="op" id="5918375">.</span><span class="ident" id="5918376">Columns</span><span class="op" id="5918383">(</span><span class="op" id="5918384">)</span><span class="op" id="5918385">)</span><span class="op" id="5918386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5918389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5918392">rs</span><span class="op" id="5918394">.</span><span class="ident" id="5918395">lasterr</span>&nbsp;<span class="op" id="5918403">=</span>&nbsp;<span class="ident" id="5918405">rs</span><span class="op" id="5918407">.</span><span class="ident" id="5918408">rowsi</span><span class="op" id="5918413">.</span><span class="ident" id="5918414">Next</span><span class="op" id="5918418">(</span><span class="ident" id="5918419">rs</span><span class="op" id="5918421">.</span><span class="ident" id="5918422">lastcols</span><span class="op" id="5918430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5918433">if</span>&nbsp;<span class="ident" id="5918436">rs</span><span class="op" id="5918438">.</span><span class="ident" id="5918439">lasterr</span>&nbsp;<span class="op" id="5918447">!=</span>&nbsp;<span class="ident" id="5918450">nil</span>&nbsp;<span class="op" id="5918454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5918458">rs</span><span class="op" id="5918460">.</span><span class="ident" id="5918461">Close</span><span class="op" id="5918466">(</span><span class="op" id="5918467">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5918471">return</span>&nbsp;<span class="ident" id="5918478">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5918485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5918488">return</span>&nbsp;<span class="ident" id="5918495">true</span><br>
<span class="lineno"></span><span class="op" id="5918500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="5918503">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="5918576">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5918634">func</span>&nbsp;<span class="op" id="5918639">(</span><span class="ident" id="5918640">rs</span>&nbsp;<span class="op" id="5918643">*</span><span class="ident" id="5918644">Rows</span><span class="op" id="5918648">)</span>&nbsp;<span class="ident" id="5918650">Err</span><span class="op" id="5918653">(</span><span class="op" id="5918654">)</span>&nbsp;<span class="builtintype" id="5918656">error</span>&nbsp;<span class="op" id="5918662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5918665">if</span>&nbsp;<span class="ident" id="5918668">rs</span><span class="op" id="5918670">.</span><span class="ident" id="5918671">lasterr</span>&nbsp;<span class="op" id="5918679">==</span>&nbsp;<span class="ident" id="5918682">io</span><span class="op" id="5918684">.</span><span class="ident" id="5918685">EOF</span>&nbsp;<span class="op" id="5918689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5918693">return</span>&nbsp;<span class="ident" id="5918700">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5918705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5918708">return</span>&nbsp;<span class="ident" id="5918715">rs</span><span class="op" id="5918717">.</span><span class="ident" id="5918718">lasterr</span><br>
<span class="lineno"></span><span class="op" id="5918726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5918729">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="5918766">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="5918833">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5918886">func</span>&nbsp;<span class="op" id="5918891">(</span><span class="ident" id="5918892">rs</span>&nbsp;<span class="op" id="5918895">*</span><span class="ident" id="5918896">Rows</span><span class="op" id="5918900">)</span>&nbsp;<span class="ident" id="5918902">Columns</span><span class="op" id="5918909">(</span><span class="op" id="5918910">)</span>&nbsp;<span class="op" id="5918912">(</span><span class="op" id="5918913">[</span><span class="op" id="5918914">]</span><span class="builtintype" id="5918915">string</span><span class="op" id="5918921">,</span>&nbsp;<span class="builtintype" id="5918923">error</span><span class="op" id="5918928">)</span>&nbsp;<span class="op" id="5918930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5918933">if</span>&nbsp;<span class="ident" id="5918936">rs</span><span class="op" id="5918938">.</span><span class="ident" id="5918939">closed</span>&nbsp;<span class="op" id="5918946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5918950">return</span>&nbsp;<span class="ident" id="5918957">nil</span><span class="op" id="5918960">,</span>&nbsp;<span class="ident" id="5918962">errors</span><span class="op" id="5918968">.</span><span class="ident" id="5918969">New</span><span class="op" id="5918972">(</span><span class="string" id="5918973">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="5918995">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5918998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5919001">if</span>&nbsp;<span class="ident" id="5919004">rs</span><span class="op" id="5919006">.</span><span class="ident" id="5919007">rowsi</span>&nbsp;<span class="op" id="5919013">==</span>&nbsp;<span class="ident" id="5919016">nil</span>&nbsp;<span class="op" id="5919020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5919024">return</span>&nbsp;<span class="ident" id="5919031">nil</span><span class="op" id="5919034">,</span>&nbsp;<span class="ident" id="5919036">errors</span><span class="op" id="5919042">.</span><span class="ident" id="5919043">New</span><span class="op" id="5919046">(</span><span class="string" id="5919047">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="5919071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5919074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5919077">return</span>&nbsp;<span class="ident" id="5919084">rs</span><span class="op" id="5919086">.</span><span class="ident" id="5919087">rowsi</span><span class="op" id="5919092">.</span><span class="ident" id="5919093">Columns</span><span class="op" id="5919100">(</span><span class="op" id="5919101">)</span><span class="op" id="5919102">,</span>&nbsp;<span class="ident" id="5919104">nil</span><br>
<span class="lineno">1620</span><span class="op" id="5919108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5919111">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="5919181">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="5919196">//</span><br>
<span class="lineno">1625</span><span class="comment" id="5919199">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="5919270">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="5919340">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="5919411">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5919479">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="5919520">//</span><br>
<span class="lineno"></span><span class="comment" id="5919523">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5919586">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5919656">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="5919725">func</span>&nbsp;<span class="op" id="5919730">(</span><span class="ident" id="5919731">rs</span>&nbsp;<span class="op" id="5919734">*</span><span class="ident" id="5919735">Rows</span><span class="op" id="5919739">)</span>&nbsp;<span class="ident" id="5919741">Scan</span><span class="op" id="5919745">(</span><span class="ident" id="5919746">dest</span>&nbsp;<span class="op" id="5919751">...</span><span class="keyword" id="5919754">interface</span><span class="op" id="5919763">{</span><span class="op" id="5919764">}</span><span class="op" id="5919765">)</span>&nbsp;<span class="builtintype" id="5919767">error</span>&nbsp;<span class="op" id="5919773">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5919776">if</span>&nbsp;<span class="ident" id="5919779">rs</span><span class="op" id="5919781">.</span><span class="ident" id="5919782">closed</span>&nbsp;<span class="op" id="5919789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5919793">return</span>&nbsp;<span class="ident" id="5919800">errors</span><span class="op" id="5919806">.</span><span class="ident" id="5919807">New</span><span class="op" id="5919810">(</span><span class="string" id="5919811">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="5919833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5919836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5919839">if</span>&nbsp;<span class="ident" id="5919842">rs</span><span class="op" id="5919844">.</span><span class="ident" id="5919845">lastcols</span>&nbsp;<span class="op" id="5919854">==</span>&nbsp;<span class="ident" id="5919857">nil</span>&nbsp;<span class="op" id="5919861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5919865">return</span>&nbsp;<span class="ident" id="5919872">errors</span><span class="op" id="5919878">.</span><span class="ident" id="5919879">New</span><span class="op" id="5919882">(</span><span class="string" id="5919883">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="5919922">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5919925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5919928">if</span>&nbsp;<span class="builtinfunc" id="5919931">len</span><span class="op" id="5919934">(</span><span class="ident" id="5919935">dest</span><span class="op" id="5919939">)</span>&nbsp;<span class="op" id="5919941">!=</span>&nbsp;<span class="builtinfunc" id="5919944">len</span><span class="op" id="5919947">(</span><span class="ident" id="5919948">rs</span><span class="op" id="5919950">.</span><span class="ident" id="5919951">lastcols</span><span class="op" id="5919959">)</span>&nbsp;<span class="op" id="5919961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5919965">return</span>&nbsp;<span class="ident" id="5919972">fmt</span><span class="op" id="5919975">.</span><span class="ident" id="5919976">Errorf</span><span class="op" id="5919982">(</span><span class="string" id="5919983">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="5920039">,</span>&nbsp;<span class="builtinfunc" id="5920041">len</span><span class="op" id="5920044">(</span><span class="ident" id="5920045">rs</span><span class="op" id="5920047">.</span><span class="ident" id="5920048">lastcols</span><span class="op" id="5920056">)</span><span class="op" id="5920057">,</span>&nbsp;<span class="builtinfunc" id="5920059">len</span><span class="op" id="5920062">(</span><span class="ident" id="5920063">dest</span><span class="op" id="5920067">)</span><span class="op" id="5920068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5920071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5920074">for</span>&nbsp;<span class="ident" id="5920078">i</span><span class="op" id="5920079">,</span>&nbsp;<span class="ident" id="5920081">sv</span>&nbsp;<span class="op" id="5920084">:=</span>&nbsp;<span class="keyword" id="5920087">range</span>&nbsp;<span class="ident" id="5920093">rs</span><span class="op" id="5920095">.</span><span class="ident" id="5920096">lastcols</span>&nbsp;<span class="op" id="5920105">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5920109">err</span>&nbsp;<span class="op" id="5920113">:=</span>&nbsp;<span class="ident" id="5920116">convertAssign</span><span class="op" id="5920129">(</span><span class="ident" id="5920130">dest</span><span class="op" id="5920134">[</span><span class="ident" id="5920135">i</span><span class="op" id="5920136">]</span><span class="op" id="5920137">,</span>&nbsp;<span class="ident" id="5920139">sv</span><span class="op" id="5920141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5920145">if</span>&nbsp;<span class="ident" id="5920148">err</span>&nbsp;<span class="op" id="5920152">!=</span>&nbsp;<span class="ident" id="5920155">nil</span>&nbsp;<span class="op" id="5920159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5920164">return</span>&nbsp;<span class="ident" id="5920171">fmt</span><span class="op" id="5920174">.</span><span class="ident" id="5920175">Errorf</span><span class="op" id="5920181">(</span><span class="string" id="5920182">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="5920222">,</span>&nbsp;<span class="ident" id="5920224">i</span><span class="op" id="5920225">,</span>&nbsp;<span class="ident" id="5920227">err</span><span class="op" id="5920230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5920234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5920237">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5920240">return</span>&nbsp;<span class="ident" id="5920247">nil</span><br>
<span class="lineno"></span><span class="op" id="5920251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5920254">var</span>&nbsp;<span class="ident" id="5920258">rowsCloseHook</span>&nbsp;<span class="keyword" id="5920272">func</span><span class="op" id="5920276">(</span><span class="op" id="5920277">*</span><span class="ident" id="5920278">Rows</span><span class="op" id="5920282">,</span>&nbsp;<span class="op" id="5920284">*</span><span class="builtintype" id="5920285">error</span><span class="op" id="5920290">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="5920293">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5920367">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5920444">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="5920521">func</span>&nbsp;<span class="op" id="5920526">(</span><span class="ident" id="5920527">rs</span>&nbsp;<span class="op" id="5920530">*</span><span class="ident" id="5920531">Rows</span><span class="op" id="5920535">)</span>&nbsp;<span class="ident" id="5920537">Close</span><span class="op" id="5920542">(</span><span class="op" id="5920543">)</span>&nbsp;<span class="builtintype" id="5920545">error</span>&nbsp;<span class="op" id="5920551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5920554">if</span>&nbsp;<span class="ident" id="5920557">rs</span><span class="op" id="5920559">.</span><span class="ident" id="5920560">closed</span>&nbsp;<span class="op" id="5920567">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5920571">return</span>&nbsp;<span class="ident" id="5920578">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5920583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5920586">rs</span><span class="op" id="5920588">.</span><span class="ident" id="5920589">closed</span>&nbsp;<span class="op" id="5920596">=</span>&nbsp;<span class="ident" id="5920598">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5920604">err</span>&nbsp;<span class="op" id="5920608">:=</span>&nbsp;<span class="ident" id="5920611">rs</span><span class="op" id="5920613">.</span><span class="ident" id="5920614">rowsi</span><span class="op" id="5920619">.</span><span class="ident" id="5920620">Close</span><span class="op" id="5920625">(</span><span class="op" id="5920626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5920629">if</span>&nbsp;<span class="ident" id="5920632">fn</span>&nbsp;<span class="op" id="5920635">:=</span>&nbsp;<span class="ident" id="5920638">rowsCloseHook</span><span class="op" id="5920651">;</span>&nbsp;<span class="ident" id="5920653">fn</span>&nbsp;<span class="op" id="5920656">!=</span>&nbsp;<span class="ident" id="5920659">nil</span>&nbsp;<span class="op" id="5920663">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5920667">fn</span><span class="op" id="5920669">(</span><span class="ident" id="5920670">rs</span><span class="op" id="5920672">,</span>&nbsp;<span class="op" id="5920674">&amp;</span><span class="ident" id="5920675">err</span><span class="op" id="5920678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5920681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5920684">if</span>&nbsp;<span class="ident" id="5920687">rs</span><span class="op" id="5920689">.</span><span class="ident" id="5920690">closeStmt</span>&nbsp;<span class="op" id="5920700">!=</span>&nbsp;<span class="ident" id="5920703">nil</span>&nbsp;<span class="op" id="5920707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5920711">rs</span><span class="op" id="5920713">.</span><span class="ident" id="5920714">closeStmt</span><span class="op" id="5920723">.</span><span class="ident" id="5920724">Close</span><span class="op" id="5920729">(</span><span class="op" id="5920730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5920733">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5920736">rs</span><span class="op" id="5920738">.</span><span class="ident" id="5920739">releaseConn</span><span class="op" id="5920750">(</span><span class="ident" id="5920751">err</span><span class="op" id="5920754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5920757">return</span>&nbsp;<span class="ident" id="5920764">err</span><br>
<span class="lineno"></span><span class="op" id="5920768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5920771">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="5920836">type</span>&nbsp;<span class="ident" id="5920841">Row</span>&nbsp;<span class="keyword" id="5920845">struct</span>&nbsp;<span class="op" id="5920852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5920855">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5920893">err</span>&nbsp;&nbsp;<span class="builtintype" id="5920898">error</span>&nbsp;<span class="comment" id="5920904">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5920941">rows</span>&nbsp;<span class="op" id="5920946">*</span><span class="ident" id="5920947">Rows</span><br>
<span class="lineno"></span><span class="op" id="5920952">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="5920955">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="5921019">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="5921083">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="5921152">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="5921190">func</span>&nbsp;<span class="op" id="5921195">(</span><span class="ident" id="5921196">r</span>&nbsp;<span class="op" id="5921198">*</span><span class="ident" id="5921199">Row</span><span class="op" id="5921202">)</span>&nbsp;<span class="ident" id="5921204">Scan</span><span class="op" id="5921208">(</span><span class="ident" id="5921209">dest</span>&nbsp;<span class="op" id="5921214">...</span><span class="keyword" id="5921217">interface</span><span class="op" id="5921226">{</span><span class="op" id="5921227">}</span><span class="op" id="5921228">)</span>&nbsp;<span class="builtintype" id="5921230">error</span>&nbsp;<span class="op" id="5921236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5921239">if</span>&nbsp;<span class="ident" id="5921242">r</span><span class="op" id="5921243">.</span><span class="ident" id="5921244">err</span>&nbsp;<span class="op" id="5921248">!=</span>&nbsp;<span class="ident" id="5921251">nil</span>&nbsp;<span class="op" id="5921255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5921259">return</span>&nbsp;<span class="ident" id="5921266">r</span><span class="op" id="5921267">.</span><span class="ident" id="5921268">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5921273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5921277">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5921338">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5921390">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5921446">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5921508">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5921572">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5921633">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5921697">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5921758">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5921814">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5921876">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5921937">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5922000">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922016">defer</span>&nbsp;<span class="ident" id="5922022">r</span><span class="op" id="5922023">.</span><span class="ident" id="5922024">rows</span><span class="op" id="5922028">.</span><span class="ident" id="5922029">Close</span><span class="op" id="5922034">(</span><span class="op" id="5922035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922038">for</span>&nbsp;<span class="ident" id="5922042">_</span><span class="op" id="5922043">,</span>&nbsp;<span class="ident" id="5922045">dp</span>&nbsp;<span class="op" id="5922048">:=</span>&nbsp;<span class="keyword" id="5922051">range</span>&nbsp;<span class="ident" id="5922057">dest</span>&nbsp;<span class="op" id="5922062">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922066">if</span>&nbsp;<span class="ident" id="5922069">_</span><span class="op" id="5922070">,</span>&nbsp;<span class="ident" id="5922072">ok</span>&nbsp;<span class="op" id="5922075">:=</span>&nbsp;<span class="ident" id="5922078">dp</span><span class="op" id="5922080">.</span><span class="op" id="5922081">(</span><span class="op" id="5922082">*</span><span class="ident" id="5922083">RawBytes</span><span class="op" id="5922091">)</span><span class="op" id="5922092">;</span>&nbsp;<span class="ident" id="5922094">ok</span>&nbsp;<span class="op" id="5922097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922102">return</span>&nbsp;<span class="ident" id="5922109">errors</span><span class="op" id="5922115">.</span><span class="ident" id="5922116">New</span><span class="op" id="5922119">(</span><span class="string" id="5922120">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="5922161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5922165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5922168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922172">if</span>&nbsp;<span class="op" id="5922175">!</span><span class="ident" id="5922176">r</span><span class="op" id="5922177">.</span><span class="ident" id="5922178">rows</span><span class="op" id="5922182">.</span><span class="ident" id="5922183">Next</span><span class="op" id="5922187">(</span><span class="op" id="5922188">)</span>&nbsp;<span class="op" id="5922190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922194">if</span>&nbsp;<span class="ident" id="5922197">err</span>&nbsp;<span class="op" id="5922201">:=</span>&nbsp;<span class="ident" id="5922204">r</span><span class="op" id="5922205">.</span><span class="ident" id="5922206">rows</span><span class="op" id="5922210">.</span><span class="ident" id="5922211">Err</span><span class="op" id="5922214">(</span><span class="op" id="5922215">)</span><span class="op" id="5922216">;</span>&nbsp;<span class="ident" id="5922218">err</span>&nbsp;<span class="op" id="5922222">!=</span>&nbsp;<span class="ident" id="5922225">nil</span>&nbsp;<span class="op" id="5922229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922234">return</span>&nbsp;<span class="ident" id="5922241">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5922247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922251">return</span>&nbsp;<span class="ident" id="5922258">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5922269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5922272">err</span>&nbsp;<span class="op" id="5922276">:=</span>&nbsp;<span class="ident" id="5922279">r</span><span class="op" id="5922280">.</span><span class="ident" id="5922281">rows</span><span class="op" id="5922285">.</span><span class="ident" id="5922286">Scan</span><span class="op" id="5922290">(</span><span class="ident" id="5922291">dest</span><span class="op" id="5922295">...</span><span class="op" id="5922298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922301">if</span>&nbsp;<span class="ident" id="5922304">err</span>&nbsp;<span class="op" id="5922308">!=</span>&nbsp;<span class="ident" id="5922311">nil</span>&nbsp;<span class="op" id="5922315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922319">return</span>&nbsp;<span class="ident" id="5922326">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5922331">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5922334">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922405">if</span>&nbsp;<span class="ident" id="5922408">err</span>&nbsp;<span class="op" id="5922412">:=</span>&nbsp;<span class="ident" id="5922415">r</span><span class="op" id="5922416">.</span><span class="ident" id="5922417">rows</span><span class="op" id="5922421">.</span><span class="ident" id="5922422">Close</span><span class="op" id="5922427">(</span><span class="op" id="5922428">)</span><span class="op" id="5922429">;</span>&nbsp;<span class="ident" id="5922431">err</span>&nbsp;<span class="op" id="5922435">!=</span>&nbsp;<span class="ident" id="5922438">nil</span>&nbsp;<span class="op" id="5922442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922446">return</span>&nbsp;<span class="ident" id="5922453">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5922458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5922462">return</span>&nbsp;<span class="ident" id="5922469">nil</span><br>
<span class="lineno"></span><span class="op" id="5922473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5922476">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="5922524">type</span>&nbsp;<span class="ident" id="5922529">Result</span>&nbsp;<span class="keyword" id="5922536">interface</span>&nbsp;<span class="op" id="5922546">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5922549">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5922612">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5922673">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5922735">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5922794">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5922817">LastInsertId</span><span class="op" id="5922829">(</span><span class="op" id="5922830">)</span>&nbsp;<span class="op" id="5922832">(</span><span class="ident" id="5922833">int64</span><span class="op" id="5922838">,</span>&nbsp;<span class="builtintype" id="5922840">error</span><span class="op" id="5922845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5922849">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5922908">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5922970">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5922999">RowsAffected</span><span class="op" id="5923011">(</span><span class="op" id="5923012">)</span>&nbsp;<span class="op" id="5923014">(</span><span class="ident" id="5923015">int64</span><span class="op" id="5923020">,</span>&nbsp;<span class="builtintype" id="5923022">error</span><span class="op" id="5923027">)</span><br>
<span class="lineno"></span><span class="op" id="5923029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5923032">type</span>&nbsp;<span class="ident" id="5923037">driverResult</span>&nbsp;<span class="keyword" id="5923050">struct</span>&nbsp;<span class="op" id="5923057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923060">sync</span><span class="op" id="5923064">.</span><span class="ident" id="5923065">Locker</span>&nbsp;<span class="comment" id="5923072">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923092">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923104">driver</span><span class="op" id="5923110">.</span><span class="ident" id="5923111">Result</span><br>
<span class="lineno"></span><span class="op" id="5923118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5923121">func</span>&nbsp;<span class="op" id="5923126">(</span><span class="ident" id="5923127">dr</span>&nbsp;<span class="ident" id="5923130">driverResult</span><span class="op" id="5923142">)</span>&nbsp;<span class="ident" id="5923144">LastInsertId</span><span class="op" id="5923156">(</span><span class="op" id="5923157">)</span>&nbsp;<span class="op" id="5923159">(</span><span class="ident" id="5923160">int64</span><span class="op" id="5923165">,</span>&nbsp;<span class="builtintype" id="5923167">error</span><span class="op" id="5923172">)</span>&nbsp;<span class="op" id="5923174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923177">dr</span><span class="op" id="5923179">.</span><span class="ident" id="5923180">Lock</span><span class="op" id="5923184">(</span><span class="op" id="5923185">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5923188">defer</span>&nbsp;<span class="ident" id="5923194">dr</span><span class="op" id="5923196">.</span><span class="ident" id="5923197">Unlock</span><span class="op" id="5923203">(</span><span class="op" id="5923204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5923207">return</span>&nbsp;<span class="ident" id="5923214">dr</span><span class="op" id="5923216">.</span><span class="ident" id="5923217">resi</span><span class="op" id="5923221">.</span><span class="ident" id="5923222">LastInsertId</span><span class="op" id="5923234">(</span><span class="op" id="5923235">)</span><br>
<span class="lineno"></span><span class="op" id="5923237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5923240">func</span>&nbsp;<span class="op" id="5923245">(</span><span class="ident" id="5923246">dr</span>&nbsp;<span class="ident" id="5923249">driverResult</span><span class="op" id="5923261">)</span>&nbsp;<span class="ident" id="5923263">RowsAffected</span><span class="op" id="5923275">(</span><span class="op" id="5923276">)</span>&nbsp;<span class="op" id="5923278">(</span><span class="ident" id="5923279">int64</span><span class="op" id="5923284">,</span>&nbsp;<span class="builtintype" id="5923286">error</span><span class="op" id="5923291">)</span>&nbsp;<span class="op" id="5923293">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923296">dr</span><span class="op" id="5923298">.</span><span class="ident" id="5923299">Lock</span><span class="op" id="5923303">(</span><span class="op" id="5923304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5923307">defer</span>&nbsp;<span class="ident" id="5923313">dr</span><span class="op" id="5923315">.</span><span class="ident" id="5923316">Unlock</span><span class="op" id="5923322">(</span><span class="op" id="5923323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5923326">return</span>&nbsp;<span class="ident" id="5923333">dr</span><span class="op" id="5923335">.</span><span class="ident" id="5923336">resi</span><span class="op" id="5923340">.</span><span class="ident" id="5923341">RowsAffected</span><span class="op" id="5923353">(</span><span class="op" id="5923354">)</span><br>
<span class="lineno"></span><span class="op" id="5923356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="5923359">func</span>&nbsp;<span class="ident" id="5923364">stack</span><span class="op" id="5923369">(</span><span class="op" id="5923370">)</span>&nbsp;<span class="builtintype" id="5923372">string</span>&nbsp;<span class="op" id="5923379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5923382">var</span>&nbsp;<span class="ident" id="5923386">buf</span>&nbsp;<span class="op" id="5923390">[</span><span class="num" id="5923391">2</span>&nbsp;<span class="op" id="5923393">&lt;&lt;</span>&nbsp;<span class="num" id="5923396">10</span><span class="op" id="5923398">]</span><span class="builtintype" id="5923399">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5923405">return</span>&nbsp;<span class="builtintype" id="5923412">string</span><span class="op" id="5923418">(</span><span class="ident" id="5923419">buf</span><span class="op" id="5923422">[</span><span class="op" id="5923423">:</span><span class="ident" id="5923424">runtime</span><span class="op" id="5923431">.</span><span class="ident" id="5923432">Stack</span><span class="op" id="5923437">(</span><span class="ident" id="5923438">buf</span><span class="op" id="5923441">[</span><span class="op" id="5923442">:</span><span class="op" id="5923443">]</span><span class="op" id="5923444">,</span>&nbsp;<span class="ident" id="5923446">false</span><span class="op" id="5923451">)</span><span class="op" id="5923452">]</span><span class="op" id="5923453">)</span><br>
<span class="lineno"></span><span class="op" id="5923455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="5923458">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="5923493">func</span>&nbsp;<span class="ident" id="5923498">withLock</span><span class="op" id="5923506">(</span><span class="ident" id="5923507">lk</span>&nbsp;<span class="ident" id="5923510">sync</span><span class="op" id="5923514">.</span><span class="ident" id="5923515">Locker</span><span class="op" id="5923521">,</span>&nbsp;<span class="ident" id="5923523">fn</span>&nbsp;<span class="keyword" id="5923526">func</span><span class="op" id="5923530">(</span><span class="op" id="5923531">)</span><span class="op" id="5923532">)</span>&nbsp;<span class="op" id="5923534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923537">lk</span><span class="op" id="5923539">.</span><span class="ident" id="5923540">Lock</span><span class="op" id="5923544">(</span><span class="op" id="5923545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923548">fn</span><span class="op" id="5923550">(</span><span class="op" id="5923551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923554">lk</span><span class="op" id="5923556">.</span><span class="ident" id="5923557">Unlock</span><span class="op" id="5923563">(</span><span class="op" id="5923564">)</span><br>
<span class="lineno">1770</span><span class="op" id="5923566">}</span>
</div>
</body>
</html>
