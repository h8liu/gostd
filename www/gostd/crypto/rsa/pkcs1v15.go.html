<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4050365">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4050420">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4050474">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4050525">package</span>&nbsp;<span class="ident" id="4050533">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4050538">import</span>&nbsp;<span class="op" id="4050545">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4050548">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4050558">&#34;crypto/subtle&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4050575">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4050585">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4050591">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="4050602">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="4050605">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;encryption&nbsp;and&nbsp;decryption&nbsp;using&nbsp;PKCS#1&nbsp;v1.5&nbsp;padding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4050683">//&nbsp;EncryptPKCS1v15&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4050779">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;minus&nbsp;11&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="4050866">//&nbsp;WARNING:&nbsp;use&nbsp;of&nbsp;this&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;plaintexts&nbsp;other&nbsp;than&nbsp;session&nbsp;keys</span><br>
<span class="lineno">20</span><span class="comment" id="4050945">//&nbsp;is&nbsp;dangerous.&nbsp;Use&nbsp;RSA&nbsp;OAEP&nbsp;in&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><span class="keyword" id="4050993">func</span>&nbsp;<span class="ident" id="4050998">EncryptPKCS1v15</span><span class="op" id="4051013">(</span><span class="ident" id="4051014">rand</span>&nbsp;<span class="ident" id="4051019">io</span><span class="op" id="4051021">.</span><span class="ident" id="4051022">Reader</span><span class="op" id="4051028">,</span>&nbsp;<span class="ident" id="4051030">pub</span>&nbsp;<span class="op" id="4051034">*</span><span class="ident" id="4051035">PublicKey</span><span class="op" id="4051044">,</span>&nbsp;<span class="ident" id="4051046">msg</span>&nbsp;<span class="op" id="4051050">[</span><span class="op" id="4051051">]</span><span class="builtintype" id="4051052">byte</span><span class="op" id="4051056">)</span>&nbsp;<span class="op" id="4051058">(</span><span class="ident" id="4051059">out</span>&nbsp;<span class="op" id="4051063">[</span><span class="op" id="4051064">]</span><span class="builtintype" id="4051065">byte</span><span class="op" id="4051069">,</span>&nbsp;<span class="ident" id="4051071">err</span>&nbsp;<span class="builtintype" id="4051075">error</span><span class="op" id="4051080">)</span>&nbsp;<span class="op" id="4051082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051085">if</span>&nbsp;<span class="ident" id="4051088">err</span>&nbsp;<span class="op" id="4051092">:=</span>&nbsp;<span class="ident" id="4051095">checkPub</span><span class="op" id="4051103">(</span><span class="ident" id="4051104">pub</span><span class="op" id="4051107">)</span><span class="op" id="4051108">;</span>&nbsp;<span class="ident" id="4051110">err</span>&nbsp;<span class="op" id="4051114">!=</span>&nbsp;<span class="ident" id="4051117">nil</span>&nbsp;<span class="op" id="4051121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051125">return</span>&nbsp;<span class="ident" id="4051132">nil</span><span class="op" id="4051135">,</span>&nbsp;<span class="ident" id="4051137">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051142">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051145">k</span>&nbsp;<span class="op" id="4051147">:=</span>&nbsp;<span class="op" id="4051150">(</span><span class="ident" id="4051151">pub</span><span class="op" id="4051154">.</span><span class="ident" id="4051155">N</span><span class="op" id="4051156">.</span><span class="ident" id="4051157">BitLen</span><span class="op" id="4051163">(</span><span class="op" id="4051164">)</span>&nbsp;<span class="op" id="4051166">+</span>&nbsp;<span class="num" id="4051168">7</span><span class="op" id="4051169">)</span>&nbsp;<span class="op" id="4051171">/</span>&nbsp;<span class="num" id="4051173">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051176">if</span>&nbsp;<span class="builtinfunc" id="4051179">len</span><span class="op" id="4051182">(</span><span class="ident" id="4051183">msg</span><span class="op" id="4051186">)</span>&nbsp;<span class="op" id="4051188">&gt;</span>&nbsp;<span class="ident" id="4051190">k</span><span class="op" id="4051191">-</span><span class="num" id="4051192">11</span>&nbsp;<span class="op" id="4051195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051199">err</span>&nbsp;<span class="op" id="4051203">=</span>&nbsp;<span class="ident" id="4051205">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051225">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051233">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4051237">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x02&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051278">em</span>&nbsp;<span class="op" id="4051281">:=</span>&nbsp;<span class="builtinfunc" id="4051284">make</span><span class="op" id="4051288">(</span><span class="op" id="4051289">[</span><span class="op" id="4051290">]</span><span class="builtintype" id="4051291">byte</span><span class="op" id="4051295">,</span>&nbsp;<span class="ident" id="4051297">k</span><span class="op" id="4051298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051301">em</span><span class="op" id="4051303">[</span><span class="num" id="4051304">1</span><span class="op" id="4051305">]</span>&nbsp;<span class="op" id="4051307">=</span>&nbsp;<span class="num" id="4051309">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051312">ps</span><span class="op" id="4051314">,</span>&nbsp;<span class="ident" id="4051316">mm</span>&nbsp;<span class="op" id="4051319">:=</span>&nbsp;<span class="ident" id="4051322">em</span><span class="op" id="4051324">[</span><span class="num" id="4051325">2</span><span class="op" id="4051326">:</span><span class="builtinfunc" id="4051327">len</span><span class="op" id="4051330">(</span><span class="ident" id="4051331">em</span><span class="op" id="4051333">)</span><span class="op" id="4051334">-</span><span class="builtinfunc" id="4051335">len</span><span class="op" id="4051338">(</span><span class="ident" id="4051339">msg</span><span class="op" id="4051342">)</span><span class="op" id="4051343">-</span><span class="num" id="4051344">1</span><span class="op" id="4051345">]</span><span class="op" id="4051346">,</span>&nbsp;<span class="ident" id="4051348">em</span><span class="op" id="4051350">[</span><span class="builtinfunc" id="4051351">len</span><span class="op" id="4051354">(</span><span class="ident" id="4051355">em</span><span class="op" id="4051357">)</span><span class="op" id="4051358">-</span><span class="builtinfunc" id="4051359">len</span><span class="op" id="4051362">(</span><span class="ident" id="4051363">msg</span><span class="op" id="4051366">)</span><span class="op" id="4051367">:</span><span class="op" id="4051368">]</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051371">err</span>&nbsp;<span class="op" id="4051375">=</span>&nbsp;<span class="ident" id="4051377">nonZeroRandomBytes</span><span class="op" id="4051395">(</span><span class="ident" id="4051396">ps</span><span class="op" id="4051398">,</span>&nbsp;<span class="ident" id="4051400">rand</span><span class="op" id="4051404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051407">if</span>&nbsp;<span class="ident" id="4051410">err</span>&nbsp;<span class="op" id="4051414">!=</span>&nbsp;<span class="ident" id="4051417">nil</span>&nbsp;<span class="op" id="4051421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051425">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051436">em</span><span class="op" id="4051438">[</span><span class="builtinfunc" id="4051439">len</span><span class="op" id="4051442">(</span><span class="ident" id="4051443">em</span><span class="op" id="4051445">)</span><span class="op" id="4051446">-</span><span class="builtinfunc" id="4051447">len</span><span class="op" id="4051450">(</span><span class="ident" id="4051451">msg</span><span class="op" id="4051454">)</span><span class="op" id="4051455">-</span><span class="num" id="4051456">1</span><span class="op" id="4051457">]</span>&nbsp;<span class="op" id="4051459">=</span>&nbsp;<span class="num" id="4051461">0</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4051464">copy</span><span class="op" id="4051468">(</span><span class="ident" id="4051469">mm</span><span class="op" id="4051471">,</span>&nbsp;<span class="ident" id="4051473">msg</span><span class="op" id="4051476">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051480">m</span>&nbsp;<span class="op" id="4051482">:=</span>&nbsp;<span class="builtinfunc" id="4051485">new</span><span class="op" id="4051488">(</span><span class="ident" id="4051489">big</span><span class="op" id="4051492">.</span><span class="ident" id="4051493">Int</span><span class="op" id="4051496">)</span><span class="op" id="4051497">.</span><span class="ident" id="4051498">SetBytes</span><span class="op" id="4051506">(</span><span class="ident" id="4051507">em</span><span class="op" id="4051509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051512">c</span>&nbsp;<span class="op" id="4051514">:=</span>&nbsp;<span class="ident" id="4051517">encrypt</span><span class="op" id="4051524">(</span><span class="builtinfunc" id="4051525">new</span><span class="op" id="4051528">(</span><span class="ident" id="4051529">big</span><span class="op" id="4051532">.</span><span class="ident" id="4051533">Int</span><span class="op" id="4051536">)</span><span class="op" id="4051537">,</span>&nbsp;<span class="ident" id="4051539">pub</span><span class="op" id="4051542">,</span>&nbsp;<span class="ident" id="4051544">m</span><span class="op" id="4051545">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051549">copyWithLeftPad</span><span class="op" id="4051564">(</span><span class="ident" id="4051565">em</span><span class="op" id="4051567">,</span>&nbsp;<span class="ident" id="4051569">c</span><span class="op" id="4051570">.</span><span class="ident" id="4051571">Bytes</span><span class="op" id="4051576">(</span><span class="op" id="4051577">)</span><span class="op" id="4051578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051581">out</span>&nbsp;<span class="op" id="4051585">=</span>&nbsp;<span class="ident" id="4051587">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051591">return</span><br>
<span class="lineno"></span><span class="op" id="4051598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4051601">//&nbsp;DecryptPKCS1v15&nbsp;decrypts&nbsp;a&nbsp;plaintext&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4051692">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword" id="4051770">func</span>&nbsp;<span class="ident" id="4051775">DecryptPKCS1v15</span><span class="op" id="4051790">(</span><span class="ident" id="4051791">rand</span>&nbsp;<span class="ident" id="4051796">io</span><span class="op" id="4051798">.</span><span class="ident" id="4051799">Reader</span><span class="op" id="4051805">,</span>&nbsp;<span class="ident" id="4051807">priv</span>&nbsp;<span class="op" id="4051812">*</span><span class="ident" id="4051813">PrivateKey</span><span class="op" id="4051823">,</span>&nbsp;<span class="ident" id="4051825">ciphertext</span>&nbsp;<span class="op" id="4051836">[</span><span class="op" id="4051837">]</span><span class="builtintype" id="4051838">byte</span><span class="op" id="4051842">)</span>&nbsp;<span class="op" id="4051844">(</span><span class="ident" id="4051845">out</span>&nbsp;<span class="op" id="4051849">[</span><span class="op" id="4051850">]</span><span class="builtintype" id="4051851">byte</span><span class="op" id="4051855">,</span>&nbsp;<span class="ident" id="4051857">err</span>&nbsp;<span class="builtintype" id="4051861">error</span><span class="op" id="4051866">)</span>&nbsp;<span class="op" id="4051868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051871">if</span>&nbsp;<span class="ident" id="4051874">err</span>&nbsp;<span class="op" id="4051878">:=</span>&nbsp;<span class="ident" id="4051881">checkPub</span><span class="op" id="4051889">(</span><span class="op" id="4051890">&amp;</span><span class="ident" id="4051891">priv</span><span class="op" id="4051895">.</span><span class="ident" id="4051896">PublicKey</span><span class="op" id="4051905">)</span><span class="op" id="4051906">;</span>&nbsp;<span class="ident" id="4051908">err</span>&nbsp;<span class="op" id="4051912">!=</span>&nbsp;<span class="ident" id="4051915">nil</span>&nbsp;<span class="op" id="4051919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051923">return</span>&nbsp;<span class="ident" id="4051930">nil</span><span class="op" id="4051933">,</span>&nbsp;<span class="ident" id="4051935">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051943">valid</span><span class="op" id="4051948">,</span>&nbsp;<span class="ident" id="4051950">out</span><span class="op" id="4051953">,</span>&nbsp;<span class="ident" id="4051955">index</span><span class="op" id="4051960">,</span>&nbsp;<span class="ident" id="4051962">err</span>&nbsp;<span class="op" id="4051966">:=</span>&nbsp;<span class="ident" id="4051969">decryptPKCS1v15</span><span class="op" id="4051984">(</span><span class="ident" id="4051985">rand</span><span class="op" id="4051989">,</span>&nbsp;<span class="ident" id="4051991">priv</span><span class="op" id="4051995">,</span>&nbsp;<span class="ident" id="4051997">ciphertext</span><span class="op" id="4052007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052010">if</span>&nbsp;<span class="ident" id="4052013">err</span>&nbsp;<span class="op" id="4052017">!=</span>&nbsp;<span class="ident" id="4052020">nil</span>&nbsp;<span class="op" id="4052024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052028">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052036">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052039">if</span>&nbsp;<span class="ident" id="4052042">valid</span>&nbsp;<span class="op" id="4052048">==</span>&nbsp;<span class="num" id="4052051">0</span>&nbsp;<span class="op" id="4052053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052057">return</span>&nbsp;<span class="ident" id="4052064">nil</span><span class="op" id="4052067">,</span>&nbsp;<span class="ident" id="4052069">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052087">out</span>&nbsp;<span class="op" id="4052091">=</span>&nbsp;<span class="ident" id="4052093">out</span><span class="op" id="4052096">[</span><span class="ident" id="4052097">index</span><span class="op" id="4052102">:</span><span class="op" id="4052103">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052106">return</span><br>
<span class="lineno">65</span><span class="op" id="4052113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4052116">//&nbsp;DecryptPKCS1v15SessionKey&nbsp;decrypts&nbsp;a&nbsp;session&nbsp;key&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4052219">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="comment" id="4052297">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;ciphertext&nbsp;is&nbsp;the&nbsp;wrong&nbsp;length&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="4052368">//&nbsp;ciphertext&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;public&nbsp;modulus.&nbsp;Otherwise,&nbsp;no&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4052441">//&nbsp;returned.&nbsp;If&nbsp;the&nbsp;padding&nbsp;is&nbsp;valid,&nbsp;the&nbsp;resulting&nbsp;plaintext&nbsp;message&nbsp;is&nbsp;copied</span><br>
<span class="lineno"></span><span class="comment" id="4052521">//&nbsp;into&nbsp;key.&nbsp;Otherwise,&nbsp;key&nbsp;is&nbsp;unchanged.&nbsp;These&nbsp;alternatives&nbsp;occur&nbsp;in&nbsp;constant</span><br>
<span class="lineno"></span><span class="comment" id="4052600">//&nbsp;time.&nbsp;It&nbsp;is&nbsp;intended&nbsp;that&nbsp;the&nbsp;user&nbsp;of&nbsp;this&nbsp;function&nbsp;generate&nbsp;a&nbsp;random</span><br>
<span class="lineno"></span><span class="comment" id="4052673">//&nbsp;session&nbsp;key&nbsp;beforehand&nbsp;and&nbsp;continue&nbsp;the&nbsp;protocol&nbsp;with&nbsp;the&nbsp;resulting&nbsp;value.</span><br>
<span class="lineno">75</span><span class="comment" id="4052751">//&nbsp;This&nbsp;will&nbsp;remove&nbsp;any&nbsp;possibility&nbsp;that&nbsp;an&nbsp;attacker&nbsp;can&nbsp;learn&nbsp;any&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="4052830">//&nbsp;about&nbsp;the&nbsp;plaintext.</span><br>
<span class="lineno"></span><span class="comment" id="4052854">//&nbsp;See&nbsp;``Chosen&nbsp;Ciphertext&nbsp;Attacks&nbsp;Against&nbsp;Protocols&nbsp;Based&nbsp;on&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span><span class="comment" id="4052924">//&nbsp;Encryption&nbsp;Standard&nbsp;PKCS&nbsp;#1&#39;&#39;,&nbsp;Daniel&nbsp;Bleichenbacher,&nbsp;Advances&nbsp;in&nbsp;Cryptology</span><br>
<span class="lineno"></span><span class="comment" id="4053004">//&nbsp;(Crypto&nbsp;&#39;98).</span><br>
<span class="lineno">80</span><span class="keyword" id="4053021">func</span>&nbsp;<span class="ident" id="4053026">DecryptPKCS1v15SessionKey</span><span class="op" id="4053051">(</span><span class="ident" id="4053052">rand</span>&nbsp;<span class="ident" id="4053057">io</span><span class="op" id="4053059">.</span><span class="ident" id="4053060">Reader</span><span class="op" id="4053066">,</span>&nbsp;<span class="ident" id="4053068">priv</span>&nbsp;<span class="op" id="4053073">*</span><span class="ident" id="4053074">PrivateKey</span><span class="op" id="4053084">,</span>&nbsp;<span class="ident" id="4053086">ciphertext</span>&nbsp;<span class="op" id="4053097">[</span><span class="op" id="4053098">]</span><span class="builtintype" id="4053099">byte</span><span class="op" id="4053103">,</span>&nbsp;<span class="ident" id="4053105">key</span>&nbsp;<span class="op" id="4053109">[</span><span class="op" id="4053110">]</span><span class="builtintype" id="4053111">byte</span><span class="op" id="4053115">)</span>&nbsp;<span class="op" id="4053117">(</span><span class="ident" id="4053118">err</span>&nbsp;<span class="builtintype" id="4053122">error</span><span class="op" id="4053127">)</span>&nbsp;<span class="op" id="4053129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053132">if</span>&nbsp;<span class="ident" id="4053135">err</span>&nbsp;<span class="op" id="4053139">:=</span>&nbsp;<span class="ident" id="4053142">checkPub</span><span class="op" id="4053150">(</span><span class="op" id="4053151">&amp;</span><span class="ident" id="4053152">priv</span><span class="op" id="4053156">.</span><span class="ident" id="4053157">PublicKey</span><span class="op" id="4053166">)</span><span class="op" id="4053167">;</span>&nbsp;<span class="ident" id="4053169">err</span>&nbsp;<span class="op" id="4053173">!=</span>&nbsp;<span class="ident" id="4053176">nil</span>&nbsp;<span class="op" id="4053180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053184">return</span>&nbsp;<span class="ident" id="4053191">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053199">k</span>&nbsp;<span class="op" id="4053201">:=</span>&nbsp;<span class="op" id="4053204">(</span><span class="ident" id="4053205">priv</span><span class="op" id="4053209">.</span><span class="ident" id="4053210">N</span><span class="op" id="4053211">.</span><span class="ident" id="4053212">BitLen</span><span class="op" id="4053218">(</span><span class="op" id="4053219">)</span>&nbsp;<span class="op" id="4053221">+</span>&nbsp;<span class="num" id="4053223">7</span><span class="op" id="4053224">)</span>&nbsp;<span class="op" id="4053226">/</span>&nbsp;<span class="num" id="4053228">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053231">if</span>&nbsp;<span class="ident" id="4053234">k</span><span class="op" id="4053235">-</span><span class="op" id="4053236">(</span><span class="builtinfunc" id="4053237">len</span><span class="op" id="4053240">(</span><span class="ident" id="4053241">key</span><span class="op" id="4053244">)</span><span class="op" id="4053245">+</span><span class="num" id="4053246">3</span><span class="op" id="4053247">+</span><span class="num" id="4053248">8</span><span class="op" id="4053249">)</span>&nbsp;<span class="op" id="4053251">&lt;</span>&nbsp;<span class="num" id="4053253">0</span>&nbsp;<span class="op" id="4053255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053259">return</span>&nbsp;<span class="ident" id="4053266">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053285">valid</span><span class="op" id="4053290">,</span>&nbsp;<span class="ident" id="4053292">em</span><span class="op" id="4053294">,</span>&nbsp;<span class="ident" id="4053296">index</span><span class="op" id="4053301">,</span>&nbsp;<span class="ident" id="4053303">err</span>&nbsp;<span class="op" id="4053307">:=</span>&nbsp;<span class="ident" id="4053310">decryptPKCS1v15</span><span class="op" id="4053325">(</span><span class="ident" id="4053326">rand</span><span class="op" id="4053330">,</span>&nbsp;<span class="ident" id="4053332">priv</span><span class="op" id="4053336">,</span>&nbsp;<span class="ident" id="4053338">ciphertext</span><span class="op" id="4053348">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053351">if</span>&nbsp;<span class="ident" id="4053354">err</span>&nbsp;<span class="op" id="4053358">!=</span>&nbsp;<span class="ident" id="4053361">nil</span>&nbsp;<span class="op" id="4053365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053369">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053381">if</span>&nbsp;<span class="builtinfunc" id="4053384">len</span><span class="op" id="4053387">(</span><span class="ident" id="4053388">em</span><span class="op" id="4053390">)</span>&nbsp;<span class="op" id="4053392">!=</span>&nbsp;<span class="ident" id="4053395">k</span>&nbsp;<span class="op" id="4053397">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4053401">//&nbsp;This&nbsp;should&nbsp;be&nbsp;impossible&nbsp;because&nbsp;decryptPKCS1v15&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4053463">//&nbsp;returns&nbsp;the&nbsp;full&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053492">return</span>&nbsp;<span class="ident" id="4053499">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053518">valid</span>&nbsp;<span class="op" id="4053524">&amp;=</span>&nbsp;<span class="ident" id="4053527">subtle</span><span class="op" id="4053533">.</span><span class="ident" id="4053534">ConstantTimeEq</span><span class="op" id="4053548">(</span><span class="builtintype" id="4053549">int32</span><span class="op" id="4053554">(</span><span class="builtinfunc" id="4053555">len</span><span class="op" id="4053558">(</span><span class="ident" id="4053559">em</span><span class="op" id="4053561">)</span><span class="op" id="4053562">-</span><span class="ident" id="4053563">index</span><span class="op" id="4053568">)</span><span class="op" id="4053569">,</span>&nbsp;<span class="builtintype" id="4053571">int32</span><span class="op" id="4053576">(</span><span class="builtinfunc" id="4053577">len</span><span class="op" id="4053580">(</span><span class="ident" id="4053581">key</span><span class="op" id="4053584">)</span><span class="op" id="4053585">)</span><span class="op" id="4053586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053589">subtle</span><span class="op" id="4053595">.</span><span class="ident" id="4053596">ConstantTimeCopy</span><span class="op" id="4053612">(</span><span class="ident" id="4053613">valid</span><span class="op" id="4053618">,</span>&nbsp;<span class="ident" id="4053620">key</span><span class="op" id="4053623">,</span>&nbsp;<span class="ident" id="4053625">em</span><span class="op" id="4053627">[</span><span class="builtinfunc" id="4053628">len</span><span class="op" id="4053631">(</span><span class="ident" id="4053632">em</span><span class="op" id="4053634">)</span><span class="op" id="4053635">-</span><span class="builtinfunc" id="4053636">len</span><span class="op" id="4053639">(</span><span class="ident" id="4053640">key</span><span class="op" id="4053643">)</span><span class="op" id="4053644">:</span><span class="op" id="4053645">]</span><span class="op" id="4053646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053649">return</span><br>
<span class="lineno"></span><span class="op" id="4053656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4053659">//&nbsp;decryptPKCS1v15&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;priv&nbsp;and&nbsp;blinds&nbsp;the&nbsp;operation&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4053737">//&nbsp;rand&nbsp;is&nbsp;not&nbsp;nil.&nbsp;It&nbsp;returns&nbsp;one&nbsp;or&nbsp;zero&nbsp;in&nbsp;valid&nbsp;that&nbsp;indicates&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4053816">//&nbsp;plaintext&nbsp;was&nbsp;correctly&nbsp;structured.&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;plaintext&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4053888">//&nbsp;returned&nbsp;in&nbsp;em&nbsp;so&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;read&nbsp;independently&nbsp;of&nbsp;whether&nbsp;it&nbsp;was&nbsp;valid</span><br>
<span class="lineno"></span><span class="comment" id="4053967">//&nbsp;in&nbsp;order&nbsp;to&nbsp;maintain&nbsp;constant&nbsp;memory&nbsp;access&nbsp;patterns.&nbsp;If&nbsp;the&nbsp;plaintext&nbsp;was</span><br>
<span class="lineno">110</span><span class="comment" id="4054045">//&nbsp;valid&nbsp;then&nbsp;index&nbsp;contains&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;original&nbsp;message&nbsp;in&nbsp;em.</span><br>
<span class="lineno"></span><span class="keyword" id="4054115">func</span>&nbsp;<span class="ident" id="4054120">decryptPKCS1v15</span><span class="op" id="4054135">(</span><span class="ident" id="4054136">rand</span>&nbsp;<span class="ident" id="4054141">io</span><span class="op" id="4054143">.</span><span class="ident" id="4054144">Reader</span><span class="op" id="4054150">,</span>&nbsp;<span class="ident" id="4054152">priv</span>&nbsp;<span class="op" id="4054157">*</span><span class="ident" id="4054158">PrivateKey</span><span class="op" id="4054168">,</span>&nbsp;<span class="ident" id="4054170">ciphertext</span>&nbsp;<span class="op" id="4054181">[</span><span class="op" id="4054182">]</span><span class="builtintype" id="4054183">byte</span><span class="op" id="4054187">)</span>&nbsp;<span class="op" id="4054189">(</span><span class="ident" id="4054190">valid</span>&nbsp;<span class="builtintype" id="4054196">int</span><span class="op" id="4054199">,</span>&nbsp;<span class="ident" id="4054201">em</span>&nbsp;<span class="op" id="4054204">[</span><span class="op" id="4054205">]</span><span class="builtintype" id="4054206">byte</span><span class="op" id="4054210">,</span>&nbsp;<span class="ident" id="4054212">index</span>&nbsp;<span class="builtintype" id="4054218">int</span><span class="op" id="4054221">,</span>&nbsp;<span class="ident" id="4054223">err</span>&nbsp;<span class="builtintype" id="4054227">error</span><span class="op" id="4054232">)</span>&nbsp;<span class="op" id="4054234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054237">k</span>&nbsp;<span class="op" id="4054239">:=</span>&nbsp;<span class="op" id="4054242">(</span><span class="ident" id="4054243">priv</span><span class="op" id="4054247">.</span><span class="ident" id="4054248">N</span><span class="op" id="4054249">.</span><span class="ident" id="4054250">BitLen</span><span class="op" id="4054256">(</span><span class="op" id="4054257">)</span>&nbsp;<span class="op" id="4054259">+</span>&nbsp;<span class="num" id="4054261">7</span><span class="op" id="4054262">)</span>&nbsp;<span class="op" id="4054264">/</span>&nbsp;<span class="num" id="4054266">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054269">if</span>&nbsp;<span class="ident" id="4054272">k</span>&nbsp;<span class="op" id="4054274">&lt;</span>&nbsp;<span class="num" id="4054276">11</span>&nbsp;<span class="op" id="4054279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054283">err</span>&nbsp;<span class="op" id="4054287">=</span>&nbsp;<span class="ident" id="4054289">ErrDecryption</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054305">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054317">c</span>&nbsp;<span class="op" id="4054319">:=</span>&nbsp;<span class="builtinfunc" id="4054322">new</span><span class="op" id="4054325">(</span><span class="ident" id="4054326">big</span><span class="op" id="4054329">.</span><span class="ident" id="4054330">Int</span><span class="op" id="4054333">)</span><span class="op" id="4054334">.</span><span class="ident" id="4054335">SetBytes</span><span class="op" id="4054343">(</span><span class="ident" id="4054344">ciphertext</span><span class="op" id="4054354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054357">m</span><span class="op" id="4054358">,</span>&nbsp;<span class="ident" id="4054360">err</span>&nbsp;<span class="op" id="4054364">:=</span>&nbsp;<span class="ident" id="4054367">decrypt</span><span class="op" id="4054374">(</span><span class="ident" id="4054375">rand</span><span class="op" id="4054379">,</span>&nbsp;<span class="ident" id="4054381">priv</span><span class="op" id="4054385">,</span>&nbsp;<span class="ident" id="4054387">c</span><span class="op" id="4054388">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054391">if</span>&nbsp;<span class="ident" id="4054394">err</span>&nbsp;<span class="op" id="4054398">!=</span>&nbsp;<span class="ident" id="4054401">nil</span>&nbsp;<span class="op" id="4054405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054409">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054421">em</span>&nbsp;<span class="op" id="4054424">=</span>&nbsp;<span class="ident" id="4054426">leftPad</span><span class="op" id="4054433">(</span><span class="ident" id="4054434">m</span><span class="op" id="4054435">.</span><span class="ident" id="4054436">Bytes</span><span class="op" id="4054441">(</span><span class="op" id="4054442">)</span><span class="op" id="4054443">,</span>&nbsp;<span class="ident" id="4054445">k</span><span class="op" id="4054446">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054449">firstByteIsZero</span>&nbsp;<span class="op" id="4054465">:=</span>&nbsp;<span class="ident" id="4054468">subtle</span><span class="op" id="4054474">.</span><span class="ident" id="4054475">ConstantTimeByteEq</span><span class="op" id="4054493">(</span><span class="ident" id="4054494">em</span><span class="op" id="4054496">[</span><span class="num" id="4054497">0</span><span class="op" id="4054498">]</span><span class="op" id="4054499">,</span>&nbsp;<span class="num" id="4054501">0</span><span class="op" id="4054502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054505">secondByteIsTwo</span>&nbsp;<span class="op" id="4054521">:=</span>&nbsp;<span class="ident" id="4054524">subtle</span><span class="op" id="4054530">.</span><span class="ident" id="4054531">ConstantTimeByteEq</span><span class="op" id="4054549">(</span><span class="ident" id="4054550">em</span><span class="op" id="4054552">[</span><span class="num" id="4054553">1</span><span class="op" id="4054554">]</span><span class="op" id="4054555">,</span>&nbsp;<span class="num" id="4054557">2</span><span class="op" id="4054558">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4054562">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;a&nbsp;string&nbsp;of&nbsp;non-zero&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4054633">//&nbsp;octets,&nbsp;followed&nbsp;by&nbsp;a&nbsp;0,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4054687">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4054751">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;zero&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054799">lookingForIndex</span>&nbsp;<span class="op" id="4054815">:=</span>&nbsp;<span class="num" id="4054818">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054822">for</span>&nbsp;<span class="ident" id="4054826">i</span>&nbsp;<span class="op" id="4054828">:=</span>&nbsp;<span class="num" id="4054831">2</span><span class="op" id="4054832">;</span>&nbsp;<span class="ident" id="4054834">i</span>&nbsp;<span class="op" id="4054836">&lt;</span>&nbsp;<span class="builtinfunc" id="4054838">len</span><span class="op" id="4054841">(</span><span class="ident" id="4054842">em</span><span class="op" id="4054844">)</span><span class="op" id="4054845">;</span>&nbsp;<span class="ident" id="4054847">i</span><span class="op" id="4054848">++</span>&nbsp;<span class="op" id="4054851">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054855">equals0</span>&nbsp;<span class="op" id="4054863">:=</span>&nbsp;<span class="ident" id="4054866">subtle</span><span class="op" id="4054872">.</span><span class="ident" id="4054873">ConstantTimeByteEq</span><span class="op" id="4054891">(</span><span class="ident" id="4054892">em</span><span class="op" id="4054894">[</span><span class="ident" id="4054895">i</span><span class="op" id="4054896">]</span><span class="op" id="4054897">,</span>&nbsp;<span class="num" id="4054899">0</span><span class="op" id="4054900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054904">index</span>&nbsp;<span class="op" id="4054910">=</span>&nbsp;<span class="ident" id="4054912">subtle</span><span class="op" id="4054918">.</span><span class="ident" id="4054919">ConstantTimeSelect</span><span class="op" id="4054937">(</span><span class="ident" id="4054938">lookingForIndex</span><span class="op" id="4054953">&amp;</span><span class="ident" id="4054954">equals0</span><span class="op" id="4054961">,</span>&nbsp;<span class="ident" id="4054963">i</span><span class="op" id="4054964">,</span>&nbsp;<span class="ident" id="4054966">index</span><span class="op" id="4054971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054975">lookingForIndex</span>&nbsp;<span class="op" id="4054991">=</span>&nbsp;<span class="ident" id="4054993">subtle</span><span class="op" id="4054999">.</span><span class="ident" id="4055000">ConstantTimeSelect</span><span class="op" id="4055018">(</span><span class="ident" id="4055019">equals0</span><span class="op" id="4055026">,</span>&nbsp;<span class="num" id="4055028">0</span><span class="op" id="4055029">,</span>&nbsp;<span class="ident" id="4055031">lookingForIndex</span><span class="op" id="4055046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4055053">//&nbsp;The&nbsp;PS&nbsp;padding&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;8&nbsp;bytes&nbsp;long,&nbsp;and&nbsp;it&nbsp;starts&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4055121">//&nbsp;bytes&nbsp;into&nbsp;em.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055140">validPS</span>&nbsp;<span class="op" id="4055148">:=</span>&nbsp;<span class="ident" id="4055151">subtle</span><span class="op" id="4055157">.</span><span class="ident" id="4055158">ConstantTimeLessOrEq</span><span class="op" id="4055178">(</span><span class="num" id="4055179">2</span><span class="op" id="4055180">+</span><span class="num" id="4055181">8</span><span class="op" id="4055182">,</span>&nbsp;<span class="ident" id="4055184">index</span><span class="op" id="4055189">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055193">valid</span>&nbsp;<span class="op" id="4055199">=</span>&nbsp;<span class="ident" id="4055201">firstByteIsZero</span>&nbsp;<span class="op" id="4055217">&amp;</span>&nbsp;<span class="ident" id="4055219">secondByteIsTwo</span>&nbsp;<span class="op" id="4055235">&amp;</span>&nbsp;<span class="op" id="4055237">(</span><span class="op" id="4055238">^</span><span class="ident" id="4055239">lookingForIndex</span>&nbsp;<span class="op" id="4055255">&amp;</span>&nbsp;<span class="num" id="4055257">1</span><span class="op" id="4055258">)</span>&nbsp;<span class="op" id="4055260">&amp;</span>&nbsp;<span class="ident" id="4055262">validPS</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055271">index</span>&nbsp;<span class="op" id="4055277">=</span>&nbsp;<span class="ident" id="4055279">subtle</span><span class="op" id="4055285">.</span><span class="ident" id="4055286">ConstantTimeSelect</span><span class="op" id="4055304">(</span><span class="ident" id="4055305">valid</span><span class="op" id="4055310">,</span>&nbsp;<span class="ident" id="4055312">index</span><span class="op" id="4055317">+</span><span class="num" id="4055318">1</span><span class="op" id="4055319">,</span>&nbsp;<span class="num" id="4055321">0</span><span class="op" id="4055322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055325">return</span>&nbsp;<span class="ident" id="4055332">valid</span><span class="op" id="4055337">,</span>&nbsp;<span class="ident" id="4055339">em</span><span class="op" id="4055341">,</span>&nbsp;<span class="ident" id="4055343">index</span><span class="op" id="4055348">,</span>&nbsp;<span class="ident" id="4055350">nil</span><br>
<span class="lineno"></span><span class="op" id="4055354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4055357">//&nbsp;nonZeroRandomBytes&nbsp;fills&nbsp;the&nbsp;given&nbsp;slice&nbsp;with&nbsp;non-zero&nbsp;random&nbsp;octets.</span><br>
<span class="lineno">150</span><span class="keyword" id="4055430">func</span>&nbsp;<span class="ident" id="4055435">nonZeroRandomBytes</span><span class="op" id="4055453">(</span><span class="ident" id="4055454">s</span>&nbsp;<span class="op" id="4055456">[</span><span class="op" id="4055457">]</span><span class="builtintype" id="4055458">byte</span><span class="op" id="4055462">,</span>&nbsp;<span class="ident" id="4055464">rand</span>&nbsp;<span class="ident" id="4055469">io</span><span class="op" id="4055471">.</span><span class="ident" id="4055472">Reader</span><span class="op" id="4055478">)</span>&nbsp;<span class="op" id="4055480">(</span><span class="ident" id="4055481">err</span>&nbsp;<span class="builtintype" id="4055485">error</span><span class="op" id="4055490">)</span>&nbsp;<span class="op" id="4055492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055495">_</span><span class="op" id="4055496">,</span>&nbsp;<span class="ident" id="4055498">err</span>&nbsp;<span class="op" id="4055502">=</span>&nbsp;<span class="ident" id="4055504">io</span><span class="op" id="4055506">.</span><span class="ident" id="4055507">ReadFull</span><span class="op" id="4055515">(</span><span class="ident" id="4055516">rand</span><span class="op" id="4055520">,</span>&nbsp;<span class="ident" id="4055522">s</span><span class="op" id="4055523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055526">if</span>&nbsp;<span class="ident" id="4055529">err</span>&nbsp;<span class="op" id="4055533">!=</span>&nbsp;<span class="ident" id="4055536">nil</span>&nbsp;<span class="op" id="4055540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055544">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055552">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055556">for</span>&nbsp;<span class="ident" id="4055560">i</span>&nbsp;<span class="op" id="4055562">:=</span>&nbsp;<span class="num" id="4055565">0</span><span class="op" id="4055566">;</span>&nbsp;<span class="ident" id="4055568">i</span>&nbsp;<span class="op" id="4055570">&lt;</span>&nbsp;<span class="builtinfunc" id="4055572">len</span><span class="op" id="4055575">(</span><span class="ident" id="4055576">s</span><span class="op" id="4055577">)</span><span class="op" id="4055578">;</span>&nbsp;<span class="ident" id="4055580">i</span><span class="op" id="4055581">++</span>&nbsp;<span class="op" id="4055584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055588">for</span>&nbsp;<span class="ident" id="4055592">s</span><span class="op" id="4055593">[</span><span class="ident" id="4055594">i</span><span class="op" id="4055595">]</span>&nbsp;<span class="op" id="4055597">==</span>&nbsp;<span class="num" id="4055600">0</span>&nbsp;<span class="op" id="4055602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055607">_</span><span class="op" id="4055608">,</span>&nbsp;<span class="ident" id="4055610">err</span>&nbsp;<span class="op" id="4055614">=</span>&nbsp;<span class="ident" id="4055616">io</span><span class="op" id="4055618">.</span><span class="ident" id="4055619">ReadFull</span><span class="op" id="4055627">(</span><span class="ident" id="4055628">rand</span><span class="op" id="4055632">,</span>&nbsp;<span class="ident" id="4055634">s</span><span class="op" id="4055635">[</span><span class="ident" id="4055636">i</span><span class="op" id="4055637">:</span><span class="ident" id="4055638">i</span><span class="op" id="4055639">+</span><span class="num" id="4055640">1</span><span class="op" id="4055641">]</span><span class="op" id="4055642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055647">if</span>&nbsp;<span class="ident" id="4055650">err</span>&nbsp;<span class="op" id="4055654">!=</span>&nbsp;<span class="ident" id="4055657">nil</span>&nbsp;<span class="op" id="4055661">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055667">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4055682">//&nbsp;In&nbsp;tests,&nbsp;the&nbsp;PRNG&nbsp;may&nbsp;return&nbsp;all&nbsp;zeros&nbsp;so&nbsp;we&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4055737">//&nbsp;this&nbsp;to&nbsp;break&nbsp;the&nbsp;loop.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055767">s</span><span class="op" id="4055768">[</span><span class="ident" id="4055769">i</span><span class="op" id="4055770">]</span>&nbsp;<span class="op" id="4055772">^=</span>&nbsp;<span class="num" id="4055775">0x42</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055789">return</span><br>
<span class="lineno"></span><span class="op" id="4055796">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4055799">//&nbsp;These&nbsp;are&nbsp;ASN1&nbsp;DER&nbsp;structures:</span><br>
<span class="lineno"></span><span class="comment" id="4055833">//&nbsp;&nbsp;&nbsp;DigestInfo&nbsp;::=&nbsp;SEQUENCE&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4055864">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digestAlgorithm&nbsp;AlgorithmIdentifier,</span><br>
<span class="lineno"></span><span class="comment" id="4055908">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digest&nbsp;OCTET&nbsp;STRING</span><br>
<span class="lineno">175</span><span class="comment" id="4055935">//&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4055942">//&nbsp;For&nbsp;performance,&nbsp;we&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;generic&nbsp;ASN1&nbsp;encoder.&nbsp;Rather,&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="4056012">//&nbsp;precompute&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;digest&nbsp;value&nbsp;that&nbsp;makes&nbsp;a&nbsp;valid&nbsp;ASN1&nbsp;DER&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4056090">//&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="4056120">var</span>&nbsp;<span class="ident" id="4056124">hashPrefixes</span>&nbsp;<span class="op" id="4056137">=</span>&nbsp;<span class="keyword" id="4056139">map</span><span class="op" id="4056142">[</span><span class="ident" id="4056143">crypto</span><span class="op" id="4056149">.</span><span class="ident" id="4056150">Hash</span><span class="op" id="4056154">]</span><span class="op" id="4056155">[</span><span class="op" id="4056156">]</span><span class="builtintype" id="4056157">byte</span><span class="op" id="4056161">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056164">crypto</span><span class="op" id="4056170">.</span><span class="ident" id="4056171">MD5</span><span class="op" id="4056174">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4056182">{</span><span class="num" id="4056183">0x30</span><span class="op" id="4056187">,</span>&nbsp;<span class="num" id="4056189">0x20</span><span class="op" id="4056193">,</span>&nbsp;<span class="num" id="4056195">0x30</span><span class="op" id="4056199">,</span>&nbsp;<span class="num" id="4056201">0x0c</span><span class="op" id="4056205">,</span>&nbsp;<span class="num" id="4056207">0x06</span><span class="op" id="4056211">,</span>&nbsp;<span class="num" id="4056213">0x08</span><span class="op" id="4056217">,</span>&nbsp;<span class="num" id="4056219">0x2a</span><span class="op" id="4056223">,</span>&nbsp;<span class="num" id="4056225">0x86</span><span class="op" id="4056229">,</span>&nbsp;<span class="num" id="4056231">0x48</span><span class="op" id="4056235">,</span>&nbsp;<span class="num" id="4056237">0x86</span><span class="op" id="4056241">,</span>&nbsp;<span class="num" id="4056243">0xf7</span><span class="op" id="4056247">,</span>&nbsp;<span class="num" id="4056249">0x0d</span><span class="op" id="4056253">,</span>&nbsp;<span class="num" id="4056255">0x02</span><span class="op" id="4056259">,</span>&nbsp;<span class="num" id="4056261">0x05</span><span class="op" id="4056265">,</span>&nbsp;<span class="num" id="4056267">0x05</span><span class="op" id="4056271">,</span>&nbsp;<span class="num" id="4056273">0x00</span><span class="op" id="4056277">,</span>&nbsp;<span class="num" id="4056279">0x04</span><span class="op" id="4056283">,</span>&nbsp;<span class="num" id="4056285">0x10</span><span class="op" id="4056289">}</span><span class="op" id="4056290">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056293">crypto</span><span class="op" id="4056299">.</span><span class="ident" id="4056300">SHA1</span><span class="op" id="4056304">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4056311">{</span><span class="num" id="4056312">0x30</span><span class="op" id="4056316">,</span>&nbsp;<span class="num" id="4056318">0x21</span><span class="op" id="4056322">,</span>&nbsp;<span class="num" id="4056324">0x30</span><span class="op" id="4056328">,</span>&nbsp;<span class="num" id="4056330">0x09</span><span class="op" id="4056334">,</span>&nbsp;<span class="num" id="4056336">0x06</span><span class="op" id="4056340">,</span>&nbsp;<span class="num" id="4056342">0x05</span><span class="op" id="4056346">,</span>&nbsp;<span class="num" id="4056348">0x2b</span><span class="op" id="4056352">,</span>&nbsp;<span class="num" id="4056354">0x0e</span><span class="op" id="4056358">,</span>&nbsp;<span class="num" id="4056360">0x03</span><span class="op" id="4056364">,</span>&nbsp;<span class="num" id="4056366">0x02</span><span class="op" id="4056370">,</span>&nbsp;<span class="num" id="4056372">0x1a</span><span class="op" id="4056376">,</span>&nbsp;<span class="num" id="4056378">0x05</span><span class="op" id="4056382">,</span>&nbsp;<span class="num" id="4056384">0x00</span><span class="op" id="4056388">,</span>&nbsp;<span class="num" id="4056390">0x04</span><span class="op" id="4056394">,</span>&nbsp;<span class="num" id="4056396">0x14</span><span class="op" id="4056400">}</span><span class="op" id="4056401">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056404">crypto</span><span class="op" id="4056410">.</span><span class="ident" id="4056411">SHA224</span><span class="op" id="4056417">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4056422">{</span><span class="num" id="4056423">0x30</span><span class="op" id="4056427">,</span>&nbsp;<span class="num" id="4056429">0x2d</span><span class="op" id="4056433">,</span>&nbsp;<span class="num" id="4056435">0x30</span><span class="op" id="4056439">,</span>&nbsp;<span class="num" id="4056441">0x0d</span><span class="op" id="4056445">,</span>&nbsp;<span class="num" id="4056447">0x06</span><span class="op" id="4056451">,</span>&nbsp;<span class="num" id="4056453">0x09</span><span class="op" id="4056457">,</span>&nbsp;<span class="num" id="4056459">0x60</span><span class="op" id="4056463">,</span>&nbsp;<span class="num" id="4056465">0x86</span><span class="op" id="4056469">,</span>&nbsp;<span class="num" id="4056471">0x48</span><span class="op" id="4056475">,</span>&nbsp;<span class="num" id="4056477">0x01</span><span class="op" id="4056481">,</span>&nbsp;<span class="num" id="4056483">0x65</span><span class="op" id="4056487">,</span>&nbsp;<span class="num" id="4056489">0x03</span><span class="op" id="4056493">,</span>&nbsp;<span class="num" id="4056495">0x04</span><span class="op" id="4056499">,</span>&nbsp;<span class="num" id="4056501">0x02</span><span class="op" id="4056505">,</span>&nbsp;<span class="num" id="4056507">0x04</span><span class="op" id="4056511">,</span>&nbsp;<span class="num" id="4056513">0x05</span><span class="op" id="4056517">,</span>&nbsp;<span class="num" id="4056519">0x00</span><span class="op" id="4056523">,</span>&nbsp;<span class="num" id="4056525">0x04</span><span class="op" id="4056529">,</span>&nbsp;<span class="num" id="4056531">0x1c</span><span class="op" id="4056535">}</span><span class="op" id="4056536">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056539">crypto</span><span class="op" id="4056545">.</span><span class="ident" id="4056546">SHA256</span><span class="op" id="4056552">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4056557">{</span><span class="num" id="4056558">0x30</span><span class="op" id="4056562">,</span>&nbsp;<span class="num" id="4056564">0x31</span><span class="op" id="4056568">,</span>&nbsp;<span class="num" id="4056570">0x30</span><span class="op" id="4056574">,</span>&nbsp;<span class="num" id="4056576">0x0d</span><span class="op" id="4056580">,</span>&nbsp;<span class="num" id="4056582">0x06</span><span class="op" id="4056586">,</span>&nbsp;<span class="num" id="4056588">0x09</span><span class="op" id="4056592">,</span>&nbsp;<span class="num" id="4056594">0x60</span><span class="op" id="4056598">,</span>&nbsp;<span class="num" id="4056600">0x86</span><span class="op" id="4056604">,</span>&nbsp;<span class="num" id="4056606">0x48</span><span class="op" id="4056610">,</span>&nbsp;<span class="num" id="4056612">0x01</span><span class="op" id="4056616">,</span>&nbsp;<span class="num" id="4056618">0x65</span><span class="op" id="4056622">,</span>&nbsp;<span class="num" id="4056624">0x03</span><span class="op" id="4056628">,</span>&nbsp;<span class="num" id="4056630">0x04</span><span class="op" id="4056634">,</span>&nbsp;<span class="num" id="4056636">0x02</span><span class="op" id="4056640">,</span>&nbsp;<span class="num" id="4056642">0x01</span><span class="op" id="4056646">,</span>&nbsp;<span class="num" id="4056648">0x05</span><span class="op" id="4056652">,</span>&nbsp;<span class="num" id="4056654">0x00</span><span class="op" id="4056658">,</span>&nbsp;<span class="num" id="4056660">0x04</span><span class="op" id="4056664">,</span>&nbsp;<span class="num" id="4056666">0x20</span><span class="op" id="4056670">}</span><span class="op" id="4056671">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056674">crypto</span><span class="op" id="4056680">.</span><span class="ident" id="4056681">SHA384</span><span class="op" id="4056687">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4056692">{</span><span class="num" id="4056693">0x30</span><span class="op" id="4056697">,</span>&nbsp;<span class="num" id="4056699">0x41</span><span class="op" id="4056703">,</span>&nbsp;<span class="num" id="4056705">0x30</span><span class="op" id="4056709">,</span>&nbsp;<span class="num" id="4056711">0x0d</span><span class="op" id="4056715">,</span>&nbsp;<span class="num" id="4056717">0x06</span><span class="op" id="4056721">,</span>&nbsp;<span class="num" id="4056723">0x09</span><span class="op" id="4056727">,</span>&nbsp;<span class="num" id="4056729">0x60</span><span class="op" id="4056733">,</span>&nbsp;<span class="num" id="4056735">0x86</span><span class="op" id="4056739">,</span>&nbsp;<span class="num" id="4056741">0x48</span><span class="op" id="4056745">,</span>&nbsp;<span class="num" id="4056747">0x01</span><span class="op" id="4056751">,</span>&nbsp;<span class="num" id="4056753">0x65</span><span class="op" id="4056757">,</span>&nbsp;<span class="num" id="4056759">0x03</span><span class="op" id="4056763">,</span>&nbsp;<span class="num" id="4056765">0x04</span><span class="op" id="4056769">,</span>&nbsp;<span class="num" id="4056771">0x02</span><span class="op" id="4056775">,</span>&nbsp;<span class="num" id="4056777">0x02</span><span class="op" id="4056781">,</span>&nbsp;<span class="num" id="4056783">0x05</span><span class="op" id="4056787">,</span>&nbsp;<span class="num" id="4056789">0x00</span><span class="op" id="4056793">,</span>&nbsp;<span class="num" id="4056795">0x04</span><span class="op" id="4056799">,</span>&nbsp;<span class="num" id="4056801">0x30</span><span class="op" id="4056805">}</span><span class="op" id="4056806">,</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056809">crypto</span><span class="op" id="4056815">.</span><span class="ident" id="4056816">SHA512</span><span class="op" id="4056822">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4056827">{</span><span class="num" id="4056828">0x30</span><span class="op" id="4056832">,</span>&nbsp;<span class="num" id="4056834">0x51</span><span class="op" id="4056838">,</span>&nbsp;<span class="num" id="4056840">0x30</span><span class="op" id="4056844">,</span>&nbsp;<span class="num" id="4056846">0x0d</span><span class="op" id="4056850">,</span>&nbsp;<span class="num" id="4056852">0x06</span><span class="op" id="4056856">,</span>&nbsp;<span class="num" id="4056858">0x09</span><span class="op" id="4056862">,</span>&nbsp;<span class="num" id="4056864">0x60</span><span class="op" id="4056868">,</span>&nbsp;<span class="num" id="4056870">0x86</span><span class="op" id="4056874">,</span>&nbsp;<span class="num" id="4056876">0x48</span><span class="op" id="4056880">,</span>&nbsp;<span class="num" id="4056882">0x01</span><span class="op" id="4056886">,</span>&nbsp;<span class="num" id="4056888">0x65</span><span class="op" id="4056892">,</span>&nbsp;<span class="num" id="4056894">0x03</span><span class="op" id="4056898">,</span>&nbsp;<span class="num" id="4056900">0x04</span><span class="op" id="4056904">,</span>&nbsp;<span class="num" id="4056906">0x02</span><span class="op" id="4056910">,</span>&nbsp;<span class="num" id="4056912">0x03</span><span class="op" id="4056916">,</span>&nbsp;<span class="num" id="4056918">0x05</span><span class="op" id="4056922">,</span>&nbsp;<span class="num" id="4056924">0x00</span><span class="op" id="4056928">,</span>&nbsp;<span class="num" id="4056930">0x04</span><span class="op" id="4056934">,</span>&nbsp;<span class="num" id="4056936">0x40</span><span class="op" id="4056940">}</span><span class="op" id="4056941">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056944">crypto</span><span class="op" id="4056950">.</span><span class="ident" id="4056951">MD5SHA1</span><span class="op" id="4056958">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4056962">{</span><span class="op" id="4056963">}</span><span class="op" id="4056964">,</span>&nbsp;<span class="comment" id="4056966">//&nbsp;A&nbsp;special&nbsp;TLS&nbsp;case&nbsp;which&nbsp;doesn&#39;t&nbsp;use&nbsp;an&nbsp;ASN1&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057023">crypto</span><span class="op" id="4057029">.</span><span class="ident" id="4057030">RIPEMD160</span><span class="op" id="4057039">:</span>&nbsp;<span class="op" id="4057041">{</span><span class="num" id="4057042">0x30</span><span class="op" id="4057046">,</span>&nbsp;<span class="num" id="4057048">0x20</span><span class="op" id="4057052">,</span>&nbsp;<span class="num" id="4057054">0x30</span><span class="op" id="4057058">,</span>&nbsp;<span class="num" id="4057060">0x08</span><span class="op" id="4057064">,</span>&nbsp;<span class="num" id="4057066">0x06</span><span class="op" id="4057070">,</span>&nbsp;<span class="num" id="4057072">0x06</span><span class="op" id="4057076">,</span>&nbsp;<span class="num" id="4057078">0x28</span><span class="op" id="4057082">,</span>&nbsp;<span class="num" id="4057084">0xcf</span><span class="op" id="4057088">,</span>&nbsp;<span class="num" id="4057090">0x06</span><span class="op" id="4057094">,</span>&nbsp;<span class="num" id="4057096">0x03</span><span class="op" id="4057100">,</span>&nbsp;<span class="num" id="4057102">0x00</span><span class="op" id="4057106">,</span>&nbsp;<span class="num" id="4057108">0x31</span><span class="op" id="4057112">,</span>&nbsp;<span class="num" id="4057114">0x04</span><span class="op" id="4057118">,</span>&nbsp;<span class="num" id="4057120">0x14</span><span class="op" id="4057124">}</span><span class="op" id="4057125">,</span><br>
<span class="lineno"></span><span class="op" id="4057127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="comment" id="4057130">//&nbsp;SignPKCS1v15&nbsp;calculates&nbsp;the&nbsp;signature&nbsp;of&nbsp;hashed&nbsp;using&nbsp;RSASSA-PKCS1-V1_5-SIGN&nbsp;from&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4057232">//&nbsp;Note&nbsp;that&nbsp;hashed&nbsp;must&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4057310">//&nbsp;given&nbsp;hash&nbsp;function.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero,&nbsp;hashed&nbsp;is&nbsp;signed&nbsp;directly.&nbsp;This&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4057389">//&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4057431">func</span>&nbsp;<span class="ident" id="4057436">SignPKCS1v15</span><span class="op" id="4057448">(</span><span class="ident" id="4057449">rand</span>&nbsp;<span class="ident" id="4057454">io</span><span class="op" id="4057456">.</span><span class="ident" id="4057457">Reader</span><span class="op" id="4057463">,</span>&nbsp;<span class="ident" id="4057465">priv</span>&nbsp;<span class="op" id="4057470">*</span><span class="ident" id="4057471">PrivateKey</span><span class="op" id="4057481">,</span>&nbsp;<span class="ident" id="4057483">hash</span>&nbsp;<span class="ident" id="4057488">crypto</span><span class="op" id="4057494">.</span><span class="ident" id="4057495">Hash</span><span class="op" id="4057499">,</span>&nbsp;<span class="ident" id="4057501">hashed</span>&nbsp;<span class="op" id="4057508">[</span><span class="op" id="4057509">]</span><span class="builtintype" id="4057510">byte</span><span class="op" id="4057514">)</span>&nbsp;<span class="op" id="4057516">(</span><span class="ident" id="4057517">s</span>&nbsp;<span class="op" id="4057519">[</span><span class="op" id="4057520">]</span><span class="builtintype" id="4057521">byte</span><span class="op" id="4057525">,</span>&nbsp;<span class="ident" id="4057527">err</span>&nbsp;<span class="builtintype" id="4057531">error</span><span class="op" id="4057536">)</span>&nbsp;<span class="op" id="4057538">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057541">hashLen</span><span class="op" id="4057548">,</span>&nbsp;<span class="ident" id="4057550">prefix</span><span class="op" id="4057556">,</span>&nbsp;<span class="ident" id="4057558">err</span>&nbsp;<span class="op" id="4057562">:=</span>&nbsp;<span class="ident" id="4057565">pkcs1v15HashInfo</span><span class="op" id="4057581">(</span><span class="ident" id="4057582">hash</span><span class="op" id="4057586">,</span>&nbsp;<span class="builtinfunc" id="4057588">len</span><span class="op" id="4057591">(</span><span class="ident" id="4057592">hashed</span><span class="op" id="4057598">)</span><span class="op" id="4057599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057602">if</span>&nbsp;<span class="ident" id="4057605">err</span>&nbsp;<span class="op" id="4057609">!=</span>&nbsp;<span class="ident" id="4057612">nil</span>&nbsp;<span class="op" id="4057616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057620">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057632">tLen</span>&nbsp;<span class="op" id="4057637">:=</span>&nbsp;<span class="builtinfunc" id="4057640">len</span><span class="op" id="4057643">(</span><span class="ident" id="4057644">prefix</span><span class="op" id="4057650">)</span>&nbsp;<span class="op" id="4057652">+</span>&nbsp;<span class="ident" id="4057654">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057663">k</span>&nbsp;<span class="op" id="4057665">:=</span>&nbsp;<span class="op" id="4057668">(</span><span class="ident" id="4057669">priv</span><span class="op" id="4057673">.</span><span class="ident" id="4057674">N</span><span class="op" id="4057675">.</span><span class="ident" id="4057676">BitLen</span><span class="op" id="4057682">(</span><span class="op" id="4057683">)</span>&nbsp;<span class="op" id="4057685">+</span>&nbsp;<span class="num" id="4057687">7</span><span class="op" id="4057688">)</span>&nbsp;<span class="op" id="4057690">/</span>&nbsp;<span class="num" id="4057692">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057695">if</span>&nbsp;<span class="ident" id="4057698">k</span>&nbsp;<span class="op" id="4057700">&lt;</span>&nbsp;<span class="ident" id="4057702">tLen</span><span class="op" id="4057706">+</span><span class="num" id="4057707">11</span>&nbsp;<span class="op" id="4057710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057714">return</span>&nbsp;<span class="ident" id="4057721">nil</span><span class="op" id="4057724">,</span>&nbsp;<span class="ident" id="4057726">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057745">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4057749">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057790">em</span>&nbsp;<span class="op" id="4057793">:=</span>&nbsp;<span class="builtinfunc" id="4057796">make</span><span class="op" id="4057800">(</span><span class="op" id="4057801">[</span><span class="op" id="4057802">]</span><span class="builtintype" id="4057803">byte</span><span class="op" id="4057807">,</span>&nbsp;<span class="ident" id="4057809">k</span><span class="op" id="4057810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057813">em</span><span class="op" id="4057815">[</span><span class="num" id="4057816">1</span><span class="op" id="4057817">]</span>&nbsp;<span class="op" id="4057819">=</span>&nbsp;<span class="num" id="4057821">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057824">for</span>&nbsp;<span class="ident" id="4057828">i</span>&nbsp;<span class="op" id="4057830">:=</span>&nbsp;<span class="num" id="4057833">2</span><span class="op" id="4057834">;</span>&nbsp;<span class="ident" id="4057836">i</span>&nbsp;<span class="op" id="4057838">&lt;</span>&nbsp;<span class="ident" id="4057840">k</span><span class="op" id="4057841">-</span><span class="ident" id="4057842">tLen</span><span class="op" id="4057846">-</span><span class="num" id="4057847">1</span><span class="op" id="4057848">;</span>&nbsp;<span class="ident" id="4057850">i</span><span class="op" id="4057851">++</span>&nbsp;<span class="op" id="4057854">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057858">em</span><span class="op" id="4057860">[</span><span class="ident" id="4057861">i</span><span class="op" id="4057862">]</span>&nbsp;<span class="op" id="4057864">=</span>&nbsp;<span class="num" id="4057866">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4057875">copy</span><span class="op" id="4057879">(</span><span class="ident" id="4057880">em</span><span class="op" id="4057882">[</span><span class="ident" id="4057883">k</span><span class="op" id="4057884">-</span><span class="ident" id="4057885">tLen</span><span class="op" id="4057889">:</span><span class="ident" id="4057890">k</span><span class="op" id="4057891">-</span><span class="ident" id="4057892">hashLen</span><span class="op" id="4057899">]</span><span class="op" id="4057900">,</span>&nbsp;<span class="ident" id="4057902">prefix</span><span class="op" id="4057908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4057911">copy</span><span class="op" id="4057915">(</span><span class="ident" id="4057916">em</span><span class="op" id="4057918">[</span><span class="ident" id="4057919">k</span><span class="op" id="4057920">-</span><span class="ident" id="4057921">hashLen</span><span class="op" id="4057928">:</span><span class="ident" id="4057929">k</span><span class="op" id="4057930">]</span><span class="op" id="4057931">,</span>&nbsp;<span class="ident" id="4057933">hashed</span><span class="op" id="4057939">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057943">m</span>&nbsp;<span class="op" id="4057945">:=</span>&nbsp;<span class="builtinfunc" id="4057948">new</span><span class="op" id="4057951">(</span><span class="ident" id="4057952">big</span><span class="op" id="4057955">.</span><span class="ident" id="4057956">Int</span><span class="op" id="4057959">)</span><span class="op" id="4057960">.</span><span class="ident" id="4057961">SetBytes</span><span class="op" id="4057969">(</span><span class="ident" id="4057970">em</span><span class="op" id="4057972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057975">c</span><span class="op" id="4057976">,</span>&nbsp;<span class="ident" id="4057978">err</span>&nbsp;<span class="op" id="4057982">:=</span>&nbsp;<span class="ident" id="4057985">decrypt</span><span class="op" id="4057992">(</span><span class="ident" id="4057993">rand</span><span class="op" id="4057997">,</span>&nbsp;<span class="ident" id="4057999">priv</span><span class="op" id="4058003">,</span>&nbsp;<span class="ident" id="4058005">m</span><span class="op" id="4058006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058009">if</span>&nbsp;<span class="ident" id="4058012">err</span>&nbsp;<span class="op" id="4058016">!=</span>&nbsp;<span class="ident" id="4058019">nil</span>&nbsp;<span class="op" id="4058023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058027">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4058035">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058039">copyWithLeftPad</span><span class="op" id="4058054">(</span><span class="ident" id="4058055">em</span><span class="op" id="4058057">,</span>&nbsp;<span class="ident" id="4058059">c</span><span class="op" id="4058060">.</span><span class="ident" id="4058061">Bytes</span><span class="op" id="4058066">(</span><span class="op" id="4058067">)</span><span class="op" id="4058068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058071">s</span>&nbsp;<span class="op" id="4058073">=</span>&nbsp;<span class="ident" id="4058075">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058079">return</span><br>
<span class="lineno"></span><span class="op" id="4058086">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="4058089">//&nbsp;VerifyPKCS1v15&nbsp;verifies&nbsp;an&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment" id="4058146">//&nbsp;hashed&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the&nbsp;given&nbsp;hash</span><br>
<span class="lineno"></span><span class="comment" id="4058220">//&nbsp;function&nbsp;and&nbsp;sig&nbsp;is&nbsp;the&nbsp;signature.&nbsp;A&nbsp;valid&nbsp;signature&nbsp;is&nbsp;indicated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4058292">//&nbsp;returning&nbsp;a&nbsp;nil&nbsp;error.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero&nbsp;then&nbsp;hashed&nbsp;is&nbsp;used&nbsp;directly.&nbsp;This</span><br>
<span class="lineno">230</span><span class="comment" id="4058369">//&nbsp;isn&#39;t&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4058417">func</span>&nbsp;<span class="ident" id="4058422">VerifyPKCS1v15</span><span class="op" id="4058436">(</span><span class="ident" id="4058437">pub</span>&nbsp;<span class="op" id="4058441">*</span><span class="ident" id="4058442">PublicKey</span><span class="op" id="4058451">,</span>&nbsp;<span class="ident" id="4058453">hash</span>&nbsp;<span class="ident" id="4058458">crypto</span><span class="op" id="4058464">.</span><span class="ident" id="4058465">Hash</span><span class="op" id="4058469">,</span>&nbsp;<span class="ident" id="4058471">hashed</span>&nbsp;<span class="op" id="4058478">[</span><span class="op" id="4058479">]</span><span class="builtintype" id="4058480">byte</span><span class="op" id="4058484">,</span>&nbsp;<span class="ident" id="4058486">sig</span>&nbsp;<span class="op" id="4058490">[</span><span class="op" id="4058491">]</span><span class="builtintype" id="4058492">byte</span><span class="op" id="4058496">)</span>&nbsp;<span class="op" id="4058498">(</span><span class="ident" id="4058499">err</span>&nbsp;<span class="builtintype" id="4058503">error</span><span class="op" id="4058508">)</span>&nbsp;<span class="op" id="4058510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058513">hashLen</span><span class="op" id="4058520">,</span>&nbsp;<span class="ident" id="4058522">prefix</span><span class="op" id="4058528">,</span>&nbsp;<span class="ident" id="4058530">err</span>&nbsp;<span class="op" id="4058534">:=</span>&nbsp;<span class="ident" id="4058537">pkcs1v15HashInfo</span><span class="op" id="4058553">(</span><span class="ident" id="4058554">hash</span><span class="op" id="4058558">,</span>&nbsp;<span class="builtinfunc" id="4058560">len</span><span class="op" id="4058563">(</span><span class="ident" id="4058564">hashed</span><span class="op" id="4058570">)</span><span class="op" id="4058571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058574">if</span>&nbsp;<span class="ident" id="4058577">err</span>&nbsp;<span class="op" id="4058581">!=</span>&nbsp;<span class="ident" id="4058584">nil</span>&nbsp;<span class="op" id="4058588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058592">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4058600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058604">tLen</span>&nbsp;<span class="op" id="4058609">:=</span>&nbsp;<span class="builtinfunc" id="4058612">len</span><span class="op" id="4058615">(</span><span class="ident" id="4058616">prefix</span><span class="op" id="4058622">)</span>&nbsp;<span class="op" id="4058624">+</span>&nbsp;<span class="ident" id="4058626">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058635">k</span>&nbsp;<span class="op" id="4058637">:=</span>&nbsp;<span class="op" id="4058640">(</span><span class="ident" id="4058641">pub</span><span class="op" id="4058644">.</span><span class="ident" id="4058645">N</span><span class="op" id="4058646">.</span><span class="ident" id="4058647">BitLen</span><span class="op" id="4058653">(</span><span class="op" id="4058654">)</span>&nbsp;<span class="op" id="4058656">+</span>&nbsp;<span class="num" id="4058658">7</span><span class="op" id="4058659">)</span>&nbsp;<span class="op" id="4058661">/</span>&nbsp;<span class="num" id="4058663">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058666">if</span>&nbsp;<span class="ident" id="4058669">k</span>&nbsp;<span class="op" id="4058671">&lt;</span>&nbsp;<span class="ident" id="4058673">tLen</span><span class="op" id="4058677">+</span><span class="num" id="4058678">11</span>&nbsp;<span class="op" id="4058681">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058685">err</span>&nbsp;<span class="op" id="4058689">=</span>&nbsp;<span class="ident" id="4058691">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058709">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4058717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058721">c</span>&nbsp;<span class="op" id="4058723">:=</span>&nbsp;<span class="builtinfunc" id="4058726">new</span><span class="op" id="4058729">(</span><span class="ident" id="4058730">big</span><span class="op" id="4058733">.</span><span class="ident" id="4058734">Int</span><span class="op" id="4058737">)</span><span class="op" id="4058738">.</span><span class="ident" id="4058739">SetBytes</span><span class="op" id="4058747">(</span><span class="ident" id="4058748">sig</span><span class="op" id="4058751">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058754">m</span>&nbsp;<span class="op" id="4058756">:=</span>&nbsp;<span class="ident" id="4058759">encrypt</span><span class="op" id="4058766">(</span><span class="builtinfunc" id="4058767">new</span><span class="op" id="4058770">(</span><span class="ident" id="4058771">big</span><span class="op" id="4058774">.</span><span class="ident" id="4058775">Int</span><span class="op" id="4058778">)</span><span class="op" id="4058779">,</span>&nbsp;<span class="ident" id="4058781">pub</span><span class="op" id="4058784">,</span>&nbsp;<span class="ident" id="4058786">c</span><span class="op" id="4058787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058790">em</span>&nbsp;<span class="op" id="4058793">:=</span>&nbsp;<span class="ident" id="4058796">leftPad</span><span class="op" id="4058803">(</span><span class="ident" id="4058804">m</span><span class="op" id="4058805">.</span><span class="ident" id="4058806">Bytes</span><span class="op" id="4058811">(</span><span class="op" id="4058812">)</span><span class="op" id="4058813">,</span>&nbsp;<span class="ident" id="4058815">k</span><span class="op" id="4058816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4058819">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058861">ok</span>&nbsp;<span class="op" id="4058864">:=</span>&nbsp;<span class="ident" id="4058867">subtle</span><span class="op" id="4058873">.</span><span class="ident" id="4058874">ConstantTimeByteEq</span><span class="op" id="4058892">(</span><span class="ident" id="4058893">em</span><span class="op" id="4058895">[</span><span class="num" id="4058896">0</span><span class="op" id="4058897">]</span><span class="op" id="4058898">,</span>&nbsp;<span class="num" id="4058900">0</span><span class="op" id="4058901">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058904">ok</span>&nbsp;<span class="op" id="4058907">&amp;=</span>&nbsp;<span class="ident" id="4058910">subtle</span><span class="op" id="4058916">.</span><span class="ident" id="4058917">ConstantTimeByteEq</span><span class="op" id="4058935">(</span><span class="ident" id="4058936">em</span><span class="op" id="4058938">[</span><span class="num" id="4058939">1</span><span class="op" id="4058940">]</span><span class="op" id="4058941">,</span>&nbsp;<span class="num" id="4058943">1</span><span class="op" id="4058944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058947">ok</span>&nbsp;<span class="op" id="4058950">&amp;=</span>&nbsp;<span class="ident" id="4058953">subtle</span><span class="op" id="4058959">.</span><span class="ident" id="4058960">ConstantTimeCompare</span><span class="op" id="4058979">(</span><span class="ident" id="4058980">em</span><span class="op" id="4058982">[</span><span class="ident" id="4058983">k</span><span class="op" id="4058984">-</span><span class="ident" id="4058985">hashLen</span><span class="op" id="4058992">:</span><span class="ident" id="4058993">k</span><span class="op" id="4058994">]</span><span class="op" id="4058995">,</span>&nbsp;<span class="ident" id="4058997">hashed</span><span class="op" id="4059003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059006">ok</span>&nbsp;<span class="op" id="4059009">&amp;=</span>&nbsp;<span class="ident" id="4059012">subtle</span><span class="op" id="4059018">.</span><span class="ident" id="4059019">ConstantTimeCompare</span><span class="op" id="4059038">(</span><span class="ident" id="4059039">em</span><span class="op" id="4059041">[</span><span class="ident" id="4059042">k</span><span class="op" id="4059043">-</span><span class="ident" id="4059044">tLen</span><span class="op" id="4059048">:</span><span class="ident" id="4059049">k</span><span class="op" id="4059050">-</span><span class="ident" id="4059051">hashLen</span><span class="op" id="4059058">]</span><span class="op" id="4059059">,</span>&nbsp;<span class="ident" id="4059061">prefix</span><span class="op" id="4059067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059070">ok</span>&nbsp;<span class="op" id="4059073">&amp;=</span>&nbsp;<span class="ident" id="4059076">subtle</span><span class="op" id="4059082">.</span><span class="ident" id="4059083">ConstantTimeByteEq</span><span class="op" id="4059101">(</span><span class="ident" id="4059102">em</span><span class="op" id="4059104">[</span><span class="ident" id="4059105">k</span><span class="op" id="4059106">-</span><span class="ident" id="4059107">tLen</span><span class="op" id="4059111">-</span><span class="num" id="4059112">1</span><span class="op" id="4059113">]</span><span class="op" id="4059114">,</span>&nbsp;<span class="num" id="4059116">0</span><span class="op" id="4059117">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059121">for</span>&nbsp;<span class="ident" id="4059125">i</span>&nbsp;<span class="op" id="4059127">:=</span>&nbsp;<span class="num" id="4059130">2</span><span class="op" id="4059131">;</span>&nbsp;<span class="ident" id="4059133">i</span>&nbsp;<span class="op" id="4059135">&lt;</span>&nbsp;<span class="ident" id="4059137">k</span><span class="op" id="4059138">-</span><span class="ident" id="4059139">tLen</span><span class="op" id="4059143">-</span><span class="num" id="4059144">1</span><span class="op" id="4059145">;</span>&nbsp;<span class="ident" id="4059147">i</span><span class="op" id="4059148">++</span>&nbsp;<span class="op" id="4059151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059155">ok</span>&nbsp;<span class="op" id="4059158">&amp;=</span>&nbsp;<span class="ident" id="4059161">subtle</span><span class="op" id="4059167">.</span><span class="ident" id="4059168">ConstantTimeByteEq</span><span class="op" id="4059186">(</span><span class="ident" id="4059187">em</span><span class="op" id="4059189">[</span><span class="ident" id="4059190">i</span><span class="op" id="4059191">]</span><span class="op" id="4059192">,</span>&nbsp;<span class="num" id="4059194">0xff</span><span class="op" id="4059198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4059201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059205">if</span>&nbsp;<span class="ident" id="4059208">ok</span>&nbsp;<span class="op" id="4059211">!=</span>&nbsp;<span class="num" id="4059214">1</span>&nbsp;<span class="op" id="4059216">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059220">return</span>&nbsp;<span class="ident" id="4059227">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4059244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059248">return</span>&nbsp;<span class="ident" id="4059255">nil</span><br>
<span class="lineno"></span><span class="op" id="4059259">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="4059262">func</span>&nbsp;<span class="ident" id="4059267">pkcs1v15HashInfo</span><span class="op" id="4059283">(</span><span class="ident" id="4059284">hash</span>&nbsp;<span class="ident" id="4059289">crypto</span><span class="op" id="4059295">.</span><span class="ident" id="4059296">Hash</span><span class="op" id="4059300">,</span>&nbsp;<span class="ident" id="4059302">inLen</span>&nbsp;<span class="builtintype" id="4059308">int</span><span class="op" id="4059311">)</span>&nbsp;<span class="op" id="4059313">(</span><span class="ident" id="4059314">hashLen</span>&nbsp;<span class="builtintype" id="4059322">int</span><span class="op" id="4059325">,</span>&nbsp;<span class="ident" id="4059327">prefix</span>&nbsp;<span class="op" id="4059334">[</span><span class="op" id="4059335">]</span><span class="builtintype" id="4059336">byte</span><span class="op" id="4059340">,</span>&nbsp;<span class="ident" id="4059342">err</span>&nbsp;<span class="builtintype" id="4059346">error</span><span class="op" id="4059351">)</span>&nbsp;<span class="op" id="4059353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059356">//&nbsp;Special&nbsp;case:&nbsp;crypto.Hash(0)&nbsp;is&nbsp;used&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059426">//&nbsp;signed&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059447">if</span>&nbsp;<span class="ident" id="4059450">hash</span>&nbsp;<span class="op" id="4059455">==</span>&nbsp;<span class="num" id="4059458">0</span>&nbsp;<span class="op" id="4059460">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059464">return</span>&nbsp;<span class="ident" id="4059471">inLen</span><span class="op" id="4059476">,</span>&nbsp;<span class="ident" id="4059478">nil</span><span class="op" id="4059481">,</span>&nbsp;<span class="ident" id="4059483">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4059488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059492">hashLen</span>&nbsp;<span class="op" id="4059500">=</span>&nbsp;<span class="ident" id="4059502">hash</span><span class="op" id="4059506">.</span><span class="ident" id="4059507">Size</span><span class="op" id="4059511">(</span><span class="op" id="4059512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059515">if</span>&nbsp;<span class="ident" id="4059518">inLen</span>&nbsp;<span class="op" id="4059524">!=</span>&nbsp;<span class="ident" id="4059527">hashLen</span>&nbsp;<span class="op" id="4059535">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059539">return</span>&nbsp;<span class="num" id="4059546">0</span><span class="op" id="4059547">,</span>&nbsp;<span class="ident" id="4059549">nil</span><span class="op" id="4059552">,</span>&nbsp;<span class="ident" id="4059554">errors</span><span class="op" id="4059560">.</span><span class="ident" id="4059561">New</span><span class="op" id="4059564">(</span><span class="string" id="4059565">&#34;crypto/rsa:&nbsp;input&nbsp;must&nbsp;be&nbsp;hashed&nbsp;message&#34;</span><span class="op" id="4059607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4059610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059613">prefix</span><span class="op" id="4059619">,</span>&nbsp;<span class="ident" id="4059621">ok</span>&nbsp;<span class="op" id="4059624">:=</span>&nbsp;<span class="ident" id="4059627">hashPrefixes</span><span class="op" id="4059639">[</span><span class="ident" id="4059640">hash</span><span class="op" id="4059644">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059647">if</span>&nbsp;<span class="op" id="4059650">!</span><span class="ident" id="4059651">ok</span>&nbsp;<span class="op" id="4059654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059658">return</span>&nbsp;<span class="num" id="4059665">0</span><span class="op" id="4059666">,</span>&nbsp;<span class="ident" id="4059668">nil</span><span class="op" id="4059671">,</span>&nbsp;<span class="ident" id="4059673">errors</span><span class="op" id="4059679">.</span><span class="ident" id="4059680">New</span><span class="op" id="4059683">(</span><span class="string" id="4059684">&#34;crypto/rsa:&nbsp;unsupported&nbsp;hash&nbsp;function&#34;</span><span class="op" id="4059723">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4059726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059729">return</span><br>
<span class="lineno"></span><span class="op" id="4059736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4059739">//&nbsp;copyWithLeftPad&nbsp;copies&nbsp;src&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;dest,&nbsp;padding&nbsp;with&nbsp;zero&nbsp;bytes&nbsp;as</span><br>
<span class="lineno">285</span><span class="comment" id="4059816">//&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="4059827">func</span>&nbsp;<span class="ident" id="4059832">copyWithLeftPad</span><span class="op" id="4059847">(</span><span class="ident" id="4059848">dest</span><span class="op" id="4059852">,</span>&nbsp;<span class="ident" id="4059854">src</span>&nbsp;<span class="op" id="4059858">[</span><span class="op" id="4059859">]</span><span class="builtintype" id="4059860">byte</span><span class="op" id="4059864">)</span>&nbsp;<span class="op" id="4059866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059869">numPaddingBytes</span>&nbsp;<span class="op" id="4059885">:=</span>&nbsp;<span class="builtinfunc" id="4059888">len</span><span class="op" id="4059891">(</span><span class="ident" id="4059892">dest</span><span class="op" id="4059896">)</span>&nbsp;<span class="op" id="4059898">-</span>&nbsp;<span class="builtinfunc" id="4059900">len</span><span class="op" id="4059903">(</span><span class="ident" id="4059904">src</span><span class="op" id="4059907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059910">for</span>&nbsp;<span class="ident" id="4059914">i</span>&nbsp;<span class="op" id="4059916">:=</span>&nbsp;<span class="num" id="4059919">0</span><span class="op" id="4059920">;</span>&nbsp;<span class="ident" id="4059922">i</span>&nbsp;<span class="op" id="4059924">&lt;</span>&nbsp;<span class="ident" id="4059926">numPaddingBytes</span><span class="op" id="4059941">;</span>&nbsp;<span class="ident" id="4059943">i</span><span class="op" id="4059944">++</span>&nbsp;<span class="op" id="4059947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059951">dest</span><span class="op" id="4059955">[</span><span class="ident" id="4059956">i</span><span class="op" id="4059957">]</span>&nbsp;<span class="op" id="4059959">=</span>&nbsp;<span class="num" id="4059961">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4059964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4059967">copy</span><span class="op" id="4059971">(</span><span class="ident" id="4059972">dest</span><span class="op" id="4059976">[</span><span class="ident" id="4059977">numPaddingBytes</span><span class="op" id="4059992">:</span><span class="op" id="4059993">]</span><span class="op" id="4059994">,</span>&nbsp;<span class="ident" id="4059996">src</span><span class="op" id="4059999">)</span><br>
<span class="lineno"></span><span class="op" id="4060001">}</span>
</div>
</body>
</html>
