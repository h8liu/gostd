<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html" class="current">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2470395">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2470450">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2470504">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2470555">//&nbsp;+build&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2470572">package</span>&nbsp;<span class="ident" id="2470580">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2470589">import</span>&nbsp;<span class="op" id="2470596">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2470599">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2470608">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2470611">//&nbsp;SysProcIDMap&nbsp;holds&nbsp;Container&nbsp;ID&nbsp;to&nbsp;Host&nbsp;ID&nbsp;mappings&nbsp;used&nbsp;for&nbsp;User&nbsp;Namespaces&nbsp;in&nbsp;Linux.</span><br>
<span class="lineno"></span><span class="comment" id="2470701">//&nbsp;See&nbsp;user_namespaces(7).</span><br>
<span class="lineno">15</span><span class="keyword" id="2470728">type</span>&nbsp;<span class="ident" id="2470733">SysProcIDMap</span>&nbsp;<span class="keyword" id="2470746">struct</span>&nbsp;<span class="op" id="2470753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2470756">ContainerID</span>&nbsp;<span class="builtintype" id="2470768">int</span>&nbsp;<span class="comment" id="2470772">//&nbsp;Container&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2470790">HostID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2470802">int</span>&nbsp;<span class="comment" id="2470806">//&nbsp;Host&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2470819">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2470831">int</span>&nbsp;<span class="comment" id="2470835">//&nbsp;Size.</span><br>
<span class="lineno"></span><span class="op" id="2470844">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2470847">type</span>&nbsp;<span class="ident" id="2470852">SysProcAttr</span>&nbsp;<span class="keyword" id="2470864">struct</span>&nbsp;<span class="op" id="2470871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2470874">Chroot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2470886">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2470901">//&nbsp;Chroot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2470913">Credential</span>&nbsp;&nbsp;<span class="op" id="2470925">*</span><span class="ident" id="2470926">Credential</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2470940">//&nbsp;Credential.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2470956">Ptrace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2470968">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2470983">//&nbsp;Enable&nbsp;tracing.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2471003">Setsid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2471015">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2471030">//&nbsp;Create&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2471050">Setpgid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2471062">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2471077">//&nbsp;Set&nbsp;process&nbsp;group&nbsp;ID&nbsp;to&nbsp;new&nbsp;pid&nbsp;(SYSV&nbsp;setpgrp)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2471128">Setctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2471140">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2471155">//&nbsp;Set&nbsp;controlling&nbsp;terminal&nbsp;to&nbsp;fd&nbsp;Ctty&nbsp;(only&nbsp;meaningful&nbsp;if&nbsp;Setsid&nbsp;is&nbsp;set)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2471230">Noctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2471242">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2471257">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;controlling&nbsp;terminal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2471299">Ctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2471311">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2471326">//&nbsp;Controlling&nbsp;TTY&nbsp;fd&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2471362">Pdeathsig</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2471374">Signal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2471389">//&nbsp;Signal&nbsp;that&nbsp;the&nbsp;process&nbsp;will&nbsp;get&nbsp;when&nbsp;its&nbsp;parent&nbsp;dies&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2471460">Cloneflags</span>&nbsp;&nbsp;<span class="builtintype" id="2471472">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2471487">//&nbsp;Flags&nbsp;for&nbsp;clone&nbsp;calls&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2471526">UidMappings</span>&nbsp;<span class="op" id="2471538">[</span><span class="op" id="2471539">]</span><span class="ident" id="2471540">SysProcIDMap</span>&nbsp;<span class="comment" id="2471553">//&nbsp;User&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2471595">GidMappings</span>&nbsp;<span class="op" id="2471607">[</span><span class="op" id="2471608">]</span><span class="ident" id="2471609">SysProcIDMap</span>&nbsp;<span class="comment" id="2471622">//&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span><span class="op" id="2471664">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="2471667">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2471702">func</span>&nbsp;<span class="ident" id="2471707">runtime_BeforeFork</span><span class="op" id="2471725">(</span><span class="op" id="2471726">)</span><br>
<span class="lineno"></span><span class="keyword" id="2471728">func</span>&nbsp;<span class="ident" id="2471733">runtime_AfterFork</span><span class="op" id="2471750">(</span><span class="op" id="2471751">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2471754">//&nbsp;Fork,&nbsp;dup&nbsp;fd&nbsp;onto&nbsp;0..len(fd),&nbsp;and&nbsp;exec(argv0,&nbsp;argvv,&nbsp;envv)&nbsp;in&nbsp;child.</span><br>
<span class="lineno"></span><span class="comment" id="2471826">//&nbsp;If&nbsp;a&nbsp;dup&nbsp;or&nbsp;exec&nbsp;fails,&nbsp;write&nbsp;the&nbsp;errno&nbsp;error&nbsp;to&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="2471884">//&nbsp;(Pipe&nbsp;is&nbsp;close-on-exec&nbsp;so&nbsp;if&nbsp;exec&nbsp;succeeds,&nbsp;it&nbsp;will&nbsp;be&nbsp;closed.)</span><br>
<span class="lineno"></span><span class="comment" id="2471951">//&nbsp;In&nbsp;the&nbsp;child,&nbsp;this&nbsp;function&nbsp;must&nbsp;not&nbsp;acquire&nbsp;any&nbsp;locks,&nbsp;because</span><br>
<span class="lineno"></span><span class="comment" id="2472018">//&nbsp;they&nbsp;might&nbsp;have&nbsp;been&nbsp;locked&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;fork.&nbsp;&nbsp;This&nbsp;means</span><br>
<span class="lineno">45</span><span class="comment" id="2472086">//&nbsp;no&nbsp;rescheduling,&nbsp;no&nbsp;malloc&nbsp;calls,&nbsp;and&nbsp;no&nbsp;new&nbsp;stack&nbsp;segments.</span><br>
<span class="lineno"></span><span class="comment" id="2472150">//&nbsp;For&nbsp;the&nbsp;same&nbsp;reason&nbsp;compiler&nbsp;does&nbsp;not&nbsp;race&nbsp;instrument&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2472211">//&nbsp;The&nbsp;calls&nbsp;to&nbsp;RawSyscall&nbsp;are&nbsp;okay&nbsp;because&nbsp;they&nbsp;are&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="2472273">//&nbsp;functions&nbsp;that&nbsp;do&nbsp;not&nbsp;grow&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="2472314">func</span>&nbsp;<span class="ident" id="2472319">forkAndExecInChild</span><span class="op" id="2472337">(</span><span class="ident" id="2472338">argv0</span>&nbsp;<span class="op" id="2472344">*</span><span class="builtintype" id="2472345">byte</span><span class="op" id="2472349">,</span>&nbsp;<span class="ident" id="2472351">argv</span><span class="op" id="2472355">,</span>&nbsp;<span class="ident" id="2472357">envv</span>&nbsp;<span class="op" id="2472362">[</span><span class="op" id="2472363">]</span><span class="op" id="2472364">*</span><span class="builtintype" id="2472365">byte</span><span class="op" id="2472369">,</span>&nbsp;<span class="ident" id="2472371">chroot</span><span class="op" id="2472377">,</span>&nbsp;<span class="ident" id="2472379">dir</span>&nbsp;<span class="op" id="2472383">*</span><span class="builtintype" id="2472384">byte</span><span class="op" id="2472388">,</span>&nbsp;<span class="ident" id="2472390">attr</span>&nbsp;<span class="op" id="2472395">*</span><span class="ident" id="2472396">ProcAttr</span><span class="op" id="2472404">,</span>&nbsp;<span class="ident" id="2472406">sys</span>&nbsp;<span class="op" id="2472410">*</span><span class="ident" id="2472411">SysProcAttr</span><span class="op" id="2472422">,</span>&nbsp;<span class="ident" id="2472424">pipe</span>&nbsp;<span class="builtintype" id="2472429">int</span><span class="op" id="2472432">)</span>&nbsp;<span class="op" id="2472434">(</span><span class="ident" id="2472435">pid</span>&nbsp;<span class="builtintype" id="2472439">int</span><span class="op" id="2472442">,</span>&nbsp;<span class="ident" id="2472444">err</span>&nbsp;<span class="ident" id="2472448">Errno</span><span class="op" id="2472453">)</span>&nbsp;<span class="op" id="2472455">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2472458">//&nbsp;Declare&nbsp;all&nbsp;variables&nbsp;at&nbsp;top&nbsp;in&nbsp;case&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2472503">//&nbsp;declarations&nbsp;require&nbsp;heap&nbsp;allocation&nbsp;(e.g.,&nbsp;err1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2472558">var</span>&nbsp;<span class="op" id="2472562">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2472566">r1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2472573">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2472583">err1</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2472590">Errno</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2472598">err2</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2472605">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2472613">nextfd</span>&nbsp;<span class="builtintype" id="2472620">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2472626">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2472633">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2472639">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2472646">[</span><span class="num" id="2472647">2</span><span class="op" id="2472648">]</span><span class="builtintype" id="2472649">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2472654">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2472658">//&nbsp;Guard&nbsp;against&nbsp;side&nbsp;effects&nbsp;of&nbsp;shuffling&nbsp;fds&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2472713">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;nextfd&nbsp;is&nbsp;beyond&nbsp;any&nbsp;currently&nbsp;open&nbsp;files&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2472777">//&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;overwriting&nbsp;any&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2472836">fd</span>&nbsp;<span class="op" id="2472839">:=</span>&nbsp;<span class="builtinfunc" id="2472842">make</span><span class="op" id="2472846">(</span><span class="op" id="2472847">[</span><span class="op" id="2472848">]</span><span class="builtintype" id="2472849">int</span><span class="op" id="2472852">,</span>&nbsp;<span class="builtinfunc" id="2472854">len</span><span class="op" id="2472857">(</span><span class="ident" id="2472858">attr</span><span class="op" id="2472862">.</span><span class="ident" id="2472863">Files</span><span class="op" id="2472868">)</span><span class="op" id="2472869">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2472872">nextfd</span>&nbsp;<span class="op" id="2472879">=</span>&nbsp;<span class="builtinfunc" id="2472881">len</span><span class="op" id="2472884">(</span><span class="ident" id="2472885">attr</span><span class="op" id="2472889">.</span><span class="ident" id="2472890">Files</span><span class="op" id="2472895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2472898">for</span>&nbsp;<span class="ident" id="2472902">i</span><span class="op" id="2472903">,</span>&nbsp;<span class="ident" id="2472905">ufd</span>&nbsp;<span class="op" id="2472909">:=</span>&nbsp;<span class="keyword" id="2472912">range</span>&nbsp;<span class="ident" id="2472918">attr</span><span class="op" id="2472922">.</span><span class="ident" id="2472923">Files</span>&nbsp;<span class="op" id="2472929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2472933">if</span>&nbsp;<span class="ident" id="2472936">nextfd</span>&nbsp;<span class="op" id="2472943">&lt;</span>&nbsp;<span class="builtintype" id="2472945">int</span><span class="op" id="2472948">(</span><span class="ident" id="2472949">ufd</span><span class="op" id="2472952">)</span>&nbsp;<span class="op" id="2472954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2472959">nextfd</span>&nbsp;<span class="op" id="2472966">=</span>&nbsp;<span class="builtintype" id="2472968">int</span><span class="op" id="2472971">(</span><span class="ident" id="2472972">ufd</span><span class="op" id="2472975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2472979">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2472983">fd</span><span class="op" id="2472985">[</span><span class="ident" id="2472986">i</span><span class="op" id="2472987">]</span>&nbsp;<span class="op" id="2472989">=</span>&nbsp;<span class="builtintype" id="2472991">int</span><span class="op" id="2472994">(</span><span class="ident" id="2472995">ufd</span><span class="op" id="2472998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2473001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2473004">nextfd</span><span class="op" id="2473010">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2473015">//&nbsp;Allocate&nbsp;another&nbsp;pipe&nbsp;for&nbsp;parent&nbsp;to&nbsp;child&nbsp;communication&nbsp;for</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2473079">//&nbsp;synchronizing&nbsp;writing&nbsp;of&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2473135">if</span>&nbsp;<span class="ident" id="2473138">sys</span><span class="op" id="2473141">.</span><span class="ident" id="2473142">UidMappings</span>&nbsp;<span class="op" id="2473154">!=</span>&nbsp;<span class="builtintype" id="2473157">nil</span>&nbsp;<span class="op" id="2473161">||</span>&nbsp;<span class="ident" id="2473164">sys</span><span class="op" id="2473167">.</span><span class="ident" id="2473168">GidMappings</span>&nbsp;<span class="op" id="2473180">!=</span>&nbsp;<span class="builtintype" id="2473183">nil</span>&nbsp;<span class="op" id="2473187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2473191">if</span>&nbsp;<span class="ident" id="2473194">err</span>&nbsp;<span class="op" id="2473198">:=</span>&nbsp;<span class="ident" id="2473201">forkExecPipe</span><span class="op" id="2473213">(</span><span class="ident" id="2473214">p</span><span class="op" id="2473215">[</span><span class="op" id="2473216">:</span><span class="op" id="2473217">]</span><span class="op" id="2473218">)</span><span class="op" id="2473219">;</span>&nbsp;<span class="ident" id="2473221">err</span>&nbsp;<span class="op" id="2473225">!=</span>&nbsp;<span class="builtintype" id="2473228">nil</span>&nbsp;<span class="op" id="2473232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2473237">return</span>&nbsp;<span class="num" id="2473244">0</span><span class="op" id="2473245">,</span>&nbsp;<span class="ident" id="2473247">err</span><span class="op" id="2473250">.</span><span class="op" id="2473251">(</span><span class="ident" id="2473252">Errno</span><span class="op" id="2473257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2473261">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2473264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2473268">//&nbsp;About&nbsp;to&nbsp;call&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2473292">//&nbsp;No&nbsp;more&nbsp;allocation&nbsp;or&nbsp;calls&nbsp;of&nbsp;non-assembly&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2473351">runtime_BeforeFork</span><span class="op" id="2473369">(</span><span class="op" id="2473370">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2473373">r1</span><span class="op" id="2473375">,</span>&nbsp;<span class="ident" id="2473377">_</span><span class="op" id="2473378">,</span>&nbsp;<span class="ident" id="2473380">err1</span>&nbsp;<span class="op" id="2473385">=</span>&nbsp;<span class="ident" id="2473387">RawSyscall6</span><span class="op" id="2473398">(</span><span class="ident" id="2473399">SYS_CLONE</span><span class="op" id="2473408">,</span>&nbsp;<span class="builtintype" id="2473410">uintptr</span><span class="op" id="2473417">(</span><span class="ident" id="2473418">SIGCHLD</span><span class="op" id="2473425">)</span><span class="op" id="2473426">|</span><span class="ident" id="2473427">sys</span><span class="op" id="2473430">.</span><span class="ident" id="2473431">Cloneflags</span><span class="op" id="2473441">,</span>&nbsp;<span class="num" id="2473443">0</span><span class="op" id="2473444">,</span>&nbsp;<span class="num" id="2473446">0</span><span class="op" id="2473447">,</span>&nbsp;<span class="num" id="2473449">0</span><span class="op" id="2473450">,</span>&nbsp;<span class="num" id="2473452">0</span><span class="op" id="2473453">,</span>&nbsp;<span class="num" id="2473455">0</span><span class="op" id="2473456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2473459">if</span>&nbsp;<span class="ident" id="2473462">err1</span>&nbsp;<span class="op" id="2473467">!=</span>&nbsp;<span class="num" id="2473470">0</span>&nbsp;<span class="op" id="2473472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2473476">runtime_AfterFork</span><span class="op" id="2473493">(</span><span class="op" id="2473494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2473498">return</span>&nbsp;<span class="num" id="2473505">0</span><span class="op" id="2473506">,</span>&nbsp;<span class="ident" id="2473508">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2473514">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2473518">if</span>&nbsp;<span class="ident" id="2473521">r1</span>&nbsp;<span class="op" id="2473524">!=</span>&nbsp;<span class="num" id="2473527">0</span>&nbsp;<span class="op" id="2473529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2473533">//&nbsp;parent;&nbsp;return&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2473557">runtime_AfterFork</span><span class="op" id="2473574">(</span><span class="op" id="2473575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2473579">pid</span>&nbsp;<span class="op" id="2473583">=</span>&nbsp;<span class="builtintype" id="2473585">int</span><span class="op" id="2473588">(</span><span class="ident" id="2473589">r1</span><span class="op" id="2473591">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2473596">if</span>&nbsp;<span class="ident" id="2473599">sys</span><span class="op" id="2473602">.</span><span class="ident" id="2473603">UidMappings</span>&nbsp;<span class="op" id="2473615">!=</span>&nbsp;<span class="builtintype" id="2473618">nil</span>&nbsp;<span class="op" id="2473622">||</span>&nbsp;<span class="ident" id="2473625">sys</span><span class="op" id="2473628">.</span><span class="ident" id="2473629">GidMappings</span>&nbsp;<span class="op" id="2473641">!=</span>&nbsp;<span class="builtintype" id="2473644">nil</span>&nbsp;<span class="op" id="2473648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2473653">Close</span><span class="op" id="2473658">(</span><span class="ident" id="2473659">p</span><span class="op" id="2473660">[</span><span class="num" id="2473661">0</span><span class="op" id="2473662">]</span><span class="op" id="2473663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2473668">err</span>&nbsp;<span class="op" id="2473672">:=</span>&nbsp;<span class="ident" id="2473675">writeUidGidMappings</span><span class="op" id="2473694">(</span><span class="ident" id="2473695">pid</span><span class="op" id="2473698">,</span>&nbsp;<span class="ident" id="2473700">sys</span><span class="op" id="2473703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2473708">if</span>&nbsp;<span class="ident" id="2473711">err</span>&nbsp;<span class="op" id="2473715">!=</span>&nbsp;<span class="builtintype" id="2473718">nil</span>&nbsp;<span class="op" id="2473722">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2473728">err2</span>&nbsp;<span class="op" id="2473733">=</span>&nbsp;<span class="ident" id="2473735">err</span><span class="op" id="2473738">.</span><span class="op" id="2473739">(</span><span class="ident" id="2473740">Errno</span><span class="op" id="2473745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2473750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2473755">RawSyscall</span><span class="op" id="2473765">(</span><span class="ident" id="2473766">SYS_WRITE</span><span class="op" id="2473775">,</span>&nbsp;<span class="builtintype" id="2473777">uintptr</span><span class="op" id="2473784">(</span><span class="ident" id="2473785">p</span><span class="op" id="2473786">[</span><span class="num" id="2473787">1</span><span class="op" id="2473788">]</span><span class="op" id="2473789">)</span><span class="op" id="2473790">,</span>&nbsp;<span class="builtintype" id="2473792">uintptr</span><span class="op" id="2473799">(</span><span class="ident" id="2473800">unsafe</span><span class="op" id="2473806">.</span><span class="ident" id="2473807">Pointer</span><span class="op" id="2473814">(</span><span class="op" id="2473815">&amp;</span><span class="ident" id="2473816">err2</span><span class="op" id="2473820">)</span><span class="op" id="2473821">)</span><span class="op" id="2473822">,</span>&nbsp;<span class="ident" id="2473824">unsafe</span><span class="op" id="2473830">.</span><span class="ident" id="2473831">Sizeof</span><span class="op" id="2473837">(</span><span class="ident" id="2473838">err2</span><span class="op" id="2473842">)</span><span class="op" id="2473843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2473848">Close</span><span class="op" id="2473853">(</span><span class="ident" id="2473854">p</span><span class="op" id="2473855">[</span><span class="num" id="2473856">1</span><span class="op" id="2473857">]</span><span class="op" id="2473858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2473862">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2473867">return</span>&nbsp;<span class="ident" id="2473874">pid</span><span class="op" id="2473877">,</span>&nbsp;<span class="num" id="2473879">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2473882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2473886">//&nbsp;Fork&nbsp;succeeded,&nbsp;now&nbsp;in&nbsp;child.</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2473921">//&nbsp;Wait&nbsp;for&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;be&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2473975">if</span>&nbsp;<span class="ident" id="2473978">sys</span><span class="op" id="2473981">.</span><span class="ident" id="2473982">UidMappings</span>&nbsp;<span class="op" id="2473994">!=</span>&nbsp;<span class="builtintype" id="2473997">nil</span>&nbsp;<span class="op" id="2474001">||</span>&nbsp;<span class="ident" id="2474004">sys</span><span class="op" id="2474007">.</span><span class="ident" id="2474008">GidMappings</span>&nbsp;<span class="op" id="2474020">!=</span>&nbsp;<span class="builtintype" id="2474023">nil</span>&nbsp;<span class="op" id="2474027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474031">if</span>&nbsp;<span class="ident" id="2474034">_</span><span class="op" id="2474035">,</span>&nbsp;<span class="ident" id="2474037">_</span><span class="op" id="2474038">,</span>&nbsp;<span class="ident" id="2474040">err1</span>&nbsp;<span class="op" id="2474045">=</span>&nbsp;<span class="ident" id="2474047">RawSyscall</span><span class="op" id="2474057">(</span><span class="ident" id="2474058">SYS_CLOSE</span><span class="op" id="2474067">,</span>&nbsp;<span class="builtintype" id="2474069">uintptr</span><span class="op" id="2474076">(</span><span class="ident" id="2474077">p</span><span class="op" id="2474078">[</span><span class="num" id="2474079">1</span><span class="op" id="2474080">]</span><span class="op" id="2474081">)</span><span class="op" id="2474082">,</span>&nbsp;<span class="num" id="2474084">0</span><span class="op" id="2474085">,</span>&nbsp;<span class="num" id="2474087">0</span><span class="op" id="2474088">)</span><span class="op" id="2474089">;</span>&nbsp;<span class="ident" id="2474091">err1</span>&nbsp;<span class="op" id="2474096">!=</span>&nbsp;<span class="num" id="2474099">0</span>&nbsp;<span class="op" id="2474101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474106">goto</span>&nbsp;<span class="ident" id="2474111">childerror</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2474124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2474128">r1</span><span class="op" id="2474130">,</span>&nbsp;<span class="ident" id="2474132">_</span><span class="op" id="2474133">,</span>&nbsp;<span class="ident" id="2474135">err1</span>&nbsp;<span class="op" id="2474140">=</span>&nbsp;<span class="ident" id="2474142">RawSyscall</span><span class="op" id="2474152">(</span><span class="ident" id="2474153">SYS_READ</span><span class="op" id="2474161">,</span>&nbsp;<span class="builtintype" id="2474163">uintptr</span><span class="op" id="2474170">(</span><span class="ident" id="2474171">p</span><span class="op" id="2474172">[</span><span class="num" id="2474173">0</span><span class="op" id="2474174">]</span><span class="op" id="2474175">)</span><span class="op" id="2474176">,</span>&nbsp;<span class="builtintype" id="2474178">uintptr</span><span class="op" id="2474185">(</span><span class="ident" id="2474186">unsafe</span><span class="op" id="2474192">.</span><span class="ident" id="2474193">Pointer</span><span class="op" id="2474200">(</span><span class="op" id="2474201">&amp;</span><span class="ident" id="2474202">err2</span><span class="op" id="2474206">)</span><span class="op" id="2474207">)</span><span class="op" id="2474208">,</span>&nbsp;<span class="ident" id="2474210">unsafe</span><span class="op" id="2474216">.</span><span class="ident" id="2474217">Sizeof</span><span class="op" id="2474223">(</span><span class="ident" id="2474224">err2</span><span class="op" id="2474228">)</span><span class="op" id="2474229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474233">if</span>&nbsp;<span class="ident" id="2474236">err1</span>&nbsp;<span class="op" id="2474241">!=</span>&nbsp;<span class="num" id="2474244">0</span>&nbsp;<span class="op" id="2474246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474251">goto</span>&nbsp;<span class="ident" id="2474256">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2474269">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474273">if</span>&nbsp;<span class="ident" id="2474276">r1</span>&nbsp;<span class="op" id="2474279">!=</span>&nbsp;<span class="ident" id="2474282">unsafe</span><span class="op" id="2474288">.</span><span class="ident" id="2474289">Sizeof</span><span class="op" id="2474295">(</span><span class="ident" id="2474296">err2</span><span class="op" id="2474300">)</span>&nbsp;<span class="op" id="2474302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2474307">err1</span>&nbsp;<span class="op" id="2474312">=</span>&nbsp;<span class="ident" id="2474314">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474324">goto</span>&nbsp;<span class="ident" id="2474329">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2474342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474346">if</span>&nbsp;<span class="ident" id="2474349">err2</span>&nbsp;<span class="op" id="2474354">!=</span>&nbsp;<span class="num" id="2474357">0</span>&nbsp;<span class="op" id="2474359">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2474364">err1</span>&nbsp;<span class="op" id="2474369">=</span>&nbsp;<span class="ident" id="2474371">err2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474379">goto</span>&nbsp;<span class="ident" id="2474384">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2474397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2474400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2474404">//&nbsp;Parent&nbsp;death&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474428">if</span>&nbsp;<span class="ident" id="2474431">sys</span><span class="op" id="2474434">.</span><span class="ident" id="2474435">Pdeathsig</span>&nbsp;<span class="op" id="2474445">!=</span>&nbsp;<span class="num" id="2474448">0</span>&nbsp;<span class="op" id="2474450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2474454">_</span><span class="op" id="2474455">,</span>&nbsp;<span class="ident" id="2474457">_</span><span class="op" id="2474458">,</span>&nbsp;<span class="ident" id="2474460">err1</span>&nbsp;<span class="op" id="2474465">=</span>&nbsp;<span class="ident" id="2474467">RawSyscall6</span><span class="op" id="2474478">(</span><span class="ident" id="2474479">SYS_PRCTL</span><span class="op" id="2474488">,</span>&nbsp;<span class="ident" id="2474490">PR_SET_PDEATHSIG</span><span class="op" id="2474506">,</span>&nbsp;<span class="builtintype" id="2474508">uintptr</span><span class="op" id="2474515">(</span><span class="ident" id="2474516">sys</span><span class="op" id="2474519">.</span><span class="ident" id="2474520">Pdeathsig</span><span class="op" id="2474529">)</span><span class="op" id="2474530">,</span>&nbsp;<span class="num" id="2474532">0</span><span class="op" id="2474533">,</span>&nbsp;<span class="num" id="2474535">0</span><span class="op" id="2474536">,</span>&nbsp;<span class="num" id="2474538">0</span><span class="op" id="2474539">,</span>&nbsp;<span class="num" id="2474541">0</span><span class="op" id="2474542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474546">if</span>&nbsp;<span class="ident" id="2474549">err1</span>&nbsp;<span class="op" id="2474554">!=</span>&nbsp;<span class="num" id="2474557">0</span>&nbsp;<span class="op" id="2474559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474564">goto</span>&nbsp;<span class="ident" id="2474569">childerror</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2474582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2474587">//&nbsp;Signal&nbsp;self&nbsp;if&nbsp;parent&nbsp;is&nbsp;already&nbsp;dead.&nbsp;This&nbsp;might&nbsp;cause&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2474650">//&nbsp;duplicate&nbsp;signal&nbsp;in&nbsp;rare&nbsp;cases,&nbsp;but&nbsp;it&nbsp;won&#39;t&nbsp;matter&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2474712">//&nbsp;using&nbsp;SIGKILL.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2474732">r1</span><span class="op" id="2474734">,</span>&nbsp;<span class="ident" id="2474736">_</span><span class="op" id="2474737">,</span>&nbsp;<span class="ident" id="2474739">_</span>&nbsp;<span class="op" id="2474741">=</span>&nbsp;<span class="ident" id="2474743">RawSyscall</span><span class="op" id="2474753">(</span><span class="ident" id="2474754">SYS_GETPPID</span><span class="op" id="2474765">,</span>&nbsp;<span class="num" id="2474767">0</span><span class="op" id="2474768">,</span>&nbsp;<span class="num" id="2474770">0</span><span class="op" id="2474771">,</span>&nbsp;<span class="num" id="2474773">0</span><span class="op" id="2474774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474778">if</span>&nbsp;<span class="ident" id="2474781">r1</span>&nbsp;<span class="op" id="2474784">==</span>&nbsp;<span class="num" id="2474787">1</span>&nbsp;<span class="op" id="2474789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2474794">pid</span><span class="op" id="2474797">,</span>&nbsp;<span class="ident" id="2474799">_</span><span class="op" id="2474800">,</span>&nbsp;<span class="ident" id="2474802">_</span>&nbsp;<span class="op" id="2474804">:=</span>&nbsp;<span class="ident" id="2474807">RawSyscall</span><span class="op" id="2474817">(</span><span class="ident" id="2474818">SYS_GETPID</span><span class="op" id="2474828">,</span>&nbsp;<span class="num" id="2474830">0</span><span class="op" id="2474831">,</span>&nbsp;<span class="num" id="2474833">0</span><span class="op" id="2474834">,</span>&nbsp;<span class="num" id="2474836">0</span><span class="op" id="2474837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2474842">_</span><span class="op" id="2474843">,</span>&nbsp;<span class="ident" id="2474845">_</span><span class="op" id="2474846">,</span>&nbsp;<span class="ident" id="2474848">err1</span>&nbsp;<span class="op" id="2474853">:=</span>&nbsp;<span class="ident" id="2474856">RawSyscall</span><span class="op" id="2474866">(</span><span class="ident" id="2474867">SYS_KILL</span><span class="op" id="2474875">,</span>&nbsp;<span class="ident" id="2474877">pid</span><span class="op" id="2474880">,</span>&nbsp;<span class="builtintype" id="2474882">uintptr</span><span class="op" id="2474889">(</span><span class="ident" id="2474890">sys</span><span class="op" id="2474893">.</span><span class="ident" id="2474894">Pdeathsig</span><span class="op" id="2474903">)</span><span class="op" id="2474904">,</span>&nbsp;<span class="num" id="2474906">0</span><span class="op" id="2474907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474912">if</span>&nbsp;<span class="ident" id="2474915">err1</span>&nbsp;<span class="op" id="2474920">!=</span>&nbsp;<span class="num" id="2474923">0</span>&nbsp;<span class="op" id="2474925">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474931">goto</span>&nbsp;<span class="ident" id="2474936">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2474950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2474954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2474957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2474961">//&nbsp;Enable&nbsp;tracing&nbsp;if&nbsp;requested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2474994">if</span>&nbsp;<span class="ident" id="2474997">sys</span><span class="op" id="2475000">.</span><span class="ident" id="2475001">Ptrace</span>&nbsp;<span class="op" id="2475008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2475012">_</span><span class="op" id="2475013">,</span>&nbsp;<span class="ident" id="2475015">_</span><span class="op" id="2475016">,</span>&nbsp;<span class="ident" id="2475018">err1</span>&nbsp;<span class="op" id="2475023">=</span>&nbsp;<span class="ident" id="2475025">RawSyscall</span><span class="op" id="2475035">(</span><span class="ident" id="2475036">SYS_PTRACE</span><span class="op" id="2475046">,</span>&nbsp;<span class="builtintype" id="2475048">uintptr</span><span class="op" id="2475055">(</span><span class="ident" id="2475056">PTRACE_TRACEME</span><span class="op" id="2475070">)</span><span class="op" id="2475071">,</span>&nbsp;<span class="num" id="2475073">0</span><span class="op" id="2475074">,</span>&nbsp;<span class="num" id="2475076">0</span><span class="op" id="2475077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475081">if</span>&nbsp;<span class="ident" id="2475084">err1</span>&nbsp;<span class="op" id="2475089">!=</span>&nbsp;<span class="num" id="2475092">0</span>&nbsp;<span class="op" id="2475094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475099">goto</span>&nbsp;<span class="ident" id="2475104">childerror</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2475117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2475120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2475124">//&nbsp;Session&nbsp;ID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475139">if</span>&nbsp;<span class="ident" id="2475142">sys</span><span class="op" id="2475145">.</span><span class="ident" id="2475146">Setsid</span>&nbsp;<span class="op" id="2475153">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2475157">_</span><span class="op" id="2475158">,</span>&nbsp;<span class="ident" id="2475160">_</span><span class="op" id="2475161">,</span>&nbsp;<span class="ident" id="2475163">err1</span>&nbsp;<span class="op" id="2475168">=</span>&nbsp;<span class="ident" id="2475170">RawSyscall</span><span class="op" id="2475180">(</span><span class="ident" id="2475181">SYS_SETSID</span><span class="op" id="2475191">,</span>&nbsp;<span class="num" id="2475193">0</span><span class="op" id="2475194">,</span>&nbsp;<span class="num" id="2475196">0</span><span class="op" id="2475197">,</span>&nbsp;<span class="num" id="2475199">0</span><span class="op" id="2475200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475204">if</span>&nbsp;<span class="ident" id="2475207">err1</span>&nbsp;<span class="op" id="2475212">!=</span>&nbsp;<span class="num" id="2475215">0</span>&nbsp;<span class="op" id="2475217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475222">goto</span>&nbsp;<span class="ident" id="2475227">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2475240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2475243">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2475247">//&nbsp;Set&nbsp;process&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475269">if</span>&nbsp;<span class="ident" id="2475272">sys</span><span class="op" id="2475275">.</span><span class="ident" id="2475276">Setpgid</span>&nbsp;<span class="op" id="2475284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2475288">_</span><span class="op" id="2475289">,</span>&nbsp;<span class="ident" id="2475291">_</span><span class="op" id="2475292">,</span>&nbsp;<span class="ident" id="2475294">err1</span>&nbsp;<span class="op" id="2475299">=</span>&nbsp;<span class="ident" id="2475301">RawSyscall</span><span class="op" id="2475311">(</span><span class="ident" id="2475312">SYS_SETPGID</span><span class="op" id="2475323">,</span>&nbsp;<span class="num" id="2475325">0</span><span class="op" id="2475326">,</span>&nbsp;<span class="num" id="2475328">0</span><span class="op" id="2475329">,</span>&nbsp;<span class="num" id="2475331">0</span><span class="op" id="2475332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475336">if</span>&nbsp;<span class="ident" id="2475339">err1</span>&nbsp;<span class="op" id="2475344">!=</span>&nbsp;<span class="num" id="2475347">0</span>&nbsp;<span class="op" id="2475349">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475354">goto</span>&nbsp;<span class="ident" id="2475359">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2475372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2475375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2475379">//&nbsp;Chroot</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475390">if</span>&nbsp;<span class="ident" id="2475393">chroot</span>&nbsp;<span class="op" id="2475400">!=</span>&nbsp;<span class="builtintype" id="2475403">nil</span>&nbsp;<span class="op" id="2475407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2475411">_</span><span class="op" id="2475412">,</span>&nbsp;<span class="ident" id="2475414">_</span><span class="op" id="2475415">,</span>&nbsp;<span class="ident" id="2475417">err1</span>&nbsp;<span class="op" id="2475422">=</span>&nbsp;<span class="ident" id="2475424">RawSyscall</span><span class="op" id="2475434">(</span><span class="ident" id="2475435">SYS_CHROOT</span><span class="op" id="2475445">,</span>&nbsp;<span class="builtintype" id="2475447">uintptr</span><span class="op" id="2475454">(</span><span class="ident" id="2475455">unsafe</span><span class="op" id="2475461">.</span><span class="ident" id="2475462">Pointer</span><span class="op" id="2475469">(</span><span class="ident" id="2475470">chroot</span><span class="op" id="2475476">)</span><span class="op" id="2475477">)</span><span class="op" id="2475478">,</span>&nbsp;<span class="num" id="2475480">0</span><span class="op" id="2475481">,</span>&nbsp;<span class="num" id="2475483">0</span><span class="op" id="2475484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475488">if</span>&nbsp;<span class="ident" id="2475491">err1</span>&nbsp;<span class="op" id="2475496">!=</span>&nbsp;<span class="num" id="2475499">0</span>&nbsp;<span class="op" id="2475501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475506">goto</span>&nbsp;<span class="ident" id="2475511">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2475524">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2475527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2475531">//&nbsp;User&nbsp;and&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475551">if</span>&nbsp;<span class="ident" id="2475554">cred</span>&nbsp;<span class="op" id="2475559">:=</span>&nbsp;<span class="ident" id="2475562">sys</span><span class="op" id="2475565">.</span><span class="ident" id="2475566">Credential</span><span class="op" id="2475576">;</span>&nbsp;<span class="ident" id="2475578">cred</span>&nbsp;<span class="op" id="2475583">!=</span>&nbsp;<span class="builtintype" id="2475586">nil</span>&nbsp;<span class="op" id="2475590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2475594">ngroups</span>&nbsp;<span class="op" id="2475602">:=</span>&nbsp;<span class="builtintype" id="2475605">uintptr</span><span class="op" id="2475612">(</span><span class="builtinfunc" id="2475613">len</span><span class="op" id="2475616">(</span><span class="ident" id="2475617">cred</span><span class="op" id="2475621">.</span><span class="ident" id="2475622">Groups</span><span class="op" id="2475628">)</span><span class="op" id="2475629">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475633">var</span>&nbsp;<span class="ident" id="2475637">groups</span>&nbsp;<span class="ident" id="2475644">unsafe</span><span class="op" id="2475650">.</span><span class="ident" id="2475651">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475661">if</span>&nbsp;<span class="ident" id="2475664">ngroups</span>&nbsp;<span class="op" id="2475672">&gt;</span>&nbsp;<span class="num" id="2475674">0</span>&nbsp;<span class="op" id="2475676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2475681">groups</span>&nbsp;<span class="op" id="2475688">=</span>&nbsp;<span class="ident" id="2475690">unsafe</span><span class="op" id="2475696">.</span><span class="ident" id="2475697">Pointer</span><span class="op" id="2475704">(</span><span class="op" id="2475705">&amp;</span><span class="ident" id="2475706">cred</span><span class="op" id="2475710">.</span><span class="ident" id="2475711">Groups</span><span class="op" id="2475717">[</span><span class="num" id="2475718">0</span><span class="op" id="2475719">]</span><span class="op" id="2475720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2475724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2475728">_</span><span class="op" id="2475729">,</span>&nbsp;<span class="ident" id="2475731">_</span><span class="op" id="2475732">,</span>&nbsp;<span class="ident" id="2475734">err1</span>&nbsp;<span class="op" id="2475739">=</span>&nbsp;<span class="ident" id="2475741">RawSyscall</span><span class="op" id="2475751">(</span><span class="ident" id="2475752">SYS_SETGROUPS</span><span class="op" id="2475765">,</span>&nbsp;<span class="ident" id="2475767">ngroups</span><span class="op" id="2475774">,</span>&nbsp;<span class="builtintype" id="2475776">uintptr</span><span class="op" id="2475783">(</span><span class="ident" id="2475784">groups</span><span class="op" id="2475790">)</span><span class="op" id="2475791">,</span>&nbsp;<span class="num" id="2475793">0</span><span class="op" id="2475794">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475798">if</span>&nbsp;<span class="ident" id="2475801">err1</span>&nbsp;<span class="op" id="2475806">!=</span>&nbsp;<span class="num" id="2475809">0</span>&nbsp;<span class="op" id="2475811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475816">goto</span>&nbsp;<span class="ident" id="2475821">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2475834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2475838">_</span><span class="op" id="2475839">,</span>&nbsp;<span class="ident" id="2475841">_</span><span class="op" id="2475842">,</span>&nbsp;<span class="ident" id="2475844">err1</span>&nbsp;<span class="op" id="2475849">=</span>&nbsp;<span class="ident" id="2475851">RawSyscall</span><span class="op" id="2475861">(</span><span class="ident" id="2475862">SYS_SETGID</span><span class="op" id="2475872">,</span>&nbsp;<span class="builtintype" id="2475874">uintptr</span><span class="op" id="2475881">(</span><span class="ident" id="2475882">cred</span><span class="op" id="2475886">.</span><span class="ident" id="2475887">Gid</span><span class="op" id="2475890">)</span><span class="op" id="2475891">,</span>&nbsp;<span class="num" id="2475893">0</span><span class="op" id="2475894">,</span>&nbsp;<span class="num" id="2475896">0</span><span class="op" id="2475897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475901">if</span>&nbsp;<span class="ident" id="2475904">err1</span>&nbsp;<span class="op" id="2475909">!=</span>&nbsp;<span class="num" id="2475912">0</span>&nbsp;<span class="op" id="2475914">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2475919">goto</span>&nbsp;<span class="ident" id="2475924">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2475937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2475941">_</span><span class="op" id="2475942">,</span>&nbsp;<span class="ident" id="2475944">_</span><span class="op" id="2475945">,</span>&nbsp;<span class="ident" id="2475947">err1</span>&nbsp;<span class="op" id="2475952">=</span>&nbsp;<span class="ident" id="2475954">RawSyscall</span><span class="op" id="2475964">(</span><span class="ident" id="2475965">SYS_SETUID</span><span class="op" id="2475975">,</span>&nbsp;<span class="builtintype" id="2475977">uintptr</span><span class="op" id="2475984">(</span><span class="ident" id="2475985">cred</span><span class="op" id="2475989">.</span><span class="ident" id="2475990">Uid</span><span class="op" id="2475993">)</span><span class="op" id="2475994">,</span>&nbsp;<span class="num" id="2475996">0</span><span class="op" id="2475997">,</span>&nbsp;<span class="num" id="2475999">0</span><span class="op" id="2476000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476004">if</span>&nbsp;<span class="ident" id="2476007">err1</span>&nbsp;<span class="op" id="2476012">!=</span>&nbsp;<span class="num" id="2476015">0</span>&nbsp;<span class="op" id="2476017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476022">goto</span>&nbsp;<span class="ident" id="2476027">childerror</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2476040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2476043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2476047">//&nbsp;Chdir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476057">if</span>&nbsp;<span class="ident" id="2476060">dir</span>&nbsp;<span class="op" id="2476064">!=</span>&nbsp;<span class="builtintype" id="2476067">nil</span>&nbsp;<span class="op" id="2476071">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2476075">_</span><span class="op" id="2476076">,</span>&nbsp;<span class="ident" id="2476078">_</span><span class="op" id="2476079">,</span>&nbsp;<span class="ident" id="2476081">err1</span>&nbsp;<span class="op" id="2476086">=</span>&nbsp;<span class="ident" id="2476088">RawSyscall</span><span class="op" id="2476098">(</span><span class="ident" id="2476099">SYS_CHDIR</span><span class="op" id="2476108">,</span>&nbsp;<span class="builtintype" id="2476110">uintptr</span><span class="op" id="2476117">(</span><span class="ident" id="2476118">unsafe</span><span class="op" id="2476124">.</span><span class="ident" id="2476125">Pointer</span><span class="op" id="2476132">(</span><span class="ident" id="2476133">dir</span><span class="op" id="2476136">)</span><span class="op" id="2476137">)</span><span class="op" id="2476138">,</span>&nbsp;<span class="num" id="2476140">0</span><span class="op" id="2476141">,</span>&nbsp;<span class="num" id="2476143">0</span><span class="op" id="2476144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476148">if</span>&nbsp;<span class="ident" id="2476151">err1</span>&nbsp;<span class="op" id="2476156">!=</span>&nbsp;<span class="num" id="2476159">0</span>&nbsp;<span class="op" id="2476161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476166">goto</span>&nbsp;<span class="ident" id="2476171">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2476184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2476187">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2476191">//&nbsp;Pass&nbsp;1:&nbsp;look&nbsp;for&nbsp;fd[i]&nbsp;&lt;&nbsp;i&nbsp;and&nbsp;move&nbsp;those&nbsp;up&nbsp;above&nbsp;len(fd)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2476254">//&nbsp;so&nbsp;that&nbsp;pass&nbsp;2&nbsp;won&#39;t&nbsp;stomp&nbsp;on&nbsp;an&nbsp;fd&nbsp;it&nbsp;needs&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476310">if</span>&nbsp;<span class="ident" id="2476313">pipe</span>&nbsp;<span class="op" id="2476318">&lt;</span>&nbsp;<span class="ident" id="2476320">nextfd</span>&nbsp;<span class="op" id="2476327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2476331">_</span><span class="op" id="2476332">,</span>&nbsp;<span class="ident" id="2476334">_</span><span class="op" id="2476335">,</span>&nbsp;<span class="ident" id="2476337">err1</span>&nbsp;<span class="op" id="2476342">=</span>&nbsp;<span class="ident" id="2476344">RawSyscall</span><span class="op" id="2476354">(</span><span class="ident" id="2476355">SYS_DUP2</span><span class="op" id="2476363">,</span>&nbsp;<span class="builtintype" id="2476365">uintptr</span><span class="op" id="2476372">(</span><span class="ident" id="2476373">pipe</span><span class="op" id="2476377">)</span><span class="op" id="2476378">,</span>&nbsp;<span class="builtintype" id="2476380">uintptr</span><span class="op" id="2476387">(</span><span class="ident" id="2476388">nextfd</span><span class="op" id="2476394">)</span><span class="op" id="2476395">,</span>&nbsp;<span class="num" id="2476397">0</span><span class="op" id="2476398">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476402">if</span>&nbsp;<span class="ident" id="2476405">err1</span>&nbsp;<span class="op" id="2476410">!=</span>&nbsp;<span class="num" id="2476413">0</span>&nbsp;<span class="op" id="2476415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476420">goto</span>&nbsp;<span class="ident" id="2476425">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2476438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2476442">RawSyscall</span><span class="op" id="2476452">(</span><span class="ident" id="2476453">SYS_FCNTL</span><span class="op" id="2476462">,</span>&nbsp;<span class="builtintype" id="2476464">uintptr</span><span class="op" id="2476471">(</span><span class="ident" id="2476472">nextfd</span><span class="op" id="2476478">)</span><span class="op" id="2476479">,</span>&nbsp;<span class="ident" id="2476481">F_SETFD</span><span class="op" id="2476488">,</span>&nbsp;<span class="ident" id="2476490">FD_CLOEXEC</span><span class="op" id="2476500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2476504">pipe</span>&nbsp;<span class="op" id="2476509">=</span>&nbsp;<span class="ident" id="2476511">nextfd</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2476520">nextfd</span><span class="op" id="2476526">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2476530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476533">for</span>&nbsp;<span class="ident" id="2476537">i</span>&nbsp;<span class="op" id="2476539">=</span>&nbsp;<span class="num" id="2476541">0</span><span class="op" id="2476542">;</span>&nbsp;<span class="ident" id="2476544">i</span>&nbsp;<span class="op" id="2476546">&lt;</span>&nbsp;<span class="builtinfunc" id="2476548">len</span><span class="op" id="2476551">(</span><span class="ident" id="2476552">fd</span><span class="op" id="2476554">)</span><span class="op" id="2476555">;</span>&nbsp;<span class="ident" id="2476557">i</span><span class="op" id="2476558">++</span>&nbsp;<span class="op" id="2476561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476565">if</span>&nbsp;<span class="ident" id="2476568">fd</span><span class="op" id="2476570">[</span><span class="ident" id="2476571">i</span><span class="op" id="2476572">]</span>&nbsp;<span class="op" id="2476574">&gt;=</span>&nbsp;<span class="num" id="2476577">0</span>&nbsp;<span class="op" id="2476579">&amp;&amp;</span>&nbsp;<span class="ident" id="2476582">fd</span><span class="op" id="2476584">[</span><span class="ident" id="2476585">i</span><span class="op" id="2476586">]</span>&nbsp;<span class="op" id="2476588">&lt;</span>&nbsp;<span class="builtintype" id="2476590">int</span><span class="op" id="2476593">(</span><span class="ident" id="2476594">i</span><span class="op" id="2476595">)</span>&nbsp;<span class="op" id="2476597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2476602">_</span><span class="op" id="2476603">,</span>&nbsp;<span class="ident" id="2476605">_</span><span class="op" id="2476606">,</span>&nbsp;<span class="ident" id="2476608">err1</span>&nbsp;<span class="op" id="2476613">=</span>&nbsp;<span class="ident" id="2476615">RawSyscall</span><span class="op" id="2476625">(</span><span class="ident" id="2476626">SYS_DUP2</span><span class="op" id="2476634">,</span>&nbsp;<span class="builtintype" id="2476636">uintptr</span><span class="op" id="2476643">(</span><span class="ident" id="2476644">fd</span><span class="op" id="2476646">[</span><span class="ident" id="2476647">i</span><span class="op" id="2476648">]</span><span class="op" id="2476649">)</span><span class="op" id="2476650">,</span>&nbsp;<span class="builtintype" id="2476652">uintptr</span><span class="op" id="2476659">(</span><span class="ident" id="2476660">nextfd</span><span class="op" id="2476666">)</span><span class="op" id="2476667">,</span>&nbsp;<span class="num" id="2476669">0</span><span class="op" id="2476670">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476675">if</span>&nbsp;<span class="ident" id="2476678">err1</span>&nbsp;<span class="op" id="2476683">!=</span>&nbsp;<span class="num" id="2476686">0</span>&nbsp;<span class="op" id="2476688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476694">goto</span>&nbsp;<span class="ident" id="2476699">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2476713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2476718">RawSyscall</span><span class="op" id="2476728">(</span><span class="ident" id="2476729">SYS_FCNTL</span><span class="op" id="2476738">,</span>&nbsp;<span class="builtintype" id="2476740">uintptr</span><span class="op" id="2476747">(</span><span class="ident" id="2476748">nextfd</span><span class="op" id="2476754">)</span><span class="op" id="2476755">,</span>&nbsp;<span class="ident" id="2476757">F_SETFD</span><span class="op" id="2476764">,</span>&nbsp;<span class="ident" id="2476766">FD_CLOEXEC</span><span class="op" id="2476776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2476781">fd</span><span class="op" id="2476783">[</span><span class="ident" id="2476784">i</span><span class="op" id="2476785">]</span>&nbsp;<span class="op" id="2476787">=</span>&nbsp;<span class="ident" id="2476789">nextfd</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2476799">nextfd</span><span class="op" id="2476805">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476811">if</span>&nbsp;<span class="ident" id="2476814">nextfd</span>&nbsp;<span class="op" id="2476821">==</span>&nbsp;<span class="ident" id="2476824">pipe</span>&nbsp;<span class="op" id="2476829">{</span>&nbsp;<span class="comment" id="2476831">//&nbsp;don&#39;t&nbsp;stomp&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2476858">nextfd</span><span class="op" id="2476864">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2476870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2476874">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2476877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2476881">//&nbsp;Pass&nbsp;2:&nbsp;dup&nbsp;fd[i]&nbsp;down&nbsp;onto&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476916">for</span>&nbsp;<span class="ident" id="2476920">i</span>&nbsp;<span class="op" id="2476922">=</span>&nbsp;<span class="num" id="2476924">0</span><span class="op" id="2476925">;</span>&nbsp;<span class="ident" id="2476927">i</span>&nbsp;<span class="op" id="2476929">&lt;</span>&nbsp;<span class="builtinfunc" id="2476931">len</span><span class="op" id="2476934">(</span><span class="ident" id="2476935">fd</span><span class="op" id="2476937">)</span><span class="op" id="2476938">;</span>&nbsp;<span class="ident" id="2476940">i</span><span class="op" id="2476941">++</span>&nbsp;<span class="op" id="2476944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2476948">if</span>&nbsp;<span class="ident" id="2476951">fd</span><span class="op" id="2476953">[</span><span class="ident" id="2476954">i</span><span class="op" id="2476955">]</span>&nbsp;<span class="op" id="2476957">==</span>&nbsp;<span class="op" id="2476960">-</span><span class="num" id="2476961">1</span>&nbsp;<span class="op" id="2476963">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2476968">RawSyscall</span><span class="op" id="2476978">(</span><span class="ident" id="2476979">SYS_CLOSE</span><span class="op" id="2476988">,</span>&nbsp;<span class="builtintype" id="2476990">uintptr</span><span class="op" id="2476997">(</span><span class="ident" id="2476998">i</span><span class="op" id="2476999">)</span><span class="op" id="2477000">,</span>&nbsp;<span class="num" id="2477002">0</span><span class="op" id="2477003">,</span>&nbsp;<span class="num" id="2477005">0</span><span class="op" id="2477006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2477011">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2477022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2477026">if</span>&nbsp;<span class="ident" id="2477029">fd</span><span class="op" id="2477031">[</span><span class="ident" id="2477032">i</span><span class="op" id="2477033">]</span>&nbsp;<span class="op" id="2477035">==</span>&nbsp;<span class="builtintype" id="2477038">int</span><span class="op" id="2477041">(</span><span class="ident" id="2477042">i</span><span class="op" id="2477043">)</span>&nbsp;<span class="op" id="2477045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2477050">//&nbsp;dup2(i,&nbsp;i)&nbsp;won&#39;t&nbsp;clear&nbsp;close-on-exec&nbsp;flag&nbsp;on&nbsp;Linux,</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2477108">//&nbsp;probably&nbsp;not&nbsp;elsewhere&nbsp;either.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2477145">_</span><span class="op" id="2477146">,</span>&nbsp;<span class="ident" id="2477148">_</span><span class="op" id="2477149">,</span>&nbsp;<span class="ident" id="2477151">err1</span>&nbsp;<span class="op" id="2477156">=</span>&nbsp;<span class="ident" id="2477158">RawSyscall</span><span class="op" id="2477168">(</span><span class="ident" id="2477169">SYS_FCNTL</span><span class="op" id="2477178">,</span>&nbsp;<span class="builtintype" id="2477180">uintptr</span><span class="op" id="2477187">(</span><span class="ident" id="2477188">fd</span><span class="op" id="2477190">[</span><span class="ident" id="2477191">i</span><span class="op" id="2477192">]</span><span class="op" id="2477193">)</span><span class="op" id="2477194">,</span>&nbsp;<span class="ident" id="2477196">F_SETFD</span><span class="op" id="2477203">,</span>&nbsp;<span class="num" id="2477205">0</span><span class="op" id="2477206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2477211">if</span>&nbsp;<span class="ident" id="2477214">err1</span>&nbsp;<span class="op" id="2477219">!=</span>&nbsp;<span class="num" id="2477222">0</span>&nbsp;<span class="op" id="2477224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2477230">goto</span>&nbsp;<span class="ident" id="2477235">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2477249">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2477254">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2477265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2477269">//&nbsp;The&nbsp;new&nbsp;fd&nbsp;is&nbsp;created&nbsp;NOT&nbsp;close-on-exec,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2477315">//&nbsp;which&nbsp;is&nbsp;exactly&nbsp;what&nbsp;we&nbsp;want.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2477351">_</span><span class="op" id="2477352">,</span>&nbsp;<span class="ident" id="2477354">_</span><span class="op" id="2477355">,</span>&nbsp;<span class="ident" id="2477357">err1</span>&nbsp;<span class="op" id="2477362">=</span>&nbsp;<span class="ident" id="2477364">RawSyscall</span><span class="op" id="2477374">(</span><span class="ident" id="2477375">SYS_DUP2</span><span class="op" id="2477383">,</span>&nbsp;<span class="builtintype" id="2477385">uintptr</span><span class="op" id="2477392">(</span><span class="ident" id="2477393">fd</span><span class="op" id="2477395">[</span><span class="ident" id="2477396">i</span><span class="op" id="2477397">]</span><span class="op" id="2477398">)</span><span class="op" id="2477399">,</span>&nbsp;<span class="builtintype" id="2477401">uintptr</span><span class="op" id="2477408">(</span><span class="ident" id="2477409">i</span><span class="op" id="2477410">)</span><span class="op" id="2477411">,</span>&nbsp;<span class="num" id="2477413">0</span><span class="op" id="2477414">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2477418">if</span>&nbsp;<span class="ident" id="2477421">err1</span>&nbsp;<span class="op" id="2477426">!=</span>&nbsp;<span class="num" id="2477429">0</span>&nbsp;<span class="op" id="2477431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2477436">goto</span>&nbsp;<span class="ident" id="2477441">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2477454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2477457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2477461">//&nbsp;By&nbsp;convention,&nbsp;we&nbsp;don&#39;t&nbsp;close-on-exec&nbsp;the&nbsp;fds&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2477518">//&nbsp;started&nbsp;with,&nbsp;so&nbsp;if&nbsp;len(fd)&nbsp;&lt;&nbsp;3,&nbsp;close&nbsp;0,&nbsp;1,&nbsp;2&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2477580">//&nbsp;Programs&nbsp;that&nbsp;know&nbsp;they&nbsp;inherit&nbsp;fds&nbsp;&gt;=&nbsp;3&nbsp;will&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2477635">//&nbsp;to&nbsp;set&nbsp;them&nbsp;close-on-exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2477666">for</span>&nbsp;<span class="ident" id="2477670">i</span>&nbsp;<span class="op" id="2477672">=</span>&nbsp;<span class="builtinfunc" id="2477674">len</span><span class="op" id="2477677">(</span><span class="ident" id="2477678">fd</span><span class="op" id="2477680">)</span><span class="op" id="2477681">;</span>&nbsp;<span class="ident" id="2477683">i</span>&nbsp;<span class="op" id="2477685">&lt;</span>&nbsp;<span class="num" id="2477687">3</span><span class="op" id="2477688">;</span>&nbsp;<span class="ident" id="2477690">i</span><span class="op" id="2477691">++</span>&nbsp;<span class="op" id="2477694">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2477698">RawSyscall</span><span class="op" id="2477708">(</span><span class="ident" id="2477709">SYS_CLOSE</span><span class="op" id="2477718">,</span>&nbsp;<span class="builtintype" id="2477720">uintptr</span><span class="op" id="2477727">(</span><span class="ident" id="2477728">i</span><span class="op" id="2477729">)</span><span class="op" id="2477730">,</span>&nbsp;<span class="num" id="2477732">0</span><span class="op" id="2477733">,</span>&nbsp;<span class="num" id="2477735">0</span><span class="op" id="2477736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2477739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2477743">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;tty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2477768">if</span>&nbsp;<span class="ident" id="2477771">sys</span><span class="op" id="2477774">.</span><span class="ident" id="2477775">Noctty</span>&nbsp;<span class="op" id="2477782">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2477786">_</span><span class="op" id="2477787">,</span>&nbsp;<span class="ident" id="2477789">_</span><span class="op" id="2477790">,</span>&nbsp;<span class="ident" id="2477792">err1</span>&nbsp;<span class="op" id="2477797">=</span>&nbsp;<span class="ident" id="2477799">RawSyscall</span><span class="op" id="2477809">(</span><span class="ident" id="2477810">SYS_IOCTL</span><span class="op" id="2477819">,</span>&nbsp;<span class="num" id="2477821">0</span><span class="op" id="2477822">,</span>&nbsp;<span class="builtintype" id="2477824">uintptr</span><span class="op" id="2477831">(</span><span class="ident" id="2477832">TIOCNOTTY</span><span class="op" id="2477841">)</span><span class="op" id="2477842">,</span>&nbsp;<span class="num" id="2477844">0</span><span class="op" id="2477845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2477849">if</span>&nbsp;<span class="ident" id="2477852">err1</span>&nbsp;<span class="op" id="2477857">!=</span>&nbsp;<span class="num" id="2477860">0</span>&nbsp;<span class="op" id="2477862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2477867">goto</span>&nbsp;<span class="ident" id="2477872">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2477885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2477888">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2477892">//&nbsp;Set&nbsp;the&nbsp;controlling&nbsp;TTY&nbsp;to&nbsp;Ctty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2477928">if</span>&nbsp;<span class="ident" id="2477931">sys</span><span class="op" id="2477934">.</span><span class="ident" id="2477935">Setctty</span>&nbsp;<span class="op" id="2477943">&amp;&amp;</span>&nbsp;<span class="ident" id="2477946">sys</span><span class="op" id="2477949">.</span><span class="ident" id="2477950">Ctty</span>&nbsp;<span class="op" id="2477955">&gt;=</span>&nbsp;<span class="num" id="2477958">0</span>&nbsp;<span class="op" id="2477960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2477964">_</span><span class="op" id="2477965">,</span>&nbsp;<span class="ident" id="2477967">_</span><span class="op" id="2477968">,</span>&nbsp;<span class="ident" id="2477970">err1</span>&nbsp;<span class="op" id="2477975">=</span>&nbsp;<span class="ident" id="2477977">RawSyscall</span><span class="op" id="2477987">(</span><span class="ident" id="2477988">SYS_IOCTL</span><span class="op" id="2477997">,</span>&nbsp;<span class="builtintype" id="2477999">uintptr</span><span class="op" id="2478006">(</span><span class="ident" id="2478007">sys</span><span class="op" id="2478010">.</span><span class="ident" id="2478011">Ctty</span><span class="op" id="2478015">)</span><span class="op" id="2478016">,</span>&nbsp;<span class="builtintype" id="2478018">uintptr</span><span class="op" id="2478025">(</span><span class="ident" id="2478026">TIOCSCTTY</span><span class="op" id="2478035">)</span><span class="op" id="2478036">,</span>&nbsp;<span class="num" id="2478038">0</span><span class="op" id="2478039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2478043">if</span>&nbsp;<span class="ident" id="2478046">err1</span>&nbsp;<span class="op" id="2478051">!=</span>&nbsp;<span class="num" id="2478054">0</span>&nbsp;<span class="op" id="2478056">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2478061">goto</span>&nbsp;<span class="ident" id="2478066">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2478079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2478082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2478086">//&nbsp;Time&nbsp;to&nbsp;exec.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2478104">_</span><span class="op" id="2478105">,</span>&nbsp;<span class="ident" id="2478107">_</span><span class="op" id="2478108">,</span>&nbsp;<span class="ident" id="2478110">err1</span>&nbsp;<span class="op" id="2478115">=</span>&nbsp;<span class="ident" id="2478117">RawSyscall</span><span class="op" id="2478127">(</span><span class="ident" id="2478128">SYS_EXECVE</span><span class="op" id="2478138">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2478142">uintptr</span><span class="op" id="2478149">(</span><span class="ident" id="2478150">unsafe</span><span class="op" id="2478156">.</span><span class="ident" id="2478157">Pointer</span><span class="op" id="2478164">(</span><span class="ident" id="2478165">argv0</span><span class="op" id="2478170">)</span><span class="op" id="2478171">)</span><span class="op" id="2478172">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2478176">uintptr</span><span class="op" id="2478183">(</span><span class="ident" id="2478184">unsafe</span><span class="op" id="2478190">.</span><span class="ident" id="2478191">Pointer</span><span class="op" id="2478198">(</span><span class="op" id="2478199">&amp;</span><span class="ident" id="2478200">argv</span><span class="op" id="2478204">[</span><span class="num" id="2478205">0</span><span class="op" id="2478206">]</span><span class="op" id="2478207">)</span><span class="op" id="2478208">)</span><span class="op" id="2478209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2478213">uintptr</span><span class="op" id="2478220">(</span><span class="ident" id="2478221">unsafe</span><span class="op" id="2478227">.</span><span class="ident" id="2478228">Pointer</span><span class="op" id="2478235">(</span><span class="op" id="2478236">&amp;</span><span class="ident" id="2478237">envv</span><span class="op" id="2478241">[</span><span class="num" id="2478242">0</span><span class="op" id="2478243">]</span><span class="op" id="2478244">)</span><span class="op" id="2478245">)</span><span class="op" id="2478246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="ident" id="2478249">childerror</span><span class="op" id="2478259">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2478262">//&nbsp;send&nbsp;error&nbsp;code&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2478290">RawSyscall</span><span class="op" id="2478300">(</span><span class="ident" id="2478301">SYS_WRITE</span><span class="op" id="2478310">,</span>&nbsp;<span class="builtintype" id="2478312">uintptr</span><span class="op" id="2478319">(</span><span class="ident" id="2478320">pipe</span><span class="op" id="2478324">)</span><span class="op" id="2478325">,</span>&nbsp;<span class="builtintype" id="2478327">uintptr</span><span class="op" id="2478334">(</span><span class="ident" id="2478335">unsafe</span><span class="op" id="2478341">.</span><span class="ident" id="2478342">Pointer</span><span class="op" id="2478349">(</span><span class="op" id="2478350">&amp;</span><span class="ident" id="2478351">err1</span><span class="op" id="2478355">)</span><span class="op" id="2478356">)</span><span class="op" id="2478357">,</span>&nbsp;<span class="ident" id="2478359">unsafe</span><span class="op" id="2478365">.</span><span class="ident" id="2478366">Sizeof</span><span class="op" id="2478372">(</span><span class="ident" id="2478373">err1</span><span class="op" id="2478377">)</span><span class="op" id="2478378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2478381">for</span>&nbsp;<span class="op" id="2478385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2478389">RawSyscall</span><span class="op" id="2478399">(</span><span class="ident" id="2478400">SYS_EXIT</span><span class="op" id="2478408">,</span>&nbsp;<span class="num" id="2478410">253</span><span class="op" id="2478413">,</span>&nbsp;<span class="num" id="2478415">0</span><span class="op" id="2478416">,</span>&nbsp;<span class="num" id="2478418">0</span><span class="op" id="2478419">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2478422">}</span><br>
<span class="lineno"></span><span class="op" id="2478424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2478427">//&nbsp;Try&nbsp;to&nbsp;open&nbsp;a&nbsp;pipe&nbsp;with&nbsp;O_CLOEXEC&nbsp;set&nbsp;on&nbsp;both&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="2478494">func</span>&nbsp;<span class="ident" id="2478499">forkExecPipe</span><span class="op" id="2478511">(</span><span class="ident" id="2478512">p</span>&nbsp;<span class="op" id="2478514">[</span><span class="op" id="2478515">]</span><span class="builtintype" id="2478516">int</span><span class="op" id="2478519">)</span>&nbsp;<span class="op" id="2478521">(</span><span class="ident" id="2478522">err</span>&nbsp;<span class="builtintype" id="2478526">error</span><span class="op" id="2478531">)</span>&nbsp;<span class="op" id="2478533">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2478536">err</span>&nbsp;<span class="op" id="2478540">=</span>&nbsp;<span class="ident" id="2478542">Pipe2</span><span class="op" id="2478547">(</span><span class="ident" id="2478548">p</span><span class="op" id="2478549">,</span>&nbsp;<span class="ident" id="2478551">O_CLOEXEC</span><span class="op" id="2478560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2478563">//&nbsp;pipe2&nbsp;was&nbsp;added&nbsp;in&nbsp;2.6.27&nbsp;and&nbsp;our&nbsp;minimum&nbsp;requirement&nbsp;is&nbsp;2.6.23,&nbsp;so&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2478638">//&nbsp;might&nbsp;not&nbsp;be&nbsp;implemented.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2478668">if</span>&nbsp;<span class="ident" id="2478671">err</span>&nbsp;<span class="op" id="2478675">==</span>&nbsp;<span class="ident" id="2478678">ENOSYS</span>&nbsp;<span class="op" id="2478685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2478689">if</span>&nbsp;<span class="ident" id="2478692">err</span>&nbsp;<span class="op" id="2478696">=</span>&nbsp;<span class="ident" id="2478698">Pipe</span><span class="op" id="2478702">(</span><span class="ident" id="2478703">p</span><span class="op" id="2478704">)</span><span class="op" id="2478705">;</span>&nbsp;<span class="ident" id="2478707">err</span>&nbsp;<span class="op" id="2478711">!=</span>&nbsp;<span class="builtintype" id="2478714">nil</span>&nbsp;<span class="op" id="2478718">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2478723">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2478732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2478736">if</span>&nbsp;<span class="ident" id="2478739">_</span><span class="op" id="2478740">,</span>&nbsp;<span class="ident" id="2478742">err</span>&nbsp;<span class="op" id="2478746">=</span>&nbsp;<span class="ident" id="2478748">fcntl</span><span class="op" id="2478753">(</span><span class="ident" id="2478754">p</span><span class="op" id="2478755">[</span><span class="num" id="2478756">0</span><span class="op" id="2478757">]</span><span class="op" id="2478758">,</span>&nbsp;<span class="ident" id="2478760">F_SETFD</span><span class="op" id="2478767">,</span>&nbsp;<span class="ident" id="2478769">FD_CLOEXEC</span><span class="op" id="2478779">)</span><span class="op" id="2478780">;</span>&nbsp;<span class="ident" id="2478782">err</span>&nbsp;<span class="op" id="2478786">!=</span>&nbsp;<span class="builtintype" id="2478789">nil</span>&nbsp;<span class="op" id="2478793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2478798">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2478807">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2478811">_</span><span class="op" id="2478812">,</span>&nbsp;<span class="ident" id="2478814">err</span>&nbsp;<span class="op" id="2478818">=</span>&nbsp;<span class="ident" id="2478820">fcntl</span><span class="op" id="2478825">(</span><span class="ident" id="2478826">p</span><span class="op" id="2478827">[</span><span class="num" id="2478828">1</span><span class="op" id="2478829">]</span><span class="op" id="2478830">,</span>&nbsp;<span class="ident" id="2478832">F_SETFD</span><span class="op" id="2478839">,</span>&nbsp;<span class="ident" id="2478841">FD_CLOEXEC</span><span class="op" id="2478851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2478854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2478857">return</span><br>
<span class="lineno"></span><span class="op" id="2478864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment" id="2478867">//&nbsp;writeIDMappings&nbsp;writes&nbsp;the&nbsp;user&nbsp;namespace&nbsp;User&nbsp;ID&nbsp;or&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;the&nbsp;specified&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="2478964">func</span>&nbsp;<span class="ident" id="2478969">writeIDMappings</span><span class="op" id="2478984">(</span><span class="ident" id="2478985">path</span>&nbsp;<span class="builtintype" id="2478990">string</span><span class="op" id="2478996">,</span>&nbsp;<span class="ident" id="2478998">idMap</span>&nbsp;<span class="op" id="2479004">[</span><span class="op" id="2479005">]</span><span class="ident" id="2479006">SysProcIDMap</span><span class="op" id="2479018">)</span>&nbsp;<span class="builtintype" id="2479020">error</span>&nbsp;<span class="op" id="2479026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2479029">fd</span><span class="op" id="2479031">,</span>&nbsp;<span class="ident" id="2479033">err</span>&nbsp;<span class="op" id="2479037">:=</span>&nbsp;<span class="ident" id="2479040">Open</span><span class="op" id="2479044">(</span><span class="ident" id="2479045">path</span><span class="op" id="2479049">,</span>&nbsp;<span class="ident" id="2479051">O_RDWR</span><span class="op" id="2479057">,</span>&nbsp;<span class="num" id="2479059">0</span><span class="op" id="2479060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479063">if</span>&nbsp;<span class="ident" id="2479066">err</span>&nbsp;<span class="op" id="2479070">!=</span>&nbsp;<span class="builtintype" id="2479073">nil</span>&nbsp;<span class="op" id="2479077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479081">return</span>&nbsp;<span class="ident" id="2479088">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2479093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2479097">data</span>&nbsp;<span class="op" id="2479102">:=</span>&nbsp;<span class="string" id="2479105">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479109">for</span>&nbsp;<span class="ident" id="2479113">_</span><span class="op" id="2479114">,</span>&nbsp;<span class="ident" id="2479116">im</span>&nbsp;<span class="op" id="2479119">:=</span>&nbsp;<span class="keyword" id="2479122">range</span>&nbsp;<span class="ident" id="2479128">idMap</span>&nbsp;<span class="op" id="2479134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2479138">data</span>&nbsp;<span class="op" id="2479143">=</span>&nbsp;<span class="ident" id="2479145">data</span>&nbsp;<span class="op" id="2479150">+</span>&nbsp;<span class="ident" id="2479152">itoa</span><span class="op" id="2479156">(</span><span class="ident" id="2479157">im</span><span class="op" id="2479159">.</span><span class="ident" id="2479160">ContainerID</span><span class="op" id="2479171">)</span>&nbsp;<span class="op" id="2479173">+</span>&nbsp;<span class="string" id="2479175">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2479179">+</span>&nbsp;<span class="ident" id="2479181">itoa</span><span class="op" id="2479185">(</span><span class="ident" id="2479186">im</span><span class="op" id="2479188">.</span><span class="ident" id="2479189">HostID</span><span class="op" id="2479195">)</span>&nbsp;<span class="op" id="2479197">+</span>&nbsp;<span class="string" id="2479199">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2479203">+</span>&nbsp;<span class="ident" id="2479205">itoa</span><span class="op" id="2479209">(</span><span class="ident" id="2479210">im</span><span class="op" id="2479212">.</span><span class="ident" id="2479213">Size</span><span class="op" id="2479217">)</span>&nbsp;<span class="op" id="2479219">+</span>&nbsp;<span class="string" id="2479221">&#34;\n&#34;</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2479227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2479231">bytes</span><span class="op" id="2479236">,</span>&nbsp;<span class="ident" id="2479238">err</span>&nbsp;<span class="op" id="2479242">:=</span>&nbsp;<span class="ident" id="2479245">ByteSliceFromString</span><span class="op" id="2479264">(</span><span class="ident" id="2479265">data</span><span class="op" id="2479269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479272">if</span>&nbsp;<span class="ident" id="2479275">err</span>&nbsp;<span class="op" id="2479279">!=</span>&nbsp;<span class="builtintype" id="2479282">nil</span>&nbsp;<span class="op" id="2479286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2479290">Close</span><span class="op" id="2479295">(</span><span class="ident" id="2479296">fd</span><span class="op" id="2479298">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479302">return</span>&nbsp;<span class="ident" id="2479309">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2479314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479318">if</span>&nbsp;<span class="ident" id="2479321">_</span><span class="op" id="2479322">,</span>&nbsp;<span class="ident" id="2479324">err</span>&nbsp;<span class="op" id="2479328">:=</span>&nbsp;<span class="ident" id="2479331">Write</span><span class="op" id="2479336">(</span><span class="ident" id="2479337">fd</span><span class="op" id="2479339">,</span>&nbsp;<span class="ident" id="2479341">bytes</span><span class="op" id="2479346">)</span><span class="op" id="2479347">;</span>&nbsp;<span class="ident" id="2479349">err</span>&nbsp;<span class="op" id="2479353">!=</span>&nbsp;<span class="builtintype" id="2479356">nil</span>&nbsp;<span class="op" id="2479360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2479364">Close</span><span class="op" id="2479369">(</span><span class="ident" id="2479370">fd</span><span class="op" id="2479372">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479376">return</span>&nbsp;<span class="ident" id="2479383">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2479388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479392">if</span>&nbsp;<span class="ident" id="2479395">err</span>&nbsp;<span class="op" id="2479399">:=</span>&nbsp;<span class="ident" id="2479402">Close</span><span class="op" id="2479407">(</span><span class="ident" id="2479408">fd</span><span class="op" id="2479410">)</span><span class="op" id="2479411">;</span>&nbsp;<span class="ident" id="2479413">err</span>&nbsp;<span class="op" id="2479417">!=</span>&nbsp;<span class="builtintype" id="2479420">nil</span>&nbsp;<span class="op" id="2479424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479428">return</span>&nbsp;<span class="ident" id="2479435">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2479440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479444">return</span>&nbsp;<span class="builtintype" id="2479451">nil</span><br>
<span class="lineno"></span><span class="op" id="2479455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment" id="2479458">//&nbsp;writeUidGidMappings&nbsp;writes&nbsp;User&nbsp;ID&nbsp;and&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces</span><br>
<span class="lineno"></span><span class="comment" id="2479538">//&nbsp;for&nbsp;a&nbsp;process&nbsp;and&nbsp;it&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;parent&nbsp;process.</span><br>
<span class="lineno"></span><span class="keyword" id="2479597">func</span>&nbsp;<span class="ident" id="2479602">writeUidGidMappings</span><span class="op" id="2479621">(</span><span class="ident" id="2479622">pid</span>&nbsp;<span class="builtintype" id="2479626">int</span><span class="op" id="2479629">,</span>&nbsp;<span class="ident" id="2479631">sys</span>&nbsp;<span class="op" id="2479635">*</span><span class="ident" id="2479636">SysProcAttr</span><span class="op" id="2479647">)</span>&nbsp;<span class="builtintype" id="2479649">error</span>&nbsp;<span class="op" id="2479655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479658">if</span>&nbsp;<span class="ident" id="2479661">sys</span><span class="op" id="2479664">.</span><span class="ident" id="2479665">UidMappings</span>&nbsp;<span class="op" id="2479677">!=</span>&nbsp;<span class="builtintype" id="2479680">nil</span>&nbsp;<span class="op" id="2479684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2479688">uidf</span>&nbsp;<span class="op" id="2479693">:=</span>&nbsp;<span class="string" id="2479696">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2479705">+</span>&nbsp;<span class="ident" id="2479707">itoa</span><span class="op" id="2479711">(</span><span class="ident" id="2479712">pid</span><span class="op" id="2479715">)</span>&nbsp;<span class="op" id="2479717">+</span>&nbsp;<span class="string" id="2479719">&#34;/uid_map&#34;</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479732">if</span>&nbsp;<span class="ident" id="2479735">err</span>&nbsp;<span class="op" id="2479739">:=</span>&nbsp;<span class="ident" id="2479742">writeIDMappings</span><span class="op" id="2479757">(</span><span class="ident" id="2479758">uidf</span><span class="op" id="2479762">,</span>&nbsp;<span class="ident" id="2479764">sys</span><span class="op" id="2479767">.</span><span class="ident" id="2479768">UidMappings</span><span class="op" id="2479779">)</span><span class="op" id="2479780">;</span>&nbsp;<span class="ident" id="2479782">err</span>&nbsp;<span class="op" id="2479786">!=</span>&nbsp;<span class="builtintype" id="2479789">nil</span>&nbsp;<span class="op" id="2479793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479798">return</span>&nbsp;<span class="ident" id="2479805">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2479811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2479814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479818">if</span>&nbsp;<span class="ident" id="2479821">sys</span><span class="op" id="2479824">.</span><span class="ident" id="2479825">GidMappings</span>&nbsp;<span class="op" id="2479837">!=</span>&nbsp;<span class="builtintype" id="2479840">nil</span>&nbsp;<span class="op" id="2479844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2479848">gidf</span>&nbsp;<span class="op" id="2479853">:=</span>&nbsp;<span class="string" id="2479856">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2479865">+</span>&nbsp;<span class="ident" id="2479867">itoa</span><span class="op" id="2479871">(</span><span class="ident" id="2479872">pid</span><span class="op" id="2479875">)</span>&nbsp;<span class="op" id="2479877">+</span>&nbsp;<span class="string" id="2479879">&#34;/gid_map&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479892">if</span>&nbsp;<span class="ident" id="2479895">err</span>&nbsp;<span class="op" id="2479899">:=</span>&nbsp;<span class="ident" id="2479902">writeIDMappings</span><span class="op" id="2479917">(</span><span class="ident" id="2479918">gidf</span><span class="op" id="2479922">,</span>&nbsp;<span class="ident" id="2479924">sys</span><span class="op" id="2479927">.</span><span class="ident" id="2479928">GidMappings</span><span class="op" id="2479939">)</span><span class="op" id="2479940">;</span>&nbsp;<span class="ident" id="2479942">err</span>&nbsp;<span class="op" id="2479946">!=</span>&nbsp;<span class="builtintype" id="2479949">nil</span>&nbsp;<span class="op" id="2479953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479958">return</span>&nbsp;<span class="ident" id="2479965">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2479971">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2479974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2479978">return</span>&nbsp;<span class="builtintype" id="2479985">nil</span><br>
<span class="lineno"></span><span class="op" id="2479989">}</span>
</div>
</body>
</html>
