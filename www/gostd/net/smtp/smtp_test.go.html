<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/smtp</h2>
<ul>
<li><a href="/gostd/net/smtp/auth.go.html">auth.go</a></li>
<li><a href="/gostd/net/smtp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/smtp/smtp.go.html">smtp.go</a></li>
<li><a href="/gostd/net/smtp/smtp_test.go.html" class="current">smtp_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7453665">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7453720">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7453774">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7453825">package</span>&nbsp;<span class="ident" id="7453833">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7453839">import</span>&nbsp;<span class="op" id="7453846">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7453849">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7453858">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7453867">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7453881">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7453896">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7453902">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7453909">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7453926">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7453937">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7453948">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7453955">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="7453958">type</span>&nbsp;<span class="ident" id="7453963">authTest</span>&nbsp;<span class="keyword" id="7453972">struct</span>&nbsp;<span class="op" id="7453979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7453982">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7453993">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7453999">challenges</span>&nbsp;<span class="op" id="7454010">[</span><span class="op" id="7454011">]</span><span class="builtintype" id="7454012">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7454020">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7454031">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7454039">responses</span>&nbsp;&nbsp;<span class="op" id="7454050">[</span><span class="op" id="7454051">]</span><span class="builtintype" id="7454052">string</span><br>
<span class="lineno">25</span><span class="op" id="7454059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7454062">var</span>&nbsp;<span class="ident" id="7454066">authTests</span>&nbsp;<span class="op" id="7454076">=</span>&nbsp;<span class="op" id="7454078">[</span><span class="op" id="7454079">]</span><span class="ident" id="7454080">authTest</span><span class="op" id="7454088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7454091">{</span><span class="ident" id="7454092">PlainAuth</span><span class="op" id="7454101">(</span><span class="string" id="7454102">&#34;&#34;</span><span class="op" id="7454104">,</span>&nbsp;<span class="string" id="7454106">&#34;user&#34;</span><span class="op" id="7454112">,</span>&nbsp;<span class="string" id="7454114">&#34;pass&#34;</span><span class="op" id="7454120">,</span>&nbsp;<span class="string" id="7454122">&#34;testserver&#34;</span><span class="op" id="7454134">)</span><span class="op" id="7454135">,</span>&nbsp;<span class="op" id="7454137">[</span><span class="op" id="7454138">]</span><span class="builtintype" id="7454139">string</span><span class="op" id="7454145">{</span><span class="op" id="7454146">}</span><span class="op" id="7454147">,</span>&nbsp;<span class="string" id="7454149">&#34;PLAIN&#34;</span><span class="op" id="7454156">,</span>&nbsp;<span class="op" id="7454158">[</span><span class="op" id="7454159">]</span><span class="builtintype" id="7454160">string</span><span class="op" id="7454166">{</span><span class="string" id="7454167">&#34;\x00user\x00pass&#34;</span><span class="op" id="7454185">}</span><span class="op" id="7454186">}</span><span class="op" id="7454187">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7454190">{</span><span class="ident" id="7454191">PlainAuth</span><span class="op" id="7454200">(</span><span class="string" id="7454201">&#34;foo&#34;</span><span class="op" id="7454206">,</span>&nbsp;<span class="string" id="7454208">&#34;bar&#34;</span><span class="op" id="7454213">,</span>&nbsp;<span class="string" id="7454215">&#34;baz&#34;</span><span class="op" id="7454220">,</span>&nbsp;<span class="string" id="7454222">&#34;testserver&#34;</span><span class="op" id="7454234">)</span><span class="op" id="7454235">,</span>&nbsp;<span class="op" id="7454237">[</span><span class="op" id="7454238">]</span><span class="builtintype" id="7454239">string</span><span class="op" id="7454245">{</span><span class="op" id="7454246">}</span><span class="op" id="7454247">,</span>&nbsp;<span class="string" id="7454249">&#34;PLAIN&#34;</span><span class="op" id="7454256">,</span>&nbsp;<span class="op" id="7454258">[</span><span class="op" id="7454259">]</span><span class="builtintype" id="7454260">string</span><span class="op" id="7454266">{</span><span class="string" id="7454267">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="7454286">}</span><span class="op" id="7454287">}</span><span class="op" id="7454288">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7454291">{</span><span class="ident" id="7454292">CRAMMD5Auth</span><span class="op" id="7454303">(</span><span class="string" id="7454304">&#34;user&#34;</span><span class="op" id="7454310">,</span>&nbsp;<span class="string" id="7454312">&#34;pass&#34;</span><span class="op" id="7454318">)</span><span class="op" id="7454319">,</span>&nbsp;<span class="op" id="7454321">[</span><span class="op" id="7454322">]</span><span class="builtintype" id="7454323">string</span><span class="op" id="7454329">{</span><span class="string" id="7454330">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="7454362">}</span><span class="op" id="7454363">,</span>&nbsp;<span class="string" id="7454365">&#34;CRAM-MD5&#34;</span><span class="op" id="7454375">,</span>&nbsp;<span class="op" id="7454377">[</span><span class="op" id="7454378">]</span><span class="builtintype" id="7454379">string</span><span class="op" id="7454385">{</span><span class="string" id="7454386">&#34;&#34;</span><span class="op" id="7454388">,</span>&nbsp;<span class="string" id="7454390">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="7454429">}</span><span class="op" id="7454430">}</span><span class="op" id="7454431">,</span><br>
<span class="lineno"></span><span class="op" id="7454433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7454436">func</span>&nbsp;<span class="ident" id="7454441">TestAuth</span><span class="op" id="7454449">(</span><span class="ident" id="7454450">t</span>&nbsp;<span class="op" id="7454452">*</span><span class="ident" id="7454453">testing</span><span class="op" id="7454460">.</span><span class="ident" id="7454461">T</span><span class="op" id="7454462">)</span>&nbsp;<span class="op" id="7454464">{</span><br>
<span class="lineno"></span><span class="ident" id="7454466">testLoop</span><span class="op" id="7454474">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7454477">for</span>&nbsp;<span class="ident" id="7454481">i</span><span class="op" id="7454482">,</span>&nbsp;<span class="ident" id="7454484">test</span>&nbsp;<span class="op" id="7454489">:=</span>&nbsp;<span class="keyword" id="7454492">range</span>&nbsp;<span class="ident" id="7454498">authTests</span>&nbsp;<span class="op" id="7454508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7454512">name</span><span class="op" id="7454516">,</span>&nbsp;<span class="ident" id="7454518">resp</span><span class="op" id="7454522">,</span>&nbsp;<span class="ident" id="7454524">err</span>&nbsp;<span class="op" id="7454528">:=</span>&nbsp;<span class="ident" id="7454531">test</span><span class="op" id="7454535">.</span><span class="ident" id="7454536">auth</span><span class="op" id="7454540">.</span><span class="ident" id="7454541">Start</span><span class="op" id="7454546">(</span><span class="op" id="7454547">&amp;</span><span class="ident" id="7454548">ServerInfo</span><span class="op" id="7454558">{</span><span class="string" id="7454559">&#34;testserver&#34;</span><span class="op" id="7454571">,</span>&nbsp;<span class="builtintype" id="7454573">true</span><span class="op" id="7454577">,</span>&nbsp;<span class="ident" id="7454579">nil</span><span class="op" id="7454582">}</span><span class="op" id="7454583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7454587">if</span>&nbsp;<span class="ident" id="7454590">name</span>&nbsp;<span class="op" id="7454595">!=</span>&nbsp;<span class="ident" id="7454598">test</span><span class="op" id="7454602">.</span><span class="ident" id="7454603">name</span>&nbsp;<span class="op" id="7454608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7454613">t</span><span class="op" id="7454614">.</span><span class="ident" id="7454615">Errorf</span><span class="op" id="7454621">(</span><span class="string" id="7454622">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="7454652">,</span>&nbsp;<span class="ident" id="7454654">i</span><span class="op" id="7454655">,</span>&nbsp;<span class="ident" id="7454657">name</span><span class="op" id="7454661">,</span>&nbsp;<span class="ident" id="7454663">test</span><span class="op" id="7454667">.</span><span class="ident" id="7454668">name</span><span class="op" id="7454672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7454676">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7454680">if</span>&nbsp;<span class="op" id="7454683">!</span><span class="ident" id="7454684">bytes</span><span class="op" id="7454689">.</span><span class="ident" id="7454690">Equal</span><span class="op" id="7454695">(</span><span class="ident" id="7454696">resp</span><span class="op" id="7454700">,</span>&nbsp;<span class="op" id="7454702">[</span><span class="op" id="7454703">]</span><span class="builtintype" id="7454704">byte</span><span class="op" id="7454708">(</span><span class="ident" id="7454709">test</span><span class="op" id="7454713">.</span><span class="ident" id="7454714">responses</span><span class="op" id="7454723">[</span><span class="num" id="7454724">0</span><span class="op" id="7454725">]</span><span class="op" id="7454726">)</span><span class="op" id="7454727">)</span>&nbsp;<span class="op" id="7454729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7454734">t</span><span class="op" id="7454735">.</span><span class="ident" id="7454736">Errorf</span><span class="op" id="7454742">(</span><span class="string" id="7454743">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="7454777">,</span>&nbsp;<span class="ident" id="7454779">i</span><span class="op" id="7454780">,</span>&nbsp;<span class="ident" id="7454782">resp</span><span class="op" id="7454786">,</span>&nbsp;<span class="ident" id="7454788">test</span><span class="op" id="7454792">.</span><span class="ident" id="7454793">responses</span><span class="op" id="7454802">[</span><span class="num" id="7454803">0</span><span class="op" id="7454804">]</span><span class="op" id="7454805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7454809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7454813">if</span>&nbsp;<span class="ident" id="7454816">err</span>&nbsp;<span class="op" id="7454820">!=</span>&nbsp;<span class="ident" id="7454823">nil</span>&nbsp;<span class="op" id="7454827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7454832">t</span><span class="op" id="7454833">.</span><span class="ident" id="7454834">Errorf</span><span class="op" id="7454840">(</span><span class="string" id="7454841">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="7454856">,</span>&nbsp;<span class="ident" id="7454858">i</span><span class="op" id="7454859">,</span>&nbsp;<span class="ident" id="7454861">err</span><span class="op" id="7454864">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7454868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7454872">for</span>&nbsp;<span class="ident" id="7454876">j</span>&nbsp;<span class="op" id="7454878">:=</span>&nbsp;<span class="keyword" id="7454881">range</span>&nbsp;<span class="ident" id="7454887">test</span><span class="op" id="7454891">.</span><span class="ident" id="7454892">challenges</span>&nbsp;<span class="op" id="7454903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7454908">challenge</span>&nbsp;<span class="op" id="7454918">:=</span>&nbsp;<span class="op" id="7454921">[</span><span class="op" id="7454922">]</span><span class="builtintype" id="7454923">byte</span><span class="op" id="7454927">(</span><span class="ident" id="7454928">test</span><span class="op" id="7454932">.</span><span class="ident" id="7454933">challenges</span><span class="op" id="7454943">[</span><span class="ident" id="7454944">j</span><span class="op" id="7454945">]</span><span class="op" id="7454946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7454951">expected</span>&nbsp;<span class="op" id="7454960">:=</span>&nbsp;<span class="op" id="7454963">[</span><span class="op" id="7454964">]</span><span class="builtintype" id="7454965">byte</span><span class="op" id="7454969">(</span><span class="ident" id="7454970">test</span><span class="op" id="7454974">.</span><span class="ident" id="7454975">responses</span><span class="op" id="7454984">[</span><span class="ident" id="7454985">j</span><span class="op" id="7454986">+</span><span class="num" id="7454987">1</span><span class="op" id="7454988">]</span><span class="op" id="7454989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7454994">resp</span><span class="op" id="7454998">,</span>&nbsp;<span class="ident" id="7455000">err</span>&nbsp;<span class="op" id="7455004">:=</span>&nbsp;<span class="ident" id="7455007">test</span><span class="op" id="7455011">.</span><span class="ident" id="7455012">auth</span><span class="op" id="7455016">.</span><span class="ident" id="7455017">Next</span><span class="op" id="7455021">(</span><span class="ident" id="7455022">challenge</span><span class="op" id="7455031">,</span>&nbsp;<span class="builtintype" id="7455033">true</span><span class="op" id="7455037">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7455042">if</span>&nbsp;<span class="ident" id="7455045">err</span>&nbsp;<span class="op" id="7455049">!=</span>&nbsp;<span class="ident" id="7455052">nil</span>&nbsp;<span class="op" id="7455056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455062">t</span><span class="op" id="7455063">.</span><span class="ident" id="7455064">Errorf</span><span class="op" id="7455070">(</span><span class="string" id="7455071">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="7455086">,</span>&nbsp;<span class="ident" id="7455088">i</span><span class="op" id="7455089">,</span>&nbsp;<span class="ident" id="7455091">err</span><span class="op" id="7455094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7455100">continue</span>&nbsp;<span class="ident" id="7455109">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7455126">if</span>&nbsp;<span class="op" id="7455129">!</span><span class="ident" id="7455130">bytes</span><span class="op" id="7455135">.</span><span class="ident" id="7455136">Equal</span><span class="op" id="7455141">(</span><span class="ident" id="7455142">resp</span><span class="op" id="7455146">,</span>&nbsp;<span class="ident" id="7455148">expected</span><span class="op" id="7455156">)</span>&nbsp;<span class="op" id="7455158">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455164">t</span><span class="op" id="7455165">.</span><span class="ident" id="7455166">Errorf</span><span class="op" id="7455172">(</span><span class="string" id="7455173">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="7455198">,</span>&nbsp;<span class="ident" id="7455200">i</span><span class="op" id="7455201">,</span>&nbsp;<span class="ident" id="7455203">resp</span><span class="op" id="7455207">,</span>&nbsp;<span class="ident" id="7455209">expected</span><span class="op" id="7455217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7455223">continue</span>&nbsp;<span class="ident" id="7455232">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455251">}</span><br>
<span class="lineno">60</span><span class="op" id="7455253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7455256">func</span>&nbsp;<span class="ident" id="7455261">TestAuthPlain</span><span class="op" id="7455274">(</span><span class="ident" id="7455275">t</span>&nbsp;<span class="op" id="7455277">*</span><span class="ident" id="7455278">testing</span><span class="op" id="7455285">.</span><span class="ident" id="7455286">T</span><span class="op" id="7455287">)</span>&nbsp;<span class="op" id="7455289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455292">auth</span>&nbsp;<span class="op" id="7455297">:=</span>&nbsp;<span class="ident" id="7455300">PlainAuth</span><span class="op" id="7455309">(</span><span class="string" id="7455310">&#34;foo&#34;</span><span class="op" id="7455315">,</span>&nbsp;<span class="string" id="7455317">&#34;bar&#34;</span><span class="op" id="7455322">,</span>&nbsp;<span class="string" id="7455324">&#34;baz&#34;</span><span class="op" id="7455329">,</span>&nbsp;<span class="string" id="7455331">&#34;servername&#34;</span><span class="op" id="7455343">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455347">tests</span>&nbsp;<span class="op" id="7455353">:=</span>&nbsp;<span class="op" id="7455356">[</span><span class="op" id="7455357">]</span><span class="keyword" id="7455358">struct</span>&nbsp;<span class="op" id="7455365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455369">server</span>&nbsp;<span class="op" id="7455376">*</span><span class="ident" id="7455377">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455390">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7455397">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455405">}</span><span class="op" id="7455406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455410">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455415">server</span><span class="op" id="7455421">:</span>&nbsp;<span class="op" id="7455423">&amp;</span><span class="ident" id="7455424">ServerInfo</span><span class="op" id="7455434">{</span><span class="ident" id="7455435">Name</span><span class="op" id="7455439">:</span>&nbsp;<span class="string" id="7455441">&#34;servername&#34;</span><span class="op" id="7455453">,</span>&nbsp;<span class="ident" id="7455455">TLS</span><span class="op" id="7455458">:</span>&nbsp;<span class="builtintype" id="7455460">true</span><span class="op" id="7455464">}</span><span class="op" id="7455465">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455469">}</span><span class="op" id="7455470">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7455479">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455524">server</span><span class="op" id="7455530">:</span>&nbsp;<span class="op" id="7455532">&amp;</span><span class="ident" id="7455533">ServerInfo</span><span class="op" id="7455543">{</span><span class="ident" id="7455544">Name</span><span class="op" id="7455548">:</span>&nbsp;<span class="string" id="7455550">&#34;servername&#34;</span><span class="op" id="7455562">,</span>&nbsp;<span class="ident" id="7455564">Auth</span><span class="op" id="7455568">:</span>&nbsp;<span class="op" id="7455570">[</span><span class="op" id="7455571">]</span><span class="builtintype" id="7455572">string</span><span class="op" id="7455578">{</span><span class="string" id="7455579">&#34;PLAIN&#34;</span><span class="op" id="7455586">}</span><span class="op" id="7455587">}</span><span class="op" id="7455588">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455592">}</span><span class="op" id="7455593">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455602">server</span><span class="op" id="7455608">:</span>&nbsp;<span class="op" id="7455610">&amp;</span><span class="ident" id="7455611">ServerInfo</span><span class="op" id="7455621">{</span><span class="ident" id="7455622">Name</span><span class="op" id="7455626">:</span>&nbsp;<span class="string" id="7455628">&#34;servername&#34;</span><span class="op" id="7455640">,</span>&nbsp;<span class="ident" id="7455642">Auth</span><span class="op" id="7455646">:</span>&nbsp;<span class="op" id="7455648">[</span><span class="op" id="7455649">]</span><span class="builtintype" id="7455650">string</span><span class="op" id="7455656">{</span><span class="string" id="7455657">&#34;CRAM-MD5&#34;</span><span class="op" id="7455667">}</span><span class="op" id="7455668">}</span><span class="op" id="7455669">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455674">err</span><span class="op" id="7455677">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7455682">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="7455706">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455710">}</span><span class="op" id="7455711">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455720">server</span><span class="op" id="7455726">:</span>&nbsp;<span class="op" id="7455728">&amp;</span><span class="ident" id="7455729">ServerInfo</span><span class="op" id="7455739">{</span><span class="ident" id="7455740">Name</span><span class="op" id="7455744">:</span>&nbsp;<span class="string" id="7455746">&#34;attacker&#34;</span><span class="op" id="7455756">,</span>&nbsp;<span class="ident" id="7455758">TLS</span><span class="op" id="7455761">:</span>&nbsp;<span class="builtintype" id="7455763">true</span><span class="op" id="7455767">}</span><span class="op" id="7455768">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455773">err</span><span class="op" id="7455776">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7455781">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="7455798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455802">}</span><span class="op" id="7455803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455806">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7455809">for</span>&nbsp;<span class="ident" id="7455813">i</span><span class="op" id="7455814">,</span>&nbsp;<span class="ident" id="7455816">tt</span>&nbsp;<span class="op" id="7455819">:=</span>&nbsp;<span class="keyword" id="7455822">range</span>&nbsp;<span class="ident" id="7455828">tests</span>&nbsp;<span class="op" id="7455834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455838">_</span><span class="op" id="7455839">,</span>&nbsp;<span class="ident" id="7455841">_</span><span class="op" id="7455842">,</span>&nbsp;<span class="ident" id="7455844">err</span>&nbsp;<span class="op" id="7455848">:=</span>&nbsp;<span class="ident" id="7455851">auth</span><span class="op" id="7455855">.</span><span class="ident" id="7455856">Start</span><span class="op" id="7455861">(</span><span class="ident" id="7455862">tt</span><span class="op" id="7455864">.</span><span class="ident" id="7455865">server</span><span class="op" id="7455871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455875">got</span>&nbsp;<span class="op" id="7455879">:=</span>&nbsp;<span class="string" id="7455882">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7455887">if</span>&nbsp;<span class="ident" id="7455890">err</span>&nbsp;<span class="op" id="7455894">!=</span>&nbsp;<span class="ident" id="7455897">nil</span>&nbsp;<span class="op" id="7455901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455906">got</span>&nbsp;<span class="op" id="7455910">=</span>&nbsp;<span class="ident" id="7455912">err</span><span class="op" id="7455915">.</span><span class="ident" id="7455916">Error</span><span class="op" id="7455921">(</span><span class="op" id="7455922">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7455926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7455930">if</span>&nbsp;<span class="ident" id="7455933">got</span>&nbsp;<span class="op" id="7455937">!=</span>&nbsp;<span class="ident" id="7455940">tt</span><span class="op" id="7455942">.</span><span class="ident" id="7455943">err</span>&nbsp;<span class="op" id="7455947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7455952">t</span><span class="op" id="7455953">.</span><span class="ident" id="7455954">Errorf</span><span class="op" id="7455960">(</span><span class="string" id="7455961">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7455990">,</span>&nbsp;<span class="ident" id="7455992">i</span><span class="op" id="7455993">,</span>&nbsp;<span class="ident" id="7455995">got</span><span class="op" id="7455998">,</span>&nbsp;<span class="ident" id="7456000">tt</span><span class="op" id="7456002">.</span><span class="ident" id="7456003">err</span><span class="op" id="7456006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7456010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7456013">}</span><br>
<span class="lineno">95</span><span class="op" id="7456015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7456018">type</span>&nbsp;<span class="ident" id="7456023">faker</span>&nbsp;<span class="keyword" id="7456029">struct</span>&nbsp;<span class="op" id="7456036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7456039">io</span><span class="op" id="7456041">.</span><span class="ident" id="7456042">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="7456053">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="7456056">func</span>&nbsp;<span class="op" id="7456061">(</span><span class="ident" id="7456062">f</span>&nbsp;<span class="ident" id="7456064">faker</span><span class="op" id="7456069">)</span>&nbsp;<span class="ident" id="7456071">Close</span><span class="op" id="7456076">(</span><span class="op" id="7456077">)</span>&nbsp;<span class="builtintype" id="7456079">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7456105">{</span>&nbsp;<span class="keyword" id="7456107">return</span>&nbsp;<span class="ident" id="7456114">nil</span>&nbsp;<span class="op" id="7456118">}</span><br>
<span class="lineno"></span><span class="keyword" id="7456120">func</span>&nbsp;<span class="op" id="7456125">(</span><span class="ident" id="7456126">f</span>&nbsp;<span class="ident" id="7456128">faker</span><span class="op" id="7456133">)</span>&nbsp;<span class="ident" id="7456135">LocalAddr</span><span class="op" id="7456144">(</span><span class="op" id="7456145">)</span>&nbsp;<span class="ident" id="7456147">net</span><span class="op" id="7456150">.</span><span class="ident" id="7456151">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7456169">{</span>&nbsp;<span class="keyword" id="7456171">return</span>&nbsp;<span class="ident" id="7456178">nil</span>&nbsp;<span class="op" id="7456182">}</span><br>
<span class="lineno"></span><span class="keyword" id="7456184">func</span>&nbsp;<span class="op" id="7456189">(</span><span class="ident" id="7456190">f</span>&nbsp;<span class="ident" id="7456192">faker</span><span class="op" id="7456197">)</span>&nbsp;<span class="ident" id="7456199">RemoteAddr</span><span class="op" id="7456209">(</span><span class="op" id="7456210">)</span>&nbsp;<span class="ident" id="7456212">net</span><span class="op" id="7456215">.</span><span class="ident" id="7456216">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7456233">{</span>&nbsp;<span class="keyword" id="7456235">return</span>&nbsp;<span class="ident" id="7456242">nil</span>&nbsp;<span class="op" id="7456246">}</span><br>
<span class="lineno"></span><span class="keyword" id="7456248">func</span>&nbsp;<span class="op" id="7456253">(</span><span class="ident" id="7456254">f</span>&nbsp;<span class="ident" id="7456256">faker</span><span class="op" id="7456261">)</span>&nbsp;<span class="ident" id="7456263">SetDeadline</span><span class="op" id="7456274">(</span><span class="ident" id="7456275">time</span><span class="op" id="7456279">.</span><span class="ident" id="7456280">Time</span><span class="op" id="7456284">)</span>&nbsp;<span class="builtintype" id="7456286">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7456297">{</span>&nbsp;<span class="keyword" id="7456299">return</span>&nbsp;<span class="ident" id="7456306">nil</span>&nbsp;<span class="op" id="7456310">}</span><br>
<span class="lineno">105</span><span class="keyword" id="7456312">func</span>&nbsp;<span class="op" id="7456317">(</span><span class="ident" id="7456318">f</span>&nbsp;<span class="ident" id="7456320">faker</span><span class="op" id="7456325">)</span>&nbsp;<span class="ident" id="7456327">SetReadDeadline</span><span class="op" id="7456342">(</span><span class="ident" id="7456343">time</span><span class="op" id="7456347">.</span><span class="ident" id="7456348">Time</span><span class="op" id="7456352">)</span>&nbsp;<span class="builtintype" id="7456354">error</span>&nbsp;&nbsp;<span class="op" id="7456361">{</span>&nbsp;<span class="keyword" id="7456363">return</span>&nbsp;<span class="ident" id="7456370">nil</span>&nbsp;<span class="op" id="7456374">}</span><br>
<span class="lineno"></span><span class="keyword" id="7456376">func</span>&nbsp;<span class="op" id="7456381">(</span><span class="ident" id="7456382">f</span>&nbsp;<span class="ident" id="7456384">faker</span><span class="op" id="7456389">)</span>&nbsp;<span class="ident" id="7456391">SetWriteDeadline</span><span class="op" id="7456407">(</span><span class="ident" id="7456408">time</span><span class="op" id="7456412">.</span><span class="ident" id="7456413">Time</span><span class="op" id="7456417">)</span>&nbsp;<span class="builtintype" id="7456419">error</span>&nbsp;<span class="op" id="7456425">{</span>&nbsp;<span class="keyword" id="7456427">return</span>&nbsp;<span class="ident" id="7456434">nil</span>&nbsp;<span class="op" id="7456438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7456441">func</span>&nbsp;<span class="ident" id="7456446">TestBasic</span><span class="op" id="7456455">(</span><span class="ident" id="7456456">t</span>&nbsp;<span class="op" id="7456458">*</span><span class="ident" id="7456459">testing</span><span class="op" id="7456466">.</span><span class="ident" id="7456467">T</span><span class="op" id="7456468">)</span>&nbsp;<span class="op" id="7456470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7456473">server</span>&nbsp;<span class="op" id="7456480">:=</span>&nbsp;<span class="ident" id="7456483">strings</span><span class="op" id="7456490">.</span><span class="ident" id="7456491">Join</span><span class="op" id="7456495">(</span><span class="ident" id="7456496">strings</span><span class="op" id="7456503">.</span><span class="ident" id="7456504">Split</span><span class="op" id="7456509">(</span><span class="ident" id="7456510">basicServer</span><span class="op" id="7456521">,</span>&nbsp;<span class="string" id="7456523">&#34;\n&#34;</span><span class="op" id="7456527">)</span><span class="op" id="7456528">,</span>&nbsp;<span class="string" id="7456530">&#34;\r\n&#34;</span><span class="op" id="7456536">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7456539">client</span>&nbsp;<span class="op" id="7456546">:=</span>&nbsp;<span class="ident" id="7456549">strings</span><span class="op" id="7456556">.</span><span class="ident" id="7456557">Join</span><span class="op" id="7456561">(</span><span class="ident" id="7456562">strings</span><span class="op" id="7456569">.</span><span class="ident" id="7456570">Split</span><span class="op" id="7456575">(</span><span class="ident" id="7456576">basicClient</span><span class="op" id="7456587">,</span>&nbsp;<span class="string" id="7456589">&#34;\n&#34;</span><span class="op" id="7456593">)</span><span class="op" id="7456594">,</span>&nbsp;<span class="string" id="7456596">&#34;\r\n&#34;</span><span class="op" id="7456602">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7456606">var</span>&nbsp;<span class="ident" id="7456610">cmdbuf</span>&nbsp;<span class="ident" id="7456617">bytes</span><span class="op" id="7456622">.</span><span class="ident" id="7456623">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7456631">bcmdbuf</span>&nbsp;<span class="op" id="7456639">:=</span>&nbsp;<span class="ident" id="7456642">bufio</span><span class="op" id="7456647">.</span><span class="ident" id="7456648">NewWriter</span><span class="op" id="7456657">(</span><span class="op" id="7456658">&amp;</span><span class="ident" id="7456659">cmdbuf</span><span class="op" id="7456665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7456668">var</span>&nbsp;<span class="ident" id="7456672">fake</span>&nbsp;<span class="ident" id="7456677">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7456684">fake</span><span class="op" id="7456688">.</span><span class="ident" id="7456689">ReadWriter</span>&nbsp;<span class="op" id="7456700">=</span>&nbsp;<span class="ident" id="7456702">bufio</span><span class="op" id="7456707">.</span><span class="ident" id="7456708">NewReadWriter</span><span class="op" id="7456721">(</span><span class="ident" id="7456722">bufio</span><span class="op" id="7456727">.</span><span class="ident" id="7456728">NewReader</span><span class="op" id="7456737">(</span><span class="ident" id="7456738">strings</span><span class="op" id="7456745">.</span><span class="ident" id="7456746">NewReader</span><span class="op" id="7456755">(</span><span class="ident" id="7456756">server</span><span class="op" id="7456762">)</span><span class="op" id="7456763">)</span><span class="op" id="7456764">,</span>&nbsp;<span class="ident" id="7456766">bcmdbuf</span><span class="op" id="7456773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7456776">c</span>&nbsp;<span class="op" id="7456778">:=</span>&nbsp;<span class="op" id="7456781">&amp;</span><span class="ident" id="7456782">Client</span><span class="op" id="7456788">{</span><span class="ident" id="7456789">Text</span><span class="op" id="7456793">:</span>&nbsp;<span class="ident" id="7456795">textproto</span><span class="op" id="7456804">.</span><span class="ident" id="7456805">NewConn</span><span class="op" id="7456812">(</span><span class="ident" id="7456813">fake</span><span class="op" id="7456817">)</span><span class="op" id="7456818">,</span>&nbsp;<span class="ident" id="7456820">localName</span><span class="op" id="7456829">:</span>&nbsp;<span class="string" id="7456831">&#34;localhost&#34;</span><span class="op" id="7456842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7456846">if</span>&nbsp;<span class="ident" id="7456849">err</span>&nbsp;<span class="op" id="7456853">:=</span>&nbsp;<span class="ident" id="7456856">c</span><span class="op" id="7456857">.</span><span class="ident" id="7456858">helo</span><span class="op" id="7456862">(</span><span class="op" id="7456863">)</span><span class="op" id="7456864">;</span>&nbsp;<span class="ident" id="7456866">err</span>&nbsp;<span class="op" id="7456870">!=</span>&nbsp;<span class="ident" id="7456873">nil</span>&nbsp;<span class="op" id="7456877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7456881">t</span><span class="op" id="7456882">.</span><span class="ident" id="7456883">Fatalf</span><span class="op" id="7456889">(</span><span class="string" id="7456890">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7456907">,</span>&nbsp;<span class="ident" id="7456909">err</span><span class="op" id="7456912">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7456915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7456918">if</span>&nbsp;<span class="ident" id="7456921">err</span>&nbsp;<span class="op" id="7456925">:=</span>&nbsp;<span class="ident" id="7456928">c</span><span class="op" id="7456929">.</span><span class="ident" id="7456930">ehlo</span><span class="op" id="7456934">(</span><span class="op" id="7456935">)</span><span class="op" id="7456936">;</span>&nbsp;<span class="ident" id="7456938">err</span>&nbsp;<span class="op" id="7456942">==</span>&nbsp;<span class="ident" id="7456945">nil</span>&nbsp;<span class="op" id="7456949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7456953">t</span><span class="op" id="7456954">.</span><span class="ident" id="7456955">Fatalf</span><span class="op" id="7456961">(</span><span class="string" id="7456962">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="7456991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7456994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7456997">if</span>&nbsp;<span class="ident" id="7457000">err</span>&nbsp;<span class="op" id="7457004">:=</span>&nbsp;<span class="ident" id="7457007">c</span><span class="op" id="7457008">.</span><span class="ident" id="7457009">ehlo</span><span class="op" id="7457013">(</span><span class="op" id="7457014">)</span><span class="op" id="7457015">;</span>&nbsp;<span class="ident" id="7457017">err</span>&nbsp;<span class="op" id="7457021">!=</span>&nbsp;<span class="ident" id="7457024">nil</span>&nbsp;<span class="op" id="7457028">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7457032">t</span><span class="op" id="7457033">.</span><span class="ident" id="7457034">Fatalf</span><span class="op" id="7457040">(</span><span class="string" id="7457041">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7457065">,</span>&nbsp;<span class="ident" id="7457067">err</span><span class="op" id="7457070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7457073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7457077">c</span><span class="op" id="7457078">.</span><span class="ident" id="7457079">didHello</span>&nbsp;<span class="op" id="7457088">=</span>&nbsp;<span class="builtintype" id="7457090">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7457096">if</span>&nbsp;<span class="ident" id="7457099">ok</span><span class="op" id="7457101">,</span>&nbsp;<span class="ident" id="7457103">args</span>&nbsp;<span class="op" id="7457108">:=</span>&nbsp;<span class="ident" id="7457111">c</span><span class="op" id="7457112">.</span><span class="ident" id="7457113">Extension</span><span class="op" id="7457122">(</span><span class="string" id="7457123">&#34;aUtH&#34;</span><span class="op" id="7457129">)</span><span class="op" id="7457130">;</span>&nbsp;<span class="op" id="7457132">!</span><span class="ident" id="7457133">ok</span>&nbsp;<span class="op" id="7457136">||</span>&nbsp;<span class="ident" id="7457139">args</span>&nbsp;<span class="op" id="7457144">!=</span>&nbsp;<span class="string" id="7457147">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="7457161">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7457165">t</span><span class="op" id="7457166">.</span><span class="ident" id="7457167">Fatalf</span><span class="op" id="7457173">(</span><span class="string" id="7457174">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="7457199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7457202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7457205">if</span>&nbsp;<span class="ident" id="7457208">ok</span><span class="op" id="7457210">,</span>&nbsp;<span class="ident" id="7457212">_</span>&nbsp;<span class="op" id="7457214">:=</span>&nbsp;<span class="ident" id="7457217">c</span><span class="op" id="7457218">.</span><span class="ident" id="7457219">Extension</span><span class="op" id="7457228">(</span><span class="string" id="7457229">&#34;DSN&#34;</span><span class="op" id="7457234">)</span><span class="op" id="7457235">;</span>&nbsp;<span class="ident" id="7457237">ok</span>&nbsp;<span class="op" id="7457240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7457244">t</span><span class="op" id="7457245">.</span><span class="ident" id="7457246">Fatalf</span><span class="op" id="7457252">(</span><span class="string" id="7457253">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="7457276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7457279">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7457283">if</span>&nbsp;<span class="ident" id="7457286">err</span>&nbsp;<span class="op" id="7457290">:=</span>&nbsp;<span class="ident" id="7457293">c</span><span class="op" id="7457294">.</span><span class="ident" id="7457295">Mail</span><span class="op" id="7457299">(</span><span class="string" id="7457300">&#34;user@gmail.com&#34;</span><span class="op" id="7457316">)</span><span class="op" id="7457317">;</span>&nbsp;<span class="ident" id="7457319">err</span>&nbsp;<span class="op" id="7457323">==</span>&nbsp;<span class="ident" id="7457326">nil</span>&nbsp;<span class="op" id="7457330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7457334">t</span><span class="op" id="7457335">.</span><span class="ident" id="7457336">Fatalf</span><span class="op" id="7457342">(</span><span class="string" id="7457343">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="7457379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7457382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7457386">if</span>&nbsp;<span class="ident" id="7457389">err</span>&nbsp;<span class="op" id="7457393">:=</span>&nbsp;<span class="ident" id="7457396">c</span><span class="op" id="7457397">.</span><span class="ident" id="7457398">Verify</span><span class="op" id="7457404">(</span><span class="string" id="7457405">&#34;user1@gmail.com&#34;</span><span class="op" id="7457422">)</span><span class="op" id="7457423">;</span>&nbsp;<span class="ident" id="7457425">err</span>&nbsp;<span class="op" id="7457429">==</span>&nbsp;<span class="ident" id="7457432">nil</span>&nbsp;<span class="op" id="7457436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7457440">t</span><span class="op" id="7457441">.</span><span class="ident" id="7457442">Fatalf</span><span class="op" id="7457448">(</span><span class="string" id="7457449">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="7457487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7457490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7457493">if</span>&nbsp;<span class="ident" id="7457496">err</span>&nbsp;<span class="op" id="7457500">:=</span>&nbsp;<span class="ident" id="7457503">c</span><span class="op" id="7457504">.</span><span class="ident" id="7457505">Verify</span><span class="op" id="7457511">(</span><span class="string" id="7457512">&#34;user2@gmail.com&#34;</span><span class="op" id="7457529">)</span><span class="op" id="7457530">;</span>&nbsp;<span class="ident" id="7457532">err</span>&nbsp;<span class="op" id="7457536">!=</span>&nbsp;<span class="ident" id="7457539">nil</span>&nbsp;<span class="op" id="7457543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7457547">t</span><span class="op" id="7457548">.</span><span class="ident" id="7457549">Fatalf</span><span class="op" id="7457555">(</span><span class="string" id="7457556">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="7457600">,</span>&nbsp;<span class="ident" id="7457602">err</span><span class="op" id="7457605">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7457608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7457612">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7457658">c</span><span class="op" id="7457659">.</span><span class="ident" id="7457660">tls</span>&nbsp;<span class="op" id="7457664">=</span>&nbsp;<span class="builtintype" id="7457666">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7457672">c</span><span class="op" id="7457673">.</span><span class="ident" id="7457674">serverName</span>&nbsp;<span class="op" id="7457685">=</span>&nbsp;<span class="string" id="7457687">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7457706">if</span>&nbsp;<span class="ident" id="7457709">err</span>&nbsp;<span class="op" id="7457713">:=</span>&nbsp;<span class="ident" id="7457716">c</span><span class="op" id="7457717">.</span><span class="ident" id="7457718">Auth</span><span class="op" id="7457722">(</span><span class="ident" id="7457723">PlainAuth</span><span class="op" id="7457732">(</span><span class="string" id="7457733">&#34;&#34;</span><span class="op" id="7457735">,</span>&nbsp;<span class="string" id="7457737">&#34;user&#34;</span><span class="op" id="7457743">,</span>&nbsp;<span class="string" id="7457745">&#34;pass&#34;</span><span class="op" id="7457751">,</span>&nbsp;<span class="string" id="7457753">&#34;smtp.google.com&#34;</span><span class="op" id="7457770">)</span><span class="op" id="7457771">)</span><span class="op" id="7457772">;</span>&nbsp;<span class="ident" id="7457774">err</span>&nbsp;<span class="op" id="7457778">!=</span>&nbsp;<span class="ident" id="7457781">nil</span>&nbsp;<span class="op" id="7457785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7457789">t</span><span class="op" id="7457790">.</span><span class="ident" id="7457791">Fatalf</span><span class="op" id="7457797">(</span><span class="string" id="7457798">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7457815">,</span>&nbsp;<span class="ident" id="7457817">err</span><span class="op" id="7457820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7457823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7457827">if</span>&nbsp;<span class="ident" id="7457830">err</span>&nbsp;<span class="op" id="7457834">:=</span>&nbsp;<span class="ident" id="7457837">c</span><span class="op" id="7457838">.</span><span class="ident" id="7457839">Mail</span><span class="op" id="7457843">(</span><span class="string" id="7457844">&#34;user@gmail.com&#34;</span><span class="op" id="7457860">)</span><span class="op" id="7457861">;</span>&nbsp;<span class="ident" id="7457863">err</span>&nbsp;<span class="op" id="7457867">!=</span>&nbsp;<span class="ident" id="7457870">nil</span>&nbsp;<span class="op" id="7457874">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7457878">t</span><span class="op" id="7457879">.</span><span class="ident" id="7457880">Fatalf</span><span class="op" id="7457886">(</span><span class="string" id="7457887">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7457904">,</span>&nbsp;<span class="ident" id="7457906">err</span><span class="op" id="7457909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7457912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7457915">if</span>&nbsp;<span class="ident" id="7457918">err</span>&nbsp;<span class="op" id="7457922">:=</span>&nbsp;<span class="ident" id="7457925">c</span><span class="op" id="7457926">.</span><span class="ident" id="7457927">Rcpt</span><span class="op" id="7457931">(</span><span class="string" id="7457932">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="7457962">)</span><span class="op" id="7457963">;</span>&nbsp;<span class="ident" id="7457965">err</span>&nbsp;<span class="op" id="7457969">!=</span>&nbsp;<span class="ident" id="7457972">nil</span>&nbsp;<span class="op" id="7457976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7457980">t</span><span class="op" id="7457981">.</span><span class="ident" id="7457982">Fatalf</span><span class="op" id="7457988">(</span><span class="string" id="7457989">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7458006">,</span>&nbsp;<span class="ident" id="7458008">err</span><span class="op" id="7458011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7458014">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7458017">msg</span>&nbsp;<span class="op" id="7458021">:=</span>&nbsp;<span class="string" id="7458024">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7458141">w</span><span class="op" id="7458142">,</span>&nbsp;<span class="ident" id="7458144">err</span>&nbsp;<span class="op" id="7458148">:=</span>&nbsp;<span class="ident" id="7458151">c</span><span class="op" id="7458152">.</span><span class="ident" id="7458153">Data</span><span class="op" id="7458157">(</span><span class="op" id="7458158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7458161">if</span>&nbsp;<span class="ident" id="7458164">err</span>&nbsp;<span class="op" id="7458168">!=</span>&nbsp;<span class="ident" id="7458171">nil</span>&nbsp;<span class="op" id="7458175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7458179">t</span><span class="op" id="7458180">.</span><span class="ident" id="7458181">Fatalf</span><span class="op" id="7458187">(</span><span class="string" id="7458188">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7458205">,</span>&nbsp;<span class="ident" id="7458207">err</span><span class="op" id="7458210">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7458213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7458216">if</span>&nbsp;<span class="ident" id="7458219">_</span><span class="op" id="7458220">,</span>&nbsp;<span class="ident" id="7458222">err</span>&nbsp;<span class="op" id="7458226">:=</span>&nbsp;<span class="ident" id="7458229">w</span><span class="op" id="7458230">.</span><span class="ident" id="7458231">Write</span><span class="op" id="7458236">(</span><span class="op" id="7458237">[</span><span class="op" id="7458238">]</span><span class="builtintype" id="7458239">byte</span><span class="op" id="7458243">(</span><span class="ident" id="7458244">msg</span><span class="op" id="7458247">)</span><span class="op" id="7458248">)</span><span class="op" id="7458249">;</span>&nbsp;<span class="ident" id="7458251">err</span>&nbsp;<span class="op" id="7458255">!=</span>&nbsp;<span class="ident" id="7458258">nil</span>&nbsp;<span class="op" id="7458262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7458266">t</span><span class="op" id="7458267">.</span><span class="ident" id="7458268">Fatalf</span><span class="op" id="7458274">(</span><span class="string" id="7458275">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7458298">,</span>&nbsp;<span class="ident" id="7458300">err</span><span class="op" id="7458303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7458306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7458309">if</span>&nbsp;<span class="ident" id="7458312">err</span>&nbsp;<span class="op" id="7458316">:=</span>&nbsp;<span class="ident" id="7458319">w</span><span class="op" id="7458320">.</span><span class="ident" id="7458321">Close</span><span class="op" id="7458326">(</span><span class="op" id="7458327">)</span><span class="op" id="7458328">;</span>&nbsp;<span class="ident" id="7458330">err</span>&nbsp;<span class="op" id="7458334">!=</span>&nbsp;<span class="ident" id="7458337">nil</span>&nbsp;<span class="op" id="7458341">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7458345">t</span><span class="op" id="7458346">.</span><span class="ident" id="7458347">Fatalf</span><span class="op" id="7458353">(</span><span class="string" id="7458354">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="7458377">,</span>&nbsp;<span class="ident" id="7458379">err</span><span class="op" id="7458382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7458385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7458389">if</span>&nbsp;<span class="ident" id="7458392">err</span>&nbsp;<span class="op" id="7458396">:=</span>&nbsp;<span class="ident" id="7458399">c</span><span class="op" id="7458400">.</span><span class="ident" id="7458401">Quit</span><span class="op" id="7458405">(</span><span class="op" id="7458406">)</span><span class="op" id="7458407">;</span>&nbsp;<span class="ident" id="7458409">err</span>&nbsp;<span class="op" id="7458413">!=</span>&nbsp;<span class="ident" id="7458416">nil</span>&nbsp;<span class="op" id="7458420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7458424">t</span><span class="op" id="7458425">.</span><span class="ident" id="7458426">Fatalf</span><span class="op" id="7458432">(</span><span class="string" id="7458433">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7458450">,</span>&nbsp;<span class="ident" id="7458452">err</span><span class="op" id="7458455">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7458458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7458462">bcmdbuf</span><span class="op" id="7458469">.</span><span class="ident" id="7458470">Flush</span><span class="op" id="7458475">(</span><span class="op" id="7458476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7458479">actualcmds</span>&nbsp;<span class="op" id="7458490">:=</span>&nbsp;<span class="ident" id="7458493">cmdbuf</span><span class="op" id="7458499">.</span><span class="ident" id="7458500">String</span><span class="op" id="7458506">(</span><span class="op" id="7458507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7458510">if</span>&nbsp;<span class="ident" id="7458513">client</span>&nbsp;<span class="op" id="7458520">!=</span>&nbsp;<span class="ident" id="7458523">actualcmds</span>&nbsp;<span class="op" id="7458534">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7458538">t</span><span class="op" id="7458539">.</span><span class="ident" id="7458540">Fatalf</span><span class="op" id="7458546">(</span><span class="string" id="7458547">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7458572">,</span>&nbsp;<span class="ident" id="7458574">actualcmds</span><span class="op" id="7458584">,</span>&nbsp;<span class="ident" id="7458586">client</span><span class="op" id="7458592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7458595">}</span><br>
<span class="lineno"></span><span class="op" id="7458597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7458600">var</span>&nbsp;<span class="ident" id="7458604">basicServer</span>&nbsp;<span class="op" id="7458616">=</span>&nbsp;<span class="string" id="7458618">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="7458926">var</span>&nbsp;<span class="ident" id="7458930">basicClient</span>&nbsp;<span class="op" id="7458942">=</span>&nbsp;<span class="string" id="7458944">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7459311">func</span>&nbsp;<span class="ident" id="7459316">TestNewClient</span><span class="op" id="7459329">(</span><span class="ident" id="7459330">t</span>&nbsp;<span class="op" id="7459332">*</span><span class="ident" id="7459333">testing</span><span class="op" id="7459340">.</span><span class="ident" id="7459341">T</span><span class="op" id="7459342">)</span>&nbsp;<span class="op" id="7459344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7459347">server</span>&nbsp;<span class="op" id="7459354">:=</span>&nbsp;<span class="ident" id="7459357">strings</span><span class="op" id="7459364">.</span><span class="ident" id="7459365">Join</span><span class="op" id="7459369">(</span><span class="ident" id="7459370">strings</span><span class="op" id="7459377">.</span><span class="ident" id="7459378">Split</span><span class="op" id="7459383">(</span><span class="ident" id="7459384">newClientServer</span><span class="op" id="7459399">,</span>&nbsp;<span class="string" id="7459401">&#34;\n&#34;</span><span class="op" id="7459405">)</span><span class="op" id="7459406">,</span>&nbsp;<span class="string" id="7459408">&#34;\r\n&#34;</span><span class="op" id="7459414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7459417">client</span>&nbsp;<span class="op" id="7459424">:=</span>&nbsp;<span class="ident" id="7459427">strings</span><span class="op" id="7459434">.</span><span class="ident" id="7459435">Join</span><span class="op" id="7459439">(</span><span class="ident" id="7459440">strings</span><span class="op" id="7459447">.</span><span class="ident" id="7459448">Split</span><span class="op" id="7459453">(</span><span class="ident" id="7459454">newClientClient</span><span class="op" id="7459469">,</span>&nbsp;<span class="string" id="7459471">&#34;\n&#34;</span><span class="op" id="7459475">)</span><span class="op" id="7459476">,</span>&nbsp;<span class="string" id="7459478">&#34;\r\n&#34;</span><span class="op" id="7459484">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7459488">var</span>&nbsp;<span class="ident" id="7459492">cmdbuf</span>&nbsp;<span class="ident" id="7459499">bytes</span><span class="op" id="7459504">.</span><span class="ident" id="7459505">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7459513">bcmdbuf</span>&nbsp;<span class="op" id="7459521">:=</span>&nbsp;<span class="ident" id="7459524">bufio</span><span class="op" id="7459529">.</span><span class="ident" id="7459530">NewWriter</span><span class="op" id="7459539">(</span><span class="op" id="7459540">&amp;</span><span class="ident" id="7459541">cmdbuf</span><span class="op" id="7459547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7459550">out</span>&nbsp;<span class="op" id="7459554">:=</span>&nbsp;<span class="keyword" id="7459557">func</span><span class="op" id="7459561">(</span><span class="op" id="7459562">)</span>&nbsp;<span class="builtintype" id="7459564">string</span>&nbsp;<span class="op" id="7459571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7459575">bcmdbuf</span><span class="op" id="7459582">.</span><span class="ident" id="7459583">Flush</span><span class="op" id="7459588">(</span><span class="op" id="7459589">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7459593">return</span>&nbsp;<span class="ident" id="7459600">cmdbuf</span><span class="op" id="7459606">.</span><span class="ident" id="7459607">String</span><span class="op" id="7459613">(</span><span class="op" id="7459614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7459617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7459620">var</span>&nbsp;<span class="ident" id="7459624">fake</span>&nbsp;<span class="ident" id="7459629">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7459636">fake</span><span class="op" id="7459640">.</span><span class="ident" id="7459641">ReadWriter</span>&nbsp;<span class="op" id="7459652">=</span>&nbsp;<span class="ident" id="7459654">bufio</span><span class="op" id="7459659">.</span><span class="ident" id="7459660">NewReadWriter</span><span class="op" id="7459673">(</span><span class="ident" id="7459674">bufio</span><span class="op" id="7459679">.</span><span class="ident" id="7459680">NewReader</span><span class="op" id="7459689">(</span><span class="ident" id="7459690">strings</span><span class="op" id="7459697">.</span><span class="ident" id="7459698">NewReader</span><span class="op" id="7459707">(</span><span class="ident" id="7459708">server</span><span class="op" id="7459714">)</span><span class="op" id="7459715">)</span><span class="op" id="7459716">,</span>&nbsp;<span class="ident" id="7459718">bcmdbuf</span><span class="op" id="7459725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7459728">c</span><span class="op" id="7459729">,</span>&nbsp;<span class="ident" id="7459731">err</span>&nbsp;<span class="op" id="7459735">:=</span>&nbsp;<span class="ident" id="7459738">NewClient</span><span class="op" id="7459747">(</span><span class="ident" id="7459748">fake</span><span class="op" id="7459752">,</span>&nbsp;<span class="string" id="7459754">&#34;fake.host&#34;</span><span class="op" id="7459765">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7459768">if</span>&nbsp;<span class="ident" id="7459771">err</span>&nbsp;<span class="op" id="7459775">!=</span>&nbsp;<span class="ident" id="7459778">nil</span>&nbsp;<span class="op" id="7459782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7459786">t</span><span class="op" id="7459787">.</span><span class="ident" id="7459788">Fatalf</span><span class="op" id="7459794">(</span><span class="string" id="7459795">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="7459822">,</span>&nbsp;<span class="ident" id="7459824">err</span><span class="op" id="7459827">,</span>&nbsp;<span class="ident" id="7459829">out</span><span class="op" id="7459832">(</span><span class="op" id="7459833">)</span><span class="op" id="7459834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7459837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7459840">defer</span>&nbsp;<span class="ident" id="7459846">c</span><span class="op" id="7459847">.</span><span class="ident" id="7459848">Close</span><span class="op" id="7459853">(</span><span class="op" id="7459854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7459857">if</span>&nbsp;<span class="ident" id="7459860">ok</span><span class="op" id="7459862">,</span>&nbsp;<span class="ident" id="7459864">args</span>&nbsp;<span class="op" id="7459869">:=</span>&nbsp;<span class="ident" id="7459872">c</span><span class="op" id="7459873">.</span><span class="ident" id="7459874">Extension</span><span class="op" id="7459883">(</span><span class="string" id="7459884">&#34;aUtH&#34;</span><span class="op" id="7459890">)</span><span class="op" id="7459891">;</span>&nbsp;<span class="op" id="7459893">!</span><span class="ident" id="7459894">ok</span>&nbsp;<span class="op" id="7459897">||</span>&nbsp;<span class="ident" id="7459900">args</span>&nbsp;<span class="op" id="7459905">!=</span>&nbsp;<span class="string" id="7459908">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="7459922">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7459926">t</span><span class="op" id="7459927">.</span><span class="ident" id="7459928">Fatalf</span><span class="op" id="7459934">(</span><span class="string" id="7459935">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="7459960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7459963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7459966">if</span>&nbsp;<span class="ident" id="7459969">ok</span><span class="op" id="7459971">,</span>&nbsp;<span class="ident" id="7459973">_</span>&nbsp;<span class="op" id="7459975">:=</span>&nbsp;<span class="ident" id="7459978">c</span><span class="op" id="7459979">.</span><span class="ident" id="7459980">Extension</span><span class="op" id="7459989">(</span><span class="string" id="7459990">&#34;DSN&#34;</span><span class="op" id="7459995">)</span><span class="op" id="7459996">;</span>&nbsp;<span class="ident" id="7459998">ok</span>&nbsp;<span class="op" id="7460001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7460005">t</span><span class="op" id="7460006">.</span><span class="ident" id="7460007">Fatalf</span><span class="op" id="7460013">(</span><span class="string" id="7460014">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="7460037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7460040">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7460043">if</span>&nbsp;<span class="ident" id="7460046">err</span>&nbsp;<span class="op" id="7460050">:=</span>&nbsp;<span class="ident" id="7460053">c</span><span class="op" id="7460054">.</span><span class="ident" id="7460055">Quit</span><span class="op" id="7460059">(</span><span class="op" id="7460060">)</span><span class="op" id="7460061">;</span>&nbsp;<span class="ident" id="7460063">err</span>&nbsp;<span class="op" id="7460067">!=</span>&nbsp;<span class="ident" id="7460070">nil</span>&nbsp;<span class="op" id="7460074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7460078">t</span><span class="op" id="7460079">.</span><span class="ident" id="7460080">Fatalf</span><span class="op" id="7460086">(</span><span class="string" id="7460087">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7460104">,</span>&nbsp;<span class="ident" id="7460106">err</span><span class="op" id="7460109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7460112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7460116">actualcmds</span>&nbsp;<span class="op" id="7460127">:=</span>&nbsp;<span class="ident" id="7460130">out</span><span class="op" id="7460133">(</span><span class="op" id="7460134">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7460137">if</span>&nbsp;<span class="ident" id="7460140">client</span>&nbsp;<span class="op" id="7460147">!=</span>&nbsp;<span class="ident" id="7460150">actualcmds</span>&nbsp;<span class="op" id="7460161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7460165">t</span><span class="op" id="7460166">.</span><span class="ident" id="7460167">Fatalf</span><span class="op" id="7460173">(</span><span class="string" id="7460174">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7460199">,</span>&nbsp;<span class="ident" id="7460201">actualcmds</span><span class="op" id="7460211">,</span>&nbsp;<span class="ident" id="7460213">client</span><span class="op" id="7460219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7460222">}</span><br>
<span class="lineno"></span><span class="op" id="7460224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="7460227">var</span>&nbsp;<span class="ident" id="7460231">newClientServer</span>&nbsp;<span class="op" id="7460247">=</span>&nbsp;<span class="string" id="7460249">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7460362">var</span>&nbsp;<span class="ident" id="7460366">newClientClient</span>&nbsp;<span class="op" id="7460382">=</span>&nbsp;<span class="string" id="7460384">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7460408">func</span>&nbsp;<span class="ident" id="7460413">TestNewClient2</span><span class="op" id="7460427">(</span><span class="ident" id="7460428">t</span>&nbsp;<span class="op" id="7460430">*</span><span class="ident" id="7460431">testing</span><span class="op" id="7460438">.</span><span class="ident" id="7460439">T</span><span class="op" id="7460440">)</span>&nbsp;<span class="op" id="7460442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7460445">server</span>&nbsp;<span class="op" id="7460452">:=</span>&nbsp;<span class="ident" id="7460455">strings</span><span class="op" id="7460462">.</span><span class="ident" id="7460463">Join</span><span class="op" id="7460467">(</span><span class="ident" id="7460468">strings</span><span class="op" id="7460475">.</span><span class="ident" id="7460476">Split</span><span class="op" id="7460481">(</span><span class="ident" id="7460482">newClient2Server</span><span class="op" id="7460498">,</span>&nbsp;<span class="string" id="7460500">&#34;\n&#34;</span><span class="op" id="7460504">)</span><span class="op" id="7460505">,</span>&nbsp;<span class="string" id="7460507">&#34;\r\n&#34;</span><span class="op" id="7460513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7460516">client</span>&nbsp;<span class="op" id="7460523">:=</span>&nbsp;<span class="ident" id="7460526">strings</span><span class="op" id="7460533">.</span><span class="ident" id="7460534">Join</span><span class="op" id="7460538">(</span><span class="ident" id="7460539">strings</span><span class="op" id="7460546">.</span><span class="ident" id="7460547">Split</span><span class="op" id="7460552">(</span><span class="ident" id="7460553">newClient2Client</span><span class="op" id="7460569">,</span>&nbsp;<span class="string" id="7460571">&#34;\n&#34;</span><span class="op" id="7460575">)</span><span class="op" id="7460576">,</span>&nbsp;<span class="string" id="7460578">&#34;\r\n&#34;</span><span class="op" id="7460584">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7460588">var</span>&nbsp;<span class="ident" id="7460592">cmdbuf</span>&nbsp;<span class="ident" id="7460599">bytes</span><span class="op" id="7460604">.</span><span class="ident" id="7460605">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7460613">bcmdbuf</span>&nbsp;<span class="op" id="7460621">:=</span>&nbsp;<span class="ident" id="7460624">bufio</span><span class="op" id="7460629">.</span><span class="ident" id="7460630">NewWriter</span><span class="op" id="7460639">(</span><span class="op" id="7460640">&amp;</span><span class="ident" id="7460641">cmdbuf</span><span class="op" id="7460647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7460650">var</span>&nbsp;<span class="ident" id="7460654">fake</span>&nbsp;<span class="ident" id="7460659">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7460666">fake</span><span class="op" id="7460670">.</span><span class="ident" id="7460671">ReadWriter</span>&nbsp;<span class="op" id="7460682">=</span>&nbsp;<span class="ident" id="7460684">bufio</span><span class="op" id="7460689">.</span><span class="ident" id="7460690">NewReadWriter</span><span class="op" id="7460703">(</span><span class="ident" id="7460704">bufio</span><span class="op" id="7460709">.</span><span class="ident" id="7460710">NewReader</span><span class="op" id="7460719">(</span><span class="ident" id="7460720">strings</span><span class="op" id="7460727">.</span><span class="ident" id="7460728">NewReader</span><span class="op" id="7460737">(</span><span class="ident" id="7460738">server</span><span class="op" id="7460744">)</span><span class="op" id="7460745">)</span><span class="op" id="7460746">,</span>&nbsp;<span class="ident" id="7460748">bcmdbuf</span><span class="op" id="7460755">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7460758">c</span><span class="op" id="7460759">,</span>&nbsp;<span class="ident" id="7460761">err</span>&nbsp;<span class="op" id="7460765">:=</span>&nbsp;<span class="ident" id="7460768">NewClient</span><span class="op" id="7460777">(</span><span class="ident" id="7460778">fake</span><span class="op" id="7460782">,</span>&nbsp;<span class="string" id="7460784">&#34;fake.host&#34;</span><span class="op" id="7460795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7460798">if</span>&nbsp;<span class="ident" id="7460801">err</span>&nbsp;<span class="op" id="7460805">!=</span>&nbsp;<span class="ident" id="7460808">nil</span>&nbsp;<span class="op" id="7460812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7460816">t</span><span class="op" id="7460817">.</span><span class="ident" id="7460818">Fatalf</span><span class="op" id="7460824">(</span><span class="string" id="7460825">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="7460840">,</span>&nbsp;<span class="ident" id="7460842">err</span><span class="op" id="7460845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7460848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7460851">defer</span>&nbsp;<span class="ident" id="7460857">c</span><span class="op" id="7460858">.</span><span class="ident" id="7460859">Close</span><span class="op" id="7460864">(</span><span class="op" id="7460865">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7460868">if</span>&nbsp;<span class="ident" id="7460871">ok</span><span class="op" id="7460873">,</span>&nbsp;<span class="ident" id="7460875">_</span>&nbsp;<span class="op" id="7460877">:=</span>&nbsp;<span class="ident" id="7460880">c</span><span class="op" id="7460881">.</span><span class="ident" id="7460882">Extension</span><span class="op" id="7460891">(</span><span class="string" id="7460892">&#34;DSN&#34;</span><span class="op" id="7460897">)</span><span class="op" id="7460898">;</span>&nbsp;<span class="ident" id="7460900">ok</span>&nbsp;<span class="op" id="7460903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7460907">t</span><span class="op" id="7460908">.</span><span class="ident" id="7460909">Fatalf</span><span class="op" id="7460915">(</span><span class="string" id="7460916">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="7460939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7460942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7460945">if</span>&nbsp;<span class="ident" id="7460948">err</span>&nbsp;<span class="op" id="7460952">:=</span>&nbsp;<span class="ident" id="7460955">c</span><span class="op" id="7460956">.</span><span class="ident" id="7460957">Quit</span><span class="op" id="7460961">(</span><span class="op" id="7460962">)</span><span class="op" id="7460963">;</span>&nbsp;<span class="ident" id="7460965">err</span>&nbsp;<span class="op" id="7460969">!=</span>&nbsp;<span class="ident" id="7460972">nil</span>&nbsp;<span class="op" id="7460976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7460980">t</span><span class="op" id="7460981">.</span><span class="ident" id="7460982">Fatalf</span><span class="op" id="7460988">(</span><span class="string" id="7460989">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7461006">,</span>&nbsp;<span class="ident" id="7461008">err</span><span class="op" id="7461011">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7461014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7461018">bcmdbuf</span><span class="op" id="7461025">.</span><span class="ident" id="7461026">Flush</span><span class="op" id="7461031">(</span><span class="op" id="7461032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7461035">actualcmds</span>&nbsp;<span class="op" id="7461046">:=</span>&nbsp;<span class="ident" id="7461049">cmdbuf</span><span class="op" id="7461055">.</span><span class="ident" id="7461056">String</span><span class="op" id="7461062">(</span><span class="op" id="7461063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7461066">if</span>&nbsp;<span class="ident" id="7461069">client</span>&nbsp;<span class="op" id="7461076">!=</span>&nbsp;<span class="ident" id="7461079">actualcmds</span>&nbsp;<span class="op" id="7461090">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7461094">t</span><span class="op" id="7461095">.</span><span class="ident" id="7461096">Fatalf</span><span class="op" id="7461102">(</span><span class="string" id="7461103">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7461128">,</span>&nbsp;<span class="ident" id="7461130">actualcmds</span><span class="op" id="7461140">,</span>&nbsp;<span class="ident" id="7461142">client</span><span class="op" id="7461148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7461151">}</span><br>
<span class="lineno"></span><span class="op" id="7461153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7461156">var</span>&nbsp;<span class="ident" id="7461160">newClient2Server</span>&nbsp;<span class="op" id="7461177">=</span>&nbsp;<span class="string" id="7461179">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7461300">var</span>&nbsp;<span class="ident" id="7461304">newClient2Client</span>&nbsp;<span class="op" id="7461321">=</span>&nbsp;<span class="string" id="7461323">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7461362">func</span>&nbsp;<span class="ident" id="7461367">TestHello</span><span class="op" id="7461376">(</span><span class="ident" id="7461377">t</span>&nbsp;<span class="op" id="7461379">*</span><span class="ident" id="7461380">testing</span><span class="op" id="7461387">.</span><span class="ident" id="7461388">T</span><span class="op" id="7461389">)</span>&nbsp;<span class="op" id="7461391">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7461395">if</span>&nbsp;<span class="builtinfunc" id="7461398">len</span><span class="op" id="7461401">(</span><span class="ident" id="7461402">helloServer</span><span class="op" id="7461413">)</span>&nbsp;<span class="op" id="7461415">!=</span>&nbsp;<span class="builtinfunc" id="7461418">len</span><span class="op" id="7461421">(</span><span class="ident" id="7461422">helloClient</span><span class="op" id="7461433">)</span>&nbsp;<span class="op" id="7461435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7461439">t</span><span class="op" id="7461440">.</span><span class="ident" id="7461441">Fatalf</span><span class="op" id="7461447">(</span><span class="string" id="7461448">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="7461487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7461490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7461494">for</span>&nbsp;<span class="ident" id="7461498">i</span>&nbsp;<span class="op" id="7461500">:=</span>&nbsp;<span class="num" id="7461503">0</span><span class="op" id="7461504">;</span>&nbsp;<span class="ident" id="7461506">i</span>&nbsp;<span class="op" id="7461508">&lt;</span>&nbsp;<span class="builtinfunc" id="7461510">len</span><span class="op" id="7461513">(</span><span class="ident" id="7461514">helloServer</span><span class="op" id="7461525">)</span><span class="op" id="7461526">;</span>&nbsp;<span class="ident" id="7461528">i</span><span class="op" id="7461529">++</span>&nbsp;<span class="op" id="7461532">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7461536">server</span>&nbsp;<span class="op" id="7461543">:=</span>&nbsp;<span class="ident" id="7461546">strings</span><span class="op" id="7461553">.</span><span class="ident" id="7461554">Join</span><span class="op" id="7461558">(</span><span class="ident" id="7461559">strings</span><span class="op" id="7461566">.</span><span class="ident" id="7461567">Split</span><span class="op" id="7461572">(</span><span class="ident" id="7461573">baseHelloServer</span><span class="op" id="7461588">+</span><span class="ident" id="7461589">helloServer</span><span class="op" id="7461600">[</span><span class="ident" id="7461601">i</span><span class="op" id="7461602">]</span><span class="op" id="7461603">,</span>&nbsp;<span class="string" id="7461605">&#34;\n&#34;</span><span class="op" id="7461609">)</span><span class="op" id="7461610">,</span>&nbsp;<span class="string" id="7461612">&#34;\r\n&#34;</span><span class="op" id="7461618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7461622">client</span>&nbsp;<span class="op" id="7461629">:=</span>&nbsp;<span class="ident" id="7461632">strings</span><span class="op" id="7461639">.</span><span class="ident" id="7461640">Join</span><span class="op" id="7461644">(</span><span class="ident" id="7461645">strings</span><span class="op" id="7461652">.</span><span class="ident" id="7461653">Split</span><span class="op" id="7461658">(</span><span class="ident" id="7461659">baseHelloClient</span><span class="op" id="7461674">+</span><span class="ident" id="7461675">helloClient</span><span class="op" id="7461686">[</span><span class="ident" id="7461687">i</span><span class="op" id="7461688">]</span><span class="op" id="7461689">,</span>&nbsp;<span class="string" id="7461691">&#34;\n&#34;</span><span class="op" id="7461695">)</span><span class="op" id="7461696">,</span>&nbsp;<span class="string" id="7461698">&#34;\r\n&#34;</span><span class="op" id="7461704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7461708">var</span>&nbsp;<span class="ident" id="7461712">cmdbuf</span>&nbsp;<span class="ident" id="7461719">bytes</span><span class="op" id="7461724">.</span><span class="ident" id="7461725">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7461734">bcmdbuf</span>&nbsp;<span class="op" id="7461742">:=</span>&nbsp;<span class="ident" id="7461745">bufio</span><span class="op" id="7461750">.</span><span class="ident" id="7461751">NewWriter</span><span class="op" id="7461760">(</span><span class="op" id="7461761">&amp;</span><span class="ident" id="7461762">cmdbuf</span><span class="op" id="7461768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7461772">var</span>&nbsp;<span class="ident" id="7461776">fake</span>&nbsp;<span class="ident" id="7461781">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7461789">fake</span><span class="op" id="7461793">.</span><span class="ident" id="7461794">ReadWriter</span>&nbsp;<span class="op" id="7461805">=</span>&nbsp;<span class="ident" id="7461807">bufio</span><span class="op" id="7461812">.</span><span class="ident" id="7461813">NewReadWriter</span><span class="op" id="7461826">(</span><span class="ident" id="7461827">bufio</span><span class="op" id="7461832">.</span><span class="ident" id="7461833">NewReader</span><span class="op" id="7461842">(</span><span class="ident" id="7461843">strings</span><span class="op" id="7461850">.</span><span class="ident" id="7461851">NewReader</span><span class="op" id="7461860">(</span><span class="ident" id="7461861">server</span><span class="op" id="7461867">)</span><span class="op" id="7461868">)</span><span class="op" id="7461869">,</span>&nbsp;<span class="ident" id="7461871">bcmdbuf</span><span class="op" id="7461878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7461882">c</span><span class="op" id="7461883">,</span>&nbsp;<span class="ident" id="7461885">err</span>&nbsp;<span class="op" id="7461889">:=</span>&nbsp;<span class="ident" id="7461892">NewClient</span><span class="op" id="7461901">(</span><span class="ident" id="7461902">fake</span><span class="op" id="7461906">,</span>&nbsp;<span class="string" id="7461908">&#34;fake.host&#34;</span><span class="op" id="7461919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7461923">if</span>&nbsp;<span class="ident" id="7461926">err</span>&nbsp;<span class="op" id="7461930">!=</span>&nbsp;<span class="ident" id="7461933">nil</span>&nbsp;<span class="op" id="7461937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7461942">t</span><span class="op" id="7461943">.</span><span class="ident" id="7461944">Fatalf</span><span class="op" id="7461950">(</span><span class="string" id="7461951">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="7461966">,</span>&nbsp;<span class="ident" id="7461968">err</span><span class="op" id="7461971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7461975">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7461979">defer</span>&nbsp;<span class="ident" id="7461985">c</span><span class="op" id="7461986">.</span><span class="ident" id="7461987">Close</span><span class="op" id="7461992">(</span><span class="op" id="7461993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7461997">c</span><span class="op" id="7461998">.</span><span class="ident" id="7461999">localName</span>&nbsp;<span class="op" id="7462009">=</span>&nbsp;<span class="string" id="7462011">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462026">err</span>&nbsp;<span class="op" id="7462030">=</span>&nbsp;<span class="ident" id="7462032">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462039">switch</span>&nbsp;<span class="ident" id="7462046">i</span>&nbsp;<span class="op" id="7462048">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462052">case</span>&nbsp;<span class="num" id="7462057">0</span><span class="op" id="7462058">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462063">err</span>&nbsp;<span class="op" id="7462067">=</span>&nbsp;<span class="ident" id="7462069">c</span><span class="op" id="7462070">.</span><span class="ident" id="7462071">Hello</span><span class="op" id="7462076">(</span><span class="string" id="7462077">&#34;customhost&#34;</span><span class="op" id="7462089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462093">case</span>&nbsp;<span class="num" id="7462098">1</span><span class="op" id="7462099">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462104">err</span>&nbsp;<span class="op" id="7462108">=</span>&nbsp;<span class="ident" id="7462110">c</span><span class="op" id="7462111">.</span><span class="ident" id="7462112">StartTLS</span><span class="op" id="7462120">(</span><span class="ident" id="7462121">nil</span><span class="op" id="7462124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462129">if</span>&nbsp;<span class="ident" id="7462132">err</span><span class="op" id="7462135">.</span><span class="ident" id="7462136">Error</span><span class="op" id="7462141">(</span><span class="op" id="7462142">)</span>&nbsp;<span class="op" id="7462144">==</span>&nbsp;<span class="string" id="7462147">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="7462169">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462175">err</span>&nbsp;<span class="op" id="7462179">=</span>&nbsp;<span class="ident" id="7462181">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7462188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462192">case</span>&nbsp;<span class="num" id="7462197">2</span><span class="op" id="7462198">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462203">err</span>&nbsp;<span class="op" id="7462207">=</span>&nbsp;<span class="ident" id="7462209">c</span><span class="op" id="7462210">.</span><span class="ident" id="7462211">Verify</span><span class="op" id="7462217">(</span><span class="string" id="7462218">&#34;test@example.com&#34;</span><span class="op" id="7462236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462240">case</span>&nbsp;<span class="num" id="7462245">3</span><span class="op" id="7462246">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462251">c</span><span class="op" id="7462252">.</span><span class="ident" id="7462253">tls</span>&nbsp;<span class="op" id="7462257">=</span>&nbsp;<span class="builtintype" id="7462259">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462267">c</span><span class="op" id="7462268">.</span><span class="ident" id="7462269">serverName</span>&nbsp;<span class="op" id="7462280">=</span>&nbsp;<span class="string" id="7462282">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462303">err</span>&nbsp;<span class="op" id="7462307">=</span>&nbsp;<span class="ident" id="7462309">c</span><span class="op" id="7462310">.</span><span class="ident" id="7462311">Auth</span><span class="op" id="7462315">(</span><span class="ident" id="7462316">PlainAuth</span><span class="op" id="7462325">(</span><span class="string" id="7462326">&#34;&#34;</span><span class="op" id="7462328">,</span>&nbsp;<span class="string" id="7462330">&#34;user&#34;</span><span class="op" id="7462336">,</span>&nbsp;<span class="string" id="7462338">&#34;pass&#34;</span><span class="op" id="7462344">,</span>&nbsp;<span class="string" id="7462346">&#34;smtp.google.com&#34;</span><span class="op" id="7462363">)</span><span class="op" id="7462364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462368">case</span>&nbsp;<span class="num" id="7462373">4</span><span class="op" id="7462374">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462379">err</span>&nbsp;<span class="op" id="7462383">=</span>&nbsp;<span class="ident" id="7462385">c</span><span class="op" id="7462386">.</span><span class="ident" id="7462387">Mail</span><span class="op" id="7462391">(</span><span class="string" id="7462392">&#34;test@example.com&#34;</span><span class="op" id="7462410">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462414">case</span>&nbsp;<span class="num" id="7462419">5</span><span class="op" id="7462420">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462425">ok</span><span class="op" id="7462427">,</span>&nbsp;<span class="ident" id="7462429">_</span>&nbsp;<span class="op" id="7462431">:=</span>&nbsp;<span class="ident" id="7462434">c</span><span class="op" id="7462435">.</span><span class="ident" id="7462436">Extension</span><span class="op" id="7462445">(</span><span class="string" id="7462446">&#34;feature&#34;</span><span class="op" id="7462455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462460">if</span>&nbsp;<span class="ident" id="7462463">ok</span>&nbsp;<span class="op" id="7462466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462472">t</span><span class="op" id="7462473">.</span><span class="ident" id="7462474">Errorf</span><span class="op" id="7462480">(</span><span class="string" id="7462481">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="7462519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7462524">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462528">case</span>&nbsp;<span class="num" id="7462533">6</span><span class="op" id="7462534">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462539">err</span>&nbsp;<span class="op" id="7462543">=</span>&nbsp;<span class="ident" id="7462545">c</span><span class="op" id="7462546">.</span><span class="ident" id="7462547">Reset</span><span class="op" id="7462552">(</span><span class="op" id="7462553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462557">case</span>&nbsp;<span class="num" id="7462562">7</span><span class="op" id="7462563">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462568">err</span>&nbsp;<span class="op" id="7462572">=</span>&nbsp;<span class="ident" id="7462574">c</span><span class="op" id="7462575">.</span><span class="ident" id="7462576">Quit</span><span class="op" id="7462580">(</span><span class="op" id="7462581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462585">case</span>&nbsp;<span class="num" id="7462590">8</span><span class="op" id="7462591">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462596">err</span>&nbsp;<span class="op" id="7462600">=</span>&nbsp;<span class="ident" id="7462602">c</span><span class="op" id="7462603">.</span><span class="ident" id="7462604">Verify</span><span class="op" id="7462610">(</span><span class="string" id="7462611">&#34;test@example.com&#34;</span><span class="op" id="7462629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462634">if</span>&nbsp;<span class="ident" id="7462637">err</span>&nbsp;<span class="op" id="7462641">!=</span>&nbsp;<span class="ident" id="7462644">nil</span>&nbsp;<span class="op" id="7462648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462654">err</span>&nbsp;<span class="op" id="7462658">=</span>&nbsp;<span class="ident" id="7462660">c</span><span class="op" id="7462661">.</span><span class="ident" id="7462662">Hello</span><span class="op" id="7462667">(</span><span class="string" id="7462668">&#34;customhost&#34;</span><span class="op" id="7462680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462686">if</span>&nbsp;<span class="ident" id="7462689">err</span>&nbsp;<span class="op" id="7462693">!=</span>&nbsp;<span class="ident" id="7462696">nil</span>&nbsp;<span class="op" id="7462700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462707">t</span><span class="op" id="7462708">.</span><span class="ident" id="7462709">Errorf</span><span class="op" id="7462715">(</span><span class="string" id="7462716">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="7462738">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7462744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7462749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462753">default</span><span class="op" id="7462760">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462765">t</span><span class="op" id="7462766">.</span><span class="ident" id="7462767">Fatalf</span><span class="op" id="7462773">(</span><span class="string" id="7462774">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="7462793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7462797">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462802">if</span>&nbsp;<span class="ident" id="7462805">err</span>&nbsp;<span class="op" id="7462809">!=</span>&nbsp;<span class="ident" id="7462812">nil</span>&nbsp;<span class="op" id="7462816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462821">t</span><span class="op" id="7462822">.</span><span class="ident" id="7462823">Errorf</span><span class="op" id="7462829">(</span><span class="string" id="7462830">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7462853">,</span>&nbsp;<span class="ident" id="7462855">i</span><span class="op" id="7462856">,</span>&nbsp;<span class="ident" id="7462858">err</span><span class="op" id="7462861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7462865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462870">bcmdbuf</span><span class="op" id="7462877">.</span><span class="ident" id="7462878">Flush</span><span class="op" id="7462883">(</span><span class="op" id="7462884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462888">actualcmds</span>&nbsp;<span class="op" id="7462899">:=</span>&nbsp;<span class="ident" id="7462902">cmdbuf</span><span class="op" id="7462908">.</span><span class="ident" id="7462909">String</span><span class="op" id="7462915">(</span><span class="op" id="7462916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7462920">if</span>&nbsp;<span class="ident" id="7462923">client</span>&nbsp;<span class="op" id="7462930">!=</span>&nbsp;<span class="ident" id="7462933">actualcmds</span>&nbsp;<span class="op" id="7462944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7462949">t</span><span class="op" id="7462950">.</span><span class="ident" id="7462951">Errorf</span><span class="op" id="7462957">(</span><span class="string" id="7462958">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7462983">,</span>&nbsp;<span class="ident" id="7462985">actualcmds</span><span class="op" id="7462995">,</span>&nbsp;<span class="ident" id="7462997">client</span><span class="op" id="7463003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7463007">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7463010">}</span><br>
<span class="lineno"></span><span class="op" id="7463012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7463015">var</span>&nbsp;<span class="ident" id="7463019">baseHelloServer</span>&nbsp;<span class="op" id="7463035">=</span>&nbsp;<span class="string" id="7463037">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7463111">var</span>&nbsp;<span class="ident" id="7463115">helloServer</span>&nbsp;<span class="op" id="7463127">=</span>&nbsp;<span class="op" id="7463129">[</span><span class="op" id="7463130">]</span><span class="builtintype" id="7463131">string</span><span class="op" id="7463137">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463140">&#34;&#34;</span><span class="op" id="7463142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463145">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="7463168">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463171">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="7463192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463195">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="7463211">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463214">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="7463231">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463234">&#34;&#34;</span><span class="op" id="7463236">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463239">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="7463255">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463258">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="7463273">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463276">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="7463293">,</span><br>
<span class="lineno"></span><span class="op" id="7463295">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="7463298">var</span>&nbsp;<span class="ident" id="7463302">baseHelloClient</span>&nbsp;<span class="op" id="7463318">=</span>&nbsp;<span class="string" id="7463320">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="7463356">var</span>&nbsp;<span class="ident" id="7463360">helloClient</span>&nbsp;<span class="op" id="7463372">=</span>&nbsp;<span class="op" id="7463374">[</span><span class="op" id="7463375">]</span><span class="builtintype" id="7463376">string</span><span class="op" id="7463382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463385">&#34;&#34;</span><span class="op" id="7463387">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463390">&#34;STARTTLS\n&#34;</span><span class="op" id="7463402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463405">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="7463430">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463433">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="7463464">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463467">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="7463499">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463502">&#34;&#34;</span><span class="op" id="7463504">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463507">&#34;RSET\n&#34;</span><span class="op" id="7463515">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463518">&#34;QUIT\n&#34;</span><span class="op" id="7463526">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7463529">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="7463554">,</span><br>
<span class="lineno">415</span><span class="op" id="7463556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7463559">func</span>&nbsp;<span class="ident" id="7463564">TestSendMail</span><span class="op" id="7463576">(</span><span class="ident" id="7463577">t</span>&nbsp;<span class="op" id="7463579">*</span><span class="ident" id="7463580">testing</span><span class="op" id="7463587">.</span><span class="ident" id="7463588">T</span><span class="op" id="7463589">)</span>&nbsp;<span class="op" id="7463591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7463594">server</span>&nbsp;<span class="op" id="7463601">:=</span>&nbsp;<span class="ident" id="7463604">strings</span><span class="op" id="7463611">.</span><span class="ident" id="7463612">Join</span><span class="op" id="7463616">(</span><span class="ident" id="7463617">strings</span><span class="op" id="7463624">.</span><span class="ident" id="7463625">Split</span><span class="op" id="7463630">(</span><span class="ident" id="7463631">sendMailServer</span><span class="op" id="7463645">,</span>&nbsp;<span class="string" id="7463647">&#34;\n&#34;</span><span class="op" id="7463651">)</span><span class="op" id="7463652">,</span>&nbsp;<span class="string" id="7463654">&#34;\r\n&#34;</span><span class="op" id="7463660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7463663">client</span>&nbsp;<span class="op" id="7463670">:=</span>&nbsp;<span class="ident" id="7463673">strings</span><span class="op" id="7463680">.</span><span class="ident" id="7463681">Join</span><span class="op" id="7463685">(</span><span class="ident" id="7463686">strings</span><span class="op" id="7463693">.</span><span class="ident" id="7463694">Split</span><span class="op" id="7463699">(</span><span class="ident" id="7463700">sendMailClient</span><span class="op" id="7463714">,</span>&nbsp;<span class="string" id="7463716">&#34;\n&#34;</span><span class="op" id="7463720">)</span><span class="op" id="7463721">,</span>&nbsp;<span class="string" id="7463723">&#34;\r\n&#34;</span><span class="op" id="7463729">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7463732">var</span>&nbsp;<span class="ident" id="7463736">cmdbuf</span>&nbsp;<span class="ident" id="7463743">bytes</span><span class="op" id="7463748">.</span><span class="ident" id="7463749">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7463757">bcmdbuf</span>&nbsp;<span class="op" id="7463765">:=</span>&nbsp;<span class="ident" id="7463768">bufio</span><span class="op" id="7463773">.</span><span class="ident" id="7463774">NewWriter</span><span class="op" id="7463783">(</span><span class="op" id="7463784">&amp;</span><span class="ident" id="7463785">cmdbuf</span><span class="op" id="7463791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7463794">l</span><span class="op" id="7463795">,</span>&nbsp;<span class="ident" id="7463797">err</span>&nbsp;<span class="op" id="7463801">:=</span>&nbsp;<span class="ident" id="7463804">net</span><span class="op" id="7463807">.</span><span class="ident" id="7463808">Listen</span><span class="op" id="7463814">(</span><span class="string" id="7463815">&#34;tcp&#34;</span><span class="op" id="7463820">,</span>&nbsp;<span class="string" id="7463822">&#34;127.0.0.1:0&#34;</span><span class="op" id="7463835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7463838">if</span>&nbsp;<span class="ident" id="7463841">err</span>&nbsp;<span class="op" id="7463845">!=</span>&nbsp;<span class="ident" id="7463848">nil</span>&nbsp;<span class="op" id="7463852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7463856">t</span><span class="op" id="7463857">.</span><span class="ident" id="7463858">Fatalf</span><span class="op" id="7463864">(</span><span class="string" id="7463865">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="7463899">,</span>&nbsp;<span class="ident" id="7463901">err</span><span class="op" id="7463904">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7463907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7463910">defer</span>&nbsp;<span class="ident" id="7463916">l</span><span class="op" id="7463917">.</span><span class="ident" id="7463918">Close</span><span class="op" id="7463923">(</span><span class="op" id="7463924">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7463928">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7463961">var</span>&nbsp;<span class="ident" id="7463965">done</span>&nbsp;<span class="op" id="7463970">=</span>&nbsp;<span class="builtinfunc" id="7463972">make</span><span class="op" id="7463976">(</span><span class="keyword" id="7463977">chan</span>&nbsp;<span class="keyword" id="7463982">struct</span><span class="op" id="7463988">{</span><span class="op" id="7463989">}</span><span class="op" id="7463990">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7463993">go</span>&nbsp;<span class="keyword" id="7463996">func</span><span class="op" id="7464000">(</span><span class="ident" id="7464001">data</span>&nbsp;<span class="op" id="7464006">[</span><span class="op" id="7464007">]</span><span class="builtintype" id="7464008">string</span><span class="op" id="7464014">)</span>&nbsp;<span class="op" id="7464016">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464021">defer</span>&nbsp;<span class="builtinfunc" id="7464027">close</span><span class="op" id="7464032">(</span><span class="ident" id="7464033">done</span><span class="op" id="7464037">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464042">conn</span><span class="op" id="7464046">,</span>&nbsp;<span class="ident" id="7464048">err</span>&nbsp;<span class="op" id="7464052">:=</span>&nbsp;<span class="ident" id="7464055">l</span><span class="op" id="7464056">.</span><span class="ident" id="7464057">Accept</span><span class="op" id="7464063">(</span><span class="op" id="7464064">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464068">if</span>&nbsp;<span class="ident" id="7464071">err</span>&nbsp;<span class="op" id="7464075">!=</span>&nbsp;<span class="ident" id="7464078">nil</span>&nbsp;<span class="op" id="7464082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464087">t</span><span class="op" id="7464088">.</span><span class="ident" id="7464089">Errorf</span><span class="op" id="7464095">(</span><span class="string" id="7464096">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7464114">,</span>&nbsp;<span class="ident" id="7464116">err</span><span class="op" id="7464119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464124">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7464133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464137">defer</span>&nbsp;<span class="ident" id="7464143">conn</span><span class="op" id="7464147">.</span><span class="ident" id="7464148">Close</span><span class="op" id="7464153">(</span><span class="op" id="7464154">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464159">tc</span>&nbsp;<span class="op" id="7464162">:=</span>&nbsp;<span class="ident" id="7464165">textproto</span><span class="op" id="7464174">.</span><span class="ident" id="7464175">NewConn</span><span class="op" id="7464182">(</span><span class="ident" id="7464183">conn</span><span class="op" id="7464187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464191">for</span>&nbsp;<span class="ident" id="7464195">i</span>&nbsp;<span class="op" id="7464197">:=</span>&nbsp;<span class="num" id="7464200">0</span><span class="op" id="7464201">;</span>&nbsp;<span class="ident" id="7464203">i</span>&nbsp;<span class="op" id="7464205">&lt;</span>&nbsp;<span class="builtinfunc" id="7464207">len</span><span class="op" id="7464210">(</span><span class="ident" id="7464211">data</span><span class="op" id="7464215">)</span>&nbsp;<span class="op" id="7464217">&amp;&amp;</span>&nbsp;<span class="ident" id="7464220">data</span><span class="op" id="7464224">[</span><span class="ident" id="7464225">i</span><span class="op" id="7464226">]</span>&nbsp;<span class="op" id="7464228">!=</span>&nbsp;<span class="string" id="7464231">&#34;&#34;</span><span class="op" id="7464233">;</span>&nbsp;<span class="ident" id="7464235">i</span><span class="op" id="7464236">++</span>&nbsp;<span class="op" id="7464239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464244">tc</span><span class="op" id="7464246">.</span><span class="ident" id="7464247">PrintfLine</span><span class="op" id="7464257">(</span><span class="ident" id="7464258">data</span><span class="op" id="7464262">[</span><span class="ident" id="7464263">i</span><span class="op" id="7464264">]</span><span class="op" id="7464265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464270">for</span>&nbsp;<span class="builtinfunc" id="7464274">len</span><span class="op" id="7464277">(</span><span class="ident" id="7464278">data</span><span class="op" id="7464282">[</span><span class="ident" id="7464283">i</span><span class="op" id="7464284">]</span><span class="op" id="7464285">)</span>&nbsp;<span class="op" id="7464287">&gt;=</span>&nbsp;<span class="num" id="7464290">4</span>&nbsp;<span class="op" id="7464292">&amp;&amp;</span>&nbsp;<span class="ident" id="7464295">data</span><span class="op" id="7464299">[</span><span class="ident" id="7464300">i</span><span class="op" id="7464301">]</span><span class="op" id="7464302">[</span><span class="num" id="7464303">3</span><span class="op" id="7464304">]</span>&nbsp;<span class="op" id="7464306">==</span>&nbsp;<span class="string" id="7464309">&#39;-&#39;</span>&nbsp;<span class="op" id="7464313">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464319">i</span><span class="op" id="7464320">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464327">tc</span><span class="op" id="7464329">.</span><span class="ident" id="7464330">PrintfLine</span><span class="op" id="7464340">(</span><span class="ident" id="7464341">data</span><span class="op" id="7464345">[</span><span class="ident" id="7464346">i</span><span class="op" id="7464347">]</span><span class="op" id="7464348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7464353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464358">if</span>&nbsp;<span class="ident" id="7464361">data</span><span class="op" id="7464365">[</span><span class="ident" id="7464366">i</span><span class="op" id="7464367">]</span>&nbsp;<span class="op" id="7464369">==</span>&nbsp;<span class="string" id="7464372">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="7464386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464392">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7464402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464407">read</span>&nbsp;<span class="op" id="7464412">:=</span>&nbsp;<span class="builtintype" id="7464415">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464424">for</span>&nbsp;<span class="op" id="7464428">!</span><span class="ident" id="7464429">read</span>&nbsp;<span class="op" id="7464434">||</span>&nbsp;<span class="ident" id="7464437">data</span><span class="op" id="7464441">[</span><span class="ident" id="7464442">i</span><span class="op" id="7464443">]</span>&nbsp;<span class="op" id="7464445">==</span>&nbsp;<span class="string" id="7464448">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="7464463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464469">msg</span><span class="op" id="7464472">,</span>&nbsp;<span class="ident" id="7464474">err</span>&nbsp;<span class="op" id="7464478">:=</span>&nbsp;<span class="ident" id="7464481">tc</span><span class="op" id="7464483">.</span><span class="ident" id="7464484">ReadLine</span><span class="op" id="7464492">(</span><span class="op" id="7464493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464499">bcmdbuf</span><span class="op" id="7464506">.</span><span class="ident" id="7464507">Write</span><span class="op" id="7464512">(</span><span class="op" id="7464513">[</span><span class="op" id="7464514">]</span><span class="builtintype" id="7464515">byte</span><span class="op" id="7464519">(</span><span class="ident" id="7464520">msg</span>&nbsp;<span class="op" id="7464524">+</span>&nbsp;<span class="string" id="7464526">&#34;\r\n&#34;</span><span class="op" id="7464532">)</span><span class="op" id="7464533">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464539">read</span>&nbsp;<span class="op" id="7464544">=</span>&nbsp;<span class="builtintype" id="7464546">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464555">if</span>&nbsp;<span class="ident" id="7464558">err</span>&nbsp;<span class="op" id="7464562">!=</span>&nbsp;<span class="ident" id="7464565">nil</span>&nbsp;<span class="op" id="7464569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464576">t</span><span class="op" id="7464577">.</span><span class="ident" id="7464578">Errorf</span><span class="op" id="7464584">(</span><span class="string" id="7464585">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7464601">,</span>&nbsp;<span class="ident" id="7464603">err</span><span class="op" id="7464606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464613">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7464624">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464630">if</span>&nbsp;<span class="ident" id="7464633">data</span><span class="op" id="7464637">[</span><span class="ident" id="7464638">i</span><span class="op" id="7464639">]</span>&nbsp;<span class="op" id="7464641">==</span>&nbsp;<span class="string" id="7464644">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="7464659">&amp;&amp;</span>&nbsp;<span class="ident" id="7464662">msg</span>&nbsp;<span class="op" id="7464666">==</span>&nbsp;<span class="string" id="7464669">&#34;.&#34;</span>&nbsp;<span class="op" id="7464673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464680">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7464690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7464695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7464699">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7464702">}</span><span class="op" id="7464703">(</span><span class="ident" id="7464704">strings</span><span class="op" id="7464711">.</span><span class="ident" id="7464712">Split</span><span class="op" id="7464717">(</span><span class="ident" id="7464718">server</span><span class="op" id="7464724">,</span>&nbsp;<span class="string" id="7464726">&#34;\r\n&#34;</span><span class="op" id="7464732">)</span><span class="op" id="7464733">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464737">err</span>&nbsp;<span class="op" id="7464741">=</span>&nbsp;<span class="ident" id="7464743">SendMail</span><span class="op" id="7464751">(</span><span class="ident" id="7464752">l</span><span class="op" id="7464753">.</span><span class="ident" id="7464754">Addr</span><span class="op" id="7464758">(</span><span class="op" id="7464759">)</span><span class="op" id="7464760">.</span><span class="ident" id="7464761">String</span><span class="op" id="7464767">(</span><span class="op" id="7464768">)</span><span class="op" id="7464769">,</span>&nbsp;<span class="ident" id="7464771">nil</span><span class="op" id="7464774">,</span>&nbsp;<span class="string" id="7464776">&#34;test@example.com&#34;</span><span class="op" id="7464794">,</span>&nbsp;<span class="op" id="7464796">[</span><span class="op" id="7464797">]</span><span class="builtintype" id="7464798">string</span><span class="op" id="7464804">{</span><span class="string" id="7464805">&#34;other@example.com&#34;</span><span class="op" id="7464824">}</span><span class="op" id="7464825">,</span>&nbsp;<span class="op" id="7464827">[</span><span class="op" id="7464828">]</span><span class="builtintype" id="7464829">byte</span><span class="op" id="7464833">(</span><span class="ident" id="7464834">strings</span><span class="op" id="7464841">.</span><span class="ident" id="7464842">Replace</span><span class="op" id="7464849">(</span><span class="string" id="7464850">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="7464949">,</span>&nbsp;<span class="string" id="7464951">&#34;\n&#34;</span><span class="op" id="7464955">,</span>&nbsp;<span class="string" id="7464957">&#34;\r\n&#34;</span><span class="op" id="7464963">,</span>&nbsp;<span class="op" id="7464965">-</span><span class="num" id="7464966">1</span><span class="op" id="7464967">)</span><span class="op" id="7464968">)</span><span class="op" id="7464969">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7464973">if</span>&nbsp;<span class="ident" id="7464976">err</span>&nbsp;<span class="op" id="7464980">!=</span>&nbsp;<span class="ident" id="7464983">nil</span>&nbsp;<span class="op" id="7464987">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7464991">t</span><span class="op" id="7464992">.</span><span class="ident" id="7464993">Errorf</span><span class="op" id="7464999">(</span><span class="string" id="7465000">&#34;%v&#34;</span><span class="op" id="7465004">,</span>&nbsp;<span class="ident" id="7465006">err</span><span class="op" id="7465009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7465012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7465016">&lt;-</span><span class="ident" id="7465018">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7465024">bcmdbuf</span><span class="op" id="7465031">.</span><span class="ident" id="7465032">Flush</span><span class="op" id="7465037">(</span><span class="op" id="7465038">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7465041">actualcmds</span>&nbsp;<span class="op" id="7465052">:=</span>&nbsp;<span class="ident" id="7465055">cmdbuf</span><span class="op" id="7465061">.</span><span class="ident" id="7465062">String</span><span class="op" id="7465068">(</span><span class="op" id="7465069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7465072">if</span>&nbsp;<span class="ident" id="7465075">client</span>&nbsp;<span class="op" id="7465082">!=</span>&nbsp;<span class="ident" id="7465085">actualcmds</span>&nbsp;<span class="op" id="7465096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7465100">t</span><span class="op" id="7465101">.</span><span class="ident" id="7465102">Errorf</span><span class="op" id="7465108">(</span><span class="string" id="7465109">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7465134">,</span>&nbsp;<span class="ident" id="7465136">actualcmds</span><span class="op" id="7465146">,</span>&nbsp;<span class="ident" id="7465148">client</span><span class="op" id="7465154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7465157">}</span><br>
<span class="lineno"></span><span class="op" id="7465159">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="7465162">var</span>&nbsp;<span class="ident" id="7465166">sendMailServer</span>&nbsp;<span class="op" id="7465181">=</span>&nbsp;<span class="string" id="7465183">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="7465312">var</span>&nbsp;<span class="ident" id="7465316">sendMailClient</span>&nbsp;<span class="op" id="7465331">=</span>&nbsp;<span class="string" id="7465333">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="7465533">func</span>&nbsp;<span class="ident" id="7465538">TestAuthFailed</span><span class="op" id="7465552">(</span><span class="ident" id="7465553">t</span>&nbsp;<span class="op" id="7465555">*</span><span class="ident" id="7465556">testing</span><span class="op" id="7465563">.</span><span class="ident" id="7465564">T</span><span class="op" id="7465565">)</span>&nbsp;<span class="op" id="7465567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7465570">server</span>&nbsp;<span class="op" id="7465577">:=</span>&nbsp;<span class="ident" id="7465580">strings</span><span class="op" id="7465587">.</span><span class="ident" id="7465588">Join</span><span class="op" id="7465592">(</span><span class="ident" id="7465593">strings</span><span class="op" id="7465600">.</span><span class="ident" id="7465601">Split</span><span class="op" id="7465606">(</span><span class="ident" id="7465607">authFailedServer</span><span class="op" id="7465623">,</span>&nbsp;<span class="string" id="7465625">&#34;\n&#34;</span><span class="op" id="7465629">)</span><span class="op" id="7465630">,</span>&nbsp;<span class="string" id="7465632">&#34;\r\n&#34;</span><span class="op" id="7465638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7465641">client</span>&nbsp;<span class="op" id="7465648">:=</span>&nbsp;<span class="ident" id="7465651">strings</span><span class="op" id="7465658">.</span><span class="ident" id="7465659">Join</span><span class="op" id="7465663">(</span><span class="ident" id="7465664">strings</span><span class="op" id="7465671">.</span><span class="ident" id="7465672">Split</span><span class="op" id="7465677">(</span><span class="ident" id="7465678">authFailedClient</span><span class="op" id="7465694">,</span>&nbsp;<span class="string" id="7465696">&#34;\n&#34;</span><span class="op" id="7465700">)</span><span class="op" id="7465701">,</span>&nbsp;<span class="string" id="7465703">&#34;\r\n&#34;</span><span class="op" id="7465709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7465712">var</span>&nbsp;<span class="ident" id="7465716">cmdbuf</span>&nbsp;<span class="ident" id="7465723">bytes</span><span class="op" id="7465728">.</span><span class="ident" id="7465729">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7465737">bcmdbuf</span>&nbsp;<span class="op" id="7465745">:=</span>&nbsp;<span class="ident" id="7465748">bufio</span><span class="op" id="7465753">.</span><span class="ident" id="7465754">NewWriter</span><span class="op" id="7465763">(</span><span class="op" id="7465764">&amp;</span><span class="ident" id="7465765">cmdbuf</span><span class="op" id="7465771">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7465774">var</span>&nbsp;<span class="ident" id="7465778">fake</span>&nbsp;<span class="ident" id="7465783">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7465790">fake</span><span class="op" id="7465794">.</span><span class="ident" id="7465795">ReadWriter</span>&nbsp;<span class="op" id="7465806">=</span>&nbsp;<span class="ident" id="7465808">bufio</span><span class="op" id="7465813">.</span><span class="ident" id="7465814">NewReadWriter</span><span class="op" id="7465827">(</span><span class="ident" id="7465828">bufio</span><span class="op" id="7465833">.</span><span class="ident" id="7465834">NewReader</span><span class="op" id="7465843">(</span><span class="ident" id="7465844">strings</span><span class="op" id="7465851">.</span><span class="ident" id="7465852">NewReader</span><span class="op" id="7465861">(</span><span class="ident" id="7465862">server</span><span class="op" id="7465868">)</span><span class="op" id="7465869">)</span><span class="op" id="7465870">,</span>&nbsp;<span class="ident" id="7465872">bcmdbuf</span><span class="op" id="7465879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7465882">c</span><span class="op" id="7465883">,</span>&nbsp;<span class="ident" id="7465885">err</span>&nbsp;<span class="op" id="7465889">:=</span>&nbsp;<span class="ident" id="7465892">NewClient</span><span class="op" id="7465901">(</span><span class="ident" id="7465902">fake</span><span class="op" id="7465906">,</span>&nbsp;<span class="string" id="7465908">&#34;fake.host&#34;</span><span class="op" id="7465919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7465922">if</span>&nbsp;<span class="ident" id="7465925">err</span>&nbsp;<span class="op" id="7465929">!=</span>&nbsp;<span class="ident" id="7465932">nil</span>&nbsp;<span class="op" id="7465936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7465940">t</span><span class="op" id="7465941">.</span><span class="ident" id="7465942">Fatalf</span><span class="op" id="7465948">(</span><span class="string" id="7465949">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="7465964">,</span>&nbsp;<span class="ident" id="7465966">err</span><span class="op" id="7465969">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7465972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7465975">defer</span>&nbsp;<span class="ident" id="7465981">c</span><span class="op" id="7465982">.</span><span class="ident" id="7465983">Close</span><span class="op" id="7465988">(</span><span class="op" id="7465989">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7465993">c</span><span class="op" id="7465994">.</span><span class="ident" id="7465995">tls</span>&nbsp;<span class="op" id="7465999">=</span>&nbsp;<span class="builtintype" id="7466001">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7466007">c</span><span class="op" id="7466008">.</span><span class="ident" id="7466009">serverName</span>&nbsp;<span class="op" id="7466020">=</span>&nbsp;<span class="string" id="7466022">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7466041">err</span>&nbsp;<span class="op" id="7466045">=</span>&nbsp;<span class="ident" id="7466047">c</span><span class="op" id="7466048">.</span><span class="ident" id="7466049">Auth</span><span class="op" id="7466053">(</span><span class="ident" id="7466054">PlainAuth</span><span class="op" id="7466063">(</span><span class="string" id="7466064">&#34;&#34;</span><span class="op" id="7466066">,</span>&nbsp;<span class="string" id="7466068">&#34;user&#34;</span><span class="op" id="7466074">,</span>&nbsp;<span class="string" id="7466076">&#34;pass&#34;</span><span class="op" id="7466082">,</span>&nbsp;<span class="string" id="7466084">&#34;smtp.google.com&#34;</span><span class="op" id="7466101">)</span><span class="op" id="7466102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7466106">if</span>&nbsp;<span class="ident" id="7466109">err</span>&nbsp;<span class="op" id="7466113">==</span>&nbsp;<span class="ident" id="7466116">nil</span>&nbsp;<span class="op" id="7466120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7466124">t</span><span class="op" id="7466125">.</span><span class="ident" id="7466126">Error</span><span class="op" id="7466131">(</span><span class="string" id="7466132">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="7466164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7466167">}</span>&nbsp;<span class="keyword" id="7466169">else</span>&nbsp;<span class="keyword" id="7466174">if</span>&nbsp;<span class="ident" id="7466177">err</span><span class="op" id="7466180">.</span><span class="ident" id="7466181">Error</span><span class="op" id="7466186">(</span><span class="op" id="7466187">)</span>&nbsp;<span class="op" id="7466189">!=</span>&nbsp;<span class="string" id="7466192">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="7466246">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7466250">t</span><span class="op" id="7466251">.</span><span class="ident" id="7466252">Errorf</span><span class="op" id="7466258">(</span><span class="string" id="7466259">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="7466290">,</span>&nbsp;<span class="ident" id="7466292">err</span><span class="op" id="7466295">,</span>&nbsp;<span class="string" id="7466297">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="7466350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7466353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7466357">bcmdbuf</span><span class="op" id="7466364">.</span><span class="ident" id="7466365">Flush</span><span class="op" id="7466370">(</span><span class="op" id="7466371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7466374">actualcmds</span>&nbsp;<span class="op" id="7466385">:=</span>&nbsp;<span class="ident" id="7466388">cmdbuf</span><span class="op" id="7466394">.</span><span class="ident" id="7466395">String</span><span class="op" id="7466401">(</span><span class="op" id="7466402">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7466405">if</span>&nbsp;<span class="ident" id="7466408">client</span>&nbsp;<span class="op" id="7466415">!=</span>&nbsp;<span class="ident" id="7466418">actualcmds</span>&nbsp;<span class="op" id="7466429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7466433">t</span><span class="op" id="7466434">.</span><span class="ident" id="7466435">Errorf</span><span class="op" id="7466441">(</span><span class="string" id="7466442">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7466467">,</span>&nbsp;<span class="ident" id="7466469">actualcmds</span><span class="op" id="7466479">,</span>&nbsp;<span class="ident" id="7466481">client</span><span class="op" id="7466487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7466490">}</span><br>
<span class="lineno"></span><span class="op" id="7466492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="7466495">var</span>&nbsp;<span class="ident" id="7466499">authFailedServer</span>&nbsp;<span class="op" id="7466516">=</span>&nbsp;<span class="string" id="7466518">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7466660">var</span>&nbsp;<span class="ident" id="7466664">authFailedClient</span>&nbsp;<span class="op" id="7466681">=</span>&nbsp;<span class="string" id="7466683">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7466737">func</span>&nbsp;<span class="ident" id="7466742">TestTLSClient</span><span class="op" id="7466755">(</span><span class="ident" id="7466756">t</span>&nbsp;<span class="op" id="7466758">*</span><span class="ident" id="7466759">testing</span><span class="op" id="7466766">.</span><span class="ident" id="7466767">T</span><span class="op" id="7466768">)</span>&nbsp;<span class="op" id="7466770">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7466773">ln</span>&nbsp;<span class="op" id="7466776">:=</span>&nbsp;<span class="ident" id="7466779">newLocalListener</span><span class="op" id="7466795">(</span><span class="ident" id="7466796">t</span><span class="op" id="7466797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7466800">defer</span>&nbsp;<span class="ident" id="7466806">ln</span><span class="op" id="7466808">.</span><span class="ident" id="7466809">Close</span><span class="op" id="7466814">(</span><span class="op" id="7466815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7466818">errc</span>&nbsp;<span class="op" id="7466823">:=</span>&nbsp;<span class="builtinfunc" id="7466826">make</span><span class="op" id="7466830">(</span><span class="keyword" id="7466831">chan</span>&nbsp;<span class="builtintype" id="7466836">error</span><span class="op" id="7466841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7466844">go</span>&nbsp;<span class="keyword" id="7466847">func</span><span class="op" id="7466851">(</span><span class="op" id="7466852">)</span>&nbsp;<span class="op" id="7466854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7466858">errc</span>&nbsp;<span class="op" id="7466863">&lt;-</span>&nbsp;<span class="ident" id="7466866">sendMail</span><span class="op" id="7466874">(</span><span class="ident" id="7466875">ln</span><span class="op" id="7466877">.</span><span class="ident" id="7466878">Addr</span><span class="op" id="7466882">(</span><span class="op" id="7466883">)</span><span class="op" id="7466884">.</span><span class="ident" id="7466885">String</span><span class="op" id="7466891">(</span><span class="op" id="7466892">)</span><span class="op" id="7466893">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7466896">}</span><span class="op" id="7466897">(</span><span class="op" id="7466898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7466901">conn</span><span class="op" id="7466905">,</span>&nbsp;<span class="ident" id="7466907">err</span>&nbsp;<span class="op" id="7466911">:=</span>&nbsp;<span class="ident" id="7466914">ln</span><span class="op" id="7466916">.</span><span class="ident" id="7466917">Accept</span><span class="op" id="7466923">(</span><span class="op" id="7466924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7466927">if</span>&nbsp;<span class="ident" id="7466930">err</span>&nbsp;<span class="op" id="7466934">!=</span>&nbsp;<span class="ident" id="7466937">nil</span>&nbsp;<span class="op" id="7466941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7466945">t</span><span class="op" id="7466946">.</span><span class="ident" id="7466947">Fatalf</span><span class="op" id="7466953">(</span><span class="string" id="7466954">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="7466987">,</span>&nbsp;<span class="ident" id="7466989">err</span><span class="op" id="7466992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7466995">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7466998">defer</span>&nbsp;<span class="ident" id="7467004">conn</span><span class="op" id="7467008">.</span><span class="ident" id="7467009">Close</span><span class="op" id="7467014">(</span><span class="op" id="7467015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7467018">if</span>&nbsp;<span class="ident" id="7467021">err</span>&nbsp;<span class="op" id="7467025">:=</span>&nbsp;<span class="ident" id="7467028">serverHandle</span><span class="op" id="7467040">(</span><span class="ident" id="7467041">conn</span><span class="op" id="7467045">,</span>&nbsp;<span class="ident" id="7467047">t</span><span class="op" id="7467048">)</span><span class="op" id="7467049">;</span>&nbsp;<span class="ident" id="7467051">err</span>&nbsp;<span class="op" id="7467055">!=</span>&nbsp;<span class="ident" id="7467058">nil</span>&nbsp;<span class="op" id="7467062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467066">t</span><span class="op" id="7467067">.</span><span class="ident" id="7467068">Fatalf</span><span class="op" id="7467074">(</span><span class="string" id="7467075">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="7467108">,</span>&nbsp;<span class="ident" id="7467110">err</span><span class="op" id="7467113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7467116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7467119">if</span>&nbsp;<span class="ident" id="7467122">err</span>&nbsp;<span class="op" id="7467126">:=</span>&nbsp;<span class="op" id="7467129">&lt;-</span><span class="ident" id="7467131">errc</span><span class="op" id="7467135">;</span>&nbsp;<span class="ident" id="7467137">err</span>&nbsp;<span class="op" id="7467141">!=</span>&nbsp;<span class="ident" id="7467144">nil</span>&nbsp;<span class="op" id="7467148">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467152">t</span><span class="op" id="7467153">.</span><span class="ident" id="7467154">Fatalf</span><span class="op" id="7467160">(</span><span class="string" id="7467161">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7467179">,</span>&nbsp;<span class="ident" id="7467181">err</span><span class="op" id="7467184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7467187">}</span><br>
<span class="lineno"></span><span class="op" id="7467189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7467192">func</span>&nbsp;<span class="ident" id="7467197">newLocalListener</span><span class="op" id="7467213">(</span><span class="ident" id="7467214">t</span>&nbsp;<span class="op" id="7467216">*</span><span class="ident" id="7467217">testing</span><span class="op" id="7467224">.</span><span class="ident" id="7467225">T</span><span class="op" id="7467226">)</span>&nbsp;<span class="ident" id="7467228">net</span><span class="op" id="7467231">.</span><span class="ident" id="7467232">Listener</span>&nbsp;<span class="op" id="7467241">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467244">ln</span><span class="op" id="7467246">,</span>&nbsp;<span class="ident" id="7467248">err</span>&nbsp;<span class="op" id="7467252">:=</span>&nbsp;<span class="ident" id="7467255">net</span><span class="op" id="7467258">.</span><span class="ident" id="7467259">Listen</span><span class="op" id="7467265">(</span><span class="string" id="7467266">&#34;tcp&#34;</span><span class="op" id="7467271">,</span>&nbsp;<span class="string" id="7467273">&#34;127.0.0.1:0&#34;</span><span class="op" id="7467286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7467289">if</span>&nbsp;<span class="ident" id="7467292">err</span>&nbsp;<span class="op" id="7467296">!=</span>&nbsp;<span class="ident" id="7467299">nil</span>&nbsp;<span class="op" id="7467303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467307">ln</span><span class="op" id="7467309">,</span>&nbsp;<span class="ident" id="7467311">err</span>&nbsp;<span class="op" id="7467315">=</span>&nbsp;<span class="ident" id="7467317">net</span><span class="op" id="7467320">.</span><span class="ident" id="7467321">Listen</span><span class="op" id="7467327">(</span><span class="string" id="7467328">&#34;tcp6&#34;</span><span class="op" id="7467334">,</span>&nbsp;<span class="string" id="7467336">&#34;[::1]:0&#34;</span><span class="op" id="7467345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7467348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7467351">if</span>&nbsp;<span class="ident" id="7467354">err</span>&nbsp;<span class="op" id="7467358">!=</span>&nbsp;<span class="ident" id="7467361">nil</span>&nbsp;<span class="op" id="7467365">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467369">t</span><span class="op" id="7467370">.</span><span class="ident" id="7467371">Fatal</span><span class="op" id="7467376">(</span><span class="ident" id="7467377">err</span><span class="op" id="7467380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7467383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7467386">return</span>&nbsp;<span class="ident" id="7467393">ln</span><br>
<span class="lineno"></span><span class="op" id="7467396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="7467399">type</span>&nbsp;<span class="ident" id="7467404">smtpSender</span>&nbsp;<span class="keyword" id="7467415">struct</span>&nbsp;<span class="op" id="7467422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467425">w</span>&nbsp;<span class="ident" id="7467427">io</span><span class="op" id="7467429">.</span><span class="ident" id="7467430">Writer</span><br>
<span class="lineno"></span><span class="op" id="7467437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7467440">func</span>&nbsp;<span class="op" id="7467445">(</span><span class="ident" id="7467446">s</span>&nbsp;<span class="ident" id="7467448">smtpSender</span><span class="op" id="7467458">)</span>&nbsp;<span class="ident" id="7467460">send</span><span class="op" id="7467464">(</span><span class="ident" id="7467465">f</span>&nbsp;<span class="builtintype" id="7467467">string</span><span class="op" id="7467473">)</span>&nbsp;<span class="op" id="7467475">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467478">s</span><span class="op" id="7467479">.</span><span class="ident" id="7467480">w</span><span class="op" id="7467481">.</span><span class="ident" id="7467482">Write</span><span class="op" id="7467487">(</span><span class="op" id="7467488">[</span><span class="op" id="7467489">]</span><span class="builtintype" id="7467490">byte</span><span class="op" id="7467494">(</span><span class="ident" id="7467495">f</span>&nbsp;<span class="op" id="7467497">+</span>&nbsp;<span class="string" id="7467499">&#34;\r\n&#34;</span><span class="op" id="7467505">)</span><span class="op" id="7467506">)</span><br>
<span class="lineno"></span><span class="op" id="7467508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7467511">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="7467577">func</span>&nbsp;<span class="ident" id="7467582">serverHandle</span><span class="op" id="7467594">(</span><span class="ident" id="7467595">c</span>&nbsp;<span class="ident" id="7467597">net</span><span class="op" id="7467600">.</span><span class="ident" id="7467601">Conn</span><span class="op" id="7467605">,</span>&nbsp;<span class="ident" id="7467607">t</span>&nbsp;<span class="op" id="7467609">*</span><span class="ident" id="7467610">testing</span><span class="op" id="7467617">.</span><span class="ident" id="7467618">T</span><span class="op" id="7467619">)</span>&nbsp;<span class="builtintype" id="7467621">error</span>&nbsp;<span class="op" id="7467627">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467630">send</span>&nbsp;<span class="op" id="7467635">:=</span>&nbsp;<span class="ident" id="7467638">smtpSender</span><span class="op" id="7467648">{</span><span class="ident" id="7467649">c</span><span class="op" id="7467650">}</span><span class="op" id="7467651">.</span><span class="ident" id="7467652">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467658">send</span><span class="op" id="7467662">(</span><span class="string" id="7467663">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="7467698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467701">s</span>&nbsp;<span class="op" id="7467703">:=</span>&nbsp;<span class="ident" id="7467706">bufio</span><span class="op" id="7467711">.</span><span class="ident" id="7467712">NewScanner</span><span class="op" id="7467722">(</span><span class="ident" id="7467723">c</span><span class="op" id="7467724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7467727">for</span>&nbsp;<span class="ident" id="7467731">s</span><span class="op" id="7467732">.</span><span class="ident" id="7467733">Scan</span><span class="op" id="7467737">(</span><span class="op" id="7467738">)</span>&nbsp;<span class="op" id="7467740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7467744">switch</span>&nbsp;<span class="ident" id="7467751">s</span><span class="op" id="7467752">.</span><span class="ident" id="7467753">Text</span><span class="op" id="7467757">(</span><span class="op" id="7467758">)</span>&nbsp;<span class="op" id="7467760">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7467764">case</span>&nbsp;<span class="string" id="7467769">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="7467785">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467790">send</span><span class="op" id="7467794">(</span><span class="string" id="7467795">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="7467845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467850">send</span><span class="op" id="7467854">(</span><span class="string" id="7467855">&#34;250-STARTTLS&#34;</span><span class="op" id="7467869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467874">send</span><span class="op" id="7467878">(</span><span class="string" id="7467879">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7467887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7467891">case</span>&nbsp;<span class="string" id="7467896">&#34;STARTTLS&#34;</span><span class="op" id="7467906">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467911">send</span><span class="op" id="7467915">(</span><span class="string" id="7467916">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="7467930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7467935">keypair</span><span class="op" id="7467942">,</span>&nbsp;<span class="ident" id="7467944">err</span>&nbsp;<span class="op" id="7467948">:=</span>&nbsp;<span class="ident" id="7467951">tls</span><span class="op" id="7467954">.</span><span class="ident" id="7467955">X509KeyPair</span><span class="op" id="7467966">(</span><span class="ident" id="7467967">localhostCert</span><span class="op" id="7467980">,</span>&nbsp;<span class="ident" id="7467982">localhostKey</span><span class="op" id="7467994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7467999">if</span>&nbsp;<span class="ident" id="7468002">err</span>&nbsp;<span class="op" id="7468006">!=</span>&nbsp;<span class="ident" id="7468009">nil</span>&nbsp;<span class="op" id="7468013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468019">return</span>&nbsp;<span class="ident" id="7468026">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7468033">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468038">config</span>&nbsp;<span class="op" id="7468045">:=</span>&nbsp;<span class="op" id="7468048">&amp;</span><span class="ident" id="7468049">tls</span><span class="op" id="7468052">.</span><span class="ident" id="7468053">Config</span><span class="op" id="7468059">{</span><span class="ident" id="7468060">Certificates</span><span class="op" id="7468072">:</span>&nbsp;<span class="op" id="7468074">[</span><span class="op" id="7468075">]</span><span class="ident" id="7468076">tls</span><span class="op" id="7468079">.</span><span class="ident" id="7468080">Certificate</span><span class="op" id="7468091">{</span><span class="ident" id="7468092">keypair</span><span class="op" id="7468099">}</span><span class="op" id="7468100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468105">c</span>&nbsp;<span class="op" id="7468107">=</span>&nbsp;<span class="ident" id="7468109">tls</span><span class="op" id="7468112">.</span><span class="ident" id="7468113">Server</span><span class="op" id="7468119">(</span><span class="ident" id="7468120">c</span><span class="op" id="7468121">,</span>&nbsp;<span class="ident" id="7468123">config</span><span class="op" id="7468129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468134">defer</span>&nbsp;<span class="ident" id="7468140">c</span><span class="op" id="7468141">.</span><span class="ident" id="7468142">Close</span><span class="op" id="7468147">(</span><span class="op" id="7468148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468153">return</span>&nbsp;<span class="ident" id="7468160">serverHandleTLS</span><span class="op" id="7468175">(</span><span class="ident" id="7468176">c</span><span class="op" id="7468177">,</span>&nbsp;<span class="ident" id="7468179">t</span><span class="op" id="7468180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468184">default</span><span class="op" id="7468191">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468196">t</span><span class="op" id="7468197">.</span><span class="ident" id="7468198">Fatalf</span><span class="op" id="7468204">(</span><span class="string" id="7468205">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="7468231">,</span>&nbsp;<span class="ident" id="7468233">s</span><span class="op" id="7468234">.</span><span class="ident" id="7468235">Text</span><span class="op" id="7468239">(</span><span class="op" id="7468240">)</span><span class="op" id="7468241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7468245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7468248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468251">return</span>&nbsp;<span class="ident" id="7468258">s</span><span class="op" id="7468259">.</span><span class="ident" id="7468260">Err</span><span class="op" id="7468263">(</span><span class="op" id="7468264">)</span><br>
<span class="lineno"></span><span class="op" id="7468266">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="7468269">func</span>&nbsp;<span class="ident" id="7468274">serverHandleTLS</span><span class="op" id="7468289">(</span><span class="ident" id="7468290">c</span>&nbsp;<span class="ident" id="7468292">net</span><span class="op" id="7468295">.</span><span class="ident" id="7468296">Conn</span><span class="op" id="7468300">,</span>&nbsp;<span class="ident" id="7468302">t</span>&nbsp;<span class="op" id="7468304">*</span><span class="ident" id="7468305">testing</span><span class="op" id="7468312">.</span><span class="ident" id="7468313">T</span><span class="op" id="7468314">)</span>&nbsp;<span class="builtintype" id="7468316">error</span>&nbsp;<span class="op" id="7468322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468325">send</span>&nbsp;<span class="op" id="7468330">:=</span>&nbsp;<span class="ident" id="7468333">smtpSender</span><span class="op" id="7468343">{</span><span class="ident" id="7468344">c</span><span class="op" id="7468345">}</span><span class="op" id="7468346">.</span><span class="ident" id="7468347">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468353">s</span>&nbsp;<span class="op" id="7468355">:=</span>&nbsp;<span class="ident" id="7468358">bufio</span><span class="op" id="7468363">.</span><span class="ident" id="7468364">NewScanner</span><span class="op" id="7468374">(</span><span class="ident" id="7468375">c</span><span class="op" id="7468376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468379">for</span>&nbsp;<span class="ident" id="7468383">s</span><span class="op" id="7468384">.</span><span class="ident" id="7468385">Scan</span><span class="op" id="7468389">(</span><span class="op" id="7468390">)</span>&nbsp;<span class="op" id="7468392">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468396">switch</span>&nbsp;<span class="ident" id="7468403">s</span><span class="op" id="7468404">.</span><span class="ident" id="7468405">Text</span><span class="op" id="7468409">(</span><span class="op" id="7468410">)</span>&nbsp;<span class="op" id="7468412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468416">case</span>&nbsp;<span class="string" id="7468421">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="7468437">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468442">send</span><span class="op" id="7468446">(</span><span class="string" id="7468447">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7468455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468459">case</span>&nbsp;<span class="string" id="7468464">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="7468494">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468499">send</span><span class="op" id="7468503">(</span><span class="string" id="7468504">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7468512">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468516">case</span>&nbsp;<span class="string" id="7468521">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="7468549">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468554">send</span><span class="op" id="7468558">(</span><span class="string" id="7468559">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7468567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468571">case</span>&nbsp;<span class="string" id="7468576">&#34;DATA&#34;</span><span class="op" id="7468582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468587">send</span><span class="op" id="7468591">(</span><span class="string" id="7468592">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="7468628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468633">send</span><span class="op" id="7468637">(</span><span class="string" id="7468638">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7468646">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468650">case</span>&nbsp;<span class="string" id="7468655">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="7468670">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468674">case</span>&nbsp;<span class="string" id="7468679">&#34;&#34;</span><span class="op" id="7468681">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468685">case</span>&nbsp;<span class="string" id="7468690">&#34;howdy!&#34;</span><span class="op" id="7468698">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468702">case</span>&nbsp;<span class="string" id="7468707">&#34;.&#34;</span><span class="op" id="7468710">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468714">case</span>&nbsp;<span class="string" id="7468719">&#34;QUIT&#34;</span><span class="op" id="7468725">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468730">send</span><span class="op" id="7468734">(</span><span class="string" id="7468735">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="7468787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468792">return</span>&nbsp;<span class="ident" id="7468799">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468805">default</span><span class="op" id="7468812">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468817">t</span><span class="op" id="7468818">.</span><span class="ident" id="7468819">Fatalf</span><span class="op" id="7468825">(</span><span class="string" id="7468826">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="7468863">,</span>&nbsp;<span class="ident" id="7468865">s</span><span class="op" id="7468866">.</span><span class="ident" id="7468867">Text</span><span class="op" id="7468871">(</span><span class="op" id="7468872">)</span><span class="op" id="7468873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7468877">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7468880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7468883">return</span>&nbsp;<span class="ident" id="7468890">s</span><span class="op" id="7468891">.</span><span class="ident" id="7468892">Err</span><span class="op" id="7468895">(</span><span class="op" id="7468896">)</span><br>
<span class="lineno"></span><span class="op" id="7468898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7468901">func</span>&nbsp;<span class="ident" id="7468906">init</span><span class="op" id="7468910">(</span><span class="op" id="7468911">)</span>&nbsp;<span class="op" id="7468913">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468916">testRootCAs</span>&nbsp;<span class="op" id="7468928">:=</span>&nbsp;<span class="ident" id="7468931">x509</span><span class="op" id="7468935">.</span><span class="ident" id="7468936">NewCertPool</span><span class="op" id="7468947">(</span><span class="op" id="7468948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468951">testRootCAs</span><span class="op" id="7468962">.</span><span class="ident" id="7468963">AppendCertsFromPEM</span><span class="op" id="7468981">(</span><span class="ident" id="7468982">localhostCert</span><span class="op" id="7468995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7468998">testHookStartTLS</span>&nbsp;<span class="op" id="7469015">=</span>&nbsp;<span class="keyword" id="7469017">func</span><span class="op" id="7469021">(</span><span class="ident" id="7469022">config</span>&nbsp;<span class="op" id="7469029">*</span><span class="ident" id="7469030">tls</span><span class="op" id="7469033">.</span><span class="ident" id="7469034">Config</span><span class="op" id="7469040">)</span>&nbsp;<span class="op" id="7469042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7469046">config</span><span class="op" id="7469052">.</span><span class="ident" id="7469053">RootCAs</span>&nbsp;<span class="op" id="7469061">=</span>&nbsp;<span class="ident" id="7469063">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7469076">}</span><br>
<span class="lineno">655</span><span class="op" id="7469078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7469081">func</span>&nbsp;<span class="ident" id="7469086">sendMail</span><span class="op" id="7469094">(</span><span class="ident" id="7469095">hostPort</span>&nbsp;<span class="builtintype" id="7469104">string</span><span class="op" id="7469110">)</span>&nbsp;<span class="builtintype" id="7469112">error</span>&nbsp;<span class="op" id="7469118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7469121">host</span><span class="op" id="7469125">,</span>&nbsp;<span class="ident" id="7469127">_</span><span class="op" id="7469128">,</span>&nbsp;<span class="ident" id="7469130">err</span>&nbsp;<span class="op" id="7469134">:=</span>&nbsp;<span class="ident" id="7469137">net</span><span class="op" id="7469140">.</span><span class="ident" id="7469141">SplitHostPort</span><span class="op" id="7469154">(</span><span class="ident" id="7469155">hostPort</span><span class="op" id="7469163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7469166">if</span>&nbsp;<span class="ident" id="7469169">err</span>&nbsp;<span class="op" id="7469173">!=</span>&nbsp;<span class="ident" id="7469176">nil</span>&nbsp;<span class="op" id="7469180">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7469184">return</span>&nbsp;<span class="ident" id="7469191">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7469196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7469199">auth</span>&nbsp;<span class="op" id="7469204">:=</span>&nbsp;<span class="ident" id="7469207">PlainAuth</span><span class="op" id="7469216">(</span><span class="string" id="7469217">&#34;&#34;</span><span class="op" id="7469219">,</span>&nbsp;<span class="string" id="7469221">&#34;&#34;</span><span class="op" id="7469223">,</span>&nbsp;<span class="string" id="7469225">&#34;&#34;</span><span class="op" id="7469227">,</span>&nbsp;<span class="ident" id="7469229">host</span><span class="op" id="7469233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7469236">from</span>&nbsp;<span class="op" id="7469241">:=</span>&nbsp;<span class="string" id="7469244">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7469264">to</span>&nbsp;<span class="op" id="7469267">:=</span>&nbsp;<span class="op" id="7469270">[</span><span class="op" id="7469271">]</span><span class="builtintype" id="7469272">string</span><span class="op" id="7469278">{</span><span class="string" id="7469279">&#34;joe2@example.com&#34;</span><span class="op" id="7469297">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7469300">return</span>&nbsp;<span class="ident" id="7469307">SendMail</span><span class="op" id="7469315">(</span><span class="ident" id="7469316">hostPort</span><span class="op" id="7469324">,</span>&nbsp;<span class="ident" id="7469326">auth</span><span class="op" id="7469330">,</span>&nbsp;<span class="ident" id="7469332">from</span><span class="op" id="7469336">,</span>&nbsp;<span class="ident" id="7469338">to</span><span class="op" id="7469340">,</span>&nbsp;<span class="op" id="7469342">[</span><span class="op" id="7469343">]</span><span class="builtintype" id="7469344">byte</span><span class="op" id="7469348">(</span><span class="string" id="7469349">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="7469374">)</span><span class="op" id="7469375">)</span><br>
<span class="lineno"></span><span class="op" id="7469377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7469380">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="7469415">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="7469471">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="7469544">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="7469563">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="7469597">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="7469733">var</span>&nbsp;<span class="ident" id="7469737">localhostCert</span>&nbsp;<span class="op" id="7469751">=</span>&nbsp;<span class="op" id="7469753">[</span><span class="op" id="7469754">]</span><span class="builtintype" id="7469755">byte</span><span class="op" id="7469759">(</span><span class="string" id="7469760">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="7470331">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="7470334">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="7470388">var</span>&nbsp;<span class="ident" id="7470392">localhostKey</span>&nbsp;<span class="op" id="7470405">=</span>&nbsp;<span class="op" id="7470407">[</span><span class="op" id="7470408">]</span><span class="builtintype" id="7470409">byte</span><span class="op" id="7470413">(</span><span class="string" id="7470414">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="7470912">)</span>
</div>
</body>
</html>
