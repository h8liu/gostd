<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1430304">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1430359">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1430413">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1430464">package</span>&nbsp;<span class="ident" id="1430472">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1430478">import</span>&nbsp;<span class="op" id="1430485">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1430488">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1430503">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1430512">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1430515">//&nbsp;Cond&nbsp;implements&nbsp;a&nbsp;condition&nbsp;variable,&nbsp;a&nbsp;rendezvous&nbsp;point</span><br>
<span class="lineno"></span><span class="comment" id="1430575">//&nbsp;for&nbsp;goroutines&nbsp;waiting&nbsp;for&nbsp;or&nbsp;announcing&nbsp;the&nbsp;occurrence</span><br>
<span class="lineno"></span><span class="comment" id="1430634">//&nbsp;of&nbsp;an&nbsp;event.</span><br>
<span class="lineno">15</span><span class="comment" id="1430650">//</span><br>
<span class="lineno"></span><span class="comment" id="1430653">//&nbsp;Each&nbsp;Cond&nbsp;has&nbsp;an&nbsp;associated&nbsp;Locker&nbsp;L&nbsp;(often&nbsp;a&nbsp;*Mutex&nbsp;or&nbsp;*RWMutex),</span><br>
<span class="lineno"></span><span class="comment" id="1430723">//&nbsp;which&nbsp;must&nbsp;be&nbsp;held&nbsp;when&nbsp;changing&nbsp;the&nbsp;condition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1430777">//&nbsp;when&nbsp;calling&nbsp;the&nbsp;Wait&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="1430810">//</span><br>
<span class="lineno">20</span><span class="comment" id="1430813">//&nbsp;A&nbsp;Cond&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures.</span><br>
<span class="lineno"></span><span class="comment" id="1430867">//&nbsp;A&nbsp;Cond&nbsp;must&nbsp;not&nbsp;be&nbsp;copied&nbsp;after&nbsp;first&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="1430913">type</span>&nbsp;<span class="ident" id="1430918">Cond</span>&nbsp;<span class="keyword" id="1430923">struct</span>&nbsp;<span class="op" id="1430930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1430933">//&nbsp;L&nbsp;is&nbsp;held&nbsp;while&nbsp;observing&nbsp;or&nbsp;changing&nbsp;the&nbsp;condition</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430989">L</span>&nbsp;<span class="ident" id="1430991">Locker</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431000">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1431008">syncSema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431018">waiters</span>&nbsp;<span class="builtintype" id="1431026">uint32</span>&nbsp;<span class="comment" id="1431033">//&nbsp;number&nbsp;of&nbsp;waiters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431055">checker</span>&nbsp;<span class="ident" id="1431063">copyChecker</span><br>
<span class="lineno"></span><span class="op" id="1431075">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="1431078">//&nbsp;NewCond&nbsp;returns&nbsp;a&nbsp;new&nbsp;Cond&nbsp;with&nbsp;Locker&nbsp;l.</span><br>
<span class="lineno"></span><span class="keyword" id="1431123">func</span>&nbsp;<span class="ident" id="1431128">NewCond</span><span class="op" id="1431135">(</span><span class="ident" id="1431136">l</span>&nbsp;<span class="ident" id="1431138">Locker</span><span class="op" id="1431144">)</span>&nbsp;<span class="op" id="1431146">*</span><span class="ident" id="1431147">Cond</span>&nbsp;<span class="op" id="1431152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431155">return</span>&nbsp;<span class="op" id="1431162">&amp;</span><span class="ident" id="1431163">Cond</span><span class="op" id="1431167">{</span><span class="ident" id="1431168">L</span><span class="op" id="1431169">:</span>&nbsp;<span class="ident" id="1431171">l</span><span class="op" id="1431172">}</span><br>
<span class="lineno"></span><span class="op" id="1431174">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1431177">//&nbsp;Wait&nbsp;atomically&nbsp;unlocks&nbsp;c.L&nbsp;and&nbsp;suspends&nbsp;execution</span><br>
<span class="lineno"></span><span class="comment" id="1431231">//&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine.&nbsp;&nbsp;After&nbsp;later&nbsp;resuming&nbsp;execution,</span><br>
<span class="lineno"></span><span class="comment" id="1431293">//&nbsp;Wait&nbsp;locks&nbsp;c.L&nbsp;before&nbsp;returning.&nbsp;&nbsp;Unlike&nbsp;in&nbsp;other&nbsp;systems,</span><br>
<span class="lineno"></span><span class="comment" id="1431355">//&nbsp;Wait&nbsp;cannot&nbsp;return&nbsp;unless&nbsp;awoken&nbsp;by&nbsp;Broadcast&nbsp;or&nbsp;Signal.</span><br>
<span class="lineno">40</span><span class="comment" id="1431415">//</span><br>
<span class="lineno"></span><span class="comment" id="1431418">//&nbsp;Because&nbsp;c.L&nbsp;is&nbsp;not&nbsp;locked&nbsp;when&nbsp;Wait&nbsp;first&nbsp;resumes,&nbsp;the&nbsp;caller</span><br>
<span class="lineno"></span><span class="comment" id="1431483">//&nbsp;typically&nbsp;cannot&nbsp;assume&nbsp;that&nbsp;the&nbsp;condition&nbsp;is&nbsp;true&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="1431542">//&nbsp;Wait&nbsp;returns.&nbsp;&nbsp;Instead,&nbsp;the&nbsp;caller&nbsp;should&nbsp;Wait&nbsp;in&nbsp;a&nbsp;loop:</span><br>
<span class="lineno"></span><span class="comment" id="1431603">//</span><br>
<span class="lineno">45</span><span class="comment" id="1431606">//&nbsp;&nbsp;&nbsp;&nbsp;c.L.Lock()</span><br>
<span class="lineno"></span><span class="comment" id="1431623">//&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;!condition()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1431648">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.Wait()</span><br>
<span class="lineno"></span><span class="comment" id="1431667">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1431675">//&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;make&nbsp;use&nbsp;of&nbsp;condition&nbsp;...</span><br>
<span class="lineno">50</span><span class="comment" id="1431711">//&nbsp;&nbsp;&nbsp;&nbsp;c.L.Unlock()</span><br>
<span class="lineno"></span><span class="comment" id="1431730">//</span><br>
<span class="lineno"></span><span class="keyword" id="1431733">func</span>&nbsp;<span class="op" id="1431738">(</span><span class="ident" id="1431739">c</span>&nbsp;<span class="op" id="1431741">*</span><span class="ident" id="1431742">Cond</span><span class="op" id="1431746">)</span>&nbsp;<span class="ident" id="1431748">Wait</span><span class="op" id="1431752">(</span><span class="op" id="1431753">)</span>&nbsp;<span class="op" id="1431755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431758">c</span><span class="op" id="1431759">.</span><span class="ident" id="1431760">checker</span><span class="op" id="1431767">.</span><span class="ident" id="1431768">check</span><span class="op" id="1431773">(</span><span class="op" id="1431774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431777">if</span>&nbsp;<span class="ident" id="1431780">raceenabled</span>&nbsp;<span class="op" id="1431792">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431796">raceDisable</span><span class="op" id="1431807">(</span><span class="op" id="1431808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1431811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431814">atomic</span><span class="op" id="1431820">.</span><span class="ident" id="1431821">AddUint32</span><span class="op" id="1431830">(</span><span class="op" id="1431831">&amp;</span><span class="ident" id="1431832">c</span><span class="op" id="1431833">.</span><span class="ident" id="1431834">waiters</span><span class="op" id="1431841">,</span>&nbsp;<span class="num" id="1431843">1</span><span class="op" id="1431844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431847">if</span>&nbsp;<span class="ident" id="1431850">raceenabled</span>&nbsp;<span class="op" id="1431862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431866">raceEnable</span><span class="op" id="1431876">(</span><span class="op" id="1431877">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1431880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431883">c</span><span class="op" id="1431884">.</span><span class="ident" id="1431885">L</span><span class="op" id="1431886">.</span><span class="ident" id="1431887">Unlock</span><span class="op" id="1431893">(</span><span class="op" id="1431894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431897">runtime_Syncsemacquire</span><span class="op" id="1431919">(</span><span class="op" id="1431920">&amp;</span><span class="ident" id="1431921">c</span><span class="op" id="1431922">.</span><span class="ident" id="1431923">sema</span><span class="op" id="1431927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431930">c</span><span class="op" id="1431931">.</span><span class="ident" id="1431932">L</span><span class="op" id="1431933">.</span><span class="ident" id="1431934">Lock</span><span class="op" id="1431938">(</span><span class="op" id="1431939">)</span><br>
<span class="lineno"></span><span class="op" id="1431941">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="1431944">//&nbsp;Signal&nbsp;wakes&nbsp;one&nbsp;goroutine&nbsp;waiting&nbsp;on&nbsp;c,&nbsp;if&nbsp;there&nbsp;is&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment" id="1432005">//</span><br>
<span class="lineno"></span><span class="comment" id="1432008">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;but&nbsp;not&nbsp;required&nbsp;for&nbsp;the&nbsp;caller&nbsp;to&nbsp;hold&nbsp;c.L</span><br>
<span class="lineno"></span><span class="comment" id="1432069">//&nbsp;during&nbsp;the&nbsp;call.</span><br>
<span class="lineno">70</span><span class="keyword" id="1432089">func</span>&nbsp;<span class="op" id="1432094">(</span><span class="ident" id="1432095">c</span>&nbsp;<span class="op" id="1432097">*</span><span class="ident" id="1432098">Cond</span><span class="op" id="1432102">)</span>&nbsp;<span class="ident" id="1432104">Signal</span><span class="op" id="1432110">(</span><span class="op" id="1432111">)</span>&nbsp;<span class="op" id="1432113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432116">c</span><span class="op" id="1432117">.</span><span class="ident" id="1432118">signalImpl</span><span class="op" id="1432128">(</span><span class="builtintype" id="1432129">false</span><span class="op" id="1432134">)</span><br>
<span class="lineno"></span><span class="op" id="1432136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1432139">//&nbsp;Broadcast&nbsp;wakes&nbsp;all&nbsp;goroutines&nbsp;waiting&nbsp;on&nbsp;c.</span><br>
<span class="lineno">75</span><span class="comment" id="1432187">//</span><br>
<span class="lineno"></span><span class="comment" id="1432190">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;but&nbsp;not&nbsp;required&nbsp;for&nbsp;the&nbsp;caller&nbsp;to&nbsp;hold&nbsp;c.L</span><br>
<span class="lineno"></span><span class="comment" id="1432251">//&nbsp;during&nbsp;the&nbsp;call.</span><br>
<span class="lineno"></span><span class="keyword" id="1432271">func</span>&nbsp;<span class="op" id="1432276">(</span><span class="ident" id="1432277">c</span>&nbsp;<span class="op" id="1432279">*</span><span class="ident" id="1432280">Cond</span><span class="op" id="1432284">)</span>&nbsp;<span class="ident" id="1432286">Broadcast</span><span class="op" id="1432295">(</span><span class="op" id="1432296">)</span>&nbsp;<span class="op" id="1432298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432301">c</span><span class="op" id="1432302">.</span><span class="ident" id="1432303">signalImpl</span><span class="op" id="1432313">(</span><span class="builtintype" id="1432314">true</span><span class="op" id="1432318">)</span><br>
<span class="lineno">80</span><span class="op" id="1432320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1432323">func</span>&nbsp;<span class="op" id="1432328">(</span><span class="ident" id="1432329">c</span>&nbsp;<span class="op" id="1432331">*</span><span class="ident" id="1432332">Cond</span><span class="op" id="1432336">)</span>&nbsp;<span class="ident" id="1432338">signalImpl</span><span class="op" id="1432348">(</span><span class="ident" id="1432349">all</span>&nbsp;<span class="builtintype" id="1432353">bool</span><span class="op" id="1432357">)</span>&nbsp;<span class="op" id="1432359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432362">c</span><span class="op" id="1432363">.</span><span class="ident" id="1432364">checker</span><span class="op" id="1432371">.</span><span class="ident" id="1432372">check</span><span class="op" id="1432377">(</span><span class="op" id="1432378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432381">if</span>&nbsp;<span class="ident" id="1432384">raceenabled</span>&nbsp;<span class="op" id="1432396">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432400">raceDisable</span><span class="op" id="1432411">(</span><span class="op" id="1432412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432418">for</span>&nbsp;<span class="op" id="1432422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432426">old</span>&nbsp;<span class="op" id="1432430">:=</span>&nbsp;<span class="ident" id="1432433">atomic</span><span class="op" id="1432439">.</span><span class="ident" id="1432440">LoadUint32</span><span class="op" id="1432450">(</span><span class="op" id="1432451">&amp;</span><span class="ident" id="1432452">c</span><span class="op" id="1432453">.</span><span class="ident" id="1432454">waiters</span><span class="op" id="1432461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432465">if</span>&nbsp;<span class="ident" id="1432468">old</span>&nbsp;<span class="op" id="1432472">==</span>&nbsp;<span class="num" id="1432475">0</span>&nbsp;<span class="op" id="1432477">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432482">if</span>&nbsp;<span class="ident" id="1432485">raceenabled</span>&nbsp;<span class="op" id="1432497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432503">raceEnable</span><span class="op" id="1432513">(</span><span class="op" id="1432514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432524">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432533">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1432537">new</span>&nbsp;<span class="op" id="1432541">:=</span>&nbsp;<span class="ident" id="1432544">old</span>&nbsp;<span class="op" id="1432548">-</span>&nbsp;<span class="num" id="1432550">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432554">if</span>&nbsp;<span class="ident" id="1432557">all</span>&nbsp;<span class="op" id="1432561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1432566">new</span>&nbsp;<span class="op" id="1432570">=</span>&nbsp;<span class="num" id="1432572">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432580">if</span>&nbsp;<span class="ident" id="1432583">atomic</span><span class="op" id="1432589">.</span><span class="ident" id="1432590">CompareAndSwapUint32</span><span class="op" id="1432610">(</span><span class="op" id="1432611">&amp;</span><span class="ident" id="1432612">c</span><span class="op" id="1432613">.</span><span class="ident" id="1432614">waiters</span><span class="op" id="1432621">,</span>&nbsp;<span class="ident" id="1432623">old</span><span class="op" id="1432626">,</span>&nbsp;<span class="builtinfunc" id="1432628">new</span><span class="op" id="1432631">)</span>&nbsp;<span class="op" id="1432633">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432638">if</span>&nbsp;<span class="ident" id="1432641">raceenabled</span>&nbsp;<span class="op" id="1432653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432659">raceEnable</span><span class="op" id="1432669">(</span><span class="op" id="1432670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432680">runtime_Syncsemrelease</span><span class="op" id="1432702">(</span><span class="op" id="1432703">&amp;</span><span class="ident" id="1432704">c</span><span class="op" id="1432705">.</span><span class="ident" id="1432706">sema</span><span class="op" id="1432710">,</span>&nbsp;<span class="ident" id="1432712">old</span><span class="op" id="1432715">-</span><span class="builtinfunc" id="1432716">new</span><span class="op" id="1432719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432724">return</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432736">}</span><br>
<span class="lineno"></span><span class="op" id="1432738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1432741">//&nbsp;copyChecker&nbsp;holds&nbsp;back&nbsp;pointer&nbsp;to&nbsp;itself&nbsp;to&nbsp;detect&nbsp;object&nbsp;copying.</span><br>
<span class="lineno">110</span><span class="keyword" id="1432811">type</span>&nbsp;<span class="ident" id="1432816">copyChecker</span>&nbsp;<span class="builtintype" id="1432828">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1432837">func</span>&nbsp;<span class="op" id="1432842">(</span><span class="ident" id="1432843">c</span>&nbsp;<span class="op" id="1432845">*</span><span class="ident" id="1432846">copyChecker</span><span class="op" id="1432857">)</span>&nbsp;<span class="ident" id="1432859">check</span><span class="op" id="1432864">(</span><span class="op" id="1432865">)</span>&nbsp;<span class="op" id="1432867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432870">if</span>&nbsp;<span class="builtintype" id="1432873">uintptr</span><span class="op" id="1432880">(</span><span class="op" id="1432881">*</span><span class="ident" id="1432882">c</span><span class="op" id="1432883">)</span>&nbsp;<span class="op" id="1432885">!=</span>&nbsp;<span class="builtintype" id="1432888">uintptr</span><span class="op" id="1432895">(</span><span class="ident" id="1432896">unsafe</span><span class="op" id="1432902">.</span><span class="ident" id="1432903">Pointer</span><span class="op" id="1432910">(</span><span class="ident" id="1432911">c</span><span class="op" id="1432912">)</span><span class="op" id="1432913">)</span>&nbsp;<span class="op" id="1432915">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432920">!</span><span class="ident" id="1432921">atomic</span><span class="op" id="1432927">.</span><span class="ident" id="1432928">CompareAndSwapUintptr</span><span class="op" id="1432949">(</span><span class="op" id="1432950">(</span><span class="op" id="1432951">*</span><span class="builtintype" id="1432952">uintptr</span><span class="op" id="1432959">)</span><span class="op" id="1432960">(</span><span class="ident" id="1432961">c</span><span class="op" id="1432962">)</span><span class="op" id="1432963">,</span>&nbsp;<span class="num" id="1432965">0</span><span class="op" id="1432966">,</span>&nbsp;<span class="builtintype" id="1432968">uintptr</span><span class="op" id="1432975">(</span><span class="ident" id="1432976">unsafe</span><span class="op" id="1432982">.</span><span class="ident" id="1432983">Pointer</span><span class="op" id="1432990">(</span><span class="ident" id="1432991">c</span><span class="op" id="1432992">)</span><span class="op" id="1432993">)</span><span class="op" id="1432994">)</span>&nbsp;<span class="op" id="1432996">&amp;&amp;</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1433001">uintptr</span><span class="op" id="1433008">(</span><span class="op" id="1433009">*</span><span class="ident" id="1433010">c</span><span class="op" id="1433011">)</span>&nbsp;<span class="op" id="1433013">!=</span>&nbsp;<span class="builtintype" id="1433016">uintptr</span><span class="op" id="1433023">(</span><span class="ident" id="1433024">unsafe</span><span class="op" id="1433030">.</span><span class="ident" id="1433031">Pointer</span><span class="op" id="1433038">(</span><span class="ident" id="1433039">c</span><span class="op" id="1433040">)</span><span class="op" id="1433041">)</span>&nbsp;<span class="op" id="1433043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1433047">panic</span><span class="op" id="1433052">(</span><span class="string" id="1433053">&#34;sync.Cond&nbsp;is&nbsp;copied&#34;</span><span class="op" id="1433074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1433077">}</span><br>
<span class="lineno"></span><span class="op" id="1433079">}</span>
</div>
</body>
</html>
