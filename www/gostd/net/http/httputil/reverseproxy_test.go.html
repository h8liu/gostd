<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html" class="current">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7410164">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7410219">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7410273">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7410324">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7410349">package</span>&nbsp;<span class="ident" id="7410357">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7410367">import</span>&nbsp;<span class="op" id="7410374">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7410377">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7410390">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7410402">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7410423">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7410434">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7410445">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7410456">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7410463">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7410466">const</span>&nbsp;<span class="ident" id="7410472">fakeHopHeader</span>&nbsp;<span class="op" id="7410486">=</span>&nbsp;<span class="string" id="7410488">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7410518">func</span>&nbsp;<span class="ident" id="7410523">init</span><span class="op" id="7410527">(</span><span class="op" id="7410528">)</span>&nbsp;<span class="op" id="7410530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7410533">hopHeaders</span>&nbsp;<span class="op" id="7410544">=</span>&nbsp;<span class="builtinfunc" id="7410546">append</span><span class="op" id="7410552">(</span><span class="ident" id="7410553">hopHeaders</span><span class="op" id="7410563">,</span>&nbsp;<span class="ident" id="7410565">fakeHopHeader</span><span class="op" id="7410578">)</span><br>
<span class="lineno"></span><span class="op" id="7410580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7410583">func</span>&nbsp;<span class="ident" id="7410588">TestReverseProxy</span><span class="op" id="7410604">(</span><span class="ident" id="7410605">t</span>&nbsp;<span class="op" id="7410607">*</span><span class="ident" id="7410608">testing</span><span class="op" id="7410615">.</span><span class="ident" id="7410616">T</span><span class="op" id="7410617">)</span>&nbsp;<span class="op" id="7410619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7410622">const</span>&nbsp;<span class="ident" id="7410628">backendResponse</span>&nbsp;<span class="op" id="7410644">=</span>&nbsp;<span class="string" id="7410646">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7410666">const</span>&nbsp;<span class="ident" id="7410672">backendStatus</span>&nbsp;<span class="op" id="7410686">=</span>&nbsp;<span class="num" id="7410688">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7410693">backend</span>&nbsp;<span class="op" id="7410701">:=</span>&nbsp;<span class="ident" id="7410704">httptest</span><span class="op" id="7410712">.</span><span class="ident" id="7410713">NewServer</span><span class="op" id="7410722">(</span><span class="ident" id="7410723">http</span><span class="op" id="7410727">.</span><span class="ident" id="7410728">HandlerFunc</span><span class="op" id="7410739">(</span><span class="keyword" id="7410740">func</span><span class="op" id="7410744">(</span><span class="ident" id="7410745">w</span>&nbsp;<span class="ident" id="7410747">http</span><span class="op" id="7410751">.</span><span class="ident" id="7410752">ResponseWriter</span><span class="op" id="7410766">,</span>&nbsp;<span class="ident" id="7410768">r</span>&nbsp;<span class="op" id="7410770">*</span><span class="ident" id="7410771">http</span><span class="op" id="7410775">.</span><span class="ident" id="7410776">Request</span><span class="op" id="7410783">)</span>&nbsp;<span class="op" id="7410785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7410789">if</span>&nbsp;<span class="builtinfunc" id="7410792">len</span><span class="op" id="7410795">(</span><span class="ident" id="7410796">r</span><span class="op" id="7410797">.</span><span class="ident" id="7410798">TransferEncoding</span><span class="op" id="7410814">)</span>&nbsp;<span class="op" id="7410816">&gt;</span>&nbsp;<span class="num" id="7410818">0</span>&nbsp;<span class="op" id="7410820">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7410825">t</span><span class="op" id="7410826">.</span><span class="ident" id="7410827">Errorf</span><span class="op" id="7410833">(</span><span class="string" id="7410834">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="7410879">,</span>&nbsp;<span class="ident" id="7410881">r</span><span class="op" id="7410882">.</span><span class="ident" id="7410883">TransferEncoding</span><span class="op" id="7410899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7410903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7410907">if</span>&nbsp;<span class="ident" id="7410910">r</span><span class="op" id="7410911">.</span><span class="ident" id="7410912">Header</span><span class="op" id="7410918">.</span><span class="ident" id="7410919">Get</span><span class="op" id="7410922">(</span><span class="string" id="7410923">&#34;X-Forwarded-For&#34;</span><span class="op" id="7410940">)</span>&nbsp;<span class="op" id="7410942">==</span>&nbsp;<span class="string" id="7410945">&#34;&#34;</span>&nbsp;<span class="op" id="7410948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7410953">t</span><span class="op" id="7410954">.</span><span class="ident" id="7410955">Errorf</span><span class="op" id="7410961">(</span><span class="string" id="7410962">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7410997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7411001">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7411005">if</span>&nbsp;<span class="ident" id="7411008">c</span>&nbsp;<span class="op" id="7411010">:=</span>&nbsp;<span class="ident" id="7411013">r</span><span class="op" id="7411014">.</span><span class="ident" id="7411015">Header</span><span class="op" id="7411021">.</span><span class="ident" id="7411022">Get</span><span class="op" id="7411025">(</span><span class="string" id="7411026">&#34;Connection&#34;</span><span class="op" id="7411038">)</span><span class="op" id="7411039">;</span>&nbsp;<span class="ident" id="7411041">c</span>&nbsp;<span class="op" id="7411043">!=</span>&nbsp;<span class="string" id="7411046">&#34;&#34;</span>&nbsp;<span class="op" id="7411049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411054">t</span><span class="op" id="7411055">.</span><span class="ident" id="7411056">Errorf</span><span class="op" id="7411062">(</span><span class="string" id="7411063">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7411103">,</span>&nbsp;<span class="ident" id="7411105">c</span><span class="op" id="7411106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7411110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7411114">if</span>&nbsp;<span class="ident" id="7411117">c</span>&nbsp;<span class="op" id="7411119">:=</span>&nbsp;<span class="ident" id="7411122">r</span><span class="op" id="7411123">.</span><span class="ident" id="7411124">Header</span><span class="op" id="7411130">.</span><span class="ident" id="7411131">Get</span><span class="op" id="7411134">(</span><span class="string" id="7411135">&#34;Upgrade&#34;</span><span class="op" id="7411144">)</span><span class="op" id="7411145">;</span>&nbsp;<span class="ident" id="7411147">c</span>&nbsp;<span class="op" id="7411149">!=</span>&nbsp;<span class="string" id="7411152">&#34;&#34;</span>&nbsp;<span class="op" id="7411155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411160">t</span><span class="op" id="7411161">.</span><span class="ident" id="7411162">Errorf</span><span class="op" id="7411168">(</span><span class="string" id="7411169">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7411206">,</span>&nbsp;<span class="ident" id="7411208">c</span><span class="op" id="7411209">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7411213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7411217">if</span>&nbsp;<span class="ident" id="7411220">g</span><span class="op" id="7411221">,</span>&nbsp;<span class="ident" id="7411223">e</span>&nbsp;<span class="op" id="7411225">:=</span>&nbsp;<span class="ident" id="7411228">r</span><span class="op" id="7411229">.</span><span class="ident" id="7411230">Host</span><span class="op" id="7411234">,</span>&nbsp;<span class="string" id="7411236">&#34;some-name&#34;</span><span class="op" id="7411247">;</span>&nbsp;<span class="ident" id="7411249">g</span>&nbsp;<span class="op" id="7411251">!=</span>&nbsp;<span class="ident" id="7411254">e</span>&nbsp;<span class="op" id="7411256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411261">t</span><span class="op" id="7411262">.</span><span class="ident" id="7411263">Errorf</span><span class="op" id="7411269">(</span><span class="string" id="7411270">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7411307">,</span>&nbsp;<span class="ident" id="7411309">g</span><span class="op" id="7411310">,</span>&nbsp;<span class="ident" id="7411312">e</span><span class="op" id="7411313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7411317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411321">w</span><span class="op" id="7411322">.</span><span class="ident" id="7411323">Header</span><span class="op" id="7411329">(</span><span class="op" id="7411330">)</span><span class="op" id="7411331">.</span><span class="ident" id="7411332">Set</span><span class="op" id="7411335">(</span><span class="string" id="7411336">&#34;X-Foo&#34;</span><span class="op" id="7411343">,</span>&nbsp;<span class="string" id="7411345">&#34;bar&#34;</span><span class="op" id="7411350">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411354">w</span><span class="op" id="7411355">.</span><span class="ident" id="7411356">Header</span><span class="op" id="7411362">(</span><span class="op" id="7411363">)</span><span class="op" id="7411364">.</span><span class="ident" id="7411365">Set</span><span class="op" id="7411368">(</span><span class="string" id="7411369">&#34;Upgrade&#34;</span><span class="op" id="7411378">,</span>&nbsp;<span class="string" id="7411380">&#34;foo&#34;</span><span class="op" id="7411385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411389">w</span><span class="op" id="7411390">.</span><span class="ident" id="7411391">Header</span><span class="op" id="7411397">(</span><span class="op" id="7411398">)</span><span class="op" id="7411399">.</span><span class="ident" id="7411400">Set</span><span class="op" id="7411403">(</span><span class="ident" id="7411404">fakeHopHeader</span><span class="op" id="7411417">,</span>&nbsp;<span class="string" id="7411419">&#34;foo&#34;</span><span class="op" id="7411424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411428">w</span><span class="op" id="7411429">.</span><span class="ident" id="7411430">Header</span><span class="op" id="7411436">(</span><span class="op" id="7411437">)</span><span class="op" id="7411438">.</span><span class="ident" id="7411439">Add</span><span class="op" id="7411442">(</span><span class="string" id="7411443">&#34;X-Multi-Value&#34;</span><span class="op" id="7411458">,</span>&nbsp;<span class="string" id="7411460">&#34;foo&#34;</span><span class="op" id="7411465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411469">w</span><span class="op" id="7411470">.</span><span class="ident" id="7411471">Header</span><span class="op" id="7411477">(</span><span class="op" id="7411478">)</span><span class="op" id="7411479">.</span><span class="ident" id="7411480">Add</span><span class="op" id="7411483">(</span><span class="string" id="7411484">&#34;X-Multi-Value&#34;</span><span class="op" id="7411499">,</span>&nbsp;<span class="string" id="7411501">&#34;bar&#34;</span><span class="op" id="7411506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411510">http</span><span class="op" id="7411514">.</span><span class="ident" id="7411515">SetCookie</span><span class="op" id="7411524">(</span><span class="ident" id="7411525">w</span><span class="op" id="7411526">,</span>&nbsp;<span class="op" id="7411528">&amp;</span><span class="ident" id="7411529">http</span><span class="op" id="7411533">.</span><span class="ident" id="7411534">Cookie</span><span class="op" id="7411540">{</span><span class="ident" id="7411541">Name</span><span class="op" id="7411545">:</span>&nbsp;<span class="string" id="7411547">&#34;flavor&#34;</span><span class="op" id="7411555">,</span>&nbsp;<span class="ident" id="7411557">Value</span><span class="op" id="7411562">:</span>&nbsp;<span class="string" id="7411564">&#34;chocolateChip&#34;</span><span class="op" id="7411579">}</span><span class="op" id="7411580">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411584">w</span><span class="op" id="7411585">.</span><span class="ident" id="7411586">WriteHeader</span><span class="op" id="7411597">(</span><span class="ident" id="7411598">backendStatus</span><span class="op" id="7411611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411615">w</span><span class="op" id="7411616">.</span><span class="ident" id="7411617">Write</span><span class="op" id="7411622">(</span><span class="op" id="7411623">[</span><span class="op" id="7411624">]</span><span class="builtintype" id="7411625">byte</span><span class="op" id="7411629">(</span><span class="ident" id="7411630">backendResponse</span><span class="op" id="7411645">)</span><span class="op" id="7411646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7411649">}</span><span class="op" id="7411650">)</span><span class="op" id="7411651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7411654">defer</span>&nbsp;<span class="ident" id="7411660">backend</span><span class="op" id="7411667">.</span><span class="ident" id="7411668">Close</span><span class="op" id="7411673">(</span><span class="op" id="7411674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411677">backendURL</span><span class="op" id="7411687">,</span>&nbsp;<span class="ident" id="7411689">err</span>&nbsp;<span class="op" id="7411693">:=</span>&nbsp;<span class="ident" id="7411696">url</span><span class="op" id="7411699">.</span><span class="ident" id="7411700">Parse</span><span class="op" id="7411705">(</span><span class="ident" id="7411706">backend</span><span class="op" id="7411713">.</span><span class="ident" id="7411714">URL</span><span class="op" id="7411717">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7411720">if</span>&nbsp;<span class="ident" id="7411723">err</span>&nbsp;<span class="op" id="7411727">!=</span>&nbsp;<span class="builtintype" id="7411730">nil</span>&nbsp;<span class="op" id="7411734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411738">t</span><span class="op" id="7411739">.</span><span class="ident" id="7411740">Fatal</span><span class="op" id="7411745">(</span><span class="ident" id="7411746">err</span><span class="op" id="7411749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7411752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411755">proxyHandler</span>&nbsp;<span class="op" id="7411768">:=</span>&nbsp;<span class="ident" id="7411771">NewSingleHostReverseProxy</span><span class="op" id="7411796">(</span><span class="ident" id="7411797">backendURL</span><span class="op" id="7411807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411810">frontend</span>&nbsp;<span class="op" id="7411819">:=</span>&nbsp;<span class="ident" id="7411822">httptest</span><span class="op" id="7411830">.</span><span class="ident" id="7411831">NewServer</span><span class="op" id="7411840">(</span><span class="ident" id="7411841">proxyHandler</span><span class="op" id="7411853">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7411856">defer</span>&nbsp;<span class="ident" id="7411862">frontend</span><span class="op" id="7411870">.</span><span class="ident" id="7411871">Close</span><span class="op" id="7411876">(</span><span class="op" id="7411877">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411881">getReq</span><span class="op" id="7411887">,</span>&nbsp;<span class="ident" id="7411889">_</span>&nbsp;<span class="op" id="7411891">:=</span>&nbsp;<span class="ident" id="7411894">http</span><span class="op" id="7411898">.</span><span class="ident" id="7411899">NewRequest</span><span class="op" id="7411909">(</span><span class="string" id="7411910">&#34;GET&#34;</span><span class="op" id="7411915">,</span>&nbsp;<span class="ident" id="7411917">frontend</span><span class="op" id="7411925">.</span><span class="ident" id="7411926">URL</span><span class="op" id="7411929">,</span>&nbsp;<span class="builtintype" id="7411931">nil</span><span class="op" id="7411934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411937">getReq</span><span class="op" id="7411943">.</span><span class="ident" id="7411944">Host</span>&nbsp;<span class="op" id="7411949">=</span>&nbsp;<span class="string" id="7411951">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7411964">getReq</span><span class="op" id="7411970">.</span><span class="ident" id="7411971">Header</span><span class="op" id="7411977">.</span><span class="ident" id="7411978">Set</span><span class="op" id="7411981">(</span><span class="string" id="7411982">&#34;Connection&#34;</span><span class="op" id="7411994">,</span>&nbsp;<span class="string" id="7411996">&#34;close&#34;</span><span class="op" id="7412003">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412006">getReq</span><span class="op" id="7412012">.</span><span class="ident" id="7412013">Header</span><span class="op" id="7412019">.</span><span class="ident" id="7412020">Set</span><span class="op" id="7412023">(</span><span class="string" id="7412024">&#34;Upgrade&#34;</span><span class="op" id="7412033">,</span>&nbsp;<span class="string" id="7412035">&#34;foo&#34;</span><span class="op" id="7412040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412043">getReq</span><span class="op" id="7412049">.</span><span class="ident" id="7412050">Close</span>&nbsp;<span class="op" id="7412056">=</span>&nbsp;<span class="builtintype" id="7412058">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412064">res</span><span class="op" id="7412067">,</span>&nbsp;<span class="ident" id="7412069">err</span>&nbsp;<span class="op" id="7412073">:=</span>&nbsp;<span class="ident" id="7412076">http</span><span class="op" id="7412080">.</span><span class="ident" id="7412081">DefaultClient</span><span class="op" id="7412094">.</span><span class="ident" id="7412095">Do</span><span class="op" id="7412097">(</span><span class="ident" id="7412098">getReq</span><span class="op" id="7412104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412107">if</span>&nbsp;<span class="ident" id="7412110">err</span>&nbsp;<span class="op" id="7412114">!=</span>&nbsp;<span class="builtintype" id="7412117">nil</span>&nbsp;<span class="op" id="7412121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412125">t</span><span class="op" id="7412126">.</span><span class="ident" id="7412127">Fatalf</span><span class="op" id="7412133">(</span><span class="string" id="7412134">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7412143">,</span>&nbsp;<span class="ident" id="7412145">err</span><span class="op" id="7412148">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412154">if</span>&nbsp;<span class="ident" id="7412157">g</span><span class="op" id="7412158">,</span>&nbsp;<span class="ident" id="7412160">e</span>&nbsp;<span class="op" id="7412162">:=</span>&nbsp;<span class="ident" id="7412165">res</span><span class="op" id="7412168">.</span><span class="ident" id="7412169">StatusCode</span><span class="op" id="7412179">,</span>&nbsp;<span class="ident" id="7412181">backendStatus</span><span class="op" id="7412194">;</span>&nbsp;<span class="ident" id="7412196">g</span>&nbsp;<span class="op" id="7412198">!=</span>&nbsp;<span class="ident" id="7412201">e</span>&nbsp;<span class="op" id="7412203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412207">t</span><span class="op" id="7412208">.</span><span class="ident" id="7412209">Errorf</span><span class="op" id="7412215">(</span><span class="string" id="7412216">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7412252">,</span>&nbsp;<span class="ident" id="7412254">g</span><span class="op" id="7412255">,</span>&nbsp;<span class="ident" id="7412257">e</span><span class="op" id="7412258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412264">if</span>&nbsp;<span class="ident" id="7412267">g</span><span class="op" id="7412268">,</span>&nbsp;<span class="ident" id="7412270">e</span>&nbsp;<span class="op" id="7412272">:=</span>&nbsp;<span class="ident" id="7412275">res</span><span class="op" id="7412278">.</span><span class="ident" id="7412279">Header</span><span class="op" id="7412285">.</span><span class="ident" id="7412286">Get</span><span class="op" id="7412289">(</span><span class="string" id="7412290">&#34;X-Foo&#34;</span><span class="op" id="7412297">)</span><span class="op" id="7412298">,</span>&nbsp;<span class="string" id="7412300">&#34;bar&#34;</span><span class="op" id="7412305">;</span>&nbsp;<span class="ident" id="7412307">g</span>&nbsp;<span class="op" id="7412309">!=</span>&nbsp;<span class="ident" id="7412312">e</span>&nbsp;<span class="op" id="7412314">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412318">t</span><span class="op" id="7412319">.</span><span class="ident" id="7412320">Errorf</span><span class="op" id="7412326">(</span><span class="string" id="7412327">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7412354">,</span>&nbsp;<span class="ident" id="7412356">g</span><span class="op" id="7412357">,</span>&nbsp;<span class="ident" id="7412359">e</span><span class="op" id="7412360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412366">if</span>&nbsp;<span class="ident" id="7412369">c</span>&nbsp;<span class="op" id="7412371">:=</span>&nbsp;<span class="ident" id="7412374">res</span><span class="op" id="7412377">.</span><span class="ident" id="7412378">Header</span><span class="op" id="7412384">.</span><span class="ident" id="7412385">Get</span><span class="op" id="7412388">(</span><span class="ident" id="7412389">fakeHopHeader</span><span class="op" id="7412402">)</span><span class="op" id="7412403">;</span>&nbsp;<span class="ident" id="7412405">c</span>&nbsp;<span class="op" id="7412407">!=</span>&nbsp;<span class="string" id="7412410">&#34;&#34;</span>&nbsp;<span class="op" id="7412413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412417">t</span><span class="op" id="7412418">.</span><span class="ident" id="7412419">Errorf</span><span class="op" id="7412425">(</span><span class="string" id="7412426">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7412450">,</span>&nbsp;<span class="ident" id="7412452">fakeHopHeader</span><span class="op" id="7412465">,</span>&nbsp;<span class="ident" id="7412467">c</span><span class="op" id="7412468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412471">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412474">if</span>&nbsp;<span class="ident" id="7412477">g</span><span class="op" id="7412478">,</span>&nbsp;<span class="ident" id="7412480">e</span>&nbsp;<span class="op" id="7412482">:=</span>&nbsp;<span class="builtinfunc" id="7412485">len</span><span class="op" id="7412488">(</span><span class="ident" id="7412489">res</span><span class="op" id="7412492">.</span><span class="ident" id="7412493">Header</span><span class="op" id="7412499">[</span><span class="string" id="7412500">&#34;X-Multi-Value&#34;</span><span class="op" id="7412515">]</span><span class="op" id="7412516">)</span><span class="op" id="7412517">,</span>&nbsp;<span class="num" id="7412519">2</span><span class="op" id="7412520">;</span>&nbsp;<span class="ident" id="7412522">g</span>&nbsp;<span class="op" id="7412524">!=</span>&nbsp;<span class="ident" id="7412527">e</span>&nbsp;<span class="op" id="7412529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412533">t</span><span class="op" id="7412534">.</span><span class="ident" id="7412535">Errorf</span><span class="op" id="7412541">(</span><span class="string" id="7412542">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7412591">,</span>&nbsp;<span class="ident" id="7412593">g</span><span class="op" id="7412594">,</span>&nbsp;<span class="ident" id="7412596">e</span><span class="op" id="7412597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412603">if</span>&nbsp;<span class="ident" id="7412606">g</span><span class="op" id="7412607">,</span>&nbsp;<span class="ident" id="7412609">e</span>&nbsp;<span class="op" id="7412611">:=</span>&nbsp;<span class="builtinfunc" id="7412614">len</span><span class="op" id="7412617">(</span><span class="ident" id="7412618">res</span><span class="op" id="7412621">.</span><span class="ident" id="7412622">Header</span><span class="op" id="7412628">[</span><span class="string" id="7412629">&#34;Set-Cookie&#34;</span><span class="op" id="7412641">]</span><span class="op" id="7412642">)</span><span class="op" id="7412643">,</span>&nbsp;<span class="num" id="7412645">1</span><span class="op" id="7412646">;</span>&nbsp;<span class="ident" id="7412648">g</span>&nbsp;<span class="op" id="7412650">!=</span>&nbsp;<span class="ident" id="7412653">e</span>&nbsp;<span class="op" id="7412655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412659">t</span><span class="op" id="7412660">.</span><span class="ident" id="7412661">Fatalf</span><span class="op" id="7412667">(</span><span class="string" id="7412668">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7412696">,</span>&nbsp;<span class="ident" id="7412698">g</span><span class="op" id="7412699">,</span>&nbsp;<span class="ident" id="7412701">e</span><span class="op" id="7412702">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412708">if</span>&nbsp;<span class="ident" id="7412711">cookie</span>&nbsp;<span class="op" id="7412718">:=</span>&nbsp;<span class="ident" id="7412721">res</span><span class="op" id="7412724">.</span><span class="ident" id="7412725">Cookies</span><span class="op" id="7412732">(</span><span class="op" id="7412733">)</span><span class="op" id="7412734">[</span><span class="num" id="7412735">0</span><span class="op" id="7412736">]</span><span class="op" id="7412737">;</span>&nbsp;<span class="ident" id="7412739">cookie</span><span class="op" id="7412745">.</span><span class="ident" id="7412746">Name</span>&nbsp;<span class="op" id="7412751">!=</span>&nbsp;<span class="string" id="7412754">&#34;flavor&#34;</span>&nbsp;<span class="op" id="7412763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412767">t</span><span class="op" id="7412768">.</span><span class="ident" id="7412769">Errorf</span><span class="op" id="7412775">(</span><span class="string" id="7412776">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="7412798">,</span>&nbsp;<span class="ident" id="7412800">cookie</span><span class="op" id="7412806">.</span><span class="ident" id="7412807">Name</span><span class="op" id="7412811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412817">bodyBytes</span><span class="op" id="7412826">,</span>&nbsp;<span class="ident" id="7412828">_</span>&nbsp;<span class="op" id="7412830">:=</span>&nbsp;<span class="ident" id="7412833">ioutil</span><span class="op" id="7412839">.</span><span class="ident" id="7412840">ReadAll</span><span class="op" id="7412847">(</span><span class="ident" id="7412848">res</span><span class="op" id="7412851">.</span><span class="ident" id="7412852">Body</span><span class="op" id="7412856">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412859">if</span>&nbsp;<span class="ident" id="7412862">g</span><span class="op" id="7412863">,</span>&nbsp;<span class="ident" id="7412865">e</span>&nbsp;<span class="op" id="7412867">:=</span>&nbsp;<span class="builtintype" id="7412870">string</span><span class="op" id="7412876">(</span><span class="ident" id="7412877">bodyBytes</span><span class="op" id="7412886">)</span><span class="op" id="7412887">,</span>&nbsp;<span class="ident" id="7412889">backendResponse</span><span class="op" id="7412904">;</span>&nbsp;<span class="ident" id="7412906">g</span>&nbsp;<span class="op" id="7412908">!=</span>&nbsp;<span class="ident" id="7412911">e</span>&nbsp;<span class="op" id="7412913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412917">t</span><span class="op" id="7412918">.</span><span class="ident" id="7412919">Errorf</span><span class="op" id="7412925">(</span><span class="string" id="7412926">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7412952">,</span>&nbsp;<span class="ident" id="7412954">g</span><span class="op" id="7412955">,</span>&nbsp;<span class="ident" id="7412957">e</span><span class="op" id="7412958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412961">}</span><br>
<span class="lineno"></span><span class="op" id="7412963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7412966">func</span>&nbsp;<span class="ident" id="7412971">TestXForwardedFor</span><span class="op" id="7412988">(</span><span class="ident" id="7412989">t</span>&nbsp;<span class="op" id="7412991">*</span><span class="ident" id="7412992">testing</span><span class="op" id="7412999">.</span><span class="ident" id="7413000">T</span><span class="op" id="7413001">)</span>&nbsp;<span class="op" id="7413003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413006">const</span>&nbsp;<span class="ident" id="7413012">prevForwardedFor</span>&nbsp;<span class="op" id="7413029">=</span>&nbsp;<span class="string" id="7413031">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413044">const</span>&nbsp;<span class="ident" id="7413050">backendResponse</span>&nbsp;<span class="op" id="7413066">=</span>&nbsp;<span class="string" id="7413068">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413088">const</span>&nbsp;<span class="ident" id="7413094">backendStatus</span>&nbsp;<span class="op" id="7413108">=</span>&nbsp;<span class="num" id="7413110">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413115">backend</span>&nbsp;<span class="op" id="7413123">:=</span>&nbsp;<span class="ident" id="7413126">httptest</span><span class="op" id="7413134">.</span><span class="ident" id="7413135">NewServer</span><span class="op" id="7413144">(</span><span class="ident" id="7413145">http</span><span class="op" id="7413149">.</span><span class="ident" id="7413150">HandlerFunc</span><span class="op" id="7413161">(</span><span class="keyword" id="7413162">func</span><span class="op" id="7413166">(</span><span class="ident" id="7413167">w</span>&nbsp;<span class="ident" id="7413169">http</span><span class="op" id="7413173">.</span><span class="ident" id="7413174">ResponseWriter</span><span class="op" id="7413188">,</span>&nbsp;<span class="ident" id="7413190">r</span>&nbsp;<span class="op" id="7413192">*</span><span class="ident" id="7413193">http</span><span class="op" id="7413197">.</span><span class="ident" id="7413198">Request</span><span class="op" id="7413205">)</span>&nbsp;<span class="op" id="7413207">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413211">if</span>&nbsp;<span class="ident" id="7413214">r</span><span class="op" id="7413215">.</span><span class="ident" id="7413216">Header</span><span class="op" id="7413222">.</span><span class="ident" id="7413223">Get</span><span class="op" id="7413226">(</span><span class="string" id="7413227">&#34;X-Forwarded-For&#34;</span><span class="op" id="7413244">)</span>&nbsp;<span class="op" id="7413246">==</span>&nbsp;<span class="string" id="7413249">&#34;&#34;</span>&nbsp;<span class="op" id="7413252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413257">t</span><span class="op" id="7413258">.</span><span class="ident" id="7413259">Errorf</span><span class="op" id="7413265">(</span><span class="string" id="7413266">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7413301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413309">if</span>&nbsp;<span class="op" id="7413312">!</span><span class="ident" id="7413313">strings</span><span class="op" id="7413320">.</span><span class="ident" id="7413321">Contains</span><span class="op" id="7413329">(</span><span class="ident" id="7413330">r</span><span class="op" id="7413331">.</span><span class="ident" id="7413332">Header</span><span class="op" id="7413338">.</span><span class="ident" id="7413339">Get</span><span class="op" id="7413342">(</span><span class="string" id="7413343">&#34;X-Forwarded-For&#34;</span><span class="op" id="7413360">)</span><span class="op" id="7413361">,</span>&nbsp;<span class="ident" id="7413363">prevForwardedFor</span><span class="op" id="7413379">)</span>&nbsp;<span class="op" id="7413381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413386">t</span><span class="op" id="7413387">.</span><span class="ident" id="7413388">Errorf</span><span class="op" id="7413394">(</span><span class="string" id="7413395">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="7413438">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413446">w</span><span class="op" id="7413447">.</span><span class="ident" id="7413448">WriteHeader</span><span class="op" id="7413459">(</span><span class="ident" id="7413460">backendStatus</span><span class="op" id="7413473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413477">w</span><span class="op" id="7413478">.</span><span class="ident" id="7413479">Write</span><span class="op" id="7413484">(</span><span class="op" id="7413485">[</span><span class="op" id="7413486">]</span><span class="builtintype" id="7413487">byte</span><span class="op" id="7413491">(</span><span class="ident" id="7413492">backendResponse</span><span class="op" id="7413507">)</span><span class="op" id="7413508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413511">}</span><span class="op" id="7413512">)</span><span class="op" id="7413513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413516">defer</span>&nbsp;<span class="ident" id="7413522">backend</span><span class="op" id="7413529">.</span><span class="ident" id="7413530">Close</span><span class="op" id="7413535">(</span><span class="op" id="7413536">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413539">backendURL</span><span class="op" id="7413549">,</span>&nbsp;<span class="ident" id="7413551">err</span>&nbsp;<span class="op" id="7413555">:=</span>&nbsp;<span class="ident" id="7413558">url</span><span class="op" id="7413561">.</span><span class="ident" id="7413562">Parse</span><span class="op" id="7413567">(</span><span class="ident" id="7413568">backend</span><span class="op" id="7413575">.</span><span class="ident" id="7413576">URL</span><span class="op" id="7413579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413582">if</span>&nbsp;<span class="ident" id="7413585">err</span>&nbsp;<span class="op" id="7413589">!=</span>&nbsp;<span class="builtintype" id="7413592">nil</span>&nbsp;<span class="op" id="7413596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413600">t</span><span class="op" id="7413601">.</span><span class="ident" id="7413602">Fatal</span><span class="op" id="7413607">(</span><span class="ident" id="7413608">err</span><span class="op" id="7413611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413617">proxyHandler</span>&nbsp;<span class="op" id="7413630">:=</span>&nbsp;<span class="ident" id="7413633">NewSingleHostReverseProxy</span><span class="op" id="7413658">(</span><span class="ident" id="7413659">backendURL</span><span class="op" id="7413669">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413672">frontend</span>&nbsp;<span class="op" id="7413681">:=</span>&nbsp;<span class="ident" id="7413684">httptest</span><span class="op" id="7413692">.</span><span class="ident" id="7413693">NewServer</span><span class="op" id="7413702">(</span><span class="ident" id="7413703">proxyHandler</span><span class="op" id="7413715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413718">defer</span>&nbsp;<span class="ident" id="7413724">frontend</span><span class="op" id="7413732">.</span><span class="ident" id="7413733">Close</span><span class="op" id="7413738">(</span><span class="op" id="7413739">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413743">getReq</span><span class="op" id="7413749">,</span>&nbsp;<span class="ident" id="7413751">_</span>&nbsp;<span class="op" id="7413753">:=</span>&nbsp;<span class="ident" id="7413756">http</span><span class="op" id="7413760">.</span><span class="ident" id="7413761">NewRequest</span><span class="op" id="7413771">(</span><span class="string" id="7413772">&#34;GET&#34;</span><span class="op" id="7413777">,</span>&nbsp;<span class="ident" id="7413779">frontend</span><span class="op" id="7413787">.</span><span class="ident" id="7413788">URL</span><span class="op" id="7413791">,</span>&nbsp;<span class="builtintype" id="7413793">nil</span><span class="op" id="7413796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413799">getReq</span><span class="op" id="7413805">.</span><span class="ident" id="7413806">Host</span>&nbsp;<span class="op" id="7413811">=</span>&nbsp;<span class="string" id="7413813">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413826">getReq</span><span class="op" id="7413832">.</span><span class="ident" id="7413833">Header</span><span class="op" id="7413839">.</span><span class="ident" id="7413840">Set</span><span class="op" id="7413843">(</span><span class="string" id="7413844">&#34;Connection&#34;</span><span class="op" id="7413856">,</span>&nbsp;<span class="string" id="7413858">&#34;close&#34;</span><span class="op" id="7413865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413868">getReq</span><span class="op" id="7413874">.</span><span class="ident" id="7413875">Header</span><span class="op" id="7413881">.</span><span class="ident" id="7413882">Set</span><span class="op" id="7413885">(</span><span class="string" id="7413886">&#34;X-Forwarded-For&#34;</span><span class="op" id="7413903">,</span>&nbsp;<span class="ident" id="7413905">prevForwardedFor</span><span class="op" id="7413921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413924">getReq</span><span class="op" id="7413930">.</span><span class="ident" id="7413931">Close</span>&nbsp;<span class="op" id="7413937">=</span>&nbsp;<span class="builtintype" id="7413939">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413945">res</span><span class="op" id="7413948">,</span>&nbsp;<span class="ident" id="7413950">err</span>&nbsp;<span class="op" id="7413954">:=</span>&nbsp;<span class="ident" id="7413957">http</span><span class="op" id="7413961">.</span><span class="ident" id="7413962">DefaultClient</span><span class="op" id="7413975">.</span><span class="ident" id="7413976">Do</span><span class="op" id="7413978">(</span><span class="ident" id="7413979">getReq</span><span class="op" id="7413985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413988">if</span>&nbsp;<span class="ident" id="7413991">err</span>&nbsp;<span class="op" id="7413995">!=</span>&nbsp;<span class="builtintype" id="7413998">nil</span>&nbsp;<span class="op" id="7414002">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414006">t</span><span class="op" id="7414007">.</span><span class="ident" id="7414008">Fatalf</span><span class="op" id="7414014">(</span><span class="string" id="7414015">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7414024">,</span>&nbsp;<span class="ident" id="7414026">err</span><span class="op" id="7414029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414035">if</span>&nbsp;<span class="ident" id="7414038">g</span><span class="op" id="7414039">,</span>&nbsp;<span class="ident" id="7414041">e</span>&nbsp;<span class="op" id="7414043">:=</span>&nbsp;<span class="ident" id="7414046">res</span><span class="op" id="7414049">.</span><span class="ident" id="7414050">StatusCode</span><span class="op" id="7414060">,</span>&nbsp;<span class="ident" id="7414062">backendStatus</span><span class="op" id="7414075">;</span>&nbsp;<span class="ident" id="7414077">g</span>&nbsp;<span class="op" id="7414079">!=</span>&nbsp;<span class="ident" id="7414082">e</span>&nbsp;<span class="op" id="7414084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414088">t</span><span class="op" id="7414089">.</span><span class="ident" id="7414090">Errorf</span><span class="op" id="7414096">(</span><span class="string" id="7414097">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7414133">,</span>&nbsp;<span class="ident" id="7414135">g</span><span class="op" id="7414136">,</span>&nbsp;<span class="ident" id="7414138">e</span><span class="op" id="7414139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414142">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414145">bodyBytes</span><span class="op" id="7414154">,</span>&nbsp;<span class="ident" id="7414156">_</span>&nbsp;<span class="op" id="7414158">:=</span>&nbsp;<span class="ident" id="7414161">ioutil</span><span class="op" id="7414167">.</span><span class="ident" id="7414168">ReadAll</span><span class="op" id="7414175">(</span><span class="ident" id="7414176">res</span><span class="op" id="7414179">.</span><span class="ident" id="7414180">Body</span><span class="op" id="7414184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414187">if</span>&nbsp;<span class="ident" id="7414190">g</span><span class="op" id="7414191">,</span>&nbsp;<span class="ident" id="7414193">e</span>&nbsp;<span class="op" id="7414195">:=</span>&nbsp;<span class="builtintype" id="7414198">string</span><span class="op" id="7414204">(</span><span class="ident" id="7414205">bodyBytes</span><span class="op" id="7414214">)</span><span class="op" id="7414215">,</span>&nbsp;<span class="ident" id="7414217">backendResponse</span><span class="op" id="7414232">;</span>&nbsp;<span class="ident" id="7414234">g</span>&nbsp;<span class="op" id="7414236">!=</span>&nbsp;<span class="ident" id="7414239">e</span>&nbsp;<span class="op" id="7414241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414245">t</span><span class="op" id="7414246">.</span><span class="ident" id="7414247">Errorf</span><span class="op" id="7414253">(</span><span class="string" id="7414254">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7414280">,</span>&nbsp;<span class="ident" id="7414282">g</span><span class="op" id="7414283">,</span>&nbsp;<span class="ident" id="7414285">e</span><span class="op" id="7414286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414289">}</span><br>
<span class="lineno"></span><span class="op" id="7414291">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="7414294">var</span>&nbsp;<span class="ident" id="7414298">proxyQueryTests</span>&nbsp;<span class="op" id="7414314">=</span>&nbsp;<span class="op" id="7414316">[</span><span class="op" id="7414317">]</span><span class="keyword" id="7414318">struct</span>&nbsp;<span class="op" id="7414325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414328">baseSuffix</span>&nbsp;<span class="builtintype" id="7414339">string</span>&nbsp;<span class="comment" id="7414346">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414379">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="7414390">string</span>&nbsp;<span class="comment" id="7414397">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414441">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7414452">string</span>&nbsp;<span class="comment" id="7414459">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="7414520">}</span><span class="op" id="7414521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414524">{</span><span class="string" id="7414525">&#34;&#34;</span><span class="op" id="7414527">,</span>&nbsp;<span class="string" id="7414529">&#34;&#34;</span><span class="op" id="7414531">,</span>&nbsp;<span class="string" id="7414533">&#34;&#34;</span><span class="op" id="7414535">}</span><span class="op" id="7414536">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414539">{</span><span class="string" id="7414540">&#34;?sta=tic&#34;</span><span class="op" id="7414550">,</span>&nbsp;<span class="string" id="7414552">&#34;?us=er&#34;</span><span class="op" id="7414560">,</span>&nbsp;<span class="string" id="7414562">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="7414577">}</span><span class="op" id="7414578">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414581">{</span><span class="string" id="7414582">&#34;&#34;</span><span class="op" id="7414584">,</span>&nbsp;<span class="string" id="7414586">&#34;?us=er&#34;</span><span class="op" id="7414594">,</span>&nbsp;<span class="string" id="7414596">&#34;us=er&#34;</span><span class="op" id="7414603">}</span><span class="op" id="7414604">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414607">{</span><span class="string" id="7414608">&#34;?sta=tic&#34;</span><span class="op" id="7414618">,</span>&nbsp;<span class="string" id="7414620">&#34;&#34;</span><span class="op" id="7414622">,</span>&nbsp;<span class="string" id="7414624">&#34;sta=tic&#34;</span><span class="op" id="7414633">}</span><span class="op" id="7414634">,</span><br>
<span class="lineno">145</span><span class="op" id="7414636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7414639">func</span>&nbsp;<span class="ident" id="7414644">TestReverseProxyQuery</span><span class="op" id="7414665">(</span><span class="ident" id="7414666">t</span>&nbsp;<span class="op" id="7414668">*</span><span class="ident" id="7414669">testing</span><span class="op" id="7414676">.</span><span class="ident" id="7414677">T</span><span class="op" id="7414678">)</span>&nbsp;<span class="op" id="7414680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414683">backend</span>&nbsp;<span class="op" id="7414691">:=</span>&nbsp;<span class="ident" id="7414694">httptest</span><span class="op" id="7414702">.</span><span class="ident" id="7414703">NewServer</span><span class="op" id="7414712">(</span><span class="ident" id="7414713">http</span><span class="op" id="7414717">.</span><span class="ident" id="7414718">HandlerFunc</span><span class="op" id="7414729">(</span><span class="keyword" id="7414730">func</span><span class="op" id="7414734">(</span><span class="ident" id="7414735">w</span>&nbsp;<span class="ident" id="7414737">http</span><span class="op" id="7414741">.</span><span class="ident" id="7414742">ResponseWriter</span><span class="op" id="7414756">,</span>&nbsp;<span class="ident" id="7414758">r</span>&nbsp;<span class="op" id="7414760">*</span><span class="ident" id="7414761">http</span><span class="op" id="7414765">.</span><span class="ident" id="7414766">Request</span><span class="op" id="7414773">)</span>&nbsp;<span class="op" id="7414775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414779">w</span><span class="op" id="7414780">.</span><span class="ident" id="7414781">Header</span><span class="op" id="7414787">(</span><span class="op" id="7414788">)</span><span class="op" id="7414789">.</span><span class="ident" id="7414790">Set</span><span class="op" id="7414793">(</span><span class="string" id="7414794">&#34;X-Got-Query&#34;</span><span class="op" id="7414807">,</span>&nbsp;<span class="ident" id="7414809">r</span><span class="op" id="7414810">.</span><span class="ident" id="7414811">URL</span><span class="op" id="7414814">.</span><span class="ident" id="7414815">RawQuery</span><span class="op" id="7414823">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414827">w</span><span class="op" id="7414828">.</span><span class="ident" id="7414829">Write</span><span class="op" id="7414834">(</span><span class="op" id="7414835">[</span><span class="op" id="7414836">]</span><span class="builtintype" id="7414837">byte</span><span class="op" id="7414841">(</span><span class="string" id="7414842">&#34;hi&#34;</span><span class="op" id="7414846">)</span><span class="op" id="7414847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414850">}</span><span class="op" id="7414851">)</span><span class="op" id="7414852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414855">defer</span>&nbsp;<span class="ident" id="7414861">backend</span><span class="op" id="7414868">.</span><span class="ident" id="7414869">Close</span><span class="op" id="7414874">(</span><span class="op" id="7414875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414879">for</span>&nbsp;<span class="ident" id="7414883">i</span><span class="op" id="7414884">,</span>&nbsp;<span class="ident" id="7414886">tt</span>&nbsp;<span class="op" id="7414889">:=</span>&nbsp;<span class="keyword" id="7414892">range</span>&nbsp;<span class="ident" id="7414898">proxyQueryTests</span>&nbsp;<span class="op" id="7414914">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414918">backendURL</span><span class="op" id="7414928">,</span>&nbsp;<span class="ident" id="7414930">err</span>&nbsp;<span class="op" id="7414934">:=</span>&nbsp;<span class="ident" id="7414937">url</span><span class="op" id="7414940">.</span><span class="ident" id="7414941">Parse</span><span class="op" id="7414946">(</span><span class="ident" id="7414947">backend</span><span class="op" id="7414954">.</span><span class="ident" id="7414955">URL</span>&nbsp;<span class="op" id="7414959">+</span>&nbsp;<span class="ident" id="7414961">tt</span><span class="op" id="7414963">.</span><span class="ident" id="7414964">baseSuffix</span><span class="op" id="7414974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414978">if</span>&nbsp;<span class="ident" id="7414981">err</span>&nbsp;<span class="op" id="7414985">!=</span>&nbsp;<span class="builtintype" id="7414988">nil</span>&nbsp;<span class="op" id="7414992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414997">t</span><span class="op" id="7414998">.</span><span class="ident" id="7414999">Fatal</span><span class="op" id="7415004">(</span><span class="ident" id="7415005">err</span><span class="op" id="7415008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415016">frontend</span>&nbsp;<span class="op" id="7415025">:=</span>&nbsp;<span class="ident" id="7415028">httptest</span><span class="op" id="7415036">.</span><span class="ident" id="7415037">NewServer</span><span class="op" id="7415046">(</span><span class="ident" id="7415047">NewSingleHostReverseProxy</span><span class="op" id="7415072">(</span><span class="ident" id="7415073">backendURL</span><span class="op" id="7415083">)</span><span class="op" id="7415084">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415088">req</span><span class="op" id="7415091">,</span>&nbsp;<span class="ident" id="7415093">_</span>&nbsp;<span class="op" id="7415095">:=</span>&nbsp;<span class="ident" id="7415098">http</span><span class="op" id="7415102">.</span><span class="ident" id="7415103">NewRequest</span><span class="op" id="7415113">(</span><span class="string" id="7415114">&#34;GET&#34;</span><span class="op" id="7415119">,</span>&nbsp;<span class="ident" id="7415121">frontend</span><span class="op" id="7415129">.</span><span class="ident" id="7415130">URL</span><span class="op" id="7415133">+</span><span class="ident" id="7415134">tt</span><span class="op" id="7415136">.</span><span class="ident" id="7415137">reqSuffix</span><span class="op" id="7415146">,</span>&nbsp;<span class="builtintype" id="7415148">nil</span><span class="op" id="7415151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415155">req</span><span class="op" id="7415158">.</span><span class="ident" id="7415159">Close</span>&nbsp;<span class="op" id="7415165">=</span>&nbsp;<span class="builtintype" id="7415167">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415174">res</span><span class="op" id="7415177">,</span>&nbsp;<span class="ident" id="7415179">err</span>&nbsp;<span class="op" id="7415183">:=</span>&nbsp;<span class="ident" id="7415186">http</span><span class="op" id="7415190">.</span><span class="ident" id="7415191">DefaultClient</span><span class="op" id="7415204">.</span><span class="ident" id="7415205">Do</span><span class="op" id="7415207">(</span><span class="ident" id="7415208">req</span><span class="op" id="7415211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415215">if</span>&nbsp;<span class="ident" id="7415218">err</span>&nbsp;<span class="op" id="7415222">!=</span>&nbsp;<span class="builtintype" id="7415225">nil</span>&nbsp;<span class="op" id="7415229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415234">t</span><span class="op" id="7415235">.</span><span class="ident" id="7415236">Fatalf</span><span class="op" id="7415242">(</span><span class="string" id="7415243">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="7415256">,</span>&nbsp;<span class="ident" id="7415258">i</span><span class="op" id="7415259">,</span>&nbsp;<span class="ident" id="7415261">err</span><span class="op" id="7415264">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415272">if</span>&nbsp;<span class="ident" id="7415275">g</span><span class="op" id="7415276">,</span>&nbsp;<span class="ident" id="7415278">e</span>&nbsp;<span class="op" id="7415280">:=</span>&nbsp;<span class="ident" id="7415283">res</span><span class="op" id="7415286">.</span><span class="ident" id="7415287">Header</span><span class="op" id="7415293">.</span><span class="ident" id="7415294">Get</span><span class="op" id="7415297">(</span><span class="string" id="7415298">&#34;X-Got-Query&#34;</span><span class="op" id="7415311">)</span><span class="op" id="7415312">,</span>&nbsp;<span class="ident" id="7415314">tt</span><span class="op" id="7415316">.</span><span class="ident" id="7415317">want</span><span class="op" id="7415321">;</span>&nbsp;<span class="ident" id="7415323">g</span>&nbsp;<span class="op" id="7415325">!=</span>&nbsp;<span class="ident" id="7415328">e</span>&nbsp;<span class="op" id="7415330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415335">t</span><span class="op" id="7415336">.</span><span class="ident" id="7415337">Errorf</span><span class="op" id="7415343">(</span><span class="string" id="7415344">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7415375">,</span>&nbsp;<span class="ident" id="7415377">i</span><span class="op" id="7415378">,</span>&nbsp;<span class="ident" id="7415380">g</span><span class="op" id="7415381">,</span>&nbsp;<span class="ident" id="7415383">e</span><span class="op" id="7415384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415392">res</span><span class="op" id="7415395">.</span><span class="ident" id="7415396">Body</span><span class="op" id="7415400">.</span><span class="ident" id="7415401">Close</span><span class="op" id="7415406">(</span><span class="op" id="7415407">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415411">frontend</span><span class="op" id="7415419">.</span><span class="ident" id="7415420">Close</span><span class="op" id="7415425">(</span><span class="op" id="7415426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415429">}</span><br>
<span class="lineno"></span><span class="op" id="7415431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7415434">func</span>&nbsp;<span class="ident" id="7415439">TestReverseProxyFlushInterval</span><span class="op" id="7415468">(</span><span class="ident" id="7415469">t</span>&nbsp;<span class="op" id="7415471">*</span><span class="ident" id="7415472">testing</span><span class="op" id="7415479">.</span><span class="ident" id="7415480">T</span><span class="op" id="7415481">)</span>&nbsp;<span class="op" id="7415483">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415486">const</span>&nbsp;<span class="ident" id="7415492">expected</span>&nbsp;<span class="op" id="7415501">=</span>&nbsp;<span class="string" id="7415503">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415509">backend</span>&nbsp;<span class="op" id="7415517">:=</span>&nbsp;<span class="ident" id="7415520">httptest</span><span class="op" id="7415528">.</span><span class="ident" id="7415529">NewServer</span><span class="op" id="7415538">(</span><span class="ident" id="7415539">http</span><span class="op" id="7415543">.</span><span class="ident" id="7415544">HandlerFunc</span><span class="op" id="7415555">(</span><span class="keyword" id="7415556">func</span><span class="op" id="7415560">(</span><span class="ident" id="7415561">w</span>&nbsp;<span class="ident" id="7415563">http</span><span class="op" id="7415567">.</span><span class="ident" id="7415568">ResponseWriter</span><span class="op" id="7415582">,</span>&nbsp;<span class="ident" id="7415584">r</span>&nbsp;<span class="op" id="7415586">*</span><span class="ident" id="7415587">http</span><span class="op" id="7415591">.</span><span class="ident" id="7415592">Request</span><span class="op" id="7415599">)</span>&nbsp;<span class="op" id="7415601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415605">w</span><span class="op" id="7415606">.</span><span class="ident" id="7415607">Write</span><span class="op" id="7415612">(</span><span class="op" id="7415613">[</span><span class="op" id="7415614">]</span><span class="builtintype" id="7415615">byte</span><span class="op" id="7415619">(</span><span class="ident" id="7415620">expected</span><span class="op" id="7415628">)</span><span class="op" id="7415629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415632">}</span><span class="op" id="7415633">)</span><span class="op" id="7415634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415637">defer</span>&nbsp;<span class="ident" id="7415643">backend</span><span class="op" id="7415650">.</span><span class="ident" id="7415651">Close</span><span class="op" id="7415656">(</span><span class="op" id="7415657">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415661">backendURL</span><span class="op" id="7415671">,</span>&nbsp;<span class="ident" id="7415673">err</span>&nbsp;<span class="op" id="7415677">:=</span>&nbsp;<span class="ident" id="7415680">url</span><span class="op" id="7415683">.</span><span class="ident" id="7415684">Parse</span><span class="op" id="7415689">(</span><span class="ident" id="7415690">backend</span><span class="op" id="7415697">.</span><span class="ident" id="7415698">URL</span><span class="op" id="7415701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415704">if</span>&nbsp;<span class="ident" id="7415707">err</span>&nbsp;<span class="op" id="7415711">!=</span>&nbsp;<span class="builtintype" id="7415714">nil</span>&nbsp;<span class="op" id="7415718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415722">t</span><span class="op" id="7415723">.</span><span class="ident" id="7415724">Fatal</span><span class="op" id="7415729">(</span><span class="ident" id="7415730">err</span><span class="op" id="7415733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415736">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415740">proxyHandler</span>&nbsp;<span class="op" id="7415753">:=</span>&nbsp;<span class="ident" id="7415756">NewSingleHostReverseProxy</span><span class="op" id="7415781">(</span><span class="ident" id="7415782">backendURL</span><span class="op" id="7415792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415795">proxyHandler</span><span class="op" id="7415807">.</span><span class="ident" id="7415808">FlushInterval</span>&nbsp;<span class="op" id="7415822">=</span>&nbsp;<span class="ident" id="7415824">time</span><span class="op" id="7415828">.</span><span class="ident" id="7415829">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415843">done</span>&nbsp;<span class="op" id="7415848">:=</span>&nbsp;<span class="builtinfunc" id="7415851">make</span><span class="op" id="7415855">(</span><span class="keyword" id="7415856">chan</span>&nbsp;<span class="builtintype" id="7415861">bool</span><span class="op" id="7415865">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415868">onExitFlushLoop</span>&nbsp;<span class="op" id="7415884">=</span>&nbsp;<span class="keyword" id="7415886">func</span><span class="op" id="7415890">(</span><span class="op" id="7415891">)</span>&nbsp;<span class="op" id="7415893">{</span>&nbsp;<span class="ident" id="7415895">done</span>&nbsp;<span class="op" id="7415900">&lt;-</span>&nbsp;<span class="builtintype" id="7415903">true</span>&nbsp;<span class="op" id="7415908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415911">defer</span>&nbsp;<span class="keyword" id="7415917">func</span><span class="op" id="7415921">(</span><span class="op" id="7415922">)</span>&nbsp;<span class="op" id="7415924">{</span>&nbsp;<span class="ident" id="7415926">onExitFlushLoop</span>&nbsp;<span class="op" id="7415942">=</span>&nbsp;<span class="builtintype" id="7415944">nil</span>&nbsp;<span class="op" id="7415948">}</span><span class="op" id="7415949">(</span><span class="op" id="7415950">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415954">frontend</span>&nbsp;<span class="op" id="7415963">:=</span>&nbsp;<span class="ident" id="7415966">httptest</span><span class="op" id="7415974">.</span><span class="ident" id="7415975">NewServer</span><span class="op" id="7415984">(</span><span class="ident" id="7415985">proxyHandler</span><span class="op" id="7415997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7416000">defer</span>&nbsp;<span class="ident" id="7416006">frontend</span><span class="op" id="7416014">.</span><span class="ident" id="7416015">Close</span><span class="op" id="7416020">(</span><span class="op" id="7416021">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7416025">req</span><span class="op" id="7416028">,</span>&nbsp;<span class="ident" id="7416030">_</span>&nbsp;<span class="op" id="7416032">:=</span>&nbsp;<span class="ident" id="7416035">http</span><span class="op" id="7416039">.</span><span class="ident" id="7416040">NewRequest</span><span class="op" id="7416050">(</span><span class="string" id="7416051">&#34;GET&#34;</span><span class="op" id="7416056">,</span>&nbsp;<span class="ident" id="7416058">frontend</span><span class="op" id="7416066">.</span><span class="ident" id="7416067">URL</span><span class="op" id="7416070">,</span>&nbsp;<span class="builtintype" id="7416072">nil</span><span class="op" id="7416075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7416078">req</span><span class="op" id="7416081">.</span><span class="ident" id="7416082">Close</span>&nbsp;<span class="op" id="7416088">=</span>&nbsp;<span class="builtintype" id="7416090">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7416096">res</span><span class="op" id="7416099">,</span>&nbsp;<span class="ident" id="7416101">err</span>&nbsp;<span class="op" id="7416105">:=</span>&nbsp;<span class="ident" id="7416108">http</span><span class="op" id="7416112">.</span><span class="ident" id="7416113">DefaultClient</span><span class="op" id="7416126">.</span><span class="ident" id="7416127">Do</span><span class="op" id="7416129">(</span><span class="ident" id="7416130">req</span><span class="op" id="7416133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7416136">if</span>&nbsp;<span class="ident" id="7416139">err</span>&nbsp;<span class="op" id="7416143">!=</span>&nbsp;<span class="builtintype" id="7416146">nil</span>&nbsp;<span class="op" id="7416150">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7416154">t</span><span class="op" id="7416155">.</span><span class="ident" id="7416156">Fatalf</span><span class="op" id="7416162">(</span><span class="string" id="7416163">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7416172">,</span>&nbsp;<span class="ident" id="7416174">err</span><span class="op" id="7416177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7416180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7416183">defer</span>&nbsp;<span class="ident" id="7416189">res</span><span class="op" id="7416192">.</span><span class="ident" id="7416193">Body</span><span class="op" id="7416197">.</span><span class="ident" id="7416198">Close</span><span class="op" id="7416203">(</span><span class="op" id="7416204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7416207">if</span>&nbsp;<span class="ident" id="7416210">bodyBytes</span><span class="op" id="7416219">,</span>&nbsp;<span class="ident" id="7416221">_</span>&nbsp;<span class="op" id="7416223">:=</span>&nbsp;<span class="ident" id="7416226">ioutil</span><span class="op" id="7416232">.</span><span class="ident" id="7416233">ReadAll</span><span class="op" id="7416240">(</span><span class="ident" id="7416241">res</span><span class="op" id="7416244">.</span><span class="ident" id="7416245">Body</span><span class="op" id="7416249">)</span><span class="op" id="7416250">;</span>&nbsp;<span class="builtintype" id="7416252">string</span><span class="op" id="7416258">(</span><span class="ident" id="7416259">bodyBytes</span><span class="op" id="7416268">)</span>&nbsp;<span class="op" id="7416270">!=</span>&nbsp;<span class="ident" id="7416273">expected</span>&nbsp;<span class="op" id="7416282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7416286">t</span><span class="op" id="7416287">.</span><span class="ident" id="7416288">Errorf</span><span class="op" id="7416294">(</span><span class="string" id="7416295">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7416321">,</span>&nbsp;<span class="ident" id="7416323">bodyBytes</span><span class="op" id="7416332">,</span>&nbsp;<span class="ident" id="7416334">expected</span><span class="op" id="7416342">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7416345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7416349">select</span>&nbsp;<span class="op" id="7416356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7416359">case</span>&nbsp;<span class="op" id="7416364">&lt;-</span><span class="ident" id="7416366">done</span><span class="op" id="7416370">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7416374">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7416381">case</span>&nbsp;<span class="op" id="7416386">&lt;-</span><span class="ident" id="7416388">time</span><span class="op" id="7416392">.</span><span class="ident" id="7416393">After</span><span class="op" id="7416398">(</span><span class="num" id="7416399">5</span>&nbsp;<span class="op" id="7416401">*</span>&nbsp;<span class="ident" id="7416403">time</span><span class="op" id="7416407">.</span><span class="ident" id="7416408">Second</span><span class="op" id="7416414">)</span><span class="op" id="7416415">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7416419">t</span><span class="op" id="7416420">.</span><span class="ident" id="7416421">Error</span><span class="op" id="7416426">(</span><span class="string" id="7416427">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="7416470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7416473">}</span><br>
<span class="lineno"></span><span class="op" id="7416475">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
