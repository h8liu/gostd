<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1657864">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1657919">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1657973">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1658024">package</span>&nbsp;<span class="ident" id="1658032">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1658041">import</span>&nbsp;<span class="string" id="1658048">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1658058">func</span>&nbsp;<span class="ident" id="1658063">newsysmon</span><span class="op" id="1658072">(</span><span class="op" id="1658073">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1658076">func</span>&nbsp;<span class="ident" id="1658081">runtime_init</span><span class="op" id="1658093">(</span><span class="op" id="1658094">)</span><br>
<span class="lineno"></span><span class="keyword" id="1658096">func</span>&nbsp;<span class="ident" id="1658101">main_init</span><span class="op" id="1658110">(</span><span class="op" id="1658111">)</span><br>
<span class="lineno"></span><span class="keyword" id="1658113">func</span>&nbsp;<span class="ident" id="1658118">main_main</span><span class="op" id="1658127">(</span><span class="op" id="1658128">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="1658131">//&nbsp;The&nbsp;main&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1658154">func</span>&nbsp;<span class="ident" id="1658159">main</span><span class="op" id="1658163">(</span><span class="op" id="1658164">)</span>&nbsp;<span class="op" id="1658166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658169">g</span>&nbsp;<span class="op" id="1658171">:=</span>&nbsp;<span class="ident" id="1658174">getg</span><span class="op" id="1658178">(</span><span class="op" id="1658179">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1658183">//&nbsp;Racectx&nbsp;of&nbsp;m0-&gt;g0&nbsp;is&nbsp;used&nbsp;only&nbsp;as&nbsp;the&nbsp;parent&nbsp;of&nbsp;the&nbsp;main&nbsp;goroutine.</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1658255">//&nbsp;It&nbsp;must&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;anything&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658298">g</span><span class="op" id="1658299">.</span><span class="ident" id="1658300">m</span><span class="op" id="1658301">.</span><span class="ident" id="1658302">g0</span><span class="op" id="1658304">.</span><span class="ident" id="1658305">racectx</span>&nbsp;<span class="op" id="1658313">=</span>&nbsp;<span class="num" id="1658315">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1658319">//&nbsp;Max&nbsp;stack&nbsp;size&nbsp;is&nbsp;1&nbsp;GB&nbsp;on&nbsp;64-bit,&nbsp;250&nbsp;MB&nbsp;on&nbsp;32-bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1658375">//&nbsp;Using&nbsp;decimal&nbsp;instead&nbsp;of&nbsp;binary&nbsp;GB&nbsp;and&nbsp;MB&nbsp;because</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1658429">//&nbsp;they&nbsp;look&nbsp;nicer&nbsp;in&nbsp;the&nbsp;stack&nbsp;overflow&nbsp;failure&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1658488">if</span>&nbsp;<span class="ident" id="1658491">ptrSize</span>&nbsp;<span class="op" id="1658499">==</span>&nbsp;<span class="num" id="1658502">8</span>&nbsp;<span class="op" id="1658504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658508">maxstacksize</span>&nbsp;<span class="op" id="1658521">=</span>&nbsp;<span class="num" id="1658523">1000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1658535">}</span>&nbsp;<span class="keyword" id="1658537">else</span>&nbsp;<span class="op" id="1658542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658546">maxstacksize</span>&nbsp;<span class="op" id="1658559">=</span>&nbsp;<span class="num" id="1658561">250000000</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1658572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658576">onM</span><span class="op" id="1658579">(</span><span class="ident" id="1658580">newsysmon</span><span class="op" id="1658589">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1658593">//&nbsp;Lock&nbsp;the&nbsp;main&nbsp;goroutine&nbsp;onto&nbsp;this,&nbsp;the&nbsp;main&nbsp;OS&nbsp;thread,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1658652">//&nbsp;during&nbsp;initialization.&nbsp;&nbsp;Most&nbsp;programs&nbsp;won&#39;t&nbsp;care,&nbsp;but&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1658716">//&nbsp;do&nbsp;require&nbsp;certain&nbsp;calls&nbsp;to&nbsp;be&nbsp;made&nbsp;by&nbsp;the&nbsp;main&nbsp;thread.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1658776">//&nbsp;Those&nbsp;can&nbsp;arrange&nbsp;for&nbsp;main.main&nbsp;to&nbsp;run&nbsp;in&nbsp;the&nbsp;main&nbsp;thread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1658838">//&nbsp;by&nbsp;calling&nbsp;runtime.LockOSThread&nbsp;during&nbsp;initialization</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1658896">//&nbsp;to&nbsp;preserve&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658922">lockOSThread</span><span class="op" id="1658934">(</span><span class="op" id="1658935">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1658939">if</span>&nbsp;<span class="ident" id="1658942">g</span><span class="op" id="1658943">.</span><span class="ident" id="1658944">m</span>&nbsp;<span class="op" id="1658946">!=</span>&nbsp;<span class="op" id="1658949">&amp;</span><span class="ident" id="1658950">m0</span>&nbsp;<span class="op" id="1658953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658957">gothrow</span><span class="op" id="1658964">(</span><span class="string" id="1658965">&#34;runtime.main&nbsp;not&nbsp;on&nbsp;m0&#34;</span><span class="op" id="1658989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1658992">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658996">runtime_init</span><span class="op" id="1659008">(</span><span class="op" id="1659009">)</span>&nbsp;<span class="comment" id="1659011">//&nbsp;must&nbsp;be&nbsp;before&nbsp;defer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659037">//&nbsp;Defer&nbsp;unlock&nbsp;so&nbsp;that&nbsp;runtime.Goexit&nbsp;during&nbsp;init&nbsp;does&nbsp;the&nbsp;unlock&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659110">needUnlock</span>&nbsp;<span class="op" id="1659121">:=</span>&nbsp;<span class="ident" id="1659124">true</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659130">defer</span>&nbsp;<span class="keyword" id="1659136">func</span><span class="op" id="1659140">(</span><span class="op" id="1659141">)</span>&nbsp;<span class="op" id="1659143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659147">if</span>&nbsp;<span class="ident" id="1659150">needUnlock</span>&nbsp;<span class="op" id="1659161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659166">unlockOSThread</span><span class="op" id="1659180">(</span><span class="op" id="1659181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659188">}</span><span class="op" id="1659189">(</span><span class="op" id="1659190">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659194">memstats</span><span class="op" id="1659202">.</span><span class="ident" id="1659203">enablegc</span>&nbsp;<span class="op" id="1659212">=</span>&nbsp;<span class="ident" id="1659214">true</span>&nbsp;<span class="comment" id="1659219">//&nbsp;now&nbsp;that&nbsp;runtime&nbsp;is&nbsp;initialized,&nbsp;GC&nbsp;is&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659268">main_init</span><span class="op" id="1659277">(</span><span class="op" id="1659278">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659282">needUnlock</span>&nbsp;<span class="op" id="1659293">=</span>&nbsp;<span class="ident" id="1659295">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659302">unlockOSThread</span><span class="op" id="1659316">(</span><span class="op" id="1659317">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659321">main_main</span><span class="op" id="1659330">(</span><span class="op" id="1659331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659334">if</span>&nbsp;<span class="ident" id="1659337">raceenabled</span>&nbsp;<span class="op" id="1659349">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659353">racefini</span><span class="op" id="1659361">(</span><span class="op" id="1659362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659369">//&nbsp;Make&nbsp;racy&nbsp;client&nbsp;program&nbsp;work:&nbsp;if&nbsp;panicking&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659420">//&nbsp;another&nbsp;goroutine&nbsp;at&nbsp;the&nbsp;same&nbsp;time&nbsp;as&nbsp;main&nbsp;returns,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659476">//&nbsp;let&nbsp;the&nbsp;other&nbsp;goroutine&nbsp;finish&nbsp;printing&nbsp;the&nbsp;panic&nbsp;trace.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659537">//&nbsp;Once&nbsp;it&nbsp;does,&nbsp;it&nbsp;will&nbsp;exit.&nbsp;See&nbsp;issue&nbsp;3934.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659585">if</span>&nbsp;<span class="ident" id="1659588">panicking</span>&nbsp;<span class="op" id="1659598">!=</span>&nbsp;<span class="num" id="1659601">0</span>&nbsp;<span class="op" id="1659603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659607">gopark</span><span class="op" id="1659613">(</span><span class="ident" id="1659614">nil</span><span class="op" id="1659617">,</span>&nbsp;<span class="ident" id="1659619">nil</span><span class="op" id="1659622">,</span>&nbsp;<span class="string" id="1659624">&#34;panicwait&#34;</span><span class="op" id="1659635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659638">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659642">exit</span><span class="op" id="1659646">(</span><span class="num" id="1659647">0</span><span class="op" id="1659648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659651">for</span>&nbsp;<span class="op" id="1659655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659659">var</span>&nbsp;<span class="ident" id="1659663">x</span>&nbsp;<span class="op" id="1659665">*</span><span class="builtintype" id="1659666">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659674">*</span><span class="ident" id="1659675">x</span>&nbsp;<span class="op" id="1659677">=</span>&nbsp;<span class="num" id="1659679">0</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659682">}</span><br>
<span class="lineno"></span><span class="op" id="1659684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1659687">var</span>&nbsp;<span class="ident" id="1659691">parkunlock_c</span>&nbsp;<span class="builtintype" id="1659704">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1659710">//&nbsp;start&nbsp;forcegc&nbsp;helper&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="keyword" id="1659744">func</span>&nbsp;<span class="ident" id="1659749">init</span><span class="op" id="1659753">(</span><span class="op" id="1659754">)</span>&nbsp;<span class="op" id="1659756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659759">go</span>&nbsp;<span class="ident" id="1659762">forcegchelper</span><span class="op" id="1659775">(</span><span class="op" id="1659776">)</span><br>
<span class="lineno"></span><span class="op" id="1659778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1659781">func</span>&nbsp;<span class="ident" id="1659786">forcegchelper</span><span class="op" id="1659799">(</span><span class="op" id="1659800">)</span>&nbsp;<span class="op" id="1659802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659805">forcegc</span><span class="op" id="1659812">.</span><span class="ident" id="1659813">g</span>&nbsp;<span class="op" id="1659815">=</span>&nbsp;<span class="ident" id="1659817">getg</span><span class="op" id="1659821">(</span><span class="op" id="1659822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659825">forcegc</span><span class="op" id="1659832">.</span><span class="ident" id="1659833">g</span><span class="op" id="1659834">.</span><span class="ident" id="1659835">issystem</span>&nbsp;<span class="op" id="1659844">=</span>&nbsp;<span class="ident" id="1659846">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659852">for</span>&nbsp;<span class="op" id="1659856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659860">lock</span><span class="op" id="1659864">(</span><span class="op" id="1659865">&amp;</span><span class="ident" id="1659866">forcegc</span><span class="op" id="1659873">.</span><span class="ident" id="1659874">lock</span><span class="op" id="1659878">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659882">if</span>&nbsp;<span class="ident" id="1659885">forcegc</span><span class="op" id="1659892">.</span><span class="ident" id="1659893">idle</span>&nbsp;<span class="op" id="1659898">!=</span>&nbsp;<span class="num" id="1659901">0</span>&nbsp;<span class="op" id="1659903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659908">gothrow</span><span class="op" id="1659915">(</span><span class="string" id="1659916">&#34;forcegc:&nbsp;phase&nbsp;error&#34;</span><span class="op" id="1659938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659946">atomicstore</span><span class="op" id="1659957">(</span><span class="op" id="1659958">&amp;</span><span class="ident" id="1659959">forcegc</span><span class="op" id="1659966">.</span><span class="ident" id="1659967">idle</span><span class="op" id="1659971">,</span>&nbsp;<span class="num" id="1659973">1</span><span class="op" id="1659974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659978">goparkunlock</span><span class="op" id="1659990">(</span><span class="op" id="1659991">&amp;</span><span class="ident" id="1659992">forcegc</span><span class="op" id="1659999">.</span><span class="ident" id="1660000">lock</span><span class="op" id="1660004">,</span>&nbsp;<span class="string" id="1660006">&#34;force&nbsp;gc&nbsp;(idle)&#34;</span><span class="op" id="1660023">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1660027">//&nbsp;this&nbsp;goroutine&nbsp;is&nbsp;explicitly&nbsp;resumed&nbsp;by&nbsp;sysmon</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660079">if</span>&nbsp;<span class="ident" id="1660082">debug</span><span class="op" id="1660087">.</span><span class="ident" id="1660088">gctrace</span>&nbsp;<span class="op" id="1660096">&gt;</span>&nbsp;<span class="num" id="1660098">0</span>&nbsp;<span class="op" id="1660100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1660105">println</span><span class="op" id="1660112">(</span><span class="string" id="1660113">&#34;GC&nbsp;forced&#34;</span><span class="op" id="1660124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1660128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660132">gogc</span><span class="op" id="1660136">(</span><span class="num" id="1660137">1</span><span class="op" id="1660138">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1660141">}</span><br>
<span class="lineno"></span><span class="op" id="1660143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1660146">//go:nosplit</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="1660160">//&nbsp;Gosched&nbsp;yields&nbsp;the&nbsp;processor,&nbsp;allowing&nbsp;other&nbsp;goroutines&nbsp;to&nbsp;run.&nbsp;&nbsp;It&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1660240">//&nbsp;suspend&nbsp;the&nbsp;current&nbsp;goroutine,&nbsp;so&nbsp;execution&nbsp;resumes&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="1660310">func</span>&nbsp;<span class="ident" id="1660315">Gosched</span><span class="op" id="1660322">(</span><span class="op" id="1660323">)</span>&nbsp;<span class="op" id="1660325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660328">mcall</span><span class="op" id="1660333">(</span><span class="ident" id="1660334">gosched_m</span><span class="op" id="1660343">)</span><br>
<span class="lineno"></span><span class="op" id="1660345">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="1660348">//&nbsp;Puts&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;into&nbsp;a&nbsp;waiting&nbsp;state&nbsp;and&nbsp;calls&nbsp;unlockf.</span><br>
<span class="lineno"></span><span class="comment" id="1660418">//&nbsp;If&nbsp;unlockf&nbsp;returns&nbsp;false,&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;resumed.</span><br>
<span class="lineno"></span><span class="keyword" id="1660473">func</span>&nbsp;<span class="ident" id="1660478">gopark</span><span class="op" id="1660484">(</span><span class="ident" id="1660485">unlockf</span>&nbsp;<span class="ident" id="1660493">unsafe</span><span class="op" id="1660499">.</span><span class="ident" id="1660500">Pointer</span><span class="op" id="1660507">,</span>&nbsp;<span class="ident" id="1660509">lock</span>&nbsp;<span class="ident" id="1660514">unsafe</span><span class="op" id="1660520">.</span><span class="ident" id="1660521">Pointer</span><span class="op" id="1660528">,</span>&nbsp;<span class="ident" id="1660530">reason</span>&nbsp;<span class="builtintype" id="1660537">string</span><span class="op" id="1660543">)</span>&nbsp;<span class="op" id="1660545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660548">mp</span>&nbsp;<span class="op" id="1660551">:=</span>&nbsp;<span class="ident" id="1660554">acquirem</span><span class="op" id="1660562">(</span><span class="op" id="1660563">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660566">gp</span>&nbsp;<span class="op" id="1660569">:=</span>&nbsp;<span class="ident" id="1660572">mp</span><span class="op" id="1660574">.</span><span class="ident" id="1660575">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660581">status</span>&nbsp;<span class="op" id="1660588">:=</span>&nbsp;<span class="ident" id="1660591">readgstatus</span><span class="op" id="1660602">(</span><span class="ident" id="1660603">gp</span><span class="op" id="1660605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660608">if</span>&nbsp;<span class="ident" id="1660611">status</span>&nbsp;<span class="op" id="1660618">!=</span>&nbsp;<span class="ident" id="1660621">_Grunning</span>&nbsp;<span class="op" id="1660631">&amp;&amp;</span>&nbsp;<span class="ident" id="1660634">status</span>&nbsp;<span class="op" id="1660641">!=</span>&nbsp;<span class="ident" id="1660644">_Gscanrunning</span>&nbsp;<span class="op" id="1660658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660662">gothrow</span><span class="op" id="1660669">(</span><span class="string" id="1660670">&#34;gopark:&nbsp;bad&nbsp;g&nbsp;status&#34;</span><span class="op" id="1660692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1660695">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660698">mp</span><span class="op" id="1660700">.</span><span class="ident" id="1660701">waitlock</span>&nbsp;<span class="op" id="1660710">=</span>&nbsp;<span class="ident" id="1660712">lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660718">mp</span><span class="op" id="1660720">.</span><span class="ident" id="1660721">waitunlockf</span>&nbsp;<span class="op" id="1660733">=</span>&nbsp;<span class="ident" id="1660735">unlockf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660744">gp</span><span class="op" id="1660746">.</span><span class="ident" id="1660747">waitreason</span>&nbsp;<span class="op" id="1660758">=</span>&nbsp;<span class="ident" id="1660760">reason</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660768">releasem</span><span class="op" id="1660776">(</span><span class="ident" id="1660777">mp</span><span class="op" id="1660779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1660782">//&nbsp;can&#39;t&nbsp;do&nbsp;anything&nbsp;that&nbsp;might&nbsp;move&nbsp;the&nbsp;G&nbsp;between&nbsp;Ms&nbsp;here.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660843">mcall</span><span class="op" id="1660848">(</span><span class="ident" id="1660849">park_m</span><span class="op" id="1660855">)</span><br>
<span class="lineno"></span><span class="op" id="1660857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1660860">//&nbsp;Puts&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;into&nbsp;a&nbsp;waiting&nbsp;state&nbsp;and&nbsp;unlocks&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1660933">//&nbsp;The&nbsp;goroutine&nbsp;can&nbsp;be&nbsp;made&nbsp;runnable&nbsp;again&nbsp;by&nbsp;calling&nbsp;goready(gp).</span><br>
<span class="lineno">135</span><span class="keyword" id="1661001">func</span>&nbsp;<span class="ident" id="1661006">goparkunlock</span><span class="op" id="1661018">(</span><span class="ident" id="1661019">lock</span>&nbsp;<span class="op" id="1661024">*</span><span class="ident" id="1661025">mutex</span><span class="op" id="1661030">,</span>&nbsp;<span class="ident" id="1661032">reason</span>&nbsp;<span class="builtintype" id="1661039">string</span><span class="op" id="1661045">)</span>&nbsp;<span class="op" id="1661047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661050">gopark</span><span class="op" id="1661056">(</span><span class="ident" id="1661057">unsafe</span><span class="op" id="1661063">.</span><span class="ident" id="1661064">Pointer</span><span class="op" id="1661071">(</span><span class="op" id="1661072">&amp;</span><span class="ident" id="1661073">parkunlock_c</span><span class="op" id="1661085">)</span><span class="op" id="1661086">,</span>&nbsp;<span class="ident" id="1661088">unsafe</span><span class="op" id="1661094">.</span><span class="ident" id="1661095">Pointer</span><span class="op" id="1661102">(</span><span class="ident" id="1661103">lock</span><span class="op" id="1661107">)</span><span class="op" id="1661108">,</span>&nbsp;<span class="ident" id="1661110">reason</span><span class="op" id="1661116">)</span><br>
<span class="lineno"></span><span class="op" id="1661118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1661121">func</span>&nbsp;<span class="ident" id="1661126">goready</span><span class="op" id="1661133">(</span><span class="ident" id="1661134">gp</span>&nbsp;<span class="op" id="1661137">*</span><span class="ident" id="1661138">g</span><span class="op" id="1661139">)</span>&nbsp;<span class="op" id="1661141">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661144">mp</span>&nbsp;<span class="op" id="1661147">:=</span>&nbsp;<span class="ident" id="1661150">acquirem</span><span class="op" id="1661158">(</span><span class="op" id="1661159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661162">mp</span><span class="op" id="1661164">.</span><span class="ident" id="1661165">ptrarg</span><span class="op" id="1661171">[</span><span class="num" id="1661172">0</span><span class="op" id="1661173">]</span>&nbsp;<span class="op" id="1661175">=</span>&nbsp;<span class="ident" id="1661177">unsafe</span><span class="op" id="1661183">.</span><span class="ident" id="1661184">Pointer</span><span class="op" id="1661191">(</span><span class="ident" id="1661192">gp</span><span class="op" id="1661194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661197">onM</span><span class="op" id="1661200">(</span><span class="ident" id="1661201">ready_m</span><span class="op" id="1661208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661211">releasem</span><span class="op" id="1661219">(</span><span class="ident" id="1661220">mp</span><span class="op" id="1661222">)</span><br>
<span class="lineno"></span><span class="op" id="1661224">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1661227">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1661240">func</span>&nbsp;<span class="ident" id="1661245">acquireSudog</span><span class="op" id="1661257">(</span><span class="op" id="1661258">)</span>&nbsp;<span class="op" id="1661260">*</span><span class="ident" id="1661261">sudog</span>&nbsp;<span class="op" id="1661267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661270">c</span>&nbsp;<span class="op" id="1661272">:=</span>&nbsp;<span class="ident" id="1661275">gomcache</span><span class="op" id="1661283">(</span><span class="op" id="1661284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661287">s</span>&nbsp;<span class="op" id="1661289">:=</span>&nbsp;<span class="ident" id="1661292">c</span><span class="op" id="1661293">.</span><span class="ident" id="1661294">sudogcache</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1661306">if</span>&nbsp;<span class="ident" id="1661309">s</span>&nbsp;<span class="op" id="1661311">!=</span>&nbsp;<span class="ident" id="1661314">nil</span>&nbsp;<span class="op" id="1661318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1661322">if</span>&nbsp;<span class="ident" id="1661325">s</span><span class="op" id="1661326">.</span><span class="ident" id="1661327">elem</span>&nbsp;<span class="op" id="1661332">!=</span>&nbsp;<span class="ident" id="1661335">nil</span>&nbsp;<span class="op" id="1661339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661344">gothrow</span><span class="op" id="1661351">(</span><span class="string" id="1661352">&#34;acquireSudog:&nbsp;found&nbsp;s.elem&nbsp;!=&nbsp;nil&nbsp;in&nbsp;cache&#34;</span><span class="op" id="1661396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1661400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661404">c</span><span class="op" id="1661405">.</span><span class="ident" id="1661406">sudogcache</span>&nbsp;<span class="op" id="1661417">=</span>&nbsp;<span class="ident" id="1661419">s</span><span class="op" id="1661420">.</span><span class="ident" id="1661421">next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661428">s</span><span class="op" id="1661429">.</span><span class="ident" id="1661430">next</span>&nbsp;<span class="op" id="1661435">=</span>&nbsp;<span class="ident" id="1661437">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1661443">return</span>&nbsp;<span class="ident" id="1661450">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1661453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1661457">//&nbsp;Delicate&nbsp;dance:&nbsp;the&nbsp;semaphore&nbsp;implementation&nbsp;calls</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1661512">//&nbsp;acquireSudog,&nbsp;acquireSudog&nbsp;calls&nbsp;new(sudog),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1661561">//&nbsp;new&nbsp;calls&nbsp;malloc,&nbsp;malloc&nbsp;can&nbsp;call&nbsp;the&nbsp;garbage&nbsp;collector,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1661622">//&nbsp;and&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;calls&nbsp;the&nbsp;semaphore&nbsp;implementation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1661687">//&nbsp;in&nbsp;stoptheworld.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1661708">//&nbsp;Break&nbsp;the&nbsp;cycle&nbsp;by&nbsp;doing&nbsp;acquirem/releasem&nbsp;around&nbsp;new(sudog).</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1661774">//&nbsp;The&nbsp;acquirem/releasem&nbsp;increments&nbsp;m.locks&nbsp;during&nbsp;new(sudog),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1661838">//&nbsp;which&nbsp;keeps&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;from&nbsp;being&nbsp;invoked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661896">mp</span>&nbsp;<span class="op" id="1661899">:=</span>&nbsp;<span class="ident" id="1661902">acquirem</span><span class="op" id="1661910">(</span><span class="op" id="1661911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661914">p</span>&nbsp;<span class="op" id="1661916">:=</span>&nbsp;<span class="builtinfunc" id="1661919">new</span><span class="op" id="1661922">(</span><span class="ident" id="1661923">sudog</span><span class="op" id="1661928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661931">releasem</span><span class="op" id="1661939">(</span><span class="ident" id="1661940">mp</span><span class="op" id="1661942">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1661945">return</span>&nbsp;<span class="ident" id="1661952">p</span><br>
<span class="lineno"></span><span class="op" id="1661954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1661957">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1661970">func</span>&nbsp;<span class="ident" id="1661975">releaseSudog</span><span class="op" id="1661987">(</span><span class="ident" id="1661988">s</span>&nbsp;<span class="op" id="1661990">*</span><span class="ident" id="1661991">sudog</span><span class="op" id="1661996">)</span>&nbsp;<span class="op" id="1661998">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662001">if</span>&nbsp;<span class="ident" id="1662004">s</span><span class="op" id="1662005">.</span><span class="ident" id="1662006">elem</span>&nbsp;<span class="op" id="1662011">!=</span>&nbsp;<span class="ident" id="1662014">nil</span>&nbsp;<span class="op" id="1662018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662022">gothrow</span><span class="op" id="1662029">(</span><span class="string" id="1662030">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;elem&#34;</span><span class="op" id="1662064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662070">if</span>&nbsp;<span class="ident" id="1662073">s</span><span class="op" id="1662074">.</span><span class="ident" id="1662075">selectdone</span>&nbsp;<span class="op" id="1662086">!=</span>&nbsp;<span class="ident" id="1662089">nil</span>&nbsp;<span class="op" id="1662093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662097">gothrow</span><span class="op" id="1662104">(</span><span class="string" id="1662105">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;selectdone&#34;</span><span class="op" id="1662145">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662151">if</span>&nbsp;<span class="ident" id="1662154">s</span><span class="op" id="1662155">.</span><span class="ident" id="1662156">next</span>&nbsp;<span class="op" id="1662161">!=</span>&nbsp;<span class="ident" id="1662164">nil</span>&nbsp;<span class="op" id="1662168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662172">gothrow</span><span class="op" id="1662179">(</span><span class="string" id="1662180">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;next&#34;</span><span class="op" id="1662214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662220">if</span>&nbsp;<span class="ident" id="1662223">s</span><span class="op" id="1662224">.</span><span class="ident" id="1662225">prev</span>&nbsp;<span class="op" id="1662230">!=</span>&nbsp;<span class="ident" id="1662233">nil</span>&nbsp;<span class="op" id="1662237">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662241">gothrow</span><span class="op" id="1662248">(</span><span class="string" id="1662249">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;prev&#34;</span><span class="op" id="1662283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662289">if</span>&nbsp;<span class="ident" id="1662292">s</span><span class="op" id="1662293">.</span><span class="ident" id="1662294">waitlink</span>&nbsp;<span class="op" id="1662303">!=</span>&nbsp;<span class="ident" id="1662306">nil</span>&nbsp;<span class="op" id="1662310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662314">gothrow</span><span class="op" id="1662321">(</span><span class="string" id="1662322">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;waitlink&#34;</span><span class="op" id="1662360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662363">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662366">gp</span>&nbsp;<span class="op" id="1662369">:=</span>&nbsp;<span class="ident" id="1662372">getg</span><span class="op" id="1662376">(</span><span class="op" id="1662377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662380">if</span>&nbsp;<span class="ident" id="1662383">gp</span><span class="op" id="1662385">.</span><span class="ident" id="1662386">param</span>&nbsp;<span class="op" id="1662392">!=</span>&nbsp;<span class="ident" id="1662395">nil</span>&nbsp;<span class="op" id="1662399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662403">gothrow</span><span class="op" id="1662410">(</span><span class="string" id="1662411">&#34;runtime:&nbsp;releaseSudog&nbsp;with&nbsp;non-nil&nbsp;gp.param&#34;</span><span class="op" id="1662456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662462">c</span>&nbsp;<span class="op" id="1662464">:=</span>&nbsp;<span class="ident" id="1662467">gomcache</span><span class="op" id="1662475">(</span><span class="op" id="1662476">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662479">s</span><span class="op" id="1662480">.</span><span class="ident" id="1662481">next</span>&nbsp;<span class="op" id="1662486">=</span>&nbsp;<span class="ident" id="1662488">c</span><span class="op" id="1662489">.</span><span class="ident" id="1662490">sudogcache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662502">c</span><span class="op" id="1662503">.</span><span class="ident" id="1662504">sudogcache</span>&nbsp;<span class="op" id="1662515">=</span>&nbsp;<span class="ident" id="1662517">s</span><br>
<span class="lineno"></span><span class="op" id="1662519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1662522">//&nbsp;funcPC&nbsp;returns&nbsp;the&nbsp;entry&nbsp;PC&nbsp;of&nbsp;the&nbsp;function&nbsp;f.</span><br>
<span class="lineno">200</span><span class="comment" id="1662572">//&nbsp;It&nbsp;assumes&nbsp;that&nbsp;f&nbsp;is&nbsp;a&nbsp;func&nbsp;value.&nbsp;Otherwise&nbsp;the&nbsp;behavior&nbsp;is&nbsp;undefined.</span><br>
<span class="lineno"></span><span class="comment" id="1662647">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1662660">func</span>&nbsp;<span class="ident" id="1662665">funcPC</span><span class="op" id="1662671">(</span><span class="ident" id="1662672">f</span>&nbsp;<span class="keyword" id="1662674">interface</span><span class="op" id="1662683">{</span><span class="op" id="1662684">}</span><span class="op" id="1662685">)</span>&nbsp;<span class="builtintype" id="1662687">uintptr</span>&nbsp;<span class="op" id="1662695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662698">return</span>&nbsp;<span class="op" id="1662705">*</span><span class="op" id="1662706">*</span><span class="op" id="1662707">(</span><span class="op" id="1662708">*</span><span class="op" id="1662709">*</span><span class="builtintype" id="1662710">uintptr</span><span class="op" id="1662717">)</span><span class="op" id="1662718">(</span><span class="ident" id="1662719">add</span><span class="op" id="1662722">(</span><span class="ident" id="1662723">unsafe</span><span class="op" id="1662729">.</span><span class="ident" id="1662730">Pointer</span><span class="op" id="1662737">(</span><span class="op" id="1662738">&amp;</span><span class="ident" id="1662739">f</span><span class="op" id="1662740">)</span><span class="op" id="1662741">,</span>&nbsp;<span class="ident" id="1662743">ptrSize</span><span class="op" id="1662750">)</span><span class="op" id="1662751">)</span><br>
<span class="lineno"></span><span class="op" id="1662753">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="1662756">//&nbsp;called&nbsp;from&nbsp;assembly</span><br>
<span class="lineno"></span><span class="keyword" id="1662780">func</span>&nbsp;<span class="ident" id="1662785">badmcall</span><span class="op" id="1662793">(</span><span class="ident" id="1662794">fn</span>&nbsp;<span class="keyword" id="1662797">func</span><span class="op" id="1662801">(</span><span class="op" id="1662802">*</span><span class="ident" id="1662803">g</span><span class="op" id="1662804">)</span><span class="op" id="1662805">)</span>&nbsp;<span class="op" id="1662807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662810">gothrow</span><span class="op" id="1662817">(</span><span class="string" id="1662818">&#34;runtime:&nbsp;mcall&nbsp;called&nbsp;on&nbsp;m-&gt;g0&nbsp;stack&#34;</span><span class="op" id="1662856">)</span><br>
<span class="lineno"></span><span class="op" id="1662858">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="1662861">func</span>&nbsp;<span class="ident" id="1662866">badmcall2</span><span class="op" id="1662875">(</span><span class="ident" id="1662876">fn</span>&nbsp;<span class="keyword" id="1662879">func</span><span class="op" id="1662883">(</span><span class="op" id="1662884">*</span><span class="ident" id="1662885">g</span><span class="op" id="1662886">)</span><span class="op" id="1662887">)</span>&nbsp;<span class="op" id="1662889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662892">gothrow</span><span class="op" id="1662899">(</span><span class="string" id="1662900">&#34;runtime:&nbsp;mcall&nbsp;function&nbsp;returned&#34;</span><span class="op" id="1662934">)</span><br>
<span class="lineno"></span><span class="op" id="1662936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="1662939">func</span>&nbsp;<span class="ident" id="1662944">badreflectcall</span><span class="op" id="1662958">(</span><span class="op" id="1662959">)</span>&nbsp;<span class="op" id="1662961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1662964">panic</span><span class="op" id="1662969">(</span><span class="string" id="1662970">&#34;runtime:&nbsp;arg&nbsp;size&nbsp;to&nbsp;reflect.call&nbsp;more&nbsp;than&nbsp;1GB&#34;</span><span class="op" id="1663019">)</span><br>
<span class="lineno"></span><span class="op" id="1663021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1663024">func</span>&nbsp;<span class="ident" id="1663029">lockedOSThread</span><span class="op" id="1663043">(</span><span class="op" id="1663044">)</span>&nbsp;<span class="builtintype" id="1663046">bool</span>&nbsp;<span class="op" id="1663051">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663054">gp</span>&nbsp;<span class="op" id="1663057">:=</span>&nbsp;<span class="ident" id="1663060">getg</span><span class="op" id="1663064">(</span><span class="op" id="1663065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1663068">return</span>&nbsp;<span class="ident" id="1663075">gp</span><span class="op" id="1663077">.</span><span class="ident" id="1663078">lockedm</span>&nbsp;<span class="op" id="1663086">!=</span>&nbsp;<span class="ident" id="1663089">nil</span>&nbsp;<span class="op" id="1663093">&amp;&amp;</span>&nbsp;<span class="ident" id="1663096">gp</span><span class="op" id="1663098">.</span><span class="ident" id="1663099">m</span><span class="op" id="1663100">.</span><span class="ident" id="1663101">lockedg</span>&nbsp;<span class="op" id="1663109">!=</span>&nbsp;<span class="ident" id="1663112">nil</span><br>
<span class="lineno"></span><span class="op" id="1663116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1663119">func</span>&nbsp;<span class="ident" id="1663124">newP</span><span class="op" id="1663128">(</span><span class="op" id="1663129">)</span>&nbsp;<span class="op" id="1663131">*</span><span class="ident" id="1663132">p</span>&nbsp;<span class="op" id="1663134">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1663137">return</span>&nbsp;<span class="builtinfunc" id="1663144">new</span><span class="op" id="1663147">(</span><span class="ident" id="1663148">p</span><span class="op" id="1663149">)</span><br>
<span class="lineno"></span><span class="op" id="1663151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1663154">func</span>&nbsp;<span class="ident" id="1663159">newM</span><span class="op" id="1663163">(</span><span class="op" id="1663164">)</span>&nbsp;<span class="op" id="1663166">*</span><span class="ident" id="1663167">m</span>&nbsp;<span class="op" id="1663169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1663172">return</span>&nbsp;<span class="builtinfunc" id="1663179">new</span><span class="op" id="1663182">(</span><span class="ident" id="1663183">m</span><span class="op" id="1663184">)</span><br>
<span class="lineno">230</span><span class="op" id="1663186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1663189">func</span>&nbsp;<span class="ident" id="1663194">newG</span><span class="op" id="1663198">(</span><span class="op" id="1663199">)</span>&nbsp;<span class="op" id="1663201">*</span><span class="ident" id="1663202">g</span>&nbsp;<span class="op" id="1663204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1663207">return</span>&nbsp;<span class="builtinfunc" id="1663214">new</span><span class="op" id="1663217">(</span><span class="ident" id="1663218">g</span><span class="op" id="1663219">)</span><br>
<span class="lineno"></span><span class="op" id="1663221">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="keyword" id="1663224">func</span>&nbsp;<span class="ident" id="1663229">allgadd</span><span class="op" id="1663236">(</span><span class="ident" id="1663237">gp</span>&nbsp;<span class="op" id="1663240">*</span><span class="ident" id="1663241">g</span><span class="op" id="1663242">)</span>&nbsp;<span class="op" id="1663244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1663247">if</span>&nbsp;<span class="ident" id="1663250">readgstatus</span><span class="op" id="1663261">(</span><span class="ident" id="1663262">gp</span><span class="op" id="1663264">)</span>&nbsp;<span class="op" id="1663266">==</span>&nbsp;<span class="ident" id="1663269">_Gidle</span>&nbsp;<span class="op" id="1663276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663280">gothrow</span><span class="op" id="1663287">(</span><span class="string" id="1663288">&#34;allgadd:&nbsp;bad&nbsp;status&nbsp;Gidle&#34;</span><span class="op" id="1663315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1663318">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663322">lock</span><span class="op" id="1663326">(</span><span class="op" id="1663327">&amp;</span><span class="ident" id="1663328">allglock</span><span class="op" id="1663336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663339">allgs</span>&nbsp;<span class="op" id="1663345">=</span>&nbsp;<span class="builtinfunc" id="1663347">append</span><span class="op" id="1663353">(</span><span class="ident" id="1663354">allgs</span><span class="op" id="1663359">,</span>&nbsp;<span class="ident" id="1663361">gp</span><span class="op" id="1663363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663366">allg</span>&nbsp;<span class="op" id="1663371">=</span>&nbsp;<span class="op" id="1663373">&amp;</span><span class="ident" id="1663374">allgs</span><span class="op" id="1663379">[</span><span class="num" id="1663380">0</span><span class="op" id="1663381">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663384">allglen</span>&nbsp;<span class="op" id="1663392">=</span>&nbsp;<span class="builtintype" id="1663394">uintptr</span><span class="op" id="1663401">(</span><span class="builtinfunc" id="1663402">len</span><span class="op" id="1663405">(</span><span class="ident" id="1663406">allgs</span><span class="op" id="1663411">)</span><span class="op" id="1663412">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663415">unlock</span><span class="op" id="1663421">(</span><span class="op" id="1663422">&amp;</span><span class="ident" id="1663423">allglock</span><span class="op" id="1663431">)</span><br>
<span class="lineno"></span><span class="op" id="1663433">}</span>
</div>
</body>
</html>
