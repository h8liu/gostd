<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html" class="current">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1446357">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1446412">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1446466">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1446517">package</span>&nbsp;<span class="ident" id="1446525">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1446534">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&#39;s&nbsp;map&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1446593">//</span><br>
<span class="lineno"></span><span class="comment" id="1446596">//&nbsp;A&nbsp;map&nbsp;is&nbsp;just&nbsp;a&nbsp;hash&nbsp;table.&nbsp;&nbsp;The&nbsp;data&nbsp;is&nbsp;arranged</span><br>
<span class="lineno">10</span><span class="comment" id="1446649">//&nbsp;into&nbsp;an&nbsp;array&nbsp;of&nbsp;buckets.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;up&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1446706">//&nbsp;8&nbsp;key/value&nbsp;pairs.&nbsp;&nbsp;The&nbsp;low-order&nbsp;bits&nbsp;of&nbsp;the&nbsp;hash&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1446764">//&nbsp;used&nbsp;to&nbsp;select&nbsp;a&nbsp;bucket.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span><span class="comment" id="1446820">//&nbsp;high-order&nbsp;bits&nbsp;of&nbsp;each&nbsp;hash&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;entries</span><br>
<span class="lineno"></span><span class="comment" id="1446879">//&nbsp;within&nbsp;a&nbsp;single&nbsp;bucket.</span><br>
<span class="lineno">15</span><span class="comment" id="1446906">//</span><br>
<span class="lineno"></span><span class="comment" id="1446909">//&nbsp;If&nbsp;more&nbsp;than&nbsp;8&nbsp;keys&nbsp;hash&nbsp;to&nbsp;a&nbsp;bucket,&nbsp;we&nbsp;chain&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1446962">//&nbsp;extra&nbsp;buckets.</span><br>
<span class="lineno"></span><span class="comment" id="1446980">//</span><br>
<span class="lineno"></span><span class="comment" id="1446983">//&nbsp;When&nbsp;the&nbsp;hashtable&nbsp;grows,&nbsp;we&nbsp;allocate&nbsp;a&nbsp;new&nbsp;array</span><br>
<span class="lineno">20</span><span class="comment" id="1447036">//&nbsp;of&nbsp;buckets&nbsp;twice&nbsp;as&nbsp;big.&nbsp;&nbsp;Buckets&nbsp;are&nbsp;incrementally</span><br>
<span class="lineno"></span><span class="comment" id="1447091">//&nbsp;copied&nbsp;from&nbsp;the&nbsp;old&nbsp;bucket&nbsp;array&nbsp;to&nbsp;the&nbsp;new&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span><span class="comment" id="1447152">//</span><br>
<span class="lineno"></span><span class="comment" id="1447155">//&nbsp;Map&nbsp;iterators&nbsp;walk&nbsp;through&nbsp;the&nbsp;array&nbsp;of&nbsp;buckets&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1447210">//&nbsp;return&nbsp;the&nbsp;keys&nbsp;in&nbsp;walk&nbsp;order&nbsp;(bucket&nbsp;#,&nbsp;then&nbsp;overflow</span><br>
<span class="lineno">25</span><span class="comment" id="1447268">//&nbsp;chain&nbsp;order,&nbsp;then&nbsp;bucket&nbsp;index).&nbsp;&nbsp;To&nbsp;maintain&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="1447327">//&nbsp;semantics,&nbsp;we&nbsp;never&nbsp;move&nbsp;keys&nbsp;within&nbsp;their&nbsp;bucket&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="1447384">//&nbsp;we&nbsp;did,&nbsp;keys&nbsp;might&nbsp;be&nbsp;returned&nbsp;0&nbsp;or&nbsp;2&nbsp;times).&nbsp;&nbsp;When</span><br>
<span class="lineno"></span><span class="comment" id="1447439">//&nbsp;growing&nbsp;the&nbsp;table,&nbsp;iterators&nbsp;remain&nbsp;iterating&nbsp;through&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1447500">//&nbsp;old&nbsp;table&nbsp;and&nbsp;must&nbsp;check&nbsp;the&nbsp;new&nbsp;table&nbsp;if&nbsp;the&nbsp;bucket</span><br>
<span class="lineno">30</span><span class="comment" id="1447556">//&nbsp;they&nbsp;are&nbsp;iterating&nbsp;through&nbsp;has&nbsp;been&nbsp;moved&nbsp;(&#34;evacuated&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1447615">//&nbsp;to&nbsp;the&nbsp;new&nbsp;table.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1447637">//&nbsp;Picking&nbsp;loadFactor:&nbsp;too&nbsp;large&nbsp;and&nbsp;we&nbsp;have&nbsp;lots&nbsp;of&nbsp;overflow</span><br>
<span class="lineno"></span><span class="comment" id="1447699">//&nbsp;buckets,&nbsp;too&nbsp;small&nbsp;and&nbsp;we&nbsp;waste&nbsp;a&nbsp;lot&nbsp;of&nbsp;space.&nbsp;&nbsp;I&nbsp;wrote</span><br>
<span class="lineno">35</span><span class="comment" id="1447759">//&nbsp;a&nbsp;simple&nbsp;program&nbsp;to&nbsp;check&nbsp;some&nbsp;stats&nbsp;for&nbsp;different&nbsp;loads:</span><br>
<span class="lineno"></span><span class="comment" id="1447820">//&nbsp;(64-bit,&nbsp;8&nbsp;byte&nbsp;keys&nbsp;and&nbsp;values)</span><br>
<span class="lineno"></span><span class="comment" id="1447856">//&nbsp;&nbsp;loadFactor&nbsp;&nbsp;&nbsp;&nbsp;%overflow&nbsp;&nbsp;bytes/entry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;missprobe</span><br>
<span class="lineno"></span><span class="comment" id="1447923">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00</span><br>
<span class="lineno"></span><span class="comment" id="1447990">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17.30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50</span><br>
<span class="lineno">40</span><span class="comment" id="1448057">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;14.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00</span><br>
<span class="lineno"></span><span class="comment" id="1448124">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12.94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50</span><br>
<span class="lineno"></span><span class="comment" id="1448191">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15.27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11.67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00</span><br>
<span class="lineno"></span><span class="comment" id="1448258">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50</span><br>
<span class="lineno"></span><span class="comment" id="1448325">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;27.14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00</span><br>
<span class="lineno">45</span><span class="comment" id="1448392">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;34.03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50</span><br>
<span class="lineno"></span><span class="comment" id="1448459">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;41.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00</span><br>
<span class="lineno"></span><span class="comment" id="1448526">//</span><br>
<span class="lineno"></span><span class="comment" id="1448529">//&nbsp;%overflow&nbsp;&nbsp;&nbsp;=&nbsp;percentage&nbsp;of&nbsp;buckets&nbsp;which&nbsp;have&nbsp;an&nbsp;overflow&nbsp;bucket</span><br>
<span class="lineno"></span><span class="comment" id="1448598">//&nbsp;bytes/entry&nbsp;=&nbsp;overhead&nbsp;bytes&nbsp;used&nbsp;per&nbsp;key/value&nbsp;pair</span><br>
<span class="lineno">50</span><span class="comment" id="1448654">//&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;a&nbsp;present&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1448723">//&nbsp;missprobe&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;an&nbsp;absent&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1448792">//</span><br>
<span class="lineno"></span><span class="comment" id="1448795">//&nbsp;Keep&nbsp;in&nbsp;mind&nbsp;this&nbsp;data&nbsp;is&nbsp;for&nbsp;maximally&nbsp;loaded&nbsp;tables,&nbsp;i.e.&nbsp;just</span><br>
<span class="lineno"></span><span class="comment" id="1448863">//&nbsp;before&nbsp;the&nbsp;table&nbsp;grows.&nbsp;&nbsp;Typical&nbsp;tables&nbsp;will&nbsp;be&nbsp;somewhat&nbsp;less&nbsp;loaded.</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="1448937">import</span>&nbsp;<span class="op" id="1448944">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1448947">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1448956">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1448959">const</span>&nbsp;<span class="op" id="1448965">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1448968">//&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;key/value&nbsp;pairs&nbsp;a&nbsp;bucket&nbsp;can&nbsp;hold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449025">bucketCntBits</span>&nbsp;<span class="op" id="1449039">=</span>&nbsp;<span class="num" id="1449041">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449044">bucketCnt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449058">=</span>&nbsp;<span class="num" id="1449060">1</span>&nbsp;<span class="op" id="1449062">&lt;&lt;</span>&nbsp;<span class="ident" id="1449065">bucketCntBits</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449081">//&nbsp;Maximum&nbsp;average&nbsp;load&nbsp;of&nbsp;a&nbsp;bucket&nbsp;that&nbsp;triggers&nbsp;growth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449140">loadFactor</span>&nbsp;<span class="op" id="1449151">=</span>&nbsp;<span class="num" id="1449153">6.5</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449159">//&nbsp;Maximum&nbsp;key&nbsp;or&nbsp;value&nbsp;size&nbsp;to&nbsp;keep&nbsp;inline&nbsp;(instead&nbsp;of&nbsp;mallocing&nbsp;per&nbsp;element).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449240">//&nbsp;Must&nbsp;fit&nbsp;in&nbsp;a&nbsp;uint8.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449265">//&nbsp;Fast&nbsp;versions&nbsp;cannot&nbsp;handle&nbsp;big&nbsp;values&nbsp;-&nbsp;the&nbsp;cutoff&nbsp;size&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449330">//&nbsp;fast&nbsp;versions&nbsp;in&nbsp;../../cmd/gc/walk.c&nbsp;must&nbsp;be&nbsp;at&nbsp;most&nbsp;this&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449399">maxKeySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1449412">=</span>&nbsp;<span class="num" id="1449414">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449419">maxValueSize</span>&nbsp;<span class="op" id="1449432">=</span>&nbsp;<span class="num" id="1449434">128</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449440">//&nbsp;data&nbsp;offset&nbsp;should&nbsp;be&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;bmap&nbsp;struct,&nbsp;but&nbsp;needs&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449511">//&nbsp;aligned&nbsp;correctly.&nbsp;&nbsp;For&nbsp;amd64p32&nbsp;this&nbsp;means&nbsp;64-bit&nbsp;alignment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449576">//&nbsp;even&nbsp;though&nbsp;pointers&nbsp;are&nbsp;32&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449613">dataOffset</span>&nbsp;<span class="op" id="1449624">=</span>&nbsp;<span class="ident" id="1449626">unsafe</span><span class="op" id="1449632">.</span><span class="ident" id="1449633">Offsetof</span><span class="op" id="1449641">(</span><span class="keyword" id="1449642">struct</span>&nbsp;<span class="op" id="1449649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449653">b</span>&nbsp;<span class="ident" id="1449655">bmap</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449662">v</span>&nbsp;<span class="builtintype" id="1449664">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449671">}</span><span class="op" id="1449672">{</span><span class="op" id="1449673">}</span><span class="op" id="1449674">.</span><span class="ident" id="1449675">v</span><span class="op" id="1449676">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449680">//&nbsp;Possible&nbsp;tophash&nbsp;values.&nbsp;&nbsp;We&nbsp;reserve&nbsp;a&nbsp;few&nbsp;possibilities&nbsp;for&nbsp;special&nbsp;marks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449760">//&nbsp;Each&nbsp;bucket&nbsp;(including&nbsp;its&nbsp;overflow&nbsp;buckets,&nbsp;if&nbsp;any)&nbsp;will&nbsp;have&nbsp;either&nbsp;all&nbsp;or&nbsp;none&nbsp;of&nbsp;its</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449853">//&nbsp;entries&nbsp;in&nbsp;the&nbsp;evacuated*&nbsp;states&nbsp;(except&nbsp;during&nbsp;the&nbsp;evacuate()&nbsp;method,&nbsp;which&nbsp;only&nbsp;happens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449947">//&nbsp;during&nbsp;map&nbsp;writes&nbsp;and&nbsp;thus&nbsp;no&nbsp;one&nbsp;else&nbsp;can&nbsp;observe&nbsp;the&nbsp;map&nbsp;during&nbsp;that&nbsp;time).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450029">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1450044">=</span>&nbsp;<span class="num" id="1450046">0</span>&nbsp;<span class="comment" id="1450048">//&nbsp;cell&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450066">evacuatedEmpty</span>&nbsp;<span class="op" id="1450081">=</span>&nbsp;<span class="num" id="1450083">1</span>&nbsp;<span class="comment" id="1450085">//&nbsp;cell&nbsp;is&nbsp;empty,&nbsp;bucket&nbsp;is&nbsp;evacuated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450125">evacuatedX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1450140">=</span>&nbsp;<span class="num" id="1450142">2</span>&nbsp;<span class="comment" id="1450144">//&nbsp;key/value&nbsp;is&nbsp;valid.&nbsp;&nbsp;Entry&nbsp;has&nbsp;been&nbsp;evacuated&nbsp;to&nbsp;first&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450225">evacuatedY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1450240">=</span>&nbsp;<span class="num" id="1450242">3</span>&nbsp;<span class="comment" id="1450244">//&nbsp;same&nbsp;as&nbsp;above,&nbsp;but&nbsp;evacuated&nbsp;to&nbsp;second&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450309">minTopHash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1450324">=</span>&nbsp;<span class="num" id="1450326">4</span>&nbsp;<span class="comment" id="1450328">//&nbsp;minimum&nbsp;tophash&nbsp;for&nbsp;a&nbsp;normal&nbsp;filled&nbsp;cell.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1450375">//&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450385">iterator</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1450397">=</span>&nbsp;<span class="num" id="1450399">1</span>&nbsp;<span class="comment" id="1450401">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;buckets</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450444">oldIterator</span>&nbsp;<span class="op" id="1450456">=</span>&nbsp;<span class="num" id="1450458">2</span>&nbsp;<span class="comment" id="1450460">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;oldbuckets</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1450507">//&nbsp;sentinel&nbsp;bucket&nbsp;ID&nbsp;for&nbsp;iterator&nbsp;checks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450550">noCheck</span>&nbsp;<span class="op" id="1450558">=</span>&nbsp;<span class="num" id="1450560">1</span><span class="op" id="1450561">&lt;&lt;</span><span class="op" id="1450563">(</span><span class="num" id="1450564">8</span><span class="op" id="1450565">*</span><span class="ident" id="1450566">ptrSize</span><span class="op" id="1450573">)</span>&nbsp;<span class="op" id="1450575">-</span>&nbsp;<span class="num" id="1450577">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1450581">//&nbsp;trigger&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;at&nbsp;every&nbsp;alloc&nbsp;called&nbsp;from&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450651">checkgc</span>&nbsp;<span class="op" id="1450659">=</span>&nbsp;<span class="builtintype" id="1450661">false</span><br>
<span class="lineno"></span><span class="op" id="1450667">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1450670">//&nbsp;A&nbsp;header&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno">105</span><span class="keyword" id="1450696">type</span>&nbsp;<span class="ident" id="1450701">hmap</span>&nbsp;<span class="keyword" id="1450706">struct</span>&nbsp;<span class="op" id="1450713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1450716">//&nbsp;Note:&nbsp;the&nbsp;format&nbsp;of&nbsp;the&nbsp;Hmap&nbsp;is&nbsp;encoded&nbsp;in&nbsp;../../cmd/gc/reflect.c&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1450790">//&nbsp;../reflect/type.go.&nbsp;&nbsp;Don&#39;t&nbsp;change&nbsp;this&nbsp;structure&nbsp;without&nbsp;also&nbsp;changing&nbsp;that&nbsp;code!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450876">count</span>&nbsp;<span class="builtintype" id="1450882">int</span>&nbsp;<span class="comment" id="1450886">//&nbsp;#&nbsp;live&nbsp;cells&nbsp;==&nbsp;size&nbsp;of&nbsp;map.&nbsp;&nbsp;Must&nbsp;be&nbsp;first&nbsp;(used&nbsp;by&nbsp;len()&nbsp;builtin)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450958">flags</span>&nbsp;<span class="builtintype" id="1450964">uint32</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450972">hash0</span>&nbsp;<span class="builtintype" id="1450978">uint32</span>&nbsp;<span class="comment" id="1450985">//&nbsp;hash&nbsp;seed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450999">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1451005">uint8</span>&nbsp;&nbsp;<span class="comment" id="1451012">//&nbsp;log_2&nbsp;of&nbsp;#&nbsp;of&nbsp;buckets&nbsp;(can&nbsp;hold&nbsp;up&nbsp;to&nbsp;loadFactor&nbsp;*&nbsp;2^B&nbsp;items)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451079">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451090">unsafe</span><span class="op" id="1451096">.</span><span class="ident" id="1451097">Pointer</span>&nbsp;<span class="comment" id="1451105">//&nbsp;array&nbsp;of&nbsp;2^B&nbsp;Buckets.&nbsp;may&nbsp;be&nbsp;nil&nbsp;if&nbsp;count==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451155">oldbuckets</span>&nbsp;<span class="ident" id="1451166">unsafe</span><span class="op" id="1451172">.</span><span class="ident" id="1451173">Pointer</span>&nbsp;<span class="comment" id="1451181">//&nbsp;previous&nbsp;bucket&nbsp;array&nbsp;of&nbsp;half&nbsp;the&nbsp;size,&nbsp;non-nil&nbsp;only&nbsp;when&nbsp;growing</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451251">nevacuate</span>&nbsp;&nbsp;<span class="builtintype" id="1451262">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1451277">//&nbsp;progress&nbsp;counter&nbsp;for&nbsp;evacuation&nbsp;(buckets&nbsp;less&nbsp;than&nbsp;this&nbsp;have&nbsp;been&nbsp;evacuated)</span><br>
<span class="lineno"></span><span class="op" id="1451357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1451360">//&nbsp;A&nbsp;bucket&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="1451386">type</span>&nbsp;<span class="ident" id="1451391">bmap</span>&nbsp;<span class="keyword" id="1451396">struct</span>&nbsp;<span class="op" id="1451403">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451406">tophash</span>&nbsp;&nbsp;<span class="op" id="1451415">[</span><span class="ident" id="1451416">bucketCnt</span><span class="op" id="1451425">]</span><span class="builtintype" id="1451426">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451433">overflow</span>&nbsp;<span class="op" id="1451442">*</span><span class="ident" id="1451443">bmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1451449">//&nbsp;Followed&nbsp;by&nbsp;bucketCnt&nbsp;keys&nbsp;and&nbsp;then&nbsp;bucketCnt&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1451507">//&nbsp;NOTE:&nbsp;packing&nbsp;all&nbsp;the&nbsp;keys&nbsp;together&nbsp;and&nbsp;then&nbsp;all&nbsp;the&nbsp;values&nbsp;together&nbsp;makes&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1451590">//&nbsp;code&nbsp;a&nbsp;bit&nbsp;more&nbsp;complicated&nbsp;than&nbsp;alternating&nbsp;key/value/key/value/...&nbsp;but&nbsp;it&nbsp;allows</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1451677">//&nbsp;us&nbsp;to&nbsp;eliminate&nbsp;padding&nbsp;which&nbsp;would&nbsp;be&nbsp;needed&nbsp;for,&nbsp;e.g.,&nbsp;map[int64]int8.</span><br>
<span class="lineno"></span><span class="op" id="1451753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1451756">//&nbsp;A&nbsp;hash&nbsp;iteration&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1451787">//&nbsp;If&nbsp;you&nbsp;modify&nbsp;hiter,&nbsp;also&nbsp;change&nbsp;cmd/gc/reflect.c&nbsp;to&nbsp;indicate</span><br>
<span class="lineno">130</span><span class="comment" id="1451852">//&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="1451885">type</span>&nbsp;<span class="ident" id="1451890">hiter</span>&nbsp;<span class="keyword" id="1451896">struct</span>&nbsp;<span class="op" id="1451903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451906">key</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451918">unsafe</span><span class="op" id="1451924">.</span><span class="ident" id="1451925">Pointer</span>&nbsp;<span class="comment" id="1451933">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;first&nbsp;position.&nbsp;&nbsp;Write&nbsp;nil&nbsp;to&nbsp;indicate&nbsp;iteration&nbsp;end&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452023">value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452035">unsafe</span><span class="op" id="1452041">.</span><span class="ident" id="1452042">Pointer</span>&nbsp;<span class="comment" id="1452050">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;second&nbsp;position&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452103">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452115">*</span><span class="ident" id="1452116">maptype</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452125">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452137">*</span><span class="ident" id="1452138">hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452144">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452156">unsafe</span><span class="op" id="1452162">.</span><span class="ident" id="1452163">Pointer</span>&nbsp;<span class="comment" id="1452171">//&nbsp;bucket&nbsp;ptr&nbsp;at&nbsp;hash_iter&nbsp;initialization&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452219">bptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452231">*</span><span class="ident" id="1452232">bmap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1452246">//&nbsp;current&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452265">startBucket</span>&nbsp;<span class="builtintype" id="1452277">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1452292">//&nbsp;bucket&nbsp;iteration&nbsp;started&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452324">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1452336">uint8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1452351">//&nbsp;intra-bucket&nbsp;offset&nbsp;to&nbsp;start&nbsp;from&nbsp;during&nbsp;iteration&nbsp;(should&nbsp;be&nbsp;big&nbsp;enough&nbsp;to&nbsp;hold&nbsp;bucketCnt-1)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452449">wrapped</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1452461">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1452476">//&nbsp;already&nbsp;wrapped&nbsp;around&nbsp;from&nbsp;end&nbsp;of&nbsp;bucket&nbsp;array&nbsp;to&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452541">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1452553">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452560">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1452572">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452579">bucket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1452591">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452600">checkBucket</span>&nbsp;<span class="builtintype" id="1452612">uintptr</span><br>
<span class="lineno">145</span><span class="op" id="1452620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1452623">func</span>&nbsp;<span class="ident" id="1452628">evacuated</span><span class="op" id="1452637">(</span><span class="ident" id="1452638">b</span>&nbsp;<span class="op" id="1452640">*</span><span class="ident" id="1452641">bmap</span><span class="op" id="1452645">)</span>&nbsp;<span class="builtintype" id="1452647">bool</span>&nbsp;<span class="op" id="1452652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452655">h</span>&nbsp;<span class="op" id="1452657">:=</span>&nbsp;<span class="ident" id="1452660">b</span><span class="op" id="1452661">.</span><span class="ident" id="1452662">tophash</span><span class="op" id="1452669">[</span><span class="num" id="1452670">0</span><span class="op" id="1452671">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452674">return</span>&nbsp;<span class="ident" id="1452681">h</span>&nbsp;<span class="op" id="1452683">&gt;</span>&nbsp;<span class="ident" id="1452685">empty</span>&nbsp;<span class="op" id="1452691">&amp;&amp;</span>&nbsp;<span class="ident" id="1452694">h</span>&nbsp;<span class="op" id="1452696">&lt;</span>&nbsp;<span class="ident" id="1452698">minTopHash</span><br>
<span class="lineno">150</span><span class="op" id="1452709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1452712">func</span>&nbsp;<span class="ident" id="1452717">makemap</span><span class="op" id="1452724">(</span><span class="ident" id="1452725">t</span>&nbsp;<span class="op" id="1452727">*</span><span class="ident" id="1452728">maptype</span><span class="op" id="1452735">,</span>&nbsp;<span class="ident" id="1452737">hint</span>&nbsp;<span class="builtintype" id="1452742">int64</span><span class="op" id="1452747">)</span>&nbsp;<span class="op" id="1452749">*</span><span class="ident" id="1452750">hmap</span>&nbsp;<span class="op" id="1452755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452758">if</span>&nbsp;<span class="ident" id="1452761">sz</span>&nbsp;<span class="op" id="1452764">:=</span>&nbsp;<span class="ident" id="1452767">unsafe</span><span class="op" id="1452773">.</span><span class="ident" id="1452774">Sizeof</span><span class="op" id="1452780">(</span><span class="ident" id="1452781">hmap</span><span class="op" id="1452785">{</span><span class="op" id="1452786">}</span><span class="op" id="1452787">)</span><span class="op" id="1452788">;</span>&nbsp;<span class="ident" id="1452790">sz</span>&nbsp;<span class="op" id="1452793">&gt;</span>&nbsp;<span class="num" id="1452795">48</span>&nbsp;<span class="op" id="1452798">||</span>&nbsp;<span class="ident" id="1452801">sz</span>&nbsp;<span class="op" id="1452804">!=</span>&nbsp;<span class="builtintype" id="1452807">uintptr</span><span class="op" id="1452814">(</span><span class="ident" id="1452815">t</span><span class="op" id="1452816">.</span><span class="ident" id="1452817">hmap</span><span class="op" id="1452821">.</span><span class="ident" id="1452822">size</span><span class="op" id="1452826">)</span>&nbsp;<span class="op" id="1452828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452832">gothrow</span><span class="op" id="1452839">(</span><span class="string" id="1452840">&#34;bad&nbsp;hmap&nbsp;size&#34;</span><span class="op" id="1452855">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452862">if</span>&nbsp;<span class="ident" id="1452865">hint</span>&nbsp;<span class="op" id="1452870">&lt;</span>&nbsp;<span class="num" id="1452872">0</span>&nbsp;<span class="op" id="1452874">||</span>&nbsp;<span class="builtintype" id="1452877">int64</span><span class="op" id="1452882">(</span><span class="builtintype" id="1452883">int32</span><span class="op" id="1452888">(</span><span class="ident" id="1452889">hint</span><span class="op" id="1452893">)</span><span class="op" id="1452894">)</span>&nbsp;<span class="op" id="1452896">!=</span>&nbsp;<span class="ident" id="1452899">hint</span>&nbsp;<span class="op" id="1452904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1452908">panic</span><span class="op" id="1452913">(</span><span class="string" id="1452914">&#34;makemap:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1452942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1452946">//&nbsp;TODO:&nbsp;make&nbsp;hint&nbsp;an&nbsp;int,&nbsp;then&nbsp;none&nbsp;of&nbsp;this&nbsp;nonsense</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1453001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453005">if</span>&nbsp;<span class="op" id="1453008">!</span><span class="ident" id="1453009">ismapkey</span><span class="op" id="1453017">(</span><span class="ident" id="1453018">t</span><span class="op" id="1453019">.</span><span class="ident" id="1453020">key</span><span class="op" id="1453023">)</span>&nbsp;<span class="op" id="1453025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453029">gothrow</span><span class="op" id="1453036">(</span><span class="string" id="1453037">&#34;runtime.makemap:&nbsp;unsupported&nbsp;map&nbsp;key&nbsp;type&#34;</span><span class="op" id="1453080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1453083">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1453087">//&nbsp;check&nbsp;compiler&#39;s&nbsp;and&nbsp;reflect&#39;s&nbsp;math</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453127">if</span>&nbsp;<span class="ident" id="1453130">t</span><span class="op" id="1453131">.</span><span class="ident" id="1453132">key</span><span class="op" id="1453135">.</span><span class="ident" id="1453136">size</span>&nbsp;<span class="op" id="1453141">&gt;</span>&nbsp;<span class="ident" id="1453143">maxKeySize</span>&nbsp;<span class="op" id="1453154">&amp;&amp;</span>&nbsp;<span class="op" id="1453157">(</span><span class="op" id="1453158">!</span><span class="ident" id="1453159">t</span><span class="op" id="1453160">.</span><span class="ident" id="1453161">indirectkey</span>&nbsp;<span class="op" id="1453173">||</span>&nbsp;<span class="ident" id="1453176">t</span><span class="op" id="1453177">.</span><span class="ident" id="1453178">keysize</span>&nbsp;<span class="op" id="1453186">!=</span>&nbsp;<span class="builtintype" id="1453189">uint8</span><span class="op" id="1453194">(</span><span class="ident" id="1453195">ptrSize</span><span class="op" id="1453202">)</span><span class="op" id="1453203">)</span>&nbsp;<span class="op" id="1453205">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453210">t</span><span class="op" id="1453211">.</span><span class="ident" id="1453212">key</span><span class="op" id="1453215">.</span><span class="ident" id="1453216">size</span>&nbsp;<span class="op" id="1453221">&lt;=</span>&nbsp;<span class="ident" id="1453224">maxKeySize</span>&nbsp;<span class="op" id="1453235">&amp;&amp;</span>&nbsp;<span class="op" id="1453238">(</span><span class="ident" id="1453239">t</span><span class="op" id="1453240">.</span><span class="ident" id="1453241">indirectkey</span>&nbsp;<span class="op" id="1453253">||</span>&nbsp;<span class="ident" id="1453256">t</span><span class="op" id="1453257">.</span><span class="ident" id="1453258">keysize</span>&nbsp;<span class="op" id="1453266">!=</span>&nbsp;<span class="builtintype" id="1453269">uint8</span><span class="op" id="1453274">(</span><span class="ident" id="1453275">t</span><span class="op" id="1453276">.</span><span class="ident" id="1453277">key</span><span class="op" id="1453280">.</span><span class="ident" id="1453281">size</span><span class="op" id="1453285">)</span><span class="op" id="1453286">)</span>&nbsp;<span class="op" id="1453288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453292">gothrow</span><span class="op" id="1453299">(</span><span class="string" id="1453300">&#34;key&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1453316">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1453319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453322">if</span>&nbsp;<span class="ident" id="1453325">t</span><span class="op" id="1453326">.</span><span class="ident" id="1453327">elem</span><span class="op" id="1453331">.</span><span class="ident" id="1453332">size</span>&nbsp;<span class="op" id="1453337">&gt;</span>&nbsp;<span class="ident" id="1453339">maxValueSize</span>&nbsp;<span class="op" id="1453352">&amp;&amp;</span>&nbsp;<span class="op" id="1453355">(</span><span class="op" id="1453356">!</span><span class="ident" id="1453357">t</span><span class="op" id="1453358">.</span><span class="ident" id="1453359">indirectvalue</span>&nbsp;<span class="op" id="1453373">||</span>&nbsp;<span class="ident" id="1453376">t</span><span class="op" id="1453377">.</span><span class="ident" id="1453378">valuesize</span>&nbsp;<span class="op" id="1453388">!=</span>&nbsp;<span class="builtintype" id="1453391">uint8</span><span class="op" id="1453396">(</span><span class="ident" id="1453397">ptrSize</span><span class="op" id="1453404">)</span><span class="op" id="1453405">)</span>&nbsp;<span class="op" id="1453407">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453412">t</span><span class="op" id="1453413">.</span><span class="ident" id="1453414">elem</span><span class="op" id="1453418">.</span><span class="ident" id="1453419">size</span>&nbsp;<span class="op" id="1453424">&lt;=</span>&nbsp;<span class="ident" id="1453427">maxValueSize</span>&nbsp;<span class="op" id="1453440">&amp;&amp;</span>&nbsp;<span class="op" id="1453443">(</span><span class="ident" id="1453444">t</span><span class="op" id="1453445">.</span><span class="ident" id="1453446">indirectvalue</span>&nbsp;<span class="op" id="1453460">||</span>&nbsp;<span class="ident" id="1453463">t</span><span class="op" id="1453464">.</span><span class="ident" id="1453465">valuesize</span>&nbsp;<span class="op" id="1453475">!=</span>&nbsp;<span class="builtintype" id="1453478">uint8</span><span class="op" id="1453483">(</span><span class="ident" id="1453484">t</span><span class="op" id="1453485">.</span><span class="ident" id="1453486">elem</span><span class="op" id="1453490">.</span><span class="ident" id="1453491">size</span><span class="op" id="1453495">)</span><span class="op" id="1453496">)</span>&nbsp;<span class="op" id="1453498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453502">gothrow</span><span class="op" id="1453509">(</span><span class="string" id="1453510">&#34;value&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1453528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1453531">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1453535">//&nbsp;invariants&nbsp;we&nbsp;depend&nbsp;on.&nbsp;&nbsp;We&nbsp;should&nbsp;probably&nbsp;check&nbsp;these&nbsp;at&nbsp;compile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1453612">//&nbsp;somewhere,&nbsp;but&nbsp;for&nbsp;now&nbsp;we&#39;ll&nbsp;do&nbsp;it&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453657">if</span>&nbsp;<span class="ident" id="1453660">t</span><span class="op" id="1453661">.</span><span class="ident" id="1453662">key</span><span class="op" id="1453665">.</span><span class="ident" id="1453666">align</span>&nbsp;<span class="op" id="1453672">&gt;</span>&nbsp;<span class="ident" id="1453674">bucketCnt</span>&nbsp;<span class="op" id="1453684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453688">gothrow</span><span class="op" id="1453695">(</span><span class="string" id="1453696">&#34;key&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1453715">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1453718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453721">if</span>&nbsp;<span class="ident" id="1453724">t</span><span class="op" id="1453725">.</span><span class="ident" id="1453726">elem</span><span class="op" id="1453730">.</span><span class="ident" id="1453731">align</span>&nbsp;<span class="op" id="1453737">&gt;</span>&nbsp;<span class="ident" id="1453739">bucketCnt</span>&nbsp;<span class="op" id="1453749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453753">gothrow</span><span class="op" id="1453760">(</span><span class="string" id="1453761">&#34;value&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1453782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1453785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453788">if</span>&nbsp;<span class="builtintype" id="1453791">uintptr</span><span class="op" id="1453798">(</span><span class="ident" id="1453799">t</span><span class="op" id="1453800">.</span><span class="ident" id="1453801">key</span><span class="op" id="1453804">.</span><span class="ident" id="1453805">size</span><span class="op" id="1453809">)</span><span class="op" id="1453810">%</span><span class="builtintype" id="1453811">uintptr</span><span class="op" id="1453818">(</span><span class="ident" id="1453819">t</span><span class="op" id="1453820">.</span><span class="ident" id="1453821">key</span><span class="op" id="1453824">.</span><span class="ident" id="1453825">align</span><span class="op" id="1453830">)</span>&nbsp;<span class="op" id="1453832">!=</span>&nbsp;<span class="num" id="1453835">0</span>&nbsp;<span class="op" id="1453837">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453841">gothrow</span><span class="op" id="1453848">(</span><span class="string" id="1453849">&#34;key&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;key&nbsp;align&#34;</span><span class="op" id="1453887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1453890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453893">if</span>&nbsp;<span class="builtintype" id="1453896">uintptr</span><span class="op" id="1453903">(</span><span class="ident" id="1453904">t</span><span class="op" id="1453905">.</span><span class="ident" id="1453906">elem</span><span class="op" id="1453910">.</span><span class="ident" id="1453911">size</span><span class="op" id="1453915">)</span><span class="op" id="1453916">%</span><span class="builtintype" id="1453917">uintptr</span><span class="op" id="1453924">(</span><span class="ident" id="1453925">t</span><span class="op" id="1453926">.</span><span class="ident" id="1453927">elem</span><span class="op" id="1453931">.</span><span class="ident" id="1453932">align</span><span class="op" id="1453937">)</span>&nbsp;<span class="op" id="1453939">!=</span>&nbsp;<span class="num" id="1453942">0</span>&nbsp;<span class="op" id="1453944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453948">gothrow</span><span class="op" id="1453955">(</span><span class="string" id="1453956">&#34;value&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;value&nbsp;align&#34;</span><span class="op" id="1453998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1454001">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1454004">if</span>&nbsp;<span class="ident" id="1454007">bucketCnt</span>&nbsp;<span class="op" id="1454017">&lt;</span>&nbsp;<span class="num" id="1454019">8</span>&nbsp;<span class="op" id="1454021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454025">gothrow</span><span class="op" id="1454032">(</span><span class="string" id="1454033">&#34;bucketsize&nbsp;too&nbsp;small&nbsp;for&nbsp;proper&nbsp;alignment&#34;</span><span class="op" id="1454076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1454079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1454082">if</span>&nbsp;<span class="ident" id="1454085">dataOffset</span><span class="op" id="1454095">%</span><span class="builtintype" id="1454096">uintptr</span><span class="op" id="1454103">(</span><span class="ident" id="1454104">t</span><span class="op" id="1454105">.</span><span class="ident" id="1454106">key</span><span class="op" id="1454109">.</span><span class="ident" id="1454110">align</span><span class="op" id="1454115">)</span>&nbsp;<span class="op" id="1454117">!=</span>&nbsp;<span class="num" id="1454120">0</span>&nbsp;<span class="op" id="1454122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454126">gothrow</span><span class="op" id="1454133">(</span><span class="string" id="1454134">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(key)&#34;</span><span class="op" id="1454164">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1454167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1454170">if</span>&nbsp;<span class="ident" id="1454173">dataOffset</span><span class="op" id="1454183">%</span><span class="builtintype" id="1454184">uintptr</span><span class="op" id="1454191">(</span><span class="ident" id="1454192">t</span><span class="op" id="1454193">.</span><span class="ident" id="1454194">elem</span><span class="op" id="1454198">.</span><span class="ident" id="1454199">align</span><span class="op" id="1454204">)</span>&nbsp;<span class="op" id="1454206">!=</span>&nbsp;<span class="num" id="1454209">0</span>&nbsp;<span class="op" id="1454211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454215">gothrow</span><span class="op" id="1454222">(</span><span class="string" id="1454223">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(value)&#34;</span><span class="op" id="1454255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1454258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454262">//&nbsp;find&nbsp;size&nbsp;parameter&nbsp;which&nbsp;will&nbsp;hold&nbsp;the&nbsp;requested&nbsp;#&nbsp;of&nbsp;elements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454330">B</span>&nbsp;<span class="op" id="1454332">:=</span>&nbsp;<span class="builtintype" id="1454335">uint8</span><span class="op" id="1454340">(</span><span class="num" id="1454341">0</span><span class="op" id="1454342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1454345">for</span>&nbsp;<span class="op" id="1454349">;</span>&nbsp;<span class="ident" id="1454351">hint</span>&nbsp;<span class="op" id="1454356">&gt;</span>&nbsp;<span class="ident" id="1454358">bucketCnt</span>&nbsp;<span class="op" id="1454368">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1454371">float32</span><span class="op" id="1454378">(</span><span class="ident" id="1454379">hint</span><span class="op" id="1454383">)</span>&nbsp;<span class="op" id="1454385">&gt;</span>&nbsp;<span class="ident" id="1454387">loadFactor</span><span class="op" id="1454397">*</span><span class="builtintype" id="1454398">float32</span><span class="op" id="1454405">(</span><span class="builtintype" id="1454406">uintptr</span><span class="op" id="1454413">(</span><span class="num" id="1454414">1</span><span class="op" id="1454415">)</span><span class="op" id="1454416">&lt;&lt;</span><span class="ident" id="1454418">B</span><span class="op" id="1454419">)</span><span class="op" id="1454420">;</span>&nbsp;<span class="ident" id="1454422">B</span><span class="op" id="1454423">++</span>&nbsp;<span class="op" id="1454426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1454429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454433">//&nbsp;allocate&nbsp;initial&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454465">//&nbsp;if&nbsp;B&nbsp;==&nbsp;0,&nbsp;the&nbsp;buckets&nbsp;field&nbsp;is&nbsp;allocated&nbsp;lazily&nbsp;later&nbsp;(in&nbsp;mapassign)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454539">//&nbsp;If&nbsp;hint&nbsp;is&nbsp;large&nbsp;zeroing&nbsp;this&nbsp;memory&nbsp;could&nbsp;take&nbsp;a&nbsp;while.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1454600">var</span>&nbsp;<span class="ident" id="1454604">buckets</span>&nbsp;<span class="ident" id="1454612">unsafe</span><span class="op" id="1454618">.</span><span class="ident" id="1454619">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1454628">if</span>&nbsp;<span class="ident" id="1454631">B</span>&nbsp;<span class="op" id="1454633">!=</span>&nbsp;<span class="num" id="1454636">0</span>&nbsp;<span class="op" id="1454638">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1454642">if</span>&nbsp;<span class="ident" id="1454645">checkgc</span>&nbsp;<span class="op" id="1454653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454658">memstats</span><span class="op" id="1454666">.</span><span class="ident" id="1454667">next_gc</span>&nbsp;<span class="op" id="1454675">=</span>&nbsp;<span class="ident" id="1454677">memstats</span><span class="op" id="1454685">.</span><span class="ident" id="1454686">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1454699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454703">buckets</span>&nbsp;<span class="op" id="1454711">=</span>&nbsp;<span class="ident" id="1454713">newarray</span><span class="op" id="1454721">(</span><span class="ident" id="1454722">t</span><span class="op" id="1454723">.</span><span class="ident" id="1454724">bucket</span><span class="op" id="1454730">,</span>&nbsp;<span class="builtintype" id="1454732">uintptr</span><span class="op" id="1454739">(</span><span class="num" id="1454740">1</span><span class="op" id="1454741">)</span><span class="op" id="1454742">&lt;&lt;</span><span class="ident" id="1454744">B</span><span class="op" id="1454745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1454748">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454752">//&nbsp;initialize&nbsp;Hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1454772">if</span>&nbsp;<span class="ident" id="1454775">checkgc</span>&nbsp;<span class="op" id="1454783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454787">memstats</span><span class="op" id="1454795">.</span><span class="ident" id="1454796">next_gc</span>&nbsp;<span class="op" id="1454804">=</span>&nbsp;<span class="ident" id="1454806">memstats</span><span class="op" id="1454814">.</span><span class="ident" id="1454815">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1454827">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454830">h</span>&nbsp;<span class="op" id="1454832">:=</span>&nbsp;<span class="op" id="1454835">(</span><span class="op" id="1454836">*</span><span class="ident" id="1454837">hmap</span><span class="op" id="1454841">)</span><span class="op" id="1454842">(</span><span class="ident" id="1454843">newobject</span><span class="op" id="1454852">(</span><span class="ident" id="1454853">t</span><span class="op" id="1454854">.</span><span class="ident" id="1454855">hmap</span><span class="op" id="1454859">)</span><span class="op" id="1454860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454863">h</span><span class="op" id="1454864">.</span><span class="ident" id="1454865">count</span>&nbsp;<span class="op" id="1454871">=</span>&nbsp;<span class="num" id="1454873">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454876">h</span><span class="op" id="1454877">.</span><span class="ident" id="1454878">B</span>&nbsp;<span class="op" id="1454880">=</span>&nbsp;<span class="ident" id="1454882">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454885">h</span><span class="op" id="1454886">.</span><span class="ident" id="1454887">flags</span>&nbsp;<span class="op" id="1454893">=</span>&nbsp;<span class="num" id="1454895">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454898">h</span><span class="op" id="1454899">.</span><span class="ident" id="1454900">hash0</span>&nbsp;<span class="op" id="1454906">=</span>&nbsp;<span class="ident" id="1454908">fastrand1</span><span class="op" id="1454917">(</span><span class="op" id="1454918">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454921">h</span><span class="op" id="1454922">.</span><span class="ident" id="1454923">buckets</span>&nbsp;<span class="op" id="1454931">=</span>&nbsp;<span class="ident" id="1454933">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454942">h</span><span class="op" id="1454943">.</span><span class="ident" id="1454944">oldbuckets</span>&nbsp;<span class="op" id="1454955">=</span>&nbsp;<span class="builtintype" id="1454957">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454962">h</span><span class="op" id="1454963">.</span><span class="ident" id="1454964">nevacuate</span>&nbsp;<span class="op" id="1454974">=</span>&nbsp;<span class="num" id="1454976">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1454980">return</span>&nbsp;<span class="ident" id="1454987">h</span><br>
<span class="lineno">230</span><span class="op" id="1454989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1454992">//&nbsp;mapaccess1&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;h[key].&nbsp;&nbsp;Never&nbsp;returns&nbsp;nil,&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1455063">//&nbsp;it&nbsp;will&nbsp;return&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;zero&nbsp;object&nbsp;for&nbsp;the&nbsp;value&nbsp;type&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="1455134">//&nbsp;the&nbsp;key&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">235</span><span class="comment" id="1455164">//&nbsp;NOTE:&nbsp;The&nbsp;returned&nbsp;pointer&nbsp;may&nbsp;keep&nbsp;the&nbsp;whole&nbsp;map&nbsp;live,&nbsp;so&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1455232">//&nbsp;hold&nbsp;onto&nbsp;it&nbsp;for&nbsp;very&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="1455263">func</span>&nbsp;<span class="ident" id="1455268">mapaccess1</span><span class="op" id="1455278">(</span><span class="ident" id="1455279">t</span>&nbsp;<span class="op" id="1455281">*</span><span class="ident" id="1455282">maptype</span><span class="op" id="1455289">,</span>&nbsp;<span class="ident" id="1455291">h</span>&nbsp;<span class="op" id="1455293">*</span><span class="ident" id="1455294">hmap</span><span class="op" id="1455298">,</span>&nbsp;<span class="ident" id="1455300">key</span>&nbsp;<span class="ident" id="1455304">unsafe</span><span class="op" id="1455310">.</span><span class="ident" id="1455311">Pointer</span><span class="op" id="1455318">)</span>&nbsp;<span class="ident" id="1455320">unsafe</span><span class="op" id="1455326">.</span><span class="ident" id="1455327">Pointer</span>&nbsp;<span class="op" id="1455335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455338">if</span>&nbsp;<span class="ident" id="1455341">raceenabled</span>&nbsp;<span class="op" id="1455353">&amp;&amp;</span>&nbsp;<span class="ident" id="1455356">h</span>&nbsp;<span class="op" id="1455358">!=</span>&nbsp;<span class="builtintype" id="1455361">nil</span>&nbsp;<span class="op" id="1455365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455369">callerpc</span>&nbsp;<span class="op" id="1455378">:=</span>&nbsp;<span class="ident" id="1455381">getcallerpc</span><span class="op" id="1455392">(</span><span class="ident" id="1455393">unsafe</span><span class="op" id="1455399">.</span><span class="ident" id="1455400">Pointer</span><span class="op" id="1455407">(</span><span class="op" id="1455408">&amp;</span><span class="ident" id="1455409">t</span><span class="op" id="1455410">)</span><span class="op" id="1455411">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455415">pc</span>&nbsp;<span class="op" id="1455418">:=</span>&nbsp;<span class="ident" id="1455421">funcPC</span><span class="op" id="1455427">(</span><span class="ident" id="1455428">mapaccess1</span><span class="op" id="1455438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455442">racereadpc</span><span class="op" id="1455452">(</span><span class="ident" id="1455453">unsafe</span><span class="op" id="1455459">.</span><span class="ident" id="1455460">Pointer</span><span class="op" id="1455467">(</span><span class="ident" id="1455468">h</span><span class="op" id="1455469">)</span><span class="op" id="1455470">,</span>&nbsp;<span class="ident" id="1455472">callerpc</span><span class="op" id="1455480">,</span>&nbsp;<span class="ident" id="1455482">pc</span><span class="op" id="1455484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455488">raceReadObjectPC</span><span class="op" id="1455504">(</span><span class="ident" id="1455505">t</span><span class="op" id="1455506">.</span><span class="ident" id="1455507">key</span><span class="op" id="1455510">,</span>&nbsp;<span class="ident" id="1455512">key</span><span class="op" id="1455515">,</span>&nbsp;<span class="ident" id="1455517">callerpc</span><span class="op" id="1455525">,</span>&nbsp;<span class="ident" id="1455527">pc</span><span class="op" id="1455529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455535">if</span>&nbsp;<span class="ident" id="1455538">h</span>&nbsp;<span class="op" id="1455540">==</span>&nbsp;<span class="builtintype" id="1455543">nil</span>&nbsp;<span class="op" id="1455547">||</span>&nbsp;<span class="ident" id="1455550">h</span><span class="op" id="1455551">.</span><span class="ident" id="1455552">count</span>&nbsp;<span class="op" id="1455558">==</span>&nbsp;<span class="num" id="1455561">0</span>&nbsp;<span class="op" id="1455563">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455567">return</span>&nbsp;<span class="ident" id="1455574">unsafe</span><span class="op" id="1455580">.</span><span class="ident" id="1455581">Pointer</span><span class="op" id="1455588">(</span><span class="ident" id="1455589">t</span><span class="op" id="1455590">.</span><span class="ident" id="1455591">elem</span><span class="op" id="1455595">.</span><span class="ident" id="1455596">zero</span><span class="op" id="1455600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455606">alg</span>&nbsp;<span class="op" id="1455610">:=</span>&nbsp;<span class="ident" id="1455613">goalg</span><span class="op" id="1455618">(</span><span class="ident" id="1455619">t</span><span class="op" id="1455620">.</span><span class="ident" id="1455621">key</span><span class="op" id="1455624">.</span><span class="ident" id="1455625">alg</span><span class="op" id="1455628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455631">hash</span>&nbsp;<span class="op" id="1455636">:=</span>&nbsp;<span class="ident" id="1455639">alg</span><span class="op" id="1455642">.</span><span class="ident" id="1455643">hash</span><span class="op" id="1455647">(</span><span class="ident" id="1455648">key</span><span class="op" id="1455651">,</span>&nbsp;<span class="builtintype" id="1455653">uintptr</span><span class="op" id="1455660">(</span><span class="ident" id="1455661">t</span><span class="op" id="1455662">.</span><span class="ident" id="1455663">key</span><span class="op" id="1455666">.</span><span class="ident" id="1455667">size</span><span class="op" id="1455671">)</span><span class="op" id="1455672">,</span>&nbsp;<span class="builtintype" id="1455674">uintptr</span><span class="op" id="1455681">(</span><span class="ident" id="1455682">h</span><span class="op" id="1455683">.</span><span class="ident" id="1455684">hash0</span><span class="op" id="1455689">)</span><span class="op" id="1455690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455693">m</span>&nbsp;<span class="op" id="1455695">:=</span>&nbsp;<span class="builtintype" id="1455698">uintptr</span><span class="op" id="1455705">(</span><span class="num" id="1455706">1</span><span class="op" id="1455707">)</span><span class="op" id="1455708">&lt;&lt;</span><span class="ident" id="1455710">h</span><span class="op" id="1455711">.</span><span class="ident" id="1455712">B</span>&nbsp;<span class="op" id="1455714">-</span>&nbsp;<span class="num" id="1455716">1</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455719">b</span>&nbsp;<span class="op" id="1455721">:=</span>&nbsp;<span class="op" id="1455724">(</span><span class="op" id="1455725">*</span><span class="ident" id="1455726">bmap</span><span class="op" id="1455730">)</span><span class="op" id="1455731">(</span><span class="ident" id="1455732">add</span><span class="op" id="1455735">(</span><span class="ident" id="1455736">h</span><span class="op" id="1455737">.</span><span class="ident" id="1455738">buckets</span><span class="op" id="1455745">,</span>&nbsp;<span class="op" id="1455747">(</span><span class="ident" id="1455748">hash</span><span class="op" id="1455752">&amp;</span><span class="ident" id="1455753">m</span><span class="op" id="1455754">)</span><span class="op" id="1455755">*</span><span class="builtintype" id="1455756">uintptr</span><span class="op" id="1455763">(</span><span class="ident" id="1455764">t</span><span class="op" id="1455765">.</span><span class="ident" id="1455766">bucketsize</span><span class="op" id="1455776">)</span><span class="op" id="1455777">)</span><span class="op" id="1455778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455781">if</span>&nbsp;<span class="ident" id="1455784">c</span>&nbsp;<span class="op" id="1455786">:=</span>&nbsp;<span class="ident" id="1455789">h</span><span class="op" id="1455790">.</span><span class="ident" id="1455791">oldbuckets</span><span class="op" id="1455801">;</span>&nbsp;<span class="ident" id="1455803">c</span>&nbsp;<span class="op" id="1455805">!=</span>&nbsp;<span class="builtintype" id="1455808">nil</span>&nbsp;<span class="op" id="1455812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455816">oldb</span>&nbsp;<span class="op" id="1455821">:=</span>&nbsp;<span class="op" id="1455824">(</span><span class="op" id="1455825">*</span><span class="ident" id="1455826">bmap</span><span class="op" id="1455830">)</span><span class="op" id="1455831">(</span><span class="ident" id="1455832">add</span><span class="op" id="1455835">(</span><span class="ident" id="1455836">c</span><span class="op" id="1455837">,</span>&nbsp;<span class="op" id="1455839">(</span><span class="ident" id="1455840">hash</span><span class="op" id="1455844">&amp;</span><span class="op" id="1455845">(</span><span class="ident" id="1455846">m</span><span class="op" id="1455847">&gt;&gt;</span><span class="num" id="1455849">1</span><span class="op" id="1455850">)</span><span class="op" id="1455851">)</span><span class="op" id="1455852">*</span><span class="builtintype" id="1455853">uintptr</span><span class="op" id="1455860">(</span><span class="ident" id="1455861">t</span><span class="op" id="1455862">.</span><span class="ident" id="1455863">bucketsize</span><span class="op" id="1455873">)</span><span class="op" id="1455874">)</span><span class="op" id="1455875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455879">if</span>&nbsp;<span class="op" id="1455882">!</span><span class="ident" id="1455883">evacuated</span><span class="op" id="1455892">(</span><span class="ident" id="1455893">oldb</span><span class="op" id="1455897">)</span>&nbsp;<span class="op" id="1455899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455904">b</span>&nbsp;<span class="op" id="1455906">=</span>&nbsp;<span class="ident" id="1455908">oldb</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455921">top</span>&nbsp;<span class="op" id="1455925">:=</span>&nbsp;<span class="builtintype" id="1455928">uint8</span><span class="op" id="1455933">(</span><span class="ident" id="1455934">hash</span>&nbsp;<span class="op" id="1455939">&gt;&gt;</span>&nbsp;<span class="op" id="1455942">(</span><span class="ident" id="1455943">ptrSize</span><span class="op" id="1455950">*</span><span class="num" id="1455951">8</span>&nbsp;<span class="op" id="1455953">-</span>&nbsp;<span class="num" id="1455955">8</span><span class="op" id="1455956">)</span><span class="op" id="1455957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455960">if</span>&nbsp;<span class="ident" id="1455963">top</span>&nbsp;<span class="op" id="1455967">&lt;</span>&nbsp;<span class="ident" id="1455969">minTopHash</span>&nbsp;<span class="op" id="1455980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455984">top</span>&nbsp;<span class="op" id="1455988">+=</span>&nbsp;<span class="ident" id="1455991">minTopHash</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456006">for</span>&nbsp;<span class="op" id="1456010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456014">for</span>&nbsp;<span class="ident" id="1456018">i</span>&nbsp;<span class="op" id="1456020">:=</span>&nbsp;<span class="builtintype" id="1456023">uintptr</span><span class="op" id="1456030">(</span><span class="num" id="1456031">0</span><span class="op" id="1456032">)</span><span class="op" id="1456033">;</span>&nbsp;<span class="ident" id="1456035">i</span>&nbsp;<span class="op" id="1456037">&lt;</span>&nbsp;<span class="ident" id="1456039">bucketCnt</span><span class="op" id="1456048">;</span>&nbsp;<span class="ident" id="1456050">i</span><span class="op" id="1456051">++</span>&nbsp;<span class="op" id="1456054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456059">if</span>&nbsp;<span class="ident" id="1456062">b</span><span class="op" id="1456063">.</span><span class="ident" id="1456064">tophash</span><span class="op" id="1456071">[</span><span class="ident" id="1456072">i</span><span class="op" id="1456073">]</span>&nbsp;<span class="op" id="1456075">!=</span>&nbsp;<span class="ident" id="1456078">top</span>&nbsp;<span class="op" id="1456082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456088">continue</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456105">k</span>&nbsp;<span class="op" id="1456107">:=</span>&nbsp;<span class="ident" id="1456110">add</span><span class="op" id="1456113">(</span><span class="ident" id="1456114">unsafe</span><span class="op" id="1456120">.</span><span class="ident" id="1456121">Pointer</span><span class="op" id="1456128">(</span><span class="ident" id="1456129">b</span><span class="op" id="1456130">)</span><span class="op" id="1456131">,</span>&nbsp;<span class="ident" id="1456133">dataOffset</span><span class="op" id="1456143">+</span><span class="ident" id="1456144">i</span><span class="op" id="1456145">*</span><span class="builtintype" id="1456146">uintptr</span><span class="op" id="1456153">(</span><span class="ident" id="1456154">t</span><span class="op" id="1456155">.</span><span class="ident" id="1456156">keysize</span><span class="op" id="1456163">)</span><span class="op" id="1456164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456169">if</span>&nbsp;<span class="ident" id="1456172">t</span><span class="op" id="1456173">.</span><span class="ident" id="1456174">indirectkey</span>&nbsp;<span class="op" id="1456186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456192">k</span>&nbsp;<span class="op" id="1456194">=</span>&nbsp;<span class="op" id="1456196">*</span><span class="op" id="1456197">(</span><span class="op" id="1456198">(</span><span class="op" id="1456199">*</span><span class="ident" id="1456200">unsafe</span><span class="op" id="1456206">.</span><span class="ident" id="1456207">Pointer</span><span class="op" id="1456214">)</span><span class="op" id="1456215">(</span><span class="ident" id="1456216">k</span><span class="op" id="1456217">)</span><span class="op" id="1456218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456223">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456228">if</span>&nbsp;<span class="ident" id="1456231">alg</span><span class="op" id="1456234">.</span><span class="ident" id="1456235">equal</span><span class="op" id="1456240">(</span><span class="ident" id="1456241">key</span><span class="op" id="1456244">,</span>&nbsp;<span class="ident" id="1456246">k</span><span class="op" id="1456247">,</span>&nbsp;<span class="builtintype" id="1456249">uintptr</span><span class="op" id="1456256">(</span><span class="ident" id="1456257">t</span><span class="op" id="1456258">.</span><span class="ident" id="1456259">key</span><span class="op" id="1456262">.</span><span class="ident" id="1456263">size</span><span class="op" id="1456267">)</span><span class="op" id="1456268">)</span>&nbsp;<span class="op" id="1456270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456276">v</span>&nbsp;<span class="op" id="1456278">:=</span>&nbsp;<span class="ident" id="1456281">add</span><span class="op" id="1456284">(</span><span class="ident" id="1456285">unsafe</span><span class="op" id="1456291">.</span><span class="ident" id="1456292">Pointer</span><span class="op" id="1456299">(</span><span class="ident" id="1456300">b</span><span class="op" id="1456301">)</span><span class="op" id="1456302">,</span>&nbsp;<span class="ident" id="1456304">dataOffset</span><span class="op" id="1456314">+</span><span class="ident" id="1456315">bucketCnt</span><span class="op" id="1456324">*</span><span class="builtintype" id="1456325">uintptr</span><span class="op" id="1456332">(</span><span class="ident" id="1456333">t</span><span class="op" id="1456334">.</span><span class="ident" id="1456335">keysize</span><span class="op" id="1456342">)</span><span class="op" id="1456343">+</span><span class="ident" id="1456344">i</span><span class="op" id="1456345">*</span><span class="builtintype" id="1456346">uintptr</span><span class="op" id="1456353">(</span><span class="ident" id="1456354">t</span><span class="op" id="1456355">.</span><span class="ident" id="1456356">valuesize</span><span class="op" id="1456365">)</span><span class="op" id="1456366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456372">if</span>&nbsp;<span class="ident" id="1456375">t</span><span class="op" id="1456376">.</span><span class="ident" id="1456377">indirectvalue</span>&nbsp;<span class="op" id="1456391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456398">v</span>&nbsp;<span class="op" id="1456400">=</span>&nbsp;<span class="op" id="1456402">*</span><span class="op" id="1456403">(</span><span class="op" id="1456404">(</span><span class="op" id="1456405">*</span><span class="ident" id="1456406">unsafe</span><span class="op" id="1456412">.</span><span class="ident" id="1456413">Pointer</span><span class="op" id="1456420">)</span><span class="op" id="1456421">(</span><span class="ident" id="1456422">v</span><span class="op" id="1456423">)</span><span class="op" id="1456424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456430">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456436">return</span>&nbsp;<span class="ident" id="1456443">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456456">b</span>&nbsp;<span class="op" id="1456458">=</span>&nbsp;<span class="ident" id="1456460">b</span><span class="op" id="1456461">.</span><span class="ident" id="1456462">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456473">if</span>&nbsp;<span class="ident" id="1456476">b</span>&nbsp;<span class="op" id="1456478">==</span>&nbsp;<span class="builtintype" id="1456481">nil</span>&nbsp;<span class="op" id="1456485">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456490">return</span>&nbsp;<span class="ident" id="1456497">unsafe</span><span class="op" id="1456503">.</span><span class="ident" id="1456504">Pointer</span><span class="op" id="1456511">(</span><span class="ident" id="1456512">t</span><span class="op" id="1456513">.</span><span class="ident" id="1456514">elem</span><span class="op" id="1456518">.</span><span class="ident" id="1456519">zero</span><span class="op" id="1456523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456530">}</span><br>
<span class="lineno"></span><span class="op" id="1456532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="1456535">func</span>&nbsp;<span class="ident" id="1456540">mapaccess2</span><span class="op" id="1456550">(</span><span class="ident" id="1456551">t</span>&nbsp;<span class="op" id="1456553">*</span><span class="ident" id="1456554">maptype</span><span class="op" id="1456561">,</span>&nbsp;<span class="ident" id="1456563">h</span>&nbsp;<span class="op" id="1456565">*</span><span class="ident" id="1456566">hmap</span><span class="op" id="1456570">,</span>&nbsp;<span class="ident" id="1456572">key</span>&nbsp;<span class="ident" id="1456576">unsafe</span><span class="op" id="1456582">.</span><span class="ident" id="1456583">Pointer</span><span class="op" id="1456590">)</span>&nbsp;<span class="op" id="1456592">(</span><span class="ident" id="1456593">unsafe</span><span class="op" id="1456599">.</span><span class="ident" id="1456600">Pointer</span><span class="op" id="1456607">,</span>&nbsp;<span class="builtintype" id="1456609">bool</span><span class="op" id="1456613">)</span>&nbsp;<span class="op" id="1456615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456618">if</span>&nbsp;<span class="ident" id="1456621">raceenabled</span>&nbsp;<span class="op" id="1456633">&amp;&amp;</span>&nbsp;<span class="ident" id="1456636">h</span>&nbsp;<span class="op" id="1456638">!=</span>&nbsp;<span class="builtintype" id="1456641">nil</span>&nbsp;<span class="op" id="1456645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456649">callerpc</span>&nbsp;<span class="op" id="1456658">:=</span>&nbsp;<span class="ident" id="1456661">getcallerpc</span><span class="op" id="1456672">(</span><span class="ident" id="1456673">unsafe</span><span class="op" id="1456679">.</span><span class="ident" id="1456680">Pointer</span><span class="op" id="1456687">(</span><span class="op" id="1456688">&amp;</span><span class="ident" id="1456689">t</span><span class="op" id="1456690">)</span><span class="op" id="1456691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456695">pc</span>&nbsp;<span class="op" id="1456698">:=</span>&nbsp;<span class="ident" id="1456701">funcPC</span><span class="op" id="1456707">(</span><span class="ident" id="1456708">mapaccess2</span><span class="op" id="1456718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456722">racereadpc</span><span class="op" id="1456732">(</span><span class="ident" id="1456733">unsafe</span><span class="op" id="1456739">.</span><span class="ident" id="1456740">Pointer</span><span class="op" id="1456747">(</span><span class="ident" id="1456748">h</span><span class="op" id="1456749">)</span><span class="op" id="1456750">,</span>&nbsp;<span class="ident" id="1456752">callerpc</span><span class="op" id="1456760">,</span>&nbsp;<span class="ident" id="1456762">pc</span><span class="op" id="1456764">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456768">raceReadObjectPC</span><span class="op" id="1456784">(</span><span class="ident" id="1456785">t</span><span class="op" id="1456786">.</span><span class="ident" id="1456787">key</span><span class="op" id="1456790">,</span>&nbsp;<span class="ident" id="1456792">key</span><span class="op" id="1456795">,</span>&nbsp;<span class="ident" id="1456797">callerpc</span><span class="op" id="1456805">,</span>&nbsp;<span class="ident" id="1456807">pc</span><span class="op" id="1456809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456815">if</span>&nbsp;<span class="ident" id="1456818">h</span>&nbsp;<span class="op" id="1456820">==</span>&nbsp;<span class="builtintype" id="1456823">nil</span>&nbsp;<span class="op" id="1456827">||</span>&nbsp;<span class="ident" id="1456830">h</span><span class="op" id="1456831">.</span><span class="ident" id="1456832">count</span>&nbsp;<span class="op" id="1456838">==</span>&nbsp;<span class="num" id="1456841">0</span>&nbsp;<span class="op" id="1456843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456847">return</span>&nbsp;<span class="ident" id="1456854">unsafe</span><span class="op" id="1456860">.</span><span class="ident" id="1456861">Pointer</span><span class="op" id="1456868">(</span><span class="ident" id="1456869">t</span><span class="op" id="1456870">.</span><span class="ident" id="1456871">elem</span><span class="op" id="1456875">.</span><span class="ident" id="1456876">zero</span><span class="op" id="1456880">)</span><span class="op" id="1456881">,</span>&nbsp;<span class="builtintype" id="1456883">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456890">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456893">alg</span>&nbsp;<span class="op" id="1456897">:=</span>&nbsp;<span class="ident" id="1456900">goalg</span><span class="op" id="1456905">(</span><span class="ident" id="1456906">t</span><span class="op" id="1456907">.</span><span class="ident" id="1456908">key</span><span class="op" id="1456911">.</span><span class="ident" id="1456912">alg</span><span class="op" id="1456915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456918">hash</span>&nbsp;<span class="op" id="1456923">:=</span>&nbsp;<span class="ident" id="1456926">alg</span><span class="op" id="1456929">.</span><span class="ident" id="1456930">hash</span><span class="op" id="1456934">(</span><span class="ident" id="1456935">key</span><span class="op" id="1456938">,</span>&nbsp;<span class="builtintype" id="1456940">uintptr</span><span class="op" id="1456947">(</span><span class="ident" id="1456948">t</span><span class="op" id="1456949">.</span><span class="ident" id="1456950">key</span><span class="op" id="1456953">.</span><span class="ident" id="1456954">size</span><span class="op" id="1456958">)</span><span class="op" id="1456959">,</span>&nbsp;<span class="builtintype" id="1456961">uintptr</span><span class="op" id="1456968">(</span><span class="ident" id="1456969">h</span><span class="op" id="1456970">.</span><span class="ident" id="1456971">hash0</span><span class="op" id="1456976">)</span><span class="op" id="1456977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456980">m</span>&nbsp;<span class="op" id="1456982">:=</span>&nbsp;<span class="builtintype" id="1456985">uintptr</span><span class="op" id="1456992">(</span><span class="num" id="1456993">1</span><span class="op" id="1456994">)</span><span class="op" id="1456995">&lt;&lt;</span><span class="ident" id="1456997">h</span><span class="op" id="1456998">.</span><span class="ident" id="1456999">B</span>&nbsp;<span class="op" id="1457001">-</span>&nbsp;<span class="num" id="1457003">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457006">b</span>&nbsp;<span class="op" id="1457008">:=</span>&nbsp;<span class="op" id="1457011">(</span><span class="op" id="1457012">*</span><span class="ident" id="1457013">bmap</span><span class="op" id="1457017">)</span><span class="op" id="1457018">(</span><span class="ident" id="1457019">unsafe</span><span class="op" id="1457025">.</span><span class="ident" id="1457026">Pointer</span><span class="op" id="1457033">(</span><span class="builtintype" id="1457034">uintptr</span><span class="op" id="1457041">(</span><span class="ident" id="1457042">h</span><span class="op" id="1457043">.</span><span class="ident" id="1457044">buckets</span><span class="op" id="1457051">)</span>&nbsp;<span class="op" id="1457053">+</span>&nbsp;<span class="op" id="1457055">(</span><span class="ident" id="1457056">hash</span><span class="op" id="1457060">&amp;</span><span class="ident" id="1457061">m</span><span class="op" id="1457062">)</span><span class="op" id="1457063">*</span><span class="builtintype" id="1457064">uintptr</span><span class="op" id="1457071">(</span><span class="ident" id="1457072">t</span><span class="op" id="1457073">.</span><span class="ident" id="1457074">bucketsize</span><span class="op" id="1457084">)</span><span class="op" id="1457085">)</span><span class="op" id="1457086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457089">if</span>&nbsp;<span class="ident" id="1457092">c</span>&nbsp;<span class="op" id="1457094">:=</span>&nbsp;<span class="ident" id="1457097">h</span><span class="op" id="1457098">.</span><span class="ident" id="1457099">oldbuckets</span><span class="op" id="1457109">;</span>&nbsp;<span class="ident" id="1457111">c</span>&nbsp;<span class="op" id="1457113">!=</span>&nbsp;<span class="builtintype" id="1457116">nil</span>&nbsp;<span class="op" id="1457120">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457124">oldb</span>&nbsp;<span class="op" id="1457129">:=</span>&nbsp;<span class="op" id="1457132">(</span><span class="op" id="1457133">*</span><span class="ident" id="1457134">bmap</span><span class="op" id="1457138">)</span><span class="op" id="1457139">(</span><span class="ident" id="1457140">unsafe</span><span class="op" id="1457146">.</span><span class="ident" id="1457147">Pointer</span><span class="op" id="1457154">(</span><span class="builtintype" id="1457155">uintptr</span><span class="op" id="1457162">(</span><span class="ident" id="1457163">c</span><span class="op" id="1457164">)</span>&nbsp;<span class="op" id="1457166">+</span>&nbsp;<span class="op" id="1457168">(</span><span class="ident" id="1457169">hash</span><span class="op" id="1457173">&amp;</span><span class="op" id="1457174">(</span><span class="ident" id="1457175">m</span><span class="op" id="1457176">&gt;&gt;</span><span class="num" id="1457178">1</span><span class="op" id="1457179">)</span><span class="op" id="1457180">)</span><span class="op" id="1457181">*</span><span class="builtintype" id="1457182">uintptr</span><span class="op" id="1457189">(</span><span class="ident" id="1457190">t</span><span class="op" id="1457191">.</span><span class="ident" id="1457192">bucketsize</span><span class="op" id="1457202">)</span><span class="op" id="1457203">)</span><span class="op" id="1457204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457208">if</span>&nbsp;<span class="op" id="1457211">!</span><span class="ident" id="1457212">evacuated</span><span class="op" id="1457221">(</span><span class="ident" id="1457222">oldb</span><span class="op" id="1457226">)</span>&nbsp;<span class="op" id="1457228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457233">b</span>&nbsp;<span class="op" id="1457235">=</span>&nbsp;<span class="ident" id="1457237">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457247">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457250">top</span>&nbsp;<span class="op" id="1457254">:=</span>&nbsp;<span class="builtintype" id="1457257">uint8</span><span class="op" id="1457262">(</span><span class="ident" id="1457263">hash</span>&nbsp;<span class="op" id="1457268">&gt;&gt;</span>&nbsp;<span class="op" id="1457271">(</span><span class="ident" id="1457272">ptrSize</span><span class="op" id="1457279">*</span><span class="num" id="1457280">8</span>&nbsp;<span class="op" id="1457282">-</span>&nbsp;<span class="num" id="1457284">8</span><span class="op" id="1457285">)</span><span class="op" id="1457286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457289">if</span>&nbsp;<span class="ident" id="1457292">top</span>&nbsp;<span class="op" id="1457296">&lt;</span>&nbsp;<span class="ident" id="1457298">minTopHash</span>&nbsp;<span class="op" id="1457309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457313">top</span>&nbsp;<span class="op" id="1457317">+=</span>&nbsp;<span class="ident" id="1457320">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457335">for</span>&nbsp;<span class="op" id="1457339">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457343">for</span>&nbsp;<span class="ident" id="1457347">i</span>&nbsp;<span class="op" id="1457349">:=</span>&nbsp;<span class="builtintype" id="1457352">uintptr</span><span class="op" id="1457359">(</span><span class="num" id="1457360">0</span><span class="op" id="1457361">)</span><span class="op" id="1457362">;</span>&nbsp;<span class="ident" id="1457364">i</span>&nbsp;<span class="op" id="1457366">&lt;</span>&nbsp;<span class="ident" id="1457368">bucketCnt</span><span class="op" id="1457377">;</span>&nbsp;<span class="ident" id="1457379">i</span><span class="op" id="1457380">++</span>&nbsp;<span class="op" id="1457383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457388">if</span>&nbsp;<span class="ident" id="1457391">b</span><span class="op" id="1457392">.</span><span class="ident" id="1457393">tophash</span><span class="op" id="1457400">[</span><span class="ident" id="1457401">i</span><span class="op" id="1457402">]</span>&nbsp;<span class="op" id="1457404">!=</span>&nbsp;<span class="ident" id="1457407">top</span>&nbsp;<span class="op" id="1457411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457417">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457434">k</span>&nbsp;<span class="op" id="1457436">:=</span>&nbsp;<span class="ident" id="1457439">add</span><span class="op" id="1457442">(</span><span class="ident" id="1457443">unsafe</span><span class="op" id="1457449">.</span><span class="ident" id="1457450">Pointer</span><span class="op" id="1457457">(</span><span class="ident" id="1457458">b</span><span class="op" id="1457459">)</span><span class="op" id="1457460">,</span>&nbsp;<span class="ident" id="1457462">dataOffset</span><span class="op" id="1457472">+</span><span class="ident" id="1457473">i</span><span class="op" id="1457474">*</span><span class="builtintype" id="1457475">uintptr</span><span class="op" id="1457482">(</span><span class="ident" id="1457483">t</span><span class="op" id="1457484">.</span><span class="ident" id="1457485">keysize</span><span class="op" id="1457492">)</span><span class="op" id="1457493">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457498">if</span>&nbsp;<span class="ident" id="1457501">t</span><span class="op" id="1457502">.</span><span class="ident" id="1457503">indirectkey</span>&nbsp;<span class="op" id="1457515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457521">k</span>&nbsp;<span class="op" id="1457523">=</span>&nbsp;<span class="op" id="1457525">*</span><span class="op" id="1457526">(</span><span class="op" id="1457527">(</span><span class="op" id="1457528">*</span><span class="ident" id="1457529">unsafe</span><span class="op" id="1457535">.</span><span class="ident" id="1457536">Pointer</span><span class="op" id="1457543">)</span><span class="op" id="1457544">(</span><span class="ident" id="1457545">k</span><span class="op" id="1457546">)</span><span class="op" id="1457547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457557">if</span>&nbsp;<span class="ident" id="1457560">alg</span><span class="op" id="1457563">.</span><span class="ident" id="1457564">equal</span><span class="op" id="1457569">(</span><span class="ident" id="1457570">key</span><span class="op" id="1457573">,</span>&nbsp;<span class="ident" id="1457575">k</span><span class="op" id="1457576">,</span>&nbsp;<span class="builtintype" id="1457578">uintptr</span><span class="op" id="1457585">(</span><span class="ident" id="1457586">t</span><span class="op" id="1457587">.</span><span class="ident" id="1457588">key</span><span class="op" id="1457591">.</span><span class="ident" id="1457592">size</span><span class="op" id="1457596">)</span><span class="op" id="1457597">)</span>&nbsp;<span class="op" id="1457599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457605">v</span>&nbsp;<span class="op" id="1457607">:=</span>&nbsp;<span class="ident" id="1457610">add</span><span class="op" id="1457613">(</span><span class="ident" id="1457614">unsafe</span><span class="op" id="1457620">.</span><span class="ident" id="1457621">Pointer</span><span class="op" id="1457628">(</span><span class="ident" id="1457629">b</span><span class="op" id="1457630">)</span><span class="op" id="1457631">,</span>&nbsp;<span class="ident" id="1457633">dataOffset</span><span class="op" id="1457643">+</span><span class="ident" id="1457644">bucketCnt</span><span class="op" id="1457653">*</span><span class="builtintype" id="1457654">uintptr</span><span class="op" id="1457661">(</span><span class="ident" id="1457662">t</span><span class="op" id="1457663">.</span><span class="ident" id="1457664">keysize</span><span class="op" id="1457671">)</span><span class="op" id="1457672">+</span><span class="ident" id="1457673">i</span><span class="op" id="1457674">*</span><span class="builtintype" id="1457675">uintptr</span><span class="op" id="1457682">(</span><span class="ident" id="1457683">t</span><span class="op" id="1457684">.</span><span class="ident" id="1457685">valuesize</span><span class="op" id="1457694">)</span><span class="op" id="1457695">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457701">if</span>&nbsp;<span class="ident" id="1457704">t</span><span class="op" id="1457705">.</span><span class="ident" id="1457706">indirectvalue</span>&nbsp;<span class="op" id="1457720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457727">v</span>&nbsp;<span class="op" id="1457729">=</span>&nbsp;<span class="op" id="1457731">*</span><span class="op" id="1457732">(</span><span class="op" id="1457733">(</span><span class="op" id="1457734">*</span><span class="ident" id="1457735">unsafe</span><span class="op" id="1457741">.</span><span class="ident" id="1457742">Pointer</span><span class="op" id="1457749">)</span><span class="op" id="1457750">(</span><span class="ident" id="1457751">v</span><span class="op" id="1457752">)</span><span class="op" id="1457753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457765">return</span>&nbsp;<span class="ident" id="1457772">v</span><span class="op" id="1457773">,</span>&nbsp;<span class="builtintype" id="1457775">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457783">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457791">b</span>&nbsp;<span class="op" id="1457793">=</span>&nbsp;<span class="ident" id="1457795">b</span><span class="op" id="1457796">.</span><span class="ident" id="1457797">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457808">if</span>&nbsp;<span class="ident" id="1457811">b</span>&nbsp;<span class="op" id="1457813">==</span>&nbsp;<span class="builtintype" id="1457816">nil</span>&nbsp;<span class="op" id="1457820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457825">return</span>&nbsp;<span class="ident" id="1457832">unsafe</span><span class="op" id="1457838">.</span><span class="ident" id="1457839">Pointer</span><span class="op" id="1457846">(</span><span class="ident" id="1457847">t</span><span class="op" id="1457848">.</span><span class="ident" id="1457849">elem</span><span class="op" id="1457853">.</span><span class="ident" id="1457854">zero</span><span class="op" id="1457858">)</span><span class="op" id="1457859">,</span>&nbsp;<span class="builtintype" id="1457861">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457869">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457872">}</span><br>
<span class="lineno"></span><span class="op" id="1457874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1457877">//&nbsp;returns&nbsp;both&nbsp;key&nbsp;and&nbsp;value.&nbsp;&nbsp;Used&nbsp;by&nbsp;map&nbsp;iterator</span><br>
<span class="lineno"></span><span class="keyword" id="1457930">func</span>&nbsp;<span class="ident" id="1457935">mapaccessK</span><span class="op" id="1457945">(</span><span class="ident" id="1457946">t</span>&nbsp;<span class="op" id="1457948">*</span><span class="ident" id="1457949">maptype</span><span class="op" id="1457956">,</span>&nbsp;<span class="ident" id="1457958">h</span>&nbsp;<span class="op" id="1457960">*</span><span class="ident" id="1457961">hmap</span><span class="op" id="1457965">,</span>&nbsp;<span class="ident" id="1457967">key</span>&nbsp;<span class="ident" id="1457971">unsafe</span><span class="op" id="1457977">.</span><span class="ident" id="1457978">Pointer</span><span class="op" id="1457985">)</span>&nbsp;<span class="op" id="1457987">(</span><span class="ident" id="1457988">unsafe</span><span class="op" id="1457994">.</span><span class="ident" id="1457995">Pointer</span><span class="op" id="1458002">,</span>&nbsp;<span class="ident" id="1458004">unsafe</span><span class="op" id="1458010">.</span><span class="ident" id="1458011">Pointer</span><span class="op" id="1458018">)</span>&nbsp;<span class="op" id="1458020">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458023">if</span>&nbsp;<span class="ident" id="1458026">h</span>&nbsp;<span class="op" id="1458028">==</span>&nbsp;<span class="builtintype" id="1458031">nil</span>&nbsp;<span class="op" id="1458035">||</span>&nbsp;<span class="ident" id="1458038">h</span><span class="op" id="1458039">.</span><span class="ident" id="1458040">count</span>&nbsp;<span class="op" id="1458046">==</span>&nbsp;<span class="num" id="1458049">0</span>&nbsp;<span class="op" id="1458051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458055">return</span>&nbsp;<span class="builtintype" id="1458062">nil</span><span class="op" id="1458065">,</span>&nbsp;<span class="builtintype" id="1458067">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458075">alg</span>&nbsp;<span class="op" id="1458079">:=</span>&nbsp;<span class="ident" id="1458082">goalg</span><span class="op" id="1458087">(</span><span class="ident" id="1458088">t</span><span class="op" id="1458089">.</span><span class="ident" id="1458090">key</span><span class="op" id="1458093">.</span><span class="ident" id="1458094">alg</span><span class="op" id="1458097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458100">hash</span>&nbsp;<span class="op" id="1458105">:=</span>&nbsp;<span class="ident" id="1458108">alg</span><span class="op" id="1458111">.</span><span class="ident" id="1458112">hash</span><span class="op" id="1458116">(</span><span class="ident" id="1458117">key</span><span class="op" id="1458120">,</span>&nbsp;<span class="builtintype" id="1458122">uintptr</span><span class="op" id="1458129">(</span><span class="ident" id="1458130">t</span><span class="op" id="1458131">.</span><span class="ident" id="1458132">key</span><span class="op" id="1458135">.</span><span class="ident" id="1458136">size</span><span class="op" id="1458140">)</span><span class="op" id="1458141">,</span>&nbsp;<span class="builtintype" id="1458143">uintptr</span><span class="op" id="1458150">(</span><span class="ident" id="1458151">h</span><span class="op" id="1458152">.</span><span class="ident" id="1458153">hash0</span><span class="op" id="1458158">)</span><span class="op" id="1458159">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458162">m</span>&nbsp;<span class="op" id="1458164">:=</span>&nbsp;<span class="builtintype" id="1458167">uintptr</span><span class="op" id="1458174">(</span><span class="num" id="1458175">1</span><span class="op" id="1458176">)</span><span class="op" id="1458177">&lt;&lt;</span><span class="ident" id="1458179">h</span><span class="op" id="1458180">.</span><span class="ident" id="1458181">B</span>&nbsp;<span class="op" id="1458183">-</span>&nbsp;<span class="num" id="1458185">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458188">b</span>&nbsp;<span class="op" id="1458190">:=</span>&nbsp;<span class="op" id="1458193">(</span><span class="op" id="1458194">*</span><span class="ident" id="1458195">bmap</span><span class="op" id="1458199">)</span><span class="op" id="1458200">(</span><span class="ident" id="1458201">unsafe</span><span class="op" id="1458207">.</span><span class="ident" id="1458208">Pointer</span><span class="op" id="1458215">(</span><span class="builtintype" id="1458216">uintptr</span><span class="op" id="1458223">(</span><span class="ident" id="1458224">h</span><span class="op" id="1458225">.</span><span class="ident" id="1458226">buckets</span><span class="op" id="1458233">)</span>&nbsp;<span class="op" id="1458235">+</span>&nbsp;<span class="op" id="1458237">(</span><span class="ident" id="1458238">hash</span><span class="op" id="1458242">&amp;</span><span class="ident" id="1458243">m</span><span class="op" id="1458244">)</span><span class="op" id="1458245">*</span><span class="builtintype" id="1458246">uintptr</span><span class="op" id="1458253">(</span><span class="ident" id="1458254">t</span><span class="op" id="1458255">.</span><span class="ident" id="1458256">bucketsize</span><span class="op" id="1458266">)</span><span class="op" id="1458267">)</span><span class="op" id="1458268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458271">if</span>&nbsp;<span class="ident" id="1458274">c</span>&nbsp;<span class="op" id="1458276">:=</span>&nbsp;<span class="ident" id="1458279">h</span><span class="op" id="1458280">.</span><span class="ident" id="1458281">oldbuckets</span><span class="op" id="1458291">;</span>&nbsp;<span class="ident" id="1458293">c</span>&nbsp;<span class="op" id="1458295">!=</span>&nbsp;<span class="builtintype" id="1458298">nil</span>&nbsp;<span class="op" id="1458302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458306">oldb</span>&nbsp;<span class="op" id="1458311">:=</span>&nbsp;<span class="op" id="1458314">(</span><span class="op" id="1458315">*</span><span class="ident" id="1458316">bmap</span><span class="op" id="1458320">)</span><span class="op" id="1458321">(</span><span class="ident" id="1458322">unsafe</span><span class="op" id="1458328">.</span><span class="ident" id="1458329">Pointer</span><span class="op" id="1458336">(</span><span class="builtintype" id="1458337">uintptr</span><span class="op" id="1458344">(</span><span class="ident" id="1458345">c</span><span class="op" id="1458346">)</span>&nbsp;<span class="op" id="1458348">+</span>&nbsp;<span class="op" id="1458350">(</span><span class="ident" id="1458351">hash</span><span class="op" id="1458355">&amp;</span><span class="op" id="1458356">(</span><span class="ident" id="1458357">m</span><span class="op" id="1458358">&gt;&gt;</span><span class="num" id="1458360">1</span><span class="op" id="1458361">)</span><span class="op" id="1458362">)</span><span class="op" id="1458363">*</span><span class="builtintype" id="1458364">uintptr</span><span class="op" id="1458371">(</span><span class="ident" id="1458372">t</span><span class="op" id="1458373">.</span><span class="ident" id="1458374">bucketsize</span><span class="op" id="1458384">)</span><span class="op" id="1458385">)</span><span class="op" id="1458386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458390">if</span>&nbsp;<span class="op" id="1458393">!</span><span class="ident" id="1458394">evacuated</span><span class="op" id="1458403">(</span><span class="ident" id="1458404">oldb</span><span class="op" id="1458408">)</span>&nbsp;<span class="op" id="1458410">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458415">b</span>&nbsp;<span class="op" id="1458417">=</span>&nbsp;<span class="ident" id="1458419">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458432">top</span>&nbsp;<span class="op" id="1458436">:=</span>&nbsp;<span class="builtintype" id="1458439">uint8</span><span class="op" id="1458444">(</span><span class="ident" id="1458445">hash</span>&nbsp;<span class="op" id="1458450">&gt;&gt;</span>&nbsp;<span class="op" id="1458453">(</span><span class="ident" id="1458454">ptrSize</span><span class="op" id="1458461">*</span><span class="num" id="1458462">8</span>&nbsp;<span class="op" id="1458464">-</span>&nbsp;<span class="num" id="1458466">8</span><span class="op" id="1458467">)</span><span class="op" id="1458468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458471">if</span>&nbsp;<span class="ident" id="1458474">top</span>&nbsp;<span class="op" id="1458478">&lt;</span>&nbsp;<span class="ident" id="1458480">minTopHash</span>&nbsp;<span class="op" id="1458491">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458495">top</span>&nbsp;<span class="op" id="1458499">+=</span>&nbsp;<span class="ident" id="1458502">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458517">for</span>&nbsp;<span class="op" id="1458521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458525">for</span>&nbsp;<span class="ident" id="1458529">i</span>&nbsp;<span class="op" id="1458531">:=</span>&nbsp;<span class="builtintype" id="1458534">uintptr</span><span class="op" id="1458541">(</span><span class="num" id="1458542">0</span><span class="op" id="1458543">)</span><span class="op" id="1458544">;</span>&nbsp;<span class="ident" id="1458546">i</span>&nbsp;<span class="op" id="1458548">&lt;</span>&nbsp;<span class="ident" id="1458550">bucketCnt</span><span class="op" id="1458559">;</span>&nbsp;<span class="ident" id="1458561">i</span><span class="op" id="1458562">++</span>&nbsp;<span class="op" id="1458565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458570">if</span>&nbsp;<span class="ident" id="1458573">b</span><span class="op" id="1458574">.</span><span class="ident" id="1458575">tophash</span><span class="op" id="1458582">[</span><span class="ident" id="1458583">i</span><span class="op" id="1458584">]</span>&nbsp;<span class="op" id="1458586">!=</span>&nbsp;<span class="ident" id="1458589">top</span>&nbsp;<span class="op" id="1458593">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458599">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458616">k</span>&nbsp;<span class="op" id="1458618">:=</span>&nbsp;<span class="ident" id="1458621">add</span><span class="op" id="1458624">(</span><span class="ident" id="1458625">unsafe</span><span class="op" id="1458631">.</span><span class="ident" id="1458632">Pointer</span><span class="op" id="1458639">(</span><span class="ident" id="1458640">b</span><span class="op" id="1458641">)</span><span class="op" id="1458642">,</span>&nbsp;<span class="ident" id="1458644">dataOffset</span><span class="op" id="1458654">+</span><span class="ident" id="1458655">i</span><span class="op" id="1458656">*</span><span class="builtintype" id="1458657">uintptr</span><span class="op" id="1458664">(</span><span class="ident" id="1458665">t</span><span class="op" id="1458666">.</span><span class="ident" id="1458667">keysize</span><span class="op" id="1458674">)</span><span class="op" id="1458675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458680">if</span>&nbsp;<span class="ident" id="1458683">t</span><span class="op" id="1458684">.</span><span class="ident" id="1458685">indirectkey</span>&nbsp;<span class="op" id="1458697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458703">k</span>&nbsp;<span class="op" id="1458705">=</span>&nbsp;<span class="op" id="1458707">*</span><span class="op" id="1458708">(</span><span class="op" id="1458709">(</span><span class="op" id="1458710">*</span><span class="ident" id="1458711">unsafe</span><span class="op" id="1458717">.</span><span class="ident" id="1458718">Pointer</span><span class="op" id="1458725">)</span><span class="op" id="1458726">(</span><span class="ident" id="1458727">k</span><span class="op" id="1458728">)</span><span class="op" id="1458729">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458739">if</span>&nbsp;<span class="ident" id="1458742">alg</span><span class="op" id="1458745">.</span><span class="ident" id="1458746">equal</span><span class="op" id="1458751">(</span><span class="ident" id="1458752">key</span><span class="op" id="1458755">,</span>&nbsp;<span class="ident" id="1458757">k</span><span class="op" id="1458758">,</span>&nbsp;<span class="builtintype" id="1458760">uintptr</span><span class="op" id="1458767">(</span><span class="ident" id="1458768">t</span><span class="op" id="1458769">.</span><span class="ident" id="1458770">key</span><span class="op" id="1458773">.</span><span class="ident" id="1458774">size</span><span class="op" id="1458778">)</span><span class="op" id="1458779">)</span>&nbsp;<span class="op" id="1458781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458787">v</span>&nbsp;<span class="op" id="1458789">:=</span>&nbsp;<span class="ident" id="1458792">add</span><span class="op" id="1458795">(</span><span class="ident" id="1458796">unsafe</span><span class="op" id="1458802">.</span><span class="ident" id="1458803">Pointer</span><span class="op" id="1458810">(</span><span class="ident" id="1458811">b</span><span class="op" id="1458812">)</span><span class="op" id="1458813">,</span>&nbsp;<span class="ident" id="1458815">dataOffset</span><span class="op" id="1458825">+</span><span class="ident" id="1458826">bucketCnt</span><span class="op" id="1458835">*</span><span class="builtintype" id="1458836">uintptr</span><span class="op" id="1458843">(</span><span class="ident" id="1458844">t</span><span class="op" id="1458845">.</span><span class="ident" id="1458846">keysize</span><span class="op" id="1458853">)</span><span class="op" id="1458854">+</span><span class="ident" id="1458855">i</span><span class="op" id="1458856">*</span><span class="builtintype" id="1458857">uintptr</span><span class="op" id="1458864">(</span><span class="ident" id="1458865">t</span><span class="op" id="1458866">.</span><span class="ident" id="1458867">valuesize</span><span class="op" id="1458876">)</span><span class="op" id="1458877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458883">if</span>&nbsp;<span class="ident" id="1458886">t</span><span class="op" id="1458887">.</span><span class="ident" id="1458888">indirectvalue</span>&nbsp;<span class="op" id="1458902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458909">v</span>&nbsp;<span class="op" id="1458911">=</span>&nbsp;<span class="op" id="1458913">*</span><span class="op" id="1458914">(</span><span class="op" id="1458915">(</span><span class="op" id="1458916">*</span><span class="ident" id="1458917">unsafe</span><span class="op" id="1458923">.</span><span class="ident" id="1458924">Pointer</span><span class="op" id="1458931">)</span><span class="op" id="1458932">(</span><span class="ident" id="1458933">v</span><span class="op" id="1458934">)</span><span class="op" id="1458935">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458947">return</span>&nbsp;<span class="ident" id="1458954">k</span><span class="op" id="1458955">,</span>&nbsp;<span class="ident" id="1458957">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458970">b</span>&nbsp;<span class="op" id="1458972">=</span>&nbsp;<span class="ident" id="1458974">b</span><span class="op" id="1458975">.</span><span class="ident" id="1458976">overflow</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458987">if</span>&nbsp;<span class="ident" id="1458990">b</span>&nbsp;<span class="op" id="1458992">==</span>&nbsp;<span class="builtintype" id="1458995">nil</span>&nbsp;<span class="op" id="1458999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459004">return</span>&nbsp;<span class="builtintype" id="1459011">nil</span><span class="op" id="1459014">,</span>&nbsp;<span class="builtintype" id="1459016">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459025">}</span><br>
<span class="lineno"></span><span class="op" id="1459027">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="1459030">func</span>&nbsp;<span class="ident" id="1459035">mapassign1</span><span class="op" id="1459045">(</span><span class="ident" id="1459046">t</span>&nbsp;<span class="op" id="1459048">*</span><span class="ident" id="1459049">maptype</span><span class="op" id="1459056">,</span>&nbsp;<span class="ident" id="1459058">h</span>&nbsp;<span class="op" id="1459060">*</span><span class="ident" id="1459061">hmap</span><span class="op" id="1459065">,</span>&nbsp;<span class="ident" id="1459067">key</span>&nbsp;<span class="ident" id="1459071">unsafe</span><span class="op" id="1459077">.</span><span class="ident" id="1459078">Pointer</span><span class="op" id="1459085">,</span>&nbsp;<span class="ident" id="1459087">val</span>&nbsp;<span class="ident" id="1459091">unsafe</span><span class="op" id="1459097">.</span><span class="ident" id="1459098">Pointer</span><span class="op" id="1459105">)</span>&nbsp;<span class="op" id="1459107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459110">if</span>&nbsp;<span class="ident" id="1459113">h</span>&nbsp;<span class="op" id="1459115">==</span>&nbsp;<span class="builtintype" id="1459118">nil</span>&nbsp;<span class="op" id="1459122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1459126">panic</span><span class="op" id="1459131">(</span><span class="string" id="1459132">&#34;assignment&nbsp;to&nbsp;entry&nbsp;in&nbsp;nil&nbsp;map&#34;</span><span class="op" id="1459164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459167">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459170">if</span>&nbsp;<span class="ident" id="1459173">raceenabled</span>&nbsp;<span class="op" id="1459185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459189">callerpc</span>&nbsp;<span class="op" id="1459198">:=</span>&nbsp;<span class="ident" id="1459201">getcallerpc</span><span class="op" id="1459212">(</span><span class="ident" id="1459213">unsafe</span><span class="op" id="1459219">.</span><span class="ident" id="1459220">Pointer</span><span class="op" id="1459227">(</span><span class="op" id="1459228">&amp;</span><span class="ident" id="1459229">t</span><span class="op" id="1459230">)</span><span class="op" id="1459231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459235">pc</span>&nbsp;<span class="op" id="1459238">:=</span>&nbsp;<span class="ident" id="1459241">funcPC</span><span class="op" id="1459247">(</span><span class="ident" id="1459248">mapassign1</span><span class="op" id="1459258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459262">racewritepc</span><span class="op" id="1459273">(</span><span class="ident" id="1459274">unsafe</span><span class="op" id="1459280">.</span><span class="ident" id="1459281">Pointer</span><span class="op" id="1459288">(</span><span class="ident" id="1459289">h</span><span class="op" id="1459290">)</span><span class="op" id="1459291">,</span>&nbsp;<span class="ident" id="1459293">callerpc</span><span class="op" id="1459301">,</span>&nbsp;<span class="ident" id="1459303">pc</span><span class="op" id="1459305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459309">raceReadObjectPC</span><span class="op" id="1459325">(</span><span class="ident" id="1459326">t</span><span class="op" id="1459327">.</span><span class="ident" id="1459328">key</span><span class="op" id="1459331">,</span>&nbsp;<span class="ident" id="1459333">key</span><span class="op" id="1459336">,</span>&nbsp;<span class="ident" id="1459338">callerpc</span><span class="op" id="1459346">,</span>&nbsp;<span class="ident" id="1459348">pc</span><span class="op" id="1459350">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459354">raceReadObjectPC</span><span class="op" id="1459370">(</span><span class="ident" id="1459371">t</span><span class="op" id="1459372">.</span><span class="ident" id="1459373">elem</span><span class="op" id="1459377">,</span>&nbsp;<span class="ident" id="1459379">val</span><span class="op" id="1459382">,</span>&nbsp;<span class="ident" id="1459384">callerpc</span><span class="op" id="1459392">,</span>&nbsp;<span class="ident" id="1459394">pc</span><span class="op" id="1459396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459403">alg</span>&nbsp;<span class="op" id="1459407">:=</span>&nbsp;<span class="ident" id="1459410">goalg</span><span class="op" id="1459415">(</span><span class="ident" id="1459416">t</span><span class="op" id="1459417">.</span><span class="ident" id="1459418">key</span><span class="op" id="1459421">.</span><span class="ident" id="1459422">alg</span><span class="op" id="1459425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459428">hash</span>&nbsp;<span class="op" id="1459433">:=</span>&nbsp;<span class="ident" id="1459436">alg</span><span class="op" id="1459439">.</span><span class="ident" id="1459440">hash</span><span class="op" id="1459444">(</span><span class="ident" id="1459445">key</span><span class="op" id="1459448">,</span>&nbsp;<span class="builtintype" id="1459450">uintptr</span><span class="op" id="1459457">(</span><span class="ident" id="1459458">t</span><span class="op" id="1459459">.</span><span class="ident" id="1459460">key</span><span class="op" id="1459463">.</span><span class="ident" id="1459464">size</span><span class="op" id="1459468">)</span><span class="op" id="1459469">,</span>&nbsp;<span class="builtintype" id="1459471">uintptr</span><span class="op" id="1459478">(</span><span class="ident" id="1459479">h</span><span class="op" id="1459480">.</span><span class="ident" id="1459481">hash0</span><span class="op" id="1459486">)</span><span class="op" id="1459487">)</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459491">if</span>&nbsp;<span class="ident" id="1459494">h</span><span class="op" id="1459495">.</span><span class="ident" id="1459496">buckets</span>&nbsp;<span class="op" id="1459504">==</span>&nbsp;<span class="builtintype" id="1459507">nil</span>&nbsp;<span class="op" id="1459511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459515">if</span>&nbsp;<span class="ident" id="1459518">checkgc</span>&nbsp;<span class="op" id="1459526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459531">memstats</span><span class="op" id="1459539">.</span><span class="ident" id="1459540">next_gc</span>&nbsp;<span class="op" id="1459548">=</span>&nbsp;<span class="ident" id="1459550">memstats</span><span class="op" id="1459558">.</span><span class="ident" id="1459559">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459572">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459576">h</span><span class="op" id="1459577">.</span><span class="ident" id="1459578">buckets</span>&nbsp;<span class="op" id="1459586">=</span>&nbsp;<span class="ident" id="1459588">newarray</span><span class="op" id="1459596">(</span><span class="ident" id="1459597">t</span><span class="op" id="1459598">.</span><span class="ident" id="1459599">bucket</span><span class="op" id="1459605">,</span>&nbsp;<span class="num" id="1459607">1</span><span class="op" id="1459608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1459614">again</span><span class="op" id="1459619">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459622">bucket</span>&nbsp;<span class="op" id="1459629">:=</span>&nbsp;<span class="ident" id="1459632">hash</span>&nbsp;<span class="op" id="1459637">&amp;</span>&nbsp;<span class="op" id="1459639">(</span><span class="builtintype" id="1459640">uintptr</span><span class="op" id="1459647">(</span><span class="num" id="1459648">1</span><span class="op" id="1459649">)</span><span class="op" id="1459650">&lt;&lt;</span><span class="ident" id="1459652">h</span><span class="op" id="1459653">.</span><span class="ident" id="1459654">B</span>&nbsp;<span class="op" id="1459656">-</span>&nbsp;<span class="num" id="1459658">1</span><span class="op" id="1459659">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459662">if</span>&nbsp;<span class="ident" id="1459665">h</span><span class="op" id="1459666">.</span><span class="ident" id="1459667">oldbuckets</span>&nbsp;<span class="op" id="1459678">!=</span>&nbsp;<span class="builtintype" id="1459681">nil</span>&nbsp;<span class="op" id="1459685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459689">growWork</span><span class="op" id="1459697">(</span><span class="ident" id="1459698">t</span><span class="op" id="1459699">,</span>&nbsp;<span class="ident" id="1459701">h</span><span class="op" id="1459702">,</span>&nbsp;<span class="ident" id="1459704">bucket</span><span class="op" id="1459710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459716">b</span>&nbsp;<span class="op" id="1459718">:=</span>&nbsp;<span class="op" id="1459721">(</span><span class="op" id="1459722">*</span><span class="ident" id="1459723">bmap</span><span class="op" id="1459727">)</span><span class="op" id="1459728">(</span><span class="ident" id="1459729">unsafe</span><span class="op" id="1459735">.</span><span class="ident" id="1459736">Pointer</span><span class="op" id="1459743">(</span><span class="builtintype" id="1459744">uintptr</span><span class="op" id="1459751">(</span><span class="ident" id="1459752">h</span><span class="op" id="1459753">.</span><span class="ident" id="1459754">buckets</span><span class="op" id="1459761">)</span>&nbsp;<span class="op" id="1459763">+</span>&nbsp;<span class="ident" id="1459765">bucket</span><span class="op" id="1459771">*</span><span class="builtintype" id="1459772">uintptr</span><span class="op" id="1459779">(</span><span class="ident" id="1459780">t</span><span class="op" id="1459781">.</span><span class="ident" id="1459782">bucketsize</span><span class="op" id="1459792">)</span><span class="op" id="1459793">)</span><span class="op" id="1459794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459797">top</span>&nbsp;<span class="op" id="1459801">:=</span>&nbsp;<span class="builtintype" id="1459804">uint8</span><span class="op" id="1459809">(</span><span class="ident" id="1459810">hash</span>&nbsp;<span class="op" id="1459815">&gt;&gt;</span>&nbsp;<span class="op" id="1459818">(</span><span class="ident" id="1459819">ptrSize</span><span class="op" id="1459826">*</span><span class="num" id="1459827">8</span>&nbsp;<span class="op" id="1459829">-</span>&nbsp;<span class="num" id="1459831">8</span><span class="op" id="1459832">)</span><span class="op" id="1459833">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459836">if</span>&nbsp;<span class="ident" id="1459839">top</span>&nbsp;<span class="op" id="1459843">&lt;</span>&nbsp;<span class="ident" id="1459845">minTopHash</span>&nbsp;<span class="op" id="1459856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459860">top</span>&nbsp;<span class="op" id="1459864">+=</span>&nbsp;<span class="ident" id="1459867">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459883">var</span>&nbsp;<span class="ident" id="1459887">inserti</span>&nbsp;<span class="op" id="1459895">*</span><span class="builtintype" id="1459896">uint8</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459903">var</span>&nbsp;<span class="ident" id="1459907">insertk</span>&nbsp;<span class="ident" id="1459915">unsafe</span><span class="op" id="1459921">.</span><span class="ident" id="1459922">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459931">var</span>&nbsp;<span class="ident" id="1459935">insertv</span>&nbsp;<span class="ident" id="1459943">unsafe</span><span class="op" id="1459949">.</span><span class="ident" id="1459950">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459959">for</span>&nbsp;<span class="op" id="1459963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459967">for</span>&nbsp;<span class="ident" id="1459971">i</span>&nbsp;<span class="op" id="1459973">:=</span>&nbsp;<span class="builtintype" id="1459976">uintptr</span><span class="op" id="1459983">(</span><span class="num" id="1459984">0</span><span class="op" id="1459985">)</span><span class="op" id="1459986">;</span>&nbsp;<span class="ident" id="1459988">i</span>&nbsp;<span class="op" id="1459990">&lt;</span>&nbsp;<span class="ident" id="1459992">bucketCnt</span><span class="op" id="1460001">;</span>&nbsp;<span class="ident" id="1460003">i</span><span class="op" id="1460004">++</span>&nbsp;<span class="op" id="1460007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460012">if</span>&nbsp;<span class="ident" id="1460015">b</span><span class="op" id="1460016">.</span><span class="ident" id="1460017">tophash</span><span class="op" id="1460024">[</span><span class="ident" id="1460025">i</span><span class="op" id="1460026">]</span>&nbsp;<span class="op" id="1460028">!=</span>&nbsp;<span class="ident" id="1460031">top</span>&nbsp;<span class="op" id="1460035">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460041">if</span>&nbsp;<span class="ident" id="1460044">b</span><span class="op" id="1460045">.</span><span class="ident" id="1460046">tophash</span><span class="op" id="1460053">[</span><span class="ident" id="1460054">i</span><span class="op" id="1460055">]</span>&nbsp;<span class="op" id="1460057">==</span>&nbsp;<span class="ident" id="1460060">empty</span>&nbsp;<span class="op" id="1460066">&amp;&amp;</span>&nbsp;<span class="ident" id="1460069">inserti</span>&nbsp;<span class="op" id="1460077">==</span>&nbsp;<span class="builtintype" id="1460080">nil</span>&nbsp;<span class="op" id="1460084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460091">inserti</span>&nbsp;<span class="op" id="1460099">=</span>&nbsp;<span class="op" id="1460101">&amp;</span><span class="ident" id="1460102">b</span><span class="op" id="1460103">.</span><span class="ident" id="1460104">tophash</span><span class="op" id="1460111">[</span><span class="ident" id="1460112">i</span><span class="op" id="1460113">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460120">insertk</span>&nbsp;<span class="op" id="1460128">=</span>&nbsp;<span class="ident" id="1460130">add</span><span class="op" id="1460133">(</span><span class="ident" id="1460134">unsafe</span><span class="op" id="1460140">.</span><span class="ident" id="1460141">Pointer</span><span class="op" id="1460148">(</span><span class="ident" id="1460149">b</span><span class="op" id="1460150">)</span><span class="op" id="1460151">,</span>&nbsp;<span class="ident" id="1460153">dataOffset</span><span class="op" id="1460163">+</span><span class="ident" id="1460164">i</span><span class="op" id="1460165">*</span><span class="builtintype" id="1460166">uintptr</span><span class="op" id="1460173">(</span><span class="ident" id="1460174">t</span><span class="op" id="1460175">.</span><span class="ident" id="1460176">keysize</span><span class="op" id="1460183">)</span><span class="op" id="1460184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460191">insertv</span>&nbsp;<span class="op" id="1460199">=</span>&nbsp;<span class="ident" id="1460201">add</span><span class="op" id="1460204">(</span><span class="ident" id="1460205">unsafe</span><span class="op" id="1460211">.</span><span class="ident" id="1460212">Pointer</span><span class="op" id="1460219">(</span><span class="ident" id="1460220">b</span><span class="op" id="1460221">)</span><span class="op" id="1460222">,</span>&nbsp;<span class="ident" id="1460224">dataOffset</span><span class="op" id="1460234">+</span><span class="ident" id="1460235">bucketCnt</span><span class="op" id="1460244">*</span><span class="builtintype" id="1460245">uintptr</span><span class="op" id="1460252">(</span><span class="ident" id="1460253">t</span><span class="op" id="1460254">.</span><span class="ident" id="1460255">keysize</span><span class="op" id="1460262">)</span><span class="op" id="1460263">+</span><span class="ident" id="1460264">i</span><span class="op" id="1460265">*</span><span class="builtintype" id="1460266">uintptr</span><span class="op" id="1460273">(</span><span class="ident" id="1460274">t</span><span class="op" id="1460275">.</span><span class="ident" id="1460276">valuesize</span><span class="op" id="1460285">)</span><span class="op" id="1460286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460292">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460298">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460315">k</span>&nbsp;<span class="op" id="1460317">:=</span>&nbsp;<span class="ident" id="1460320">add</span><span class="op" id="1460323">(</span><span class="ident" id="1460324">unsafe</span><span class="op" id="1460330">.</span><span class="ident" id="1460331">Pointer</span><span class="op" id="1460338">(</span><span class="ident" id="1460339">b</span><span class="op" id="1460340">)</span><span class="op" id="1460341">,</span>&nbsp;<span class="ident" id="1460343">dataOffset</span><span class="op" id="1460353">+</span><span class="ident" id="1460354">i</span><span class="op" id="1460355">*</span><span class="builtintype" id="1460356">uintptr</span><span class="op" id="1460363">(</span><span class="ident" id="1460364">t</span><span class="op" id="1460365">.</span><span class="ident" id="1460366">keysize</span><span class="op" id="1460373">)</span><span class="op" id="1460374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460379">k2</span>&nbsp;<span class="op" id="1460382">:=</span>&nbsp;<span class="ident" id="1460385">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460390">if</span>&nbsp;<span class="ident" id="1460393">t</span><span class="op" id="1460394">.</span><span class="ident" id="1460395">indirectkey</span>&nbsp;<span class="op" id="1460407">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460413">k2</span>&nbsp;<span class="op" id="1460416">=</span>&nbsp;<span class="op" id="1460418">*</span><span class="op" id="1460419">(</span><span class="op" id="1460420">(</span><span class="op" id="1460421">*</span><span class="ident" id="1460422">unsafe</span><span class="op" id="1460428">.</span><span class="ident" id="1460429">Pointer</span><span class="op" id="1460436">)</span><span class="op" id="1460437">(</span><span class="ident" id="1460438">k2</span><span class="op" id="1460440">)</span><span class="op" id="1460441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460451">if</span>&nbsp;<span class="op" id="1460454">!</span><span class="ident" id="1460455">alg</span><span class="op" id="1460458">.</span><span class="ident" id="1460459">equal</span><span class="op" id="1460464">(</span><span class="ident" id="1460465">key</span><span class="op" id="1460468">,</span>&nbsp;<span class="ident" id="1460470">k2</span><span class="op" id="1460472">,</span>&nbsp;<span class="builtintype" id="1460474">uintptr</span><span class="op" id="1460481">(</span><span class="ident" id="1460482">t</span><span class="op" id="1460483">.</span><span class="ident" id="1460484">key</span><span class="op" id="1460487">.</span><span class="ident" id="1460488">size</span><span class="op" id="1460492">)</span><span class="op" id="1460493">)</span>&nbsp;<span class="op" id="1460495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460501">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460513">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460518">//&nbsp;already&nbsp;have&nbsp;a&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Update&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460568">memmove</span><span class="op" id="1460575">(</span><span class="ident" id="1460576">k2</span><span class="op" id="1460578">,</span>&nbsp;<span class="ident" id="1460580">key</span><span class="op" id="1460583">,</span>&nbsp;<span class="builtintype" id="1460585">uintptr</span><span class="op" id="1460592">(</span><span class="ident" id="1460593">t</span><span class="op" id="1460594">.</span><span class="ident" id="1460595">key</span><span class="op" id="1460598">.</span><span class="ident" id="1460599">size</span><span class="op" id="1460603">)</span><span class="op" id="1460604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460609">v</span>&nbsp;<span class="op" id="1460611">:=</span>&nbsp;<span class="ident" id="1460614">add</span><span class="op" id="1460617">(</span><span class="ident" id="1460618">unsafe</span><span class="op" id="1460624">.</span><span class="ident" id="1460625">Pointer</span><span class="op" id="1460632">(</span><span class="ident" id="1460633">b</span><span class="op" id="1460634">)</span><span class="op" id="1460635">,</span>&nbsp;<span class="ident" id="1460637">dataOffset</span><span class="op" id="1460647">+</span><span class="ident" id="1460648">bucketCnt</span><span class="op" id="1460657">*</span><span class="builtintype" id="1460658">uintptr</span><span class="op" id="1460665">(</span><span class="ident" id="1460666">t</span><span class="op" id="1460667">.</span><span class="ident" id="1460668">keysize</span><span class="op" id="1460675">)</span><span class="op" id="1460676">+</span><span class="ident" id="1460677">i</span><span class="op" id="1460678">*</span><span class="builtintype" id="1460679">uintptr</span><span class="op" id="1460686">(</span><span class="ident" id="1460687">t</span><span class="op" id="1460688">.</span><span class="ident" id="1460689">valuesize</span><span class="op" id="1460698">)</span><span class="op" id="1460699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460704">v2</span>&nbsp;<span class="op" id="1460707">:=</span>&nbsp;<span class="ident" id="1460710">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460715">if</span>&nbsp;<span class="ident" id="1460718">t</span><span class="op" id="1460719">.</span><span class="ident" id="1460720">indirectvalue</span>&nbsp;<span class="op" id="1460734">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460740">v2</span>&nbsp;<span class="op" id="1460743">=</span>&nbsp;<span class="op" id="1460745">*</span><span class="op" id="1460746">(</span><span class="op" id="1460747">(</span><span class="op" id="1460748">*</span><span class="ident" id="1460749">unsafe</span><span class="op" id="1460755">.</span><span class="ident" id="1460756">Pointer</span><span class="op" id="1460763">)</span><span class="op" id="1460764">(</span><span class="ident" id="1460765">v2</span><span class="op" id="1460767">)</span><span class="op" id="1460768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460778">memmove</span><span class="op" id="1460785">(</span><span class="ident" id="1460786">v2</span><span class="op" id="1460788">,</span>&nbsp;<span class="ident" id="1460790">val</span><span class="op" id="1460793">,</span>&nbsp;<span class="builtintype" id="1460795">uintptr</span><span class="op" id="1460802">(</span><span class="ident" id="1460803">t</span><span class="op" id="1460804">.</span><span class="ident" id="1460805">elem</span><span class="op" id="1460809">.</span><span class="ident" id="1460810">size</span><span class="op" id="1460814">)</span><span class="op" id="1460815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460820">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460829">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460833">if</span>&nbsp;<span class="ident" id="1460836">b</span><span class="op" id="1460837">.</span><span class="ident" id="1460838">overflow</span>&nbsp;<span class="op" id="1460847">==</span>&nbsp;<span class="builtintype" id="1460850">nil</span>&nbsp;<span class="op" id="1460854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460859">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460871">b</span>&nbsp;<span class="op" id="1460873">=</span>&nbsp;<span class="ident" id="1460875">b</span><span class="op" id="1460876">.</span><span class="ident" id="1460877">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460887">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460891">//&nbsp;did&nbsp;not&nbsp;find&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Allocate&nbsp;new&nbsp;cell&nbsp;&amp;&nbsp;add&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460957">if</span>&nbsp;<span class="builtintype" id="1460960">float32</span><span class="op" id="1460967">(</span><span class="ident" id="1460968">h</span><span class="op" id="1460969">.</span><span class="ident" id="1460970">count</span><span class="op" id="1460975">)</span>&nbsp;<span class="op" id="1460977">&gt;=</span>&nbsp;<span class="ident" id="1460980">loadFactor</span><span class="op" id="1460990">*</span><span class="builtintype" id="1460991">float32</span><span class="op" id="1460998">(</span><span class="op" id="1460999">(</span><span class="builtintype" id="1461000">uintptr</span><span class="op" id="1461007">(</span><span class="num" id="1461008">1</span><span class="op" id="1461009">)</span><span class="op" id="1461010">&lt;&lt;</span><span class="ident" id="1461012">h</span><span class="op" id="1461013">.</span><span class="ident" id="1461014">B</span><span class="op" id="1461015">)</span><span class="op" id="1461016">)</span>&nbsp;<span class="op" id="1461018">&amp;&amp;</span>&nbsp;<span class="ident" id="1461021">h</span><span class="op" id="1461022">.</span><span class="ident" id="1461023">count</span>&nbsp;<span class="op" id="1461029">&gt;=</span>&nbsp;<span class="ident" id="1461032">bucketCnt</span>&nbsp;<span class="op" id="1461042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461046">hashGrow</span><span class="op" id="1461054">(</span><span class="ident" id="1461055">t</span><span class="op" id="1461056">,</span>&nbsp;<span class="ident" id="1461058">h</span><span class="op" id="1461059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461063">goto</span>&nbsp;<span class="ident" id="1461068">again</span>&nbsp;<span class="comment" id="1461074">//&nbsp;Growing&nbsp;the&nbsp;table&nbsp;invalidates&nbsp;everything,&nbsp;so&nbsp;try&nbsp;again</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461137">if</span>&nbsp;<span class="ident" id="1461140">inserti</span>&nbsp;<span class="op" id="1461148">==</span>&nbsp;<span class="builtintype" id="1461151">nil</span>&nbsp;<span class="op" id="1461155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461159">//&nbsp;all&nbsp;current&nbsp;buckets&nbsp;are&nbsp;full,&nbsp;allocate&nbsp;a&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461214">if</span>&nbsp;<span class="ident" id="1461217">checkgc</span>&nbsp;<span class="op" id="1461225">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461230">memstats</span><span class="op" id="1461238">.</span><span class="ident" id="1461239">next_gc</span>&nbsp;<span class="op" id="1461247">=</span>&nbsp;<span class="ident" id="1461249">memstats</span><span class="op" id="1461257">.</span><span class="ident" id="1461258">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461275">newb</span>&nbsp;<span class="op" id="1461280">:=</span>&nbsp;<span class="op" id="1461283">(</span><span class="op" id="1461284">*</span><span class="ident" id="1461285">bmap</span><span class="op" id="1461289">)</span><span class="op" id="1461290">(</span><span class="ident" id="1461291">newobject</span><span class="op" id="1461300">(</span><span class="ident" id="1461301">t</span><span class="op" id="1461302">.</span><span class="ident" id="1461303">bucket</span><span class="op" id="1461309">)</span><span class="op" id="1461310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461314">b</span><span class="op" id="1461315">.</span><span class="ident" id="1461316">overflow</span>&nbsp;<span class="op" id="1461325">=</span>&nbsp;<span class="ident" id="1461327">newb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461334">inserti</span>&nbsp;<span class="op" id="1461342">=</span>&nbsp;<span class="op" id="1461344">&amp;</span><span class="ident" id="1461345">newb</span><span class="op" id="1461349">.</span><span class="ident" id="1461350">tophash</span><span class="op" id="1461357">[</span><span class="num" id="1461358">0</span><span class="op" id="1461359">]</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461363">insertk</span>&nbsp;<span class="op" id="1461371">=</span>&nbsp;<span class="ident" id="1461373">add</span><span class="op" id="1461376">(</span><span class="ident" id="1461377">unsafe</span><span class="op" id="1461383">.</span><span class="ident" id="1461384">Pointer</span><span class="op" id="1461391">(</span><span class="ident" id="1461392">newb</span><span class="op" id="1461396">)</span><span class="op" id="1461397">,</span>&nbsp;<span class="ident" id="1461399">dataOffset</span><span class="op" id="1461409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461413">insertv</span>&nbsp;<span class="op" id="1461421">=</span>&nbsp;<span class="ident" id="1461423">add</span><span class="op" id="1461426">(</span><span class="ident" id="1461427">insertk</span><span class="op" id="1461434">,</span>&nbsp;<span class="ident" id="1461436">bucketCnt</span><span class="op" id="1461445">*</span><span class="builtintype" id="1461446">uintptr</span><span class="op" id="1461453">(</span><span class="ident" id="1461454">t</span><span class="op" id="1461455">.</span><span class="ident" id="1461456">keysize</span><span class="op" id="1461463">)</span><span class="op" id="1461464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461471">//&nbsp;store&nbsp;new&nbsp;key/value&nbsp;at&nbsp;insert&nbsp;position</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461514">if</span>&nbsp;<span class="ident" id="1461517">t</span><span class="op" id="1461518">.</span><span class="ident" id="1461519">indirectkey</span>&nbsp;<span class="op" id="1461531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461535">if</span>&nbsp;<span class="ident" id="1461538">checkgc</span>&nbsp;<span class="op" id="1461546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461551">memstats</span><span class="op" id="1461559">.</span><span class="ident" id="1461560">next_gc</span>&nbsp;<span class="op" id="1461568">=</span>&nbsp;<span class="ident" id="1461570">memstats</span><span class="op" id="1461578">.</span><span class="ident" id="1461579">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461596">kmem</span>&nbsp;<span class="op" id="1461601">:=</span>&nbsp;<span class="ident" id="1461604">newobject</span><span class="op" id="1461613">(</span><span class="ident" id="1461614">t</span><span class="op" id="1461615">.</span><span class="ident" id="1461616">key</span><span class="op" id="1461619">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461623">*</span><span class="op" id="1461624">(</span><span class="op" id="1461625">*</span><span class="ident" id="1461626">unsafe</span><span class="op" id="1461632">.</span><span class="ident" id="1461633">Pointer</span><span class="op" id="1461640">)</span><span class="op" id="1461641">(</span><span class="ident" id="1461642">insertk</span><span class="op" id="1461649">)</span>&nbsp;<span class="op" id="1461651">=</span>&nbsp;<span class="ident" id="1461653">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461660">insertk</span>&nbsp;<span class="op" id="1461668">=</span>&nbsp;<span class="ident" id="1461670">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461679">if</span>&nbsp;<span class="ident" id="1461682">t</span><span class="op" id="1461683">.</span><span class="ident" id="1461684">indirectvalue</span>&nbsp;<span class="op" id="1461698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461702">if</span>&nbsp;<span class="ident" id="1461705">checkgc</span>&nbsp;<span class="op" id="1461713">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461718">memstats</span><span class="op" id="1461726">.</span><span class="ident" id="1461727">next_gc</span>&nbsp;<span class="op" id="1461735">=</span>&nbsp;<span class="ident" id="1461737">memstats</span><span class="op" id="1461745">.</span><span class="ident" id="1461746">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461763">vmem</span>&nbsp;<span class="op" id="1461768">:=</span>&nbsp;<span class="ident" id="1461771">newobject</span><span class="op" id="1461780">(</span><span class="ident" id="1461781">t</span><span class="op" id="1461782">.</span><span class="ident" id="1461783">elem</span><span class="op" id="1461787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461791">*</span><span class="op" id="1461792">(</span><span class="op" id="1461793">*</span><span class="ident" id="1461794">unsafe</span><span class="op" id="1461800">.</span><span class="ident" id="1461801">Pointer</span><span class="op" id="1461808">)</span><span class="op" id="1461809">(</span><span class="ident" id="1461810">insertv</span><span class="op" id="1461817">)</span>&nbsp;<span class="op" id="1461819">=</span>&nbsp;<span class="ident" id="1461821">vmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461828">insertv</span>&nbsp;<span class="op" id="1461836">=</span>&nbsp;<span class="ident" id="1461838">vmem</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461847">memmove</span><span class="op" id="1461854">(</span><span class="ident" id="1461855">insertk</span><span class="op" id="1461862">,</span>&nbsp;<span class="ident" id="1461864">key</span><span class="op" id="1461867">,</span>&nbsp;<span class="builtintype" id="1461869">uintptr</span><span class="op" id="1461876">(</span><span class="ident" id="1461877">t</span><span class="op" id="1461878">.</span><span class="ident" id="1461879">key</span><span class="op" id="1461882">.</span><span class="ident" id="1461883">size</span><span class="op" id="1461887">)</span><span class="op" id="1461888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461891">memmove</span><span class="op" id="1461898">(</span><span class="ident" id="1461899">insertv</span><span class="op" id="1461906">,</span>&nbsp;<span class="ident" id="1461908">val</span><span class="op" id="1461911">,</span>&nbsp;<span class="builtintype" id="1461913">uintptr</span><span class="op" id="1461920">(</span><span class="ident" id="1461921">t</span><span class="op" id="1461922">.</span><span class="ident" id="1461923">elem</span><span class="op" id="1461927">.</span><span class="ident" id="1461928">size</span><span class="op" id="1461932">)</span><span class="op" id="1461933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461936">*</span><span class="ident" id="1461937">inserti</span>&nbsp;<span class="op" id="1461945">=</span>&nbsp;<span class="ident" id="1461947">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461952">h</span><span class="op" id="1461953">.</span><span class="ident" id="1461954">count</span><span class="op" id="1461959">++</span><br>
<span class="lineno">485</span><span class="op" id="1461962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1461965">func</span>&nbsp;<span class="ident" id="1461970">mapdelete</span><span class="op" id="1461979">(</span><span class="ident" id="1461980">t</span>&nbsp;<span class="op" id="1461982">*</span><span class="ident" id="1461983">maptype</span><span class="op" id="1461990">,</span>&nbsp;<span class="ident" id="1461992">h</span>&nbsp;<span class="op" id="1461994">*</span><span class="ident" id="1461995">hmap</span><span class="op" id="1461999">,</span>&nbsp;<span class="ident" id="1462001">key</span>&nbsp;<span class="ident" id="1462005">unsafe</span><span class="op" id="1462011">.</span><span class="ident" id="1462012">Pointer</span><span class="op" id="1462019">)</span>&nbsp;<span class="op" id="1462021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462024">if</span>&nbsp;<span class="ident" id="1462027">raceenabled</span>&nbsp;<span class="op" id="1462039">&amp;&amp;</span>&nbsp;<span class="ident" id="1462042">h</span>&nbsp;<span class="op" id="1462044">!=</span>&nbsp;<span class="builtintype" id="1462047">nil</span>&nbsp;<span class="op" id="1462051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462055">callerpc</span>&nbsp;<span class="op" id="1462064">:=</span>&nbsp;<span class="ident" id="1462067">getcallerpc</span><span class="op" id="1462078">(</span><span class="ident" id="1462079">unsafe</span><span class="op" id="1462085">.</span><span class="ident" id="1462086">Pointer</span><span class="op" id="1462093">(</span><span class="op" id="1462094">&amp;</span><span class="ident" id="1462095">t</span><span class="op" id="1462096">)</span><span class="op" id="1462097">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462101">pc</span>&nbsp;<span class="op" id="1462104">:=</span>&nbsp;<span class="ident" id="1462107">funcPC</span><span class="op" id="1462113">(</span><span class="ident" id="1462114">mapdelete</span><span class="op" id="1462123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462127">racewritepc</span><span class="op" id="1462138">(</span><span class="ident" id="1462139">unsafe</span><span class="op" id="1462145">.</span><span class="ident" id="1462146">Pointer</span><span class="op" id="1462153">(</span><span class="ident" id="1462154">h</span><span class="op" id="1462155">)</span><span class="op" id="1462156">,</span>&nbsp;<span class="ident" id="1462158">callerpc</span><span class="op" id="1462166">,</span>&nbsp;<span class="ident" id="1462168">pc</span><span class="op" id="1462170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462174">raceReadObjectPC</span><span class="op" id="1462190">(</span><span class="ident" id="1462191">t</span><span class="op" id="1462192">.</span><span class="ident" id="1462193">key</span><span class="op" id="1462196">,</span>&nbsp;<span class="ident" id="1462198">key</span><span class="op" id="1462201">,</span>&nbsp;<span class="ident" id="1462203">callerpc</span><span class="op" id="1462211">,</span>&nbsp;<span class="ident" id="1462213">pc</span><span class="op" id="1462215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462221">if</span>&nbsp;<span class="ident" id="1462224">h</span>&nbsp;<span class="op" id="1462226">==</span>&nbsp;<span class="builtintype" id="1462229">nil</span>&nbsp;<span class="op" id="1462233">||</span>&nbsp;<span class="ident" id="1462236">h</span><span class="op" id="1462237">.</span><span class="ident" id="1462238">count</span>&nbsp;<span class="op" id="1462244">==</span>&nbsp;<span class="num" id="1462247">0</span>&nbsp;<span class="op" id="1462249">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462253">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462264">alg</span>&nbsp;<span class="op" id="1462268">:=</span>&nbsp;<span class="ident" id="1462271">goalg</span><span class="op" id="1462276">(</span><span class="ident" id="1462277">t</span><span class="op" id="1462278">.</span><span class="ident" id="1462279">key</span><span class="op" id="1462282">.</span><span class="ident" id="1462283">alg</span><span class="op" id="1462286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462289">hash</span>&nbsp;<span class="op" id="1462294">:=</span>&nbsp;<span class="ident" id="1462297">alg</span><span class="op" id="1462300">.</span><span class="ident" id="1462301">hash</span><span class="op" id="1462305">(</span><span class="ident" id="1462306">key</span><span class="op" id="1462309">,</span>&nbsp;<span class="builtintype" id="1462311">uintptr</span><span class="op" id="1462318">(</span><span class="ident" id="1462319">t</span><span class="op" id="1462320">.</span><span class="ident" id="1462321">key</span><span class="op" id="1462324">.</span><span class="ident" id="1462325">size</span><span class="op" id="1462329">)</span><span class="op" id="1462330">,</span>&nbsp;<span class="builtintype" id="1462332">uintptr</span><span class="op" id="1462339">(</span><span class="ident" id="1462340">h</span><span class="op" id="1462341">.</span><span class="ident" id="1462342">hash0</span><span class="op" id="1462347">)</span><span class="op" id="1462348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462351">bucket</span>&nbsp;<span class="op" id="1462358">:=</span>&nbsp;<span class="ident" id="1462361">hash</span>&nbsp;<span class="op" id="1462366">&amp;</span>&nbsp;<span class="op" id="1462368">(</span><span class="builtintype" id="1462369">uintptr</span><span class="op" id="1462376">(</span><span class="num" id="1462377">1</span><span class="op" id="1462378">)</span><span class="op" id="1462379">&lt;&lt;</span><span class="ident" id="1462381">h</span><span class="op" id="1462382">.</span><span class="ident" id="1462383">B</span>&nbsp;<span class="op" id="1462385">-</span>&nbsp;<span class="num" id="1462387">1</span><span class="op" id="1462388">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462391">if</span>&nbsp;<span class="ident" id="1462394">h</span><span class="op" id="1462395">.</span><span class="ident" id="1462396">oldbuckets</span>&nbsp;<span class="op" id="1462407">!=</span>&nbsp;<span class="builtintype" id="1462410">nil</span>&nbsp;<span class="op" id="1462414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462418">growWork</span><span class="op" id="1462426">(</span><span class="ident" id="1462427">t</span><span class="op" id="1462428">,</span>&nbsp;<span class="ident" id="1462430">h</span><span class="op" id="1462431">,</span>&nbsp;<span class="ident" id="1462433">bucket</span><span class="op" id="1462439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462445">b</span>&nbsp;<span class="op" id="1462447">:=</span>&nbsp;<span class="op" id="1462450">(</span><span class="op" id="1462451">*</span><span class="ident" id="1462452">bmap</span><span class="op" id="1462456">)</span><span class="op" id="1462457">(</span><span class="ident" id="1462458">unsafe</span><span class="op" id="1462464">.</span><span class="ident" id="1462465">Pointer</span><span class="op" id="1462472">(</span><span class="builtintype" id="1462473">uintptr</span><span class="op" id="1462480">(</span><span class="ident" id="1462481">h</span><span class="op" id="1462482">.</span><span class="ident" id="1462483">buckets</span><span class="op" id="1462490">)</span>&nbsp;<span class="op" id="1462492">+</span>&nbsp;<span class="ident" id="1462494">bucket</span><span class="op" id="1462500">*</span><span class="builtintype" id="1462501">uintptr</span><span class="op" id="1462508">(</span><span class="ident" id="1462509">t</span><span class="op" id="1462510">.</span><span class="ident" id="1462511">bucketsize</span><span class="op" id="1462521">)</span><span class="op" id="1462522">)</span><span class="op" id="1462523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462526">top</span>&nbsp;<span class="op" id="1462530">:=</span>&nbsp;<span class="builtintype" id="1462533">uint8</span><span class="op" id="1462538">(</span><span class="ident" id="1462539">hash</span>&nbsp;<span class="op" id="1462544">&gt;&gt;</span>&nbsp;<span class="op" id="1462547">(</span><span class="ident" id="1462548">ptrSize</span><span class="op" id="1462555">*</span><span class="num" id="1462556">8</span>&nbsp;<span class="op" id="1462558">-</span>&nbsp;<span class="num" id="1462560">8</span><span class="op" id="1462561">)</span><span class="op" id="1462562">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462565">if</span>&nbsp;<span class="ident" id="1462568">top</span>&nbsp;<span class="op" id="1462572">&lt;</span>&nbsp;<span class="ident" id="1462574">minTopHash</span>&nbsp;<span class="op" id="1462585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462589">top</span>&nbsp;<span class="op" id="1462593">+=</span>&nbsp;<span class="ident" id="1462596">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462611">for</span>&nbsp;<span class="op" id="1462615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462619">for</span>&nbsp;<span class="ident" id="1462623">i</span>&nbsp;<span class="op" id="1462625">:=</span>&nbsp;<span class="builtintype" id="1462628">uintptr</span><span class="op" id="1462635">(</span><span class="num" id="1462636">0</span><span class="op" id="1462637">)</span><span class="op" id="1462638">;</span>&nbsp;<span class="ident" id="1462640">i</span>&nbsp;<span class="op" id="1462642">&lt;</span>&nbsp;<span class="ident" id="1462644">bucketCnt</span><span class="op" id="1462653">;</span>&nbsp;<span class="ident" id="1462655">i</span><span class="op" id="1462656">++</span>&nbsp;<span class="op" id="1462659">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462664">if</span>&nbsp;<span class="ident" id="1462667">b</span><span class="op" id="1462668">.</span><span class="ident" id="1462669">tophash</span><span class="op" id="1462676">[</span><span class="ident" id="1462677">i</span><span class="op" id="1462678">]</span>&nbsp;<span class="op" id="1462680">!=</span>&nbsp;<span class="ident" id="1462683">top</span>&nbsp;<span class="op" id="1462687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462693">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462710">k</span>&nbsp;<span class="op" id="1462712">:=</span>&nbsp;<span class="ident" id="1462715">add</span><span class="op" id="1462718">(</span><span class="ident" id="1462719">unsafe</span><span class="op" id="1462725">.</span><span class="ident" id="1462726">Pointer</span><span class="op" id="1462733">(</span><span class="ident" id="1462734">b</span><span class="op" id="1462735">)</span><span class="op" id="1462736">,</span>&nbsp;<span class="ident" id="1462738">dataOffset</span><span class="op" id="1462748">+</span><span class="ident" id="1462749">i</span><span class="op" id="1462750">*</span><span class="builtintype" id="1462751">uintptr</span><span class="op" id="1462758">(</span><span class="ident" id="1462759">t</span><span class="op" id="1462760">.</span><span class="ident" id="1462761">keysize</span><span class="op" id="1462768">)</span><span class="op" id="1462769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462774">k2</span>&nbsp;<span class="op" id="1462777">:=</span>&nbsp;<span class="ident" id="1462780">k</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462785">if</span>&nbsp;<span class="ident" id="1462788">t</span><span class="op" id="1462789">.</span><span class="ident" id="1462790">indirectkey</span>&nbsp;<span class="op" id="1462802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462808">k2</span>&nbsp;<span class="op" id="1462811">=</span>&nbsp;<span class="op" id="1462813">*</span><span class="op" id="1462814">(</span><span class="op" id="1462815">(</span><span class="op" id="1462816">*</span><span class="ident" id="1462817">unsafe</span><span class="op" id="1462823">.</span><span class="ident" id="1462824">Pointer</span><span class="op" id="1462831">)</span><span class="op" id="1462832">(</span><span class="ident" id="1462833">k2</span><span class="op" id="1462835">)</span><span class="op" id="1462836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462846">if</span>&nbsp;<span class="op" id="1462849">!</span><span class="ident" id="1462850">alg</span><span class="op" id="1462853">.</span><span class="ident" id="1462854">equal</span><span class="op" id="1462859">(</span><span class="ident" id="1462860">key</span><span class="op" id="1462863">,</span>&nbsp;<span class="ident" id="1462865">k2</span><span class="op" id="1462867">,</span>&nbsp;<span class="builtintype" id="1462869">uintptr</span><span class="op" id="1462876">(</span><span class="ident" id="1462877">t</span><span class="op" id="1462878">.</span><span class="ident" id="1462879">key</span><span class="op" id="1462882">.</span><span class="ident" id="1462883">size</span><span class="op" id="1462887">)</span><span class="op" id="1462888">)</span>&nbsp;<span class="op" id="1462890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462896">continue</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462913">memclr</span><span class="op" id="1462919">(</span><span class="ident" id="1462920">k</span><span class="op" id="1462921">,</span>&nbsp;<span class="builtintype" id="1462923">uintptr</span><span class="op" id="1462930">(</span><span class="ident" id="1462931">t</span><span class="op" id="1462932">.</span><span class="ident" id="1462933">keysize</span><span class="op" id="1462940">)</span><span class="op" id="1462941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462946">v</span>&nbsp;<span class="op" id="1462948">:=</span>&nbsp;<span class="ident" id="1462951">unsafe</span><span class="op" id="1462957">.</span><span class="ident" id="1462958">Pointer</span><span class="op" id="1462965">(</span><span class="builtintype" id="1462966">uintptr</span><span class="op" id="1462973">(</span><span class="ident" id="1462974">unsafe</span><span class="op" id="1462980">.</span><span class="ident" id="1462981">Pointer</span><span class="op" id="1462988">(</span><span class="ident" id="1462989">b</span><span class="op" id="1462990">)</span><span class="op" id="1462991">)</span>&nbsp;<span class="op" id="1462993">+</span>&nbsp;<span class="ident" id="1462995">dataOffset</span>&nbsp;<span class="op" id="1463006">+</span>&nbsp;<span class="ident" id="1463008">bucketCnt</span><span class="op" id="1463017">*</span><span class="builtintype" id="1463018">uintptr</span><span class="op" id="1463025">(</span><span class="ident" id="1463026">t</span><span class="op" id="1463027">.</span><span class="ident" id="1463028">keysize</span><span class="op" id="1463035">)</span>&nbsp;<span class="op" id="1463037">+</span>&nbsp;<span class="ident" id="1463039">i</span><span class="op" id="1463040">*</span><span class="builtintype" id="1463041">uintptr</span><span class="op" id="1463048">(</span><span class="ident" id="1463049">t</span><span class="op" id="1463050">.</span><span class="ident" id="1463051">valuesize</span><span class="op" id="1463060">)</span><span class="op" id="1463061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463066">memclr</span><span class="op" id="1463072">(</span><span class="ident" id="1463073">v</span><span class="op" id="1463074">,</span>&nbsp;<span class="builtintype" id="1463076">uintptr</span><span class="op" id="1463083">(</span><span class="ident" id="1463084">t</span><span class="op" id="1463085">.</span><span class="ident" id="1463086">valuesize</span><span class="op" id="1463095">)</span><span class="op" id="1463096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463101">b</span><span class="op" id="1463102">.</span><span class="ident" id="1463103">tophash</span><span class="op" id="1463110">[</span><span class="ident" id="1463111">i</span><span class="op" id="1463112">]</span>&nbsp;<span class="op" id="1463114">=</span>&nbsp;<span class="ident" id="1463116">empty</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463125">h</span><span class="op" id="1463126">.</span><span class="ident" id="1463127">count</span><span class="op" id="1463132">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463138">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463151">b</span>&nbsp;<span class="op" id="1463153">=</span>&nbsp;<span class="ident" id="1463155">b</span><span class="op" id="1463156">.</span><span class="ident" id="1463157">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463168">if</span>&nbsp;<span class="ident" id="1463171">b</span>&nbsp;<span class="op" id="1463173">==</span>&nbsp;<span class="builtintype" id="1463176">nil</span>&nbsp;<span class="op" id="1463180">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463185">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463197">}</span><br>
<span class="lineno"></span><span class="op" id="1463199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="1463202">func</span>&nbsp;<span class="ident" id="1463207">mapiterinit</span><span class="op" id="1463218">(</span><span class="ident" id="1463219">t</span>&nbsp;<span class="op" id="1463221">*</span><span class="ident" id="1463222">maptype</span><span class="op" id="1463229">,</span>&nbsp;<span class="ident" id="1463231">h</span>&nbsp;<span class="op" id="1463233">*</span><span class="ident" id="1463234">hmap</span><span class="op" id="1463238">,</span>&nbsp;<span class="ident" id="1463240">it</span>&nbsp;<span class="op" id="1463243">*</span><span class="ident" id="1463244">hiter</span><span class="op" id="1463249">)</span>&nbsp;<span class="op" id="1463251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1463254">//&nbsp;Clear&nbsp;pointer&nbsp;fields&nbsp;so&nbsp;garbage&nbsp;collector&nbsp;does&nbsp;not&nbsp;complain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463319">it</span><span class="op" id="1463321">.</span><span class="ident" id="1463322">key</span>&nbsp;<span class="op" id="1463326">=</span>&nbsp;<span class="builtintype" id="1463328">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463333">it</span><span class="op" id="1463335">.</span><span class="ident" id="1463336">value</span>&nbsp;<span class="op" id="1463342">=</span>&nbsp;<span class="builtintype" id="1463344">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463349">it</span><span class="op" id="1463351">.</span><span class="ident" id="1463352">t</span>&nbsp;<span class="op" id="1463354">=</span>&nbsp;<span class="builtintype" id="1463356">nil</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463361">it</span><span class="op" id="1463363">.</span><span class="ident" id="1463364">h</span>&nbsp;<span class="op" id="1463366">=</span>&nbsp;<span class="builtintype" id="1463368">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463373">it</span><span class="op" id="1463375">.</span><span class="ident" id="1463376">buckets</span>&nbsp;<span class="op" id="1463384">=</span>&nbsp;<span class="builtintype" id="1463386">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463391">it</span><span class="op" id="1463393">.</span><span class="ident" id="1463394">bptr</span>&nbsp;<span class="op" id="1463399">=</span>&nbsp;<span class="builtintype" id="1463401">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463407">if</span>&nbsp;<span class="ident" id="1463410">raceenabled</span>&nbsp;<span class="op" id="1463422">&amp;&amp;</span>&nbsp;<span class="ident" id="1463425">h</span>&nbsp;<span class="op" id="1463427">!=</span>&nbsp;<span class="builtintype" id="1463430">nil</span>&nbsp;<span class="op" id="1463434">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463438">callerpc</span>&nbsp;<span class="op" id="1463447">:=</span>&nbsp;<span class="ident" id="1463450">getcallerpc</span><span class="op" id="1463461">(</span><span class="ident" id="1463462">unsafe</span><span class="op" id="1463468">.</span><span class="ident" id="1463469">Pointer</span><span class="op" id="1463476">(</span><span class="op" id="1463477">&amp;</span><span class="ident" id="1463478">t</span><span class="op" id="1463479">)</span><span class="op" id="1463480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463484">racereadpc</span><span class="op" id="1463494">(</span><span class="ident" id="1463495">unsafe</span><span class="op" id="1463501">.</span><span class="ident" id="1463502">Pointer</span><span class="op" id="1463509">(</span><span class="ident" id="1463510">h</span><span class="op" id="1463511">)</span><span class="op" id="1463512">,</span>&nbsp;<span class="ident" id="1463514">callerpc</span><span class="op" id="1463522">,</span>&nbsp;<span class="ident" id="1463524">funcPC</span><span class="op" id="1463530">(</span><span class="ident" id="1463531">mapiterinit</span><span class="op" id="1463542">)</span><span class="op" id="1463543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463550">if</span>&nbsp;<span class="ident" id="1463553">h</span>&nbsp;<span class="op" id="1463555">==</span>&nbsp;<span class="builtintype" id="1463558">nil</span>&nbsp;<span class="op" id="1463562">||</span>&nbsp;<span class="ident" id="1463565">h</span><span class="op" id="1463566">.</span><span class="ident" id="1463567">count</span>&nbsp;<span class="op" id="1463573">==</span>&nbsp;<span class="num" id="1463576">0</span>&nbsp;<span class="op" id="1463578">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463582">it</span><span class="op" id="1463584">.</span><span class="ident" id="1463585">key</span>&nbsp;<span class="op" id="1463589">=</span>&nbsp;<span class="builtintype" id="1463591">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463597">it</span><span class="op" id="1463599">.</span><span class="ident" id="1463600">value</span>&nbsp;<span class="op" id="1463606">=</span>&nbsp;<span class="builtintype" id="1463608">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463614">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463626">if</span>&nbsp;<span class="ident" id="1463629">unsafe</span><span class="op" id="1463635">.</span><span class="ident" id="1463636">Sizeof</span><span class="op" id="1463642">(</span><span class="ident" id="1463643">hiter</span><span class="op" id="1463648">{</span><span class="op" id="1463649">}</span><span class="op" id="1463650">)</span><span class="op" id="1463651">/</span><span class="ident" id="1463652">ptrSize</span>&nbsp;<span class="op" id="1463660">!=</span>&nbsp;<span class="num" id="1463663">10</span>&nbsp;<span class="op" id="1463666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463670">gothrow</span><span class="op" id="1463677">(</span><span class="string" id="1463678">&#34;hash_iter&nbsp;size&nbsp;incorrect&#34;</span><span class="op" id="1463704">)</span>&nbsp;<span class="comment" id="1463706">//&nbsp;see&nbsp;../../cmd/gc/reflect.c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463740">it</span><span class="op" id="1463742">.</span><span class="ident" id="1463743">t</span>&nbsp;<span class="op" id="1463745">=</span>&nbsp;<span class="ident" id="1463747">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463750">it</span><span class="op" id="1463752">.</span><span class="ident" id="1463753">h</span>&nbsp;<span class="op" id="1463755">=</span>&nbsp;<span class="ident" id="1463757">h</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1463761">//&nbsp;grab&nbsp;snapshot&nbsp;of&nbsp;bucket&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463795">it</span><span class="op" id="1463797">.</span><span class="ident" id="1463798">B</span>&nbsp;<span class="op" id="1463800">=</span>&nbsp;<span class="ident" id="1463802">h</span><span class="op" id="1463803">.</span><span class="ident" id="1463804">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463807">it</span><span class="op" id="1463809">.</span><span class="ident" id="1463810">buckets</span>&nbsp;<span class="op" id="1463818">=</span>&nbsp;<span class="ident" id="1463820">h</span><span class="op" id="1463821">.</span><span class="ident" id="1463822">buckets</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1463832">//&nbsp;decide&nbsp;where&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463858">r</span>&nbsp;<span class="op" id="1463860">:=</span>&nbsp;<span class="builtintype" id="1463863">uintptr</span><span class="op" id="1463870">(</span><span class="ident" id="1463871">fastrand1</span><span class="op" id="1463880">(</span><span class="op" id="1463881">)</span><span class="op" id="1463882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463885">if</span>&nbsp;<span class="ident" id="1463888">h</span><span class="op" id="1463889">.</span><span class="ident" id="1463890">B</span>&nbsp;<span class="op" id="1463892">&gt;</span>&nbsp;<span class="num" id="1463894">31</span><span class="op" id="1463896">-</span><span class="ident" id="1463897">bucketCntBits</span>&nbsp;<span class="op" id="1463911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463915">r</span>&nbsp;<span class="op" id="1463917">+=</span>&nbsp;<span class="builtintype" id="1463920">uintptr</span><span class="op" id="1463927">(</span><span class="ident" id="1463928">fastrand1</span><span class="op" id="1463937">(</span><span class="op" id="1463938">)</span><span class="op" id="1463939">)</span>&nbsp;<span class="op" id="1463941">&lt;&lt;</span>&nbsp;<span class="num" id="1463944">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463948">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463951">it</span><span class="op" id="1463953">.</span><span class="ident" id="1463954">startBucket</span>&nbsp;<span class="op" id="1463966">=</span>&nbsp;<span class="ident" id="1463968">r</span>&nbsp;<span class="op" id="1463970">&amp;</span>&nbsp;<span class="op" id="1463972">(</span><span class="builtintype" id="1463973">uintptr</span><span class="op" id="1463980">(</span><span class="num" id="1463981">1</span><span class="op" id="1463982">)</span><span class="op" id="1463983">&lt;&lt;</span><span class="ident" id="1463985">h</span><span class="op" id="1463986">.</span><span class="ident" id="1463987">B</span>&nbsp;<span class="op" id="1463989">-</span>&nbsp;<span class="num" id="1463991">1</span><span class="op" id="1463992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463995">it</span><span class="op" id="1463997">.</span><span class="ident" id="1463998">offset</span>&nbsp;<span class="op" id="1464005">=</span>&nbsp;<span class="builtintype" id="1464007">uint8</span><span class="op" id="1464012">(</span><span class="ident" id="1464013">r</span>&nbsp;<span class="op" id="1464015">&gt;&gt;</span>&nbsp;<span class="ident" id="1464018">h</span><span class="op" id="1464019">.</span><span class="ident" id="1464020">B</span>&nbsp;<span class="op" id="1464022">&amp;</span>&nbsp;<span class="op" id="1464024">(</span><span class="ident" id="1464025">bucketCnt</span>&nbsp;<span class="op" id="1464035">-</span>&nbsp;<span class="num" id="1464037">1</span><span class="op" id="1464038">)</span><span class="op" id="1464039">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1464043">//&nbsp;iterator&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464062">it</span><span class="op" id="1464064">.</span><span class="ident" id="1464065">bucket</span>&nbsp;<span class="op" id="1464072">=</span>&nbsp;<span class="ident" id="1464074">it</span><span class="op" id="1464076">.</span><span class="ident" id="1464077">startBucket</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464090">it</span><span class="op" id="1464092">.</span><span class="ident" id="1464093">wrapped</span>&nbsp;<span class="op" id="1464101">=</span>&nbsp;<span class="builtintype" id="1464103">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464110">it</span><span class="op" id="1464112">.</span><span class="ident" id="1464113">bptr</span>&nbsp;<span class="op" id="1464118">=</span>&nbsp;<span class="builtintype" id="1464120">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1464126">//&nbsp;Remember&nbsp;we&nbsp;have&nbsp;an&nbsp;iterator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1464160">//&nbsp;Can&nbsp;run&nbsp;concurrently&nbsp;with&nbsp;another&nbsp;hash_iter_init().</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464216">for</span>&nbsp;<span class="op" id="1464220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464224">old</span>&nbsp;<span class="op" id="1464228">:=</span>&nbsp;<span class="ident" id="1464231">h</span><span class="op" id="1464232">.</span><span class="ident" id="1464233">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464241">if</span>&nbsp;<span class="ident" id="1464244">old</span>&nbsp;<span class="op" id="1464248">==</span>&nbsp;<span class="ident" id="1464251">old</span><span class="op" id="1464254">|</span><span class="ident" id="1464255">iterator</span><span class="op" id="1464263">|</span><span class="ident" id="1464264">oldIterator</span>&nbsp;<span class="op" id="1464276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464281">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464289">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464293">if</span>&nbsp;<span class="ident" id="1464296">cas</span><span class="op" id="1464299">(</span><span class="op" id="1464300">&amp;</span><span class="ident" id="1464301">h</span><span class="op" id="1464302">.</span><span class="ident" id="1464303">flags</span><span class="op" id="1464308">,</span>&nbsp;<span class="ident" id="1464310">old</span><span class="op" id="1464313">,</span>&nbsp;<span class="ident" id="1464315">old</span><span class="op" id="1464318">|</span><span class="ident" id="1464319">iterator</span><span class="op" id="1464327">|</span><span class="ident" id="1464328">oldIterator</span><span class="op" id="1464339">)</span>&nbsp;<span class="op" id="1464341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464346">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464361">mapiternext</span><span class="op" id="1464372">(</span><span class="ident" id="1464373">it</span><span class="op" id="1464375">)</span><br>
<span class="lineno"></span><span class="op" id="1464377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1464380">func</span>&nbsp;<span class="ident" id="1464385">mapiternext</span><span class="op" id="1464396">(</span><span class="ident" id="1464397">it</span>&nbsp;<span class="op" id="1464400">*</span><span class="ident" id="1464401">hiter</span><span class="op" id="1464406">)</span>&nbsp;<span class="op" id="1464408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464411">h</span>&nbsp;<span class="op" id="1464413">:=</span>&nbsp;<span class="ident" id="1464416">it</span><span class="op" id="1464418">.</span><span class="ident" id="1464419">h</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464422">if</span>&nbsp;<span class="ident" id="1464425">raceenabled</span>&nbsp;<span class="op" id="1464437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464441">callerpc</span>&nbsp;<span class="op" id="1464450">:=</span>&nbsp;<span class="ident" id="1464453">getcallerpc</span><span class="op" id="1464464">(</span><span class="ident" id="1464465">unsafe</span><span class="op" id="1464471">.</span><span class="ident" id="1464472">Pointer</span><span class="op" id="1464479">(</span><span class="op" id="1464480">&amp;</span><span class="ident" id="1464481">it</span><span class="op" id="1464483">)</span><span class="op" id="1464484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464488">racereadpc</span><span class="op" id="1464498">(</span><span class="ident" id="1464499">unsafe</span><span class="op" id="1464505">.</span><span class="ident" id="1464506">Pointer</span><span class="op" id="1464513">(</span><span class="ident" id="1464514">h</span><span class="op" id="1464515">)</span><span class="op" id="1464516">,</span>&nbsp;<span class="ident" id="1464518">callerpc</span><span class="op" id="1464526">,</span>&nbsp;<span class="ident" id="1464528">funcPC</span><span class="op" id="1464534">(</span><span class="ident" id="1464535">mapiternext</span><span class="op" id="1464546">)</span><span class="op" id="1464547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464553">t</span>&nbsp;<span class="op" id="1464555">:=</span>&nbsp;<span class="ident" id="1464558">it</span><span class="op" id="1464560">.</span><span class="ident" id="1464561">t</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464564">bucket</span>&nbsp;<span class="op" id="1464571">:=</span>&nbsp;<span class="ident" id="1464574">it</span><span class="op" id="1464576">.</span><span class="ident" id="1464577">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464585">b</span>&nbsp;<span class="op" id="1464587">:=</span>&nbsp;<span class="ident" id="1464590">it</span><span class="op" id="1464592">.</span><span class="ident" id="1464593">bptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464599">i</span>&nbsp;<span class="op" id="1464601">:=</span>&nbsp;<span class="ident" id="1464604">it</span><span class="op" id="1464606">.</span><span class="ident" id="1464607">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464610">checkBucket</span>&nbsp;<span class="op" id="1464622">:=</span>&nbsp;<span class="ident" id="1464625">it</span><span class="op" id="1464627">.</span><span class="ident" id="1464628">checkBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464641">alg</span>&nbsp;<span class="op" id="1464645">:=</span>&nbsp;<span class="ident" id="1464648">goalg</span><span class="op" id="1464653">(</span><span class="ident" id="1464654">t</span><span class="op" id="1464655">.</span><span class="ident" id="1464656">key</span><span class="op" id="1464659">.</span><span class="ident" id="1464660">alg</span><span class="op" id="1464663">)</span><br>
<span class="lineno">605</span><br>
<span class="lineno"></span><span class="ident" id="1464666">next</span><span class="op" id="1464670">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464673">if</span>&nbsp;<span class="ident" id="1464676">b</span>&nbsp;<span class="op" id="1464678">==</span>&nbsp;<span class="builtintype" id="1464681">nil</span>&nbsp;<span class="op" id="1464685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464689">if</span>&nbsp;<span class="ident" id="1464692">bucket</span>&nbsp;<span class="op" id="1464699">==</span>&nbsp;<span class="ident" id="1464702">it</span><span class="op" id="1464704">.</span><span class="ident" id="1464705">startBucket</span>&nbsp;<span class="op" id="1464717">&amp;&amp;</span>&nbsp;<span class="ident" id="1464720">it</span><span class="op" id="1464722">.</span><span class="ident" id="1464723">wrapped</span>&nbsp;<span class="op" id="1464731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1464736">//&nbsp;end&nbsp;of&nbsp;iteration</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464759">it</span><span class="op" id="1464761">.</span><span class="ident" id="1464762">key</span>&nbsp;<span class="op" id="1464766">=</span>&nbsp;<span class="builtintype" id="1464768">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464775">it</span><span class="op" id="1464777">.</span><span class="ident" id="1464778">value</span>&nbsp;<span class="op" id="1464784">=</span>&nbsp;<span class="builtintype" id="1464786">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464793">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464806">if</span>&nbsp;<span class="ident" id="1464809">h</span><span class="op" id="1464810">.</span><span class="ident" id="1464811">oldbuckets</span>&nbsp;<span class="op" id="1464822">!=</span>&nbsp;<span class="builtintype" id="1464825">nil</span>&nbsp;<span class="op" id="1464829">&amp;&amp;</span>&nbsp;<span class="ident" id="1464832">it</span><span class="op" id="1464834">.</span><span class="ident" id="1464835">B</span>&nbsp;<span class="op" id="1464837">==</span>&nbsp;<span class="ident" id="1464840">h</span><span class="op" id="1464841">.</span><span class="ident" id="1464842">B</span>&nbsp;<span class="op" id="1464844">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1464849">//&nbsp;Iterator&nbsp;was&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;grow,&nbsp;and&nbsp;the&nbsp;grow&nbsp;isn&#39;t&nbsp;done&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1464930">//&nbsp;If&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;looking&nbsp;at&nbsp;hasn&#39;t&nbsp;been&nbsp;filled&nbsp;in&nbsp;yet&nbsp;(i.e.&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465007">//&nbsp;bucket&nbsp;hasn&#39;t&nbsp;been&nbsp;evacuated)&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;iterate&nbsp;through&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465083">//&nbsp;bucket&nbsp;and&nbsp;only&nbsp;return&nbsp;the&nbsp;ones&nbsp;that&nbsp;will&nbsp;be&nbsp;migrated&nbsp;to&nbsp;this&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465159">oldbucket</span>&nbsp;<span class="op" id="1465169">:=</span>&nbsp;<span class="ident" id="1465172">bucket</span>&nbsp;<span class="op" id="1465179">&amp;</span>&nbsp;<span class="op" id="1465181">(</span><span class="builtintype" id="1465182">uintptr</span><span class="op" id="1465189">(</span><span class="num" id="1465190">1</span><span class="op" id="1465191">)</span><span class="op" id="1465192">&lt;&lt;</span><span class="op" id="1465194">(</span><span class="ident" id="1465195">it</span><span class="op" id="1465197">.</span><span class="ident" id="1465198">B</span><span class="op" id="1465199">-</span><span class="num" id="1465200">1</span><span class="op" id="1465201">)</span>&nbsp;<span class="op" id="1465203">-</span>&nbsp;<span class="num" id="1465205">1</span><span class="op" id="1465206">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465211">b</span>&nbsp;<span class="op" id="1465213">=</span>&nbsp;<span class="op" id="1465215">(</span><span class="op" id="1465216">*</span><span class="ident" id="1465217">bmap</span><span class="op" id="1465221">)</span><span class="op" id="1465222">(</span><span class="ident" id="1465223">add</span><span class="op" id="1465226">(</span><span class="ident" id="1465227">h</span><span class="op" id="1465228">.</span><span class="ident" id="1465229">oldbuckets</span><span class="op" id="1465239">,</span>&nbsp;<span class="ident" id="1465241">oldbucket</span><span class="op" id="1465250">*</span><span class="builtintype" id="1465251">uintptr</span><span class="op" id="1465258">(</span><span class="ident" id="1465259">t</span><span class="op" id="1465260">.</span><span class="ident" id="1465261">bucketsize</span><span class="op" id="1465271">)</span><span class="op" id="1465272">)</span><span class="op" id="1465273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465278">if</span>&nbsp;<span class="op" id="1465281">!</span><span class="ident" id="1465282">evacuated</span><span class="op" id="1465291">(</span><span class="ident" id="1465292">b</span><span class="op" id="1465293">)</span>&nbsp;<span class="op" id="1465295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465301">checkBucket</span>&nbsp;<span class="op" id="1465313">=</span>&nbsp;<span class="ident" id="1465315">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465325">}</span>&nbsp;<span class="keyword" id="1465327">else</span>&nbsp;<span class="op" id="1465332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465338">b</span>&nbsp;<span class="op" id="1465340">=</span>&nbsp;<span class="op" id="1465342">(</span><span class="op" id="1465343">*</span><span class="ident" id="1465344">bmap</span><span class="op" id="1465348">)</span><span class="op" id="1465349">(</span><span class="ident" id="1465350">add</span><span class="op" id="1465353">(</span><span class="ident" id="1465354">it</span><span class="op" id="1465356">.</span><span class="ident" id="1465357">buckets</span><span class="op" id="1465364">,</span>&nbsp;<span class="ident" id="1465366">bucket</span><span class="op" id="1465372">*</span><span class="builtintype" id="1465373">uintptr</span><span class="op" id="1465380">(</span><span class="ident" id="1465381">t</span><span class="op" id="1465382">.</span><span class="ident" id="1465383">bucketsize</span><span class="op" id="1465393">)</span><span class="op" id="1465394">)</span><span class="op" id="1465395">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465401">checkBucket</span>&nbsp;<span class="op" id="1465413">=</span>&nbsp;<span class="ident" id="1465415">noCheck</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465430">}</span>&nbsp;<span class="keyword" id="1465432">else</span>&nbsp;<span class="op" id="1465437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465442">b</span>&nbsp;<span class="op" id="1465444">=</span>&nbsp;<span class="op" id="1465446">(</span><span class="op" id="1465447">*</span><span class="ident" id="1465448">bmap</span><span class="op" id="1465452">)</span><span class="op" id="1465453">(</span><span class="ident" id="1465454">add</span><span class="op" id="1465457">(</span><span class="ident" id="1465458">it</span><span class="op" id="1465460">.</span><span class="ident" id="1465461">buckets</span><span class="op" id="1465468">,</span>&nbsp;<span class="ident" id="1465470">bucket</span><span class="op" id="1465476">*</span><span class="builtintype" id="1465477">uintptr</span><span class="op" id="1465484">(</span><span class="ident" id="1465485">t</span><span class="op" id="1465486">.</span><span class="ident" id="1465487">bucketsize</span><span class="op" id="1465497">)</span><span class="op" id="1465498">)</span><span class="op" id="1465499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465504">checkBucket</span>&nbsp;<span class="op" id="1465516">=</span>&nbsp;<span class="ident" id="1465518">noCheck</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465532">bucket</span><span class="op" id="1465538">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465543">if</span>&nbsp;<span class="ident" id="1465546">bucket</span>&nbsp;<span class="op" id="1465553">==</span>&nbsp;<span class="builtintype" id="1465556">uintptr</span><span class="op" id="1465563">(</span><span class="num" id="1465564">1</span><span class="op" id="1465565">)</span><span class="op" id="1465566">&lt;&lt;</span><span class="ident" id="1465568">it</span><span class="op" id="1465570">.</span><span class="ident" id="1465571">B</span>&nbsp;<span class="op" id="1465573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465578">bucket</span>&nbsp;<span class="op" id="1465585">=</span>&nbsp;<span class="num" id="1465587">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465592">it</span><span class="op" id="1465594">.</span><span class="ident" id="1465595">wrapped</span>&nbsp;<span class="op" id="1465603">=</span>&nbsp;<span class="builtintype" id="1465605">true</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465616">i</span>&nbsp;<span class="op" id="1465618">=</span>&nbsp;<span class="num" id="1465620">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465626">for</span>&nbsp;<span class="op" id="1465630">;</span>&nbsp;<span class="ident" id="1465632">i</span>&nbsp;<span class="op" id="1465634">&lt;</span>&nbsp;<span class="ident" id="1465636">bucketCnt</span><span class="op" id="1465645">;</span>&nbsp;<span class="ident" id="1465647">i</span><span class="op" id="1465648">++</span>&nbsp;<span class="op" id="1465651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465655">offi</span>&nbsp;<span class="op" id="1465660">:=</span>&nbsp;<span class="op" id="1465663">(</span><span class="ident" id="1465664">i</span>&nbsp;<span class="op" id="1465666">+</span>&nbsp;<span class="ident" id="1465668">it</span><span class="op" id="1465670">.</span><span class="ident" id="1465671">offset</span><span class="op" id="1465677">)</span>&nbsp;<span class="op" id="1465679">&amp;</span>&nbsp;<span class="op" id="1465681">(</span><span class="ident" id="1465682">bucketCnt</span>&nbsp;<span class="op" id="1465692">-</span>&nbsp;<span class="num" id="1465694">1</span><span class="op" id="1465695">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465699">k</span>&nbsp;<span class="op" id="1465701">:=</span>&nbsp;<span class="ident" id="1465704">add</span><span class="op" id="1465707">(</span><span class="ident" id="1465708">unsafe</span><span class="op" id="1465714">.</span><span class="ident" id="1465715">Pointer</span><span class="op" id="1465722">(</span><span class="ident" id="1465723">b</span><span class="op" id="1465724">)</span><span class="op" id="1465725">,</span>&nbsp;<span class="ident" id="1465727">dataOffset</span><span class="op" id="1465737">+</span><span class="builtintype" id="1465738">uintptr</span><span class="op" id="1465745">(</span><span class="ident" id="1465746">offi</span><span class="op" id="1465750">)</span><span class="op" id="1465751">*</span><span class="builtintype" id="1465752">uintptr</span><span class="op" id="1465759">(</span><span class="ident" id="1465760">t</span><span class="op" id="1465761">.</span><span class="ident" id="1465762">keysize</span><span class="op" id="1465769">)</span><span class="op" id="1465770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465774">v</span>&nbsp;<span class="op" id="1465776">:=</span>&nbsp;<span class="ident" id="1465779">add</span><span class="op" id="1465782">(</span><span class="ident" id="1465783">unsafe</span><span class="op" id="1465789">.</span><span class="ident" id="1465790">Pointer</span><span class="op" id="1465797">(</span><span class="ident" id="1465798">b</span><span class="op" id="1465799">)</span><span class="op" id="1465800">,</span>&nbsp;<span class="ident" id="1465802">dataOffset</span><span class="op" id="1465812">+</span><span class="ident" id="1465813">bucketCnt</span><span class="op" id="1465822">*</span><span class="builtintype" id="1465823">uintptr</span><span class="op" id="1465830">(</span><span class="ident" id="1465831">t</span><span class="op" id="1465832">.</span><span class="ident" id="1465833">keysize</span><span class="op" id="1465840">)</span><span class="op" id="1465841">+</span><span class="builtintype" id="1465842">uintptr</span><span class="op" id="1465849">(</span><span class="ident" id="1465850">offi</span><span class="op" id="1465854">)</span><span class="op" id="1465855">*</span><span class="builtintype" id="1465856">uintptr</span><span class="op" id="1465863">(</span><span class="ident" id="1465864">t</span><span class="op" id="1465865">.</span><span class="ident" id="1465866">valuesize</span><span class="op" id="1465875">)</span><span class="op" id="1465876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465880">if</span>&nbsp;<span class="ident" id="1465883">b</span><span class="op" id="1465884">.</span><span class="ident" id="1465885">tophash</span><span class="op" id="1465892">[</span><span class="ident" id="1465893">offi</span><span class="op" id="1465897">]</span>&nbsp;<span class="op" id="1465899">!=</span>&nbsp;<span class="ident" id="1465902">empty</span>&nbsp;<span class="op" id="1465908">&amp;&amp;</span>&nbsp;<span class="ident" id="1465911">b</span><span class="op" id="1465912">.</span><span class="ident" id="1465913">tophash</span><span class="op" id="1465920">[</span><span class="ident" id="1465921">offi</span><span class="op" id="1465925">]</span>&nbsp;<span class="op" id="1465927">!=</span>&nbsp;<span class="ident" id="1465930">evacuatedEmpty</span>&nbsp;<span class="op" id="1465945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465950">if</span>&nbsp;<span class="ident" id="1465953">checkBucket</span>&nbsp;<span class="op" id="1465965">!=</span>&nbsp;<span class="ident" id="1465968">noCheck</span>&nbsp;<span class="op" id="1465976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465982">//&nbsp;Special&nbsp;case:&nbsp;iterator&nbsp;was&nbsp;started&nbsp;during&nbsp;a&nbsp;grow&nbsp;and&nbsp;the</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466046">//&nbsp;grow&nbsp;is&nbsp;not&nbsp;done&nbsp;yet.&nbsp;&nbsp;We&#39;re&nbsp;working&nbsp;on&nbsp;a&nbsp;bucket&nbsp;whose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466108">//&nbsp;oldbucket&nbsp;has&nbsp;not&nbsp;been&nbsp;evacuated&nbsp;yet.&nbsp;&nbsp;Or&nbsp;at&nbsp;least,&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466177">//&nbsp;evacuated&nbsp;when&nbsp;we&nbsp;started&nbsp;the&nbsp;bucket.&nbsp;&nbsp;So&nbsp;we&#39;re&nbsp;iterating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466242">//&nbsp;through&nbsp;the&nbsp;oldbucket,&nbsp;skipping&nbsp;any&nbsp;keys&nbsp;that&nbsp;will&nbsp;go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466303">//&nbsp;to&nbsp;the&nbsp;other&nbsp;new&nbsp;bucket&nbsp;(each&nbsp;oldbucket&nbsp;expands&nbsp;to&nbsp;two</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466365">//&nbsp;buckets&nbsp;during&nbsp;a&nbsp;grow).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466396">k2</span>&nbsp;<span class="op" id="1466399">:=</span>&nbsp;<span class="ident" id="1466402">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466408">if</span>&nbsp;<span class="ident" id="1466411">t</span><span class="op" id="1466412">.</span><span class="ident" id="1466413">indirectkey</span>&nbsp;<span class="op" id="1466425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466432">k2</span>&nbsp;<span class="op" id="1466435">=</span>&nbsp;<span class="op" id="1466437">*</span><span class="op" id="1466438">(</span><span class="op" id="1466439">(</span><span class="op" id="1466440">*</span><span class="ident" id="1466441">unsafe</span><span class="op" id="1466447">.</span><span class="ident" id="1466448">Pointer</span><span class="op" id="1466455">)</span><span class="op" id="1466456">(</span><span class="ident" id="1466457">k2</span><span class="op" id="1466459">)</span><span class="op" id="1466460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466466">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466472">if</span>&nbsp;<span class="ident" id="1466475">alg</span><span class="op" id="1466478">.</span><span class="ident" id="1466479">equal</span><span class="op" id="1466484">(</span><span class="ident" id="1466485">k2</span><span class="op" id="1466487">,</span>&nbsp;<span class="ident" id="1466489">k2</span><span class="op" id="1466491">,</span>&nbsp;<span class="builtintype" id="1466493">uintptr</span><span class="op" id="1466500">(</span><span class="ident" id="1466501">t</span><span class="op" id="1466502">.</span><span class="ident" id="1466503">key</span><span class="op" id="1466506">.</span><span class="ident" id="1466507">size</span><span class="op" id="1466511">)</span><span class="op" id="1466512">)</span>&nbsp;<span class="op" id="1466514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466521">//&nbsp;If&nbsp;the&nbsp;item&nbsp;in&nbsp;the&nbsp;oldbucket&nbsp;is&nbsp;not&nbsp;destined&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466578">//&nbsp;the&nbsp;current&nbsp;new&nbsp;bucket&nbsp;in&nbsp;the&nbsp;iteration,&nbsp;skip&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466636">hash</span>&nbsp;<span class="op" id="1466641">:=</span>&nbsp;<span class="ident" id="1466644">alg</span><span class="op" id="1466647">.</span><span class="ident" id="1466648">hash</span><span class="op" id="1466652">(</span><span class="ident" id="1466653">k2</span><span class="op" id="1466655">,</span>&nbsp;<span class="builtintype" id="1466657">uintptr</span><span class="op" id="1466664">(</span><span class="ident" id="1466665">t</span><span class="op" id="1466666">.</span><span class="ident" id="1466667">key</span><span class="op" id="1466670">.</span><span class="ident" id="1466671">size</span><span class="op" id="1466675">)</span><span class="op" id="1466676">,</span>&nbsp;<span class="builtintype" id="1466678">uintptr</span><span class="op" id="1466685">(</span><span class="ident" id="1466686">h</span><span class="op" id="1466687">.</span><span class="ident" id="1466688">hash0</span><span class="op" id="1466693">)</span><span class="op" id="1466694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466701">if</span>&nbsp;<span class="ident" id="1466704">hash</span><span class="op" id="1466708">&amp;</span><span class="op" id="1466709">(</span><span class="builtintype" id="1466710">uintptr</span><span class="op" id="1466717">(</span><span class="num" id="1466718">1</span><span class="op" id="1466719">)</span><span class="op" id="1466720">&lt;&lt;</span><span class="ident" id="1466722">it</span><span class="op" id="1466724">.</span><span class="ident" id="1466725">B</span><span class="op" id="1466726">-</span><span class="num" id="1466727">1</span><span class="op" id="1466728">)</span>&nbsp;<span class="op" id="1466730">!=</span>&nbsp;<span class="ident" id="1466733">checkBucket</span>&nbsp;<span class="op" id="1466745">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466753">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466773">}</span>&nbsp;<span class="keyword" id="1466775">else</span>&nbsp;<span class="op" id="1466780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466787">//&nbsp;Hash&nbsp;isn&#39;t&nbsp;repeatable&nbsp;if&nbsp;k&nbsp;!=&nbsp;k&nbsp;(NaNs).&nbsp;&nbsp;We&nbsp;need&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466846">//&nbsp;repeatable&nbsp;and&nbsp;randomish&nbsp;choice&nbsp;of&nbsp;which&nbsp;direction</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466905">//&nbsp;to&nbsp;send&nbsp;NaNs&nbsp;during&nbsp;evacuation.&nbsp;&nbsp;We&#39;ll&nbsp;use&nbsp;the&nbsp;low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466964">//&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;to&nbsp;decide&nbsp;which&nbsp;way&nbsp;NaNs&nbsp;go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467016">//&nbsp;NOTE:&nbsp;this&nbsp;case&nbsp;is&nbsp;why&nbsp;we&nbsp;need&nbsp;two&nbsp;evacuate&nbsp;tophash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467076">//&nbsp;values,&nbsp;evacuatedX&nbsp;and&nbsp;evacuatedY,&nbsp;that&nbsp;differ&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467134">//&nbsp;their&nbsp;low&nbsp;bit.</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467157">if</span>&nbsp;<span class="ident" id="1467160">checkBucket</span><span class="op" id="1467171">&gt;&gt;</span><span class="op" id="1467173">(</span><span class="ident" id="1467174">it</span><span class="op" id="1467176">.</span><span class="ident" id="1467177">B</span><span class="op" id="1467178">-</span><span class="num" id="1467179">1</span><span class="op" id="1467180">)</span>&nbsp;<span class="op" id="1467182">!=</span>&nbsp;<span class="builtintype" id="1467185">uintptr</span><span class="op" id="1467192">(</span><span class="ident" id="1467193">b</span><span class="op" id="1467194">.</span><span class="ident" id="1467195">tophash</span><span class="op" id="1467202">[</span><span class="ident" id="1467203">offi</span><span class="op" id="1467207">]</span><span class="op" id="1467208">&amp;</span><span class="num" id="1467209">1</span><span class="op" id="1467210">)</span>&nbsp;<span class="op" id="1467212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467220">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467245">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467250">if</span>&nbsp;<span class="ident" id="1467253">b</span><span class="op" id="1467254">.</span><span class="ident" id="1467255">tophash</span><span class="op" id="1467262">[</span><span class="ident" id="1467263">offi</span><span class="op" id="1467267">]</span>&nbsp;<span class="op" id="1467269">!=</span>&nbsp;<span class="ident" id="1467272">evacuatedX</span>&nbsp;<span class="op" id="1467283">&amp;&amp;</span>&nbsp;<span class="ident" id="1467286">b</span><span class="op" id="1467287">.</span><span class="ident" id="1467288">tophash</span><span class="op" id="1467295">[</span><span class="ident" id="1467296">offi</span><span class="op" id="1467300">]</span>&nbsp;<span class="op" id="1467302">!=</span>&nbsp;<span class="ident" id="1467305">evacuatedY</span>&nbsp;<span class="op" id="1467316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467322">//&nbsp;this&nbsp;is&nbsp;the&nbsp;golden&nbsp;data,&nbsp;we&nbsp;can&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467372">if</span>&nbsp;<span class="ident" id="1467375">t</span><span class="op" id="1467376">.</span><span class="ident" id="1467377">indirectkey</span>&nbsp;<span class="op" id="1467389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467396">k</span>&nbsp;<span class="op" id="1467398">=</span>&nbsp;<span class="op" id="1467400">*</span><span class="op" id="1467401">(</span><span class="op" id="1467402">(</span><span class="op" id="1467403">*</span><span class="ident" id="1467404">unsafe</span><span class="op" id="1467410">.</span><span class="ident" id="1467411">Pointer</span><span class="op" id="1467418">)</span><span class="op" id="1467419">(</span><span class="ident" id="1467420">k</span><span class="op" id="1467421">)</span><span class="op" id="1467422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467428">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467434">it</span><span class="op" id="1467436">.</span><span class="ident" id="1467437">key</span>&nbsp;<span class="op" id="1467441">=</span>&nbsp;<span class="ident" id="1467443">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467449">if</span>&nbsp;<span class="ident" id="1467452">t</span><span class="op" id="1467453">.</span><span class="ident" id="1467454">indirectvalue</span>&nbsp;<span class="op" id="1467468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467475">v</span>&nbsp;<span class="op" id="1467477">=</span>&nbsp;<span class="op" id="1467479">*</span><span class="op" id="1467480">(</span><span class="op" id="1467481">(</span><span class="op" id="1467482">*</span><span class="ident" id="1467483">unsafe</span><span class="op" id="1467489">.</span><span class="ident" id="1467490">Pointer</span><span class="op" id="1467497">)</span><span class="op" id="1467498">(</span><span class="ident" id="1467499">v</span><span class="op" id="1467500">)</span><span class="op" id="1467501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467513">it</span><span class="op" id="1467515">.</span><span class="ident" id="1467516">value</span>&nbsp;<span class="op" id="1467522">=</span>&nbsp;<span class="ident" id="1467524">v</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467529">}</span>&nbsp;<span class="keyword" id="1467531">else</span>&nbsp;<span class="op" id="1467536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467542">//&nbsp;The&nbsp;hash&nbsp;table&nbsp;has&nbsp;grown&nbsp;since&nbsp;the&nbsp;iterator&nbsp;was&nbsp;started.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467606">//&nbsp;The&nbsp;golden&nbsp;data&nbsp;for&nbsp;this&nbsp;key&nbsp;is&nbsp;now&nbsp;somewhere&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467665">k2</span>&nbsp;<span class="op" id="1467668">:=</span>&nbsp;<span class="ident" id="1467671">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467677">if</span>&nbsp;<span class="ident" id="1467680">t</span><span class="op" id="1467681">.</span><span class="ident" id="1467682">indirectkey</span>&nbsp;<span class="op" id="1467694">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1467701">k2</span>&nbsp;<span class="op" id="1467704">=</span>&nbsp;<span class="op" id="1467706">*</span><span class="op" id="1467707">(</span><span class="op" id="1467708">(</span><span class="op" id="1467709">*</span><span class="ident" id="1467710">unsafe</span><span class="op" id="1467716">.</span><span class="ident" id="1467717">Pointer</span><span class="op" id="1467724">)</span><span class="op" id="1467725">(</span><span class="ident" id="1467726">k2</span><span class="op" id="1467728">)</span><span class="op" id="1467729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467741">if</span>&nbsp;<span class="ident" id="1467744">alg</span><span class="op" id="1467747">.</span><span class="ident" id="1467748">equal</span><span class="op" id="1467753">(</span><span class="ident" id="1467754">k2</span><span class="op" id="1467756">,</span>&nbsp;<span class="ident" id="1467758">k2</span><span class="op" id="1467760">,</span>&nbsp;<span class="builtintype" id="1467762">uintptr</span><span class="op" id="1467769">(</span><span class="ident" id="1467770">t</span><span class="op" id="1467771">.</span><span class="ident" id="1467772">key</span><span class="op" id="1467775">.</span><span class="ident" id="1467776">size</span><span class="op" id="1467780">)</span><span class="op" id="1467781">)</span>&nbsp;<span class="op" id="1467783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467790">//&nbsp;Check&nbsp;the&nbsp;current&nbsp;hash&nbsp;table&nbsp;for&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467841">//&nbsp;This&nbsp;code&nbsp;handles&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;key</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467890">//&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;updated,&nbsp;or&nbsp;deleted&nbsp;and&nbsp;reinserted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467952">//&nbsp;NOTE:&nbsp;we&nbsp;need&nbsp;to&nbsp;regrab&nbsp;the&nbsp;key&nbsp;as&nbsp;it&nbsp;has&nbsp;potentially&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1468019">//&nbsp;updated&nbsp;to&nbsp;an&nbsp;equal()&nbsp;but&nbsp;not&nbsp;identical&nbsp;key&nbsp;(e.g.&nbsp;+0.0&nbsp;vs&nbsp;-0.0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468092">rk</span><span class="op" id="1468094">,</span>&nbsp;<span class="ident" id="1468096">rv</span>&nbsp;<span class="op" id="1468099">:=</span>&nbsp;<span class="ident" id="1468102">mapaccessK</span><span class="op" id="1468112">(</span><span class="ident" id="1468113">t</span><span class="op" id="1468114">,</span>&nbsp;<span class="ident" id="1468116">h</span><span class="op" id="1468117">,</span>&nbsp;<span class="ident" id="1468119">k2</span><span class="op" id="1468121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468128">if</span>&nbsp;<span class="ident" id="1468131">rk</span>&nbsp;<span class="op" id="1468134">==</span>&nbsp;<span class="builtintype" id="1468137">nil</span>&nbsp;<span class="op" id="1468141">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468149">continue</span>&nbsp;<span class="comment" id="1468158">//&nbsp;key&nbsp;has&nbsp;been&nbsp;deleted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468194">it</span><span class="op" id="1468196">.</span><span class="ident" id="1468197">key</span>&nbsp;<span class="op" id="1468201">=</span>&nbsp;<span class="ident" id="1468203">rk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468211">it</span><span class="op" id="1468213">.</span><span class="ident" id="1468214">value</span>&nbsp;<span class="op" id="1468220">=</span>&nbsp;<span class="ident" id="1468222">rv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468229">}</span>&nbsp;<span class="keyword" id="1468231">else</span>&nbsp;<span class="op" id="1468236">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1468243">//&nbsp;if&nbsp;key!=key&nbsp;then&nbsp;the&nbsp;entry&nbsp;can&#39;t&nbsp;be&nbsp;deleted&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1468298">//&nbsp;updated,&nbsp;so&nbsp;we&nbsp;can&nbsp;just&nbsp;return&nbsp;it.&nbsp;&nbsp;That&#39;s&nbsp;lucky&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1468359">//&nbsp;us&nbsp;because&nbsp;when&nbsp;key!=key&nbsp;we&nbsp;can&#39;t&nbsp;look&nbsp;it&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1468412">//&nbsp;successfully&nbsp;in&nbsp;the&nbsp;current&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468455">it</span><span class="op" id="1468457">.</span><span class="ident" id="1468458">key</span>&nbsp;<span class="op" id="1468462">=</span>&nbsp;<span class="ident" id="1468464">k2</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468472">if</span>&nbsp;<span class="ident" id="1468475">t</span><span class="op" id="1468476">.</span><span class="ident" id="1468477">indirectvalue</span>&nbsp;<span class="op" id="1468491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468499">v</span>&nbsp;<span class="op" id="1468501">=</span>&nbsp;<span class="op" id="1468503">*</span><span class="op" id="1468504">(</span><span class="op" id="1468505">(</span><span class="op" id="1468506">*</span><span class="ident" id="1468507">unsafe</span><span class="op" id="1468513">.</span><span class="ident" id="1468514">Pointer</span><span class="op" id="1468521">)</span><span class="op" id="1468522">(</span><span class="ident" id="1468523">v</span><span class="op" id="1468524">)</span><span class="op" id="1468525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468539">it</span><span class="op" id="1468541">.</span><span class="ident" id="1468542">value</span>&nbsp;<span class="op" id="1468548">=</span>&nbsp;<span class="ident" id="1468550">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468556">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468566">it</span><span class="op" id="1468568">.</span><span class="ident" id="1468569">bucket</span>&nbsp;<span class="op" id="1468576">=</span>&nbsp;<span class="ident" id="1468578">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468588">it</span><span class="op" id="1468590">.</span><span class="ident" id="1468591">bptr</span>&nbsp;<span class="op" id="1468596">=</span>&nbsp;<span class="ident" id="1468598">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468603">it</span><span class="op" id="1468605">.</span><span class="ident" id="1468606">i</span>&nbsp;<span class="op" id="1468608">=</span>&nbsp;<span class="ident" id="1468610">i</span>&nbsp;<span class="op" id="1468612">+</span>&nbsp;<span class="num" id="1468614">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468619">it</span><span class="op" id="1468621">.</span><span class="ident" id="1468622">checkBucket</span>&nbsp;<span class="op" id="1468634">=</span>&nbsp;<span class="ident" id="1468636">checkBucket</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468651">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468666">b</span>&nbsp;<span class="op" id="1468668">=</span>&nbsp;<span class="ident" id="1468670">b</span><span class="op" id="1468671">.</span><span class="ident" id="1468672">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468682">i</span>&nbsp;<span class="op" id="1468684">=</span>&nbsp;<span class="num" id="1468686">0</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468689">goto</span>&nbsp;<span class="ident" id="1468694">next</span><br>
<span class="lineno"></span><span class="op" id="1468699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1468702">func</span>&nbsp;<span class="ident" id="1468707">hashGrow</span><span class="op" id="1468715">(</span><span class="ident" id="1468716">t</span>&nbsp;<span class="op" id="1468718">*</span><span class="ident" id="1468719">maptype</span><span class="op" id="1468726">,</span>&nbsp;<span class="ident" id="1468728">h</span>&nbsp;<span class="op" id="1468730">*</span><span class="ident" id="1468731">hmap</span><span class="op" id="1468735">)</span>&nbsp;<span class="op" id="1468737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468740">if</span>&nbsp;<span class="ident" id="1468743">h</span><span class="op" id="1468744">.</span><span class="ident" id="1468745">oldbuckets</span>&nbsp;<span class="op" id="1468756">!=</span>&nbsp;<span class="builtintype" id="1468759">nil</span>&nbsp;<span class="op" id="1468763">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468767">gothrow</span><span class="op" id="1468774">(</span><span class="string" id="1468775">&#34;evacuation&nbsp;not&nbsp;done&nbsp;in&nbsp;time&#34;</span><span class="op" id="1468804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468810">oldbuckets</span>&nbsp;<span class="op" id="1468821">:=</span>&nbsp;<span class="ident" id="1468824">h</span><span class="op" id="1468825">.</span><span class="ident" id="1468826">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468835">if</span>&nbsp;<span class="ident" id="1468838">checkgc</span>&nbsp;<span class="op" id="1468846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468850">memstats</span><span class="op" id="1468858">.</span><span class="ident" id="1468859">next_gc</span>&nbsp;<span class="op" id="1468867">=</span>&nbsp;<span class="ident" id="1468869">memstats</span><span class="op" id="1468877">.</span><span class="ident" id="1468878">heap_alloc</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468893">newbuckets</span>&nbsp;<span class="op" id="1468904">:=</span>&nbsp;<span class="ident" id="1468907">newarray</span><span class="op" id="1468915">(</span><span class="ident" id="1468916">t</span><span class="op" id="1468917">.</span><span class="ident" id="1468918">bucket</span><span class="op" id="1468924">,</span>&nbsp;<span class="builtintype" id="1468926">uintptr</span><span class="op" id="1468933">(</span><span class="num" id="1468934">1</span><span class="op" id="1468935">)</span><span class="op" id="1468936">&lt;&lt;</span><span class="op" id="1468938">(</span><span class="ident" id="1468939">h</span><span class="op" id="1468940">.</span><span class="ident" id="1468941">B</span><span class="op" id="1468942">+</span><span class="num" id="1468943">1</span><span class="op" id="1468944">)</span><span class="op" id="1468945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1468948">flags</span>&nbsp;<span class="op" id="1468954">:=</span>&nbsp;<span class="ident" id="1468957">h</span><span class="op" id="1468958">.</span><span class="ident" id="1468959">flags</span>&nbsp;<span class="op" id="1468965">&amp;^</span>&nbsp;<span class="op" id="1468968">(</span><span class="ident" id="1468969">iterator</span>&nbsp;<span class="op" id="1468978">|</span>&nbsp;<span class="ident" id="1468980">oldIterator</span><span class="op" id="1468991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1468994">if</span>&nbsp;<span class="ident" id="1468997">h</span><span class="op" id="1468998">.</span><span class="ident" id="1468999">flags</span><span class="op" id="1469004">&amp;</span><span class="ident" id="1469005">iterator</span>&nbsp;<span class="op" id="1469014">!=</span>&nbsp;<span class="num" id="1469017">0</span>&nbsp;<span class="op" id="1469019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469023">flags</span>&nbsp;<span class="op" id="1469029">|=</span>&nbsp;<span class="ident" id="1469032">oldIterator</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1469045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1469048">//&nbsp;commit&nbsp;the&nbsp;grow&nbsp;(atomic&nbsp;wrt&nbsp;gc)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469084">h</span><span class="op" id="1469085">.</span><span class="ident" id="1469086">B</span><span class="op" id="1469087">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469091">h</span><span class="op" id="1469092">.</span><span class="ident" id="1469093">flags</span>&nbsp;<span class="op" id="1469099">=</span>&nbsp;<span class="ident" id="1469101">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469108">h</span><span class="op" id="1469109">.</span><span class="ident" id="1469110">oldbuckets</span>&nbsp;<span class="op" id="1469121">=</span>&nbsp;<span class="ident" id="1469123">oldbuckets</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469135">h</span><span class="op" id="1469136">.</span><span class="ident" id="1469137">buckets</span>&nbsp;<span class="op" id="1469145">=</span>&nbsp;<span class="ident" id="1469147">newbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469159">h</span><span class="op" id="1469160">.</span><span class="ident" id="1469161">nevacuate</span>&nbsp;<span class="op" id="1469171">=</span>&nbsp;<span class="num" id="1469173">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1469177">//&nbsp;the&nbsp;actual&nbsp;copying&nbsp;of&nbsp;the&nbsp;hash&nbsp;table&nbsp;data&nbsp;is&nbsp;done&nbsp;incrementally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1469245">//&nbsp;by&nbsp;growWork()&nbsp;and&nbsp;evacuate().</span><br>
<span class="lineno">750</span><span class="op" id="1469278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1469281">func</span>&nbsp;<span class="ident" id="1469286">growWork</span><span class="op" id="1469294">(</span><span class="ident" id="1469295">t</span>&nbsp;<span class="op" id="1469297">*</span><span class="ident" id="1469298">maptype</span><span class="op" id="1469305">,</span>&nbsp;<span class="ident" id="1469307">h</span>&nbsp;<span class="op" id="1469309">*</span><span class="ident" id="1469310">hmap</span><span class="op" id="1469314">,</span>&nbsp;<span class="ident" id="1469316">bucket</span>&nbsp;<span class="builtintype" id="1469323">uintptr</span><span class="op" id="1469330">)</span>&nbsp;<span class="op" id="1469332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469335">noldbuckets</span>&nbsp;<span class="op" id="1469347">:=</span>&nbsp;<span class="builtintype" id="1469350">uintptr</span><span class="op" id="1469357">(</span><span class="num" id="1469358">1</span><span class="op" id="1469359">)</span>&nbsp;<span class="op" id="1469361">&lt;&lt;</span>&nbsp;<span class="op" id="1469364">(</span><span class="ident" id="1469365">h</span><span class="op" id="1469366">.</span><span class="ident" id="1469367">B</span>&nbsp;<span class="op" id="1469369">-</span>&nbsp;<span class="num" id="1469371">1</span><span class="op" id="1469372">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1469376">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;evacuate&nbsp;the&nbsp;oldbucket&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1469430">//&nbsp;to&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469467">evacuate</span><span class="op" id="1469475">(</span><span class="ident" id="1469476">t</span><span class="op" id="1469477">,</span>&nbsp;<span class="ident" id="1469479">h</span><span class="op" id="1469480">,</span>&nbsp;<span class="ident" id="1469482">bucket</span><span class="op" id="1469488">&amp;</span><span class="op" id="1469489">(</span><span class="ident" id="1469490">noldbuckets</span><span class="op" id="1469501">-</span><span class="num" id="1469502">1</span><span class="op" id="1469503">)</span><span class="op" id="1469504">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1469508">//&nbsp;evacuate&nbsp;one&nbsp;more&nbsp;oldbucket&nbsp;to&nbsp;make&nbsp;progress&nbsp;on&nbsp;growing</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1469568">if</span>&nbsp;<span class="ident" id="1469571">h</span><span class="op" id="1469572">.</span><span class="ident" id="1469573">oldbuckets</span>&nbsp;<span class="op" id="1469584">!=</span>&nbsp;<span class="builtintype" id="1469587">nil</span>&nbsp;<span class="op" id="1469591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469595">evacuate</span><span class="op" id="1469603">(</span><span class="ident" id="1469604">t</span><span class="op" id="1469605">,</span>&nbsp;<span class="ident" id="1469607">h</span><span class="op" id="1469608">,</span>&nbsp;<span class="ident" id="1469610">h</span><span class="op" id="1469611">.</span><span class="ident" id="1469612">nevacuate</span><span class="op" id="1469621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1469624">}</span><br>
<span class="lineno"></span><span class="op" id="1469626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="1469629">func</span>&nbsp;<span class="ident" id="1469634">evacuate</span><span class="op" id="1469642">(</span><span class="ident" id="1469643">t</span>&nbsp;<span class="op" id="1469645">*</span><span class="ident" id="1469646">maptype</span><span class="op" id="1469653">,</span>&nbsp;<span class="ident" id="1469655">h</span>&nbsp;<span class="op" id="1469657">*</span><span class="ident" id="1469658">hmap</span><span class="op" id="1469662">,</span>&nbsp;<span class="ident" id="1469664">oldbucket</span>&nbsp;<span class="builtintype" id="1469674">uintptr</span><span class="op" id="1469681">)</span>&nbsp;<span class="op" id="1469683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469686">b</span>&nbsp;<span class="op" id="1469688">:=</span>&nbsp;<span class="op" id="1469691">(</span><span class="op" id="1469692">*</span><span class="ident" id="1469693">bmap</span><span class="op" id="1469697">)</span><span class="op" id="1469698">(</span><span class="ident" id="1469699">add</span><span class="op" id="1469702">(</span><span class="ident" id="1469703">h</span><span class="op" id="1469704">.</span><span class="ident" id="1469705">oldbuckets</span><span class="op" id="1469715">,</span>&nbsp;<span class="ident" id="1469717">oldbucket</span><span class="op" id="1469726">*</span><span class="builtintype" id="1469727">uintptr</span><span class="op" id="1469734">(</span><span class="ident" id="1469735">t</span><span class="op" id="1469736">.</span><span class="ident" id="1469737">bucketsize</span><span class="op" id="1469747">)</span><span class="op" id="1469748">)</span><span class="op" id="1469749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469752">newbit</span>&nbsp;<span class="op" id="1469759">:=</span>&nbsp;<span class="builtintype" id="1469762">uintptr</span><span class="op" id="1469769">(</span><span class="num" id="1469770">1</span><span class="op" id="1469771">)</span>&nbsp;<span class="op" id="1469773">&lt;&lt;</span>&nbsp;<span class="op" id="1469776">(</span><span class="ident" id="1469777">h</span><span class="op" id="1469778">.</span><span class="ident" id="1469779">B</span>&nbsp;<span class="op" id="1469781">-</span>&nbsp;<span class="num" id="1469783">1</span><span class="op" id="1469784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469787">alg</span>&nbsp;<span class="op" id="1469791">:=</span>&nbsp;<span class="ident" id="1469794">goalg</span><span class="op" id="1469799">(</span><span class="ident" id="1469800">t</span><span class="op" id="1469801">.</span><span class="ident" id="1469802">key</span><span class="op" id="1469805">.</span><span class="ident" id="1469806">alg</span><span class="op" id="1469809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1469812">if</span>&nbsp;<span class="op" id="1469815">!</span><span class="ident" id="1469816">evacuated</span><span class="op" id="1469825">(</span><span class="ident" id="1469826">b</span><span class="op" id="1469827">)</span>&nbsp;<span class="op" id="1469829">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1469833">//&nbsp;TODO:&nbsp;reuse&nbsp;overflow&nbsp;buckets&nbsp;instead&nbsp;of&nbsp;using&nbsp;new&nbsp;ones,&nbsp;if&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1469903">//&nbsp;is&nbsp;no&nbsp;iterator&nbsp;using&nbsp;the&nbsp;old&nbsp;buckets.&nbsp;&nbsp;(If&nbsp;!oldIterator.)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1469967">x</span>&nbsp;<span class="op" id="1469969">:=</span>&nbsp;<span class="op" id="1469972">(</span><span class="op" id="1469973">*</span><span class="ident" id="1469974">bmap</span><span class="op" id="1469978">)</span><span class="op" id="1469979">(</span><span class="ident" id="1469980">add</span><span class="op" id="1469983">(</span><span class="ident" id="1469984">h</span><span class="op" id="1469985">.</span><span class="ident" id="1469986">buckets</span><span class="op" id="1469993">,</span>&nbsp;<span class="ident" id="1469995">oldbucket</span><span class="op" id="1470004">*</span><span class="builtintype" id="1470005">uintptr</span><span class="op" id="1470012">(</span><span class="ident" id="1470013">t</span><span class="op" id="1470014">.</span><span class="ident" id="1470015">bucketsize</span><span class="op" id="1470025">)</span><span class="op" id="1470026">)</span><span class="op" id="1470027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470031">y</span>&nbsp;<span class="op" id="1470033">:=</span>&nbsp;<span class="op" id="1470036">(</span><span class="op" id="1470037">*</span><span class="ident" id="1470038">bmap</span><span class="op" id="1470042">)</span><span class="op" id="1470043">(</span><span class="ident" id="1470044">add</span><span class="op" id="1470047">(</span><span class="ident" id="1470048">h</span><span class="op" id="1470049">.</span><span class="ident" id="1470050">buckets</span><span class="op" id="1470057">,</span>&nbsp;<span class="op" id="1470059">(</span><span class="ident" id="1470060">oldbucket</span><span class="op" id="1470069">+</span><span class="ident" id="1470070">newbit</span><span class="op" id="1470076">)</span><span class="op" id="1470077">*</span><span class="builtintype" id="1470078">uintptr</span><span class="op" id="1470085">(</span><span class="ident" id="1470086">t</span><span class="op" id="1470087">.</span><span class="ident" id="1470088">bucketsize</span><span class="op" id="1470098">)</span><span class="op" id="1470099">)</span><span class="op" id="1470100">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470104">xi</span>&nbsp;<span class="op" id="1470107">:=</span>&nbsp;<span class="num" id="1470110">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470114">yi</span>&nbsp;<span class="op" id="1470117">:=</span>&nbsp;<span class="num" id="1470120">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470124">xk</span>&nbsp;<span class="op" id="1470127">:=</span>&nbsp;<span class="ident" id="1470130">add</span><span class="op" id="1470133">(</span><span class="ident" id="1470134">unsafe</span><span class="op" id="1470140">.</span><span class="ident" id="1470141">Pointer</span><span class="op" id="1470148">(</span><span class="ident" id="1470149">x</span><span class="op" id="1470150">)</span><span class="op" id="1470151">,</span>&nbsp;<span class="ident" id="1470153">dataOffset</span><span class="op" id="1470163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470167">yk</span>&nbsp;<span class="op" id="1470170">:=</span>&nbsp;<span class="ident" id="1470173">add</span><span class="op" id="1470176">(</span><span class="ident" id="1470177">unsafe</span><span class="op" id="1470183">.</span><span class="ident" id="1470184">Pointer</span><span class="op" id="1470191">(</span><span class="ident" id="1470192">y</span><span class="op" id="1470193">)</span><span class="op" id="1470194">,</span>&nbsp;<span class="ident" id="1470196">dataOffset</span><span class="op" id="1470206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470210">xv</span>&nbsp;<span class="op" id="1470213">:=</span>&nbsp;<span class="ident" id="1470216">add</span><span class="op" id="1470219">(</span><span class="ident" id="1470220">xk</span><span class="op" id="1470222">,</span>&nbsp;<span class="ident" id="1470224">bucketCnt</span><span class="op" id="1470233">*</span><span class="builtintype" id="1470234">uintptr</span><span class="op" id="1470241">(</span><span class="ident" id="1470242">t</span><span class="op" id="1470243">.</span><span class="ident" id="1470244">keysize</span><span class="op" id="1470251">)</span><span class="op" id="1470252">)</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470256">yv</span>&nbsp;<span class="op" id="1470259">:=</span>&nbsp;<span class="ident" id="1470262">add</span><span class="op" id="1470265">(</span><span class="ident" id="1470266">yk</span><span class="op" id="1470268">,</span>&nbsp;<span class="ident" id="1470270">bucketCnt</span><span class="op" id="1470279">*</span><span class="builtintype" id="1470280">uintptr</span><span class="op" id="1470287">(</span><span class="ident" id="1470288">t</span><span class="op" id="1470289">.</span><span class="ident" id="1470290">keysize</span><span class="op" id="1470297">)</span><span class="op" id="1470298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470302">for</span>&nbsp;<span class="op" id="1470306">;</span>&nbsp;<span class="ident" id="1470308">b</span>&nbsp;<span class="op" id="1470310">!=</span>&nbsp;<span class="builtintype" id="1470313">nil</span><span class="op" id="1470316">;</span>&nbsp;<span class="ident" id="1470318">b</span>&nbsp;<span class="op" id="1470320">=</span>&nbsp;<span class="ident" id="1470322">b</span><span class="op" id="1470323">.</span><span class="ident" id="1470324">overflow</span>&nbsp;<span class="op" id="1470333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470338">k</span>&nbsp;<span class="op" id="1470340">:=</span>&nbsp;<span class="ident" id="1470343">add</span><span class="op" id="1470346">(</span><span class="ident" id="1470347">unsafe</span><span class="op" id="1470353">.</span><span class="ident" id="1470354">Pointer</span><span class="op" id="1470361">(</span><span class="ident" id="1470362">b</span><span class="op" id="1470363">)</span><span class="op" id="1470364">,</span>&nbsp;<span class="ident" id="1470366">dataOffset</span><span class="op" id="1470376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470381">v</span>&nbsp;<span class="op" id="1470383">:=</span>&nbsp;<span class="ident" id="1470386">add</span><span class="op" id="1470389">(</span><span class="ident" id="1470390">k</span><span class="op" id="1470391">,</span>&nbsp;<span class="ident" id="1470393">bucketCnt</span><span class="op" id="1470402">*</span><span class="builtintype" id="1470403">uintptr</span><span class="op" id="1470410">(</span><span class="ident" id="1470411">t</span><span class="op" id="1470412">.</span><span class="ident" id="1470413">keysize</span><span class="op" id="1470420">)</span><span class="op" id="1470421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470426">for</span>&nbsp;<span class="ident" id="1470430">i</span>&nbsp;<span class="op" id="1470432">:=</span>&nbsp;<span class="num" id="1470435">0</span><span class="op" id="1470436">;</span>&nbsp;<span class="ident" id="1470438">i</span>&nbsp;<span class="op" id="1470440">&lt;</span>&nbsp;<span class="ident" id="1470442">bucketCnt</span><span class="op" id="1470451">;</span>&nbsp;<span class="ident" id="1470453">i</span><span class="op" id="1470454">,</span>&nbsp;<span class="ident" id="1470456">k</span><span class="op" id="1470457">,</span>&nbsp;<span class="ident" id="1470459">v</span>&nbsp;<span class="op" id="1470461">=</span>&nbsp;<span class="ident" id="1470463">i</span><span class="op" id="1470464">+</span><span class="num" id="1470465">1</span><span class="op" id="1470466">,</span>&nbsp;<span class="ident" id="1470468">add</span><span class="op" id="1470471">(</span><span class="ident" id="1470472">k</span><span class="op" id="1470473">,</span>&nbsp;<span class="builtintype" id="1470475">uintptr</span><span class="op" id="1470482">(</span><span class="ident" id="1470483">t</span><span class="op" id="1470484">.</span><span class="ident" id="1470485">keysize</span><span class="op" id="1470492">)</span><span class="op" id="1470493">)</span><span class="op" id="1470494">,</span>&nbsp;<span class="ident" id="1470496">add</span><span class="op" id="1470499">(</span><span class="ident" id="1470500">v</span><span class="op" id="1470501">,</span>&nbsp;<span class="builtintype" id="1470503">uintptr</span><span class="op" id="1470510">(</span><span class="ident" id="1470511">t</span><span class="op" id="1470512">.</span><span class="ident" id="1470513">valuesize</span><span class="op" id="1470522">)</span><span class="op" id="1470523">)</span>&nbsp;<span class="op" id="1470525">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470531">top</span>&nbsp;<span class="op" id="1470535">:=</span>&nbsp;<span class="ident" id="1470538">b</span><span class="op" id="1470539">.</span><span class="ident" id="1470540">tophash</span><span class="op" id="1470547">[</span><span class="ident" id="1470548">i</span><span class="op" id="1470549">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470555">if</span>&nbsp;<span class="ident" id="1470558">top</span>&nbsp;<span class="op" id="1470562">==</span>&nbsp;<span class="ident" id="1470565">empty</span>&nbsp;<span class="op" id="1470571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470578">b</span><span class="op" id="1470579">.</span><span class="ident" id="1470580">tophash</span><span class="op" id="1470587">[</span><span class="ident" id="1470588">i</span><span class="op" id="1470589">]</span>&nbsp;<span class="op" id="1470591">=</span>&nbsp;<span class="ident" id="1470593">evacuatedEmpty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470613">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1470626">}</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470632">if</span>&nbsp;<span class="ident" id="1470635">top</span>&nbsp;<span class="op" id="1470639">&lt;</span>&nbsp;<span class="ident" id="1470641">minTopHash</span>&nbsp;<span class="op" id="1470652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470659">gothrow</span><span class="op" id="1470666">(</span><span class="string" id="1470667">&#34;bad&nbsp;map&nbsp;state&#34;</span><span class="op" id="1470682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1470688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470694">k2</span>&nbsp;<span class="op" id="1470697">:=</span>&nbsp;<span class="ident" id="1470700">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470706">if</span>&nbsp;<span class="ident" id="1470709">t</span><span class="op" id="1470710">.</span><span class="ident" id="1470711">indirectkey</span>&nbsp;<span class="op" id="1470723">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470730">k2</span>&nbsp;<span class="op" id="1470733">=</span>&nbsp;<span class="op" id="1470735">*</span><span class="op" id="1470736">(</span><span class="op" id="1470737">(</span><span class="op" id="1470738">*</span><span class="ident" id="1470739">unsafe</span><span class="op" id="1470745">.</span><span class="ident" id="1470746">Pointer</span><span class="op" id="1470753">)</span><span class="op" id="1470754">(</span><span class="ident" id="1470755">k2</span><span class="op" id="1470757">)</span><span class="op" id="1470758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1470764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1470770">//&nbsp;Compute&nbsp;hash&nbsp;to&nbsp;make&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;(whether&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1470839">//&nbsp;to&nbsp;send&nbsp;this&nbsp;key/value&nbsp;to&nbsp;bucket&nbsp;x&nbsp;or&nbsp;bucket&nbsp;y).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470895">hash</span>&nbsp;<span class="op" id="1470900">:=</span>&nbsp;<span class="ident" id="1470903">alg</span><span class="op" id="1470906">.</span><span class="ident" id="1470907">hash</span><span class="op" id="1470911">(</span><span class="ident" id="1470912">k2</span><span class="op" id="1470914">,</span>&nbsp;<span class="builtintype" id="1470916">uintptr</span><span class="op" id="1470923">(</span><span class="ident" id="1470924">t</span><span class="op" id="1470925">.</span><span class="ident" id="1470926">key</span><span class="op" id="1470929">.</span><span class="ident" id="1470930">size</span><span class="op" id="1470934">)</span><span class="op" id="1470935">,</span>&nbsp;<span class="builtintype" id="1470937">uintptr</span><span class="op" id="1470944">(</span><span class="ident" id="1470945">h</span><span class="op" id="1470946">.</span><span class="ident" id="1470947">hash0</span><span class="op" id="1470952">)</span><span class="op" id="1470953">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470959">if</span>&nbsp;<span class="ident" id="1470962">h</span><span class="op" id="1470963">.</span><span class="ident" id="1470964">flags</span><span class="op" id="1470969">&amp;</span><span class="ident" id="1470970">iterator</span>&nbsp;<span class="op" id="1470979">!=</span>&nbsp;<span class="num" id="1470982">0</span>&nbsp;<span class="op" id="1470984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1470991">if</span>&nbsp;<span class="op" id="1470994">!</span><span class="ident" id="1470995">alg</span><span class="op" id="1470998">.</span><span class="ident" id="1470999">equal</span><span class="op" id="1471004">(</span><span class="ident" id="1471005">k2</span><span class="op" id="1471007">,</span>&nbsp;<span class="ident" id="1471009">k2</span><span class="op" id="1471011">,</span>&nbsp;<span class="builtintype" id="1471013">uintptr</span><span class="op" id="1471020">(</span><span class="ident" id="1471021">t</span><span class="op" id="1471022">.</span><span class="ident" id="1471023">key</span><span class="op" id="1471026">.</span><span class="ident" id="1471027">size</span><span class="op" id="1471031">)</span><span class="op" id="1471032">)</span>&nbsp;<span class="op" id="1471034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471042">//&nbsp;If&nbsp;key&nbsp;!=&nbsp;key&nbsp;(NaNs),&nbsp;then&nbsp;the&nbsp;hash&nbsp;could&nbsp;be&nbsp;(and&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471110">//&nbsp;will&nbsp;be)&nbsp;entirely&nbsp;different&nbsp;from&nbsp;the&nbsp;old&nbsp;hash.&nbsp;&nbsp;Moreover,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471177">//&nbsp;it&nbsp;isn&#39;t&nbsp;reproducible.&nbsp;&nbsp;Reproducibility&nbsp;is&nbsp;required&nbsp;in&nbsp;the</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471245">//&nbsp;presence&nbsp;of&nbsp;iterators,&nbsp;as&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471309">//&nbsp;match&nbsp;whatever&nbsp;decision&nbsp;the&nbsp;iterator&nbsp;made.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471361">//&nbsp;Fortunately,&nbsp;we&nbsp;have&nbsp;the&nbsp;freedom&nbsp;to&nbsp;send&nbsp;these&nbsp;keys&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471429">//&nbsp;way.&nbsp;&nbsp;Also,&nbsp;tophash&nbsp;is&nbsp;meaningless&nbsp;for&nbsp;these&nbsp;kinds&nbsp;of&nbsp;keys.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471498">//&nbsp;We&nbsp;let&nbsp;the&nbsp;low&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;drive&nbsp;the&nbsp;evacuation&nbsp;decision.</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471568">//&nbsp;We&nbsp;recompute&nbsp;a&nbsp;new&nbsp;random&nbsp;tophash&nbsp;for&nbsp;the&nbsp;next&nbsp;level&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471633">//&nbsp;these&nbsp;keys&nbsp;will&nbsp;get&nbsp;evenly&nbsp;distributed&nbsp;across&nbsp;all&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471700">//&nbsp;after&nbsp;multiple&nbsp;grows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471731">if</span>&nbsp;<span class="op" id="1471734">(</span><span class="ident" id="1471735">top</span>&nbsp;<span class="op" id="1471739">&amp;</span>&nbsp;<span class="num" id="1471741">1</span><span class="op" id="1471742">)</span>&nbsp;<span class="op" id="1471744">!=</span>&nbsp;<span class="num" id="1471747">0</span>&nbsp;<span class="op" id="1471749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471758">hash</span>&nbsp;<span class="op" id="1471763">|=</span>&nbsp;<span class="ident" id="1471766">newbit</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471779">}</span>&nbsp;<span class="keyword" id="1471781">else</span>&nbsp;<span class="op" id="1471786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471795">hash</span>&nbsp;<span class="op" id="1471800">&amp;^=</span>&nbsp;<span class="ident" id="1471804">newbit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471825">top</span>&nbsp;<span class="op" id="1471829">=</span>&nbsp;<span class="builtintype" id="1471831">uint8</span><span class="op" id="1471836">(</span><span class="ident" id="1471837">hash</span>&nbsp;<span class="op" id="1471842">&gt;&gt;</span>&nbsp;<span class="op" id="1471845">(</span><span class="ident" id="1471846">ptrSize</span><span class="op" id="1471853">*</span><span class="num" id="1471854">8</span>&nbsp;<span class="op" id="1471856">-</span>&nbsp;<span class="num" id="1471858">8</span><span class="op" id="1471859">)</span><span class="op" id="1471860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471868">if</span>&nbsp;<span class="ident" id="1471871">top</span>&nbsp;<span class="op" id="1471875">&lt;</span>&nbsp;<span class="ident" id="1471877">minTopHash</span>&nbsp;<span class="op" id="1471888">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471897">top</span>&nbsp;<span class="op" id="1471901">+=</span>&nbsp;<span class="ident" id="1471904">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1471940">if</span>&nbsp;<span class="op" id="1471943">(</span><span class="ident" id="1471944">hash</span>&nbsp;<span class="op" id="1471949">&amp;</span>&nbsp;<span class="ident" id="1471951">newbit</span><span class="op" id="1471957">)</span>&nbsp;<span class="op" id="1471959">==</span>&nbsp;<span class="num" id="1471962">0</span>&nbsp;<span class="op" id="1471964">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471971">b</span><span class="op" id="1471972">.</span><span class="ident" id="1471973">tophash</span><span class="op" id="1471980">[</span><span class="ident" id="1471981">i</span><span class="op" id="1471982">]</span>&nbsp;<span class="op" id="1471984">=</span>&nbsp;<span class="ident" id="1471986">evacuatedX</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472002">if</span>&nbsp;<span class="ident" id="1472005">xi</span>&nbsp;<span class="op" id="1472008">==</span>&nbsp;<span class="ident" id="1472011">bucketCnt</span>&nbsp;<span class="op" id="1472021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472029">if</span>&nbsp;<span class="ident" id="1472032">checkgc</span>&nbsp;<span class="op" id="1472040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472049">memstats</span><span class="op" id="1472057">.</span><span class="ident" id="1472058">next_gc</span>&nbsp;<span class="op" id="1472066">=</span>&nbsp;<span class="ident" id="1472068">memstats</span><span class="op" id="1472076">.</span><span class="ident" id="1472077">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472094">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472102">newx</span>&nbsp;<span class="op" id="1472107">:=</span>&nbsp;<span class="op" id="1472110">(</span><span class="op" id="1472111">*</span><span class="ident" id="1472112">bmap</span><span class="op" id="1472116">)</span><span class="op" id="1472117">(</span><span class="ident" id="1472118">newobject</span><span class="op" id="1472127">(</span><span class="ident" id="1472128">t</span><span class="op" id="1472129">.</span><span class="ident" id="1472130">bucket</span><span class="op" id="1472136">)</span><span class="op" id="1472137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472145">x</span><span class="op" id="1472146">.</span><span class="ident" id="1472147">overflow</span>&nbsp;<span class="op" id="1472156">=</span>&nbsp;<span class="ident" id="1472158">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472169">x</span>&nbsp;<span class="op" id="1472171">=</span>&nbsp;<span class="ident" id="1472173">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472184">xi</span>&nbsp;<span class="op" id="1472187">=</span>&nbsp;<span class="num" id="1472189">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472197">xk</span>&nbsp;<span class="op" id="1472200">=</span>&nbsp;<span class="ident" id="1472202">add</span><span class="op" id="1472205">(</span><span class="ident" id="1472206">unsafe</span><span class="op" id="1472212">.</span><span class="ident" id="1472213">Pointer</span><span class="op" id="1472220">(</span><span class="ident" id="1472221">x</span><span class="op" id="1472222">)</span><span class="op" id="1472223">,</span>&nbsp;<span class="ident" id="1472225">dataOffset</span><span class="op" id="1472235">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472243">xv</span>&nbsp;<span class="op" id="1472246">=</span>&nbsp;<span class="ident" id="1472248">add</span><span class="op" id="1472251">(</span><span class="ident" id="1472252">xk</span><span class="op" id="1472254">,</span>&nbsp;<span class="ident" id="1472256">bucketCnt</span><span class="op" id="1472265">*</span><span class="builtintype" id="1472266">uintptr</span><span class="op" id="1472273">(</span><span class="ident" id="1472274">t</span><span class="op" id="1472275">.</span><span class="ident" id="1472276">keysize</span><span class="op" id="1472283">)</span><span class="op" id="1472284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472298">x</span><span class="op" id="1472299">.</span><span class="ident" id="1472300">tophash</span><span class="op" id="1472307">[</span><span class="ident" id="1472308">xi</span><span class="op" id="1472310">]</span>&nbsp;<span class="op" id="1472312">=</span>&nbsp;<span class="ident" id="1472314">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472323">if</span>&nbsp;<span class="ident" id="1472326">t</span><span class="op" id="1472327">.</span><span class="ident" id="1472328">indirectkey</span>&nbsp;<span class="op" id="1472340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472348">*</span><span class="op" id="1472349">(</span><span class="op" id="1472350">*</span><span class="ident" id="1472351">unsafe</span><span class="op" id="1472357">.</span><span class="ident" id="1472358">Pointer</span><span class="op" id="1472365">)</span><span class="op" id="1472366">(</span><span class="ident" id="1472367">xk</span><span class="op" id="1472369">)</span>&nbsp;<span class="op" id="1472371">=</span>&nbsp;<span class="ident" id="1472373">k2</span>&nbsp;<span class="comment" id="1472376">//&nbsp;copy&nbsp;pointer</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472397">}</span>&nbsp;<span class="keyword" id="1472399">else</span>&nbsp;<span class="op" id="1472404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472412">memmove</span><span class="op" id="1472419">(</span><span class="ident" id="1472420">xk</span><span class="op" id="1472422">,</span>&nbsp;<span class="ident" id="1472424">k</span><span class="op" id="1472425">,</span>&nbsp;<span class="builtintype" id="1472427">uintptr</span><span class="op" id="1472434">(</span><span class="ident" id="1472435">t</span><span class="op" id="1472436">.</span><span class="ident" id="1472437">key</span><span class="op" id="1472440">.</span><span class="ident" id="1472441">size</span><span class="op" id="1472445">)</span><span class="op" id="1472446">)</span>&nbsp;<span class="comment" id="1472448">//&nbsp;copy&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472474">if</span>&nbsp;<span class="ident" id="1472477">t</span><span class="op" id="1472478">.</span><span class="ident" id="1472479">indirectvalue</span>&nbsp;<span class="op" id="1472493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472501">*</span><span class="op" id="1472502">(</span><span class="op" id="1472503">*</span><span class="ident" id="1472504">unsafe</span><span class="op" id="1472510">.</span><span class="ident" id="1472511">Pointer</span><span class="op" id="1472518">)</span><span class="op" id="1472519">(</span><span class="ident" id="1472520">xv</span><span class="op" id="1472522">)</span>&nbsp;<span class="op" id="1472524">=</span>&nbsp;<span class="op" id="1472526">*</span><span class="op" id="1472527">(</span><span class="op" id="1472528">*</span><span class="ident" id="1472529">unsafe</span><span class="op" id="1472535">.</span><span class="ident" id="1472536">Pointer</span><span class="op" id="1472543">)</span><span class="op" id="1472544">(</span><span class="ident" id="1472545">v</span><span class="op" id="1472546">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472553">}</span>&nbsp;<span class="keyword" id="1472555">else</span>&nbsp;<span class="op" id="1472560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472568">memmove</span><span class="op" id="1472575">(</span><span class="ident" id="1472576">xv</span><span class="op" id="1472578">,</span>&nbsp;<span class="ident" id="1472580">v</span><span class="op" id="1472581">,</span>&nbsp;<span class="builtintype" id="1472583">uintptr</span><span class="op" id="1472590">(</span><span class="ident" id="1472591">t</span><span class="op" id="1472592">.</span><span class="ident" id="1472593">elem</span><span class="op" id="1472597">.</span><span class="ident" id="1472598">size</span><span class="op" id="1472602">)</span><span class="op" id="1472603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472617">xi</span><span class="op" id="1472619">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472627">xk</span>&nbsp;<span class="op" id="1472630">=</span>&nbsp;<span class="ident" id="1472632">add</span><span class="op" id="1472635">(</span><span class="ident" id="1472636">xk</span><span class="op" id="1472638">,</span>&nbsp;<span class="builtintype" id="1472640">uintptr</span><span class="op" id="1472647">(</span><span class="ident" id="1472648">t</span><span class="op" id="1472649">.</span><span class="ident" id="1472650">keysize</span><span class="op" id="1472657">)</span><span class="op" id="1472658">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472665">xv</span>&nbsp;<span class="op" id="1472668">=</span>&nbsp;<span class="ident" id="1472670">add</span><span class="op" id="1472673">(</span><span class="ident" id="1472674">xv</span><span class="op" id="1472676">,</span>&nbsp;<span class="builtintype" id="1472678">uintptr</span><span class="op" id="1472685">(</span><span class="ident" id="1472686">t</span><span class="op" id="1472687">.</span><span class="ident" id="1472688">valuesize</span><span class="op" id="1472697">)</span><span class="op" id="1472698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472704">}</span>&nbsp;<span class="keyword" id="1472706">else</span>&nbsp;<span class="op" id="1472711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472718">b</span><span class="op" id="1472719">.</span><span class="ident" id="1472720">tophash</span><span class="op" id="1472727">[</span><span class="ident" id="1472728">i</span><span class="op" id="1472729">]</span>&nbsp;<span class="op" id="1472731">=</span>&nbsp;<span class="ident" id="1472733">evacuatedY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472749">if</span>&nbsp;<span class="ident" id="1472752">yi</span>&nbsp;<span class="op" id="1472755">==</span>&nbsp;<span class="ident" id="1472758">bucketCnt</span>&nbsp;<span class="op" id="1472768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472776">if</span>&nbsp;<span class="ident" id="1472779">checkgc</span>&nbsp;<span class="op" id="1472787">{</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472796">memstats</span><span class="op" id="1472804">.</span><span class="ident" id="1472805">next_gc</span>&nbsp;<span class="op" id="1472813">=</span>&nbsp;<span class="ident" id="1472815">memstats</span><span class="op" id="1472823">.</span><span class="ident" id="1472824">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472849">newy</span>&nbsp;<span class="op" id="1472854">:=</span>&nbsp;<span class="op" id="1472857">(</span><span class="op" id="1472858">*</span><span class="ident" id="1472859">bmap</span><span class="op" id="1472863">)</span><span class="op" id="1472864">(</span><span class="ident" id="1472865">newobject</span><span class="op" id="1472874">(</span><span class="ident" id="1472875">t</span><span class="op" id="1472876">.</span><span class="ident" id="1472877">bucket</span><span class="op" id="1472883">)</span><span class="op" id="1472884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472892">y</span><span class="op" id="1472893">.</span><span class="ident" id="1472894">overflow</span>&nbsp;<span class="op" id="1472903">=</span>&nbsp;<span class="ident" id="1472905">newy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472916">y</span>&nbsp;<span class="op" id="1472918">=</span>&nbsp;<span class="ident" id="1472920">newy</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472931">yi</span>&nbsp;<span class="op" id="1472934">=</span>&nbsp;<span class="num" id="1472936">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472944">yk</span>&nbsp;<span class="op" id="1472947">=</span>&nbsp;<span class="ident" id="1472949">add</span><span class="op" id="1472952">(</span><span class="ident" id="1472953">unsafe</span><span class="op" id="1472959">.</span><span class="ident" id="1472960">Pointer</span><span class="op" id="1472967">(</span><span class="ident" id="1472968">y</span><span class="op" id="1472969">)</span><span class="op" id="1472970">,</span>&nbsp;<span class="ident" id="1472972">dataOffset</span><span class="op" id="1472982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472990">yv</span>&nbsp;<span class="op" id="1472993">=</span>&nbsp;<span class="ident" id="1472995">add</span><span class="op" id="1472998">(</span><span class="ident" id="1472999">yk</span><span class="op" id="1473001">,</span>&nbsp;<span class="ident" id="1473003">bucketCnt</span><span class="op" id="1473012">*</span><span class="builtintype" id="1473013">uintptr</span><span class="op" id="1473020">(</span><span class="ident" id="1473021">t</span><span class="op" id="1473022">.</span><span class="ident" id="1473023">keysize</span><span class="op" id="1473030">)</span><span class="op" id="1473031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473045">y</span><span class="op" id="1473046">.</span><span class="ident" id="1473047">tophash</span><span class="op" id="1473054">[</span><span class="ident" id="1473055">yi</span><span class="op" id="1473057">]</span>&nbsp;<span class="op" id="1473059">=</span>&nbsp;<span class="ident" id="1473061">top</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1473070">if</span>&nbsp;<span class="ident" id="1473073">t</span><span class="op" id="1473074">.</span><span class="ident" id="1473075">indirectkey</span>&nbsp;<span class="op" id="1473087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473095">*</span><span class="op" id="1473096">(</span><span class="op" id="1473097">*</span><span class="ident" id="1473098">unsafe</span><span class="op" id="1473104">.</span><span class="ident" id="1473105">Pointer</span><span class="op" id="1473112">)</span><span class="op" id="1473113">(</span><span class="ident" id="1473114">yk</span><span class="op" id="1473116">)</span>&nbsp;<span class="op" id="1473118">=</span>&nbsp;<span class="ident" id="1473120">k2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473128">}</span>&nbsp;<span class="keyword" id="1473130">else</span>&nbsp;<span class="op" id="1473135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473143">memmove</span><span class="op" id="1473150">(</span><span class="ident" id="1473151">yk</span><span class="op" id="1473153">,</span>&nbsp;<span class="ident" id="1473155">k</span><span class="op" id="1473156">,</span>&nbsp;<span class="builtintype" id="1473158">uintptr</span><span class="op" id="1473165">(</span><span class="ident" id="1473166">t</span><span class="op" id="1473167">.</span><span class="ident" id="1473168">key</span><span class="op" id="1473171">.</span><span class="ident" id="1473172">size</span><span class="op" id="1473176">)</span><span class="op" id="1473177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473184">}</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1473191">if</span>&nbsp;<span class="ident" id="1473194">t</span><span class="op" id="1473195">.</span><span class="ident" id="1473196">indirectvalue</span>&nbsp;<span class="op" id="1473210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473218">*</span><span class="op" id="1473219">(</span><span class="op" id="1473220">*</span><span class="ident" id="1473221">unsafe</span><span class="op" id="1473227">.</span><span class="ident" id="1473228">Pointer</span><span class="op" id="1473235">)</span><span class="op" id="1473236">(</span><span class="ident" id="1473237">yv</span><span class="op" id="1473239">)</span>&nbsp;<span class="op" id="1473241">=</span>&nbsp;<span class="op" id="1473243">*</span><span class="op" id="1473244">(</span><span class="op" id="1473245">*</span><span class="ident" id="1473246">unsafe</span><span class="op" id="1473252">.</span><span class="ident" id="1473253">Pointer</span><span class="op" id="1473260">)</span><span class="op" id="1473261">(</span><span class="ident" id="1473262">v</span><span class="op" id="1473263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473270">}</span>&nbsp;<span class="keyword" id="1473272">else</span>&nbsp;<span class="op" id="1473277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473285">memmove</span><span class="op" id="1473292">(</span><span class="ident" id="1473293">yv</span><span class="op" id="1473295">,</span>&nbsp;<span class="ident" id="1473297">v</span><span class="op" id="1473298">,</span>&nbsp;<span class="builtintype" id="1473300">uintptr</span><span class="op" id="1473307">(</span><span class="ident" id="1473308">t</span><span class="op" id="1473309">.</span><span class="ident" id="1473310">elem</span><span class="op" id="1473314">.</span><span class="ident" id="1473315">size</span><span class="op" id="1473319">)</span><span class="op" id="1473320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473327">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473334">yi</span><span class="op" id="1473336">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473344">yk</span>&nbsp;<span class="op" id="1473347">=</span>&nbsp;<span class="ident" id="1473349">add</span><span class="op" id="1473352">(</span><span class="ident" id="1473353">yk</span><span class="op" id="1473355">,</span>&nbsp;<span class="builtintype" id="1473357">uintptr</span><span class="op" id="1473364">(</span><span class="ident" id="1473365">t</span><span class="op" id="1473366">.</span><span class="ident" id="1473367">keysize</span><span class="op" id="1473374">)</span><span class="op" id="1473375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473382">yv</span>&nbsp;<span class="op" id="1473385">=</span>&nbsp;<span class="ident" id="1473387">add</span><span class="op" id="1473390">(</span><span class="ident" id="1473391">yv</span><span class="op" id="1473393">,</span>&nbsp;<span class="builtintype" id="1473395">uintptr</span><span class="op" id="1473402">(</span><span class="ident" id="1473403">t</span><span class="op" id="1473404">.</span><span class="ident" id="1473405">valuesize</span><span class="op" id="1473414">)</span><span class="op" id="1473415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473426">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1473434">//&nbsp;Unlink&nbsp;the&nbsp;overflow&nbsp;buckets&nbsp;&amp;&nbsp;clear&nbsp;key/value&nbsp;to&nbsp;help&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1473497">if</span>&nbsp;<span class="ident" id="1473500">h</span><span class="op" id="1473501">.</span><span class="ident" id="1473502">flags</span><span class="op" id="1473507">&amp;</span><span class="ident" id="1473508">oldIterator</span>&nbsp;<span class="op" id="1473520">==</span>&nbsp;<span class="num" id="1473523">0</span>&nbsp;<span class="op" id="1473525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473530">b</span>&nbsp;<span class="op" id="1473532">=</span>&nbsp;<span class="op" id="1473534">(</span><span class="op" id="1473535">*</span><span class="ident" id="1473536">bmap</span><span class="op" id="1473540">)</span><span class="op" id="1473541">(</span><span class="ident" id="1473542">add</span><span class="op" id="1473545">(</span><span class="ident" id="1473546">h</span><span class="op" id="1473547">.</span><span class="ident" id="1473548">oldbuckets</span><span class="op" id="1473558">,</span>&nbsp;<span class="ident" id="1473560">oldbucket</span><span class="op" id="1473569">*</span><span class="builtintype" id="1473570">uintptr</span><span class="op" id="1473577">(</span><span class="ident" id="1473578">t</span><span class="op" id="1473579">.</span><span class="ident" id="1473580">bucketsize</span><span class="op" id="1473590">)</span><span class="op" id="1473591">)</span><span class="op" id="1473592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473597">b</span><span class="op" id="1473598">.</span><span class="ident" id="1473599">overflow</span>&nbsp;<span class="op" id="1473608">=</span>&nbsp;<span class="builtintype" id="1473610">nil</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473617">memclr</span><span class="op" id="1473623">(</span><span class="ident" id="1473624">add</span><span class="op" id="1473627">(</span><span class="ident" id="1473628">unsafe</span><span class="op" id="1473634">.</span><span class="ident" id="1473635">Pointer</span><span class="op" id="1473642">(</span><span class="ident" id="1473643">b</span><span class="op" id="1473644">)</span><span class="op" id="1473645">,</span>&nbsp;<span class="ident" id="1473647">dataOffset</span><span class="op" id="1473657">)</span><span class="op" id="1473658">,</span>&nbsp;<span class="builtintype" id="1473660">uintptr</span><span class="op" id="1473667">(</span><span class="ident" id="1473668">t</span><span class="op" id="1473669">.</span><span class="ident" id="1473670">bucketsize</span><span class="op" id="1473680">)</span><span class="op" id="1473681">-</span><span class="ident" id="1473682">dataOffset</span><span class="op" id="1473692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1473703">//&nbsp;Advance&nbsp;evacuation&nbsp;mark</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1473731">if</span>&nbsp;<span class="ident" id="1473734">oldbucket</span>&nbsp;<span class="op" id="1473744">==</span>&nbsp;<span class="ident" id="1473747">h</span><span class="op" id="1473748">.</span><span class="ident" id="1473749">nevacuate</span>&nbsp;<span class="op" id="1473759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473763">h</span><span class="op" id="1473764">.</span><span class="ident" id="1473765">nevacuate</span>&nbsp;<span class="op" id="1473775">=</span>&nbsp;<span class="ident" id="1473777">oldbucket</span>&nbsp;<span class="op" id="1473787">+</span>&nbsp;<span class="num" id="1473789">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1473793">if</span>&nbsp;<span class="ident" id="1473796">oldbucket</span><span class="op" id="1473805">+</span><span class="num" id="1473806">1</span>&nbsp;<span class="op" id="1473808">==</span>&nbsp;<span class="ident" id="1473811">newbit</span>&nbsp;<span class="op" id="1473818">{</span>&nbsp;<span class="comment" id="1473820">//&nbsp;newbit&nbsp;==&nbsp;#&nbsp;of&nbsp;oldbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1473852">//&nbsp;Growing&nbsp;is&nbsp;all&nbsp;done.&nbsp;&nbsp;Free&nbsp;old&nbsp;main&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473908">h</span><span class="op" id="1473909">.</span><span class="ident" id="1473910">oldbuckets</span>&nbsp;<span class="op" id="1473921">=</span>&nbsp;<span class="builtintype" id="1473923">nil</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473932">}</span><br>
<span class="lineno"></span><span class="op" id="1473934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1473937">func</span>&nbsp;<span class="ident" id="1473942">ismapkey</span><span class="op" id="1473950">(</span><span class="ident" id="1473951">t</span>&nbsp;<span class="op" id="1473953">*</span><span class="ident" id="1473954">_type</span><span class="op" id="1473959">)</span>&nbsp;<span class="builtintype" id="1473961">bool</span>&nbsp;<span class="op" id="1473966">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1473969">return</span>&nbsp;<span class="ident" id="1473976">goalg</span><span class="op" id="1473981">(</span><span class="ident" id="1473982">t</span><span class="op" id="1473983">.</span><span class="ident" id="1473984">alg</span><span class="op" id="1473987">)</span><span class="op" id="1473988">.</span><span class="ident" id="1473989">hash</span>&nbsp;<span class="op" id="1473994">!=</span>&nbsp;<span class="builtintype" id="1473997">nil</span><br>
<span class="lineno"></span><span class="op" id="1474001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1474004">//&nbsp;Reflect&nbsp;stubs.&nbsp;&nbsp;Called&nbsp;from&nbsp;../reflect/asm_*.s</span><br>
<span class="lineno"></span><br>
<span class="lineno">905</span><span class="keyword" id="1474055">func</span>&nbsp;<span class="ident" id="1474060">reflect_makemap</span><span class="op" id="1474075">(</span><span class="ident" id="1474076">t</span>&nbsp;<span class="op" id="1474078">*</span><span class="ident" id="1474079">maptype</span><span class="op" id="1474086">)</span>&nbsp;<span class="op" id="1474088">*</span><span class="ident" id="1474089">hmap</span>&nbsp;<span class="op" id="1474094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474097">return</span>&nbsp;<span class="ident" id="1474104">makemap</span><span class="op" id="1474111">(</span><span class="ident" id="1474112">t</span><span class="op" id="1474113">,</span>&nbsp;<span class="num" id="1474115">0</span><span class="op" id="1474116">)</span><br>
<span class="lineno"></span><span class="op" id="1474118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1474121">func</span>&nbsp;<span class="ident" id="1474126">reflect_mapaccess</span><span class="op" id="1474143">(</span><span class="ident" id="1474144">t</span>&nbsp;<span class="op" id="1474146">*</span><span class="ident" id="1474147">maptype</span><span class="op" id="1474154">,</span>&nbsp;<span class="ident" id="1474156">h</span>&nbsp;<span class="op" id="1474158">*</span><span class="ident" id="1474159">hmap</span><span class="op" id="1474163">,</span>&nbsp;<span class="ident" id="1474165">key</span>&nbsp;<span class="ident" id="1474169">unsafe</span><span class="op" id="1474175">.</span><span class="ident" id="1474176">Pointer</span><span class="op" id="1474183">)</span>&nbsp;<span class="ident" id="1474185">unsafe</span><span class="op" id="1474191">.</span><span class="ident" id="1474192">Pointer</span>&nbsp;<span class="op" id="1474200">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474203">val</span><span class="op" id="1474206">,</span>&nbsp;<span class="ident" id="1474208">ok</span>&nbsp;<span class="op" id="1474211">:=</span>&nbsp;<span class="ident" id="1474214">mapaccess2</span><span class="op" id="1474224">(</span><span class="ident" id="1474225">t</span><span class="op" id="1474226">,</span>&nbsp;<span class="ident" id="1474228">h</span><span class="op" id="1474229">,</span>&nbsp;<span class="ident" id="1474231">key</span><span class="op" id="1474234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474237">if</span>&nbsp;<span class="op" id="1474240">!</span><span class="ident" id="1474241">ok</span>&nbsp;<span class="op" id="1474244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1474248">//&nbsp;reflect&nbsp;wants&nbsp;nil&nbsp;for&nbsp;a&nbsp;missing&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474293">val</span>&nbsp;<span class="op" id="1474297">=</span>&nbsp;<span class="builtintype" id="1474299">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1474304">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474307">return</span>&nbsp;<span class="ident" id="1474314">val</span><br>
<span class="lineno"></span><span class="op" id="1474318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1474321">func</span>&nbsp;<span class="ident" id="1474326">reflect_mapassign</span><span class="op" id="1474343">(</span><span class="ident" id="1474344">t</span>&nbsp;<span class="op" id="1474346">*</span><span class="ident" id="1474347">maptype</span><span class="op" id="1474354">,</span>&nbsp;<span class="ident" id="1474356">h</span>&nbsp;<span class="op" id="1474358">*</span><span class="ident" id="1474359">hmap</span><span class="op" id="1474363">,</span>&nbsp;<span class="ident" id="1474365">key</span>&nbsp;<span class="ident" id="1474369">unsafe</span><span class="op" id="1474375">.</span><span class="ident" id="1474376">Pointer</span><span class="op" id="1474383">,</span>&nbsp;<span class="ident" id="1474385">val</span>&nbsp;<span class="ident" id="1474389">unsafe</span><span class="op" id="1474395">.</span><span class="ident" id="1474396">Pointer</span><span class="op" id="1474403">)</span>&nbsp;<span class="op" id="1474405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474408">mapassign1</span><span class="op" id="1474418">(</span><span class="ident" id="1474419">t</span><span class="op" id="1474420">,</span>&nbsp;<span class="ident" id="1474422">h</span><span class="op" id="1474423">,</span>&nbsp;<span class="ident" id="1474425">key</span><span class="op" id="1474428">,</span>&nbsp;<span class="ident" id="1474430">val</span><span class="op" id="1474433">)</span><br>
<span class="lineno">920</span><span class="op" id="1474435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1474438">func</span>&nbsp;<span class="ident" id="1474443">reflect_mapdelete</span><span class="op" id="1474460">(</span><span class="ident" id="1474461">t</span>&nbsp;<span class="op" id="1474463">*</span><span class="ident" id="1474464">maptype</span><span class="op" id="1474471">,</span>&nbsp;<span class="ident" id="1474473">h</span>&nbsp;<span class="op" id="1474475">*</span><span class="ident" id="1474476">hmap</span><span class="op" id="1474480">,</span>&nbsp;<span class="ident" id="1474482">key</span>&nbsp;<span class="ident" id="1474486">unsafe</span><span class="op" id="1474492">.</span><span class="ident" id="1474493">Pointer</span><span class="op" id="1474500">)</span>&nbsp;<span class="op" id="1474502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474505">mapdelete</span><span class="op" id="1474514">(</span><span class="ident" id="1474515">t</span><span class="op" id="1474516">,</span>&nbsp;<span class="ident" id="1474518">h</span><span class="op" id="1474519">,</span>&nbsp;<span class="ident" id="1474521">key</span><span class="op" id="1474524">)</span><br>
<span class="lineno"></span><span class="op" id="1474526">}</span><br>
<span class="lineno">925</span><br>
<span class="lineno"></span><span class="keyword" id="1474529">func</span>&nbsp;<span class="ident" id="1474534">reflect_mapiterinit</span><span class="op" id="1474553">(</span><span class="ident" id="1474554">t</span>&nbsp;<span class="op" id="1474556">*</span><span class="ident" id="1474557">maptype</span><span class="op" id="1474564">,</span>&nbsp;<span class="ident" id="1474566">h</span>&nbsp;<span class="op" id="1474568">*</span><span class="ident" id="1474569">hmap</span><span class="op" id="1474573">)</span>&nbsp;<span class="op" id="1474575">*</span><span class="ident" id="1474576">hiter</span>&nbsp;<span class="op" id="1474582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474585">it</span>&nbsp;<span class="op" id="1474588">:=</span>&nbsp;<span class="builtinfunc" id="1474591">new</span><span class="op" id="1474594">(</span><span class="ident" id="1474595">hiter</span><span class="op" id="1474600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474603">mapiterinit</span><span class="op" id="1474614">(</span><span class="ident" id="1474615">t</span><span class="op" id="1474616">,</span>&nbsp;<span class="ident" id="1474618">h</span><span class="op" id="1474619">,</span>&nbsp;<span class="ident" id="1474621">it</span><span class="op" id="1474623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474626">return</span>&nbsp;<span class="ident" id="1474633">it</span><br>
<span class="lineno">930</span><span class="op" id="1474636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1474639">func</span>&nbsp;<span class="ident" id="1474644">reflect_mapiternext</span><span class="op" id="1474663">(</span><span class="ident" id="1474664">it</span>&nbsp;<span class="op" id="1474667">*</span><span class="ident" id="1474668">hiter</span><span class="op" id="1474673">)</span>&nbsp;<span class="op" id="1474675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474678">mapiternext</span><span class="op" id="1474689">(</span><span class="ident" id="1474690">it</span><span class="op" id="1474692">)</span><br>
<span class="lineno"></span><span class="op" id="1474694">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="keyword" id="1474697">func</span>&nbsp;<span class="ident" id="1474702">reflect_mapiterkey</span><span class="op" id="1474720">(</span><span class="ident" id="1474721">it</span>&nbsp;<span class="op" id="1474724">*</span><span class="ident" id="1474725">hiter</span><span class="op" id="1474730">)</span>&nbsp;<span class="ident" id="1474732">unsafe</span><span class="op" id="1474738">.</span><span class="ident" id="1474739">Pointer</span>&nbsp;<span class="op" id="1474747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474750">return</span>&nbsp;<span class="ident" id="1474757">it</span><span class="op" id="1474759">.</span><span class="ident" id="1474760">key</span><br>
<span class="lineno"></span><span class="op" id="1474764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">940</span><span class="keyword" id="1474767">func</span>&nbsp;<span class="ident" id="1474772">reflect_maplen</span><span class="op" id="1474786">(</span><span class="ident" id="1474787">h</span>&nbsp;<span class="op" id="1474789">*</span><span class="ident" id="1474790">hmap</span><span class="op" id="1474794">)</span>&nbsp;<span class="builtintype" id="1474796">int</span>&nbsp;<span class="op" id="1474800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474803">if</span>&nbsp;<span class="ident" id="1474806">h</span>&nbsp;<span class="op" id="1474808">==</span>&nbsp;<span class="builtintype" id="1474811">nil</span>&nbsp;<span class="op" id="1474815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474819">return</span>&nbsp;<span class="num" id="1474826">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1474829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474832">if</span>&nbsp;<span class="ident" id="1474835">raceenabled</span>&nbsp;<span class="op" id="1474847">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474851">callerpc</span>&nbsp;<span class="op" id="1474860">:=</span>&nbsp;<span class="ident" id="1474863">getcallerpc</span><span class="op" id="1474874">(</span><span class="ident" id="1474875">unsafe</span><span class="op" id="1474881">.</span><span class="ident" id="1474882">Pointer</span><span class="op" id="1474889">(</span><span class="op" id="1474890">&amp;</span><span class="ident" id="1474891">h</span><span class="op" id="1474892">)</span><span class="op" id="1474893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474897">racereadpc</span><span class="op" id="1474907">(</span><span class="ident" id="1474908">unsafe</span><span class="op" id="1474914">.</span><span class="ident" id="1474915">Pointer</span><span class="op" id="1474922">(</span><span class="ident" id="1474923">h</span><span class="op" id="1474924">)</span><span class="op" id="1474925">,</span>&nbsp;<span class="ident" id="1474927">callerpc</span><span class="op" id="1474935">,</span>&nbsp;<span class="ident" id="1474937">funcPC</span><span class="op" id="1474943">(</span><span class="ident" id="1474944">reflect_maplen</span><span class="op" id="1474958">)</span><span class="op" id="1474959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1474962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474965">return</span>&nbsp;<span class="ident" id="1474972">h</span><span class="op" id="1474973">.</span><span class="ident" id="1474974">count</span><br>
<span class="lineno"></span><span class="op" id="1474980">}</span><br>
<span class="lineno">950</span><br>
<span class="lineno"></span><span class="keyword" id="1474983">func</span>&nbsp;<span class="ident" id="1474988">reflect_ismapkey</span><span class="op" id="1475004">(</span><span class="ident" id="1475005">t</span>&nbsp;<span class="op" id="1475007">*</span><span class="ident" id="1475008">_type</span><span class="op" id="1475013">)</span>&nbsp;<span class="builtintype" id="1475015">bool</span>&nbsp;<span class="op" id="1475020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1475023">return</span>&nbsp;<span class="ident" id="1475030">ismapkey</span><span class="op" id="1475038">(</span><span class="ident" id="1475039">t</span><span class="op" id="1475040">)</span><br>
<span class="lineno"></span><span class="op" id="1475042">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
