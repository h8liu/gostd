<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>os/signal</h2>
<ul>
<li><a href="/gostd/os/signal/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/os/signal/signal.go.html">signal.go</a></li>
<li><a href="/gostd/os/signal/signal_test.go.html">signal_test.go</a></li>
<li><a href="/gostd/os/signal/signal_unix.go.html">signal_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8453601">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8453656">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8453710">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8453761">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8453826">package</span>&nbsp;<span class="ident" id="8453834">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8453842">import</span>&nbsp;<span class="op" id="8453849">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8453852">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8453860">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8453873">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8453879">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8453890">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8453901">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8453912">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8453923">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8453934">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8453941">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8453944">func</span>&nbsp;<span class="ident" id="8453949">waitSig</span><span class="op" id="8453956">(</span><span class="ident" id="8453957">t</span>&nbsp;<span class="op" id="8453959">*</span><span class="ident" id="8453960">testing</span><span class="op" id="8453967">.</span><span class="ident" id="8453968">T</span><span class="op" id="8453969">,</span>&nbsp;<span class="ident" id="8453971">c</span>&nbsp;<span class="op" id="8453973">&lt;-</span><span class="keyword" id="8453975">chan</span>&nbsp;<span class="ident" id="8453980">os</span><span class="op" id="8453982">.</span><span class="ident" id="8453983">Signal</span><span class="op" id="8453989">,</span>&nbsp;<span class="ident" id="8453991">sig</span>&nbsp;<span class="ident" id="8453995">os</span><span class="op" id="8453997">.</span><span class="ident" id="8453998">Signal</span><span class="op" id="8454004">)</span>&nbsp;<span class="op" id="8454006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8454009">select</span>&nbsp;<span class="op" id="8454016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8454019">case</span>&nbsp;<span class="ident" id="8454024">s</span>&nbsp;<span class="op" id="8454026">:=</span>&nbsp;<span class="op" id="8454029">&lt;-</span><span class="ident" id="8454031">c</span><span class="op" id="8454032">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8454036">if</span>&nbsp;<span class="ident" id="8454039">s</span>&nbsp;<span class="op" id="8454041">!=</span>&nbsp;<span class="ident" id="8454044">sig</span>&nbsp;<span class="op" id="8454048">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454053">t</span><span class="op" id="8454054">.</span><span class="ident" id="8454055">Fatalf</span><span class="op" id="8454061">(</span><span class="string" id="8454062">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8454086">,</span>&nbsp;<span class="ident" id="8454088">s</span><span class="op" id="8454089">,</span>&nbsp;<span class="ident" id="8454091">sig</span><span class="op" id="8454094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8454098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8454101">case</span>&nbsp;<span class="op" id="8454106">&lt;-</span><span class="ident" id="8454108">time</span><span class="op" id="8454112">.</span><span class="ident" id="8454113">After</span><span class="op" id="8454118">(</span><span class="num" id="8454119">1</span>&nbsp;<span class="op" id="8454121">*</span>&nbsp;<span class="ident" id="8454123">time</span><span class="op" id="8454127">.</span><span class="ident" id="8454128">Second</span><span class="op" id="8454134">)</span><span class="op" id="8454135">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454139">t</span><span class="op" id="8454140">.</span><span class="ident" id="8454141">Fatalf</span><span class="op" id="8454147">(</span><span class="string" id="8454148">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="8454172">,</span>&nbsp;<span class="ident" id="8454174">sig</span><span class="op" id="8454177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8454180">}</span><br>
<span class="lineno">30</span><span class="op" id="8454182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8454185">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="8454227">func</span>&nbsp;<span class="ident" id="8454232">TestSignal</span><span class="op" id="8454242">(</span><span class="ident" id="8454243">t</span>&nbsp;<span class="op" id="8454245">*</span><span class="ident" id="8454246">testing</span><span class="op" id="8454253">.</span><span class="ident" id="8454254">T</span><span class="op" id="8454255">)</span>&nbsp;<span class="op" id="8454257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8454260">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454279">c</span>&nbsp;<span class="op" id="8454281">:=</span>&nbsp;<span class="builtinfunc" id="8454284">make</span><span class="op" id="8454288">(</span><span class="keyword" id="8454289">chan</span>&nbsp;<span class="ident" id="8454294">os</span><span class="op" id="8454296">.</span><span class="ident" id="8454297">Signal</span><span class="op" id="8454303">,</span>&nbsp;<span class="num" id="8454305">1</span><span class="op" id="8454306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454309">Notify</span><span class="op" id="8454315">(</span><span class="ident" id="8454316">c</span><span class="op" id="8454317">,</span>&nbsp;<span class="ident" id="8454319">syscall</span><span class="op" id="8454326">.</span><span class="ident" id="8454327">SIGHUP</span><span class="op" id="8454333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8454336">defer</span>&nbsp;<span class="ident" id="8454342">Stop</span><span class="op" id="8454346">(</span><span class="ident" id="8454347">c</span><span class="op" id="8454348">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8454352">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454383">t</span><span class="op" id="8454384">.</span><span class="ident" id="8454385">Logf</span><span class="op" id="8454389">(</span><span class="string" id="8454390">&#34;sighup...&#34;</span><span class="op" id="8454401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454404">syscall</span><span class="op" id="8454411">.</span><span class="ident" id="8454412">Kill</span><span class="op" id="8454416">(</span><span class="ident" id="8454417">syscall</span><span class="op" id="8454424">.</span><span class="ident" id="8454425">Getpid</span><span class="op" id="8454431">(</span><span class="op" id="8454432">)</span><span class="op" id="8454433">,</span>&nbsp;<span class="ident" id="8454435">syscall</span><span class="op" id="8454442">.</span><span class="ident" id="8454443">SIGHUP</span><span class="op" id="8454449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454452">waitSig</span><span class="op" id="8454459">(</span><span class="ident" id="8454460">t</span><span class="op" id="8454461">,</span>&nbsp;<span class="ident" id="8454463">c</span><span class="op" id="8454464">,</span>&nbsp;<span class="ident" id="8454466">syscall</span><span class="op" id="8454473">.</span><span class="ident" id="8454474">SIGHUP</span><span class="op" id="8454480">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8454484">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454519">c1</span>&nbsp;<span class="op" id="8454522">:=</span>&nbsp;<span class="builtinfunc" id="8454525">make</span><span class="op" id="8454529">(</span><span class="keyword" id="8454530">chan</span>&nbsp;<span class="ident" id="8454535">os</span><span class="op" id="8454537">.</span><span class="ident" id="8454538">Signal</span><span class="op" id="8454544">,</span>&nbsp;<span class="num" id="8454546">1</span><span class="op" id="8454547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454550">Notify</span><span class="op" id="8454556">(</span><span class="ident" id="8454557">c1</span><span class="op" id="8454559">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8454563">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454596">t</span><span class="op" id="8454597">.</span><span class="ident" id="8454598">Logf</span><span class="op" id="8454602">(</span><span class="string" id="8454603">&#34;sigwinch...&#34;</span><span class="op" id="8454616">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454619">syscall</span><span class="op" id="8454626">.</span><span class="ident" id="8454627">Kill</span><span class="op" id="8454631">(</span><span class="ident" id="8454632">syscall</span><span class="op" id="8454639">.</span><span class="ident" id="8454640">Getpid</span><span class="op" id="8454646">(</span><span class="op" id="8454647">)</span><span class="op" id="8454648">,</span>&nbsp;<span class="ident" id="8454650">syscall</span><span class="op" id="8454657">.</span><span class="ident" id="8454658">SIGWINCH</span><span class="op" id="8454666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454669">waitSig</span><span class="op" id="8454676">(</span><span class="ident" id="8454677">t</span><span class="op" id="8454678">,</span>&nbsp;<span class="ident" id="8454680">c1</span><span class="op" id="8454682">,</span>&nbsp;<span class="ident" id="8454684">syscall</span><span class="op" id="8454691">.</span><span class="ident" id="8454692">SIGWINCH</span><span class="op" id="8454700">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8454704">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8454749">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8454799">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454837">t</span><span class="op" id="8454838">.</span><span class="ident" id="8454839">Logf</span><span class="op" id="8454843">(</span><span class="string" id="8454844">&#34;sighup...&#34;</span><span class="op" id="8454855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454858">syscall</span><span class="op" id="8454865">.</span><span class="ident" id="8454866">Kill</span><span class="op" id="8454870">(</span><span class="ident" id="8454871">syscall</span><span class="op" id="8454878">.</span><span class="ident" id="8454879">Getpid</span><span class="op" id="8454885">(</span><span class="op" id="8454886">)</span><span class="op" id="8454887">,</span>&nbsp;<span class="ident" id="8454889">syscall</span><span class="op" id="8454896">.</span><span class="ident" id="8454897">SIGHUP</span><span class="op" id="8454903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454906">waitSig</span><span class="op" id="8454913">(</span><span class="ident" id="8454914">t</span><span class="op" id="8454915">,</span>&nbsp;<span class="ident" id="8454917">c1</span><span class="op" id="8454919">,</span>&nbsp;<span class="ident" id="8454921">syscall</span><span class="op" id="8454928">.</span><span class="ident" id="8454929">SIGHUP</span><span class="op" id="8454935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454938">t</span><span class="op" id="8454939">.</span><span class="ident" id="8454940">Logf</span><span class="op" id="8454944">(</span><span class="string" id="8454945">&#34;sighup...&#34;</span><span class="op" id="8454956">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8454959">syscall</span><span class="op" id="8454966">.</span><span class="ident" id="8454967">Kill</span><span class="op" id="8454971">(</span><span class="ident" id="8454972">syscall</span><span class="op" id="8454979">.</span><span class="ident" id="8454980">Getpid</span><span class="op" id="8454986">(</span><span class="op" id="8454987">)</span><span class="op" id="8454988">,</span>&nbsp;<span class="ident" id="8454990">syscall</span><span class="op" id="8454997">.</span><span class="ident" id="8454998">SIGHUP</span><span class="op" id="8455004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455007">waitSig</span><span class="op" id="8455014">(</span><span class="ident" id="8455015">t</span><span class="op" id="8455016">,</span>&nbsp;<span class="ident" id="8455018">c1</span><span class="op" id="8455020">,</span>&nbsp;<span class="ident" id="8455022">syscall</span><span class="op" id="8455029">.</span><span class="ident" id="8455030">SIGHUP</span><span class="op" id="8455036">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8455040">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455092">waitSig</span><span class="op" id="8455099">(</span><span class="ident" id="8455100">t</span><span class="op" id="8455101">,</span>&nbsp;<span class="ident" id="8455103">c</span><span class="op" id="8455104">,</span>&nbsp;<span class="ident" id="8455106">syscall</span><span class="op" id="8455113">.</span><span class="ident" id="8455114">SIGHUP</span><span class="op" id="8455120">)</span><br>
<span class="lineno">65</span><span class="op" id="8455122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8455125">func</span>&nbsp;<span class="ident" id="8455130">TestStress</span><span class="op" id="8455140">(</span><span class="ident" id="8455141">t</span>&nbsp;<span class="op" id="8455143">*</span><span class="ident" id="8455144">testing</span><span class="op" id="8455151">.</span><span class="ident" id="8455152">T</span><span class="op" id="8455153">)</span>&nbsp;<span class="op" id="8455155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455158">dur</span>&nbsp;<span class="op" id="8455162">:=</span>&nbsp;<span class="num" id="8455165">3</span>&nbsp;<span class="op" id="8455167">*</span>&nbsp;<span class="ident" id="8455169">time</span><span class="op" id="8455173">.</span><span class="ident" id="8455174">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455182">if</span>&nbsp;<span class="ident" id="8455185">testing</span><span class="op" id="8455192">.</span><span class="ident" id="8455193">Short</span><span class="op" id="8455198">(</span><span class="op" id="8455199">)</span>&nbsp;<span class="op" id="8455201">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455205">dur</span>&nbsp;<span class="op" id="8455209">=</span>&nbsp;<span class="num" id="8455211">100</span>&nbsp;<span class="op" id="8455215">*</span>&nbsp;<span class="ident" id="8455217">time</span><span class="op" id="8455221">.</span><span class="ident" id="8455222">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8455235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455238">defer</span>&nbsp;<span class="ident" id="8455244">runtime</span><span class="op" id="8455251">.</span><span class="ident" id="8455252">GOMAXPROCS</span><span class="op" id="8455262">(</span><span class="ident" id="8455263">runtime</span><span class="op" id="8455270">.</span><span class="ident" id="8455271">GOMAXPROCS</span><span class="op" id="8455281">(</span><span class="num" id="8455282">4</span><span class="op" id="8455283">)</span><span class="op" id="8455284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455287">done</span>&nbsp;<span class="op" id="8455292">:=</span>&nbsp;<span class="builtinfunc" id="8455295">make</span><span class="op" id="8455299">(</span><span class="keyword" id="8455300">chan</span>&nbsp;<span class="builtintype" id="8455305">bool</span><span class="op" id="8455309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455312">finished</span>&nbsp;<span class="op" id="8455321">:=</span>&nbsp;<span class="builtinfunc" id="8455324">make</span><span class="op" id="8455328">(</span><span class="keyword" id="8455329">chan</span>&nbsp;<span class="builtintype" id="8455334">bool</span><span class="op" id="8455338">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455341">go</span>&nbsp;<span class="keyword" id="8455344">func</span><span class="op" id="8455348">(</span><span class="op" id="8455349">)</span>&nbsp;<span class="op" id="8455351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455355">sig</span>&nbsp;<span class="op" id="8455359">:=</span>&nbsp;<span class="builtinfunc" id="8455362">make</span><span class="op" id="8455366">(</span><span class="keyword" id="8455367">chan</span>&nbsp;<span class="ident" id="8455372">os</span><span class="op" id="8455374">.</span><span class="ident" id="8455375">Signal</span><span class="op" id="8455381">,</span>&nbsp;<span class="num" id="8455383">1</span><span class="op" id="8455384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455388">Notify</span><span class="op" id="8455394">(</span><span class="ident" id="8455395">sig</span><span class="op" id="8455398">,</span>&nbsp;<span class="ident" id="8455400">syscall</span><span class="op" id="8455407">.</span><span class="ident" id="8455408">SIGUSR1</span><span class="op" id="8455415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455419">defer</span>&nbsp;<span class="ident" id="8455425">Stop</span><span class="op" id="8455429">(</span><span class="ident" id="8455430">sig</span><span class="op" id="8455433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455436">Loop</span><span class="op" id="8455440">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455444">for</span>&nbsp;<span class="op" id="8455448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455453">select</span>&nbsp;<span class="op" id="8455460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455465">case</span>&nbsp;<span class="op" id="8455470">&lt;-</span><span class="ident" id="8455472">sig</span><span class="op" id="8455475">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455480">case</span>&nbsp;<span class="op" id="8455485">&lt;-</span><span class="ident" id="8455487">done</span><span class="op" id="8455491">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455497">break</span>&nbsp;<span class="ident" id="8455503">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8455511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8455515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455519">finished</span>&nbsp;<span class="op" id="8455528">&lt;-</span>&nbsp;<span class="builtintype" id="8455531">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8455537">}</span><span class="op" id="8455538">(</span><span class="op" id="8455539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455542">go</span>&nbsp;<span class="keyword" id="8455545">func</span><span class="op" id="8455549">(</span><span class="op" id="8455550">)</span>&nbsp;<span class="op" id="8455552">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455555">Loop</span><span class="op" id="8455559">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455563">for</span>&nbsp;<span class="op" id="8455567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455572">select</span>&nbsp;<span class="op" id="8455579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455584">case</span>&nbsp;<span class="op" id="8455589">&lt;-</span><span class="ident" id="8455591">done</span><span class="op" id="8455595">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455601">break</span>&nbsp;<span class="ident" id="8455607">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8455615">default</span><span class="op" id="8455622">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455628">syscall</span><span class="op" id="8455635">.</span><span class="ident" id="8455636">Kill</span><span class="op" id="8455640">(</span><span class="ident" id="8455641">syscall</span><span class="op" id="8455648">.</span><span class="ident" id="8455649">Getpid</span><span class="op" id="8455655">(</span><span class="op" id="8455656">)</span><span class="op" id="8455657">,</span>&nbsp;<span class="ident" id="8455659">syscall</span><span class="op" id="8455666">.</span><span class="ident" id="8455667">SIGUSR1</span><span class="op" id="8455674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455680">runtime</span><span class="op" id="8455687">.</span><span class="ident" id="8455688">Gosched</span><span class="op" id="8455695">(</span><span class="op" id="8455696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8455701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8455705">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455709">finished</span>&nbsp;<span class="op" id="8455718">&lt;-</span>&nbsp;<span class="builtintype" id="8455721">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8455727">}</span><span class="op" id="8455728">(</span><span class="op" id="8455729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455732">time</span><span class="op" id="8455736">.</span><span class="ident" id="8455737">Sleep</span><span class="op" id="8455742">(</span><span class="ident" id="8455743">dur</span><span class="op" id="8455746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8455749">close</span><span class="op" id="8455754">(</span><span class="ident" id="8455755">done</span><span class="op" id="8455759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8455762">&lt;-</span><span class="ident" id="8455764">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8455774">&lt;-</span><span class="ident" id="8455776">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8455786">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8455857">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8455907">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8455971">time</span><span class="op" id="8455975">.</span><span class="ident" id="8455976">Sleep</span><span class="op" id="8455981">(</span><span class="num" id="8455982">10</span>&nbsp;<span class="op" id="8455985">*</span>&nbsp;<span class="ident" id="8455987">time</span><span class="op" id="8455991">.</span><span class="ident" id="8455992">Millisecond</span><span class="op" id="8456003">)</span><br>
<span class="lineno">110</span><span class="op" id="8456005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8456008">var</span>&nbsp;<span class="ident" id="8456012">sendUncaughtSighup</span>&nbsp;<span class="op" id="8456031">=</span>&nbsp;<span class="ident" id="8456033">flag</span><span class="op" id="8456037">.</span><span class="ident" id="8456038">Int</span><span class="op" id="8456041">(</span><span class="string" id="8456042">&#34;send_uncaught_sighup&#34;</span><span class="op" id="8456064">,</span>&nbsp;<span class="num" id="8456066">0</span><span class="op" id="8456067">,</span>&nbsp;<span class="string" id="8456069">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="8456107">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8456110">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="8456165">func</span>&nbsp;<span class="ident" id="8456170">TestStop</span><span class="op" id="8456178">(</span><span class="ident" id="8456179">t</span>&nbsp;<span class="op" id="8456181">*</span><span class="ident" id="8456182">testing</span><span class="op" id="8456189">.</span><span class="ident" id="8456190">T</span><span class="op" id="8456191">)</span>&nbsp;<span class="op" id="8456193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8456196">sigs</span>&nbsp;<span class="op" id="8456201">:=</span>&nbsp;<span class="op" id="8456204">[</span><span class="op" id="8456205">]</span><span class="ident" id="8456206">syscall</span><span class="op" id="8456213">.</span><span class="ident" id="8456214">Signal</span><span class="op" id="8456220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8456224">syscall</span><span class="op" id="8456231">.</span><span class="ident" id="8456232">SIGWINCH</span><span class="op" id="8456240">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8456244">syscall</span><span class="op" id="8456251">.</span><span class="ident" id="8456252">SIGHUP</span><span class="op" id="8456258">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8456261">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8456265">for</span>&nbsp;<span class="ident" id="8456269">_</span><span class="op" id="8456270">,</span>&nbsp;<span class="ident" id="8456272">sig</span>&nbsp;<span class="op" id="8456276">:=</span>&nbsp;<span class="keyword" id="8456279">range</span>&nbsp;<span class="ident" id="8456285">sigs</span>&nbsp;<span class="op" id="8456290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8456294">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8456316">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8456361">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8456432">if</span>&nbsp;<span class="ident" id="8456435">sig</span>&nbsp;<span class="op" id="8456439">!=</span>&nbsp;<span class="ident" id="8456442">syscall</span><span class="op" id="8456449">.</span><span class="ident" id="8456450">SIGHUP</span>&nbsp;<span class="op" id="8456457">||</span>&nbsp;<span class="op" id="8456460">*</span><span class="ident" id="8456461">sendUncaughtSighup</span>&nbsp;<span class="op" id="8456480">==</span>&nbsp;<span class="num" id="8456483">1</span>&nbsp;<span class="op" id="8456485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8456490">syscall</span><span class="op" id="8456497">.</span><span class="ident" id="8456498">Kill</span><span class="op" id="8456502">(</span><span class="ident" id="8456503">syscall</span><span class="op" id="8456510">.</span><span class="ident" id="8456511">Getpid</span><span class="op" id="8456517">(</span><span class="op" id="8456518">)</span><span class="op" id="8456519">,</span>&nbsp;<span class="ident" id="8456521">sig</span><span class="op" id="8456524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8456528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8456532">time</span><span class="op" id="8456536">.</span><span class="ident" id="8456537">Sleep</span><span class="op" id="8456542">(</span><span class="num" id="8456543">100</span>&nbsp;<span class="op" id="8456547">*</span>&nbsp;<span class="ident" id="8456549">time</span><span class="op" id="8456553">.</span><span class="ident" id="8456554">Millisecond</span><span class="op" id="8456565">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8456570">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8456590">c</span>&nbsp;<span class="op" id="8456592">:=</span>&nbsp;<span class="builtinfunc" id="8456595">make</span><span class="op" id="8456599">(</span><span class="keyword" id="8456600">chan</span>&nbsp;<span class="ident" id="8456605">os</span><span class="op" id="8456607">.</span><span class="ident" id="8456608">Signal</span><span class="op" id="8456614">,</span>&nbsp;<span class="num" id="8456616">1</span><span class="op" id="8456617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8456621">Notify</span><span class="op" id="8456627">(</span><span class="ident" id="8456628">c</span><span class="op" id="8456629">,</span>&nbsp;<span class="ident" id="8456631">sig</span><span class="op" id="8456634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8456638">defer</span>&nbsp;<span class="ident" id="8456644">Stop</span><span class="op" id="8456648">(</span><span class="ident" id="8456649">c</span><span class="op" id="8456650">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8456655">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8456690">syscall</span><span class="op" id="8456697">.</span><span class="ident" id="8456698">Kill</span><span class="op" id="8456702">(</span><span class="ident" id="8456703">syscall</span><span class="op" id="8456710">.</span><span class="ident" id="8456711">Getpid</span><span class="op" id="8456717">(</span><span class="op" id="8456718">)</span><span class="op" id="8456719">,</span>&nbsp;<span class="ident" id="8456721">sig</span><span class="op" id="8456724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8456728">waitSig</span><span class="op" id="8456735">(</span><span class="ident" id="8456736">t</span><span class="op" id="8456737">,</span>&nbsp;<span class="ident" id="8456739">c</span><span class="op" id="8456740">,</span>&nbsp;<span class="ident" id="8456742">sig</span><span class="op" id="8456745">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8456750">Stop</span><span class="op" id="8456754">(</span><span class="ident" id="8456755">c</span><span class="op" id="8456756">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8456760">select</span>&nbsp;<span class="op" id="8456767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8456771">case</span>&nbsp;<span class="ident" id="8456776">s</span>&nbsp;<span class="op" id="8456778">:=</span>&nbsp;<span class="op" id="8456781">&lt;-</span><span class="ident" id="8456783">c</span><span class="op" id="8456784">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8456789">t</span><span class="op" id="8456790">.</span><span class="ident" id="8456791">Fatalf</span><span class="op" id="8456797">(</span><span class="string" id="8456798">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="8456820">,</span>&nbsp;<span class="ident" id="8456822">s</span><span class="op" id="8456823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8456827">case</span>&nbsp;<span class="op" id="8456832">&lt;-</span><span class="ident" id="8456834">time</span><span class="op" id="8456838">.</span><span class="ident" id="8456839">After</span><span class="op" id="8456844">(</span><span class="num" id="8456845">100</span>&nbsp;<span class="op" id="8456849">*</span>&nbsp;<span class="ident" id="8456851">time</span><span class="op" id="8456855">.</span><span class="ident" id="8456856">Millisecond</span><span class="op" id="8456867">)</span><span class="op" id="8456868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8456873">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8456901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8456906">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8456928">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8456973">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8457044">if</span>&nbsp;<span class="ident" id="8457047">sig</span>&nbsp;<span class="op" id="8457051">!=</span>&nbsp;<span class="ident" id="8457054">syscall</span><span class="op" id="8457061">.</span><span class="ident" id="8457062">SIGHUP</span>&nbsp;<span class="op" id="8457069">||</span>&nbsp;<span class="op" id="8457072">*</span><span class="ident" id="8457073">sendUncaughtSighup</span>&nbsp;<span class="op" id="8457092">==</span>&nbsp;<span class="num" id="8457095">2</span>&nbsp;<span class="op" id="8457097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8457102">syscall</span><span class="op" id="8457109">.</span><span class="ident" id="8457110">Kill</span><span class="op" id="8457114">(</span><span class="ident" id="8457115">syscall</span><span class="op" id="8457122">.</span><span class="ident" id="8457123">Getpid</span><span class="op" id="8457129">(</span><span class="op" id="8457130">)</span><span class="op" id="8457131">,</span>&nbsp;<span class="ident" id="8457133">sig</span><span class="op" id="8457136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8457140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8457145">select</span>&nbsp;<span class="op" id="8457152">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8457156">case</span>&nbsp;<span class="ident" id="8457161">s</span>&nbsp;<span class="op" id="8457163">:=</span>&nbsp;<span class="op" id="8457166">&lt;-</span><span class="ident" id="8457168">c</span><span class="op" id="8457169">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8457174">t</span><span class="op" id="8457175">.</span><span class="ident" id="8457176">Fatalf</span><span class="op" id="8457182">(</span><span class="string" id="8457183">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="8457205">,</span>&nbsp;<span class="ident" id="8457207">s</span><span class="op" id="8457208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8457212">case</span>&nbsp;<span class="op" id="8457217">&lt;-</span><span class="ident" id="8457219">time</span><span class="op" id="8457223">.</span><span class="ident" id="8457224">After</span><span class="op" id="8457229">(</span><span class="num" id="8457230">100</span>&nbsp;<span class="op" id="8457234">*</span>&nbsp;<span class="ident" id="8457236">time</span><span class="op" id="8457240">.</span><span class="ident" id="8457241">Millisecond</span><span class="op" id="8457252">)</span><span class="op" id="8457253">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8457258">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8457286">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8457289">}</span><br>
<span class="lineno"></span><span class="op" id="8457291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8457294">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="8457375">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="8457384">func</span>&nbsp;<span class="ident" id="8457389">TestNohup</span><span class="op" id="8457398">(</span><span class="ident" id="8457399">t</span>&nbsp;<span class="op" id="8457401">*</span><span class="ident" id="8457402">testing</span><span class="op" id="8457409">.</span><span class="ident" id="8457410">T</span><span class="op" id="8457411">)</span>&nbsp;<span class="op" id="8457413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8457416">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8457480">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8457533">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8457577">c</span>&nbsp;<span class="op" id="8457579">:=</span>&nbsp;<span class="builtinfunc" id="8457582">make</span><span class="op" id="8457586">(</span><span class="keyword" id="8457587">chan</span>&nbsp;<span class="ident" id="8457592">os</span><span class="op" id="8457594">.</span><span class="ident" id="8457595">Signal</span><span class="op" id="8457601">,</span>&nbsp;<span class="num" id="8457603">1</span><span class="op" id="8457604">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8457607">Notify</span><span class="op" id="8457613">(</span><span class="ident" id="8457614">c</span><span class="op" id="8457615">,</span>&nbsp;<span class="ident" id="8457617">syscall</span><span class="op" id="8457624">.</span><span class="ident" id="8457625">SIGHUP</span><span class="op" id="8457631">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8457635">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8457708">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8457775">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8457841">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8457920">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8457998">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8458002">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8458085">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8458168">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8458172">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8458232">for</span>&nbsp;<span class="ident" id="8458236">i</span>&nbsp;<span class="op" id="8458238">:=</span>&nbsp;<span class="num" id="8458241">1</span><span class="op" id="8458242">;</span>&nbsp;<span class="ident" id="8458244">i</span>&nbsp;<span class="op" id="8458246">&lt;=</span>&nbsp;<span class="num" id="8458249">2</span><span class="op" id="8458250">;</span>&nbsp;<span class="ident" id="8458252">i</span><span class="op" id="8458253">++</span>&nbsp;<span class="op" id="8458256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8458260">out</span><span class="op" id="8458263">,</span>&nbsp;<span class="ident" id="8458265">err</span>&nbsp;<span class="op" id="8458269">:=</span>&nbsp;<span class="ident" id="8458272">exec</span><span class="op" id="8458276">.</span><span class="ident" id="8458277">Command</span><span class="op" id="8458284">(</span><span class="ident" id="8458285">os</span><span class="op" id="8458287">.</span><span class="ident" id="8458288">Args</span><span class="op" id="8458292">[</span><span class="num" id="8458293">0</span><span class="op" id="8458294">]</span><span class="op" id="8458295">,</span>&nbsp;<span class="string" id="8458297">&#34;-test.run=TestStop&#34;</span><span class="op" id="8458317">,</span>&nbsp;<span class="string" id="8458319">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="8458343">+</span><span class="ident" id="8458344">strconv</span><span class="op" id="8458351">.</span><span class="ident" id="8458352">Itoa</span><span class="op" id="8458356">(</span><span class="ident" id="8458357">i</span><span class="op" id="8458358">)</span><span class="op" id="8458359">)</span><span class="op" id="8458360">.</span><span class="ident" id="8458361">CombinedOutput</span><span class="op" id="8458375">(</span><span class="op" id="8458376">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8458380">if</span>&nbsp;<span class="ident" id="8458383">err</span>&nbsp;<span class="op" id="8458387">==</span>&nbsp;<span class="ident" id="8458390">nil</span>&nbsp;<span class="op" id="8458394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8458399">t</span><span class="op" id="8458400">.</span><span class="ident" id="8458401">Fatalf</span><span class="op" id="8458407">(</span><span class="string" id="8458408">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="8458497">,</span>&nbsp;<span class="ident" id="8458499">i</span><span class="op" id="8458500">,</span>&nbsp;<span class="ident" id="8458502">out</span><span class="op" id="8458505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8458509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8458512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8458516">Stop</span><span class="op" id="8458520">(</span><span class="ident" id="8458521">c</span><span class="op" id="8458522">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8458526">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8458584">_</span><span class="op" id="8458585">,</span>&nbsp;<span class="ident" id="8458587">err</span>&nbsp;<span class="op" id="8458591">:=</span>&nbsp;<span class="ident" id="8458594">os</span><span class="op" id="8458596">.</span><span class="ident" id="8458597">Stat</span><span class="op" id="8458601">(</span><span class="string" id="8458602">&#34;/usr/bin/nohup&#34;</span><span class="op" id="8458618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8458621">if</span>&nbsp;<span class="ident" id="8458624">err</span>&nbsp;<span class="op" id="8458628">!=</span>&nbsp;<span class="ident" id="8458631">nil</span>&nbsp;<span class="op" id="8458635">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8458639">t</span><span class="op" id="8458640">.</span><span class="ident" id="8458641">Skip</span><span class="op" id="8458645">(</span><span class="string" id="8458646">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="8458695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8458698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8458702">for</span>&nbsp;<span class="ident" id="8458706">i</span>&nbsp;<span class="op" id="8458708">:=</span>&nbsp;<span class="num" id="8458711">1</span><span class="op" id="8458712">;</span>&nbsp;<span class="ident" id="8458714">i</span>&nbsp;<span class="op" id="8458716">&lt;=</span>&nbsp;<span class="num" id="8458719">2</span><span class="op" id="8458720">;</span>&nbsp;<span class="ident" id="8458722">i</span><span class="op" id="8458723">++</span>&nbsp;<span class="op" id="8458726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8458730">os</span><span class="op" id="8458732">.</span><span class="ident" id="8458733">Remove</span><span class="op" id="8458739">(</span><span class="string" id="8458740">&#34;nohup.out&#34;</span><span class="op" id="8458751">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8458755">out</span><span class="op" id="8458758">,</span>&nbsp;<span class="ident" id="8458760">err</span>&nbsp;<span class="op" id="8458764">:=</span>&nbsp;<span class="ident" id="8458767">exec</span><span class="op" id="8458771">.</span><span class="ident" id="8458772">Command</span><span class="op" id="8458779">(</span><span class="string" id="8458780">&#34;/usr/bin/nohup&#34;</span><span class="op" id="8458796">,</span>&nbsp;<span class="ident" id="8458798">os</span><span class="op" id="8458800">.</span><span class="ident" id="8458801">Args</span><span class="op" id="8458805">[</span><span class="num" id="8458806">0</span><span class="op" id="8458807">]</span><span class="op" id="8458808">,</span>&nbsp;<span class="string" id="8458810">&#34;-test.run=TestStop&#34;</span><span class="op" id="8458830">,</span>&nbsp;<span class="string" id="8458832">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="8458856">+</span><span class="ident" id="8458857">strconv</span><span class="op" id="8458864">.</span><span class="ident" id="8458865">Itoa</span><span class="op" id="8458869">(</span><span class="ident" id="8458870">i</span><span class="op" id="8458871">)</span><span class="op" id="8458872">)</span><span class="op" id="8458873">.</span><span class="ident" id="8458874">CombinedOutput</span><span class="op" id="8458888">(</span><span class="op" id="8458889">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8458894">data</span><span class="op" id="8458898">,</span>&nbsp;<span class="ident" id="8458900">_</span>&nbsp;<span class="op" id="8458902">:=</span>&nbsp;<span class="ident" id="8458905">ioutil</span><span class="op" id="8458911">.</span><span class="ident" id="8458912">ReadFile</span><span class="op" id="8458920">(</span><span class="string" id="8458921">&#34;nohup.out&#34;</span><span class="op" id="8458932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8458936">os</span><span class="op" id="8458938">.</span><span class="ident" id="8458939">Remove</span><span class="op" id="8458945">(</span><span class="string" id="8458946">&#34;nohup.out&#34;</span><span class="op" id="8458957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8458961">if</span>&nbsp;<span class="ident" id="8458964">err</span>&nbsp;<span class="op" id="8458968">!=</span>&nbsp;<span class="ident" id="8458971">nil</span>&nbsp;<span class="op" id="8458975">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8458980">t</span><span class="op" id="8458981">.</span><span class="ident" id="8458982">Fatalf</span><span class="op" id="8458988">(</span><span class="string" id="8458989">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="8459100">,</span>&nbsp;<span class="ident" id="8459102">i</span><span class="op" id="8459103">,</span>&nbsp;<span class="ident" id="8459105">err</span><span class="op" id="8459108">,</span>&nbsp;<span class="ident" id="8459110">out</span><span class="op" id="8459113">,</span>&nbsp;<span class="ident" id="8459115">data</span><span class="op" id="8459119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8459123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8459126">}</span><br>
<span class="lineno"></span><span class="op" id="8459128">}</span>
</div>
</body>
</html>
