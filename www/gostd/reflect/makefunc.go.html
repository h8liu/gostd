<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>reflect</h2>
<ul>
<li><a href="/gostd/reflect/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/reflect/deepequal.go.html">deepequal.go</a></li>
<li><a href="/gostd/reflect/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/reflect/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/reflect/makefunc.go.html">makefunc.go</a></li>
<li><a href="/gostd/reflect/set_test.go.html">set_test.go</a></li>
<li><a href="/gostd/reflect/tostring_test.go.html">tostring_test.go</a></li>
<li><a href="/gostd/reflect/type.go.html">type.go</a></li>
<li><a href="/gostd/reflect/value.go.html">value.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2879120">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2879176">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2879230">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2879281">//&nbsp;MakeFunc&nbsp;implementation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2879310">package</span>&nbsp;<span class="ident" id="2879318">reflect</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2879327">import</span>&nbsp;<span class="op" id="2879334">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2879337">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2879346">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2879349">//&nbsp;makeFuncImpl&nbsp;is&nbsp;the&nbsp;closure&nbsp;value&nbsp;implementing&nbsp;the&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2879412">//&nbsp;returned&nbsp;by&nbsp;MakeFunc.</span><br>
<span class="lineno">15</span><span class="keyword" id="2879437">type</span>&nbsp;<span class="ident" id="2879442">makeFuncImpl</span>&nbsp;<span class="keyword" id="2879455">struct</span>&nbsp;<span class="op" id="2879462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2879465">code</span>&nbsp;&nbsp;<span class="builtintype" id="2879471">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2879480">stack</span>&nbsp;<span class="op" id="2879486">*</span><span class="ident" id="2879487">bitVector</span>&nbsp;<span class="comment" id="2879497">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2879549">typ</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2879555">*</span><span class="ident" id="2879556">funcType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2879566">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2879572">func</span><span class="op" id="2879576">(</span><span class="op" id="2879577">[</span><span class="op" id="2879578">]</span><span class="ident" id="2879579">Value</span><span class="op" id="2879584">)</span>&nbsp;<span class="op" id="2879586">[</span><span class="op" id="2879587">]</span><span class="ident" id="2879588">Value</span><br>
<span class="lineno">20</span><span class="op" id="2879594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2879597">//&nbsp;MakeFunc&nbsp;returns&nbsp;a&nbsp;new&nbsp;function&nbsp;of&nbsp;the&nbsp;given&nbsp;Type</span><br>
<span class="lineno"></span><span class="comment" id="2879650">//&nbsp;that&nbsp;wraps&nbsp;the&nbsp;function&nbsp;fn.&nbsp;When&nbsp;called,&nbsp;that&nbsp;new&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2879712">//&nbsp;does&nbsp;the&nbsp;following:</span><br>
<span class="lineno">25</span><span class="comment" id="2879735">//</span><br>
<span class="lineno"></span><span class="comment" id="2879738">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;converts&nbsp;its&nbsp;arguments&nbsp;to&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values.</span><br>
<span class="lineno"></span><span class="comment" id="2879788">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;runs&nbsp;results&nbsp;:=&nbsp;fn(args).</span><br>
<span class="lineno"></span><span class="comment" id="2879819">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;returns&nbsp;the&nbsp;results&nbsp;as&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values,&nbsp;one&nbsp;per&nbsp;formal&nbsp;result.</span><br>
<span class="lineno"></span><span class="comment" id="2879889">//</span><br>
<span class="lineno">30</span><span class="comment" id="2879892">//&nbsp;The&nbsp;implementation&nbsp;fn&nbsp;can&nbsp;assume&nbsp;that&nbsp;the&nbsp;argument&nbsp;Value&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="2879958">//&nbsp;has&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;arguments&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2880012">//&nbsp;If&nbsp;typ&nbsp;describes&nbsp;a&nbsp;variadic&nbsp;function,&nbsp;the&nbsp;final&nbsp;Value&nbsp;is&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2880079">//&nbsp;a&nbsp;slice&nbsp;representing&nbsp;the&nbsp;variadic&nbsp;arguments,&nbsp;as&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2880137">//&nbsp;body&nbsp;of&nbsp;a&nbsp;variadic&nbsp;function.&nbsp;The&nbsp;result&nbsp;Value&nbsp;slice&nbsp;returned&nbsp;by&nbsp;fn</span><br>
<span class="lineno">35</span><span class="comment" id="2880207">//&nbsp;must&nbsp;have&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;results&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2880265">//</span><br>
<span class="lineno"></span><span class="comment" id="2880268">//&nbsp;The&nbsp;Value.Call&nbsp;method&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;invoke&nbsp;a&nbsp;typed&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2880338">//&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values;&nbsp;in&nbsp;contrast,&nbsp;MakeFunc&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span><span class="comment" id="2880414">//&nbsp;a&nbsp;typed&nbsp;function&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values.</span><br>
<span class="lineno">40</span><span class="comment" id="2880454">//</span><br>
<span class="lineno"></span><span class="comment" id="2880457">//&nbsp;The&nbsp;Examples&nbsp;section&nbsp;of&nbsp;the&nbsp;documentation&nbsp;includes&nbsp;an&nbsp;illustration</span><br>
<span class="lineno"></span><span class="comment" id="2880527">//&nbsp;of&nbsp;how&nbsp;to&nbsp;use&nbsp;MakeFunc&nbsp;to&nbsp;build&nbsp;a&nbsp;swap&nbsp;function&nbsp;for&nbsp;different&nbsp;types.</span><br>
<span class="lineno"></span><span class="comment" id="2880599">//</span><br>
<span class="lineno"></span><span class="keyword" id="2880602">func</span>&nbsp;<span class="ident" id="2880607">MakeFunc</span><span class="op" id="2880615">(</span><span class="ident" id="2880616">typ</span>&nbsp;<span class="ident" id="2880620">Type</span><span class="op" id="2880624">,</span>&nbsp;<span class="ident" id="2880626">fn</span>&nbsp;<span class="keyword" id="2880629">func</span><span class="op" id="2880633">(</span><span class="ident" id="2880634">args</span>&nbsp;<span class="op" id="2880639">[</span><span class="op" id="2880640">]</span><span class="ident" id="2880641">Value</span><span class="op" id="2880646">)</span>&nbsp;<span class="op" id="2880648">(</span><span class="ident" id="2880649">results</span>&nbsp;<span class="op" id="2880657">[</span><span class="op" id="2880658">]</span><span class="ident" id="2880659">Value</span><span class="op" id="2880664">)</span><span class="op" id="2880665">)</span>&nbsp;<span class="ident" id="2880667">Value</span>&nbsp;<span class="op" id="2880673">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2880676">if</span>&nbsp;<span class="ident" id="2880679">typ</span><span class="op" id="2880682">.</span><span class="ident" id="2880683">Kind</span><span class="op" id="2880687">(</span><span class="op" id="2880688">)</span>&nbsp;<span class="op" id="2880690">!=</span>&nbsp;<span class="ident" id="2880693">Func</span>&nbsp;<span class="op" id="2880698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2880702">panic</span><span class="op" id="2880707">(</span><span class="string" id="2880708">&#34;reflect:&nbsp;call&nbsp;of&nbsp;MakeFunc&nbsp;with&nbsp;non-Func&nbsp;type&#34;</span><span class="op" id="2880754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2880757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2880761">t</span>&nbsp;<span class="op" id="2880763">:=</span>&nbsp;<span class="ident" id="2880766">typ</span><span class="op" id="2880769">.</span><span class="ident" id="2880770">common</span><span class="op" id="2880776">(</span><span class="op" id="2880777">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2880780">ftyp</span>&nbsp;<span class="op" id="2880785">:=</span>&nbsp;<span class="op" id="2880788">(</span><span class="op" id="2880789">*</span><span class="ident" id="2880790">funcType</span><span class="op" id="2880798">)</span><span class="op" id="2880799">(</span><span class="ident" id="2880800">unsafe</span><span class="op" id="2880806">.</span><span class="ident" id="2880807">Pointer</span><span class="op" id="2880814">(</span><span class="ident" id="2880815">t</span><span class="op" id="2880816">)</span><span class="op" id="2880817">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2880821">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2880866">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2880921">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2880981">dummy</span>&nbsp;<span class="op" id="2880987">:=</span>&nbsp;<span class="ident" id="2880990">makeFuncStub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2881004">code</span>&nbsp;<span class="op" id="2881009">:=</span>&nbsp;<span class="op" id="2881012">*</span><span class="op" id="2881013">*</span><span class="op" id="2881014">(</span><span class="op" id="2881015">*</span><span class="op" id="2881016">*</span><span class="builtintype" id="2881017">uintptr</span><span class="op" id="2881024">)</span><span class="op" id="2881025">(</span><span class="ident" id="2881026">unsafe</span><span class="op" id="2881032">.</span><span class="ident" id="2881033">Pointer</span><span class="op" id="2881040">(</span><span class="op" id="2881041">&amp;</span><span class="ident" id="2881042">dummy</span><span class="op" id="2881047">)</span><span class="op" id="2881048">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2881052">//&nbsp;makeFuncImpl&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2881113">_</span><span class="op" id="2881114">,</span>&nbsp;<span class="ident" id="2881116">_</span><span class="op" id="2881117">,</span>&nbsp;<span class="ident" id="2881119">_</span><span class="op" id="2881120">,</span>&nbsp;<span class="ident" id="2881122">stack</span>&nbsp;<span class="op" id="2881128">:=</span>&nbsp;<span class="ident" id="2881131">funcLayout</span><span class="op" id="2881141">(</span><span class="ident" id="2881142">t</span><span class="op" id="2881143">,</span>&nbsp;<span class="ident" id="2881145">nil</span><span class="op" id="2881148">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2881152">impl</span>&nbsp;<span class="op" id="2881157">:=</span>&nbsp;<span class="op" id="2881160">&amp;</span><span class="ident" id="2881161">makeFuncImpl</span><span class="op" id="2881173">{</span><span class="ident" id="2881174">code</span><span class="op" id="2881178">:</span>&nbsp;<span class="ident" id="2881180">code</span><span class="op" id="2881184">,</span>&nbsp;<span class="ident" id="2881186">stack</span><span class="op" id="2881191">:</span>&nbsp;<span class="ident" id="2881193">stack</span><span class="op" id="2881198">,</span>&nbsp;<span class="ident" id="2881200">typ</span><span class="op" id="2881203">:</span>&nbsp;<span class="ident" id="2881205">ftyp</span><span class="op" id="2881209">,</span>&nbsp;<span class="ident" id="2881211">fn</span><span class="op" id="2881213">:</span>&nbsp;<span class="ident" id="2881215">fn</span><span class="op" id="2881217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2881221">return</span>&nbsp;<span class="ident" id="2881228">Value</span><span class="op" id="2881233">{</span><span class="ident" id="2881234">t</span><span class="op" id="2881235">,</span>&nbsp;<span class="ident" id="2881237">unsafe</span><span class="op" id="2881243">.</span><span class="ident" id="2881244">Pointer</span><span class="op" id="2881251">(</span><span class="ident" id="2881252">impl</span><span class="op" id="2881256">)</span><span class="op" id="2881257">,</span>&nbsp;<span class="ident" id="2881259">flag</span><span class="op" id="2881263">(</span><span class="ident" id="2881264">Func</span><span class="op" id="2881268">)</span><span class="op" id="2881269">}</span><br>
<span class="lineno"></span><span class="op" id="2881271">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2881274">//&nbsp;makeFuncStub&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2881339">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;MakeFunc.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*callReflectFunc</span><br>
<span class="lineno"></span><span class="comment" id="2881409">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callReflect(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2881487">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno">70</span><span class="comment" id="2881561">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2881602">func</span>&nbsp;<span class="ident" id="2881607">makeFuncStub</span><span class="op" id="2881619">(</span><span class="op" id="2881620">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2881623">type</span>&nbsp;<span class="ident" id="2881628">methodValue</span>&nbsp;<span class="keyword" id="2881640">struct</span>&nbsp;<span class="op" id="2881647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2881650">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2881657">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2881666">stack</span>&nbsp;&nbsp;<span class="op" id="2881673">*</span><span class="ident" id="2881674">bitVector</span>&nbsp;<span class="comment" id="2881684">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2881736">method</span>&nbsp;<span class="builtintype" id="2881743">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2881748">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2881755">Value</span><br>
<span class="lineno"></span><span class="op" id="2881761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="2881764">//&nbsp;makeMethodValue&nbsp;converts&nbsp;v&nbsp;from&nbsp;the&nbsp;rcvr+method&nbsp;index&nbsp;representation</span><br>
<span class="lineno"></span><span class="comment" id="2881836">//&nbsp;of&nbsp;a&nbsp;method&nbsp;value&nbsp;to&nbsp;an&nbsp;actual&nbsp;method&nbsp;func&nbsp;value,&nbsp;which&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2881898">//&nbsp;basically&nbsp;the&nbsp;receiver&nbsp;value&nbsp;with&nbsp;a&nbsp;special&nbsp;bit&nbsp;set,&nbsp;into&nbsp;a&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="2881966">//&nbsp;func&nbsp;value&nbsp;-&nbsp;a&nbsp;value&nbsp;holding&nbsp;an&nbsp;actual&nbsp;func.&nbsp;The&nbsp;output&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2882028">//&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;input&nbsp;as&nbsp;far&nbsp;as&nbsp;the&nbsp;user&nbsp;of&nbsp;package</span><br>
<span class="lineno">85</span><span class="comment" id="2882098">//&nbsp;reflect&nbsp;can&nbsp;tell,&nbsp;but&nbsp;the&nbsp;true&nbsp;func&nbsp;representation&nbsp;can&nbsp;be&nbsp;handled</span><br>
<span class="lineno"></span><span class="comment" id="2882167">//&nbsp;by&nbsp;code&nbsp;like&nbsp;Convert&nbsp;and&nbsp;Interface&nbsp;and&nbsp;Assign.</span><br>
<span class="lineno"></span><span class="keyword" id="2882217">func</span>&nbsp;<span class="ident" id="2882222">makeMethodValue</span><span class="op" id="2882237">(</span><span class="ident" id="2882238">op</span>&nbsp;<span class="builtintype" id="2882241">string</span><span class="op" id="2882247">,</span>&nbsp;<span class="ident" id="2882249">v</span>&nbsp;<span class="ident" id="2882251">Value</span><span class="op" id="2882256">)</span>&nbsp;<span class="ident" id="2882258">Value</span>&nbsp;<span class="op" id="2882264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2882267">if</span>&nbsp;<span class="ident" id="2882270">v</span><span class="op" id="2882271">.</span><span class="ident" id="2882272">flag</span><span class="op" id="2882276">&amp;</span><span class="ident" id="2882277">flagMethod</span>&nbsp;<span class="op" id="2882288">==</span>&nbsp;<span class="num" id="2882291">0</span>&nbsp;<span class="op" id="2882293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2882297">panic</span><span class="op" id="2882302">(</span><span class="string" id="2882303">&#34;reflect:&nbsp;internal&nbsp;error:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;makeMethodValue&#34;</span><span class="op" id="2882360">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2882363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2882367">//&nbsp;Ignoring&nbsp;the&nbsp;flagMethod&nbsp;bit,&nbsp;v&nbsp;describes&nbsp;the&nbsp;receiver,&nbsp;not&nbsp;the&nbsp;method&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2882447">fl</span>&nbsp;<span class="op" id="2882450">:=</span>&nbsp;<span class="ident" id="2882453">v</span><span class="op" id="2882454">.</span><span class="ident" id="2882455">flag</span>&nbsp;<span class="op" id="2882460">&amp;</span>&nbsp;<span class="op" id="2882462">(</span><span class="ident" id="2882463">flagRO</span>&nbsp;<span class="op" id="2882470">|</span>&nbsp;<span class="ident" id="2882472">flagAddr</span>&nbsp;<span class="op" id="2882481">|</span>&nbsp;<span class="ident" id="2882483">flagIndir</span><span class="op" id="2882492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2882495">fl</span>&nbsp;<span class="op" id="2882498">|=</span>&nbsp;<span class="ident" id="2882501">flag</span><span class="op" id="2882505">(</span><span class="ident" id="2882506">v</span><span class="op" id="2882507">.</span><span class="ident" id="2882508">typ</span><span class="op" id="2882511">.</span><span class="ident" id="2882512">Kind</span><span class="op" id="2882516">(</span><span class="op" id="2882517">)</span><span class="op" id="2882518">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2882521">rcvr</span>&nbsp;<span class="op" id="2882526">:=</span>&nbsp;<span class="ident" id="2882529">Value</span><span class="op" id="2882534">{</span><span class="ident" id="2882535">v</span><span class="op" id="2882536">.</span><span class="ident" id="2882537">typ</span><span class="op" id="2882540">,</span>&nbsp;<span class="ident" id="2882542">v</span><span class="op" id="2882543">.</span><span class="ident" id="2882544">ptr</span><span class="op" id="2882547">,</span>&nbsp;<span class="ident" id="2882549">fl</span><span class="op" id="2882551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2882555">//&nbsp;v.Type&nbsp;returns&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2882611">funcType</span>&nbsp;<span class="op" id="2882620">:=</span>&nbsp;<span class="ident" id="2882623">v</span><span class="op" id="2882624">.</span><span class="ident" id="2882625">Type</span><span class="op" id="2882629">(</span><span class="op" id="2882630">)</span><span class="op" id="2882631">.</span><span class="op" id="2882632">(</span><span class="op" id="2882633">*</span><span class="ident" id="2882634">rtype</span><span class="op" id="2882639">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2882643">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2882688">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2882743">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2882803">dummy</span>&nbsp;<span class="op" id="2882809">:=</span>&nbsp;<span class="ident" id="2882812">methodValueCall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2882829">code</span>&nbsp;<span class="op" id="2882834">:=</span>&nbsp;<span class="op" id="2882837">*</span><span class="op" id="2882838">*</span><span class="op" id="2882839">(</span><span class="op" id="2882840">*</span><span class="op" id="2882841">*</span><span class="builtintype" id="2882842">uintptr</span><span class="op" id="2882849">)</span><span class="op" id="2882850">(</span><span class="ident" id="2882851">unsafe</span><span class="op" id="2882857">.</span><span class="ident" id="2882858">Pointer</span><span class="op" id="2882865">(</span><span class="op" id="2882866">&amp;</span><span class="ident" id="2882867">dummy</span><span class="op" id="2882872">)</span><span class="op" id="2882873">)</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2882877">//&nbsp;methodValue&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2882937">_</span><span class="op" id="2882938">,</span>&nbsp;<span class="ident" id="2882940">_</span><span class="op" id="2882941">,</span>&nbsp;<span class="ident" id="2882943">_</span><span class="op" id="2882944">,</span>&nbsp;<span class="ident" id="2882946">stack</span>&nbsp;<span class="op" id="2882952">:=</span>&nbsp;<span class="ident" id="2882955">funcLayout</span><span class="op" id="2882965">(</span><span class="ident" id="2882966">funcType</span><span class="op" id="2882974">,</span>&nbsp;<span class="ident" id="2882976">nil</span><span class="op" id="2882979">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2882983">fv</span>&nbsp;<span class="op" id="2882986">:=</span>&nbsp;<span class="op" id="2882989">&amp;</span><span class="ident" id="2882990">methodValue</span><span class="op" id="2883001">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2883005">fn</span><span class="op" id="2883007">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2883013">code</span><span class="op" id="2883017">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2883021">stack</span><span class="op" id="2883026">:</span>&nbsp;&nbsp;<span class="ident" id="2883029">stack</span><span class="op" id="2883034">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2883038">method</span><span class="op" id="2883044">:</span>&nbsp;<span class="builtintype" id="2883046">int</span><span class="op" id="2883049">(</span><span class="ident" id="2883050">v</span><span class="op" id="2883051">.</span><span class="ident" id="2883052">flag</span><span class="op" id="2883056">)</span>&nbsp;<span class="op" id="2883058">&gt;&gt;</span>&nbsp;<span class="ident" id="2883061">flagMethodShift</span><span class="op" id="2883076">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2883080">rcvr</span><span class="op" id="2883084">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2883088">rcvr</span><span class="op" id="2883092">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2883095">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2883099">//&nbsp;Cause&nbsp;panic&nbsp;if&nbsp;method&nbsp;is&nbsp;not&nbsp;appropriate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2883145">//&nbsp;The&nbsp;panic&nbsp;would&nbsp;still&nbsp;happen&nbsp;during&nbsp;the&nbsp;call&nbsp;if&nbsp;we&nbsp;omit&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2883211">//&nbsp;but&nbsp;we&nbsp;want&nbsp;Interface()&nbsp;and&nbsp;other&nbsp;operations&nbsp;to&nbsp;fail&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2883275">methodReceiver</span><span class="op" id="2883289">(</span><span class="ident" id="2883290">op</span><span class="op" id="2883292">,</span>&nbsp;<span class="ident" id="2883294">fv</span><span class="op" id="2883296">.</span><span class="ident" id="2883297">rcvr</span><span class="op" id="2883301">,</span>&nbsp;<span class="ident" id="2883303">fv</span><span class="op" id="2883305">.</span><span class="ident" id="2883306">method</span><span class="op" id="2883312">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2883316">return</span>&nbsp;<span class="ident" id="2883323">Value</span><span class="op" id="2883328">{</span><span class="ident" id="2883329">funcType</span><span class="op" id="2883337">,</span>&nbsp;<span class="ident" id="2883339">unsafe</span><span class="op" id="2883345">.</span><span class="ident" id="2883346">Pointer</span><span class="op" id="2883353">(</span><span class="ident" id="2883354">fv</span><span class="op" id="2883356">)</span><span class="op" id="2883357">,</span>&nbsp;<span class="ident" id="2883359">v</span><span class="op" id="2883360">.</span><span class="ident" id="2883361">flag</span><span class="op" id="2883365">&amp;</span><span class="ident" id="2883366">flagRO</span>&nbsp;<span class="op" id="2883373">|</span>&nbsp;<span class="ident" id="2883375">flag</span><span class="op" id="2883379">(</span><span class="ident" id="2883380">Func</span><span class="op" id="2883384">)</span><span class="op" id="2883385">}</span><br>
<span class="lineno"></span><span class="op" id="2883387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2883390">//&nbsp;methodValueCall&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno">125</span><span class="comment" id="2883458">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;makeMethodValue.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*methodValue</span><br>
<span class="lineno"></span><span class="comment" id="2883531">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callMethod(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2883608">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="2883682">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2883723">func</span>&nbsp;<span class="ident" id="2883728">methodValueCall</span><span class="op" id="2883743">(</span><span class="op" id="2883744">)</span>
</div>
</body>
</html>
