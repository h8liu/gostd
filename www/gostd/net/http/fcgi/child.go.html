<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5577374">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5577429">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5577483">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5577534">package</span>&nbsp;<span class="ident" id="5577542">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5577548">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5577622">import</span>&nbsp;<span class="op" id="5577629">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577632">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577642">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577649">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577655">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577668">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577675">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577687">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577703">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577709">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577720">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5577728">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5577735">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5577738">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="5577819">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="5577857">type</span>&nbsp;<span class="ident" id="5577862">request</span>&nbsp;<span class="keyword" id="5577870">struct</span>&nbsp;<span class="op" id="5577877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577880">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5577890">*</span><span class="ident" id="5577891">io</span><span class="op" id="5577893">.</span><span class="ident" id="5577894">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577906">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5577916">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577924">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5577934">map</span><span class="op" id="5577937">[</span><span class="builtintype" id="5577938">string</span><span class="op" id="5577944">]</span><span class="builtintype" id="5577945">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577953">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5577963">[</span><span class="num" id="5577964">1024</span><span class="op" id="5577968">]</span><span class="builtintype" id="5577969">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577975">rawParams</span>&nbsp;<span class="op" id="5577985">[</span><span class="op" id="5577986">]</span><span class="builtintype" id="5577987">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577993">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="5578003">bool</span><br>
<span class="lineno"></span><span class="op" id="5578008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5578011">func</span>&nbsp;<span class="ident" id="5578016">newRequest</span><span class="op" id="5578026">(</span><span class="ident" id="5578027">reqId</span>&nbsp;<span class="builtintype" id="5578033">uint16</span><span class="op" id="5578039">,</span>&nbsp;<span class="ident" id="5578041">flags</span>&nbsp;<span class="builtintype" id="5578047">uint8</span><span class="op" id="5578052">)</span>&nbsp;<span class="op" id="5578054">*</span><span class="ident" id="5578055">request</span>&nbsp;<span class="op" id="5578063">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578066">r</span>&nbsp;<span class="op" id="5578068">:=</span>&nbsp;<span class="op" id="5578071">&amp;</span><span class="ident" id="5578072">request</span><span class="op" id="5578079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578083">reqId</span><span class="op" id="5578088">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5578093">reqId</span><span class="op" id="5578098">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578102">params</span><span class="op" id="5578108">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="5578112">map</span><span class="op" id="5578115">[</span><span class="builtintype" id="5578116">string</span><span class="op" id="5578122">]</span><span class="builtintype" id="5578123">string</span><span class="op" id="5578129">{</span><span class="op" id="5578130">}</span><span class="op" id="5578131">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578135">keepConn</span><span class="op" id="5578143">:</span>&nbsp;<span class="ident" id="5578145">flags</span><span class="op" id="5578150">&amp;</span><span class="ident" id="5578151">flagKeepConn</span>&nbsp;<span class="op" id="5578164">!=</span>&nbsp;<span class="num" id="5578167">0</span><span class="op" id="5578168">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578171">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578174">r</span><span class="op" id="5578175">.</span><span class="ident" id="5578176">rawParams</span>&nbsp;<span class="op" id="5578186">=</span>&nbsp;<span class="ident" id="5578188">r</span><span class="op" id="5578189">.</span><span class="ident" id="5578190">buf</span><span class="op" id="5578193">[</span><span class="op" id="5578194">:</span><span class="num" id="5578195">0</span><span class="op" id="5578196">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578199">return</span>&nbsp;<span class="ident" id="5578206">r</span><br>
<span class="lineno"></span><span class="op" id="5578208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5578211">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="5578263">func</span>&nbsp;<span class="op" id="5578268">(</span><span class="ident" id="5578269">r</span>&nbsp;<span class="op" id="5578271">*</span><span class="ident" id="5578272">request</span><span class="op" id="5578279">)</span>&nbsp;<span class="ident" id="5578281">parseParams</span><span class="op" id="5578292">(</span><span class="op" id="5578293">)</span>&nbsp;<span class="op" id="5578295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578298">text</span>&nbsp;<span class="op" id="5578303">:=</span>&nbsp;<span class="ident" id="5578306">r</span><span class="op" id="5578307">.</span><span class="ident" id="5578308">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578319">r</span><span class="op" id="5578320">.</span><span class="ident" id="5578321">rawParams</span>&nbsp;<span class="op" id="5578331">=</span>&nbsp;<span class="ident" id="5578333">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578338">for</span>&nbsp;<span class="builtinfunc" id="5578342">len</span><span class="op" id="5578345">(</span><span class="ident" id="5578346">text</span><span class="op" id="5578350">)</span>&nbsp;<span class="op" id="5578352">&gt;</span>&nbsp;<span class="num" id="5578354">0</span>&nbsp;<span class="op" id="5578356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578360">keyLen</span><span class="op" id="5578366">,</span>&nbsp;<span class="ident" id="5578368">n</span>&nbsp;<span class="op" id="5578370">:=</span>&nbsp;<span class="ident" id="5578373">readSize</span><span class="op" id="5578381">(</span><span class="ident" id="5578382">text</span><span class="op" id="5578386">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578390">if</span>&nbsp;<span class="ident" id="5578393">n</span>&nbsp;<span class="op" id="5578395">==</span>&nbsp;<span class="num" id="5578398">0</span>&nbsp;<span class="op" id="5578400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578405">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578418">text</span>&nbsp;<span class="op" id="5578423">=</span>&nbsp;<span class="ident" id="5578425">text</span><span class="op" id="5578429">[</span><span class="ident" id="5578430">n</span><span class="op" id="5578431">:</span><span class="op" id="5578432">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578436">valLen</span><span class="op" id="5578442">,</span>&nbsp;<span class="ident" id="5578444">n</span>&nbsp;<span class="op" id="5578446">:=</span>&nbsp;<span class="ident" id="5578449">readSize</span><span class="op" id="5578457">(</span><span class="ident" id="5578458">text</span><span class="op" id="5578462">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578466">if</span>&nbsp;<span class="ident" id="5578469">n</span>&nbsp;<span class="op" id="5578471">==</span>&nbsp;<span class="num" id="5578474">0</span>&nbsp;<span class="op" id="5578476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578481">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578494">text</span>&nbsp;<span class="op" id="5578499">=</span>&nbsp;<span class="ident" id="5578501">text</span><span class="op" id="5578505">[</span><span class="ident" id="5578506">n</span><span class="op" id="5578507">:</span><span class="op" id="5578508">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578512">key</span>&nbsp;<span class="op" id="5578516">:=</span>&nbsp;<span class="ident" id="5578519">readString</span><span class="op" id="5578529">(</span><span class="ident" id="5578530">text</span><span class="op" id="5578534">,</span>&nbsp;<span class="ident" id="5578536">keyLen</span><span class="op" id="5578542">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578546">text</span>&nbsp;<span class="op" id="5578551">=</span>&nbsp;<span class="ident" id="5578553">text</span><span class="op" id="5578557">[</span><span class="ident" id="5578558">keyLen</span><span class="op" id="5578564">:</span><span class="op" id="5578565">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578569">val</span>&nbsp;<span class="op" id="5578573">:=</span>&nbsp;<span class="ident" id="5578576">readString</span><span class="op" id="5578586">(</span><span class="ident" id="5578587">text</span><span class="op" id="5578591">,</span>&nbsp;<span class="ident" id="5578593">valLen</span><span class="op" id="5578599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578603">text</span>&nbsp;<span class="op" id="5578608">=</span>&nbsp;<span class="ident" id="5578610">text</span><span class="op" id="5578614">[</span><span class="ident" id="5578615">valLen</span><span class="op" id="5578621">:</span><span class="op" id="5578622">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578626">r</span><span class="op" id="5578627">.</span><span class="ident" id="5578628">params</span><span class="op" id="5578634">[</span><span class="ident" id="5578635">key</span><span class="op" id="5578638">]</span>&nbsp;<span class="op" id="5578640">=</span>&nbsp;<span class="ident" id="5578642">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578647">}</span><br>
<span class="lineno">65</span><span class="op" id="5578649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5578652">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="5578696">type</span>&nbsp;<span class="ident" id="5578701">response</span>&nbsp;<span class="keyword" id="5578710">struct</span>&nbsp;<span class="op" id="5578717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578720">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5578732">*</span><span class="ident" id="5578733">request</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578742">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5578754">http</span><span class="op" id="5578758">.</span><span class="ident" id="5578759">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578767">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5578779">*</span><span class="ident" id="5578780">bufWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578791">wroteHeader</span>&nbsp;<span class="builtintype" id="5578803">bool</span><br>
<span class="lineno"></span><span class="op" id="5578808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="5578811">func</span>&nbsp;<span class="ident" id="5578816">newResponse</span><span class="op" id="5578827">(</span><span class="ident" id="5578828">c</span>&nbsp;<span class="op" id="5578830">*</span><span class="ident" id="5578831">child</span><span class="op" id="5578836">,</span>&nbsp;<span class="ident" id="5578838">req</span>&nbsp;<span class="op" id="5578842">*</span><span class="ident" id="5578843">request</span><span class="op" id="5578850">)</span>&nbsp;<span class="op" id="5578852">*</span><span class="ident" id="5578853">response</span>&nbsp;<span class="op" id="5578862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578865">return</span>&nbsp;<span class="op" id="5578872">&amp;</span><span class="ident" id="5578873">response</span><span class="op" id="5578881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578885">req</span><span class="op" id="5578888">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5578893">req</span><span class="op" id="5578896">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578900">header</span><span class="op" id="5578906">:</span>&nbsp;<span class="ident" id="5578908">http</span><span class="op" id="5578912">.</span><span class="ident" id="5578913">Header</span><span class="op" id="5578919">{</span><span class="op" id="5578920">}</span><span class="op" id="5578921">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578925">w</span><span class="op" id="5578926">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5578933">newWriter</span><span class="op" id="5578942">(</span><span class="ident" id="5578943">c</span><span class="op" id="5578944">.</span><span class="ident" id="5578945">conn</span><span class="op" id="5578949">,</span>&nbsp;<span class="ident" id="5578951">typeStdout</span><span class="op" id="5578961">,</span>&nbsp;<span class="ident" id="5578963">req</span><span class="op" id="5578966">.</span><span class="ident" id="5578967">reqId</span><span class="op" id="5578972">)</span><span class="op" id="5578973">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578976">}</span><br>
<span class="lineno"></span><span class="op" id="5578978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5578981">func</span>&nbsp;<span class="op" id="5578986">(</span><span class="ident" id="5578987">r</span>&nbsp;<span class="op" id="5578989">*</span><span class="ident" id="5578990">response</span><span class="op" id="5578998">)</span>&nbsp;<span class="ident" id="5579000">Header</span><span class="op" id="5579006">(</span><span class="op" id="5579007">)</span>&nbsp;<span class="ident" id="5579009">http</span><span class="op" id="5579013">.</span><span class="ident" id="5579014">Header</span>&nbsp;<span class="op" id="5579021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579024">return</span>&nbsp;<span class="ident" id="5579031">r</span><span class="op" id="5579032">.</span><span class="ident" id="5579033">header</span><br>
<span class="lineno">85</span><span class="op" id="5579040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5579043">func</span>&nbsp;<span class="op" id="5579048">(</span><span class="ident" id="5579049">r</span>&nbsp;<span class="op" id="5579051">*</span><span class="ident" id="5579052">response</span><span class="op" id="5579060">)</span>&nbsp;<span class="ident" id="5579062">Write</span><span class="op" id="5579067">(</span><span class="ident" id="5579068">data</span>&nbsp;<span class="op" id="5579073">[</span><span class="op" id="5579074">]</span><span class="builtintype" id="5579075">byte</span><span class="op" id="5579079">)</span>&nbsp;<span class="op" id="5579081">(</span><span class="builtintype" id="5579082">int</span><span class="op" id="5579085">,</span>&nbsp;<span class="builtintype" id="5579087">error</span><span class="op" id="5579092">)</span>&nbsp;<span class="op" id="5579094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579097">if</span>&nbsp;<span class="op" id="5579100">!</span><span class="ident" id="5579101">r</span><span class="op" id="5579102">.</span><span class="ident" id="5579103">wroteHeader</span>&nbsp;<span class="op" id="5579115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579119">r</span><span class="op" id="5579120">.</span><span class="ident" id="5579121">WriteHeader</span><span class="op" id="5579132">(</span><span class="ident" id="5579133">http</span><span class="op" id="5579137">.</span><span class="ident" id="5579138">StatusOK</span><span class="op" id="5579146">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5579149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579152">return</span>&nbsp;<span class="ident" id="5579159">r</span><span class="op" id="5579160">.</span><span class="ident" id="5579161">w</span><span class="op" id="5579162">.</span><span class="ident" id="5579163">Write</span><span class="op" id="5579168">(</span><span class="ident" id="5579169">data</span><span class="op" id="5579173">)</span><br>
<span class="lineno"></span><span class="op" id="5579175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5579178">func</span>&nbsp;<span class="op" id="5579183">(</span><span class="ident" id="5579184">r</span>&nbsp;<span class="op" id="5579186">*</span><span class="ident" id="5579187">response</span><span class="op" id="5579195">)</span>&nbsp;<span class="ident" id="5579197">WriteHeader</span><span class="op" id="5579208">(</span><span class="ident" id="5579209">code</span>&nbsp;<span class="builtintype" id="5579214">int</span><span class="op" id="5579217">)</span>&nbsp;<span class="op" id="5579219">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579222">if</span>&nbsp;<span class="ident" id="5579225">r</span><span class="op" id="5579226">.</span><span class="ident" id="5579227">wroteHeader</span>&nbsp;<span class="op" id="5579239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579243">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5579251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579254">r</span><span class="op" id="5579255">.</span><span class="ident" id="5579256">wroteHeader</span>&nbsp;<span class="op" id="5579268">=</span>&nbsp;<span class="builtintype" id="5579270">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579276">if</span>&nbsp;<span class="ident" id="5579279">code</span>&nbsp;<span class="op" id="5579284">==</span>&nbsp;<span class="ident" id="5579287">http</span><span class="op" id="5579291">.</span><span class="ident" id="5579292">StatusNotModified</span>&nbsp;<span class="op" id="5579310">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5579314">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579339">r</span><span class="op" id="5579340">.</span><span class="ident" id="5579341">header</span><span class="op" id="5579347">.</span><span class="ident" id="5579348">Del</span><span class="op" id="5579351">(</span><span class="string" id="5579352">&#34;Content-Type&#34;</span><span class="op" id="5579366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579370">r</span><span class="op" id="5579371">.</span><span class="ident" id="5579372">header</span><span class="op" id="5579378">.</span><span class="ident" id="5579379">Del</span><span class="op" id="5579382">(</span><span class="string" id="5579383">&#34;Content-Length&#34;</span><span class="op" id="5579399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579403">r</span><span class="op" id="5579404">.</span><span class="ident" id="5579405">header</span><span class="op" id="5579411">.</span><span class="ident" id="5579412">Del</span><span class="op" id="5579415">(</span><span class="string" id="5579416">&#34;Transfer-Encoding&#34;</span><span class="op" id="5579435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5579438">}</span>&nbsp;<span class="keyword" id="5579440">else</span>&nbsp;<span class="keyword" id="5579445">if</span>&nbsp;<span class="ident" id="5579448">r</span><span class="op" id="5579449">.</span><span class="ident" id="5579450">header</span><span class="op" id="5579456">.</span><span class="ident" id="5579457">Get</span><span class="op" id="5579460">(</span><span class="string" id="5579461">&#34;Content-Type&#34;</span><span class="op" id="5579475">)</span>&nbsp;<span class="op" id="5579477">==</span>&nbsp;<span class="string" id="5579480">&#34;&#34;</span>&nbsp;<span class="op" id="5579483">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579487">r</span><span class="op" id="5579488">.</span><span class="ident" id="5579489">header</span><span class="op" id="5579495">.</span><span class="ident" id="5579496">Set</span><span class="op" id="5579499">(</span><span class="string" id="5579500">&#34;Content-Type&#34;</span><span class="op" id="5579514">,</span>&nbsp;<span class="string" id="5579516">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5579542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5579545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579549">if</span>&nbsp;<span class="ident" id="5579552">r</span><span class="op" id="5579553">.</span><span class="ident" id="5579554">header</span><span class="op" id="5579560">.</span><span class="ident" id="5579561">Get</span><span class="op" id="5579564">(</span><span class="string" id="5579565">&#34;Date&#34;</span><span class="op" id="5579571">)</span>&nbsp;<span class="op" id="5579573">==</span>&nbsp;<span class="string" id="5579576">&#34;&#34;</span>&nbsp;<span class="op" id="5579579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579583">r</span><span class="op" id="5579584">.</span><span class="ident" id="5579585">header</span><span class="op" id="5579591">.</span><span class="ident" id="5579592">Set</span><span class="op" id="5579595">(</span><span class="string" id="5579596">&#34;Date&#34;</span><span class="op" id="5579602">,</span>&nbsp;<span class="ident" id="5579604">time</span><span class="op" id="5579608">.</span><span class="ident" id="5579609">Now</span><span class="op" id="5579612">(</span><span class="op" id="5579613">)</span><span class="op" id="5579614">.</span><span class="ident" id="5579615">UTC</span><span class="op" id="5579618">(</span><span class="op" id="5579619">)</span><span class="op" id="5579620">.</span><span class="ident" id="5579621">Format</span><span class="op" id="5579627">(</span><span class="ident" id="5579628">http</span><span class="op" id="5579632">.</span><span class="ident" id="5579633">TimeFormat</span><span class="op" id="5579643">)</span><span class="op" id="5579644">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5579647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579651">fmt</span><span class="op" id="5579654">.</span><span class="ident" id="5579655">Fprintf</span><span class="op" id="5579662">(</span><span class="ident" id="5579663">r</span><span class="op" id="5579664">.</span><span class="ident" id="5579665">w</span><span class="op" id="5579666">,</span>&nbsp;<span class="string" id="5579668">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="5579687">,</span>&nbsp;<span class="ident" id="5579689">code</span><span class="op" id="5579693">,</span>&nbsp;<span class="ident" id="5579695">http</span><span class="op" id="5579699">.</span><span class="ident" id="5579700">StatusText</span><span class="op" id="5579710">(</span><span class="ident" id="5579711">code</span><span class="op" id="5579715">)</span><span class="op" id="5579716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579719">r</span><span class="op" id="5579720">.</span><span class="ident" id="5579721">header</span><span class="op" id="5579727">.</span><span class="ident" id="5579728">Write</span><span class="op" id="5579733">(</span><span class="ident" id="5579734">r</span><span class="op" id="5579735">.</span><span class="ident" id="5579736">w</span><span class="op" id="5579737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579740">r</span><span class="op" id="5579741">.</span><span class="ident" id="5579742">w</span><span class="op" id="5579743">.</span><span class="ident" id="5579744">WriteString</span><span class="op" id="5579755">(</span><span class="string" id="5579756">&#34;\r\n&#34;</span><span class="op" id="5579762">)</span><br>
<span class="lineno">115</span><span class="op" id="5579764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5579767">func</span>&nbsp;<span class="op" id="5579772">(</span><span class="ident" id="5579773">r</span>&nbsp;<span class="op" id="5579775">*</span><span class="ident" id="5579776">response</span><span class="op" id="5579784">)</span>&nbsp;<span class="ident" id="5579786">Flush</span><span class="op" id="5579791">(</span><span class="op" id="5579792">)</span>&nbsp;<span class="op" id="5579794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579797">if</span>&nbsp;<span class="op" id="5579800">!</span><span class="ident" id="5579801">r</span><span class="op" id="5579802">.</span><span class="ident" id="5579803">wroteHeader</span>&nbsp;<span class="op" id="5579815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579819">r</span><span class="op" id="5579820">.</span><span class="ident" id="5579821">WriteHeader</span><span class="op" id="5579832">(</span><span class="ident" id="5579833">http</span><span class="op" id="5579837">.</span><span class="ident" id="5579838">StatusOK</span><span class="op" id="5579846">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5579849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579852">r</span><span class="op" id="5579853">.</span><span class="ident" id="5579854">w</span><span class="op" id="5579855">.</span><span class="ident" id="5579856">Flush</span><span class="op" id="5579861">(</span><span class="op" id="5579862">)</span><br>
<span class="lineno"></span><span class="op" id="5579864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5579867">func</span>&nbsp;<span class="op" id="5579872">(</span><span class="ident" id="5579873">r</span>&nbsp;<span class="op" id="5579875">*</span><span class="ident" id="5579876">response</span><span class="op" id="5579884">)</span>&nbsp;<span class="ident" id="5579886">Close</span><span class="op" id="5579891">(</span><span class="op" id="5579892">)</span>&nbsp;<span class="builtintype" id="5579894">error</span>&nbsp;<span class="op" id="5579900">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579903">r</span><span class="op" id="5579904">.</span><span class="ident" id="5579905">Flush</span><span class="op" id="5579910">(</span><span class="op" id="5579911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579914">return</span>&nbsp;<span class="ident" id="5579921">r</span><span class="op" id="5579922">.</span><span class="ident" id="5579923">w</span><span class="op" id="5579924">.</span><span class="ident" id="5579925">Close</span><span class="op" id="5579930">(</span><span class="op" id="5579931">)</span><br>
<span class="lineno"></span><span class="op" id="5579933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5579936">type</span>&nbsp;<span class="ident" id="5579941">child</span>&nbsp;<span class="keyword" id="5579947">struct</span>&nbsp;<span class="op" id="5579954">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579957">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5579965">*</span><span class="ident" id="5579966">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579972">handler</span>&nbsp;<span class="ident" id="5579980">http</span><span class="op" id="5579984">.</span><span class="ident" id="5579985">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579995">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5580004">sync</span><span class="op" id="5580008">.</span><span class="ident" id="5580009">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5580024">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580047">requests</span>&nbsp;<span class="keyword" id="5580056">map</span><span class="op" id="5580059">[</span><span class="builtintype" id="5580060">uint16</span><span class="op" id="5580066">]</span><span class="op" id="5580067">*</span><span class="ident" id="5580068">request</span>&nbsp;<span class="comment" id="5580076">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="5580099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5580102">func</span>&nbsp;<span class="ident" id="5580107">newChild</span><span class="op" id="5580115">(</span><span class="ident" id="5580116">rwc</span>&nbsp;<span class="ident" id="5580120">io</span><span class="op" id="5580122">.</span><span class="ident" id="5580123">ReadWriteCloser</span><span class="op" id="5580138">,</span>&nbsp;<span class="ident" id="5580140">handler</span>&nbsp;<span class="ident" id="5580148">http</span><span class="op" id="5580152">.</span><span class="ident" id="5580153">Handler</span><span class="op" id="5580160">)</span>&nbsp;<span class="op" id="5580162">*</span><span class="ident" id="5580163">child</span>&nbsp;<span class="op" id="5580169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580172">return</span>&nbsp;<span class="op" id="5580179">&amp;</span><span class="ident" id="5580180">child</span><span class="op" id="5580185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580189">conn</span><span class="op" id="5580193">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5580199">newConn</span><span class="op" id="5580206">(</span><span class="ident" id="5580207">rwc</span><span class="op" id="5580210">)</span><span class="op" id="5580211">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580215">handler</span><span class="op" id="5580222">:</span>&nbsp;&nbsp;<span class="ident" id="5580225">handler</span><span class="op" id="5580232">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580236">requests</span><span class="op" id="5580244">:</span>&nbsp;<span class="builtinfunc" id="5580246">make</span><span class="op" id="5580250">(</span><span class="keyword" id="5580251">map</span><span class="op" id="5580254">[</span><span class="builtintype" id="5580255">uint16</span><span class="op" id="5580261">]</span><span class="op" id="5580262">*</span><span class="ident" id="5580263">request</span><span class="op" id="5580270">)</span><span class="op" id="5580271">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580274">}</span><br>
<span class="lineno"></span><span class="op" id="5580276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5580279">func</span>&nbsp;<span class="op" id="5580284">(</span><span class="ident" id="5580285">c</span>&nbsp;<span class="op" id="5580287">*</span><span class="ident" id="5580288">child</span><span class="op" id="5580293">)</span>&nbsp;<span class="ident" id="5580295">serve</span><span class="op" id="5580300">(</span><span class="op" id="5580301">)</span>&nbsp;<span class="op" id="5580303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580306">defer</span>&nbsp;<span class="ident" id="5580312">c</span><span class="op" id="5580313">.</span><span class="ident" id="5580314">conn</span><span class="op" id="5580318">.</span><span class="ident" id="5580319">Close</span><span class="op" id="5580324">(</span><span class="op" id="5580325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580328">var</span>&nbsp;<span class="ident" id="5580332">rec</span>&nbsp;<span class="ident" id="5580336">record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580344">for</span>&nbsp;<span class="op" id="5580348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580352">if</span>&nbsp;<span class="ident" id="5580355">err</span>&nbsp;<span class="op" id="5580359">:=</span>&nbsp;<span class="ident" id="5580362">rec</span><span class="op" id="5580365">.</span><span class="ident" id="5580366">read</span><span class="op" id="5580370">(</span><span class="ident" id="5580371">c</span><span class="op" id="5580372">.</span><span class="ident" id="5580373">conn</span><span class="op" id="5580377">.</span><span class="ident" id="5580378">rwc</span><span class="op" id="5580381">)</span><span class="op" id="5580382">;</span>&nbsp;<span class="ident" id="5580384">err</span>&nbsp;<span class="op" id="5580388">!=</span>&nbsp;<span class="ident" id="5580391">nil</span>&nbsp;<span class="op" id="5580395">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580400">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580413">if</span>&nbsp;<span class="ident" id="5580416">err</span>&nbsp;<span class="op" id="5580420">:=</span>&nbsp;<span class="ident" id="5580423">c</span><span class="op" id="5580424">.</span><span class="ident" id="5580425">handleRecord</span><span class="op" id="5580437">(</span><span class="op" id="5580438">&amp;</span><span class="ident" id="5580439">rec</span><span class="op" id="5580442">)</span><span class="op" id="5580443">;</span>&nbsp;<span class="ident" id="5580445">err</span>&nbsp;<span class="op" id="5580449">!=</span>&nbsp;<span class="ident" id="5580452">nil</span>&nbsp;<span class="op" id="5580456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580461">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580470">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580473">}</span><br>
<span class="lineno"></span><span class="op" id="5580475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5580478">var</span>&nbsp;<span class="ident" id="5580482">errCloseConn</span>&nbsp;<span class="op" id="5580495">=</span>&nbsp;<span class="ident" id="5580497">errors</span><span class="op" id="5580503">.</span><span class="ident" id="5580504">New</span><span class="op" id="5580507">(</span><span class="string" id="5580508">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="5580543">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="5580546">var</span>&nbsp;<span class="ident" id="5580550">emptyBody</span>&nbsp;<span class="op" id="5580560">=</span>&nbsp;<span class="ident" id="5580562">ioutil</span><span class="op" id="5580568">.</span><span class="ident" id="5580569">NopCloser</span><span class="op" id="5580578">(</span><span class="ident" id="5580579">strings</span><span class="op" id="5580586">.</span><span class="ident" id="5580587">NewReader</span><span class="op" id="5580596">(</span><span class="string" id="5580597">&#34;&#34;</span><span class="op" id="5580599">)</span><span class="op" id="5580600">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5580603">func</span>&nbsp;<span class="op" id="5580608">(</span><span class="ident" id="5580609">c</span>&nbsp;<span class="op" id="5580611">*</span><span class="ident" id="5580612">child</span><span class="op" id="5580617">)</span>&nbsp;<span class="ident" id="5580619">handleRecord</span><span class="op" id="5580631">(</span><span class="ident" id="5580632">rec</span>&nbsp;<span class="op" id="5580636">*</span><span class="ident" id="5580637">record</span><span class="op" id="5580643">)</span>&nbsp;<span class="builtintype" id="5580645">error</span>&nbsp;<span class="op" id="5580651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580654">c</span><span class="op" id="5580655">.</span><span class="ident" id="5580656">mu</span><span class="op" id="5580658">.</span><span class="ident" id="5580659">Lock</span><span class="op" id="5580663">(</span><span class="op" id="5580664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580667">req</span><span class="op" id="5580670">,</span>&nbsp;<span class="ident" id="5580672">ok</span>&nbsp;<span class="op" id="5580675">:=</span>&nbsp;<span class="ident" id="5580678">c</span><span class="op" id="5580679">.</span><span class="ident" id="5580680">requests</span><span class="op" id="5580688">[</span><span class="ident" id="5580689">rec</span><span class="op" id="5580692">.</span><span class="ident" id="5580693">h</span><span class="op" id="5580694">.</span><span class="ident" id="5580695">Id</span><span class="op" id="5580697">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580700">c</span><span class="op" id="5580701">.</span><span class="ident" id="5580702">mu</span><span class="op" id="5580704">.</span><span class="ident" id="5580705">Unlock</span><span class="op" id="5580711">(</span><span class="op" id="5580712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580715">if</span>&nbsp;<span class="op" id="5580718">!</span><span class="ident" id="5580719">ok</span>&nbsp;<span class="op" id="5580722">&amp;&amp;</span>&nbsp;<span class="ident" id="5580725">rec</span><span class="op" id="5580728">.</span><span class="ident" id="5580729">h</span><span class="op" id="5580730">.</span><span class="ident" id="5580731">Type</span>&nbsp;<span class="op" id="5580736">!=</span>&nbsp;<span class="ident" id="5580739">typeBeginRequest</span>&nbsp;<span class="op" id="5580756">&amp;&amp;</span>&nbsp;<span class="ident" id="5580759">rec</span><span class="op" id="5580762">.</span><span class="ident" id="5580763">h</span><span class="op" id="5580764">.</span><span class="ident" id="5580765">Type</span>&nbsp;<span class="op" id="5580770">!=</span>&nbsp;<span class="ident" id="5580773">typeGetValues</span>&nbsp;<span class="op" id="5580787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5580791">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580841">return</span>&nbsp;<span class="ident" id="5580848">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580853">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580857">switch</span>&nbsp;<span class="ident" id="5580864">rec</span><span class="op" id="5580867">.</span><span class="ident" id="5580868">h</span><span class="op" id="5580869">.</span><span class="ident" id="5580870">Type</span>&nbsp;<span class="op" id="5580875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580878">case</span>&nbsp;<span class="ident" id="5580883">typeBeginRequest</span><span class="op" id="5580899">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580903">if</span>&nbsp;<span class="ident" id="5580906">req</span>&nbsp;<span class="op" id="5580910">!=</span>&nbsp;<span class="ident" id="5580913">nil</span>&nbsp;<span class="op" id="5580917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5580922">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5580985">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581036">return</span>&nbsp;<span class="ident" id="5581043">errors</span><span class="op" id="5581049">.</span><span class="ident" id="5581050">New</span><span class="op" id="5581053">(</span><span class="string" id="5581054">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="5581099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581108">var</span>&nbsp;<span class="ident" id="5581112">br</span>&nbsp;<span class="ident" id="5581115">beginRequest</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581130">if</span>&nbsp;<span class="ident" id="5581133">err</span>&nbsp;<span class="op" id="5581137">:=</span>&nbsp;<span class="ident" id="5581140">br</span><span class="op" id="5581142">.</span><span class="ident" id="5581143">read</span><span class="op" id="5581147">(</span><span class="ident" id="5581148">rec</span><span class="op" id="5581151">.</span><span class="ident" id="5581152">content</span><span class="op" id="5581159">(</span><span class="op" id="5581160">)</span><span class="op" id="5581161">)</span><span class="op" id="5581162">;</span>&nbsp;<span class="ident" id="5581164">err</span>&nbsp;<span class="op" id="5581168">!=</span>&nbsp;<span class="ident" id="5581171">nil</span>&nbsp;<span class="op" id="5581175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581180">return</span>&nbsp;<span class="ident" id="5581187">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581197">if</span>&nbsp;<span class="ident" id="5581200">br</span><span class="op" id="5581202">.</span><span class="ident" id="5581203">role</span>&nbsp;<span class="op" id="5581208">!=</span>&nbsp;<span class="ident" id="5581211">roleResponder</span>&nbsp;<span class="op" id="5581225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581230">c</span><span class="op" id="5581231">.</span><span class="ident" id="5581232">conn</span><span class="op" id="5581236">.</span><span class="ident" id="5581237">writeEndRequest</span><span class="op" id="5581252">(</span><span class="ident" id="5581253">rec</span><span class="op" id="5581256">.</span><span class="ident" id="5581257">h</span><span class="op" id="5581258">.</span><span class="ident" id="5581259">Id</span><span class="op" id="5581261">,</span>&nbsp;<span class="num" id="5581263">0</span><span class="op" id="5581264">,</span>&nbsp;<span class="ident" id="5581266">statusUnknownRole</span><span class="op" id="5581283">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581288">return</span>&nbsp;<span class="ident" id="5581295">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581305">req</span>&nbsp;<span class="op" id="5581309">=</span>&nbsp;<span class="ident" id="5581311">newRequest</span><span class="op" id="5581321">(</span><span class="ident" id="5581322">rec</span><span class="op" id="5581325">.</span><span class="ident" id="5581326">h</span><span class="op" id="5581327">.</span><span class="ident" id="5581328">Id</span><span class="op" id="5581330">,</span>&nbsp;<span class="ident" id="5581332">br</span><span class="op" id="5581334">.</span><span class="ident" id="5581335">flags</span><span class="op" id="5581340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581344">c</span><span class="op" id="5581345">.</span><span class="ident" id="5581346">mu</span><span class="op" id="5581348">.</span><span class="ident" id="5581349">Lock</span><span class="op" id="5581353">(</span><span class="op" id="5581354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581358">c</span><span class="op" id="5581359">.</span><span class="ident" id="5581360">requests</span><span class="op" id="5581368">[</span><span class="ident" id="5581369">rec</span><span class="op" id="5581372">.</span><span class="ident" id="5581373">h</span><span class="op" id="5581374">.</span><span class="ident" id="5581375">Id</span><span class="op" id="5581377">]</span>&nbsp;<span class="op" id="5581379">=</span>&nbsp;<span class="ident" id="5581381">req</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581387">c</span><span class="op" id="5581388">.</span><span class="ident" id="5581389">mu</span><span class="op" id="5581391">.</span><span class="ident" id="5581392">Unlock</span><span class="op" id="5581398">(</span><span class="op" id="5581399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581403">return</span>&nbsp;<span class="ident" id="5581410">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581415">case</span>&nbsp;<span class="ident" id="5581420">typeParams</span><span class="op" id="5581430">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581434">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581505">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581578">if</span>&nbsp;<span class="builtinfunc" id="5581581">len</span><span class="op" id="5581584">(</span><span class="ident" id="5581585">rec</span><span class="op" id="5581588">.</span><span class="ident" id="5581589">content</span><span class="op" id="5581596">(</span><span class="op" id="5581597">)</span><span class="op" id="5581598">)</span>&nbsp;<span class="op" id="5581600">&gt;</span>&nbsp;<span class="num" id="5581602">0</span>&nbsp;<span class="op" id="5581604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581609">req</span><span class="op" id="5581612">.</span><span class="ident" id="5581613">rawParams</span>&nbsp;<span class="op" id="5581623">=</span>&nbsp;<span class="builtinfunc" id="5581625">append</span><span class="op" id="5581631">(</span><span class="ident" id="5581632">req</span><span class="op" id="5581635">.</span><span class="ident" id="5581636">rawParams</span><span class="op" id="5581645">,</span>&nbsp;<span class="ident" id="5581647">rec</span><span class="op" id="5581650">.</span><span class="ident" id="5581651">content</span><span class="op" id="5581658">(</span><span class="op" id="5581659">)</span><span class="op" id="5581660">...</span><span class="op" id="5581663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581668">return</span>&nbsp;<span class="ident" id="5581675">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581685">req</span><span class="op" id="5581688">.</span><span class="ident" id="5581689">parseParams</span><span class="op" id="5581700">(</span><span class="op" id="5581701">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581705">return</span>&nbsp;<span class="ident" id="5581712">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581717">case</span>&nbsp;<span class="ident" id="5581722">typeStdin</span><span class="op" id="5581731">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581735">content</span>&nbsp;<span class="op" id="5581743">:=</span>&nbsp;<span class="ident" id="5581746">rec</span><span class="op" id="5581749">.</span><span class="ident" id="5581750">content</span><span class="op" id="5581757">(</span><span class="op" id="5581758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581762">if</span>&nbsp;<span class="ident" id="5581765">req</span><span class="op" id="5581768">.</span><span class="ident" id="5581769">pw</span>&nbsp;<span class="op" id="5581772">==</span>&nbsp;<span class="ident" id="5581775">nil</span>&nbsp;<span class="op" id="5581779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581784">var</span>&nbsp;<span class="ident" id="5581788">body</span>&nbsp;<span class="ident" id="5581793">io</span><span class="op" id="5581795">.</span><span class="ident" id="5581796">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581810">if</span>&nbsp;<span class="builtinfunc" id="5581813">len</span><span class="op" id="5581816">(</span><span class="ident" id="5581817">content</span><span class="op" id="5581824">)</span>&nbsp;<span class="op" id="5581826">&gt;</span>&nbsp;<span class="num" id="5581828">0</span>&nbsp;<span class="op" id="5581830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581836">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581900">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581943">body</span><span class="op" id="5581947">,</span>&nbsp;<span class="ident" id="5581949">req</span><span class="op" id="5581952">.</span><span class="ident" id="5581953">pw</span>&nbsp;<span class="op" id="5581956">=</span>&nbsp;<span class="ident" id="5581958">io</span><span class="op" id="5581960">.</span><span class="ident" id="5581961">Pipe</span><span class="op" id="5581965">(</span><span class="op" id="5581966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581971">}</span>&nbsp;<span class="keyword" id="5581973">else</span>&nbsp;<span class="op" id="5581978">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581984">body</span>&nbsp;<span class="op" id="5581989">=</span>&nbsp;<span class="ident" id="5581991">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582009">go</span>&nbsp;<span class="ident" id="5582012">c</span><span class="op" id="5582013">.</span><span class="ident" id="5582014">serveRequest</span><span class="op" id="5582026">(</span><span class="ident" id="5582027">req</span><span class="op" id="5582030">,</span>&nbsp;<span class="ident" id="5582032">body</span><span class="op" id="5582036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582044">if</span>&nbsp;<span class="builtinfunc" id="5582047">len</span><span class="op" id="5582050">(</span><span class="ident" id="5582051">content</span><span class="op" id="5582058">)</span>&nbsp;<span class="op" id="5582060">&gt;</span>&nbsp;<span class="num" id="5582062">0</span>&nbsp;<span class="op" id="5582064">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582069">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582137">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582200">req</span><span class="op" id="5582203">.</span><span class="ident" id="5582204">pw</span><span class="op" id="5582206">.</span><span class="ident" id="5582207">Write</span><span class="op" id="5582212">(</span><span class="ident" id="5582213">content</span><span class="op" id="5582220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582224">}</span>&nbsp;<span class="keyword" id="5582226">else</span>&nbsp;<span class="keyword" id="5582231">if</span>&nbsp;<span class="ident" id="5582234">req</span><span class="op" id="5582237">.</span><span class="ident" id="5582238">pw</span>&nbsp;<span class="op" id="5582241">!=</span>&nbsp;<span class="ident" id="5582244">nil</span>&nbsp;<span class="op" id="5582248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582253">req</span><span class="op" id="5582256">.</span><span class="ident" id="5582257">pw</span><span class="op" id="5582259">.</span><span class="ident" id="5582260">Close</span><span class="op" id="5582265">(</span><span class="op" id="5582266">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582274">return</span>&nbsp;<span class="ident" id="5582281">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582286">case</span>&nbsp;<span class="ident" id="5582291">typeGetValues</span><span class="op" id="5582304">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582308">values</span>&nbsp;<span class="op" id="5582315">:=</span>&nbsp;<span class="keyword" id="5582318">map</span><span class="op" id="5582321">[</span><span class="builtintype" id="5582322">string</span><span class="op" id="5582328">]</span><span class="builtintype" id="5582329">string</span><span class="op" id="5582335">{</span><span class="string" id="5582336">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="5582353">:</span>&nbsp;<span class="string" id="5582355">&#34;1&#34;</span><span class="op" id="5582358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582362">c</span><span class="op" id="5582363">.</span><span class="ident" id="5582364">conn</span><span class="op" id="5582368">.</span><span class="ident" id="5582369">writePairs</span><span class="op" id="5582379">(</span><span class="ident" id="5582380">typeGetValuesResult</span><span class="op" id="5582399">,</span>&nbsp;<span class="num" id="5582401">0</span><span class="op" id="5582402">,</span>&nbsp;<span class="ident" id="5582404">values</span><span class="op" id="5582410">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582414">return</span>&nbsp;<span class="ident" id="5582421">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582426">case</span>&nbsp;<span class="ident" id="5582431">typeData</span><span class="op" id="5582439">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582443">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582510">return</span>&nbsp;<span class="ident" id="5582517">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582522">case</span>&nbsp;<span class="ident" id="5582527">typeAbortRequest</span><span class="op" id="5582543">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5582547">println</span><span class="op" id="5582554">(</span><span class="string" id="5582555">&#34;abort&#34;</span><span class="op" id="5582562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582566">c</span><span class="op" id="5582567">.</span><span class="ident" id="5582568">mu</span><span class="op" id="5582570">.</span><span class="ident" id="5582571">Lock</span><span class="op" id="5582575">(</span><span class="op" id="5582576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5582580">delete</span><span class="op" id="5582586">(</span><span class="ident" id="5582587">c</span><span class="op" id="5582588">.</span><span class="ident" id="5582589">requests</span><span class="op" id="5582597">,</span>&nbsp;<span class="ident" id="5582599">rec</span><span class="op" id="5582602">.</span><span class="ident" id="5582603">h</span><span class="op" id="5582604">.</span><span class="ident" id="5582605">Id</span><span class="op" id="5582607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582611">c</span><span class="op" id="5582612">.</span><span class="ident" id="5582613">mu</span><span class="op" id="5582615">.</span><span class="ident" id="5582616">Unlock</span><span class="op" id="5582622">(</span><span class="op" id="5582623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582627">c</span><span class="op" id="5582628">.</span><span class="ident" id="5582629">conn</span><span class="op" id="5582633">.</span><span class="ident" id="5582634">writeEndRequest</span><span class="op" id="5582649">(</span><span class="ident" id="5582650">rec</span><span class="op" id="5582653">.</span><span class="ident" id="5582654">h</span><span class="op" id="5582655">.</span><span class="ident" id="5582656">Id</span><span class="op" id="5582658">,</span>&nbsp;<span class="num" id="5582660">0</span><span class="op" id="5582661">,</span>&nbsp;<span class="ident" id="5582663">statusRequestComplete</span><span class="op" id="5582684">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582688">if</span>&nbsp;<span class="op" id="5582691">!</span><span class="ident" id="5582692">req</span><span class="op" id="5582695">.</span><span class="ident" id="5582696">keepConn</span>&nbsp;<span class="op" id="5582705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582710">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582750">return</span>&nbsp;<span class="ident" id="5582757">errCloseConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582776">return</span>&nbsp;<span class="ident" id="5582783">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582788">default</span><span class="op" id="5582795">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582799">b</span>&nbsp;<span class="op" id="5582801">:=</span>&nbsp;<span class="builtinfunc" id="5582804">make</span><span class="op" id="5582808">(</span><span class="op" id="5582809">[</span><span class="op" id="5582810">]</span><span class="builtintype" id="5582811">byte</span><span class="op" id="5582815">,</span>&nbsp;<span class="num" id="5582817">8</span><span class="op" id="5582818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582822">b</span><span class="op" id="5582823">[</span><span class="num" id="5582824">0</span><span class="op" id="5582825">]</span>&nbsp;<span class="op" id="5582827">=</span>&nbsp;<span class="builtintype" id="5582829">byte</span><span class="op" id="5582833">(</span><span class="ident" id="5582834">rec</span><span class="op" id="5582837">.</span><span class="ident" id="5582838">h</span><span class="op" id="5582839">.</span><span class="ident" id="5582840">Type</span><span class="op" id="5582844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582848">c</span><span class="op" id="5582849">.</span><span class="ident" id="5582850">conn</span><span class="op" id="5582854">.</span><span class="ident" id="5582855">writeRecord</span><span class="op" id="5582866">(</span><span class="ident" id="5582867">typeUnknownType</span><span class="op" id="5582882">,</span>&nbsp;<span class="num" id="5582884">0</span><span class="op" id="5582885">,</span>&nbsp;<span class="ident" id="5582887">b</span><span class="op" id="5582888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582892">return</span>&nbsp;<span class="ident" id="5582899">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582904">}</span><br>
<span class="lineno"></span><span class="op" id="5582906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5582909">func</span>&nbsp;<span class="op" id="5582914">(</span><span class="ident" id="5582915">c</span>&nbsp;<span class="op" id="5582917">*</span><span class="ident" id="5582918">child</span><span class="op" id="5582923">)</span>&nbsp;<span class="ident" id="5582925">serveRequest</span><span class="op" id="5582937">(</span><span class="ident" id="5582938">req</span>&nbsp;<span class="op" id="5582942">*</span><span class="ident" id="5582943">request</span><span class="op" id="5582950">,</span>&nbsp;<span class="ident" id="5582952">body</span>&nbsp;<span class="ident" id="5582957">io</span><span class="op" id="5582959">.</span><span class="ident" id="5582960">ReadCloser</span><span class="op" id="5582970">)</span>&nbsp;<span class="op" id="5582972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582975">r</span>&nbsp;<span class="op" id="5582977">:=</span>&nbsp;<span class="ident" id="5582980">newResponse</span><span class="op" id="5582991">(</span><span class="ident" id="5582992">c</span><span class="op" id="5582993">,</span>&nbsp;<span class="ident" id="5582995">req</span><span class="op" id="5582998">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583001">httpReq</span><span class="op" id="5583008">,</span>&nbsp;<span class="ident" id="5583010">err</span>&nbsp;<span class="op" id="5583014">:=</span>&nbsp;<span class="ident" id="5583017">cgi</span><span class="op" id="5583020">.</span><span class="ident" id="5583021">RequestFromMap</span><span class="op" id="5583035">(</span><span class="ident" id="5583036">req</span><span class="op" id="5583039">.</span><span class="ident" id="5583040">params</span><span class="op" id="5583046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583049">if</span>&nbsp;<span class="ident" id="5583052">err</span>&nbsp;<span class="op" id="5583056">!=</span>&nbsp;<span class="ident" id="5583059">nil</span>&nbsp;<span class="op" id="5583063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583067">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583111">r</span><span class="op" id="5583112">.</span><span class="ident" id="5583113">WriteHeader</span><span class="op" id="5583124">(</span><span class="ident" id="5583125">http</span><span class="op" id="5583129">.</span><span class="ident" id="5583130">StatusInternalServerError</span><span class="op" id="5583155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583159">c</span><span class="op" id="5583160">.</span><span class="ident" id="5583161">conn</span><span class="op" id="5583165">.</span><span class="ident" id="5583166">writeRecord</span><span class="op" id="5583177">(</span><span class="ident" id="5583178">typeStderr</span><span class="op" id="5583188">,</span>&nbsp;<span class="ident" id="5583190">req</span><span class="op" id="5583193">.</span><span class="ident" id="5583194">reqId</span><span class="op" id="5583199">,</span>&nbsp;<span class="op" id="5583201">[</span><span class="op" id="5583202">]</span><span class="builtintype" id="5583203">byte</span><span class="op" id="5583207">(</span><span class="ident" id="5583208">err</span><span class="op" id="5583211">.</span><span class="ident" id="5583212">Error</span><span class="op" id="5583217">(</span><span class="op" id="5583218">)</span><span class="op" id="5583219">)</span><span class="op" id="5583220">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583223">}</span>&nbsp;<span class="keyword" id="5583225">else</span>&nbsp;<span class="op" id="5583230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583234">httpReq</span><span class="op" id="5583241">.</span><span class="ident" id="5583242">Body</span>&nbsp;<span class="op" id="5583247">=</span>&nbsp;<span class="ident" id="5583249">body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583256">c</span><span class="op" id="5583257">.</span><span class="ident" id="5583258">handler</span><span class="op" id="5583265">.</span><span class="ident" id="5583266">ServeHTTP</span><span class="op" id="5583275">(</span><span class="ident" id="5583276">r</span><span class="op" id="5583277">,</span>&nbsp;<span class="ident" id="5583279">httpReq</span><span class="op" id="5583286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583292">r</span><span class="op" id="5583293">.</span><span class="ident" id="5583294">Close</span><span class="op" id="5583299">(</span><span class="op" id="5583300">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583303">c</span><span class="op" id="5583304">.</span><span class="ident" id="5583305">mu</span><span class="op" id="5583307">.</span><span class="ident" id="5583308">Lock</span><span class="op" id="5583312">(</span><span class="op" id="5583313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5583316">delete</span><span class="op" id="5583322">(</span><span class="ident" id="5583323">c</span><span class="op" id="5583324">.</span><span class="ident" id="5583325">requests</span><span class="op" id="5583333">,</span>&nbsp;<span class="ident" id="5583335">req</span><span class="op" id="5583338">.</span><span class="ident" id="5583339">reqId</span><span class="op" id="5583344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583347">c</span><span class="op" id="5583348">.</span><span class="ident" id="5583349">mu</span><span class="op" id="5583351">.</span><span class="ident" id="5583352">Unlock</span><span class="op" id="5583358">(</span><span class="op" id="5583359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583362">c</span><span class="op" id="5583363">.</span><span class="ident" id="5583364">conn</span><span class="op" id="5583368">.</span><span class="ident" id="5583369">writeEndRequest</span><span class="op" id="5583384">(</span><span class="ident" id="5583385">req</span><span class="op" id="5583388">.</span><span class="ident" id="5583389">reqId</span><span class="op" id="5583394">,</span>&nbsp;<span class="num" id="5583396">0</span><span class="op" id="5583397">,</span>&nbsp;<span class="ident" id="5583399">statusRequestComplete</span><span class="op" id="5583420">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583424">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583488">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583549">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583604">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583662">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583718">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583776">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583815">io</span><span class="op" id="5583817">.</span><span class="ident" id="5583818">CopyN</span><span class="op" id="5583823">(</span><span class="ident" id="5583824">ioutil</span><span class="op" id="5583830">.</span><span class="ident" id="5583831">Discard</span><span class="op" id="5583838">,</span>&nbsp;<span class="ident" id="5583840">body</span><span class="op" id="5583844">,</span>&nbsp;<span class="num" id="5583846">100</span><span class="op" id="5583849">&lt;&lt;</span><span class="num" id="5583851">20</span><span class="op" id="5583853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583856">body</span><span class="op" id="5583860">.</span><span class="ident" id="5583861">Close</span><span class="op" id="5583866">(</span><span class="op" id="5583867">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583871">if</span>&nbsp;<span class="op" id="5583874">!</span><span class="ident" id="5583875">req</span><span class="op" id="5583878">.</span><span class="ident" id="5583879">keepConn</span>&nbsp;<span class="op" id="5583888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583892">c</span><span class="op" id="5583893">.</span><span class="ident" id="5583894">conn</span><span class="op" id="5583898">.</span><span class="ident" id="5583899">Close</span><span class="op" id="5583904">(</span><span class="op" id="5583905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583908">}</span><br>
<span class="lineno"></span><span class="op" id="5583910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="5583913">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="5583993">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="5584068">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="5584089">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="5584146">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="5584198">func</span>&nbsp;<span class="ident" id="5584203">Serve</span><span class="op" id="5584208">(</span><span class="ident" id="5584209">l</span>&nbsp;<span class="ident" id="5584211">net</span><span class="op" id="5584214">.</span><span class="ident" id="5584215">Listener</span><span class="op" id="5584223">,</span>&nbsp;<span class="ident" id="5584225">handler</span>&nbsp;<span class="ident" id="5584233">http</span><span class="op" id="5584237">.</span><span class="ident" id="5584238">Handler</span><span class="op" id="5584245">)</span>&nbsp;<span class="builtintype" id="5584247">error</span>&nbsp;<span class="op" id="5584253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584256">if</span>&nbsp;<span class="ident" id="5584259">l</span>&nbsp;<span class="op" id="5584261">==</span>&nbsp;<span class="ident" id="5584264">nil</span>&nbsp;<span class="op" id="5584268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584272">var</span>&nbsp;<span class="ident" id="5584276">err</span>&nbsp;<span class="builtintype" id="5584280">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584288">l</span><span class="op" id="5584289">,</span>&nbsp;<span class="ident" id="5584291">err</span>&nbsp;<span class="op" id="5584295">=</span>&nbsp;<span class="ident" id="5584297">net</span><span class="op" id="5584300">.</span><span class="ident" id="5584301">FileListener</span><span class="op" id="5584313">(</span><span class="ident" id="5584314">os</span><span class="op" id="5584316">.</span><span class="ident" id="5584317">Stdin</span><span class="op" id="5584322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584326">if</span>&nbsp;<span class="ident" id="5584329">err</span>&nbsp;<span class="op" id="5584333">!=</span>&nbsp;<span class="ident" id="5584336">nil</span>&nbsp;<span class="op" id="5584340">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584345">return</span>&nbsp;<span class="ident" id="5584352">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584362">defer</span>&nbsp;<span class="ident" id="5584368">l</span><span class="op" id="5584369">.</span><span class="ident" id="5584370">Close</span><span class="op" id="5584375">(</span><span class="op" id="5584376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584382">if</span>&nbsp;<span class="ident" id="5584385">handler</span>&nbsp;<span class="op" id="5584393">==</span>&nbsp;<span class="ident" id="5584396">nil</span>&nbsp;<span class="op" id="5584400">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584404">handler</span>&nbsp;<span class="op" id="5584412">=</span>&nbsp;<span class="ident" id="5584414">http</span><span class="op" id="5584418">.</span><span class="ident" id="5584419">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584439">for</span>&nbsp;<span class="op" id="5584443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584447">rw</span><span class="op" id="5584449">,</span>&nbsp;<span class="ident" id="5584451">err</span>&nbsp;<span class="op" id="5584455">:=</span>&nbsp;<span class="ident" id="5584458">l</span><span class="op" id="5584459">.</span><span class="ident" id="5584460">Accept</span><span class="op" id="5584466">(</span><span class="op" id="5584467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584471">if</span>&nbsp;<span class="ident" id="5584474">err</span>&nbsp;<span class="op" id="5584478">!=</span>&nbsp;<span class="ident" id="5584481">nil</span>&nbsp;<span class="op" id="5584485">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584490">return</span>&nbsp;<span class="ident" id="5584497">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584507">c</span>&nbsp;<span class="op" id="5584509">:=</span>&nbsp;<span class="ident" id="5584512">newChild</span><span class="op" id="5584520">(</span><span class="ident" id="5584521">rw</span><span class="op" id="5584523">,</span>&nbsp;<span class="ident" id="5584525">handler</span><span class="op" id="5584532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584536">go</span>&nbsp;<span class="ident" id="5584539">c</span><span class="op" id="5584540">.</span><span class="ident" id="5584541">serve</span><span class="op" id="5584546">(</span><span class="op" id="5584547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584550">}</span><br>
<span class="lineno">305</span><span class="op" id="5584552">}</span>
</div>
</body>
</html>
