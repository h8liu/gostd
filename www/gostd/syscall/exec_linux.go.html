<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2583003">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2583058">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2583112">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2583163">//&nbsp;+build&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2583180">package</span>&nbsp;<span class="ident" id="2583188">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2583197">import</span>&nbsp;<span class="op" id="2583204">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2583207">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2583216">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2583219">//&nbsp;SysProcIDMap&nbsp;holds&nbsp;Container&nbsp;ID&nbsp;to&nbsp;Host&nbsp;ID&nbsp;mappings&nbsp;used&nbsp;for&nbsp;User&nbsp;Namespaces&nbsp;in&nbsp;Linux.</span><br>
<span class="lineno"></span><span class="comment" id="2583309">//&nbsp;See&nbsp;user_namespaces(7).</span><br>
<span class="lineno">15</span><span class="keyword" id="2583336">type</span>&nbsp;<span class="ident" id="2583341">SysProcIDMap</span>&nbsp;<span class="keyword" id="2583354">struct</span>&nbsp;<span class="op" id="2583361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583364">ContainerID</span>&nbsp;<span class="builtintype" id="2583376">int</span>&nbsp;<span class="comment" id="2583380">//&nbsp;Container&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583398">HostID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2583410">int</span>&nbsp;<span class="comment" id="2583414">//&nbsp;Host&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583427">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2583439">int</span>&nbsp;<span class="comment" id="2583443">//&nbsp;Size.</span><br>
<span class="lineno"></span><span class="op" id="2583452">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2583455">type</span>&nbsp;<span class="ident" id="2583460">SysProcAttr</span>&nbsp;<span class="keyword" id="2583472">struct</span>&nbsp;<span class="op" id="2583479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583482">Chroot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2583494">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2583509">//&nbsp;Chroot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583521">Credential</span>&nbsp;&nbsp;<span class="op" id="2583533">*</span><span class="ident" id="2583534">Credential</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2583548">//&nbsp;Credential.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583564">Ptrace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2583576">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2583591">//&nbsp;Enable&nbsp;tracing.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583611">Setsid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2583623">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2583638">//&nbsp;Create&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583658">Setpgid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2583670">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2583685">//&nbsp;Set&nbsp;process&nbsp;group&nbsp;ID&nbsp;to&nbsp;new&nbsp;pid&nbsp;(SYSV&nbsp;setpgrp)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583736">Setctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2583748">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2583763">//&nbsp;Set&nbsp;controlling&nbsp;terminal&nbsp;to&nbsp;fd&nbsp;Ctty&nbsp;(only&nbsp;meaningful&nbsp;if&nbsp;Setsid&nbsp;is&nbsp;set)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583838">Noctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2583850">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2583865">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;controlling&nbsp;terminal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583907">Ctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2583919">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2583934">//&nbsp;Controlling&nbsp;TTY&nbsp;fd&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583970">Pdeathsig</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2583982">Signal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2583997">//&nbsp;Signal&nbsp;that&nbsp;the&nbsp;process&nbsp;will&nbsp;get&nbsp;when&nbsp;its&nbsp;parent&nbsp;dies&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2584068">Cloneflags</span>&nbsp;&nbsp;<span class="builtintype" id="2584080">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2584095">//&nbsp;Flags&nbsp;for&nbsp;clone&nbsp;calls&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2584134">UidMappings</span>&nbsp;<span class="op" id="2584146">[</span><span class="op" id="2584147">]</span><span class="ident" id="2584148">SysProcIDMap</span>&nbsp;<span class="comment" id="2584161">//&nbsp;User&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2584203">GidMappings</span>&nbsp;<span class="op" id="2584215">[</span><span class="op" id="2584216">]</span><span class="ident" id="2584217">SysProcIDMap</span>&nbsp;<span class="comment" id="2584230">//&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span><span class="op" id="2584272">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="2584275">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2584310">func</span>&nbsp;<span class="ident" id="2584315">runtime_BeforeFork</span><span class="op" id="2584333">(</span><span class="op" id="2584334">)</span><br>
<span class="lineno"></span><span class="keyword" id="2584336">func</span>&nbsp;<span class="ident" id="2584341">runtime_AfterFork</span><span class="op" id="2584358">(</span><span class="op" id="2584359">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2584362">//&nbsp;Fork,&nbsp;dup&nbsp;fd&nbsp;onto&nbsp;0..len(fd),&nbsp;and&nbsp;exec(argv0,&nbsp;argvv,&nbsp;envv)&nbsp;in&nbsp;child.</span><br>
<span class="lineno"></span><span class="comment" id="2584434">//&nbsp;If&nbsp;a&nbsp;dup&nbsp;or&nbsp;exec&nbsp;fails,&nbsp;write&nbsp;the&nbsp;errno&nbsp;error&nbsp;to&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="2584492">//&nbsp;(Pipe&nbsp;is&nbsp;close-on-exec&nbsp;so&nbsp;if&nbsp;exec&nbsp;succeeds,&nbsp;it&nbsp;will&nbsp;be&nbsp;closed.)</span><br>
<span class="lineno"></span><span class="comment" id="2584559">//&nbsp;In&nbsp;the&nbsp;child,&nbsp;this&nbsp;function&nbsp;must&nbsp;not&nbsp;acquire&nbsp;any&nbsp;locks,&nbsp;because</span><br>
<span class="lineno"></span><span class="comment" id="2584626">//&nbsp;they&nbsp;might&nbsp;have&nbsp;been&nbsp;locked&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;fork.&nbsp;&nbsp;This&nbsp;means</span><br>
<span class="lineno">45</span><span class="comment" id="2584694">//&nbsp;no&nbsp;rescheduling,&nbsp;no&nbsp;malloc&nbsp;calls,&nbsp;and&nbsp;no&nbsp;new&nbsp;stack&nbsp;segments.</span><br>
<span class="lineno"></span><span class="comment" id="2584758">//&nbsp;For&nbsp;the&nbsp;same&nbsp;reason&nbsp;compiler&nbsp;does&nbsp;not&nbsp;race&nbsp;instrument&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2584819">//&nbsp;The&nbsp;calls&nbsp;to&nbsp;RawSyscall&nbsp;are&nbsp;okay&nbsp;because&nbsp;they&nbsp;are&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="2584881">//&nbsp;functions&nbsp;that&nbsp;do&nbsp;not&nbsp;grow&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="2584922">func</span>&nbsp;<span class="ident" id="2584927">forkAndExecInChild</span><span class="op" id="2584945">(</span><span class="ident" id="2584946">argv0</span>&nbsp;<span class="op" id="2584952">*</span><span class="builtintype" id="2584953">byte</span><span class="op" id="2584957">,</span>&nbsp;<span class="ident" id="2584959">argv</span><span class="op" id="2584963">,</span>&nbsp;<span class="ident" id="2584965">envv</span>&nbsp;<span class="op" id="2584970">[</span><span class="op" id="2584971">]</span><span class="op" id="2584972">*</span><span class="builtintype" id="2584973">byte</span><span class="op" id="2584977">,</span>&nbsp;<span class="ident" id="2584979">chroot</span><span class="op" id="2584985">,</span>&nbsp;<span class="ident" id="2584987">dir</span>&nbsp;<span class="op" id="2584991">*</span><span class="builtintype" id="2584992">byte</span><span class="op" id="2584996">,</span>&nbsp;<span class="ident" id="2584998">attr</span>&nbsp;<span class="op" id="2585003">*</span><span class="ident" id="2585004">ProcAttr</span><span class="op" id="2585012">,</span>&nbsp;<span class="ident" id="2585014">sys</span>&nbsp;<span class="op" id="2585018">*</span><span class="ident" id="2585019">SysProcAttr</span><span class="op" id="2585030">,</span>&nbsp;<span class="ident" id="2585032">pipe</span>&nbsp;<span class="builtintype" id="2585037">int</span><span class="op" id="2585040">)</span>&nbsp;<span class="op" id="2585042">(</span><span class="ident" id="2585043">pid</span>&nbsp;<span class="builtintype" id="2585047">int</span><span class="op" id="2585050">,</span>&nbsp;<span class="ident" id="2585052">err</span>&nbsp;<span class="ident" id="2585056">Errno</span><span class="op" id="2585061">)</span>&nbsp;<span class="op" id="2585063">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585066">//&nbsp;Declare&nbsp;all&nbsp;variables&nbsp;at&nbsp;top&nbsp;in&nbsp;case&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585111">//&nbsp;declarations&nbsp;require&nbsp;heap&nbsp;allocation&nbsp;(e.g.,&nbsp;err1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2585166">var</span>&nbsp;<span class="op" id="2585170">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585174">r1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2585181">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585191">err1</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2585198">Errno</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585206">err2</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2585213">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585221">nextfd</span>&nbsp;<span class="builtintype" id="2585228">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585234">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2585241">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585247">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2585254">[</span><span class="num" id="2585255">2</span><span class="op" id="2585256">]</span><span class="builtintype" id="2585257">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2585262">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585266">//&nbsp;Guard&nbsp;against&nbsp;side&nbsp;effects&nbsp;of&nbsp;shuffling&nbsp;fds&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585321">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;nextfd&nbsp;is&nbsp;beyond&nbsp;any&nbsp;currently&nbsp;open&nbsp;files&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585385">//&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;overwriting&nbsp;any&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585444">fd</span>&nbsp;<span class="op" id="2585447">:=</span>&nbsp;<span class="builtinfunc" id="2585450">make</span><span class="op" id="2585454">(</span><span class="op" id="2585455">[</span><span class="op" id="2585456">]</span><span class="builtintype" id="2585457">int</span><span class="op" id="2585460">,</span>&nbsp;<span class="builtinfunc" id="2585462">len</span><span class="op" id="2585465">(</span><span class="ident" id="2585466">attr</span><span class="op" id="2585470">.</span><span class="ident" id="2585471">Files</span><span class="op" id="2585476">)</span><span class="op" id="2585477">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585480">nextfd</span>&nbsp;<span class="op" id="2585487">=</span>&nbsp;<span class="builtinfunc" id="2585489">len</span><span class="op" id="2585492">(</span><span class="ident" id="2585493">attr</span><span class="op" id="2585497">.</span><span class="ident" id="2585498">Files</span><span class="op" id="2585503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2585506">for</span>&nbsp;<span class="ident" id="2585510">i</span><span class="op" id="2585511">,</span>&nbsp;<span class="ident" id="2585513">ufd</span>&nbsp;<span class="op" id="2585517">:=</span>&nbsp;<span class="keyword" id="2585520">range</span>&nbsp;<span class="ident" id="2585526">attr</span><span class="op" id="2585530">.</span><span class="ident" id="2585531">Files</span>&nbsp;<span class="op" id="2585537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2585541">if</span>&nbsp;<span class="ident" id="2585544">nextfd</span>&nbsp;<span class="op" id="2585551">&lt;</span>&nbsp;<span class="builtintype" id="2585553">int</span><span class="op" id="2585556">(</span><span class="ident" id="2585557">ufd</span><span class="op" id="2585560">)</span>&nbsp;<span class="op" id="2585562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585567">nextfd</span>&nbsp;<span class="op" id="2585574">=</span>&nbsp;<span class="builtintype" id="2585576">int</span><span class="op" id="2585579">(</span><span class="ident" id="2585580">ufd</span><span class="op" id="2585583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2585587">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585591">fd</span><span class="op" id="2585593">[</span><span class="ident" id="2585594">i</span><span class="op" id="2585595">]</span>&nbsp;<span class="op" id="2585597">=</span>&nbsp;<span class="builtintype" id="2585599">int</span><span class="op" id="2585602">(</span><span class="ident" id="2585603">ufd</span><span class="op" id="2585606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2585609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585612">nextfd</span><span class="op" id="2585618">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585623">//&nbsp;Allocate&nbsp;another&nbsp;pipe&nbsp;for&nbsp;parent&nbsp;to&nbsp;child&nbsp;communication&nbsp;for</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585687">//&nbsp;synchronizing&nbsp;writing&nbsp;of&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2585743">if</span>&nbsp;<span class="ident" id="2585746">sys</span><span class="op" id="2585749">.</span><span class="ident" id="2585750">UidMappings</span>&nbsp;<span class="op" id="2585762">!=</span>&nbsp;<span class="ident" id="2585765">nil</span>&nbsp;<span class="op" id="2585769">||</span>&nbsp;<span class="ident" id="2585772">sys</span><span class="op" id="2585775">.</span><span class="ident" id="2585776">GidMappings</span>&nbsp;<span class="op" id="2585788">!=</span>&nbsp;<span class="ident" id="2585791">nil</span>&nbsp;<span class="op" id="2585795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2585799">if</span>&nbsp;<span class="ident" id="2585802">err</span>&nbsp;<span class="op" id="2585806">:=</span>&nbsp;<span class="ident" id="2585809">forkExecPipe</span><span class="op" id="2585821">(</span><span class="ident" id="2585822">p</span><span class="op" id="2585823">[</span><span class="op" id="2585824">:</span><span class="op" id="2585825">]</span><span class="op" id="2585826">)</span><span class="op" id="2585827">;</span>&nbsp;<span class="ident" id="2585829">err</span>&nbsp;<span class="op" id="2585833">!=</span>&nbsp;<span class="ident" id="2585836">nil</span>&nbsp;<span class="op" id="2585840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2585845">return</span>&nbsp;<span class="num" id="2585852">0</span><span class="op" id="2585853">,</span>&nbsp;<span class="ident" id="2585855">err</span><span class="op" id="2585858">.</span><span class="op" id="2585859">(</span><span class="ident" id="2585860">Errno</span><span class="op" id="2585865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2585869">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2585872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585876">//&nbsp;About&nbsp;to&nbsp;call&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585900">//&nbsp;No&nbsp;more&nbsp;allocation&nbsp;or&nbsp;calls&nbsp;of&nbsp;non-assembly&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585959">runtime_BeforeFork</span><span class="op" id="2585977">(</span><span class="op" id="2585978">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585981">r1</span><span class="op" id="2585983">,</span>&nbsp;<span class="ident" id="2585985">_</span><span class="op" id="2585986">,</span>&nbsp;<span class="ident" id="2585988">err1</span>&nbsp;<span class="op" id="2585993">=</span>&nbsp;<span class="ident" id="2585995">RawSyscall6</span><span class="op" id="2586006">(</span><span class="ident" id="2586007">SYS_CLONE</span><span class="op" id="2586016">,</span>&nbsp;<span class="builtintype" id="2586018">uintptr</span><span class="op" id="2586025">(</span><span class="ident" id="2586026">SIGCHLD</span><span class="op" id="2586033">)</span><span class="op" id="2586034">|</span><span class="ident" id="2586035">sys</span><span class="op" id="2586038">.</span><span class="ident" id="2586039">Cloneflags</span><span class="op" id="2586049">,</span>&nbsp;<span class="num" id="2586051">0</span><span class="op" id="2586052">,</span>&nbsp;<span class="num" id="2586054">0</span><span class="op" id="2586055">,</span>&nbsp;<span class="num" id="2586057">0</span><span class="op" id="2586058">,</span>&nbsp;<span class="num" id="2586060">0</span><span class="op" id="2586061">,</span>&nbsp;<span class="num" id="2586063">0</span><span class="op" id="2586064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586067">if</span>&nbsp;<span class="ident" id="2586070">err1</span>&nbsp;<span class="op" id="2586075">!=</span>&nbsp;<span class="num" id="2586078">0</span>&nbsp;<span class="op" id="2586080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586084">runtime_AfterFork</span><span class="op" id="2586101">(</span><span class="op" id="2586102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586106">return</span>&nbsp;<span class="num" id="2586113">0</span><span class="op" id="2586114">,</span>&nbsp;<span class="ident" id="2586116">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2586122">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586126">if</span>&nbsp;<span class="ident" id="2586129">r1</span>&nbsp;<span class="op" id="2586132">!=</span>&nbsp;<span class="num" id="2586135">0</span>&nbsp;<span class="op" id="2586137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2586141">//&nbsp;parent;&nbsp;return&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586165">runtime_AfterFork</span><span class="op" id="2586182">(</span><span class="op" id="2586183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586187">pid</span>&nbsp;<span class="op" id="2586191">=</span>&nbsp;<span class="builtintype" id="2586193">int</span><span class="op" id="2586196">(</span><span class="ident" id="2586197">r1</span><span class="op" id="2586199">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586204">if</span>&nbsp;<span class="ident" id="2586207">sys</span><span class="op" id="2586210">.</span><span class="ident" id="2586211">UidMappings</span>&nbsp;<span class="op" id="2586223">!=</span>&nbsp;<span class="ident" id="2586226">nil</span>&nbsp;<span class="op" id="2586230">||</span>&nbsp;<span class="ident" id="2586233">sys</span><span class="op" id="2586236">.</span><span class="ident" id="2586237">GidMappings</span>&nbsp;<span class="op" id="2586249">!=</span>&nbsp;<span class="ident" id="2586252">nil</span>&nbsp;<span class="op" id="2586256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586261">Close</span><span class="op" id="2586266">(</span><span class="ident" id="2586267">p</span><span class="op" id="2586268">[</span><span class="num" id="2586269">0</span><span class="op" id="2586270">]</span><span class="op" id="2586271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586276">err</span>&nbsp;<span class="op" id="2586280">:=</span>&nbsp;<span class="ident" id="2586283">writeUidGidMappings</span><span class="op" id="2586302">(</span><span class="ident" id="2586303">pid</span><span class="op" id="2586306">,</span>&nbsp;<span class="ident" id="2586308">sys</span><span class="op" id="2586311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586316">if</span>&nbsp;<span class="ident" id="2586319">err</span>&nbsp;<span class="op" id="2586323">!=</span>&nbsp;<span class="ident" id="2586326">nil</span>&nbsp;<span class="op" id="2586330">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586336">err2</span>&nbsp;<span class="op" id="2586341">=</span>&nbsp;<span class="ident" id="2586343">err</span><span class="op" id="2586346">.</span><span class="op" id="2586347">(</span><span class="ident" id="2586348">Errno</span><span class="op" id="2586353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2586358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586363">RawSyscall</span><span class="op" id="2586373">(</span><span class="ident" id="2586374">SYS_WRITE</span><span class="op" id="2586383">,</span>&nbsp;<span class="builtintype" id="2586385">uintptr</span><span class="op" id="2586392">(</span><span class="ident" id="2586393">p</span><span class="op" id="2586394">[</span><span class="num" id="2586395">1</span><span class="op" id="2586396">]</span><span class="op" id="2586397">)</span><span class="op" id="2586398">,</span>&nbsp;<span class="builtintype" id="2586400">uintptr</span><span class="op" id="2586407">(</span><span class="ident" id="2586408">unsafe</span><span class="op" id="2586414">.</span><span class="ident" id="2586415">Pointer</span><span class="op" id="2586422">(</span><span class="op" id="2586423">&amp;</span><span class="ident" id="2586424">err2</span><span class="op" id="2586428">)</span><span class="op" id="2586429">)</span><span class="op" id="2586430">,</span>&nbsp;<span class="ident" id="2586432">unsafe</span><span class="op" id="2586438">.</span><span class="ident" id="2586439">Sizeof</span><span class="op" id="2586445">(</span><span class="ident" id="2586446">err2</span><span class="op" id="2586450">)</span><span class="op" id="2586451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586456">Close</span><span class="op" id="2586461">(</span><span class="ident" id="2586462">p</span><span class="op" id="2586463">[</span><span class="num" id="2586464">1</span><span class="op" id="2586465">]</span><span class="op" id="2586466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2586470">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586475">return</span>&nbsp;<span class="ident" id="2586482">pid</span><span class="op" id="2586485">,</span>&nbsp;<span class="num" id="2586487">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2586490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2586494">//&nbsp;Fork&nbsp;succeeded,&nbsp;now&nbsp;in&nbsp;child.</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2586529">//&nbsp;Wait&nbsp;for&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;be&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586583">if</span>&nbsp;<span class="ident" id="2586586">sys</span><span class="op" id="2586589">.</span><span class="ident" id="2586590">UidMappings</span>&nbsp;<span class="op" id="2586602">!=</span>&nbsp;<span class="ident" id="2586605">nil</span>&nbsp;<span class="op" id="2586609">||</span>&nbsp;<span class="ident" id="2586612">sys</span><span class="op" id="2586615">.</span><span class="ident" id="2586616">GidMappings</span>&nbsp;<span class="op" id="2586628">!=</span>&nbsp;<span class="ident" id="2586631">nil</span>&nbsp;<span class="op" id="2586635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586639">if</span>&nbsp;<span class="ident" id="2586642">_</span><span class="op" id="2586643">,</span>&nbsp;<span class="ident" id="2586645">_</span><span class="op" id="2586646">,</span>&nbsp;<span class="ident" id="2586648">err1</span>&nbsp;<span class="op" id="2586653">=</span>&nbsp;<span class="ident" id="2586655">RawSyscall</span><span class="op" id="2586665">(</span><span class="ident" id="2586666">SYS_CLOSE</span><span class="op" id="2586675">,</span>&nbsp;<span class="builtintype" id="2586677">uintptr</span><span class="op" id="2586684">(</span><span class="ident" id="2586685">p</span><span class="op" id="2586686">[</span><span class="num" id="2586687">1</span><span class="op" id="2586688">]</span><span class="op" id="2586689">)</span><span class="op" id="2586690">,</span>&nbsp;<span class="num" id="2586692">0</span><span class="op" id="2586693">,</span>&nbsp;<span class="num" id="2586695">0</span><span class="op" id="2586696">)</span><span class="op" id="2586697">;</span>&nbsp;<span class="ident" id="2586699">err1</span>&nbsp;<span class="op" id="2586704">!=</span>&nbsp;<span class="num" id="2586707">0</span>&nbsp;<span class="op" id="2586709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586714">goto</span>&nbsp;<span class="ident" id="2586719">childerror</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2586732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586736">r1</span><span class="op" id="2586738">,</span>&nbsp;<span class="ident" id="2586740">_</span><span class="op" id="2586741">,</span>&nbsp;<span class="ident" id="2586743">err1</span>&nbsp;<span class="op" id="2586748">=</span>&nbsp;<span class="ident" id="2586750">RawSyscall</span><span class="op" id="2586760">(</span><span class="ident" id="2586761">SYS_READ</span><span class="op" id="2586769">,</span>&nbsp;<span class="builtintype" id="2586771">uintptr</span><span class="op" id="2586778">(</span><span class="ident" id="2586779">p</span><span class="op" id="2586780">[</span><span class="num" id="2586781">0</span><span class="op" id="2586782">]</span><span class="op" id="2586783">)</span><span class="op" id="2586784">,</span>&nbsp;<span class="builtintype" id="2586786">uintptr</span><span class="op" id="2586793">(</span><span class="ident" id="2586794">unsafe</span><span class="op" id="2586800">.</span><span class="ident" id="2586801">Pointer</span><span class="op" id="2586808">(</span><span class="op" id="2586809">&amp;</span><span class="ident" id="2586810">err2</span><span class="op" id="2586814">)</span><span class="op" id="2586815">)</span><span class="op" id="2586816">,</span>&nbsp;<span class="ident" id="2586818">unsafe</span><span class="op" id="2586824">.</span><span class="ident" id="2586825">Sizeof</span><span class="op" id="2586831">(</span><span class="ident" id="2586832">err2</span><span class="op" id="2586836">)</span><span class="op" id="2586837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586841">if</span>&nbsp;<span class="ident" id="2586844">err1</span>&nbsp;<span class="op" id="2586849">!=</span>&nbsp;<span class="num" id="2586852">0</span>&nbsp;<span class="op" id="2586854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586859">goto</span>&nbsp;<span class="ident" id="2586864">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2586877">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586881">if</span>&nbsp;<span class="ident" id="2586884">r1</span>&nbsp;<span class="op" id="2586887">!=</span>&nbsp;<span class="ident" id="2586890">unsafe</span><span class="op" id="2586896">.</span><span class="ident" id="2586897">Sizeof</span><span class="op" id="2586903">(</span><span class="ident" id="2586904">err2</span><span class="op" id="2586908">)</span>&nbsp;<span class="op" id="2586910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586915">err1</span>&nbsp;<span class="op" id="2586920">=</span>&nbsp;<span class="ident" id="2586922">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586932">goto</span>&nbsp;<span class="ident" id="2586937">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2586950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586954">if</span>&nbsp;<span class="ident" id="2586957">err2</span>&nbsp;<span class="op" id="2586962">!=</span>&nbsp;<span class="num" id="2586965">0</span>&nbsp;<span class="op" id="2586967">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586972">err1</span>&nbsp;<span class="op" id="2586977">=</span>&nbsp;<span class="ident" id="2586979">err2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586987">goto</span>&nbsp;<span class="ident" id="2586992">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2587012">//&nbsp;Parent&nbsp;death&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587036">if</span>&nbsp;<span class="ident" id="2587039">sys</span><span class="op" id="2587042">.</span><span class="ident" id="2587043">Pdeathsig</span>&nbsp;<span class="op" id="2587053">!=</span>&nbsp;<span class="num" id="2587056">0</span>&nbsp;<span class="op" id="2587058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2587062">_</span><span class="op" id="2587063">,</span>&nbsp;<span class="ident" id="2587065">_</span><span class="op" id="2587066">,</span>&nbsp;<span class="ident" id="2587068">err1</span>&nbsp;<span class="op" id="2587073">=</span>&nbsp;<span class="ident" id="2587075">RawSyscall6</span><span class="op" id="2587086">(</span><span class="ident" id="2587087">SYS_PRCTL</span><span class="op" id="2587096">,</span>&nbsp;<span class="ident" id="2587098">PR_SET_PDEATHSIG</span><span class="op" id="2587114">,</span>&nbsp;<span class="builtintype" id="2587116">uintptr</span><span class="op" id="2587123">(</span><span class="ident" id="2587124">sys</span><span class="op" id="2587127">.</span><span class="ident" id="2587128">Pdeathsig</span><span class="op" id="2587137">)</span><span class="op" id="2587138">,</span>&nbsp;<span class="num" id="2587140">0</span><span class="op" id="2587141">,</span>&nbsp;<span class="num" id="2587143">0</span><span class="op" id="2587144">,</span>&nbsp;<span class="num" id="2587146">0</span><span class="op" id="2587147">,</span>&nbsp;<span class="num" id="2587149">0</span><span class="op" id="2587150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587154">if</span>&nbsp;<span class="ident" id="2587157">err1</span>&nbsp;<span class="op" id="2587162">!=</span>&nbsp;<span class="num" id="2587165">0</span>&nbsp;<span class="op" id="2587167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587172">goto</span>&nbsp;<span class="ident" id="2587177">childerror</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2587195">//&nbsp;Signal&nbsp;self&nbsp;if&nbsp;parent&nbsp;is&nbsp;already&nbsp;dead.&nbsp;This&nbsp;might&nbsp;cause&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2587258">//&nbsp;duplicate&nbsp;signal&nbsp;in&nbsp;rare&nbsp;cases,&nbsp;but&nbsp;it&nbsp;won&#39;t&nbsp;matter&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2587320">//&nbsp;using&nbsp;SIGKILL.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2587340">r1</span><span class="op" id="2587342">,</span>&nbsp;<span class="ident" id="2587344">_</span><span class="op" id="2587345">,</span>&nbsp;<span class="ident" id="2587347">_</span>&nbsp;<span class="op" id="2587349">=</span>&nbsp;<span class="ident" id="2587351">RawSyscall</span><span class="op" id="2587361">(</span><span class="ident" id="2587362">SYS_GETPPID</span><span class="op" id="2587373">,</span>&nbsp;<span class="num" id="2587375">0</span><span class="op" id="2587376">,</span>&nbsp;<span class="num" id="2587378">0</span><span class="op" id="2587379">,</span>&nbsp;<span class="num" id="2587381">0</span><span class="op" id="2587382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587386">if</span>&nbsp;<span class="ident" id="2587389">r1</span>&nbsp;<span class="op" id="2587392">==</span>&nbsp;<span class="num" id="2587395">1</span>&nbsp;<span class="op" id="2587397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2587402">pid</span><span class="op" id="2587405">,</span>&nbsp;<span class="ident" id="2587407">_</span><span class="op" id="2587408">,</span>&nbsp;<span class="ident" id="2587410">_</span>&nbsp;<span class="op" id="2587412">:=</span>&nbsp;<span class="ident" id="2587415">RawSyscall</span><span class="op" id="2587425">(</span><span class="ident" id="2587426">SYS_GETPID</span><span class="op" id="2587436">,</span>&nbsp;<span class="num" id="2587438">0</span><span class="op" id="2587439">,</span>&nbsp;<span class="num" id="2587441">0</span><span class="op" id="2587442">,</span>&nbsp;<span class="num" id="2587444">0</span><span class="op" id="2587445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2587450">_</span><span class="op" id="2587451">,</span>&nbsp;<span class="ident" id="2587453">_</span><span class="op" id="2587454">,</span>&nbsp;<span class="ident" id="2587456">err1</span>&nbsp;<span class="op" id="2587461">:=</span>&nbsp;<span class="ident" id="2587464">RawSyscall</span><span class="op" id="2587474">(</span><span class="ident" id="2587475">SYS_KILL</span><span class="op" id="2587483">,</span>&nbsp;<span class="ident" id="2587485">pid</span><span class="op" id="2587488">,</span>&nbsp;<span class="builtintype" id="2587490">uintptr</span><span class="op" id="2587497">(</span><span class="ident" id="2587498">sys</span><span class="op" id="2587501">.</span><span class="ident" id="2587502">Pdeathsig</span><span class="op" id="2587511">)</span><span class="op" id="2587512">,</span>&nbsp;<span class="num" id="2587514">0</span><span class="op" id="2587515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587520">if</span>&nbsp;<span class="ident" id="2587523">err1</span>&nbsp;<span class="op" id="2587528">!=</span>&nbsp;<span class="num" id="2587531">0</span>&nbsp;<span class="op" id="2587533">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587539">goto</span>&nbsp;<span class="ident" id="2587544">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2587569">//&nbsp;Enable&nbsp;tracing&nbsp;if&nbsp;requested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587602">if</span>&nbsp;<span class="ident" id="2587605">sys</span><span class="op" id="2587608">.</span><span class="ident" id="2587609">Ptrace</span>&nbsp;<span class="op" id="2587616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2587620">_</span><span class="op" id="2587621">,</span>&nbsp;<span class="ident" id="2587623">_</span><span class="op" id="2587624">,</span>&nbsp;<span class="ident" id="2587626">err1</span>&nbsp;<span class="op" id="2587631">=</span>&nbsp;<span class="ident" id="2587633">RawSyscall</span><span class="op" id="2587643">(</span><span class="ident" id="2587644">SYS_PTRACE</span><span class="op" id="2587654">,</span>&nbsp;<span class="builtintype" id="2587656">uintptr</span><span class="op" id="2587663">(</span><span class="ident" id="2587664">PTRACE_TRACEME</span><span class="op" id="2587678">)</span><span class="op" id="2587679">,</span>&nbsp;<span class="num" id="2587681">0</span><span class="op" id="2587682">,</span>&nbsp;<span class="num" id="2587684">0</span><span class="op" id="2587685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587689">if</span>&nbsp;<span class="ident" id="2587692">err1</span>&nbsp;<span class="op" id="2587697">!=</span>&nbsp;<span class="num" id="2587700">0</span>&nbsp;<span class="op" id="2587702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587707">goto</span>&nbsp;<span class="ident" id="2587712">childerror</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2587732">//&nbsp;Session&nbsp;ID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587747">if</span>&nbsp;<span class="ident" id="2587750">sys</span><span class="op" id="2587753">.</span><span class="ident" id="2587754">Setsid</span>&nbsp;<span class="op" id="2587761">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2587765">_</span><span class="op" id="2587766">,</span>&nbsp;<span class="ident" id="2587768">_</span><span class="op" id="2587769">,</span>&nbsp;<span class="ident" id="2587771">err1</span>&nbsp;<span class="op" id="2587776">=</span>&nbsp;<span class="ident" id="2587778">RawSyscall</span><span class="op" id="2587788">(</span><span class="ident" id="2587789">SYS_SETSID</span><span class="op" id="2587799">,</span>&nbsp;<span class="num" id="2587801">0</span><span class="op" id="2587802">,</span>&nbsp;<span class="num" id="2587804">0</span><span class="op" id="2587805">,</span>&nbsp;<span class="num" id="2587807">0</span><span class="op" id="2587808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587812">if</span>&nbsp;<span class="ident" id="2587815">err1</span>&nbsp;<span class="op" id="2587820">!=</span>&nbsp;<span class="num" id="2587823">0</span>&nbsp;<span class="op" id="2587825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587830">goto</span>&nbsp;<span class="ident" id="2587835">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587851">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2587855">//&nbsp;Set&nbsp;process&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587877">if</span>&nbsp;<span class="ident" id="2587880">sys</span><span class="op" id="2587883">.</span><span class="ident" id="2587884">Setpgid</span>&nbsp;<span class="op" id="2587892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2587896">_</span><span class="op" id="2587897">,</span>&nbsp;<span class="ident" id="2587899">_</span><span class="op" id="2587900">,</span>&nbsp;<span class="ident" id="2587902">err1</span>&nbsp;<span class="op" id="2587907">=</span>&nbsp;<span class="ident" id="2587909">RawSyscall</span><span class="op" id="2587919">(</span><span class="ident" id="2587920">SYS_SETPGID</span><span class="op" id="2587931">,</span>&nbsp;<span class="num" id="2587933">0</span><span class="op" id="2587934">,</span>&nbsp;<span class="num" id="2587936">0</span><span class="op" id="2587937">,</span>&nbsp;<span class="num" id="2587939">0</span><span class="op" id="2587940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587944">if</span>&nbsp;<span class="ident" id="2587947">err1</span>&nbsp;<span class="op" id="2587952">!=</span>&nbsp;<span class="num" id="2587955">0</span>&nbsp;<span class="op" id="2587957">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587962">goto</span>&nbsp;<span class="ident" id="2587967">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2587987">//&nbsp;Chroot</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587998">if</span>&nbsp;<span class="ident" id="2588001">chroot</span>&nbsp;<span class="op" id="2588008">!=</span>&nbsp;<span class="ident" id="2588011">nil</span>&nbsp;<span class="op" id="2588015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2588019">_</span><span class="op" id="2588020">,</span>&nbsp;<span class="ident" id="2588022">_</span><span class="op" id="2588023">,</span>&nbsp;<span class="ident" id="2588025">err1</span>&nbsp;<span class="op" id="2588030">=</span>&nbsp;<span class="ident" id="2588032">RawSyscall</span><span class="op" id="2588042">(</span><span class="ident" id="2588043">SYS_CHROOT</span><span class="op" id="2588053">,</span>&nbsp;<span class="builtintype" id="2588055">uintptr</span><span class="op" id="2588062">(</span><span class="ident" id="2588063">unsafe</span><span class="op" id="2588069">.</span><span class="ident" id="2588070">Pointer</span><span class="op" id="2588077">(</span><span class="ident" id="2588078">chroot</span><span class="op" id="2588084">)</span><span class="op" id="2588085">)</span><span class="op" id="2588086">,</span>&nbsp;<span class="num" id="2588088">0</span><span class="op" id="2588089">,</span>&nbsp;<span class="num" id="2588091">0</span><span class="op" id="2588092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588096">if</span>&nbsp;<span class="ident" id="2588099">err1</span>&nbsp;<span class="op" id="2588104">!=</span>&nbsp;<span class="num" id="2588107">0</span>&nbsp;<span class="op" id="2588109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588114">goto</span>&nbsp;<span class="ident" id="2588119">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2588132">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2588135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2588139">//&nbsp;User&nbsp;and&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588159">if</span>&nbsp;<span class="ident" id="2588162">cred</span>&nbsp;<span class="op" id="2588167">:=</span>&nbsp;<span class="ident" id="2588170">sys</span><span class="op" id="2588173">.</span><span class="ident" id="2588174">Credential</span><span class="op" id="2588184">;</span>&nbsp;<span class="ident" id="2588186">cred</span>&nbsp;<span class="op" id="2588191">!=</span>&nbsp;<span class="ident" id="2588194">nil</span>&nbsp;<span class="op" id="2588198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2588202">ngroups</span>&nbsp;<span class="op" id="2588210">:=</span>&nbsp;<span class="builtintype" id="2588213">uintptr</span><span class="op" id="2588220">(</span><span class="builtinfunc" id="2588221">len</span><span class="op" id="2588224">(</span><span class="ident" id="2588225">cred</span><span class="op" id="2588229">.</span><span class="ident" id="2588230">Groups</span><span class="op" id="2588236">)</span><span class="op" id="2588237">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588241">var</span>&nbsp;<span class="ident" id="2588245">groups</span>&nbsp;<span class="ident" id="2588252">unsafe</span><span class="op" id="2588258">.</span><span class="ident" id="2588259">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588269">if</span>&nbsp;<span class="ident" id="2588272">ngroups</span>&nbsp;<span class="op" id="2588280">&gt;</span>&nbsp;<span class="num" id="2588282">0</span>&nbsp;<span class="op" id="2588284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2588289">groups</span>&nbsp;<span class="op" id="2588296">=</span>&nbsp;<span class="ident" id="2588298">unsafe</span><span class="op" id="2588304">.</span><span class="ident" id="2588305">Pointer</span><span class="op" id="2588312">(</span><span class="op" id="2588313">&amp;</span><span class="ident" id="2588314">cred</span><span class="op" id="2588318">.</span><span class="ident" id="2588319">Groups</span><span class="op" id="2588325">[</span><span class="num" id="2588326">0</span><span class="op" id="2588327">]</span><span class="op" id="2588328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2588332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2588336">_</span><span class="op" id="2588337">,</span>&nbsp;<span class="ident" id="2588339">_</span><span class="op" id="2588340">,</span>&nbsp;<span class="ident" id="2588342">err1</span>&nbsp;<span class="op" id="2588347">=</span>&nbsp;<span class="ident" id="2588349">RawSyscall</span><span class="op" id="2588359">(</span><span class="ident" id="2588360">SYS_SETGROUPS</span><span class="op" id="2588373">,</span>&nbsp;<span class="ident" id="2588375">ngroups</span><span class="op" id="2588382">,</span>&nbsp;<span class="builtintype" id="2588384">uintptr</span><span class="op" id="2588391">(</span><span class="ident" id="2588392">groups</span><span class="op" id="2588398">)</span><span class="op" id="2588399">,</span>&nbsp;<span class="num" id="2588401">0</span><span class="op" id="2588402">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588406">if</span>&nbsp;<span class="ident" id="2588409">err1</span>&nbsp;<span class="op" id="2588414">!=</span>&nbsp;<span class="num" id="2588417">0</span>&nbsp;<span class="op" id="2588419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588424">goto</span>&nbsp;<span class="ident" id="2588429">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2588442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2588446">_</span><span class="op" id="2588447">,</span>&nbsp;<span class="ident" id="2588449">_</span><span class="op" id="2588450">,</span>&nbsp;<span class="ident" id="2588452">err1</span>&nbsp;<span class="op" id="2588457">=</span>&nbsp;<span class="ident" id="2588459">RawSyscall</span><span class="op" id="2588469">(</span><span class="ident" id="2588470">SYS_SETGID</span><span class="op" id="2588480">,</span>&nbsp;<span class="builtintype" id="2588482">uintptr</span><span class="op" id="2588489">(</span><span class="ident" id="2588490">cred</span><span class="op" id="2588494">.</span><span class="ident" id="2588495">Gid</span><span class="op" id="2588498">)</span><span class="op" id="2588499">,</span>&nbsp;<span class="num" id="2588501">0</span><span class="op" id="2588502">,</span>&nbsp;<span class="num" id="2588504">0</span><span class="op" id="2588505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588509">if</span>&nbsp;<span class="ident" id="2588512">err1</span>&nbsp;<span class="op" id="2588517">!=</span>&nbsp;<span class="num" id="2588520">0</span>&nbsp;<span class="op" id="2588522">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588527">goto</span>&nbsp;<span class="ident" id="2588532">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2588545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2588549">_</span><span class="op" id="2588550">,</span>&nbsp;<span class="ident" id="2588552">_</span><span class="op" id="2588553">,</span>&nbsp;<span class="ident" id="2588555">err1</span>&nbsp;<span class="op" id="2588560">=</span>&nbsp;<span class="ident" id="2588562">RawSyscall</span><span class="op" id="2588572">(</span><span class="ident" id="2588573">SYS_SETUID</span><span class="op" id="2588583">,</span>&nbsp;<span class="builtintype" id="2588585">uintptr</span><span class="op" id="2588592">(</span><span class="ident" id="2588593">cred</span><span class="op" id="2588597">.</span><span class="ident" id="2588598">Uid</span><span class="op" id="2588601">)</span><span class="op" id="2588602">,</span>&nbsp;<span class="num" id="2588604">0</span><span class="op" id="2588605">,</span>&nbsp;<span class="num" id="2588607">0</span><span class="op" id="2588608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588612">if</span>&nbsp;<span class="ident" id="2588615">err1</span>&nbsp;<span class="op" id="2588620">!=</span>&nbsp;<span class="num" id="2588623">0</span>&nbsp;<span class="op" id="2588625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588630">goto</span>&nbsp;<span class="ident" id="2588635">childerror</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2588648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2588651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2588655">//&nbsp;Chdir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588665">if</span>&nbsp;<span class="ident" id="2588668">dir</span>&nbsp;<span class="op" id="2588672">!=</span>&nbsp;<span class="ident" id="2588675">nil</span>&nbsp;<span class="op" id="2588679">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2588683">_</span><span class="op" id="2588684">,</span>&nbsp;<span class="ident" id="2588686">_</span><span class="op" id="2588687">,</span>&nbsp;<span class="ident" id="2588689">err1</span>&nbsp;<span class="op" id="2588694">=</span>&nbsp;<span class="ident" id="2588696">RawSyscall</span><span class="op" id="2588706">(</span><span class="ident" id="2588707">SYS_CHDIR</span><span class="op" id="2588716">,</span>&nbsp;<span class="builtintype" id="2588718">uintptr</span><span class="op" id="2588725">(</span><span class="ident" id="2588726">unsafe</span><span class="op" id="2588732">.</span><span class="ident" id="2588733">Pointer</span><span class="op" id="2588740">(</span><span class="ident" id="2588741">dir</span><span class="op" id="2588744">)</span><span class="op" id="2588745">)</span><span class="op" id="2588746">,</span>&nbsp;<span class="num" id="2588748">0</span><span class="op" id="2588749">,</span>&nbsp;<span class="num" id="2588751">0</span><span class="op" id="2588752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588756">if</span>&nbsp;<span class="ident" id="2588759">err1</span>&nbsp;<span class="op" id="2588764">!=</span>&nbsp;<span class="num" id="2588767">0</span>&nbsp;<span class="op" id="2588769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588774">goto</span>&nbsp;<span class="ident" id="2588779">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2588792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2588795">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2588799">//&nbsp;Pass&nbsp;1:&nbsp;look&nbsp;for&nbsp;fd[i]&nbsp;&lt;&nbsp;i&nbsp;and&nbsp;move&nbsp;those&nbsp;up&nbsp;above&nbsp;len(fd)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2588862">//&nbsp;so&nbsp;that&nbsp;pass&nbsp;2&nbsp;won&#39;t&nbsp;stomp&nbsp;on&nbsp;an&nbsp;fd&nbsp;it&nbsp;needs&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2588918">if</span>&nbsp;<span class="ident" id="2588921">pipe</span>&nbsp;<span class="op" id="2588926">&lt;</span>&nbsp;<span class="ident" id="2588928">nextfd</span>&nbsp;<span class="op" id="2588935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2588939">_</span><span class="op" id="2588940">,</span>&nbsp;<span class="ident" id="2588942">_</span><span class="op" id="2588943">,</span>&nbsp;<span class="ident" id="2588945">err1</span>&nbsp;<span class="op" id="2588950">=</span>&nbsp;<span class="ident" id="2588952">RawSyscall</span><span class="op" id="2588962">(</span><span class="ident" id="2588963">SYS_DUP2</span><span class="op" id="2588971">,</span>&nbsp;<span class="builtintype" id="2588973">uintptr</span><span class="op" id="2588980">(</span><span class="ident" id="2588981">pipe</span><span class="op" id="2588985">)</span><span class="op" id="2588986">,</span>&nbsp;<span class="builtintype" id="2588988">uintptr</span><span class="op" id="2588995">(</span><span class="ident" id="2588996">nextfd</span><span class="op" id="2589002">)</span><span class="op" id="2589003">,</span>&nbsp;<span class="num" id="2589005">0</span><span class="op" id="2589006">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589010">if</span>&nbsp;<span class="ident" id="2589013">err1</span>&nbsp;<span class="op" id="2589018">!=</span>&nbsp;<span class="num" id="2589021">0</span>&nbsp;<span class="op" id="2589023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589028">goto</span>&nbsp;<span class="ident" id="2589033">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2589046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2589050">RawSyscall</span><span class="op" id="2589060">(</span><span class="ident" id="2589061">SYS_FCNTL</span><span class="op" id="2589070">,</span>&nbsp;<span class="builtintype" id="2589072">uintptr</span><span class="op" id="2589079">(</span><span class="ident" id="2589080">nextfd</span><span class="op" id="2589086">)</span><span class="op" id="2589087">,</span>&nbsp;<span class="ident" id="2589089">F_SETFD</span><span class="op" id="2589096">,</span>&nbsp;<span class="ident" id="2589098">FD_CLOEXEC</span><span class="op" id="2589108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2589112">pipe</span>&nbsp;<span class="op" id="2589117">=</span>&nbsp;<span class="ident" id="2589119">nextfd</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2589128">nextfd</span><span class="op" id="2589134">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2589138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589141">for</span>&nbsp;<span class="ident" id="2589145">i</span>&nbsp;<span class="op" id="2589147">=</span>&nbsp;<span class="num" id="2589149">0</span><span class="op" id="2589150">;</span>&nbsp;<span class="ident" id="2589152">i</span>&nbsp;<span class="op" id="2589154">&lt;</span>&nbsp;<span class="builtinfunc" id="2589156">len</span><span class="op" id="2589159">(</span><span class="ident" id="2589160">fd</span><span class="op" id="2589162">)</span><span class="op" id="2589163">;</span>&nbsp;<span class="ident" id="2589165">i</span><span class="op" id="2589166">++</span>&nbsp;<span class="op" id="2589169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589173">if</span>&nbsp;<span class="ident" id="2589176">fd</span><span class="op" id="2589178">[</span><span class="ident" id="2589179">i</span><span class="op" id="2589180">]</span>&nbsp;<span class="op" id="2589182">&gt;=</span>&nbsp;<span class="num" id="2589185">0</span>&nbsp;<span class="op" id="2589187">&amp;&amp;</span>&nbsp;<span class="ident" id="2589190">fd</span><span class="op" id="2589192">[</span><span class="ident" id="2589193">i</span><span class="op" id="2589194">]</span>&nbsp;<span class="op" id="2589196">&lt;</span>&nbsp;<span class="builtintype" id="2589198">int</span><span class="op" id="2589201">(</span><span class="ident" id="2589202">i</span><span class="op" id="2589203">)</span>&nbsp;<span class="op" id="2589205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2589210">_</span><span class="op" id="2589211">,</span>&nbsp;<span class="ident" id="2589213">_</span><span class="op" id="2589214">,</span>&nbsp;<span class="ident" id="2589216">err1</span>&nbsp;<span class="op" id="2589221">=</span>&nbsp;<span class="ident" id="2589223">RawSyscall</span><span class="op" id="2589233">(</span><span class="ident" id="2589234">SYS_DUP2</span><span class="op" id="2589242">,</span>&nbsp;<span class="builtintype" id="2589244">uintptr</span><span class="op" id="2589251">(</span><span class="ident" id="2589252">fd</span><span class="op" id="2589254">[</span><span class="ident" id="2589255">i</span><span class="op" id="2589256">]</span><span class="op" id="2589257">)</span><span class="op" id="2589258">,</span>&nbsp;<span class="builtintype" id="2589260">uintptr</span><span class="op" id="2589267">(</span><span class="ident" id="2589268">nextfd</span><span class="op" id="2589274">)</span><span class="op" id="2589275">,</span>&nbsp;<span class="num" id="2589277">0</span><span class="op" id="2589278">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589283">if</span>&nbsp;<span class="ident" id="2589286">err1</span>&nbsp;<span class="op" id="2589291">!=</span>&nbsp;<span class="num" id="2589294">0</span>&nbsp;<span class="op" id="2589296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589302">goto</span>&nbsp;<span class="ident" id="2589307">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2589321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2589326">RawSyscall</span><span class="op" id="2589336">(</span><span class="ident" id="2589337">SYS_FCNTL</span><span class="op" id="2589346">,</span>&nbsp;<span class="builtintype" id="2589348">uintptr</span><span class="op" id="2589355">(</span><span class="ident" id="2589356">nextfd</span><span class="op" id="2589362">)</span><span class="op" id="2589363">,</span>&nbsp;<span class="ident" id="2589365">F_SETFD</span><span class="op" id="2589372">,</span>&nbsp;<span class="ident" id="2589374">FD_CLOEXEC</span><span class="op" id="2589384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2589389">fd</span><span class="op" id="2589391">[</span><span class="ident" id="2589392">i</span><span class="op" id="2589393">]</span>&nbsp;<span class="op" id="2589395">=</span>&nbsp;<span class="ident" id="2589397">nextfd</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2589407">nextfd</span><span class="op" id="2589413">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589419">if</span>&nbsp;<span class="ident" id="2589422">nextfd</span>&nbsp;<span class="op" id="2589429">==</span>&nbsp;<span class="ident" id="2589432">pipe</span>&nbsp;<span class="op" id="2589437">{</span>&nbsp;<span class="comment" id="2589439">//&nbsp;don&#39;t&nbsp;stomp&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2589466">nextfd</span><span class="op" id="2589472">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2589478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2589482">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2589485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2589489">//&nbsp;Pass&nbsp;2:&nbsp;dup&nbsp;fd[i]&nbsp;down&nbsp;onto&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589524">for</span>&nbsp;<span class="ident" id="2589528">i</span>&nbsp;<span class="op" id="2589530">=</span>&nbsp;<span class="num" id="2589532">0</span><span class="op" id="2589533">;</span>&nbsp;<span class="ident" id="2589535">i</span>&nbsp;<span class="op" id="2589537">&lt;</span>&nbsp;<span class="builtinfunc" id="2589539">len</span><span class="op" id="2589542">(</span><span class="ident" id="2589543">fd</span><span class="op" id="2589545">)</span><span class="op" id="2589546">;</span>&nbsp;<span class="ident" id="2589548">i</span><span class="op" id="2589549">++</span>&nbsp;<span class="op" id="2589552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589556">if</span>&nbsp;<span class="ident" id="2589559">fd</span><span class="op" id="2589561">[</span><span class="ident" id="2589562">i</span><span class="op" id="2589563">]</span>&nbsp;<span class="op" id="2589565">==</span>&nbsp;<span class="op" id="2589568">-</span><span class="num" id="2589569">1</span>&nbsp;<span class="op" id="2589571">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2589576">RawSyscall</span><span class="op" id="2589586">(</span><span class="ident" id="2589587">SYS_CLOSE</span><span class="op" id="2589596">,</span>&nbsp;<span class="builtintype" id="2589598">uintptr</span><span class="op" id="2589605">(</span><span class="ident" id="2589606">i</span><span class="op" id="2589607">)</span><span class="op" id="2589608">,</span>&nbsp;<span class="num" id="2589610">0</span><span class="op" id="2589611">,</span>&nbsp;<span class="num" id="2589613">0</span><span class="op" id="2589614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589619">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2589630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589634">if</span>&nbsp;<span class="ident" id="2589637">fd</span><span class="op" id="2589639">[</span><span class="ident" id="2589640">i</span><span class="op" id="2589641">]</span>&nbsp;<span class="op" id="2589643">==</span>&nbsp;<span class="builtintype" id="2589646">int</span><span class="op" id="2589649">(</span><span class="ident" id="2589650">i</span><span class="op" id="2589651">)</span>&nbsp;<span class="op" id="2589653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2589658">//&nbsp;dup2(i,&nbsp;i)&nbsp;won&#39;t&nbsp;clear&nbsp;close-on-exec&nbsp;flag&nbsp;on&nbsp;Linux,</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2589716">//&nbsp;probably&nbsp;not&nbsp;elsewhere&nbsp;either.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2589753">_</span><span class="op" id="2589754">,</span>&nbsp;<span class="ident" id="2589756">_</span><span class="op" id="2589757">,</span>&nbsp;<span class="ident" id="2589759">err1</span>&nbsp;<span class="op" id="2589764">=</span>&nbsp;<span class="ident" id="2589766">RawSyscall</span><span class="op" id="2589776">(</span><span class="ident" id="2589777">SYS_FCNTL</span><span class="op" id="2589786">,</span>&nbsp;<span class="builtintype" id="2589788">uintptr</span><span class="op" id="2589795">(</span><span class="ident" id="2589796">fd</span><span class="op" id="2589798">[</span><span class="ident" id="2589799">i</span><span class="op" id="2589800">]</span><span class="op" id="2589801">)</span><span class="op" id="2589802">,</span>&nbsp;<span class="ident" id="2589804">F_SETFD</span><span class="op" id="2589811">,</span>&nbsp;<span class="num" id="2589813">0</span><span class="op" id="2589814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589819">if</span>&nbsp;<span class="ident" id="2589822">err1</span>&nbsp;<span class="op" id="2589827">!=</span>&nbsp;<span class="num" id="2589830">0</span>&nbsp;<span class="op" id="2589832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589838">goto</span>&nbsp;<span class="ident" id="2589843">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2589857">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2589862">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2589873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2589877">//&nbsp;The&nbsp;new&nbsp;fd&nbsp;is&nbsp;created&nbsp;NOT&nbsp;close-on-exec,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2589923">//&nbsp;which&nbsp;is&nbsp;exactly&nbsp;what&nbsp;we&nbsp;want.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2589959">_</span><span class="op" id="2589960">,</span>&nbsp;<span class="ident" id="2589962">_</span><span class="op" id="2589963">,</span>&nbsp;<span class="ident" id="2589965">err1</span>&nbsp;<span class="op" id="2589970">=</span>&nbsp;<span class="ident" id="2589972">RawSyscall</span><span class="op" id="2589982">(</span><span class="ident" id="2589983">SYS_DUP2</span><span class="op" id="2589991">,</span>&nbsp;<span class="builtintype" id="2589993">uintptr</span><span class="op" id="2590000">(</span><span class="ident" id="2590001">fd</span><span class="op" id="2590003">[</span><span class="ident" id="2590004">i</span><span class="op" id="2590005">]</span><span class="op" id="2590006">)</span><span class="op" id="2590007">,</span>&nbsp;<span class="builtintype" id="2590009">uintptr</span><span class="op" id="2590016">(</span><span class="ident" id="2590017">i</span><span class="op" id="2590018">)</span><span class="op" id="2590019">,</span>&nbsp;<span class="num" id="2590021">0</span><span class="op" id="2590022">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2590026">if</span>&nbsp;<span class="ident" id="2590029">err1</span>&nbsp;<span class="op" id="2590034">!=</span>&nbsp;<span class="num" id="2590037">0</span>&nbsp;<span class="op" id="2590039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2590044">goto</span>&nbsp;<span class="ident" id="2590049">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2590062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2590065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2590069">//&nbsp;By&nbsp;convention,&nbsp;we&nbsp;don&#39;t&nbsp;close-on-exec&nbsp;the&nbsp;fds&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2590126">//&nbsp;started&nbsp;with,&nbsp;so&nbsp;if&nbsp;len(fd)&nbsp;&lt;&nbsp;3,&nbsp;close&nbsp;0,&nbsp;1,&nbsp;2&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2590188">//&nbsp;Programs&nbsp;that&nbsp;know&nbsp;they&nbsp;inherit&nbsp;fds&nbsp;&gt;=&nbsp;3&nbsp;will&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2590243">//&nbsp;to&nbsp;set&nbsp;them&nbsp;close-on-exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2590274">for</span>&nbsp;<span class="ident" id="2590278">i</span>&nbsp;<span class="op" id="2590280">=</span>&nbsp;<span class="builtinfunc" id="2590282">len</span><span class="op" id="2590285">(</span><span class="ident" id="2590286">fd</span><span class="op" id="2590288">)</span><span class="op" id="2590289">;</span>&nbsp;<span class="ident" id="2590291">i</span>&nbsp;<span class="op" id="2590293">&lt;</span>&nbsp;<span class="num" id="2590295">3</span><span class="op" id="2590296">;</span>&nbsp;<span class="ident" id="2590298">i</span><span class="op" id="2590299">++</span>&nbsp;<span class="op" id="2590302">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2590306">RawSyscall</span><span class="op" id="2590316">(</span><span class="ident" id="2590317">SYS_CLOSE</span><span class="op" id="2590326">,</span>&nbsp;<span class="builtintype" id="2590328">uintptr</span><span class="op" id="2590335">(</span><span class="ident" id="2590336">i</span><span class="op" id="2590337">)</span><span class="op" id="2590338">,</span>&nbsp;<span class="num" id="2590340">0</span><span class="op" id="2590341">,</span>&nbsp;<span class="num" id="2590343">0</span><span class="op" id="2590344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2590347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2590351">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;tty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2590376">if</span>&nbsp;<span class="ident" id="2590379">sys</span><span class="op" id="2590382">.</span><span class="ident" id="2590383">Noctty</span>&nbsp;<span class="op" id="2590390">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2590394">_</span><span class="op" id="2590395">,</span>&nbsp;<span class="ident" id="2590397">_</span><span class="op" id="2590398">,</span>&nbsp;<span class="ident" id="2590400">err1</span>&nbsp;<span class="op" id="2590405">=</span>&nbsp;<span class="ident" id="2590407">RawSyscall</span><span class="op" id="2590417">(</span><span class="ident" id="2590418">SYS_IOCTL</span><span class="op" id="2590427">,</span>&nbsp;<span class="num" id="2590429">0</span><span class="op" id="2590430">,</span>&nbsp;<span class="builtintype" id="2590432">uintptr</span><span class="op" id="2590439">(</span><span class="ident" id="2590440">TIOCNOTTY</span><span class="op" id="2590449">)</span><span class="op" id="2590450">,</span>&nbsp;<span class="num" id="2590452">0</span><span class="op" id="2590453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2590457">if</span>&nbsp;<span class="ident" id="2590460">err1</span>&nbsp;<span class="op" id="2590465">!=</span>&nbsp;<span class="num" id="2590468">0</span>&nbsp;<span class="op" id="2590470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2590475">goto</span>&nbsp;<span class="ident" id="2590480">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2590493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2590496">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2590500">//&nbsp;Set&nbsp;the&nbsp;controlling&nbsp;TTY&nbsp;to&nbsp;Ctty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2590536">if</span>&nbsp;<span class="ident" id="2590539">sys</span><span class="op" id="2590542">.</span><span class="ident" id="2590543">Setctty</span>&nbsp;<span class="op" id="2590551">&amp;&amp;</span>&nbsp;<span class="ident" id="2590554">sys</span><span class="op" id="2590557">.</span><span class="ident" id="2590558">Ctty</span>&nbsp;<span class="op" id="2590563">&gt;=</span>&nbsp;<span class="num" id="2590566">0</span>&nbsp;<span class="op" id="2590568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2590572">_</span><span class="op" id="2590573">,</span>&nbsp;<span class="ident" id="2590575">_</span><span class="op" id="2590576">,</span>&nbsp;<span class="ident" id="2590578">err1</span>&nbsp;<span class="op" id="2590583">=</span>&nbsp;<span class="ident" id="2590585">RawSyscall</span><span class="op" id="2590595">(</span><span class="ident" id="2590596">SYS_IOCTL</span><span class="op" id="2590605">,</span>&nbsp;<span class="builtintype" id="2590607">uintptr</span><span class="op" id="2590614">(</span><span class="ident" id="2590615">sys</span><span class="op" id="2590618">.</span><span class="ident" id="2590619">Ctty</span><span class="op" id="2590623">)</span><span class="op" id="2590624">,</span>&nbsp;<span class="builtintype" id="2590626">uintptr</span><span class="op" id="2590633">(</span><span class="ident" id="2590634">TIOCSCTTY</span><span class="op" id="2590643">)</span><span class="op" id="2590644">,</span>&nbsp;<span class="num" id="2590646">0</span><span class="op" id="2590647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2590651">if</span>&nbsp;<span class="ident" id="2590654">err1</span>&nbsp;<span class="op" id="2590659">!=</span>&nbsp;<span class="num" id="2590662">0</span>&nbsp;<span class="op" id="2590664">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2590669">goto</span>&nbsp;<span class="ident" id="2590674">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2590687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2590690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2590694">//&nbsp;Time&nbsp;to&nbsp;exec.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2590712">_</span><span class="op" id="2590713">,</span>&nbsp;<span class="ident" id="2590715">_</span><span class="op" id="2590716">,</span>&nbsp;<span class="ident" id="2590718">err1</span>&nbsp;<span class="op" id="2590723">=</span>&nbsp;<span class="ident" id="2590725">RawSyscall</span><span class="op" id="2590735">(</span><span class="ident" id="2590736">SYS_EXECVE</span><span class="op" id="2590746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2590750">uintptr</span><span class="op" id="2590757">(</span><span class="ident" id="2590758">unsafe</span><span class="op" id="2590764">.</span><span class="ident" id="2590765">Pointer</span><span class="op" id="2590772">(</span><span class="ident" id="2590773">argv0</span><span class="op" id="2590778">)</span><span class="op" id="2590779">)</span><span class="op" id="2590780">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2590784">uintptr</span><span class="op" id="2590791">(</span><span class="ident" id="2590792">unsafe</span><span class="op" id="2590798">.</span><span class="ident" id="2590799">Pointer</span><span class="op" id="2590806">(</span><span class="op" id="2590807">&amp;</span><span class="ident" id="2590808">argv</span><span class="op" id="2590812">[</span><span class="num" id="2590813">0</span><span class="op" id="2590814">]</span><span class="op" id="2590815">)</span><span class="op" id="2590816">)</span><span class="op" id="2590817">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2590821">uintptr</span><span class="op" id="2590828">(</span><span class="ident" id="2590829">unsafe</span><span class="op" id="2590835">.</span><span class="ident" id="2590836">Pointer</span><span class="op" id="2590843">(</span><span class="op" id="2590844">&amp;</span><span class="ident" id="2590845">envv</span><span class="op" id="2590849">[</span><span class="num" id="2590850">0</span><span class="op" id="2590851">]</span><span class="op" id="2590852">)</span><span class="op" id="2590853">)</span><span class="op" id="2590854">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="ident" id="2590857">childerror</span><span class="op" id="2590867">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2590870">//&nbsp;send&nbsp;error&nbsp;code&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2590898">RawSyscall</span><span class="op" id="2590908">(</span><span class="ident" id="2590909">SYS_WRITE</span><span class="op" id="2590918">,</span>&nbsp;<span class="builtintype" id="2590920">uintptr</span><span class="op" id="2590927">(</span><span class="ident" id="2590928">pipe</span><span class="op" id="2590932">)</span><span class="op" id="2590933">,</span>&nbsp;<span class="builtintype" id="2590935">uintptr</span><span class="op" id="2590942">(</span><span class="ident" id="2590943">unsafe</span><span class="op" id="2590949">.</span><span class="ident" id="2590950">Pointer</span><span class="op" id="2590957">(</span><span class="op" id="2590958">&amp;</span><span class="ident" id="2590959">err1</span><span class="op" id="2590963">)</span><span class="op" id="2590964">)</span><span class="op" id="2590965">,</span>&nbsp;<span class="ident" id="2590967">unsafe</span><span class="op" id="2590973">.</span><span class="ident" id="2590974">Sizeof</span><span class="op" id="2590980">(</span><span class="ident" id="2590981">err1</span><span class="op" id="2590985">)</span><span class="op" id="2590986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2590989">for</span>&nbsp;<span class="op" id="2590993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2590997">RawSyscall</span><span class="op" id="2591007">(</span><span class="ident" id="2591008">SYS_EXIT</span><span class="op" id="2591016">,</span>&nbsp;<span class="num" id="2591018">253</span><span class="op" id="2591021">,</span>&nbsp;<span class="num" id="2591023">0</span><span class="op" id="2591024">,</span>&nbsp;<span class="num" id="2591026">0</span><span class="op" id="2591027">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2591030">}</span><br>
<span class="lineno"></span><span class="op" id="2591032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2591035">//&nbsp;Try&nbsp;to&nbsp;open&nbsp;a&nbsp;pipe&nbsp;with&nbsp;O_CLOEXEC&nbsp;set&nbsp;on&nbsp;both&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="2591102">func</span>&nbsp;<span class="ident" id="2591107">forkExecPipe</span><span class="op" id="2591119">(</span><span class="ident" id="2591120">p</span>&nbsp;<span class="op" id="2591122">[</span><span class="op" id="2591123">]</span><span class="builtintype" id="2591124">int</span><span class="op" id="2591127">)</span>&nbsp;<span class="op" id="2591129">(</span><span class="ident" id="2591130">err</span>&nbsp;<span class="builtintype" id="2591134">error</span><span class="op" id="2591139">)</span>&nbsp;<span class="op" id="2591141">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2591144">err</span>&nbsp;<span class="op" id="2591148">=</span>&nbsp;<span class="ident" id="2591150">Pipe2</span><span class="op" id="2591155">(</span><span class="ident" id="2591156">p</span><span class="op" id="2591157">,</span>&nbsp;<span class="ident" id="2591159">O_CLOEXEC</span><span class="op" id="2591168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2591171">//&nbsp;pipe2&nbsp;was&nbsp;added&nbsp;in&nbsp;2.6.27&nbsp;and&nbsp;our&nbsp;minimum&nbsp;requirement&nbsp;is&nbsp;2.6.23,&nbsp;so&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2591246">//&nbsp;might&nbsp;not&nbsp;be&nbsp;implemented.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591276">if</span>&nbsp;<span class="ident" id="2591279">err</span>&nbsp;<span class="op" id="2591283">==</span>&nbsp;<span class="ident" id="2591286">ENOSYS</span>&nbsp;<span class="op" id="2591293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591297">if</span>&nbsp;<span class="ident" id="2591300">err</span>&nbsp;<span class="op" id="2591304">=</span>&nbsp;<span class="ident" id="2591306">Pipe</span><span class="op" id="2591310">(</span><span class="ident" id="2591311">p</span><span class="op" id="2591312">)</span><span class="op" id="2591313">;</span>&nbsp;<span class="ident" id="2591315">err</span>&nbsp;<span class="op" id="2591319">!=</span>&nbsp;<span class="ident" id="2591322">nil</span>&nbsp;<span class="op" id="2591326">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591331">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2591340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591344">if</span>&nbsp;<span class="ident" id="2591347">_</span><span class="op" id="2591348">,</span>&nbsp;<span class="ident" id="2591350">err</span>&nbsp;<span class="op" id="2591354">=</span>&nbsp;<span class="ident" id="2591356">fcntl</span><span class="op" id="2591361">(</span><span class="ident" id="2591362">p</span><span class="op" id="2591363">[</span><span class="num" id="2591364">0</span><span class="op" id="2591365">]</span><span class="op" id="2591366">,</span>&nbsp;<span class="ident" id="2591368">F_SETFD</span><span class="op" id="2591375">,</span>&nbsp;<span class="ident" id="2591377">FD_CLOEXEC</span><span class="op" id="2591387">)</span><span class="op" id="2591388">;</span>&nbsp;<span class="ident" id="2591390">err</span>&nbsp;<span class="op" id="2591394">!=</span>&nbsp;<span class="ident" id="2591397">nil</span>&nbsp;<span class="op" id="2591401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591406">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2591415">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2591419">_</span><span class="op" id="2591420">,</span>&nbsp;<span class="ident" id="2591422">err</span>&nbsp;<span class="op" id="2591426">=</span>&nbsp;<span class="ident" id="2591428">fcntl</span><span class="op" id="2591433">(</span><span class="ident" id="2591434">p</span><span class="op" id="2591435">[</span><span class="num" id="2591436">1</span><span class="op" id="2591437">]</span><span class="op" id="2591438">,</span>&nbsp;<span class="ident" id="2591440">F_SETFD</span><span class="op" id="2591447">,</span>&nbsp;<span class="ident" id="2591449">FD_CLOEXEC</span><span class="op" id="2591459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2591462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591465">return</span><br>
<span class="lineno"></span><span class="op" id="2591472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment" id="2591475">//&nbsp;writeIDMappings&nbsp;writes&nbsp;the&nbsp;user&nbsp;namespace&nbsp;User&nbsp;ID&nbsp;or&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;the&nbsp;specified&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="2591572">func</span>&nbsp;<span class="ident" id="2591577">writeIDMappings</span><span class="op" id="2591592">(</span><span class="ident" id="2591593">path</span>&nbsp;<span class="builtintype" id="2591598">string</span><span class="op" id="2591604">,</span>&nbsp;<span class="ident" id="2591606">idMap</span>&nbsp;<span class="op" id="2591612">[</span><span class="op" id="2591613">]</span><span class="ident" id="2591614">SysProcIDMap</span><span class="op" id="2591626">)</span>&nbsp;<span class="builtintype" id="2591628">error</span>&nbsp;<span class="op" id="2591634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2591637">fd</span><span class="op" id="2591639">,</span>&nbsp;<span class="ident" id="2591641">err</span>&nbsp;<span class="op" id="2591645">:=</span>&nbsp;<span class="ident" id="2591648">Open</span><span class="op" id="2591652">(</span><span class="ident" id="2591653">path</span><span class="op" id="2591657">,</span>&nbsp;<span class="ident" id="2591659">O_RDWR</span><span class="op" id="2591665">,</span>&nbsp;<span class="num" id="2591667">0</span><span class="op" id="2591668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591671">if</span>&nbsp;<span class="ident" id="2591674">err</span>&nbsp;<span class="op" id="2591678">!=</span>&nbsp;<span class="ident" id="2591681">nil</span>&nbsp;<span class="op" id="2591685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591689">return</span>&nbsp;<span class="ident" id="2591696">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2591701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2591705">data</span>&nbsp;<span class="op" id="2591710">:=</span>&nbsp;<span class="string" id="2591713">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591717">for</span>&nbsp;<span class="ident" id="2591721">_</span><span class="op" id="2591722">,</span>&nbsp;<span class="ident" id="2591724">im</span>&nbsp;<span class="op" id="2591727">:=</span>&nbsp;<span class="keyword" id="2591730">range</span>&nbsp;<span class="ident" id="2591736">idMap</span>&nbsp;<span class="op" id="2591742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2591746">data</span>&nbsp;<span class="op" id="2591751">=</span>&nbsp;<span class="ident" id="2591753">data</span>&nbsp;<span class="op" id="2591758">+</span>&nbsp;<span class="ident" id="2591760">itoa</span><span class="op" id="2591764">(</span><span class="ident" id="2591765">im</span><span class="op" id="2591767">.</span><span class="ident" id="2591768">ContainerID</span><span class="op" id="2591779">)</span>&nbsp;<span class="op" id="2591781">+</span>&nbsp;<span class="string" id="2591783">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2591787">+</span>&nbsp;<span class="ident" id="2591789">itoa</span><span class="op" id="2591793">(</span><span class="ident" id="2591794">im</span><span class="op" id="2591796">.</span><span class="ident" id="2591797">HostID</span><span class="op" id="2591803">)</span>&nbsp;<span class="op" id="2591805">+</span>&nbsp;<span class="string" id="2591807">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2591811">+</span>&nbsp;<span class="ident" id="2591813">itoa</span><span class="op" id="2591817">(</span><span class="ident" id="2591818">im</span><span class="op" id="2591820">.</span><span class="ident" id="2591821">Size</span><span class="op" id="2591825">)</span>&nbsp;<span class="op" id="2591827">+</span>&nbsp;<span class="string" id="2591829">&#34;\n&#34;</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2591835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2591839">bytes</span><span class="op" id="2591844">,</span>&nbsp;<span class="ident" id="2591846">err</span>&nbsp;<span class="op" id="2591850">:=</span>&nbsp;<span class="ident" id="2591853">ByteSliceFromString</span><span class="op" id="2591872">(</span><span class="ident" id="2591873">data</span><span class="op" id="2591877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591880">if</span>&nbsp;<span class="ident" id="2591883">err</span>&nbsp;<span class="op" id="2591887">!=</span>&nbsp;<span class="ident" id="2591890">nil</span>&nbsp;<span class="op" id="2591894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2591898">Close</span><span class="op" id="2591903">(</span><span class="ident" id="2591904">fd</span><span class="op" id="2591906">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591910">return</span>&nbsp;<span class="ident" id="2591917">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2591922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591926">if</span>&nbsp;<span class="ident" id="2591929">_</span><span class="op" id="2591930">,</span>&nbsp;<span class="ident" id="2591932">err</span>&nbsp;<span class="op" id="2591936">:=</span>&nbsp;<span class="ident" id="2591939">Write</span><span class="op" id="2591944">(</span><span class="ident" id="2591945">fd</span><span class="op" id="2591947">,</span>&nbsp;<span class="ident" id="2591949">bytes</span><span class="op" id="2591954">)</span><span class="op" id="2591955">;</span>&nbsp;<span class="ident" id="2591957">err</span>&nbsp;<span class="op" id="2591961">!=</span>&nbsp;<span class="ident" id="2591964">nil</span>&nbsp;<span class="op" id="2591968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2591972">Close</span><span class="op" id="2591977">(</span><span class="ident" id="2591978">fd</span><span class="op" id="2591980">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2591984">return</span>&nbsp;<span class="ident" id="2591991">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2591996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2592000">if</span>&nbsp;<span class="ident" id="2592003">err</span>&nbsp;<span class="op" id="2592007">:=</span>&nbsp;<span class="ident" id="2592010">Close</span><span class="op" id="2592015">(</span><span class="ident" id="2592016">fd</span><span class="op" id="2592018">)</span><span class="op" id="2592019">;</span>&nbsp;<span class="ident" id="2592021">err</span>&nbsp;<span class="op" id="2592025">!=</span>&nbsp;<span class="ident" id="2592028">nil</span>&nbsp;<span class="op" id="2592032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2592036">return</span>&nbsp;<span class="ident" id="2592043">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2592048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2592052">return</span>&nbsp;<span class="ident" id="2592059">nil</span><br>
<span class="lineno"></span><span class="op" id="2592063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment" id="2592066">//&nbsp;writeUidGidMappings&nbsp;writes&nbsp;User&nbsp;ID&nbsp;and&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces</span><br>
<span class="lineno"></span><span class="comment" id="2592146">//&nbsp;for&nbsp;a&nbsp;process&nbsp;and&nbsp;it&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;parent&nbsp;process.</span><br>
<span class="lineno"></span><span class="keyword" id="2592205">func</span>&nbsp;<span class="ident" id="2592210">writeUidGidMappings</span><span class="op" id="2592229">(</span><span class="ident" id="2592230">pid</span>&nbsp;<span class="builtintype" id="2592234">int</span><span class="op" id="2592237">,</span>&nbsp;<span class="ident" id="2592239">sys</span>&nbsp;<span class="op" id="2592243">*</span><span class="ident" id="2592244">SysProcAttr</span><span class="op" id="2592255">)</span>&nbsp;<span class="builtintype" id="2592257">error</span>&nbsp;<span class="op" id="2592263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2592266">if</span>&nbsp;<span class="ident" id="2592269">sys</span><span class="op" id="2592272">.</span><span class="ident" id="2592273">UidMappings</span>&nbsp;<span class="op" id="2592285">!=</span>&nbsp;<span class="ident" id="2592288">nil</span>&nbsp;<span class="op" id="2592292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2592296">uidf</span>&nbsp;<span class="op" id="2592301">:=</span>&nbsp;<span class="string" id="2592304">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2592313">+</span>&nbsp;<span class="ident" id="2592315">itoa</span><span class="op" id="2592319">(</span><span class="ident" id="2592320">pid</span><span class="op" id="2592323">)</span>&nbsp;<span class="op" id="2592325">+</span>&nbsp;<span class="string" id="2592327">&#34;/uid_map&#34;</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2592340">if</span>&nbsp;<span class="ident" id="2592343">err</span>&nbsp;<span class="op" id="2592347">:=</span>&nbsp;<span class="ident" id="2592350">writeIDMappings</span><span class="op" id="2592365">(</span><span class="ident" id="2592366">uidf</span><span class="op" id="2592370">,</span>&nbsp;<span class="ident" id="2592372">sys</span><span class="op" id="2592375">.</span><span class="ident" id="2592376">UidMappings</span><span class="op" id="2592387">)</span><span class="op" id="2592388">;</span>&nbsp;<span class="ident" id="2592390">err</span>&nbsp;<span class="op" id="2592394">!=</span>&nbsp;<span class="ident" id="2592397">nil</span>&nbsp;<span class="op" id="2592401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2592406">return</span>&nbsp;<span class="ident" id="2592413">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2592419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2592422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2592426">if</span>&nbsp;<span class="ident" id="2592429">sys</span><span class="op" id="2592432">.</span><span class="ident" id="2592433">GidMappings</span>&nbsp;<span class="op" id="2592445">!=</span>&nbsp;<span class="ident" id="2592448">nil</span>&nbsp;<span class="op" id="2592452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2592456">gidf</span>&nbsp;<span class="op" id="2592461">:=</span>&nbsp;<span class="string" id="2592464">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2592473">+</span>&nbsp;<span class="ident" id="2592475">itoa</span><span class="op" id="2592479">(</span><span class="ident" id="2592480">pid</span><span class="op" id="2592483">)</span>&nbsp;<span class="op" id="2592485">+</span>&nbsp;<span class="string" id="2592487">&#34;/gid_map&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2592500">if</span>&nbsp;<span class="ident" id="2592503">err</span>&nbsp;<span class="op" id="2592507">:=</span>&nbsp;<span class="ident" id="2592510">writeIDMappings</span><span class="op" id="2592525">(</span><span class="ident" id="2592526">gidf</span><span class="op" id="2592530">,</span>&nbsp;<span class="ident" id="2592532">sys</span><span class="op" id="2592535">.</span><span class="ident" id="2592536">GidMappings</span><span class="op" id="2592547">)</span><span class="op" id="2592548">;</span>&nbsp;<span class="ident" id="2592550">err</span>&nbsp;<span class="op" id="2592554">!=</span>&nbsp;<span class="ident" id="2592557">nil</span>&nbsp;<span class="op" id="2592561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2592566">return</span>&nbsp;<span class="ident" id="2592573">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2592579">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2592582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2592586">return</span>&nbsp;<span class="ident" id="2592593">nil</span><br>
<span class="lineno"></span><span class="op" id="2592597">}</span>
</div>
</body>
</html>
