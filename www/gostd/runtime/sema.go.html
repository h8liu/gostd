<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html" class="current">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1660969">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1661024">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1661078">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1661129">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1661172">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1661218">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="1661270">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="1661310">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="1661361">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1661399">//</span><br>
<span class="lineno"></span><span class="comment" id="1661402">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="1661450">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1661506">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="1661563">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="1661626">//</span><br>
<span class="lineno"></span><span class="comment" id="1661629">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="1661681">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1661716">package</span>&nbsp;<span class="ident" id="1661724">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1661733">import</span>&nbsp;<span class="string" id="1661740">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1661750">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1661793">type</span>&nbsp;<span class="ident" id="1661798">semaRoot</span>&nbsp;<span class="keyword" id="1661807">struct</span>&nbsp;<span class="op" id="1661814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661817">lock</span>&nbsp;&nbsp;<span class="ident" id="1661823">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661830">head</span>&nbsp;&nbsp;<span class="op" id="1661836">*</span><span class="ident" id="1661837">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661844">tail</span>&nbsp;&nbsp;<span class="op" id="1661850">*</span><span class="ident" id="1661851">sudog</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1661858">nwait</span>&nbsp;<span class="builtintype" id="1661864">uint32</span>&nbsp;<span class="comment" id="1661871">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="1661912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1661915">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="1661965">const</span>&nbsp;<span class="ident" id="1661971">semTabSize</span>&nbsp;<span class="op" id="1661982">=</span>&nbsp;<span class="num" id="1661984">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1661989">var</span>&nbsp;<span class="ident" id="1661993">semtable</span>&nbsp;<span class="op" id="1662002">[</span><span class="ident" id="1662003">semTabSize</span><span class="op" id="1662013">]</span><span class="keyword" id="1662014">struct</span>&nbsp;<span class="op" id="1662021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662024">root</span>&nbsp;<span class="ident" id="1662029">semaRoot</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662039">pad</span>&nbsp;&nbsp;<span class="op" id="1662044">[</span><span class="ident" id="1662045">_CacheLineSize</span>&nbsp;<span class="op" id="1662060">-</span>&nbsp;<span class="ident" id="1662062">unsafe</span><span class="op" id="1662068">.</span><span class="ident" id="1662069">Sizeof</span><span class="op" id="1662075">(</span><span class="ident" id="1662076">semaRoot</span><span class="op" id="1662084">{</span><span class="op" id="1662085">}</span><span class="op" id="1662086">)</span><span class="op" id="1662087">]</span><span class="builtintype" id="1662088">byte</span><br>
<span class="lineno"></span><span class="op" id="1662093">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1662096">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="1662130">func</span>&nbsp;<span class="ident" id="1662135">asyncsemacquire</span><span class="op" id="1662150">(</span><span class="ident" id="1662151">addr</span>&nbsp;<span class="op" id="1662156">*</span><span class="builtintype" id="1662157">uint32</span><span class="op" id="1662163">)</span>&nbsp;<span class="op" id="1662165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662168">semacquire</span><span class="op" id="1662178">(</span><span class="ident" id="1662179">addr</span><span class="op" id="1662183">,</span>&nbsp;<span class="builtintype" id="1662185">true</span><span class="op" id="1662189">)</span><br>
<span class="lineno"></span><span class="op" id="1662191">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="1662194">func</span>&nbsp;<span class="ident" id="1662199">asyncsemrelease</span><span class="op" id="1662214">(</span><span class="ident" id="1662215">addr</span>&nbsp;<span class="op" id="1662220">*</span><span class="builtintype" id="1662221">uint32</span><span class="op" id="1662227">)</span>&nbsp;<span class="op" id="1662229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662232">semrelease</span><span class="op" id="1662242">(</span><span class="ident" id="1662243">addr</span><span class="op" id="1662247">)</span><br>
<span class="lineno"></span><span class="op" id="1662249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1662252">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1662276">func</span>&nbsp;<span class="ident" id="1662281">semacquire</span><span class="op" id="1662291">(</span><span class="ident" id="1662292">addr</span>&nbsp;<span class="op" id="1662297">*</span><span class="builtintype" id="1662298">uint32</span><span class="op" id="1662304">,</span>&nbsp;<span class="ident" id="1662306">profile</span>&nbsp;<span class="builtintype" id="1662314">bool</span><span class="op" id="1662318">)</span>&nbsp;<span class="op" id="1662320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662323">gp</span>&nbsp;<span class="op" id="1662326">:=</span>&nbsp;<span class="ident" id="1662329">getg</span><span class="op" id="1662333">(</span><span class="op" id="1662334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662337">if</span>&nbsp;<span class="ident" id="1662340">gp</span>&nbsp;<span class="op" id="1662343">!=</span>&nbsp;<span class="ident" id="1662346">gp</span><span class="op" id="1662348">.</span><span class="ident" id="1662349">m</span><span class="op" id="1662350">.</span><span class="ident" id="1662351">curg</span>&nbsp;<span class="op" id="1662356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662360">gothrow</span><span class="op" id="1662367">(</span><span class="string" id="1662368">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="1662399">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1662406">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662421">if</span>&nbsp;<span class="ident" id="1662424">cansemacquire</span><span class="op" id="1662437">(</span><span class="ident" id="1662438">addr</span><span class="op" id="1662442">)</span>&nbsp;<span class="op" id="1662444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662448">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1662460">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1662477">//&nbsp;&nbsp;&nbsp;&nbsp;increment&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1662504">//&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1662561">//&nbsp;&nbsp;&nbsp;&nbsp;enqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1662592">//&nbsp;&nbsp;&nbsp;&nbsp;sleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1662602">//&nbsp;&nbsp;&nbsp;&nbsp;(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662650">s</span>&nbsp;<span class="op" id="1662652">:=</span>&nbsp;<span class="ident" id="1662655">acquireSudog</span><span class="op" id="1662667">(</span><span class="op" id="1662668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662671">root</span>&nbsp;<span class="op" id="1662676">:=</span>&nbsp;<span class="ident" id="1662679">semroot</span><span class="op" id="1662686">(</span><span class="ident" id="1662687">addr</span><span class="op" id="1662691">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662694">t0</span>&nbsp;<span class="op" id="1662697">:=</span>&nbsp;<span class="ident" id="1662700">int64</span><span class="op" id="1662705">(</span><span class="num" id="1662706">0</span><span class="op" id="1662707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662710">s</span><span class="op" id="1662711">.</span><span class="ident" id="1662712">releasetime</span>&nbsp;<span class="op" id="1662724">=</span>&nbsp;<span class="num" id="1662726">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662729">if</span>&nbsp;<span class="ident" id="1662732">profile</span>&nbsp;<span class="op" id="1662740">&amp;&amp;</span>&nbsp;<span class="ident" id="1662743">blockprofilerate</span>&nbsp;<span class="op" id="1662760">&gt;</span>&nbsp;<span class="num" id="1662762">0</span>&nbsp;<span class="op" id="1662764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662768">t0</span>&nbsp;<span class="op" id="1662771">=</span>&nbsp;<span class="ident" id="1662773">cputicks</span><span class="op" id="1662781">(</span><span class="op" id="1662782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662786">s</span><span class="op" id="1662787">.</span><span class="ident" id="1662788">releasetime</span>&nbsp;<span class="op" id="1662800">=</span>&nbsp;<span class="op" id="1662802">-</span><span class="num" id="1662803">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1662806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662809">for</span>&nbsp;<span class="op" id="1662813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662817">lock</span><span class="op" id="1662821">(</span><span class="op" id="1662822">&amp;</span><span class="ident" id="1662823">root</span><span class="op" id="1662827">.</span><span class="ident" id="1662828">lock</span><span class="op" id="1662832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1662836">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1662902">xadd</span><span class="op" id="1662906">(</span><span class="op" id="1662907">&amp;</span><span class="ident" id="1662908">root</span><span class="op" id="1662912">.</span><span class="ident" id="1662913">nwait</span><span class="op" id="1662918">,</span>&nbsp;<span class="num" id="1662920">1</span><span class="op" id="1662921">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1662925">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1662974">if</span>&nbsp;<span class="ident" id="1662977">cansemacquire</span><span class="op" id="1662990">(</span><span class="ident" id="1662991">addr</span><span class="op" id="1662995">)</span>&nbsp;<span class="op" id="1662997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663002">xadd</span><span class="op" id="1663006">(</span><span class="op" id="1663007">&amp;</span><span class="ident" id="1663008">root</span><span class="op" id="1663012">.</span><span class="ident" id="1663013">nwait</span><span class="op" id="1663018">,</span>&nbsp;<span class="op" id="1663020">-</span><span class="num" id="1663021">1</span><span class="op" id="1663022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663027">unlock</span><span class="op" id="1663033">(</span><span class="op" id="1663034">&amp;</span><span class="ident" id="1663035">root</span><span class="op" id="1663039">.</span><span class="ident" id="1663040">lock</span><span class="op" id="1663044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663049">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1663061">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1663125">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663168">root</span><span class="op" id="1663172">.</span><span class="ident" id="1663173">queue</span><span class="op" id="1663178">(</span><span class="ident" id="1663179">addr</span><span class="op" id="1663183">,</span>&nbsp;<span class="ident" id="1663185">s</span><span class="op" id="1663186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663190">goparkunlock</span><span class="op" id="1663202">(</span><span class="op" id="1663203">&amp;</span><span class="ident" id="1663204">root</span><span class="op" id="1663208">.</span><span class="ident" id="1663209">lock</span><span class="op" id="1663213">,</span>&nbsp;<span class="string" id="1663215">&#34;semacquire&#34;</span><span class="op" id="1663227">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663231">if</span>&nbsp;<span class="ident" id="1663234">cansemacquire</span><span class="op" id="1663247">(</span><span class="ident" id="1663248">addr</span><span class="op" id="1663252">)</span>&nbsp;<span class="op" id="1663254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663259">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663273">if</span>&nbsp;<span class="ident" id="1663276">s</span><span class="op" id="1663277">.</span><span class="ident" id="1663278">releasetime</span>&nbsp;<span class="op" id="1663290">&gt;</span>&nbsp;<span class="num" id="1663292">0</span>&nbsp;<span class="op" id="1663294">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663298">blockevent</span><span class="op" id="1663308">(</span><span class="ident" id="1663309">int64</span><span class="op" id="1663314">(</span><span class="ident" id="1663315">s</span><span class="op" id="1663316">.</span><span class="ident" id="1663317">releasetime</span><span class="op" id="1663328">)</span><span class="op" id="1663329">-</span><span class="ident" id="1663330">t0</span><span class="op" id="1663332">,</span>&nbsp;<span class="num" id="1663334">3</span><span class="op" id="1663335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663341">releaseSudog</span><span class="op" id="1663353">(</span><span class="ident" id="1663354">s</span><span class="op" id="1663355">)</span><br>
<span class="lineno"></span><span class="op" id="1663357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1663360">func</span>&nbsp;<span class="ident" id="1663365">semrelease</span><span class="op" id="1663375">(</span><span class="ident" id="1663376">addr</span>&nbsp;<span class="op" id="1663381">*</span><span class="builtintype" id="1663382">uint32</span><span class="op" id="1663388">)</span>&nbsp;<span class="op" id="1663390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663393">root</span>&nbsp;<span class="op" id="1663398">:=</span>&nbsp;<span class="ident" id="1663401">semroot</span><span class="op" id="1663408">(</span><span class="ident" id="1663409">addr</span><span class="op" id="1663413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663416">xadd</span><span class="op" id="1663420">(</span><span class="ident" id="1663421">addr</span><span class="op" id="1663425">,</span>&nbsp;<span class="num" id="1663427">1</span><span class="op" id="1663428">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1663432">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1663459">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1663527">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663557">if</span>&nbsp;<span class="ident" id="1663560">atomicload</span><span class="op" id="1663570">(</span><span class="op" id="1663571">&amp;</span><span class="ident" id="1663572">root</span><span class="op" id="1663576">.</span><span class="ident" id="1663577">nwait</span><span class="op" id="1663582">)</span>&nbsp;<span class="op" id="1663584">==</span>&nbsp;<span class="num" id="1663587">0</span>&nbsp;<span class="op" id="1663589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663593">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663601">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1663605">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663655">lock</span><span class="op" id="1663659">(</span><span class="op" id="1663660">&amp;</span><span class="ident" id="1663661">root</span><span class="op" id="1663665">.</span><span class="ident" id="1663666">lock</span><span class="op" id="1663670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663673">if</span>&nbsp;<span class="ident" id="1663676">atomicload</span><span class="op" id="1663686">(</span><span class="op" id="1663687">&amp;</span><span class="ident" id="1663688">root</span><span class="op" id="1663692">.</span><span class="ident" id="1663693">nwait</span><span class="op" id="1663698">)</span>&nbsp;<span class="op" id="1663700">==</span>&nbsp;<span class="num" id="1663703">0</span>&nbsp;<span class="op" id="1663705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1663709">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1663766">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663812">unlock</span><span class="op" id="1663818">(</span><span class="op" id="1663819">&amp;</span><span class="ident" id="1663820">root</span><span class="op" id="1663824">.</span><span class="ident" id="1663825">lock</span><span class="op" id="1663829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663833">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663844">s</span>&nbsp;<span class="op" id="1663846">:=</span>&nbsp;<span class="ident" id="1663849">root</span><span class="op" id="1663853">.</span><span class="ident" id="1663854">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663860">for</span>&nbsp;<span class="op" id="1663864">;</span>&nbsp;<span class="ident" id="1663866">s</span>&nbsp;<span class="op" id="1663868">!=</span>&nbsp;<span class="builtintype" id="1663871">nil</span><span class="op" id="1663874">;</span>&nbsp;<span class="ident" id="1663876">s</span>&nbsp;<span class="op" id="1663878">=</span>&nbsp;<span class="ident" id="1663880">s</span><span class="op" id="1663881">.</span><span class="ident" id="1663882">next</span>&nbsp;<span class="op" id="1663887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663891">if</span>&nbsp;<span class="ident" id="1663894">s</span><span class="op" id="1663895">.</span><span class="ident" id="1663896">elem</span>&nbsp;<span class="op" id="1663901">==</span>&nbsp;<span class="ident" id="1663904">unsafe</span><span class="op" id="1663910">.</span><span class="ident" id="1663911">Pointer</span><span class="op" id="1663918">(</span><span class="ident" id="1663919">addr</span><span class="op" id="1663923">)</span>&nbsp;<span class="op" id="1663925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663930">xadd</span><span class="op" id="1663934">(</span><span class="op" id="1663935">&amp;</span><span class="ident" id="1663936">root</span><span class="op" id="1663940">.</span><span class="ident" id="1663941">nwait</span><span class="op" id="1663946">,</span>&nbsp;<span class="op" id="1663948">-</span><span class="num" id="1663949">1</span><span class="op" id="1663950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663955">root</span><span class="op" id="1663959">.</span><span class="ident" id="1663960">dequeue</span><span class="op" id="1663967">(</span><span class="ident" id="1663968">s</span><span class="op" id="1663969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1663974">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1663985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1663988">unlock</span><span class="op" id="1663994">(</span><span class="op" id="1663995">&amp;</span><span class="ident" id="1663996">root</span><span class="op" id="1664000">.</span><span class="ident" id="1664001">lock</span><span class="op" id="1664005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664008">if</span>&nbsp;<span class="ident" id="1664011">s</span>&nbsp;<span class="op" id="1664013">!=</span>&nbsp;<span class="builtintype" id="1664016">nil</span>&nbsp;<span class="op" id="1664020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664024">if</span>&nbsp;<span class="ident" id="1664027">s</span><span class="op" id="1664028">.</span><span class="ident" id="1664029">releasetime</span>&nbsp;<span class="op" id="1664041">!=</span>&nbsp;<span class="num" id="1664044">0</span>&nbsp;<span class="op" id="1664046">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664051">s</span><span class="op" id="1664052">.</span><span class="ident" id="1664053">releasetime</span>&nbsp;<span class="op" id="1664065">=</span>&nbsp;<span class="ident" id="1664067">cputicks</span><span class="op" id="1664075">(</span><span class="op" id="1664076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664084">goready</span><span class="op" id="1664091">(</span><span class="ident" id="1664092">s</span><span class="op" id="1664093">.</span><span class="ident" id="1664094">g</span><span class="op" id="1664095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664098">}</span><br>
<span class="lineno"></span><span class="op" id="1664100">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1664103">func</span>&nbsp;<span class="ident" id="1664108">semroot</span><span class="op" id="1664115">(</span><span class="ident" id="1664116">addr</span>&nbsp;<span class="op" id="1664121">*</span><span class="builtintype" id="1664122">uint32</span><span class="op" id="1664128">)</span>&nbsp;<span class="op" id="1664130">*</span><span class="ident" id="1664131">semaRoot</span>&nbsp;<span class="op" id="1664140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664143">return</span>&nbsp;<span class="op" id="1664150">&amp;</span><span class="ident" id="1664151">semtable</span><span class="op" id="1664159">[</span><span class="op" id="1664160">(</span><span class="builtintype" id="1664161">uintptr</span><span class="op" id="1664168">(</span><span class="ident" id="1664169">unsafe</span><span class="op" id="1664175">.</span><span class="ident" id="1664176">Pointer</span><span class="op" id="1664183">(</span><span class="ident" id="1664184">addr</span><span class="op" id="1664188">)</span><span class="op" id="1664189">)</span><span class="op" id="1664190">&gt;&gt;</span><span class="num" id="1664192">3</span><span class="op" id="1664193">)</span><span class="op" id="1664194">%</span><span class="ident" id="1664195">semTabSize</span><span class="op" id="1664205">]</span><span class="op" id="1664206">.</span><span class="ident" id="1664207">root</span><br>
<span class="lineno"></span><span class="op" id="1664212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1664215">func</span>&nbsp;<span class="ident" id="1664220">cansemacquire</span><span class="op" id="1664233">(</span><span class="ident" id="1664234">addr</span>&nbsp;<span class="op" id="1664239">*</span><span class="builtintype" id="1664240">uint32</span><span class="op" id="1664246">)</span>&nbsp;<span class="builtintype" id="1664248">bool</span>&nbsp;<span class="op" id="1664253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664256">for</span>&nbsp;<span class="op" id="1664260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664264">v</span>&nbsp;<span class="op" id="1664266">:=</span>&nbsp;<span class="ident" id="1664269">atomicload</span><span class="op" id="1664279">(</span><span class="ident" id="1664280">addr</span><span class="op" id="1664284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664288">if</span>&nbsp;<span class="ident" id="1664291">v</span>&nbsp;<span class="op" id="1664293">==</span>&nbsp;<span class="num" id="1664296">0</span>&nbsp;<span class="op" id="1664298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664303">return</span>&nbsp;<span class="builtintype" id="1664310">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664322">if</span>&nbsp;<span class="ident" id="1664325">cas</span><span class="op" id="1664328">(</span><span class="ident" id="1664329">addr</span><span class="op" id="1664333">,</span>&nbsp;<span class="ident" id="1664335">v</span><span class="op" id="1664336">,</span>&nbsp;<span class="ident" id="1664338">v</span><span class="op" id="1664339">-</span><span class="num" id="1664340">1</span><span class="op" id="1664341">)</span>&nbsp;<span class="op" id="1664343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664348">return</span>&nbsp;<span class="builtintype" id="1664355">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664365">}</span><br>
<span class="lineno">150</span><span class="op" id="1664367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1664370">func</span>&nbsp;<span class="op" id="1664375">(</span><span class="ident" id="1664376">root</span>&nbsp;<span class="op" id="1664381">*</span><span class="ident" id="1664382">semaRoot</span><span class="op" id="1664390">)</span>&nbsp;<span class="ident" id="1664392">queue</span><span class="op" id="1664397">(</span><span class="ident" id="1664398">addr</span>&nbsp;<span class="op" id="1664403">*</span><span class="builtintype" id="1664404">uint32</span><span class="op" id="1664410">,</span>&nbsp;<span class="ident" id="1664412">s</span>&nbsp;<span class="op" id="1664414">*</span><span class="ident" id="1664415">sudog</span><span class="op" id="1664420">)</span>&nbsp;<span class="op" id="1664422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664425">s</span><span class="op" id="1664426">.</span><span class="ident" id="1664427">g</span>&nbsp;<span class="op" id="1664429">=</span>&nbsp;<span class="ident" id="1664431">getg</span><span class="op" id="1664435">(</span><span class="op" id="1664436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664439">s</span><span class="op" id="1664440">.</span><span class="ident" id="1664441">elem</span>&nbsp;<span class="op" id="1664446">=</span>&nbsp;<span class="ident" id="1664448">unsafe</span><span class="op" id="1664454">.</span><span class="ident" id="1664455">Pointer</span><span class="op" id="1664462">(</span><span class="ident" id="1664463">addr</span><span class="op" id="1664467">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664470">s</span><span class="op" id="1664471">.</span><span class="ident" id="1664472">next</span>&nbsp;<span class="op" id="1664477">=</span>&nbsp;<span class="builtintype" id="1664479">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664484">s</span><span class="op" id="1664485">.</span><span class="ident" id="1664486">prev</span>&nbsp;<span class="op" id="1664491">=</span>&nbsp;<span class="ident" id="1664493">root</span><span class="op" id="1664497">.</span><span class="ident" id="1664498">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664504">if</span>&nbsp;<span class="ident" id="1664507">root</span><span class="op" id="1664511">.</span><span class="ident" id="1664512">tail</span>&nbsp;<span class="op" id="1664517">!=</span>&nbsp;<span class="builtintype" id="1664520">nil</span>&nbsp;<span class="op" id="1664524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664528">root</span><span class="op" id="1664532">.</span><span class="ident" id="1664533">tail</span><span class="op" id="1664537">.</span><span class="ident" id="1664538">next</span>&nbsp;<span class="op" id="1664543">=</span>&nbsp;<span class="ident" id="1664545">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664548">}</span>&nbsp;<span class="keyword" id="1664550">else</span>&nbsp;<span class="op" id="1664555">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664559">root</span><span class="op" id="1664563">.</span><span class="ident" id="1664564">head</span>&nbsp;<span class="op" id="1664569">=</span>&nbsp;<span class="ident" id="1664571">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664577">root</span><span class="op" id="1664581">.</span><span class="ident" id="1664582">tail</span>&nbsp;<span class="op" id="1664587">=</span>&nbsp;<span class="ident" id="1664589">s</span><br>
<span class="lineno"></span><span class="op" id="1664591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="1664594">func</span>&nbsp;<span class="op" id="1664599">(</span><span class="ident" id="1664600">root</span>&nbsp;<span class="op" id="1664605">*</span><span class="ident" id="1664606">semaRoot</span><span class="op" id="1664614">)</span>&nbsp;<span class="ident" id="1664616">dequeue</span><span class="op" id="1664623">(</span><span class="ident" id="1664624">s</span>&nbsp;<span class="op" id="1664626">*</span><span class="ident" id="1664627">sudog</span><span class="op" id="1664632">)</span>&nbsp;<span class="op" id="1664634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664637">if</span>&nbsp;<span class="ident" id="1664640">s</span><span class="op" id="1664641">.</span><span class="ident" id="1664642">next</span>&nbsp;<span class="op" id="1664647">!=</span>&nbsp;<span class="builtintype" id="1664650">nil</span>&nbsp;<span class="op" id="1664654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664658">s</span><span class="op" id="1664659">.</span><span class="ident" id="1664660">next</span><span class="op" id="1664664">.</span><span class="ident" id="1664665">prev</span>&nbsp;<span class="op" id="1664670">=</span>&nbsp;<span class="ident" id="1664672">s</span><span class="op" id="1664673">.</span><span class="ident" id="1664674">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664680">}</span>&nbsp;<span class="keyword" id="1664682">else</span>&nbsp;<span class="op" id="1664687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664691">root</span><span class="op" id="1664695">.</span><span class="ident" id="1664696">tail</span>&nbsp;<span class="op" id="1664701">=</span>&nbsp;<span class="ident" id="1664703">s</span><span class="op" id="1664704">.</span><span class="ident" id="1664705">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1664714">if</span>&nbsp;<span class="ident" id="1664717">s</span><span class="op" id="1664718">.</span><span class="ident" id="1664719">prev</span>&nbsp;<span class="op" id="1664724">!=</span>&nbsp;<span class="builtintype" id="1664727">nil</span>&nbsp;<span class="op" id="1664731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664735">s</span><span class="op" id="1664736">.</span><span class="ident" id="1664737">prev</span><span class="op" id="1664741">.</span><span class="ident" id="1664742">next</span>&nbsp;<span class="op" id="1664747">=</span>&nbsp;<span class="ident" id="1664749">s</span><span class="op" id="1664750">.</span><span class="ident" id="1664751">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664757">}</span>&nbsp;<span class="keyword" id="1664759">else</span>&nbsp;<span class="op" id="1664764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664768">root</span><span class="op" id="1664772">.</span><span class="ident" id="1664773">head</span>&nbsp;<span class="op" id="1664778">=</span>&nbsp;<span class="ident" id="1664780">s</span><span class="op" id="1664781">.</span><span class="ident" id="1664782">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1664788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664791">s</span><span class="op" id="1664792">.</span><span class="ident" id="1664793">elem</span>&nbsp;<span class="op" id="1664798">=</span>&nbsp;<span class="builtintype" id="1664800">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664805">s</span><span class="op" id="1664806">.</span><span class="ident" id="1664807">next</span>&nbsp;<span class="op" id="1664812">=</span>&nbsp;<span class="builtintype" id="1664814">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664819">s</span><span class="op" id="1664820">.</span><span class="ident" id="1664821">prev</span>&nbsp;<span class="op" id="1664826">=</span>&nbsp;<span class="builtintype" id="1664828">nil</span><br>
<span class="lineno"></span><span class="op" id="1664832">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="1664835">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="1664875">type</span>&nbsp;<span class="ident" id="1664880">syncSema</span>&nbsp;<span class="keyword" id="1664889">struct</span>&nbsp;<span class="op" id="1664896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664899">lock</span>&nbsp;<span class="ident" id="1664904">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664911">head</span>&nbsp;<span class="op" id="1664916">*</span><span class="ident" id="1664917">sudog</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1664924">tail</span>&nbsp;<span class="op" id="1664929">*</span><span class="ident" id="1664930">sudog</span><br>
<span class="lineno"></span><span class="op" id="1664936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1664939">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1665017">func</span>&nbsp;<span class="ident" id="1665022">syncsemacquire</span><span class="op" id="1665036">(</span><span class="ident" id="1665037">s</span>&nbsp;<span class="op" id="1665039">*</span><span class="ident" id="1665040">syncSema</span><span class="op" id="1665048">)</span>&nbsp;<span class="op" id="1665050">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665053">lock</span><span class="op" id="1665057">(</span><span class="op" id="1665058">&amp;</span><span class="ident" id="1665059">s</span><span class="op" id="1665060">.</span><span class="ident" id="1665061">lock</span><span class="op" id="1665065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1665068">if</span>&nbsp;<span class="ident" id="1665071">s</span><span class="op" id="1665072">.</span><span class="ident" id="1665073">head</span>&nbsp;<span class="op" id="1665078">!=</span>&nbsp;<span class="builtintype" id="1665081">nil</span>&nbsp;<span class="op" id="1665085">&amp;&amp;</span>&nbsp;<span class="ident" id="1665088">s</span><span class="op" id="1665089">.</span><span class="ident" id="1665090">head</span><span class="op" id="1665094">.</span><span class="ident" id="1665095">nrelease</span>&nbsp;<span class="op" id="1665104">&gt;</span>&nbsp;<span class="num" id="1665106">0</span>&nbsp;<span class="op" id="1665108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1665112">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1665151">var</span>&nbsp;<span class="ident" id="1665155">wake</span>&nbsp;<span class="op" id="1665160">*</span><span class="ident" id="1665161">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665169">s</span><span class="op" id="1665170">.</span><span class="ident" id="1665171">head</span><span class="op" id="1665175">.</span><span class="ident" id="1665176">nrelease</span><span class="op" id="1665184">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1665189">if</span>&nbsp;<span class="ident" id="1665192">s</span><span class="op" id="1665193">.</span><span class="ident" id="1665194">head</span><span class="op" id="1665198">.</span><span class="ident" id="1665199">nrelease</span>&nbsp;<span class="op" id="1665208">==</span>&nbsp;<span class="num" id="1665211">0</span>&nbsp;<span class="op" id="1665213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665218">wake</span>&nbsp;<span class="op" id="1665223">=</span>&nbsp;<span class="ident" id="1665225">s</span><span class="op" id="1665226">.</span><span class="ident" id="1665227">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665235">s</span><span class="op" id="1665236">.</span><span class="ident" id="1665237">head</span>&nbsp;<span class="op" id="1665242">=</span>&nbsp;<span class="ident" id="1665244">wake</span><span class="op" id="1665248">.</span><span class="ident" id="1665249">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1665257">if</span>&nbsp;<span class="ident" id="1665260">s</span><span class="op" id="1665261">.</span><span class="ident" id="1665262">head</span>&nbsp;<span class="op" id="1665267">==</span>&nbsp;<span class="builtintype" id="1665270">nil</span>&nbsp;<span class="op" id="1665274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665280">s</span><span class="op" id="1665281">.</span><span class="ident" id="1665282">tail</span>&nbsp;<span class="op" id="1665287">=</span>&nbsp;<span class="builtintype" id="1665289">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1665296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1665300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665304">unlock</span><span class="op" id="1665310">(</span><span class="op" id="1665311">&amp;</span><span class="ident" id="1665312">s</span><span class="op" id="1665313">.</span><span class="ident" id="1665314">lock</span><span class="op" id="1665318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1665322">if</span>&nbsp;<span class="ident" id="1665325">wake</span>&nbsp;<span class="op" id="1665330">!=</span>&nbsp;<span class="builtintype" id="1665333">nil</span>&nbsp;<span class="op" id="1665337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665342">wake</span><span class="op" id="1665346">.</span><span class="ident" id="1665347">next</span>&nbsp;<span class="op" id="1665352">=</span>&nbsp;<span class="builtintype" id="1665354">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665361">goready</span><span class="op" id="1665368">(</span><span class="ident" id="1665369">wake</span><span class="op" id="1665373">.</span><span class="ident" id="1665374">g</span><span class="op" id="1665375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1665379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1665382">}</span>&nbsp;<span class="keyword" id="1665384">else</span>&nbsp;<span class="op" id="1665389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1665393">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665414">w</span>&nbsp;<span class="op" id="1665416">:=</span>&nbsp;<span class="ident" id="1665419">acquireSudog</span><span class="op" id="1665431">(</span><span class="op" id="1665432">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665436">w</span><span class="op" id="1665437">.</span><span class="ident" id="1665438">g</span>&nbsp;<span class="op" id="1665440">=</span>&nbsp;<span class="ident" id="1665442">getg</span><span class="op" id="1665446">(</span><span class="op" id="1665447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665451">w</span><span class="op" id="1665452">.</span><span class="ident" id="1665453">nrelease</span>&nbsp;<span class="op" id="1665462">=</span>&nbsp;<span class="op" id="1665464">-</span><span class="num" id="1665465">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665469">w</span><span class="op" id="1665470">.</span><span class="ident" id="1665471">next</span>&nbsp;<span class="op" id="1665476">=</span>&nbsp;<span class="builtintype" id="1665478">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665484">w</span><span class="op" id="1665485">.</span><span class="ident" id="1665486">releasetime</span>&nbsp;<span class="op" id="1665498">=</span>&nbsp;<span class="num" id="1665500">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665504">t0</span>&nbsp;<span class="op" id="1665507">:=</span>&nbsp;<span class="ident" id="1665510">int64</span><span class="op" id="1665515">(</span><span class="num" id="1665516">0</span><span class="op" id="1665517">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1665521">if</span>&nbsp;<span class="ident" id="1665524">blockprofilerate</span>&nbsp;<span class="op" id="1665541">&gt;</span>&nbsp;<span class="num" id="1665543">0</span>&nbsp;<span class="op" id="1665545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665550">t0</span>&nbsp;<span class="op" id="1665553">=</span>&nbsp;<span class="ident" id="1665555">cputicks</span><span class="op" id="1665563">(</span><span class="op" id="1665564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665569">w</span><span class="op" id="1665570">.</span><span class="ident" id="1665571">releasetime</span>&nbsp;<span class="op" id="1665583">=</span>&nbsp;<span class="op" id="1665585">-</span><span class="num" id="1665586">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1665590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1665594">if</span>&nbsp;<span class="ident" id="1665597">s</span><span class="op" id="1665598">.</span><span class="ident" id="1665599">tail</span>&nbsp;<span class="op" id="1665604">==</span>&nbsp;<span class="builtintype" id="1665607">nil</span>&nbsp;<span class="op" id="1665611">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665616">s</span><span class="op" id="1665617">.</span><span class="ident" id="1665618">head</span>&nbsp;<span class="op" id="1665623">=</span>&nbsp;<span class="ident" id="1665625">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1665629">}</span>&nbsp;<span class="keyword" id="1665631">else</span>&nbsp;<span class="op" id="1665636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665641">s</span><span class="op" id="1665642">.</span><span class="ident" id="1665643">tail</span><span class="op" id="1665647">.</span><span class="ident" id="1665648">next</span>&nbsp;<span class="op" id="1665653">=</span>&nbsp;<span class="ident" id="1665655">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1665659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665663">s</span><span class="op" id="1665664">.</span><span class="ident" id="1665665">tail</span>&nbsp;<span class="op" id="1665670">=</span>&nbsp;<span class="ident" id="1665672">w</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665676">goparkunlock</span><span class="op" id="1665688">(</span><span class="op" id="1665689">&amp;</span><span class="ident" id="1665690">s</span><span class="op" id="1665691">.</span><span class="ident" id="1665692">lock</span><span class="op" id="1665696">,</span>&nbsp;<span class="string" id="1665698">&#34;semacquire&#34;</span><span class="op" id="1665710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1665714">if</span>&nbsp;<span class="ident" id="1665717">t0</span>&nbsp;<span class="op" id="1665720">!=</span>&nbsp;<span class="num" id="1665723">0</span>&nbsp;<span class="op" id="1665725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665730">blockevent</span><span class="op" id="1665740">(</span><span class="ident" id="1665741">int64</span><span class="op" id="1665746">(</span><span class="ident" id="1665747">w</span><span class="op" id="1665748">.</span><span class="ident" id="1665749">releasetime</span><span class="op" id="1665760">)</span><span class="op" id="1665761">-</span><span class="ident" id="1665762">t0</span><span class="op" id="1665764">,</span>&nbsp;<span class="num" id="1665766">2</span><span class="op" id="1665767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1665771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665775">releaseSudog</span><span class="op" id="1665787">(</span><span class="ident" id="1665788">w</span><span class="op" id="1665789">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1665792">}</span><br>
<span class="lineno"></span><span class="op" id="1665794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1665797">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1665875">func</span>&nbsp;<span class="ident" id="1665880">syncsemrelease</span><span class="op" id="1665894">(</span><span class="ident" id="1665895">s</span>&nbsp;<span class="op" id="1665897">*</span><span class="ident" id="1665898">syncSema</span><span class="op" id="1665906">,</span>&nbsp;<span class="ident" id="1665908">n</span>&nbsp;<span class="builtintype" id="1665910">uint32</span><span class="op" id="1665916">)</span>&nbsp;<span class="op" id="1665918">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1665921">lock</span><span class="op" id="1665925">(</span><span class="op" id="1665926">&amp;</span><span class="ident" id="1665927">s</span><span class="op" id="1665928">.</span><span class="ident" id="1665929">lock</span><span class="op" id="1665933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1665936">for</span>&nbsp;<span class="ident" id="1665940">n</span>&nbsp;<span class="op" id="1665942">&gt;</span>&nbsp;<span class="num" id="1665944">0</span>&nbsp;<span class="op" id="1665946">&amp;&amp;</span>&nbsp;<span class="ident" id="1665949">s</span><span class="op" id="1665950">.</span><span class="ident" id="1665951">head</span>&nbsp;<span class="op" id="1665956">!=</span>&nbsp;<span class="builtintype" id="1665959">nil</span>&nbsp;<span class="op" id="1665963">&amp;&amp;</span>&nbsp;<span class="ident" id="1665966">s</span><span class="op" id="1665967">.</span><span class="ident" id="1665968">head</span><span class="op" id="1665972">.</span><span class="ident" id="1665973">nrelease</span>&nbsp;<span class="op" id="1665982">&lt;</span>&nbsp;<span class="num" id="1665984">0</span>&nbsp;<span class="op" id="1665986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1665990">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666029">wake</span>&nbsp;<span class="op" id="1666034">:=</span>&nbsp;<span class="ident" id="1666037">s</span><span class="op" id="1666038">.</span><span class="ident" id="1666039">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666046">s</span><span class="op" id="1666047">.</span><span class="ident" id="1666048">head</span>&nbsp;<span class="op" id="1666053">=</span>&nbsp;<span class="ident" id="1666055">wake</span><span class="op" id="1666059">.</span><span class="ident" id="1666060">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666067">if</span>&nbsp;<span class="ident" id="1666070">s</span><span class="op" id="1666071">.</span><span class="ident" id="1666072">head</span>&nbsp;<span class="op" id="1666077">==</span>&nbsp;<span class="builtintype" id="1666080">nil</span>&nbsp;<span class="op" id="1666084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666089">s</span><span class="op" id="1666090">.</span><span class="ident" id="1666091">tail</span>&nbsp;<span class="op" id="1666096">=</span>&nbsp;<span class="builtintype" id="1666098">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666108">if</span>&nbsp;<span class="ident" id="1666111">wake</span><span class="op" id="1666115">.</span><span class="ident" id="1666116">releasetime</span>&nbsp;<span class="op" id="1666128">!=</span>&nbsp;<span class="num" id="1666131">0</span>&nbsp;<span class="op" id="1666133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666138">wake</span><span class="op" id="1666142">.</span><span class="ident" id="1666143">releasetime</span>&nbsp;<span class="op" id="1666155">=</span>&nbsp;<span class="ident" id="1666157">cputicks</span><span class="op" id="1666165">(</span><span class="op" id="1666166">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666174">wake</span><span class="op" id="1666178">.</span><span class="ident" id="1666179">next</span>&nbsp;<span class="op" id="1666184">=</span>&nbsp;<span class="builtintype" id="1666186">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666192">goready</span><span class="op" id="1666199">(</span><span class="ident" id="1666200">wake</span><span class="op" id="1666204">.</span><span class="ident" id="1666205">g</span><span class="op" id="1666206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666210">n</span><span class="op" id="1666211">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666215">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666218">if</span>&nbsp;<span class="ident" id="1666221">n</span>&nbsp;<span class="op" id="1666223">&gt;</span>&nbsp;<span class="num" id="1666225">0</span>&nbsp;<span class="op" id="1666227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1666231">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666251">w</span>&nbsp;<span class="op" id="1666253">:=</span>&nbsp;<span class="ident" id="1666256">acquireSudog</span><span class="op" id="1666268">(</span><span class="op" id="1666269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666273">w</span><span class="op" id="1666274">.</span><span class="ident" id="1666275">g</span>&nbsp;<span class="op" id="1666277">=</span>&nbsp;<span class="ident" id="1666279">getg</span><span class="op" id="1666283">(</span><span class="op" id="1666284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666288">w</span><span class="op" id="1666289">.</span><span class="ident" id="1666290">nrelease</span>&nbsp;<span class="op" id="1666299">=</span>&nbsp;<span class="builtintype" id="1666301">int32</span><span class="op" id="1666306">(</span><span class="ident" id="1666307">n</span><span class="op" id="1666308">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666312">w</span><span class="op" id="1666313">.</span><span class="ident" id="1666314">next</span>&nbsp;<span class="op" id="1666319">=</span>&nbsp;<span class="builtintype" id="1666321">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666327">w</span><span class="op" id="1666328">.</span><span class="ident" id="1666329">releasetime</span>&nbsp;<span class="op" id="1666341">=</span>&nbsp;<span class="num" id="1666343">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666347">if</span>&nbsp;<span class="ident" id="1666350">s</span><span class="op" id="1666351">.</span><span class="ident" id="1666352">tail</span>&nbsp;<span class="op" id="1666357">==</span>&nbsp;<span class="builtintype" id="1666360">nil</span>&nbsp;<span class="op" id="1666364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666369">s</span><span class="op" id="1666370">.</span><span class="ident" id="1666371">head</span>&nbsp;<span class="op" id="1666376">=</span>&nbsp;<span class="ident" id="1666378">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666382">}</span>&nbsp;<span class="keyword" id="1666384">else</span>&nbsp;<span class="op" id="1666389">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666394">s</span><span class="op" id="1666395">.</span><span class="ident" id="1666396">tail</span><span class="op" id="1666400">.</span><span class="ident" id="1666401">next</span>&nbsp;<span class="op" id="1666406">=</span>&nbsp;<span class="ident" id="1666408">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666416">s</span><span class="op" id="1666417">.</span><span class="ident" id="1666418">tail</span>&nbsp;<span class="op" id="1666423">=</span>&nbsp;<span class="ident" id="1666425">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666429">goparkunlock</span><span class="op" id="1666441">(</span><span class="op" id="1666442">&amp;</span><span class="ident" id="1666443">s</span><span class="op" id="1666444">.</span><span class="ident" id="1666445">lock</span><span class="op" id="1666449">,</span>&nbsp;<span class="string" id="1666451">&#34;semarelease&#34;</span><span class="op" id="1666464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666468">releaseSudog</span><span class="op" id="1666480">(</span><span class="ident" id="1666481">w</span><span class="op" id="1666482">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666485">}</span>&nbsp;<span class="keyword" id="1666487">else</span>&nbsp;<span class="op" id="1666492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666496">unlock</span><span class="op" id="1666502">(</span><span class="op" id="1666503">&amp;</span><span class="ident" id="1666504">s</span><span class="op" id="1666505">.</span><span class="ident" id="1666506">lock</span><span class="op" id="1666510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666513">}</span><br>
<span class="lineno"></span><span class="op" id="1666515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1666518">func</span>&nbsp;<span class="ident" id="1666523">syncsemcheck</span><span class="op" id="1666535">(</span><span class="ident" id="1666536">sz</span>&nbsp;<span class="builtintype" id="1666539">uintptr</span><span class="op" id="1666546">)</span>&nbsp;<span class="op" id="1666548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1666551">if</span>&nbsp;<span class="ident" id="1666554">sz</span>&nbsp;<span class="op" id="1666557">!=</span>&nbsp;<span class="ident" id="1666560">unsafe</span><span class="op" id="1666566">.</span><span class="ident" id="1666567">Sizeof</span><span class="op" id="1666573">(</span><span class="ident" id="1666574">syncSema</span><span class="op" id="1666582">{</span><span class="op" id="1666583">}</span><span class="op" id="1666584">)</span>&nbsp;<span class="op" id="1666586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1666590">print</span><span class="op" id="1666595">(</span><span class="string" id="1666596">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="1666632">,</span>&nbsp;<span class="ident" id="1666634">sz</span><span class="op" id="1666636">,</span>&nbsp;<span class="string" id="1666638">&#34;&nbsp;runtime=&#34;</span><span class="op" id="1666649">,</span>&nbsp;<span class="ident" id="1666651">unsafe</span><span class="op" id="1666657">.</span><span class="ident" id="1666658">Sizeof</span><span class="op" id="1666664">(</span><span class="ident" id="1666665">syncSema</span><span class="op" id="1666673">{</span><span class="op" id="1666674">}</span><span class="op" id="1666675">)</span><span class="op" id="1666676">,</span>&nbsp;<span class="string" id="1666678">&#34;\n&#34;</span><span class="op" id="1666682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1666686">gothrow</span><span class="op" id="1666693">(</span><span class="string" id="1666694">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="1666713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1666716">}</span><br>
<span class="lineno">275</span><span class="op" id="1666718">}</span>
</div>
</body>
</html>
