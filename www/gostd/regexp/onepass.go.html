<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5207852">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5207908">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5207962">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5208013">package</span>&nbsp;<span class="ident" id="5208021">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5208029">import</span>&nbsp;<span class="op" id="5208036">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5208039">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5208048">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5208065">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5208073">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="5208083">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5208086">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment" id="5208118">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment" id="5208184">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5208256">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="5208310">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5208358">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5208426">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword" id="5208494">type</span>&nbsp;<span class="ident" id="5208499">onePassProg</span>&nbsp;<span class="keyword" id="5208511">struct</span>&nbsp;<span class="op" id="5208518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208521">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5208528">[</span><span class="op" id="5208529">]</span><span class="ident" id="5208530">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208543">Start</span>&nbsp;&nbsp;<span class="builtintype" id="5208550">int</span>&nbsp;<span class="comment" id="5208554">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208585">NumCap</span>&nbsp;<span class="builtintype" id="5208592">int</span>&nbsp;<span class="comment" id="5208596">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op" id="5208633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5208636">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5208719">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword" id="5208785">type</span>&nbsp;<span class="ident" id="5208790">onePassInst</span>&nbsp;<span class="keyword" id="5208802">struct</span>&nbsp;<span class="op" id="5208809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208812">syntax</span><span class="op" id="5208818">.</span><span class="ident" id="5208819">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5208825">Next</span>&nbsp;<span class="op" id="5208830">[</span><span class="op" id="5208831">]</span><span class="builtintype" id="5208832">uint32</span><br>
<span class="lineno"></span><span class="op" id="5208839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5208842">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5208909">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="5208968">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5209037">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment" id="5209098">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword" id="5209116">func</span>&nbsp;<span class="ident" id="5209121">onePassPrefix</span><span class="op" id="5209134">(</span><span class="ident" id="5209135">p</span>&nbsp;<span class="op" id="5209137">*</span><span class="ident" id="5209138">syntax</span><span class="op" id="5209144">.</span><span class="ident" id="5209145">Prog</span><span class="op" id="5209149">)</span>&nbsp;<span class="op" id="5209151">(</span><span class="ident" id="5209152">prefix</span>&nbsp;<span class="builtintype" id="5209159">string</span><span class="op" id="5209165">,</span>&nbsp;<span class="ident" id="5209167">complete</span>&nbsp;<span class="builtintype" id="5209176">bool</span><span class="op" id="5209180">,</span>&nbsp;<span class="ident" id="5209182">pc</span>&nbsp;<span class="builtintype" id="5209185">uint32</span><span class="op" id="5209191">)</span>&nbsp;<span class="op" id="5209193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209196">i</span>&nbsp;<span class="op" id="5209198">:=</span>&nbsp;<span class="op" id="5209201">&amp;</span><span class="ident" id="5209202">p</span><span class="op" id="5209203">.</span><span class="ident" id="5209204">Inst</span><span class="op" id="5209208">[</span><span class="ident" id="5209209">p</span><span class="op" id="5209210">.</span><span class="ident" id="5209211">Start</span><span class="op" id="5209216">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209219">if</span>&nbsp;<span class="ident" id="5209222">i</span><span class="op" id="5209223">.</span><span class="ident" id="5209224">Op</span>&nbsp;<span class="op" id="5209227">!=</span>&nbsp;<span class="ident" id="5209230">syntax</span><span class="op" id="5209236">.</span><span class="ident" id="5209237">InstEmptyWidth</span>&nbsp;<span class="op" id="5209252">||</span>&nbsp;<span class="op" id="5209255">(</span><span class="ident" id="5209256">syntax</span><span class="op" id="5209262">.</span><span class="ident" id="5209263">EmptyOp</span><span class="op" id="5209270">(</span><span class="ident" id="5209271">i</span><span class="op" id="5209272">.</span><span class="ident" id="5209273">Arg</span><span class="op" id="5209276">)</span><span class="op" id="5209277">)</span><span class="op" id="5209278">&amp;</span><span class="ident" id="5209279">syntax</span><span class="op" id="5209285">.</span><span class="ident" id="5209286">EmptyBeginText</span>&nbsp;<span class="op" id="5209301">==</span>&nbsp;<span class="num" id="5209304">0</span>&nbsp;<span class="op" id="5209306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209310">return</span>&nbsp;<span class="string" id="5209317">&#34;&#34;</span><span class="op" id="5209319">,</span>&nbsp;<span class="ident" id="5209321">i</span><span class="op" id="5209322">.</span><span class="ident" id="5209323">Op</span>&nbsp;<span class="op" id="5209326">==</span>&nbsp;<span class="ident" id="5209329">syntax</span><span class="op" id="5209335">.</span><span class="ident" id="5209336">InstMatch</span><span class="op" id="5209345">,</span>&nbsp;<span class="builtintype" id="5209347">uint32</span><span class="op" id="5209353">(</span><span class="ident" id="5209354">p</span><span class="op" id="5209355">.</span><span class="ident" id="5209356">Start</span><span class="op" id="5209361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209364">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209367">pc</span>&nbsp;<span class="op" id="5209370">=</span>&nbsp;<span class="ident" id="5209372">i</span><span class="op" id="5209373">.</span><span class="ident" id="5209374">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209379">i</span>&nbsp;<span class="op" id="5209381">=</span>&nbsp;<span class="op" id="5209383">&amp;</span><span class="ident" id="5209384">p</span><span class="op" id="5209385">.</span><span class="ident" id="5209386">Inst</span><span class="op" id="5209390">[</span><span class="ident" id="5209391">pc</span><span class="op" id="5209393">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209396">for</span>&nbsp;<span class="ident" id="5209400">i</span><span class="op" id="5209401">.</span><span class="ident" id="5209402">Op</span>&nbsp;<span class="op" id="5209405">==</span>&nbsp;<span class="ident" id="5209408">syntax</span><span class="op" id="5209414">.</span><span class="ident" id="5209415">InstNop</span>&nbsp;<span class="op" id="5209423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209427">pc</span>&nbsp;<span class="op" id="5209430">=</span>&nbsp;<span class="ident" id="5209432">i</span><span class="op" id="5209433">.</span><span class="ident" id="5209434">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209440">i</span>&nbsp;<span class="op" id="5209442">=</span>&nbsp;<span class="op" id="5209444">&amp;</span><span class="ident" id="5209445">p</span><span class="op" id="5209446">.</span><span class="ident" id="5209447">Inst</span><span class="op" id="5209451">[</span><span class="ident" id="5209452">pc</span><span class="op" id="5209454">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5209460">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209511">if</span>&nbsp;<span class="ident" id="5209514">iop</span><span class="op" id="5209517">(</span><span class="ident" id="5209518">i</span><span class="op" id="5209519">)</span>&nbsp;<span class="op" id="5209521">!=</span>&nbsp;<span class="ident" id="5209524">syntax</span><span class="op" id="5209530">.</span><span class="ident" id="5209531">InstRune</span>&nbsp;<span class="op" id="5209540">||</span>&nbsp;<span class="builtinfunc" id="5209543">len</span><span class="op" id="5209546">(</span><span class="ident" id="5209547">i</span><span class="op" id="5209548">.</span><span class="ident" id="5209549">Rune</span><span class="op" id="5209553">)</span>&nbsp;<span class="op" id="5209555">!=</span>&nbsp;<span class="num" id="5209558">1</span>&nbsp;<span class="op" id="5209560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209564">return</span>&nbsp;<span class="string" id="5209571">&#34;&#34;</span><span class="op" id="5209573">,</span>&nbsp;<span class="ident" id="5209575">i</span><span class="op" id="5209576">.</span><span class="ident" id="5209577">Op</span>&nbsp;<span class="op" id="5209580">==</span>&nbsp;<span class="ident" id="5209583">syntax</span><span class="op" id="5209589">.</span><span class="ident" id="5209590">InstMatch</span><span class="op" id="5209599">,</span>&nbsp;<span class="builtintype" id="5209601">uint32</span><span class="op" id="5209607">(</span><span class="ident" id="5209608">p</span><span class="op" id="5209609">.</span><span class="ident" id="5209610">Start</span><span class="op" id="5209615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209618">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5209622">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209658">var</span>&nbsp;<span class="ident" id="5209662">buf</span>&nbsp;<span class="ident" id="5209666">bytes</span><span class="op" id="5209671">.</span><span class="ident" id="5209672">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209680">for</span>&nbsp;<span class="ident" id="5209684">iop</span><span class="op" id="5209687">(</span><span class="ident" id="5209688">i</span><span class="op" id="5209689">)</span>&nbsp;<span class="op" id="5209691">==</span>&nbsp;<span class="ident" id="5209694">syntax</span><span class="op" id="5209700">.</span><span class="ident" id="5209701">InstRune</span>&nbsp;<span class="op" id="5209710">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5209713">len</span><span class="op" id="5209716">(</span><span class="ident" id="5209717">i</span><span class="op" id="5209718">.</span><span class="ident" id="5209719">Rune</span><span class="op" id="5209723">)</span>&nbsp;<span class="op" id="5209725">==</span>&nbsp;<span class="num" id="5209728">1</span>&nbsp;<span class="op" id="5209730">&amp;&amp;</span>&nbsp;<span class="ident" id="5209733">syntax</span><span class="op" id="5209739">.</span><span class="ident" id="5209740">Flags</span><span class="op" id="5209745">(</span><span class="ident" id="5209746">i</span><span class="op" id="5209747">.</span><span class="ident" id="5209748">Arg</span><span class="op" id="5209751">)</span><span class="op" id="5209752">&amp;</span><span class="ident" id="5209753">syntax</span><span class="op" id="5209759">.</span><span class="ident" id="5209760">FoldCase</span>&nbsp;<span class="op" id="5209769">==</span>&nbsp;<span class="num" id="5209772">0</span>&nbsp;<span class="op" id="5209774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209778">buf</span><span class="op" id="5209781">.</span><span class="ident" id="5209782">WriteRune</span><span class="op" id="5209791">(</span><span class="ident" id="5209792">i</span><span class="op" id="5209793">.</span><span class="ident" id="5209794">Rune</span><span class="op" id="5209798">[</span><span class="num" id="5209799">0</span><span class="op" id="5209800">]</span><span class="op" id="5209801">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5209805">pc</span><span class="op" id="5209807">,</span>&nbsp;<span class="ident" id="5209809">i</span>&nbsp;<span class="op" id="5209811">=</span>&nbsp;<span class="ident" id="5209813">i</span><span class="op" id="5209814">.</span><span class="ident" id="5209815">Out</span><span class="op" id="5209818">,</span>&nbsp;<span class="op" id="5209820">&amp;</span><span class="ident" id="5209821">p</span><span class="op" id="5209822">.</span><span class="ident" id="5209823">Inst</span><span class="op" id="5209827">[</span><span class="ident" id="5209828">i</span><span class="op" id="5209829">.</span><span class="ident" id="5209830">Out</span><span class="op" id="5209833">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5209836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5209839">return</span>&nbsp;<span class="ident" id="5209846">buf</span><span class="op" id="5209849">.</span><span class="ident" id="5209850">String</span><span class="op" id="5209856">(</span><span class="op" id="5209857">)</span><span class="op" id="5209858">,</span>&nbsp;<span class="ident" id="5209860">i</span><span class="op" id="5209861">.</span><span class="ident" id="5209862">Op</span>&nbsp;<span class="op" id="5209865">==</span>&nbsp;<span class="ident" id="5209868">syntax</span><span class="op" id="5209874">.</span><span class="ident" id="5209875">InstEmptyWidth</span>&nbsp;<span class="op" id="5209890">&amp;&amp;</span>&nbsp;<span class="op" id="5209893">(</span><span class="ident" id="5209894">syntax</span><span class="op" id="5209900">.</span><span class="ident" id="5209901">EmptyOp</span><span class="op" id="5209908">(</span><span class="ident" id="5209909">i</span><span class="op" id="5209910">.</span><span class="ident" id="5209911">Arg</span><span class="op" id="5209914">)</span><span class="op" id="5209915">)</span><span class="op" id="5209916">&amp;</span><span class="ident" id="5209917">syntax</span><span class="op" id="5209923">.</span><span class="ident" id="5209924">EmptyBeginText</span>&nbsp;<span class="op" id="5209939">!=</span>&nbsp;<span class="num" id="5209942">0</span><span class="op" id="5209943">,</span>&nbsp;<span class="ident" id="5209945">pc</span><br>
<span class="lineno"></span><span class="op" id="5209948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5209951">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5210043">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment" id="5210140">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5210234">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword" id="5210319">func</span>&nbsp;<span class="ident" id="5210324">onePassNext</span><span class="op" id="5210335">(</span><span class="ident" id="5210336">i</span>&nbsp;<span class="op" id="5210338">*</span><span class="ident" id="5210339">onePassInst</span><span class="op" id="5210350">,</span>&nbsp;<span class="ident" id="5210352">r</span>&nbsp;<span class="builtintype" id="5210354">rune</span><span class="op" id="5210358">)</span>&nbsp;<span class="builtintype" id="5210360">uint32</span>&nbsp;<span class="op" id="5210367">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210370">next</span>&nbsp;<span class="op" id="5210375">:=</span>&nbsp;<span class="ident" id="5210378">i</span><span class="op" id="5210379">.</span><span class="ident" id="5210380">MatchRunePos</span><span class="op" id="5210392">(</span><span class="ident" id="5210393">r</span><span class="op" id="5210394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210397">if</span>&nbsp;<span class="ident" id="5210400">next</span>&nbsp;<span class="op" id="5210405">&gt;=</span>&nbsp;<span class="num" id="5210408">0</span>&nbsp;<span class="op" id="5210410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210414">return</span>&nbsp;<span class="ident" id="5210421">i</span><span class="op" id="5210422">.</span><span class="ident" id="5210423">Next</span><span class="op" id="5210427">[</span><span class="ident" id="5210428">next</span><span class="op" id="5210432">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210438">if</span>&nbsp;<span class="ident" id="5210441">i</span><span class="op" id="5210442">.</span><span class="ident" id="5210443">Op</span>&nbsp;<span class="op" id="5210446">==</span>&nbsp;<span class="ident" id="5210449">syntax</span><span class="op" id="5210455">.</span><span class="ident" id="5210456">InstAltMatch</span>&nbsp;<span class="op" id="5210469">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210473">return</span>&nbsp;<span class="ident" id="5210480">i</span><span class="op" id="5210481">.</span><span class="ident" id="5210482">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210490">return</span>&nbsp;<span class="num" id="5210497">0</span><br>
<span class="lineno"></span><span class="op" id="5210499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5210502">func</span>&nbsp;<span class="ident" id="5210507">iop</span><span class="op" id="5210510">(</span><span class="ident" id="5210511">i</span>&nbsp;<span class="op" id="5210513">*</span><span class="ident" id="5210514">syntax</span><span class="op" id="5210520">.</span><span class="ident" id="5210521">Inst</span><span class="op" id="5210525">)</span>&nbsp;<span class="ident" id="5210527">syntax</span><span class="op" id="5210533">.</span><span class="ident" id="5210534">InstOp</span>&nbsp;<span class="op" id="5210541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210544">op</span>&nbsp;<span class="op" id="5210547">:=</span>&nbsp;<span class="ident" id="5210550">i</span><span class="op" id="5210551">.</span><span class="ident" id="5210552">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210556">switch</span>&nbsp;<span class="ident" id="5210563">op</span>&nbsp;<span class="op" id="5210566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210569">case</span>&nbsp;<span class="ident" id="5210574">syntax</span><span class="op" id="5210580">.</span><span class="ident" id="5210581">InstRune1</span><span class="op" id="5210590">,</span>&nbsp;<span class="ident" id="5210592">syntax</span><span class="op" id="5210598">.</span><span class="ident" id="5210599">InstRuneAny</span><span class="op" id="5210610">,</span>&nbsp;<span class="ident" id="5210612">syntax</span><span class="op" id="5210618">.</span><span class="ident" id="5210619">InstRuneAnyNotNL</span><span class="op" id="5210635">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210639">op</span>&nbsp;<span class="op" id="5210642">=</span>&nbsp;<span class="ident" id="5210644">syntax</span><span class="op" id="5210650">.</span><span class="ident" id="5210651">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5210661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210664">return</span>&nbsp;<span class="ident" id="5210671">op</span><br>
<span class="lineno"></span><span class="op" id="5210674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5210677">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword" id="5210735">type</span>&nbsp;<span class="ident" id="5210740">queueOnePass</span>&nbsp;<span class="keyword" id="5210753">struct</span>&nbsp;<span class="op" id="5210760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210763">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5210779">[</span><span class="op" id="5210780">]</span><span class="builtintype" id="5210781">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210789">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5210805">[</span><span class="op" id="5210806">]</span><span class="builtintype" id="5210807">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210815">size</span><span class="op" id="5210819">,</span>&nbsp;<span class="ident" id="5210821">nextIndex</span>&nbsp;<span class="builtintype" id="5210831">uint32</span><br>
<span class="lineno"></span><span class="op" id="5210838">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="5210841">func</span>&nbsp;<span class="op" id="5210846">(</span><span class="ident" id="5210847">q</span>&nbsp;<span class="op" id="5210849">*</span><span class="ident" id="5210850">queueOnePass</span><span class="op" id="5210862">)</span>&nbsp;<span class="ident" id="5210864">empty</span><span class="op" id="5210869">(</span><span class="op" id="5210870">)</span>&nbsp;<span class="builtintype" id="5210872">bool</span>&nbsp;<span class="op" id="5210877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210880">return</span>&nbsp;<span class="ident" id="5210887">q</span><span class="op" id="5210888">.</span><span class="ident" id="5210889">nextIndex</span>&nbsp;<span class="op" id="5210899">&gt;=</span>&nbsp;<span class="ident" id="5210902">q</span><span class="op" id="5210903">.</span><span class="ident" id="5210904">size</span><br>
<span class="lineno"></span><span class="op" id="5210909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5210912">func</span>&nbsp;<span class="op" id="5210917">(</span><span class="ident" id="5210918">q</span>&nbsp;<span class="op" id="5210920">*</span><span class="ident" id="5210921">queueOnePass</span><span class="op" id="5210933">)</span>&nbsp;<span class="ident" id="5210935">next</span><span class="op" id="5210939">(</span><span class="op" id="5210940">)</span>&nbsp;<span class="op" id="5210942">(</span><span class="ident" id="5210943">n</span>&nbsp;<span class="builtintype" id="5210945">uint32</span><span class="op" id="5210951">)</span>&nbsp;<span class="op" id="5210953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210956">n</span>&nbsp;<span class="op" id="5210958">=</span>&nbsp;<span class="ident" id="5210960">q</span><span class="op" id="5210961">.</span><span class="ident" id="5210962">dense</span><span class="op" id="5210967">[</span><span class="ident" id="5210968">q</span><span class="op" id="5210969">.</span><span class="ident" id="5210970">nextIndex</span><span class="op" id="5210979">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5210982">q</span><span class="op" id="5210983">.</span><span class="ident" id="5210984">nextIndex</span><span class="op" id="5210993">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5210997">return</span><br>
<span class="lineno"></span><span class="op" id="5211004">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="5211007">func</span>&nbsp;<span class="op" id="5211012">(</span><span class="ident" id="5211013">q</span>&nbsp;<span class="op" id="5211015">*</span><span class="ident" id="5211016">queueOnePass</span><span class="op" id="5211028">)</span>&nbsp;<span class="ident" id="5211030">clear</span><span class="op" id="5211035">(</span><span class="op" id="5211036">)</span>&nbsp;<span class="op" id="5211038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211041">q</span><span class="op" id="5211042">.</span><span class="ident" id="5211043">size</span>&nbsp;<span class="op" id="5211048">=</span>&nbsp;<span class="num" id="5211050">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211053">q</span><span class="op" id="5211054">.</span><span class="ident" id="5211055">nextIndex</span>&nbsp;<span class="op" id="5211065">=</span>&nbsp;<span class="num" id="5211067">0</span><br>
<span class="lineno"></span><span class="op" id="5211069">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5211072">func</span>&nbsp;<span class="op" id="5211077">(</span><span class="ident" id="5211078">q</span>&nbsp;<span class="op" id="5211080">*</span><span class="ident" id="5211081">queueOnePass</span><span class="op" id="5211093">)</span>&nbsp;<span class="ident" id="5211095">reset</span><span class="op" id="5211100">(</span><span class="op" id="5211101">)</span>&nbsp;<span class="op" id="5211103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211106">q</span><span class="op" id="5211107">.</span><span class="ident" id="5211108">nextIndex</span>&nbsp;<span class="op" id="5211118">=</span>&nbsp;<span class="num" id="5211120">0</span><br>
<span class="lineno"></span><span class="op" id="5211122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="5211125">func</span>&nbsp;<span class="op" id="5211130">(</span><span class="ident" id="5211131">q</span>&nbsp;<span class="op" id="5211133">*</span><span class="ident" id="5211134">queueOnePass</span><span class="op" id="5211146">)</span>&nbsp;<span class="ident" id="5211148">contains</span><span class="op" id="5211156">(</span><span class="ident" id="5211157">u</span>&nbsp;<span class="builtintype" id="5211159">uint32</span><span class="op" id="5211165">)</span>&nbsp;<span class="builtintype" id="5211167">bool</span>&nbsp;<span class="op" id="5211172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211175">if</span>&nbsp;<span class="ident" id="5211178">u</span>&nbsp;<span class="op" id="5211180">&gt;=</span>&nbsp;<span class="builtintype" id="5211183">uint32</span><span class="op" id="5211189">(</span><span class="builtinfunc" id="5211190">len</span><span class="op" id="5211193">(</span><span class="ident" id="5211194">q</span><span class="op" id="5211195">.</span><span class="ident" id="5211196">sparse</span><span class="op" id="5211202">)</span><span class="op" id="5211203">)</span>&nbsp;<span class="op" id="5211205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211209">return</span>&nbsp;<span class="builtintype" id="5211216">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5211223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211226">return</span>&nbsp;<span class="ident" id="5211233">q</span><span class="op" id="5211234">.</span><span class="ident" id="5211235">sparse</span><span class="op" id="5211241">[</span><span class="ident" id="5211242">u</span><span class="op" id="5211243">]</span>&nbsp;<span class="op" id="5211245">&lt;</span>&nbsp;<span class="ident" id="5211247">q</span><span class="op" id="5211248">.</span><span class="ident" id="5211249">size</span>&nbsp;<span class="op" id="5211254">&amp;&amp;</span>&nbsp;<span class="ident" id="5211257">q</span><span class="op" id="5211258">.</span><span class="ident" id="5211259">dense</span><span class="op" id="5211264">[</span><span class="ident" id="5211265">q</span><span class="op" id="5211266">.</span><span class="ident" id="5211267">sparse</span><span class="op" id="5211273">[</span><span class="ident" id="5211274">u</span><span class="op" id="5211275">]</span><span class="op" id="5211276">]</span>&nbsp;<span class="op" id="5211278">==</span>&nbsp;<span class="ident" id="5211281">u</span><br>
<span class="lineno">120</span><span class="op" id="5211283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5211286">func</span>&nbsp;<span class="op" id="5211291">(</span><span class="ident" id="5211292">q</span>&nbsp;<span class="op" id="5211294">*</span><span class="ident" id="5211295">queueOnePass</span><span class="op" id="5211307">)</span>&nbsp;<span class="ident" id="5211309">insert</span><span class="op" id="5211315">(</span><span class="ident" id="5211316">u</span>&nbsp;<span class="builtintype" id="5211318">uint32</span><span class="op" id="5211324">)</span>&nbsp;<span class="op" id="5211326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211329">if</span>&nbsp;<span class="op" id="5211332">!</span><span class="ident" id="5211333">q</span><span class="op" id="5211334">.</span><span class="ident" id="5211335">contains</span><span class="op" id="5211343">(</span><span class="ident" id="5211344">u</span><span class="op" id="5211345">)</span>&nbsp;<span class="op" id="5211347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211351">q</span><span class="op" id="5211352">.</span><span class="ident" id="5211353">insertNew</span><span class="op" id="5211362">(</span><span class="ident" id="5211363">u</span><span class="op" id="5211364">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5211367">}</span><br>
<span class="lineno"></span><span class="op" id="5211369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5211372">func</span>&nbsp;<span class="op" id="5211377">(</span><span class="ident" id="5211378">q</span>&nbsp;<span class="op" id="5211380">*</span><span class="ident" id="5211381">queueOnePass</span><span class="op" id="5211393">)</span>&nbsp;<span class="ident" id="5211395">insertNew</span><span class="op" id="5211404">(</span><span class="ident" id="5211405">u</span>&nbsp;<span class="builtintype" id="5211407">uint32</span><span class="op" id="5211413">)</span>&nbsp;<span class="op" id="5211415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211418">if</span>&nbsp;<span class="ident" id="5211421">u</span>&nbsp;<span class="op" id="5211423">&gt;=</span>&nbsp;<span class="builtintype" id="5211426">uint32</span><span class="op" id="5211432">(</span><span class="builtinfunc" id="5211433">len</span><span class="op" id="5211436">(</span><span class="ident" id="5211437">q</span><span class="op" id="5211438">.</span><span class="ident" id="5211439">sparse</span><span class="op" id="5211445">)</span><span class="op" id="5211446">)</span>&nbsp;<span class="op" id="5211448">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211452">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5211460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211463">q</span><span class="op" id="5211464">.</span><span class="ident" id="5211465">sparse</span><span class="op" id="5211471">[</span><span class="ident" id="5211472">u</span><span class="op" id="5211473">]</span>&nbsp;<span class="op" id="5211475">=</span>&nbsp;<span class="ident" id="5211477">q</span><span class="op" id="5211478">.</span><span class="ident" id="5211479">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211485">q</span><span class="op" id="5211486">.</span><span class="ident" id="5211487">dense</span><span class="op" id="5211492">[</span><span class="ident" id="5211493">q</span><span class="op" id="5211494">.</span><span class="ident" id="5211495">size</span><span class="op" id="5211499">]</span>&nbsp;<span class="op" id="5211501">=</span>&nbsp;<span class="ident" id="5211503">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211506">q</span><span class="op" id="5211507">.</span><span class="ident" id="5211508">size</span><span class="op" id="5211512">++</span><br>
<span class="lineno">135</span><span class="op" id="5211515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5211518">func</span>&nbsp;<span class="ident" id="5211523">newQueue</span><span class="op" id="5211531">(</span><span class="ident" id="5211532">size</span>&nbsp;<span class="builtintype" id="5211537">int</span><span class="op" id="5211540">)</span>&nbsp;<span class="op" id="5211542">(</span><span class="ident" id="5211543">q</span>&nbsp;<span class="op" id="5211545">*</span><span class="ident" id="5211546">queueOnePass</span><span class="op" id="5211558">)</span>&nbsp;<span class="op" id="5211560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5211563">return</span>&nbsp;<span class="op" id="5211570">&amp;</span><span class="ident" id="5211571">queueOnePass</span><span class="op" id="5211583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211587">sparse</span><span class="op" id="5211593">:</span>&nbsp;<span class="builtinfunc" id="5211595">make</span><span class="op" id="5211599">(</span><span class="op" id="5211600">[</span><span class="op" id="5211601">]</span><span class="builtintype" id="5211602">uint32</span><span class="op" id="5211608">,</span>&nbsp;<span class="ident" id="5211610">size</span><span class="op" id="5211614">)</span><span class="op" id="5211615">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5211619">dense</span><span class="op" id="5211624">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5211627">make</span><span class="op" id="5211631">(</span><span class="op" id="5211632">[</span><span class="op" id="5211633">]</span><span class="builtintype" id="5211634">uint32</span><span class="op" id="5211640">,</span>&nbsp;<span class="ident" id="5211642">size</span><span class="op" id="5211646">)</span><span class="op" id="5211647">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5211650">}</span><br>
<span class="lineno"></span><span class="op" id="5211652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5211655">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment" id="5211741">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment" id="5211825">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5211910">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5211975">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword" id="5212061">const</span>&nbsp;<span class="ident" id="5212067">mergeFailed</span>&nbsp;<span class="op" id="5212079">=</span>&nbsp;<span class="builtintype" id="5212081">uint32</span><span class="op" id="5212087">(</span><span class="num" id="5212088">0xffffffff</span><span class="op" id="5212098">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="5212101">var</span>&nbsp;<span class="op" id="5212105">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212108">noRune</span>&nbsp;<span class="op" id="5212115">=</span>&nbsp;<span class="op" id="5212117">[</span><span class="op" id="5212118">]</span><span class="builtintype" id="5212119">rune</span><span class="op" id="5212123">{</span><span class="op" id="5212124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212127">noNext</span>&nbsp;<span class="op" id="5212134">=</span>&nbsp;<span class="op" id="5212136">[</span><span class="op" id="5212137">]</span><span class="builtintype" id="5212138">uint32</span><span class="op" id="5212144">{</span><span class="ident" id="5212145">mergeFailed</span><span class="op" id="5212156">}</span><br>
<span class="lineno"></span><span class="op" id="5212158">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="5212161">func</span>&nbsp;<span class="ident" id="5212166">mergeRuneSets</span><span class="op" id="5212179">(</span><span class="ident" id="5212180">leftRunes</span><span class="op" id="5212189">,</span>&nbsp;<span class="ident" id="5212191">rightRunes</span>&nbsp;<span class="op" id="5212202">*</span><span class="op" id="5212203">[</span><span class="op" id="5212204">]</span><span class="builtintype" id="5212205">rune</span><span class="op" id="5212209">,</span>&nbsp;<span class="ident" id="5212211">leftPC</span><span class="op" id="5212217">,</span>&nbsp;<span class="ident" id="5212219">rightPC</span>&nbsp;<span class="builtintype" id="5212227">uint32</span><span class="op" id="5212233">)</span>&nbsp;<span class="op" id="5212235">(</span><span class="op" id="5212236">[</span><span class="op" id="5212237">]</span><span class="builtintype" id="5212238">rune</span><span class="op" id="5212242">,</span>&nbsp;<span class="op" id="5212244">[</span><span class="op" id="5212245">]</span><span class="builtintype" id="5212246">uint32</span><span class="op" id="5212252">)</span>&nbsp;<span class="op" id="5212254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212257">leftLen</span>&nbsp;<span class="op" id="5212265">:=</span>&nbsp;<span class="builtinfunc" id="5212268">len</span><span class="op" id="5212271">(</span><span class="op" id="5212272">*</span><span class="ident" id="5212273">leftRunes</span><span class="op" id="5212282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212285">rightLen</span>&nbsp;<span class="op" id="5212294">:=</span>&nbsp;<span class="builtinfunc" id="5212297">len</span><span class="op" id="5212300">(</span><span class="op" id="5212301">*</span><span class="ident" id="5212302">rightRunes</span><span class="op" id="5212312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212315">if</span>&nbsp;<span class="ident" id="5212318">leftLen</span><span class="op" id="5212325">&amp;</span><span class="num" id="5212326">0x1</span>&nbsp;<span class="op" id="5212330">!=</span>&nbsp;<span class="num" id="5212333">0</span>&nbsp;<span class="op" id="5212335">||</span>&nbsp;<span class="ident" id="5212338">rightLen</span><span class="op" id="5212346">&amp;</span><span class="num" id="5212347">0x1</span>&nbsp;<span class="op" id="5212351">!=</span>&nbsp;<span class="num" id="5212354">0</span>&nbsp;<span class="op" id="5212356">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5212360">panic</span><span class="op" id="5212365">(</span><span class="string" id="5212366">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op" id="5212399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212405">var</span>&nbsp;<span class="op" id="5212409">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212413">lx</span><span class="op" id="5212415">,</span>&nbsp;<span class="ident" id="5212417">rx</span>&nbsp;<span class="builtintype" id="5212420">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212425">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212428">merged</span>&nbsp;<span class="op" id="5212435">:=</span>&nbsp;<span class="builtinfunc" id="5212438">make</span><span class="op" id="5212442">(</span><span class="op" id="5212443">[</span><span class="op" id="5212444">]</span><span class="builtintype" id="5212445">rune</span><span class="op" id="5212449">,</span>&nbsp;<span class="num" id="5212451">0</span><span class="op" id="5212452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212455">next</span>&nbsp;<span class="op" id="5212460">:=</span>&nbsp;<span class="builtinfunc" id="5212463">make</span><span class="op" id="5212467">(</span><span class="op" id="5212468">[</span><span class="op" id="5212469">]</span><span class="builtintype" id="5212470">uint32</span><span class="op" id="5212476">,</span>&nbsp;<span class="num" id="5212478">0</span><span class="op" id="5212479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212482">ok</span>&nbsp;<span class="op" id="5212485">:=</span>&nbsp;<span class="builtintype" id="5212488">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212494">defer</span>&nbsp;<span class="keyword" id="5212500">func</span><span class="op" id="5212504">(</span><span class="op" id="5212505">)</span>&nbsp;<span class="op" id="5212507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212511">if</span>&nbsp;<span class="op" id="5212514">!</span><span class="ident" id="5212515">ok</span>&nbsp;<span class="op" id="5212518">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212523">merged</span>&nbsp;<span class="op" id="5212530">=</span>&nbsp;<span class="ident" id="5212532">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212539">next</span>&nbsp;<span class="op" id="5212544">=</span>&nbsp;<span class="ident" id="5212546">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212555">}</span><span class="op" id="5212556">(</span><span class="op" id="5212557">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212561">ix</span>&nbsp;<span class="op" id="5212564">:=</span>&nbsp;<span class="op" id="5212567">-</span><span class="num" id="5212568">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212571">extend</span>&nbsp;<span class="op" id="5212578">:=</span>&nbsp;<span class="keyword" id="5212581">func</span><span class="op" id="5212585">(</span><span class="ident" id="5212586">newLow</span>&nbsp;<span class="op" id="5212593">*</span><span class="builtintype" id="5212594">int</span><span class="op" id="5212597">,</span>&nbsp;<span class="ident" id="5212599">newArray</span>&nbsp;<span class="op" id="5212608">*</span><span class="op" id="5212609">[</span><span class="op" id="5212610">]</span><span class="builtintype" id="5212611">rune</span><span class="op" id="5212615">,</span>&nbsp;<span class="ident" id="5212617">pc</span>&nbsp;<span class="builtintype" id="5212620">uint32</span><span class="op" id="5212626">)</span>&nbsp;<span class="builtintype" id="5212628">bool</span>&nbsp;<span class="op" id="5212633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212637">if</span>&nbsp;<span class="ident" id="5212640">ix</span>&nbsp;<span class="op" id="5212643">&gt;</span>&nbsp;<span class="num" id="5212645">0</span>&nbsp;<span class="op" id="5212647">&amp;&amp;</span>&nbsp;<span class="op" id="5212650">(</span><span class="op" id="5212651">*</span><span class="ident" id="5212652">newArray</span><span class="op" id="5212660">)</span><span class="op" id="5212661">[</span><span class="op" id="5212662">*</span><span class="ident" id="5212663">newLow</span><span class="op" id="5212669">]</span>&nbsp;<span class="op" id="5212671">&lt;=</span>&nbsp;<span class="ident" id="5212674">merged</span><span class="op" id="5212680">[</span><span class="ident" id="5212681">ix</span><span class="op" id="5212683">]</span>&nbsp;<span class="op" id="5212685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212690">return</span>&nbsp;<span class="builtintype" id="5212697">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212705">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212709">merged</span>&nbsp;<span class="op" id="5212716">=</span>&nbsp;<span class="builtinfunc" id="5212718">append</span><span class="op" id="5212724">(</span><span class="ident" id="5212725">merged</span><span class="op" id="5212731">,</span>&nbsp;<span class="op" id="5212733">(</span><span class="op" id="5212734">*</span><span class="ident" id="5212735">newArray</span><span class="op" id="5212743">)</span><span class="op" id="5212744">[</span><span class="op" id="5212745">*</span><span class="ident" id="5212746">newLow</span><span class="op" id="5212752">]</span><span class="op" id="5212753">,</span>&nbsp;<span class="op" id="5212755">(</span><span class="op" id="5212756">*</span><span class="ident" id="5212757">newArray</span><span class="op" id="5212765">)</span><span class="op" id="5212766">[</span><span class="op" id="5212767">*</span><span class="ident" id="5212768">newLow</span><span class="op" id="5212774">+</span><span class="num" id="5212775">1</span><span class="op" id="5212776">]</span><span class="op" id="5212777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212781">*</span><span class="ident" id="5212782">newLow</span>&nbsp;<span class="op" id="5212789">+=</span>&nbsp;<span class="num" id="5212792">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212796">ix</span>&nbsp;<span class="op" id="5212799">+=</span>&nbsp;<span class="num" id="5212802">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212806">next</span>&nbsp;<span class="op" id="5212811">=</span>&nbsp;<span class="builtinfunc" id="5212813">append</span><span class="op" id="5212819">(</span><span class="ident" id="5212820">next</span><span class="op" id="5212824">,</span>&nbsp;<span class="ident" id="5212826">pc</span><span class="op" id="5212828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212832">return</span>&nbsp;<span class="builtintype" id="5212839">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5212845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212849">for</span>&nbsp;<span class="ident" id="5212853">lx</span>&nbsp;<span class="op" id="5212856">&lt;</span>&nbsp;<span class="ident" id="5212858">leftLen</span>&nbsp;<span class="op" id="5212866">||</span>&nbsp;<span class="ident" id="5212869">rx</span>&nbsp;<span class="op" id="5212872">&lt;</span>&nbsp;<span class="ident" id="5212874">rightLen</span>&nbsp;<span class="op" id="5212883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212887">switch</span>&nbsp;<span class="op" id="5212894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212898">case</span>&nbsp;<span class="ident" id="5212903">rx</span>&nbsp;<span class="op" id="5212906">&gt;=</span>&nbsp;<span class="ident" id="5212909">rightLen</span><span class="op" id="5212917">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212922">ok</span>&nbsp;<span class="op" id="5212925">=</span>&nbsp;<span class="ident" id="5212927">extend</span><span class="op" id="5212933">(</span><span class="op" id="5212934">&amp;</span><span class="ident" id="5212935">lx</span><span class="op" id="5212937">,</span>&nbsp;<span class="ident" id="5212939">leftRunes</span><span class="op" id="5212948">,</span>&nbsp;<span class="ident" id="5212950">leftPC</span><span class="op" id="5212956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5212960">case</span>&nbsp;<span class="ident" id="5212965">lx</span>&nbsp;<span class="op" id="5212968">&gt;=</span>&nbsp;<span class="ident" id="5212971">leftLen</span><span class="op" id="5212978">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5212983">ok</span>&nbsp;<span class="op" id="5212986">=</span>&nbsp;<span class="ident" id="5212988">extend</span><span class="op" id="5212994">(</span><span class="op" id="5212995">&amp;</span><span class="ident" id="5212996">rx</span><span class="op" id="5212998">,</span>&nbsp;<span class="ident" id="5213000">rightRunes</span><span class="op" id="5213010">,</span>&nbsp;<span class="ident" id="5213012">rightPC</span><span class="op" id="5213019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213023">case</span>&nbsp;<span class="op" id="5213028">(</span><span class="op" id="5213029">*</span><span class="ident" id="5213030">rightRunes</span><span class="op" id="5213040">)</span><span class="op" id="5213041">[</span><span class="ident" id="5213042">rx</span><span class="op" id="5213044">]</span>&nbsp;<span class="op" id="5213046">&lt;</span>&nbsp;<span class="op" id="5213048">(</span><span class="op" id="5213049">*</span><span class="ident" id="5213050">leftRunes</span><span class="op" id="5213059">)</span><span class="op" id="5213060">[</span><span class="ident" id="5213061">lx</span><span class="op" id="5213063">]</span><span class="op" id="5213064">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213069">ok</span>&nbsp;<span class="op" id="5213072">=</span>&nbsp;<span class="ident" id="5213074">extend</span><span class="op" id="5213080">(</span><span class="op" id="5213081">&amp;</span><span class="ident" id="5213082">rx</span><span class="op" id="5213084">,</span>&nbsp;<span class="ident" id="5213086">rightRunes</span><span class="op" id="5213096">,</span>&nbsp;<span class="ident" id="5213098">rightPC</span><span class="op" id="5213105">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213109">default</span><span class="op" id="5213116">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213121">ok</span>&nbsp;<span class="op" id="5213124">=</span>&nbsp;<span class="ident" id="5213126">extend</span><span class="op" id="5213132">(</span><span class="op" id="5213133">&amp;</span><span class="ident" id="5213134">lx</span><span class="op" id="5213136">,</span>&nbsp;<span class="ident" id="5213138">leftRunes</span><span class="op" id="5213147">,</span>&nbsp;<span class="ident" id="5213149">leftPC</span><span class="op" id="5213155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5213159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213163">if</span>&nbsp;<span class="op" id="5213166">!</span><span class="ident" id="5213167">ok</span>&nbsp;<span class="op" id="5213170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213175">return</span>&nbsp;<span class="ident" id="5213182">noRune</span><span class="op" id="5213188">,</span>&nbsp;<span class="ident" id="5213190">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5213199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5213202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213205">return</span>&nbsp;<span class="ident" id="5213212">merged</span><span class="op" id="5213218">,</span>&nbsp;<span class="ident" id="5213220">next</span><br>
<span class="lineno"></span><span class="op" id="5213225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment" id="5213228">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword" id="5213312">func</span>&nbsp;<span class="ident" id="5213317">cleanupOnePass</span><span class="op" id="5213331">(</span><span class="ident" id="5213332">prog</span>&nbsp;<span class="op" id="5213337">*</span><span class="ident" id="5213338">onePassProg</span><span class="op" id="5213349">,</span>&nbsp;<span class="ident" id="5213351">original</span>&nbsp;<span class="op" id="5213360">*</span><span class="ident" id="5213361">syntax</span><span class="op" id="5213367">.</span><span class="ident" id="5213368">Prog</span><span class="op" id="5213372">)</span>&nbsp;<span class="op" id="5213374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213377">for</span>&nbsp;<span class="ident" id="5213381">ix</span><span class="op" id="5213383">,</span>&nbsp;<span class="ident" id="5213385">instOriginal</span>&nbsp;<span class="op" id="5213398">:=</span>&nbsp;<span class="keyword" id="5213401">range</span>&nbsp;<span class="ident" id="5213407">original</span><span class="op" id="5213415">.</span><span class="ident" id="5213416">Inst</span>&nbsp;<span class="op" id="5213421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213425">switch</span>&nbsp;<span class="ident" id="5213432">instOriginal</span><span class="op" id="5213444">.</span><span class="ident" id="5213445">Op</span>&nbsp;<span class="op" id="5213448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213452">case</span>&nbsp;<span class="ident" id="5213457">syntax</span><span class="op" id="5213463">.</span><span class="ident" id="5213464">InstAlt</span><span class="op" id="5213471">,</span>&nbsp;<span class="ident" id="5213473">syntax</span><span class="op" id="5213479">.</span><span class="ident" id="5213480">InstAltMatch</span><span class="op" id="5213492">,</span>&nbsp;<span class="ident" id="5213494">syntax</span><span class="op" id="5213500">.</span><span class="ident" id="5213501">InstRune</span><span class="op" id="5213509">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213513">case</span>&nbsp;<span class="ident" id="5213518">syntax</span><span class="op" id="5213524">.</span><span class="ident" id="5213525">InstCapture</span><span class="op" id="5213536">,</span>&nbsp;<span class="ident" id="5213538">syntax</span><span class="op" id="5213544">.</span><span class="ident" id="5213545">InstEmptyWidth</span><span class="op" id="5213559">,</span>&nbsp;<span class="ident" id="5213561">syntax</span><span class="op" id="5213567">.</span><span class="ident" id="5213568">InstNop</span><span class="op" id="5213575">,</span>&nbsp;<span class="ident" id="5213577">syntax</span><span class="op" id="5213583">.</span><span class="ident" id="5213584">InstMatch</span><span class="op" id="5213593">,</span>&nbsp;<span class="ident" id="5213595">syntax</span><span class="op" id="5213601">.</span><span class="ident" id="5213602">InstFail</span><span class="op" id="5213610">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213615">prog</span><span class="op" id="5213619">.</span><span class="ident" id="5213620">Inst</span><span class="op" id="5213624">[</span><span class="ident" id="5213625">ix</span><span class="op" id="5213627">]</span><span class="op" id="5213628">.</span><span class="ident" id="5213629">Next</span>&nbsp;<span class="op" id="5213634">=</span>&nbsp;<span class="ident" id="5213636">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213642">case</span>&nbsp;<span class="ident" id="5213647">syntax</span><span class="op" id="5213653">.</span><span class="ident" id="5213654">InstRune1</span><span class="op" id="5213663">,</span>&nbsp;<span class="ident" id="5213665">syntax</span><span class="op" id="5213671">.</span><span class="ident" id="5213672">InstRuneAny</span><span class="op" id="5213683">,</span>&nbsp;<span class="ident" id="5213685">syntax</span><span class="op" id="5213691">.</span><span class="ident" id="5213692">InstRuneAnyNotNL</span><span class="op" id="5213708">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213713">prog</span><span class="op" id="5213717">.</span><span class="ident" id="5213718">Inst</span><span class="op" id="5213722">[</span><span class="ident" id="5213723">ix</span><span class="op" id="5213725">]</span><span class="op" id="5213726">.</span><span class="ident" id="5213727">Next</span>&nbsp;<span class="op" id="5213732">=</span>&nbsp;<span class="ident" id="5213734">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213741">prog</span><span class="op" id="5213745">.</span><span class="ident" id="5213746">Inst</span><span class="op" id="5213750">[</span><span class="ident" id="5213751">ix</span><span class="op" id="5213753">]</span>&nbsp;<span class="op" id="5213755">=</span>&nbsp;<span class="ident" id="5213757">onePassInst</span><span class="op" id="5213768">{</span><span class="ident" id="5213769">Inst</span><span class="op" id="5213773">:</span>&nbsp;<span class="ident" id="5213775">instOriginal</span><span class="op" id="5213787">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5213791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5213794">}</span><br>
<span class="lineno"></span><span class="op" id="5213796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5213799">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword" id="5213876">func</span>&nbsp;<span class="ident" id="5213881">onePassCopy</span><span class="op" id="5213892">(</span><span class="ident" id="5213893">prog</span>&nbsp;<span class="op" id="5213898">*</span><span class="ident" id="5213899">syntax</span><span class="op" id="5213905">.</span><span class="ident" id="5213906">Prog</span><span class="op" id="5213910">)</span>&nbsp;<span class="op" id="5213912">*</span><span class="ident" id="5213913">onePassProg</span>&nbsp;<span class="op" id="5213925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213928">p</span>&nbsp;<span class="op" id="5213930">:=</span>&nbsp;<span class="op" id="5213933">&amp;</span><span class="ident" id="5213934">onePassProg</span><span class="op" id="5213945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213949">Start</span><span class="op" id="5213954">:</span>&nbsp;&nbsp;<span class="ident" id="5213957">prog</span><span class="op" id="5213961">.</span><span class="ident" id="5213962">Start</span><span class="op" id="5213967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5213971">NumCap</span><span class="op" id="5213977">:</span>&nbsp;<span class="ident" id="5213979">prog</span><span class="op" id="5213983">.</span><span class="ident" id="5213984">NumCap</span><span class="op" id="5213990">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5213993">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5213996">for</span>&nbsp;<span class="ident" id="5214000">_</span><span class="op" id="5214001">,</span>&nbsp;<span class="ident" id="5214003">inst</span>&nbsp;<span class="op" id="5214008">:=</span>&nbsp;<span class="keyword" id="5214011">range</span>&nbsp;<span class="ident" id="5214017">prog</span><span class="op" id="5214021">.</span><span class="ident" id="5214022">Inst</span>&nbsp;<span class="op" id="5214027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214031">p</span><span class="op" id="5214032">.</span><span class="ident" id="5214033">Inst</span>&nbsp;<span class="op" id="5214038">=</span>&nbsp;<span class="builtinfunc" id="5214040">append</span><span class="op" id="5214046">(</span><span class="ident" id="5214047">p</span><span class="op" id="5214048">.</span><span class="ident" id="5214049">Inst</span><span class="op" id="5214053">,</span>&nbsp;<span class="ident" id="5214055">onePassInst</span><span class="op" id="5214066">{</span><span class="ident" id="5214067">Inst</span><span class="op" id="5214071">:</span>&nbsp;<span class="ident" id="5214073">inst</span><span class="op" id="5214077">}</span><span class="op" id="5214078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5214081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214085">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214160">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214236">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214272">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214303">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214334">for</span>&nbsp;<span class="ident" id="5214338">pc</span>&nbsp;<span class="op" id="5214341">:=</span>&nbsp;<span class="keyword" id="5214344">range</span>&nbsp;<span class="ident" id="5214350">p</span><span class="op" id="5214351">.</span><span class="ident" id="5214352">Inst</span>&nbsp;<span class="op" id="5214357">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214361">switch</span>&nbsp;<span class="ident" id="5214368">p</span><span class="op" id="5214369">.</span><span class="ident" id="5214370">Inst</span><span class="op" id="5214374">[</span><span class="ident" id="5214375">pc</span><span class="op" id="5214377">]</span><span class="op" id="5214378">.</span><span class="ident" id="5214379">Op</span>&nbsp;<span class="op" id="5214382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214386">default</span><span class="op" id="5214393">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214398">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214409">case</span>&nbsp;<span class="ident" id="5214414">syntax</span><span class="op" id="5214420">.</span><span class="ident" id="5214421">InstAlt</span><span class="op" id="5214428">,</span>&nbsp;<span class="ident" id="5214430">syntax</span><span class="op" id="5214436">.</span><span class="ident" id="5214437">InstAltMatch</span><span class="op" id="5214449">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214454">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214472">p_A_Other</span>&nbsp;<span class="op" id="5214482">:=</span>&nbsp;<span class="op" id="5214485">&amp;</span><span class="ident" id="5214486">p</span><span class="op" id="5214487">.</span><span class="ident" id="5214488">Inst</span><span class="op" id="5214492">[</span><span class="ident" id="5214493">pc</span><span class="op" id="5214495">]</span><span class="op" id="5214496">.</span><span class="ident" id="5214497">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214504">p_A_Alt</span>&nbsp;<span class="op" id="5214512">:=</span>&nbsp;<span class="op" id="5214515">&amp;</span><span class="ident" id="5214516">p</span><span class="op" id="5214517">.</span><span class="ident" id="5214518">Inst</span><span class="op" id="5214522">[</span><span class="ident" id="5214523">pc</span><span class="op" id="5214525">]</span><span class="op" id="5214526">.</span><span class="ident" id="5214527">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214534">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214574">instAlt</span>&nbsp;<span class="op" id="5214582">:=</span>&nbsp;<span class="ident" id="5214585">p</span><span class="op" id="5214586">.</span><span class="ident" id="5214587">Inst</span><span class="op" id="5214591">[</span><span class="op" id="5214592">*</span><span class="ident" id="5214593">p_A_Alt</span><span class="op" id="5214600">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214605">if</span>&nbsp;<span class="op" id="5214608">!</span><span class="op" id="5214609">(</span><span class="ident" id="5214610">instAlt</span><span class="op" id="5214617">.</span><span class="ident" id="5214618">Op</span>&nbsp;<span class="op" id="5214621">==</span>&nbsp;<span class="ident" id="5214624">syntax</span><span class="op" id="5214630">.</span><span class="ident" id="5214631">InstAlt</span>&nbsp;<span class="op" id="5214639">||</span>&nbsp;<span class="ident" id="5214642">instAlt</span><span class="op" id="5214649">.</span><span class="ident" id="5214650">Op</span>&nbsp;<span class="op" id="5214653">==</span>&nbsp;<span class="ident" id="5214656">syntax</span><span class="op" id="5214662">.</span><span class="ident" id="5214663">InstAltMatch</span><span class="op" id="5214675">)</span>&nbsp;<span class="op" id="5214677">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214683">p_A_Alt</span><span class="op" id="5214690">,</span>&nbsp;<span class="ident" id="5214692">p_A_Other</span>&nbsp;<span class="op" id="5214702">=</span>&nbsp;<span class="ident" id="5214704">p_A_Other</span><span class="op" id="5214713">,</span>&nbsp;<span class="ident" id="5214715">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214727">instAlt</span>&nbsp;<span class="op" id="5214735">=</span>&nbsp;<span class="ident" id="5214737">p</span><span class="op" id="5214738">.</span><span class="ident" id="5214739">Inst</span><span class="op" id="5214743">[</span><span class="op" id="5214744">*</span><span class="ident" id="5214745">p_A_Alt</span><span class="op" id="5214752">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214758">if</span>&nbsp;<span class="op" id="5214761">!</span><span class="op" id="5214762">(</span><span class="ident" id="5214763">instAlt</span><span class="op" id="5214770">.</span><span class="ident" id="5214771">Op</span>&nbsp;<span class="op" id="5214774">==</span>&nbsp;<span class="ident" id="5214777">syntax</span><span class="op" id="5214783">.</span><span class="ident" id="5214784">InstAlt</span>&nbsp;<span class="op" id="5214792">||</span>&nbsp;<span class="ident" id="5214795">instAlt</span><span class="op" id="5214802">.</span><span class="ident" id="5214803">Op</span>&nbsp;<span class="op" id="5214806">==</span>&nbsp;<span class="ident" id="5214809">syntax</span><span class="op" id="5214815">.</span><span class="ident" id="5214816">InstAltMatch</span><span class="op" id="5214828">)</span>&nbsp;<span class="op" id="5214830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214837">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5214850">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5214855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5214860">instOther</span>&nbsp;<span class="op" id="5214870">:=</span>&nbsp;<span class="ident" id="5214873">p</span><span class="op" id="5214874">.</span><span class="ident" id="5214875">Inst</span><span class="op" id="5214879">[</span><span class="op" id="5214880">*</span><span class="ident" id="5214881">p_A_Other</span><span class="op" id="5214890">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5214895">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5214957">if</span>&nbsp;<span class="ident" id="5214960">instOther</span><span class="op" id="5214969">.</span><span class="ident" id="5214970">Op</span>&nbsp;<span class="op" id="5214973">==</span>&nbsp;<span class="ident" id="5214976">syntax</span><span class="op" id="5214982">.</span><span class="ident" id="5214983">InstAlt</span>&nbsp;<span class="op" id="5214991">||</span>&nbsp;<span class="ident" id="5214994">instOther</span><span class="op" id="5215003">.</span><span class="ident" id="5215004">Op</span>&nbsp;<span class="op" id="5215007">==</span>&nbsp;<span class="ident" id="5215010">syntax</span><span class="op" id="5215016">.</span><span class="ident" id="5215017">InstAltMatch</span>&nbsp;<span class="op" id="5215030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215036">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215059">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215076">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215111">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215144">p_B_Alt</span>&nbsp;<span class="op" id="5215152">:=</span>&nbsp;<span class="op" id="5215155">&amp;</span><span class="ident" id="5215156">p</span><span class="op" id="5215157">.</span><span class="ident" id="5215158">Inst</span><span class="op" id="5215162">[</span><span class="op" id="5215163">*</span><span class="ident" id="5215164">p_A_Alt</span><span class="op" id="5215171">]</span><span class="op" id="5215172">.</span><span class="ident" id="5215173">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215180">p_B_Other</span>&nbsp;<span class="op" id="5215190">:=</span>&nbsp;<span class="op" id="5215193">&amp;</span><span class="ident" id="5215194">p</span><span class="op" id="5215195">.</span><span class="ident" id="5215196">Inst</span><span class="op" id="5215200">[</span><span class="op" id="5215201">*</span><span class="ident" id="5215202">p_A_Alt</span><span class="op" id="5215209">]</span><span class="op" id="5215210">.</span><span class="ident" id="5215211">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215218">patch</span>&nbsp;<span class="op" id="5215224">:=</span>&nbsp;<span class="builtintype" id="5215227">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215236">if</span>&nbsp;<span class="ident" id="5215239">instAlt</span><span class="op" id="5215246">.</span><span class="ident" id="5215247">Out</span>&nbsp;<span class="op" id="5215251">==</span>&nbsp;<span class="builtintype" id="5215254">uint32</span><span class="op" id="5215260">(</span><span class="ident" id="5215261">pc</span><span class="op" id="5215263">)</span>&nbsp;<span class="op" id="5215265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215271">patch</span>&nbsp;<span class="op" id="5215277">=</span>&nbsp;<span class="builtintype" id="5215279">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215287">}</span>&nbsp;<span class="keyword" id="5215289">else</span>&nbsp;<span class="keyword" id="5215294">if</span>&nbsp;<span class="ident" id="5215297">instAlt</span><span class="op" id="5215304">.</span><span class="ident" id="5215305">Arg</span>&nbsp;<span class="op" id="5215309">==</span>&nbsp;<span class="builtintype" id="5215312">uint32</span><span class="op" id="5215318">(</span><span class="ident" id="5215319">pc</span><span class="op" id="5215321">)</span>&nbsp;<span class="op" id="5215323">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215329">patch</span>&nbsp;<span class="op" id="5215335">=</span>&nbsp;<span class="builtintype" id="5215337">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215346">p_B_Alt</span><span class="op" id="5215353">,</span>&nbsp;<span class="ident" id="5215355">p_B_Other</span>&nbsp;<span class="op" id="5215365">=</span>&nbsp;<span class="ident" id="5215367">p_B_Other</span><span class="op" id="5215376">,</span>&nbsp;<span class="ident" id="5215378">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215394">if</span>&nbsp;<span class="ident" id="5215397">patch</span>&nbsp;<span class="op" id="5215403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215409">*</span><span class="ident" id="5215410">p_B_Alt</span>&nbsp;<span class="op" id="5215418">=</span>&nbsp;<span class="op" id="5215420">*</span><span class="ident" id="5215421">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215440">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5215480">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215513">if</span>&nbsp;<span class="op" id="5215516">*</span><span class="ident" id="5215517">p_A_Other</span>&nbsp;<span class="op" id="5215527">==</span>&nbsp;<span class="op" id="5215530">*</span><span class="ident" id="5215531">p_B_Alt</span>&nbsp;<span class="op" id="5215539">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215545">*</span><span class="ident" id="5215546">p_A_Alt</span>&nbsp;<span class="op" id="5215554">=</span>&nbsp;<span class="op" id="5215556">*</span><span class="ident" id="5215557">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5215577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5215580">return</span>&nbsp;<span class="ident" id="5215587">p</span><br>
<span class="lineno">280</span><span class="op" id="5215589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5215592">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword" id="5215657">type</span>&nbsp;<span class="ident" id="5215662">runeSlice</span>&nbsp;<span class="op" id="5215672">[</span><span class="op" id="5215673">]</span><span class="builtintype" id="5215674">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5215680">func</span>&nbsp;<span class="op" id="5215685">(</span><span class="ident" id="5215686">p</span>&nbsp;<span class="ident" id="5215688">runeSlice</span><span class="op" id="5215697">)</span>&nbsp;<span class="ident" id="5215699">Len</span><span class="op" id="5215702">(</span><span class="op" id="5215703">)</span>&nbsp;<span class="builtintype" id="5215705">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5215719">{</span>&nbsp;<span class="keyword" id="5215721">return</span>&nbsp;<span class="builtinfunc" id="5215728">len</span><span class="op" id="5215731">(</span><span class="ident" id="5215732">p</span><span class="op" id="5215733">)</span>&nbsp;<span class="op" id="5215735">}</span><br>
<span class="lineno"></span><span class="keyword" id="5215737">func</span>&nbsp;<span class="op" id="5215742">(</span><span class="ident" id="5215743">p</span>&nbsp;<span class="ident" id="5215745">runeSlice</span><span class="op" id="5215754">)</span>&nbsp;<span class="ident" id="5215756">Less</span><span class="op" id="5215760">(</span><span class="ident" id="5215761">i</span><span class="op" id="5215762">,</span>&nbsp;<span class="ident" id="5215764">j</span>&nbsp;<span class="builtintype" id="5215766">int</span><span class="op" id="5215769">)</span>&nbsp;<span class="builtintype" id="5215771">bool</span>&nbsp;<span class="op" id="5215776">{</span>&nbsp;<span class="keyword" id="5215778">return</span>&nbsp;<span class="ident" id="5215785">p</span><span class="op" id="5215786">[</span><span class="ident" id="5215787">i</span><span class="op" id="5215788">]</span>&nbsp;<span class="op" id="5215790">&lt;</span>&nbsp;<span class="ident" id="5215792">p</span><span class="op" id="5215793">[</span><span class="ident" id="5215794">j</span><span class="op" id="5215795">]</span>&nbsp;<span class="op" id="5215797">}</span><br>
<span class="lineno"></span><span class="keyword" id="5215799">func</span>&nbsp;<span class="op" id="5215804">(</span><span class="ident" id="5215805">p</span>&nbsp;<span class="ident" id="5215807">runeSlice</span><span class="op" id="5215816">)</span>&nbsp;<span class="ident" id="5215818">Swap</span><span class="op" id="5215822">(</span><span class="ident" id="5215823">i</span><span class="op" id="5215824">,</span>&nbsp;<span class="ident" id="5215826">j</span>&nbsp;<span class="builtintype" id="5215828">int</span><span class="op" id="5215831">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5215838">{</span>&nbsp;<span class="ident" id="5215840">p</span><span class="op" id="5215841">[</span><span class="ident" id="5215842">i</span><span class="op" id="5215843">]</span><span class="op" id="5215844">,</span>&nbsp;<span class="ident" id="5215846">p</span><span class="op" id="5215847">[</span><span class="ident" id="5215848">j</span><span class="op" id="5215849">]</span>&nbsp;<span class="op" id="5215851">=</span>&nbsp;<span class="ident" id="5215853">p</span><span class="op" id="5215854">[</span><span class="ident" id="5215855">j</span><span class="op" id="5215856">]</span><span class="op" id="5215857">,</span>&nbsp;<span class="ident" id="5215859">p</span><span class="op" id="5215860">[</span><span class="ident" id="5215861">i</span><span class="op" id="5215862">]</span>&nbsp;<span class="op" id="5215864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5215867">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword" id="5215900">func</span>&nbsp;<span class="op" id="5215905">(</span><span class="ident" id="5215906">p</span>&nbsp;<span class="ident" id="5215908">runeSlice</span><span class="op" id="5215917">)</span>&nbsp;<span class="ident" id="5215919">Sort</span><span class="op" id="5215923">(</span><span class="op" id="5215924">)</span>&nbsp;<span class="op" id="5215926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5215929">sort</span><span class="op" id="5215933">.</span><span class="ident" id="5215934">Sort</span><span class="op" id="5215938">(</span><span class="ident" id="5215939">p</span><span class="op" id="5215940">)</span><br>
<span class="lineno"></span><span class="op" id="5215942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5215945">var</span>&nbsp;<span class="ident" id="5215949">anyRuneNotNL</span>&nbsp;<span class="op" id="5215962">=</span>&nbsp;<span class="op" id="5215964">[</span><span class="op" id="5215965">]</span><span class="builtintype" id="5215966">rune</span><span class="op" id="5215970">{</span><span class="num" id="5215971">0</span><span class="op" id="5215972">,</span>&nbsp;<span class="string" id="5215974">&#39;\n&#39;</span>&nbsp;<span class="op" id="5215979">-</span>&nbsp;<span class="num" id="5215981">1</span><span class="op" id="5215982">,</span>&nbsp;<span class="string" id="5215984">&#39;\n&#39;</span>&nbsp;<span class="op" id="5215989">+</span>&nbsp;<span class="num" id="5215991">1</span><span class="op" id="5215992">,</span>&nbsp;<span class="ident" id="5215994">unicode</span><span class="op" id="5216001">.</span><span class="ident" id="5216002">MaxRune</span><span class="op" id="5216009">}</span><br>
<span class="lineno">295</span><span class="keyword" id="5216011">var</span>&nbsp;<span class="ident" id="5216015">anyRune</span>&nbsp;<span class="op" id="5216023">=</span>&nbsp;<span class="op" id="5216025">[</span><span class="op" id="5216026">]</span><span class="builtintype" id="5216027">rune</span><span class="op" id="5216031">{</span><span class="num" id="5216032">0</span><span class="op" id="5216033">,</span>&nbsp;<span class="ident" id="5216035">unicode</span><span class="op" id="5216042">.</span><span class="ident" id="5216043">MaxRune</span><span class="op" id="5216050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5216053">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment" id="5216135">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment" id="5216216">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment" id="5216296">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment" id="5216371">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword" id="5216399">func</span>&nbsp;<span class="ident" id="5216404">makeOnePass</span><span class="op" id="5216415">(</span><span class="ident" id="5216416">p</span>&nbsp;<span class="op" id="5216418">*</span><span class="ident" id="5216419">onePassProg</span><span class="op" id="5216430">)</span>&nbsp;<span class="op" id="5216432">*</span><span class="ident" id="5216433">onePassProg</span>&nbsp;<span class="op" id="5216445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5216448">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216538">if</span>&nbsp;<span class="builtinfunc" id="5216541">len</span><span class="op" id="5216544">(</span><span class="ident" id="5216545">p</span><span class="op" id="5216546">.</span><span class="ident" id="5216547">Inst</span><span class="op" id="5216551">)</span>&nbsp;<span class="op" id="5216553">&gt;=</span>&nbsp;<span class="num" id="5216556">1000</span>&nbsp;<span class="op" id="5216561">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216565">return</span>&nbsp;<span class="ident" id="5216572">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5216584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216588">var</span>&nbsp;<span class="op" id="5216592">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216596">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5216609">=</span>&nbsp;<span class="ident" id="5216611">newQueue</span><span class="op" id="5216619">(</span><span class="builtinfunc" id="5216620">len</span><span class="op" id="5216623">(</span><span class="ident" id="5216624">p</span><span class="op" id="5216625">.</span><span class="ident" id="5216626">Inst</span><span class="op" id="5216630">)</span><span class="op" id="5216631">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216635">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5216648">=</span>&nbsp;<span class="ident" id="5216650">newQueue</span><span class="op" id="5216658">(</span><span class="builtinfunc" id="5216659">len</span><span class="op" id="5216662">(</span><span class="ident" id="5216663">p</span><span class="op" id="5216664">.</span><span class="ident" id="5216665">Inst</span><span class="op" id="5216669">)</span><span class="op" id="5216670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216674">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5216687">func</span><span class="op" id="5216691">(</span><span class="builtintype" id="5216692">uint32</span><span class="op" id="5216698">,</span>&nbsp;<span class="op" id="5216700">*</span><span class="ident" id="5216701">queueOnePass</span><span class="op" id="5216713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216717">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5216730">func</span><span class="op" id="5216734">(</span><span class="builtintype" id="5216735">uint32</span><span class="op" id="5216741">,</span>&nbsp;<span class="keyword" id="5216743">map</span><span class="op" id="5216746">[</span><span class="builtintype" id="5216747">uint32</span><span class="op" id="5216753">]</span><span class="builtintype" id="5216754">bool</span><span class="op" id="5216758">)</span>&nbsp;<span class="builtintype" id="5216760">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216767">onePassRunes</span>&nbsp;<span class="op" id="5216780">=</span>&nbsp;<span class="builtinfunc" id="5216782">make</span><span class="op" id="5216786">(</span><span class="op" id="5216787">[</span><span class="op" id="5216788">]</span><span class="op" id="5216789">[</span><span class="op" id="5216790">]</span><span class="builtintype" id="5216791">rune</span><span class="op" id="5216795">,</span>&nbsp;<span class="builtinfunc" id="5216797">len</span><span class="op" id="5216800">(</span><span class="ident" id="5216801">p</span><span class="op" id="5216802">.</span><span class="ident" id="5216803">Inst</span><span class="op" id="5216807">)</span><span class="op" id="5216808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5216811">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216814">build</span>&nbsp;<span class="op" id="5216820">=</span>&nbsp;<span class="keyword" id="5216822">func</span><span class="op" id="5216826">(</span><span class="ident" id="5216827">pc</span>&nbsp;<span class="builtintype" id="5216830">uint32</span><span class="op" id="5216836">,</span>&nbsp;<span class="ident" id="5216838">q</span>&nbsp;<span class="op" id="5216840">*</span><span class="ident" id="5216841">queueOnePass</span><span class="op" id="5216853">)</span>&nbsp;<span class="op" id="5216855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216859">if</span>&nbsp;<span class="ident" id="5216862">q</span><span class="op" id="5216863">.</span><span class="ident" id="5216864">contains</span><span class="op" id="5216872">(</span><span class="ident" id="5216873">pc</span><span class="op" id="5216875">)</span>&nbsp;<span class="op" id="5216877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216882">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5216891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216895">inst</span>&nbsp;<span class="op" id="5216900">:=</span>&nbsp;<span class="ident" id="5216903">p</span><span class="op" id="5216904">.</span><span class="ident" id="5216905">Inst</span><span class="op" id="5216909">[</span><span class="ident" id="5216910">pc</span><span class="op" id="5216912">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216916">switch</span>&nbsp;<span class="ident" id="5216923">inst</span><span class="op" id="5216927">.</span><span class="ident" id="5216928">Op</span>&nbsp;<span class="op" id="5216931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5216935">case</span>&nbsp;<span class="ident" id="5216940">syntax</span><span class="op" id="5216946">.</span><span class="ident" id="5216947">InstAlt</span><span class="op" id="5216954">,</span>&nbsp;<span class="ident" id="5216956">syntax</span><span class="op" id="5216962">.</span><span class="ident" id="5216963">InstAltMatch</span><span class="op" id="5216975">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5216980">q</span><span class="op" id="5216981">.</span><span class="ident" id="5216982">insert</span><span class="op" id="5216988">(</span><span class="ident" id="5216989">inst</span><span class="op" id="5216993">.</span><span class="ident" id="5216994">Out</span><span class="op" id="5216997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217002">build</span><span class="op" id="5217007">(</span><span class="ident" id="5217008">inst</span><span class="op" id="5217012">.</span><span class="ident" id="5217013">Out</span><span class="op" id="5217016">,</span>&nbsp;<span class="ident" id="5217018">q</span><span class="op" id="5217019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217024">q</span><span class="op" id="5217025">.</span><span class="ident" id="5217026">insert</span><span class="op" id="5217032">(</span><span class="ident" id="5217033">inst</span><span class="op" id="5217037">.</span><span class="ident" id="5217038">Arg</span><span class="op" id="5217041">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217045">case</span>&nbsp;<span class="ident" id="5217050">syntax</span><span class="op" id="5217056">.</span><span class="ident" id="5217057">InstMatch</span><span class="op" id="5217066">,</span>&nbsp;<span class="ident" id="5217068">syntax</span><span class="op" id="5217074">.</span><span class="ident" id="5217075">InstFail</span><span class="op" id="5217083">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217087">default</span><span class="op" id="5217094">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217099">q</span><span class="op" id="5217100">.</span><span class="ident" id="5217101">insert</span><span class="op" id="5217107">(</span><span class="ident" id="5217108">inst</span><span class="op" id="5217112">.</span><span class="ident" id="5217113">Out</span><span class="op" id="5217116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217123">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5217127">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5217207">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217240">check</span>&nbsp;<span class="op" id="5217246">=</span>&nbsp;<span class="keyword" id="5217248">func</span><span class="op" id="5217252">(</span><span class="ident" id="5217253">pc</span>&nbsp;<span class="builtintype" id="5217256">uint32</span><span class="op" id="5217262">,</span>&nbsp;<span class="ident" id="5217264">m</span>&nbsp;<span class="keyword" id="5217266">map</span><span class="op" id="5217269">[</span><span class="builtintype" id="5217270">uint32</span><span class="op" id="5217276">]</span><span class="builtintype" id="5217277">bool</span><span class="op" id="5217281">)</span>&nbsp;<span class="op" id="5217283">(</span><span class="ident" id="5217284">ok</span>&nbsp;<span class="builtintype" id="5217287">bool</span><span class="op" id="5217291">)</span>&nbsp;<span class="op" id="5217293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217297">ok</span>&nbsp;<span class="op" id="5217300">=</span>&nbsp;<span class="builtintype" id="5217302">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217309">inst</span>&nbsp;<span class="op" id="5217314">:=</span>&nbsp;<span class="op" id="5217317">&amp;</span><span class="ident" id="5217318">p</span><span class="op" id="5217319">.</span><span class="ident" id="5217320">Inst</span><span class="op" id="5217324">[</span><span class="ident" id="5217325">pc</span><span class="op" id="5217327">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217331">if</span>&nbsp;<span class="ident" id="5217334">visitQueue</span><span class="op" id="5217344">.</span><span class="ident" id="5217345">contains</span><span class="op" id="5217353">(</span><span class="ident" id="5217354">pc</span><span class="op" id="5217356">)</span>&nbsp;<span class="op" id="5217358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217363">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217376">visitQueue</span><span class="op" id="5217386">.</span><span class="ident" id="5217387">insert</span><span class="op" id="5217393">(</span><span class="ident" id="5217394">pc</span><span class="op" id="5217396">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217400">switch</span>&nbsp;<span class="ident" id="5217407">inst</span><span class="op" id="5217411">.</span><span class="ident" id="5217412">Op</span>&nbsp;<span class="op" id="5217415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217419">case</span>&nbsp;<span class="ident" id="5217424">syntax</span><span class="op" id="5217430">.</span><span class="ident" id="5217431">InstAlt</span><span class="op" id="5217438">,</span>&nbsp;<span class="ident" id="5217440">syntax</span><span class="op" id="5217446">.</span><span class="ident" id="5217447">InstAltMatch</span><span class="op" id="5217459">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217464">ok</span>&nbsp;<span class="op" id="5217467">=</span>&nbsp;<span class="ident" id="5217469">check</span><span class="op" id="5217474">(</span><span class="ident" id="5217475">inst</span><span class="op" id="5217479">.</span><span class="ident" id="5217480">Out</span><span class="op" id="5217483">,</span>&nbsp;<span class="ident" id="5217485">m</span><span class="op" id="5217486">)</span>&nbsp;<span class="op" id="5217488">&amp;&amp;</span>&nbsp;<span class="ident" id="5217491">check</span><span class="op" id="5217496">(</span><span class="ident" id="5217497">inst</span><span class="op" id="5217501">.</span><span class="ident" id="5217502">Arg</span><span class="op" id="5217505">,</span>&nbsp;<span class="ident" id="5217507">m</span><span class="op" id="5217508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5217513">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217553">matchOut</span>&nbsp;<span class="op" id="5217562">:=</span>&nbsp;<span class="ident" id="5217565">m</span><span class="op" id="5217566">[</span><span class="ident" id="5217567">inst</span><span class="op" id="5217571">.</span><span class="ident" id="5217572">Out</span><span class="op" id="5217575">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217580">matchArg</span>&nbsp;<span class="op" id="5217589">:=</span>&nbsp;<span class="ident" id="5217592">m</span><span class="op" id="5217593">[</span><span class="ident" id="5217594">inst</span><span class="op" id="5217598">.</span><span class="ident" id="5217599">Arg</span><span class="op" id="5217602">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217607">if</span>&nbsp;<span class="ident" id="5217610">matchOut</span>&nbsp;<span class="op" id="5217619">&amp;&amp;</span>&nbsp;<span class="ident" id="5217622">matchArg</span>&nbsp;<span class="op" id="5217631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217637">ok</span>&nbsp;<span class="op" id="5217640">=</span>&nbsp;<span class="builtintype" id="5217642">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217652">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217661">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5217666">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217704">if</span>&nbsp;<span class="ident" id="5217707">matchArg</span>&nbsp;<span class="op" id="5217716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217722">inst</span><span class="op" id="5217726">.</span><span class="ident" id="5217727">Out</span><span class="op" id="5217730">,</span>&nbsp;<span class="ident" id="5217732">inst</span><span class="op" id="5217736">.</span><span class="ident" id="5217737">Arg</span>&nbsp;<span class="op" id="5217741">=</span>&nbsp;<span class="ident" id="5217743">inst</span><span class="op" id="5217747">.</span><span class="ident" id="5217748">Arg</span><span class="op" id="5217751">,</span>&nbsp;<span class="ident" id="5217753">inst</span><span class="op" id="5217757">.</span><span class="ident" id="5217758">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217766">matchOut</span><span class="op" id="5217774">,</span>&nbsp;<span class="ident" id="5217776">matchArg</span>&nbsp;<span class="op" id="5217785">=</span>&nbsp;<span class="ident" id="5217787">matchArg</span><span class="op" id="5217795">,</span>&nbsp;<span class="ident" id="5217797">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217809">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5217814">if</span>&nbsp;<span class="ident" id="5217817">matchOut</span>&nbsp;<span class="op" id="5217826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217832">m</span><span class="op" id="5217833">[</span><span class="ident" id="5217834">pc</span><span class="op" id="5217836">]</span>&nbsp;<span class="op" id="5217838">=</span>&nbsp;<span class="builtintype" id="5217840">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217849">inst</span><span class="op" id="5217853">.</span><span class="ident" id="5217854">Op</span>&nbsp;<span class="op" id="5217857">=</span>&nbsp;<span class="ident" id="5217859">syntax</span><span class="op" id="5217865">.</span><span class="ident" id="5217866">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5217888">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5217950">onePassRunes</span><span class="op" id="5217962">[</span><span class="ident" id="5217963">pc</span><span class="op" id="5217965">]</span><span class="op" id="5217966">,</span>&nbsp;<span class="ident" id="5217968">inst</span><span class="op" id="5217972">.</span><span class="ident" id="5217973">Next</span>&nbsp;<span class="op" id="5217978">=</span>&nbsp;<span class="ident" id="5217980">mergeRuneSets</span><span class="op" id="5217993">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5217999">&amp;</span><span class="ident" id="5218000">onePassRunes</span><span class="op" id="5218012">[</span><span class="ident" id="5218013">inst</span><span class="op" id="5218017">.</span><span class="ident" id="5218018">Out</span><span class="op" id="5218021">]</span><span class="op" id="5218022">,</span>&nbsp;<span class="op" id="5218024">&amp;</span><span class="ident" id="5218025">onePassRunes</span><span class="op" id="5218037">[</span><span class="ident" id="5218038">inst</span><span class="op" id="5218042">.</span><span class="ident" id="5218043">Arg</span><span class="op" id="5218046">]</span><span class="op" id="5218047">,</span>&nbsp;<span class="ident" id="5218049">inst</span><span class="op" id="5218053">.</span><span class="ident" id="5218054">Out</span><span class="op" id="5218057">,</span>&nbsp;<span class="ident" id="5218059">inst</span><span class="op" id="5218063">.</span><span class="ident" id="5218064">Arg</span><span class="op" id="5218067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218072">if</span>&nbsp;<span class="builtinfunc" id="5218075">len</span><span class="op" id="5218078">(</span><span class="ident" id="5218079">inst</span><span class="op" id="5218083">.</span><span class="ident" id="5218084">Next</span><span class="op" id="5218088">)</span>&nbsp;<span class="op" id="5218090">&gt;</span>&nbsp;<span class="num" id="5218092">0</span>&nbsp;<span class="op" id="5218094">&amp;&amp;</span>&nbsp;<span class="ident" id="5218097">inst</span><span class="op" id="5218101">.</span><span class="ident" id="5218102">Next</span><span class="op" id="5218106">[</span><span class="num" id="5218107">0</span><span class="op" id="5218108">]</span>&nbsp;<span class="op" id="5218110">==</span>&nbsp;<span class="ident" id="5218113">mergeFailed</span>&nbsp;<span class="op" id="5218125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218131">ok</span>&nbsp;<span class="op" id="5218134">=</span>&nbsp;<span class="builtintype" id="5218136">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218146">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218159">case</span>&nbsp;<span class="ident" id="5218164">syntax</span><span class="op" id="5218170">.</span><span class="ident" id="5218171">InstCapture</span><span class="op" id="5218182">,</span>&nbsp;<span class="ident" id="5218184">syntax</span><span class="op" id="5218190">.</span><span class="ident" id="5218191">InstNop</span><span class="op" id="5218198">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218203">ok</span>&nbsp;<span class="op" id="5218206">=</span>&nbsp;<span class="ident" id="5218208">check</span><span class="op" id="5218213">(</span><span class="ident" id="5218214">inst</span><span class="op" id="5218218">.</span><span class="ident" id="5218219">Out</span><span class="op" id="5218222">,</span>&nbsp;<span class="ident" id="5218224">m</span><span class="op" id="5218225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218230">m</span><span class="op" id="5218231">[</span><span class="ident" id="5218232">pc</span><span class="op" id="5218234">]</span>&nbsp;<span class="op" id="5218236">=</span>&nbsp;<span class="ident" id="5218238">m</span><span class="op" id="5218239">[</span><span class="ident" id="5218240">inst</span><span class="op" id="5218244">.</span><span class="ident" id="5218245">Out</span><span class="op" id="5218248">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5218253">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218306">onePassRunes</span><span class="op" id="5218318">[</span><span class="ident" id="5218319">pc</span><span class="op" id="5218321">]</span>&nbsp;<span class="op" id="5218323">=</span>&nbsp;<span class="builtinfunc" id="5218325">append</span><span class="op" id="5218331">(</span><span class="op" id="5218332">[</span><span class="op" id="5218333">]</span><span class="builtintype" id="5218334">rune</span><span class="op" id="5218338">{</span><span class="op" id="5218339">}</span><span class="op" id="5218340">,</span>&nbsp;<span class="ident" id="5218342">onePassRunes</span><span class="op" id="5218354">[</span><span class="ident" id="5218355">inst</span><span class="op" id="5218359">.</span><span class="ident" id="5218360">Out</span><span class="op" id="5218363">]</span><span class="op" id="5218364">...</span><span class="op" id="5218367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218372">inst</span><span class="op" id="5218376">.</span><span class="ident" id="5218377">Next</span>&nbsp;<span class="op" id="5218382">=</span>&nbsp;<span class="op" id="5218384">[</span><span class="op" id="5218385">]</span><span class="builtintype" id="5218386">uint32</span><span class="op" id="5218392">{</span><span class="op" id="5218393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218398">for</span>&nbsp;<span class="ident" id="5218402">i</span>&nbsp;<span class="op" id="5218404">:=</span>&nbsp;<span class="builtinfunc" id="5218407">len</span><span class="op" id="5218410">(</span><span class="ident" id="5218411">onePassRunes</span><span class="op" id="5218423">[</span><span class="ident" id="5218424">pc</span><span class="op" id="5218426">]</span><span class="op" id="5218427">)</span>&nbsp;<span class="op" id="5218429">/</span>&nbsp;<span class="num" id="5218431">2</span><span class="op" id="5218432">;</span>&nbsp;<span class="ident" id="5218434">i</span>&nbsp;<span class="op" id="5218436">&gt;=</span>&nbsp;<span class="num" id="5218439">0</span><span class="op" id="5218440">;</span>&nbsp;<span class="ident" id="5218442">i</span><span class="op" id="5218443">--</span>&nbsp;<span class="op" id="5218446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218452">inst</span><span class="op" id="5218456">.</span><span class="ident" id="5218457">Next</span>&nbsp;<span class="op" id="5218462">=</span>&nbsp;<span class="builtinfunc" id="5218464">append</span><span class="op" id="5218470">(</span><span class="ident" id="5218471">inst</span><span class="op" id="5218475">.</span><span class="ident" id="5218476">Next</span><span class="op" id="5218480">,</span>&nbsp;<span class="ident" id="5218482">inst</span><span class="op" id="5218486">.</span><span class="ident" id="5218487">Out</span><span class="op" id="5218490">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218499">case</span>&nbsp;<span class="ident" id="5218504">syntax</span><span class="op" id="5218510">.</span><span class="ident" id="5218511">InstEmptyWidth</span><span class="op" id="5218525">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218530">ok</span>&nbsp;<span class="op" id="5218533">=</span>&nbsp;<span class="ident" id="5218535">check</span><span class="op" id="5218540">(</span><span class="ident" id="5218541">inst</span><span class="op" id="5218545">.</span><span class="ident" id="5218546">Out</span><span class="op" id="5218549">,</span>&nbsp;<span class="ident" id="5218551">m</span><span class="op" id="5218552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218557">m</span><span class="op" id="5218558">[</span><span class="ident" id="5218559">pc</span><span class="op" id="5218561">]</span>&nbsp;<span class="op" id="5218563">=</span>&nbsp;<span class="ident" id="5218565">m</span><span class="op" id="5218566">[</span><span class="ident" id="5218567">inst</span><span class="op" id="5218571">.</span><span class="ident" id="5218572">Out</span><span class="op" id="5218575">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218580">onePassRunes</span><span class="op" id="5218592">[</span><span class="ident" id="5218593">pc</span><span class="op" id="5218595">]</span>&nbsp;<span class="op" id="5218597">=</span>&nbsp;<span class="builtinfunc" id="5218599">append</span><span class="op" id="5218605">(</span><span class="op" id="5218606">[</span><span class="op" id="5218607">]</span><span class="builtintype" id="5218608">rune</span><span class="op" id="5218612">{</span><span class="op" id="5218613">}</span><span class="op" id="5218614">,</span>&nbsp;<span class="ident" id="5218616">onePassRunes</span><span class="op" id="5218628">[</span><span class="ident" id="5218629">inst</span><span class="op" id="5218633">.</span><span class="ident" id="5218634">Out</span><span class="op" id="5218637">]</span><span class="op" id="5218638">...</span><span class="op" id="5218641">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218646">inst</span><span class="op" id="5218650">.</span><span class="ident" id="5218651">Next</span>&nbsp;<span class="op" id="5218656">=</span>&nbsp;<span class="op" id="5218658">[</span><span class="op" id="5218659">]</span><span class="builtintype" id="5218660">uint32</span><span class="op" id="5218666">{</span><span class="op" id="5218667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218672">for</span>&nbsp;<span class="ident" id="5218676">i</span>&nbsp;<span class="op" id="5218678">:=</span>&nbsp;<span class="builtinfunc" id="5218681">len</span><span class="op" id="5218684">(</span><span class="ident" id="5218685">onePassRunes</span><span class="op" id="5218697">[</span><span class="ident" id="5218698">pc</span><span class="op" id="5218700">]</span><span class="op" id="5218701">)</span>&nbsp;<span class="op" id="5218703">/</span>&nbsp;<span class="num" id="5218705">2</span><span class="op" id="5218706">;</span>&nbsp;<span class="ident" id="5218708">i</span>&nbsp;<span class="op" id="5218710">&gt;=</span>&nbsp;<span class="num" id="5218713">0</span><span class="op" id="5218714">;</span>&nbsp;<span class="ident" id="5218716">i</span><span class="op" id="5218717">--</span>&nbsp;<span class="op" id="5218720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218726">inst</span><span class="op" id="5218730">.</span><span class="ident" id="5218731">Next</span>&nbsp;<span class="op" id="5218736">=</span>&nbsp;<span class="builtinfunc" id="5218738">append</span><span class="op" id="5218744">(</span><span class="ident" id="5218745">inst</span><span class="op" id="5218749">.</span><span class="ident" id="5218750">Next</span><span class="op" id="5218754">,</span>&nbsp;<span class="ident" id="5218756">inst</span><span class="op" id="5218760">.</span><span class="ident" id="5218761">Out</span><span class="op" id="5218764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218773">case</span>&nbsp;<span class="ident" id="5218778">syntax</span><span class="op" id="5218784">.</span><span class="ident" id="5218785">InstMatch</span><span class="op" id="5218794">,</span>&nbsp;<span class="ident" id="5218796">syntax</span><span class="op" id="5218802">.</span><span class="ident" id="5218803">InstFail</span><span class="op" id="5218811">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218816">m</span><span class="op" id="5218817">[</span><span class="ident" id="5218818">pc</span><span class="op" id="5218820">]</span>&nbsp;<span class="op" id="5218822">=</span>&nbsp;<span class="ident" id="5218824">inst</span><span class="op" id="5218828">.</span><span class="ident" id="5218829">Op</span>&nbsp;<span class="op" id="5218832">==</span>&nbsp;<span class="ident" id="5218835">syntax</span><span class="op" id="5218841">.</span><span class="ident" id="5218842">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218855">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218863">case</span>&nbsp;<span class="ident" id="5218868">syntax</span><span class="op" id="5218874">.</span><span class="ident" id="5218875">InstRune</span><span class="op" id="5218883">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218888">ok</span>&nbsp;<span class="op" id="5218891">=</span>&nbsp;<span class="ident" id="5218893">check</span><span class="op" id="5218898">(</span><span class="ident" id="5218899">inst</span><span class="op" id="5218903">.</span><span class="ident" id="5218904">Out</span><span class="op" id="5218907">,</span>&nbsp;<span class="ident" id="5218909">m</span><span class="op" id="5218910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5218915">m</span><span class="op" id="5218916">[</span><span class="ident" id="5218917">pc</span><span class="op" id="5218919">]</span>&nbsp;<span class="op" id="5218921">=</span>&nbsp;<span class="builtintype" id="5218923">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218932">if</span>&nbsp;<span class="builtinfunc" id="5218935">len</span><span class="op" id="5218938">(</span><span class="ident" id="5218939">inst</span><span class="op" id="5218943">.</span><span class="ident" id="5218944">Next</span><span class="op" id="5218948">)</span>&nbsp;<span class="op" id="5218950">&gt;</span>&nbsp;<span class="num" id="5218952">0</span>&nbsp;<span class="op" id="5218954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218960">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5218969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5218974">if</span>&nbsp;<span class="builtinfunc" id="5218977">len</span><span class="op" id="5218980">(</span><span class="ident" id="5218981">inst</span><span class="op" id="5218985">.</span><span class="ident" id="5218986">Rune</span><span class="op" id="5218990">)</span>&nbsp;<span class="op" id="5218992">==</span>&nbsp;<span class="num" id="5218995">0</span>&nbsp;<span class="op" id="5218997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219003">onePassRunes</span><span class="op" id="5219015">[</span><span class="ident" id="5219016">pc</span><span class="op" id="5219018">]</span>&nbsp;<span class="op" id="5219020">=</span>&nbsp;<span class="op" id="5219022">[</span><span class="op" id="5219023">]</span><span class="builtintype" id="5219024">rune</span><span class="op" id="5219028">{</span><span class="op" id="5219029">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219035">inst</span><span class="op" id="5219039">.</span><span class="ident" id="5219040">Next</span>&nbsp;<span class="op" id="5219045">=</span>&nbsp;<span class="op" id="5219047">[</span><span class="op" id="5219048">]</span><span class="builtintype" id="5219049">uint32</span><span class="op" id="5219055">{</span><span class="ident" id="5219056">inst</span><span class="op" id="5219060">.</span><span class="ident" id="5219061">Out</span><span class="op" id="5219064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219070">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219084">runes</span>&nbsp;<span class="op" id="5219090">:=</span>&nbsp;<span class="builtinfunc" id="5219093">make</span><span class="op" id="5219097">(</span><span class="op" id="5219098">[</span><span class="op" id="5219099">]</span><span class="builtintype" id="5219100">rune</span><span class="op" id="5219104">,</span>&nbsp;<span class="num" id="5219106">0</span><span class="op" id="5219107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219112">if</span>&nbsp;<span class="builtinfunc" id="5219115">len</span><span class="op" id="5219118">(</span><span class="ident" id="5219119">inst</span><span class="op" id="5219123">.</span><span class="ident" id="5219124">Rune</span><span class="op" id="5219128">)</span>&nbsp;<span class="op" id="5219130">==</span>&nbsp;<span class="num" id="5219133">1</span>&nbsp;<span class="op" id="5219135">&amp;&amp;</span>&nbsp;<span class="ident" id="5219138">syntax</span><span class="op" id="5219144">.</span><span class="ident" id="5219145">Flags</span><span class="op" id="5219150">(</span><span class="ident" id="5219151">inst</span><span class="op" id="5219155">.</span><span class="ident" id="5219156">Arg</span><span class="op" id="5219159">)</span><span class="op" id="5219160">&amp;</span><span class="ident" id="5219161">syntax</span><span class="op" id="5219167">.</span><span class="ident" id="5219168">FoldCase</span>&nbsp;<span class="op" id="5219177">!=</span>&nbsp;<span class="num" id="5219180">0</span>&nbsp;<span class="op" id="5219182">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219188">r0</span>&nbsp;<span class="op" id="5219191">:=</span>&nbsp;<span class="ident" id="5219194">inst</span><span class="op" id="5219198">.</span><span class="ident" id="5219199">Rune</span><span class="op" id="5219203">[</span><span class="num" id="5219204">0</span><span class="op" id="5219205">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219211">runes</span>&nbsp;<span class="op" id="5219217">=</span>&nbsp;<span class="builtinfunc" id="5219219">append</span><span class="op" id="5219225">(</span><span class="ident" id="5219226">runes</span><span class="op" id="5219231">,</span>&nbsp;<span class="ident" id="5219233">r0</span><span class="op" id="5219235">,</span>&nbsp;<span class="ident" id="5219237">r0</span><span class="op" id="5219239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219245">for</span>&nbsp;<span class="ident" id="5219249">r1</span>&nbsp;<span class="op" id="5219252">:=</span>&nbsp;<span class="ident" id="5219255">unicode</span><span class="op" id="5219262">.</span><span class="ident" id="5219263">SimpleFold</span><span class="op" id="5219273">(</span><span class="ident" id="5219274">r0</span><span class="op" id="5219276">)</span><span class="op" id="5219277">;</span>&nbsp;<span class="ident" id="5219279">r1</span>&nbsp;<span class="op" id="5219282">!=</span>&nbsp;<span class="ident" id="5219285">r0</span><span class="op" id="5219287">;</span>&nbsp;<span class="ident" id="5219289">r1</span>&nbsp;<span class="op" id="5219292">=</span>&nbsp;<span class="ident" id="5219294">unicode</span><span class="op" id="5219301">.</span><span class="ident" id="5219302">SimpleFold</span><span class="op" id="5219312">(</span><span class="ident" id="5219313">r1</span><span class="op" id="5219315">)</span>&nbsp;<span class="op" id="5219317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219324">runes</span>&nbsp;<span class="op" id="5219330">=</span>&nbsp;<span class="builtinfunc" id="5219332">append</span><span class="op" id="5219338">(</span><span class="ident" id="5219339">runes</span><span class="op" id="5219344">,</span>&nbsp;<span class="ident" id="5219346">r1</span><span class="op" id="5219348">,</span>&nbsp;<span class="ident" id="5219350">r1</span><span class="op" id="5219352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219358">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219364">sort</span><span class="op" id="5219368">.</span><span class="ident" id="5219369">Sort</span><span class="op" id="5219373">(</span><span class="ident" id="5219374">runeSlice</span><span class="op" id="5219383">(</span><span class="ident" id="5219384">runes</span><span class="op" id="5219389">)</span><span class="op" id="5219390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219395">}</span>&nbsp;<span class="keyword" id="5219397">else</span>&nbsp;<span class="op" id="5219402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219408">runes</span>&nbsp;<span class="op" id="5219414">=</span>&nbsp;<span class="builtinfunc" id="5219416">append</span><span class="op" id="5219422">(</span><span class="ident" id="5219423">runes</span><span class="op" id="5219428">,</span>&nbsp;<span class="ident" id="5219430">inst</span><span class="op" id="5219434">.</span><span class="ident" id="5219435">Rune</span><span class="op" id="5219439">...</span><span class="op" id="5219442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219452">onePassRunes</span><span class="op" id="5219464">[</span><span class="ident" id="5219465">pc</span><span class="op" id="5219467">]</span>&nbsp;<span class="op" id="5219469">=</span>&nbsp;<span class="ident" id="5219471">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219480">inst</span><span class="op" id="5219484">.</span><span class="ident" id="5219485">Next</span>&nbsp;<span class="op" id="5219490">=</span>&nbsp;<span class="op" id="5219492">[</span><span class="op" id="5219493">]</span><span class="builtintype" id="5219494">uint32</span><span class="op" id="5219500">{</span><span class="op" id="5219501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219506">for</span>&nbsp;<span class="ident" id="5219510">i</span>&nbsp;<span class="op" id="5219512">:=</span>&nbsp;<span class="builtinfunc" id="5219515">len</span><span class="op" id="5219518">(</span><span class="ident" id="5219519">onePassRunes</span><span class="op" id="5219531">[</span><span class="ident" id="5219532">pc</span><span class="op" id="5219534">]</span><span class="op" id="5219535">)</span>&nbsp;<span class="op" id="5219537">/</span>&nbsp;<span class="num" id="5219539">2</span><span class="op" id="5219540">;</span>&nbsp;<span class="ident" id="5219542">i</span>&nbsp;<span class="op" id="5219544">&gt;=</span>&nbsp;<span class="num" id="5219547">0</span><span class="op" id="5219548">;</span>&nbsp;<span class="ident" id="5219550">i</span><span class="op" id="5219551">--</span>&nbsp;<span class="op" id="5219554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219560">inst</span><span class="op" id="5219564">.</span><span class="ident" id="5219565">Next</span>&nbsp;<span class="op" id="5219570">=</span>&nbsp;<span class="builtinfunc" id="5219572">append</span><span class="op" id="5219578">(</span><span class="ident" id="5219579">inst</span><span class="op" id="5219583">.</span><span class="ident" id="5219584">Next</span><span class="op" id="5219588">,</span>&nbsp;<span class="ident" id="5219590">inst</span><span class="op" id="5219594">.</span><span class="ident" id="5219595">Out</span><span class="op" id="5219598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219608">inst</span><span class="op" id="5219612">.</span><span class="ident" id="5219613">Op</span>&nbsp;<span class="op" id="5219616">=</span>&nbsp;<span class="ident" id="5219618">syntax</span><span class="op" id="5219624">.</span><span class="ident" id="5219625">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219636">case</span>&nbsp;<span class="ident" id="5219641">syntax</span><span class="op" id="5219647">.</span><span class="ident" id="5219648">InstRune1</span><span class="op" id="5219657">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219662">ok</span>&nbsp;<span class="op" id="5219665">=</span>&nbsp;<span class="ident" id="5219667">check</span><span class="op" id="5219672">(</span><span class="ident" id="5219673">inst</span><span class="op" id="5219677">.</span><span class="ident" id="5219678">Out</span><span class="op" id="5219681">,</span>&nbsp;<span class="ident" id="5219683">m</span><span class="op" id="5219684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219689">m</span><span class="op" id="5219690">[</span><span class="ident" id="5219691">pc</span><span class="op" id="5219693">]</span>&nbsp;<span class="op" id="5219695">=</span>&nbsp;<span class="builtintype" id="5219697">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219706">if</span>&nbsp;<span class="builtinfunc" id="5219709">len</span><span class="op" id="5219712">(</span><span class="ident" id="5219713">inst</span><span class="op" id="5219717">.</span><span class="ident" id="5219718">Next</span><span class="op" id="5219722">)</span>&nbsp;<span class="op" id="5219724">&gt;</span>&nbsp;<span class="num" id="5219726">0</span>&nbsp;<span class="op" id="5219728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219734">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5219743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219748">runes</span>&nbsp;<span class="op" id="5219754">:=</span>&nbsp;<span class="op" id="5219757">[</span><span class="op" id="5219758">]</span><span class="builtintype" id="5219759">rune</span><span class="op" id="5219763">{</span><span class="op" id="5219764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5219769">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219800">if</span>&nbsp;<span class="ident" id="5219803">syntax</span><span class="op" id="5219809">.</span><span class="ident" id="5219810">Flags</span><span class="op" id="5219815">(</span><span class="ident" id="5219816">inst</span><span class="op" id="5219820">.</span><span class="ident" id="5219821">Arg</span><span class="op" id="5219824">)</span><span class="op" id="5219825">&amp;</span><span class="ident" id="5219826">syntax</span><span class="op" id="5219832">.</span><span class="ident" id="5219833">FoldCase</span>&nbsp;<span class="op" id="5219842">!=</span>&nbsp;<span class="num" id="5219845">0</span>&nbsp;<span class="op" id="5219847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219853">r0</span>&nbsp;<span class="op" id="5219856">:=</span>&nbsp;<span class="ident" id="5219859">inst</span><span class="op" id="5219863">.</span><span class="ident" id="5219864">Rune</span><span class="op" id="5219868">[</span><span class="num" id="5219869">0</span><span class="op" id="5219870">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219876">runes</span>&nbsp;<span class="op" id="5219882">=</span>&nbsp;<span class="builtinfunc" id="5219884">append</span><span class="op" id="5219890">(</span><span class="ident" id="5219891">runes</span><span class="op" id="5219896">,</span>&nbsp;<span class="ident" id="5219898">r0</span><span class="op" id="5219900">,</span>&nbsp;<span class="ident" id="5219902">r0</span><span class="op" id="5219904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5219910">for</span>&nbsp;<span class="ident" id="5219914">r1</span>&nbsp;<span class="op" id="5219917">:=</span>&nbsp;<span class="ident" id="5219920">unicode</span><span class="op" id="5219927">.</span><span class="ident" id="5219928">SimpleFold</span><span class="op" id="5219938">(</span><span class="ident" id="5219939">r0</span><span class="op" id="5219941">)</span><span class="op" id="5219942">;</span>&nbsp;<span class="ident" id="5219944">r1</span>&nbsp;<span class="op" id="5219947">!=</span>&nbsp;<span class="ident" id="5219950">r0</span><span class="op" id="5219952">;</span>&nbsp;<span class="ident" id="5219954">r1</span>&nbsp;<span class="op" id="5219957">=</span>&nbsp;<span class="ident" id="5219959">unicode</span><span class="op" id="5219966">.</span><span class="ident" id="5219967">SimpleFold</span><span class="op" id="5219977">(</span><span class="ident" id="5219978">r1</span><span class="op" id="5219980">)</span>&nbsp;<span class="op" id="5219982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5219989">runes</span>&nbsp;<span class="op" id="5219995">=</span>&nbsp;<span class="builtinfunc" id="5219997">append</span><span class="op" id="5220003">(</span><span class="ident" id="5220004">runes</span><span class="op" id="5220009">,</span>&nbsp;<span class="ident" id="5220011">r1</span><span class="op" id="5220013">,</span>&nbsp;<span class="ident" id="5220015">r1</span><span class="op" id="5220017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220029">sort</span><span class="op" id="5220033">.</span><span class="ident" id="5220034">Sort</span><span class="op" id="5220038">(</span><span class="ident" id="5220039">runeSlice</span><span class="op" id="5220048">(</span><span class="ident" id="5220049">runes</span><span class="op" id="5220054">)</span><span class="op" id="5220055">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220060">}</span>&nbsp;<span class="keyword" id="5220062">else</span>&nbsp;<span class="op" id="5220067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220073">runes</span>&nbsp;<span class="op" id="5220079">=</span>&nbsp;<span class="builtinfunc" id="5220081">append</span><span class="op" id="5220087">(</span><span class="ident" id="5220088">runes</span><span class="op" id="5220093">,</span>&nbsp;<span class="ident" id="5220095">inst</span><span class="op" id="5220099">.</span><span class="ident" id="5220100">Rune</span><span class="op" id="5220104">[</span><span class="num" id="5220105">0</span><span class="op" id="5220106">]</span><span class="op" id="5220107">,</span>&nbsp;<span class="ident" id="5220109">inst</span><span class="op" id="5220113">.</span><span class="ident" id="5220114">Rune</span><span class="op" id="5220118">[</span><span class="num" id="5220119">0</span><span class="op" id="5220120">]</span><span class="op" id="5220121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220131">onePassRunes</span><span class="op" id="5220143">[</span><span class="ident" id="5220144">pc</span><span class="op" id="5220146">]</span>&nbsp;<span class="op" id="5220148">=</span>&nbsp;<span class="ident" id="5220150">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220159">inst</span><span class="op" id="5220163">.</span><span class="ident" id="5220164">Next</span>&nbsp;<span class="op" id="5220169">=</span>&nbsp;<span class="op" id="5220171">[</span><span class="op" id="5220172">]</span><span class="builtintype" id="5220173">uint32</span><span class="op" id="5220179">{</span><span class="op" id="5220180">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220185">for</span>&nbsp;<span class="ident" id="5220189">i</span>&nbsp;<span class="op" id="5220191">:=</span>&nbsp;<span class="builtinfunc" id="5220194">len</span><span class="op" id="5220197">(</span><span class="ident" id="5220198">onePassRunes</span><span class="op" id="5220210">[</span><span class="ident" id="5220211">pc</span><span class="op" id="5220213">]</span><span class="op" id="5220214">)</span>&nbsp;<span class="op" id="5220216">/</span>&nbsp;<span class="num" id="5220218">2</span><span class="op" id="5220219">;</span>&nbsp;<span class="ident" id="5220221">i</span>&nbsp;<span class="op" id="5220223">&gt;=</span>&nbsp;<span class="num" id="5220226">0</span><span class="op" id="5220227">;</span>&nbsp;<span class="ident" id="5220229">i</span><span class="op" id="5220230">--</span>&nbsp;<span class="op" id="5220233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220239">inst</span><span class="op" id="5220243">.</span><span class="ident" id="5220244">Next</span>&nbsp;<span class="op" id="5220249">=</span>&nbsp;<span class="builtinfunc" id="5220251">append</span><span class="op" id="5220257">(</span><span class="ident" id="5220258">inst</span><span class="op" id="5220262">.</span><span class="ident" id="5220263">Next</span><span class="op" id="5220267">,</span>&nbsp;<span class="ident" id="5220269">inst</span><span class="op" id="5220273">.</span><span class="ident" id="5220274">Out</span><span class="op" id="5220277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220287">inst</span><span class="op" id="5220291">.</span><span class="ident" id="5220292">Op</span>&nbsp;<span class="op" id="5220295">=</span>&nbsp;<span class="ident" id="5220297">syntax</span><span class="op" id="5220303">.</span><span class="ident" id="5220304">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220315">case</span>&nbsp;<span class="ident" id="5220320">syntax</span><span class="op" id="5220326">.</span><span class="ident" id="5220327">InstRuneAny</span><span class="op" id="5220338">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220343">ok</span>&nbsp;<span class="op" id="5220346">=</span>&nbsp;<span class="ident" id="5220348">check</span><span class="op" id="5220353">(</span><span class="ident" id="5220354">inst</span><span class="op" id="5220358">.</span><span class="ident" id="5220359">Out</span><span class="op" id="5220362">,</span>&nbsp;<span class="ident" id="5220364">m</span><span class="op" id="5220365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220370">m</span><span class="op" id="5220371">[</span><span class="ident" id="5220372">pc</span><span class="op" id="5220374">]</span>&nbsp;<span class="op" id="5220376">=</span>&nbsp;<span class="builtintype" id="5220378">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220387">if</span>&nbsp;<span class="builtinfunc" id="5220390">len</span><span class="op" id="5220393">(</span><span class="ident" id="5220394">inst</span><span class="op" id="5220398">.</span><span class="ident" id="5220399">Next</span><span class="op" id="5220403">)</span>&nbsp;<span class="op" id="5220405">&gt;</span>&nbsp;<span class="num" id="5220407">0</span>&nbsp;<span class="op" id="5220409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220415">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220424">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220429">onePassRunes</span><span class="op" id="5220441">[</span><span class="ident" id="5220442">pc</span><span class="op" id="5220444">]</span>&nbsp;<span class="op" id="5220446">=</span>&nbsp;<span class="builtinfunc" id="5220448">append</span><span class="op" id="5220454">(</span><span class="op" id="5220455">[</span><span class="op" id="5220456">]</span><span class="builtintype" id="5220457">rune</span><span class="op" id="5220461">{</span><span class="op" id="5220462">}</span><span class="op" id="5220463">,</span>&nbsp;<span class="ident" id="5220465">anyRune</span><span class="op" id="5220472">...</span><span class="op" id="5220475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220480">inst</span><span class="op" id="5220484">.</span><span class="ident" id="5220485">Next</span>&nbsp;<span class="op" id="5220490">=</span>&nbsp;<span class="op" id="5220492">[</span><span class="op" id="5220493">]</span><span class="builtintype" id="5220494">uint32</span><span class="op" id="5220500">{</span><span class="ident" id="5220501">inst</span><span class="op" id="5220505">.</span><span class="ident" id="5220506">Out</span><span class="op" id="5220509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220513">case</span>&nbsp;<span class="ident" id="5220518">syntax</span><span class="op" id="5220524">.</span><span class="ident" id="5220525">InstRuneAnyNotNL</span><span class="op" id="5220541">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220546">ok</span>&nbsp;<span class="op" id="5220549">=</span>&nbsp;<span class="ident" id="5220551">check</span><span class="op" id="5220556">(</span><span class="ident" id="5220557">inst</span><span class="op" id="5220561">.</span><span class="ident" id="5220562">Out</span><span class="op" id="5220565">,</span>&nbsp;<span class="ident" id="5220567">m</span><span class="op" id="5220568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220573">m</span><span class="op" id="5220574">[</span><span class="ident" id="5220575">pc</span><span class="op" id="5220577">]</span>&nbsp;<span class="op" id="5220579">=</span>&nbsp;<span class="builtintype" id="5220581">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220590">if</span>&nbsp;<span class="builtinfunc" id="5220593">len</span><span class="op" id="5220596">(</span><span class="ident" id="5220597">inst</span><span class="op" id="5220601">.</span><span class="ident" id="5220602">Next</span><span class="op" id="5220606">)</span>&nbsp;<span class="op" id="5220608">&gt;</span>&nbsp;<span class="num" id="5220610">0</span>&nbsp;<span class="op" id="5220612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220618">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220632">onePassRunes</span><span class="op" id="5220644">[</span><span class="ident" id="5220645">pc</span><span class="op" id="5220647">]</span>&nbsp;<span class="op" id="5220649">=</span>&nbsp;<span class="builtinfunc" id="5220651">append</span><span class="op" id="5220657">(</span><span class="op" id="5220658">[</span><span class="op" id="5220659">]</span><span class="builtintype" id="5220660">rune</span><span class="op" id="5220664">{</span><span class="op" id="5220665">}</span><span class="op" id="5220666">,</span>&nbsp;<span class="ident" id="5220668">anyRuneNotNL</span><span class="op" id="5220680">...</span><span class="op" id="5220683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220688">inst</span><span class="op" id="5220692">.</span><span class="ident" id="5220693">Next</span>&nbsp;<span class="op" id="5220698">=</span>&nbsp;<span class="op" id="5220700">[</span><span class="op" id="5220701">]</span><span class="builtintype" id="5220702">uint32</span><span class="op" id="5220708">{</span><span class="op" id="5220709">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220714">for</span>&nbsp;<span class="ident" id="5220718">i</span>&nbsp;<span class="op" id="5220720">:=</span>&nbsp;<span class="builtinfunc" id="5220723">len</span><span class="op" id="5220726">(</span><span class="ident" id="5220727">onePassRunes</span><span class="op" id="5220739">[</span><span class="ident" id="5220740">pc</span><span class="op" id="5220742">]</span><span class="op" id="5220743">)</span>&nbsp;<span class="op" id="5220745">/</span>&nbsp;<span class="num" id="5220747">2</span><span class="op" id="5220748">;</span>&nbsp;<span class="ident" id="5220750">i</span>&nbsp;<span class="op" id="5220752">&gt;=</span>&nbsp;<span class="num" id="5220755">0</span><span class="op" id="5220756">;</span>&nbsp;<span class="ident" id="5220758">i</span><span class="op" id="5220759">--</span>&nbsp;<span class="op" id="5220762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220768">inst</span><span class="op" id="5220772">.</span><span class="ident" id="5220773">Next</span>&nbsp;<span class="op" id="5220778">=</span>&nbsp;<span class="builtinfunc" id="5220780">append</span><span class="op" id="5220786">(</span><span class="ident" id="5220787">inst</span><span class="op" id="5220791">.</span><span class="ident" id="5220792">Next</span><span class="op" id="5220796">,</span>&nbsp;<span class="ident" id="5220798">inst</span><span class="op" id="5220802">.</span><span class="ident" id="5220803">Out</span><span class="op" id="5220806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220819">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5220827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220831">instQueue</span><span class="op" id="5220840">.</span><span class="ident" id="5220841">clear</span><span class="op" id="5220846">(</span><span class="op" id="5220847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220850">instQueue</span><span class="op" id="5220859">.</span><span class="ident" id="5220860">insert</span><span class="op" id="5220866">(</span><span class="builtintype" id="5220867">uint32</span><span class="op" id="5220873">(</span><span class="ident" id="5220874">p</span><span class="op" id="5220875">.</span><span class="ident" id="5220876">Start</span><span class="op" id="5220881">)</span><span class="op" id="5220882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220885">m</span>&nbsp;<span class="op" id="5220887">:=</span>&nbsp;<span class="builtinfunc" id="5220890">make</span><span class="op" id="5220894">(</span><span class="keyword" id="5220895">map</span><span class="op" id="5220898">[</span><span class="builtintype" id="5220899">uint32</span><span class="op" id="5220905">]</span><span class="builtintype" id="5220906">bool</span><span class="op" id="5220910">,</span>&nbsp;<span class="builtinfunc" id="5220912">len</span><span class="op" id="5220915">(</span><span class="ident" id="5220916">p</span><span class="op" id="5220917">.</span><span class="ident" id="5220918">Inst</span><span class="op" id="5220922">)</span><span class="op" id="5220923">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5220926">for</span>&nbsp;<span class="op" id="5220930">!</span><span class="ident" id="5220931">instQueue</span><span class="op" id="5220940">.</span><span class="ident" id="5220941">empty</span><span class="op" id="5220946">(</span><span class="op" id="5220947">)</span>&nbsp;<span class="op" id="5220949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220953">pc</span>&nbsp;<span class="op" id="5220956">:=</span>&nbsp;<span class="ident" id="5220959">instQueue</span><span class="op" id="5220968">.</span><span class="ident" id="5220969">next</span><span class="op" id="5220973">(</span><span class="op" id="5220974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220978">inst</span>&nbsp;<span class="op" id="5220983">:=</span>&nbsp;<span class="ident" id="5220986">p</span><span class="op" id="5220987">.</span><span class="ident" id="5220988">Inst</span><span class="op" id="5220992">[</span><span class="ident" id="5220993">pc</span><span class="op" id="5220995">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5220999">visitQueue</span><span class="op" id="5221009">.</span><span class="ident" id="5221010">clear</span><span class="op" id="5221015">(</span><span class="op" id="5221016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221020">if</span>&nbsp;<span class="op" id="5221023">!</span><span class="ident" id="5221024">check</span><span class="op" id="5221029">(</span><span class="builtintype" id="5221030">uint32</span><span class="op" id="5221036">(</span><span class="ident" id="5221037">pc</span><span class="op" id="5221039">)</span><span class="op" id="5221040">,</span>&nbsp;<span class="ident" id="5221042">m</span><span class="op" id="5221043">)</span>&nbsp;<span class="op" id="5221045">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221050">p</span>&nbsp;<span class="op" id="5221052">=</span>&nbsp;<span class="ident" id="5221054">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221068">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221080">switch</span>&nbsp;<span class="ident" id="5221087">inst</span><span class="op" id="5221091">.</span><span class="ident" id="5221092">Op</span>&nbsp;<span class="op" id="5221095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221099">case</span>&nbsp;<span class="ident" id="5221104">syntax</span><span class="op" id="5221110">.</span><span class="ident" id="5221111">InstAlt</span><span class="op" id="5221118">,</span>&nbsp;<span class="ident" id="5221120">syntax</span><span class="op" id="5221126">.</span><span class="ident" id="5221127">InstAltMatch</span><span class="op" id="5221139">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221144">instQueue</span><span class="op" id="5221153">.</span><span class="ident" id="5221154">insert</span><span class="op" id="5221160">(</span><span class="ident" id="5221161">inst</span><span class="op" id="5221165">.</span><span class="ident" id="5221166">Out</span><span class="op" id="5221169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221174">instQueue</span><span class="op" id="5221183">.</span><span class="ident" id="5221184">insert</span><span class="op" id="5221190">(</span><span class="ident" id="5221191">inst</span><span class="op" id="5221195">.</span><span class="ident" id="5221196">Arg</span><span class="op" id="5221199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221203">case</span>&nbsp;<span class="ident" id="5221208">syntax</span><span class="op" id="5221214">.</span><span class="ident" id="5221215">InstCapture</span><span class="op" id="5221226">,</span>&nbsp;<span class="ident" id="5221228">syntax</span><span class="op" id="5221234">.</span><span class="ident" id="5221235">InstEmptyWidth</span><span class="op" id="5221249">,</span>&nbsp;<span class="ident" id="5221251">syntax</span><span class="op" id="5221257">.</span><span class="ident" id="5221258">InstNop</span><span class="op" id="5221265">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221270">instQueue</span><span class="op" id="5221279">.</span><span class="ident" id="5221280">insert</span><span class="op" id="5221286">(</span><span class="ident" id="5221287">inst</span><span class="op" id="5221291">.</span><span class="ident" id="5221292">Out</span><span class="op" id="5221295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221299">case</span>&nbsp;<span class="ident" id="5221304">syntax</span><span class="op" id="5221310">.</span><span class="ident" id="5221311">InstMatch</span><span class="op" id="5221320">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221324">case</span>&nbsp;<span class="ident" id="5221329">syntax</span><span class="op" id="5221335">.</span><span class="ident" id="5221336">InstFail</span><span class="op" id="5221344">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221348">case</span>&nbsp;<span class="ident" id="5221353">syntax</span><span class="op" id="5221359">.</span><span class="ident" id="5221360">InstRune</span><span class="op" id="5221368">,</span>&nbsp;<span class="ident" id="5221370">syntax</span><span class="op" id="5221376">.</span><span class="ident" id="5221377">InstRune1</span><span class="op" id="5221386">,</span>&nbsp;<span class="ident" id="5221388">syntax</span><span class="op" id="5221394">.</span><span class="ident" id="5221395">InstRuneAny</span><span class="op" id="5221406">,</span>&nbsp;<span class="ident" id="5221408">syntax</span><span class="op" id="5221414">.</span><span class="ident" id="5221415">InstRuneAnyNotNL</span><span class="op" id="5221431">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221435">default</span><span class="op" id="5221442">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221449">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221452">if</span>&nbsp;<span class="ident" id="5221455">p</span>&nbsp;<span class="op" id="5221457">!=</span>&nbsp;<span class="ident" id="5221460">notOnePass</span>&nbsp;<span class="op" id="5221471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221475">for</span>&nbsp;<span class="ident" id="5221479">i</span>&nbsp;<span class="op" id="5221481">:=</span>&nbsp;<span class="keyword" id="5221484">range</span>&nbsp;<span class="ident" id="5221490">p</span><span class="op" id="5221491">.</span><span class="ident" id="5221492">Inst</span>&nbsp;<span class="op" id="5221497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221502">p</span><span class="op" id="5221503">.</span><span class="ident" id="5221504">Inst</span><span class="op" id="5221508">[</span><span class="ident" id="5221509">i</span><span class="op" id="5221510">]</span><span class="op" id="5221511">.</span><span class="ident" id="5221512">Rune</span>&nbsp;<span class="op" id="5221517">=</span>&nbsp;<span class="ident" id="5221519">onePassRunes</span><span class="op" id="5221531">[</span><span class="ident" id="5221532">i</span><span class="op" id="5221533">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221540">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221543">return</span>&nbsp;<span class="ident" id="5221550">p</span><br>
<span class="lineno"></span><span class="op" id="5221552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5221555">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="5221623">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword" id="5221660">func</span>&nbsp;<span class="ident" id="5221665">walk</span><span class="op" id="5221669">(</span><span class="ident" id="5221670">prog</span>&nbsp;<span class="op" id="5221675">*</span><span class="ident" id="5221676">syntax</span><span class="op" id="5221682">.</span><span class="ident" id="5221683">Prog</span><span class="op" id="5221687">,</span>&nbsp;<span class="ident" id="5221689">funcs</span>&nbsp;<span class="op" id="5221695">...</span><span class="keyword" id="5221698">func</span><span class="op" id="5221702">(</span><span class="ident" id="5221703">ip</span><span class="op" id="5221705">,</span>&nbsp;<span class="ident" id="5221707">next</span>&nbsp;<span class="builtintype" id="5221712">uint32</span><span class="op" id="5221718">)</span><span class="op" id="5221719">)</span>&nbsp;<span class="op" id="5221721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221724">var</span>&nbsp;<span class="ident" id="5221728">walk1</span>&nbsp;<span class="keyword" id="5221734">func</span><span class="op" id="5221738">(</span><span class="builtintype" id="5221739">uint32</span><span class="op" id="5221745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221748">progQueue</span>&nbsp;<span class="op" id="5221758">:=</span>&nbsp;<span class="ident" id="5221761">newQueue</span><span class="op" id="5221769">(</span><span class="builtinfunc" id="5221770">len</span><span class="op" id="5221773">(</span><span class="ident" id="5221774">prog</span><span class="op" id="5221778">.</span><span class="ident" id="5221779">Inst</span><span class="op" id="5221783">)</span><span class="op" id="5221784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221787">walk1</span>&nbsp;<span class="op" id="5221793">=</span>&nbsp;<span class="keyword" id="5221795">func</span><span class="op" id="5221799">(</span><span class="ident" id="5221800">ip</span>&nbsp;<span class="builtintype" id="5221803">uint32</span><span class="op" id="5221809">)</span>&nbsp;<span class="op" id="5221811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221815">if</span>&nbsp;<span class="ident" id="5221818">progQueue</span><span class="op" id="5221827">.</span><span class="ident" id="5221828">contains</span><span class="op" id="5221836">(</span><span class="ident" id="5221837">ip</span><span class="op" id="5221839">)</span>&nbsp;<span class="op" id="5221841">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221846">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5221855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221859">progQueue</span><span class="op" id="5221868">.</span><span class="ident" id="5221869">insert</span><span class="op" id="5221875">(</span><span class="ident" id="5221876">ip</span><span class="op" id="5221878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5221882">inst</span>&nbsp;<span class="op" id="5221887">:=</span>&nbsp;<span class="ident" id="5221890">prog</span><span class="op" id="5221894">.</span><span class="ident" id="5221895">Inst</span><span class="op" id="5221899">[</span><span class="ident" id="5221900">ip</span><span class="op" id="5221902">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221906">switch</span>&nbsp;<span class="ident" id="5221913">inst</span><span class="op" id="5221917">.</span><span class="ident" id="5221918">Op</span>&nbsp;<span class="op" id="5221921">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221925">case</span>&nbsp;<span class="ident" id="5221930">syntax</span><span class="op" id="5221936">.</span><span class="ident" id="5221937">InstAlt</span><span class="op" id="5221944">,</span>&nbsp;<span class="ident" id="5221946">syntax</span><span class="op" id="5221952">.</span><span class="ident" id="5221953">InstAltMatch</span><span class="op" id="5221965">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5221970">for</span>&nbsp;<span class="ident" id="5221974">_</span><span class="op" id="5221975">,</span>&nbsp;<span class="ident" id="5221977">f</span>&nbsp;<span class="op" id="5221979">:=</span>&nbsp;<span class="keyword" id="5221982">range</span>&nbsp;<span class="ident" id="5221988">funcs</span>&nbsp;<span class="op" id="5221994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222000">f</span><span class="op" id="5222001">(</span><span class="ident" id="5222002">ip</span><span class="op" id="5222004">,</span>&nbsp;<span class="ident" id="5222006">inst</span><span class="op" id="5222010">.</span><span class="ident" id="5222011">Out</span><span class="op" id="5222014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222020">f</span><span class="op" id="5222021">(</span><span class="ident" id="5222022">ip</span><span class="op" id="5222024">,</span>&nbsp;<span class="ident" id="5222026">inst</span><span class="op" id="5222030">.</span><span class="ident" id="5222031">Arg</span><span class="op" id="5222034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5222039">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222044">walk1</span><span class="op" id="5222049">(</span><span class="ident" id="5222050">inst</span><span class="op" id="5222054">.</span><span class="ident" id="5222055">Out</span><span class="op" id="5222058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222063">walk1</span><span class="op" id="5222068">(</span><span class="ident" id="5222069">inst</span><span class="op" id="5222073">.</span><span class="ident" id="5222074">Arg</span><span class="op" id="5222077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222081">default</span><span class="op" id="5222088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222093">for</span>&nbsp;<span class="ident" id="5222097">_</span><span class="op" id="5222098">,</span>&nbsp;<span class="ident" id="5222100">f</span>&nbsp;<span class="op" id="5222102">:=</span>&nbsp;<span class="keyword" id="5222105">range</span>&nbsp;<span class="ident" id="5222111">funcs</span>&nbsp;<span class="op" id="5222117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222123">f</span><span class="op" id="5222124">(</span><span class="ident" id="5222125">ip</span><span class="op" id="5222127">,</span>&nbsp;<span class="ident" id="5222129">inst</span><span class="op" id="5222133">.</span><span class="ident" id="5222134">Out</span><span class="op" id="5222137">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5222142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222147">walk1</span><span class="op" id="5222152">(</span><span class="ident" id="5222153">inst</span><span class="op" id="5222157">.</span><span class="ident" id="5222158">Out</span><span class="op" id="5222161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5222165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5222168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222171">walk1</span><span class="op" id="5222176">(</span><span class="builtintype" id="5222177">uint32</span><span class="op" id="5222183">(</span><span class="ident" id="5222184">prog</span><span class="op" id="5222188">.</span><span class="ident" id="5222189">Start</span><span class="op" id="5222194">)</span><span class="op" id="5222195">)</span><br>
<span class="lineno">520</span><span class="op" id="5222197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5222200">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword" id="5222269">func</span>&nbsp;<span class="ident" id="5222274">find</span><span class="op" id="5222278">(</span><span class="ident" id="5222279">prog</span>&nbsp;<span class="op" id="5222284">*</span><span class="ident" id="5222285">syntax</span><span class="op" id="5222291">.</span><span class="ident" id="5222292">Prog</span><span class="op" id="5222296">,</span>&nbsp;<span class="ident" id="5222298">f</span>&nbsp;<span class="keyword" id="5222300">func</span><span class="op" id="5222304">(</span><span class="op" id="5222305">*</span><span class="ident" id="5222306">syntax</span><span class="op" id="5222312">.</span><span class="ident" id="5222313">Prog</span><span class="op" id="5222317">,</span>&nbsp;<span class="builtintype" id="5222319">int</span><span class="op" id="5222322">)</span>&nbsp;<span class="builtintype" id="5222324">bool</span><span class="op" id="5222328">)</span>&nbsp;<span class="op" id="5222330">(</span><span class="ident" id="5222331">matches</span>&nbsp;<span class="op" id="5222339">[</span><span class="op" id="5222340">]</span><span class="builtintype" id="5222341">uint32</span><span class="op" id="5222347">)</span>&nbsp;<span class="op" id="5222349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222352">matches</span>&nbsp;<span class="op" id="5222360">=</span>&nbsp;<span class="op" id="5222362">[</span><span class="op" id="5222363">]</span><span class="builtintype" id="5222364">uint32</span><span class="op" id="5222370">{</span><span class="op" id="5222371">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222375">for</span>&nbsp;<span class="ident" id="5222379">ip</span>&nbsp;<span class="op" id="5222382">:=</span>&nbsp;<span class="keyword" id="5222385">range</span>&nbsp;<span class="ident" id="5222391">prog</span><span class="op" id="5222395">.</span><span class="ident" id="5222396">Inst</span>&nbsp;<span class="op" id="5222401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222405">if</span>&nbsp;<span class="ident" id="5222408">f</span><span class="op" id="5222409">(</span><span class="ident" id="5222410">prog</span><span class="op" id="5222414">,</span>&nbsp;<span class="ident" id="5222416">ip</span><span class="op" id="5222418">)</span>&nbsp;<span class="op" id="5222420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5222425">matches</span>&nbsp;<span class="op" id="5222433">=</span>&nbsp;<span class="builtinfunc" id="5222435">append</span><span class="op" id="5222441">(</span><span class="ident" id="5222442">matches</span><span class="op" id="5222449">,</span>&nbsp;<span class="builtintype" id="5222451">uint32</span><span class="op" id="5222457">(</span><span class="ident" id="5222458">ip</span><span class="op" id="5222460">)</span><span class="op" id="5222461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5222465">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5222468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222471">return</span><br>
<span class="lineno"></span><span class="op" id="5222478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5222481">var</span>&nbsp;<span class="ident" id="5222485">notOnePass</span>&nbsp;<span class="op" id="5222496">*</span><span class="ident" id="5222497">onePassProg</span>&nbsp;<span class="op" id="5222509">=</span>&nbsp;<span class="ident" id="5222511">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment" id="5222516">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment" id="5222613">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5222697">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="5222783">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword" id="5222869">func</span>&nbsp;<span class="ident" id="5222874">compileOnePass</span><span class="op" id="5222888">(</span><span class="ident" id="5222889">prog</span>&nbsp;<span class="op" id="5222894">*</span><span class="ident" id="5222895">syntax</span><span class="op" id="5222901">.</span><span class="ident" id="5222902">Prog</span><span class="op" id="5222906">)</span>&nbsp;<span class="op" id="5222908">(</span><span class="ident" id="5222909">p</span>&nbsp;<span class="op" id="5222911">*</span><span class="ident" id="5222912">onePassProg</span><span class="op" id="5222923">)</span>&nbsp;<span class="op" id="5222925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222928">if</span>&nbsp;<span class="ident" id="5222931">prog</span><span class="op" id="5222935">.</span><span class="ident" id="5222936">Start</span>&nbsp;<span class="op" id="5222942">==</span>&nbsp;<span class="num" id="5222945">0</span>&nbsp;<span class="op" id="5222947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5222951">return</span>&nbsp;<span class="ident" id="5222958">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5222970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5222973">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223004">if</span>&nbsp;<span class="ident" id="5223007">prog</span><span class="op" id="5223011">.</span><span class="ident" id="5223012">Inst</span><span class="op" id="5223016">[</span><span class="ident" id="5223017">prog</span><span class="op" id="5223021">.</span><span class="ident" id="5223022">Start</span><span class="op" id="5223027">]</span><span class="op" id="5223028">.</span><span class="ident" id="5223029">Op</span>&nbsp;<span class="op" id="5223032">!=</span>&nbsp;<span class="ident" id="5223035">syntax</span><span class="op" id="5223041">.</span><span class="ident" id="5223042">InstEmptyWidth</span>&nbsp;<span class="op" id="5223057">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5223062">syntax</span><span class="op" id="5223068">.</span><span class="ident" id="5223069">EmptyOp</span><span class="op" id="5223076">(</span><span class="ident" id="5223077">prog</span><span class="op" id="5223081">.</span><span class="ident" id="5223082">Inst</span><span class="op" id="5223086">[</span><span class="ident" id="5223087">prog</span><span class="op" id="5223091">.</span><span class="ident" id="5223092">Start</span><span class="op" id="5223097">]</span><span class="op" id="5223098">.</span><span class="ident" id="5223099">Arg</span><span class="op" id="5223102">)</span><span class="op" id="5223103">&amp;</span><span class="ident" id="5223104">syntax</span><span class="op" id="5223110">.</span><span class="ident" id="5223111">EmptyBeginText</span>&nbsp;<span class="op" id="5223126">!=</span>&nbsp;<span class="ident" id="5223129">syntax</span><span class="op" id="5223135">.</span><span class="ident" id="5223136">EmptyBeginText</span>&nbsp;<span class="op" id="5223151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223155">return</span>&nbsp;<span class="ident" id="5223162">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5223174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5223177">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223241">for</span>&nbsp;<span class="ident" id="5223245">_</span><span class="op" id="5223246">,</span>&nbsp;<span class="ident" id="5223248">inst</span>&nbsp;<span class="op" id="5223253">:=</span>&nbsp;<span class="keyword" id="5223256">range</span>&nbsp;<span class="ident" id="5223262">prog</span><span class="op" id="5223266">.</span><span class="ident" id="5223267">Inst</span>&nbsp;<span class="op" id="5223272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5223276">opOut</span>&nbsp;<span class="op" id="5223282">:=</span>&nbsp;<span class="ident" id="5223285">prog</span><span class="op" id="5223289">.</span><span class="ident" id="5223290">Inst</span><span class="op" id="5223294">[</span><span class="ident" id="5223295">inst</span><span class="op" id="5223299">.</span><span class="ident" id="5223300">Out</span><span class="op" id="5223303">]</span><span class="op" id="5223304">.</span><span class="ident" id="5223305">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223310">switch</span>&nbsp;<span class="ident" id="5223317">inst</span><span class="op" id="5223321">.</span><span class="ident" id="5223322">Op</span>&nbsp;<span class="op" id="5223325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223329">default</span><span class="op" id="5223336">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223341">if</span>&nbsp;<span class="ident" id="5223344">opOut</span>&nbsp;<span class="op" id="5223350">==</span>&nbsp;<span class="ident" id="5223353">syntax</span><span class="op" id="5223359">.</span><span class="ident" id="5223360">InstMatch</span>&nbsp;<span class="op" id="5223370">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223376">return</span>&nbsp;<span class="ident" id="5223383">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5223397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223401">case</span>&nbsp;<span class="ident" id="5223406">syntax</span><span class="op" id="5223412">.</span><span class="ident" id="5223413">InstAlt</span><span class="op" id="5223420">,</span>&nbsp;<span class="ident" id="5223422">syntax</span><span class="op" id="5223428">.</span><span class="ident" id="5223429">InstAltMatch</span><span class="op" id="5223441">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223446">if</span>&nbsp;<span class="ident" id="5223449">opOut</span>&nbsp;<span class="op" id="5223455">==</span>&nbsp;<span class="ident" id="5223458">syntax</span><span class="op" id="5223464">.</span><span class="ident" id="5223465">InstMatch</span>&nbsp;<span class="op" id="5223475">||</span>&nbsp;<span class="ident" id="5223478">prog</span><span class="op" id="5223482">.</span><span class="ident" id="5223483">Inst</span><span class="op" id="5223487">[</span><span class="ident" id="5223488">inst</span><span class="op" id="5223492">.</span><span class="ident" id="5223493">Arg</span><span class="op" id="5223496">]</span><span class="op" id="5223497">.</span><span class="ident" id="5223498">Op</span>&nbsp;<span class="op" id="5223501">==</span>&nbsp;<span class="ident" id="5223504">syntax</span><span class="op" id="5223510">.</span><span class="ident" id="5223511">InstMatch</span>&nbsp;<span class="op" id="5223521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223527">return</span>&nbsp;<span class="ident" id="5223534">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5223548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223552">case</span>&nbsp;<span class="ident" id="5223557">syntax</span><span class="op" id="5223563">.</span><span class="ident" id="5223564">InstEmptyWidth</span><span class="op" id="5223578">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223583">if</span>&nbsp;<span class="ident" id="5223586">opOut</span>&nbsp;<span class="op" id="5223592">==</span>&nbsp;<span class="ident" id="5223595">syntax</span><span class="op" id="5223601">.</span><span class="ident" id="5223602">InstMatch</span>&nbsp;<span class="op" id="5223612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223618">if</span>&nbsp;<span class="ident" id="5223621">syntax</span><span class="op" id="5223627">.</span><span class="ident" id="5223628">EmptyOp</span><span class="op" id="5223635">(</span><span class="ident" id="5223636">inst</span><span class="op" id="5223640">.</span><span class="ident" id="5223641">Arg</span><span class="op" id="5223644">)</span><span class="op" id="5223645">&amp;</span><span class="ident" id="5223646">syntax</span><span class="op" id="5223652">.</span><span class="ident" id="5223653">EmptyEndText</span>&nbsp;<span class="op" id="5223666">==</span>&nbsp;<span class="ident" id="5223669">syntax</span><span class="op" id="5223675">.</span><span class="ident" id="5223676">EmptyEndText</span>&nbsp;<span class="op" id="5223689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223696">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5223709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223715">return</span>&nbsp;<span class="ident" id="5223722">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5223736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5223740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5223743">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5223746">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5223805">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5223875">p</span>&nbsp;<span class="op" id="5223877">=</span>&nbsp;<span class="ident" id="5223879">onePassCopy</span><span class="op" id="5223890">(</span><span class="ident" id="5223891">prog</span><span class="op" id="5223895">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5223899">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5223962">p</span>&nbsp;<span class="op" id="5223964">=</span>&nbsp;<span class="ident" id="5223966">makeOnePass</span><span class="op" id="5223977">(</span><span class="ident" id="5223978">p</span><span class="op" id="5223979">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5223983">if</span>&nbsp;<span class="ident" id="5223986">p</span>&nbsp;<span class="op" id="5223988">!=</span>&nbsp;<span class="ident" id="5223991">notOnePass</span>&nbsp;<span class="op" id="5224002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5224006">cleanupOnePass</span><span class="op" id="5224020">(</span><span class="ident" id="5224021">p</span><span class="op" id="5224022">,</span>&nbsp;<span class="ident" id="5224024">prog</span><span class="op" id="5224028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5224031">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5224034">return</span>&nbsp;<span class="ident" id="5224041">p</span><br>
<span class="lineno"></span><span class="op" id="5224043">}</span>
</div>
</body>
</html>
