<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4869180">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4869236">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4869290">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4869341">package</span>&nbsp;<span class="ident" id="4869349">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4869355">import</span>&nbsp;<span class="op" id="4869362">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4869365">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4869371">&#34;net/textproto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4869388">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4869396">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4869407">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4869415">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4869422">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="4869425">var</span>&nbsp;<span class="ident" id="4869429">raceEnabled</span>&nbsp;<span class="op" id="4869441">=</span>&nbsp;<span class="builtintype" id="4869443">false</span>&nbsp;<span class="comment" id="4869449">//&nbsp;set&nbsp;by&nbsp;race.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4869468">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="4869530">type</span>&nbsp;<span class="ident" id="4869535">Header</span>&nbsp;<span class="keyword" id="4869542">map</span><span class="op" id="4869545">[</span><span class="builtintype" id="4869546">string</span><span class="op" id="4869552">]</span><span class="op" id="4869553">[</span><span class="op" id="4869554">]</span><span class="builtintype" id="4869555">string</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4869563">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;key,&nbsp;value&nbsp;pair&nbsp;to&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="4869610">//&nbsp;It&nbsp;appends&nbsp;to&nbsp;any&nbsp;existing&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="4869668">func</span>&nbsp;<span class="op" id="4869673">(</span><span class="ident" id="4869674">h</span>&nbsp;<span class="ident" id="4869676">Header</span><span class="op" id="4869682">)</span>&nbsp;<span class="ident" id="4869684">Add</span><span class="op" id="4869687">(</span><span class="ident" id="4869688">key</span><span class="op" id="4869691">,</span>&nbsp;<span class="ident" id="4869693">value</span>&nbsp;<span class="builtintype" id="4869699">string</span><span class="op" id="4869705">)</span>&nbsp;<span class="op" id="4869707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869710">textproto</span><span class="op" id="4869719">.</span><span class="ident" id="4869720">MIMEHeader</span><span class="op" id="4869730">(</span><span class="ident" id="4869731">h</span><span class="op" id="4869732">)</span><span class="op" id="4869733">.</span><span class="ident" id="4869734">Add</span><span class="op" id="4869737">(</span><span class="ident" id="4869738">key</span><span class="op" id="4869741">,</span>&nbsp;<span class="ident" id="4869743">value</span><span class="op" id="4869748">)</span><br>
<span class="lineno">25</span><span class="op" id="4869750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4869753">//&nbsp;Set&nbsp;sets&nbsp;the&nbsp;header&nbsp;entries&nbsp;associated&nbsp;with&nbsp;key&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4869807">//&nbsp;the&nbsp;single&nbsp;element&nbsp;value.&nbsp;&nbsp;It&nbsp;replaces&nbsp;any&nbsp;existing</span><br>
<span class="lineno"></span><span class="comment" id="4869862">//&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno">30</span><span class="keyword" id="4869893">func</span>&nbsp;<span class="op" id="4869898">(</span><span class="ident" id="4869899">h</span>&nbsp;<span class="ident" id="4869901">Header</span><span class="op" id="4869907">)</span>&nbsp;<span class="ident" id="4869909">Set</span><span class="op" id="4869912">(</span><span class="ident" id="4869913">key</span><span class="op" id="4869916">,</span>&nbsp;<span class="ident" id="4869918">value</span>&nbsp;<span class="builtintype" id="4869924">string</span><span class="op" id="4869930">)</span>&nbsp;<span class="op" id="4869932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869935">textproto</span><span class="op" id="4869944">.</span><span class="ident" id="4869945">MIMEHeader</span><span class="op" id="4869955">(</span><span class="ident" id="4869956">h</span><span class="op" id="4869957">)</span><span class="op" id="4869958">.</span><span class="ident" id="4869959">Set</span><span class="op" id="4869962">(</span><span class="ident" id="4869963">key</span><span class="op" id="4869966">,</span>&nbsp;<span class="ident" id="4869968">value</span><span class="op" id="4869973">)</span><br>
<span class="lineno"></span><span class="op" id="4869975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4869978">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno">35</span><span class="comment" id="4870037">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4870104">//&nbsp;To&nbsp;access&nbsp;multiple&nbsp;values&nbsp;of&nbsp;a&nbsp;key,&nbsp;access&nbsp;the&nbsp;map&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="4870167">//&nbsp;with&nbsp;CanonicalHeaderKey.</span><br>
<span class="lineno"></span><span class="keyword" id="4870195">func</span>&nbsp;<span class="op" id="4870200">(</span><span class="ident" id="4870201">h</span>&nbsp;<span class="ident" id="4870203">Header</span><span class="op" id="4870209">)</span>&nbsp;<span class="ident" id="4870211">Get</span><span class="op" id="4870214">(</span><span class="ident" id="4870215">key</span>&nbsp;<span class="builtintype" id="4870219">string</span><span class="op" id="4870225">)</span>&nbsp;<span class="builtintype" id="4870227">string</span>&nbsp;<span class="op" id="4870234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870237">return</span>&nbsp;<span class="ident" id="4870244">textproto</span><span class="op" id="4870253">.</span><span class="ident" id="4870254">MIMEHeader</span><span class="op" id="4870264">(</span><span class="ident" id="4870265">h</span><span class="op" id="4870266">)</span><span class="op" id="4870267">.</span><span class="ident" id="4870268">Get</span><span class="op" id="4870271">(</span><span class="ident" id="4870272">key</span><span class="op" id="4870275">)</span><br>
<span class="lineno">40</span><span class="op" id="4870277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4870280">//&nbsp;get&nbsp;is&nbsp;like&nbsp;Get,&nbsp;but&nbsp;key&nbsp;must&nbsp;already&nbsp;be&nbsp;in&nbsp;CanonicalHeaderKey&nbsp;form.</span><br>
<span class="lineno"></span><span class="keyword" id="4870352">func</span>&nbsp;<span class="op" id="4870357">(</span><span class="ident" id="4870358">h</span>&nbsp;<span class="ident" id="4870360">Header</span><span class="op" id="4870366">)</span>&nbsp;<span class="ident" id="4870368">get</span><span class="op" id="4870371">(</span><span class="ident" id="4870372">key</span>&nbsp;<span class="builtintype" id="4870376">string</span><span class="op" id="4870382">)</span>&nbsp;<span class="builtintype" id="4870384">string</span>&nbsp;<span class="op" id="4870391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870394">if</span>&nbsp;<span class="ident" id="4870397">v</span>&nbsp;<span class="op" id="4870399">:=</span>&nbsp;<span class="ident" id="4870402">h</span><span class="op" id="4870403">[</span><span class="ident" id="4870404">key</span><span class="op" id="4870407">]</span><span class="op" id="4870408">;</span>&nbsp;<span class="builtinfunc" id="4870410">len</span><span class="op" id="4870413">(</span><span class="ident" id="4870414">v</span><span class="op" id="4870415">)</span>&nbsp;<span class="op" id="4870417">&gt;</span>&nbsp;<span class="num" id="4870419">0</span>&nbsp;<span class="op" id="4870421">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870425">return</span>&nbsp;<span class="ident" id="4870432">v</span><span class="op" id="4870433">[</span><span class="num" id="4870434">0</span><span class="op" id="4870435">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4870438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870441">return</span>&nbsp;<span class="string" id="4870448">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="4870451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4870454">//&nbsp;Del&nbsp;deletes&nbsp;the&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="4870501">func</span>&nbsp;<span class="op" id="4870506">(</span><span class="ident" id="4870507">h</span>&nbsp;<span class="ident" id="4870509">Header</span><span class="op" id="4870515">)</span>&nbsp;<span class="ident" id="4870517">Del</span><span class="op" id="4870520">(</span><span class="ident" id="4870521">key</span>&nbsp;<span class="builtintype" id="4870525">string</span><span class="op" id="4870531">)</span>&nbsp;<span class="op" id="4870533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870536">textproto</span><span class="op" id="4870545">.</span><span class="ident" id="4870546">MIMEHeader</span><span class="op" id="4870556">(</span><span class="ident" id="4870557">h</span><span class="op" id="4870558">)</span><span class="op" id="4870559">.</span><span class="ident" id="4870560">Del</span><span class="op" id="4870563">(</span><span class="ident" id="4870564">key</span><span class="op" id="4870567">)</span><br>
<span class="lineno"></span><span class="op" id="4870569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="4870572">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="4870613">func</span>&nbsp;<span class="op" id="4870618">(</span><span class="ident" id="4870619">h</span>&nbsp;<span class="ident" id="4870621">Header</span><span class="op" id="4870627">)</span>&nbsp;<span class="ident" id="4870629">Write</span><span class="op" id="4870634">(</span><span class="ident" id="4870635">w</span>&nbsp;<span class="ident" id="4870637">io</span><span class="op" id="4870639">.</span><span class="ident" id="4870640">Writer</span><span class="op" id="4870646">)</span>&nbsp;<span class="builtintype" id="4870648">error</span>&nbsp;<span class="op" id="4870654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870657">return</span>&nbsp;<span class="ident" id="4870664">h</span><span class="op" id="4870665">.</span><span class="ident" id="4870666">WriteSubset</span><span class="op" id="4870677">(</span><span class="ident" id="4870678">w</span><span class="op" id="4870679">,</span>&nbsp;<span class="ident" id="4870681">nil</span><span class="op" id="4870684">)</span><br>
<span class="lineno"></span><span class="op" id="4870686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4870689">func</span>&nbsp;<span class="op" id="4870694">(</span><span class="ident" id="4870695">h</span>&nbsp;<span class="ident" id="4870697">Header</span><span class="op" id="4870703">)</span>&nbsp;<span class="ident" id="4870705">clone</span><span class="op" id="4870710">(</span><span class="op" id="4870711">)</span>&nbsp;<span class="ident" id="4870713">Header</span>&nbsp;<span class="op" id="4870720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870723">h2</span>&nbsp;<span class="op" id="4870726">:=</span>&nbsp;<span class="builtinfunc" id="4870729">make</span><span class="op" id="4870733">(</span><span class="ident" id="4870734">Header</span><span class="op" id="4870740">,</span>&nbsp;<span class="builtinfunc" id="4870742">len</span><span class="op" id="4870745">(</span><span class="ident" id="4870746">h</span><span class="op" id="4870747">)</span><span class="op" id="4870748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870751">for</span>&nbsp;<span class="ident" id="4870755">k</span><span class="op" id="4870756">,</span>&nbsp;<span class="ident" id="4870758">vv</span>&nbsp;<span class="op" id="4870761">:=</span>&nbsp;<span class="keyword" id="4870764">range</span>&nbsp;<span class="ident" id="4870770">h</span>&nbsp;<span class="op" id="4870772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870776">vv2</span>&nbsp;<span class="op" id="4870780">:=</span>&nbsp;<span class="builtinfunc" id="4870783">make</span><span class="op" id="4870787">(</span><span class="op" id="4870788">[</span><span class="op" id="4870789">]</span><span class="builtintype" id="4870790">string</span><span class="op" id="4870796">,</span>&nbsp;<span class="builtinfunc" id="4870798">len</span><span class="op" id="4870801">(</span><span class="ident" id="4870802">vv</span><span class="op" id="4870804">)</span><span class="op" id="4870805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4870809">copy</span><span class="op" id="4870813">(</span><span class="ident" id="4870814">vv2</span><span class="op" id="4870817">,</span>&nbsp;<span class="ident" id="4870819">vv</span><span class="op" id="4870821">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870825">h2</span><span class="op" id="4870827">[</span><span class="ident" id="4870828">k</span><span class="op" id="4870829">]</span>&nbsp;<span class="op" id="4870831">=</span>&nbsp;<span class="ident" id="4870833">vv2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4870838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870841">return</span>&nbsp;<span class="ident" id="4870848">h2</span><br>
<span class="lineno"></span><span class="op" id="4870851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4870854">var</span>&nbsp;<span class="ident" id="4870858">timeFormats</span>&nbsp;<span class="op" id="4870870">=</span>&nbsp;<span class="op" id="4870872">[</span><span class="op" id="4870873">]</span><span class="builtintype" id="4870874">string</span><span class="op" id="4870880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870883">TimeFormat</span><span class="op" id="4870893">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870896">time</span><span class="op" id="4870900">.</span><span class="ident" id="4870901">RFC850</span><span class="op" id="4870907">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870910">time</span><span class="op" id="4870914">.</span><span class="ident" id="4870915">ANSIC</span><span class="op" id="4870920">,</span><br>
<span class="lineno"></span><span class="op" id="4870922">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="4870925">//&nbsp;ParseTime&nbsp;parses&nbsp;a&nbsp;time&nbsp;header&nbsp;(such&nbsp;as&nbsp;the&nbsp;Date:&nbsp;header),</span><br>
<span class="lineno"></span><span class="comment" id="4870987">//&nbsp;trying&nbsp;each&nbsp;of&nbsp;the&nbsp;three&nbsp;formats&nbsp;allowed&nbsp;by&nbsp;HTTP/1.1:</span><br>
<span class="lineno"></span><span class="comment" id="4871044">//&nbsp;TimeFormat,&nbsp;time.RFC850,&nbsp;and&nbsp;time.ANSIC.</span><br>
<span class="lineno"></span><span class="keyword" id="4871088">func</span>&nbsp;<span class="ident" id="4871093">ParseTime</span><span class="op" id="4871102">(</span><span class="ident" id="4871103">text</span>&nbsp;<span class="builtintype" id="4871108">string</span><span class="op" id="4871114">)</span>&nbsp;<span class="op" id="4871116">(</span><span class="ident" id="4871117">t</span>&nbsp;<span class="ident" id="4871119">time</span><span class="op" id="4871123">.</span><span class="ident" id="4871124">Time</span><span class="op" id="4871128">,</span>&nbsp;<span class="ident" id="4871130">err</span>&nbsp;<span class="builtintype" id="4871134">error</span><span class="op" id="4871139">)</span>&nbsp;<span class="op" id="4871141">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871144">for</span>&nbsp;<span class="ident" id="4871148">_</span><span class="op" id="4871149">,</span>&nbsp;<span class="ident" id="4871151">layout</span>&nbsp;<span class="op" id="4871158">:=</span>&nbsp;<span class="keyword" id="4871161">range</span>&nbsp;<span class="ident" id="4871167">timeFormats</span>&nbsp;<span class="op" id="4871179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871183">t</span><span class="op" id="4871184">,</span>&nbsp;<span class="ident" id="4871186">err</span>&nbsp;<span class="op" id="4871190">=</span>&nbsp;<span class="ident" id="4871192">time</span><span class="op" id="4871196">.</span><span class="ident" id="4871197">Parse</span><span class="op" id="4871202">(</span><span class="ident" id="4871203">layout</span><span class="op" id="4871209">,</span>&nbsp;<span class="ident" id="4871211">text</span><span class="op" id="4871215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871219">if</span>&nbsp;<span class="ident" id="4871222">err</span>&nbsp;<span class="op" id="4871226">==</span>&nbsp;<span class="ident" id="4871229">nil</span>&nbsp;<span class="op" id="4871233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871238">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4871247">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4871250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871253">return</span><br>
<span class="lineno"></span><span class="op" id="4871260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4871263">var</span>&nbsp;<span class="ident" id="4871267">headerNewlineToSpace</span>&nbsp;<span class="op" id="4871288">=</span>&nbsp;<span class="ident" id="4871290">strings</span><span class="op" id="4871297">.</span><span class="ident" id="4871298">NewReplacer</span><span class="op" id="4871309">(</span><span class="string" id="4871310">&#34;\n&#34;</span><span class="op" id="4871314">,</span>&nbsp;<span class="string" id="4871316">&#34;&nbsp;&#34;</span><span class="op" id="4871319">,</span>&nbsp;<span class="string" id="4871321">&#34;\r&#34;</span><span class="op" id="4871325">,</span>&nbsp;<span class="string" id="4871327">&#34;&nbsp;&#34;</span><span class="op" id="4871330">)</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="4871333">type</span>&nbsp;<span class="ident" id="4871338">writeStringer</span>&nbsp;<span class="keyword" id="4871352">interface</span>&nbsp;<span class="op" id="4871362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871365">WriteString</span><span class="op" id="4871376">(</span><span class="builtintype" id="4871377">string</span><span class="op" id="4871383">)</span>&nbsp;<span class="op" id="4871385">(</span><span class="builtintype" id="4871386">int</span><span class="op" id="4871389">,</span>&nbsp;<span class="builtintype" id="4871391">error</span><span class="op" id="4871396">)</span><br>
<span class="lineno"></span><span class="op" id="4871398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4871401">//&nbsp;stringWriter&nbsp;implements&nbsp;WriteString&nbsp;on&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4871453">type</span>&nbsp;<span class="ident" id="4871458">stringWriter</span>&nbsp;<span class="keyword" id="4871471">struct</span>&nbsp;<span class="op" id="4871478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871481">w</span>&nbsp;<span class="ident" id="4871483">io</span><span class="op" id="4871485">.</span><span class="ident" id="4871486">Writer</span><br>
<span class="lineno"></span><span class="op" id="4871493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="4871496">func</span>&nbsp;<span class="op" id="4871501">(</span><span class="ident" id="4871502">w</span>&nbsp;<span class="ident" id="4871504">stringWriter</span><span class="op" id="4871516">)</span>&nbsp;<span class="ident" id="4871518">WriteString</span><span class="op" id="4871529">(</span><span class="ident" id="4871530">s</span>&nbsp;<span class="builtintype" id="4871532">string</span><span class="op" id="4871538">)</span>&nbsp;<span class="op" id="4871540">(</span><span class="ident" id="4871541">n</span>&nbsp;<span class="builtintype" id="4871543">int</span><span class="op" id="4871546">,</span>&nbsp;<span class="ident" id="4871548">err</span>&nbsp;<span class="builtintype" id="4871552">error</span><span class="op" id="4871557">)</span>&nbsp;<span class="op" id="4871559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871562">return</span>&nbsp;<span class="ident" id="4871569">w</span><span class="op" id="4871570">.</span><span class="ident" id="4871571">w</span><span class="op" id="4871572">.</span><span class="ident" id="4871573">Write</span><span class="op" id="4871578">(</span><span class="op" id="4871579">[</span><span class="op" id="4871580">]</span><span class="builtintype" id="4871581">byte</span><span class="op" id="4871585">(</span><span class="ident" id="4871586">s</span><span class="op" id="4871587">)</span><span class="op" id="4871588">)</span><br>
<span class="lineno"></span><span class="op" id="4871590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4871593">type</span>&nbsp;<span class="ident" id="4871598">keyValues</span>&nbsp;<span class="keyword" id="4871608">struct</span>&nbsp;<span class="op" id="4871615">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871618">key</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4871625">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871633">values</span>&nbsp;<span class="op" id="4871640">[</span><span class="op" id="4871641">]</span><span class="builtintype" id="4871642">string</span><br>
<span class="lineno"></span><span class="op" id="4871649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4871652">//&nbsp;A&nbsp;headerSorter&nbsp;implements&nbsp;sort.Interface&nbsp;by&nbsp;sorting&nbsp;a&nbsp;[]keyValues</span><br>
<span class="lineno">110</span><span class="comment" id="4871721">//&nbsp;by&nbsp;key.&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;pointer,&nbsp;so&nbsp;it&nbsp;can&nbsp;fit&nbsp;in&nbsp;a&nbsp;sort.Interface</span><br>
<span class="lineno"></span><span class="comment" id="4871790">//&nbsp;interface&nbsp;value&nbsp;without&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="4871829">type</span>&nbsp;<span class="ident" id="4871834">headerSorter</span>&nbsp;<span class="keyword" id="4871847">struct</span>&nbsp;<span class="op" id="4871854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871857">kvs</span>&nbsp;<span class="op" id="4871861">[</span><span class="op" id="4871862">]</span><span class="ident" id="4871863">keyValues</span><br>
<span class="lineno"></span><span class="op" id="4871873">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="4871876">func</span>&nbsp;<span class="op" id="4871881">(</span><span class="ident" id="4871882">s</span>&nbsp;<span class="op" id="4871884">*</span><span class="ident" id="4871885">headerSorter</span><span class="op" id="4871897">)</span>&nbsp;<span class="ident" id="4871899">Len</span><span class="op" id="4871902">(</span><span class="op" id="4871903">)</span>&nbsp;<span class="builtintype" id="4871905">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4871919">{</span>&nbsp;<span class="keyword" id="4871921">return</span>&nbsp;<span class="builtinfunc" id="4871928">len</span><span class="op" id="4871931">(</span><span class="ident" id="4871932">s</span><span class="op" id="4871933">.</span><span class="ident" id="4871934">kvs</span><span class="op" id="4871937">)</span>&nbsp;<span class="op" id="4871939">}</span><br>
<span class="lineno"></span><span class="keyword" id="4871941">func</span>&nbsp;<span class="op" id="4871946">(</span><span class="ident" id="4871947">s</span>&nbsp;<span class="op" id="4871949">*</span><span class="ident" id="4871950">headerSorter</span><span class="op" id="4871962">)</span>&nbsp;<span class="ident" id="4871964">Swap</span><span class="op" id="4871968">(</span><span class="ident" id="4871969">i</span><span class="op" id="4871970">,</span>&nbsp;<span class="ident" id="4871972">j</span>&nbsp;<span class="builtintype" id="4871974">int</span><span class="op" id="4871977">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4871984">{</span>&nbsp;<span class="ident" id="4871986">s</span><span class="op" id="4871987">.</span><span class="ident" id="4871988">kvs</span><span class="op" id="4871991">[</span><span class="ident" id="4871992">i</span><span class="op" id="4871993">]</span><span class="op" id="4871994">,</span>&nbsp;<span class="ident" id="4871996">s</span><span class="op" id="4871997">.</span><span class="ident" id="4871998">kvs</span><span class="op" id="4872001">[</span><span class="ident" id="4872002">j</span><span class="op" id="4872003">]</span>&nbsp;<span class="op" id="4872005">=</span>&nbsp;<span class="ident" id="4872007">s</span><span class="op" id="4872008">.</span><span class="ident" id="4872009">kvs</span><span class="op" id="4872012">[</span><span class="ident" id="4872013">j</span><span class="op" id="4872014">]</span><span class="op" id="4872015">,</span>&nbsp;<span class="ident" id="4872017">s</span><span class="op" id="4872018">.</span><span class="ident" id="4872019">kvs</span><span class="op" id="4872022">[</span><span class="ident" id="4872023">i</span><span class="op" id="4872024">]</span>&nbsp;<span class="op" id="4872026">}</span><br>
<span class="lineno"></span><span class="keyword" id="4872028">func</span>&nbsp;<span class="op" id="4872033">(</span><span class="ident" id="4872034">s</span>&nbsp;<span class="op" id="4872036">*</span><span class="ident" id="4872037">headerSorter</span><span class="op" id="4872049">)</span>&nbsp;<span class="ident" id="4872051">Less</span><span class="op" id="4872055">(</span><span class="ident" id="4872056">i</span><span class="op" id="4872057">,</span>&nbsp;<span class="ident" id="4872059">j</span>&nbsp;<span class="builtintype" id="4872061">int</span><span class="op" id="4872064">)</span>&nbsp;<span class="builtintype" id="4872066">bool</span>&nbsp;<span class="op" id="4872071">{</span>&nbsp;<span class="keyword" id="4872073">return</span>&nbsp;<span class="ident" id="4872080">s</span><span class="op" id="4872081">.</span><span class="ident" id="4872082">kvs</span><span class="op" id="4872085">[</span><span class="ident" id="4872086">i</span><span class="op" id="4872087">]</span><span class="op" id="4872088">.</span><span class="ident" id="4872089">key</span>&nbsp;<span class="op" id="4872093">&lt;</span>&nbsp;<span class="ident" id="4872095">s</span><span class="op" id="4872096">.</span><span class="ident" id="4872097">kvs</span><span class="op" id="4872100">[</span><span class="ident" id="4872101">j</span><span class="op" id="4872102">]</span><span class="op" id="4872103">.</span><span class="ident" id="4872104">key</span>&nbsp;<span class="op" id="4872108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="4872111">var</span>&nbsp;<span class="ident" id="4872115">headerSorterPool</span>&nbsp;<span class="op" id="4872132">=</span>&nbsp;<span class="ident" id="4872134">sync</span><span class="op" id="4872138">.</span><span class="ident" id="4872139">Pool</span><span class="op" id="4872143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872146">New</span><span class="op" id="4872149">:</span>&nbsp;<span class="keyword" id="4872151">func</span><span class="op" id="4872155">(</span><span class="op" id="4872156">)</span>&nbsp;<span class="keyword" id="4872158">interface</span><span class="op" id="4872167">{</span><span class="op" id="4872168">}</span>&nbsp;<span class="op" id="4872170">{</span>&nbsp;<span class="keyword" id="4872172">return</span>&nbsp;<span class="builtinfunc" id="4872179">new</span><span class="op" id="4872182">(</span><span class="ident" id="4872183">headerSorter</span><span class="op" id="4872195">)</span>&nbsp;<span class="op" id="4872197">}</span><span class="op" id="4872198">,</span><br>
<span class="lineno"></span><span class="op" id="4872200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4872203">//&nbsp;sortedKeyValues&nbsp;returns&nbsp;h&#39;s&nbsp;keys&nbsp;sorted&nbsp;in&nbsp;the&nbsp;returned&nbsp;kvs</span><br>
<span class="lineno">125</span><span class="comment" id="4872266">//&nbsp;slice.&nbsp;The&nbsp;headerSorter&nbsp;used&nbsp;to&nbsp;sort&nbsp;is&nbsp;also&nbsp;returned,&nbsp;for&nbsp;possible</span><br>
<span class="lineno"></span><span class="comment" id="4872337">//&nbsp;return&nbsp;to&nbsp;headerSorterCache.</span><br>
<span class="lineno"></span><span class="keyword" id="4872369">func</span>&nbsp;<span class="op" id="4872374">(</span><span class="ident" id="4872375">h</span>&nbsp;<span class="ident" id="4872377">Header</span><span class="op" id="4872383">)</span>&nbsp;<span class="ident" id="4872385">sortedKeyValues</span><span class="op" id="4872400">(</span><span class="ident" id="4872401">exclude</span>&nbsp;<span class="keyword" id="4872409">map</span><span class="op" id="4872412">[</span><span class="builtintype" id="4872413">string</span><span class="op" id="4872419">]</span><span class="builtintype" id="4872420">bool</span><span class="op" id="4872424">)</span>&nbsp;<span class="op" id="4872426">(</span><span class="ident" id="4872427">kvs</span>&nbsp;<span class="op" id="4872431">[</span><span class="op" id="4872432">]</span><span class="ident" id="4872433">keyValues</span><span class="op" id="4872442">,</span>&nbsp;<span class="ident" id="4872444">hs</span>&nbsp;<span class="op" id="4872447">*</span><span class="ident" id="4872448">headerSorter</span><span class="op" id="4872460">)</span>&nbsp;<span class="op" id="4872462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872465">hs</span>&nbsp;<span class="op" id="4872468">=</span>&nbsp;<span class="ident" id="4872470">headerSorterPool</span><span class="op" id="4872486">.</span><span class="ident" id="4872487">Get</span><span class="op" id="4872490">(</span><span class="op" id="4872491">)</span><span class="op" id="4872492">.</span><span class="op" id="4872493">(</span><span class="op" id="4872494">*</span><span class="ident" id="4872495">headerSorter</span><span class="op" id="4872507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872510">if</span>&nbsp;<span class="builtinfunc" id="4872513">cap</span><span class="op" id="4872516">(</span><span class="ident" id="4872517">hs</span><span class="op" id="4872519">.</span><span class="ident" id="4872520">kvs</span><span class="op" id="4872523">)</span>&nbsp;<span class="op" id="4872525">&lt;</span>&nbsp;<span class="builtinfunc" id="4872527">len</span><span class="op" id="4872530">(</span><span class="ident" id="4872531">h</span><span class="op" id="4872532">)</span>&nbsp;<span class="op" id="4872534">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872538">hs</span><span class="op" id="4872540">.</span><span class="ident" id="4872541">kvs</span>&nbsp;<span class="op" id="4872545">=</span>&nbsp;<span class="builtinfunc" id="4872547">make</span><span class="op" id="4872551">(</span><span class="op" id="4872552">[</span><span class="op" id="4872553">]</span><span class="ident" id="4872554">keyValues</span><span class="op" id="4872563">,</span>&nbsp;<span class="num" id="4872565">0</span><span class="op" id="4872566">,</span>&nbsp;<span class="builtinfunc" id="4872568">len</span><span class="op" id="4872571">(</span><span class="ident" id="4872572">h</span><span class="op" id="4872573">)</span><span class="op" id="4872574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872580">kvs</span>&nbsp;<span class="op" id="4872584">=</span>&nbsp;<span class="ident" id="4872586">hs</span><span class="op" id="4872588">.</span><span class="ident" id="4872589">kvs</span><span class="op" id="4872592">[</span><span class="op" id="4872593">:</span><span class="num" id="4872594">0</span><span class="op" id="4872595">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872598">for</span>&nbsp;<span class="ident" id="4872602">k</span><span class="op" id="4872603">,</span>&nbsp;<span class="ident" id="4872605">vv</span>&nbsp;<span class="op" id="4872608">:=</span>&nbsp;<span class="keyword" id="4872611">range</span>&nbsp;<span class="ident" id="4872617">h</span>&nbsp;<span class="op" id="4872619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872623">if</span>&nbsp;<span class="op" id="4872626">!</span><span class="ident" id="4872627">exclude</span><span class="op" id="4872634">[</span><span class="ident" id="4872635">k</span><span class="op" id="4872636">]</span>&nbsp;<span class="op" id="4872638">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872643">kvs</span>&nbsp;<span class="op" id="4872647">=</span>&nbsp;<span class="builtinfunc" id="4872649">append</span><span class="op" id="4872655">(</span><span class="ident" id="4872656">kvs</span><span class="op" id="4872659">,</span>&nbsp;<span class="ident" id="4872661">keyValues</span><span class="op" id="4872670">{</span><span class="ident" id="4872671">k</span><span class="op" id="4872672">,</span>&nbsp;<span class="ident" id="4872674">vv</span><span class="op" id="4872676">}</span><span class="op" id="4872677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872687">hs</span><span class="op" id="4872689">.</span><span class="ident" id="4872690">kvs</span>&nbsp;<span class="op" id="4872694">=</span>&nbsp;<span class="ident" id="4872696">kvs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872701">sort</span><span class="op" id="4872705">.</span><span class="ident" id="4872706">Sort</span><span class="op" id="4872710">(</span><span class="ident" id="4872711">hs</span><span class="op" id="4872713">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872716">return</span>&nbsp;<span class="ident" id="4872723">kvs</span><span class="op" id="4872726">,</span>&nbsp;<span class="ident" id="4872728">hs</span><br>
<span class="lineno"></span><span class="op" id="4872731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4872734">//&nbsp;WriteSubset&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="4872781">//&nbsp;If&nbsp;exclude&nbsp;is&nbsp;not&nbsp;nil,&nbsp;keys&nbsp;where&nbsp;exclude[key]&nbsp;==&nbsp;true&nbsp;are&nbsp;not&nbsp;written.</span><br>
<span class="lineno">145</span><span class="keyword" id="4872856">func</span>&nbsp;<span class="op" id="4872861">(</span><span class="ident" id="4872862">h</span>&nbsp;<span class="ident" id="4872864">Header</span><span class="op" id="4872870">)</span>&nbsp;<span class="ident" id="4872872">WriteSubset</span><span class="op" id="4872883">(</span><span class="ident" id="4872884">w</span>&nbsp;<span class="ident" id="4872886">io</span><span class="op" id="4872888">.</span><span class="ident" id="4872889">Writer</span><span class="op" id="4872895">,</span>&nbsp;<span class="ident" id="4872897">exclude</span>&nbsp;<span class="keyword" id="4872905">map</span><span class="op" id="4872908">[</span><span class="builtintype" id="4872909">string</span><span class="op" id="4872915">]</span><span class="builtintype" id="4872916">bool</span><span class="op" id="4872920">)</span>&nbsp;<span class="builtintype" id="4872922">error</span>&nbsp;<span class="op" id="4872928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872931">ws</span><span class="op" id="4872933">,</span>&nbsp;<span class="ident" id="4872935">ok</span>&nbsp;<span class="op" id="4872938">:=</span>&nbsp;<span class="ident" id="4872941">w</span><span class="op" id="4872942">.</span><span class="op" id="4872943">(</span><span class="ident" id="4872944">writeStringer</span><span class="op" id="4872957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872960">if</span>&nbsp;<span class="op" id="4872963">!</span><span class="ident" id="4872964">ok</span>&nbsp;<span class="op" id="4872967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872971">ws</span>&nbsp;<span class="op" id="4872974">=</span>&nbsp;<span class="ident" id="4872976">stringWriter</span><span class="op" id="4872988">{</span><span class="ident" id="4872989">w</span><span class="op" id="4872990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872993">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872996">kvs</span><span class="op" id="4872999">,</span>&nbsp;<span class="ident" id="4873001">sorter</span>&nbsp;<span class="op" id="4873008">:=</span>&nbsp;<span class="ident" id="4873011">h</span><span class="op" id="4873012">.</span><span class="ident" id="4873013">sortedKeyValues</span><span class="op" id="4873028">(</span><span class="ident" id="4873029">exclude</span><span class="op" id="4873036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4873039">for</span>&nbsp;<span class="ident" id="4873043">_</span><span class="op" id="4873044">,</span>&nbsp;<span class="ident" id="4873046">kv</span>&nbsp;<span class="op" id="4873049">:=</span>&nbsp;<span class="keyword" id="4873052">range</span>&nbsp;<span class="ident" id="4873058">kvs</span>&nbsp;<span class="op" id="4873062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4873066">for</span>&nbsp;<span class="ident" id="4873070">_</span><span class="op" id="4873071">,</span>&nbsp;<span class="ident" id="4873073">v</span>&nbsp;<span class="op" id="4873075">:=</span>&nbsp;<span class="keyword" id="4873078">range</span>&nbsp;<span class="ident" id="4873084">kv</span><span class="op" id="4873086">.</span><span class="ident" id="4873087">values</span>&nbsp;<span class="op" id="4873094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4873099">v</span>&nbsp;<span class="op" id="4873101">=</span>&nbsp;<span class="ident" id="4873103">headerNewlineToSpace</span><span class="op" id="4873123">.</span><span class="ident" id="4873124">Replace</span><span class="op" id="4873131">(</span><span class="ident" id="4873132">v</span><span class="op" id="4873133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4873138">v</span>&nbsp;<span class="op" id="4873140">=</span>&nbsp;<span class="ident" id="4873142">textproto</span><span class="op" id="4873151">.</span><span class="ident" id="4873152">TrimString</span><span class="op" id="4873162">(</span><span class="ident" id="4873163">v</span><span class="op" id="4873164">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4873169">for</span>&nbsp;<span class="ident" id="4873173">_</span><span class="op" id="4873174">,</span>&nbsp;<span class="ident" id="4873176">s</span>&nbsp;<span class="op" id="4873178">:=</span>&nbsp;<span class="keyword" id="4873181">range</span>&nbsp;<span class="op" id="4873187">[</span><span class="op" id="4873188">]</span><span class="builtintype" id="4873189">string</span><span class="op" id="4873195">{</span><span class="ident" id="4873196">kv</span><span class="op" id="4873198">.</span><span class="ident" id="4873199">key</span><span class="op" id="4873202">,</span>&nbsp;<span class="string" id="4873204">&#34;:&nbsp;&#34;</span><span class="op" id="4873208">,</span>&nbsp;<span class="ident" id="4873210">v</span><span class="op" id="4873211">,</span>&nbsp;<span class="string" id="4873213">&#34;\r\n&#34;</span><span class="op" id="4873219">}</span>&nbsp;<span class="op" id="4873221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4873227">if</span>&nbsp;<span class="ident" id="4873230">_</span><span class="op" id="4873231">,</span>&nbsp;<span class="ident" id="4873233">err</span>&nbsp;<span class="op" id="4873237">:=</span>&nbsp;<span class="ident" id="4873240">ws</span><span class="op" id="4873242">.</span><span class="ident" id="4873243">WriteString</span><span class="op" id="4873254">(</span><span class="ident" id="4873255">s</span><span class="op" id="4873256">)</span><span class="op" id="4873257">;</span>&nbsp;<span class="ident" id="4873259">err</span>&nbsp;<span class="op" id="4873263">!=</span>&nbsp;<span class="ident" id="4873266">nil</span>&nbsp;<span class="op" id="4873270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4873277">return</span>&nbsp;<span class="ident" id="4873284">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4873292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4873297">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4873301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4873304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4873307">headerSorterPool</span><span class="op" id="4873323">.</span><span class="ident" id="4873324">Put</span><span class="op" id="4873327">(</span><span class="ident" id="4873328">sorter</span><span class="op" id="4873334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4873337">return</span>&nbsp;<span class="ident" id="4873344">nil</span><br>
<span class="lineno"></span><span class="op" id="4873348">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="4873351">//&nbsp;CanonicalHeaderKey&nbsp;returns&nbsp;the&nbsp;canonical&nbsp;format&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4873409">//&nbsp;header&nbsp;key&nbsp;s.&nbsp;&nbsp;The&nbsp;canonicalization&nbsp;converts&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="4873467">//&nbsp;letter&nbsp;and&nbsp;any&nbsp;letter&nbsp;following&nbsp;a&nbsp;hyphen&nbsp;to&nbsp;upper&nbsp;case;</span><br>
<span class="lineno"></span><span class="comment" id="4873526">//&nbsp;the&nbsp;rest&nbsp;are&nbsp;converted&nbsp;to&nbsp;lowercase.&nbsp;&nbsp;For&nbsp;example,&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="4873584">//&nbsp;canonical&nbsp;key&nbsp;for&nbsp;&#34;accept-encoding&#34;&nbsp;is&nbsp;&#34;Accept-Encoding&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4873645">func</span>&nbsp;<span class="ident" id="4873650">CanonicalHeaderKey</span><span class="op" id="4873668">(</span><span class="ident" id="4873669">s</span>&nbsp;<span class="builtintype" id="4873671">string</span><span class="op" id="4873677">)</span>&nbsp;<span class="builtintype" id="4873679">string</span>&nbsp;<span class="op" id="4873686">{</span>&nbsp;<span class="keyword" id="4873688">return</span>&nbsp;<span class="ident" id="4873695">textproto</span><span class="op" id="4873704">.</span><span class="ident" id="4873705">CanonicalMIMEHeaderKey</span><span class="op" id="4873727">(</span><span class="ident" id="4873728">s</span><span class="op" id="4873729">)</span>&nbsp;<span class="op" id="4873731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4873734">//&nbsp;hasToken&nbsp;reports&nbsp;whether&nbsp;token&nbsp;appears&nbsp;with&nbsp;v,&nbsp;ASCII</span><br>
<span class="lineno"></span><span class="comment" id="4873790">//&nbsp;case-insensitive,&nbsp;with&nbsp;space&nbsp;or&nbsp;comma&nbsp;boundaries.</span><br>
<span class="lineno">175</span><span class="comment" id="4873843">//&nbsp;token&nbsp;must&nbsp;be&nbsp;all&nbsp;lowercase.</span><br>
<span class="lineno"></span><span class="comment" id="4873875">//&nbsp;v&nbsp;may&nbsp;contain&nbsp;mixed&nbsp;cased.</span><br>
<span class="lineno"></span><span class="keyword" id="4873905">func</span>&nbsp;<span class="ident" id="4873910">hasToken</span><span class="op" id="4873918">(</span><span class="ident" id="4873919">v</span><span class="op" id="4873920">,</span>&nbsp;<span class="ident" id="4873922">token</span>&nbsp;<span class="builtintype" id="4873928">string</span><span class="op" id="4873934">)</span>&nbsp;<span class="builtintype" id="4873936">bool</span>&nbsp;<span class="op" id="4873941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4873944">if</span>&nbsp;<span class="builtinfunc" id="4873947">len</span><span class="op" id="4873950">(</span><span class="ident" id="4873951">token</span><span class="op" id="4873956">)</span>&nbsp;<span class="op" id="4873958">&gt;</span>&nbsp;<span class="builtinfunc" id="4873960">len</span><span class="op" id="4873963">(</span><span class="ident" id="4873964">v</span><span class="op" id="4873965">)</span>&nbsp;<span class="op" id="4873967">||</span>&nbsp;<span class="ident" id="4873970">token</span>&nbsp;<span class="op" id="4873976">==</span>&nbsp;<span class="string" id="4873979">&#34;&#34;</span>&nbsp;<span class="op" id="4873982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4873986">return</span>&nbsp;<span class="builtintype" id="4873993">false</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4874000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874003">if</span>&nbsp;<span class="ident" id="4874006">v</span>&nbsp;<span class="op" id="4874008">==</span>&nbsp;<span class="ident" id="4874011">token</span>&nbsp;<span class="op" id="4874017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874021">return</span>&nbsp;<span class="builtintype" id="4874028">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4874034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874037">for</span>&nbsp;<span class="ident" id="4874041">sp</span>&nbsp;<span class="op" id="4874044">:=</span>&nbsp;<span class="num" id="4874047">0</span><span class="op" id="4874048">;</span>&nbsp;<span class="ident" id="4874050">sp</span>&nbsp;<span class="op" id="4874053">&lt;=</span>&nbsp;<span class="builtinfunc" id="4874056">len</span><span class="op" id="4874059">(</span><span class="ident" id="4874060">v</span><span class="op" id="4874061">)</span><span class="op" id="4874062">-</span><span class="builtinfunc" id="4874063">len</span><span class="op" id="4874066">(</span><span class="ident" id="4874067">token</span><span class="op" id="4874072">)</span><span class="op" id="4874073">;</span>&nbsp;<span class="ident" id="4874075">sp</span><span class="op" id="4874077">++</span>&nbsp;<span class="op" id="4874080">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4874084">//&nbsp;Check&nbsp;that&nbsp;first&nbsp;character&nbsp;is&nbsp;good.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4874125">//&nbsp;The&nbsp;token&nbsp;is&nbsp;ASCII,&nbsp;so&nbsp;checking&nbsp;only&nbsp;a&nbsp;single&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4874181">//&nbsp;is&nbsp;sufficient.&nbsp;&nbsp;We&nbsp;skip&nbsp;this&nbsp;potential&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4874234">//&nbsp;position&nbsp;if&nbsp;both&nbsp;the&nbsp;first&nbsp;byte&nbsp;and&nbsp;its&nbsp;potential</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4874289">//&nbsp;ASCII&nbsp;uppercase&nbsp;equivalent&nbsp;(b|0x20)&nbsp;don&#39;t&nbsp;match.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4874343">//&nbsp;False&nbsp;positives&nbsp;(&#39;^&#39;&nbsp;=&gt;&nbsp;&#39;~&#39;)&nbsp;are&nbsp;caught&nbsp;by&nbsp;EqualFold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874402">if</span>&nbsp;<span class="ident" id="4874405">b</span>&nbsp;<span class="op" id="4874407">:=</span>&nbsp;<span class="ident" id="4874410">v</span><span class="op" id="4874411">[</span><span class="ident" id="4874412">sp</span><span class="op" id="4874414">]</span><span class="op" id="4874415">;</span>&nbsp;<span class="ident" id="4874417">b</span>&nbsp;<span class="op" id="4874419">!=</span>&nbsp;<span class="ident" id="4874422">token</span><span class="op" id="4874427">[</span><span class="num" id="4874428">0</span><span class="op" id="4874429">]</span>&nbsp;<span class="op" id="4874431">&amp;&amp;</span>&nbsp;<span class="ident" id="4874434">b</span><span class="op" id="4874435">|</span><span class="num" id="4874436">0x20</span>&nbsp;<span class="op" id="4874441">!=</span>&nbsp;<span class="ident" id="4874444">token</span><span class="op" id="4874449">[</span><span class="num" id="4874450">0</span><span class="op" id="4874451">]</span>&nbsp;<span class="op" id="4874453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874458">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4874469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4874473">//&nbsp;Check&nbsp;that&nbsp;start&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874529">if</span>&nbsp;<span class="ident" id="4874532">sp</span>&nbsp;<span class="op" id="4874535">&gt;</span>&nbsp;<span class="num" id="4874537">0</span>&nbsp;<span class="op" id="4874539">&amp;&amp;</span>&nbsp;<span class="op" id="4874542">!</span><span class="ident" id="4874543">isTokenBoundary</span><span class="op" id="4874558">(</span><span class="ident" id="4874559">v</span><span class="op" id="4874560">[</span><span class="ident" id="4874561">sp</span><span class="op" id="4874563">-</span><span class="num" id="4874564">1</span><span class="op" id="4874565">]</span><span class="op" id="4874566">)</span>&nbsp;<span class="op" id="4874568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874573">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4874584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4874588">//&nbsp;Check&nbsp;that&nbsp;end&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874642">if</span>&nbsp;<span class="ident" id="4874645">endPos</span>&nbsp;<span class="op" id="4874652">:=</span>&nbsp;<span class="ident" id="4874655">sp</span>&nbsp;<span class="op" id="4874658">+</span>&nbsp;<span class="builtinfunc" id="4874660">len</span><span class="op" id="4874663">(</span><span class="ident" id="4874664">token</span><span class="op" id="4874669">)</span><span class="op" id="4874670">;</span>&nbsp;<span class="ident" id="4874672">endPos</span>&nbsp;<span class="op" id="4874679">!=</span>&nbsp;<span class="builtinfunc" id="4874682">len</span><span class="op" id="4874685">(</span><span class="ident" id="4874686">v</span><span class="op" id="4874687">)</span>&nbsp;<span class="op" id="4874689">&amp;&amp;</span>&nbsp;<span class="op" id="4874692">!</span><span class="ident" id="4874693">isTokenBoundary</span><span class="op" id="4874708">(</span><span class="ident" id="4874709">v</span><span class="op" id="4874710">[</span><span class="ident" id="4874711">endPos</span><span class="op" id="4874717">]</span><span class="op" id="4874718">)</span>&nbsp;<span class="op" id="4874720">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874725">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4874736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874740">if</span>&nbsp;<span class="ident" id="4874743">strings</span><span class="op" id="4874750">.</span><span class="ident" id="4874751">EqualFold</span><span class="op" id="4874760">(</span><span class="ident" id="4874761">v</span><span class="op" id="4874762">[</span><span class="ident" id="4874763">sp</span><span class="op" id="4874765">:</span><span class="ident" id="4874766">sp</span><span class="op" id="4874768">+</span><span class="builtinfunc" id="4874769">len</span><span class="op" id="4874772">(</span><span class="ident" id="4874773">token</span><span class="op" id="4874778">)</span><span class="op" id="4874779">]</span><span class="op" id="4874780">,</span>&nbsp;<span class="ident" id="4874782">token</span><span class="op" id="4874787">)</span>&nbsp;<span class="op" id="4874789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874794">return</span>&nbsp;<span class="builtintype" id="4874801">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4874808">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4874811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874814">return</span>&nbsp;<span class="builtintype" id="4874821">false</span><br>
<span class="lineno"></span><span class="op" id="4874827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4874830">func</span>&nbsp;<span class="ident" id="4874835">isTokenBoundary</span><span class="op" id="4874850">(</span><span class="ident" id="4874851">b</span>&nbsp;<span class="builtintype" id="4874853">byte</span><span class="op" id="4874857">)</span>&nbsp;<span class="builtintype" id="4874859">bool</span>&nbsp;<span class="op" id="4874864">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874867">return</span>&nbsp;<span class="ident" id="4874874">b</span>&nbsp;<span class="op" id="4874876">==</span>&nbsp;<span class="string" id="4874879">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4874883">||</span>&nbsp;<span class="ident" id="4874886">b</span>&nbsp;<span class="op" id="4874888">==</span>&nbsp;<span class="string" id="4874891">&#39;,&#39;</span>&nbsp;<span class="op" id="4874895">||</span>&nbsp;<span class="ident" id="4874898">b</span>&nbsp;<span class="op" id="4874900">==</span>&nbsp;<span class="string" id="4874903">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="4874908">}</span>
</div>
</body>
</html>
