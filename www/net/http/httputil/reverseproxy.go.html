<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6268461">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6268516">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6268570">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6268621">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6268652">package</span>&nbsp;<span class="ident" id="6268660">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6268670">import</span>&nbsp;<span class="op" id="6268677">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6268680">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6268686">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6268693">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6268700">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6268712">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6268723">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6268734">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6268742">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6268749">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6268752">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6268825">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="6268851">var</span>&nbsp;<span class="ident" id="6268855">onExitFlushLoop</span>&nbsp;<span class="keyword" id="6268871">func</span><span class="op" id="6268875">(</span><span class="op" id="6268876">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6268879">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="6268949">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6269014">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="6269025">type</span>&nbsp;<span class="ident" id="6269030">ReverseProxy</span>&nbsp;<span class="keyword" id="6269043">struct</span>&nbsp;<span class="op" id="6269050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269053">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269100">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269146">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269195">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6269239">Director</span>&nbsp;<span class="keyword" id="6269248">func</span><span class="op" id="6269252">(</span><span class="op" id="6269253">*</span><span class="ident" id="6269254"><a href="/net/http/httputil/reverseproxy.go.html#6268700">http</a></span><span class="op" id="6269258">.</span><span class="ident" id="6269259">Request</span><span class="op" id="6269266">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269270">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269320">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6269363">Transport</span>&nbsp;<span class="ident" id="6269373"><a href="/net/http/httputil/reverseproxy.go.html#6268700">http</a></span><span class="op" id="6269377">.</span><span class="ident" id="6269378">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269393">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269440">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269485">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269504">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6269547">FlushInterval</span>&nbsp;<span class="ident" id="6269561"><a href="/net/http/httputil/reverseproxy.go.html#6268742">time</a></span><span class="op" id="6269565">.</span><span class="ident" id="6269566">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269577">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269630">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269683">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269743">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6269764">ErrorLog</span>&nbsp;<span class="op" id="6269773">*</span><span class="ident" id="6269774"><a href="/net/http/httputil/reverseproxy.go.html#6268686">log</a></span><span class="op" id="6269777">.</span><span class="ident" id="6269778">Logger</span><br>
<span class="lineno"></span><span class="op" id="6269785">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6269788">func</span>&nbsp;<span class="ident" id="6269793">singleJoiningSlash</span><span class="op" id="6269811">(</span><span class="ident" id="6269812">a</span><span class="op" id="6269813">,</span>&nbsp;<span class="ident" id="6269815">b</span>&nbsp;<span class="builtintype" id="6269817">string</span><span class="op" id="6269823">)</span>&nbsp;<span class="builtintype" id="6269825">string</span>&nbsp;<span class="op" id="6269832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6269835">aslash</span>&nbsp;<span class="op" id="6269842">:=</span>&nbsp;<span class="ident" id="6269845"><a href="/net/http/httputil/reverseproxy.go.html#6268723">strings</a></span><span class="op" id="6269852">.</span><span class="ident" id="6269853">HasSuffix</span><span class="op" id="6269862">(</span><span class="ident" id="6269863"><a href="/net/http/httputil/reverseproxy.go.html#6269812">a</a></span><span class="op" id="6269864">,</span>&nbsp;<span class="string" id="6269866">&#34;/&#34;</span><span class="op" id="6269869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6269872">bslash</span>&nbsp;<span class="op" id="6269879">:=</span>&nbsp;<span class="ident" id="6269882"><a href="/net/http/httputil/reverseproxy.go.html#6268723">strings</a></span><span class="op" id="6269889">.</span><span class="ident" id="6269890">HasPrefix</span><span class="op" id="6269899">(</span><span class="ident" id="6269900"><a href="/net/http/httputil/reverseproxy.go.html#6269815">b</a></span><span class="op" id="6269901">,</span>&nbsp;<span class="string" id="6269903">&#34;/&#34;</span><span class="op" id="6269906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6269909">switch</span>&nbsp;<span class="op" id="6269916">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6269919">case</span>&nbsp;<span class="ident" id="6269924"><a href="/net/http/httputil/reverseproxy.go.html#6269835">aslash</a></span>&nbsp;<span class="op" id="6269931">&amp;&amp;</span>&nbsp;<span class="ident" id="6269934"><a href="/net/http/httputil/reverseproxy.go.html#6269872">bslash</a></span><span class="op" id="6269940">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6269944">return</span>&nbsp;<span class="ident" id="6269951"><a href="/net/http/httputil/reverseproxy.go.html#6269812">a</a></span>&nbsp;<span class="op" id="6269953">+</span>&nbsp;<span class="ident" id="6269955"><a href="/net/http/httputil/reverseproxy.go.html#6269815">b</a></span><span class="op" id="6269956">[</span><span class="num" id="6269957">1</span><span class="op" id="6269958">:</span><span class="op" id="6269959">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6269962">case</span>&nbsp;<span class="op" id="6269967">!</span><span class="ident" id="6269968"><a href="/net/http/httputil/reverseproxy.go.html#6269835">aslash</a></span>&nbsp;<span class="op" id="6269975">&amp;&amp;</span>&nbsp;<span class="op" id="6269978">!</span><span class="ident" id="6269979"><a href="/net/http/httputil/reverseproxy.go.html#6269872">bslash</a></span><span class="op" id="6269985">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6269989">return</span>&nbsp;<span class="ident" id="6269996"><a href="/net/http/httputil/reverseproxy.go.html#6269812">a</a></span>&nbsp;<span class="op" id="6269998">+</span>&nbsp;<span class="string" id="6270000">&#34;/&#34;</span>&nbsp;<span class="op" id="6270004">+</span>&nbsp;<span class="ident" id="6270006"><a href="/net/http/httputil/reverseproxy.go.html#6269815">b</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270009">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270012">return</span>&nbsp;<span class="ident" id="6270019"><a href="/net/http/httputil/reverseproxy.go.html#6269812">a</a></span>&nbsp;<span class="op" id="6270021">+</span>&nbsp;<span class="ident" id="6270023"><a href="/net/http/httputil/reverseproxy.go.html#6269815">b</a></span><br>
<span class="lineno"></span><span class="op" id="6270025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6270028">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="6270098">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="6270168">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="6270237">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="6270282">func</span>&nbsp;<span class="ident" id="6270287">NewSingleHostReverseProxy</span><span class="op" id="6270312">(</span><span class="ident" id="6270313">target</span>&nbsp;<span class="op" id="6270320">*</span><span class="ident" id="6270321"><a href="/net/http/httputil/reverseproxy.go.html#6268712">url</a></span><span class="op" id="6270324">.</span><span class="ident" id="6270325">URL</span><span class="op" id="6270328">)</span>&nbsp;<span class="op" id="6270330">*</span><span class="ident" id="6270331"><a href="/net/http/httputil/reverseproxy.go.html#6269030">ReverseProxy</a></span>&nbsp;<span class="op" id="6270344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270347">targetQuery</span>&nbsp;<span class="op" id="6270359">:=</span>&nbsp;<span class="ident" id="6270362"><a href="/net/http/httputil/reverseproxy.go.html#6270313">target</a></span><span class="op" id="6270368">.</span><span class="ident" id="6270369">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270379">director</span>&nbsp;<span class="op" id="6270388">:=</span>&nbsp;<span class="keyword" id="6270391">func</span><span class="op" id="6270395">(</span><span class="ident" id="6270396">req</span>&nbsp;<span class="op" id="6270400">*</span><span class="ident" id="6270401"><a href="/net/http/httputil/reverseproxy.go.html#6268700">http</a></span><span class="op" id="6270405">.</span><span class="ident" id="6270406">Request</span><span class="op" id="6270413">)</span>&nbsp;<span class="op" id="6270415">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270419"><a href="/net/http/httputil/reverseproxy.go.html#6270396">req</a></span><span class="op" id="6270422">.</span><span class="ident" id="6270423">URL</span><span class="op" id="6270426">.</span><span class="ident" id="6270427">Scheme</span>&nbsp;<span class="op" id="6270434">=</span>&nbsp;<span class="ident" id="6270436"><a href="/net/http/httputil/reverseproxy.go.html#6270313">target</a></span><span class="op" id="6270442">.</span><span class="ident" id="6270443">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270452"><a href="/net/http/httputil/reverseproxy.go.html#6270396">req</a></span><span class="op" id="6270455">.</span><span class="ident" id="6270456">URL</span><span class="op" id="6270459">.</span><span class="ident" id="6270460">Host</span>&nbsp;<span class="op" id="6270465">=</span>&nbsp;<span class="ident" id="6270467"><a href="/net/http/httputil/reverseproxy.go.html#6270313">target</a></span><span class="op" id="6270473">.</span><span class="ident" id="6270474">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270481"><a href="/net/http/httputil/reverseproxy.go.html#6270396">req</a></span><span class="op" id="6270484">.</span><span class="ident" id="6270485">URL</span><span class="op" id="6270488">.</span><span class="ident" id="6270489">Path</span>&nbsp;<span class="op" id="6270494">=</span>&nbsp;<span class="ident" id="6270496"><a href="/net/http/httputil/reverseproxy.go.html#6269793">singleJoiningSlash</a></span><span class="op" id="6270514">(</span><span class="ident" id="6270515"><a href="/net/http/httputil/reverseproxy.go.html#6270313">target</a></span><span class="op" id="6270521">.</span><span class="ident" id="6270522">Path</span><span class="op" id="6270526">,</span>&nbsp;<span class="ident" id="6270528"><a href="/net/http/httputil/reverseproxy.go.html#6270396">req</a></span><span class="op" id="6270531">.</span><span class="ident" id="6270532">URL</span><span class="op" id="6270535">.</span><span class="ident" id="6270536">Path</span><span class="op" id="6270540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270544">if</span>&nbsp;<span class="ident" id="6270547"><a href="/net/http/httputil/reverseproxy.go.html#6270347">targetQuery</a></span>&nbsp;<span class="op" id="6270559">==</span>&nbsp;<span class="string" id="6270562">&#34;&#34;</span>&nbsp;<span class="op" id="6270565">||</span>&nbsp;<span class="ident" id="6270568"><a href="/net/http/httputil/reverseproxy.go.html#6270396">req</a></span><span class="op" id="6270571">.</span><span class="ident" id="6270572">URL</span><span class="op" id="6270575">.</span><span class="ident" id="6270576">RawQuery</span>&nbsp;<span class="op" id="6270585">==</span>&nbsp;<span class="string" id="6270588">&#34;&#34;</span>&nbsp;<span class="op" id="6270591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270596"><a href="/net/http/httputil/reverseproxy.go.html#6270396">req</a></span><span class="op" id="6270599">.</span><span class="ident" id="6270600">URL</span><span class="op" id="6270603">.</span><span class="ident" id="6270604">RawQuery</span>&nbsp;<span class="op" id="6270613">=</span>&nbsp;<span class="ident" id="6270615"><a href="/net/http/httputil/reverseproxy.go.html#6270347">targetQuery</a></span>&nbsp;<span class="op" id="6270627">+</span>&nbsp;<span class="ident" id="6270629"><a href="/net/http/httputil/reverseproxy.go.html#6270396">req</a></span><span class="op" id="6270632">.</span><span class="ident" id="6270633">URL</span><span class="op" id="6270636">.</span><span class="ident" id="6270637">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270648">}</span>&nbsp;<span class="keyword" id="6270650">else</span>&nbsp;<span class="op" id="6270655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270660"><a href="/net/http/httputil/reverseproxy.go.html#6270396">req</a></span><span class="op" id="6270663">.</span><span class="ident" id="6270664">URL</span><span class="op" id="6270667">.</span><span class="ident" id="6270668">RawQuery</span>&nbsp;<span class="op" id="6270677">=</span>&nbsp;<span class="ident" id="6270679"><a href="/net/http/httputil/reverseproxy.go.html#6270347">targetQuery</a></span>&nbsp;<span class="op" id="6270691">+</span>&nbsp;<span class="string" id="6270693">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="6270697">+</span>&nbsp;<span class="ident" id="6270699"><a href="/net/http/httputil/reverseproxy.go.html#6270396">req</a></span><span class="op" id="6270702">.</span><span class="ident" id="6270703">URL</span><span class="op" id="6270706">.</span><span class="ident" id="6270707">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270724">return</span>&nbsp;<span class="op" id="6270731">&amp;</span><span class="ident" id="6270732"><a href="/net/http/httputil/reverseproxy.go.html#6269030">ReverseProxy</a></span><span class="op" id="6270744">{</span><span class="ident" id="6270745">Director</span><span class="op" id="6270753">:</span>&nbsp;<span class="ident" id="6270755"><a href="/net/http/httputil/reverseproxy.go.html#6270379">director</a></span><span class="op" id="6270763">}</span><br>
<span class="lineno">80</span><span class="op" id="6270765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6270768">func</span>&nbsp;<span class="ident" id="6270773">copyHeader</span><span class="op" id="6270783">(</span><span class="ident" id="6270784">dst</span><span class="op" id="6270787">,</span>&nbsp;<span class="ident" id="6270789">src</span>&nbsp;<span class="ident" id="6270793"><a href="/net/http/httputil/reverseproxy.go.html#6268700">http</a></span><span class="op" id="6270797">.</span><span class="ident" id="6270798">Header</span><span class="op" id="6270804">)</span>&nbsp;<span class="op" id="6270806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270809">for</span>&nbsp;<span class="ident" id="6270813">k</span><span class="op" id="6270814">,</span>&nbsp;<span class="ident" id="6270816">vv</span>&nbsp;<span class="op" id="6270819">:=</span>&nbsp;<span class="keyword" id="6270822">range</span>&nbsp;<span class="ident" id="6270828"><a href="/net/http/httputil/reverseproxy.go.html#6270789">src</a></span>&nbsp;<span class="op" id="6270832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270836">for</span>&nbsp;<span class="ident" id="6270840">_</span><span class="op" id="6270841">,</span>&nbsp;<span class="ident" id="6270843">v</span>&nbsp;<span class="op" id="6270845">:=</span>&nbsp;<span class="keyword" id="6270848">range</span>&nbsp;<span class="ident" id="6270854"><a href="/net/http/httputil/reverseproxy.go.html#6270816">vv</a></span>&nbsp;<span class="op" id="6270857">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270862"><a href="/net/http/httputil/reverseproxy.go.html#6270784">dst</a></span><span class="op" id="6270865">.</span><span class="ident" id="6270866">Add</span><span class="op" id="6270869">(</span><span class="ident" id="6270870"><a href="/net/http/httputil/reverseproxy.go.html#6270813">k</a></span><span class="op" id="6270871">,</span>&nbsp;<span class="ident" id="6270873"><a href="/net/http/httputil/reverseproxy.go.html#6270843">v</a></span><span class="op" id="6270874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270881">}</span><br>
<span class="lineno"></span><span class="op" id="6270883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="6270886">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="6270953">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="6271011">var</span>&nbsp;<span class="ident" id="6271015">hopHeaders</span>&nbsp;<span class="op" id="6271026">=</span>&nbsp;<span class="op" id="6271028">[</span><span class="op" id="6271029">]</span><span class="builtintype" id="6271030">string</span><span class="op" id="6271036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6271039">&#34;Connection&#34;</span><span class="op" id="6271051">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6271054">&#34;Keep-Alive&#34;</span><span class="op" id="6271066">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6271069">&#34;Proxy-Authenticate&#34;</span><span class="op" id="6271089">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6271092">&#34;Proxy-Authorization&#34;</span><span class="op" id="6271113">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6271116">&#34;Te&#34;</span><span class="op" id="6271120">,</span>&nbsp;<span class="comment" id="6271122">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6271156">&#34;Trailers&#34;</span><span class="op" id="6271166">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6271169">&#34;Transfer-Encoding&#34;</span><span class="op" id="6271188">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6271191">&#34;Upgrade&#34;</span><span class="op" id="6271200">,</span><br>
<span class="lineno"></span><span class="op" id="6271202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6271205">func</span>&nbsp;<span class="op" id="6271210">(</span><span class="ident" id="6271211">p</span>&nbsp;<span class="op" id="6271213">*</span><span class="ident" id="6271214"><a href="/net/http/httputil/reverseproxy.go.html#6269030">ReverseProxy</a></span><span class="op" id="6271226">)</span>&nbsp;<span class="ident" id="6271228">ServeHTTP</span><span class="op" id="6271237">(</span><span class="ident" id="6271238">rw</span>&nbsp;<span class="ident" id="6271241"><a href="/net/http/httputil/reverseproxy.go.html#6268700">http</a></span><span class="op" id="6271245">.</span><span class="ident" id="6271246">ResponseWriter</span><span class="op" id="6271260">,</span>&nbsp;<span class="ident" id="6271262">req</span>&nbsp;<span class="op" id="6271266">*</span><span class="ident" id="6271267"><a href="/net/http/httputil/reverseproxy.go.html#6268700">http</a></span><span class="op" id="6271271">.</span><span class="ident" id="6271272">Request</span><span class="op" id="6271279">)</span>&nbsp;<span class="op" id="6271281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271284">transport</span>&nbsp;<span class="op" id="6271294">:=</span>&nbsp;<span class="ident" id="6271297"><a href="/net/http/httputil/reverseproxy.go.html#6271211">p</a></span><span class="op" id="6271298">.</span><span class="ident" id="6271299">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6271310">if</span>&nbsp;<span class="ident" id="6271313"><a href="/net/http/httputil/reverseproxy.go.html#6271284">transport</a></span>&nbsp;<span class="op" id="6271323">==</span>&nbsp;<span class="ident" id="6271326">nil</span>&nbsp;<span class="op" id="6271330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271334"><a href="/net/http/httputil/reverseproxy.go.html#6271284">transport</a></span>&nbsp;<span class="op" id="6271344">=</span>&nbsp;<span class="ident" id="6271346"><a href="/net/http/httputil/reverseproxy.go.html#6268700">http</a></span><span class="op" id="6271350">.</span><span class="ident" id="6271351">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6271369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271373">outreq</span>&nbsp;<span class="op" id="6271380">:=</span>&nbsp;<span class="builtinfunc" id="6271383">new</span><span class="op" id="6271386">(</span><span class="ident" id="6271387"><a href="/net/http/httputil/reverseproxy.go.html#6268700">http</a></span><span class="op" id="6271391">.</span><span class="ident" id="6271392">Request</span><span class="op" id="6271399">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6271402">*</span><span class="ident" id="6271403"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span>&nbsp;<span class="op" id="6271410">=</span>&nbsp;<span class="op" id="6271412">*</span><span class="ident" id="6271413"><a href="/net/http/httputil/reverseproxy.go.html#6271262">req</a></span>&nbsp;<span class="comment" id="6271417">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271464"><a href="/net/http/httputil/reverseproxy.go.html#6271211">p</a></span><span class="op" id="6271465">.</span><span class="ident" id="6271466">Director</span><span class="op" id="6271474">(</span><span class="ident" id="6271475"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span><span class="op" id="6271481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271484"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span><span class="op" id="6271490">.</span><span class="ident" id="6271491">Proto</span>&nbsp;<span class="op" id="6271497">=</span>&nbsp;<span class="string" id="6271499">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271511"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span><span class="op" id="6271517">.</span><span class="ident" id="6271518">ProtoMajor</span>&nbsp;<span class="op" id="6271529">=</span>&nbsp;<span class="num" id="6271531">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271534"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span><span class="op" id="6271540">.</span><span class="ident" id="6271541">ProtoMinor</span>&nbsp;<span class="op" id="6271552">=</span>&nbsp;<span class="num" id="6271554">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271557"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span><span class="op" id="6271563">.</span><span class="ident" id="6271564">Close</span>&nbsp;<span class="op" id="6271570">=</span>&nbsp;<span class="ident" id="6271572">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6271580">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6271638">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6271697">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6271761">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6271820">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271871">copiedHeaders</span>&nbsp;<span class="op" id="6271885">:=</span>&nbsp;<span class="ident" id="6271888">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6271895">for</span>&nbsp;<span class="ident" id="6271899">_</span><span class="op" id="6271900">,</span>&nbsp;<span class="ident" id="6271902">h</span>&nbsp;<span class="op" id="6271904">:=</span>&nbsp;<span class="keyword" id="6271907">range</span>&nbsp;<span class="ident" id="6271913"><a href="/net/http/httputil/reverseproxy.go.html#6271015">hopHeaders</a></span>&nbsp;<span class="op" id="6271924">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6271928">if</span>&nbsp;<span class="ident" id="6271931"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span><span class="op" id="6271937">.</span><span class="ident" id="6271938">Header</span><span class="op" id="6271944">.</span><span class="ident" id="6271945">Get</span><span class="op" id="6271948">(</span><span class="ident" id="6271949"><a href="/net/http/httputil/reverseproxy.go.html#6271902">h</a></span><span class="op" id="6271950">)</span>&nbsp;<span class="op" id="6271952">!=</span>&nbsp;<span class="string" id="6271955">&#34;&#34;</span>&nbsp;<span class="op" id="6271958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6271963">if</span>&nbsp;<span class="op" id="6271966">!</span><span class="ident" id="6271967"><a href="/net/http/httputil/reverseproxy.go.html#6271871">copiedHeaders</a></span>&nbsp;<span class="op" id="6271981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271987"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span><span class="op" id="6271993">.</span><span class="ident" id="6271994">Header</span>&nbsp;<span class="op" id="6272001">=</span>&nbsp;<span class="builtinfunc" id="6272003">make</span><span class="op" id="6272007">(</span><span class="ident" id="6272008"><a href="/net/http/httputil/reverseproxy.go.html#6268700">http</a></span><span class="op" id="6272012">.</span><span class="ident" id="6272013">Header</span><span class="op" id="6272019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272025"><a href="/net/http/httputil/reverseproxy.go.html#6270773">copyHeader</a></span><span class="op" id="6272035">(</span><span class="ident" id="6272036"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span><span class="op" id="6272042">.</span><span class="ident" id="6272043">Header</span><span class="op" id="6272049">,</span>&nbsp;<span class="ident" id="6272051"><a href="/net/http/httputil/reverseproxy.go.html#6271262">req</a></span><span class="op" id="6272054">.</span><span class="ident" id="6272055">Header</span><span class="op" id="6272061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272067"><a href="/net/http/httputil/reverseproxy.go.html#6271871">copiedHeaders</a></span>&nbsp;<span class="op" id="6272081">=</span>&nbsp;<span class="ident" id="6272083">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6272091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272096"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span><span class="op" id="6272102">.</span><span class="ident" id="6272103">Header</span><span class="op" id="6272109">.</span><span class="ident" id="6272110">Del</span><span class="op" id="6272113">(</span><span class="ident" id="6272114"><a href="/net/http/httputil/reverseproxy.go.html#6271902">h</a></span><span class="op" id="6272115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6272119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6272122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272126">if</span>&nbsp;<span class="ident" id="6272129">clientIP</span><span class="op" id="6272137">,</span>&nbsp;<span class="ident" id="6272139">_</span><span class="op" id="6272140">,</span>&nbsp;<span class="ident" id="6272142">err</span>&nbsp;<span class="op" id="6272146">:=</span>&nbsp;<span class="ident" id="6272149"><a href="/net/http/httputil/reverseproxy.go.html#6268693">net</a></span><span class="op" id="6272152">.</span><span class="ident" id="6272153">SplitHostPort</span><span class="op" id="6272166">(</span><span class="ident" id="6272167"><a href="/net/http/httputil/reverseproxy.go.html#6271262">req</a></span><span class="op" id="6272170">.</span><span class="ident" id="6272171">RemoteAddr</span><span class="op" id="6272181">)</span><span class="op" id="6272182">;</span>&nbsp;<span class="ident" id="6272184"><a href="/net/http/httputil/reverseproxy.go.html#6272142">err</a></span>&nbsp;<span class="op" id="6272188">==</span>&nbsp;<span class="ident" id="6272191">nil</span>&nbsp;<span class="op" id="6272195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6272199">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6272246">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6272296">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272352">if</span>&nbsp;<span class="ident" id="6272355">prior</span><span class="op" id="6272360">,</span>&nbsp;<span class="ident" id="6272362">ok</span>&nbsp;<span class="op" id="6272365">:=</span>&nbsp;<span class="ident" id="6272368"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span><span class="op" id="6272374">.</span><span class="ident" id="6272375">Header</span><span class="op" id="6272381">[</span><span class="string" id="6272382">&#34;X-Forwarded-For&#34;</span><span class="op" id="6272399">]</span><span class="op" id="6272400">;</span>&nbsp;<span class="ident" id="6272402"><a href="/net/http/httputil/reverseproxy.go.html#6272362">ok</a></span>&nbsp;<span class="op" id="6272405">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272410"><a href="/net/http/httputil/reverseproxy.go.html#6272129">clientIP</a></span>&nbsp;<span class="op" id="6272419">=</span>&nbsp;<span class="ident" id="6272421"><a href="/net/http/httputil/reverseproxy.go.html#6268723">strings</a></span><span class="op" id="6272428">.</span><span class="ident" id="6272429">Join</span><span class="op" id="6272433">(</span><span class="ident" id="6272434"><a href="/net/http/httputil/reverseproxy.go.html#6272355">prior</a></span><span class="op" id="6272439">,</span>&nbsp;<span class="string" id="6272441">&#34;,&nbsp;&#34;</span><span class="op" id="6272445">)</span>&nbsp;<span class="op" id="6272447">+</span>&nbsp;<span class="string" id="6272449">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="6272454">+</span>&nbsp;<span class="ident" id="6272456"><a href="/net/http/httputil/reverseproxy.go.html#6272129">clientIP</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6272467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272471"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span><span class="op" id="6272477">.</span><span class="ident" id="6272478">Header</span><span class="op" id="6272484">.</span><span class="ident" id="6272485">Set</span><span class="op" id="6272488">(</span><span class="string" id="6272489">&#34;X-Forwarded-For&#34;</span><span class="op" id="6272506">,</span>&nbsp;<span class="ident" id="6272508"><a href="/net/http/httputil/reverseproxy.go.html#6272129">clientIP</a></span><span class="op" id="6272516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6272519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272523">res</span><span class="op" id="6272526">,</span>&nbsp;<span class="ident" id="6272528">err</span>&nbsp;<span class="op" id="6272532">:=</span>&nbsp;<span class="ident" id="6272535"><a href="/net/http/httputil/reverseproxy.go.html#6271284">transport</a></span><span class="op" id="6272544">.</span><span class="ident" id="6272545">RoundTrip</span><span class="op" id="6272554">(</span><span class="ident" id="6272555"><a href="/net/http/httputil/reverseproxy.go.html#6271373">outreq</a></span><span class="op" id="6272561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272564">if</span>&nbsp;<span class="ident" id="6272567"><a href="/net/http/httputil/reverseproxy.go.html#6272528">err</a></span>&nbsp;<span class="op" id="6272571">!=</span>&nbsp;<span class="ident" id="6272574">nil</span>&nbsp;<span class="op" id="6272578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272582"><a href="/net/http/httputil/reverseproxy.go.html#6271211">p</a></span><span class="op" id="6272583">.</span><span class="ident" id="6272584">logf</span><span class="op" id="6272588">(</span><span class="string" id="6272589">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6272612">,</span>&nbsp;<span class="ident" id="6272614"><a href="/net/http/httputil/reverseproxy.go.html#6272528">err</a></span><span class="op" id="6272617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272621"><a href="/net/http/httputil/reverseproxy.go.html#6271238">rw</a></span><span class="op" id="6272623">.</span><span class="ident" id="6272624">WriteHeader</span><span class="op" id="6272635">(</span><span class="ident" id="6272636"><a href="/net/http/httputil/reverseproxy.go.html#6268700">http</a></span><span class="op" id="6272640">.</span><span class="ident" id="6272641">StatusInternalServerError</span><span class="op" id="6272666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272670">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6272678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272681">defer</span>&nbsp;<span class="ident" id="6272687"><a href="/net/http/httputil/reverseproxy.go.html#6272523">res</a></span><span class="op" id="6272690">.</span><span class="ident" id="6272691">Body</span><span class="op" id="6272695">.</span><span class="ident" id="6272696">Close</span><span class="op" id="6272701">(</span><span class="op" id="6272702">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272706">for</span>&nbsp;<span class="ident" id="6272710">_</span><span class="op" id="6272711">,</span>&nbsp;<span class="ident" id="6272713">h</span>&nbsp;<span class="op" id="6272715">:=</span>&nbsp;<span class="keyword" id="6272718">range</span>&nbsp;<span class="ident" id="6272724"><a href="/net/http/httputil/reverseproxy.go.html#6271015">hopHeaders</a></span>&nbsp;<span class="op" id="6272735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272739"><a href="/net/http/httputil/reverseproxy.go.html#6272523">res</a></span><span class="op" id="6272742">.</span><span class="ident" id="6272743">Header</span><span class="op" id="6272749">.</span><span class="ident" id="6272750">Del</span><span class="op" id="6272753">(</span><span class="ident" id="6272754"><a href="/net/http/httputil/reverseproxy.go.html#6272713">h</a></span><span class="op" id="6272755">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6272758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272762"><a href="/net/http/httputil/reverseproxy.go.html#6270773">copyHeader</a></span><span class="op" id="6272772">(</span><span class="ident" id="6272773"><a href="/net/http/httputil/reverseproxy.go.html#6271238">rw</a></span><span class="op" id="6272775">.</span><span class="ident" id="6272776">Header</span><span class="op" id="6272782">(</span><span class="op" id="6272783">)</span><span class="op" id="6272784">,</span>&nbsp;<span class="ident" id="6272786"><a href="/net/http/httputil/reverseproxy.go.html#6272523">res</a></span><span class="op" id="6272789">.</span><span class="ident" id="6272790">Header</span><span class="op" id="6272796">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272800"><a href="/net/http/httputil/reverseproxy.go.html#6271238">rw</a></span><span class="op" id="6272802">.</span><span class="ident" id="6272803">WriteHeader</span><span class="op" id="6272814">(</span><span class="ident" id="6272815"><a href="/net/http/httputil/reverseproxy.go.html#6272523">res</a></span><span class="op" id="6272818">.</span><span class="ident" id="6272819">StatusCode</span><span class="op" id="6272829">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272832"><a href="/net/http/httputil/reverseproxy.go.html#6271211">p</a></span><span class="op" id="6272833">.</span><span class="ident" id="6272834">copyResponse</span><span class="op" id="6272846">(</span><span class="ident" id="6272847"><a href="/net/http/httputil/reverseproxy.go.html#6271238">rw</a></span><span class="op" id="6272849">,</span>&nbsp;<span class="ident" id="6272851"><a href="/net/http/httputil/reverseproxy.go.html#6272523">res</a></span><span class="op" id="6272854">.</span><span class="ident" id="6272855">Body</span><span class="op" id="6272859">)</span><br>
<span class="lineno"></span><span class="op" id="6272861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6272864">func</span>&nbsp;<span class="op" id="6272869">(</span><span class="ident" id="6272870">p</span>&nbsp;<span class="op" id="6272872">*</span><span class="ident" id="6272873"><a href="/net/http/httputil/reverseproxy.go.html#6269030">ReverseProxy</a></span><span class="op" id="6272885">)</span>&nbsp;<span class="ident" id="6272887">copyResponse</span><span class="op" id="6272899">(</span><span class="ident" id="6272900">dst</span>&nbsp;<span class="ident" id="6272904"><a href="/net/http/httputil/reverseproxy.go.html#6268680">io</a></span><span class="op" id="6272906">.</span><span class="ident" id="6272907">Writer</span><span class="op" id="6272913">,</span>&nbsp;<span class="ident" id="6272915">src</span>&nbsp;<span class="ident" id="6272919"><a href="/net/http/httputil/reverseproxy.go.html#6268680">io</a></span><span class="op" id="6272921">.</span><span class="ident" id="6272922">Reader</span><span class="op" id="6272928">)</span>&nbsp;<span class="op" id="6272930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272933">if</span>&nbsp;<span class="ident" id="6272936"><a href="/net/http/httputil/reverseproxy.go.html#6272870">p</a></span><span class="op" id="6272937">.</span><span class="ident" id="6272938">FlushInterval</span>&nbsp;<span class="op" id="6272952">!=</span>&nbsp;<span class="num" id="6272955">0</span>&nbsp;<span class="op" id="6272957">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272961">if</span>&nbsp;<span class="ident" id="6272964">wf</span><span class="op" id="6272966">,</span>&nbsp;<span class="ident" id="6272968">ok</span>&nbsp;<span class="op" id="6272971">:=</span>&nbsp;<span class="ident" id="6272974"><a href="/net/http/httputil/reverseproxy.go.html#6272900">dst</a></span><span class="op" id="6272977">.</span><span class="op" id="6272978">(</span><span class="ident" id="6272979"><a href="/net/http/httputil/reverseproxy.go.html#6273373">writeFlusher</a></span><span class="op" id="6272991">)</span><span class="op" id="6272992">;</span>&nbsp;<span class="ident" id="6272994"><a href="/net/http/httputil/reverseproxy.go.html#6272968">ok</a></span>&nbsp;<span class="op" id="6272997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273002">mlw</span>&nbsp;<span class="op" id="6273006">:=</span>&nbsp;<span class="op" id="6273009">&amp;</span><span class="ident" id="6273010"><a href="/net/http/httputil/reverseproxy.go.html#6273431">maxLatencyWriter</a></span><span class="op" id="6273026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273032">dst</span><span class="op" id="6273035">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6273041"><a href="/net/http/httputil/reverseproxy.go.html#6272964">wf</a></span><span class="op" id="6273043">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273049">latency</span><span class="op" id="6273056">:</span>&nbsp;<span class="ident" id="6273058"><a href="/net/http/httputil/reverseproxy.go.html#6272870">p</a></span><span class="op" id="6273059">.</span><span class="ident" id="6273060">FlushInterval</span><span class="op" id="6273073">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273079">done</span><span class="op" id="6273083">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6273088">make</span><span class="op" id="6273092">(</span><span class="keyword" id="6273093">chan</span>&nbsp;<span class="builtintype" id="6273098">bool</span><span class="op" id="6273102">)</span><span class="op" id="6273103">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273113">go</span>&nbsp;<span class="ident" id="6273116"><a href="/net/http/httputil/reverseproxy.go.html#6273002">mlw</a></span><span class="op" id="6273119">.</span><span class="ident" id="6273120">flushLoop</span><span class="op" id="6273129">(</span><span class="op" id="6273130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273135">defer</span>&nbsp;<span class="ident" id="6273141"><a href="/net/http/httputil/reverseproxy.go.html#6273002">mlw</a></span><span class="op" id="6273144">.</span><span class="ident" id="6273145">stop</span><span class="op" id="6273149">(</span><span class="op" id="6273150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273155"><a href="/net/http/httputil/reverseproxy.go.html#6272900">dst</a></span>&nbsp;<span class="op" id="6273159">=</span>&nbsp;<span class="ident" id="6273161"><a href="/net/http/httputil/reverseproxy.go.html#6273002">mlw</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273167">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273174"><a href="/net/http/httputil/reverseproxy.go.html#6268680">io</a></span><span class="op" id="6273176">.</span><span class="ident" id="6273177">Copy</span><span class="op" id="6273181">(</span><span class="ident" id="6273182"><a href="/net/http/httputil/reverseproxy.go.html#6272900">dst</a></span><span class="op" id="6273185">,</span>&nbsp;<span class="ident" id="6273187"><a href="/net/http/httputil/reverseproxy.go.html#6272915">src</a></span><span class="op" id="6273190">)</span><br>
<span class="lineno"></span><span class="op" id="6273192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6273195">func</span>&nbsp;<span class="op" id="6273200">(</span><span class="ident" id="6273201">p</span>&nbsp;<span class="op" id="6273203">*</span><span class="ident" id="6273204"><a href="/net/http/httputil/reverseproxy.go.html#6269030">ReverseProxy</a></span><span class="op" id="6273216">)</span>&nbsp;<span class="ident" id="6273218">logf</span><span class="op" id="6273222">(</span><span class="ident" id="6273223">format</span>&nbsp;<span class="builtintype" id="6273230">string</span><span class="op" id="6273236">,</span>&nbsp;<span class="ident" id="6273238">args</span>&nbsp;<span class="op" id="6273243">...</span><span class="keyword" id="6273246">interface</span><span class="op" id="6273255">{</span><span class="op" id="6273256">}</span><span class="op" id="6273257">)</span>&nbsp;<span class="op" id="6273259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273262">if</span>&nbsp;<span class="ident" id="6273265"><a href="/net/http/httputil/reverseproxy.go.html#6273201">p</a></span><span class="op" id="6273266">.</span><span class="ident" id="6273267">ErrorLog</span>&nbsp;<span class="op" id="6273276">!=</span>&nbsp;<span class="ident" id="6273279">nil</span>&nbsp;<span class="op" id="6273283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273287"><a href="/net/http/httputil/reverseproxy.go.html#6273201">p</a></span><span class="op" id="6273288">.</span><span class="ident" id="6273289">ErrorLog</span><span class="op" id="6273297">.</span><span class="ident" id="6273298">Printf</span><span class="op" id="6273304">(</span><span class="ident" id="6273305"><a href="/net/http/httputil/reverseproxy.go.html#6273223">format</a></span><span class="op" id="6273311">,</span>&nbsp;<span class="ident" id="6273313"><a href="/net/http/httputil/reverseproxy.go.html#6273238">args</a></span><span class="op" id="6273317">...</span><span class="op" id="6273320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273323">}</span>&nbsp;<span class="keyword" id="6273325">else</span>&nbsp;<span class="op" id="6273330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273334"><a href="/net/http/httputil/reverseproxy.go.html#6268686">log</a></span><span class="op" id="6273337">.</span><span class="ident" id="6273338">Printf</span><span class="op" id="6273344">(</span><span class="ident" id="6273345"><a href="/net/http/httputil/reverseproxy.go.html#6273223">format</a></span><span class="op" id="6273351">,</span>&nbsp;<span class="ident" id="6273353"><a href="/net/http/httputil/reverseproxy.go.html#6273238">args</a></span><span class="op" id="6273357">...</span><span class="op" id="6273360">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273363">}</span><br>
<span class="lineno"></span><span class="op" id="6273365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6273368">type</span>&nbsp;<span class="ident" id="6273373">writeFlusher</span>&nbsp;<span class="keyword" id="6273386">interface</span>&nbsp;<span class="op" id="6273396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273399"><a href="/net/http/httputil/reverseproxy.go.html#6268680">io</a></span><span class="op" id="6273401">.</span><span class="ident" id="6273402">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273410"><a href="/net/http/httputil/reverseproxy.go.html#6268700">http</a></span><span class="op" id="6273414">.</span><span class="ident" id="6273415">Flusher</span><br>
<span class="lineno"></span><span class="op" id="6273423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6273426">type</span>&nbsp;<span class="ident" id="6273431">maxLatencyWriter</span>&nbsp;<span class="keyword" id="6273448">struct</span>&nbsp;<span class="op" id="6273455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273458">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6273466"><a href="/net/http/httputil/reverseproxy.go.html#6273373">writeFlusher</a></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273480">latency</span>&nbsp;<span class="ident" id="6273488"><a href="/net/http/httputil/reverseproxy.go.html#6268742">time</a></span><span class="op" id="6273492">.</span><span class="ident" id="6273493">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273504">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6273509"><a href="/net/http/httputil/reverseproxy.go.html#6268734">sync</a></span><span class="op" id="6273513">.</span><span class="ident" id="6273514">Mutex</span>&nbsp;<span class="comment" id="6273520">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273547">done</span>&nbsp;<span class="keyword" id="6273552">chan</span>&nbsp;<span class="builtintype" id="6273557">bool</span><br>
<span class="lineno"></span><span class="op" id="6273562">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="6273565">func</span>&nbsp;<span class="op" id="6273570">(</span><span class="ident" id="6273571">m</span>&nbsp;<span class="op" id="6273573">*</span><span class="ident" id="6273574"><a href="/net/http/httputil/reverseproxy.go.html#6273431">maxLatencyWriter</a></span><span class="op" id="6273590">)</span>&nbsp;<span class="ident" id="6273592">Write</span><span class="op" id="6273597">(</span><span class="ident" id="6273598">p</span>&nbsp;<span class="op" id="6273600">[</span><span class="op" id="6273601">]</span><span class="builtintype" id="6273602">byte</span><span class="op" id="6273606">)</span>&nbsp;<span class="op" id="6273608">(</span><span class="builtintype" id="6273609">int</span><span class="op" id="6273612">,</span>&nbsp;<span class="builtintype" id="6273614">error</span><span class="op" id="6273619">)</span>&nbsp;<span class="op" id="6273621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273624"><a href="/net/http/httputil/reverseproxy.go.html#6273571">m</a></span><span class="op" id="6273625">.</span><span class="ident" id="6273626">lk</span><span class="op" id="6273628">.</span><span class="ident" id="6273629">Lock</span><span class="op" id="6273633">(</span><span class="op" id="6273634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273637">defer</span>&nbsp;<span class="ident" id="6273643"><a href="/net/http/httputil/reverseproxy.go.html#6273571">m</a></span><span class="op" id="6273644">.</span><span class="ident" id="6273645">lk</span><span class="op" id="6273647">.</span><span class="ident" id="6273648">Unlock</span><span class="op" id="6273654">(</span><span class="op" id="6273655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273658">return</span>&nbsp;<span class="ident" id="6273665"><a href="/net/http/httputil/reverseproxy.go.html#6273571">m</a></span><span class="op" id="6273666">.</span><span class="ident" id="6273667">dst</span><span class="op" id="6273670">.</span><span class="ident" id="6273671">Write</span><span class="op" id="6273676">(</span><span class="ident" id="6273677"><a href="/net/http/httputil/reverseproxy.go.html#6273598">p</a></span><span class="op" id="6273678">)</span><br>
<span class="lineno">205</span><span class="op" id="6273680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6273683">func</span>&nbsp;<span class="op" id="6273688">(</span><span class="ident" id="6273689">m</span>&nbsp;<span class="op" id="6273691">*</span><span class="ident" id="6273692"><a href="/net/http/httputil/reverseproxy.go.html#6273431">maxLatencyWriter</a></span><span class="op" id="6273708">)</span>&nbsp;<span class="ident" id="6273710">flushLoop</span><span class="op" id="6273719">(</span><span class="op" id="6273720">)</span>&nbsp;<span class="op" id="6273722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273725">t</span>&nbsp;<span class="op" id="6273727">:=</span>&nbsp;<span class="ident" id="6273730"><a href="/net/http/httputil/reverseproxy.go.html#6268742">time</a></span><span class="op" id="6273734">.</span><span class="ident" id="6273735">NewTicker</span><span class="op" id="6273744">(</span><span class="ident" id="6273745"><a href="/net/http/httputil/reverseproxy.go.html#6273689">m</a></span><span class="op" id="6273746">.</span><span class="ident" id="6273747">latency</span><span class="op" id="6273754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273757">defer</span>&nbsp;<span class="ident" id="6273763"><a href="/net/http/httputil/reverseproxy.go.html#6273725">t</a></span><span class="op" id="6273764">.</span><span class="ident" id="6273765">Stop</span><span class="op" id="6273769">(</span><span class="op" id="6273770">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273773">for</span>&nbsp;<span class="op" id="6273777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273781">select</span>&nbsp;<span class="op" id="6273788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273792">case</span>&nbsp;<span class="op" id="6273797">&lt;-</span><span class="ident" id="6273799"><a href="/net/http/httputil/reverseproxy.go.html#6273689">m</a></span><span class="op" id="6273800">.</span><span class="ident" id="6273801">done</span><span class="op" id="6273805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273810">if</span>&nbsp;<span class="ident" id="6273813"><a href="/net/http/httputil/reverseproxy.go.html#6268855">onExitFlushLoop</a></span>&nbsp;<span class="op" id="6273829">!=</span>&nbsp;<span class="ident" id="6273832">nil</span>&nbsp;<span class="op" id="6273836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273842"><a href="/net/http/httputil/reverseproxy.go.html#6268855">onExitFlushLoop</a></span><span class="op" id="6273857">(</span><span class="op" id="6273858">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273868">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273877">case</span>&nbsp;<span class="op" id="6273882">&lt;-</span><span class="ident" id="6273884"><a href="/net/http/httputil/reverseproxy.go.html#6273725">t</a></span><span class="op" id="6273885">.</span><span class="ident" id="6273886">C</span><span class="op" id="6273887">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273892"><a href="/net/http/httputil/reverseproxy.go.html#6273689">m</a></span><span class="op" id="6273893">.</span><span class="ident" id="6273894">lk</span><span class="op" id="6273896">.</span><span class="ident" id="6273897">Lock</span><span class="op" id="6273901">(</span><span class="op" id="6273902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273907"><a href="/net/http/httputil/reverseproxy.go.html#6273689">m</a></span><span class="op" id="6273908">.</span><span class="ident" id="6273909">dst</span><span class="op" id="6273912">.</span><span class="ident" id="6273913">Flush</span><span class="op" id="6273918">(</span><span class="op" id="6273919">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273924"><a href="/net/http/httputil/reverseproxy.go.html#6273689">m</a></span><span class="op" id="6273925">.</span><span class="ident" id="6273926">lk</span><span class="op" id="6273928">.</span><span class="ident" id="6273929">Unlock</span><span class="op" id="6273935">(</span><span class="op" id="6273936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273943">}</span><br>
<span class="lineno"></span><span class="op" id="6273945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="6273948">func</span>&nbsp;<span class="op" id="6273953">(</span><span class="ident" id="6273954">m</span>&nbsp;<span class="op" id="6273956">*</span><span class="ident" id="6273957"><a href="/net/http/httputil/reverseproxy.go.html#6273431">maxLatencyWriter</a></span><span class="op" id="6273973">)</span>&nbsp;<span class="ident" id="6273975">stop</span><span class="op" id="6273979">(</span><span class="op" id="6273980">)</span>&nbsp;<span class="op" id="6273982">{</span>&nbsp;<span class="ident" id="6273984"><a href="/net/http/httputil/reverseproxy.go.html#6273954">m</a></span><span class="op" id="6273985">.</span><span class="ident" id="6273986">done</span>&nbsp;<span class="op" id="6273991">&lt;-</span>&nbsp;<span class="ident" id="6273994">true</span>&nbsp;<span class="op" id="6273999">}</span>
</div>
</body>
</html>
