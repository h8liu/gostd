<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rsa</h2>
<ul>
<li><a href="/gostd/crypto/rsa/pkcs1v15.go.html" class="current">pkcs1v15.go</a></li>
<li><a href="/gostd/crypto/rsa/pkcs1v15_test.go.html">pkcs1v15_test.go</a></li>
<li><a href="/gostd/crypto/rsa/pss.go.html">pss.go</a></li>
<li><a href="/gostd/crypto/rsa/pss_test.go.html">pss_test.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa.go.html">rsa.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa_test.go.html">rsa_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2923181">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2923236">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2923290">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2923341">package</span>&nbsp;<span class="ident" id="2923349">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2923354">import</span>&nbsp;<span class="op" id="2923361">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2923364">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2923374">&#34;crypto/subtle&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2923391">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2923401">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2923407">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="2923418">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2923421">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;encryption&nbsp;and&nbsp;decryption&nbsp;using&nbsp;PKCS#1&nbsp;v1.5&nbsp;padding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2923499">//&nbsp;EncryptPKCS1v15&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="2923595">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;minus&nbsp;11&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2923682">//&nbsp;WARNING:&nbsp;use&nbsp;of&nbsp;this&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;plaintexts&nbsp;other&nbsp;than&nbsp;session&nbsp;keys</span><br>
<span class="lineno">20</span><span class="comment" id="2923761">//&nbsp;is&nbsp;dangerous.&nbsp;Use&nbsp;RSA&nbsp;OAEP&nbsp;in&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><span class="keyword" id="2923809">func</span>&nbsp;<span class="ident" id="2923814">EncryptPKCS1v15</span><span class="op" id="2923829">(</span><span class="ident" id="2923830">rand</span>&nbsp;<span class="ident" id="2923835">io</span><span class="op" id="2923837">.</span><span class="ident" id="2923838">Reader</span><span class="op" id="2923844">,</span>&nbsp;<span class="ident" id="2923846">pub</span>&nbsp;<span class="op" id="2923850">*</span><span class="ident" id="2923851">PublicKey</span><span class="op" id="2923860">,</span>&nbsp;<span class="ident" id="2923862">msg</span>&nbsp;<span class="op" id="2923866">[</span><span class="op" id="2923867">]</span><span class="builtintype" id="2923868">byte</span><span class="op" id="2923872">)</span>&nbsp;<span class="op" id="2923874">(</span><span class="ident" id="2923875">out</span>&nbsp;<span class="op" id="2923879">[</span><span class="op" id="2923880">]</span><span class="builtintype" id="2923881">byte</span><span class="op" id="2923885">,</span>&nbsp;<span class="ident" id="2923887">err</span>&nbsp;<span class="builtintype" id="2923891">error</span><span class="op" id="2923896">)</span>&nbsp;<span class="op" id="2923898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2923901">if</span>&nbsp;<span class="ident" id="2923904">err</span>&nbsp;<span class="op" id="2923908">:=</span>&nbsp;<span class="ident" id="2923911">checkPub</span><span class="op" id="2923919">(</span><span class="ident" id="2923920">pub</span><span class="op" id="2923923">)</span><span class="op" id="2923924">;</span>&nbsp;<span class="ident" id="2923926">err</span>&nbsp;<span class="op" id="2923930">!=</span>&nbsp;<span class="builtintype" id="2923933">nil</span>&nbsp;<span class="op" id="2923937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2923941">return</span>&nbsp;<span class="builtintype" id="2923948">nil</span><span class="op" id="2923951">,</span>&nbsp;<span class="ident" id="2923953">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2923958">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2923961">k</span>&nbsp;<span class="op" id="2923963">:=</span>&nbsp;<span class="op" id="2923966">(</span><span class="ident" id="2923967">pub</span><span class="op" id="2923970">.</span><span class="ident" id="2923971">N</span><span class="op" id="2923972">.</span><span class="ident" id="2923973">BitLen</span><span class="op" id="2923979">(</span><span class="op" id="2923980">)</span>&nbsp;<span class="op" id="2923982">+</span>&nbsp;<span class="num" id="2923984">7</span><span class="op" id="2923985">)</span>&nbsp;<span class="op" id="2923987">/</span>&nbsp;<span class="num" id="2923989">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2923992">if</span>&nbsp;<span class="builtinfunc" id="2923995">len</span><span class="op" id="2923998">(</span><span class="ident" id="2923999">msg</span><span class="op" id="2924002">)</span>&nbsp;<span class="op" id="2924004">&gt;</span>&nbsp;<span class="ident" id="2924006">k</span><span class="op" id="2924007">-</span><span class="num" id="2924008">11</span>&nbsp;<span class="op" id="2924011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2924015">err</span>&nbsp;<span class="op" id="2924019">=</span>&nbsp;<span class="ident" id="2924021">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2924041">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2924049">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2924053">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x02&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2924094">em</span>&nbsp;<span class="op" id="2924097">:=</span>&nbsp;<span class="builtinfunc" id="2924100">make</span><span class="op" id="2924104">(</span><span class="op" id="2924105">[</span><span class="op" id="2924106">]</span><span class="builtintype" id="2924107">byte</span><span class="op" id="2924111">,</span>&nbsp;<span class="ident" id="2924113">k</span><span class="op" id="2924114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2924117">em</span><span class="op" id="2924119">[</span><span class="num" id="2924120">1</span><span class="op" id="2924121">]</span>&nbsp;<span class="op" id="2924123">=</span>&nbsp;<span class="num" id="2924125">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2924128">ps</span><span class="op" id="2924130">,</span>&nbsp;<span class="ident" id="2924132">mm</span>&nbsp;<span class="op" id="2924135">:=</span>&nbsp;<span class="ident" id="2924138">em</span><span class="op" id="2924140">[</span><span class="num" id="2924141">2</span><span class="op" id="2924142">:</span><span class="builtinfunc" id="2924143">len</span><span class="op" id="2924146">(</span><span class="ident" id="2924147">em</span><span class="op" id="2924149">)</span><span class="op" id="2924150">-</span><span class="builtinfunc" id="2924151">len</span><span class="op" id="2924154">(</span><span class="ident" id="2924155">msg</span><span class="op" id="2924158">)</span><span class="op" id="2924159">-</span><span class="num" id="2924160">1</span><span class="op" id="2924161">]</span><span class="op" id="2924162">,</span>&nbsp;<span class="ident" id="2924164">em</span><span class="op" id="2924166">[</span><span class="builtinfunc" id="2924167">len</span><span class="op" id="2924170">(</span><span class="ident" id="2924171">em</span><span class="op" id="2924173">)</span><span class="op" id="2924174">-</span><span class="builtinfunc" id="2924175">len</span><span class="op" id="2924178">(</span><span class="ident" id="2924179">msg</span><span class="op" id="2924182">)</span><span class="op" id="2924183">:</span><span class="op" id="2924184">]</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2924187">err</span>&nbsp;<span class="op" id="2924191">=</span>&nbsp;<span class="ident" id="2924193">nonZeroRandomBytes</span><span class="op" id="2924211">(</span><span class="ident" id="2924212">ps</span><span class="op" id="2924214">,</span>&nbsp;<span class="ident" id="2924216">rand</span><span class="op" id="2924220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2924223">if</span>&nbsp;<span class="ident" id="2924226">err</span>&nbsp;<span class="op" id="2924230">!=</span>&nbsp;<span class="builtintype" id="2924233">nil</span>&nbsp;<span class="op" id="2924237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2924241">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2924249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2924252">em</span><span class="op" id="2924254">[</span><span class="builtinfunc" id="2924255">len</span><span class="op" id="2924258">(</span><span class="ident" id="2924259">em</span><span class="op" id="2924261">)</span><span class="op" id="2924262">-</span><span class="builtinfunc" id="2924263">len</span><span class="op" id="2924266">(</span><span class="ident" id="2924267">msg</span><span class="op" id="2924270">)</span><span class="op" id="2924271">-</span><span class="num" id="2924272">1</span><span class="op" id="2924273">]</span>&nbsp;<span class="op" id="2924275">=</span>&nbsp;<span class="num" id="2924277">0</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2924280">copy</span><span class="op" id="2924284">(</span><span class="ident" id="2924285">mm</span><span class="op" id="2924287">,</span>&nbsp;<span class="ident" id="2924289">msg</span><span class="op" id="2924292">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2924296">m</span>&nbsp;<span class="op" id="2924298">:=</span>&nbsp;<span class="builtinfunc" id="2924301">new</span><span class="op" id="2924304">(</span><span class="ident" id="2924305">big</span><span class="op" id="2924308">.</span><span class="ident" id="2924309">Int</span><span class="op" id="2924312">)</span><span class="op" id="2924313">.</span><span class="ident" id="2924314">SetBytes</span><span class="op" id="2924322">(</span><span class="ident" id="2924323">em</span><span class="op" id="2924325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2924328">c</span>&nbsp;<span class="op" id="2924330">:=</span>&nbsp;<span class="ident" id="2924333">encrypt</span><span class="op" id="2924340">(</span><span class="builtinfunc" id="2924341">new</span><span class="op" id="2924344">(</span><span class="ident" id="2924345">big</span><span class="op" id="2924348">.</span><span class="ident" id="2924349">Int</span><span class="op" id="2924352">)</span><span class="op" id="2924353">,</span>&nbsp;<span class="ident" id="2924355">pub</span><span class="op" id="2924358">,</span>&nbsp;<span class="ident" id="2924360">m</span><span class="op" id="2924361">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2924365">copyWithLeftPad</span><span class="op" id="2924380">(</span><span class="ident" id="2924381">em</span><span class="op" id="2924383">,</span>&nbsp;<span class="ident" id="2924385">c</span><span class="op" id="2924386">.</span><span class="ident" id="2924387">Bytes</span><span class="op" id="2924392">(</span><span class="op" id="2924393">)</span><span class="op" id="2924394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2924397">out</span>&nbsp;<span class="op" id="2924401">=</span>&nbsp;<span class="ident" id="2924403">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2924407">return</span><br>
<span class="lineno"></span><span class="op" id="2924414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="2924417">//&nbsp;DecryptPKCS1v15&nbsp;decrypts&nbsp;a&nbsp;plaintext&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="2924508">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword" id="2924586">func</span>&nbsp;<span class="ident" id="2924591">DecryptPKCS1v15</span><span class="op" id="2924606">(</span><span class="ident" id="2924607">rand</span>&nbsp;<span class="ident" id="2924612">io</span><span class="op" id="2924614">.</span><span class="ident" id="2924615">Reader</span><span class="op" id="2924621">,</span>&nbsp;<span class="ident" id="2924623">priv</span>&nbsp;<span class="op" id="2924628">*</span><span class="ident" id="2924629">PrivateKey</span><span class="op" id="2924639">,</span>&nbsp;<span class="ident" id="2924641">ciphertext</span>&nbsp;<span class="op" id="2924652">[</span><span class="op" id="2924653">]</span><span class="builtintype" id="2924654">byte</span><span class="op" id="2924658">)</span>&nbsp;<span class="op" id="2924660">(</span><span class="ident" id="2924661">out</span>&nbsp;<span class="op" id="2924665">[</span><span class="op" id="2924666">]</span><span class="builtintype" id="2924667">byte</span><span class="op" id="2924671">,</span>&nbsp;<span class="ident" id="2924673">err</span>&nbsp;<span class="builtintype" id="2924677">error</span><span class="op" id="2924682">)</span>&nbsp;<span class="op" id="2924684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2924687">if</span>&nbsp;<span class="ident" id="2924690">err</span>&nbsp;<span class="op" id="2924694">:=</span>&nbsp;<span class="ident" id="2924697">checkPub</span><span class="op" id="2924705">(</span><span class="op" id="2924706">&amp;</span><span class="ident" id="2924707">priv</span><span class="op" id="2924711">.</span><span class="ident" id="2924712">PublicKey</span><span class="op" id="2924721">)</span><span class="op" id="2924722">;</span>&nbsp;<span class="ident" id="2924724">err</span>&nbsp;<span class="op" id="2924728">!=</span>&nbsp;<span class="builtintype" id="2924731">nil</span>&nbsp;<span class="op" id="2924735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2924739">return</span>&nbsp;<span class="builtintype" id="2924746">nil</span><span class="op" id="2924749">,</span>&nbsp;<span class="ident" id="2924751">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2924756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2924759">valid</span><span class="op" id="2924764">,</span>&nbsp;<span class="ident" id="2924766">out</span><span class="op" id="2924769">,</span>&nbsp;<span class="ident" id="2924771">index</span><span class="op" id="2924776">,</span>&nbsp;<span class="ident" id="2924778">err</span>&nbsp;<span class="op" id="2924782">:=</span>&nbsp;<span class="ident" id="2924785">decryptPKCS1v15</span><span class="op" id="2924800">(</span><span class="ident" id="2924801">rand</span><span class="op" id="2924805">,</span>&nbsp;<span class="ident" id="2924807">priv</span><span class="op" id="2924811">,</span>&nbsp;<span class="ident" id="2924813">ciphertext</span><span class="op" id="2924823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2924826">if</span>&nbsp;<span class="ident" id="2924829">err</span>&nbsp;<span class="op" id="2924833">!=</span>&nbsp;<span class="builtintype" id="2924836">nil</span>&nbsp;<span class="op" id="2924840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2924844">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2924852">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2924855">if</span>&nbsp;<span class="ident" id="2924858">valid</span>&nbsp;<span class="op" id="2924864">==</span>&nbsp;<span class="num" id="2924867">0</span>&nbsp;<span class="op" id="2924869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2924873">return</span>&nbsp;<span class="builtintype" id="2924880">nil</span><span class="op" id="2924883">,</span>&nbsp;<span class="ident" id="2924885">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2924900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2924903">out</span>&nbsp;<span class="op" id="2924907">=</span>&nbsp;<span class="ident" id="2924909">out</span><span class="op" id="2924912">[</span><span class="ident" id="2924913">index</span><span class="op" id="2924918">:</span><span class="op" id="2924919">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2924922">return</span><br>
<span class="lineno">65</span><span class="op" id="2924929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2924932">//&nbsp;DecryptPKCS1v15SessionKey&nbsp;decrypts&nbsp;a&nbsp;session&nbsp;key&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="2925035">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="comment" id="2925113">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;ciphertext&nbsp;is&nbsp;the&nbsp;wrong&nbsp;length&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="2925184">//&nbsp;ciphertext&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;public&nbsp;modulus.&nbsp;Otherwise,&nbsp;no&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2925257">//&nbsp;returned.&nbsp;If&nbsp;the&nbsp;padding&nbsp;is&nbsp;valid,&nbsp;the&nbsp;resulting&nbsp;plaintext&nbsp;message&nbsp;is&nbsp;copied</span><br>
<span class="lineno"></span><span class="comment" id="2925337">//&nbsp;into&nbsp;key.&nbsp;Otherwise,&nbsp;key&nbsp;is&nbsp;unchanged.&nbsp;These&nbsp;alternatives&nbsp;occur&nbsp;in&nbsp;constant</span><br>
<span class="lineno"></span><span class="comment" id="2925416">//&nbsp;time.&nbsp;It&nbsp;is&nbsp;intended&nbsp;that&nbsp;the&nbsp;user&nbsp;of&nbsp;this&nbsp;function&nbsp;generate&nbsp;a&nbsp;random</span><br>
<span class="lineno"></span><span class="comment" id="2925489">//&nbsp;session&nbsp;key&nbsp;beforehand&nbsp;and&nbsp;continue&nbsp;the&nbsp;protocol&nbsp;with&nbsp;the&nbsp;resulting&nbsp;value.</span><br>
<span class="lineno">75</span><span class="comment" id="2925567">//&nbsp;This&nbsp;will&nbsp;remove&nbsp;any&nbsp;possibility&nbsp;that&nbsp;an&nbsp;attacker&nbsp;can&nbsp;learn&nbsp;any&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="2925646">//&nbsp;about&nbsp;the&nbsp;plaintext.</span><br>
<span class="lineno"></span><span class="comment" id="2925670">//&nbsp;See&nbsp;``Chosen&nbsp;Ciphertext&nbsp;Attacks&nbsp;Against&nbsp;Protocols&nbsp;Based&nbsp;on&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span><span class="comment" id="2925740">//&nbsp;Encryption&nbsp;Standard&nbsp;PKCS&nbsp;#1&#39;&#39;,&nbsp;Daniel&nbsp;Bleichenbacher,&nbsp;Advances&nbsp;in&nbsp;Cryptology</span><br>
<span class="lineno"></span><span class="comment" id="2925820">//&nbsp;(Crypto&nbsp;&#39;98).</span><br>
<span class="lineno">80</span><span class="keyword" id="2925837">func</span>&nbsp;<span class="ident" id="2925842">DecryptPKCS1v15SessionKey</span><span class="op" id="2925867">(</span><span class="ident" id="2925868">rand</span>&nbsp;<span class="ident" id="2925873">io</span><span class="op" id="2925875">.</span><span class="ident" id="2925876">Reader</span><span class="op" id="2925882">,</span>&nbsp;<span class="ident" id="2925884">priv</span>&nbsp;<span class="op" id="2925889">*</span><span class="ident" id="2925890">PrivateKey</span><span class="op" id="2925900">,</span>&nbsp;<span class="ident" id="2925902">ciphertext</span>&nbsp;<span class="op" id="2925913">[</span><span class="op" id="2925914">]</span><span class="builtintype" id="2925915">byte</span><span class="op" id="2925919">,</span>&nbsp;<span class="ident" id="2925921">key</span>&nbsp;<span class="op" id="2925925">[</span><span class="op" id="2925926">]</span><span class="builtintype" id="2925927">byte</span><span class="op" id="2925931">)</span>&nbsp;<span class="op" id="2925933">(</span><span class="ident" id="2925934">err</span>&nbsp;<span class="builtintype" id="2925938">error</span><span class="op" id="2925943">)</span>&nbsp;<span class="op" id="2925945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2925948">if</span>&nbsp;<span class="ident" id="2925951">err</span>&nbsp;<span class="op" id="2925955">:=</span>&nbsp;<span class="ident" id="2925958">checkPub</span><span class="op" id="2925966">(</span><span class="op" id="2925967">&amp;</span><span class="ident" id="2925968">priv</span><span class="op" id="2925972">.</span><span class="ident" id="2925973">PublicKey</span><span class="op" id="2925982">)</span><span class="op" id="2925983">;</span>&nbsp;<span class="ident" id="2925985">err</span>&nbsp;<span class="op" id="2925989">!=</span>&nbsp;<span class="builtintype" id="2925992">nil</span>&nbsp;<span class="op" id="2925996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2926000">return</span>&nbsp;<span class="ident" id="2926007">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2926012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2926015">k</span>&nbsp;<span class="op" id="2926017">:=</span>&nbsp;<span class="op" id="2926020">(</span><span class="ident" id="2926021">priv</span><span class="op" id="2926025">.</span><span class="ident" id="2926026">N</span><span class="op" id="2926027">.</span><span class="ident" id="2926028">BitLen</span><span class="op" id="2926034">(</span><span class="op" id="2926035">)</span>&nbsp;<span class="op" id="2926037">+</span>&nbsp;<span class="num" id="2926039">7</span><span class="op" id="2926040">)</span>&nbsp;<span class="op" id="2926042">/</span>&nbsp;<span class="num" id="2926044">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2926047">if</span>&nbsp;<span class="ident" id="2926050">k</span><span class="op" id="2926051">-</span><span class="op" id="2926052">(</span><span class="builtinfunc" id="2926053">len</span><span class="op" id="2926056">(</span><span class="ident" id="2926057">key</span><span class="op" id="2926060">)</span><span class="op" id="2926061">+</span><span class="num" id="2926062">3</span><span class="op" id="2926063">+</span><span class="num" id="2926064">8</span><span class="op" id="2926065">)</span>&nbsp;<span class="op" id="2926067">&lt;</span>&nbsp;<span class="num" id="2926069">0</span>&nbsp;<span class="op" id="2926071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2926075">return</span>&nbsp;<span class="ident" id="2926082">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2926097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2926101">valid</span><span class="op" id="2926106">,</span>&nbsp;<span class="ident" id="2926108">em</span><span class="op" id="2926110">,</span>&nbsp;<span class="ident" id="2926112">index</span><span class="op" id="2926117">,</span>&nbsp;<span class="ident" id="2926119">err</span>&nbsp;<span class="op" id="2926123">:=</span>&nbsp;<span class="ident" id="2926126">decryptPKCS1v15</span><span class="op" id="2926141">(</span><span class="ident" id="2926142">rand</span><span class="op" id="2926146">,</span>&nbsp;<span class="ident" id="2926148">priv</span><span class="op" id="2926152">,</span>&nbsp;<span class="ident" id="2926154">ciphertext</span><span class="op" id="2926164">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2926167">if</span>&nbsp;<span class="ident" id="2926170">err</span>&nbsp;<span class="op" id="2926174">!=</span>&nbsp;<span class="builtintype" id="2926177">nil</span>&nbsp;<span class="op" id="2926181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2926185">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2926193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2926197">if</span>&nbsp;<span class="builtinfunc" id="2926200">len</span><span class="op" id="2926203">(</span><span class="ident" id="2926204">em</span><span class="op" id="2926206">)</span>&nbsp;<span class="op" id="2926208">!=</span>&nbsp;<span class="ident" id="2926211">k</span>&nbsp;<span class="op" id="2926213">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2926217">//&nbsp;This&nbsp;should&nbsp;be&nbsp;impossible&nbsp;because&nbsp;decryptPKCS1v15&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2926279">//&nbsp;returns&nbsp;the&nbsp;full&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2926308">return</span>&nbsp;<span class="ident" id="2926315">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2926330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2926334">valid</span>&nbsp;<span class="op" id="2926340">&amp;=</span>&nbsp;<span class="ident" id="2926343">subtle</span><span class="op" id="2926349">.</span><span class="ident" id="2926350">ConstantTimeEq</span><span class="op" id="2926364">(</span><span class="builtintype" id="2926365">int32</span><span class="op" id="2926370">(</span><span class="builtinfunc" id="2926371">len</span><span class="op" id="2926374">(</span><span class="ident" id="2926375">em</span><span class="op" id="2926377">)</span><span class="op" id="2926378">-</span><span class="ident" id="2926379">index</span><span class="op" id="2926384">)</span><span class="op" id="2926385">,</span>&nbsp;<span class="builtintype" id="2926387">int32</span><span class="op" id="2926392">(</span><span class="builtinfunc" id="2926393">len</span><span class="op" id="2926396">(</span><span class="ident" id="2926397">key</span><span class="op" id="2926400">)</span><span class="op" id="2926401">)</span><span class="op" id="2926402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2926405">subtle</span><span class="op" id="2926411">.</span><span class="ident" id="2926412">ConstantTimeCopy</span><span class="op" id="2926428">(</span><span class="ident" id="2926429">valid</span><span class="op" id="2926434">,</span>&nbsp;<span class="ident" id="2926436">key</span><span class="op" id="2926439">,</span>&nbsp;<span class="ident" id="2926441">em</span><span class="op" id="2926443">[</span><span class="builtinfunc" id="2926444">len</span><span class="op" id="2926447">(</span><span class="ident" id="2926448">em</span><span class="op" id="2926450">)</span><span class="op" id="2926451">-</span><span class="builtinfunc" id="2926452">len</span><span class="op" id="2926455">(</span><span class="ident" id="2926456">key</span><span class="op" id="2926459">)</span><span class="op" id="2926460">:</span><span class="op" id="2926461">]</span><span class="op" id="2926462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2926465">return</span><br>
<span class="lineno"></span><span class="op" id="2926472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="2926475">//&nbsp;decryptPKCS1v15&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;priv&nbsp;and&nbsp;blinds&nbsp;the&nbsp;operation&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="2926553">//&nbsp;rand&nbsp;is&nbsp;not&nbsp;nil.&nbsp;It&nbsp;returns&nbsp;one&nbsp;or&nbsp;zero&nbsp;in&nbsp;valid&nbsp;that&nbsp;indicates&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2926632">//&nbsp;plaintext&nbsp;was&nbsp;correctly&nbsp;structured.&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;plaintext&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2926704">//&nbsp;returned&nbsp;in&nbsp;em&nbsp;so&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;read&nbsp;independently&nbsp;of&nbsp;whether&nbsp;it&nbsp;was&nbsp;valid</span><br>
<span class="lineno"></span><span class="comment" id="2926783">//&nbsp;in&nbsp;order&nbsp;to&nbsp;maintain&nbsp;constant&nbsp;memory&nbsp;access&nbsp;patterns.&nbsp;If&nbsp;the&nbsp;plaintext&nbsp;was</span><br>
<span class="lineno">110</span><span class="comment" id="2926861">//&nbsp;valid&nbsp;then&nbsp;index&nbsp;contains&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;original&nbsp;message&nbsp;in&nbsp;em.</span><br>
<span class="lineno"></span><span class="keyword" id="2926931">func</span>&nbsp;<span class="ident" id="2926936">decryptPKCS1v15</span><span class="op" id="2926951">(</span><span class="ident" id="2926952">rand</span>&nbsp;<span class="ident" id="2926957">io</span><span class="op" id="2926959">.</span><span class="ident" id="2926960">Reader</span><span class="op" id="2926966">,</span>&nbsp;<span class="ident" id="2926968">priv</span>&nbsp;<span class="op" id="2926973">*</span><span class="ident" id="2926974">PrivateKey</span><span class="op" id="2926984">,</span>&nbsp;<span class="ident" id="2926986">ciphertext</span>&nbsp;<span class="op" id="2926997">[</span><span class="op" id="2926998">]</span><span class="builtintype" id="2926999">byte</span><span class="op" id="2927003">)</span>&nbsp;<span class="op" id="2927005">(</span><span class="ident" id="2927006">valid</span>&nbsp;<span class="builtintype" id="2927012">int</span><span class="op" id="2927015">,</span>&nbsp;<span class="ident" id="2927017">em</span>&nbsp;<span class="op" id="2927020">[</span><span class="op" id="2927021">]</span><span class="builtintype" id="2927022">byte</span><span class="op" id="2927026">,</span>&nbsp;<span class="ident" id="2927028">index</span>&nbsp;<span class="builtintype" id="2927034">int</span><span class="op" id="2927037">,</span>&nbsp;<span class="ident" id="2927039">err</span>&nbsp;<span class="builtintype" id="2927043">error</span><span class="op" id="2927048">)</span>&nbsp;<span class="op" id="2927050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2927053">k</span>&nbsp;<span class="op" id="2927055">:=</span>&nbsp;<span class="op" id="2927058">(</span><span class="ident" id="2927059">priv</span><span class="op" id="2927063">.</span><span class="ident" id="2927064">N</span><span class="op" id="2927065">.</span><span class="ident" id="2927066">BitLen</span><span class="op" id="2927072">(</span><span class="op" id="2927073">)</span>&nbsp;<span class="op" id="2927075">+</span>&nbsp;<span class="num" id="2927077">7</span><span class="op" id="2927078">)</span>&nbsp;<span class="op" id="2927080">/</span>&nbsp;<span class="num" id="2927082">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2927085">if</span>&nbsp;<span class="ident" id="2927088">k</span>&nbsp;<span class="op" id="2927090">&lt;</span>&nbsp;<span class="num" id="2927092">11</span>&nbsp;<span class="op" id="2927095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2927099">err</span>&nbsp;<span class="op" id="2927103">=</span>&nbsp;<span class="ident" id="2927105">ErrDecryption</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2927121">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2927129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2927133">c</span>&nbsp;<span class="op" id="2927135">:=</span>&nbsp;<span class="builtinfunc" id="2927138">new</span><span class="op" id="2927141">(</span><span class="ident" id="2927142">big</span><span class="op" id="2927145">.</span><span class="ident" id="2927146">Int</span><span class="op" id="2927149">)</span><span class="op" id="2927150">.</span><span class="ident" id="2927151">SetBytes</span><span class="op" id="2927159">(</span><span class="ident" id="2927160">ciphertext</span><span class="op" id="2927170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2927173">m</span><span class="op" id="2927174">,</span>&nbsp;<span class="ident" id="2927176">err</span>&nbsp;<span class="op" id="2927180">:=</span>&nbsp;<span class="ident" id="2927183">decrypt</span><span class="op" id="2927190">(</span><span class="ident" id="2927191">rand</span><span class="op" id="2927195">,</span>&nbsp;<span class="ident" id="2927197">priv</span><span class="op" id="2927201">,</span>&nbsp;<span class="ident" id="2927203">c</span><span class="op" id="2927204">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2927207">if</span>&nbsp;<span class="ident" id="2927210">err</span>&nbsp;<span class="op" id="2927214">!=</span>&nbsp;<span class="builtintype" id="2927217">nil</span>&nbsp;<span class="op" id="2927221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2927225">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2927233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2927237">em</span>&nbsp;<span class="op" id="2927240">=</span>&nbsp;<span class="ident" id="2927242">leftPad</span><span class="op" id="2927249">(</span><span class="ident" id="2927250">m</span><span class="op" id="2927251">.</span><span class="ident" id="2927252">Bytes</span><span class="op" id="2927257">(</span><span class="op" id="2927258">)</span><span class="op" id="2927259">,</span>&nbsp;<span class="ident" id="2927261">k</span><span class="op" id="2927262">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2927265">firstByteIsZero</span>&nbsp;<span class="op" id="2927281">:=</span>&nbsp;<span class="ident" id="2927284">subtle</span><span class="op" id="2927290">.</span><span class="ident" id="2927291">ConstantTimeByteEq</span><span class="op" id="2927309">(</span><span class="ident" id="2927310">em</span><span class="op" id="2927312">[</span><span class="num" id="2927313">0</span><span class="op" id="2927314">]</span><span class="op" id="2927315">,</span>&nbsp;<span class="num" id="2927317">0</span><span class="op" id="2927318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2927321">secondByteIsTwo</span>&nbsp;<span class="op" id="2927337">:=</span>&nbsp;<span class="ident" id="2927340">subtle</span><span class="op" id="2927346">.</span><span class="ident" id="2927347">ConstantTimeByteEq</span><span class="op" id="2927365">(</span><span class="ident" id="2927366">em</span><span class="op" id="2927368">[</span><span class="num" id="2927369">1</span><span class="op" id="2927370">]</span><span class="op" id="2927371">,</span>&nbsp;<span class="num" id="2927373">2</span><span class="op" id="2927374">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2927378">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;a&nbsp;string&nbsp;of&nbsp;non-zero&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2927449">//&nbsp;octets,&nbsp;followed&nbsp;by&nbsp;a&nbsp;0,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2927503">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2927567">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;zero&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2927615">lookingForIndex</span>&nbsp;<span class="op" id="2927631">:=</span>&nbsp;<span class="num" id="2927634">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2927638">for</span>&nbsp;<span class="ident" id="2927642">i</span>&nbsp;<span class="op" id="2927644">:=</span>&nbsp;<span class="num" id="2927647">2</span><span class="op" id="2927648">;</span>&nbsp;<span class="ident" id="2927650">i</span>&nbsp;<span class="op" id="2927652">&lt;</span>&nbsp;<span class="builtinfunc" id="2927654">len</span><span class="op" id="2927657">(</span><span class="ident" id="2927658">em</span><span class="op" id="2927660">)</span><span class="op" id="2927661">;</span>&nbsp;<span class="ident" id="2927663">i</span><span class="op" id="2927664">++</span>&nbsp;<span class="op" id="2927667">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2927671">equals0</span>&nbsp;<span class="op" id="2927679">:=</span>&nbsp;<span class="ident" id="2927682">subtle</span><span class="op" id="2927688">.</span><span class="ident" id="2927689">ConstantTimeByteEq</span><span class="op" id="2927707">(</span><span class="ident" id="2927708">em</span><span class="op" id="2927710">[</span><span class="ident" id="2927711">i</span><span class="op" id="2927712">]</span><span class="op" id="2927713">,</span>&nbsp;<span class="num" id="2927715">0</span><span class="op" id="2927716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2927720">index</span>&nbsp;<span class="op" id="2927726">=</span>&nbsp;<span class="ident" id="2927728">subtle</span><span class="op" id="2927734">.</span><span class="ident" id="2927735">ConstantTimeSelect</span><span class="op" id="2927753">(</span><span class="ident" id="2927754">lookingForIndex</span><span class="op" id="2927769">&amp;</span><span class="ident" id="2927770">equals0</span><span class="op" id="2927777">,</span>&nbsp;<span class="ident" id="2927779">i</span><span class="op" id="2927780">,</span>&nbsp;<span class="ident" id="2927782">index</span><span class="op" id="2927787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2927791">lookingForIndex</span>&nbsp;<span class="op" id="2927807">=</span>&nbsp;<span class="ident" id="2927809">subtle</span><span class="op" id="2927815">.</span><span class="ident" id="2927816">ConstantTimeSelect</span><span class="op" id="2927834">(</span><span class="ident" id="2927835">equals0</span><span class="op" id="2927842">,</span>&nbsp;<span class="num" id="2927844">0</span><span class="op" id="2927845">,</span>&nbsp;<span class="ident" id="2927847">lookingForIndex</span><span class="op" id="2927862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2927865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2927869">//&nbsp;The&nbsp;PS&nbsp;padding&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;8&nbsp;bytes&nbsp;long,&nbsp;and&nbsp;it&nbsp;starts&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2927937">//&nbsp;bytes&nbsp;into&nbsp;em.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2927956">validPS</span>&nbsp;<span class="op" id="2927964">:=</span>&nbsp;<span class="ident" id="2927967">subtle</span><span class="op" id="2927973">.</span><span class="ident" id="2927974">ConstantTimeLessOrEq</span><span class="op" id="2927994">(</span><span class="num" id="2927995">2</span><span class="op" id="2927996">+</span><span class="num" id="2927997">8</span><span class="op" id="2927998">,</span>&nbsp;<span class="ident" id="2928000">index</span><span class="op" id="2928005">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2928009">valid</span>&nbsp;<span class="op" id="2928015">=</span>&nbsp;<span class="ident" id="2928017">firstByteIsZero</span>&nbsp;<span class="op" id="2928033">&amp;</span>&nbsp;<span class="ident" id="2928035">secondByteIsTwo</span>&nbsp;<span class="op" id="2928051">&amp;</span>&nbsp;<span class="op" id="2928053">(</span><span class="op" id="2928054">^</span><span class="ident" id="2928055">lookingForIndex</span>&nbsp;<span class="op" id="2928071">&amp;</span>&nbsp;<span class="num" id="2928073">1</span><span class="op" id="2928074">)</span>&nbsp;<span class="op" id="2928076">&amp;</span>&nbsp;<span class="ident" id="2928078">validPS</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2928087">index</span>&nbsp;<span class="op" id="2928093">=</span>&nbsp;<span class="ident" id="2928095">subtle</span><span class="op" id="2928101">.</span><span class="ident" id="2928102">ConstantTimeSelect</span><span class="op" id="2928120">(</span><span class="ident" id="2928121">valid</span><span class="op" id="2928126">,</span>&nbsp;<span class="ident" id="2928128">index</span><span class="op" id="2928133">+</span><span class="num" id="2928134">1</span><span class="op" id="2928135">,</span>&nbsp;<span class="num" id="2928137">0</span><span class="op" id="2928138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2928141">return</span>&nbsp;<span class="ident" id="2928148">valid</span><span class="op" id="2928153">,</span>&nbsp;<span class="ident" id="2928155">em</span><span class="op" id="2928157">,</span>&nbsp;<span class="ident" id="2928159">index</span><span class="op" id="2928164">,</span>&nbsp;<span class="builtintype" id="2928166">nil</span><br>
<span class="lineno"></span><span class="op" id="2928170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2928173">//&nbsp;nonZeroRandomBytes&nbsp;fills&nbsp;the&nbsp;given&nbsp;slice&nbsp;with&nbsp;non-zero&nbsp;random&nbsp;octets.</span><br>
<span class="lineno">150</span><span class="keyword" id="2928246">func</span>&nbsp;<span class="ident" id="2928251">nonZeroRandomBytes</span><span class="op" id="2928269">(</span><span class="ident" id="2928270">s</span>&nbsp;<span class="op" id="2928272">[</span><span class="op" id="2928273">]</span><span class="builtintype" id="2928274">byte</span><span class="op" id="2928278">,</span>&nbsp;<span class="ident" id="2928280">rand</span>&nbsp;<span class="ident" id="2928285">io</span><span class="op" id="2928287">.</span><span class="ident" id="2928288">Reader</span><span class="op" id="2928294">)</span>&nbsp;<span class="op" id="2928296">(</span><span class="ident" id="2928297">err</span>&nbsp;<span class="builtintype" id="2928301">error</span><span class="op" id="2928306">)</span>&nbsp;<span class="op" id="2928308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2928311">_</span><span class="op" id="2928312">,</span>&nbsp;<span class="ident" id="2928314">err</span>&nbsp;<span class="op" id="2928318">=</span>&nbsp;<span class="ident" id="2928320">io</span><span class="op" id="2928322">.</span><span class="ident" id="2928323">ReadFull</span><span class="op" id="2928331">(</span><span class="ident" id="2928332">rand</span><span class="op" id="2928336">,</span>&nbsp;<span class="ident" id="2928338">s</span><span class="op" id="2928339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2928342">if</span>&nbsp;<span class="ident" id="2928345">err</span>&nbsp;<span class="op" id="2928349">!=</span>&nbsp;<span class="builtintype" id="2928352">nil</span>&nbsp;<span class="op" id="2928356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2928360">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2928368">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2928372">for</span>&nbsp;<span class="ident" id="2928376">i</span>&nbsp;<span class="op" id="2928378">:=</span>&nbsp;<span class="num" id="2928381">0</span><span class="op" id="2928382">;</span>&nbsp;<span class="ident" id="2928384">i</span>&nbsp;<span class="op" id="2928386">&lt;</span>&nbsp;<span class="builtinfunc" id="2928388">len</span><span class="op" id="2928391">(</span><span class="ident" id="2928392">s</span><span class="op" id="2928393">)</span><span class="op" id="2928394">;</span>&nbsp;<span class="ident" id="2928396">i</span><span class="op" id="2928397">++</span>&nbsp;<span class="op" id="2928400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2928404">for</span>&nbsp;<span class="ident" id="2928408">s</span><span class="op" id="2928409">[</span><span class="ident" id="2928410">i</span><span class="op" id="2928411">]</span>&nbsp;<span class="op" id="2928413">==</span>&nbsp;<span class="num" id="2928416">0</span>&nbsp;<span class="op" id="2928418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2928423">_</span><span class="op" id="2928424">,</span>&nbsp;<span class="ident" id="2928426">err</span>&nbsp;<span class="op" id="2928430">=</span>&nbsp;<span class="ident" id="2928432">io</span><span class="op" id="2928434">.</span><span class="ident" id="2928435">ReadFull</span><span class="op" id="2928443">(</span><span class="ident" id="2928444">rand</span><span class="op" id="2928448">,</span>&nbsp;<span class="ident" id="2928450">s</span><span class="op" id="2928451">[</span><span class="ident" id="2928452">i</span><span class="op" id="2928453">:</span><span class="ident" id="2928454">i</span><span class="op" id="2928455">+</span><span class="num" id="2928456">1</span><span class="op" id="2928457">]</span><span class="op" id="2928458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2928463">if</span>&nbsp;<span class="ident" id="2928466">err</span>&nbsp;<span class="op" id="2928470">!=</span>&nbsp;<span class="builtintype" id="2928473">nil</span>&nbsp;<span class="op" id="2928477">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2928483">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2928493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2928498">//&nbsp;In&nbsp;tests,&nbsp;the&nbsp;PRNG&nbsp;may&nbsp;return&nbsp;all&nbsp;zeros&nbsp;so&nbsp;we&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2928553">//&nbsp;this&nbsp;to&nbsp;break&nbsp;the&nbsp;loop.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2928583">s</span><span class="op" id="2928584">[</span><span class="ident" id="2928585">i</span><span class="op" id="2928586">]</span>&nbsp;<span class="op" id="2928588">^=</span>&nbsp;<span class="num" id="2928591">0x42</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2928598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2928601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2928605">return</span><br>
<span class="lineno"></span><span class="op" id="2928612">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="2928615">//&nbsp;These&nbsp;are&nbsp;ASN1&nbsp;DER&nbsp;structures:</span><br>
<span class="lineno"></span><span class="comment" id="2928649">//&nbsp;&nbsp;&nbsp;DigestInfo&nbsp;::=&nbsp;SEQUENCE&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="2928680">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digestAlgorithm&nbsp;AlgorithmIdentifier,</span><br>
<span class="lineno"></span><span class="comment" id="2928724">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digest&nbsp;OCTET&nbsp;STRING</span><br>
<span class="lineno">175</span><span class="comment" id="2928751">//&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="2928758">//&nbsp;For&nbsp;performance,&nbsp;we&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;generic&nbsp;ASN1&nbsp;encoder.&nbsp;Rather,&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="2928828">//&nbsp;precompute&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;digest&nbsp;value&nbsp;that&nbsp;makes&nbsp;a&nbsp;valid&nbsp;ASN1&nbsp;DER&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="2928906">//&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="2928936">var</span>&nbsp;<span class="ident" id="2928940">hashPrefixes</span>&nbsp;<span class="op" id="2928953">=</span>&nbsp;<span class="keyword" id="2928955">map</span><span class="op" id="2928958">[</span><span class="ident" id="2928959">crypto</span><span class="op" id="2928965">.</span><span class="ident" id="2928966">Hash</span><span class="op" id="2928970">]</span><span class="op" id="2928971">[</span><span class="op" id="2928972">]</span><span class="builtintype" id="2928973">byte</span><span class="op" id="2928977">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2928980">crypto</span><span class="op" id="2928986">.</span><span class="ident" id="2928987">MD5</span><span class="op" id="2928990">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2928998">{</span><span class="num" id="2928999">0x30</span><span class="op" id="2929003">,</span>&nbsp;<span class="num" id="2929005">0x20</span><span class="op" id="2929009">,</span>&nbsp;<span class="num" id="2929011">0x30</span><span class="op" id="2929015">,</span>&nbsp;<span class="num" id="2929017">0x0c</span><span class="op" id="2929021">,</span>&nbsp;<span class="num" id="2929023">0x06</span><span class="op" id="2929027">,</span>&nbsp;<span class="num" id="2929029">0x08</span><span class="op" id="2929033">,</span>&nbsp;<span class="num" id="2929035">0x2a</span><span class="op" id="2929039">,</span>&nbsp;<span class="num" id="2929041">0x86</span><span class="op" id="2929045">,</span>&nbsp;<span class="num" id="2929047">0x48</span><span class="op" id="2929051">,</span>&nbsp;<span class="num" id="2929053">0x86</span><span class="op" id="2929057">,</span>&nbsp;<span class="num" id="2929059">0xf7</span><span class="op" id="2929063">,</span>&nbsp;<span class="num" id="2929065">0x0d</span><span class="op" id="2929069">,</span>&nbsp;<span class="num" id="2929071">0x02</span><span class="op" id="2929075">,</span>&nbsp;<span class="num" id="2929077">0x05</span><span class="op" id="2929081">,</span>&nbsp;<span class="num" id="2929083">0x05</span><span class="op" id="2929087">,</span>&nbsp;<span class="num" id="2929089">0x00</span><span class="op" id="2929093">,</span>&nbsp;<span class="num" id="2929095">0x04</span><span class="op" id="2929099">,</span>&nbsp;<span class="num" id="2929101">0x10</span><span class="op" id="2929105">}</span><span class="op" id="2929106">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2929109">crypto</span><span class="op" id="2929115">.</span><span class="ident" id="2929116">SHA1</span><span class="op" id="2929120">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2929127">{</span><span class="num" id="2929128">0x30</span><span class="op" id="2929132">,</span>&nbsp;<span class="num" id="2929134">0x21</span><span class="op" id="2929138">,</span>&nbsp;<span class="num" id="2929140">0x30</span><span class="op" id="2929144">,</span>&nbsp;<span class="num" id="2929146">0x09</span><span class="op" id="2929150">,</span>&nbsp;<span class="num" id="2929152">0x06</span><span class="op" id="2929156">,</span>&nbsp;<span class="num" id="2929158">0x05</span><span class="op" id="2929162">,</span>&nbsp;<span class="num" id="2929164">0x2b</span><span class="op" id="2929168">,</span>&nbsp;<span class="num" id="2929170">0x0e</span><span class="op" id="2929174">,</span>&nbsp;<span class="num" id="2929176">0x03</span><span class="op" id="2929180">,</span>&nbsp;<span class="num" id="2929182">0x02</span><span class="op" id="2929186">,</span>&nbsp;<span class="num" id="2929188">0x1a</span><span class="op" id="2929192">,</span>&nbsp;<span class="num" id="2929194">0x05</span><span class="op" id="2929198">,</span>&nbsp;<span class="num" id="2929200">0x00</span><span class="op" id="2929204">,</span>&nbsp;<span class="num" id="2929206">0x04</span><span class="op" id="2929210">,</span>&nbsp;<span class="num" id="2929212">0x14</span><span class="op" id="2929216">}</span><span class="op" id="2929217">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2929220">crypto</span><span class="op" id="2929226">.</span><span class="ident" id="2929227">SHA224</span><span class="op" id="2929233">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2929238">{</span><span class="num" id="2929239">0x30</span><span class="op" id="2929243">,</span>&nbsp;<span class="num" id="2929245">0x2d</span><span class="op" id="2929249">,</span>&nbsp;<span class="num" id="2929251">0x30</span><span class="op" id="2929255">,</span>&nbsp;<span class="num" id="2929257">0x0d</span><span class="op" id="2929261">,</span>&nbsp;<span class="num" id="2929263">0x06</span><span class="op" id="2929267">,</span>&nbsp;<span class="num" id="2929269">0x09</span><span class="op" id="2929273">,</span>&nbsp;<span class="num" id="2929275">0x60</span><span class="op" id="2929279">,</span>&nbsp;<span class="num" id="2929281">0x86</span><span class="op" id="2929285">,</span>&nbsp;<span class="num" id="2929287">0x48</span><span class="op" id="2929291">,</span>&nbsp;<span class="num" id="2929293">0x01</span><span class="op" id="2929297">,</span>&nbsp;<span class="num" id="2929299">0x65</span><span class="op" id="2929303">,</span>&nbsp;<span class="num" id="2929305">0x03</span><span class="op" id="2929309">,</span>&nbsp;<span class="num" id="2929311">0x04</span><span class="op" id="2929315">,</span>&nbsp;<span class="num" id="2929317">0x02</span><span class="op" id="2929321">,</span>&nbsp;<span class="num" id="2929323">0x04</span><span class="op" id="2929327">,</span>&nbsp;<span class="num" id="2929329">0x05</span><span class="op" id="2929333">,</span>&nbsp;<span class="num" id="2929335">0x00</span><span class="op" id="2929339">,</span>&nbsp;<span class="num" id="2929341">0x04</span><span class="op" id="2929345">,</span>&nbsp;<span class="num" id="2929347">0x1c</span><span class="op" id="2929351">}</span><span class="op" id="2929352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2929355">crypto</span><span class="op" id="2929361">.</span><span class="ident" id="2929362">SHA256</span><span class="op" id="2929368">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2929373">{</span><span class="num" id="2929374">0x30</span><span class="op" id="2929378">,</span>&nbsp;<span class="num" id="2929380">0x31</span><span class="op" id="2929384">,</span>&nbsp;<span class="num" id="2929386">0x30</span><span class="op" id="2929390">,</span>&nbsp;<span class="num" id="2929392">0x0d</span><span class="op" id="2929396">,</span>&nbsp;<span class="num" id="2929398">0x06</span><span class="op" id="2929402">,</span>&nbsp;<span class="num" id="2929404">0x09</span><span class="op" id="2929408">,</span>&nbsp;<span class="num" id="2929410">0x60</span><span class="op" id="2929414">,</span>&nbsp;<span class="num" id="2929416">0x86</span><span class="op" id="2929420">,</span>&nbsp;<span class="num" id="2929422">0x48</span><span class="op" id="2929426">,</span>&nbsp;<span class="num" id="2929428">0x01</span><span class="op" id="2929432">,</span>&nbsp;<span class="num" id="2929434">0x65</span><span class="op" id="2929438">,</span>&nbsp;<span class="num" id="2929440">0x03</span><span class="op" id="2929444">,</span>&nbsp;<span class="num" id="2929446">0x04</span><span class="op" id="2929450">,</span>&nbsp;<span class="num" id="2929452">0x02</span><span class="op" id="2929456">,</span>&nbsp;<span class="num" id="2929458">0x01</span><span class="op" id="2929462">,</span>&nbsp;<span class="num" id="2929464">0x05</span><span class="op" id="2929468">,</span>&nbsp;<span class="num" id="2929470">0x00</span><span class="op" id="2929474">,</span>&nbsp;<span class="num" id="2929476">0x04</span><span class="op" id="2929480">,</span>&nbsp;<span class="num" id="2929482">0x20</span><span class="op" id="2929486">}</span><span class="op" id="2929487">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2929490">crypto</span><span class="op" id="2929496">.</span><span class="ident" id="2929497">SHA384</span><span class="op" id="2929503">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2929508">{</span><span class="num" id="2929509">0x30</span><span class="op" id="2929513">,</span>&nbsp;<span class="num" id="2929515">0x41</span><span class="op" id="2929519">,</span>&nbsp;<span class="num" id="2929521">0x30</span><span class="op" id="2929525">,</span>&nbsp;<span class="num" id="2929527">0x0d</span><span class="op" id="2929531">,</span>&nbsp;<span class="num" id="2929533">0x06</span><span class="op" id="2929537">,</span>&nbsp;<span class="num" id="2929539">0x09</span><span class="op" id="2929543">,</span>&nbsp;<span class="num" id="2929545">0x60</span><span class="op" id="2929549">,</span>&nbsp;<span class="num" id="2929551">0x86</span><span class="op" id="2929555">,</span>&nbsp;<span class="num" id="2929557">0x48</span><span class="op" id="2929561">,</span>&nbsp;<span class="num" id="2929563">0x01</span><span class="op" id="2929567">,</span>&nbsp;<span class="num" id="2929569">0x65</span><span class="op" id="2929573">,</span>&nbsp;<span class="num" id="2929575">0x03</span><span class="op" id="2929579">,</span>&nbsp;<span class="num" id="2929581">0x04</span><span class="op" id="2929585">,</span>&nbsp;<span class="num" id="2929587">0x02</span><span class="op" id="2929591">,</span>&nbsp;<span class="num" id="2929593">0x02</span><span class="op" id="2929597">,</span>&nbsp;<span class="num" id="2929599">0x05</span><span class="op" id="2929603">,</span>&nbsp;<span class="num" id="2929605">0x00</span><span class="op" id="2929609">,</span>&nbsp;<span class="num" id="2929611">0x04</span><span class="op" id="2929615">,</span>&nbsp;<span class="num" id="2929617">0x30</span><span class="op" id="2929621">}</span><span class="op" id="2929622">,</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2929625">crypto</span><span class="op" id="2929631">.</span><span class="ident" id="2929632">SHA512</span><span class="op" id="2929638">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2929643">{</span><span class="num" id="2929644">0x30</span><span class="op" id="2929648">,</span>&nbsp;<span class="num" id="2929650">0x51</span><span class="op" id="2929654">,</span>&nbsp;<span class="num" id="2929656">0x30</span><span class="op" id="2929660">,</span>&nbsp;<span class="num" id="2929662">0x0d</span><span class="op" id="2929666">,</span>&nbsp;<span class="num" id="2929668">0x06</span><span class="op" id="2929672">,</span>&nbsp;<span class="num" id="2929674">0x09</span><span class="op" id="2929678">,</span>&nbsp;<span class="num" id="2929680">0x60</span><span class="op" id="2929684">,</span>&nbsp;<span class="num" id="2929686">0x86</span><span class="op" id="2929690">,</span>&nbsp;<span class="num" id="2929692">0x48</span><span class="op" id="2929696">,</span>&nbsp;<span class="num" id="2929698">0x01</span><span class="op" id="2929702">,</span>&nbsp;<span class="num" id="2929704">0x65</span><span class="op" id="2929708">,</span>&nbsp;<span class="num" id="2929710">0x03</span><span class="op" id="2929714">,</span>&nbsp;<span class="num" id="2929716">0x04</span><span class="op" id="2929720">,</span>&nbsp;<span class="num" id="2929722">0x02</span><span class="op" id="2929726">,</span>&nbsp;<span class="num" id="2929728">0x03</span><span class="op" id="2929732">,</span>&nbsp;<span class="num" id="2929734">0x05</span><span class="op" id="2929738">,</span>&nbsp;<span class="num" id="2929740">0x00</span><span class="op" id="2929744">,</span>&nbsp;<span class="num" id="2929746">0x04</span><span class="op" id="2929750">,</span>&nbsp;<span class="num" id="2929752">0x40</span><span class="op" id="2929756">}</span><span class="op" id="2929757">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2929760">crypto</span><span class="op" id="2929766">.</span><span class="ident" id="2929767">MD5SHA1</span><span class="op" id="2929774">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2929778">{</span><span class="op" id="2929779">}</span><span class="op" id="2929780">,</span>&nbsp;<span class="comment" id="2929782">//&nbsp;A&nbsp;special&nbsp;TLS&nbsp;case&nbsp;which&nbsp;doesn&#39;t&nbsp;use&nbsp;an&nbsp;ASN1&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2929839">crypto</span><span class="op" id="2929845">.</span><span class="ident" id="2929846">RIPEMD160</span><span class="op" id="2929855">:</span>&nbsp;<span class="op" id="2929857">{</span><span class="num" id="2929858">0x30</span><span class="op" id="2929862">,</span>&nbsp;<span class="num" id="2929864">0x20</span><span class="op" id="2929868">,</span>&nbsp;<span class="num" id="2929870">0x30</span><span class="op" id="2929874">,</span>&nbsp;<span class="num" id="2929876">0x08</span><span class="op" id="2929880">,</span>&nbsp;<span class="num" id="2929882">0x06</span><span class="op" id="2929886">,</span>&nbsp;<span class="num" id="2929888">0x06</span><span class="op" id="2929892">,</span>&nbsp;<span class="num" id="2929894">0x28</span><span class="op" id="2929898">,</span>&nbsp;<span class="num" id="2929900">0xcf</span><span class="op" id="2929904">,</span>&nbsp;<span class="num" id="2929906">0x06</span><span class="op" id="2929910">,</span>&nbsp;<span class="num" id="2929912">0x03</span><span class="op" id="2929916">,</span>&nbsp;<span class="num" id="2929918">0x00</span><span class="op" id="2929922">,</span>&nbsp;<span class="num" id="2929924">0x31</span><span class="op" id="2929928">,</span>&nbsp;<span class="num" id="2929930">0x04</span><span class="op" id="2929934">,</span>&nbsp;<span class="num" id="2929936">0x14</span><span class="op" id="2929940">}</span><span class="op" id="2929941">,</span><br>
<span class="lineno"></span><span class="op" id="2929943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="comment" id="2929946">//&nbsp;SignPKCS1v15&nbsp;calculates&nbsp;the&nbsp;signature&nbsp;of&nbsp;hashed&nbsp;using&nbsp;RSASSA-PKCS1-V1_5-SIGN&nbsp;from&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="2930048">//&nbsp;Note&nbsp;that&nbsp;hashed&nbsp;must&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2930126">//&nbsp;given&nbsp;hash&nbsp;function.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero,&nbsp;hashed&nbsp;is&nbsp;signed&nbsp;directly.&nbsp;This&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="2930205">//&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="2930247">func</span>&nbsp;<span class="ident" id="2930252">SignPKCS1v15</span><span class="op" id="2930264">(</span><span class="ident" id="2930265">rand</span>&nbsp;<span class="ident" id="2930270">io</span><span class="op" id="2930272">.</span><span class="ident" id="2930273">Reader</span><span class="op" id="2930279">,</span>&nbsp;<span class="ident" id="2930281">priv</span>&nbsp;<span class="op" id="2930286">*</span><span class="ident" id="2930287">PrivateKey</span><span class="op" id="2930297">,</span>&nbsp;<span class="ident" id="2930299">hash</span>&nbsp;<span class="ident" id="2930304">crypto</span><span class="op" id="2930310">.</span><span class="ident" id="2930311">Hash</span><span class="op" id="2930315">,</span>&nbsp;<span class="ident" id="2930317">hashed</span>&nbsp;<span class="op" id="2930324">[</span><span class="op" id="2930325">]</span><span class="builtintype" id="2930326">byte</span><span class="op" id="2930330">)</span>&nbsp;<span class="op" id="2930332">(</span><span class="ident" id="2930333">s</span>&nbsp;<span class="op" id="2930335">[</span><span class="op" id="2930336">]</span><span class="builtintype" id="2930337">byte</span><span class="op" id="2930341">,</span>&nbsp;<span class="ident" id="2930343">err</span>&nbsp;<span class="builtintype" id="2930347">error</span><span class="op" id="2930352">)</span>&nbsp;<span class="op" id="2930354">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2930357">hashLen</span><span class="op" id="2930364">,</span>&nbsp;<span class="ident" id="2930366">prefix</span><span class="op" id="2930372">,</span>&nbsp;<span class="ident" id="2930374">err</span>&nbsp;<span class="op" id="2930378">:=</span>&nbsp;<span class="ident" id="2930381">pkcs1v15HashInfo</span><span class="op" id="2930397">(</span><span class="ident" id="2930398">hash</span><span class="op" id="2930402">,</span>&nbsp;<span class="builtinfunc" id="2930404">len</span><span class="op" id="2930407">(</span><span class="ident" id="2930408">hashed</span><span class="op" id="2930414">)</span><span class="op" id="2930415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2930418">if</span>&nbsp;<span class="ident" id="2930421">err</span>&nbsp;<span class="op" id="2930425">!=</span>&nbsp;<span class="builtintype" id="2930428">nil</span>&nbsp;<span class="op" id="2930432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2930436">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2930444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2930448">tLen</span>&nbsp;<span class="op" id="2930453">:=</span>&nbsp;<span class="builtinfunc" id="2930456">len</span><span class="op" id="2930459">(</span><span class="ident" id="2930460">prefix</span><span class="op" id="2930466">)</span>&nbsp;<span class="op" id="2930468">+</span>&nbsp;<span class="ident" id="2930470">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2930479">k</span>&nbsp;<span class="op" id="2930481">:=</span>&nbsp;<span class="op" id="2930484">(</span><span class="ident" id="2930485">priv</span><span class="op" id="2930489">.</span><span class="ident" id="2930490">N</span><span class="op" id="2930491">.</span><span class="ident" id="2930492">BitLen</span><span class="op" id="2930498">(</span><span class="op" id="2930499">)</span>&nbsp;<span class="op" id="2930501">+</span>&nbsp;<span class="num" id="2930503">7</span><span class="op" id="2930504">)</span>&nbsp;<span class="op" id="2930506">/</span>&nbsp;<span class="num" id="2930508">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2930511">if</span>&nbsp;<span class="ident" id="2930514">k</span>&nbsp;<span class="op" id="2930516">&lt;</span>&nbsp;<span class="ident" id="2930518">tLen</span><span class="op" id="2930522">+</span><span class="num" id="2930523">11</span>&nbsp;<span class="op" id="2930526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2930530">return</span>&nbsp;<span class="builtintype" id="2930537">nil</span><span class="op" id="2930540">,</span>&nbsp;<span class="ident" id="2930542">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2930561">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2930565">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2930606">em</span>&nbsp;<span class="op" id="2930609">:=</span>&nbsp;<span class="builtinfunc" id="2930612">make</span><span class="op" id="2930616">(</span><span class="op" id="2930617">[</span><span class="op" id="2930618">]</span><span class="builtintype" id="2930619">byte</span><span class="op" id="2930623">,</span>&nbsp;<span class="ident" id="2930625">k</span><span class="op" id="2930626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2930629">em</span><span class="op" id="2930631">[</span><span class="num" id="2930632">1</span><span class="op" id="2930633">]</span>&nbsp;<span class="op" id="2930635">=</span>&nbsp;<span class="num" id="2930637">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2930640">for</span>&nbsp;<span class="ident" id="2930644">i</span>&nbsp;<span class="op" id="2930646">:=</span>&nbsp;<span class="num" id="2930649">2</span><span class="op" id="2930650">;</span>&nbsp;<span class="ident" id="2930652">i</span>&nbsp;<span class="op" id="2930654">&lt;</span>&nbsp;<span class="ident" id="2930656">k</span><span class="op" id="2930657">-</span><span class="ident" id="2930658">tLen</span><span class="op" id="2930662">-</span><span class="num" id="2930663">1</span><span class="op" id="2930664">;</span>&nbsp;<span class="ident" id="2930666">i</span><span class="op" id="2930667">++</span>&nbsp;<span class="op" id="2930670">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2930674">em</span><span class="op" id="2930676">[</span><span class="ident" id="2930677">i</span><span class="op" id="2930678">]</span>&nbsp;<span class="op" id="2930680">=</span>&nbsp;<span class="num" id="2930682">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2930688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2930691">copy</span><span class="op" id="2930695">(</span><span class="ident" id="2930696">em</span><span class="op" id="2930698">[</span><span class="ident" id="2930699">k</span><span class="op" id="2930700">-</span><span class="ident" id="2930701">tLen</span><span class="op" id="2930705">:</span><span class="ident" id="2930706">k</span><span class="op" id="2930707">-</span><span class="ident" id="2930708">hashLen</span><span class="op" id="2930715">]</span><span class="op" id="2930716">,</span>&nbsp;<span class="ident" id="2930718">prefix</span><span class="op" id="2930724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2930727">copy</span><span class="op" id="2930731">(</span><span class="ident" id="2930732">em</span><span class="op" id="2930734">[</span><span class="ident" id="2930735">k</span><span class="op" id="2930736">-</span><span class="ident" id="2930737">hashLen</span><span class="op" id="2930744">:</span><span class="ident" id="2930745">k</span><span class="op" id="2930746">]</span><span class="op" id="2930747">,</span>&nbsp;<span class="ident" id="2930749">hashed</span><span class="op" id="2930755">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2930759">m</span>&nbsp;<span class="op" id="2930761">:=</span>&nbsp;<span class="builtinfunc" id="2930764">new</span><span class="op" id="2930767">(</span><span class="ident" id="2930768">big</span><span class="op" id="2930771">.</span><span class="ident" id="2930772">Int</span><span class="op" id="2930775">)</span><span class="op" id="2930776">.</span><span class="ident" id="2930777">SetBytes</span><span class="op" id="2930785">(</span><span class="ident" id="2930786">em</span><span class="op" id="2930788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2930791">c</span><span class="op" id="2930792">,</span>&nbsp;<span class="ident" id="2930794">err</span>&nbsp;<span class="op" id="2930798">:=</span>&nbsp;<span class="ident" id="2930801">decrypt</span><span class="op" id="2930808">(</span><span class="ident" id="2930809">rand</span><span class="op" id="2930813">,</span>&nbsp;<span class="ident" id="2930815">priv</span><span class="op" id="2930819">,</span>&nbsp;<span class="ident" id="2930821">m</span><span class="op" id="2930822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2930825">if</span>&nbsp;<span class="ident" id="2930828">err</span>&nbsp;<span class="op" id="2930832">!=</span>&nbsp;<span class="builtintype" id="2930835">nil</span>&nbsp;<span class="op" id="2930839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2930843">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2930851">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2930855">copyWithLeftPad</span><span class="op" id="2930870">(</span><span class="ident" id="2930871">em</span><span class="op" id="2930873">,</span>&nbsp;<span class="ident" id="2930875">c</span><span class="op" id="2930876">.</span><span class="ident" id="2930877">Bytes</span><span class="op" id="2930882">(</span><span class="op" id="2930883">)</span><span class="op" id="2930884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2930887">s</span>&nbsp;<span class="op" id="2930889">=</span>&nbsp;<span class="ident" id="2930891">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2930895">return</span><br>
<span class="lineno"></span><span class="op" id="2930902">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="2930905">//&nbsp;VerifyPKCS1v15&nbsp;verifies&nbsp;an&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment" id="2930962">//&nbsp;hashed&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the&nbsp;given&nbsp;hash</span><br>
<span class="lineno"></span><span class="comment" id="2931036">//&nbsp;function&nbsp;and&nbsp;sig&nbsp;is&nbsp;the&nbsp;signature.&nbsp;A&nbsp;valid&nbsp;signature&nbsp;is&nbsp;indicated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="2931108">//&nbsp;returning&nbsp;a&nbsp;nil&nbsp;error.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero&nbsp;then&nbsp;hashed&nbsp;is&nbsp;used&nbsp;directly.&nbsp;This</span><br>
<span class="lineno">230</span><span class="comment" id="2931185">//&nbsp;isn&#39;t&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="2931233">func</span>&nbsp;<span class="ident" id="2931238">VerifyPKCS1v15</span><span class="op" id="2931252">(</span><span class="ident" id="2931253">pub</span>&nbsp;<span class="op" id="2931257">*</span><span class="ident" id="2931258">PublicKey</span><span class="op" id="2931267">,</span>&nbsp;<span class="ident" id="2931269">hash</span>&nbsp;<span class="ident" id="2931274">crypto</span><span class="op" id="2931280">.</span><span class="ident" id="2931281">Hash</span><span class="op" id="2931285">,</span>&nbsp;<span class="ident" id="2931287">hashed</span>&nbsp;<span class="op" id="2931294">[</span><span class="op" id="2931295">]</span><span class="builtintype" id="2931296">byte</span><span class="op" id="2931300">,</span>&nbsp;<span class="ident" id="2931302">sig</span>&nbsp;<span class="op" id="2931306">[</span><span class="op" id="2931307">]</span><span class="builtintype" id="2931308">byte</span><span class="op" id="2931312">)</span>&nbsp;<span class="op" id="2931314">(</span><span class="ident" id="2931315">err</span>&nbsp;<span class="builtintype" id="2931319">error</span><span class="op" id="2931324">)</span>&nbsp;<span class="op" id="2931326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931329">hashLen</span><span class="op" id="2931336">,</span>&nbsp;<span class="ident" id="2931338">prefix</span><span class="op" id="2931344">,</span>&nbsp;<span class="ident" id="2931346">err</span>&nbsp;<span class="op" id="2931350">:=</span>&nbsp;<span class="ident" id="2931353">pkcs1v15HashInfo</span><span class="op" id="2931369">(</span><span class="ident" id="2931370">hash</span><span class="op" id="2931374">,</span>&nbsp;<span class="builtinfunc" id="2931376">len</span><span class="op" id="2931379">(</span><span class="ident" id="2931380">hashed</span><span class="op" id="2931386">)</span><span class="op" id="2931387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2931390">if</span>&nbsp;<span class="ident" id="2931393">err</span>&nbsp;<span class="op" id="2931397">!=</span>&nbsp;<span class="builtintype" id="2931400">nil</span>&nbsp;<span class="op" id="2931404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2931408">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2931416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931420">tLen</span>&nbsp;<span class="op" id="2931425">:=</span>&nbsp;<span class="builtinfunc" id="2931428">len</span><span class="op" id="2931431">(</span><span class="ident" id="2931432">prefix</span><span class="op" id="2931438">)</span>&nbsp;<span class="op" id="2931440">+</span>&nbsp;<span class="ident" id="2931442">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931451">k</span>&nbsp;<span class="op" id="2931453">:=</span>&nbsp;<span class="op" id="2931456">(</span><span class="ident" id="2931457">pub</span><span class="op" id="2931460">.</span><span class="ident" id="2931461">N</span><span class="op" id="2931462">.</span><span class="ident" id="2931463">BitLen</span><span class="op" id="2931469">(</span><span class="op" id="2931470">)</span>&nbsp;<span class="op" id="2931472">+</span>&nbsp;<span class="num" id="2931474">7</span><span class="op" id="2931475">)</span>&nbsp;<span class="op" id="2931477">/</span>&nbsp;<span class="num" id="2931479">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2931482">if</span>&nbsp;<span class="ident" id="2931485">k</span>&nbsp;<span class="op" id="2931487">&lt;</span>&nbsp;<span class="ident" id="2931489">tLen</span><span class="op" id="2931493">+</span><span class="num" id="2931494">11</span>&nbsp;<span class="op" id="2931497">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931501">err</span>&nbsp;<span class="op" id="2931505">=</span>&nbsp;<span class="ident" id="2931507">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2931525">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2931533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931537">c</span>&nbsp;<span class="op" id="2931539">:=</span>&nbsp;<span class="builtinfunc" id="2931542">new</span><span class="op" id="2931545">(</span><span class="ident" id="2931546">big</span><span class="op" id="2931549">.</span><span class="ident" id="2931550">Int</span><span class="op" id="2931553">)</span><span class="op" id="2931554">.</span><span class="ident" id="2931555">SetBytes</span><span class="op" id="2931563">(</span><span class="ident" id="2931564">sig</span><span class="op" id="2931567">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931570">m</span>&nbsp;<span class="op" id="2931572">:=</span>&nbsp;<span class="ident" id="2931575">encrypt</span><span class="op" id="2931582">(</span><span class="builtinfunc" id="2931583">new</span><span class="op" id="2931586">(</span><span class="ident" id="2931587">big</span><span class="op" id="2931590">.</span><span class="ident" id="2931591">Int</span><span class="op" id="2931594">)</span><span class="op" id="2931595">,</span>&nbsp;<span class="ident" id="2931597">pub</span><span class="op" id="2931600">,</span>&nbsp;<span class="ident" id="2931602">c</span><span class="op" id="2931603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931606">em</span>&nbsp;<span class="op" id="2931609">:=</span>&nbsp;<span class="ident" id="2931612">leftPad</span><span class="op" id="2931619">(</span><span class="ident" id="2931620">m</span><span class="op" id="2931621">.</span><span class="ident" id="2931622">Bytes</span><span class="op" id="2931627">(</span><span class="op" id="2931628">)</span><span class="op" id="2931629">,</span>&nbsp;<span class="ident" id="2931631">k</span><span class="op" id="2931632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2931635">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931677">ok</span>&nbsp;<span class="op" id="2931680">:=</span>&nbsp;<span class="ident" id="2931683">subtle</span><span class="op" id="2931689">.</span><span class="ident" id="2931690">ConstantTimeByteEq</span><span class="op" id="2931708">(</span><span class="ident" id="2931709">em</span><span class="op" id="2931711">[</span><span class="num" id="2931712">0</span><span class="op" id="2931713">]</span><span class="op" id="2931714">,</span>&nbsp;<span class="num" id="2931716">0</span><span class="op" id="2931717">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931720">ok</span>&nbsp;<span class="op" id="2931723">&amp;=</span>&nbsp;<span class="ident" id="2931726">subtle</span><span class="op" id="2931732">.</span><span class="ident" id="2931733">ConstantTimeByteEq</span><span class="op" id="2931751">(</span><span class="ident" id="2931752">em</span><span class="op" id="2931754">[</span><span class="num" id="2931755">1</span><span class="op" id="2931756">]</span><span class="op" id="2931757">,</span>&nbsp;<span class="num" id="2931759">1</span><span class="op" id="2931760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931763">ok</span>&nbsp;<span class="op" id="2931766">&amp;=</span>&nbsp;<span class="ident" id="2931769">subtle</span><span class="op" id="2931775">.</span><span class="ident" id="2931776">ConstantTimeCompare</span><span class="op" id="2931795">(</span><span class="ident" id="2931796">em</span><span class="op" id="2931798">[</span><span class="ident" id="2931799">k</span><span class="op" id="2931800">-</span><span class="ident" id="2931801">hashLen</span><span class="op" id="2931808">:</span><span class="ident" id="2931809">k</span><span class="op" id="2931810">]</span><span class="op" id="2931811">,</span>&nbsp;<span class="ident" id="2931813">hashed</span><span class="op" id="2931819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931822">ok</span>&nbsp;<span class="op" id="2931825">&amp;=</span>&nbsp;<span class="ident" id="2931828">subtle</span><span class="op" id="2931834">.</span><span class="ident" id="2931835">ConstantTimeCompare</span><span class="op" id="2931854">(</span><span class="ident" id="2931855">em</span><span class="op" id="2931857">[</span><span class="ident" id="2931858">k</span><span class="op" id="2931859">-</span><span class="ident" id="2931860">tLen</span><span class="op" id="2931864">:</span><span class="ident" id="2931865">k</span><span class="op" id="2931866">-</span><span class="ident" id="2931867">hashLen</span><span class="op" id="2931874">]</span><span class="op" id="2931875">,</span>&nbsp;<span class="ident" id="2931877">prefix</span><span class="op" id="2931883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931886">ok</span>&nbsp;<span class="op" id="2931889">&amp;=</span>&nbsp;<span class="ident" id="2931892">subtle</span><span class="op" id="2931898">.</span><span class="ident" id="2931899">ConstantTimeByteEq</span><span class="op" id="2931917">(</span><span class="ident" id="2931918">em</span><span class="op" id="2931920">[</span><span class="ident" id="2931921">k</span><span class="op" id="2931922">-</span><span class="ident" id="2931923">tLen</span><span class="op" id="2931927">-</span><span class="num" id="2931928">1</span><span class="op" id="2931929">]</span><span class="op" id="2931930">,</span>&nbsp;<span class="num" id="2931932">0</span><span class="op" id="2931933">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2931937">for</span>&nbsp;<span class="ident" id="2931941">i</span>&nbsp;<span class="op" id="2931943">:=</span>&nbsp;<span class="num" id="2931946">2</span><span class="op" id="2931947">;</span>&nbsp;<span class="ident" id="2931949">i</span>&nbsp;<span class="op" id="2931951">&lt;</span>&nbsp;<span class="ident" id="2931953">k</span><span class="op" id="2931954">-</span><span class="ident" id="2931955">tLen</span><span class="op" id="2931959">-</span><span class="num" id="2931960">1</span><span class="op" id="2931961">;</span>&nbsp;<span class="ident" id="2931963">i</span><span class="op" id="2931964">++</span>&nbsp;<span class="op" id="2931967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2931971">ok</span>&nbsp;<span class="op" id="2931974">&amp;=</span>&nbsp;<span class="ident" id="2931977">subtle</span><span class="op" id="2931983">.</span><span class="ident" id="2931984">ConstantTimeByteEq</span><span class="op" id="2932002">(</span><span class="ident" id="2932003">em</span><span class="op" id="2932005">[</span><span class="ident" id="2932006">i</span><span class="op" id="2932007">]</span><span class="op" id="2932008">,</span>&nbsp;<span class="num" id="2932010">0xff</span><span class="op" id="2932014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2932017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2932021">if</span>&nbsp;<span class="ident" id="2932024">ok</span>&nbsp;<span class="op" id="2932027">!=</span>&nbsp;<span class="num" id="2932030">1</span>&nbsp;<span class="op" id="2932032">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2932036">return</span>&nbsp;<span class="ident" id="2932043">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2932060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2932064">return</span>&nbsp;<span class="builtintype" id="2932071">nil</span><br>
<span class="lineno"></span><span class="op" id="2932075">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="2932078">func</span>&nbsp;<span class="ident" id="2932083">pkcs1v15HashInfo</span><span class="op" id="2932099">(</span><span class="ident" id="2932100">hash</span>&nbsp;<span class="ident" id="2932105">crypto</span><span class="op" id="2932111">.</span><span class="ident" id="2932112">Hash</span><span class="op" id="2932116">,</span>&nbsp;<span class="ident" id="2932118">inLen</span>&nbsp;<span class="builtintype" id="2932124">int</span><span class="op" id="2932127">)</span>&nbsp;<span class="op" id="2932129">(</span><span class="ident" id="2932130">hashLen</span>&nbsp;<span class="builtintype" id="2932138">int</span><span class="op" id="2932141">,</span>&nbsp;<span class="ident" id="2932143">prefix</span>&nbsp;<span class="op" id="2932150">[</span><span class="op" id="2932151">]</span><span class="builtintype" id="2932152">byte</span><span class="op" id="2932156">,</span>&nbsp;<span class="ident" id="2932158">err</span>&nbsp;<span class="builtintype" id="2932162">error</span><span class="op" id="2932167">)</span>&nbsp;<span class="op" id="2932169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2932172">//&nbsp;Special&nbsp;case:&nbsp;crypto.Hash(0)&nbsp;is&nbsp;used&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2932242">//&nbsp;signed&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2932263">if</span>&nbsp;<span class="ident" id="2932266">hash</span>&nbsp;<span class="op" id="2932271">==</span>&nbsp;<span class="num" id="2932274">0</span>&nbsp;<span class="op" id="2932276">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2932280">return</span>&nbsp;<span class="ident" id="2932287">inLen</span><span class="op" id="2932292">,</span>&nbsp;<span class="builtintype" id="2932294">nil</span><span class="op" id="2932297">,</span>&nbsp;<span class="builtintype" id="2932299">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2932304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2932308">hashLen</span>&nbsp;<span class="op" id="2932316">=</span>&nbsp;<span class="ident" id="2932318">hash</span><span class="op" id="2932322">.</span><span class="ident" id="2932323">Size</span><span class="op" id="2932327">(</span><span class="op" id="2932328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2932331">if</span>&nbsp;<span class="ident" id="2932334">inLen</span>&nbsp;<span class="op" id="2932340">!=</span>&nbsp;<span class="ident" id="2932343">hashLen</span>&nbsp;<span class="op" id="2932351">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2932355">return</span>&nbsp;<span class="num" id="2932362">0</span><span class="op" id="2932363">,</span>&nbsp;<span class="builtintype" id="2932365">nil</span><span class="op" id="2932368">,</span>&nbsp;<span class="ident" id="2932370">errors</span><span class="op" id="2932376">.</span><span class="ident" id="2932377">New</span><span class="op" id="2932380">(</span><span class="string" id="2932381">&#34;crypto/rsa:&nbsp;input&nbsp;must&nbsp;be&nbsp;hashed&nbsp;message&#34;</span><span class="op" id="2932423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2932426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2932429">prefix</span><span class="op" id="2932435">,</span>&nbsp;<span class="ident" id="2932437">ok</span>&nbsp;<span class="op" id="2932440">:=</span>&nbsp;<span class="ident" id="2932443">hashPrefixes</span><span class="op" id="2932455">[</span><span class="ident" id="2932456">hash</span><span class="op" id="2932460">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2932463">if</span>&nbsp;<span class="op" id="2932466">!</span><span class="ident" id="2932467">ok</span>&nbsp;<span class="op" id="2932470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2932474">return</span>&nbsp;<span class="num" id="2932481">0</span><span class="op" id="2932482">,</span>&nbsp;<span class="builtintype" id="2932484">nil</span><span class="op" id="2932487">,</span>&nbsp;<span class="ident" id="2932489">errors</span><span class="op" id="2932495">.</span><span class="ident" id="2932496">New</span><span class="op" id="2932499">(</span><span class="string" id="2932500">&#34;crypto/rsa:&nbsp;unsupported&nbsp;hash&nbsp;function&#34;</span><span class="op" id="2932539">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2932542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2932545">return</span><br>
<span class="lineno"></span><span class="op" id="2932552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2932555">//&nbsp;copyWithLeftPad&nbsp;copies&nbsp;src&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;dest,&nbsp;padding&nbsp;with&nbsp;zero&nbsp;bytes&nbsp;as</span><br>
<span class="lineno">285</span><span class="comment" id="2932632">//&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="2932643">func</span>&nbsp;<span class="ident" id="2932648">copyWithLeftPad</span><span class="op" id="2932663">(</span><span class="ident" id="2932664">dest</span><span class="op" id="2932668">,</span>&nbsp;<span class="ident" id="2932670">src</span>&nbsp;<span class="op" id="2932674">[</span><span class="op" id="2932675">]</span><span class="builtintype" id="2932676">byte</span><span class="op" id="2932680">)</span>&nbsp;<span class="op" id="2932682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2932685">numPaddingBytes</span>&nbsp;<span class="op" id="2932701">:=</span>&nbsp;<span class="builtinfunc" id="2932704">len</span><span class="op" id="2932707">(</span><span class="ident" id="2932708">dest</span><span class="op" id="2932712">)</span>&nbsp;<span class="op" id="2932714">-</span>&nbsp;<span class="builtinfunc" id="2932716">len</span><span class="op" id="2932719">(</span><span class="ident" id="2932720">src</span><span class="op" id="2932723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2932726">for</span>&nbsp;<span class="ident" id="2932730">i</span>&nbsp;<span class="op" id="2932732">:=</span>&nbsp;<span class="num" id="2932735">0</span><span class="op" id="2932736">;</span>&nbsp;<span class="ident" id="2932738">i</span>&nbsp;<span class="op" id="2932740">&lt;</span>&nbsp;<span class="ident" id="2932742">numPaddingBytes</span><span class="op" id="2932757">;</span>&nbsp;<span class="ident" id="2932759">i</span><span class="op" id="2932760">++</span>&nbsp;<span class="op" id="2932763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2932767">dest</span><span class="op" id="2932771">[</span><span class="ident" id="2932772">i</span><span class="op" id="2932773">]</span>&nbsp;<span class="op" id="2932775">=</span>&nbsp;<span class="num" id="2932777">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2932780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2932783">copy</span><span class="op" id="2932787">(</span><span class="ident" id="2932788">dest</span><span class="op" id="2932792">[</span><span class="ident" id="2932793">numPaddingBytes</span><span class="op" id="2932808">:</span><span class="op" id="2932809">]</span><span class="op" id="2932810">,</span>&nbsp;<span class="ident" id="2932812">src</span><span class="op" id="2932815">)</span><br>
<span class="lineno"></span><span class="op" id="2932817">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
