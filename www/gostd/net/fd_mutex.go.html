<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html" class="current">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3132488">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3132543">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3132597">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3132648">package</span>&nbsp;<span class="ident" id="3132656">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3132661">import</span>&nbsp;<span class="string" id="3132668">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3132683">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="3132737">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="3132793">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="3132832">type</span>&nbsp;<span class="ident" id="3132837">fdMutex</span>&nbsp;<span class="keyword" id="3132845">struct</span>&nbsp;<span class="op" id="3132852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132855">state</span>&nbsp;<span class="ident" id="3132861">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132869">rsema</span>&nbsp;<span class="builtintype" id="3132875">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132883">wsema</span>&nbsp;<span class="builtintype" id="3132889">uint32</span><br>
<span class="lineno"></span><span class="op" id="3132896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3132899">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="3132941">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="3133026">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3133063">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3133101">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="3133160">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="3133209">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="3133259">const</span>&nbsp;<span class="op" id="3133265">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133268">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="3133281">=</span>&nbsp;<span class="num" id="3133283">1</span>&nbsp;<span class="op" id="3133285">&lt;&lt;</span>&nbsp;<span class="num" id="3133288">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133291">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3133304">=</span>&nbsp;<span class="num" id="3133306">1</span>&nbsp;<span class="op" id="3133308">&lt;&lt;</span>&nbsp;<span class="num" id="3133311">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133314">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3133327">=</span>&nbsp;<span class="num" id="3133329">1</span>&nbsp;<span class="op" id="3133331">&lt;&lt;</span>&nbsp;<span class="num" id="3133334">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133337">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3133350">=</span>&nbsp;<span class="num" id="3133352">1</span>&nbsp;<span class="op" id="3133354">&lt;&lt;</span>&nbsp;<span class="num" id="3133357">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133360">mutexRefMask</span>&nbsp;<span class="op" id="3133373">=</span>&nbsp;<span class="op" id="3133375">(</span><span class="num" id="3133376">1</span><span class="op" id="3133377">&lt;&lt;</span><span class="num" id="3133379">20</span>&nbsp;<span class="op" id="3133382">-</span>&nbsp;<span class="num" id="3133384">1</span><span class="op" id="3133385">)</span>&nbsp;<span class="op" id="3133387">&lt;&lt;</span>&nbsp;<span class="num" id="3133390">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133393">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3133406">=</span>&nbsp;<span class="num" id="3133408">1</span>&nbsp;<span class="op" id="3133410">&lt;&lt;</span>&nbsp;<span class="num" id="3133413">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133417">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3133430">=</span>&nbsp;<span class="op" id="3133432">(</span><span class="num" id="3133433">1</span><span class="op" id="3133434">&lt;&lt;</span><span class="num" id="3133436">20</span>&nbsp;<span class="op" id="3133439">-</span>&nbsp;<span class="num" id="3133441">1</span><span class="op" id="3133442">)</span>&nbsp;<span class="op" id="3133444">&lt;&lt;</span>&nbsp;<span class="num" id="3133447">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133451">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3133464">=</span>&nbsp;<span class="num" id="3133466">1</span>&nbsp;<span class="op" id="3133468">&lt;&lt;</span>&nbsp;<span class="num" id="3133471">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133475">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3133488">=</span>&nbsp;<span class="op" id="3133490">(</span><span class="num" id="3133491">1</span><span class="op" id="3133492">&lt;&lt;</span><span class="num" id="3133494">20</span>&nbsp;<span class="op" id="3133497">-</span>&nbsp;<span class="num" id="3133499">1</span><span class="op" id="3133500">)</span>&nbsp;<span class="op" id="3133502">&lt;&lt;</span>&nbsp;<span class="num" id="3133505">43</span><br>
<span class="lineno">35</span><span class="op" id="3133508">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3133511">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="3133567">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="3133626">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="3133707">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3133784">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="3133857">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="3133907">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3133958">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="3134002">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3134089">func</span>&nbsp;<span class="op" id="3134094">(</span><span class="ident" id="3134095">mu</span>&nbsp;<span class="op" id="3134098">*</span><span class="ident" id="3134099">fdMutex</span><span class="op" id="3134106">)</span>&nbsp;<span class="ident" id="3134108">Incref</span><span class="op" id="3134114">(</span><span class="op" id="3134115">)</span>&nbsp;<span class="builtintype" id="3134117">bool</span>&nbsp;<span class="op" id="3134122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134125">for</span>&nbsp;<span class="op" id="3134129">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134133">old</span>&nbsp;<span class="op" id="3134137">:=</span>&nbsp;<span class="ident" id="3134140">atomic</span><span class="op" id="3134146">.</span><span class="ident" id="3134147">LoadUint64</span><span class="op" id="3134157">(</span><span class="op" id="3134158">&amp;</span><span class="ident" id="3134159">mu</span><span class="op" id="3134161">.</span><span class="ident" id="3134162">state</span><span class="op" id="3134167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134171">if</span>&nbsp;<span class="ident" id="3134174">old</span><span class="op" id="3134177">&amp;</span><span class="ident" id="3134178">mutexClosed</span>&nbsp;<span class="op" id="3134190">!=</span>&nbsp;<span class="num" id="3134193">0</span>&nbsp;<span class="op" id="3134195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134200">return</span>&nbsp;<span class="builtintype" id="3134207">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3134219">new</span>&nbsp;<span class="op" id="3134223">:=</span>&nbsp;<span class="ident" id="3134226">old</span>&nbsp;<span class="op" id="3134230">+</span>&nbsp;<span class="ident" id="3134232">mutexRef</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134243">if</span>&nbsp;<span class="builtinfunc" id="3134246">new</span><span class="op" id="3134249">&amp;</span><span class="ident" id="3134250">mutexRefMask</span>&nbsp;<span class="op" id="3134263">==</span>&nbsp;<span class="num" id="3134266">0</span>&nbsp;<span class="op" id="3134268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3134273">panic</span><span class="op" id="3134278">(</span><span class="string" id="3134279">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3134306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134314">if</span>&nbsp;<span class="ident" id="3134317">atomic</span><span class="op" id="3134323">.</span><span class="ident" id="3134324">CompareAndSwapUint64</span><span class="op" id="3134344">(</span><span class="op" id="3134345">&amp;</span><span class="ident" id="3134346">mu</span><span class="op" id="3134348">.</span><span class="ident" id="3134349">state</span><span class="op" id="3134354">,</span>&nbsp;<span class="ident" id="3134356">old</span><span class="op" id="3134359">,</span>&nbsp;<span class="builtinfunc" id="3134361">new</span><span class="op" id="3134364">)</span>&nbsp;<span class="op" id="3134366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134371">return</span>&nbsp;<span class="builtintype" id="3134378">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134388">}</span><br>
<span class="lineno"></span><span class="op" id="3134390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3134393">func</span>&nbsp;<span class="op" id="3134398">(</span><span class="ident" id="3134399">mu</span>&nbsp;<span class="op" id="3134402">*</span><span class="ident" id="3134403">fdMutex</span><span class="op" id="3134410">)</span>&nbsp;<span class="ident" id="3134412">IncrefAndClose</span><span class="op" id="3134426">(</span><span class="op" id="3134427">)</span>&nbsp;<span class="builtintype" id="3134429">bool</span>&nbsp;<span class="op" id="3134434">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134437">for</span>&nbsp;<span class="op" id="3134441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134445">old</span>&nbsp;<span class="op" id="3134449">:=</span>&nbsp;<span class="ident" id="3134452">atomic</span><span class="op" id="3134458">.</span><span class="ident" id="3134459">LoadUint64</span><span class="op" id="3134469">(</span><span class="op" id="3134470">&amp;</span><span class="ident" id="3134471">mu</span><span class="op" id="3134473">.</span><span class="ident" id="3134474">state</span><span class="op" id="3134479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134483">if</span>&nbsp;<span class="ident" id="3134486">old</span><span class="op" id="3134489">&amp;</span><span class="ident" id="3134490">mutexClosed</span>&nbsp;<span class="op" id="3134502">!=</span>&nbsp;<span class="num" id="3134505">0</span>&nbsp;<span class="op" id="3134507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134512">return</span>&nbsp;<span class="builtintype" id="3134519">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134527">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3134531">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3134576">new</span>&nbsp;<span class="op" id="3134580">:=</span>&nbsp;<span class="op" id="3134583">(</span><span class="ident" id="3134584">old</span>&nbsp;<span class="op" id="3134588">|</span>&nbsp;<span class="ident" id="3134590">mutexClosed</span><span class="op" id="3134601">)</span>&nbsp;<span class="op" id="3134603">+</span>&nbsp;<span class="ident" id="3134605">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134616">if</span>&nbsp;<span class="builtinfunc" id="3134619">new</span><span class="op" id="3134622">&amp;</span><span class="ident" id="3134623">mutexRefMask</span>&nbsp;<span class="op" id="3134636">==</span>&nbsp;<span class="num" id="3134639">0</span>&nbsp;<span class="op" id="3134641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3134646">panic</span><span class="op" id="3134651">(</span><span class="string" id="3134652">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3134679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134683">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3134687">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3134727">new</span>&nbsp;<span class="op" id="3134731">&amp;^=</span>&nbsp;<span class="ident" id="3134735">mutexRMask</span>&nbsp;<span class="op" id="3134746">|</span>&nbsp;<span class="ident" id="3134748">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134761">if</span>&nbsp;<span class="ident" id="3134764">atomic</span><span class="op" id="3134770">.</span><span class="ident" id="3134771">CompareAndSwapUint64</span><span class="op" id="3134791">(</span><span class="op" id="3134792">&amp;</span><span class="ident" id="3134793">mu</span><span class="op" id="3134795">.</span><span class="ident" id="3134796">state</span><span class="op" id="3134801">,</span>&nbsp;<span class="ident" id="3134803">old</span><span class="op" id="3134806">,</span>&nbsp;<span class="builtinfunc" id="3134808">new</span><span class="op" id="3134811">)</span>&nbsp;<span class="op" id="3134813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3134818">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3134857">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134907">for</span>&nbsp;<span class="ident" id="3134911">old</span><span class="op" id="3134914">&amp;</span><span class="ident" id="3134915">mutexRMask</span>&nbsp;<span class="op" id="3134926">!=</span>&nbsp;<span class="num" id="3134929">0</span>&nbsp;<span class="op" id="3134931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134937">old</span>&nbsp;<span class="op" id="3134941">-=</span>&nbsp;<span class="ident" id="3134944">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134959">runtime_Semrelease</span><span class="op" id="3134977">(</span><span class="op" id="3134978">&amp;</span><span class="ident" id="3134979">mu</span><span class="op" id="3134981">.</span><span class="ident" id="3134982">rsema</span><span class="op" id="3134987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134997">for</span>&nbsp;<span class="ident" id="3135001">old</span><span class="op" id="3135004">&amp;</span><span class="ident" id="3135005">mutexWMask</span>&nbsp;<span class="op" id="3135016">!=</span>&nbsp;<span class="num" id="3135019">0</span>&nbsp;<span class="op" id="3135021">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135027">old</span>&nbsp;<span class="op" id="3135031">-=</span>&nbsp;<span class="ident" id="3135034">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135049">runtime_Semrelease</span><span class="op" id="3135067">(</span><span class="op" id="3135068">&amp;</span><span class="ident" id="3135069">mu</span><span class="op" id="3135071">.</span><span class="ident" id="3135072">wsema</span><span class="op" id="3135077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135087">return</span>&nbsp;<span class="builtintype" id="3135094">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135101">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135104">}</span><br>
<span class="lineno"></span><span class="op" id="3135106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3135109">func</span>&nbsp;<span class="op" id="3135114">(</span><span class="ident" id="3135115">mu</span>&nbsp;<span class="op" id="3135118">*</span><span class="ident" id="3135119">fdMutex</span><span class="op" id="3135126">)</span>&nbsp;<span class="ident" id="3135128">Decref</span><span class="op" id="3135134">(</span><span class="op" id="3135135">)</span>&nbsp;<span class="builtintype" id="3135137">bool</span>&nbsp;<span class="op" id="3135142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135145">for</span>&nbsp;<span class="op" id="3135149">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135153">old</span>&nbsp;<span class="op" id="3135157">:=</span>&nbsp;<span class="ident" id="3135160">atomic</span><span class="op" id="3135166">.</span><span class="ident" id="3135167">LoadUint64</span><span class="op" id="3135177">(</span><span class="op" id="3135178">&amp;</span><span class="ident" id="3135179">mu</span><span class="op" id="3135181">.</span><span class="ident" id="3135182">state</span><span class="op" id="3135187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135191">if</span>&nbsp;<span class="ident" id="3135194">old</span><span class="op" id="3135197">&amp;</span><span class="ident" id="3135198">mutexRefMask</span>&nbsp;<span class="op" id="3135211">==</span>&nbsp;<span class="num" id="3135214">0</span>&nbsp;<span class="op" id="3135216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3135221">panic</span><span class="op" id="3135226">(</span><span class="string" id="3135227">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3135254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3135262">new</span>&nbsp;<span class="op" id="3135266">:=</span>&nbsp;<span class="ident" id="3135269">old</span>&nbsp;<span class="op" id="3135273">-</span>&nbsp;<span class="ident" id="3135275">mutexRef</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135286">if</span>&nbsp;<span class="ident" id="3135289">atomic</span><span class="op" id="3135295">.</span><span class="ident" id="3135296">CompareAndSwapUint64</span><span class="op" id="3135316">(</span><span class="op" id="3135317">&amp;</span><span class="ident" id="3135318">mu</span><span class="op" id="3135320">.</span><span class="ident" id="3135321">state</span><span class="op" id="3135326">,</span>&nbsp;<span class="ident" id="3135328">old</span><span class="op" id="3135331">,</span>&nbsp;<span class="builtinfunc" id="3135333">new</span><span class="op" id="3135336">)</span>&nbsp;<span class="op" id="3135338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135343">return</span>&nbsp;<span class="builtinfunc" id="3135350">new</span><span class="op" id="3135353">&amp;</span><span class="op" id="3135354">(</span><span class="ident" id="3135355">mutexClosed</span><span class="op" id="3135366">|</span><span class="ident" id="3135367">mutexRefMask</span><span class="op" id="3135379">)</span>&nbsp;<span class="op" id="3135381">==</span>&nbsp;<span class="ident" id="3135384">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135401">}</span><br>
<span class="lineno"></span><span class="op" id="3135403">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3135406">func</span>&nbsp;<span class="op" id="3135411">(</span><span class="ident" id="3135412">mu</span>&nbsp;<span class="op" id="3135415">*</span><span class="ident" id="3135416">fdMutex</span><span class="op" id="3135423">)</span>&nbsp;<span class="ident" id="3135425">RWLock</span><span class="op" id="3135431">(</span><span class="ident" id="3135432">read</span>&nbsp;<span class="builtintype" id="3135437">bool</span><span class="op" id="3135441">)</span>&nbsp;<span class="builtintype" id="3135443">bool</span>&nbsp;<span class="op" id="3135448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135451">var</span>&nbsp;<span class="ident" id="3135455">mutexBit</span><span class="op" id="3135463">,</span>&nbsp;<span class="ident" id="3135465">mutexWait</span><span class="op" id="3135474">,</span>&nbsp;<span class="ident" id="3135476">mutexMask</span>&nbsp;<span class="ident" id="3135486">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135494">var</span>&nbsp;<span class="ident" id="3135498">mutexSema</span>&nbsp;<span class="op" id="3135508">*</span><span class="builtintype" id="3135509">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135517">if</span>&nbsp;<span class="ident" id="3135520">read</span>&nbsp;<span class="op" id="3135525">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135529">mutexBit</span>&nbsp;<span class="op" id="3135538">=</span>&nbsp;<span class="ident" id="3135540">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135553">mutexWait</span>&nbsp;<span class="op" id="3135563">=</span>&nbsp;<span class="ident" id="3135565">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135578">mutexMask</span>&nbsp;<span class="op" id="3135588">=</span>&nbsp;<span class="ident" id="3135590">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135603">mutexSema</span>&nbsp;<span class="op" id="3135613">=</span>&nbsp;<span class="op" id="3135615">&amp;</span><span class="ident" id="3135616">mu</span><span class="op" id="3135618">.</span><span class="ident" id="3135619">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135626">}</span>&nbsp;<span class="keyword" id="3135628">else</span>&nbsp;<span class="op" id="3135633">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135637">mutexBit</span>&nbsp;<span class="op" id="3135646">=</span>&nbsp;<span class="ident" id="3135648">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135661">mutexWait</span>&nbsp;<span class="op" id="3135671">=</span>&nbsp;<span class="ident" id="3135673">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135686">mutexMask</span>&nbsp;<span class="op" id="3135696">=</span>&nbsp;<span class="ident" id="3135698">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135711">mutexSema</span>&nbsp;<span class="op" id="3135721">=</span>&nbsp;<span class="op" id="3135723">&amp;</span><span class="ident" id="3135724">mu</span><span class="op" id="3135726">.</span><span class="ident" id="3135727">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135734">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135737">for</span>&nbsp;<span class="op" id="3135741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135745">old</span>&nbsp;<span class="op" id="3135749">:=</span>&nbsp;<span class="ident" id="3135752">atomic</span><span class="op" id="3135758">.</span><span class="ident" id="3135759">LoadUint64</span><span class="op" id="3135769">(</span><span class="op" id="3135770">&amp;</span><span class="ident" id="3135771">mu</span><span class="op" id="3135773">.</span><span class="ident" id="3135774">state</span><span class="op" id="3135779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135783">if</span>&nbsp;<span class="ident" id="3135786">old</span><span class="op" id="3135789">&amp;</span><span class="ident" id="3135790">mutexClosed</span>&nbsp;<span class="op" id="3135802">!=</span>&nbsp;<span class="num" id="3135805">0</span>&nbsp;<span class="op" id="3135807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135812">return</span>&nbsp;<span class="builtintype" id="3135819">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135827">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135831">var</span>&nbsp;<span class="builtinfunc" id="3135835">new</span>&nbsp;<span class="ident" id="3135839">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135848">if</span>&nbsp;<span class="ident" id="3135851">old</span><span class="op" id="3135854">&amp;</span><span class="ident" id="3135855">mutexBit</span>&nbsp;<span class="op" id="3135864">==</span>&nbsp;<span class="num" id="3135867">0</span>&nbsp;<span class="op" id="3135869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3135874">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3135906">new</span>&nbsp;<span class="op" id="3135910">=</span>&nbsp;<span class="op" id="3135912">(</span><span class="ident" id="3135913">old</span>&nbsp;<span class="op" id="3135917">|</span>&nbsp;<span class="ident" id="3135919">mutexBit</span><span class="op" id="3135927">)</span>&nbsp;<span class="op" id="3135929">+</span>&nbsp;<span class="ident" id="3135931">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135943">if</span>&nbsp;<span class="builtinfunc" id="3135946">new</span><span class="op" id="3135949">&amp;</span><span class="ident" id="3135950">mutexRefMask</span>&nbsp;<span class="op" id="3135963">==</span>&nbsp;<span class="num" id="3135966">0</span>&nbsp;<span class="op" id="3135968">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3135974">panic</span><span class="op" id="3135979">(</span><span class="string" id="3135980">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3136007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136016">}</span>&nbsp;<span class="keyword" id="3136018">else</span>&nbsp;<span class="op" id="3136023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3136028">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3136049">new</span>&nbsp;<span class="op" id="3136053">=</span>&nbsp;<span class="ident" id="3136055">old</span>&nbsp;<span class="op" id="3136059">+</span>&nbsp;<span class="ident" id="3136061">mutexWait</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136074">if</span>&nbsp;<span class="builtinfunc" id="3136077">new</span><span class="op" id="3136080">&amp;</span><span class="ident" id="3136081">mutexMask</span>&nbsp;<span class="op" id="3136091">==</span>&nbsp;<span class="num" id="3136094">0</span>&nbsp;<span class="op" id="3136096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3136102">panic</span><span class="op" id="3136107">(</span><span class="string" id="3136108">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3136135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136148">if</span>&nbsp;<span class="ident" id="3136151">atomic</span><span class="op" id="3136157">.</span><span class="ident" id="3136158">CompareAndSwapUint64</span><span class="op" id="3136178">(</span><span class="op" id="3136179">&amp;</span><span class="ident" id="3136180">mu</span><span class="op" id="3136182">.</span><span class="ident" id="3136183">state</span><span class="op" id="3136188">,</span>&nbsp;<span class="ident" id="3136190">old</span><span class="op" id="3136193">,</span>&nbsp;<span class="builtinfunc" id="3136195">new</span><span class="op" id="3136198">)</span>&nbsp;<span class="op" id="3136200">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136205">if</span>&nbsp;<span class="ident" id="3136208">old</span><span class="op" id="3136211">&amp;</span><span class="ident" id="3136212">mutexBit</span>&nbsp;<span class="op" id="3136221">==</span>&nbsp;<span class="num" id="3136224">0</span>&nbsp;<span class="op" id="3136226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136232">return</span>&nbsp;<span class="builtintype" id="3136239">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136252">runtime_Semacquire</span><span class="op" id="3136270">(</span><span class="ident" id="3136271">mutexSema</span><span class="op" id="3136280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3136285">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136333">}</span><br>
<span class="lineno"></span><span class="op" id="3136335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3136338">func</span>&nbsp;<span class="op" id="3136343">(</span><span class="ident" id="3136344">mu</span>&nbsp;<span class="op" id="3136347">*</span><span class="ident" id="3136348">fdMutex</span><span class="op" id="3136355">)</span>&nbsp;<span class="ident" id="3136357">RWUnlock</span><span class="op" id="3136365">(</span><span class="ident" id="3136366">read</span>&nbsp;<span class="builtintype" id="3136371">bool</span><span class="op" id="3136375">)</span>&nbsp;<span class="builtintype" id="3136377">bool</span>&nbsp;<span class="op" id="3136382">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136385">var</span>&nbsp;<span class="ident" id="3136389">mutexBit</span><span class="op" id="3136397">,</span>&nbsp;<span class="ident" id="3136399">mutexWait</span><span class="op" id="3136408">,</span>&nbsp;<span class="ident" id="3136410">mutexMask</span>&nbsp;<span class="ident" id="3136420">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136428">var</span>&nbsp;<span class="ident" id="3136432">mutexSema</span>&nbsp;<span class="op" id="3136442">*</span><span class="builtintype" id="3136443">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136451">if</span>&nbsp;<span class="ident" id="3136454">read</span>&nbsp;<span class="op" id="3136459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136463">mutexBit</span>&nbsp;<span class="op" id="3136472">=</span>&nbsp;<span class="ident" id="3136474">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136487">mutexWait</span>&nbsp;<span class="op" id="3136497">=</span>&nbsp;<span class="ident" id="3136499">mutexRWait</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136512">mutexMask</span>&nbsp;<span class="op" id="3136522">=</span>&nbsp;<span class="ident" id="3136524">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136537">mutexSema</span>&nbsp;<span class="op" id="3136547">=</span>&nbsp;<span class="op" id="3136549">&amp;</span><span class="ident" id="3136550">mu</span><span class="op" id="3136552">.</span><span class="ident" id="3136553">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136560">}</span>&nbsp;<span class="keyword" id="3136562">else</span>&nbsp;<span class="op" id="3136567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136571">mutexBit</span>&nbsp;<span class="op" id="3136580">=</span>&nbsp;<span class="ident" id="3136582">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136595">mutexWait</span>&nbsp;<span class="op" id="3136605">=</span>&nbsp;<span class="ident" id="3136607">mutexWWait</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136620">mutexMask</span>&nbsp;<span class="op" id="3136630">=</span>&nbsp;<span class="ident" id="3136632">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136645">mutexSema</span>&nbsp;<span class="op" id="3136655">=</span>&nbsp;<span class="op" id="3136657">&amp;</span><span class="ident" id="3136658">mu</span><span class="op" id="3136660">.</span><span class="ident" id="3136661">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136671">for</span>&nbsp;<span class="op" id="3136675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136679">old</span>&nbsp;<span class="op" id="3136683">:=</span>&nbsp;<span class="ident" id="3136686">atomic</span><span class="op" id="3136692">.</span><span class="ident" id="3136693">LoadUint64</span><span class="op" id="3136703">(</span><span class="op" id="3136704">&amp;</span><span class="ident" id="3136705">mu</span><span class="op" id="3136707">.</span><span class="ident" id="3136708">state</span><span class="op" id="3136713">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136717">if</span>&nbsp;<span class="ident" id="3136720">old</span><span class="op" id="3136723">&amp;</span><span class="ident" id="3136724">mutexBit</span>&nbsp;<span class="op" id="3136733">==</span>&nbsp;<span class="num" id="3136736">0</span>&nbsp;<span class="op" id="3136738">||</span>&nbsp;<span class="ident" id="3136741">old</span><span class="op" id="3136744">&amp;</span><span class="ident" id="3136745">mutexRefMask</span>&nbsp;<span class="op" id="3136758">==</span>&nbsp;<span class="num" id="3136761">0</span>&nbsp;<span class="op" id="3136763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3136768">panic</span><span class="op" id="3136773">(</span><span class="string" id="3136774">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3136801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3136809">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3136873">new</span>&nbsp;<span class="op" id="3136877">:=</span>&nbsp;<span class="op" id="3136880">(</span><span class="ident" id="3136881">old</span>&nbsp;<span class="op" id="3136885">&amp;^</span>&nbsp;<span class="ident" id="3136888">mutexBit</span><span class="op" id="3136896">)</span>&nbsp;<span class="op" id="3136898">-</span>&nbsp;<span class="ident" id="3136900">mutexRef</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136911">if</span>&nbsp;<span class="ident" id="3136914">old</span><span class="op" id="3136917">&amp;</span><span class="ident" id="3136918">mutexMask</span>&nbsp;<span class="op" id="3136928">!=</span>&nbsp;<span class="num" id="3136931">0</span>&nbsp;<span class="op" id="3136933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3136938">new</span>&nbsp;<span class="op" id="3136942">-=</span>&nbsp;<span class="ident" id="3136945">mutexWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136961">if</span>&nbsp;<span class="ident" id="3136964">atomic</span><span class="op" id="3136970">.</span><span class="ident" id="3136971">CompareAndSwapUint64</span><span class="op" id="3136991">(</span><span class="op" id="3136992">&amp;</span><span class="ident" id="3136993">mu</span><span class="op" id="3136995">.</span><span class="ident" id="3136996">state</span><span class="op" id="3137001">,</span>&nbsp;<span class="ident" id="3137003">old</span><span class="op" id="3137006">,</span>&nbsp;<span class="builtinfunc" id="3137008">new</span><span class="op" id="3137011">)</span>&nbsp;<span class="op" id="3137013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137018">if</span>&nbsp;<span class="ident" id="3137021">old</span><span class="op" id="3137024">&amp;</span><span class="ident" id="3137025">mutexMask</span>&nbsp;<span class="op" id="3137035">!=</span>&nbsp;<span class="num" id="3137038">0</span>&nbsp;<span class="op" id="3137040">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3137046">runtime_Semrelease</span><span class="op" id="3137064">(</span><span class="ident" id="3137065">mutexSema</span><span class="op" id="3137074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137084">return</span>&nbsp;<span class="builtinfunc" id="3137091">new</span><span class="op" id="3137094">&amp;</span><span class="op" id="3137095">(</span><span class="ident" id="3137096">mutexClosed</span><span class="op" id="3137107">|</span><span class="ident" id="3137108">mutexRefMask</span><span class="op" id="3137120">)</span>&nbsp;<span class="op" id="3137122">==</span>&nbsp;<span class="ident" id="3137125">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137142">}</span><br>
<span class="lineno">180</span><span class="op" id="3137144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3137147">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3137182">func</span>&nbsp;<span class="ident" id="3137187">runtime_Semacquire</span><span class="op" id="3137205">(</span><span class="ident" id="3137206">sema</span>&nbsp;<span class="op" id="3137211">*</span><span class="builtintype" id="3137212">uint32</span><span class="op" id="3137218">)</span><br>
<span class="lineno"></span><span class="keyword" id="3137220">func</span>&nbsp;<span class="ident" id="3137225">runtime_Semrelease</span><span class="op" id="3137243">(</span><span class="ident" id="3137244">sema</span>&nbsp;<span class="op" id="3137249">*</span><span class="builtintype" id="3137250">uint32</span><span class="op" id="3137256">)</span>
</div>
</body>
</html>
