<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html" class="current">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5049228">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5049283">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5049337">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5049388">package</span>&nbsp;<span class="ident" id="5049396">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5049406">import</span>&nbsp;<span class="op" id="5049413">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5049416">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5049425">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5049432">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5049440">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5049446">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5049463">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="5049485">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5049488">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5049549">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="5049620">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="5049710">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="5049778">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="5049791">func</span>&nbsp;<span class="ident" id="5049796">escapeTemplate</span><span class="op" id="5049810">(</span><span class="ident" id="5049811">tmpl</span>&nbsp;<span class="op" id="5049816">*</span><span class="ident" id="5049817">Template</span><span class="op" id="5049825">,</span>&nbsp;<span class="ident" id="5049827">node</span>&nbsp;<span class="ident" id="5049832">parse</span><span class="op" id="5049837">.</span><span class="ident" id="5049838">Node</span><span class="op" id="5049842">,</span>&nbsp;<span class="ident" id="5049844">name</span>&nbsp;<span class="builtintype" id="5049849">string</span><span class="op" id="5049855">)</span>&nbsp;<span class="builtintype" id="5049857">error</span>&nbsp;<span class="op" id="5049863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049866">e</span>&nbsp;<span class="op" id="5049868">:=</span>&nbsp;<span class="ident" id="5049871">newEscaper</span><span class="op" id="5049881">(</span><span class="ident" id="5049882">tmpl</span><span class="op" id="5049886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049889">c</span><span class="op" id="5049890">,</span>&nbsp;<span class="ident" id="5049892">_</span>&nbsp;<span class="op" id="5049894">:=</span>&nbsp;<span class="ident" id="5049897">e</span><span class="op" id="5049898">.</span><span class="ident" id="5049899">escapeTree</span><span class="op" id="5049909">(</span><span class="ident" id="5049910">context</span><span class="op" id="5049917">{</span><span class="op" id="5049918">}</span><span class="op" id="5049919">,</span>&nbsp;<span class="ident" id="5049921">node</span><span class="op" id="5049925">,</span>&nbsp;<span class="ident" id="5049927">name</span><span class="op" id="5049931">,</span>&nbsp;<span class="num" id="5049933">0</span><span class="op" id="5049934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049937">var</span>&nbsp;<span class="ident" id="5049941">err</span>&nbsp;<span class="builtintype" id="5049945">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049952">if</span>&nbsp;<span class="ident" id="5049955">c</span><span class="op" id="5049956">.</span><span class="ident" id="5049957">err</span>&nbsp;<span class="op" id="5049961">!=</span>&nbsp;<span class="ident" id="5049964">nil</span>&nbsp;<span class="op" id="5049968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049972">err</span><span class="op" id="5049975">,</span>&nbsp;<span class="ident" id="5049977">c</span><span class="op" id="5049978">.</span><span class="ident" id="5049979">err</span><span class="op" id="5049982">.</span><span class="ident" id="5049983">Name</span>&nbsp;<span class="op" id="5049988">=</span>&nbsp;<span class="ident" id="5049990">c</span><span class="op" id="5049991">.</span><span class="ident" id="5049992">err</span><span class="op" id="5049995">,</span>&nbsp;<span class="ident" id="5049997">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050003">}</span>&nbsp;<span class="keyword" id="5050005">else</span>&nbsp;<span class="keyword" id="5050010">if</span>&nbsp;<span class="ident" id="5050013">c</span><span class="op" id="5050014">.</span><span class="ident" id="5050015">state</span>&nbsp;<span class="op" id="5050021">!=</span>&nbsp;<span class="ident" id="5050024">stateText</span>&nbsp;<span class="op" id="5050034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050038">err</span>&nbsp;<span class="op" id="5050042">=</span>&nbsp;<span class="op" id="5050044">&amp;</span><span class="ident" id="5050045">Error</span><span class="op" id="5050050">{</span><span class="ident" id="5050051">ErrEndContext</span><span class="op" id="5050064">,</span>&nbsp;<span class="ident" id="5050066">nil</span><span class="op" id="5050069">,</span>&nbsp;<span class="ident" id="5050071">name</span><span class="op" id="5050075">,</span>&nbsp;<span class="num" id="5050077">0</span><span class="op" id="5050078">,</span>&nbsp;<span class="ident" id="5050080">fmt</span><span class="op" id="5050083">.</span><span class="ident" id="5050084">Sprintf</span><span class="op" id="5050091">(</span><span class="string" id="5050092">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="5050124">,</span>&nbsp;<span class="ident" id="5050126">c</span><span class="op" id="5050127">)</span><span class="op" id="5050128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050131">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050134">if</span>&nbsp;<span class="ident" id="5050137">err</span>&nbsp;<span class="op" id="5050141">!=</span>&nbsp;<span class="ident" id="5050144">nil</span>&nbsp;<span class="op" id="5050148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5050152">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050196">if</span>&nbsp;<span class="ident" id="5050199">t</span>&nbsp;<span class="op" id="5050201">:=</span>&nbsp;<span class="ident" id="5050204">tmpl</span><span class="op" id="5050208">.</span><span class="ident" id="5050209">set</span><span class="op" id="5050212">[</span><span class="ident" id="5050213">name</span><span class="op" id="5050217">]</span><span class="op" id="5050218">;</span>&nbsp;<span class="ident" id="5050220">t</span>&nbsp;<span class="op" id="5050222">!=</span>&nbsp;<span class="ident" id="5050225">nil</span>&nbsp;<span class="op" id="5050229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050234">t</span><span class="op" id="5050235">.</span><span class="ident" id="5050236">escapeErr</span>&nbsp;<span class="op" id="5050246">=</span>&nbsp;<span class="ident" id="5050248">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050255">t</span><span class="op" id="5050256">.</span><span class="ident" id="5050257">text</span><span class="op" id="5050261">.</span><span class="ident" id="5050262">Tree</span>&nbsp;<span class="op" id="5050267">=</span>&nbsp;<span class="ident" id="5050269">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050276">t</span><span class="op" id="5050277">.</span><span class="ident" id="5050278">Tree</span>&nbsp;<span class="op" id="5050283">=</span>&nbsp;<span class="ident" id="5050285">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050295">return</span>&nbsp;<span class="ident" id="5050302">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050310">e</span><span class="op" id="5050311">.</span><span class="ident" id="5050312">commit</span><span class="op" id="5050318">(</span><span class="op" id="5050319">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050322">if</span>&nbsp;<span class="ident" id="5050325">t</span>&nbsp;<span class="op" id="5050327">:=</span>&nbsp;<span class="ident" id="5050330">tmpl</span><span class="op" id="5050334">.</span><span class="ident" id="5050335">set</span><span class="op" id="5050338">[</span><span class="ident" id="5050339">name</span><span class="op" id="5050343">]</span><span class="op" id="5050344">;</span>&nbsp;<span class="ident" id="5050346">t</span>&nbsp;<span class="op" id="5050348">!=</span>&nbsp;<span class="ident" id="5050351">nil</span>&nbsp;<span class="op" id="5050355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050359">t</span><span class="op" id="5050360">.</span><span class="ident" id="5050361">escapeErr</span>&nbsp;<span class="op" id="5050371">=</span>&nbsp;<span class="ident" id="5050373">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050384">t</span><span class="op" id="5050385">.</span><span class="ident" id="5050386">Tree</span>&nbsp;<span class="op" id="5050391">=</span>&nbsp;<span class="ident" id="5050393">t</span><span class="op" id="5050394">.</span><span class="ident" id="5050395">text</span><span class="op" id="5050399">.</span><span class="ident" id="5050400">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050409">return</span>&nbsp;<span class="ident" id="5050416">nil</span><br>
<span class="lineno">45</span><span class="op" id="5050420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5050423">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="5050497">var</span>&nbsp;<span class="ident" id="5050501">funcMap</span>&nbsp;<span class="op" id="5050509">=</span>&nbsp;<span class="ident" id="5050511">template</span><span class="op" id="5050519">.</span><span class="ident" id="5050520">FuncMap</span><span class="op" id="5050527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5050530">&#34;html_template_attrescaper&#34;</span><span class="op" id="5050557">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5050563">attrEscaper</span><span class="op" id="5050574">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5050577">&#34;html_template_commentescaper&#34;</span><span class="op" id="5050607">:</span>&nbsp;&nbsp;<span class="ident" id="5050610">commentEscaper</span><span class="op" id="5050624">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5050627">&#34;html_template_cssescaper&#34;</span><span class="op" id="5050653">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5050660">cssEscaper</span><span class="op" id="5050670">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5050673">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="5050703">:</span>&nbsp;&nbsp;<span class="ident" id="5050706">cssValueFilter</span><span class="op" id="5050720">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5050723">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="5050753">:</span>&nbsp;&nbsp;<span class="ident" id="5050756">htmlNameFilter</span><span class="op" id="5050770">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5050773">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5050800">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5050806">htmlEscaper</span><span class="op" id="5050817">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5050820">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5050851">:</span>&nbsp;<span class="ident" id="5050853">jsRegexpEscaper</span><span class="op" id="5050868">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5050871">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5050899">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5050904">jsStrEscaper</span><span class="op" id="5050916">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5050919">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="5050947">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5050952">jsValEscaper</span><span class="op" id="5050964">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5050967">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5050997">:</span>&nbsp;&nbsp;<span class="ident" id="5051000">htmlNospaceEscaper</span><span class="op" id="5051018">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051021">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5051050">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5051054">rcdataEscaper</span><span class="op" id="5051067">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051070">&#34;html_template_urlescaper&#34;</span><span class="op" id="5051096">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5051103">urlEscaper</span><span class="op" id="5051113">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051116">&#34;html_template_urlfilter&#34;</span><span class="op" id="5051141">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5051149">urlFilter</span><span class="op" id="5051158">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051161">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5051190">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5051194">urlNormalizer</span><span class="op" id="5051207">,</span><br>
<span class="lineno"></span><span class="op" id="5051209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5051212">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="5051290">var</span>&nbsp;<span class="ident" id="5051294">equivEscapers</span>&nbsp;<span class="op" id="5051308">=</span>&nbsp;<span class="keyword" id="5051310">map</span><span class="op" id="5051313">[</span><span class="builtintype" id="5051314">string</span><span class="op" id="5051320">]</span><span class="builtintype" id="5051321">string</span><span class="op" id="5051327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051330">&#34;html_template_attrescaper&#34;</span><span class="op" id="5051357">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5051362">&#34;html&#34;</span><span class="op" id="5051368">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051371">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5051398">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5051403">&#34;html&#34;</span><span class="op" id="5051409">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051412">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5051442">:</span>&nbsp;<span class="string" id="5051444">&#34;html&#34;</span><span class="op" id="5051450">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051453">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5051482">:</span>&nbsp;&nbsp;<span class="string" id="5051485">&#34;html&#34;</span><span class="op" id="5051491">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051494">&#34;html_template_urlescaper&#34;</span><span class="op" id="5051520">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5051526">&#34;urlquery&#34;</span><span class="op" id="5051536">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051539">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5051568">:</span>&nbsp;&nbsp;<span class="string" id="5051571">&#34;urlquery&#34;</span><span class="op" id="5051581">,</span><br>
<span class="lineno"></span><span class="op" id="5051583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="5051586">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="5051665">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="5051694">type</span>&nbsp;<span class="ident" id="5051699">escaper</span>&nbsp;<span class="keyword" id="5051707">struct</span>&nbsp;<span class="op" id="5051714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5051717">tmpl</span>&nbsp;<span class="op" id="5051722">*</span><span class="ident" id="5051723">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5051733">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5051804">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5051855">output</span>&nbsp;<span class="keyword" id="5051862">map</span><span class="op" id="5051865">[</span><span class="builtintype" id="5051866">string</span><span class="op" id="5051872">]</span><span class="ident" id="5051873">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5051882">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5051955">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5052008">derived</span>&nbsp;<span class="keyword" id="5052016">map</span><span class="op" id="5052019">[</span><span class="builtintype" id="5052020">string</span><span class="op" id="5052026">]</span><span class="op" id="5052027">*</span><span class="ident" id="5052028">template</span><span class="op" id="5052036">.</span><span class="ident" id="5052037">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5052047">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5052115">called</span>&nbsp;<span class="keyword" id="5052122">map</span><span class="op" id="5052125">[</span><span class="builtintype" id="5052126">string</span><span class="op" id="5052132">]</span><span class="builtintype" id="5052133">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5052139">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5052206">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5052272">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5052334">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="5052352">map</span><span class="op" id="5052355">[</span><span class="op" id="5052356">*</span><span class="ident" id="5052357">parse</span><span class="op" id="5052362">.</span><span class="ident" id="5052363">ActionNode</span><span class="op" id="5052373">]</span><span class="op" id="5052374">[</span><span class="op" id="5052375">]</span><span class="builtintype" id="5052376">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5052384">templateNodeEdits</span>&nbsp;<span class="keyword" id="5052402">map</span><span class="op" id="5052405">[</span><span class="op" id="5052406">*</span><span class="ident" id="5052407">parse</span><span class="op" id="5052412">.</span><span class="ident" id="5052413">TemplateNode</span><span class="op" id="5052425">]</span><span class="builtintype" id="5052426">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5052434">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5052452">map</span><span class="op" id="5052455">[</span><span class="op" id="5052456">*</span><span class="ident" id="5052457">parse</span><span class="op" id="5052462">.</span><span class="ident" id="5052463">TextNode</span><span class="op" id="5052471">]</span><span class="op" id="5052472">[</span><span class="op" id="5052473">]</span><span class="builtintype" id="5052474">byte</span><br>
<span class="lineno"></span><span class="op" id="5052479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="5052482">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="5052539">func</span>&nbsp;<span class="ident" id="5052544">newEscaper</span><span class="op" id="5052554">(</span><span class="ident" id="5052555">t</span>&nbsp;<span class="op" id="5052557">*</span><span class="ident" id="5052558">Template</span><span class="op" id="5052566">)</span>&nbsp;<span class="op" id="5052568">*</span><span class="ident" id="5052569">escaper</span>&nbsp;<span class="op" id="5052577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5052580">return</span>&nbsp;<span class="op" id="5052587">&amp;</span><span class="ident" id="5052588">escaper</span><span class="op" id="5052595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5052599">t</span><span class="op" id="5052600">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5052604">map</span><span class="op" id="5052607">[</span><span class="builtintype" id="5052608">string</span><span class="op" id="5052614">]</span><span class="ident" id="5052615">context</span><span class="op" id="5052622">{</span><span class="op" id="5052623">}</span><span class="op" id="5052624">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5052628">map</span><span class="op" id="5052631">[</span><span class="builtintype" id="5052632">string</span><span class="op" id="5052638">]</span><span class="op" id="5052639">*</span><span class="ident" id="5052640">template</span><span class="op" id="5052648">.</span><span class="ident" id="5052649">Template</span><span class="op" id="5052657">{</span><span class="op" id="5052658">}</span><span class="op" id="5052659">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5052663">map</span><span class="op" id="5052666">[</span><span class="builtintype" id="5052667">string</span><span class="op" id="5052673">]</span><span class="builtintype" id="5052674">bool</span><span class="op" id="5052678">{</span><span class="op" id="5052679">}</span><span class="op" id="5052680">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5052684">map</span><span class="op" id="5052687">[</span><span class="op" id="5052688">*</span><span class="ident" id="5052689">parse</span><span class="op" id="5052694">.</span><span class="ident" id="5052695">ActionNode</span><span class="op" id="5052705">]</span><span class="op" id="5052706">[</span><span class="op" id="5052707">]</span><span class="builtintype" id="5052708">string</span><span class="op" id="5052714">{</span><span class="op" id="5052715">}</span><span class="op" id="5052716">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5052720">map</span><span class="op" id="5052723">[</span><span class="op" id="5052724">*</span><span class="ident" id="5052725">parse</span><span class="op" id="5052730">.</span><span class="ident" id="5052731">TemplateNode</span><span class="op" id="5052743">]</span><span class="builtintype" id="5052744">string</span><span class="op" id="5052750">{</span><span class="op" id="5052751">}</span><span class="op" id="5052752">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5052756">map</span><span class="op" id="5052759">[</span><span class="op" id="5052760">*</span><span class="ident" id="5052761">parse</span><span class="op" id="5052766">.</span><span class="ident" id="5052767">TextNode</span><span class="op" id="5052775">]</span><span class="op" id="5052776">[</span><span class="op" id="5052777">]</span><span class="builtintype" id="5052778">byte</span><span class="op" id="5052782">{</span><span class="op" id="5052783">}</span><span class="op" id="5052784">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5052787">}</span><br>
<span class="lineno"></span><span class="op" id="5052789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5052792">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="5052873">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="5052949">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5053028">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="5053105">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="5053129">const</span>&nbsp;<span class="ident" id="5053135">filterFailsafe</span>&nbsp;<span class="op" id="5053150">=</span>&nbsp;<span class="string" id="5053152">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="5053164">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5053199">func</span>&nbsp;<span class="op" id="5053204">(</span><span class="ident" id="5053205">e</span>&nbsp;<span class="op" id="5053207">*</span><span class="ident" id="5053208">escaper</span><span class="op" id="5053215">)</span>&nbsp;<span class="ident" id="5053217">escape</span><span class="op" id="5053223">(</span><span class="ident" id="5053224">c</span>&nbsp;<span class="ident" id="5053226">context</span><span class="op" id="5053233">,</span>&nbsp;<span class="ident" id="5053235">n</span>&nbsp;<span class="ident" id="5053237">parse</span><span class="op" id="5053242">.</span><span class="ident" id="5053243">Node</span><span class="op" id="5053247">)</span>&nbsp;<span class="ident" id="5053249">context</span>&nbsp;<span class="op" id="5053257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053260">switch</span>&nbsp;<span class="ident" id="5053267">n</span>&nbsp;<span class="op" id="5053269">:=</span>&nbsp;<span class="ident" id="5053272">n</span><span class="op" id="5053273">.</span><span class="op" id="5053274">(</span><span class="keyword" id="5053275">type</span><span class="op" id="5053279">)</span>&nbsp;<span class="op" id="5053281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053284">case</span>&nbsp;<span class="op" id="5053289">*</span><span class="ident" id="5053290">parse</span><span class="op" id="5053295">.</span><span class="ident" id="5053296">ActionNode</span><span class="op" id="5053306">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053310">return</span>&nbsp;<span class="ident" id="5053317">e</span><span class="op" id="5053318">.</span><span class="ident" id="5053319">escapeAction</span><span class="op" id="5053331">(</span><span class="ident" id="5053332">c</span><span class="op" id="5053333">,</span>&nbsp;<span class="ident" id="5053335">n</span><span class="op" id="5053336">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053339">case</span>&nbsp;<span class="op" id="5053344">*</span><span class="ident" id="5053345">parse</span><span class="op" id="5053350">.</span><span class="ident" id="5053351">IfNode</span><span class="op" id="5053357">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053361">return</span>&nbsp;<span class="ident" id="5053368">e</span><span class="op" id="5053369">.</span><span class="ident" id="5053370">escapeBranch</span><span class="op" id="5053382">(</span><span class="ident" id="5053383">c</span><span class="op" id="5053384">,</span>&nbsp;<span class="op" id="5053386">&amp;</span><span class="ident" id="5053387">n</span><span class="op" id="5053388">.</span><span class="ident" id="5053389">BranchNode</span><span class="op" id="5053399">,</span>&nbsp;<span class="string" id="5053401">&#34;if&#34;</span><span class="op" id="5053405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053408">case</span>&nbsp;<span class="op" id="5053413">*</span><span class="ident" id="5053414">parse</span><span class="op" id="5053419">.</span><span class="ident" id="5053420">ListNode</span><span class="op" id="5053428">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053432">return</span>&nbsp;<span class="ident" id="5053439">e</span><span class="op" id="5053440">.</span><span class="ident" id="5053441">escapeList</span><span class="op" id="5053451">(</span><span class="ident" id="5053452">c</span><span class="op" id="5053453">,</span>&nbsp;<span class="ident" id="5053455">n</span><span class="op" id="5053456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053459">case</span>&nbsp;<span class="op" id="5053464">*</span><span class="ident" id="5053465">parse</span><span class="op" id="5053470">.</span><span class="ident" id="5053471">RangeNode</span><span class="op" id="5053480">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053484">return</span>&nbsp;<span class="ident" id="5053491">e</span><span class="op" id="5053492">.</span><span class="ident" id="5053493">escapeBranch</span><span class="op" id="5053505">(</span><span class="ident" id="5053506">c</span><span class="op" id="5053507">,</span>&nbsp;<span class="op" id="5053509">&amp;</span><span class="ident" id="5053510">n</span><span class="op" id="5053511">.</span><span class="ident" id="5053512">BranchNode</span><span class="op" id="5053522">,</span>&nbsp;<span class="string" id="5053524">&#34;range&#34;</span><span class="op" id="5053531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053534">case</span>&nbsp;<span class="op" id="5053539">*</span><span class="ident" id="5053540">parse</span><span class="op" id="5053545">.</span><span class="ident" id="5053546">TemplateNode</span><span class="op" id="5053558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053562">return</span>&nbsp;<span class="ident" id="5053569">e</span><span class="op" id="5053570">.</span><span class="ident" id="5053571">escapeTemplate</span><span class="op" id="5053585">(</span><span class="ident" id="5053586">c</span><span class="op" id="5053587">,</span>&nbsp;<span class="ident" id="5053589">n</span><span class="op" id="5053590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053593">case</span>&nbsp;<span class="op" id="5053598">*</span><span class="ident" id="5053599">parse</span><span class="op" id="5053604">.</span><span class="ident" id="5053605">TextNode</span><span class="op" id="5053613">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053617">return</span>&nbsp;<span class="ident" id="5053624">e</span><span class="op" id="5053625">.</span><span class="ident" id="5053626">escapeText</span><span class="op" id="5053636">(</span><span class="ident" id="5053637">c</span><span class="op" id="5053638">,</span>&nbsp;<span class="ident" id="5053640">n</span><span class="op" id="5053641">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053644">case</span>&nbsp;<span class="op" id="5053649">*</span><span class="ident" id="5053650">parse</span><span class="op" id="5053655">.</span><span class="ident" id="5053656">WithNode</span><span class="op" id="5053664">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053668">return</span>&nbsp;<span class="ident" id="5053675">e</span><span class="op" id="5053676">.</span><span class="ident" id="5053677">escapeBranch</span><span class="op" id="5053689">(</span><span class="ident" id="5053690">c</span><span class="op" id="5053691">,</span>&nbsp;<span class="op" id="5053693">&amp;</span><span class="ident" id="5053694">n</span><span class="op" id="5053695">.</span><span class="ident" id="5053696">BranchNode</span><span class="op" id="5053706">,</span>&nbsp;<span class="string" id="5053708">&#34;with&#34;</span><span class="op" id="5053714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5053717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5053720">panic</span><span class="op" id="5053725">(</span><span class="string" id="5053726">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="5053738">+</span>&nbsp;<span class="ident" id="5053740">n</span><span class="op" id="5053741">.</span><span class="ident" id="5053742">String</span><span class="op" id="5053748">(</span><span class="op" id="5053749">)</span>&nbsp;<span class="op" id="5053751">+</span>&nbsp;<span class="string" id="5053753">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="5053772">)</span><br>
<span class="lineno"></span><span class="op" id="5053774">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="5053777">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5053826">func</span>&nbsp;<span class="op" id="5053831">(</span><span class="ident" id="5053832">e</span>&nbsp;<span class="op" id="5053834">*</span><span class="ident" id="5053835">escaper</span><span class="op" id="5053842">)</span>&nbsp;<span class="ident" id="5053844">escapeAction</span><span class="op" id="5053856">(</span><span class="ident" id="5053857">c</span>&nbsp;<span class="ident" id="5053859">context</span><span class="op" id="5053866">,</span>&nbsp;<span class="ident" id="5053868">n</span>&nbsp;<span class="op" id="5053870">*</span><span class="ident" id="5053871">parse</span><span class="op" id="5053876">.</span><span class="ident" id="5053877">ActionNode</span><span class="op" id="5053887">)</span>&nbsp;<span class="ident" id="5053889">context</span>&nbsp;<span class="op" id="5053897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053900">if</span>&nbsp;<span class="builtinfunc" id="5053903">len</span><span class="op" id="5053906">(</span><span class="ident" id="5053907">n</span><span class="op" id="5053908">.</span><span class="ident" id="5053909">Pipe</span><span class="op" id="5053913">.</span><span class="ident" id="5053914">Decl</span><span class="op" id="5053918">)</span>&nbsp;<span class="op" id="5053920">!=</span>&nbsp;<span class="num" id="5053923">0</span>&nbsp;<span class="op" id="5053925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5053929">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053985">return</span>&nbsp;<span class="ident" id="5053992">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5053995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5053998">c</span>&nbsp;<span class="op" id="5054000">=</span>&nbsp;<span class="ident" id="5054002">nudge</span><span class="op" id="5054007">(</span><span class="ident" id="5054008">c</span><span class="op" id="5054009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054012">s</span>&nbsp;<span class="op" id="5054014">:=</span>&nbsp;<span class="builtinfunc" id="5054017">make</span><span class="op" id="5054021">(</span><span class="op" id="5054022">[</span><span class="op" id="5054023">]</span><span class="builtintype" id="5054024">string</span><span class="op" id="5054030">,</span>&nbsp;<span class="num" id="5054032">0</span><span class="op" id="5054033">,</span>&nbsp;<span class="num" id="5054035">3</span><span class="op" id="5054036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054039">switch</span>&nbsp;<span class="ident" id="5054046">c</span><span class="op" id="5054047">.</span><span class="ident" id="5054048">state</span>&nbsp;<span class="op" id="5054054">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054057">case</span>&nbsp;<span class="ident" id="5054062">stateError</span><span class="op" id="5054072">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054076">return</span>&nbsp;<span class="ident" id="5054083">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054086">case</span>&nbsp;<span class="ident" id="5054091">stateURL</span><span class="op" id="5054099">,</span>&nbsp;<span class="ident" id="5054101">stateCSSDqStr</span><span class="op" id="5054114">,</span>&nbsp;<span class="ident" id="5054116">stateCSSSqStr</span><span class="op" id="5054129">,</span>&nbsp;<span class="ident" id="5054131">stateCSSDqURL</span><span class="op" id="5054144">,</span>&nbsp;<span class="ident" id="5054146">stateCSSSqURL</span><span class="op" id="5054159">,</span>&nbsp;<span class="ident" id="5054161">stateCSSURL</span><span class="op" id="5054172">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054176">switch</span>&nbsp;<span class="ident" id="5054183">c</span><span class="op" id="5054184">.</span><span class="ident" id="5054185">urlPart</span>&nbsp;<span class="op" id="5054193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054197">case</span>&nbsp;<span class="ident" id="5054202">urlPartNone</span><span class="op" id="5054213">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054218">s</span>&nbsp;<span class="op" id="5054220">=</span>&nbsp;<span class="builtinfunc" id="5054222">append</span><span class="op" id="5054228">(</span><span class="ident" id="5054229">s</span><span class="op" id="5054230">,</span>&nbsp;<span class="string" id="5054232">&#34;html_template_urlfilter&#34;</span><span class="op" id="5054257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054262">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054276">case</span>&nbsp;<span class="ident" id="5054281">urlPartPreQuery</span><span class="op" id="5054296">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054301">switch</span>&nbsp;<span class="ident" id="5054308">c</span><span class="op" id="5054309">.</span><span class="ident" id="5054310">state</span>&nbsp;<span class="op" id="5054316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054321">case</span>&nbsp;<span class="ident" id="5054326">stateCSSDqStr</span><span class="op" id="5054339">,</span>&nbsp;<span class="ident" id="5054341">stateCSSSqStr</span><span class="op" id="5054354">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054360">s</span>&nbsp;<span class="op" id="5054362">=</span>&nbsp;<span class="builtinfunc" id="5054364">append</span><span class="op" id="5054370">(</span><span class="ident" id="5054371">s</span><span class="op" id="5054372">,</span>&nbsp;<span class="string" id="5054374">&#34;html_template_cssescaper&#34;</span><span class="op" id="5054400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054405">default</span><span class="op" id="5054412">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054418">s</span>&nbsp;<span class="op" id="5054420">=</span>&nbsp;<span class="builtinfunc" id="5054422">append</span><span class="op" id="5054428">(</span><span class="ident" id="5054429">s</span><span class="op" id="5054430">,</span>&nbsp;<span class="string" id="5054432">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5054461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5054466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054470">case</span>&nbsp;<span class="ident" id="5054475">urlPartQueryOrFrag</span><span class="op" id="5054493">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054498">s</span>&nbsp;<span class="op" id="5054500">=</span>&nbsp;<span class="builtinfunc" id="5054502">append</span><span class="op" id="5054508">(</span><span class="ident" id="5054509">s</span><span class="op" id="5054510">,</span>&nbsp;<span class="string" id="5054512">&#34;html_template_urlescaper&#34;</span><span class="op" id="5054538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054542">case</span>&nbsp;<span class="ident" id="5054547">urlPartUnknown</span><span class="op" id="5054561">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054566">return</span>&nbsp;<span class="ident" id="5054573">context</span><span class="op" id="5054580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054586">state</span><span class="op" id="5054591">:</span>&nbsp;<span class="ident" id="5054593">stateError</span><span class="op" id="5054603">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054609">err</span><span class="op" id="5054612">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5054616">errorf</span><span class="op" id="5054622">(</span><span class="ident" id="5054623">ErrAmbigContext</span><span class="op" id="5054638">,</span>&nbsp;<span class="ident" id="5054640">n</span><span class="op" id="5054641">,</span>&nbsp;<span class="ident" id="5054643">n</span><span class="op" id="5054644">.</span><span class="ident" id="5054645">Line</span><span class="op" id="5054649">,</span>&nbsp;<span class="string" id="5054651">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="5054691">,</span>&nbsp;<span class="ident" id="5054693">n</span><span class="op" id="5054694">)</span><span class="op" id="5054695">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5054700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054704">default</span><span class="op" id="5054711">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5054716">panic</span><span class="op" id="5054721">(</span><span class="ident" id="5054722">c</span><span class="op" id="5054723">.</span><span class="ident" id="5054724">urlPart</span><span class="op" id="5054731">.</span><span class="ident" id="5054732">String</span><span class="op" id="5054738">(</span><span class="op" id="5054739">)</span><span class="op" id="5054740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5054744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054747">case</span>&nbsp;<span class="ident" id="5054752">stateJS</span><span class="op" id="5054759">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054763">s</span>&nbsp;<span class="op" id="5054765">=</span>&nbsp;<span class="builtinfunc" id="5054767">append</span><span class="op" id="5054773">(</span><span class="ident" id="5054774">s</span><span class="op" id="5054775">,</span>&nbsp;<span class="string" id="5054777">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="5054805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5054809">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054859">c</span><span class="op" id="5054860">.</span><span class="ident" id="5054861">jsCtx</span>&nbsp;<span class="op" id="5054867">=</span>&nbsp;<span class="ident" id="5054869">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054881">case</span>&nbsp;<span class="ident" id="5054886">stateJSDqStr</span><span class="op" id="5054898">,</span>&nbsp;<span class="ident" id="5054900">stateJSSqStr</span><span class="op" id="5054912">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054916">s</span>&nbsp;<span class="op" id="5054918">=</span>&nbsp;<span class="builtinfunc" id="5054920">append</span><span class="op" id="5054926">(</span><span class="ident" id="5054927">s</span><span class="op" id="5054928">,</span>&nbsp;<span class="string" id="5054930">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5054958">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054961">case</span>&nbsp;<span class="ident" id="5054966">stateJSRegexp</span><span class="op" id="5054979">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054983">s</span>&nbsp;<span class="op" id="5054985">=</span>&nbsp;<span class="builtinfunc" id="5054987">append</span><span class="op" id="5054993">(</span><span class="ident" id="5054994">s</span><span class="op" id="5054995">,</span>&nbsp;<span class="string" id="5054997">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5055028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055031">case</span>&nbsp;<span class="ident" id="5055036">stateCSS</span><span class="op" id="5055044">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055048">s</span>&nbsp;<span class="op" id="5055050">=</span>&nbsp;<span class="builtinfunc" id="5055052">append</span><span class="op" id="5055058">(</span><span class="ident" id="5055059">s</span><span class="op" id="5055060">,</span>&nbsp;<span class="string" id="5055062">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="5055092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055095">case</span>&nbsp;<span class="ident" id="5055100">stateText</span><span class="op" id="5055109">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055113">s</span>&nbsp;<span class="op" id="5055115">=</span>&nbsp;<span class="builtinfunc" id="5055117">append</span><span class="op" id="5055123">(</span><span class="ident" id="5055124">s</span><span class="op" id="5055125">,</span>&nbsp;<span class="string" id="5055127">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5055154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055157">case</span>&nbsp;<span class="ident" id="5055162">stateRCDATA</span><span class="op" id="5055173">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055177">s</span>&nbsp;<span class="op" id="5055179">=</span>&nbsp;<span class="builtinfunc" id="5055181">append</span><span class="op" id="5055187">(</span><span class="ident" id="5055188">s</span><span class="op" id="5055189">,</span>&nbsp;<span class="string" id="5055191">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5055220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055223">case</span>&nbsp;<span class="ident" id="5055228">stateAttr</span><span class="op" id="5055237">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5055241">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055275">case</span>&nbsp;<span class="ident" id="5055280">stateAttrName</span><span class="op" id="5055293">,</span>&nbsp;<span class="ident" id="5055295">stateTag</span><span class="op" id="5055303">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055307">c</span><span class="op" id="5055308">.</span><span class="ident" id="5055309">state</span>&nbsp;<span class="op" id="5055315">=</span>&nbsp;<span class="ident" id="5055317">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055333">s</span>&nbsp;<span class="op" id="5055335">=</span>&nbsp;<span class="builtinfunc" id="5055337">append</span><span class="op" id="5055343">(</span><span class="ident" id="5055344">s</span><span class="op" id="5055345">,</span>&nbsp;<span class="string" id="5055347">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="5055377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055380">default</span><span class="op" id="5055387">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055391">if</span>&nbsp;<span class="ident" id="5055394">isComment</span><span class="op" id="5055403">(</span><span class="ident" id="5055404">c</span><span class="op" id="5055405">.</span><span class="ident" id="5055406">state</span><span class="op" id="5055411">)</span>&nbsp;<span class="op" id="5055413">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055418">s</span>&nbsp;<span class="op" id="5055420">=</span>&nbsp;<span class="builtinfunc" id="5055422">append</span><span class="op" id="5055428">(</span><span class="ident" id="5055429">s</span><span class="op" id="5055430">,</span>&nbsp;<span class="string" id="5055432">&#34;html_template_commentescaper&#34;</span><span class="op" id="5055462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5055466">}</span>&nbsp;<span class="keyword" id="5055468">else</span>&nbsp;<span class="op" id="5055473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5055478">panic</span><span class="op" id="5055483">(</span><span class="string" id="5055484">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="5055504">+</span>&nbsp;<span class="ident" id="5055506">c</span><span class="op" id="5055507">.</span><span class="ident" id="5055508">state</span><span class="op" id="5055513">.</span><span class="ident" id="5055514">String</span><span class="op" id="5055520">(</span><span class="op" id="5055521">)</span><span class="op" id="5055522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5055526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5055529">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055532">switch</span>&nbsp;<span class="ident" id="5055539">c</span><span class="op" id="5055540">.</span><span class="ident" id="5055541">delim</span>&nbsp;<span class="op" id="5055547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055550">case</span>&nbsp;<span class="ident" id="5055555">delimNone</span><span class="op" id="5055564">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5055568">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055619">case</span>&nbsp;<span class="ident" id="5055624">delimSpaceOrTagEnd</span><span class="op" id="5055642">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055646">s</span>&nbsp;<span class="op" id="5055648">=</span>&nbsp;<span class="builtinfunc" id="5055650">append</span><span class="op" id="5055656">(</span><span class="ident" id="5055657">s</span><span class="op" id="5055658">,</span>&nbsp;<span class="string" id="5055660">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5055690">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055693">default</span><span class="op" id="5055700">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055704">s</span>&nbsp;<span class="op" id="5055706">=</span>&nbsp;<span class="builtinfunc" id="5055708">append</span><span class="op" id="5055714">(</span><span class="ident" id="5055715">s</span><span class="op" id="5055716">,</span>&nbsp;<span class="string" id="5055718">&#34;html_template_attrescaper&#34;</span><span class="op" id="5055745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5055748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055751">e</span><span class="op" id="5055752">.</span><span class="ident" id="5055753">editActionNode</span><span class="op" id="5055767">(</span><span class="ident" id="5055768">n</span><span class="op" id="5055769">,</span>&nbsp;<span class="ident" id="5055771">s</span><span class="op" id="5055772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055775">return</span>&nbsp;<span class="ident" id="5055782">c</span><br>
<span class="lineno">205</span><span class="op" id="5055784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5055787">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="5055872">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="5055935">func</span>&nbsp;<span class="ident" id="5055940">allIdents</span><span class="op" id="5055949">(</span><span class="ident" id="5055950">node</span>&nbsp;<span class="ident" id="5055955">parse</span><span class="op" id="5055960">.</span><span class="ident" id="5055961">Node</span><span class="op" id="5055965">)</span>&nbsp;<span class="op" id="5055967">[</span><span class="op" id="5055968">]</span><span class="builtintype" id="5055969">string</span>&nbsp;<span class="op" id="5055976">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055979">switch</span>&nbsp;<span class="ident" id="5055986">node</span>&nbsp;<span class="op" id="5055991">:=</span>&nbsp;<span class="ident" id="5055994">node</span><span class="op" id="5055998">.</span><span class="op" id="5055999">(</span><span class="keyword" id="5056000">type</span><span class="op" id="5056004">)</span>&nbsp;<span class="op" id="5056006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056009">case</span>&nbsp;<span class="op" id="5056014">*</span><span class="ident" id="5056015">parse</span><span class="op" id="5056020">.</span><span class="ident" id="5056021">IdentifierNode</span><span class="op" id="5056035">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056039">return</span>&nbsp;<span class="op" id="5056046">[</span><span class="op" id="5056047">]</span><span class="builtintype" id="5056048">string</span><span class="op" id="5056054">{</span><span class="ident" id="5056055">node</span><span class="op" id="5056059">.</span><span class="ident" id="5056060">Ident</span><span class="op" id="5056065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056068">case</span>&nbsp;<span class="op" id="5056073">*</span><span class="ident" id="5056074">parse</span><span class="op" id="5056079">.</span><span class="ident" id="5056080">FieldNode</span><span class="op" id="5056089">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056093">return</span>&nbsp;<span class="ident" id="5056100">node</span><span class="op" id="5056104">.</span><span class="ident" id="5056105">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5056112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5056115">panic</span><span class="op" id="5056120">(</span><span class="string" id="5056121">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="5056158">)</span><br>
<span class="lineno"></span><span class="op" id="5056160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5056163">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="5056233">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="5056267">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="5056340">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5056417">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="5056491">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="5056521">func</span>&nbsp;<span class="ident" id="5056526">ensurePipelineContains</span><span class="op" id="5056548">(</span><span class="ident" id="5056549">p</span>&nbsp;<span class="op" id="5056551">*</span><span class="ident" id="5056552">parse</span><span class="op" id="5056557">.</span><span class="ident" id="5056558">PipeNode</span><span class="op" id="5056566">,</span>&nbsp;<span class="ident" id="5056568">s</span>&nbsp;<span class="op" id="5056570">[</span><span class="op" id="5056571">]</span><span class="builtintype" id="5056572">string</span><span class="op" id="5056578">)</span>&nbsp;<span class="op" id="5056580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056583">if</span>&nbsp;<span class="builtinfunc" id="5056586">len</span><span class="op" id="5056589">(</span><span class="ident" id="5056590">s</span><span class="op" id="5056591">)</span>&nbsp;<span class="op" id="5056593">==</span>&nbsp;<span class="num" id="5056596">0</span>&nbsp;<span class="op" id="5056598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056602">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5056610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5056613">n</span>&nbsp;<span class="op" id="5056615">:=</span>&nbsp;<span class="builtinfunc" id="5056618">len</span><span class="op" id="5056621">(</span><span class="ident" id="5056622">p</span><span class="op" id="5056623">.</span><span class="ident" id="5056624">Cmds</span><span class="op" id="5056628">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5056631">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5056689">idents</span>&nbsp;<span class="op" id="5056696">:=</span>&nbsp;<span class="ident" id="5056699">p</span><span class="op" id="5056700">.</span><span class="ident" id="5056701">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056707">for</span>&nbsp;<span class="ident" id="5056711">i</span>&nbsp;<span class="op" id="5056713">:=</span>&nbsp;<span class="ident" id="5056716">n</span>&nbsp;<span class="op" id="5056718">-</span>&nbsp;<span class="num" id="5056720">1</span><span class="op" id="5056721">;</span>&nbsp;<span class="ident" id="5056723">i</span>&nbsp;<span class="op" id="5056725">&gt;=</span>&nbsp;<span class="num" id="5056728">0</span><span class="op" id="5056729">;</span>&nbsp;<span class="ident" id="5056731">i</span><span class="op" id="5056732">--</span>&nbsp;<span class="op" id="5056735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056739">if</span>&nbsp;<span class="ident" id="5056742">cmd</span>&nbsp;<span class="op" id="5056746">:=</span>&nbsp;<span class="ident" id="5056749">p</span><span class="op" id="5056750">.</span><span class="ident" id="5056751">Cmds</span><span class="op" id="5056755">[</span><span class="ident" id="5056756">i</span><span class="op" id="5056757">]</span><span class="op" id="5056758">;</span>&nbsp;<span class="builtinfunc" id="5056760">len</span><span class="op" id="5056763">(</span><span class="ident" id="5056764">cmd</span><span class="op" id="5056767">.</span><span class="ident" id="5056768">Args</span><span class="op" id="5056772">)</span>&nbsp;<span class="op" id="5056774">!=</span>&nbsp;<span class="num" id="5056777">0</span>&nbsp;<span class="op" id="5056779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056784">if</span>&nbsp;<span class="ident" id="5056787">_</span><span class="op" id="5056788">,</span>&nbsp;<span class="ident" id="5056790">ok</span>&nbsp;<span class="op" id="5056793">:=</span>&nbsp;<span class="ident" id="5056796">cmd</span><span class="op" id="5056799">.</span><span class="ident" id="5056800">Args</span><span class="op" id="5056804">[</span><span class="num" id="5056805">0</span><span class="op" id="5056806">]</span><span class="op" id="5056807">.</span><span class="op" id="5056808">(</span><span class="op" id="5056809">*</span><span class="ident" id="5056810">parse</span><span class="op" id="5056815">.</span><span class="ident" id="5056816">IdentifierNode</span><span class="op" id="5056830">)</span><span class="op" id="5056831">;</span>&nbsp;<span class="ident" id="5056833">ok</span>&nbsp;<span class="op" id="5056836">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056842">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5056854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5056858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5056862">idents</span>&nbsp;<span class="op" id="5056869">=</span>&nbsp;<span class="ident" id="5056871">p</span><span class="op" id="5056872">.</span><span class="ident" id="5056873">Cmds</span><span class="op" id="5056877">[</span><span class="ident" id="5056878">i</span><span class="op" id="5056879">+</span><span class="num" id="5056880">1</span><span class="op" id="5056881">:</span><span class="op" id="5056882">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5056885">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5056888">dups</span>&nbsp;<span class="op" id="5056893">:=</span>&nbsp;<span class="num" id="5056896">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056899">for</span>&nbsp;<span class="ident" id="5056903">_</span><span class="op" id="5056904">,</span>&nbsp;<span class="ident" id="5056906">idNode</span>&nbsp;<span class="op" id="5056913">:=</span>&nbsp;<span class="keyword" id="5056916">range</span>&nbsp;<span class="ident" id="5056922">idents</span>&nbsp;<span class="op" id="5056929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056933">for</span>&nbsp;<span class="ident" id="5056937">_</span><span class="op" id="5056938">,</span>&nbsp;<span class="ident" id="5056940">ident</span>&nbsp;<span class="op" id="5056946">:=</span>&nbsp;<span class="keyword" id="5056949">range</span>&nbsp;<span class="ident" id="5056955">allIdents</span><span class="op" id="5056964">(</span><span class="ident" id="5056965">idNode</span><span class="op" id="5056971">.</span><span class="ident" id="5056972">Args</span><span class="op" id="5056976">[</span><span class="num" id="5056977">0</span><span class="op" id="5056978">]</span><span class="op" id="5056979">)</span>&nbsp;<span class="op" id="5056981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056986">if</span>&nbsp;<span class="ident" id="5056989">escFnsEq</span><span class="op" id="5056997">(</span><span class="ident" id="5056998">s</span><span class="op" id="5056999">[</span><span class="ident" id="5057000">dups</span><span class="op" id="5057004">]</span><span class="op" id="5057005">,</span>&nbsp;<span class="ident" id="5057007">ident</span><span class="op" id="5057012">)</span>&nbsp;<span class="op" id="5057014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5057020">dups</span><span class="op" id="5057024">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057031">if</span>&nbsp;<span class="ident" id="5057034">dups</span>&nbsp;<span class="op" id="5057039">==</span>&nbsp;<span class="builtinfunc" id="5057042">len</span><span class="op" id="5057045">(</span><span class="ident" id="5057046">s</span><span class="op" id="5057047">)</span>&nbsp;<span class="op" id="5057049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057056">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5057067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5057072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5057076">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5057079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5057082">newCmds</span>&nbsp;<span class="op" id="5057090">:=</span>&nbsp;<span class="builtinfunc" id="5057093">make</span><span class="op" id="5057097">(</span><span class="op" id="5057098">[</span><span class="op" id="5057099">]</span><span class="op" id="5057100">*</span><span class="ident" id="5057101">parse</span><span class="op" id="5057106">.</span><span class="ident" id="5057107">CommandNode</span><span class="op" id="5057118">,</span>&nbsp;<span class="ident" id="5057120">n</span><span class="op" id="5057121">-</span><span class="builtinfunc" id="5057122">len</span><span class="op" id="5057125">(</span><span class="ident" id="5057126">idents</span><span class="op" id="5057132">)</span><span class="op" id="5057133">,</span>&nbsp;<span class="ident" id="5057135">n</span><span class="op" id="5057136">+</span><span class="builtinfunc" id="5057137">len</span><span class="op" id="5057140">(</span><span class="ident" id="5057141">s</span><span class="op" id="5057142">)</span><span class="op" id="5057143">-</span><span class="ident" id="5057144">dups</span><span class="op" id="5057148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5057151">copy</span><span class="op" id="5057155">(</span><span class="ident" id="5057156">newCmds</span><span class="op" id="5057163">,</span>&nbsp;<span class="ident" id="5057165">p</span><span class="op" id="5057166">.</span><span class="ident" id="5057167">Cmds</span><span class="op" id="5057171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5057174">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057241">for</span>&nbsp;<span class="ident" id="5057245">_</span><span class="op" id="5057246">,</span>&nbsp;<span class="ident" id="5057248">idNode</span>&nbsp;<span class="op" id="5057255">:=</span>&nbsp;<span class="keyword" id="5057258">range</span>&nbsp;<span class="ident" id="5057264">idents</span>&nbsp;<span class="op" id="5057271">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5057275">pos</span>&nbsp;<span class="op" id="5057279">:=</span>&nbsp;<span class="ident" id="5057282">idNode</span><span class="op" id="5057288">.</span><span class="ident" id="5057289">Args</span><span class="op" id="5057293">[</span><span class="num" id="5057294">0</span><span class="op" id="5057295">]</span><span class="op" id="5057296">.</span><span class="ident" id="5057297">Position</span><span class="op" id="5057305">(</span><span class="op" id="5057306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057310">for</span>&nbsp;<span class="ident" id="5057314">_</span><span class="op" id="5057315">,</span>&nbsp;<span class="ident" id="5057317">ident</span>&nbsp;<span class="op" id="5057323">:=</span>&nbsp;<span class="keyword" id="5057326">range</span>&nbsp;<span class="ident" id="5057332">allIdents</span><span class="op" id="5057341">(</span><span class="ident" id="5057342">idNode</span><span class="op" id="5057348">.</span><span class="ident" id="5057349">Args</span><span class="op" id="5057353">[</span><span class="num" id="5057354">0</span><span class="op" id="5057355">]</span><span class="op" id="5057356">)</span>&nbsp;<span class="op" id="5057358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5057363">i</span>&nbsp;<span class="op" id="5057365">:=</span>&nbsp;<span class="ident" id="5057368">indexOfStr</span><span class="op" id="5057378">(</span><span class="ident" id="5057379">ident</span><span class="op" id="5057384">,</span>&nbsp;<span class="ident" id="5057386">s</span><span class="op" id="5057387">,</span>&nbsp;<span class="ident" id="5057389">escFnsEq</span><span class="op" id="5057397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057402">if</span>&nbsp;<span class="ident" id="5057405">i</span>&nbsp;<span class="op" id="5057407">!=</span>&nbsp;<span class="op" id="5057410">-</span><span class="num" id="5057411">1</span>&nbsp;<span class="op" id="5057413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057419">for</span>&nbsp;<span class="ident" id="5057423">_</span><span class="op" id="5057424">,</span>&nbsp;<span class="ident" id="5057426">name</span>&nbsp;<span class="op" id="5057431">:=</span>&nbsp;<span class="keyword" id="5057434">range</span>&nbsp;<span class="ident" id="5057440">s</span><span class="op" id="5057441">[</span><span class="op" id="5057442">:</span><span class="ident" id="5057443">i</span><span class="op" id="5057444">]</span>&nbsp;<span class="op" id="5057446">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5057453">newCmds</span>&nbsp;<span class="op" id="5057461">=</span>&nbsp;<span class="ident" id="5057463">appendCmd</span><span class="op" id="5057472">(</span><span class="ident" id="5057473">newCmds</span><span class="op" id="5057480">,</span>&nbsp;<span class="ident" id="5057482">newIdentCmd</span><span class="op" id="5057493">(</span><span class="ident" id="5057494">name</span><span class="op" id="5057498">,</span>&nbsp;<span class="ident" id="5057500">pos</span><span class="op" id="5057503">)</span><span class="op" id="5057504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5057510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5057516">s</span>&nbsp;<span class="op" id="5057518">=</span>&nbsp;<span class="ident" id="5057520">s</span><span class="op" id="5057521">[</span><span class="ident" id="5057522">i</span><span class="op" id="5057523">+</span><span class="num" id="5057524">1</span><span class="op" id="5057525">:</span><span class="op" id="5057526">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5057531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5057535">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5057539">newCmds</span>&nbsp;<span class="op" id="5057547">=</span>&nbsp;<span class="ident" id="5057549">appendCmd</span><span class="op" id="5057558">(</span><span class="ident" id="5057559">newCmds</span><span class="op" id="5057566">,</span>&nbsp;<span class="ident" id="5057568">idNode</span><span class="op" id="5057574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5057577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5057580">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057617">for</span>&nbsp;<span class="ident" id="5057621">_</span><span class="op" id="5057622">,</span>&nbsp;<span class="ident" id="5057624">name</span>&nbsp;<span class="op" id="5057629">:=</span>&nbsp;<span class="keyword" id="5057632">range</span>&nbsp;<span class="ident" id="5057638">s</span>&nbsp;<span class="op" id="5057640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5057644">newCmds</span>&nbsp;<span class="op" id="5057652">=</span>&nbsp;<span class="ident" id="5057654">appendCmd</span><span class="op" id="5057663">(</span><span class="ident" id="5057664">newCmds</span><span class="op" id="5057671">,</span>&nbsp;<span class="ident" id="5057673">newIdentCmd</span><span class="op" id="5057684">(</span><span class="ident" id="5057685">name</span><span class="op" id="5057689">,</span>&nbsp;<span class="ident" id="5057691">p</span><span class="op" id="5057692">.</span><span class="ident" id="5057693">Position</span><span class="op" id="5057701">(</span><span class="op" id="5057702">)</span><span class="op" id="5057703">)</span><span class="op" id="5057704">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5057707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5057710">p</span><span class="op" id="5057711">.</span><span class="ident" id="5057712">Cmds</span>&nbsp;<span class="op" id="5057717">=</span>&nbsp;<span class="ident" id="5057719">newCmds</span><br>
<span class="lineno"></span><span class="op" id="5057727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5057730">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="5057810">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="5057824">var</span>&nbsp;<span class="ident" id="5057828">redundantFuncs</span>&nbsp;<span class="op" id="5057843">=</span>&nbsp;<span class="keyword" id="5057845">map</span><span class="op" id="5057848">[</span><span class="builtintype" id="5057849">string</span><span class="op" id="5057855">]</span><span class="keyword" id="5057856">map</span><span class="op" id="5057859">[</span><span class="builtintype" id="5057860">string</span><span class="op" id="5057866">]</span><span class="builtintype" id="5057867">bool</span><span class="op" id="5057871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5057874">&#34;html_template_commentescaper&#34;</span><span class="op" id="5057904">:</span>&nbsp;<span class="op" id="5057906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5057910">&#34;html_template_attrescaper&#34;</span><span class="op" id="5057937">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5057942">true</span><span class="op" id="5057946">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5057950">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5057980">:</span>&nbsp;<span class="builtintype" id="5057982">true</span><span class="op" id="5057986">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5057990">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5058017">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5058022">true</span><span class="op" id="5058026">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5058029">}</span><span class="op" id="5058030">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5058033">&#34;html_template_cssescaper&#34;</span><span class="op" id="5058059">:</span>&nbsp;<span class="op" id="5058061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5058065">&#34;html_template_attrescaper&#34;</span><span class="op" id="5058092">:</span>&nbsp;<span class="builtintype" id="5058094">true</span><span class="op" id="5058098">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5058101">}</span><span class="op" id="5058102">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5058105">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5058136">:</span>&nbsp;<span class="op" id="5058138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5058142">&#34;html_template_attrescaper&#34;</span><span class="op" id="5058169">:</span>&nbsp;<span class="builtintype" id="5058171">true</span><span class="op" id="5058175">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5058178">}</span><span class="op" id="5058179">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5058182">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5058210">:</span>&nbsp;<span class="op" id="5058212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5058216">&#34;html_template_attrescaper&#34;</span><span class="op" id="5058243">:</span>&nbsp;<span class="builtintype" id="5058245">true</span><span class="op" id="5058249">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5058252">}</span><span class="op" id="5058253">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5058256">&#34;html_template_urlescaper&#34;</span><span class="op" id="5058282">:</span>&nbsp;<span class="op" id="5058284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5058288">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5058317">:</span>&nbsp;<span class="builtintype" id="5058319">true</span><span class="op" id="5058323">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5058326">}</span><span class="op" id="5058327">,</span><br>
<span class="lineno"></span><span class="op" id="5058329">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="5058332">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="5058406">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="5058455">func</span>&nbsp;<span class="ident" id="5058460">appendCmd</span><span class="op" id="5058469">(</span><span class="ident" id="5058470">cmds</span>&nbsp;<span class="op" id="5058475">[</span><span class="op" id="5058476">]</span><span class="op" id="5058477">*</span><span class="ident" id="5058478">parse</span><span class="op" id="5058483">.</span><span class="ident" id="5058484">CommandNode</span><span class="op" id="5058495">,</span>&nbsp;<span class="ident" id="5058497">cmd</span>&nbsp;<span class="op" id="5058501">*</span><span class="ident" id="5058502">parse</span><span class="op" id="5058507">.</span><span class="ident" id="5058508">CommandNode</span><span class="op" id="5058519">)</span>&nbsp;<span class="op" id="5058521">[</span><span class="op" id="5058522">]</span><span class="op" id="5058523">*</span><span class="ident" id="5058524">parse</span><span class="op" id="5058529">.</span><span class="ident" id="5058530">CommandNode</span>&nbsp;<span class="op" id="5058542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5058545">if</span>&nbsp;<span class="ident" id="5058548">n</span>&nbsp;<span class="op" id="5058550">:=</span>&nbsp;<span class="builtinfunc" id="5058553">len</span><span class="op" id="5058556">(</span><span class="ident" id="5058557">cmds</span><span class="op" id="5058561">)</span><span class="op" id="5058562">;</span>&nbsp;<span class="ident" id="5058564">n</span>&nbsp;<span class="op" id="5058566">!=</span>&nbsp;<span class="num" id="5058569">0</span>&nbsp;<span class="op" id="5058571">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058575">last</span><span class="op" id="5058579">,</span>&nbsp;<span class="ident" id="5058581">ok</span>&nbsp;<span class="op" id="5058584">:=</span>&nbsp;<span class="ident" id="5058587">cmds</span><span class="op" id="5058591">[</span><span class="ident" id="5058592">n</span><span class="op" id="5058593">-</span><span class="num" id="5058594">1</span><span class="op" id="5058595">]</span><span class="op" id="5058596">.</span><span class="ident" id="5058597">Args</span><span class="op" id="5058601">[</span><span class="num" id="5058602">0</span><span class="op" id="5058603">]</span><span class="op" id="5058604">.</span><span class="op" id="5058605">(</span><span class="op" id="5058606">*</span><span class="ident" id="5058607">parse</span><span class="op" id="5058612">.</span><span class="ident" id="5058613">IdentifierNode</span><span class="op" id="5058627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5058631">next</span><span class="op" id="5058635">,</span>&nbsp;<span class="ident" id="5058637">_</span>&nbsp;<span class="op" id="5058639">:=</span>&nbsp;<span class="ident" id="5058642">cmd</span><span class="op" id="5058645">.</span><span class="ident" id="5058646">Args</span><span class="op" id="5058650">[</span><span class="num" id="5058651">0</span><span class="op" id="5058652">]</span><span class="op" id="5058653">.</span><span class="op" id="5058654">(</span><span class="op" id="5058655">*</span><span class="ident" id="5058656">parse</span><span class="op" id="5058661">.</span><span class="ident" id="5058662">IdentifierNode</span><span class="op" id="5058676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5058680">if</span>&nbsp;<span class="ident" id="5058683">ok</span>&nbsp;<span class="op" id="5058686">&amp;&amp;</span>&nbsp;<span class="ident" id="5058689">redundantFuncs</span><span class="op" id="5058703">[</span><span class="ident" id="5058704">last</span><span class="op" id="5058708">.</span><span class="ident" id="5058709">Ident</span><span class="op" id="5058714">]</span><span class="op" id="5058715">[</span><span class="ident" id="5058716">next</span><span class="op" id="5058720">.</span><span class="ident" id="5058721">Ident</span><span class="op" id="5058726">]</span>&nbsp;<span class="op" id="5058728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5058733">return</span>&nbsp;<span class="ident" id="5058740">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5058747">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5058750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5058753">return</span>&nbsp;<span class="builtinfunc" id="5058760">append</span><span class="op" id="5058766">(</span><span class="ident" id="5058767">cmds</span><span class="op" id="5058771">,</span>&nbsp;<span class="ident" id="5058773">cmd</span><span class="op" id="5058776">)</span><br>
<span class="lineno"></span><span class="op" id="5058778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5058781">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="5058861">func</span>&nbsp;<span class="ident" id="5058866">indexOfStr</span><span class="op" id="5058876">(</span><span class="ident" id="5058877">s</span>&nbsp;<span class="builtintype" id="5058879">string</span><span class="op" id="5058885">,</span>&nbsp;<span class="ident" id="5058887">strs</span>&nbsp;<span class="op" id="5058892">[</span><span class="op" id="5058893">]</span><span class="builtintype" id="5058894">string</span><span class="op" id="5058900">,</span>&nbsp;<span class="ident" id="5058902">eq</span>&nbsp;<span class="keyword" id="5058905">func</span><span class="op" id="5058909">(</span><span class="ident" id="5058910">a</span><span class="op" id="5058911">,</span>&nbsp;<span class="ident" id="5058913">b</span>&nbsp;<span class="builtintype" id="5058915">string</span><span class="op" id="5058921">)</span>&nbsp;<span class="builtintype" id="5058923">bool</span><span class="op" id="5058927">)</span>&nbsp;<span class="builtintype" id="5058929">int</span>&nbsp;<span class="op" id="5058933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5058936">for</span>&nbsp;<span class="ident" id="5058940">i</span><span class="op" id="5058941">,</span>&nbsp;<span class="ident" id="5058943">t</span>&nbsp;<span class="op" id="5058945">:=</span>&nbsp;<span class="keyword" id="5058948">range</span>&nbsp;<span class="ident" id="5058954">strs</span>&nbsp;<span class="op" id="5058959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5058963">if</span>&nbsp;<span class="ident" id="5058966">eq</span><span class="op" id="5058968">(</span><span class="ident" id="5058969">s</span><span class="op" id="5058970">,</span>&nbsp;<span class="ident" id="5058972">t</span><span class="op" id="5058973">)</span>&nbsp;<span class="op" id="5058975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5058980">return</span>&nbsp;<span class="ident" id="5058987">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5058991">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5058994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5058997">return</span>&nbsp;<span class="op" id="5059004">-</span><span class="num" id="5059005">1</span><br>
<span class="lineno"></span><span class="op" id="5059007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5059010">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="5059081">func</span>&nbsp;<span class="ident" id="5059086">escFnsEq</span><span class="op" id="5059094">(</span><span class="ident" id="5059095">a</span><span class="op" id="5059096">,</span>&nbsp;<span class="ident" id="5059098">b</span>&nbsp;<span class="builtintype" id="5059100">string</span><span class="op" id="5059106">)</span>&nbsp;<span class="builtintype" id="5059108">bool</span>&nbsp;<span class="op" id="5059113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5059116">if</span>&nbsp;<span class="ident" id="5059119">e</span>&nbsp;<span class="op" id="5059121">:=</span>&nbsp;<span class="ident" id="5059124">equivEscapers</span><span class="op" id="5059137">[</span><span class="ident" id="5059138">a</span><span class="op" id="5059139">]</span><span class="op" id="5059140">;</span>&nbsp;<span class="ident" id="5059142">e</span>&nbsp;<span class="op" id="5059144">!=</span>&nbsp;<span class="string" id="5059147">&#34;&#34;</span>&nbsp;<span class="op" id="5059150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5059154">a</span>&nbsp;<span class="op" id="5059156">=</span>&nbsp;<span class="ident" id="5059158">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5059161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5059164">if</span>&nbsp;<span class="ident" id="5059167">e</span>&nbsp;<span class="op" id="5059169">:=</span>&nbsp;<span class="ident" id="5059172">equivEscapers</span><span class="op" id="5059185">[</span><span class="ident" id="5059186">b</span><span class="op" id="5059187">]</span><span class="op" id="5059188">;</span>&nbsp;<span class="ident" id="5059190">e</span>&nbsp;<span class="op" id="5059192">!=</span>&nbsp;<span class="string" id="5059195">&#34;&#34;</span>&nbsp;<span class="op" id="5059198">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5059202">b</span>&nbsp;<span class="op" id="5059204">=</span>&nbsp;<span class="ident" id="5059206">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5059209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5059212">return</span>&nbsp;<span class="ident" id="5059219">a</span>&nbsp;<span class="op" id="5059221">==</span>&nbsp;<span class="ident" id="5059224">b</span><br>
<span class="lineno"></span><span class="op" id="5059226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="5059229">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5059300">func</span>&nbsp;<span class="ident" id="5059305">newIdentCmd</span><span class="op" id="5059316">(</span><span class="ident" id="5059317">identifier</span>&nbsp;<span class="builtintype" id="5059328">string</span><span class="op" id="5059334">,</span>&nbsp;<span class="ident" id="5059336">pos</span>&nbsp;<span class="ident" id="5059340">parse</span><span class="op" id="5059345">.</span><span class="ident" id="5059346">Pos</span><span class="op" id="5059349">)</span>&nbsp;<span class="op" id="5059351">*</span><span class="ident" id="5059352">parse</span><span class="op" id="5059357">.</span><span class="ident" id="5059358">CommandNode</span>&nbsp;<span class="op" id="5059370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5059373">return</span>&nbsp;<span class="op" id="5059380">&amp;</span><span class="ident" id="5059381">parse</span><span class="op" id="5059386">.</span><span class="ident" id="5059387">CommandNode</span><span class="op" id="5059398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5059402">NodeType</span><span class="op" id="5059410">:</span>&nbsp;<span class="ident" id="5059412">parse</span><span class="op" id="5059417">.</span><span class="ident" id="5059418">NodeCommand</span><span class="op" id="5059429">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5059433">Args</span><span class="op" id="5059437">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5059443">[</span><span class="op" id="5059444">]</span><span class="ident" id="5059445">parse</span><span class="op" id="5059450">.</span><span class="ident" id="5059451">Node</span><span class="op" id="5059455">{</span><span class="ident" id="5059456">parse</span><span class="op" id="5059461">.</span><span class="ident" id="5059462">NewIdentifier</span><span class="op" id="5059475">(</span><span class="ident" id="5059476">identifier</span><span class="op" id="5059486">)</span><span class="op" id="5059487">.</span><span class="ident" id="5059488">SetTree</span><span class="op" id="5059495">(</span><span class="ident" id="5059496">nil</span><span class="op" id="5059499">)</span><span class="op" id="5059500">.</span><span class="ident" id="5059501">SetPos</span><span class="op" id="5059507">(</span><span class="ident" id="5059508">pos</span><span class="op" id="5059511">)</span><span class="op" id="5059512">}</span><span class="op" id="5059513">,</span>&nbsp;<span class="comment" id="5059515">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5059534">}</span><br>
<span class="lineno"></span><span class="op" id="5059536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5059539">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5059614">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="5059653">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="5059678">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="5059696">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="5059775">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="5059794">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="5059853">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="5059916">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="5059994">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5060026">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5060092">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="5060157">func</span>&nbsp;<span class="ident" id="5060162">nudge</span><span class="op" id="5060167">(</span><span class="ident" id="5060168">c</span>&nbsp;<span class="ident" id="5060170">context</span><span class="op" id="5060177">)</span>&nbsp;<span class="ident" id="5060179">context</span>&nbsp;<span class="op" id="5060187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5060190">switch</span>&nbsp;<span class="ident" id="5060197">c</span><span class="op" id="5060198">.</span><span class="ident" id="5060199">state</span>&nbsp;<span class="op" id="5060205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5060208">case</span>&nbsp;<span class="ident" id="5060213">stateTag</span><span class="op" id="5060221">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5060225">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060284">c</span><span class="op" id="5060285">.</span><span class="ident" id="5060286">state</span>&nbsp;<span class="op" id="5060292">=</span>&nbsp;<span class="ident" id="5060294">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5060309">case</span>&nbsp;<span class="ident" id="5060314">stateBeforeValue</span><span class="op" id="5060330">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5060334">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060396">c</span><span class="op" id="5060397">.</span><span class="ident" id="5060398">state</span><span class="op" id="5060403">,</span>&nbsp;<span class="ident" id="5060405">c</span><span class="op" id="5060406">.</span><span class="ident" id="5060407">delim</span><span class="op" id="5060412">,</span>&nbsp;<span class="ident" id="5060414">c</span><span class="op" id="5060415">.</span><span class="ident" id="5060416">attr</span>&nbsp;<span class="op" id="5060421">=</span>&nbsp;<span class="ident" id="5060423">attrStartStates</span><span class="op" id="5060438">[</span><span class="ident" id="5060439">c</span><span class="op" id="5060440">.</span><span class="ident" id="5060441">attr</span><span class="op" id="5060445">]</span><span class="op" id="5060446">,</span>&nbsp;<span class="ident" id="5060448">delimSpaceOrTagEnd</span><span class="op" id="5060466">,</span>&nbsp;<span class="ident" id="5060468">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5060478">case</span>&nbsp;<span class="ident" id="5060483">stateAfterName</span><span class="op" id="5060497">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5060501">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060560">c</span><span class="op" id="5060561">.</span><span class="ident" id="5060562">state</span><span class="op" id="5060567">,</span>&nbsp;<span class="ident" id="5060569">c</span><span class="op" id="5060570">.</span><span class="ident" id="5060571">attr</span>&nbsp;<span class="op" id="5060576">=</span>&nbsp;<span class="ident" id="5060578">stateAttrName</span><span class="op" id="5060591">,</span>&nbsp;<span class="ident" id="5060593">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5060603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5060606">return</span>&nbsp;<span class="ident" id="5060613">c</span><br>
<span class="lineno"></span><span class="op" id="5060615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="5060618">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5060693">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5060772">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="5060802">func</span>&nbsp;<span class="ident" id="5060807">join</span><span class="op" id="5060811">(</span><span class="ident" id="5060812">a</span><span class="op" id="5060813">,</span>&nbsp;<span class="ident" id="5060815">b</span>&nbsp;<span class="ident" id="5060817">context</span><span class="op" id="5060824">,</span>&nbsp;<span class="ident" id="5060826">node</span>&nbsp;<span class="ident" id="5060831">parse</span><span class="op" id="5060836">.</span><span class="ident" id="5060837">Node</span><span class="op" id="5060841">,</span>&nbsp;<span class="ident" id="5060843">nodeName</span>&nbsp;<span class="builtintype" id="5060852">string</span><span class="op" id="5060858">)</span>&nbsp;<span class="ident" id="5060860">context</span>&nbsp;<span class="op" id="5060868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5060871">if</span>&nbsp;<span class="ident" id="5060874">a</span><span class="op" id="5060875">.</span><span class="ident" id="5060876">state</span>&nbsp;<span class="op" id="5060882">==</span>&nbsp;<span class="ident" id="5060885">stateError</span>&nbsp;<span class="op" id="5060896">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5060900">return</span>&nbsp;<span class="ident" id="5060907">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5060910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5060913">if</span>&nbsp;<span class="ident" id="5060916">b</span><span class="op" id="5060917">.</span><span class="ident" id="5060918">state</span>&nbsp;<span class="op" id="5060924">==</span>&nbsp;<span class="ident" id="5060927">stateError</span>&nbsp;<span class="op" id="5060938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5060942">return</span>&nbsp;<span class="ident" id="5060949">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5060952">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5060955">if</span>&nbsp;<span class="ident" id="5060958">a</span><span class="op" id="5060959">.</span><span class="ident" id="5060960">eq</span><span class="op" id="5060962">(</span><span class="ident" id="5060963">b</span><span class="op" id="5060964">)</span>&nbsp;<span class="op" id="5060966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5060970">return</span>&nbsp;<span class="ident" id="5060977">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5060980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060984">c</span>&nbsp;<span class="op" id="5060986">:=</span>&nbsp;<span class="ident" id="5060989">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5060992">c</span><span class="op" id="5060993">.</span><span class="ident" id="5060994">urlPart</span>&nbsp;<span class="op" id="5061002">=</span>&nbsp;<span class="ident" id="5061004">b</span><span class="op" id="5061005">.</span><span class="ident" id="5061006">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061015">if</span>&nbsp;<span class="ident" id="5061018">c</span><span class="op" id="5061019">.</span><span class="ident" id="5061020">eq</span><span class="op" id="5061022">(</span><span class="ident" id="5061023">b</span><span class="op" id="5061024">)</span>&nbsp;<span class="op" id="5061026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5061030">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5061072">c</span><span class="op" id="5061073">.</span><span class="ident" id="5061074">urlPart</span>&nbsp;<span class="op" id="5061082">=</span>&nbsp;<span class="ident" id="5061084">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061101">return</span>&nbsp;<span class="ident" id="5061108">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5061111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5061115">c</span>&nbsp;<span class="op" id="5061117">=</span>&nbsp;<span class="ident" id="5061119">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5061122">c</span><span class="op" id="5061123">.</span><span class="ident" id="5061124">jsCtx</span>&nbsp;<span class="op" id="5061130">=</span>&nbsp;<span class="ident" id="5061132">b</span><span class="op" id="5061133">.</span><span class="ident" id="5061134">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061141">if</span>&nbsp;<span class="ident" id="5061144">c</span><span class="op" id="5061145">.</span><span class="ident" id="5061146">eq</span><span class="op" id="5061148">(</span><span class="ident" id="5061149">b</span><span class="op" id="5061150">)</span>&nbsp;<span class="op" id="5061152">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5061156">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5061196">c</span><span class="op" id="5061197">.</span><span class="ident" id="5061198">jsCtx</span>&nbsp;<span class="op" id="5061204">=</span>&nbsp;<span class="ident" id="5061206">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061221">return</span>&nbsp;<span class="ident" id="5061228">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5061231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5061235">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5061292">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5061312">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5061349">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5061413">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061443">if</span>&nbsp;<span class="ident" id="5061446">c</span><span class="op" id="5061447">,</span>&nbsp;<span class="ident" id="5061449">d</span>&nbsp;<span class="op" id="5061451">:=</span>&nbsp;<span class="ident" id="5061454">nudge</span><span class="op" id="5061459">(</span><span class="ident" id="5061460">a</span><span class="op" id="5061461">)</span><span class="op" id="5061462">,</span>&nbsp;<span class="ident" id="5061464">nudge</span><span class="op" id="5061469">(</span><span class="ident" id="5061470">b</span><span class="op" id="5061471">)</span><span class="op" id="5061472">;</span>&nbsp;<span class="op" id="5061474">!</span><span class="op" id="5061475">(</span><span class="ident" id="5061476">c</span><span class="op" id="5061477">.</span><span class="ident" id="5061478">eq</span><span class="op" id="5061480">(</span><span class="ident" id="5061481">a</span><span class="op" id="5061482">)</span>&nbsp;<span class="op" id="5061484">&amp;&amp;</span>&nbsp;<span class="ident" id="5061487">d</span><span class="op" id="5061488">.</span><span class="ident" id="5061489">eq</span><span class="op" id="5061491">(</span><span class="ident" id="5061492">b</span><span class="op" id="5061493">)</span><span class="op" id="5061494">)</span>&nbsp;<span class="op" id="5061496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061500">if</span>&nbsp;<span class="ident" id="5061503">e</span>&nbsp;<span class="op" id="5061505">:=</span>&nbsp;<span class="ident" id="5061508">join</span><span class="op" id="5061512">(</span><span class="ident" id="5061513">c</span><span class="op" id="5061514">,</span>&nbsp;<span class="ident" id="5061516">d</span><span class="op" id="5061517">,</span>&nbsp;<span class="ident" id="5061519">node</span><span class="op" id="5061523">,</span>&nbsp;<span class="ident" id="5061525">nodeName</span><span class="op" id="5061533">)</span><span class="op" id="5061534">;</span>&nbsp;<span class="ident" id="5061536">e</span><span class="op" id="5061537">.</span><span class="ident" id="5061538">state</span>&nbsp;<span class="op" id="5061544">!=</span>&nbsp;<span class="ident" id="5061547">stateError</span>&nbsp;<span class="op" id="5061558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061563">return</span>&nbsp;<span class="ident" id="5061570">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5061574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5061577">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061581">return</span>&nbsp;<span class="ident" id="5061588">context</span><span class="op" id="5061595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5061599">state</span><span class="op" id="5061604">:</span>&nbsp;<span class="ident" id="5061606">stateError</span><span class="op" id="5061616">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5061620">err</span><span class="op" id="5061623">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5061627">errorf</span><span class="op" id="5061633">(</span><span class="ident" id="5061634">ErrBranchEnd</span><span class="op" id="5061646">,</span>&nbsp;<span class="ident" id="5061648">node</span><span class="op" id="5061652">,</span>&nbsp;<span class="num" id="5061654">0</span><span class="op" id="5061655">,</span>&nbsp;<span class="string" id="5061657">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="5061708">,</span>&nbsp;<span class="ident" id="5061710">nodeName</span><span class="op" id="5061718">,</span>&nbsp;<span class="ident" id="5061720">a</span><span class="op" id="5061721">,</span>&nbsp;<span class="ident" id="5061723">b</span><span class="op" id="5061724">)</span><span class="op" id="5061725">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5061728">}</span><br>
<span class="lineno">410</span><span class="op" id="5061730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5061733">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5061807">func</span>&nbsp;<span class="op" id="5061812">(</span><span class="ident" id="5061813">e</span>&nbsp;<span class="op" id="5061815">*</span><span class="ident" id="5061816">escaper</span><span class="op" id="5061823">)</span>&nbsp;<span class="ident" id="5061825">escapeBranch</span><span class="op" id="5061837">(</span><span class="ident" id="5061838">c</span>&nbsp;<span class="ident" id="5061840">context</span><span class="op" id="5061847">,</span>&nbsp;<span class="ident" id="5061849">n</span>&nbsp;<span class="op" id="5061851">*</span><span class="ident" id="5061852">parse</span><span class="op" id="5061857">.</span><span class="ident" id="5061858">BranchNode</span><span class="op" id="5061868">,</span>&nbsp;<span class="ident" id="5061870">nodeName</span>&nbsp;<span class="builtintype" id="5061879">string</span><span class="op" id="5061885">)</span>&nbsp;<span class="ident" id="5061887">context</span>&nbsp;<span class="op" id="5061895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5061898">c0</span>&nbsp;<span class="op" id="5061901">:=</span>&nbsp;<span class="ident" id="5061904">e</span><span class="op" id="5061905">.</span><span class="ident" id="5061906">escapeList</span><span class="op" id="5061916">(</span><span class="ident" id="5061917">c</span><span class="op" id="5061918">,</span>&nbsp;<span class="ident" id="5061920">n</span><span class="op" id="5061921">.</span><span class="ident" id="5061922">List</span><span class="op" id="5061926">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5061929">if</span>&nbsp;<span class="ident" id="5061932">nodeName</span>&nbsp;<span class="op" id="5061941">==</span>&nbsp;<span class="string" id="5061944">&#34;range&#34;</span>&nbsp;<span class="op" id="5061952">&amp;&amp;</span>&nbsp;<span class="ident" id="5061955">c0</span><span class="op" id="5061957">.</span><span class="ident" id="5061958">state</span>&nbsp;<span class="op" id="5061964">!=</span>&nbsp;<span class="ident" id="5061967">stateError</span>&nbsp;<span class="op" id="5061978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5061982">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5062051">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5062120">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062152">c1</span><span class="op" id="5062154">,</span>&nbsp;<span class="ident" id="5062156">_</span>&nbsp;<span class="op" id="5062158">:=</span>&nbsp;<span class="ident" id="5062161">e</span><span class="op" id="5062162">.</span><span class="ident" id="5062163">escapeListConditionally</span><span class="op" id="5062186">(</span><span class="ident" id="5062187">c0</span><span class="op" id="5062189">,</span>&nbsp;<span class="ident" id="5062191">n</span><span class="op" id="5062192">.</span><span class="ident" id="5062193">List</span><span class="op" id="5062197">,</span>&nbsp;<span class="ident" id="5062199">nil</span><span class="op" id="5062202">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062206">c0</span>&nbsp;<span class="op" id="5062209">=</span>&nbsp;<span class="ident" id="5062211">join</span><span class="op" id="5062215">(</span><span class="ident" id="5062216">c0</span><span class="op" id="5062218">,</span>&nbsp;<span class="ident" id="5062220">c1</span><span class="op" id="5062222">,</span>&nbsp;<span class="ident" id="5062224">n</span><span class="op" id="5062225">,</span>&nbsp;<span class="ident" id="5062227">nodeName</span><span class="op" id="5062235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5062239">if</span>&nbsp;<span class="ident" id="5062242">c0</span><span class="op" id="5062244">.</span><span class="ident" id="5062245">state</span>&nbsp;<span class="op" id="5062251">==</span>&nbsp;<span class="ident" id="5062254">stateError</span>&nbsp;<span class="op" id="5062265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5062270">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5062327">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5062384">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062411">c0</span><span class="op" id="5062413">.</span><span class="ident" id="5062414">err</span><span class="op" id="5062417">.</span><span class="ident" id="5062418">Line</span>&nbsp;<span class="op" id="5062423">=</span>&nbsp;<span class="ident" id="5062425">n</span><span class="op" id="5062426">.</span><span class="ident" id="5062427">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062435">c0</span><span class="op" id="5062437">.</span><span class="ident" id="5062438">err</span><span class="op" id="5062441">.</span><span class="ident" id="5062442">Description</span>&nbsp;<span class="op" id="5062454">=</span>&nbsp;<span class="string" id="5062456">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="5062483">+</span>&nbsp;<span class="ident" id="5062485">c0</span><span class="op" id="5062487">.</span><span class="ident" id="5062488">err</span><span class="op" id="5062491">.</span><span class="ident" id="5062492">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5062507">return</span>&nbsp;<span class="ident" id="5062514">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5062519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5062522">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062525">c1</span>&nbsp;<span class="op" id="5062528">:=</span>&nbsp;<span class="ident" id="5062531">e</span><span class="op" id="5062532">.</span><span class="ident" id="5062533">escapeList</span><span class="op" id="5062543">(</span><span class="ident" id="5062544">c</span><span class="op" id="5062545">,</span>&nbsp;<span class="ident" id="5062547">n</span><span class="op" id="5062548">.</span><span class="ident" id="5062549">ElseList</span><span class="op" id="5062557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5062560">return</span>&nbsp;<span class="ident" id="5062567">join</span><span class="op" id="5062571">(</span><span class="ident" id="5062572">c0</span><span class="op" id="5062574">,</span>&nbsp;<span class="ident" id="5062576">c1</span><span class="op" id="5062578">,</span>&nbsp;<span class="ident" id="5062580">n</span><span class="op" id="5062581">,</span>&nbsp;<span class="ident" id="5062583">nodeName</span><span class="op" id="5062591">)</span><br>
<span class="lineno"></span><span class="op" id="5062593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5062596">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="5062640">func</span>&nbsp;<span class="op" id="5062645">(</span><span class="ident" id="5062646">e</span>&nbsp;<span class="op" id="5062648">*</span><span class="ident" id="5062649">escaper</span><span class="op" id="5062656">)</span>&nbsp;<span class="ident" id="5062658">escapeList</span><span class="op" id="5062668">(</span><span class="ident" id="5062669">c</span>&nbsp;<span class="ident" id="5062671">context</span><span class="op" id="5062678">,</span>&nbsp;<span class="ident" id="5062680">n</span>&nbsp;<span class="op" id="5062682">*</span><span class="ident" id="5062683">parse</span><span class="op" id="5062688">.</span><span class="ident" id="5062689">ListNode</span><span class="op" id="5062697">)</span>&nbsp;<span class="ident" id="5062699">context</span>&nbsp;<span class="op" id="5062707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5062710">if</span>&nbsp;<span class="ident" id="5062713">n</span>&nbsp;<span class="op" id="5062715">==</span>&nbsp;<span class="ident" id="5062718">nil</span>&nbsp;<span class="op" id="5062722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5062726">return</span>&nbsp;<span class="ident" id="5062733">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5062736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5062739">for</span>&nbsp;<span class="ident" id="5062743">_</span><span class="op" id="5062744">,</span>&nbsp;<span class="ident" id="5062746">m</span>&nbsp;<span class="op" id="5062748">:=</span>&nbsp;<span class="keyword" id="5062751">range</span>&nbsp;<span class="ident" id="5062757">n</span><span class="op" id="5062758">.</span><span class="ident" id="5062759">Nodes</span>&nbsp;<span class="op" id="5062765">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5062769">c</span>&nbsp;<span class="op" id="5062771">=</span>&nbsp;<span class="ident" id="5062773">e</span><span class="op" id="5062774">.</span><span class="ident" id="5062775">escape</span><span class="op" id="5062781">(</span><span class="ident" id="5062782">c</span><span class="op" id="5062783">,</span>&nbsp;<span class="ident" id="5062785">m</span><span class="op" id="5062786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5062789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5062792">return</span>&nbsp;<span class="ident" id="5062799">c</span><br>
<span class="lineno"></span><span class="op" id="5062801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="5062804">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5062880">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="5062952">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="5063032">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5063079">func</span>&nbsp;<span class="op" id="5063084">(</span><span class="ident" id="5063085">e</span>&nbsp;<span class="op" id="5063087">*</span><span class="ident" id="5063088">escaper</span><span class="op" id="5063095">)</span>&nbsp;<span class="ident" id="5063097">escapeListConditionally</span><span class="op" id="5063120">(</span><span class="ident" id="5063121">c</span>&nbsp;<span class="ident" id="5063123">context</span><span class="op" id="5063130">,</span>&nbsp;<span class="ident" id="5063132">n</span>&nbsp;<span class="op" id="5063134">*</span><span class="ident" id="5063135">parse</span><span class="op" id="5063140">.</span><span class="ident" id="5063141">ListNode</span><span class="op" id="5063149">,</span>&nbsp;<span class="ident" id="5063151">filter</span>&nbsp;<span class="keyword" id="5063158">func</span><span class="op" id="5063162">(</span><span class="op" id="5063163">*</span><span class="ident" id="5063164">escaper</span><span class="op" id="5063171">,</span>&nbsp;<span class="ident" id="5063173">context</span><span class="op" id="5063180">)</span>&nbsp;<span class="builtintype" id="5063182">bool</span><span class="op" id="5063186">)</span>&nbsp;<span class="op" id="5063188">(</span><span class="ident" id="5063189">context</span><span class="op" id="5063196">,</span>&nbsp;<span class="builtintype" id="5063198">bool</span><span class="op" id="5063202">)</span>&nbsp;<span class="op" id="5063204">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063207">e1</span>&nbsp;<span class="op" id="5063210">:=</span>&nbsp;<span class="ident" id="5063213">newEscaper</span><span class="op" id="5063223">(</span><span class="ident" id="5063224">e</span><span class="op" id="5063225">.</span><span class="ident" id="5063226">tmpl</span><span class="op" id="5063230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5063233">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063274">for</span>&nbsp;<span class="ident" id="5063278">k</span><span class="op" id="5063279">,</span>&nbsp;<span class="ident" id="5063281">v</span>&nbsp;<span class="op" id="5063283">:=</span>&nbsp;<span class="keyword" id="5063286">range</span>&nbsp;<span class="ident" id="5063292">e</span><span class="op" id="5063293">.</span><span class="ident" id="5063294">output</span>&nbsp;<span class="op" id="5063301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063305">e1</span><span class="op" id="5063307">.</span><span class="ident" id="5063308">output</span><span class="op" id="5063314">[</span><span class="ident" id="5063315">k</span><span class="op" id="5063316">]</span>&nbsp;<span class="op" id="5063318">=</span>&nbsp;<span class="ident" id="5063320">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5063323">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063326">c</span>&nbsp;<span class="op" id="5063328">=</span>&nbsp;<span class="ident" id="5063330">e1</span><span class="op" id="5063332">.</span><span class="ident" id="5063333">escapeList</span><span class="op" id="5063343">(</span><span class="ident" id="5063344">c</span><span class="op" id="5063345">,</span>&nbsp;<span class="ident" id="5063347">n</span><span class="op" id="5063348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063351">ok</span>&nbsp;<span class="op" id="5063354">:=</span>&nbsp;<span class="ident" id="5063357">filter</span>&nbsp;<span class="op" id="5063364">!=</span>&nbsp;<span class="ident" id="5063367">nil</span>&nbsp;<span class="op" id="5063371">&amp;&amp;</span>&nbsp;<span class="ident" id="5063374">filter</span><span class="op" id="5063380">(</span><span class="ident" id="5063381">e1</span><span class="op" id="5063383">,</span>&nbsp;<span class="ident" id="5063385">c</span><span class="op" id="5063386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063389">if</span>&nbsp;<span class="ident" id="5063392">ok</span>&nbsp;<span class="op" id="5063395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5063399">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063451">for</span>&nbsp;<span class="ident" id="5063455">k</span><span class="op" id="5063456">,</span>&nbsp;<span class="ident" id="5063458">v</span>&nbsp;<span class="op" id="5063460">:=</span>&nbsp;<span class="keyword" id="5063463">range</span>&nbsp;<span class="ident" id="5063469">e1</span><span class="op" id="5063471">.</span><span class="ident" id="5063472">output</span>&nbsp;<span class="op" id="5063479">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063484">e</span><span class="op" id="5063485">.</span><span class="ident" id="5063486">output</span><span class="op" id="5063492">[</span><span class="ident" id="5063493">k</span><span class="op" id="5063494">]</span>&nbsp;<span class="op" id="5063496">=</span>&nbsp;<span class="ident" id="5063498">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5063502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063506">for</span>&nbsp;<span class="ident" id="5063510">k</span><span class="op" id="5063511">,</span>&nbsp;<span class="ident" id="5063513">v</span>&nbsp;<span class="op" id="5063515">:=</span>&nbsp;<span class="keyword" id="5063518">range</span>&nbsp;<span class="ident" id="5063524">e1</span><span class="op" id="5063526">.</span><span class="ident" id="5063527">derived</span>&nbsp;<span class="op" id="5063535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063540">e</span><span class="op" id="5063541">.</span><span class="ident" id="5063542">derived</span><span class="op" id="5063549">[</span><span class="ident" id="5063550">k</span><span class="op" id="5063551">]</span>&nbsp;<span class="op" id="5063553">=</span>&nbsp;<span class="ident" id="5063555">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5063559">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063563">for</span>&nbsp;<span class="ident" id="5063567">k</span><span class="op" id="5063568">,</span>&nbsp;<span class="ident" id="5063570">v</span>&nbsp;<span class="op" id="5063572">:=</span>&nbsp;<span class="keyword" id="5063575">range</span>&nbsp;<span class="ident" id="5063581">e1</span><span class="op" id="5063583">.</span><span class="ident" id="5063584">called</span>&nbsp;<span class="op" id="5063591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063596">e</span><span class="op" id="5063597">.</span><span class="ident" id="5063598">called</span><span class="op" id="5063604">[</span><span class="ident" id="5063605">k</span><span class="op" id="5063606">]</span>&nbsp;<span class="op" id="5063608">=</span>&nbsp;<span class="ident" id="5063610">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5063614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063618">for</span>&nbsp;<span class="ident" id="5063622">k</span><span class="op" id="5063623">,</span>&nbsp;<span class="ident" id="5063625">v</span>&nbsp;<span class="op" id="5063627">:=</span>&nbsp;<span class="keyword" id="5063630">range</span>&nbsp;<span class="ident" id="5063636">e1</span><span class="op" id="5063638">.</span><span class="ident" id="5063639">actionNodeEdits</span>&nbsp;<span class="op" id="5063655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063660">e</span><span class="op" id="5063661">.</span><span class="ident" id="5063662">editActionNode</span><span class="op" id="5063676">(</span><span class="ident" id="5063677">k</span><span class="op" id="5063678">,</span>&nbsp;<span class="ident" id="5063680">v</span><span class="op" id="5063681">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5063685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063689">for</span>&nbsp;<span class="ident" id="5063693">k</span><span class="op" id="5063694">,</span>&nbsp;<span class="ident" id="5063696">v</span>&nbsp;<span class="op" id="5063698">:=</span>&nbsp;<span class="keyword" id="5063701">range</span>&nbsp;<span class="ident" id="5063707">e1</span><span class="op" id="5063709">.</span><span class="ident" id="5063710">templateNodeEdits</span>&nbsp;<span class="op" id="5063728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063733">e</span><span class="op" id="5063734">.</span><span class="ident" id="5063735">editTemplateNode</span><span class="op" id="5063751">(</span><span class="ident" id="5063752">k</span><span class="op" id="5063753">,</span>&nbsp;<span class="ident" id="5063755">v</span><span class="op" id="5063756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5063760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063764">for</span>&nbsp;<span class="ident" id="5063768">k</span><span class="op" id="5063769">,</span>&nbsp;<span class="ident" id="5063771">v</span>&nbsp;<span class="op" id="5063773">:=</span>&nbsp;<span class="keyword" id="5063776">range</span>&nbsp;<span class="ident" id="5063782">e1</span><span class="op" id="5063784">.</span><span class="ident" id="5063785">textNodeEdits</span>&nbsp;<span class="op" id="5063799">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063804">e</span><span class="op" id="5063805">.</span><span class="ident" id="5063806">editTextNode</span><span class="op" id="5063818">(</span><span class="ident" id="5063819">k</span><span class="op" id="5063820">,</span>&nbsp;<span class="ident" id="5063822">v</span><span class="op" id="5063823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5063827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5063830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5063833">return</span>&nbsp;<span class="ident" id="5063840">c</span><span class="op" id="5063841">,</span>&nbsp;<span class="ident" id="5063843">ok</span><br>
<span class="lineno"></span><span class="op" id="5063846">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5063849">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5063901">func</span>&nbsp;<span class="op" id="5063906">(</span><span class="ident" id="5063907">e</span>&nbsp;<span class="op" id="5063909">*</span><span class="ident" id="5063910">escaper</span><span class="op" id="5063917">)</span>&nbsp;<span class="ident" id="5063919">escapeTemplate</span><span class="op" id="5063933">(</span><span class="ident" id="5063934">c</span>&nbsp;<span class="ident" id="5063936">context</span><span class="op" id="5063943">,</span>&nbsp;<span class="ident" id="5063945">n</span>&nbsp;<span class="op" id="5063947">*</span><span class="ident" id="5063948">parse</span><span class="op" id="5063953">.</span><span class="ident" id="5063954">TemplateNode</span><span class="op" id="5063966">)</span>&nbsp;<span class="ident" id="5063968">context</span>&nbsp;<span class="op" id="5063976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5063979">c</span><span class="op" id="5063980">,</span>&nbsp;<span class="ident" id="5063982">name</span>&nbsp;<span class="op" id="5063987">:=</span>&nbsp;<span class="ident" id="5063990">e</span><span class="op" id="5063991">.</span><span class="ident" id="5063992">escapeTree</span><span class="op" id="5064002">(</span><span class="ident" id="5064003">c</span><span class="op" id="5064004">,</span>&nbsp;<span class="ident" id="5064006">n</span><span class="op" id="5064007">,</span>&nbsp;<span class="ident" id="5064009">n</span><span class="op" id="5064010">.</span><span class="ident" id="5064011">Name</span><span class="op" id="5064015">,</span>&nbsp;<span class="ident" id="5064017">n</span><span class="op" id="5064018">.</span><span class="ident" id="5064019">Line</span><span class="op" id="5064023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064026">if</span>&nbsp;<span class="ident" id="5064029">name</span>&nbsp;<span class="op" id="5064034">!=</span>&nbsp;<span class="ident" id="5064037">n</span><span class="op" id="5064038">.</span><span class="ident" id="5064039">Name</span>&nbsp;<span class="op" id="5064044">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064048">e</span><span class="op" id="5064049">.</span><span class="ident" id="5064050">editTemplateNode</span><span class="op" id="5064066">(</span><span class="ident" id="5064067">n</span><span class="op" id="5064068">,</span>&nbsp;<span class="ident" id="5064070">name</span><span class="op" id="5064074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5064077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064080">return</span>&nbsp;<span class="ident" id="5064087">c</span><br>
<span class="lineno"></span><span class="op" id="5064089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="5064092">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5064166">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="5064211">func</span>&nbsp;<span class="op" id="5064216">(</span><span class="ident" id="5064217">e</span>&nbsp;<span class="op" id="5064219">*</span><span class="ident" id="5064220">escaper</span><span class="op" id="5064227">)</span>&nbsp;<span class="ident" id="5064229">escapeTree</span><span class="op" id="5064239">(</span><span class="ident" id="5064240">c</span>&nbsp;<span class="ident" id="5064242">context</span><span class="op" id="5064249">,</span>&nbsp;<span class="ident" id="5064251">node</span>&nbsp;<span class="ident" id="5064256">parse</span><span class="op" id="5064261">.</span><span class="ident" id="5064262">Node</span><span class="op" id="5064266">,</span>&nbsp;<span class="ident" id="5064268">name</span>&nbsp;<span class="builtintype" id="5064273">string</span><span class="op" id="5064279">,</span>&nbsp;<span class="ident" id="5064281">line</span>&nbsp;<span class="builtintype" id="5064286">int</span><span class="op" id="5064289">)</span>&nbsp;<span class="op" id="5064291">(</span><span class="ident" id="5064292">context</span><span class="op" id="5064299">,</span>&nbsp;<span class="builtintype" id="5064301">string</span><span class="op" id="5064307">)</span>&nbsp;<span class="op" id="5064309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064312">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064386">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064402">dname</span>&nbsp;<span class="op" id="5064408">:=</span>&nbsp;<span class="ident" id="5064411">c</span><span class="op" id="5064412">.</span><span class="ident" id="5064413">mangle</span><span class="op" id="5064419">(</span><span class="ident" id="5064420">name</span><span class="op" id="5064424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064427">e</span><span class="op" id="5064428">.</span><span class="ident" id="5064429">called</span><span class="op" id="5064435">[</span><span class="ident" id="5064436">dname</span><span class="op" id="5064441">]</span>&nbsp;<span class="op" id="5064443">=</span>&nbsp;<span class="builtintype" id="5064445">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064451">if</span>&nbsp;<span class="ident" id="5064454">out</span><span class="op" id="5064457">,</span>&nbsp;<span class="ident" id="5064459">ok</span>&nbsp;<span class="op" id="5064462">:=</span>&nbsp;<span class="ident" id="5064465">e</span><span class="op" id="5064466">.</span><span class="ident" id="5064467">output</span><span class="op" id="5064473">[</span><span class="ident" id="5064474">dname</span><span class="op" id="5064479">]</span><span class="op" id="5064480">;</span>&nbsp;<span class="ident" id="5064482">ok</span>&nbsp;<span class="op" id="5064485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064489">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064511">return</span>&nbsp;<span class="ident" id="5064518">out</span><span class="op" id="5064521">,</span>&nbsp;<span class="ident" id="5064523">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5064530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064533">t</span>&nbsp;<span class="op" id="5064535">:=</span>&nbsp;<span class="ident" id="5064538">e</span><span class="op" id="5064539">.</span><span class="ident" id="5064540">template</span><span class="op" id="5064548">(</span><span class="ident" id="5064549">name</span><span class="op" id="5064553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064556">if</span>&nbsp;<span class="ident" id="5064559">t</span>&nbsp;<span class="op" id="5064561">==</span>&nbsp;<span class="ident" id="5064564">nil</span>&nbsp;<span class="op" id="5064568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064572">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064653">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064708">if</span>&nbsp;<span class="ident" id="5064711">e</span><span class="op" id="5064712">.</span><span class="ident" id="5064713">tmpl</span><span class="op" id="5064717">.</span><span class="ident" id="5064718">set</span><span class="op" id="5064721">[</span><span class="ident" id="5064722">name</span><span class="op" id="5064726">]</span>&nbsp;<span class="op" id="5064728">!=</span>&nbsp;<span class="ident" id="5064731">nil</span>&nbsp;<span class="op" id="5064735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064740">return</span>&nbsp;<span class="ident" id="5064747">context</span><span class="op" id="5064754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064760">state</span><span class="op" id="5064765">:</span>&nbsp;<span class="ident" id="5064767">stateError</span><span class="op" id="5064777">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064783">err</span><span class="op" id="5064786">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5064790">errorf</span><span class="op" id="5064796">(</span><span class="ident" id="5064797">ErrNoSuchTemplate</span><span class="op" id="5064814">,</span>&nbsp;<span class="ident" id="5064816">node</span><span class="op" id="5064820">,</span>&nbsp;<span class="ident" id="5064822">line</span><span class="op" id="5064826">,</span>&nbsp;<span class="string" id="5064828">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="5064867">,</span>&nbsp;<span class="ident" id="5064869">name</span><span class="op" id="5064873">)</span><span class="op" id="5064874">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5064879">}</span><span class="op" id="5064880">,</span>&nbsp;<span class="ident" id="5064882">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5064890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5064894">return</span>&nbsp;<span class="ident" id="5064901">context</span><span class="op" id="5064908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064913">state</span><span class="op" id="5064918">:</span>&nbsp;<span class="ident" id="5064920">stateError</span><span class="op" id="5064930">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064935">err</span><span class="op" id="5064938">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5064942">errorf</span><span class="op" id="5064948">(</span><span class="ident" id="5064949">ErrNoSuchTemplate</span><span class="op" id="5064966">,</span>&nbsp;<span class="ident" id="5064968">node</span><span class="op" id="5064972">,</span>&nbsp;<span class="ident" id="5064974">line</span><span class="op" id="5064978">,</span>&nbsp;<span class="string" id="5064980">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="5065001">,</span>&nbsp;<span class="ident" id="5065003">name</span><span class="op" id="5065007">)</span><span class="op" id="5065008">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065012">}</span><span class="op" id="5065013">,</span>&nbsp;<span class="ident" id="5065015">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065025">if</span>&nbsp;<span class="ident" id="5065028">dname</span>&nbsp;<span class="op" id="5065034">!=</span>&nbsp;<span class="ident" id="5065037">name</span>&nbsp;<span class="op" id="5065042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5065046">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5065117">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065181">dt</span>&nbsp;<span class="op" id="5065184">:=</span>&nbsp;<span class="ident" id="5065187">e</span><span class="op" id="5065188">.</span><span class="ident" id="5065189">template</span><span class="op" id="5065197">(</span><span class="ident" id="5065198">dname</span><span class="op" id="5065203">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065207">if</span>&nbsp;<span class="ident" id="5065210">dt</span>&nbsp;<span class="op" id="5065213">==</span>&nbsp;<span class="ident" id="5065216">nil</span>&nbsp;<span class="op" id="5065220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065225">dt</span>&nbsp;<span class="op" id="5065228">=</span>&nbsp;<span class="ident" id="5065230">template</span><span class="op" id="5065238">.</span><span class="ident" id="5065239">New</span><span class="op" id="5065242">(</span><span class="ident" id="5065243">dname</span><span class="op" id="5065248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065253">dt</span><span class="op" id="5065255">.</span><span class="ident" id="5065256">Tree</span>&nbsp;<span class="op" id="5065261">=</span>&nbsp;<span class="op" id="5065263">&amp;</span><span class="ident" id="5065264">parse</span><span class="op" id="5065269">.</span><span class="ident" id="5065270">Tree</span><span class="op" id="5065274">{</span><span class="ident" id="5065275">Name</span><span class="op" id="5065279">:</span>&nbsp;<span class="ident" id="5065281">dname</span><span class="op" id="5065286">,</span>&nbsp;<span class="ident" id="5065288">Root</span><span class="op" id="5065292">:</span>&nbsp;<span class="ident" id="5065294">t</span><span class="op" id="5065295">.</span><span class="ident" id="5065296">Root</span><span class="op" id="5065300">.</span><span class="ident" id="5065301">CopyList</span><span class="op" id="5065309">(</span><span class="op" id="5065310">)</span><span class="op" id="5065311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065316">e</span><span class="op" id="5065317">.</span><span class="ident" id="5065318">derived</span><span class="op" id="5065325">[</span><span class="ident" id="5065326">dname</span><span class="op" id="5065331">]</span>&nbsp;<span class="op" id="5065333">=</span>&nbsp;<span class="ident" id="5065335">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065340">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065344">t</span>&nbsp;<span class="op" id="5065346">=</span>&nbsp;<span class="ident" id="5065348">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065355">return</span>&nbsp;<span class="ident" id="5065362">e</span><span class="op" id="5065363">.</span><span class="ident" id="5065364">computeOutCtx</span><span class="op" id="5065377">(</span><span class="ident" id="5065378">c</span><span class="op" id="5065379">,</span>&nbsp;<span class="ident" id="5065381">t</span><span class="op" id="5065382">)</span><span class="op" id="5065383">,</span>&nbsp;<span class="ident" id="5065385">dname</span><br>
<span class="lineno"></span><span class="op" id="5065391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="5065394">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5065474">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="5065520">func</span>&nbsp;<span class="op" id="5065525">(</span><span class="ident" id="5065526">e</span>&nbsp;<span class="op" id="5065528">*</span><span class="ident" id="5065529">escaper</span><span class="op" id="5065536">)</span>&nbsp;<span class="ident" id="5065538">computeOutCtx</span><span class="op" id="5065551">(</span><span class="ident" id="5065552">c</span>&nbsp;<span class="ident" id="5065554">context</span><span class="op" id="5065561">,</span>&nbsp;<span class="ident" id="5065563">t</span>&nbsp;<span class="op" id="5065565">*</span><span class="ident" id="5065566">template</span><span class="op" id="5065574">.</span><span class="ident" id="5065575">Template</span><span class="op" id="5065583">)</span>&nbsp;<span class="ident" id="5065585">context</span>&nbsp;<span class="op" id="5065593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5065596">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065633">c1</span><span class="op" id="5065635">,</span>&nbsp;<span class="ident" id="5065637">ok</span>&nbsp;<span class="op" id="5065640">:=</span>&nbsp;<span class="ident" id="5065643">e</span><span class="op" id="5065644">.</span><span class="ident" id="5065645">escapeTemplateBody</span><span class="op" id="5065663">(</span><span class="ident" id="5065664">c</span><span class="op" id="5065665">,</span>&nbsp;<span class="ident" id="5065667">t</span><span class="op" id="5065668">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065671">if</span>&nbsp;<span class="op" id="5065674">!</span><span class="ident" id="5065675">ok</span>&nbsp;<span class="op" id="5065678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5065682">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065748">if</span>&nbsp;<span class="ident" id="5065751">c2</span><span class="op" id="5065753">,</span>&nbsp;<span class="ident" id="5065755">ok2</span>&nbsp;<span class="op" id="5065759">:=</span>&nbsp;<span class="ident" id="5065762">e</span><span class="op" id="5065763">.</span><span class="ident" id="5065764">escapeTemplateBody</span><span class="op" id="5065782">(</span><span class="ident" id="5065783">c1</span><span class="op" id="5065785">,</span>&nbsp;<span class="ident" id="5065787">t</span><span class="op" id="5065788">)</span><span class="op" id="5065789">;</span>&nbsp;<span class="ident" id="5065791">ok2</span>&nbsp;<span class="op" id="5065795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065800">c1</span><span class="op" id="5065802">,</span>&nbsp;<span class="ident" id="5065804">ok</span>&nbsp;<span class="op" id="5065807">=</span>&nbsp;<span class="ident" id="5065809">c2</span><span class="op" id="5065811">,</span>&nbsp;<span class="builtintype" id="5065813">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065820">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5065824">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065889">if</span>&nbsp;<span class="op" id="5065892">!</span><span class="ident" id="5065893">ok</span>&nbsp;<span class="op" id="5065896">&amp;&amp;</span>&nbsp;<span class="ident" id="5065899">c1</span><span class="op" id="5065901">.</span><span class="ident" id="5065902">state</span>&nbsp;<span class="op" id="5065908">!=</span>&nbsp;<span class="ident" id="5065911">stateError</span>&nbsp;<span class="op" id="5065922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065926">return</span>&nbsp;<span class="ident" id="5065933">context</span><span class="op" id="5065940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065945">state</span><span class="op" id="5065950">:</span>&nbsp;<span class="ident" id="5065952">stateError</span><span class="op" id="5065962">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065967">err</span><span class="op" id="5065970">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5065974">errorf</span><span class="op" id="5065980">(</span><span class="ident" id="5065981">ErrOutputContext</span><span class="op" id="5065997">,</span>&nbsp;<span class="ident" id="5065999">t</span><span class="op" id="5066000">.</span><span class="ident" id="5066001">Tree</span><span class="op" id="5066005">.</span><span class="ident" id="5066006">Root</span><span class="op" id="5066010">,</span>&nbsp;<span class="num" id="5066012">0</span><span class="op" id="5066013">,</span>&nbsp;<span class="string" id="5066015">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="5066062">,</span>&nbsp;<span class="ident" id="5066064">t</span><span class="op" id="5066065">.</span><span class="ident" id="5066066">Name</span><span class="op" id="5066070">(</span><span class="op" id="5066071">)</span><span class="op" id="5066072">)</span><span class="op" id="5066073">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5066077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5066080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066083">return</span>&nbsp;<span class="ident" id="5066090">c1</span><br>
<span class="lineno"></span><span class="op" id="5066093">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="5066096">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5066171">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5066248">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="5066275">func</span>&nbsp;<span class="op" id="5066280">(</span><span class="ident" id="5066281">e</span>&nbsp;<span class="op" id="5066283">*</span><span class="ident" id="5066284">escaper</span><span class="op" id="5066291">)</span>&nbsp;<span class="ident" id="5066293">escapeTemplateBody</span><span class="op" id="5066311">(</span><span class="ident" id="5066312">c</span>&nbsp;<span class="ident" id="5066314">context</span><span class="op" id="5066321">,</span>&nbsp;<span class="ident" id="5066323">t</span>&nbsp;<span class="op" id="5066325">*</span><span class="ident" id="5066326">template</span><span class="op" id="5066334">.</span><span class="ident" id="5066335">Template</span><span class="op" id="5066343">)</span>&nbsp;<span class="op" id="5066345">(</span><span class="ident" id="5066346">context</span><span class="op" id="5066353">,</span>&nbsp;<span class="builtintype" id="5066355">bool</span><span class="op" id="5066359">)</span>&nbsp;<span class="op" id="5066361">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066364">filter</span>&nbsp;<span class="op" id="5066371">:=</span>&nbsp;<span class="keyword" id="5066374">func</span><span class="op" id="5066378">(</span><span class="ident" id="5066379">e1</span>&nbsp;<span class="op" id="5066382">*</span><span class="ident" id="5066383">escaper</span><span class="op" id="5066390">,</span>&nbsp;<span class="ident" id="5066392">c1</span>&nbsp;<span class="ident" id="5066395">context</span><span class="op" id="5066402">)</span>&nbsp;<span class="builtintype" id="5066404">bool</span>&nbsp;<span class="op" id="5066409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066413">if</span>&nbsp;<span class="ident" id="5066416">c1</span><span class="op" id="5066418">.</span><span class="ident" id="5066419">state</span>&nbsp;<span class="op" id="5066425">==</span>&nbsp;<span class="ident" id="5066428">stateError</span>&nbsp;<span class="op" id="5066439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5066444">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066486">return</span>&nbsp;<span class="builtintype" id="5066493">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5066501">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066505">if</span>&nbsp;<span class="op" id="5066508">!</span><span class="ident" id="5066509">e1</span><span class="op" id="5066511">.</span><span class="ident" id="5066512">called</span><span class="op" id="5066518">[</span><span class="ident" id="5066519">t</span><span class="op" id="5066520">.</span><span class="ident" id="5066521">Name</span><span class="op" id="5066525">(</span><span class="op" id="5066526">)</span><span class="op" id="5066527">]</span>&nbsp;<span class="op" id="5066529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5066534">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5066586">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066617">return</span>&nbsp;<span class="builtintype" id="5066624">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5066631">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5066635">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066697">return</span>&nbsp;<span class="ident" id="5066704">c</span><span class="op" id="5066705">.</span><span class="ident" id="5066706">eq</span><span class="op" id="5066708">(</span><span class="ident" id="5066709">c1</span><span class="op" id="5066711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5066714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5066717">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5066790">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5066864">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5066934">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066962">e</span><span class="op" id="5066963">.</span><span class="ident" id="5066964">output</span><span class="op" id="5066970">[</span><span class="ident" id="5066971">t</span><span class="op" id="5066972">.</span><span class="ident" id="5066973">Name</span><span class="op" id="5066977">(</span><span class="op" id="5066978">)</span><span class="op" id="5066979">]</span>&nbsp;<span class="op" id="5066981">=</span>&nbsp;<span class="ident" id="5066983">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066986">return</span>&nbsp;<span class="ident" id="5066993">e</span><span class="op" id="5066994">.</span><span class="ident" id="5066995">escapeListConditionally</span><span class="op" id="5067018">(</span><span class="ident" id="5067019">c</span><span class="op" id="5067020">,</span>&nbsp;<span class="ident" id="5067022">t</span><span class="op" id="5067023">.</span><span class="ident" id="5067024">Tree</span><span class="op" id="5067028">.</span><span class="ident" id="5067029">Root</span><span class="op" id="5067033">,</span>&nbsp;<span class="ident" id="5067035">filter</span><span class="op" id="5067041">)</span><br>
<span class="lineno"></span><span class="op" id="5067043">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="5067046">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5067120">var</span>&nbsp;<span class="ident" id="5067124">delimEnds</span>&nbsp;<span class="op" id="5067134">=</span>&nbsp;<span class="op" id="5067136">[</span><span class="op" id="5067137">...</span><span class="op" id="5067140">]</span><span class="builtintype" id="5067141">string</span><span class="op" id="5067147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067150">delimDoubleQuote</span><span class="op" id="5067166">:</span>&nbsp;<span class="string" id="5067168">`&#34;`</span><span class="op" id="5067171">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067174">delimSingleQuote</span><span class="op" id="5067190">:</span>&nbsp;<span class="string" id="5067192">&#34;&#39;&#34;</span><span class="op" id="5067195">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067198">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067267">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067312">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067352">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067426">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067498">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067548">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067554">delimSpaceOrTagEnd</span><span class="op" id="5067572">:</span>&nbsp;<span class="string" id="5067574">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="5067586">,</span><br>
<span class="lineno"></span><span class="op" id="5067588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="5067591">var</span>&nbsp;<span class="ident" id="5067595">doctypeBytes</span>&nbsp;<span class="op" id="5067608">=</span>&nbsp;<span class="op" id="5067610">[</span><span class="op" id="5067611">]</span><span class="builtintype" id="5067612">byte</span><span class="op" id="5067616">(</span><span class="string" id="5067617">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="5067628">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5067631">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5067675">func</span>&nbsp;<span class="op" id="5067680">(</span><span class="ident" id="5067681">e</span>&nbsp;<span class="op" id="5067683">*</span><span class="ident" id="5067684">escaper</span><span class="op" id="5067691">)</span>&nbsp;<span class="ident" id="5067693">escapeText</span><span class="op" id="5067703">(</span><span class="ident" id="5067704">c</span>&nbsp;<span class="ident" id="5067706">context</span><span class="op" id="5067713">,</span>&nbsp;<span class="ident" id="5067715">n</span>&nbsp;<span class="op" id="5067717">*</span><span class="ident" id="5067718">parse</span><span class="op" id="5067723">.</span><span class="ident" id="5067724">TextNode</span><span class="op" id="5067732">)</span>&nbsp;<span class="ident" id="5067734">context</span>&nbsp;<span class="op" id="5067742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067745">s</span><span class="op" id="5067746">,</span>&nbsp;<span class="ident" id="5067748">written</span><span class="op" id="5067755">,</span>&nbsp;<span class="ident" id="5067757">i</span><span class="op" id="5067758">,</span>&nbsp;<span class="ident" id="5067760">b</span>&nbsp;<span class="op" id="5067762">:=</span>&nbsp;<span class="ident" id="5067765">n</span><span class="op" id="5067766">.</span><span class="ident" id="5067767">Text</span><span class="op" id="5067771">,</span>&nbsp;<span class="num" id="5067773">0</span><span class="op" id="5067774">,</span>&nbsp;<span class="num" id="5067776">0</span><span class="op" id="5067777">,</span>&nbsp;<span class="builtinfunc" id="5067779">new</span><span class="op" id="5067782">(</span><span class="ident" id="5067783">bytes</span><span class="op" id="5067788">.</span><span class="ident" id="5067789">Buffer</span><span class="op" id="5067795">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067798">for</span>&nbsp;<span class="ident" id="5067802">i</span>&nbsp;<span class="op" id="5067804">!=</span>&nbsp;<span class="builtinfunc" id="5067807">len</span><span class="op" id="5067810">(</span><span class="ident" id="5067811">s</span><span class="op" id="5067812">)</span>&nbsp;<span class="op" id="5067814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067818">c1</span><span class="op" id="5067820">,</span>&nbsp;<span class="ident" id="5067822">nread</span>&nbsp;<span class="op" id="5067828">:=</span>&nbsp;<span class="ident" id="5067831">contextAfterText</span><span class="op" id="5067847">(</span><span class="ident" id="5067848">c</span><span class="op" id="5067849">,</span>&nbsp;<span class="ident" id="5067851">s</span><span class="op" id="5067852">[</span><span class="ident" id="5067853">i</span><span class="op" id="5067854">:</span><span class="op" id="5067855">]</span><span class="op" id="5067856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067860">i1</span>&nbsp;<span class="op" id="5067863">:=</span>&nbsp;<span class="ident" id="5067866">i</span>&nbsp;<span class="op" id="5067868">+</span>&nbsp;<span class="ident" id="5067870">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067878">if</span>&nbsp;<span class="ident" id="5067881">c</span><span class="op" id="5067882">.</span><span class="ident" id="5067883">state</span>&nbsp;<span class="op" id="5067889">==</span>&nbsp;<span class="ident" id="5067892">stateText</span>&nbsp;<span class="op" id="5067902">||</span>&nbsp;<span class="ident" id="5067905">c</span><span class="op" id="5067906">.</span><span class="ident" id="5067907">state</span>&nbsp;<span class="op" id="5067913">==</span>&nbsp;<span class="ident" id="5067916">stateRCDATA</span>&nbsp;<span class="op" id="5067928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067933">end</span>&nbsp;<span class="op" id="5067937">:=</span>&nbsp;<span class="ident" id="5067940">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067946">if</span>&nbsp;<span class="ident" id="5067949">c1</span><span class="op" id="5067951">.</span><span class="ident" id="5067952">state</span>&nbsp;<span class="op" id="5067958">!=</span>&nbsp;<span class="ident" id="5067961">c</span><span class="op" id="5067962">.</span><span class="ident" id="5067963">state</span>&nbsp;<span class="op" id="5067969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067975">for</span>&nbsp;<span class="ident" id="5067979">j</span>&nbsp;<span class="op" id="5067981">:=</span>&nbsp;<span class="ident" id="5067984">end</span>&nbsp;<span class="op" id="5067988">-</span>&nbsp;<span class="num" id="5067990">1</span><span class="op" id="5067991">;</span>&nbsp;<span class="ident" id="5067993">j</span>&nbsp;<span class="op" id="5067995">&gt;=</span>&nbsp;<span class="ident" id="5067998">i</span><span class="op" id="5067999">;</span>&nbsp;<span class="ident" id="5068001">j</span><span class="op" id="5068002">--</span>&nbsp;<span class="op" id="5068005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068012">if</span>&nbsp;<span class="ident" id="5068015">s</span><span class="op" id="5068016">[</span><span class="ident" id="5068017">j</span><span class="op" id="5068018">]</span>&nbsp;<span class="op" id="5068020">==</span>&nbsp;<span class="string" id="5068023">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5068027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068035">end</span>&nbsp;<span class="op" id="5068039">=</span>&nbsp;<span class="ident" id="5068041">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068049">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068076">for</span>&nbsp;<span class="ident" id="5068080">j</span>&nbsp;<span class="op" id="5068082">:=</span>&nbsp;<span class="ident" id="5068085">i</span><span class="op" id="5068086">;</span>&nbsp;<span class="ident" id="5068088">j</span>&nbsp;<span class="op" id="5068090">&lt;</span>&nbsp;<span class="ident" id="5068092">end</span><span class="op" id="5068095">;</span>&nbsp;<span class="ident" id="5068097">j</span><span class="op" id="5068098">++</span>&nbsp;<span class="op" id="5068101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068107">if</span>&nbsp;<span class="ident" id="5068110">s</span><span class="op" id="5068111">[</span><span class="ident" id="5068112">j</span><span class="op" id="5068113">]</span>&nbsp;<span class="op" id="5068115">==</span>&nbsp;<span class="string" id="5068118">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5068122">&amp;&amp;</span>&nbsp;<span class="op" id="5068125">!</span><span class="ident" id="5068126">bytes</span><span class="op" id="5068131">.</span><span class="ident" id="5068132">HasPrefix</span><span class="op" id="5068141">(</span><span class="ident" id="5068142">bytes</span><span class="op" id="5068147">.</span><span class="ident" id="5068148">ToUpper</span><span class="op" id="5068155">(</span><span class="ident" id="5068156">s</span><span class="op" id="5068157">[</span><span class="ident" id="5068158">j</span><span class="op" id="5068159">:</span><span class="op" id="5068160">]</span><span class="op" id="5068161">)</span><span class="op" id="5068162">,</span>&nbsp;<span class="ident" id="5068164">doctypeBytes</span><span class="op" id="5068176">)</span>&nbsp;<span class="op" id="5068178">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068185">b</span><span class="op" id="5068186">.</span><span class="ident" id="5068187">Write</span><span class="op" id="5068192">(</span><span class="ident" id="5068193">s</span><span class="op" id="5068194">[</span><span class="ident" id="5068195">written</span><span class="op" id="5068202">:</span><span class="ident" id="5068203">j</span><span class="op" id="5068204">]</span><span class="op" id="5068205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068212">b</span><span class="op" id="5068213">.</span><span class="ident" id="5068214">WriteString</span><span class="op" id="5068225">(</span><span class="string" id="5068226">&#34;&amp;lt;&#34;</span><span class="op" id="5068232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068239">written</span>&nbsp;<span class="op" id="5068247">=</span>&nbsp;<span class="ident" id="5068249">j</span>&nbsp;<span class="op" id="5068251">+</span>&nbsp;<span class="num" id="5068253">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068264">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068268">}</span>&nbsp;<span class="keyword" id="5068270">else</span>&nbsp;<span class="keyword" id="5068275">if</span>&nbsp;<span class="ident" id="5068278">isComment</span><span class="op" id="5068287">(</span><span class="ident" id="5068288">c</span><span class="op" id="5068289">.</span><span class="ident" id="5068290">state</span><span class="op" id="5068295">)</span>&nbsp;<span class="op" id="5068297">&amp;&amp;</span>&nbsp;<span class="ident" id="5068300">c</span><span class="op" id="5068301">.</span><span class="ident" id="5068302">delim</span>&nbsp;<span class="op" id="5068308">==</span>&nbsp;<span class="ident" id="5068311">delimNone</span>&nbsp;<span class="op" id="5068321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068326">switch</span>&nbsp;<span class="ident" id="5068333">c</span><span class="op" id="5068334">.</span><span class="ident" id="5068335">state</span>&nbsp;<span class="op" id="5068341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068346">case</span>&nbsp;<span class="ident" id="5068351">stateJSBlockCmt</span><span class="op" id="5068366">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068372">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068408">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068457">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068509">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068559">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068607">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068656">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068687">if</span>&nbsp;<span class="ident" id="5068690">bytes</span><span class="op" id="5068695">.</span><span class="ident" id="5068696">IndexAny</span><span class="op" id="5068704">(</span><span class="ident" id="5068705">s</span><span class="op" id="5068706">[</span><span class="ident" id="5068707">written</span><span class="op" id="5068714">:</span><span class="ident" id="5068715">i1</span><span class="op" id="5068717">]</span><span class="op" id="5068718">,</span>&nbsp;<span class="string" id="5068720">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="5068738">)</span>&nbsp;<span class="op" id="5068740">!=</span>&nbsp;<span class="op" id="5068743">-</span><span class="num" id="5068744">1</span>&nbsp;<span class="op" id="5068746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068753">b</span><span class="op" id="5068754">.</span><span class="ident" id="5068755">WriteByte</span><span class="op" id="5068764">(</span><span class="string" id="5068765">&#39;\n&#39;</span><span class="op" id="5068769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068775">}</span>&nbsp;<span class="keyword" id="5068777">else</span>&nbsp;<span class="op" id="5068782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068789">b</span><span class="op" id="5068790">.</span><span class="ident" id="5068791">WriteByte</span><span class="op" id="5068800">(</span><span class="string" id="5068801">&#39;&nbsp;&#39;</span><span class="op" id="5068804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068810">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068815">case</span>&nbsp;<span class="ident" id="5068820">stateCSSBlockCmt</span><span class="op" id="5068836">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068842">b</span><span class="op" id="5068843">.</span><span class="ident" id="5068844">WriteByte</span><span class="op" id="5068853">(</span><span class="string" id="5068854">&#39;&nbsp;&#39;</span><span class="op" id="5068857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068867">written</span>&nbsp;<span class="op" id="5068875">=</span>&nbsp;<span class="ident" id="5068877">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068882">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068886">if</span>&nbsp;<span class="ident" id="5068889">c</span><span class="op" id="5068890">.</span><span class="ident" id="5068891">state</span>&nbsp;<span class="op" id="5068897">!=</span>&nbsp;<span class="ident" id="5068900">c1</span><span class="op" id="5068902">.</span><span class="ident" id="5068903">state</span>&nbsp;<span class="op" id="5068909">&amp;&amp;</span>&nbsp;<span class="ident" id="5068912">isComment</span><span class="op" id="5068921">(</span><span class="ident" id="5068922">c1</span><span class="op" id="5068924">.</span><span class="ident" id="5068925">state</span><span class="op" id="5068930">)</span>&nbsp;<span class="op" id="5068932">&amp;&amp;</span>&nbsp;<span class="ident" id="5068935">c1</span><span class="op" id="5068937">.</span><span class="ident" id="5068938">delim</span>&nbsp;<span class="op" id="5068944">==</span>&nbsp;<span class="ident" id="5068947">delimNone</span>&nbsp;<span class="op" id="5068957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068962">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069028">cs</span>&nbsp;<span class="op" id="5069031">:=</span>&nbsp;<span class="ident" id="5069034">i1</span>&nbsp;<span class="op" id="5069037">-</span>&nbsp;<span class="num" id="5069039">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069044">if</span>&nbsp;<span class="ident" id="5069047">c1</span><span class="op" id="5069049">.</span><span class="ident" id="5069050">state</span>&nbsp;<span class="op" id="5069056">==</span>&nbsp;<span class="ident" id="5069059">stateHTMLCmt</span>&nbsp;<span class="op" id="5069072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5069078">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069116">cs</span>&nbsp;<span class="op" id="5069119">-=</span>&nbsp;<span class="num" id="5069122">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069132">b</span><span class="op" id="5069133">.</span><span class="ident" id="5069134">Write</span><span class="op" id="5069139">(</span><span class="ident" id="5069140">s</span><span class="op" id="5069141">[</span><span class="ident" id="5069142">written</span><span class="op" id="5069149">:</span><span class="ident" id="5069150">cs</span><span class="op" id="5069152">]</span><span class="op" id="5069153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069158">written</span>&nbsp;<span class="op" id="5069166">=</span>&nbsp;<span class="ident" id="5069168">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069173">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069177">if</span>&nbsp;<span class="ident" id="5069180">i</span>&nbsp;<span class="op" id="5069182">==</span>&nbsp;<span class="ident" id="5069185">i1</span>&nbsp;<span class="op" id="5069188">&amp;&amp;</span>&nbsp;<span class="ident" id="5069191">c</span><span class="op" id="5069192">.</span><span class="ident" id="5069193">state</span>&nbsp;<span class="op" id="5069199">==</span>&nbsp;<span class="ident" id="5069202">c1</span><span class="op" id="5069204">.</span><span class="ident" id="5069205">state</span>&nbsp;<span class="op" id="5069211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5069216">panic</span><span class="op" id="5069221">(</span><span class="ident" id="5069222">fmt</span><span class="op" id="5069225">.</span><span class="ident" id="5069226">Sprintf</span><span class="op" id="5069233">(</span><span class="string" id="5069234">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="5069273">,</span>&nbsp;<span class="ident" id="5069275">c</span><span class="op" id="5069276">,</span>&nbsp;<span class="ident" id="5069278">c1</span><span class="op" id="5069280">,</span>&nbsp;<span class="ident" id="5069282">s</span><span class="op" id="5069283">[</span><span class="op" id="5069284">:</span><span class="ident" id="5069285">i</span><span class="op" id="5069286">]</span><span class="op" id="5069287">,</span>&nbsp;<span class="ident" id="5069289">s</span><span class="op" id="5069290">[</span><span class="ident" id="5069291">i</span><span class="op" id="5069292">:</span><span class="op" id="5069293">]</span><span class="op" id="5069294">)</span><span class="op" id="5069295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069303">c</span><span class="op" id="5069304">,</span>&nbsp;<span class="ident" id="5069306">i</span>&nbsp;<span class="op" id="5069308">=</span>&nbsp;<span class="ident" id="5069310">c1</span><span class="op" id="5069312">,</span>&nbsp;<span class="ident" id="5069314">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069318">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069322">if</span>&nbsp;<span class="ident" id="5069325">written</span>&nbsp;<span class="op" id="5069333">!=</span>&nbsp;<span class="num" id="5069336">0</span>&nbsp;<span class="op" id="5069338">&amp;&amp;</span>&nbsp;<span class="ident" id="5069341">c</span><span class="op" id="5069342">.</span><span class="ident" id="5069343">state</span>&nbsp;<span class="op" id="5069349">!=</span>&nbsp;<span class="ident" id="5069352">stateError</span>&nbsp;<span class="op" id="5069363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069367">if</span>&nbsp;<span class="op" id="5069370">!</span><span class="ident" id="5069371">isComment</span><span class="op" id="5069380">(</span><span class="ident" id="5069381">c</span><span class="op" id="5069382">.</span><span class="ident" id="5069383">state</span><span class="op" id="5069388">)</span>&nbsp;<span class="op" id="5069390">||</span>&nbsp;<span class="ident" id="5069393">c</span><span class="op" id="5069394">.</span><span class="ident" id="5069395">delim</span>&nbsp;<span class="op" id="5069401">!=</span>&nbsp;<span class="ident" id="5069404">delimNone</span>&nbsp;<span class="op" id="5069414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069419">b</span><span class="op" id="5069420">.</span><span class="ident" id="5069421">Write</span><span class="op" id="5069426">(</span><span class="ident" id="5069427">n</span><span class="op" id="5069428">.</span><span class="ident" id="5069429">Text</span><span class="op" id="5069433">[</span><span class="ident" id="5069434">written</span><span class="op" id="5069441">:</span><span class="op" id="5069442">]</span><span class="op" id="5069443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069447">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069451">e</span><span class="op" id="5069452">.</span><span class="ident" id="5069453">editTextNode</span><span class="op" id="5069465">(</span><span class="ident" id="5069466">n</span><span class="op" id="5069467">,</span>&nbsp;<span class="ident" id="5069469">b</span><span class="op" id="5069470">.</span><span class="ident" id="5069471">Bytes</span><span class="op" id="5069476">(</span><span class="op" id="5069477">)</span><span class="op" id="5069478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069484">return</span>&nbsp;<span class="ident" id="5069491">c</span><br>
<span class="lineno"></span><span class="op" id="5069493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="5069496">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5069576">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="5069654">func</span>&nbsp;<span class="ident" id="5069659">contextAfterText</span><span class="op" id="5069675">(</span><span class="ident" id="5069676">c</span>&nbsp;<span class="ident" id="5069678">context</span><span class="op" id="5069685">,</span>&nbsp;<span class="ident" id="5069687">s</span>&nbsp;<span class="op" id="5069689">[</span><span class="op" id="5069690">]</span><span class="builtintype" id="5069691">byte</span><span class="op" id="5069695">)</span>&nbsp;<span class="op" id="5069697">(</span><span class="ident" id="5069698">context</span><span class="op" id="5069705">,</span>&nbsp;<span class="builtintype" id="5069707">int</span><span class="op" id="5069710">)</span>&nbsp;<span class="op" id="5069712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069715">if</span>&nbsp;<span class="ident" id="5069718">c</span><span class="op" id="5069719">.</span><span class="ident" id="5069720">delim</span>&nbsp;<span class="op" id="5069726">==</span>&nbsp;<span class="ident" id="5069729">delimNone</span>&nbsp;<span class="op" id="5069739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069743">c1</span><span class="op" id="5069745">,</span>&nbsp;<span class="ident" id="5069747">i</span>&nbsp;<span class="op" id="5069749">:=</span>&nbsp;<span class="ident" id="5069752">tSpecialTagEnd</span><span class="op" id="5069766">(</span><span class="ident" id="5069767">c</span><span class="op" id="5069768">,</span>&nbsp;<span class="ident" id="5069770">s</span><span class="op" id="5069771">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069775">if</span>&nbsp;<span class="ident" id="5069778">i</span>&nbsp;<span class="op" id="5069780">==</span>&nbsp;<span class="num" id="5069783">0</span>&nbsp;<span class="op" id="5069785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5069790">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5069846">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069896">return</span>&nbsp;<span class="ident" id="5069903">c1</span><span class="op" id="5069905">,</span>&nbsp;<span class="num" id="5069907">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069911">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5069915">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069960">return</span>&nbsp;<span class="ident" id="5069967">transitionFunc</span><span class="op" id="5069981">[</span><span class="ident" id="5069982">c</span><span class="op" id="5069983">.</span><span class="ident" id="5069984">state</span><span class="op" id="5069989">]</span><span class="op" id="5069990">(</span><span class="ident" id="5069991">c</span><span class="op" id="5069992">,</span>&nbsp;<span class="ident" id="5069994">s</span><span class="op" id="5069995">[</span><span class="op" id="5069996">:</span><span class="ident" id="5069997">i</span><span class="op" id="5069998">]</span><span class="op" id="5069999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070006">i</span>&nbsp;<span class="op" id="5070008">:=</span>&nbsp;<span class="ident" id="5070011">bytes</span><span class="op" id="5070016">.</span><span class="ident" id="5070017">IndexAny</span><span class="op" id="5070025">(</span><span class="ident" id="5070026">s</span><span class="op" id="5070027">,</span>&nbsp;<span class="ident" id="5070029">delimEnds</span><span class="op" id="5070038">[</span><span class="ident" id="5070039">c</span><span class="op" id="5070040">.</span><span class="ident" id="5070041">delim</span><span class="op" id="5070046">]</span><span class="op" id="5070047">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070050">if</span>&nbsp;<span class="ident" id="5070053">i</span>&nbsp;<span class="op" id="5070055">==</span>&nbsp;<span class="op" id="5070058">-</span><span class="num" id="5070059">1</span>&nbsp;<span class="op" id="5070061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070065">i</span>&nbsp;<span class="op" id="5070067">=</span>&nbsp;<span class="builtinfunc" id="5070069">len</span><span class="op" id="5070072">(</span><span class="ident" id="5070073">s</span><span class="op" id="5070074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070080">if</span>&nbsp;<span class="ident" id="5070083">c</span><span class="op" id="5070084">.</span><span class="ident" id="5070085">delim</span>&nbsp;<span class="op" id="5070091">==</span>&nbsp;<span class="ident" id="5070094">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="5070113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070117">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070194">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070242">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070300">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070366">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070416">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070469">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070514">if</span>&nbsp;<span class="ident" id="5070517">j</span>&nbsp;<span class="op" id="5070519">:=</span>&nbsp;<span class="ident" id="5070522">bytes</span><span class="op" id="5070527">.</span><span class="ident" id="5070528">IndexAny</span><span class="op" id="5070536">(</span><span class="ident" id="5070537">s</span><span class="op" id="5070538">[</span><span class="op" id="5070539">:</span><span class="ident" id="5070540">i</span><span class="op" id="5070541">]</span><span class="op" id="5070542">,</span>&nbsp;<span class="string" id="5070544">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="5070552">)</span><span class="op" id="5070553">;</span>&nbsp;<span class="ident" id="5070555">j</span>&nbsp;<span class="op" id="5070557">&gt;=</span>&nbsp;<span class="num" id="5070560">0</span>&nbsp;<span class="op" id="5070562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070567">return</span>&nbsp;<span class="ident" id="5070574">context</span><span class="op" id="5070581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070587">state</span><span class="op" id="5070592">:</span>&nbsp;<span class="ident" id="5070594">stateError</span><span class="op" id="5070604">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070610">err</span><span class="op" id="5070613">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5070617">errorf</span><span class="op" id="5070623">(</span><span class="ident" id="5070624">ErrBadHTML</span><span class="op" id="5070634">,</span>&nbsp;<span class="ident" id="5070636">nil</span><span class="op" id="5070639">,</span>&nbsp;<span class="num" id="5070641">0</span><span class="op" id="5070642">,</span>&nbsp;<span class="string" id="5070644">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="5070669">,</span>&nbsp;<span class="ident" id="5070671">s</span><span class="op" id="5070672">[</span><span class="ident" id="5070673">j</span><span class="op" id="5070674">:</span><span class="ident" id="5070675">j</span><span class="op" id="5070676">+</span><span class="num" id="5070677">1</span><span class="op" id="5070678">]</span><span class="op" id="5070679">,</span>&nbsp;<span class="ident" id="5070681">s</span><span class="op" id="5070682">[</span><span class="op" id="5070683">:</span><span class="ident" id="5070684">i</span><span class="op" id="5070685">]</span><span class="op" id="5070686">)</span><span class="op" id="5070687">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070692">}</span><span class="op" id="5070693">,</span>&nbsp;<span class="builtinfunc" id="5070695">len</span><span class="op" id="5070698">(</span><span class="ident" id="5070699">s</span><span class="op" id="5070700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070710">if</span>&nbsp;<span class="ident" id="5070713">i</span>&nbsp;<span class="op" id="5070715">==</span>&nbsp;<span class="builtinfunc" id="5070718">len</span><span class="op" id="5070721">(</span><span class="ident" id="5070722">s</span><span class="op" id="5070723">)</span>&nbsp;<span class="op" id="5070725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070729">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070763">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070821">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070872">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070927">for</span>&nbsp;<span class="ident" id="5070931">u</span>&nbsp;<span class="op" id="5070933">:=</span>&nbsp;<span class="op" id="5070936">[</span><span class="op" id="5070937">]</span><span class="builtintype" id="5070938">byte</span><span class="op" id="5070942">(</span><span class="ident" id="5070943">html</span><span class="op" id="5070947">.</span><span class="ident" id="5070948">UnescapeString</span><span class="op" id="5070962">(</span><span class="builtintype" id="5070963">string</span><span class="op" id="5070969">(</span><span class="ident" id="5070970">s</span><span class="op" id="5070971">)</span><span class="op" id="5070972">)</span><span class="op" id="5070973">)</span><span class="op" id="5070974">;</span>&nbsp;<span class="builtinfunc" id="5070976">len</span><span class="op" id="5070979">(</span><span class="ident" id="5070980">u</span><span class="op" id="5070981">)</span>&nbsp;<span class="op" id="5070983">!=</span>&nbsp;<span class="num" id="5070986">0</span><span class="op" id="5070987">;</span>&nbsp;<span class="op" id="5070989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070994">c1</span><span class="op" id="5070996">,</span>&nbsp;<span class="ident" id="5070998">i1</span>&nbsp;<span class="op" id="5071001">:=</span>&nbsp;<span class="ident" id="5071004">transitionFunc</span><span class="op" id="5071018">[</span><span class="ident" id="5071019">c</span><span class="op" id="5071020">.</span><span class="ident" id="5071021">state</span><span class="op" id="5071026">]</span><span class="op" id="5071027">(</span><span class="ident" id="5071028">c</span><span class="op" id="5071029">,</span>&nbsp;<span class="ident" id="5071031">u</span><span class="op" id="5071032">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071037">c</span><span class="op" id="5071038">,</span>&nbsp;<span class="ident" id="5071040">u</span>&nbsp;<span class="op" id="5071042">=</span>&nbsp;<span class="ident" id="5071044">c1</span><span class="op" id="5071046">,</span>&nbsp;<span class="ident" id="5071048">u</span><span class="op" id="5071049">[</span><span class="ident" id="5071050">i1</span><span class="op" id="5071052">:</span><span class="op" id="5071053">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071061">return</span>&nbsp;<span class="ident" id="5071068">c</span><span class="op" id="5071069">,</span>&nbsp;<span class="builtinfunc" id="5071071">len</span><span class="op" id="5071074">(</span><span class="ident" id="5071075">s</span><span class="op" id="5071076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071082">if</span>&nbsp;<span class="ident" id="5071085">c</span><span class="op" id="5071086">.</span><span class="ident" id="5071087">delim</span>&nbsp;<span class="op" id="5071093">!=</span>&nbsp;<span class="ident" id="5071096">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="5071115">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071119">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071143">i</span><span class="op" id="5071144">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071151">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071213">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071247">return</span>&nbsp;<span class="ident" id="5071254">context</span><span class="op" id="5071261">{</span><span class="ident" id="5071262">state</span><span class="op" id="5071267">:</span>&nbsp;<span class="ident" id="5071269">stateTag</span><span class="op" id="5071277">,</span>&nbsp;<span class="ident" id="5071279">element</span><span class="op" id="5071286">:</span>&nbsp;<span class="ident" id="5071288">c</span><span class="op" id="5071289">.</span><span class="ident" id="5071290">element</span><span class="op" id="5071297">}</span><span class="op" id="5071298">,</span>&nbsp;<span class="ident" id="5071300">i</span><br>
<span class="lineno"></span><span class="op" id="5071302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5071305">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="5071380">func</span>&nbsp;<span class="op" id="5071385">(</span><span class="ident" id="5071386">e</span>&nbsp;<span class="op" id="5071388">*</span><span class="ident" id="5071389">escaper</span><span class="op" id="5071396">)</span>&nbsp;<span class="ident" id="5071398">editActionNode</span><span class="op" id="5071412">(</span><span class="ident" id="5071413">n</span>&nbsp;<span class="op" id="5071415">*</span><span class="ident" id="5071416">parse</span><span class="op" id="5071421">.</span><span class="ident" id="5071422">ActionNode</span><span class="op" id="5071432">,</span>&nbsp;<span class="ident" id="5071434">cmds</span>&nbsp;<span class="op" id="5071439">[</span><span class="op" id="5071440">]</span><span class="builtintype" id="5071441">string</span><span class="op" id="5071447">)</span>&nbsp;<span class="op" id="5071449">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071452">if</span>&nbsp;<span class="ident" id="5071455">_</span><span class="op" id="5071456">,</span>&nbsp;<span class="ident" id="5071458">ok</span>&nbsp;<span class="op" id="5071461">:=</span>&nbsp;<span class="ident" id="5071464">e</span><span class="op" id="5071465">.</span><span class="ident" id="5071466">actionNodeEdits</span><span class="op" id="5071481">[</span><span class="ident" id="5071482">n</span><span class="op" id="5071483">]</span><span class="op" id="5071484">;</span>&nbsp;<span class="ident" id="5071486">ok</span>&nbsp;<span class="op" id="5071489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5071493">panic</span><span class="op" id="5071498">(</span><span class="ident" id="5071499">fmt</span><span class="op" id="5071502">.</span><span class="ident" id="5071503">Sprintf</span><span class="op" id="5071510">(</span><span class="string" id="5071511">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5071545">,</span>&nbsp;<span class="ident" id="5071547">n</span><span class="op" id="5071548">)</span><span class="op" id="5071549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071555">e</span><span class="op" id="5071556">.</span><span class="ident" id="5071557">actionNodeEdits</span><span class="op" id="5071572">[</span><span class="ident" id="5071573">n</span><span class="op" id="5071574">]</span>&nbsp;<span class="op" id="5071576">=</span>&nbsp;<span class="ident" id="5071578">cmds</span><br>
<span class="lineno"></span><span class="op" id="5071583">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="5071586">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="5071666">func</span>&nbsp;<span class="op" id="5071671">(</span><span class="ident" id="5071672">e</span>&nbsp;<span class="op" id="5071674">*</span><span class="ident" id="5071675">escaper</span><span class="op" id="5071682">)</span>&nbsp;<span class="ident" id="5071684">editTemplateNode</span><span class="op" id="5071700">(</span><span class="ident" id="5071701">n</span>&nbsp;<span class="op" id="5071703">*</span><span class="ident" id="5071704">parse</span><span class="op" id="5071709">.</span><span class="ident" id="5071710">TemplateNode</span><span class="op" id="5071722">,</span>&nbsp;<span class="ident" id="5071724">callee</span>&nbsp;<span class="builtintype" id="5071731">string</span><span class="op" id="5071737">)</span>&nbsp;<span class="op" id="5071739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071742">if</span>&nbsp;<span class="ident" id="5071745">_</span><span class="op" id="5071746">,</span>&nbsp;<span class="ident" id="5071748">ok</span>&nbsp;<span class="op" id="5071751">:=</span>&nbsp;<span class="ident" id="5071754">e</span><span class="op" id="5071755">.</span><span class="ident" id="5071756">templateNodeEdits</span><span class="op" id="5071773">[</span><span class="ident" id="5071774">n</span><span class="op" id="5071775">]</span><span class="op" id="5071776">;</span>&nbsp;<span class="ident" id="5071778">ok</span>&nbsp;<span class="op" id="5071781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5071785">panic</span><span class="op" id="5071790">(</span><span class="ident" id="5071791">fmt</span><span class="op" id="5071794">.</span><span class="ident" id="5071795">Sprintf</span><span class="op" id="5071802">(</span><span class="string" id="5071803">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5071837">,</span>&nbsp;<span class="ident" id="5071839">n</span><span class="op" id="5071840">)</span><span class="op" id="5071841">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071847">e</span><span class="op" id="5071848">.</span><span class="ident" id="5071849">templateNodeEdits</span><span class="op" id="5071866">[</span><span class="ident" id="5071867">n</span><span class="op" id="5071868">]</span>&nbsp;<span class="op" id="5071870">=</span>&nbsp;<span class="ident" id="5071872">callee</span><br>
<span class="lineno"></span><span class="op" id="5071879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5071882">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="5071948">func</span>&nbsp;<span class="op" id="5071953">(</span><span class="ident" id="5071954">e</span>&nbsp;<span class="op" id="5071956">*</span><span class="ident" id="5071957">escaper</span><span class="op" id="5071964">)</span>&nbsp;<span class="ident" id="5071966">editTextNode</span><span class="op" id="5071978">(</span><span class="ident" id="5071979">n</span>&nbsp;<span class="op" id="5071981">*</span><span class="ident" id="5071982">parse</span><span class="op" id="5071987">.</span><span class="ident" id="5071988">TextNode</span><span class="op" id="5071996">,</span>&nbsp;<span class="ident" id="5071998">text</span>&nbsp;<span class="op" id="5072003">[</span><span class="op" id="5072004">]</span><span class="builtintype" id="5072005">byte</span><span class="op" id="5072009">)</span>&nbsp;<span class="op" id="5072011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072014">if</span>&nbsp;<span class="ident" id="5072017">_</span><span class="op" id="5072018">,</span>&nbsp;<span class="ident" id="5072020">ok</span>&nbsp;<span class="op" id="5072023">:=</span>&nbsp;<span class="ident" id="5072026">e</span><span class="op" id="5072027">.</span><span class="ident" id="5072028">textNodeEdits</span><span class="op" id="5072041">[</span><span class="ident" id="5072042">n</span><span class="op" id="5072043">]</span><span class="op" id="5072044">;</span>&nbsp;<span class="ident" id="5072046">ok</span>&nbsp;<span class="op" id="5072049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5072053">panic</span><span class="op" id="5072058">(</span><span class="ident" id="5072059">fmt</span><span class="op" id="5072062">.</span><span class="ident" id="5072063">Sprintf</span><span class="op" id="5072070">(</span><span class="string" id="5072071">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5072105">,</span>&nbsp;<span class="ident" id="5072107">n</span><span class="op" id="5072108">)</span><span class="op" id="5072109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072115">e</span><span class="op" id="5072116">.</span><span class="ident" id="5072117">textNodeEdits</span><span class="op" id="5072130">[</span><span class="ident" id="5072131">n</span><span class="op" id="5072132">]</span>&nbsp;<span class="op" id="5072134">=</span>&nbsp;<span class="ident" id="5072136">text</span><br>
<span class="lineno">735</span><span class="op" id="5072141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5072144">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="5072223">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="5072288">func</span>&nbsp;<span class="op" id="5072293">(</span><span class="ident" id="5072294">e</span>&nbsp;<span class="op" id="5072296">*</span><span class="ident" id="5072297">escaper</span><span class="op" id="5072304">)</span>&nbsp;<span class="ident" id="5072306">commit</span><span class="op" id="5072312">(</span><span class="op" id="5072313">)</span>&nbsp;<span class="op" id="5072315">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072318">for</span>&nbsp;<span class="ident" id="5072322">name</span>&nbsp;<span class="op" id="5072327">:=</span>&nbsp;<span class="keyword" id="5072330">range</span>&nbsp;<span class="ident" id="5072336">e</span><span class="op" id="5072337">.</span><span class="ident" id="5072338">output</span>&nbsp;<span class="op" id="5072345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072349">e</span><span class="op" id="5072350">.</span><span class="ident" id="5072351">template</span><span class="op" id="5072359">(</span><span class="ident" id="5072360">name</span><span class="op" id="5072364">)</span><span class="op" id="5072365">.</span><span class="ident" id="5072366">Funcs</span><span class="op" id="5072371">(</span><span class="ident" id="5072372">funcMap</span><span class="op" id="5072379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072385">for</span>&nbsp;<span class="ident" id="5072389">_</span><span class="op" id="5072390">,</span>&nbsp;<span class="ident" id="5072392">t</span>&nbsp;<span class="op" id="5072394">:=</span>&nbsp;<span class="keyword" id="5072397">range</span>&nbsp;<span class="ident" id="5072403">e</span><span class="op" id="5072404">.</span><span class="ident" id="5072405">derived</span>&nbsp;<span class="op" id="5072413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072417">if</span>&nbsp;<span class="ident" id="5072420">_</span><span class="op" id="5072421">,</span>&nbsp;<span class="ident" id="5072423">err</span>&nbsp;<span class="op" id="5072427">:=</span>&nbsp;<span class="ident" id="5072430">e</span><span class="op" id="5072431">.</span><span class="ident" id="5072432">tmpl</span><span class="op" id="5072436">.</span><span class="ident" id="5072437">text</span><span class="op" id="5072441">.</span><span class="ident" id="5072442">AddParseTree</span><span class="op" id="5072454">(</span><span class="ident" id="5072455">t</span><span class="op" id="5072456">.</span><span class="ident" id="5072457">Name</span><span class="op" id="5072461">(</span><span class="op" id="5072462">)</span><span class="op" id="5072463">,</span>&nbsp;<span class="ident" id="5072465">t</span><span class="op" id="5072466">.</span><span class="ident" id="5072467">Tree</span><span class="op" id="5072471">)</span><span class="op" id="5072472">;</span>&nbsp;<span class="ident" id="5072474">err</span>&nbsp;<span class="op" id="5072478">!=</span>&nbsp;<span class="ident" id="5072481">nil</span>&nbsp;<span class="op" id="5072485">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5072490">panic</span><span class="op" id="5072495">(</span><span class="string" id="5072496">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="5072527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072537">for</span>&nbsp;<span class="ident" id="5072541">n</span><span class="op" id="5072542">,</span>&nbsp;<span class="ident" id="5072544">s</span>&nbsp;<span class="op" id="5072546">:=</span>&nbsp;<span class="keyword" id="5072549">range</span>&nbsp;<span class="ident" id="5072555">e</span><span class="op" id="5072556">.</span><span class="ident" id="5072557">actionNodeEdits</span>&nbsp;<span class="op" id="5072573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072577">ensurePipelineContains</span><span class="op" id="5072599">(</span><span class="ident" id="5072600">n</span><span class="op" id="5072601">.</span><span class="ident" id="5072602">Pipe</span><span class="op" id="5072606">,</span>&nbsp;<span class="ident" id="5072608">s</span><span class="op" id="5072609">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072615">for</span>&nbsp;<span class="ident" id="5072619">n</span><span class="op" id="5072620">,</span>&nbsp;<span class="ident" id="5072622">name</span>&nbsp;<span class="op" id="5072627">:=</span>&nbsp;<span class="keyword" id="5072630">range</span>&nbsp;<span class="ident" id="5072636">e</span><span class="op" id="5072637">.</span><span class="ident" id="5072638">templateNodeEdits</span>&nbsp;<span class="op" id="5072656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072660">n</span><span class="op" id="5072661">.</span><span class="ident" id="5072662">Name</span>&nbsp;<span class="op" id="5072667">=</span>&nbsp;<span class="ident" id="5072669">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072678">for</span>&nbsp;<span class="ident" id="5072682">n</span><span class="op" id="5072683">,</span>&nbsp;<span class="ident" id="5072685">s</span>&nbsp;<span class="op" id="5072687">:=</span>&nbsp;<span class="keyword" id="5072690">range</span>&nbsp;<span class="ident" id="5072696">e</span><span class="op" id="5072697">.</span><span class="ident" id="5072698">textNodeEdits</span>&nbsp;<span class="op" id="5072712">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072716">n</span><span class="op" id="5072717">.</span><span class="ident" id="5072718">Text</span>&nbsp;<span class="op" id="5072723">=</span>&nbsp;<span class="ident" id="5072725">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072728">}</span><br>
<span class="lineno"></span><span class="op" id="5072730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5072733">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="5072803">func</span>&nbsp;<span class="op" id="5072808">(</span><span class="ident" id="5072809">e</span>&nbsp;<span class="op" id="5072811">*</span><span class="ident" id="5072812">escaper</span><span class="op" id="5072819">)</span>&nbsp;<span class="ident" id="5072821">template</span><span class="op" id="5072829">(</span><span class="ident" id="5072830">name</span>&nbsp;<span class="builtintype" id="5072835">string</span><span class="op" id="5072841">)</span>&nbsp;<span class="op" id="5072843">*</span><span class="ident" id="5072844">template</span><span class="op" id="5072852">.</span><span class="ident" id="5072853">Template</span>&nbsp;<span class="op" id="5072862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072865">t</span>&nbsp;<span class="op" id="5072867">:=</span>&nbsp;<span class="ident" id="5072870">e</span><span class="op" id="5072871">.</span><span class="ident" id="5072872">tmpl</span><span class="op" id="5072876">.</span><span class="ident" id="5072877">text</span><span class="op" id="5072881">.</span><span class="ident" id="5072882">Lookup</span><span class="op" id="5072888">(</span><span class="ident" id="5072889">name</span><span class="op" id="5072893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072896">if</span>&nbsp;<span class="ident" id="5072899">t</span>&nbsp;<span class="op" id="5072901">==</span>&nbsp;<span class="ident" id="5072904">nil</span>&nbsp;<span class="op" id="5072908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072912">t</span>&nbsp;<span class="op" id="5072914">=</span>&nbsp;<span class="ident" id="5072916">e</span><span class="op" id="5072917">.</span><span class="ident" id="5072918">derived</span><span class="op" id="5072925">[</span><span class="ident" id="5072926">name</span><span class="op" id="5072930">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072933">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072936">return</span>&nbsp;<span class="ident" id="5072943">t</span><br>
<span class="lineno"></span><span class="op" id="5072945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5072948">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="5073018">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="5073080">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="5073160">func</span>&nbsp;<span class="ident" id="5073165">HTMLEscape</span><span class="op" id="5073175">(</span><span class="ident" id="5073176">w</span>&nbsp;<span class="ident" id="5073178">io</span><span class="op" id="5073180">.</span><span class="ident" id="5073181">Writer</span><span class="op" id="5073187">,</span>&nbsp;<span class="ident" id="5073189">b</span>&nbsp;<span class="op" id="5073191">[</span><span class="op" id="5073192">]</span><span class="builtintype" id="5073193">byte</span><span class="op" id="5073197">)</span>&nbsp;<span class="op" id="5073199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073202">template</span><span class="op" id="5073210">.</span><span class="ident" id="5073211">HTMLEscape</span><span class="op" id="5073221">(</span><span class="ident" id="5073222">w</span><span class="op" id="5073223">,</span>&nbsp;<span class="ident" id="5073225">b</span><span class="op" id="5073226">)</span><br>
<span class="lineno"></span><span class="op" id="5073228">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="5073231">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="5073313">func</span>&nbsp;<span class="ident" id="5073318">HTMLEscapeString</span><span class="op" id="5073334">(</span><span class="ident" id="5073335">s</span>&nbsp;<span class="builtintype" id="5073337">string</span><span class="op" id="5073343">)</span>&nbsp;<span class="builtintype" id="5073345">string</span>&nbsp;<span class="op" id="5073352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073355">return</span>&nbsp;<span class="ident" id="5073362">template</span><span class="op" id="5073370">.</span><span class="ident" id="5073371">HTMLEscapeString</span><span class="op" id="5073387">(</span><span class="ident" id="5073388">s</span><span class="op" id="5073389">)</span><br>
<span class="lineno"></span><span class="op" id="5073391">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="5073394">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="5073460">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="5073496">func</span>&nbsp;<span class="ident" id="5073501">HTMLEscaper</span><span class="op" id="5073512">(</span><span class="ident" id="5073513">args</span>&nbsp;<span class="op" id="5073518">...</span><span class="keyword" id="5073521">interface</span><span class="op" id="5073530">{</span><span class="op" id="5073531">}</span><span class="op" id="5073532">)</span>&nbsp;<span class="builtintype" id="5073534">string</span>&nbsp;<span class="op" id="5073541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073544">return</span>&nbsp;<span class="ident" id="5073551">template</span><span class="op" id="5073559">.</span><span class="ident" id="5073560">HTMLEscaper</span><span class="op" id="5073571">(</span><span class="ident" id="5073572">args</span><span class="op" id="5073576">...</span><span class="op" id="5073579">)</span><br>
<span class="lineno">785</span><span class="op" id="5073581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5073584">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="5073668">func</span>&nbsp;<span class="ident" id="5073673">JSEscape</span><span class="op" id="5073681">(</span><span class="ident" id="5073682">w</span>&nbsp;<span class="ident" id="5073684">io</span><span class="op" id="5073686">.</span><span class="ident" id="5073687">Writer</span><span class="op" id="5073693">,</span>&nbsp;<span class="ident" id="5073695">b</span>&nbsp;<span class="op" id="5073697">[</span><span class="op" id="5073698">]</span><span class="builtintype" id="5073699">byte</span><span class="op" id="5073703">)</span>&nbsp;<span class="op" id="5073705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073708">template</span><span class="op" id="5073716">.</span><span class="ident" id="5073717">JSEscape</span><span class="op" id="5073725">(</span><span class="ident" id="5073726">w</span><span class="op" id="5073727">,</span>&nbsp;<span class="ident" id="5073729">b</span><span class="op" id="5073730">)</span><br>
<span class="lineno">790</span><span class="op" id="5073732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5073735">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="5073821">func</span>&nbsp;<span class="ident" id="5073826">JSEscapeString</span><span class="op" id="5073840">(</span><span class="ident" id="5073841">s</span>&nbsp;<span class="builtintype" id="5073843">string</span><span class="op" id="5073849">)</span>&nbsp;<span class="builtintype" id="5073851">string</span>&nbsp;<span class="op" id="5073858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073861">return</span>&nbsp;<span class="ident" id="5073868">template</span><span class="op" id="5073876">.</span><span class="ident" id="5073877">JSEscapeString</span><span class="op" id="5073891">(</span><span class="ident" id="5073892">s</span><span class="op" id="5073893">)</span><br>
<span class="lineno">795</span><span class="op" id="5073895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5073898">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="5073968">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="5074004">func</span>&nbsp;<span class="ident" id="5074009">JSEscaper</span><span class="op" id="5074018">(</span><span class="ident" id="5074019">args</span>&nbsp;<span class="op" id="5074024">...</span><span class="keyword" id="5074027">interface</span><span class="op" id="5074036">{</span><span class="op" id="5074037">}</span><span class="op" id="5074038">)</span>&nbsp;<span class="builtintype" id="5074040">string</span>&nbsp;<span class="op" id="5074047">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074050">return</span>&nbsp;<span class="ident" id="5074057">template</span><span class="op" id="5074065">.</span><span class="ident" id="5074066">JSEscaper</span><span class="op" id="5074075">(</span><span class="ident" id="5074076">args</span><span class="op" id="5074080">...</span><span class="op" id="5074083">)</span><br>
<span class="lineno"></span><span class="op" id="5074085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5074088">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5074166">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="5074232">func</span>&nbsp;<span class="ident" id="5074237">URLQueryEscaper</span><span class="op" id="5074252">(</span><span class="ident" id="5074253">args</span>&nbsp;<span class="op" id="5074258">...</span><span class="keyword" id="5074261">interface</span><span class="op" id="5074270">{</span><span class="op" id="5074271">}</span><span class="op" id="5074272">)</span>&nbsp;<span class="builtintype" id="5074274">string</span>&nbsp;<span class="op" id="5074281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5074284">return</span>&nbsp;<span class="ident" id="5074291">template</span><span class="op" id="5074299">.</span><span class="ident" id="5074300">URLQueryEscaper</span><span class="op" id="5074315">(</span><span class="ident" id="5074316">args</span><span class="op" id="5074320">...</span><span class="op" id="5074323">)</span><br>
<span class="lineno"></span><span class="op" id="5074325">}</span>
</div>
</body>
</html>
