<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3206579">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3206634">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3206688">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3206739">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3206794">package</span>&nbsp;<span class="ident" id="3206802">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3206807">import</span>&nbsp;<span class="op" id="3206814">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3206817">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3206829">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3206837">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="3206847">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="3206850">const</span>&nbsp;<span class="ident" id="3206856">uint64Size</span>&nbsp;<span class="op" id="3206867">=</span>&nbsp;<span class="num" id="3206869">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3206872">type</span>&nbsp;<span class="ident" id="3206877">encHelper</span>&nbsp;<span class="keyword" id="3206887">func</span><span class="op" id="3206891">(</span><span class="ident" id="3206892">state</span>&nbsp;<span class="op" id="3206898">*</span><span class="ident" id="3206899">encoderState</span><span class="op" id="3206911">,</span>&nbsp;<span class="ident" id="3206913">v</span>&nbsp;<span class="ident" id="3206915">reflect</span><span class="op" id="3206922">.</span><span class="ident" id="3206923">Value</span><span class="op" id="3206928">)</span>&nbsp;<span class="builtintype" id="3206930">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3206936">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="3207013">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="3207079">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3207149">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="3207180">type</span>&nbsp;<span class="ident" id="3207185">encoderState</span>&nbsp;<span class="keyword" id="3207198">struct</span>&nbsp;<span class="op" id="3207205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3207208">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3207217">*</span><span class="ident" id="3207218">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3207227">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3207236">*</span><span class="ident" id="3207237">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3207248">sendZero</span>&nbsp;<span class="builtintype" id="3207257">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3207278">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3207348">fieldnum</span>&nbsp;<span class="builtintype" id="3207357">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3207378">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3207413">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3207422">[</span><span class="num" id="3207423">1</span>&nbsp;<span class="op" id="3207425">+</span>&nbsp;<span class="ident" id="3207427">uint64Size</span><span class="op" id="3207437">]</span><span class="builtintype" id="3207438">byte</span>&nbsp;<span class="comment" id="3207443">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3207501">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3207510">*</span><span class="ident" id="3207511">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3207531">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="3207548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3207551">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="3207637">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3207732">type</span>&nbsp;<span class="ident" id="3207737">encBuffer</span>&nbsp;<span class="keyword" id="3207747">struct</span>&nbsp;<span class="op" id="3207754">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3207757">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3207765">[</span><span class="op" id="3207766">]</span><span class="builtintype" id="3207767">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3207773">scratch</span>&nbsp;<span class="op" id="3207781">[</span><span class="num" id="3207782">64</span><span class="op" id="3207784">]</span><span class="builtintype" id="3207785">byte</span><br>
<span class="lineno"></span><span class="op" id="3207790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3207793">func</span>&nbsp;<span class="op" id="3207798">(</span><span class="ident" id="3207799">e</span>&nbsp;<span class="op" id="3207801">*</span><span class="ident" id="3207802">encBuffer</span><span class="op" id="3207811">)</span>&nbsp;<span class="ident" id="3207813">WriteByte</span><span class="op" id="3207822">(</span><span class="ident" id="3207823">c</span>&nbsp;<span class="builtintype" id="3207825">byte</span><span class="op" id="3207829">)</span>&nbsp;<span class="op" id="3207831">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3207834">e</span><span class="op" id="3207835">.</span><span class="ident" id="3207836">data</span>&nbsp;<span class="op" id="3207841">=</span>&nbsp;<span class="builtinfunc" id="3207843">append</span><span class="op" id="3207849">(</span><span class="ident" id="3207850">e</span><span class="op" id="3207851">.</span><span class="ident" id="3207852">data</span><span class="op" id="3207856">,</span>&nbsp;<span class="ident" id="3207858">c</span><span class="op" id="3207859">)</span><br>
<span class="lineno"></span><span class="op" id="3207861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3207864">func</span>&nbsp;<span class="op" id="3207869">(</span><span class="ident" id="3207870">e</span>&nbsp;<span class="op" id="3207872">*</span><span class="ident" id="3207873">encBuffer</span><span class="op" id="3207882">)</span>&nbsp;<span class="ident" id="3207884">Write</span><span class="op" id="3207889">(</span><span class="ident" id="3207890">p</span>&nbsp;<span class="op" id="3207892">[</span><span class="op" id="3207893">]</span><span class="builtintype" id="3207894">byte</span><span class="op" id="3207898">)</span>&nbsp;<span class="op" id="3207900">(</span><span class="builtintype" id="3207901">int</span><span class="op" id="3207904">,</span>&nbsp;<span class="builtintype" id="3207906">error</span><span class="op" id="3207911">)</span>&nbsp;<span class="op" id="3207913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3207916">e</span><span class="op" id="3207917">.</span><span class="ident" id="3207918">data</span>&nbsp;<span class="op" id="3207923">=</span>&nbsp;<span class="builtinfunc" id="3207925">append</span><span class="op" id="3207931">(</span><span class="ident" id="3207932">e</span><span class="op" id="3207933">.</span><span class="ident" id="3207934">data</span><span class="op" id="3207938">,</span>&nbsp;<span class="ident" id="3207940">p</span><span class="op" id="3207941">...</span><span class="op" id="3207944">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3207947">return</span>&nbsp;<span class="builtinfunc" id="3207954">len</span><span class="op" id="3207957">(</span><span class="ident" id="3207958">p</span><span class="op" id="3207959">)</span><span class="op" id="3207960">,</span>&nbsp;<span class="ident" id="3207962">nil</span><br>
<span class="lineno"></span><span class="op" id="3207966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3207969">func</span>&nbsp;<span class="op" id="3207974">(</span><span class="ident" id="3207975">e</span>&nbsp;<span class="op" id="3207977">*</span><span class="ident" id="3207978">encBuffer</span><span class="op" id="3207987">)</span>&nbsp;<span class="ident" id="3207989">WriteString</span><span class="op" id="3208000">(</span><span class="ident" id="3208001">s</span>&nbsp;<span class="builtintype" id="3208003">string</span><span class="op" id="3208009">)</span>&nbsp;<span class="op" id="3208011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208014">e</span><span class="op" id="3208015">.</span><span class="ident" id="3208016">data</span>&nbsp;<span class="op" id="3208021">=</span>&nbsp;<span class="builtinfunc" id="3208023">append</span><span class="op" id="3208029">(</span><span class="ident" id="3208030">e</span><span class="op" id="3208031">.</span><span class="ident" id="3208032">data</span><span class="op" id="3208036">,</span>&nbsp;<span class="ident" id="3208038">s</span><span class="op" id="3208039">...</span><span class="op" id="3208042">)</span><br>
<span class="lineno">50</span><span class="op" id="3208044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3208047">func</span>&nbsp;<span class="op" id="3208052">(</span><span class="ident" id="3208053">e</span>&nbsp;<span class="op" id="3208055">*</span><span class="ident" id="3208056">encBuffer</span><span class="op" id="3208065">)</span>&nbsp;<span class="ident" id="3208067">Len</span><span class="op" id="3208070">(</span><span class="op" id="3208071">)</span>&nbsp;<span class="builtintype" id="3208073">int</span>&nbsp;<span class="op" id="3208077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3208080">return</span>&nbsp;<span class="builtinfunc" id="3208087">len</span><span class="op" id="3208090">(</span><span class="ident" id="3208091">e</span><span class="op" id="3208092">.</span><span class="ident" id="3208093">data</span><span class="op" id="3208097">)</span><br>
<span class="lineno"></span><span class="op" id="3208099">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="3208102">func</span>&nbsp;<span class="op" id="3208107">(</span><span class="ident" id="3208108">e</span>&nbsp;<span class="op" id="3208110">*</span><span class="ident" id="3208111">encBuffer</span><span class="op" id="3208120">)</span>&nbsp;<span class="ident" id="3208122">Bytes</span><span class="op" id="3208127">(</span><span class="op" id="3208128">)</span>&nbsp;<span class="op" id="3208130">[</span><span class="op" id="3208131">]</span><span class="builtintype" id="3208132">byte</span>&nbsp;<span class="op" id="3208137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3208140">return</span>&nbsp;<span class="ident" id="3208147">e</span><span class="op" id="3208148">.</span><span class="ident" id="3208149">data</span><br>
<span class="lineno"></span><span class="op" id="3208154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3208157">func</span>&nbsp;<span class="op" id="3208162">(</span><span class="ident" id="3208163">e</span>&nbsp;<span class="op" id="3208165">*</span><span class="ident" id="3208166">encBuffer</span><span class="op" id="3208175">)</span>&nbsp;<span class="ident" id="3208177">Reset</span><span class="op" id="3208182">(</span><span class="op" id="3208183">)</span>&nbsp;<span class="op" id="3208185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208188">e</span><span class="op" id="3208189">.</span><span class="ident" id="3208190">data</span>&nbsp;<span class="op" id="3208195">=</span>&nbsp;<span class="ident" id="3208197">e</span><span class="op" id="3208198">.</span><span class="ident" id="3208199">data</span><span class="op" id="3208203">[</span><span class="num" id="3208204">0</span><span class="op" id="3208205">:</span><span class="num" id="3208206">0</span><span class="op" id="3208207">]</span><br>
<span class="lineno"></span><span class="op" id="3208209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3208212">func</span>&nbsp;<span class="op" id="3208217">(</span><span class="ident" id="3208218">enc</span>&nbsp;<span class="op" id="3208222">*</span><span class="ident" id="3208223">Encoder</span><span class="op" id="3208230">)</span>&nbsp;<span class="ident" id="3208232">newEncoderState</span><span class="op" id="3208247">(</span><span class="ident" id="3208248">b</span>&nbsp;<span class="op" id="3208250">*</span><span class="ident" id="3208251">encBuffer</span><span class="op" id="3208260">)</span>&nbsp;<span class="op" id="3208262">*</span><span class="ident" id="3208263">encoderState</span>&nbsp;<span class="op" id="3208276">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208279">e</span>&nbsp;<span class="op" id="3208281">:=</span>&nbsp;<span class="ident" id="3208284">enc</span><span class="op" id="3208287">.</span><span class="ident" id="3208288">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3208298">if</span>&nbsp;<span class="ident" id="3208301">e</span>&nbsp;<span class="op" id="3208303">==</span>&nbsp;<span class="ident" id="3208306">nil</span>&nbsp;<span class="op" id="3208310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208314">e</span>&nbsp;<span class="op" id="3208316">=</span>&nbsp;<span class="builtinfunc" id="3208318">new</span><span class="op" id="3208321">(</span><span class="ident" id="3208322">encoderState</span><span class="op" id="3208334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208338">e</span><span class="op" id="3208339">.</span><span class="ident" id="3208340">enc</span>&nbsp;<span class="op" id="3208344">=</span>&nbsp;<span class="ident" id="3208346">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3208351">}</span>&nbsp;<span class="keyword" id="3208353">else</span>&nbsp;<span class="op" id="3208358">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208362">enc</span><span class="op" id="3208365">.</span><span class="ident" id="3208366">freeList</span>&nbsp;<span class="op" id="3208375">=</span>&nbsp;<span class="ident" id="3208377">e</span><span class="op" id="3208378">.</span><span class="ident" id="3208379">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3208385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208388">e</span><span class="op" id="3208389">.</span><span class="ident" id="3208390">sendZero</span>&nbsp;<span class="op" id="3208399">=</span>&nbsp;<span class="ident" id="3208401">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208408">e</span><span class="op" id="3208409">.</span><span class="ident" id="3208410">fieldnum</span>&nbsp;<span class="op" id="3208419">=</span>&nbsp;<span class="num" id="3208421">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208424">e</span><span class="op" id="3208425">.</span><span class="ident" id="3208426">b</span>&nbsp;<span class="op" id="3208428">=</span>&nbsp;<span class="ident" id="3208430">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3208433">if</span>&nbsp;<span class="builtinfunc" id="3208436">len</span><span class="op" id="3208439">(</span><span class="ident" id="3208440">b</span><span class="op" id="3208441">.</span><span class="ident" id="3208442">data</span><span class="op" id="3208446">)</span>&nbsp;<span class="op" id="3208448">==</span>&nbsp;<span class="num" id="3208451">0</span>&nbsp;<span class="op" id="3208453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208457">b</span><span class="op" id="3208458">.</span><span class="ident" id="3208459">data</span>&nbsp;<span class="op" id="3208464">=</span>&nbsp;<span class="ident" id="3208466">b</span><span class="op" id="3208467">.</span><span class="ident" id="3208468">scratch</span><span class="op" id="3208475">[</span><span class="num" id="3208476">0</span><span class="op" id="3208477">:</span><span class="num" id="3208478">0</span><span class="op" id="3208479">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3208482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3208485">return</span>&nbsp;<span class="ident" id="3208492">e</span><br>
<span class="lineno"></span><span class="op" id="3208494">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="3208497">func</span>&nbsp;<span class="op" id="3208502">(</span><span class="ident" id="3208503">enc</span>&nbsp;<span class="op" id="3208507">*</span><span class="ident" id="3208508">Encoder</span><span class="op" id="3208515">)</span>&nbsp;<span class="ident" id="3208517">freeEncoderState</span><span class="op" id="3208533">(</span><span class="ident" id="3208534">e</span>&nbsp;<span class="op" id="3208536">*</span><span class="ident" id="3208537">encoderState</span><span class="op" id="3208549">)</span>&nbsp;<span class="op" id="3208551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208554">e</span><span class="op" id="3208555">.</span><span class="ident" id="3208556">next</span>&nbsp;<span class="op" id="3208561">=</span>&nbsp;<span class="ident" id="3208563">enc</span><span class="op" id="3208566">.</span><span class="ident" id="3208567">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208577">enc</span><span class="op" id="3208580">.</span><span class="ident" id="3208581">freeList</span>&nbsp;<span class="op" id="3208590">=</span>&nbsp;<span class="ident" id="3208592">e</span><br>
<span class="lineno"></span><span class="op" id="3208594">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="3208597">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="3208668">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="3208729">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="3208797">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3208830">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="3208891">func</span>&nbsp;<span class="op" id="3208896">(</span><span class="ident" id="3208897">state</span>&nbsp;<span class="op" id="3208903">*</span><span class="ident" id="3208904">encoderState</span><span class="op" id="3208916">)</span>&nbsp;<span class="ident" id="3208918">encodeUint</span><span class="op" id="3208928">(</span><span class="ident" id="3208929">x</span>&nbsp;<span class="ident" id="3208931">uint64</span><span class="op" id="3208937">)</span>&nbsp;<span class="op" id="3208939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3208942">if</span>&nbsp;<span class="ident" id="3208945">x</span>&nbsp;<span class="op" id="3208947">&lt;=</span>&nbsp;<span class="num" id="3208950">0x7F</span>&nbsp;<span class="op" id="3208955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3208959">state</span><span class="op" id="3208964">.</span><span class="ident" id="3208965">b</span><span class="op" id="3208966">.</span><span class="ident" id="3208967">WriteByte</span><span class="op" id="3208976">(</span><span class="builtintype" id="3208977">uint8</span><span class="op" id="3208982">(</span><span class="ident" id="3208983">x</span><span class="op" id="3208984">)</span><span class="op" id="3208985">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3208989">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3208997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209000">i</span>&nbsp;<span class="op" id="3209002">:=</span>&nbsp;<span class="ident" id="3209005">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3209017">for</span>&nbsp;<span class="ident" id="3209021">x</span>&nbsp;<span class="op" id="3209023">&gt;</span>&nbsp;<span class="num" id="3209025">0</span>&nbsp;<span class="op" id="3209027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209031">state</span><span class="op" id="3209036">.</span><span class="ident" id="3209037">buf</span><span class="op" id="3209040">[</span><span class="ident" id="3209041">i</span><span class="op" id="3209042">]</span>&nbsp;<span class="op" id="3209044">=</span>&nbsp;<span class="builtintype" id="3209046">uint8</span><span class="op" id="3209051">(</span><span class="ident" id="3209052">x</span><span class="op" id="3209053">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209057">x</span>&nbsp;<span class="op" id="3209059">&gt;&gt;=</span>&nbsp;<span class="num" id="3209063">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209067">i</span><span class="op" id="3209068">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3209072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209075">state</span><span class="op" id="3209080">.</span><span class="ident" id="3209081">buf</span><span class="op" id="3209084">[</span><span class="ident" id="3209085">i</span><span class="op" id="3209086">]</span>&nbsp;<span class="op" id="3209088">=</span>&nbsp;<span class="builtintype" id="3209090">uint8</span><span class="op" id="3209095">(</span><span class="ident" id="3209096">i</span>&nbsp;<span class="op" id="3209098">-</span>&nbsp;<span class="ident" id="3209100">uint64Size</span><span class="op" id="3209110">)</span>&nbsp;<span class="comment" id="3209112">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209138">state</span><span class="op" id="3209143">.</span><span class="ident" id="3209144">b</span><span class="op" id="3209145">.</span><span class="ident" id="3209146">Write</span><span class="op" id="3209151">(</span><span class="ident" id="3209152">state</span><span class="op" id="3209157">.</span><span class="ident" id="3209158">buf</span><span class="op" id="3209161">[</span><span class="ident" id="3209162">i</span>&nbsp;<span class="op" id="3209164">:</span>&nbsp;<span class="ident" id="3209166">uint64Size</span><span class="op" id="3209176">+</span><span class="num" id="3209177">1</span><span class="op" id="3209178">]</span><span class="op" id="3209179">)</span><br>
<span class="lineno">105</span><span class="op" id="3209181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3209184">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="3209242">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="3209328">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="3209356">func</span>&nbsp;<span class="op" id="3209361">(</span><span class="ident" id="3209362">state</span>&nbsp;<span class="op" id="3209368">*</span><span class="ident" id="3209369">encoderState</span><span class="op" id="3209381">)</span>&nbsp;<span class="ident" id="3209383">encodeInt</span><span class="op" id="3209392">(</span><span class="ident" id="3209393">i</span>&nbsp;<span class="ident" id="3209395">int64</span><span class="op" id="3209400">)</span>&nbsp;<span class="op" id="3209402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3209405">var</span>&nbsp;<span class="ident" id="3209409">x</span>&nbsp;<span class="ident" id="3209411">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3209419">if</span>&nbsp;<span class="ident" id="3209422">i</span>&nbsp;<span class="op" id="3209424">&lt;</span>&nbsp;<span class="num" id="3209426">0</span>&nbsp;<span class="op" id="3209428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209432">x</span>&nbsp;<span class="op" id="3209434">=</span>&nbsp;<span class="ident" id="3209436">uint64</span><span class="op" id="3209442">(</span><span class="op" id="3209443">^</span><span class="ident" id="3209444">i</span><span class="op" id="3209445">&lt;&lt;</span><span class="num" id="3209447">1</span><span class="op" id="3209448">)</span>&nbsp;<span class="op" id="3209450">|</span>&nbsp;<span class="num" id="3209452">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3209455">}</span>&nbsp;<span class="keyword" id="3209457">else</span>&nbsp;<span class="op" id="3209462">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209466">x</span>&nbsp;<span class="op" id="3209468">=</span>&nbsp;<span class="ident" id="3209470">uint64</span><span class="op" id="3209476">(</span><span class="ident" id="3209477">i</span>&nbsp;<span class="op" id="3209479">&lt;&lt;</span>&nbsp;<span class="num" id="3209482">1</span><span class="op" id="3209483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3209486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209489">state</span><span class="op" id="3209494">.</span><span class="ident" id="3209495">encodeUint</span><span class="op" id="3209505">(</span><span class="ident" id="3209506">uint64</span><span class="op" id="3209512">(</span><span class="ident" id="3209513">x</span><span class="op" id="3209514">)</span><span class="op" id="3209515">)</span><br>
<span class="lineno"></span><span class="op" id="3209517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="3209520">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3209588">type</span>&nbsp;<span class="ident" id="3209593">encOp</span>&nbsp;<span class="keyword" id="3209599">func</span><span class="op" id="3209603">(</span><span class="ident" id="3209604">i</span>&nbsp;<span class="op" id="3209606">*</span><span class="ident" id="3209607">encInstr</span><span class="op" id="3209615">,</span>&nbsp;<span class="ident" id="3209617">state</span>&nbsp;<span class="op" id="3209623">*</span><span class="ident" id="3209624">encoderState</span><span class="op" id="3209636">,</span>&nbsp;<span class="ident" id="3209638">v</span>&nbsp;<span class="ident" id="3209640">reflect</span><span class="op" id="3209647">.</span><span class="ident" id="3209648">Value</span><span class="op" id="3209653">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3209656">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="3209702">type</span>&nbsp;<span class="ident" id="3209707">encInstr</span>&nbsp;<span class="keyword" id="3209716">struct</span>&nbsp;<span class="op" id="3209723">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209726">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3209732">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209739">field</span>&nbsp;<span class="builtintype" id="3209745">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3209751">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209777">index</span>&nbsp;<span class="op" id="3209783">[</span><span class="op" id="3209784">]</span><span class="builtintype" id="3209785">int</span>&nbsp;<span class="comment" id="3209789">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3209806">indir</span>&nbsp;<span class="builtintype" id="3209812">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3209818">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="3209884">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="3209887">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="3209980">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="3210034">func</span>&nbsp;<span class="op" id="3210039">(</span><span class="ident" id="3210040">state</span>&nbsp;<span class="op" id="3210046">*</span><span class="ident" id="3210047">encoderState</span><span class="op" id="3210059">)</span>&nbsp;<span class="ident" id="3210061">update</span><span class="op" id="3210067">(</span><span class="ident" id="3210068">instr</span>&nbsp;<span class="op" id="3210074">*</span><span class="ident" id="3210075">encInstr</span><span class="op" id="3210083">)</span>&nbsp;<span class="op" id="3210085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3210088">if</span>&nbsp;<span class="ident" id="3210091">instr</span>&nbsp;<span class="op" id="3210097">!=</span>&nbsp;<span class="ident" id="3210100">nil</span>&nbsp;<span class="op" id="3210104">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3210108">state</span><span class="op" id="3210113">.</span><span class="ident" id="3210114">encodeUint</span><span class="op" id="3210124">(</span><span class="ident" id="3210125">uint64</span><span class="op" id="3210131">(</span><span class="ident" id="3210132">instr</span><span class="op" id="3210137">.</span><span class="ident" id="3210138">field</span>&nbsp;<span class="op" id="3210144">-</span>&nbsp;<span class="ident" id="3210146">state</span><span class="op" id="3210151">.</span><span class="ident" id="3210152">fieldnum</span><span class="op" id="3210160">)</span><span class="op" id="3210161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3210165">state</span><span class="op" id="3210170">.</span><span class="ident" id="3210171">fieldnum</span>&nbsp;<span class="op" id="3210180">=</span>&nbsp;<span class="ident" id="3210182">instr</span><span class="op" id="3210187">.</span><span class="ident" id="3210188">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3210195">}</span><br>
<span class="lineno"></span><span class="op" id="3210197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3210200">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3210264">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="3210332">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3210399">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="3210466">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="3210530">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3210597">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="3210663">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3210675">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="3210742">func</span>&nbsp;<span class="ident" id="3210747">encIndirect</span><span class="op" id="3210758">(</span><span class="ident" id="3210759">pv</span>&nbsp;<span class="ident" id="3210762">reflect</span><span class="op" id="3210769">.</span><span class="ident" id="3210770">Value</span><span class="op" id="3210775">,</span>&nbsp;<span class="ident" id="3210777">indir</span>&nbsp;<span class="builtintype" id="3210783">int</span><span class="op" id="3210786">)</span>&nbsp;<span class="ident" id="3210788">reflect</span><span class="op" id="3210795">.</span><span class="ident" id="3210796">Value</span>&nbsp;<span class="op" id="3210802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3210805">for</span>&nbsp;<span class="op" id="3210809">;</span>&nbsp;<span class="ident" id="3210811">indir</span>&nbsp;<span class="op" id="3210817">&gt;</span>&nbsp;<span class="num" id="3210819">0</span><span class="op" id="3210820">;</span>&nbsp;<span class="ident" id="3210822">indir</span><span class="op" id="3210827">--</span>&nbsp;<span class="op" id="3210830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3210834">if</span>&nbsp;<span class="ident" id="3210837">pv</span><span class="op" id="3210839">.</span><span class="ident" id="3210840">IsNil</span><span class="op" id="3210845">(</span><span class="op" id="3210846">)</span>&nbsp;<span class="op" id="3210848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3210853">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3210861">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3210865">pv</span>&nbsp;<span class="op" id="3210868">=</span>&nbsp;<span class="ident" id="3210870">pv</span><span class="op" id="3210872">.</span><span class="ident" id="3210873">Elem</span><span class="op" id="3210877">(</span><span class="op" id="3210878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3210881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3210884">return</span>&nbsp;<span class="ident" id="3210891">pv</span><br>
<span class="lineno"></span><span class="op" id="3210894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="3210897">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="3210964">func</span>&nbsp;<span class="ident" id="3210969">encBool</span><span class="op" id="3210976">(</span><span class="ident" id="3210977">i</span>&nbsp;<span class="op" id="3210979">*</span><span class="ident" id="3210980">encInstr</span><span class="op" id="3210988">,</span>&nbsp;<span class="ident" id="3210990">state</span>&nbsp;<span class="op" id="3210996">*</span><span class="ident" id="3210997">encoderState</span><span class="op" id="3211009">,</span>&nbsp;<span class="ident" id="3211011">v</span>&nbsp;<span class="ident" id="3211013">reflect</span><span class="op" id="3211020">.</span><span class="ident" id="3211021">Value</span><span class="op" id="3211026">)</span>&nbsp;<span class="op" id="3211028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3211031">b</span>&nbsp;<span class="op" id="3211033">:=</span>&nbsp;<span class="ident" id="3211036">v</span><span class="op" id="3211037">.</span><span class="ident" id="3211038">Bool</span><span class="op" id="3211042">(</span><span class="op" id="3211043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3211046">if</span>&nbsp;<span class="ident" id="3211049">b</span>&nbsp;<span class="op" id="3211051">||</span>&nbsp;<span class="ident" id="3211054">state</span><span class="op" id="3211059">.</span><span class="ident" id="3211060">sendZero</span>&nbsp;<span class="op" id="3211069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3211073">state</span><span class="op" id="3211078">.</span><span class="ident" id="3211079">update</span><span class="op" id="3211085">(</span><span class="ident" id="3211086">i</span><span class="op" id="3211087">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3211091">if</span>&nbsp;<span class="ident" id="3211094">b</span>&nbsp;<span class="op" id="3211096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3211101">state</span><span class="op" id="3211106">.</span><span class="ident" id="3211107">encodeUint</span><span class="op" id="3211117">(</span><span class="num" id="3211118">1</span><span class="op" id="3211119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3211123">}</span>&nbsp;<span class="keyword" id="3211125">else</span>&nbsp;<span class="op" id="3211130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3211135">state</span><span class="op" id="3211140">.</span><span class="ident" id="3211141">encodeUint</span><span class="op" id="3211151">(</span><span class="num" id="3211152">0</span><span class="op" id="3211153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3211157">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3211160">}</span><br>
<span class="lineno"></span><span class="op" id="3211162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3211165">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3211248">func</span>&nbsp;<span class="ident" id="3211253">encInt</span><span class="op" id="3211259">(</span><span class="ident" id="3211260">i</span>&nbsp;<span class="op" id="3211262">*</span><span class="ident" id="3211263">encInstr</span><span class="op" id="3211271">,</span>&nbsp;<span class="ident" id="3211273">state</span>&nbsp;<span class="op" id="3211279">*</span><span class="ident" id="3211280">encoderState</span><span class="op" id="3211292">,</span>&nbsp;<span class="ident" id="3211294">v</span>&nbsp;<span class="ident" id="3211296">reflect</span><span class="op" id="3211303">.</span><span class="ident" id="3211304">Value</span><span class="op" id="3211309">)</span>&nbsp;<span class="op" id="3211311">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3211314">value</span>&nbsp;<span class="op" id="3211320">:=</span>&nbsp;<span class="ident" id="3211323">v</span><span class="op" id="3211324">.</span><span class="ident" id="3211325">Int</span><span class="op" id="3211328">(</span><span class="op" id="3211329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3211332">if</span>&nbsp;<span class="ident" id="3211335">value</span>&nbsp;<span class="op" id="3211341">!=</span>&nbsp;<span class="num" id="3211344">0</span>&nbsp;<span class="op" id="3211346">||</span>&nbsp;<span class="ident" id="3211349">state</span><span class="op" id="3211354">.</span><span class="ident" id="3211355">sendZero</span>&nbsp;<span class="op" id="3211364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3211368">state</span><span class="op" id="3211373">.</span><span class="ident" id="3211374">update</span><span class="op" id="3211380">(</span><span class="ident" id="3211381">i</span><span class="op" id="3211382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3211386">state</span><span class="op" id="3211391">.</span><span class="ident" id="3211392">encodeInt</span><span class="op" id="3211401">(</span><span class="ident" id="3211402">value</span><span class="op" id="3211407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3211410">}</span><br>
<span class="lineno">180</span><span class="op" id="3211412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3211415">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3211514">func</span>&nbsp;<span class="ident" id="3211519">encUint</span><span class="op" id="3211526">(</span><span class="ident" id="3211527">i</span>&nbsp;<span class="op" id="3211529">*</span><span class="ident" id="3211530">encInstr</span><span class="op" id="3211538">,</span>&nbsp;<span class="ident" id="3211540">state</span>&nbsp;<span class="op" id="3211546">*</span><span class="ident" id="3211547">encoderState</span><span class="op" id="3211559">,</span>&nbsp;<span class="ident" id="3211561">v</span>&nbsp;<span class="ident" id="3211563">reflect</span><span class="op" id="3211570">.</span><span class="ident" id="3211571">Value</span><span class="op" id="3211576">)</span>&nbsp;<span class="op" id="3211578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3211581">value</span>&nbsp;<span class="op" id="3211587">:=</span>&nbsp;<span class="ident" id="3211590">v</span><span class="op" id="3211591">.</span><span class="ident" id="3211592">Uint</span><span class="op" id="3211596">(</span><span class="op" id="3211597">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3211600">if</span>&nbsp;<span class="ident" id="3211603">value</span>&nbsp;<span class="op" id="3211609">!=</span>&nbsp;<span class="num" id="3211612">0</span>&nbsp;<span class="op" id="3211614">||</span>&nbsp;<span class="ident" id="3211617">state</span><span class="op" id="3211622">.</span><span class="ident" id="3211623">sendZero</span>&nbsp;<span class="op" id="3211632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3211636">state</span><span class="op" id="3211641">.</span><span class="ident" id="3211642">update</span><span class="op" id="3211648">(</span><span class="ident" id="3211649">i</span><span class="op" id="3211650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3211654">state</span><span class="op" id="3211659">.</span><span class="ident" id="3211660">encodeUint</span><span class="op" id="3211670">(</span><span class="ident" id="3211671">value</span><span class="op" id="3211676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3211679">}</span><br>
<span class="lineno"></span><span class="op" id="3211681">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3211684">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="3211759">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="3211829">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3211901">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="3211973">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3212038">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="3212052">func</span>&nbsp;<span class="ident" id="3212057">floatBits</span><span class="op" id="3212066">(</span><span class="ident" id="3212067">f</span>&nbsp;<span class="builtintype" id="3212069">float64</span><span class="op" id="3212076">)</span>&nbsp;<span class="ident" id="3212078">uint64</span>&nbsp;<span class="op" id="3212085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212088">u</span>&nbsp;<span class="op" id="3212090">:=</span>&nbsp;<span class="ident" id="3212093">math</span><span class="op" id="3212097">.</span><span class="ident" id="3212098">Float64bits</span><span class="op" id="3212109">(</span><span class="ident" id="3212110">f</span><span class="op" id="3212111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3212114">var</span>&nbsp;<span class="ident" id="3212118">v</span>&nbsp;<span class="ident" id="3212120">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3212128">for</span>&nbsp;<span class="ident" id="3212132">i</span>&nbsp;<span class="op" id="3212134">:=</span>&nbsp;<span class="num" id="3212137">0</span><span class="op" id="3212138">;</span>&nbsp;<span class="ident" id="3212140">i</span>&nbsp;<span class="op" id="3212142">&lt;</span>&nbsp;<span class="num" id="3212144">8</span><span class="op" id="3212145">;</span>&nbsp;<span class="ident" id="3212147">i</span><span class="op" id="3212148">++</span>&nbsp;<span class="op" id="3212151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212155">v</span>&nbsp;<span class="op" id="3212157">&lt;&lt;=</span>&nbsp;<span class="num" id="3212161">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212165">v</span>&nbsp;<span class="op" id="3212167">|=</span>&nbsp;<span class="ident" id="3212170">u</span>&nbsp;<span class="op" id="3212172">&amp;</span>&nbsp;<span class="num" id="3212174">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212181">u</span>&nbsp;<span class="op" id="3212183">&gt;&gt;=</span>&nbsp;<span class="num" id="3212187">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3212190">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3212193">return</span>&nbsp;<span class="ident" id="3212200">v</span><br>
<span class="lineno"></span><span class="op" id="3212202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3212205">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3212285">func</span>&nbsp;<span class="ident" id="3212290">encFloat</span><span class="op" id="3212298">(</span><span class="ident" id="3212299">i</span>&nbsp;<span class="op" id="3212301">*</span><span class="ident" id="3212302">encInstr</span><span class="op" id="3212310">,</span>&nbsp;<span class="ident" id="3212312">state</span>&nbsp;<span class="op" id="3212318">*</span><span class="ident" id="3212319">encoderState</span><span class="op" id="3212331">,</span>&nbsp;<span class="ident" id="3212333">v</span>&nbsp;<span class="ident" id="3212335">reflect</span><span class="op" id="3212342">.</span><span class="ident" id="3212343">Value</span><span class="op" id="3212348">)</span>&nbsp;<span class="op" id="3212350">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212353">f</span>&nbsp;<span class="op" id="3212355">:=</span>&nbsp;<span class="ident" id="3212358">v</span><span class="op" id="3212359">.</span><span class="ident" id="3212360">Float</span><span class="op" id="3212365">(</span><span class="op" id="3212366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3212369">if</span>&nbsp;<span class="ident" id="3212372">f</span>&nbsp;<span class="op" id="3212374">!=</span>&nbsp;<span class="num" id="3212377">0</span>&nbsp;<span class="op" id="3212379">||</span>&nbsp;<span class="ident" id="3212382">state</span><span class="op" id="3212387">.</span><span class="ident" id="3212388">sendZero</span>&nbsp;<span class="op" id="3212397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212401">bits</span>&nbsp;<span class="op" id="3212406">:=</span>&nbsp;<span class="ident" id="3212409">floatBits</span><span class="op" id="3212418">(</span><span class="ident" id="3212419">f</span><span class="op" id="3212420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212424">state</span><span class="op" id="3212429">.</span><span class="ident" id="3212430">update</span><span class="op" id="3212436">(</span><span class="ident" id="3212437">i</span><span class="op" id="3212438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212442">state</span><span class="op" id="3212447">.</span><span class="ident" id="3212448">encodeUint</span><span class="op" id="3212458">(</span><span class="ident" id="3212459">bits</span><span class="op" id="3212463">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3212466">}</span><br>
<span class="lineno"></span><span class="op" id="3212468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3212471">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="3212551">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="3212630">func</span>&nbsp;<span class="ident" id="3212635">encComplex</span><span class="op" id="3212645">(</span><span class="ident" id="3212646">i</span>&nbsp;<span class="op" id="3212648">*</span><span class="ident" id="3212649">encInstr</span><span class="op" id="3212657">,</span>&nbsp;<span class="ident" id="3212659">state</span>&nbsp;<span class="op" id="3212665">*</span><span class="ident" id="3212666">encoderState</span><span class="op" id="3212678">,</span>&nbsp;<span class="ident" id="3212680">v</span>&nbsp;<span class="ident" id="3212682">reflect</span><span class="op" id="3212689">.</span><span class="ident" id="3212690">Value</span><span class="op" id="3212695">)</span>&nbsp;<span class="op" id="3212697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212700">c</span>&nbsp;<span class="op" id="3212702">:=</span>&nbsp;<span class="ident" id="3212705">v</span><span class="op" id="3212706">.</span><span class="ident" id="3212707">Complex</span><span class="op" id="3212714">(</span><span class="op" id="3212715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3212718">if</span>&nbsp;<span class="ident" id="3212721">c</span>&nbsp;<span class="op" id="3212723">!=</span>&nbsp;<span class="num" id="3212726">0</span><span class="op" id="3212727">+</span><span class="num" id="3212728">0i</span>&nbsp;<span class="op" id="3212731">||</span>&nbsp;<span class="ident" id="3212734">state</span><span class="op" id="3212739">.</span><span class="ident" id="3212740">sendZero</span>&nbsp;<span class="op" id="3212749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212753">rpart</span>&nbsp;<span class="op" id="3212759">:=</span>&nbsp;<span class="ident" id="3212762">floatBits</span><span class="op" id="3212771">(</span><span class="builtinfunc" id="3212772">real</span><span class="op" id="3212776">(</span><span class="ident" id="3212777">c</span><span class="op" id="3212778">)</span><span class="op" id="3212779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212783">ipart</span>&nbsp;<span class="op" id="3212789">:=</span>&nbsp;<span class="ident" id="3212792">floatBits</span><span class="op" id="3212801">(</span><span class="builtinfunc" id="3212802">imag</span><span class="op" id="3212806">(</span><span class="ident" id="3212807">c</span><span class="op" id="3212808">)</span><span class="op" id="3212809">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212813">state</span><span class="op" id="3212818">.</span><span class="ident" id="3212819">update</span><span class="op" id="3212825">(</span><span class="ident" id="3212826">i</span><span class="op" id="3212827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212831">state</span><span class="op" id="3212836">.</span><span class="ident" id="3212837">encodeUint</span><span class="op" id="3212847">(</span><span class="ident" id="3212848">rpart</span><span class="op" id="3212853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3212857">state</span><span class="op" id="3212862">.</span><span class="ident" id="3212863">encodeUint</span><span class="op" id="3212873">(</span><span class="ident" id="3212874">ipart</span><span class="op" id="3212879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3212882">}</span><br>
<span class="lineno"></span><span class="op" id="3212884">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="3212887">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="3212944">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3213019">func</span>&nbsp;<span class="ident" id="3213024">encUint8Array</span><span class="op" id="3213037">(</span><span class="ident" id="3213038">i</span>&nbsp;<span class="op" id="3213040">*</span><span class="ident" id="3213041">encInstr</span><span class="op" id="3213049">,</span>&nbsp;<span class="ident" id="3213051">state</span>&nbsp;<span class="op" id="3213057">*</span><span class="ident" id="3213058">encoderState</span><span class="op" id="3213070">,</span>&nbsp;<span class="ident" id="3213072">v</span>&nbsp;<span class="ident" id="3213074">reflect</span><span class="op" id="3213081">.</span><span class="ident" id="3213082">Value</span><span class="op" id="3213087">)</span>&nbsp;<span class="op" id="3213089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3213092">b</span>&nbsp;<span class="op" id="3213094">:=</span>&nbsp;<span class="ident" id="3213097">v</span><span class="op" id="3213098">.</span><span class="ident" id="3213099">Bytes</span><span class="op" id="3213104">(</span><span class="op" id="3213105">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3213108">if</span>&nbsp;<span class="builtinfunc" id="3213111">len</span><span class="op" id="3213114">(</span><span class="ident" id="3213115">b</span><span class="op" id="3213116">)</span>&nbsp;<span class="op" id="3213118">&gt;</span>&nbsp;<span class="num" id="3213120">0</span>&nbsp;<span class="op" id="3213122">||</span>&nbsp;<span class="ident" id="3213125">state</span><span class="op" id="3213130">.</span><span class="ident" id="3213131">sendZero</span>&nbsp;<span class="op" id="3213140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3213144">state</span><span class="op" id="3213149">.</span><span class="ident" id="3213150">update</span><span class="op" id="3213156">(</span><span class="ident" id="3213157">i</span><span class="op" id="3213158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3213162">state</span><span class="op" id="3213167">.</span><span class="ident" id="3213168">encodeUint</span><span class="op" id="3213178">(</span><span class="ident" id="3213179">uint64</span><span class="op" id="3213185">(</span><span class="builtinfunc" id="3213186">len</span><span class="op" id="3213189">(</span><span class="ident" id="3213190">b</span><span class="op" id="3213191">)</span><span class="op" id="3213192">)</span><span class="op" id="3213193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3213197">state</span><span class="op" id="3213202">.</span><span class="ident" id="3213203">b</span><span class="op" id="3213204">.</span><span class="ident" id="3213205">Write</span><span class="op" id="3213210">(</span><span class="ident" id="3213211">b</span><span class="op" id="3213212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3213215">}</span><br>
<span class="lineno">240</span><span class="op" id="3213217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3213220">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="3213269">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3213340">func</span>&nbsp;<span class="ident" id="3213345">encString</span><span class="op" id="3213354">(</span><span class="ident" id="3213355">i</span>&nbsp;<span class="op" id="3213357">*</span><span class="ident" id="3213358">encInstr</span><span class="op" id="3213366">,</span>&nbsp;<span class="ident" id="3213368">state</span>&nbsp;<span class="op" id="3213374">*</span><span class="ident" id="3213375">encoderState</span><span class="op" id="3213387">,</span>&nbsp;<span class="ident" id="3213389">v</span>&nbsp;<span class="ident" id="3213391">reflect</span><span class="op" id="3213398">.</span><span class="ident" id="3213399">Value</span><span class="op" id="3213404">)</span>&nbsp;<span class="op" id="3213406">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3213409">s</span>&nbsp;<span class="op" id="3213411">:=</span>&nbsp;<span class="ident" id="3213414">v</span><span class="op" id="3213415">.</span><span class="ident" id="3213416">String</span><span class="op" id="3213422">(</span><span class="op" id="3213423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3213426">if</span>&nbsp;<span class="builtinfunc" id="3213429">len</span><span class="op" id="3213432">(</span><span class="ident" id="3213433">s</span><span class="op" id="3213434">)</span>&nbsp;<span class="op" id="3213436">&gt;</span>&nbsp;<span class="num" id="3213438">0</span>&nbsp;<span class="op" id="3213440">||</span>&nbsp;<span class="ident" id="3213443">state</span><span class="op" id="3213448">.</span><span class="ident" id="3213449">sendZero</span>&nbsp;<span class="op" id="3213458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3213462">state</span><span class="op" id="3213467">.</span><span class="ident" id="3213468">update</span><span class="op" id="3213474">(</span><span class="ident" id="3213475">i</span><span class="op" id="3213476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3213480">state</span><span class="op" id="3213485">.</span><span class="ident" id="3213486">encodeUint</span><span class="op" id="3213496">(</span><span class="ident" id="3213497">uint64</span><span class="op" id="3213503">(</span><span class="builtinfunc" id="3213504">len</span><span class="op" id="3213507">(</span><span class="ident" id="3213508">s</span><span class="op" id="3213509">)</span><span class="op" id="3213510">)</span><span class="op" id="3213511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3213515">state</span><span class="op" id="3213520">.</span><span class="ident" id="3213521">b</span><span class="op" id="3213522">.</span><span class="ident" id="3213523">WriteString</span><span class="op" id="3213534">(</span><span class="ident" id="3213535">s</span><span class="op" id="3213536">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3213539">}</span><br>
<span class="lineno"></span><span class="op" id="3213541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3213544">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="3213604">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="3213635">func</span>&nbsp;<span class="ident" id="3213640">encStructTerminator</span><span class="op" id="3213659">(</span><span class="ident" id="3213660">i</span>&nbsp;<span class="op" id="3213662">*</span><span class="ident" id="3213663">encInstr</span><span class="op" id="3213671">,</span>&nbsp;<span class="ident" id="3213673">state</span>&nbsp;<span class="op" id="3213679">*</span><span class="ident" id="3213680">encoderState</span><span class="op" id="3213692">,</span>&nbsp;<span class="ident" id="3213694">v</span>&nbsp;<span class="ident" id="3213696">reflect</span><span class="op" id="3213703">.</span><span class="ident" id="3213704">Value</span><span class="op" id="3213709">)</span>&nbsp;<span class="op" id="3213711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3213714">state</span><span class="op" id="3213719">.</span><span class="ident" id="3213720">encodeUint</span><span class="op" id="3213730">(</span><span class="num" id="3213731">0</span><span class="op" id="3213732">)</span><br>
<span class="lineno"></span><span class="op" id="3213734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3213737">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="3213758">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="3213836">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="3213916">type</span>&nbsp;<span class="ident" id="3213921">encEngine</span>&nbsp;<span class="keyword" id="3213931">struct</span>&nbsp;<span class="op" id="3213938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3213941">instr</span>&nbsp;<span class="op" id="3213947">[</span><span class="op" id="3213948">]</span><span class="ident" id="3213949">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="3213958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3213961">const</span>&nbsp;<span class="ident" id="3213967">singletonField</span>&nbsp;<span class="op" id="3213982">=</span>&nbsp;<span class="num" id="3213984">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3213987">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="3214054">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="3214108">func</span>&nbsp;<span class="ident" id="3214113">valid</span><span class="op" id="3214118">(</span><span class="ident" id="3214119">v</span>&nbsp;<span class="ident" id="3214121">reflect</span><span class="op" id="3214128">.</span><span class="ident" id="3214129">Value</span><span class="op" id="3214134">)</span>&nbsp;<span class="builtintype" id="3214136">bool</span>&nbsp;<span class="op" id="3214141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214144">switch</span>&nbsp;<span class="ident" id="3214151">v</span><span class="op" id="3214152">.</span><span class="ident" id="3214153">Kind</span><span class="op" id="3214157">(</span><span class="op" id="3214158">)</span>&nbsp;<span class="op" id="3214160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214163">case</span>&nbsp;<span class="ident" id="3214168">reflect</span><span class="op" id="3214175">.</span><span class="ident" id="3214176">Invalid</span><span class="op" id="3214183">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214187">return</span>&nbsp;<span class="ident" id="3214194">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214201">case</span>&nbsp;<span class="ident" id="3214206">reflect</span><span class="op" id="3214213">.</span><span class="ident" id="3214214">Ptr</span><span class="op" id="3214217">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214221">return</span>&nbsp;<span class="op" id="3214228">!</span><span class="ident" id="3214229">v</span><span class="op" id="3214230">.</span><span class="ident" id="3214231">IsNil</span><span class="op" id="3214236">(</span><span class="op" id="3214237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3214240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214243">return</span>&nbsp;<span class="ident" id="3214250">true</span><br>
<span class="lineno"></span><span class="op" id="3214255">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3214258">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3214319">func</span>&nbsp;<span class="op" id="3214324">(</span><span class="ident" id="3214325">enc</span>&nbsp;<span class="op" id="3214329">*</span><span class="ident" id="3214330">Encoder</span><span class="op" id="3214337">)</span>&nbsp;<span class="ident" id="3214339">encodeSingle</span><span class="op" id="3214351">(</span><span class="ident" id="3214352">b</span>&nbsp;<span class="op" id="3214354">*</span><span class="ident" id="3214355">encBuffer</span><span class="op" id="3214364">,</span>&nbsp;<span class="ident" id="3214366">engine</span>&nbsp;<span class="op" id="3214373">*</span><span class="ident" id="3214374">encEngine</span><span class="op" id="3214383">,</span>&nbsp;<span class="ident" id="3214385">value</span>&nbsp;<span class="ident" id="3214391">reflect</span><span class="op" id="3214398">.</span><span class="ident" id="3214399">Value</span><span class="op" id="3214404">)</span>&nbsp;<span class="op" id="3214406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3214409">state</span>&nbsp;<span class="op" id="3214415">:=</span>&nbsp;<span class="ident" id="3214418">enc</span><span class="op" id="3214421">.</span><span class="ident" id="3214422">newEncoderState</span><span class="op" id="3214437">(</span><span class="ident" id="3214438">b</span><span class="op" id="3214439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214442">defer</span>&nbsp;<span class="ident" id="3214448">enc</span><span class="op" id="3214451">.</span><span class="ident" id="3214452">freeEncoderState</span><span class="op" id="3214468">(</span><span class="ident" id="3214469">state</span><span class="op" id="3214474">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3214477">state</span><span class="op" id="3214482">.</span><span class="ident" id="3214483">fieldnum</span>&nbsp;<span class="op" id="3214492">=</span>&nbsp;<span class="ident" id="3214494">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3214510">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3214583">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3214654">state</span><span class="op" id="3214659">.</span><span class="ident" id="3214660">sendZero</span>&nbsp;<span class="op" id="3214669">=</span>&nbsp;<span class="ident" id="3214671">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3214677">instr</span>&nbsp;<span class="op" id="3214683">:=</span>&nbsp;<span class="op" id="3214686">&amp;</span><span class="ident" id="3214687">engine</span><span class="op" id="3214693">.</span><span class="ident" id="3214694">instr</span><span class="op" id="3214699">[</span><span class="ident" id="3214700">singletonField</span><span class="op" id="3214714">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214717">if</span>&nbsp;<span class="ident" id="3214720">instr</span><span class="op" id="3214725">.</span><span class="ident" id="3214726">indir</span>&nbsp;<span class="op" id="3214732">&gt;</span>&nbsp;<span class="num" id="3214734">0</span>&nbsp;<span class="op" id="3214736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3214740">value</span>&nbsp;<span class="op" id="3214746">=</span>&nbsp;<span class="ident" id="3214748">encIndirect</span><span class="op" id="3214759">(</span><span class="ident" id="3214760">value</span><span class="op" id="3214765">,</span>&nbsp;<span class="ident" id="3214767">instr</span><span class="op" id="3214772">.</span><span class="ident" id="3214773">indir</span><span class="op" id="3214778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3214781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214784">if</span>&nbsp;<span class="ident" id="3214787">valid</span><span class="op" id="3214792">(</span><span class="ident" id="3214793">value</span><span class="op" id="3214798">)</span>&nbsp;<span class="op" id="3214800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3214804">instr</span><span class="op" id="3214809">.</span><span class="ident" id="3214810">op</span><span class="op" id="3214812">(</span><span class="ident" id="3214813">instr</span><span class="op" id="3214818">,</span>&nbsp;<span class="ident" id="3214820">state</span><span class="op" id="3214825">,</span>&nbsp;<span class="ident" id="3214827">value</span><span class="op" id="3214832">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3214835">}</span><br>
<span class="lineno"></span><span class="op" id="3214837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3214840">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3214887">func</span>&nbsp;<span class="op" id="3214892">(</span><span class="ident" id="3214893">enc</span>&nbsp;<span class="op" id="3214897">*</span><span class="ident" id="3214898">Encoder</span><span class="op" id="3214905">)</span>&nbsp;<span class="ident" id="3214907">encodeStruct</span><span class="op" id="3214919">(</span><span class="ident" id="3214920">b</span>&nbsp;<span class="op" id="3214922">*</span><span class="ident" id="3214923">encBuffer</span><span class="op" id="3214932">,</span>&nbsp;<span class="ident" id="3214934">engine</span>&nbsp;<span class="op" id="3214941">*</span><span class="ident" id="3214942">encEngine</span><span class="op" id="3214951">,</span>&nbsp;<span class="ident" id="3214953">value</span>&nbsp;<span class="ident" id="3214959">reflect</span><span class="op" id="3214966">.</span><span class="ident" id="3214967">Value</span><span class="op" id="3214972">)</span>&nbsp;<span class="op" id="3214974">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214977">if</span>&nbsp;<span class="op" id="3214980">!</span><span class="ident" id="3214981">valid</span><span class="op" id="3214986">(</span><span class="ident" id="3214987">value</span><span class="op" id="3214992">)</span>&nbsp;<span class="op" id="3214994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214998">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3215006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215009">state</span>&nbsp;<span class="op" id="3215015">:=</span>&nbsp;<span class="ident" id="3215018">enc</span><span class="op" id="3215021">.</span><span class="ident" id="3215022">newEncoderState</span><span class="op" id="3215037">(</span><span class="ident" id="3215038">b</span><span class="op" id="3215039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215042">defer</span>&nbsp;<span class="ident" id="3215048">enc</span><span class="op" id="3215051">.</span><span class="ident" id="3215052">freeEncoderState</span><span class="op" id="3215068">(</span><span class="ident" id="3215069">state</span><span class="op" id="3215074">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215077">state</span><span class="op" id="3215082">.</span><span class="ident" id="3215083">fieldnum</span>&nbsp;<span class="op" id="3215092">=</span>&nbsp;<span class="op" id="3215094">-</span><span class="num" id="3215095">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215098">for</span>&nbsp;<span class="ident" id="3215102">i</span>&nbsp;<span class="op" id="3215104">:=</span>&nbsp;<span class="num" id="3215107">0</span><span class="op" id="3215108">;</span>&nbsp;<span class="ident" id="3215110">i</span>&nbsp;<span class="op" id="3215112">&lt;</span>&nbsp;<span class="builtinfunc" id="3215114">len</span><span class="op" id="3215117">(</span><span class="ident" id="3215118">engine</span><span class="op" id="3215124">.</span><span class="ident" id="3215125">instr</span><span class="op" id="3215130">)</span><span class="op" id="3215131">;</span>&nbsp;<span class="ident" id="3215133">i</span><span class="op" id="3215134">++</span>&nbsp;<span class="op" id="3215137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215141">instr</span>&nbsp;<span class="op" id="3215147">:=</span>&nbsp;<span class="op" id="3215150">&amp;</span><span class="ident" id="3215151">engine</span><span class="op" id="3215157">.</span><span class="ident" id="3215158">instr</span><span class="op" id="3215163">[</span><span class="ident" id="3215164">i</span><span class="op" id="3215165">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215169">if</span>&nbsp;<span class="ident" id="3215172">i</span>&nbsp;<span class="op" id="3215174">&gt;=</span>&nbsp;<span class="ident" id="3215177">value</span><span class="op" id="3215182">.</span><span class="ident" id="3215183">NumField</span><span class="op" id="3215191">(</span><span class="op" id="3215192">)</span>&nbsp;<span class="op" id="3215194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3215199">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215225">instr</span><span class="op" id="3215230">.</span><span class="ident" id="3215231">op</span><span class="op" id="3215233">(</span><span class="ident" id="3215234">instr</span><span class="op" id="3215239">,</span>&nbsp;<span class="ident" id="3215241">state</span><span class="op" id="3215246">,</span>&nbsp;<span class="ident" id="3215248">reflect</span><span class="op" id="3215255">.</span><span class="ident" id="3215256">Value</span><span class="op" id="3215261">{</span><span class="op" id="3215262">}</span><span class="op" id="3215263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215268">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3215276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215280">field</span>&nbsp;<span class="op" id="3215286">:=</span>&nbsp;<span class="ident" id="3215289">value</span><span class="op" id="3215294">.</span><span class="ident" id="3215295">FieldByIndex</span><span class="op" id="3215307">(</span><span class="ident" id="3215308">instr</span><span class="op" id="3215313">.</span><span class="ident" id="3215314">index</span><span class="op" id="3215319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215323">if</span>&nbsp;<span class="ident" id="3215326">instr</span><span class="op" id="3215331">.</span><span class="ident" id="3215332">indir</span>&nbsp;<span class="op" id="3215338">&gt;</span>&nbsp;<span class="num" id="3215340">0</span>&nbsp;<span class="op" id="3215342">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215347">field</span>&nbsp;<span class="op" id="3215353">=</span>&nbsp;<span class="ident" id="3215355">encIndirect</span><span class="op" id="3215366">(</span><span class="ident" id="3215367">field</span><span class="op" id="3215372">,</span>&nbsp;<span class="ident" id="3215374">instr</span><span class="op" id="3215379">.</span><span class="ident" id="3215380">indir</span><span class="op" id="3215385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3215390">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215462">if</span>&nbsp;<span class="op" id="3215465">!</span><span class="ident" id="3215466">valid</span><span class="op" id="3215471">(</span><span class="ident" id="3215472">field</span><span class="op" id="3215477">)</span>&nbsp;<span class="op" id="3215479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215485">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3215497">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3215501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215505">instr</span><span class="op" id="3215510">.</span><span class="ident" id="3215511">op</span><span class="op" id="3215513">(</span><span class="ident" id="3215514">instr</span><span class="op" id="3215519">,</span>&nbsp;<span class="ident" id="3215521">state</span><span class="op" id="3215526">,</span>&nbsp;<span class="ident" id="3215528">field</span><span class="op" id="3215533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3215536">}</span><br>
<span class="lineno"></span><span class="op" id="3215538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="3215541">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="3215574">func</span>&nbsp;<span class="op" id="3215579">(</span><span class="ident" id="3215580">enc</span>&nbsp;<span class="op" id="3215584">*</span><span class="ident" id="3215585">Encoder</span><span class="op" id="3215592">)</span>&nbsp;<span class="ident" id="3215594">encodeArray</span><span class="op" id="3215605">(</span><span class="ident" id="3215606">b</span>&nbsp;<span class="op" id="3215608">*</span><span class="ident" id="3215609">encBuffer</span><span class="op" id="3215618">,</span>&nbsp;<span class="ident" id="3215620">value</span>&nbsp;<span class="ident" id="3215626">reflect</span><span class="op" id="3215633">.</span><span class="ident" id="3215634">Value</span><span class="op" id="3215639">,</span>&nbsp;<span class="ident" id="3215641">op</span>&nbsp;<span class="ident" id="3215644">encOp</span><span class="op" id="3215649">,</span>&nbsp;<span class="ident" id="3215651">elemIndir</span>&nbsp;<span class="builtintype" id="3215661">int</span><span class="op" id="3215664">,</span>&nbsp;<span class="ident" id="3215666">length</span>&nbsp;<span class="builtintype" id="3215673">int</span><span class="op" id="3215676">,</span>&nbsp;<span class="ident" id="3215678">helper</span>&nbsp;<span class="ident" id="3215685">encHelper</span><span class="op" id="3215694">)</span>&nbsp;<span class="op" id="3215696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215699">state</span>&nbsp;<span class="op" id="3215705">:=</span>&nbsp;<span class="ident" id="3215708">enc</span><span class="op" id="3215711">.</span><span class="ident" id="3215712">newEncoderState</span><span class="op" id="3215727">(</span><span class="ident" id="3215728">b</span><span class="op" id="3215729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215732">defer</span>&nbsp;<span class="ident" id="3215738">enc</span><span class="op" id="3215741">.</span><span class="ident" id="3215742">freeEncoderState</span><span class="op" id="3215758">(</span><span class="ident" id="3215759">state</span><span class="op" id="3215764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215767">state</span><span class="op" id="3215772">.</span><span class="ident" id="3215773">fieldnum</span>&nbsp;<span class="op" id="3215782">=</span>&nbsp;<span class="op" id="3215784">-</span><span class="num" id="3215785">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215788">state</span><span class="op" id="3215793">.</span><span class="ident" id="3215794">sendZero</span>&nbsp;<span class="op" id="3215803">=</span>&nbsp;<span class="ident" id="3215805">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215811">state</span><span class="op" id="3215816">.</span><span class="ident" id="3215817">encodeUint</span><span class="op" id="3215827">(</span><span class="ident" id="3215828">uint64</span><span class="op" id="3215834">(</span><span class="ident" id="3215835">length</span><span class="op" id="3215841">)</span><span class="op" id="3215842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215845">if</span>&nbsp;<span class="ident" id="3215848">helper</span>&nbsp;<span class="op" id="3215855">!=</span>&nbsp;<span class="ident" id="3215858">nil</span>&nbsp;<span class="op" id="3215862">&amp;&amp;</span>&nbsp;<span class="ident" id="3215865">helper</span><span class="op" id="3215871">(</span><span class="ident" id="3215872">state</span><span class="op" id="3215877">,</span>&nbsp;<span class="ident" id="3215879">value</span><span class="op" id="3215884">)</span>&nbsp;<span class="op" id="3215886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215890">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3215898">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215901">for</span>&nbsp;<span class="ident" id="3215905">i</span>&nbsp;<span class="op" id="3215907">:=</span>&nbsp;<span class="num" id="3215910">0</span><span class="op" id="3215911">;</span>&nbsp;<span class="ident" id="3215913">i</span>&nbsp;<span class="op" id="3215915">&lt;</span>&nbsp;<span class="ident" id="3215917">length</span><span class="op" id="3215923">;</span>&nbsp;<span class="ident" id="3215925">i</span><span class="op" id="3215926">++</span>&nbsp;<span class="op" id="3215929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215933">elem</span>&nbsp;<span class="op" id="3215938">:=</span>&nbsp;<span class="ident" id="3215941">value</span><span class="op" id="3215946">.</span><span class="ident" id="3215947">Index</span><span class="op" id="3215952">(</span><span class="ident" id="3215953">i</span><span class="op" id="3215954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215958">if</span>&nbsp;<span class="ident" id="3215961">elemIndir</span>&nbsp;<span class="op" id="3215971">&gt;</span>&nbsp;<span class="num" id="3215973">0</span>&nbsp;<span class="op" id="3215975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215980">elem</span>&nbsp;<span class="op" id="3215985">=</span>&nbsp;<span class="ident" id="3215987">encIndirect</span><span class="op" id="3215998">(</span><span class="ident" id="3215999">elem</span><span class="op" id="3216003">,</span>&nbsp;<span class="ident" id="3216005">elemIndir</span><span class="op" id="3216014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3216019">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3216090">if</span>&nbsp;<span class="op" id="3216093">!</span><span class="ident" id="3216094">valid</span><span class="op" id="3216099">(</span><span class="ident" id="3216100">elem</span><span class="op" id="3216104">)</span>&nbsp;<span class="op" id="3216106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216112">errorf</span><span class="op" id="3216118">(</span><span class="string" id="3216119">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="3216145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3216150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3216154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216158">op</span><span class="op" id="3216160">(</span><span class="ident" id="3216161">nil</span><span class="op" id="3216164">,</span>&nbsp;<span class="ident" id="3216166">state</span><span class="op" id="3216171">,</span>&nbsp;<span class="ident" id="3216173">elem</span><span class="op" id="3216177">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3216180">}</span><br>
<span class="lineno"></span><span class="op" id="3216182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3216185">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3216253">func</span>&nbsp;<span class="ident" id="3216258">encodeReflectValue</span><span class="op" id="3216276">(</span><span class="ident" id="3216277">state</span>&nbsp;<span class="op" id="3216283">*</span><span class="ident" id="3216284">encoderState</span><span class="op" id="3216296">,</span>&nbsp;<span class="ident" id="3216298">v</span>&nbsp;<span class="ident" id="3216300">reflect</span><span class="op" id="3216307">.</span><span class="ident" id="3216308">Value</span><span class="op" id="3216313">,</span>&nbsp;<span class="ident" id="3216315">op</span>&nbsp;<span class="ident" id="3216318">encOp</span><span class="op" id="3216323">,</span>&nbsp;<span class="ident" id="3216325">indir</span>&nbsp;<span class="builtintype" id="3216331">int</span><span class="op" id="3216334">)</span>&nbsp;<span class="op" id="3216336">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3216339">for</span>&nbsp;<span class="ident" id="3216343">i</span>&nbsp;<span class="op" id="3216345">:=</span>&nbsp;<span class="num" id="3216348">0</span><span class="op" id="3216349">;</span>&nbsp;<span class="ident" id="3216351">i</span>&nbsp;<span class="op" id="3216353">&lt;</span>&nbsp;<span class="ident" id="3216355">indir</span>&nbsp;<span class="op" id="3216361">&amp;&amp;</span>&nbsp;<span class="ident" id="3216364">v</span><span class="op" id="3216365">.</span><span class="ident" id="3216366">IsValid</span><span class="op" id="3216373">(</span><span class="op" id="3216374">)</span><span class="op" id="3216375">;</span>&nbsp;<span class="ident" id="3216377">i</span><span class="op" id="3216378">++</span>&nbsp;<span class="op" id="3216381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216385">v</span>&nbsp;<span class="op" id="3216387">=</span>&nbsp;<span class="ident" id="3216389">reflect</span><span class="op" id="3216396">.</span><span class="ident" id="3216397">Indirect</span><span class="op" id="3216405">(</span><span class="ident" id="3216406">v</span><span class="op" id="3216407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3216410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3216413">if</span>&nbsp;<span class="op" id="3216416">!</span><span class="ident" id="3216417">v</span><span class="op" id="3216418">.</span><span class="ident" id="3216419">IsValid</span><span class="op" id="3216426">(</span><span class="op" id="3216427">)</span>&nbsp;<span class="op" id="3216429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216433">errorf</span><span class="op" id="3216439">(</span><span class="string" id="3216440">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="3216473">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3216476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216479">op</span><span class="op" id="3216481">(</span><span class="ident" id="3216482">nil</span><span class="op" id="3216485">,</span>&nbsp;<span class="ident" id="3216487">state</span><span class="op" id="3216492">,</span>&nbsp;<span class="ident" id="3216494">v</span><span class="op" id="3216495">)</span><br>
<span class="lineno"></span><span class="op" id="3216497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3216500">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="3216574">func</span>&nbsp;<span class="op" id="3216579">(</span><span class="ident" id="3216580">enc</span>&nbsp;<span class="op" id="3216584">*</span><span class="ident" id="3216585">Encoder</span><span class="op" id="3216592">)</span>&nbsp;<span class="ident" id="3216594">encodeMap</span><span class="op" id="3216603">(</span><span class="ident" id="3216604">b</span>&nbsp;<span class="op" id="3216606">*</span><span class="ident" id="3216607">encBuffer</span><span class="op" id="3216616">,</span>&nbsp;<span class="ident" id="3216618">mv</span>&nbsp;<span class="ident" id="3216621">reflect</span><span class="op" id="3216628">.</span><span class="ident" id="3216629">Value</span><span class="op" id="3216634">,</span>&nbsp;<span class="ident" id="3216636">keyOp</span><span class="op" id="3216641">,</span>&nbsp;<span class="ident" id="3216643">elemOp</span>&nbsp;<span class="ident" id="3216650">encOp</span><span class="op" id="3216655">,</span>&nbsp;<span class="ident" id="3216657">keyIndir</span><span class="op" id="3216665">,</span>&nbsp;<span class="ident" id="3216667">elemIndir</span>&nbsp;<span class="builtintype" id="3216677">int</span><span class="op" id="3216680">)</span>&nbsp;<span class="op" id="3216682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216685">state</span>&nbsp;<span class="op" id="3216691">:=</span>&nbsp;<span class="ident" id="3216694">enc</span><span class="op" id="3216697">.</span><span class="ident" id="3216698">newEncoderState</span><span class="op" id="3216713">(</span><span class="ident" id="3216714">b</span><span class="op" id="3216715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216718">state</span><span class="op" id="3216723">.</span><span class="ident" id="3216724">fieldnum</span>&nbsp;<span class="op" id="3216733">=</span>&nbsp;<span class="op" id="3216735">-</span><span class="num" id="3216736">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216739">state</span><span class="op" id="3216744">.</span><span class="ident" id="3216745">sendZero</span>&nbsp;<span class="op" id="3216754">=</span>&nbsp;<span class="ident" id="3216756">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216762">keys</span>&nbsp;<span class="op" id="3216767">:=</span>&nbsp;<span class="ident" id="3216770">mv</span><span class="op" id="3216772">.</span><span class="ident" id="3216773">MapKeys</span><span class="op" id="3216780">(</span><span class="op" id="3216781">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216784">state</span><span class="op" id="3216789">.</span><span class="ident" id="3216790">encodeUint</span><span class="op" id="3216800">(</span><span class="ident" id="3216801">uint64</span><span class="op" id="3216807">(</span><span class="builtinfunc" id="3216808">len</span><span class="op" id="3216811">(</span><span class="ident" id="3216812">keys</span><span class="op" id="3216816">)</span><span class="op" id="3216817">)</span><span class="op" id="3216818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3216821">for</span>&nbsp;<span class="ident" id="3216825">_</span><span class="op" id="3216826">,</span>&nbsp;<span class="ident" id="3216828">key</span>&nbsp;<span class="op" id="3216832">:=</span>&nbsp;<span class="keyword" id="3216835">range</span>&nbsp;<span class="ident" id="3216841">keys</span>&nbsp;<span class="op" id="3216846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216850">encodeReflectValue</span><span class="op" id="3216868">(</span><span class="ident" id="3216869">state</span><span class="op" id="3216874">,</span>&nbsp;<span class="ident" id="3216876">key</span><span class="op" id="3216879">,</span>&nbsp;<span class="ident" id="3216881">keyOp</span><span class="op" id="3216886">,</span>&nbsp;<span class="ident" id="3216888">keyIndir</span><span class="op" id="3216896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216900">encodeReflectValue</span><span class="op" id="3216918">(</span><span class="ident" id="3216919">state</span><span class="op" id="3216924">,</span>&nbsp;<span class="ident" id="3216926">mv</span><span class="op" id="3216928">.</span><span class="ident" id="3216929">MapIndex</span><span class="op" id="3216937">(</span><span class="ident" id="3216938">key</span><span class="op" id="3216941">)</span><span class="op" id="3216942">,</span>&nbsp;<span class="ident" id="3216944">elemOp</span><span class="op" id="3216950">,</span>&nbsp;<span class="ident" id="3216952">elemIndir</span><span class="op" id="3216961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3216964">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216967">enc</span><span class="op" id="3216970">.</span><span class="ident" id="3216971">freeEncoderState</span><span class="op" id="3216987">(</span><span class="ident" id="3216988">state</span><span class="op" id="3216993">)</span><br>
<span class="lineno"></span><span class="op" id="3216995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3216998">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="3217049">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="3217131">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="3217218">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="3217301">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3217326">func</span>&nbsp;<span class="op" id="3217331">(</span><span class="ident" id="3217332">enc</span>&nbsp;<span class="op" id="3217336">*</span><span class="ident" id="3217337">Encoder</span><span class="op" id="3217344">)</span>&nbsp;<span class="ident" id="3217346">encodeInterface</span><span class="op" id="3217361">(</span><span class="ident" id="3217362">b</span>&nbsp;<span class="op" id="3217364">*</span><span class="ident" id="3217365">encBuffer</span><span class="op" id="3217374">,</span>&nbsp;<span class="ident" id="3217376">iv</span>&nbsp;<span class="ident" id="3217379">reflect</span><span class="op" id="3217386">.</span><span class="ident" id="3217387">Value</span><span class="op" id="3217392">)</span>&nbsp;<span class="op" id="3217394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3217397">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3217462">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217533">elem</span>&nbsp;<span class="op" id="3217538">:=</span>&nbsp;<span class="ident" id="3217541">iv</span><span class="op" id="3217543">.</span><span class="ident" id="3217544">Elem</span><span class="op" id="3217548">(</span><span class="op" id="3217549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217552">if</span>&nbsp;<span class="ident" id="3217555">elem</span><span class="op" id="3217559">.</span><span class="ident" id="3217560">Kind</span><span class="op" id="3217564">(</span><span class="op" id="3217565">)</span>&nbsp;<span class="op" id="3217567">==</span>&nbsp;<span class="ident" id="3217570">reflect</span><span class="op" id="3217577">.</span><span class="ident" id="3217578">Ptr</span>&nbsp;<span class="op" id="3217582">&amp;&amp;</span>&nbsp;<span class="ident" id="3217585">elem</span><span class="op" id="3217589">.</span><span class="ident" id="3217590">IsNil</span><span class="op" id="3217595">(</span><span class="op" id="3217596">)</span>&nbsp;<span class="op" id="3217598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217602">errorf</span><span class="op" id="3217608">(</span><span class="string" id="3217609">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="3217669">,</span>&nbsp;<span class="ident" id="3217671">iv</span><span class="op" id="3217673">.</span><span class="ident" id="3217674">Elem</span><span class="op" id="3217678">(</span><span class="op" id="3217679">)</span><span class="op" id="3217680">.</span><span class="ident" id="3217681">Type</span><span class="op" id="3217685">(</span><span class="op" id="3217686">)</span><span class="op" id="3217687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3217690">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217693">state</span>&nbsp;<span class="op" id="3217699">:=</span>&nbsp;<span class="ident" id="3217702">enc</span><span class="op" id="3217705">.</span><span class="ident" id="3217706">newEncoderState</span><span class="op" id="3217721">(</span><span class="ident" id="3217722">b</span><span class="op" id="3217723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217726">state</span><span class="op" id="3217731">.</span><span class="ident" id="3217732">fieldnum</span>&nbsp;<span class="op" id="3217741">=</span>&nbsp;<span class="op" id="3217743">-</span><span class="num" id="3217744">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217747">state</span><span class="op" id="3217752">.</span><span class="ident" id="3217753">sendZero</span>&nbsp;<span class="op" id="3217762">=</span>&nbsp;<span class="ident" id="3217764">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217770">if</span>&nbsp;<span class="ident" id="3217773">iv</span><span class="op" id="3217775">.</span><span class="ident" id="3217776">IsNil</span><span class="op" id="3217781">(</span><span class="op" id="3217782">)</span>&nbsp;<span class="op" id="3217784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217788">state</span><span class="op" id="3217793">.</span><span class="ident" id="3217794">encodeUint</span><span class="op" id="3217804">(</span><span class="num" id="3217805">0</span><span class="op" id="3217806">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217810">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3217818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217822">ut</span>&nbsp;<span class="op" id="3217825">:=</span>&nbsp;<span class="ident" id="3217828">userType</span><span class="op" id="3217836">(</span><span class="ident" id="3217837">iv</span><span class="op" id="3217839">.</span><span class="ident" id="3217840">Elem</span><span class="op" id="3217844">(</span><span class="op" id="3217845">)</span><span class="op" id="3217846">.</span><span class="ident" id="3217847">Type</span><span class="op" id="3217851">(</span><span class="op" id="3217852">)</span><span class="op" id="3217853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217856">registerLock</span><span class="op" id="3217868">.</span><span class="ident" id="3217869">RLock</span><span class="op" id="3217874">(</span><span class="op" id="3217875">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217878">name</span><span class="op" id="3217882">,</span>&nbsp;<span class="ident" id="3217884">ok</span>&nbsp;<span class="op" id="3217887">:=</span>&nbsp;<span class="ident" id="3217890">concreteTypeToName</span><span class="op" id="3217908">[</span><span class="ident" id="3217909">ut</span><span class="op" id="3217911">.</span><span class="ident" id="3217912">base</span><span class="op" id="3217916">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217919">registerLock</span><span class="op" id="3217931">.</span><span class="ident" id="3217932">RUnlock</span><span class="op" id="3217939">(</span><span class="op" id="3217940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217943">if</span>&nbsp;<span class="op" id="3217946">!</span><span class="ident" id="3217947">ok</span>&nbsp;<span class="op" id="3217950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217954">errorf</span><span class="op" id="3217960">(</span><span class="string" id="3217961">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="3218000">,</span>&nbsp;<span class="ident" id="3218002">ut</span><span class="op" id="3218004">.</span><span class="ident" id="3218005">base</span><span class="op" id="3218009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3218012">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218015">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218034">state</span><span class="op" id="3218039">.</span><span class="ident" id="3218040">encodeUint</span><span class="op" id="3218050">(</span><span class="ident" id="3218051">uint64</span><span class="op" id="3218057">(</span><span class="builtinfunc" id="3218058">len</span><span class="op" id="3218061">(</span><span class="ident" id="3218062">name</span><span class="op" id="3218066">)</span><span class="op" id="3218067">)</span><span class="op" id="3218068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218071">state</span><span class="op" id="3218076">.</span><span class="ident" id="3218077">b</span><span class="op" id="3218078">.</span><span class="ident" id="3218079">WriteString</span><span class="op" id="3218090">(</span><span class="ident" id="3218091">name</span><span class="op" id="3218095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218098">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218135">enc</span><span class="op" id="3218138">.</span><span class="ident" id="3218139">sendTypeDescriptor</span><span class="op" id="3218157">(</span><span class="ident" id="3218158">enc</span><span class="op" id="3218161">.</span><span class="ident" id="3218162">writer</span><span class="op" id="3218168">(</span><span class="op" id="3218169">)</span><span class="op" id="3218170">,</span>&nbsp;<span class="ident" id="3218172">state</span><span class="op" id="3218177">,</span>&nbsp;<span class="ident" id="3218179">ut</span><span class="op" id="3218181">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218184">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218206">enc</span><span class="op" id="3218209">.</span><span class="ident" id="3218210">sendTypeId</span><span class="op" id="3218220">(</span><span class="ident" id="3218221">state</span><span class="op" id="3218226">,</span>&nbsp;<span class="ident" id="3218228">ut</span><span class="op" id="3218230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218233">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218302">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218356">enc</span><span class="op" id="3218359">.</span><span class="ident" id="3218360">pushWriter</span><span class="op" id="3218370">(</span><span class="ident" id="3218371">b</span><span class="op" id="3218372">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218375">data</span>&nbsp;<span class="op" id="3218380">:=</span>&nbsp;<span class="builtinfunc" id="3218383">new</span><span class="op" id="3218386">(</span><span class="ident" id="3218387">encBuffer</span><span class="op" id="3218396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218399">data</span><span class="op" id="3218403">.</span><span class="ident" id="3218404">Write</span><span class="op" id="3218409">(</span><span class="ident" id="3218410">spaceForLength</span><span class="op" id="3218424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218427">enc</span><span class="op" id="3218430">.</span><span class="ident" id="3218431">encode</span><span class="op" id="3218437">(</span><span class="ident" id="3218438">data</span><span class="op" id="3218442">,</span>&nbsp;<span class="ident" id="3218444">elem</span><span class="op" id="3218448">,</span>&nbsp;<span class="ident" id="3218450">ut</span><span class="op" id="3218452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218455">if</span>&nbsp;<span class="ident" id="3218458">enc</span><span class="op" id="3218461">.</span><span class="ident" id="3218462">err</span>&nbsp;<span class="op" id="3218466">!=</span>&nbsp;<span class="ident" id="3218469">nil</span>&nbsp;<span class="op" id="3218473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218477">error_</span><span class="op" id="3218483">(</span><span class="ident" id="3218484">enc</span><span class="op" id="3218487">.</span><span class="ident" id="3218488">err</span><span class="op" id="3218491">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3218494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218497">enc</span><span class="op" id="3218500">.</span><span class="ident" id="3218501">popWriter</span><span class="op" id="3218510">(</span><span class="op" id="3218511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218514">enc</span><span class="op" id="3218517">.</span><span class="ident" id="3218518">writeMessage</span><span class="op" id="3218530">(</span><span class="ident" id="3218531">b</span><span class="op" id="3218532">,</span>&nbsp;<span class="ident" id="3218534">data</span><span class="op" id="3218538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218541">if</span>&nbsp;<span class="ident" id="3218544">enc</span><span class="op" id="3218547">.</span><span class="ident" id="3218548">err</span>&nbsp;<span class="op" id="3218552">!=</span>&nbsp;<span class="ident" id="3218555">nil</span>&nbsp;<span class="op" id="3218559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218563">error_</span><span class="op" id="3218569">(</span><span class="ident" id="3218570">enc</span><span class="op" id="3218573">.</span><span class="ident" id="3218574">err</span><span class="op" id="3218577">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3218580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218583">enc</span><span class="op" id="3218586">.</span><span class="ident" id="3218587">freeEncoderState</span><span class="op" id="3218603">(</span><span class="ident" id="3218604">state</span><span class="op" id="3218609">)</span><br>
<span class="lineno"></span><span class="op" id="3218611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3218614">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="3218675">func</span>&nbsp;<span class="ident" id="3218680">isZero</span><span class="op" id="3218686">(</span><span class="ident" id="3218687">val</span>&nbsp;<span class="ident" id="3218691">reflect</span><span class="op" id="3218698">.</span><span class="ident" id="3218699">Value</span><span class="op" id="3218704">)</span>&nbsp;<span class="builtintype" id="3218706">bool</span>&nbsp;<span class="op" id="3218711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218714">switch</span>&nbsp;<span class="ident" id="3218721">val</span><span class="op" id="3218724">.</span><span class="ident" id="3218725">Kind</span><span class="op" id="3218729">(</span><span class="op" id="3218730">)</span>&nbsp;<span class="op" id="3218732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218735">case</span>&nbsp;<span class="ident" id="3218740">reflect</span><span class="op" id="3218747">.</span><span class="ident" id="3218748">Array</span><span class="op" id="3218753">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218757">for</span>&nbsp;<span class="ident" id="3218761">i</span>&nbsp;<span class="op" id="3218763">:=</span>&nbsp;<span class="num" id="3218766">0</span><span class="op" id="3218767">;</span>&nbsp;<span class="ident" id="3218769">i</span>&nbsp;<span class="op" id="3218771">&lt;</span>&nbsp;<span class="ident" id="3218773">val</span><span class="op" id="3218776">.</span><span class="ident" id="3218777">Len</span><span class="op" id="3218780">(</span><span class="op" id="3218781">)</span><span class="op" id="3218782">;</span>&nbsp;<span class="ident" id="3218784">i</span><span class="op" id="3218785">++</span>&nbsp;<span class="op" id="3218788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218793">if</span>&nbsp;<span class="op" id="3218796">!</span><span class="ident" id="3218797">isZero</span><span class="op" id="3218803">(</span><span class="ident" id="3218804">val</span><span class="op" id="3218807">.</span><span class="ident" id="3218808">Index</span><span class="op" id="3218813">(</span><span class="ident" id="3218814">i</span><span class="op" id="3218815">)</span><span class="op" id="3218816">)</span>&nbsp;<span class="op" id="3218818">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218824">return</span>&nbsp;<span class="ident" id="3218831">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3218840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3218844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218848">return</span>&nbsp;<span class="ident" id="3218855">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218861">case</span>&nbsp;<span class="ident" id="3218866">reflect</span><span class="op" id="3218873">.</span><span class="ident" id="3218874">Map</span><span class="op" id="3218877">,</span>&nbsp;<span class="ident" id="3218879">reflect</span><span class="op" id="3218886">.</span><span class="ident" id="3218887">Slice</span><span class="op" id="3218892">,</span>&nbsp;<span class="ident" id="3218894">reflect</span><span class="op" id="3218901">.</span><span class="ident" id="3218902">String</span><span class="op" id="3218908">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218912">return</span>&nbsp;<span class="ident" id="3218919">val</span><span class="op" id="3218922">.</span><span class="ident" id="3218923">Len</span><span class="op" id="3218926">(</span><span class="op" id="3218927">)</span>&nbsp;<span class="op" id="3218929">==</span>&nbsp;<span class="num" id="3218932">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218935">case</span>&nbsp;<span class="ident" id="3218940">reflect</span><span class="op" id="3218947">.</span><span class="ident" id="3218948">Bool</span><span class="op" id="3218952">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218956">return</span>&nbsp;<span class="op" id="3218963">!</span><span class="ident" id="3218964">val</span><span class="op" id="3218967">.</span><span class="ident" id="3218968">Bool</span><span class="op" id="3218972">(</span><span class="op" id="3218973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3218976">case</span>&nbsp;<span class="ident" id="3218981">reflect</span><span class="op" id="3218988">.</span><span class="ident" id="3218989">Complex64</span><span class="op" id="3218998">,</span>&nbsp;<span class="ident" id="3219000">reflect</span><span class="op" id="3219007">.</span><span class="ident" id="3219008">Complex128</span><span class="op" id="3219018">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219022">return</span>&nbsp;<span class="ident" id="3219029">val</span><span class="op" id="3219032">.</span><span class="ident" id="3219033">Complex</span><span class="op" id="3219040">(</span><span class="op" id="3219041">)</span>&nbsp;<span class="op" id="3219043">==</span>&nbsp;<span class="num" id="3219046">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219049">case</span>&nbsp;<span class="ident" id="3219054">reflect</span><span class="op" id="3219061">.</span><span class="ident" id="3219062">Chan</span><span class="op" id="3219066">,</span>&nbsp;<span class="ident" id="3219068">reflect</span><span class="op" id="3219075">.</span><span class="ident" id="3219076">Func</span><span class="op" id="3219080">,</span>&nbsp;<span class="ident" id="3219082">reflect</span><span class="op" id="3219089">.</span><span class="ident" id="3219090">Interface</span><span class="op" id="3219099">,</span>&nbsp;<span class="ident" id="3219101">reflect</span><span class="op" id="3219108">.</span><span class="ident" id="3219109">Ptr</span><span class="op" id="3219112">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219116">return</span>&nbsp;<span class="ident" id="3219123">val</span><span class="op" id="3219126">.</span><span class="ident" id="3219127">IsNil</span><span class="op" id="3219132">(</span><span class="op" id="3219133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219136">case</span>&nbsp;<span class="ident" id="3219141">reflect</span><span class="op" id="3219148">.</span><span class="ident" id="3219149">Int</span><span class="op" id="3219152">,</span>&nbsp;<span class="ident" id="3219154">reflect</span><span class="op" id="3219161">.</span><span class="ident" id="3219162">Int8</span><span class="op" id="3219166">,</span>&nbsp;<span class="ident" id="3219168">reflect</span><span class="op" id="3219175">.</span><span class="ident" id="3219176">Int16</span><span class="op" id="3219181">,</span>&nbsp;<span class="ident" id="3219183">reflect</span><span class="op" id="3219190">.</span><span class="ident" id="3219191">Int32</span><span class="op" id="3219196">,</span>&nbsp;<span class="ident" id="3219198">reflect</span><span class="op" id="3219205">.</span><span class="ident" id="3219206">Int64</span><span class="op" id="3219211">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219215">return</span>&nbsp;<span class="ident" id="3219222">val</span><span class="op" id="3219225">.</span><span class="ident" id="3219226">Int</span><span class="op" id="3219229">(</span><span class="op" id="3219230">)</span>&nbsp;<span class="op" id="3219232">==</span>&nbsp;<span class="num" id="3219235">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219238">case</span>&nbsp;<span class="ident" id="3219243">reflect</span><span class="op" id="3219250">.</span><span class="ident" id="3219251">Float32</span><span class="op" id="3219258">,</span>&nbsp;<span class="ident" id="3219260">reflect</span><span class="op" id="3219267">.</span><span class="ident" id="3219268">Float64</span><span class="op" id="3219275">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219279">return</span>&nbsp;<span class="ident" id="3219286">val</span><span class="op" id="3219289">.</span><span class="ident" id="3219290">Float</span><span class="op" id="3219295">(</span><span class="op" id="3219296">)</span>&nbsp;<span class="op" id="3219298">==</span>&nbsp;<span class="num" id="3219301">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219304">case</span>&nbsp;<span class="ident" id="3219309">reflect</span><span class="op" id="3219316">.</span><span class="ident" id="3219317">Uint</span><span class="op" id="3219321">,</span>&nbsp;<span class="ident" id="3219323">reflect</span><span class="op" id="3219330">.</span><span class="ident" id="3219331">Uint8</span><span class="op" id="3219336">,</span>&nbsp;<span class="ident" id="3219338">reflect</span><span class="op" id="3219345">.</span><span class="ident" id="3219346">Uint16</span><span class="op" id="3219352">,</span>&nbsp;<span class="ident" id="3219354">reflect</span><span class="op" id="3219361">.</span><span class="ident" id="3219362">Uint32</span><span class="op" id="3219368">,</span>&nbsp;<span class="ident" id="3219370">reflect</span><span class="op" id="3219377">.</span><span class="ident" id="3219378">Uint64</span><span class="op" id="3219384">,</span>&nbsp;<span class="ident" id="3219386">reflect</span><span class="op" id="3219393">.</span><span class="ident" id="3219394">Uintptr</span><span class="op" id="3219401">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219405">return</span>&nbsp;<span class="ident" id="3219412">val</span><span class="op" id="3219415">.</span><span class="ident" id="3219416">Uint</span><span class="op" id="3219420">(</span><span class="op" id="3219421">)</span>&nbsp;<span class="op" id="3219423">==</span>&nbsp;<span class="num" id="3219426">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219429">case</span>&nbsp;<span class="ident" id="3219434">reflect</span><span class="op" id="3219441">.</span><span class="ident" id="3219442">Struct</span><span class="op" id="3219448">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219452">for</span>&nbsp;<span class="ident" id="3219456">i</span>&nbsp;<span class="op" id="3219458">:=</span>&nbsp;<span class="num" id="3219461">0</span><span class="op" id="3219462">;</span>&nbsp;<span class="ident" id="3219464">i</span>&nbsp;<span class="op" id="3219466">&lt;</span>&nbsp;<span class="ident" id="3219468">val</span><span class="op" id="3219471">.</span><span class="ident" id="3219472">NumField</span><span class="op" id="3219480">(</span><span class="op" id="3219481">)</span><span class="op" id="3219482">;</span>&nbsp;<span class="ident" id="3219484">i</span><span class="op" id="3219485">++</span>&nbsp;<span class="op" id="3219488">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219493">if</span>&nbsp;<span class="op" id="3219496">!</span><span class="ident" id="3219497">isZero</span><span class="op" id="3219503">(</span><span class="ident" id="3219504">val</span><span class="op" id="3219507">.</span><span class="ident" id="3219508">Field</span><span class="op" id="3219513">(</span><span class="ident" id="3219514">i</span><span class="op" id="3219515">)</span><span class="op" id="3219516">)</span>&nbsp;<span class="op" id="3219518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219524">return</span>&nbsp;<span class="ident" id="3219531">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3219540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3219544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219548">return</span>&nbsp;<span class="ident" id="3219555">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3219561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3219564">panic</span><span class="op" id="3219569">(</span><span class="string" id="3219570">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="3219596">+</span>&nbsp;<span class="ident" id="3219598">val</span><span class="op" id="3219601">.</span><span class="ident" id="3219602">Type</span><span class="op" id="3219606">(</span><span class="op" id="3219607">)</span><span class="op" id="3219608">.</span><span class="ident" id="3219609">String</span><span class="op" id="3219615">(</span><span class="op" id="3219616">)</span><span class="op" id="3219617">)</span><br>
<span class="lineno"></span><span class="op" id="3219619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3219622">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="3219697">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="3219734">func</span>&nbsp;<span class="op" id="3219739">(</span><span class="ident" id="3219740">enc</span>&nbsp;<span class="op" id="3219744">*</span><span class="ident" id="3219745">Encoder</span><span class="op" id="3219752">)</span>&nbsp;<span class="ident" id="3219754">encodeGobEncoder</span><span class="op" id="3219770">(</span><span class="ident" id="3219771">b</span>&nbsp;<span class="op" id="3219773">*</span><span class="ident" id="3219774">encBuffer</span><span class="op" id="3219783">,</span>&nbsp;<span class="ident" id="3219785">ut</span>&nbsp;<span class="op" id="3219788">*</span><span class="ident" id="3219789">userTypeInfo</span><span class="op" id="3219801">,</span>&nbsp;<span class="ident" id="3219803">v</span>&nbsp;<span class="ident" id="3219805">reflect</span><span class="op" id="3219812">.</span><span class="ident" id="3219813">Value</span><span class="op" id="3219818">)</span>&nbsp;<span class="op" id="3219820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3219823">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219881">var</span>&nbsp;<span class="ident" id="3219885">data</span>&nbsp;<span class="op" id="3219890">[</span><span class="op" id="3219891">]</span><span class="builtintype" id="3219892">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219898">var</span>&nbsp;<span class="ident" id="3219902">err</span>&nbsp;<span class="builtintype" id="3219906">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3219913">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219944">switch</span>&nbsp;<span class="ident" id="3219951">ut</span><span class="op" id="3219953">.</span><span class="ident" id="3219954">externalEnc</span>&nbsp;<span class="op" id="3219966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3219969">case</span>&nbsp;<span class="ident" id="3219974">xGob</span><span class="op" id="3219978">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219982">data</span><span class="op" id="3219986">,</span>&nbsp;<span class="ident" id="3219988">err</span>&nbsp;<span class="op" id="3219992">=</span>&nbsp;<span class="ident" id="3219994">v</span><span class="op" id="3219995">.</span><span class="ident" id="3219996">Interface</span><span class="op" id="3220005">(</span><span class="op" id="3220006">)</span><span class="op" id="3220007">.</span><span class="op" id="3220008">(</span><span class="ident" id="3220009">GobEncoder</span><span class="op" id="3220019">)</span><span class="op" id="3220020">.</span><span class="ident" id="3220021">GobEncode</span><span class="op" id="3220030">(</span><span class="op" id="3220031">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3220034">case</span>&nbsp;<span class="ident" id="3220039">xBinary</span><span class="op" id="3220046">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220050">data</span><span class="op" id="3220054">,</span>&nbsp;<span class="ident" id="3220056">err</span>&nbsp;<span class="op" id="3220060">=</span>&nbsp;<span class="ident" id="3220062">v</span><span class="op" id="3220063">.</span><span class="ident" id="3220064">Interface</span><span class="op" id="3220073">(</span><span class="op" id="3220074">)</span><span class="op" id="3220075">.</span><span class="op" id="3220076">(</span><span class="ident" id="3220077">encoding</span><span class="op" id="3220085">.</span><span class="ident" id="3220086">BinaryMarshaler</span><span class="op" id="3220101">)</span><span class="op" id="3220102">.</span><span class="ident" id="3220103">MarshalBinary</span><span class="op" id="3220116">(</span><span class="op" id="3220117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3220120">case</span>&nbsp;<span class="ident" id="3220125">xText</span><span class="op" id="3220130">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220134">data</span><span class="op" id="3220138">,</span>&nbsp;<span class="ident" id="3220140">err</span>&nbsp;<span class="op" id="3220144">=</span>&nbsp;<span class="ident" id="3220146">v</span><span class="op" id="3220147">.</span><span class="ident" id="3220148">Interface</span><span class="op" id="3220157">(</span><span class="op" id="3220158">)</span><span class="op" id="3220159">.</span><span class="op" id="3220160">(</span><span class="ident" id="3220161">encoding</span><span class="op" id="3220169">.</span><span class="ident" id="3220170">TextMarshaler</span><span class="op" id="3220183">)</span><span class="op" id="3220184">.</span><span class="ident" id="3220185">MarshalText</span><span class="op" id="3220196">(</span><span class="op" id="3220197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3220200">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3220203">if</span>&nbsp;<span class="ident" id="3220206">err</span>&nbsp;<span class="op" id="3220210">!=</span>&nbsp;<span class="ident" id="3220213">nil</span>&nbsp;<span class="op" id="3220217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220221">error_</span><span class="op" id="3220227">(</span><span class="ident" id="3220228">err</span><span class="op" id="3220231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3220234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220237">state</span>&nbsp;<span class="op" id="3220243">:=</span>&nbsp;<span class="ident" id="3220246">enc</span><span class="op" id="3220249">.</span><span class="ident" id="3220250">newEncoderState</span><span class="op" id="3220265">(</span><span class="ident" id="3220266">b</span><span class="op" id="3220267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220270">state</span><span class="op" id="3220275">.</span><span class="ident" id="3220276">fieldnum</span>&nbsp;<span class="op" id="3220285">=</span>&nbsp;<span class="op" id="3220287">-</span><span class="num" id="3220288">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220291">state</span><span class="op" id="3220296">.</span><span class="ident" id="3220297">encodeUint</span><span class="op" id="3220307">(</span><span class="ident" id="3220308">uint64</span><span class="op" id="3220314">(</span><span class="builtinfunc" id="3220315">len</span><span class="op" id="3220318">(</span><span class="ident" id="3220319">data</span><span class="op" id="3220323">)</span><span class="op" id="3220324">)</span><span class="op" id="3220325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220328">state</span><span class="op" id="3220333">.</span><span class="ident" id="3220334">b</span><span class="op" id="3220335">.</span><span class="ident" id="3220336">Write</span><span class="op" id="3220341">(</span><span class="ident" id="3220342">data</span><span class="op" id="3220346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220349">enc</span><span class="op" id="3220352">.</span><span class="ident" id="3220353">freeEncoderState</span><span class="op" id="3220369">(</span><span class="ident" id="3220370">state</span><span class="op" id="3220375">)</span><br>
<span class="lineno"></span><span class="op" id="3220377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="3220380">var</span>&nbsp;<span class="ident" id="3220384">encOpTable</span>&nbsp;<span class="op" id="3220395">=</span>&nbsp;<span class="op" id="3220397">[</span><span class="op" id="3220398">...</span><span class="op" id="3220401">]</span><span class="ident" id="3220402">encOp</span><span class="op" id="3220407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220410">reflect</span><span class="op" id="3220417">.</span><span class="ident" id="3220418">Bool</span><span class="op" id="3220422">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220430">encBool</span><span class="op" id="3220437">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220440">reflect</span><span class="op" id="3220447">.</span><span class="ident" id="3220448">Int</span><span class="op" id="3220451">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220460">encInt</span><span class="op" id="3220466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220469">reflect</span><span class="op" id="3220476">.</span><span class="ident" id="3220477">Int8</span><span class="op" id="3220481">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220489">encInt</span><span class="op" id="3220495">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220498">reflect</span><span class="op" id="3220505">.</span><span class="ident" id="3220506">Int16</span><span class="op" id="3220511">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220518">encInt</span><span class="op" id="3220524">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220527">reflect</span><span class="op" id="3220534">.</span><span class="ident" id="3220535">Int32</span><span class="op" id="3220540">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220547">encInt</span><span class="op" id="3220553">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220556">reflect</span><span class="op" id="3220563">.</span><span class="ident" id="3220564">Int64</span><span class="op" id="3220569">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220576">encInt</span><span class="op" id="3220582">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220585">reflect</span><span class="op" id="3220592">.</span><span class="ident" id="3220593">Uint</span><span class="op" id="3220597">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220605">encUint</span><span class="op" id="3220612">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220615">reflect</span><span class="op" id="3220622">.</span><span class="ident" id="3220623">Uint8</span><span class="op" id="3220628">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220635">encUint</span><span class="op" id="3220642">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220645">reflect</span><span class="op" id="3220652">.</span><span class="ident" id="3220653">Uint16</span><span class="op" id="3220659">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220665">encUint</span><span class="op" id="3220672">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220675">reflect</span><span class="op" id="3220682">.</span><span class="ident" id="3220683">Uint32</span><span class="op" id="3220689">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220695">encUint</span><span class="op" id="3220702">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220705">reflect</span><span class="op" id="3220712">.</span><span class="ident" id="3220713">Uint64</span><span class="op" id="3220719">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220725">encUint</span><span class="op" id="3220732">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220735">reflect</span><span class="op" id="3220742">.</span><span class="ident" id="3220743">Uintptr</span><span class="op" id="3220750">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220755">encUint</span><span class="op" id="3220762">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220765">reflect</span><span class="op" id="3220772">.</span><span class="ident" id="3220773">Float32</span><span class="op" id="3220780">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220785">encFloat</span><span class="op" id="3220793">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220796">reflect</span><span class="op" id="3220803">.</span><span class="ident" id="3220804">Float64</span><span class="op" id="3220811">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220816">encFloat</span><span class="op" id="3220824">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220827">reflect</span><span class="op" id="3220834">.</span><span class="ident" id="3220835">Complex64</span><span class="op" id="3220844">:</span>&nbsp;&nbsp;<span class="ident" id="3220847">encComplex</span><span class="op" id="3220857">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220860">reflect</span><span class="op" id="3220867">.</span><span class="ident" id="3220868">Complex128</span><span class="op" id="3220878">:</span>&nbsp;<span class="ident" id="3220880">encComplex</span><span class="op" id="3220890">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220893">reflect</span><span class="op" id="3220900">.</span><span class="ident" id="3220901">String</span><span class="op" id="3220907">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220913">encString</span><span class="op" id="3220922">,</span><br>
<span class="lineno"></span><span class="op" id="3220924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="3220927">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3221009">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="3221047">func</span>&nbsp;<span class="ident" id="3221052">encOpFor</span><span class="op" id="3221060">(</span><span class="ident" id="3221061">rt</span>&nbsp;<span class="ident" id="3221064">reflect</span><span class="op" id="3221071">.</span><span class="ident" id="3221072">Type</span><span class="op" id="3221076">,</span>&nbsp;<span class="ident" id="3221078">inProgress</span>&nbsp;<span class="keyword" id="3221089">map</span><span class="op" id="3221092">[</span><span class="ident" id="3221093">reflect</span><span class="op" id="3221100">.</span><span class="ident" id="3221101">Type</span><span class="op" id="3221105">]</span><span class="op" id="3221106">*</span><span class="ident" id="3221107">encOp</span><span class="op" id="3221112">,</span>&nbsp;<span class="ident" id="3221114">building</span>&nbsp;<span class="keyword" id="3221123">map</span><span class="op" id="3221126">[</span><span class="op" id="3221127">*</span><span class="ident" id="3221128">typeInfo</span><span class="op" id="3221136">]</span><span class="builtintype" id="3221137">bool</span><span class="op" id="3221141">)</span>&nbsp;<span class="op" id="3221143">(</span><span class="op" id="3221144">*</span><span class="ident" id="3221145">encOp</span><span class="op" id="3221150">,</span>&nbsp;<span class="builtintype" id="3221152">int</span><span class="op" id="3221155">)</span>&nbsp;<span class="op" id="3221157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221160">ut</span>&nbsp;<span class="op" id="3221163">:=</span>&nbsp;<span class="ident" id="3221166">userType</span><span class="op" id="3221174">(</span><span class="ident" id="3221175">rt</span><span class="op" id="3221177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221180">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221260">if</span>&nbsp;<span class="ident" id="3221263">ut</span><span class="op" id="3221265">.</span><span class="ident" id="3221266">externalEnc</span>&nbsp;<span class="op" id="3221278">!=</span>&nbsp;<span class="num" id="3221281">0</span>&nbsp;<span class="op" id="3221283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221287">return</span>&nbsp;<span class="ident" id="3221294">gobEncodeOpFor</span><span class="op" id="3221308">(</span><span class="ident" id="3221309">ut</span><span class="op" id="3221311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3221314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221317">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221402">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221459">if</span>&nbsp;<span class="ident" id="3221462">opPtr</span>&nbsp;<span class="op" id="3221468">:=</span>&nbsp;<span class="ident" id="3221471">inProgress</span><span class="op" id="3221481">[</span><span class="ident" id="3221482">rt</span><span class="op" id="3221484">]</span><span class="op" id="3221485">;</span>&nbsp;<span class="ident" id="3221487">opPtr</span>&nbsp;<span class="op" id="3221493">!=</span>&nbsp;<span class="ident" id="3221496">nil</span>&nbsp;<span class="op" id="3221500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221504">return</span>&nbsp;<span class="ident" id="3221511">opPtr</span><span class="op" id="3221516">,</span>&nbsp;<span class="ident" id="3221518">ut</span><span class="op" id="3221520">.</span><span class="ident" id="3221521">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3221528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221531">typ</span>&nbsp;<span class="op" id="3221535">:=</span>&nbsp;<span class="ident" id="3221538">ut</span><span class="op" id="3221540">.</span><span class="ident" id="3221541">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221547">indir</span>&nbsp;<span class="op" id="3221553">:=</span>&nbsp;<span class="ident" id="3221556">ut</span><span class="op" id="3221558">.</span><span class="ident" id="3221559">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221566">k</span>&nbsp;<span class="op" id="3221568">:=</span>&nbsp;<span class="ident" id="3221571">typ</span><span class="op" id="3221574">.</span><span class="ident" id="3221575">Kind</span><span class="op" id="3221579">(</span><span class="op" id="3221580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221583">var</span>&nbsp;<span class="ident" id="3221587">op</span>&nbsp;<span class="ident" id="3221590">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221597">if</span>&nbsp;<span class="builtintype" id="3221600">int</span><span class="op" id="3221603">(</span><span class="ident" id="3221604">k</span><span class="op" id="3221605">)</span>&nbsp;<span class="op" id="3221607">&lt;</span>&nbsp;<span class="builtinfunc" id="3221609">len</span><span class="op" id="3221612">(</span><span class="ident" id="3221613">encOpTable</span><span class="op" id="3221623">)</span>&nbsp;<span class="op" id="3221625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221629">op</span>&nbsp;<span class="op" id="3221632">=</span>&nbsp;<span class="ident" id="3221634">encOpTable</span><span class="op" id="3221644">[</span><span class="ident" id="3221645">k</span><span class="op" id="3221646">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3221649">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221652">if</span>&nbsp;<span class="ident" id="3221655">op</span>&nbsp;<span class="op" id="3221658">==</span>&nbsp;<span class="ident" id="3221661">nil</span>&nbsp;<span class="op" id="3221665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221669">inProgress</span><span class="op" id="3221679">[</span><span class="ident" id="3221680">rt</span><span class="op" id="3221682">]</span>&nbsp;<span class="op" id="3221684">=</span>&nbsp;<span class="op" id="3221686">&amp;</span><span class="ident" id="3221687">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221692">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221711">switch</span>&nbsp;<span class="ident" id="3221718">t</span>&nbsp;<span class="op" id="3221720">:=</span>&nbsp;<span class="ident" id="3221723">typ</span><span class="op" id="3221726">;</span>&nbsp;<span class="ident" id="3221728">t</span><span class="op" id="3221729">.</span><span class="ident" id="3221730">Kind</span><span class="op" id="3221734">(</span><span class="op" id="3221735">)</span>&nbsp;<span class="op" id="3221737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221741">case</span>&nbsp;<span class="ident" id="3221746">reflect</span><span class="op" id="3221753">.</span><span class="ident" id="3221754">Slice</span><span class="op" id="3221759">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221764">if</span>&nbsp;<span class="ident" id="3221767">t</span><span class="op" id="3221768">.</span><span class="ident" id="3221769">Elem</span><span class="op" id="3221773">(</span><span class="op" id="3221774">)</span><span class="op" id="3221775">.</span><span class="ident" id="3221776">Kind</span><span class="op" id="3221780">(</span><span class="op" id="3221781">)</span>&nbsp;<span class="op" id="3221783">==</span>&nbsp;<span class="ident" id="3221786">reflect</span><span class="op" id="3221793">.</span><span class="ident" id="3221794">Uint8</span>&nbsp;<span class="op" id="3221800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221806">op</span>&nbsp;<span class="op" id="3221809">=</span>&nbsp;<span class="ident" id="3221811">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221829">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3221838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221843">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221914">elemOp</span><span class="op" id="3221920">,</span>&nbsp;<span class="ident" id="3221922">elemIndir</span>&nbsp;<span class="op" id="3221932">:=</span>&nbsp;<span class="ident" id="3221935">encOpFor</span><span class="op" id="3221943">(</span><span class="ident" id="3221944">t</span><span class="op" id="3221945">.</span><span class="ident" id="3221946">Elem</span><span class="op" id="3221950">(</span><span class="op" id="3221951">)</span><span class="op" id="3221952">,</span>&nbsp;<span class="ident" id="3221954">inProgress</span><span class="op" id="3221964">,</span>&nbsp;<span class="ident" id="3221966">building</span><span class="op" id="3221974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221979">helper</span>&nbsp;<span class="op" id="3221986">:=</span>&nbsp;<span class="ident" id="3221989">encSliceHelper</span><span class="op" id="3222003">[</span><span class="ident" id="3222004">t</span><span class="op" id="3222005">.</span><span class="ident" id="3222006">Elem</span><span class="op" id="3222010">(</span><span class="op" id="3222011">)</span><span class="op" id="3222012">.</span><span class="ident" id="3222013">Kind</span><span class="op" id="3222017">(</span><span class="op" id="3222018">)</span><span class="op" id="3222019">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222024">op</span>&nbsp;<span class="op" id="3222027">=</span>&nbsp;<span class="keyword" id="3222029">func</span><span class="op" id="3222033">(</span><span class="ident" id="3222034">i</span>&nbsp;<span class="op" id="3222036">*</span><span class="ident" id="3222037">encInstr</span><span class="op" id="3222045">,</span>&nbsp;<span class="ident" id="3222047">state</span>&nbsp;<span class="op" id="3222053">*</span><span class="ident" id="3222054">encoderState</span><span class="op" id="3222066">,</span>&nbsp;<span class="ident" id="3222068">slice</span>&nbsp;<span class="ident" id="3222074">reflect</span><span class="op" id="3222081">.</span><span class="ident" id="3222082">Value</span><span class="op" id="3222087">)</span>&nbsp;<span class="op" id="3222089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3222095">if</span>&nbsp;<span class="op" id="3222098">!</span><span class="ident" id="3222099">state</span><span class="op" id="3222104">.</span><span class="ident" id="3222105">sendZero</span>&nbsp;<span class="op" id="3222114">&amp;&amp;</span>&nbsp;<span class="ident" id="3222117">slice</span><span class="op" id="3222122">.</span><span class="ident" id="3222123">Len</span><span class="op" id="3222126">(</span><span class="op" id="3222127">)</span>&nbsp;<span class="op" id="3222129">==</span>&nbsp;<span class="num" id="3222132">0</span>&nbsp;<span class="op" id="3222134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3222141">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3222152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222158">state</span><span class="op" id="3222163">.</span><span class="ident" id="3222164">update</span><span class="op" id="3222170">(</span><span class="ident" id="3222171">i</span><span class="op" id="3222172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222178">state</span><span class="op" id="3222183">.</span><span class="ident" id="3222184">enc</span><span class="op" id="3222187">.</span><span class="ident" id="3222188">encodeArray</span><span class="op" id="3222199">(</span><span class="ident" id="3222200">state</span><span class="op" id="3222205">.</span><span class="ident" id="3222206">b</span><span class="op" id="3222207">,</span>&nbsp;<span class="ident" id="3222209">slice</span><span class="op" id="3222214">,</span>&nbsp;<span class="op" id="3222216">*</span><span class="ident" id="3222217">elemOp</span><span class="op" id="3222223">,</span>&nbsp;<span class="ident" id="3222225">elemIndir</span><span class="op" id="3222234">,</span>&nbsp;<span class="ident" id="3222236">slice</span><span class="op" id="3222241">.</span><span class="ident" id="3222242">Len</span><span class="op" id="3222245">(</span><span class="op" id="3222246">)</span><span class="op" id="3222247">,</span>&nbsp;<span class="ident" id="3222249">helper</span><span class="op" id="3222255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3222260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3222264">case</span>&nbsp;<span class="ident" id="3222269">reflect</span><span class="op" id="3222276">.</span><span class="ident" id="3222277">Array</span><span class="op" id="3222282">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3222287">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222328">elemOp</span><span class="op" id="3222334">,</span>&nbsp;<span class="ident" id="3222336">elemIndir</span>&nbsp;<span class="op" id="3222346">:=</span>&nbsp;<span class="ident" id="3222349">encOpFor</span><span class="op" id="3222357">(</span><span class="ident" id="3222358">t</span><span class="op" id="3222359">.</span><span class="ident" id="3222360">Elem</span><span class="op" id="3222364">(</span><span class="op" id="3222365">)</span><span class="op" id="3222366">,</span>&nbsp;<span class="ident" id="3222368">inProgress</span><span class="op" id="3222378">,</span>&nbsp;<span class="ident" id="3222380">building</span><span class="op" id="3222388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222393">helper</span>&nbsp;<span class="op" id="3222400">:=</span>&nbsp;<span class="ident" id="3222403">encArrayHelper</span><span class="op" id="3222417">[</span><span class="ident" id="3222418">t</span><span class="op" id="3222419">.</span><span class="ident" id="3222420">Elem</span><span class="op" id="3222424">(</span><span class="op" id="3222425">)</span><span class="op" id="3222426">.</span><span class="ident" id="3222427">Kind</span><span class="op" id="3222431">(</span><span class="op" id="3222432">)</span><span class="op" id="3222433">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222438">op</span>&nbsp;<span class="op" id="3222441">=</span>&nbsp;<span class="keyword" id="3222443">func</span><span class="op" id="3222447">(</span><span class="ident" id="3222448">i</span>&nbsp;<span class="op" id="3222450">*</span><span class="ident" id="3222451">encInstr</span><span class="op" id="3222459">,</span>&nbsp;<span class="ident" id="3222461">state</span>&nbsp;<span class="op" id="3222467">*</span><span class="ident" id="3222468">encoderState</span><span class="op" id="3222480">,</span>&nbsp;<span class="ident" id="3222482">array</span>&nbsp;<span class="ident" id="3222488">reflect</span><span class="op" id="3222495">.</span><span class="ident" id="3222496">Value</span><span class="op" id="3222501">)</span>&nbsp;<span class="op" id="3222503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222509">state</span><span class="op" id="3222514">.</span><span class="ident" id="3222515">update</span><span class="op" id="3222521">(</span><span class="ident" id="3222522">i</span><span class="op" id="3222523">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222529">state</span><span class="op" id="3222534">.</span><span class="ident" id="3222535">enc</span><span class="op" id="3222538">.</span><span class="ident" id="3222539">encodeArray</span><span class="op" id="3222550">(</span><span class="ident" id="3222551">state</span><span class="op" id="3222556">.</span><span class="ident" id="3222557">b</span><span class="op" id="3222558">,</span>&nbsp;<span class="ident" id="3222560">array</span><span class="op" id="3222565">,</span>&nbsp;<span class="op" id="3222567">*</span><span class="ident" id="3222568">elemOp</span><span class="op" id="3222574">,</span>&nbsp;<span class="ident" id="3222576">elemIndir</span><span class="op" id="3222585">,</span>&nbsp;<span class="ident" id="3222587">array</span><span class="op" id="3222592">.</span><span class="ident" id="3222593">Len</span><span class="op" id="3222596">(</span><span class="op" id="3222597">)</span><span class="op" id="3222598">,</span>&nbsp;<span class="ident" id="3222600">helper</span><span class="op" id="3222606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3222611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3222615">case</span>&nbsp;<span class="ident" id="3222620">reflect</span><span class="op" id="3222627">.</span><span class="ident" id="3222628">Map</span><span class="op" id="3222631">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222636">keyOp</span><span class="op" id="3222641">,</span>&nbsp;<span class="ident" id="3222643">keyIndir</span>&nbsp;<span class="op" id="3222652">:=</span>&nbsp;<span class="ident" id="3222655">encOpFor</span><span class="op" id="3222663">(</span><span class="ident" id="3222664">t</span><span class="op" id="3222665">.</span><span class="ident" id="3222666">Key</span><span class="op" id="3222669">(</span><span class="op" id="3222670">)</span><span class="op" id="3222671">,</span>&nbsp;<span class="ident" id="3222673">inProgress</span><span class="op" id="3222683">,</span>&nbsp;<span class="ident" id="3222685">building</span><span class="op" id="3222693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222698">elemOp</span><span class="op" id="3222704">,</span>&nbsp;<span class="ident" id="3222706">elemIndir</span>&nbsp;<span class="op" id="3222716">:=</span>&nbsp;<span class="ident" id="3222719">encOpFor</span><span class="op" id="3222727">(</span><span class="ident" id="3222728">t</span><span class="op" id="3222729">.</span><span class="ident" id="3222730">Elem</span><span class="op" id="3222734">(</span><span class="op" id="3222735">)</span><span class="op" id="3222736">,</span>&nbsp;<span class="ident" id="3222738">inProgress</span><span class="op" id="3222748">,</span>&nbsp;<span class="ident" id="3222750">building</span><span class="op" id="3222758">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222763">op</span>&nbsp;<span class="op" id="3222766">=</span>&nbsp;<span class="keyword" id="3222768">func</span><span class="op" id="3222772">(</span><span class="ident" id="3222773">i</span>&nbsp;<span class="op" id="3222775">*</span><span class="ident" id="3222776">encInstr</span><span class="op" id="3222784">,</span>&nbsp;<span class="ident" id="3222786">state</span>&nbsp;<span class="op" id="3222792">*</span><span class="ident" id="3222793">encoderState</span><span class="op" id="3222805">,</span>&nbsp;<span class="ident" id="3222807">mv</span>&nbsp;<span class="ident" id="3222810">reflect</span><span class="op" id="3222817">.</span><span class="ident" id="3222818">Value</span><span class="op" id="3222823">)</span>&nbsp;<span class="op" id="3222825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3222831">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3222889">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3222958">if</span>&nbsp;<span class="op" id="3222961">!</span><span class="ident" id="3222962">state</span><span class="op" id="3222967">.</span><span class="ident" id="3222968">sendZero</span>&nbsp;<span class="op" id="3222977">&amp;&amp;</span>&nbsp;<span class="ident" id="3222980">mv</span><span class="op" id="3222982">.</span><span class="ident" id="3222983">IsNil</span><span class="op" id="3222988">(</span><span class="op" id="3222989">)</span>&nbsp;<span class="op" id="3222991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3222998">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3223009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223015">state</span><span class="op" id="3223020">.</span><span class="ident" id="3223021">update</span><span class="op" id="3223027">(</span><span class="ident" id="3223028">i</span><span class="op" id="3223029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223035">state</span><span class="op" id="3223040">.</span><span class="ident" id="3223041">enc</span><span class="op" id="3223044">.</span><span class="ident" id="3223045">encodeMap</span><span class="op" id="3223054">(</span><span class="ident" id="3223055">state</span><span class="op" id="3223060">.</span><span class="ident" id="3223061">b</span><span class="op" id="3223062">,</span>&nbsp;<span class="ident" id="3223064">mv</span><span class="op" id="3223066">,</span>&nbsp;<span class="op" id="3223068">*</span><span class="ident" id="3223069">keyOp</span><span class="op" id="3223074">,</span>&nbsp;<span class="op" id="3223076">*</span><span class="ident" id="3223077">elemOp</span><span class="op" id="3223083">,</span>&nbsp;<span class="ident" id="3223085">keyIndir</span><span class="op" id="3223093">,</span>&nbsp;<span class="ident" id="3223095">elemIndir</span><span class="op" id="3223104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3223109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3223113">case</span>&nbsp;<span class="ident" id="3223118">reflect</span><span class="op" id="3223125">.</span><span class="ident" id="3223126">Struct</span><span class="op" id="3223132">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3223137">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223212">getEncEngine</span><span class="op" id="3223224">(</span><span class="ident" id="3223225">userType</span><span class="op" id="3223233">(</span><span class="ident" id="3223234">typ</span><span class="op" id="3223237">)</span><span class="op" id="3223238">,</span>&nbsp;<span class="ident" id="3223240">building</span><span class="op" id="3223248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223253">info</span>&nbsp;<span class="op" id="3223258">:=</span>&nbsp;<span class="ident" id="3223261">mustGetTypeInfo</span><span class="op" id="3223276">(</span><span class="ident" id="3223277">typ</span><span class="op" id="3223280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223285">op</span>&nbsp;<span class="op" id="3223288">=</span>&nbsp;<span class="keyword" id="3223290">func</span><span class="op" id="3223294">(</span><span class="ident" id="3223295">i</span>&nbsp;<span class="op" id="3223297">*</span><span class="ident" id="3223298">encInstr</span><span class="op" id="3223306">,</span>&nbsp;<span class="ident" id="3223308">state</span>&nbsp;<span class="op" id="3223314">*</span><span class="ident" id="3223315">encoderState</span><span class="op" id="3223327">,</span>&nbsp;<span class="ident" id="3223329">sv</span>&nbsp;<span class="ident" id="3223332">reflect</span><span class="op" id="3223339">.</span><span class="ident" id="3223340">Value</span><span class="op" id="3223345">)</span>&nbsp;<span class="op" id="3223347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223353">state</span><span class="op" id="3223358">.</span><span class="ident" id="3223359">update</span><span class="op" id="3223365">(</span><span class="ident" id="3223366">i</span><span class="op" id="3223367">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3223373">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223444">enc</span>&nbsp;<span class="op" id="3223448">:=</span>&nbsp;<span class="ident" id="3223451">info</span><span class="op" id="3223455">.</span><span class="ident" id="3223456">encoder</span><span class="op" id="3223463">.</span><span class="ident" id="3223464">Load</span><span class="op" id="3223468">(</span><span class="op" id="3223469">)</span><span class="op" id="3223470">.</span><span class="op" id="3223471">(</span><span class="op" id="3223472">*</span><span class="ident" id="3223473">encEngine</span><span class="op" id="3223482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223488">state</span><span class="op" id="3223493">.</span><span class="ident" id="3223494">enc</span><span class="op" id="3223497">.</span><span class="ident" id="3223498">encodeStruct</span><span class="op" id="3223510">(</span><span class="ident" id="3223511">state</span><span class="op" id="3223516">.</span><span class="ident" id="3223517">b</span><span class="op" id="3223518">,</span>&nbsp;<span class="ident" id="3223520">enc</span><span class="op" id="3223523">,</span>&nbsp;<span class="ident" id="3223525">sv</span><span class="op" id="3223527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3223532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3223536">case</span>&nbsp;<span class="ident" id="3223541">reflect</span><span class="op" id="3223548">.</span><span class="ident" id="3223549">Interface</span><span class="op" id="3223558">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223563">op</span>&nbsp;<span class="op" id="3223566">=</span>&nbsp;<span class="keyword" id="3223568">func</span><span class="op" id="3223572">(</span><span class="ident" id="3223573">i</span>&nbsp;<span class="op" id="3223575">*</span><span class="ident" id="3223576">encInstr</span><span class="op" id="3223584">,</span>&nbsp;<span class="ident" id="3223586">state</span>&nbsp;<span class="op" id="3223592">*</span><span class="ident" id="3223593">encoderState</span><span class="op" id="3223605">,</span>&nbsp;<span class="ident" id="3223607">iv</span>&nbsp;<span class="ident" id="3223610">reflect</span><span class="op" id="3223617">.</span><span class="ident" id="3223618">Value</span><span class="op" id="3223623">)</span>&nbsp;<span class="op" id="3223625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3223631">if</span>&nbsp;<span class="op" id="3223634">!</span><span class="ident" id="3223635">state</span><span class="op" id="3223640">.</span><span class="ident" id="3223641">sendZero</span>&nbsp;<span class="op" id="3223650">&amp;&amp;</span>&nbsp;<span class="op" id="3223653">(</span><span class="op" id="3223654">!</span><span class="ident" id="3223655">iv</span><span class="op" id="3223657">.</span><span class="ident" id="3223658">IsValid</span><span class="op" id="3223665">(</span><span class="op" id="3223666">)</span>&nbsp;<span class="op" id="3223668">||</span>&nbsp;<span class="ident" id="3223671">iv</span><span class="op" id="3223673">.</span><span class="ident" id="3223674">IsNil</span><span class="op" id="3223679">(</span><span class="op" id="3223680">)</span><span class="op" id="3223681">)</span>&nbsp;<span class="op" id="3223683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3223690">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3223701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223707">state</span><span class="op" id="3223712">.</span><span class="ident" id="3223713">update</span><span class="op" id="3223719">(</span><span class="ident" id="3223720">i</span><span class="op" id="3223721">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223727">state</span><span class="op" id="3223732">.</span><span class="ident" id="3223733">enc</span><span class="op" id="3223736">.</span><span class="ident" id="3223737">encodeInterface</span><span class="op" id="3223752">(</span><span class="ident" id="3223753">state</span><span class="op" id="3223758">.</span><span class="ident" id="3223759">b</span><span class="op" id="3223760">,</span>&nbsp;<span class="ident" id="3223762">iv</span><span class="op" id="3223764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3223769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3223773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3223776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3223779">if</span>&nbsp;<span class="ident" id="3223782">op</span>&nbsp;<span class="op" id="3223785">==</span>&nbsp;<span class="ident" id="3223788">nil</span>&nbsp;<span class="op" id="3223792">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223796">errorf</span><span class="op" id="3223802">(</span><span class="string" id="3223803">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="3223833">,</span>&nbsp;<span class="ident" id="3223835">rt</span><span class="op" id="3223837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3223840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3223843">return</span>&nbsp;<span class="op" id="3223850">&amp;</span><span class="ident" id="3223851">op</span><span class="op" id="3223853">,</span>&nbsp;<span class="ident" id="3223855">indir</span><br>
<span class="lineno"></span><span class="op" id="3223861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="3223864">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="3223947">func</span>&nbsp;<span class="ident" id="3223952">gobEncodeOpFor</span><span class="op" id="3223966">(</span><span class="ident" id="3223967">ut</span>&nbsp;<span class="op" id="3223970">*</span><span class="ident" id="3223971">userTypeInfo</span><span class="op" id="3223983">)</span>&nbsp;<span class="op" id="3223985">(</span><span class="op" id="3223986">*</span><span class="ident" id="3223987">encOp</span><span class="op" id="3223992">,</span>&nbsp;<span class="builtintype" id="3223994">int</span><span class="op" id="3223997">)</span>&nbsp;<span class="op" id="3223999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224002">rt</span>&nbsp;<span class="op" id="3224005">:=</span>&nbsp;<span class="ident" id="3224008">ut</span><span class="op" id="3224010">.</span><span class="ident" id="3224011">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224017">if</span>&nbsp;<span class="ident" id="3224020">ut</span><span class="op" id="3224022">.</span><span class="ident" id="3224023">encIndir</span>&nbsp;<span class="op" id="3224032">==</span>&nbsp;<span class="op" id="3224035">-</span><span class="num" id="3224036">1</span>&nbsp;<span class="op" id="3224038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224042">rt</span>&nbsp;<span class="op" id="3224045">=</span>&nbsp;<span class="ident" id="3224047">reflect</span><span class="op" id="3224054">.</span><span class="ident" id="3224055">PtrTo</span><span class="op" id="3224060">(</span><span class="ident" id="3224061">rt</span><span class="op" id="3224063">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3224066">}</span>&nbsp;<span class="keyword" id="3224068">else</span>&nbsp;<span class="keyword" id="3224073">if</span>&nbsp;<span class="ident" id="3224076">ut</span><span class="op" id="3224078">.</span><span class="ident" id="3224079">encIndir</span>&nbsp;<span class="op" id="3224088">&gt;</span>&nbsp;<span class="num" id="3224090">0</span>&nbsp;<span class="op" id="3224092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224096">for</span>&nbsp;<span class="ident" id="3224100">i</span>&nbsp;<span class="op" id="3224102">:=</span>&nbsp;<span class="builtintype" id="3224105">int8</span><span class="op" id="3224109">(</span><span class="num" id="3224110">0</span><span class="op" id="3224111">)</span><span class="op" id="3224112">;</span>&nbsp;<span class="ident" id="3224114">i</span>&nbsp;<span class="op" id="3224116">&lt;</span>&nbsp;<span class="ident" id="3224118">ut</span><span class="op" id="3224120">.</span><span class="ident" id="3224121">encIndir</span><span class="op" id="3224129">;</span>&nbsp;<span class="ident" id="3224131">i</span><span class="op" id="3224132">++</span>&nbsp;<span class="op" id="3224135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224140">rt</span>&nbsp;<span class="op" id="3224143">=</span>&nbsp;<span class="ident" id="3224145">rt</span><span class="op" id="3224147">.</span><span class="ident" id="3224148">Elem</span><span class="op" id="3224152">(</span><span class="op" id="3224153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3224157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3224160">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224163">var</span>&nbsp;<span class="ident" id="3224167">op</span>&nbsp;<span class="ident" id="3224170">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224177">op</span>&nbsp;<span class="op" id="3224180">=</span>&nbsp;<span class="keyword" id="3224182">func</span><span class="op" id="3224186">(</span><span class="ident" id="3224187">i</span>&nbsp;<span class="op" id="3224189">*</span><span class="ident" id="3224190">encInstr</span><span class="op" id="3224198">,</span>&nbsp;<span class="ident" id="3224200">state</span>&nbsp;<span class="op" id="3224206">*</span><span class="ident" id="3224207">encoderState</span><span class="op" id="3224219">,</span>&nbsp;<span class="ident" id="3224221">v</span>&nbsp;<span class="ident" id="3224223">reflect</span><span class="op" id="3224230">.</span><span class="ident" id="3224231">Value</span><span class="op" id="3224236">)</span>&nbsp;<span class="op" id="3224238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224242">if</span>&nbsp;<span class="ident" id="3224245">ut</span><span class="op" id="3224247">.</span><span class="ident" id="3224248">encIndir</span>&nbsp;<span class="op" id="3224257">==</span>&nbsp;<span class="op" id="3224260">-</span><span class="num" id="3224261">1</span>&nbsp;<span class="op" id="3224263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3224268">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224329">if</span>&nbsp;<span class="op" id="3224332">!</span><span class="ident" id="3224333">v</span><span class="op" id="3224334">.</span><span class="ident" id="3224335">CanAddr</span><span class="op" id="3224342">(</span><span class="op" id="3224343">)</span>&nbsp;<span class="op" id="3224345">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224351">errorf</span><span class="op" id="3224357">(</span><span class="string" id="3224358">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="3224390">,</span>&nbsp;<span class="ident" id="3224392">rt</span><span class="op" id="3224394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3224399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224404">v</span>&nbsp;<span class="op" id="3224406">=</span>&nbsp;<span class="ident" id="3224408">v</span><span class="op" id="3224409">.</span><span class="ident" id="3224410">Addr</span><span class="op" id="3224414">(</span><span class="op" id="3224415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3224419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224423">if</span>&nbsp;<span class="op" id="3224426">!</span><span class="ident" id="3224427">state</span><span class="op" id="3224432">.</span><span class="ident" id="3224433">sendZero</span>&nbsp;<span class="op" id="3224442">&amp;&amp;</span>&nbsp;<span class="ident" id="3224445">isZero</span><span class="op" id="3224451">(</span><span class="ident" id="3224452">v</span><span class="op" id="3224453">)</span>&nbsp;<span class="op" id="3224455">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224460">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3224469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224473">state</span><span class="op" id="3224478">.</span><span class="ident" id="3224479">update</span><span class="op" id="3224485">(</span><span class="ident" id="3224486">i</span><span class="op" id="3224487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224491">state</span><span class="op" id="3224496">.</span><span class="ident" id="3224497">enc</span><span class="op" id="3224500">.</span><span class="ident" id="3224501">encodeGobEncoder</span><span class="op" id="3224517">(</span><span class="ident" id="3224518">state</span><span class="op" id="3224523">.</span><span class="ident" id="3224524">b</span><span class="op" id="3224525">,</span>&nbsp;<span class="ident" id="3224527">ut</span><span class="op" id="3224529">,</span>&nbsp;<span class="ident" id="3224531">v</span><span class="op" id="3224532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3224535">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224538">return</span>&nbsp;<span class="op" id="3224545">&amp;</span><span class="ident" id="3224546">op</span><span class="op" id="3224548">,</span>&nbsp;<span class="builtintype" id="3224550">int</span><span class="op" id="3224553">(</span><span class="ident" id="3224554">ut</span><span class="op" id="3224556">.</span><span class="ident" id="3224557">encIndir</span><span class="op" id="3224565">)</span>&nbsp;<span class="comment" id="3224567">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="3224630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3224633">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3224687">func</span>&nbsp;<span class="ident" id="3224692">compileEnc</span><span class="op" id="3224702">(</span><span class="ident" id="3224703">ut</span>&nbsp;<span class="op" id="3224706">*</span><span class="ident" id="3224707">userTypeInfo</span><span class="op" id="3224719">,</span>&nbsp;<span class="ident" id="3224721">building</span>&nbsp;<span class="keyword" id="3224730">map</span><span class="op" id="3224733">[</span><span class="op" id="3224734">*</span><span class="ident" id="3224735">typeInfo</span><span class="op" id="3224743">]</span><span class="builtintype" id="3224744">bool</span><span class="op" id="3224748">)</span>&nbsp;<span class="op" id="3224750">*</span><span class="ident" id="3224751">encEngine</span>&nbsp;<span class="op" id="3224761">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224764">srt</span>&nbsp;<span class="op" id="3224768">:=</span>&nbsp;<span class="ident" id="3224771">ut</span><span class="op" id="3224773">.</span><span class="ident" id="3224774">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224780">engine</span>&nbsp;<span class="op" id="3224787">:=</span>&nbsp;<span class="builtinfunc" id="3224790">new</span><span class="op" id="3224793">(</span><span class="ident" id="3224794">encEngine</span><span class="op" id="3224803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224806">seen</span>&nbsp;<span class="op" id="3224811">:=</span>&nbsp;<span class="builtinfunc" id="3224814">make</span><span class="op" id="3224818">(</span><span class="keyword" id="3224819">map</span><span class="op" id="3224822">[</span><span class="ident" id="3224823">reflect</span><span class="op" id="3224830">.</span><span class="ident" id="3224831">Type</span><span class="op" id="3224835">]</span><span class="op" id="3224836">*</span><span class="ident" id="3224837">encOp</span><span class="op" id="3224842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224845">rt</span>&nbsp;<span class="op" id="3224848">:=</span>&nbsp;<span class="ident" id="3224851">ut</span><span class="op" id="3224853">.</span><span class="ident" id="3224854">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224860">if</span>&nbsp;<span class="ident" id="3224863">ut</span><span class="op" id="3224865">.</span><span class="ident" id="3224866">externalEnc</span>&nbsp;<span class="op" id="3224878">!=</span>&nbsp;<span class="num" id="3224881">0</span>&nbsp;<span class="op" id="3224883">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224887">rt</span>&nbsp;<span class="op" id="3224890">=</span>&nbsp;<span class="ident" id="3224892">ut</span><span class="op" id="3224894">.</span><span class="ident" id="3224895">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3224901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224904">if</span>&nbsp;<span class="ident" id="3224907">ut</span><span class="op" id="3224909">.</span><span class="ident" id="3224910">externalEnc</span>&nbsp;<span class="op" id="3224922">==</span>&nbsp;<span class="num" id="3224925">0</span>&nbsp;<span class="op" id="3224927">&amp;&amp;</span>&nbsp;<span class="ident" id="3224930">srt</span><span class="op" id="3224933">.</span><span class="ident" id="3224934">Kind</span><span class="op" id="3224938">(</span><span class="op" id="3224939">)</span>&nbsp;<span class="op" id="3224941">==</span>&nbsp;<span class="ident" id="3224944">reflect</span><span class="op" id="3224951">.</span><span class="ident" id="3224952">Struct</span>&nbsp;<span class="op" id="3224959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224963">for</span>&nbsp;<span class="ident" id="3224967">fieldNum</span><span class="op" id="3224975">,</span>&nbsp;<span class="ident" id="3224977">wireFieldNum</span>&nbsp;<span class="op" id="3224990">:=</span>&nbsp;<span class="num" id="3224993">0</span><span class="op" id="3224994">,</span>&nbsp;<span class="num" id="3224996">0</span><span class="op" id="3224997">;</span>&nbsp;<span class="ident" id="3224999">fieldNum</span>&nbsp;<span class="op" id="3225008">&lt;</span>&nbsp;<span class="ident" id="3225010">srt</span><span class="op" id="3225013">.</span><span class="ident" id="3225014">NumField</span><span class="op" id="3225022">(</span><span class="op" id="3225023">)</span><span class="op" id="3225024">;</span>&nbsp;<span class="ident" id="3225026">fieldNum</span><span class="op" id="3225034">++</span>&nbsp;<span class="op" id="3225037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225042">f</span>&nbsp;<span class="op" id="3225044">:=</span>&nbsp;<span class="ident" id="3225047">srt</span><span class="op" id="3225050">.</span><span class="ident" id="3225051">Field</span><span class="op" id="3225056">(</span><span class="ident" id="3225057">fieldNum</span><span class="op" id="3225065">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3225070">if</span>&nbsp;<span class="op" id="3225073">!</span><span class="ident" id="3225074">isSent</span><span class="op" id="3225080">(</span><span class="op" id="3225081">&amp;</span><span class="ident" id="3225082">f</span><span class="op" id="3225083">)</span>&nbsp;<span class="op" id="3225085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3225091">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3225103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225108">op</span><span class="op" id="3225110">,</span>&nbsp;<span class="ident" id="3225112">indir</span>&nbsp;<span class="op" id="3225118">:=</span>&nbsp;<span class="ident" id="3225121">encOpFor</span><span class="op" id="3225129">(</span><span class="ident" id="3225130">f</span><span class="op" id="3225131">.</span><span class="ident" id="3225132">Type</span><span class="op" id="3225136">,</span>&nbsp;<span class="ident" id="3225138">seen</span><span class="op" id="3225142">,</span>&nbsp;<span class="ident" id="3225144">building</span><span class="op" id="3225152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225157">engine</span><span class="op" id="3225163">.</span><span class="ident" id="3225164">instr</span>&nbsp;<span class="op" id="3225170">=</span>&nbsp;<span class="builtinfunc" id="3225172">append</span><span class="op" id="3225178">(</span><span class="ident" id="3225179">engine</span><span class="op" id="3225185">.</span><span class="ident" id="3225186">instr</span><span class="op" id="3225191">,</span>&nbsp;<span class="ident" id="3225193">encInstr</span><span class="op" id="3225201">{</span><span class="op" id="3225202">*</span><span class="ident" id="3225203">op</span><span class="op" id="3225205">,</span>&nbsp;<span class="ident" id="3225207">wireFieldNum</span><span class="op" id="3225219">,</span>&nbsp;<span class="ident" id="3225221">f</span><span class="op" id="3225222">.</span><span class="ident" id="3225223">Index</span><span class="op" id="3225228">,</span>&nbsp;<span class="ident" id="3225230">indir</span><span class="op" id="3225235">}</span><span class="op" id="3225236">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225241">wireFieldNum</span><span class="op" id="3225253">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3225258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3225262">if</span>&nbsp;<span class="ident" id="3225265">srt</span><span class="op" id="3225268">.</span><span class="ident" id="3225269">NumField</span><span class="op" id="3225277">(</span><span class="op" id="3225278">)</span>&nbsp;<span class="op" id="3225280">&gt;</span>&nbsp;<span class="num" id="3225282">0</span>&nbsp;<span class="op" id="3225284">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3225287">len</span><span class="op" id="3225290">(</span><span class="ident" id="3225291">engine</span><span class="op" id="3225297">.</span><span class="ident" id="3225298">instr</span><span class="op" id="3225303">)</span>&nbsp;<span class="op" id="3225305">==</span>&nbsp;<span class="num" id="3225308">0</span>&nbsp;<span class="op" id="3225310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225315">errorf</span><span class="op" id="3225321">(</span><span class="string" id="3225322">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="3225354">,</span>&nbsp;<span class="ident" id="3225356">rt</span><span class="op" id="3225358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3225362">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225366">engine</span><span class="op" id="3225372">.</span><span class="ident" id="3225373">instr</span>&nbsp;<span class="op" id="3225379">=</span>&nbsp;<span class="builtinfunc" id="3225381">append</span><span class="op" id="3225387">(</span><span class="ident" id="3225388">engine</span><span class="op" id="3225394">.</span><span class="ident" id="3225395">instr</span><span class="op" id="3225400">,</span>&nbsp;<span class="ident" id="3225402">encInstr</span><span class="op" id="3225410">{</span><span class="ident" id="3225411">encStructTerminator</span><span class="op" id="3225430">,</span>&nbsp;<span class="num" id="3225432">0</span><span class="op" id="3225433">,</span>&nbsp;<span class="ident" id="3225435">nil</span><span class="op" id="3225438">,</span>&nbsp;<span class="num" id="3225440">0</span><span class="op" id="3225441">}</span><span class="op" id="3225442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3225445">}</span>&nbsp;<span class="keyword" id="3225447">else</span>&nbsp;<span class="op" id="3225452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225456">engine</span><span class="op" id="3225462">.</span><span class="ident" id="3225463">instr</span>&nbsp;<span class="op" id="3225469">=</span>&nbsp;<span class="builtinfunc" id="3225471">make</span><span class="op" id="3225475">(</span><span class="op" id="3225476">[</span><span class="op" id="3225477">]</span><span class="ident" id="3225478">encInstr</span><span class="op" id="3225486">,</span>&nbsp;<span class="num" id="3225488">1</span><span class="op" id="3225489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225493">op</span><span class="op" id="3225495">,</span>&nbsp;<span class="ident" id="3225497">indir</span>&nbsp;<span class="op" id="3225503">:=</span>&nbsp;<span class="ident" id="3225506">encOpFor</span><span class="op" id="3225514">(</span><span class="ident" id="3225515">rt</span><span class="op" id="3225517">,</span>&nbsp;<span class="ident" id="3225519">seen</span><span class="op" id="3225523">,</span>&nbsp;<span class="ident" id="3225525">building</span><span class="op" id="3225533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225537">engine</span><span class="op" id="3225543">.</span><span class="ident" id="3225544">instr</span><span class="op" id="3225549">[</span><span class="num" id="3225550">0</span><span class="op" id="3225551">]</span>&nbsp;<span class="op" id="3225553">=</span>&nbsp;<span class="ident" id="3225555">encInstr</span><span class="op" id="3225563">{</span><span class="op" id="3225564">*</span><span class="ident" id="3225565">op</span><span class="op" id="3225567">,</span>&nbsp;<span class="ident" id="3225569">singletonField</span><span class="op" id="3225583">,</span>&nbsp;<span class="ident" id="3225585">nil</span><span class="op" id="3225588">,</span>&nbsp;<span class="ident" id="3225590">indir</span><span class="op" id="3225595">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3225598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3225601">return</span>&nbsp;<span class="ident" id="3225608">engine</span><br>
<span class="lineno"></span><span class="op" id="3225615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3225618">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="3225674">func</span>&nbsp;<span class="ident" id="3225679">getEncEngine</span><span class="op" id="3225691">(</span><span class="ident" id="3225692">ut</span>&nbsp;<span class="op" id="3225695">*</span><span class="ident" id="3225696">userTypeInfo</span><span class="op" id="3225708">,</span>&nbsp;<span class="ident" id="3225710">building</span>&nbsp;<span class="keyword" id="3225719">map</span><span class="op" id="3225722">[</span><span class="op" id="3225723">*</span><span class="ident" id="3225724">typeInfo</span><span class="op" id="3225732">]</span><span class="builtintype" id="3225733">bool</span><span class="op" id="3225737">)</span>&nbsp;<span class="op" id="3225739">*</span><span class="ident" id="3225740">encEngine</span>&nbsp;<span class="op" id="3225750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225753">info</span><span class="op" id="3225757">,</span>&nbsp;<span class="ident" id="3225759">err</span>&nbsp;<span class="op" id="3225763">:=</span>&nbsp;<span class="ident" id="3225766">getTypeInfo</span><span class="op" id="3225777">(</span><span class="ident" id="3225778">ut</span><span class="op" id="3225780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3225783">if</span>&nbsp;<span class="ident" id="3225786">err</span>&nbsp;<span class="op" id="3225790">!=</span>&nbsp;<span class="ident" id="3225793">nil</span>&nbsp;<span class="op" id="3225797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225801">error_</span><span class="op" id="3225807">(</span><span class="ident" id="3225808">err</span><span class="op" id="3225811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3225814">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225817">enc</span><span class="op" id="3225820">,</span>&nbsp;<span class="ident" id="3225822">ok</span>&nbsp;<span class="op" id="3225825">:=</span>&nbsp;<span class="ident" id="3225828">info</span><span class="op" id="3225832">.</span><span class="ident" id="3225833">encoder</span><span class="op" id="3225840">.</span><span class="ident" id="3225841">Load</span><span class="op" id="3225845">(</span><span class="op" id="3225846">)</span><span class="op" id="3225847">.</span><span class="op" id="3225848">(</span><span class="op" id="3225849">*</span><span class="ident" id="3225850">encEngine</span><span class="op" id="3225859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3225862">if</span>&nbsp;<span class="op" id="3225865">!</span><span class="ident" id="3225866">ok</span>&nbsp;<span class="op" id="3225869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3225873">enc</span>&nbsp;<span class="op" id="3225877">=</span>&nbsp;<span class="ident" id="3225879">buildEncEngine</span><span class="op" id="3225893">(</span><span class="ident" id="3225894">info</span><span class="op" id="3225898">,</span>&nbsp;<span class="ident" id="3225900">ut</span><span class="op" id="3225902">,</span>&nbsp;<span class="ident" id="3225904">building</span><span class="op" id="3225912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3225915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3225918">return</span>&nbsp;<span class="ident" id="3225925">enc</span><br>
<span class="lineno">660</span><span class="op" id="3225929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3225932">func</span>&nbsp;<span class="ident" id="3225937">buildEncEngine</span><span class="op" id="3225951">(</span><span class="ident" id="3225952">info</span>&nbsp;<span class="op" id="3225957">*</span><span class="ident" id="3225958">typeInfo</span><span class="op" id="3225966">,</span>&nbsp;<span class="ident" id="3225968">ut</span>&nbsp;<span class="op" id="3225971">*</span><span class="ident" id="3225972">userTypeInfo</span><span class="op" id="3225984">,</span>&nbsp;<span class="ident" id="3225986">building</span>&nbsp;<span class="keyword" id="3225995">map</span><span class="op" id="3225998">[</span><span class="op" id="3225999">*</span><span class="ident" id="3226000">typeInfo</span><span class="op" id="3226008">]</span><span class="builtintype" id="3226009">bool</span><span class="op" id="3226013">)</span>&nbsp;<span class="op" id="3226015">*</span><span class="ident" id="3226016">encEngine</span>&nbsp;<span class="op" id="3226026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3226029">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226060">if</span>&nbsp;<span class="ident" id="3226063">building</span>&nbsp;<span class="op" id="3226072">!=</span>&nbsp;<span class="ident" id="3226075">nil</span>&nbsp;<span class="op" id="3226079">&amp;&amp;</span>&nbsp;<span class="ident" id="3226082">building</span><span class="op" id="3226090">[</span><span class="ident" id="3226091">info</span><span class="op" id="3226095">]</span>&nbsp;<span class="op" id="3226097">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226101">return</span>&nbsp;<span class="ident" id="3226108">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3226113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226116">info</span><span class="op" id="3226120">.</span><span class="ident" id="3226121">encInit</span><span class="op" id="3226128">.</span><span class="ident" id="3226129">Lock</span><span class="op" id="3226133">(</span><span class="op" id="3226134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226137">defer</span>&nbsp;<span class="ident" id="3226143">info</span><span class="op" id="3226147">.</span><span class="ident" id="3226148">encInit</span><span class="op" id="3226155">.</span><span class="ident" id="3226156">Unlock</span><span class="op" id="3226162">(</span><span class="op" id="3226163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226166">enc</span><span class="op" id="3226169">,</span>&nbsp;<span class="ident" id="3226171">ok</span>&nbsp;<span class="op" id="3226174">:=</span>&nbsp;<span class="ident" id="3226177">info</span><span class="op" id="3226181">.</span><span class="ident" id="3226182">encoder</span><span class="op" id="3226189">.</span><span class="ident" id="3226190">Load</span><span class="op" id="3226194">(</span><span class="op" id="3226195">)</span><span class="op" id="3226196">.</span><span class="op" id="3226197">(</span><span class="op" id="3226198">*</span><span class="ident" id="3226199">encEngine</span><span class="op" id="3226208">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226211">if</span>&nbsp;<span class="op" id="3226214">!</span><span class="ident" id="3226215">ok</span>&nbsp;<span class="op" id="3226218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226222">if</span>&nbsp;<span class="ident" id="3226225">building</span>&nbsp;<span class="op" id="3226234">==</span>&nbsp;<span class="ident" id="3226237">nil</span>&nbsp;<span class="op" id="3226241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226246">building</span>&nbsp;<span class="op" id="3226255">=</span>&nbsp;<span class="builtinfunc" id="3226257">make</span><span class="op" id="3226261">(</span><span class="keyword" id="3226262">map</span><span class="op" id="3226265">[</span><span class="op" id="3226266">*</span><span class="ident" id="3226267">typeInfo</span><span class="op" id="3226275">]</span><span class="builtintype" id="3226276">bool</span><span class="op" id="3226280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3226284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226288">building</span><span class="op" id="3226296">[</span><span class="ident" id="3226297">info</span><span class="op" id="3226301">]</span>&nbsp;<span class="op" id="3226303">=</span>&nbsp;<span class="ident" id="3226305">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226312">enc</span>&nbsp;<span class="op" id="3226316">=</span>&nbsp;<span class="ident" id="3226318">compileEnc</span><span class="op" id="3226328">(</span><span class="ident" id="3226329">ut</span><span class="op" id="3226331">,</span>&nbsp;<span class="ident" id="3226333">building</span><span class="op" id="3226341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226345">info</span><span class="op" id="3226349">.</span><span class="ident" id="3226350">encoder</span><span class="op" id="3226357">.</span><span class="ident" id="3226358">Store</span><span class="op" id="3226363">(</span><span class="ident" id="3226364">enc</span><span class="op" id="3226367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3226370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226373">return</span>&nbsp;<span class="ident" id="3226380">enc</span><br>
<span class="lineno"></span><span class="op" id="3226384">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="3226387">func</span>&nbsp;<span class="op" id="3226392">(</span><span class="ident" id="3226393">enc</span>&nbsp;<span class="op" id="3226397">*</span><span class="ident" id="3226398">Encoder</span><span class="op" id="3226405">)</span>&nbsp;<span class="ident" id="3226407">encode</span><span class="op" id="3226413">(</span><span class="ident" id="3226414">b</span>&nbsp;<span class="op" id="3226416">*</span><span class="ident" id="3226417">encBuffer</span><span class="op" id="3226426">,</span>&nbsp;<span class="ident" id="3226428">value</span>&nbsp;<span class="ident" id="3226434">reflect</span><span class="op" id="3226441">.</span><span class="ident" id="3226442">Value</span><span class="op" id="3226447">,</span>&nbsp;<span class="ident" id="3226449">ut</span>&nbsp;<span class="op" id="3226452">*</span><span class="ident" id="3226453">userTypeInfo</span><span class="op" id="3226465">)</span>&nbsp;<span class="op" id="3226467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226470">defer</span>&nbsp;<span class="ident" id="3226476">catchError</span><span class="op" id="3226486">(</span><span class="op" id="3226487">&amp;</span><span class="ident" id="3226488">enc</span><span class="op" id="3226491">.</span><span class="ident" id="3226492">err</span><span class="op" id="3226495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226498">engine</span>&nbsp;<span class="op" id="3226505">:=</span>&nbsp;<span class="ident" id="3226508">getEncEngine</span><span class="op" id="3226520">(</span><span class="ident" id="3226521">ut</span><span class="op" id="3226523">,</span>&nbsp;<span class="ident" id="3226525">nil</span><span class="op" id="3226528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226531">indir</span>&nbsp;<span class="op" id="3226537">:=</span>&nbsp;<span class="ident" id="3226540">ut</span><span class="op" id="3226542">.</span><span class="ident" id="3226543">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226550">if</span>&nbsp;<span class="ident" id="3226553">ut</span><span class="op" id="3226555">.</span><span class="ident" id="3226556">externalEnc</span>&nbsp;<span class="op" id="3226568">!=</span>&nbsp;<span class="num" id="3226571">0</span>&nbsp;<span class="op" id="3226573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226577">indir</span>&nbsp;<span class="op" id="3226583">=</span>&nbsp;<span class="builtintype" id="3226585">int</span><span class="op" id="3226588">(</span><span class="ident" id="3226589">ut</span><span class="op" id="3226591">.</span><span class="ident" id="3226592">encIndir</span><span class="op" id="3226600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3226603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226606">for</span>&nbsp;<span class="ident" id="3226610">i</span>&nbsp;<span class="op" id="3226612">:=</span>&nbsp;<span class="num" id="3226615">0</span><span class="op" id="3226616">;</span>&nbsp;<span class="ident" id="3226618">i</span>&nbsp;<span class="op" id="3226620">&lt;</span>&nbsp;<span class="ident" id="3226622">indir</span><span class="op" id="3226627">;</span>&nbsp;<span class="ident" id="3226629">i</span><span class="op" id="3226630">++</span>&nbsp;<span class="op" id="3226633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226637">value</span>&nbsp;<span class="op" id="3226643">=</span>&nbsp;<span class="ident" id="3226645">reflect</span><span class="op" id="3226652">.</span><span class="ident" id="3226653">Indirect</span><span class="op" id="3226661">(</span><span class="ident" id="3226662">value</span><span class="op" id="3226667">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3226670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226673">if</span>&nbsp;<span class="ident" id="3226676">ut</span><span class="op" id="3226678">.</span><span class="ident" id="3226679">externalEnc</span>&nbsp;<span class="op" id="3226691">==</span>&nbsp;<span class="num" id="3226694">0</span>&nbsp;<span class="op" id="3226696">&amp;&amp;</span>&nbsp;<span class="ident" id="3226699">value</span><span class="op" id="3226704">.</span><span class="ident" id="3226705">Type</span><span class="op" id="3226709">(</span><span class="op" id="3226710">)</span><span class="op" id="3226711">.</span><span class="ident" id="3226712">Kind</span><span class="op" id="3226716">(</span><span class="op" id="3226717">)</span>&nbsp;<span class="op" id="3226719">==</span>&nbsp;<span class="ident" id="3226722">reflect</span><span class="op" id="3226729">.</span><span class="ident" id="3226730">Struct</span>&nbsp;<span class="op" id="3226737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226741">enc</span><span class="op" id="3226744">.</span><span class="ident" id="3226745">encodeStruct</span><span class="op" id="3226757">(</span><span class="ident" id="3226758">b</span><span class="op" id="3226759">,</span>&nbsp;<span class="ident" id="3226761">engine</span><span class="op" id="3226767">,</span>&nbsp;<span class="ident" id="3226769">value</span><span class="op" id="3226774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3226777">}</span>&nbsp;<span class="keyword" id="3226779">else</span>&nbsp;<span class="op" id="3226784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226788">enc</span><span class="op" id="3226791">.</span><span class="ident" id="3226792">encodeSingle</span><span class="op" id="3226804">(</span><span class="ident" id="3226805">b</span><span class="op" id="3226806">,</span>&nbsp;<span class="ident" id="3226808">engine</span><span class="op" id="3226814">,</span>&nbsp;<span class="ident" id="3226816">value</span><span class="op" id="3226821">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3226824">}</span><br>
<span class="lineno"></span><span class="op" id="3226826">}</span>
</div>
</body>
</html>
