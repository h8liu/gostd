<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3640760">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3640815">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3640869">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3640920">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3640966">package</span>&nbsp;<span class="ident" id="3640974">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3640979">import</span>&nbsp;<span class="op" id="3640986">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3640989">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3640998">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3641015">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3641032">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3641047">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3641057">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3641064">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3641070">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3641077">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3641085">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3641092">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3641095">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3641138">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3641179">type</span>&nbsp;<span class="ident" id="3641184">Conn</span>&nbsp;<span class="keyword" id="3641189">struct</span>&nbsp;<span class="op" id="3641196">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3641199">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641212">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641221">net</span><span class="op" id="3641224">.</span><span class="ident" id="3641225">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641231">isClient</span>&nbsp;<span class="builtintype" id="3641240">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3641247">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641305">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641323">sync</span><span class="op" id="3641327">.</span><span class="ident" id="3641328">Mutex</span>&nbsp;<span class="comment" id="3641334">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641385">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3641403">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3641414">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641449">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3641467">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3641478">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641494">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3641512">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3641523">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641555">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3641573">*</span><span class="ident" id="3641574">Config</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3641584">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641624">handshakeComplete</span>&nbsp;<span class="builtintype" id="3641642">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641648">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3641666">bool</span>&nbsp;<span class="comment" id="3641671">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641724">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3641742">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641750">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3641768">[</span><span class="op" id="3641769">]</span><span class="builtintype" id="3641770">byte</span>&nbsp;<span class="comment" id="3641775">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641801">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="3641819">[</span><span class="op" id="3641820">]</span><span class="op" id="3641821">*</span><span class="ident" id="3641822">x509</span><span class="op" id="3641826">.</span><span class="ident" id="3641827">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3641840">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3641909">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3641958">verifiedChains</span>&nbsp;<span class="op" id="3641973">[</span><span class="op" id="3641974">]</span><span class="op" id="3641975">[</span><span class="op" id="3641976">]</span><span class="op" id="3641977">*</span><span class="ident" id="3641978">x509</span><span class="op" id="3641982">.</span><span class="ident" id="3641983">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3641996">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3642069">serverName</span>&nbsp;<span class="builtintype" id="3642080">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3642088">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3642155">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3642218">firstFinished</span>&nbsp;<span class="op" id="3642232">[</span><span class="num" id="3642233">12</span><span class="op" id="3642235">]</span><span class="builtintype" id="3642236">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3642243">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3642266">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3642274">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="3642297">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3642304">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3642321">in</span><span class="op" id="3642323">,</span>&nbsp;<span class="ident" id="3642325">out</span>&nbsp;&nbsp;<span class="ident" id="3642330">halfConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642343">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3642368">rawInput</span>&nbsp;<span class="op" id="3642377">*</span><span class="ident" id="3642378">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642390">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3642424">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3642433">*</span><span class="ident" id="3642434">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642446">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3642486">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642495">bytes</span><span class="op" id="3642500">.</span><span class="ident" id="3642501">Buffer</span>&nbsp;<span class="comment" id="3642508">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3642547">tmp</span>&nbsp;<span class="op" id="3642551">[</span><span class="num" id="3642552">16</span><span class="op" id="3642554">]</span><span class="builtintype" id="3642555">byte</span><br>
<span class="lineno"></span><span class="op" id="3642560">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3642563">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="3642594">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="3642643">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3642676">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3642724">func</span>&nbsp;<span class="op" id="3642729">(</span><span class="ident" id="3642730">c</span>&nbsp;<span class="op" id="3642732">*</span><span class="ident" id="3642733">Conn</span><span class="op" id="3642737">)</span>&nbsp;<span class="ident" id="3642739">LocalAddr</span><span class="op" id="3642748">(</span><span class="op" id="3642749">)</span>&nbsp;<span class="ident" id="3642751">net</span><span class="op" id="3642754">.</span><span class="ident" id="3642755">Addr</span>&nbsp;<span class="op" id="3642760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3642763">return</span>&nbsp;<span class="ident" id="3642770">c</span><span class="op" id="3642771">.</span><span class="ident" id="3642772">conn</span><span class="op" id="3642776">.</span><span class="ident" id="3642777">LocalAddr</span><span class="op" id="3642786">(</span><span class="op" id="3642787">)</span><br>
<span class="lineno"></span><span class="op" id="3642789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="3642792">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3642842">func</span>&nbsp;<span class="op" id="3642847">(</span><span class="ident" id="3642848">c</span>&nbsp;<span class="op" id="3642850">*</span><span class="ident" id="3642851">Conn</span><span class="op" id="3642855">)</span>&nbsp;<span class="ident" id="3642857">RemoteAddr</span><span class="op" id="3642867">(</span><span class="op" id="3642868">)</span>&nbsp;<span class="ident" id="3642870">net</span><span class="op" id="3642873">.</span><span class="ident" id="3642874">Addr</span>&nbsp;<span class="op" id="3642879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3642882">return</span>&nbsp;<span class="ident" id="3642889">c</span><span class="op" id="3642890">.</span><span class="ident" id="3642891">conn</span><span class="op" id="3642895">.</span><span class="ident" id="3642896">RemoteAddr</span><span class="op" id="3642906">(</span><span class="op" id="3642907">)</span><br>
<span class="lineno"></span><span class="op" id="3642909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3642912">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3642993">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3643055">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3643162">func</span>&nbsp;<span class="op" id="3643167">(</span><span class="ident" id="3643168">c</span>&nbsp;<span class="op" id="3643170">*</span><span class="ident" id="3643171">Conn</span><span class="op" id="3643175">)</span>&nbsp;<span class="ident" id="3643177">SetDeadline</span><span class="op" id="3643188">(</span><span class="ident" id="3643189">t</span>&nbsp;<span class="ident" id="3643191">time</span><span class="op" id="3643195">.</span><span class="ident" id="3643196">Time</span><span class="op" id="3643200">)</span>&nbsp;<span class="builtintype" id="3643202">error</span>&nbsp;<span class="op" id="3643208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3643211">return</span>&nbsp;<span class="ident" id="3643218">c</span><span class="op" id="3643219">.</span><span class="ident" id="3643220">conn</span><span class="op" id="3643224">.</span><span class="ident" id="3643225">SetDeadline</span><span class="op" id="3643236">(</span><span class="ident" id="3643237">t</span><span class="op" id="3643238">)</span><br>
<span class="lineno">80</span><span class="op" id="3643240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3643243">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3643315">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3643367">func</span>&nbsp;<span class="op" id="3643372">(</span><span class="ident" id="3643373">c</span>&nbsp;<span class="op" id="3643375">*</span><span class="ident" id="3643376">Conn</span><span class="op" id="3643380">)</span>&nbsp;<span class="ident" id="3643382">SetReadDeadline</span><span class="op" id="3643397">(</span><span class="ident" id="3643398">t</span>&nbsp;<span class="ident" id="3643400">time</span><span class="op" id="3643404">.</span><span class="ident" id="3643405">Time</span><span class="op" id="3643409">)</span>&nbsp;<span class="builtintype" id="3643411">error</span>&nbsp;<span class="op" id="3643417">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3643420">return</span>&nbsp;<span class="ident" id="3643427">c</span><span class="op" id="3643428">.</span><span class="ident" id="3643429">conn</span><span class="op" id="3643433">.</span><span class="ident" id="3643434">SetReadDeadline</span><span class="op" id="3643449">(</span><span class="ident" id="3643450">t</span><span class="op" id="3643451">)</span><br>
<span class="lineno"></span><span class="op" id="3643453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3643456">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3643530">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="3643583">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3643690">func</span>&nbsp;<span class="op" id="3643695">(</span><span class="ident" id="3643696">c</span>&nbsp;<span class="op" id="3643698">*</span><span class="ident" id="3643699">Conn</span><span class="op" id="3643703">)</span>&nbsp;<span class="ident" id="3643705">SetWriteDeadline</span><span class="op" id="3643721">(</span><span class="ident" id="3643722">t</span>&nbsp;<span class="ident" id="3643724">time</span><span class="op" id="3643728">.</span><span class="ident" id="3643729">Time</span><span class="op" id="3643733">)</span>&nbsp;<span class="builtintype" id="3643735">error</span>&nbsp;<span class="op" id="3643741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3643744">return</span>&nbsp;<span class="ident" id="3643751">c</span><span class="op" id="3643752">.</span><span class="ident" id="3643753">conn</span><span class="op" id="3643757">.</span><span class="ident" id="3643758">SetWriteDeadline</span><span class="op" id="3643774">(</span><span class="ident" id="3643775">t</span><span class="op" id="3643776">)</span><br>
<span class="lineno"></span><span class="op" id="3643778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3643781">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="3643840">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="3643884">type</span>&nbsp;<span class="ident" id="3643889">halfConn</span>&nbsp;<span class="keyword" id="3643898">struct</span>&nbsp;<span class="op" id="3643905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3643908">sync</span><span class="op" id="3643912">.</span><span class="ident" id="3643913">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3643921">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3643929">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643941">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3643967">version</span>&nbsp;<span class="builtintype" id="3643975">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643987">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644008">cipher</span>&nbsp;&nbsp;<span class="keyword" id="3644016">interface</span><span class="op" id="3644025">{</span><span class="op" id="3644026">}</span>&nbsp;<span class="comment" id="3644028">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644049">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3644057">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644070">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3644078">[</span><span class="num" id="3644079">8</span><span class="op" id="3644080">]</span><span class="builtintype" id="3644081">byte</span>&nbsp;<span class="comment" id="3644086">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644113">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3644121">*</span><span class="ident" id="3644122">block</span>&nbsp;&nbsp;<span class="comment" id="3644129">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644154">nextCipher</span>&nbsp;<span class="keyword" id="3644165">interface</span><span class="op" id="3644174">{</span><span class="op" id="3644175">}</span>&nbsp;<span class="comment" id="3644177">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644203">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3644214">macFunction</span>&nbsp;<span class="comment" id="3644226">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3644250">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644305">inDigestBuf</span><span class="op" id="3644316">,</span>&nbsp;<span class="ident" id="3644318">outDigestBuf</span>&nbsp;<span class="op" id="3644331">[</span><span class="op" id="3644332">]</span><span class="builtintype" id="3644333">byte</span><br>
<span class="lineno"></span><span class="op" id="3644338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3644341">func</span>&nbsp;<span class="op" id="3644346">(</span><span class="ident" id="3644347">hc</span>&nbsp;<span class="op" id="3644350">*</span><span class="ident" id="3644351">halfConn</span><span class="op" id="3644359">)</span>&nbsp;<span class="ident" id="3644361">setErrorLocked</span><span class="op" id="3644375">(</span><span class="ident" id="3644376">err</span>&nbsp;<span class="builtintype" id="3644380">error</span><span class="op" id="3644385">)</span>&nbsp;<span class="builtintype" id="3644387">error</span>&nbsp;<span class="op" id="3644393">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644396">hc</span><span class="op" id="3644398">.</span><span class="ident" id="3644399">err</span>&nbsp;<span class="op" id="3644403">=</span>&nbsp;<span class="ident" id="3644405">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3644410">return</span>&nbsp;<span class="ident" id="3644417">err</span><br>
<span class="lineno"></span><span class="op" id="3644421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3644424">func</span>&nbsp;<span class="op" id="3644429">(</span><span class="ident" id="3644430">hc</span>&nbsp;<span class="op" id="3644433">*</span><span class="ident" id="3644434">halfConn</span><span class="op" id="3644442">)</span>&nbsp;<span class="builtintype" id="3644444">error</span><span class="op" id="3644449">(</span><span class="op" id="3644450">)</span>&nbsp;<span class="builtintype" id="3644452">error</span>&nbsp;<span class="op" id="3644458">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644461">hc</span><span class="op" id="3644463">.</span><span class="ident" id="3644464">Lock</span><span class="op" id="3644468">(</span><span class="op" id="3644469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644472">err</span>&nbsp;<span class="op" id="3644476">:=</span>&nbsp;<span class="ident" id="3644479">hc</span><span class="op" id="3644481">.</span><span class="ident" id="3644482">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644487">hc</span><span class="op" id="3644489">.</span><span class="ident" id="3644490">Unlock</span><span class="op" id="3644496">(</span><span class="op" id="3644497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3644500">return</span>&nbsp;<span class="ident" id="3644507">err</span><br>
<span class="lineno"></span><span class="op" id="3644511">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="3644514">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="3644570">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3644618">func</span>&nbsp;<span class="op" id="3644623">(</span><span class="ident" id="3644624">hc</span>&nbsp;<span class="op" id="3644627">*</span><span class="ident" id="3644628">halfConn</span><span class="op" id="3644636">)</span>&nbsp;<span class="ident" id="3644638">prepareCipherSpec</span><span class="op" id="3644655">(</span><span class="ident" id="3644656">version</span>&nbsp;<span class="builtintype" id="3644664">uint16</span><span class="op" id="3644670">,</span>&nbsp;<span class="ident" id="3644672">cipher</span>&nbsp;<span class="keyword" id="3644679">interface</span><span class="op" id="3644688">{</span><span class="op" id="3644689">}</span><span class="op" id="3644690">,</span>&nbsp;<span class="ident" id="3644692">mac</span>&nbsp;<span class="ident" id="3644696">macFunction</span><span class="op" id="3644707">)</span>&nbsp;<span class="op" id="3644709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644712">hc</span><span class="op" id="3644714">.</span><span class="ident" id="3644715">version</span>&nbsp;<span class="op" id="3644723">=</span>&nbsp;<span class="ident" id="3644725">version</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644734">hc</span><span class="op" id="3644736">.</span><span class="ident" id="3644737">nextCipher</span>&nbsp;<span class="op" id="3644748">=</span>&nbsp;<span class="ident" id="3644750">cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644758">hc</span><span class="op" id="3644760">.</span><span class="ident" id="3644761">nextMac</span>&nbsp;<span class="op" id="3644769">=</span>&nbsp;<span class="ident" id="3644771">mac</span><br>
<span class="lineno"></span><span class="op" id="3644775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3644778">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="3644836">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="3644891">func</span>&nbsp;<span class="op" id="3644896">(</span><span class="ident" id="3644897">hc</span>&nbsp;<span class="op" id="3644900">*</span><span class="ident" id="3644901">halfConn</span><span class="op" id="3644909">)</span>&nbsp;<span class="ident" id="3644911">changeCipherSpec</span><span class="op" id="3644927">(</span><span class="op" id="3644928">)</span>&nbsp;<span class="builtintype" id="3644930">error</span>&nbsp;<span class="op" id="3644936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3644939">if</span>&nbsp;<span class="ident" id="3644942">hc</span><span class="op" id="3644944">.</span><span class="ident" id="3644945">nextCipher</span>&nbsp;<span class="op" id="3644956">==</span>&nbsp;<span class="ident" id="3644959">nil</span>&nbsp;<span class="op" id="3644963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3644967">return</span>&nbsp;<span class="ident" id="3644974">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3644994">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644997">hc</span><span class="op" id="3644999">.</span><span class="ident" id="3645000">cipher</span>&nbsp;<span class="op" id="3645007">=</span>&nbsp;<span class="ident" id="3645009">hc</span><span class="op" id="3645011">.</span><span class="ident" id="3645012">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645024">hc</span><span class="op" id="3645026">.</span><span class="ident" id="3645027">mac</span>&nbsp;<span class="op" id="3645031">=</span>&nbsp;<span class="ident" id="3645033">hc</span><span class="op" id="3645035">.</span><span class="ident" id="3645036">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645045">hc</span><span class="op" id="3645047">.</span><span class="ident" id="3645048">nextCipher</span>&nbsp;<span class="op" id="3645059">=</span>&nbsp;<span class="ident" id="3645061">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645066">hc</span><span class="op" id="3645068">.</span><span class="ident" id="3645069">nextMac</span>&nbsp;<span class="op" id="3645077">=</span>&nbsp;<span class="ident" id="3645079">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645084">for</span>&nbsp;<span class="ident" id="3645088">i</span>&nbsp;<span class="op" id="3645090">:=</span>&nbsp;<span class="keyword" id="3645093">range</span>&nbsp;<span class="ident" id="3645099">hc</span><span class="op" id="3645101">.</span><span class="ident" id="3645102">seq</span>&nbsp;<span class="op" id="3645106">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645110">hc</span><span class="op" id="3645112">.</span><span class="ident" id="3645113">seq</span><span class="op" id="3645116">[</span><span class="ident" id="3645117">i</span><span class="op" id="3645118">]</span>&nbsp;<span class="op" id="3645120">=</span>&nbsp;<span class="num" id="3645122">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3645125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645128">return</span>&nbsp;<span class="ident" id="3645135">nil</span><br>
<span class="lineno"></span><span class="op" id="3645139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="3645142">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="3645184">func</span>&nbsp;<span class="op" id="3645189">(</span><span class="ident" id="3645190">hc</span>&nbsp;<span class="op" id="3645193">*</span><span class="ident" id="3645194">halfConn</span><span class="op" id="3645202">)</span>&nbsp;<span class="ident" id="3645204">incSeq</span><span class="op" id="3645210">(</span><span class="op" id="3645211">)</span>&nbsp;<span class="op" id="3645213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645216">for</span>&nbsp;<span class="ident" id="3645220">i</span>&nbsp;<span class="op" id="3645222">:=</span>&nbsp;<span class="num" id="3645225">7</span><span class="op" id="3645226">;</span>&nbsp;<span class="ident" id="3645228">i</span>&nbsp;<span class="op" id="3645230">&gt;=</span>&nbsp;<span class="num" id="3645233">0</span><span class="op" id="3645234">;</span>&nbsp;<span class="ident" id="3645236">i</span><span class="op" id="3645237">--</span>&nbsp;<span class="op" id="3645240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645244">hc</span><span class="op" id="3645246">.</span><span class="ident" id="3645247">seq</span><span class="op" id="3645250">[</span><span class="ident" id="3645251">i</span><span class="op" id="3645252">]</span><span class="op" id="3645253">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645258">if</span>&nbsp;<span class="ident" id="3645261">hc</span><span class="op" id="3645263">.</span><span class="ident" id="3645264">seq</span><span class="op" id="3645267">[</span><span class="ident" id="3645268">i</span><span class="op" id="3645269">]</span>&nbsp;<span class="op" id="3645271">!=</span>&nbsp;<span class="num" id="3645274">0</span>&nbsp;<span class="op" id="3645276">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645281">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3645290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3645293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3645297">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3645342">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3645388">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3645421">panic</span><span class="op" id="3645426">(</span><span class="string" id="3645427">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="3645460">)</span><br>
<span class="lineno"></span><span class="op" id="3645462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3645465">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="3645513">func</span>&nbsp;<span class="op" id="3645518">(</span><span class="ident" id="3645519">hc</span>&nbsp;<span class="op" id="3645522">*</span><span class="ident" id="3645523">halfConn</span><span class="op" id="3645531">)</span>&nbsp;<span class="ident" id="3645533">resetSeq</span><span class="op" id="3645541">(</span><span class="op" id="3645542">)</span>&nbsp;<span class="op" id="3645544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645547">for</span>&nbsp;<span class="ident" id="3645551">i</span>&nbsp;<span class="op" id="3645553">:=</span>&nbsp;<span class="keyword" id="3645556">range</span>&nbsp;<span class="ident" id="3645562">hc</span><span class="op" id="3645564">.</span><span class="ident" id="3645565">seq</span>&nbsp;<span class="op" id="3645569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645573">hc</span><span class="op" id="3645575">.</span><span class="ident" id="3645576">seq</span><span class="op" id="3645579">[</span><span class="ident" id="3645580">i</span><span class="op" id="3645581">]</span>&nbsp;<span class="op" id="3645583">=</span>&nbsp;<span class="num" id="3645585">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3645588">}</span><br>
<span class="lineno">170</span><span class="op" id="3645590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3645593">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="3645673">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3645750">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="3645810">func</span>&nbsp;<span class="ident" id="3645815">removePadding</span><span class="op" id="3645828">(</span><span class="ident" id="3645829">payload</span>&nbsp;<span class="op" id="3645837">[</span><span class="op" id="3645838">]</span><span class="builtintype" id="3645839">byte</span><span class="op" id="3645843">)</span>&nbsp;<span class="op" id="3645845">(</span><span class="op" id="3645846">[</span><span class="op" id="3645847">]</span><span class="builtintype" id="3645848">byte</span><span class="op" id="3645852">,</span>&nbsp;<span class="builtintype" id="3645854">byte</span><span class="op" id="3645858">)</span>&nbsp;<span class="op" id="3645860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645863">if</span>&nbsp;<span class="builtinfunc" id="3645866">len</span><span class="op" id="3645869">(</span><span class="ident" id="3645870">payload</span><span class="op" id="3645877">)</span>&nbsp;<span class="op" id="3645879">&lt;</span>&nbsp;<span class="num" id="3645881">1</span>&nbsp;<span class="op" id="3645883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645887">return</span>&nbsp;<span class="ident" id="3645894">payload</span><span class="op" id="3645901">,</span>&nbsp;<span class="num" id="3645903">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3645906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645910">paddingLen</span>&nbsp;<span class="op" id="3645921">:=</span>&nbsp;<span class="ident" id="3645924">payload</span><span class="op" id="3645931">[</span><span class="builtinfunc" id="3645932">len</span><span class="op" id="3645935">(</span><span class="ident" id="3645936">payload</span><span class="op" id="3645943">)</span><span class="op" id="3645944">-</span><span class="num" id="3645945">1</span><span class="op" id="3645946">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645949">t</span>&nbsp;<span class="op" id="3645951">:=</span>&nbsp;<span class="builtintype" id="3645954">uint</span><span class="op" id="3645958">(</span><span class="builtinfunc" id="3645959">len</span><span class="op" id="3645962">(</span><span class="ident" id="3645963">payload</span><span class="op" id="3645970">)</span><span class="op" id="3645971">-</span><span class="num" id="3645972">1</span><span class="op" id="3645973">)</span>&nbsp;<span class="op" id="3645975">-</span>&nbsp;<span class="builtintype" id="3645977">uint</span><span class="op" id="3645981">(</span><span class="ident" id="3645982">paddingLen</span><span class="op" id="3645992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3645995">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646061">good</span>&nbsp;<span class="op" id="3646066">:=</span>&nbsp;<span class="builtintype" id="3646069">byte</span><span class="op" id="3646073">(</span><span class="builtintype" id="3646074">int32</span><span class="op" id="3646079">(</span><span class="op" id="3646080">^</span><span class="ident" id="3646081">t</span><span class="op" id="3646082">)</span>&nbsp;<span class="op" id="3646084">&gt;&gt;</span>&nbsp;<span class="num" id="3646087">31</span><span class="op" id="3646089">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646093">toCheck</span>&nbsp;<span class="op" id="3646101">:=</span>&nbsp;<span class="num" id="3646104">255</span>&nbsp;<span class="comment" id="3646108">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3646148">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646218">if</span>&nbsp;<span class="ident" id="3646221">toCheck</span><span class="op" id="3646228">+</span><span class="num" id="3646229">1</span>&nbsp;<span class="op" id="3646231">&gt;</span>&nbsp;<span class="builtinfunc" id="3646233">len</span><span class="op" id="3646236">(</span><span class="ident" id="3646237">payload</span><span class="op" id="3646244">)</span>&nbsp;<span class="op" id="3646246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646250">toCheck</span>&nbsp;<span class="op" id="3646258">=</span>&nbsp;<span class="builtinfunc" id="3646260">len</span><span class="op" id="3646263">(</span><span class="ident" id="3646264">payload</span><span class="op" id="3646271">)</span>&nbsp;<span class="op" id="3646273">-</span>&nbsp;<span class="num" id="3646275">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646278">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646282">for</span>&nbsp;<span class="ident" id="3646286">i</span>&nbsp;<span class="op" id="3646288">:=</span>&nbsp;<span class="num" id="3646291">0</span><span class="op" id="3646292">;</span>&nbsp;<span class="ident" id="3646294">i</span>&nbsp;<span class="op" id="3646296">&lt;</span>&nbsp;<span class="ident" id="3646298">toCheck</span><span class="op" id="3646305">;</span>&nbsp;<span class="ident" id="3646307">i</span><span class="op" id="3646308">++</span>&nbsp;<span class="op" id="3646311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646315">t</span>&nbsp;<span class="op" id="3646317">:=</span>&nbsp;<span class="builtintype" id="3646320">uint</span><span class="op" id="3646324">(</span><span class="ident" id="3646325">paddingLen</span><span class="op" id="3646335">)</span>&nbsp;<span class="op" id="3646337">-</span>&nbsp;<span class="builtintype" id="3646339">uint</span><span class="op" id="3646343">(</span><span class="ident" id="3646344">i</span><span class="op" id="3646345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3646349">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646399">mask</span>&nbsp;<span class="op" id="3646404">:=</span>&nbsp;<span class="builtintype" id="3646407">byte</span><span class="op" id="3646411">(</span><span class="builtintype" id="3646412">int32</span><span class="op" id="3646417">(</span><span class="op" id="3646418">^</span><span class="ident" id="3646419">t</span><span class="op" id="3646420">)</span>&nbsp;<span class="op" id="3646422">&gt;&gt;</span>&nbsp;<span class="num" id="3646425">31</span><span class="op" id="3646427">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646431">b</span>&nbsp;<span class="op" id="3646433">:=</span>&nbsp;<span class="ident" id="3646436">payload</span><span class="op" id="3646443">[</span><span class="builtinfunc" id="3646444">len</span><span class="op" id="3646447">(</span><span class="ident" id="3646448">payload</span><span class="op" id="3646455">)</span><span class="op" id="3646456">-</span><span class="num" id="3646457">1</span><span class="op" id="3646458">-</span><span class="ident" id="3646459">i</span><span class="op" id="3646460">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646464">good</span>&nbsp;<span class="op" id="3646469">&amp;^=</span>&nbsp;<span class="ident" id="3646473">mask</span><span class="op" id="3646477">&amp;</span><span class="ident" id="3646478">paddingLen</span>&nbsp;<span class="op" id="3646489">^</span>&nbsp;<span class="ident" id="3646491">mask</span><span class="op" id="3646495">&amp;</span><span class="ident" id="3646496">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3646503">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3646572">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646590">good</span>&nbsp;<span class="op" id="3646595">&amp;=</span>&nbsp;<span class="ident" id="3646598">good</span>&nbsp;<span class="op" id="3646603">&lt;&lt;</span>&nbsp;<span class="num" id="3646606">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646609">good</span>&nbsp;<span class="op" id="3646614">&amp;=</span>&nbsp;<span class="ident" id="3646617">good</span>&nbsp;<span class="op" id="3646622">&lt;&lt;</span>&nbsp;<span class="num" id="3646625">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646628">good</span>&nbsp;<span class="op" id="3646633">&amp;=</span>&nbsp;<span class="ident" id="3646636">good</span>&nbsp;<span class="op" id="3646641">&lt;&lt;</span>&nbsp;<span class="num" id="3646644">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646647">good</span>&nbsp;<span class="op" id="3646652">=</span>&nbsp;<span class="builtintype" id="3646654">uint8</span><span class="op" id="3646659">(</span><span class="builtintype" id="3646660">int8</span><span class="op" id="3646664">(</span><span class="ident" id="3646665">good</span><span class="op" id="3646669">)</span>&nbsp;<span class="op" id="3646671">&gt;&gt;</span>&nbsp;<span class="num" id="3646674">7</span><span class="op" id="3646675">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646679">toRemove</span>&nbsp;<span class="op" id="3646688">:=</span>&nbsp;<span class="ident" id="3646691">good</span><span class="op" id="3646695">&amp;</span><span class="ident" id="3646696">paddingLen</span>&nbsp;<span class="op" id="3646707">+</span>&nbsp;<span class="num" id="3646709">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646712">return</span>&nbsp;<span class="ident" id="3646719">payload</span><span class="op" id="3646726">[</span><span class="op" id="3646727">:</span><span class="builtinfunc" id="3646728">len</span><span class="op" id="3646731">(</span><span class="ident" id="3646732">payload</span><span class="op" id="3646739">)</span><span class="op" id="3646740">-</span><span class="builtintype" id="3646741">int</span><span class="op" id="3646744">(</span><span class="ident" id="3646745">toRemove</span><span class="op" id="3646753">)</span><span class="op" id="3646754">]</span><span class="op" id="3646755">,</span>&nbsp;<span class="ident" id="3646757">good</span><br>
<span class="lineno"></span><span class="op" id="3646762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="3646765">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3646843">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3646918">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="3646955">func</span>&nbsp;<span class="ident" id="3646960">removePaddingSSL30</span><span class="op" id="3646978">(</span><span class="ident" id="3646979">payload</span>&nbsp;<span class="op" id="3646987">[</span><span class="op" id="3646988">]</span><span class="builtintype" id="3646989">byte</span><span class="op" id="3646993">)</span>&nbsp;<span class="op" id="3646995">(</span><span class="op" id="3646996">[</span><span class="op" id="3646997">]</span><span class="builtintype" id="3646998">byte</span><span class="op" id="3647002">,</span>&nbsp;<span class="builtintype" id="3647004">byte</span><span class="op" id="3647008">)</span>&nbsp;<span class="op" id="3647010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647013">if</span>&nbsp;<span class="builtinfunc" id="3647016">len</span><span class="op" id="3647019">(</span><span class="ident" id="3647020">payload</span><span class="op" id="3647027">)</span>&nbsp;<span class="op" id="3647029">&lt;</span>&nbsp;<span class="num" id="3647031">1</span>&nbsp;<span class="op" id="3647033">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647037">return</span>&nbsp;<span class="ident" id="3647044">payload</span><span class="op" id="3647051">,</span>&nbsp;<span class="num" id="3647053">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3647056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3647060">paddingLen</span>&nbsp;<span class="op" id="3647071">:=</span>&nbsp;<span class="builtintype" id="3647074">int</span><span class="op" id="3647077">(</span><span class="ident" id="3647078">payload</span><span class="op" id="3647085">[</span><span class="builtinfunc" id="3647086">len</span><span class="op" id="3647089">(</span><span class="ident" id="3647090">payload</span><span class="op" id="3647097">)</span><span class="op" id="3647098">-</span><span class="num" id="3647099">1</span><span class="op" id="3647100">]</span><span class="op" id="3647101">)</span>&nbsp;<span class="op" id="3647103">+</span>&nbsp;<span class="num" id="3647105">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647108">if</span>&nbsp;<span class="ident" id="3647111">paddingLen</span>&nbsp;<span class="op" id="3647122">&gt;</span>&nbsp;<span class="builtinfunc" id="3647124">len</span><span class="op" id="3647127">(</span><span class="ident" id="3647128">payload</span><span class="op" id="3647135">)</span>&nbsp;<span class="op" id="3647137">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647141">return</span>&nbsp;<span class="ident" id="3647148">payload</span><span class="op" id="3647155">,</span>&nbsp;<span class="num" id="3647157">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3647160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647164">return</span>&nbsp;<span class="ident" id="3647171">payload</span><span class="op" id="3647178">[</span><span class="op" id="3647179">:</span><span class="builtinfunc" id="3647180">len</span><span class="op" id="3647183">(</span><span class="ident" id="3647184">payload</span><span class="op" id="3647191">)</span><span class="op" id="3647192">-</span><span class="ident" id="3647193">paddingLen</span><span class="op" id="3647203">]</span><span class="op" id="3647204">,</span>&nbsp;<span class="num" id="3647206">255</span><br>
<span class="lineno"></span><span class="op" id="3647210">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="3647213">func</span>&nbsp;<span class="ident" id="3647218">roundUp</span><span class="op" id="3647225">(</span><span class="ident" id="3647226">a</span><span class="op" id="3647227">,</span>&nbsp;<span class="ident" id="3647229">b</span>&nbsp;<span class="builtintype" id="3647231">int</span><span class="op" id="3647234">)</span>&nbsp;<span class="builtintype" id="3647236">int</span>&nbsp;<span class="op" id="3647240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647243">return</span>&nbsp;<span class="ident" id="3647250">a</span>&nbsp;<span class="op" id="3647252">+</span>&nbsp;<span class="op" id="3647254">(</span><span class="ident" id="3647255">b</span><span class="op" id="3647256">-</span><span class="ident" id="3647257">a</span><span class="op" id="3647258">%</span><span class="ident" id="3647259">b</span><span class="op" id="3647260">)</span><span class="op" id="3647261">%</span><span class="ident" id="3647262">b</span><br>
<span class="lineno"></span><span class="op" id="3647264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="3647267">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="3647341">type</span>&nbsp;<span class="ident" id="3647346">cbcMode</span>&nbsp;<span class="keyword" id="3647354">interface</span>&nbsp;<span class="op" id="3647364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3647367">cipher</span><span class="op" id="3647373">.</span><span class="ident" id="3647374">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3647385">SetIV</span><span class="op" id="3647390">(</span><span class="op" id="3647391">[</span><span class="op" id="3647392">]</span><span class="builtintype" id="3647393">byte</span><span class="op" id="3647397">)</span><br>
<span class="lineno"></span><span class="op" id="3647399">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="3647402">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3647477">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3647557">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3647627">func</span>&nbsp;<span class="op" id="3647632">(</span><span class="ident" id="3647633">hc</span>&nbsp;<span class="op" id="3647636">*</span><span class="ident" id="3647637">halfConn</span><span class="op" id="3647645">)</span>&nbsp;<span class="ident" id="3647647">decrypt</span><span class="op" id="3647654">(</span><span class="ident" id="3647655">b</span>&nbsp;<span class="op" id="3647657">*</span><span class="ident" id="3647658">block</span><span class="op" id="3647663">)</span>&nbsp;<span class="op" id="3647665">(</span><span class="ident" id="3647666">ok</span>&nbsp;<span class="builtintype" id="3647669">bool</span><span class="op" id="3647673">,</span>&nbsp;<span class="ident" id="3647675">prefixLen</span>&nbsp;<span class="builtintype" id="3647685">int</span><span class="op" id="3647688">,</span>&nbsp;<span class="ident" id="3647690">alertValue</span>&nbsp;<span class="ident" id="3647701">alert</span><span class="op" id="3647706">)</span>&nbsp;<span class="op" id="3647708">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3647711">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3647732">payload</span>&nbsp;<span class="op" id="3647740">:=</span>&nbsp;<span class="ident" id="3647743">b</span><span class="op" id="3647744">.</span><span class="ident" id="3647745">data</span><span class="op" id="3647749">[</span><span class="ident" id="3647750">recordHeaderLen</span><span class="op" id="3647765">:</span><span class="op" id="3647766">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3647770">macSize</span>&nbsp;<span class="op" id="3647778">:=</span>&nbsp;<span class="num" id="3647781">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647784">if</span>&nbsp;<span class="ident" id="3647787">hc</span><span class="op" id="3647789">.</span><span class="ident" id="3647790">mac</span>&nbsp;<span class="op" id="3647794">!=</span>&nbsp;<span class="ident" id="3647797">nil</span>&nbsp;<span class="op" id="3647801">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3647805">macSize</span>&nbsp;<span class="op" id="3647813">=</span>&nbsp;<span class="ident" id="3647815">hc</span><span class="op" id="3647817">.</span><span class="ident" id="3647818">mac</span><span class="op" id="3647821">.</span><span class="ident" id="3647822">Size</span><span class="op" id="3647826">(</span><span class="op" id="3647827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3647830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3647834">paddingGood</span>&nbsp;<span class="op" id="3647846">:=</span>&nbsp;<span class="builtintype" id="3647849">byte</span><span class="op" id="3647853">(</span><span class="num" id="3647854">255</span><span class="op" id="3647857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3647860">explicitIVLen</span>&nbsp;<span class="op" id="3647874">:=</span>&nbsp;<span class="num" id="3647877">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3647881">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647893">if</span>&nbsp;<span class="ident" id="3647896">hc</span><span class="op" id="3647898">.</span><span class="ident" id="3647899">cipher</span>&nbsp;<span class="op" id="3647906">!=</span>&nbsp;<span class="ident" id="3647909">nil</span>&nbsp;<span class="op" id="3647913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647917">switch</span>&nbsp;<span class="ident" id="3647924">c</span>&nbsp;<span class="op" id="3647926">:=</span>&nbsp;<span class="ident" id="3647929">hc</span><span class="op" id="3647931">.</span><span class="ident" id="3647932">cipher</span><span class="op" id="3647938">.</span><span class="op" id="3647939">(</span><span class="keyword" id="3647940">type</span><span class="op" id="3647944">)</span>&nbsp;<span class="op" id="3647946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647950">case</span>&nbsp;<span class="ident" id="3647955">cipher</span><span class="op" id="3647961">.</span><span class="ident" id="3647962">Stream</span><span class="op" id="3647968">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3647973">c</span><span class="op" id="3647974">.</span><span class="ident" id="3647975">XORKeyStream</span><span class="op" id="3647987">(</span><span class="ident" id="3647988">payload</span><span class="op" id="3647995">,</span>&nbsp;<span class="ident" id="3647997">payload</span><span class="op" id="3648004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648008">case</span>&nbsp;<span class="ident" id="3648013">cipher</span><span class="op" id="3648019">.</span><span class="ident" id="3648020">AEAD</span><span class="op" id="3648024">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648029">explicitIVLen</span>&nbsp;<span class="op" id="3648043">=</span>&nbsp;<span class="num" id="3648045">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648050">if</span>&nbsp;<span class="builtinfunc" id="3648053">len</span><span class="op" id="3648056">(</span><span class="ident" id="3648057">payload</span><span class="op" id="3648064">)</span>&nbsp;<span class="op" id="3648066">&lt;</span>&nbsp;<span class="ident" id="3648068">explicitIVLen</span>&nbsp;<span class="op" id="3648082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648088">return</span>&nbsp;<span class="builtintype" id="3648095">false</span><span class="op" id="3648100">,</span>&nbsp;<span class="num" id="3648102">0</span><span class="op" id="3648103">,</span>&nbsp;<span class="ident" id="3648105">alertBadRecordMAC</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648131">nonce</span>&nbsp;<span class="op" id="3648137">:=</span>&nbsp;<span class="ident" id="3648140">payload</span><span class="op" id="3648147">[</span><span class="op" id="3648148">:</span><span class="num" id="3648149">8</span><span class="op" id="3648150">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648155">payload</span>&nbsp;<span class="op" id="3648163">=</span>&nbsp;<span class="ident" id="3648165">payload</span><span class="op" id="3648172">[</span><span class="num" id="3648173">8</span><span class="op" id="3648174">:</span><span class="op" id="3648175">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648181">var</span>&nbsp;<span class="ident" id="3648185">additionalData</span>&nbsp;<span class="op" id="3648200">[</span><span class="num" id="3648201">13</span><span class="op" id="3648203">]</span><span class="builtintype" id="3648204">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3648212">copy</span><span class="op" id="3648216">(</span><span class="ident" id="3648217">additionalData</span><span class="op" id="3648231">[</span><span class="op" id="3648232">:</span><span class="op" id="3648233">]</span><span class="op" id="3648234">,</span>&nbsp;<span class="ident" id="3648236">hc</span><span class="op" id="3648238">.</span><span class="ident" id="3648239">seq</span><span class="op" id="3648242">[</span><span class="op" id="3648243">:</span><span class="op" id="3648244">]</span><span class="op" id="3648245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3648250">copy</span><span class="op" id="3648254">(</span><span class="ident" id="3648255">additionalData</span><span class="op" id="3648269">[</span><span class="num" id="3648270">8</span><span class="op" id="3648271">:</span><span class="op" id="3648272">]</span><span class="op" id="3648273">,</span>&nbsp;<span class="ident" id="3648275">b</span><span class="op" id="3648276">.</span><span class="ident" id="3648277">data</span><span class="op" id="3648281">[</span><span class="op" id="3648282">:</span><span class="num" id="3648283">3</span><span class="op" id="3648284">]</span><span class="op" id="3648285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648290">n</span>&nbsp;<span class="op" id="3648292">:=</span>&nbsp;<span class="builtinfunc" id="3648295">len</span><span class="op" id="3648298">(</span><span class="ident" id="3648299">payload</span><span class="op" id="3648306">)</span>&nbsp;<span class="op" id="3648308">-</span>&nbsp;<span class="ident" id="3648310">c</span><span class="op" id="3648311">.</span><span class="ident" id="3648312">Overhead</span><span class="op" id="3648320">(</span><span class="op" id="3648321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648326">additionalData</span><span class="op" id="3648340">[</span><span class="num" id="3648341">11</span><span class="op" id="3648343">]</span>&nbsp;<span class="op" id="3648345">=</span>&nbsp;<span class="builtintype" id="3648347">byte</span><span class="op" id="3648351">(</span><span class="ident" id="3648352">n</span>&nbsp;<span class="op" id="3648354">&gt;&gt;</span>&nbsp;<span class="num" id="3648357">8</span><span class="op" id="3648358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648363">additionalData</span><span class="op" id="3648377">[</span><span class="num" id="3648378">12</span><span class="op" id="3648380">]</span>&nbsp;<span class="op" id="3648382">=</span>&nbsp;<span class="builtintype" id="3648384">byte</span><span class="op" id="3648388">(</span><span class="ident" id="3648389">n</span><span class="op" id="3648390">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648395">var</span>&nbsp;<span class="ident" id="3648399">err</span>&nbsp;<span class="builtintype" id="3648403">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648412">payload</span><span class="op" id="3648419">,</span>&nbsp;<span class="ident" id="3648421">err</span>&nbsp;<span class="op" id="3648425">=</span>&nbsp;<span class="ident" id="3648427">c</span><span class="op" id="3648428">.</span><span class="ident" id="3648429">Open</span><span class="op" id="3648433">(</span><span class="ident" id="3648434">payload</span><span class="op" id="3648441">[</span><span class="op" id="3648442">:</span><span class="num" id="3648443">0</span><span class="op" id="3648444">]</span><span class="op" id="3648445">,</span>&nbsp;<span class="ident" id="3648447">nonce</span><span class="op" id="3648452">,</span>&nbsp;<span class="ident" id="3648454">payload</span><span class="op" id="3648461">,</span>&nbsp;<span class="ident" id="3648463">additionalData</span><span class="op" id="3648477">[</span><span class="op" id="3648478">:</span><span class="op" id="3648479">]</span><span class="op" id="3648480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648485">if</span>&nbsp;<span class="ident" id="3648488">err</span>&nbsp;<span class="op" id="3648492">!=</span>&nbsp;<span class="ident" id="3648495">nil</span>&nbsp;<span class="op" id="3648499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648505">return</span>&nbsp;<span class="builtintype" id="3648512">false</span><span class="op" id="3648517">,</span>&nbsp;<span class="num" id="3648519">0</span><span class="op" id="3648520">,</span>&nbsp;<span class="ident" id="3648522">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648543">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648548">b</span><span class="op" id="3648549">.</span><span class="ident" id="3648550">resize</span><span class="op" id="3648556">(</span><span class="ident" id="3648557">recordHeaderLen</span>&nbsp;<span class="op" id="3648573">+</span>&nbsp;<span class="ident" id="3648575">explicitIVLen</span>&nbsp;<span class="op" id="3648589">+</span>&nbsp;<span class="builtinfunc" id="3648591">len</span><span class="op" id="3648594">(</span><span class="ident" id="3648595">payload</span><span class="op" id="3648602">)</span><span class="op" id="3648603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648607">case</span>&nbsp;<span class="ident" id="3648612">cbcMode</span><span class="op" id="3648619">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648624">blockSize</span>&nbsp;<span class="op" id="3648634">:=</span>&nbsp;<span class="ident" id="3648637">c</span><span class="op" id="3648638">.</span><span class="ident" id="3648639">BlockSize</span><span class="op" id="3648648">(</span><span class="op" id="3648649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648654">if</span>&nbsp;<span class="ident" id="3648657">hc</span><span class="op" id="3648659">.</span><span class="ident" id="3648660">version</span>&nbsp;<span class="op" id="3648668">&gt;=</span>&nbsp;<span class="ident" id="3648671">VersionTLS11</span>&nbsp;<span class="op" id="3648684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648690">explicitIVLen</span>&nbsp;<span class="op" id="3648704">=</span>&nbsp;<span class="ident" id="3648706">blockSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648725">if</span>&nbsp;<span class="builtinfunc" id="3648728">len</span><span class="op" id="3648731">(</span><span class="ident" id="3648732">payload</span><span class="op" id="3648739">)</span><span class="op" id="3648740">%</span><span class="ident" id="3648741">blockSize</span>&nbsp;<span class="op" id="3648751">!=</span>&nbsp;<span class="num" id="3648754">0</span>&nbsp;<span class="op" id="3648756">||</span>&nbsp;<span class="builtinfunc" id="3648759">len</span><span class="op" id="3648762">(</span><span class="ident" id="3648763">payload</span><span class="op" id="3648770">)</span>&nbsp;<span class="op" id="3648772">&lt;</span>&nbsp;<span class="ident" id="3648774">roundUp</span><span class="op" id="3648781">(</span><span class="ident" id="3648782">explicitIVLen</span><span class="op" id="3648795">+</span><span class="ident" id="3648796">macSize</span><span class="op" id="3648803">+</span><span class="num" id="3648804">1</span><span class="op" id="3648805">,</span>&nbsp;<span class="ident" id="3648807">blockSize</span><span class="op" id="3648816">)</span>&nbsp;<span class="op" id="3648818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648824">return</span>&nbsp;<span class="builtintype" id="3648831">false</span><span class="op" id="3648836">,</span>&nbsp;<span class="num" id="3648838">0</span><span class="op" id="3648839">,</span>&nbsp;<span class="ident" id="3648841">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648862">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648868">if</span>&nbsp;<span class="ident" id="3648871">explicitIVLen</span>&nbsp;<span class="op" id="3648885">&gt;</span>&nbsp;<span class="num" id="3648887">0</span>&nbsp;<span class="op" id="3648889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648895">c</span><span class="op" id="3648896">.</span><span class="ident" id="3648897">SetIV</span><span class="op" id="3648902">(</span><span class="ident" id="3648903">payload</span><span class="op" id="3648910">[</span><span class="op" id="3648911">:</span><span class="ident" id="3648912">explicitIVLen</span><span class="op" id="3648925">]</span><span class="op" id="3648926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648932">payload</span>&nbsp;<span class="op" id="3648940">=</span>&nbsp;<span class="ident" id="3648942">payload</span><span class="op" id="3648949">[</span><span class="ident" id="3648950">explicitIVLen</span><span class="op" id="3648963">:</span><span class="op" id="3648964">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648969">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648974">c</span><span class="op" id="3648975">.</span><span class="ident" id="3648976">CryptBlocks</span><span class="op" id="3648987">(</span><span class="ident" id="3648988">payload</span><span class="op" id="3648995">,</span>&nbsp;<span class="ident" id="3648997">payload</span><span class="op" id="3649004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649009">if</span>&nbsp;<span class="ident" id="3649012">hc</span><span class="op" id="3649014">.</span><span class="ident" id="3649015">version</span>&nbsp;<span class="op" id="3649023">==</span>&nbsp;<span class="ident" id="3649026">VersionSSL30</span>&nbsp;<span class="op" id="3649039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649045">payload</span><span class="op" id="3649052">,</span>&nbsp;<span class="ident" id="3649054">paddingGood</span>&nbsp;<span class="op" id="3649066">=</span>&nbsp;<span class="ident" id="3649068">removePaddingSSL30</span><span class="op" id="3649086">(</span><span class="ident" id="3649087">payload</span><span class="op" id="3649094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3649099">}</span>&nbsp;<span class="keyword" id="3649101">else</span>&nbsp;<span class="op" id="3649106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649112">payload</span><span class="op" id="3649119">,</span>&nbsp;<span class="ident" id="3649121">paddingGood</span>&nbsp;<span class="op" id="3649133">=</span>&nbsp;<span class="ident" id="3649135">removePadding</span><span class="op" id="3649148">(</span><span class="ident" id="3649149">payload</span><span class="op" id="3649156">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3649161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649166">b</span><span class="op" id="3649167">.</span><span class="ident" id="3649168">resize</span><span class="op" id="3649174">(</span><span class="ident" id="3649175">recordHeaderLen</span>&nbsp;<span class="op" id="3649191">+</span>&nbsp;<span class="ident" id="3649193">explicitIVLen</span>&nbsp;<span class="op" id="3649207">+</span>&nbsp;<span class="builtinfunc" id="3649209">len</span><span class="op" id="3649212">(</span><span class="ident" id="3649213">payload</span><span class="op" id="3649220">)</span><span class="op" id="3649221">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649227">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649286">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649343">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649400">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649456">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649506">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649564">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649584">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649590">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649646">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649676">default</span><span class="op" id="3649683">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3649688">panic</span><span class="op" id="3649693">(</span><span class="string" id="3649694">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3649715">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3649719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3649722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649726">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649747">if</span>&nbsp;<span class="ident" id="3649750">hc</span><span class="op" id="3649752">.</span><span class="ident" id="3649753">mac</span>&nbsp;<span class="op" id="3649757">!=</span>&nbsp;<span class="ident" id="3649760">nil</span>&nbsp;<span class="op" id="3649764">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649768">if</span>&nbsp;<span class="builtinfunc" id="3649771">len</span><span class="op" id="3649774">(</span><span class="ident" id="3649775">payload</span><span class="op" id="3649782">)</span>&nbsp;<span class="op" id="3649784">&lt;</span>&nbsp;<span class="ident" id="3649786">macSize</span>&nbsp;<span class="op" id="3649794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649799">return</span>&nbsp;<span class="builtintype" id="3649806">false</span><span class="op" id="3649811">,</span>&nbsp;<span class="num" id="3649813">0</span><span class="op" id="3649814">,</span>&nbsp;<span class="ident" id="3649816">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3649836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649841">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649876">n</span>&nbsp;<span class="op" id="3649878">:=</span>&nbsp;<span class="builtinfunc" id="3649881">len</span><span class="op" id="3649884">(</span><span class="ident" id="3649885">payload</span><span class="op" id="3649892">)</span>&nbsp;<span class="op" id="3649894">-</span>&nbsp;<span class="ident" id="3649896">macSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649906">b</span><span class="op" id="3649907">.</span><span class="ident" id="3649908">data</span><span class="op" id="3649912">[</span><span class="num" id="3649913">3</span><span class="op" id="3649914">]</span>&nbsp;<span class="op" id="3649916">=</span>&nbsp;<span class="builtintype" id="3649918">byte</span><span class="op" id="3649922">(</span><span class="ident" id="3649923">n</span>&nbsp;<span class="op" id="3649925">&gt;&gt;</span>&nbsp;<span class="num" id="3649928">8</span><span class="op" id="3649929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649933">b</span><span class="op" id="3649934">.</span><span class="ident" id="3649935">data</span><span class="op" id="3649939">[</span><span class="num" id="3649940">4</span><span class="op" id="3649941">]</span>&nbsp;<span class="op" id="3649943">=</span>&nbsp;<span class="builtintype" id="3649945">byte</span><span class="op" id="3649949">(</span><span class="ident" id="3649950">n</span><span class="op" id="3649951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649955">b</span><span class="op" id="3649956">.</span><span class="ident" id="3649957">resize</span><span class="op" id="3649963">(</span><span class="ident" id="3649964">recordHeaderLen</span>&nbsp;<span class="op" id="3649980">+</span>&nbsp;<span class="ident" id="3649982">explicitIVLen</span>&nbsp;<span class="op" id="3649996">+</span>&nbsp;<span class="ident" id="3649998">n</span><span class="op" id="3649999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650003">remoteMAC</span>&nbsp;<span class="op" id="3650013">:=</span>&nbsp;<span class="ident" id="3650016">payload</span><span class="op" id="3650023">[</span><span class="ident" id="3650024">n</span><span class="op" id="3650025">:</span><span class="op" id="3650026">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650030">localMAC</span>&nbsp;<span class="op" id="3650039">:=</span>&nbsp;<span class="ident" id="3650042">hc</span><span class="op" id="3650044">.</span><span class="ident" id="3650045">mac</span><span class="op" id="3650048">.</span><span class="ident" id="3650049">MAC</span><span class="op" id="3650052">(</span><span class="ident" id="3650053">hc</span><span class="op" id="3650055">.</span><span class="ident" id="3650056">inDigestBuf</span><span class="op" id="3650067">,</span>&nbsp;<span class="ident" id="3650069">hc</span><span class="op" id="3650071">.</span><span class="ident" id="3650072">seq</span><span class="op" id="3650075">[</span><span class="num" id="3650076">0</span><span class="op" id="3650077">:</span><span class="op" id="3650078">]</span><span class="op" id="3650079">,</span>&nbsp;<span class="ident" id="3650081">b</span><span class="op" id="3650082">.</span><span class="ident" id="3650083">data</span><span class="op" id="3650087">[</span><span class="op" id="3650088">:</span><span class="ident" id="3650089">recordHeaderLen</span><span class="op" id="3650104">]</span><span class="op" id="3650105">,</span>&nbsp;<span class="ident" id="3650107">payload</span><span class="op" id="3650114">[</span><span class="op" id="3650115">:</span><span class="ident" id="3650116">n</span><span class="op" id="3650117">]</span><span class="op" id="3650118">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650123">if</span>&nbsp;<span class="ident" id="3650126">subtle</span><span class="op" id="3650132">.</span><span class="ident" id="3650133">ConstantTimeCompare</span><span class="op" id="3650152">(</span><span class="ident" id="3650153">localMAC</span><span class="op" id="3650161">,</span>&nbsp;<span class="ident" id="3650163">remoteMAC</span><span class="op" id="3650172">)</span>&nbsp;<span class="op" id="3650174">!=</span>&nbsp;<span class="num" id="3650177">1</span>&nbsp;<span class="op" id="3650179">||</span>&nbsp;<span class="ident" id="3650182">paddingGood</span>&nbsp;<span class="op" id="3650194">!=</span>&nbsp;<span class="num" id="3650197">255</span>&nbsp;<span class="op" id="3650201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650206">return</span>&nbsp;<span class="builtintype" id="3650213">false</span><span class="op" id="3650218">,</span>&nbsp;<span class="num" id="3650220">0</span><span class="op" id="3650221">,</span>&nbsp;<span class="ident" id="3650223">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3650243">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650247">hc</span><span class="op" id="3650249">.</span><span class="ident" id="3650250">inDigestBuf</span>&nbsp;<span class="op" id="3650262">=</span>&nbsp;<span class="ident" id="3650264">localMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3650274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650277">hc</span><span class="op" id="3650279">.</span><span class="ident" id="3650280">incSeq</span><span class="op" id="3650286">(</span><span class="op" id="3650287">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650291">return</span>&nbsp;<span class="builtintype" id="3650298">true</span><span class="op" id="3650302">,</span>&nbsp;<span class="ident" id="3650304">recordHeaderLen</span>&nbsp;<span class="op" id="3650320">+</span>&nbsp;<span class="ident" id="3650322">explicitIVLen</span><span class="op" id="3650335">,</span>&nbsp;<span class="num" id="3650337">0</span><br>
<span class="lineno">335</span><span class="op" id="3650339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3650342">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="3650420">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="3650495">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="3650575">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3650651">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="3650666">func</span>&nbsp;<span class="ident" id="3650671">padToBlockSize</span><span class="op" id="3650685">(</span><span class="ident" id="3650686">payload</span>&nbsp;<span class="op" id="3650694">[</span><span class="op" id="3650695">]</span><span class="builtintype" id="3650696">byte</span><span class="op" id="3650700">,</span>&nbsp;<span class="ident" id="3650702">blockSize</span>&nbsp;<span class="builtintype" id="3650712">int</span><span class="op" id="3650715">)</span>&nbsp;<span class="op" id="3650717">(</span><span class="ident" id="3650718">prefix</span><span class="op" id="3650724">,</span>&nbsp;<span class="ident" id="3650726">finalBlock</span>&nbsp;<span class="op" id="3650737">[</span><span class="op" id="3650738">]</span><span class="builtintype" id="3650739">byte</span><span class="op" id="3650743">)</span>&nbsp;<span class="op" id="3650745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650748">overrun</span>&nbsp;<span class="op" id="3650756">:=</span>&nbsp;<span class="builtinfunc" id="3650759">len</span><span class="op" id="3650762">(</span><span class="ident" id="3650763">payload</span><span class="op" id="3650770">)</span>&nbsp;<span class="op" id="3650772">%</span>&nbsp;<span class="ident" id="3650774">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650785">paddingLen</span>&nbsp;<span class="op" id="3650796">:=</span>&nbsp;<span class="ident" id="3650799">blockSize</span>&nbsp;<span class="op" id="3650809">-</span>&nbsp;<span class="ident" id="3650811">overrun</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650820">prefix</span>&nbsp;<span class="op" id="3650827">=</span>&nbsp;<span class="ident" id="3650829">payload</span><span class="op" id="3650836">[</span><span class="op" id="3650837">:</span><span class="builtinfunc" id="3650838">len</span><span class="op" id="3650841">(</span><span class="ident" id="3650842">payload</span><span class="op" id="3650849">)</span><span class="op" id="3650850">-</span><span class="ident" id="3650851">overrun</span><span class="op" id="3650858">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650861">finalBlock</span>&nbsp;<span class="op" id="3650872">=</span>&nbsp;<span class="builtinfunc" id="3650874">make</span><span class="op" id="3650878">(</span><span class="op" id="3650879">[</span><span class="op" id="3650880">]</span><span class="builtintype" id="3650881">byte</span><span class="op" id="3650885">,</span>&nbsp;<span class="ident" id="3650887">blockSize</span><span class="op" id="3650896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3650899">copy</span><span class="op" id="3650903">(</span><span class="ident" id="3650904">finalBlock</span><span class="op" id="3650914">,</span>&nbsp;<span class="ident" id="3650916">payload</span><span class="op" id="3650923">[</span><span class="builtinfunc" id="3650924">len</span><span class="op" id="3650927">(</span><span class="ident" id="3650928">payload</span><span class="op" id="3650935">)</span><span class="op" id="3650936">-</span><span class="ident" id="3650937">overrun</span><span class="op" id="3650944">:</span><span class="op" id="3650945">]</span><span class="op" id="3650946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650949">for</span>&nbsp;<span class="ident" id="3650953">i</span>&nbsp;<span class="op" id="3650955">:=</span>&nbsp;<span class="ident" id="3650958">overrun</span><span class="op" id="3650965">;</span>&nbsp;<span class="ident" id="3650967">i</span>&nbsp;<span class="op" id="3650969">&lt;</span>&nbsp;<span class="ident" id="3650971">blockSize</span><span class="op" id="3650980">;</span>&nbsp;<span class="ident" id="3650982">i</span><span class="op" id="3650983">++</span>&nbsp;<span class="op" id="3650986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650990">finalBlock</span><span class="op" id="3651000">[</span><span class="ident" id="3651001">i</span><span class="op" id="3651002">]</span>&nbsp;<span class="op" id="3651004">=</span>&nbsp;<span class="builtintype" id="3651006">byte</span><span class="op" id="3651010">(</span><span class="ident" id="3651011">paddingLen</span>&nbsp;<span class="op" id="3651022">-</span>&nbsp;<span class="num" id="3651024">1</span><span class="op" id="3651025">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3651028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651031">return</span><br>
<span class="lineno"></span><span class="op" id="3651038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3651041">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="3651085">func</span>&nbsp;<span class="op" id="3651090">(</span><span class="ident" id="3651091">hc</span>&nbsp;<span class="op" id="3651094">*</span><span class="ident" id="3651095">halfConn</span><span class="op" id="3651103">)</span>&nbsp;<span class="ident" id="3651105">encrypt</span><span class="op" id="3651112">(</span><span class="ident" id="3651113">b</span>&nbsp;<span class="op" id="3651115">*</span><span class="ident" id="3651116">block</span><span class="op" id="3651121">,</span>&nbsp;<span class="ident" id="3651123">explicitIVLen</span>&nbsp;<span class="builtintype" id="3651137">int</span><span class="op" id="3651140">)</span>&nbsp;<span class="op" id="3651142">(</span><span class="builtintype" id="3651143">bool</span><span class="op" id="3651147">,</span>&nbsp;<span class="ident" id="3651149">alert</span><span class="op" id="3651154">)</span>&nbsp;<span class="op" id="3651156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3651159">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651167">if</span>&nbsp;<span class="ident" id="3651170">hc</span><span class="op" id="3651172">.</span><span class="ident" id="3651173">mac</span>&nbsp;<span class="op" id="3651177">!=</span>&nbsp;<span class="ident" id="3651180">nil</span>&nbsp;<span class="op" id="3651184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651188">mac</span>&nbsp;<span class="op" id="3651192">:=</span>&nbsp;<span class="ident" id="3651195">hc</span><span class="op" id="3651197">.</span><span class="ident" id="3651198">mac</span><span class="op" id="3651201">.</span><span class="ident" id="3651202">MAC</span><span class="op" id="3651205">(</span><span class="ident" id="3651206">hc</span><span class="op" id="3651208">.</span><span class="ident" id="3651209">outDigestBuf</span><span class="op" id="3651221">,</span>&nbsp;<span class="ident" id="3651223">hc</span><span class="op" id="3651225">.</span><span class="ident" id="3651226">seq</span><span class="op" id="3651229">[</span><span class="num" id="3651230">0</span><span class="op" id="3651231">:</span><span class="op" id="3651232">]</span><span class="op" id="3651233">,</span>&nbsp;<span class="ident" id="3651235">b</span><span class="op" id="3651236">.</span><span class="ident" id="3651237">data</span><span class="op" id="3651241">[</span><span class="op" id="3651242">:</span><span class="ident" id="3651243">recordHeaderLen</span><span class="op" id="3651258">]</span><span class="op" id="3651259">,</span>&nbsp;<span class="ident" id="3651261">b</span><span class="op" id="3651262">.</span><span class="ident" id="3651263">data</span><span class="op" id="3651267">[</span><span class="ident" id="3651268">recordHeaderLen</span><span class="op" id="3651283">+</span><span class="ident" id="3651284">explicitIVLen</span><span class="op" id="3651297">:</span><span class="op" id="3651298">]</span><span class="op" id="3651299">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651304">n</span>&nbsp;<span class="op" id="3651306">:=</span>&nbsp;<span class="builtinfunc" id="3651309">len</span><span class="op" id="3651312">(</span><span class="ident" id="3651313">b</span><span class="op" id="3651314">.</span><span class="ident" id="3651315">data</span><span class="op" id="3651319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651323">b</span><span class="op" id="3651324">.</span><span class="ident" id="3651325">resize</span><span class="op" id="3651331">(</span><span class="ident" id="3651332">n</span>&nbsp;<span class="op" id="3651334">+</span>&nbsp;<span class="builtinfunc" id="3651336">len</span><span class="op" id="3651339">(</span><span class="ident" id="3651340">mac</span><span class="op" id="3651343">)</span><span class="op" id="3651344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3651348">copy</span><span class="op" id="3651352">(</span><span class="ident" id="3651353">b</span><span class="op" id="3651354">.</span><span class="ident" id="3651355">data</span><span class="op" id="3651359">[</span><span class="ident" id="3651360">n</span><span class="op" id="3651361">:</span><span class="op" id="3651362">]</span><span class="op" id="3651363">,</span>&nbsp;<span class="ident" id="3651365">mac</span><span class="op" id="3651368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651372">hc</span><span class="op" id="3651374">.</span><span class="ident" id="3651375">outDigestBuf</span>&nbsp;<span class="op" id="3651388">=</span>&nbsp;<span class="ident" id="3651390">mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3651395">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651399">payload</span>&nbsp;<span class="op" id="3651407">:=</span>&nbsp;<span class="ident" id="3651410">b</span><span class="op" id="3651411">.</span><span class="ident" id="3651412">data</span><span class="op" id="3651416">[</span><span class="ident" id="3651417">recordHeaderLen</span><span class="op" id="3651432">:</span><span class="op" id="3651433">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3651437">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651449">if</span>&nbsp;<span class="ident" id="3651452">hc</span><span class="op" id="3651454">.</span><span class="ident" id="3651455">cipher</span>&nbsp;<span class="op" id="3651462">!=</span>&nbsp;<span class="ident" id="3651465">nil</span>&nbsp;<span class="op" id="3651469">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651473">switch</span>&nbsp;<span class="ident" id="3651480">c</span>&nbsp;<span class="op" id="3651482">:=</span>&nbsp;<span class="ident" id="3651485">hc</span><span class="op" id="3651487">.</span><span class="ident" id="3651488">cipher</span><span class="op" id="3651494">.</span><span class="op" id="3651495">(</span><span class="keyword" id="3651496">type</span><span class="op" id="3651500">)</span>&nbsp;<span class="op" id="3651502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651506">case</span>&nbsp;<span class="ident" id="3651511">cipher</span><span class="op" id="3651517">.</span><span class="ident" id="3651518">Stream</span><span class="op" id="3651524">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651529">c</span><span class="op" id="3651530">.</span><span class="ident" id="3651531">XORKeyStream</span><span class="op" id="3651543">(</span><span class="ident" id="3651544">payload</span><span class="op" id="3651551">,</span>&nbsp;<span class="ident" id="3651553">payload</span><span class="op" id="3651560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651564">case</span>&nbsp;<span class="ident" id="3651569">cipher</span><span class="op" id="3651575">.</span><span class="ident" id="3651576">AEAD</span><span class="op" id="3651580">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651585">payloadLen</span>&nbsp;<span class="op" id="3651596">:=</span>&nbsp;<span class="builtinfunc" id="3651599">len</span><span class="op" id="3651602">(</span><span class="ident" id="3651603">b</span><span class="op" id="3651604">.</span><span class="ident" id="3651605">data</span><span class="op" id="3651609">)</span>&nbsp;<span class="op" id="3651611">-</span>&nbsp;<span class="ident" id="3651613">recordHeaderLen</span>&nbsp;<span class="op" id="3651629">-</span>&nbsp;<span class="ident" id="3651631">explicitIVLen</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651648">b</span><span class="op" id="3651649">.</span><span class="ident" id="3651650">resize</span><span class="op" id="3651656">(</span><span class="builtinfunc" id="3651657">len</span><span class="op" id="3651660">(</span><span class="ident" id="3651661">b</span><span class="op" id="3651662">.</span><span class="ident" id="3651663">data</span><span class="op" id="3651667">)</span>&nbsp;<span class="op" id="3651669">+</span>&nbsp;<span class="ident" id="3651671">c</span><span class="op" id="3651672">.</span><span class="ident" id="3651673">Overhead</span><span class="op" id="3651681">(</span><span class="op" id="3651682">)</span><span class="op" id="3651683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651688">nonce</span>&nbsp;<span class="op" id="3651694">:=</span>&nbsp;<span class="ident" id="3651697">b</span><span class="op" id="3651698">.</span><span class="ident" id="3651699">data</span><span class="op" id="3651703">[</span><span class="ident" id="3651704">recordHeaderLen</span>&nbsp;<span class="op" id="3651720">:</span>&nbsp;<span class="ident" id="3651722">recordHeaderLen</span><span class="op" id="3651737">+</span><span class="ident" id="3651738">explicitIVLen</span><span class="op" id="3651751">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651756">payload</span>&nbsp;<span class="op" id="3651764">:=</span>&nbsp;<span class="ident" id="3651767">b</span><span class="op" id="3651768">.</span><span class="ident" id="3651769">data</span><span class="op" id="3651773">[</span><span class="ident" id="3651774">recordHeaderLen</span><span class="op" id="3651789">+</span><span class="ident" id="3651790">explicitIVLen</span><span class="op" id="3651803">:</span><span class="op" id="3651804">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651809">payload</span>&nbsp;<span class="op" id="3651817">=</span>&nbsp;<span class="ident" id="3651819">payload</span><span class="op" id="3651826">[</span><span class="op" id="3651827">:</span><span class="ident" id="3651828">payloadLen</span><span class="op" id="3651838">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651844">var</span>&nbsp;<span class="ident" id="3651848">additionalData</span>&nbsp;<span class="op" id="3651863">[</span><span class="num" id="3651864">13</span><span class="op" id="3651866">]</span><span class="builtintype" id="3651867">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3651875">copy</span><span class="op" id="3651879">(</span><span class="ident" id="3651880">additionalData</span><span class="op" id="3651894">[</span><span class="op" id="3651895">:</span><span class="op" id="3651896">]</span><span class="op" id="3651897">,</span>&nbsp;<span class="ident" id="3651899">hc</span><span class="op" id="3651901">.</span><span class="ident" id="3651902">seq</span><span class="op" id="3651905">[</span><span class="op" id="3651906">:</span><span class="op" id="3651907">]</span><span class="op" id="3651908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3651913">copy</span><span class="op" id="3651917">(</span><span class="ident" id="3651918">additionalData</span><span class="op" id="3651932">[</span><span class="num" id="3651933">8</span><span class="op" id="3651934">:</span><span class="op" id="3651935">]</span><span class="op" id="3651936">,</span>&nbsp;<span class="ident" id="3651938">b</span><span class="op" id="3651939">.</span><span class="ident" id="3651940">data</span><span class="op" id="3651944">[</span><span class="op" id="3651945">:</span><span class="num" id="3651946">3</span><span class="op" id="3651947">]</span><span class="op" id="3651948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651953">additionalData</span><span class="op" id="3651967">[</span><span class="num" id="3651968">11</span><span class="op" id="3651970">]</span>&nbsp;<span class="op" id="3651972">=</span>&nbsp;<span class="builtintype" id="3651974">byte</span><span class="op" id="3651978">(</span><span class="ident" id="3651979">payloadLen</span>&nbsp;<span class="op" id="3651990">&gt;&gt;</span>&nbsp;<span class="num" id="3651993">8</span><span class="op" id="3651994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651999">additionalData</span><span class="op" id="3652013">[</span><span class="num" id="3652014">12</span><span class="op" id="3652016">]</span>&nbsp;<span class="op" id="3652018">=</span>&nbsp;<span class="builtintype" id="3652020">byte</span><span class="op" id="3652024">(</span><span class="ident" id="3652025">payloadLen</span><span class="op" id="3652035">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652041">c</span><span class="op" id="3652042">.</span><span class="ident" id="3652043">Seal</span><span class="op" id="3652047">(</span><span class="ident" id="3652048">payload</span><span class="op" id="3652055">[</span><span class="op" id="3652056">:</span><span class="num" id="3652057">0</span><span class="op" id="3652058">]</span><span class="op" id="3652059">,</span>&nbsp;<span class="ident" id="3652061">nonce</span><span class="op" id="3652066">,</span>&nbsp;<span class="ident" id="3652068">payload</span><span class="op" id="3652075">,</span>&nbsp;<span class="ident" id="3652077">additionalData</span><span class="op" id="3652091">[</span><span class="op" id="3652092">:</span><span class="op" id="3652093">]</span><span class="op" id="3652094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652098">case</span>&nbsp;<span class="ident" id="3652103">cbcMode</span><span class="op" id="3652110">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652115">blockSize</span>&nbsp;<span class="op" id="3652125">:=</span>&nbsp;<span class="ident" id="3652128">c</span><span class="op" id="3652129">.</span><span class="ident" id="3652130">BlockSize</span><span class="op" id="3652139">(</span><span class="op" id="3652140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652145">if</span>&nbsp;<span class="ident" id="3652148">explicitIVLen</span>&nbsp;<span class="op" id="3652162">&gt;</span>&nbsp;<span class="num" id="3652164">0</span>&nbsp;<span class="op" id="3652166">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652172">c</span><span class="op" id="3652173">.</span><span class="ident" id="3652174">SetIV</span><span class="op" id="3652179">(</span><span class="ident" id="3652180">payload</span><span class="op" id="3652187">[</span><span class="op" id="3652188">:</span><span class="ident" id="3652189">explicitIVLen</span><span class="op" id="3652202">]</span><span class="op" id="3652203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652209">payload</span>&nbsp;<span class="op" id="3652217">=</span>&nbsp;<span class="ident" id="3652219">payload</span><span class="op" id="3652226">[</span><span class="ident" id="3652227">explicitIVLen</span><span class="op" id="3652240">:</span><span class="op" id="3652241">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3652246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652251">prefix</span><span class="op" id="3652257">,</span>&nbsp;<span class="ident" id="3652259">finalBlock</span>&nbsp;<span class="op" id="3652270">:=</span>&nbsp;<span class="ident" id="3652273">padToBlockSize</span><span class="op" id="3652287">(</span><span class="ident" id="3652288">payload</span><span class="op" id="3652295">,</span>&nbsp;<span class="ident" id="3652297">blockSize</span><span class="op" id="3652306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652311">b</span><span class="op" id="3652312">.</span><span class="ident" id="3652313">resize</span><span class="op" id="3652319">(</span><span class="ident" id="3652320">recordHeaderLen</span>&nbsp;<span class="op" id="3652336">+</span>&nbsp;<span class="ident" id="3652338">explicitIVLen</span>&nbsp;<span class="op" id="3652352">+</span>&nbsp;<span class="builtinfunc" id="3652354">len</span><span class="op" id="3652357">(</span><span class="ident" id="3652358">prefix</span><span class="op" id="3652364">)</span>&nbsp;<span class="op" id="3652366">+</span>&nbsp;<span class="builtinfunc" id="3652368">len</span><span class="op" id="3652371">(</span><span class="ident" id="3652372">finalBlock</span><span class="op" id="3652382">)</span><span class="op" id="3652383">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652388">c</span><span class="op" id="3652389">.</span><span class="ident" id="3652390">CryptBlocks</span><span class="op" id="3652401">(</span><span class="ident" id="3652402">b</span><span class="op" id="3652403">.</span><span class="ident" id="3652404">data</span><span class="op" id="3652408">[</span><span class="ident" id="3652409">recordHeaderLen</span><span class="op" id="3652424">+</span><span class="ident" id="3652425">explicitIVLen</span><span class="op" id="3652438">:</span><span class="op" id="3652439">]</span><span class="op" id="3652440">,</span>&nbsp;<span class="ident" id="3652442">prefix</span><span class="op" id="3652448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652453">c</span><span class="op" id="3652454">.</span><span class="ident" id="3652455">CryptBlocks</span><span class="op" id="3652466">(</span><span class="ident" id="3652467">b</span><span class="op" id="3652468">.</span><span class="ident" id="3652469">data</span><span class="op" id="3652473">[</span><span class="ident" id="3652474">recordHeaderLen</span><span class="op" id="3652489">+</span><span class="ident" id="3652490">explicitIVLen</span><span class="op" id="3652503">+</span><span class="builtinfunc" id="3652504">len</span><span class="op" id="3652507">(</span><span class="ident" id="3652508">prefix</span><span class="op" id="3652514">)</span><span class="op" id="3652515">:</span><span class="op" id="3652516">]</span><span class="op" id="3652517">,</span>&nbsp;<span class="ident" id="3652519">finalBlock</span><span class="op" id="3652529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652533">default</span><span class="op" id="3652540">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3652545">panic</span><span class="op" id="3652550">(</span><span class="string" id="3652551">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3652572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3652576">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3652579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3652583">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652646">n</span>&nbsp;<span class="op" id="3652648">:=</span>&nbsp;<span class="builtinfunc" id="3652651">len</span><span class="op" id="3652654">(</span><span class="ident" id="3652655">b</span><span class="op" id="3652656">.</span><span class="ident" id="3652657">data</span><span class="op" id="3652661">)</span>&nbsp;<span class="op" id="3652663">-</span>&nbsp;<span class="ident" id="3652665">recordHeaderLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652682">b</span><span class="op" id="3652683">.</span><span class="ident" id="3652684">data</span><span class="op" id="3652688">[</span><span class="num" id="3652689">3</span><span class="op" id="3652690">]</span>&nbsp;<span class="op" id="3652692">=</span>&nbsp;<span class="builtintype" id="3652694">byte</span><span class="op" id="3652698">(</span><span class="ident" id="3652699">n</span>&nbsp;<span class="op" id="3652701">&gt;&gt;</span>&nbsp;<span class="num" id="3652704">8</span><span class="op" id="3652705">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652708">b</span><span class="op" id="3652709">.</span><span class="ident" id="3652710">data</span><span class="op" id="3652714">[</span><span class="num" id="3652715">4</span><span class="op" id="3652716">]</span>&nbsp;<span class="op" id="3652718">=</span>&nbsp;<span class="builtintype" id="3652720">byte</span><span class="op" id="3652724">(</span><span class="ident" id="3652725">n</span><span class="op" id="3652726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652729">hc</span><span class="op" id="3652731">.</span><span class="ident" id="3652732">incSeq</span><span class="op" id="3652738">(</span><span class="op" id="3652739">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652743">return</span>&nbsp;<span class="builtintype" id="3652750">true</span><span class="op" id="3652754">,</span>&nbsp;<span class="num" id="3652756">0</span><br>
<span class="lineno"></span><span class="op" id="3652758">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="3652761">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3652797">type</span>&nbsp;<span class="ident" id="3652802">block</span>&nbsp;<span class="keyword" id="3652808">struct</span>&nbsp;<span class="op" id="3652815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652818">data</span>&nbsp;<span class="op" id="3652823">[</span><span class="op" id="3652824">]</span><span class="builtintype" id="3652825">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652831">off</span>&nbsp;&nbsp;<span class="builtintype" id="3652836">int</span>&nbsp;<span class="comment" id="3652840">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652859">link</span>&nbsp;<span class="op" id="3652864">*</span><span class="ident" id="3652865">block</span><br>
<span class="lineno"></span><span class="op" id="3652871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3652874">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3652935">func</span>&nbsp;<span class="op" id="3652940">(</span><span class="ident" id="3652941">b</span>&nbsp;<span class="op" id="3652943">*</span><span class="ident" id="3652944">block</span><span class="op" id="3652949">)</span>&nbsp;<span class="ident" id="3652951">resize</span><span class="op" id="3652957">(</span><span class="ident" id="3652958">n</span>&nbsp;<span class="builtintype" id="3652960">int</span><span class="op" id="3652963">)</span>&nbsp;<span class="op" id="3652965">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652968">if</span>&nbsp;<span class="ident" id="3652971">n</span>&nbsp;<span class="op" id="3652973">&gt;</span>&nbsp;<span class="builtinfunc" id="3652975">cap</span><span class="op" id="3652978">(</span><span class="ident" id="3652979">b</span><span class="op" id="3652980">.</span><span class="ident" id="3652981">data</span><span class="op" id="3652985">)</span>&nbsp;<span class="op" id="3652987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652991">b</span><span class="op" id="3652992">.</span><span class="ident" id="3652993">reserve</span><span class="op" id="3653000">(</span><span class="ident" id="3653001">n</span><span class="op" id="3653002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3653005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653008">b</span><span class="op" id="3653009">.</span><span class="ident" id="3653010">data</span>&nbsp;<span class="op" id="3653015">=</span>&nbsp;<span class="ident" id="3653017">b</span><span class="op" id="3653018">.</span><span class="ident" id="3653019">data</span><span class="op" id="3653023">[</span><span class="num" id="3653024">0</span><span class="op" id="3653025">:</span><span class="ident" id="3653026">n</span><span class="op" id="3653027">]</span><br>
<span class="lineno"></span><span class="op" id="3653029">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="3653032">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3653106">func</span>&nbsp;<span class="op" id="3653111">(</span><span class="ident" id="3653112">b</span>&nbsp;<span class="op" id="3653114">*</span><span class="ident" id="3653115">block</span><span class="op" id="3653120">)</span>&nbsp;<span class="ident" id="3653122">reserve</span><span class="op" id="3653129">(</span><span class="ident" id="3653130">n</span>&nbsp;<span class="builtintype" id="3653132">int</span><span class="op" id="3653135">)</span>&nbsp;<span class="op" id="3653137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653140">if</span>&nbsp;<span class="builtinfunc" id="3653143">cap</span><span class="op" id="3653146">(</span><span class="ident" id="3653147">b</span><span class="op" id="3653148">.</span><span class="ident" id="3653149">data</span><span class="op" id="3653153">)</span>&nbsp;<span class="op" id="3653155">&gt;=</span>&nbsp;<span class="ident" id="3653158">n</span>&nbsp;<span class="op" id="3653160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653164">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3653172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653175">m</span>&nbsp;<span class="op" id="3653177">:=</span>&nbsp;<span class="builtinfunc" id="3653180">cap</span><span class="op" id="3653183">(</span><span class="ident" id="3653184">b</span><span class="op" id="3653185">.</span><span class="ident" id="3653186">data</span><span class="op" id="3653190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653193">if</span>&nbsp;<span class="ident" id="3653196">m</span>&nbsp;<span class="op" id="3653198">==</span>&nbsp;<span class="num" id="3653201">0</span>&nbsp;<span class="op" id="3653203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653207">m</span>&nbsp;<span class="op" id="3653209">=</span>&nbsp;<span class="num" id="3653211">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3653217">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653220">for</span>&nbsp;<span class="ident" id="3653224">m</span>&nbsp;<span class="op" id="3653226">&lt;</span>&nbsp;<span class="ident" id="3653228">n</span>&nbsp;<span class="op" id="3653230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653234">m</span>&nbsp;<span class="op" id="3653236">*=</span>&nbsp;<span class="num" id="3653239">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3653242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653245">data</span>&nbsp;<span class="op" id="3653250">:=</span>&nbsp;<span class="builtinfunc" id="3653253">make</span><span class="op" id="3653257">(</span><span class="op" id="3653258">[</span><span class="op" id="3653259">]</span><span class="builtintype" id="3653260">byte</span><span class="op" id="3653264">,</span>&nbsp;<span class="builtinfunc" id="3653266">len</span><span class="op" id="3653269">(</span><span class="ident" id="3653270">b</span><span class="op" id="3653271">.</span><span class="ident" id="3653272">data</span><span class="op" id="3653276">)</span><span class="op" id="3653277">,</span>&nbsp;<span class="ident" id="3653279">m</span><span class="op" id="3653280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3653283">copy</span><span class="op" id="3653287">(</span><span class="ident" id="3653288">data</span><span class="op" id="3653292">,</span>&nbsp;<span class="ident" id="3653294">b</span><span class="op" id="3653295">.</span><span class="ident" id="3653296">data</span><span class="op" id="3653300">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653303">b</span><span class="op" id="3653304">.</span><span class="ident" id="3653305">data</span>&nbsp;<span class="op" id="3653310">=</span>&nbsp;<span class="ident" id="3653312">data</span><br>
<span class="lineno"></span><span class="op" id="3653317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3653320">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="3653391">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="3653420">func</span>&nbsp;<span class="op" id="3653425">(</span><span class="ident" id="3653426">b</span>&nbsp;<span class="op" id="3653428">*</span><span class="ident" id="3653429">block</span><span class="op" id="3653434">)</span>&nbsp;<span class="ident" id="3653436">readFromUntil</span><span class="op" id="3653449">(</span><span class="ident" id="3653450">r</span>&nbsp;<span class="ident" id="3653452">io</span><span class="op" id="3653454">.</span><span class="ident" id="3653455">Reader</span><span class="op" id="3653461">,</span>&nbsp;<span class="ident" id="3653463">n</span>&nbsp;<span class="builtintype" id="3653465">int</span><span class="op" id="3653468">)</span>&nbsp;<span class="builtintype" id="3653470">error</span>&nbsp;<span class="op" id="3653476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3653479">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653494">if</span>&nbsp;<span class="builtinfunc" id="3653497">len</span><span class="op" id="3653500">(</span><span class="ident" id="3653501">b</span><span class="op" id="3653502">.</span><span class="ident" id="3653503">data</span><span class="op" id="3653507">)</span>&nbsp;<span class="op" id="3653509">&gt;=</span>&nbsp;<span class="ident" id="3653512">n</span>&nbsp;<span class="op" id="3653514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653518">return</span>&nbsp;<span class="ident" id="3653525">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3653530">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3653534">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653562">b</span><span class="op" id="3653563">.</span><span class="ident" id="3653564">reserve</span><span class="op" id="3653571">(</span><span class="ident" id="3653572">n</span><span class="op" id="3653573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653576">for</span>&nbsp;<span class="op" id="3653580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653584">m</span><span class="op" id="3653585">,</span>&nbsp;<span class="ident" id="3653587">err</span>&nbsp;<span class="op" id="3653591">:=</span>&nbsp;<span class="ident" id="3653594">r</span><span class="op" id="3653595">.</span><span class="ident" id="3653596">Read</span><span class="op" id="3653600">(</span><span class="ident" id="3653601">b</span><span class="op" id="3653602">.</span><span class="ident" id="3653603">data</span><span class="op" id="3653607">[</span><span class="builtinfunc" id="3653608">len</span><span class="op" id="3653611">(</span><span class="ident" id="3653612">b</span><span class="op" id="3653613">.</span><span class="ident" id="3653614">data</span><span class="op" id="3653618">)</span><span class="op" id="3653619">:</span><span class="builtinfunc" id="3653620">cap</span><span class="op" id="3653623">(</span><span class="ident" id="3653624">b</span><span class="op" id="3653625">.</span><span class="ident" id="3653626">data</span><span class="op" id="3653630">)</span><span class="op" id="3653631">]</span><span class="op" id="3653632">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653636">b</span><span class="op" id="3653637">.</span><span class="ident" id="3653638">data</span>&nbsp;<span class="op" id="3653643">=</span>&nbsp;<span class="ident" id="3653645">b</span><span class="op" id="3653646">.</span><span class="ident" id="3653647">data</span><span class="op" id="3653651">[</span><span class="num" id="3653652">0</span>&nbsp;<span class="op" id="3653654">:</span>&nbsp;<span class="builtinfunc" id="3653656">len</span><span class="op" id="3653659">(</span><span class="ident" id="3653660">b</span><span class="op" id="3653661">.</span><span class="ident" id="3653662">data</span><span class="op" id="3653666">)</span><span class="op" id="3653667">+</span><span class="ident" id="3653668">m</span><span class="op" id="3653669">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653673">if</span>&nbsp;<span class="builtinfunc" id="3653676">len</span><span class="op" id="3653679">(</span><span class="ident" id="3653680">b</span><span class="op" id="3653681">.</span><span class="ident" id="3653682">data</span><span class="op" id="3653686">)</span>&nbsp;<span class="op" id="3653688">&gt;=</span>&nbsp;<span class="ident" id="3653691">n</span>&nbsp;<span class="op" id="3653693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3653698">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3653744">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653794">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3653802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653806">if</span>&nbsp;<span class="ident" id="3653809">err</span>&nbsp;<span class="op" id="3653813">!=</span>&nbsp;<span class="ident" id="3653816">nil</span>&nbsp;<span class="op" id="3653820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653825">return</span>&nbsp;<span class="ident" id="3653832">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3653838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3653841">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653844">return</span>&nbsp;<span class="ident" id="3653851">nil</span><br>
<span class="lineno"></span><span class="op" id="3653855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3653858">func</span>&nbsp;<span class="op" id="3653863">(</span><span class="ident" id="3653864">b</span>&nbsp;<span class="op" id="3653866">*</span><span class="ident" id="3653867">block</span><span class="op" id="3653872">)</span>&nbsp;<span class="ident" id="3653874">Read</span><span class="op" id="3653878">(</span><span class="ident" id="3653879">p</span>&nbsp;<span class="op" id="3653881">[</span><span class="op" id="3653882">]</span><span class="builtintype" id="3653883">byte</span><span class="op" id="3653887">)</span>&nbsp;<span class="op" id="3653889">(</span><span class="ident" id="3653890">n</span>&nbsp;<span class="builtintype" id="3653892">int</span><span class="op" id="3653895">,</span>&nbsp;<span class="ident" id="3653897">err</span>&nbsp;<span class="builtintype" id="3653901">error</span><span class="op" id="3653906">)</span>&nbsp;<span class="op" id="3653908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653911">n</span>&nbsp;<span class="op" id="3653913">=</span>&nbsp;<span class="builtinfunc" id="3653915">copy</span><span class="op" id="3653919">(</span><span class="ident" id="3653920">p</span><span class="op" id="3653921">,</span>&nbsp;<span class="ident" id="3653923">b</span><span class="op" id="3653924">.</span><span class="ident" id="3653925">data</span><span class="op" id="3653929">[</span><span class="ident" id="3653930">b</span><span class="op" id="3653931">.</span><span class="ident" id="3653932">off</span><span class="op" id="3653935">:</span><span class="op" id="3653936">]</span><span class="op" id="3653937">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653940">b</span><span class="op" id="3653941">.</span><span class="ident" id="3653942">off</span>&nbsp;<span class="op" id="3653946">+=</span>&nbsp;<span class="ident" id="3653949">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653952">return</span><br>
<span class="lineno"></span><span class="op" id="3653959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3653962">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="3654030">func</span>&nbsp;<span class="op" id="3654035">(</span><span class="ident" id="3654036">hc</span>&nbsp;<span class="op" id="3654039">*</span><span class="ident" id="3654040">halfConn</span><span class="op" id="3654048">)</span>&nbsp;<span class="ident" id="3654050">newBlock</span><span class="op" id="3654058">(</span><span class="op" id="3654059">)</span>&nbsp;<span class="op" id="3654061">*</span><span class="ident" id="3654062">block</span>&nbsp;<span class="op" id="3654068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654071">b</span>&nbsp;<span class="op" id="3654073">:=</span>&nbsp;<span class="ident" id="3654076">hc</span><span class="op" id="3654078">.</span><span class="ident" id="3654079">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654086">if</span>&nbsp;<span class="ident" id="3654089">b</span>&nbsp;<span class="op" id="3654091">==</span>&nbsp;<span class="ident" id="3654094">nil</span>&nbsp;<span class="op" id="3654098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654102">return</span>&nbsp;<span class="builtinfunc" id="3654109">new</span><span class="op" id="3654112">(</span><span class="ident" id="3654113">block</span><span class="op" id="3654118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3654121">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654124">hc</span><span class="op" id="3654126">.</span><span class="ident" id="3654127">bfree</span>&nbsp;<span class="op" id="3654133">=</span>&nbsp;<span class="ident" id="3654135">b</span><span class="op" id="3654136">.</span><span class="ident" id="3654137">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654143">b</span><span class="op" id="3654144">.</span><span class="ident" id="3654145">link</span>&nbsp;<span class="op" id="3654150">=</span>&nbsp;<span class="ident" id="3654152">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654157">b</span><span class="op" id="3654158">.</span><span class="ident" id="3654159">resize</span><span class="op" id="3654165">(</span><span class="num" id="3654166">0</span><span class="op" id="3654167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654170">return</span>&nbsp;<span class="ident" id="3654177">b</span><br>
<span class="lineno"></span><span class="op" id="3654179">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="3654182">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="3654230">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3654296">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="3654358">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="3654385">func</span>&nbsp;<span class="op" id="3654390">(</span><span class="ident" id="3654391">hc</span>&nbsp;<span class="op" id="3654394">*</span><span class="ident" id="3654395">halfConn</span><span class="op" id="3654403">)</span>&nbsp;<span class="ident" id="3654405">freeBlock</span><span class="op" id="3654414">(</span><span class="ident" id="3654415">b</span>&nbsp;<span class="op" id="3654417">*</span><span class="ident" id="3654418">block</span><span class="op" id="3654423">)</span>&nbsp;<span class="op" id="3654425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654428">b</span><span class="op" id="3654429">.</span><span class="ident" id="3654430">link</span>&nbsp;<span class="op" id="3654435">=</span>&nbsp;<span class="ident" id="3654437">hc</span><span class="op" id="3654439">.</span><span class="ident" id="3654440">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654447">hc</span><span class="op" id="3654449">.</span><span class="ident" id="3654450">bfree</span>&nbsp;<span class="op" id="3654456">=</span>&nbsp;<span class="ident" id="3654458">b</span><br>
<span class="lineno"></span><span class="op" id="3654460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="3654463">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="3654517">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3654563">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3654616">func</span>&nbsp;<span class="op" id="3654621">(</span><span class="ident" id="3654622">hc</span>&nbsp;<span class="op" id="3654625">*</span><span class="ident" id="3654626">halfConn</span><span class="op" id="3654634">)</span>&nbsp;<span class="ident" id="3654636">splitBlock</span><span class="op" id="3654646">(</span><span class="ident" id="3654647">b</span>&nbsp;<span class="op" id="3654649">*</span><span class="ident" id="3654650">block</span><span class="op" id="3654655">,</span>&nbsp;<span class="ident" id="3654657">n</span>&nbsp;<span class="builtintype" id="3654659">int</span><span class="op" id="3654662">)</span>&nbsp;<span class="op" id="3654664">(</span><span class="op" id="3654665">*</span><span class="ident" id="3654666">block</span><span class="op" id="3654671">,</span>&nbsp;<span class="op" id="3654673">*</span><span class="ident" id="3654674">block</span><span class="op" id="3654679">)</span>&nbsp;<span class="op" id="3654681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654684">if</span>&nbsp;<span class="builtinfunc" id="3654687">len</span><span class="op" id="3654690">(</span><span class="ident" id="3654691">b</span><span class="op" id="3654692">.</span><span class="ident" id="3654693">data</span><span class="op" id="3654697">)</span>&nbsp;<span class="op" id="3654699">&lt;=</span>&nbsp;<span class="ident" id="3654702">n</span>&nbsp;<span class="op" id="3654704">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654708">return</span>&nbsp;<span class="ident" id="3654715">b</span><span class="op" id="3654716">,</span>&nbsp;<span class="ident" id="3654718">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3654723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654726">bb</span>&nbsp;<span class="op" id="3654729">:=</span>&nbsp;<span class="ident" id="3654732">hc</span><span class="op" id="3654734">.</span><span class="ident" id="3654735">newBlock</span><span class="op" id="3654743">(</span><span class="op" id="3654744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654747">bb</span><span class="op" id="3654749">.</span><span class="ident" id="3654750">resize</span><span class="op" id="3654756">(</span><span class="builtinfunc" id="3654757">len</span><span class="op" id="3654760">(</span><span class="ident" id="3654761">b</span><span class="op" id="3654762">.</span><span class="ident" id="3654763">data</span><span class="op" id="3654767">)</span>&nbsp;<span class="op" id="3654769">-</span>&nbsp;<span class="ident" id="3654771">n</span><span class="op" id="3654772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3654775">copy</span><span class="op" id="3654779">(</span><span class="ident" id="3654780">bb</span><span class="op" id="3654782">.</span><span class="ident" id="3654783">data</span><span class="op" id="3654787">,</span>&nbsp;<span class="ident" id="3654789">b</span><span class="op" id="3654790">.</span><span class="ident" id="3654791">data</span><span class="op" id="3654795">[</span><span class="ident" id="3654796">n</span><span class="op" id="3654797">:</span><span class="op" id="3654798">]</span><span class="op" id="3654799">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654802">b</span><span class="op" id="3654803">.</span><span class="ident" id="3654804">data</span>&nbsp;<span class="op" id="3654809">=</span>&nbsp;<span class="ident" id="3654811">b</span><span class="op" id="3654812">.</span><span class="ident" id="3654813">data</span><span class="op" id="3654817">[</span><span class="num" id="3654818">0</span><span class="op" id="3654819">:</span><span class="ident" id="3654820">n</span><span class="op" id="3654821">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654824">return</span>&nbsp;<span class="ident" id="3654831">b</span><span class="op" id="3654832">,</span>&nbsp;<span class="ident" id="3654834">bb</span><br>
<span class="lineno"></span><span class="op" id="3654837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3654840">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="3654900">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3654939">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3654975">func</span>&nbsp;<span class="op" id="3654980">(</span><span class="ident" id="3654981">c</span>&nbsp;<span class="op" id="3654983">*</span><span class="ident" id="3654984">Conn</span><span class="op" id="3654988">)</span>&nbsp;<span class="ident" id="3654990">readRecord</span><span class="op" id="3655000">(</span><span class="ident" id="3655001">want</span>&nbsp;<span class="ident" id="3655006">recordType</span><span class="op" id="3655016">)</span>&nbsp;<span class="builtintype" id="3655018">error</span>&nbsp;<span class="op" id="3655024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3655027">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3655071">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3655122">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655184">switch</span>&nbsp;<span class="ident" id="3655191">want</span>&nbsp;<span class="op" id="3655196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655199">default</span><span class="op" id="3655206">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3655210">c</span><span class="op" id="3655211">.</span><span class="ident" id="3655212">sendAlert</span><span class="op" id="3655221">(</span><span class="ident" id="3655222">alertInternalError</span><span class="op" id="3655240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655244">return</span>&nbsp;<span class="ident" id="3655251">c</span><span class="op" id="3655252">.</span><span class="ident" id="3655253">in</span><span class="op" id="3655255">.</span><span class="ident" id="3655256">setErrorLocked</span><span class="op" id="3655270">(</span><span class="ident" id="3655271">errors</span><span class="op" id="3655277">.</span><span class="ident" id="3655278">New</span><span class="op" id="3655281">(</span><span class="string" id="3655282">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="3655318">)</span><span class="op" id="3655319">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655322">case</span>&nbsp;<span class="ident" id="3655327">recordTypeHandshake</span><span class="op" id="3655346">,</span>&nbsp;<span class="ident" id="3655348">recordTypeChangeCipherSpec</span><span class="op" id="3655374">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655378">if</span>&nbsp;<span class="ident" id="3655381">c</span><span class="op" id="3655382">.</span><span class="ident" id="3655383">handshakeComplete</span>&nbsp;<span class="op" id="3655401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3655406">c</span><span class="op" id="3655407">.</span><span class="ident" id="3655408">sendAlert</span><span class="op" id="3655417">(</span><span class="ident" id="3655418">alertInternalError</span><span class="op" id="3655436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655441">return</span>&nbsp;<span class="ident" id="3655448">c</span><span class="op" id="3655449">.</span><span class="ident" id="3655450">in</span><span class="op" id="3655452">.</span><span class="ident" id="3655453">setErrorLocked</span><span class="op" id="3655467">(</span><span class="ident" id="3655468">errors</span><span class="op" id="3655474">.</span><span class="ident" id="3655475">New</span><span class="op" id="3655478">(</span><span class="string" id="3655479">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3655550">)</span><span class="op" id="3655551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3655555">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655558">case</span>&nbsp;<span class="ident" id="3655563">recordTypeApplicationData</span><span class="op" id="3655588">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655592">if</span>&nbsp;<span class="op" id="3655595">!</span><span class="ident" id="3655596">c</span><span class="op" id="3655597">.</span><span class="ident" id="3655598">handshakeComplete</span>&nbsp;<span class="op" id="3655616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3655621">c</span><span class="op" id="3655622">.</span><span class="ident" id="3655623">sendAlert</span><span class="op" id="3655632">(</span><span class="ident" id="3655633">alertInternalError</span><span class="op" id="3655651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655656">return</span>&nbsp;<span class="ident" id="3655663">c</span><span class="op" id="3655664">.</span><span class="ident" id="3655665">in</span><span class="op" id="3655667">.</span><span class="ident" id="3655668">setErrorLocked</span><span class="op" id="3655682">(</span><span class="ident" id="3655683">errors</span><span class="op" id="3655689">.</span><span class="ident" id="3655690">New</span><span class="op" id="3655693">(</span><span class="string" id="3655694">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3655760">)</span><span class="op" id="3655761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3655765">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3655768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3655771">Again</span><span class="op" id="3655776">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655779">if</span>&nbsp;<span class="ident" id="3655782">c</span><span class="op" id="3655783">.</span><span class="ident" id="3655784">rawInput</span>&nbsp;<span class="op" id="3655793">==</span>&nbsp;<span class="ident" id="3655796">nil</span>&nbsp;<span class="op" id="3655800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3655804">c</span><span class="op" id="3655805">.</span><span class="ident" id="3655806">rawInput</span>&nbsp;<span class="op" id="3655815">=</span>&nbsp;<span class="ident" id="3655817">c</span><span class="op" id="3655818">.</span><span class="ident" id="3655819">in</span><span class="op" id="3655821">.</span><span class="ident" id="3655822">newBlock</span><span class="op" id="3655830">(</span><span class="op" id="3655831">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3655834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3655837">b</span>&nbsp;<span class="op" id="3655839">:=</span>&nbsp;<span class="ident" id="3655842">c</span><span class="op" id="3655843">.</span><span class="ident" id="3655844">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3655855">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655881">if</span>&nbsp;<span class="ident" id="3655884">err</span>&nbsp;<span class="op" id="3655888">:=</span>&nbsp;<span class="ident" id="3655891">b</span><span class="op" id="3655892">.</span><span class="ident" id="3655893">readFromUntil</span><span class="op" id="3655906">(</span><span class="ident" id="3655907">c</span><span class="op" id="3655908">.</span><span class="ident" id="3655909">conn</span><span class="op" id="3655913">,</span>&nbsp;<span class="ident" id="3655915">recordHeaderLen</span><span class="op" id="3655930">)</span><span class="op" id="3655931">;</span>&nbsp;<span class="ident" id="3655933">err</span>&nbsp;<span class="op" id="3655937">!=</span>&nbsp;<span class="ident" id="3655940">nil</span>&nbsp;<span class="op" id="3655944">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3655948">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656006">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656060">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656095">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656119">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656151">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656158">if</span>&nbsp;<span class="ident" id="3656161">e</span><span class="op" id="3656162">,</span>&nbsp;<span class="ident" id="3656164">ok</span>&nbsp;<span class="op" id="3656167">:=</span>&nbsp;<span class="ident" id="3656170">err</span><span class="op" id="3656173">.</span><span class="op" id="3656174">(</span><span class="ident" id="3656175">net</span><span class="op" id="3656178">.</span><span class="ident" id="3656179">Error</span><span class="op" id="3656184">)</span><span class="op" id="3656185">;</span>&nbsp;<span class="op" id="3656187">!</span><span class="ident" id="3656188">ok</span>&nbsp;<span class="op" id="3656191">||</span>&nbsp;<span class="op" id="3656194">!</span><span class="ident" id="3656195">e</span><span class="op" id="3656196">.</span><span class="ident" id="3656197">Temporary</span><span class="op" id="3656206">(</span><span class="op" id="3656207">)</span>&nbsp;<span class="op" id="3656209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3656214">c</span><span class="op" id="3656215">.</span><span class="ident" id="3656216">in</span><span class="op" id="3656218">.</span><span class="ident" id="3656219">setErrorLocked</span><span class="op" id="3656233">(</span><span class="ident" id="3656234">err</span><span class="op" id="3656237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3656241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656245">return</span>&nbsp;<span class="ident" id="3656252">err</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3656257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3656260">typ</span>&nbsp;<span class="op" id="3656264">:=</span>&nbsp;<span class="ident" id="3656267">recordType</span><span class="op" id="3656277">(</span><span class="ident" id="3656278">b</span><span class="op" id="3656279">.</span><span class="ident" id="3656280">data</span><span class="op" id="3656284">[</span><span class="num" id="3656285">0</span><span class="op" id="3656286">]</span><span class="op" id="3656287">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656291">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656360">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656433">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656505">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656526">if</span>&nbsp;<span class="ident" id="3656529">want</span>&nbsp;<span class="op" id="3656534">==</span>&nbsp;<span class="ident" id="3656537">recordTypeHandshake</span>&nbsp;<span class="op" id="3656557">&amp;&amp;</span>&nbsp;<span class="ident" id="3656560">typ</span>&nbsp;<span class="op" id="3656564">==</span>&nbsp;<span class="num" id="3656567">0x80</span>&nbsp;<span class="op" id="3656572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3656576">c</span><span class="op" id="3656577">.</span><span class="ident" id="3656578">sendAlert</span><span class="op" id="3656587">(</span><span class="ident" id="3656588">alertProtocolVersion</span><span class="op" id="3656608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656612">return</span>&nbsp;<span class="ident" id="3656619">c</span><span class="op" id="3656620">.</span><span class="ident" id="3656621">in</span><span class="op" id="3656623">.</span><span class="ident" id="3656624">setErrorLocked</span><span class="op" id="3656638">(</span><span class="ident" id="3656639">errors</span><span class="op" id="3656645">.</span><span class="ident" id="3656646">New</span><span class="op" id="3656649">(</span><span class="string" id="3656650">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="3656693">)</span><span class="op" id="3656694">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3656697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3656701">vers</span>&nbsp;<span class="op" id="3656706">:=</span>&nbsp;<span class="builtintype" id="3656709">uint16</span><span class="op" id="3656715">(</span><span class="ident" id="3656716">b</span><span class="op" id="3656717">.</span><span class="ident" id="3656718">data</span><span class="op" id="3656722">[</span><span class="num" id="3656723">1</span><span class="op" id="3656724">]</span><span class="op" id="3656725">)</span><span class="op" id="3656726">&lt;&lt;</span><span class="num" id="3656728">8</span>&nbsp;<span class="op" id="3656730">|</span>&nbsp;<span class="builtintype" id="3656732">uint16</span><span class="op" id="3656738">(</span><span class="ident" id="3656739">b</span><span class="op" id="3656740">.</span><span class="ident" id="3656741">data</span><span class="op" id="3656745">[</span><span class="num" id="3656746">2</span><span class="op" id="3656747">]</span><span class="op" id="3656748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3656751">n</span>&nbsp;<span class="op" id="3656753">:=</span>&nbsp;<span class="builtintype" id="3656756">int</span><span class="op" id="3656759">(</span><span class="ident" id="3656760">b</span><span class="op" id="3656761">.</span><span class="ident" id="3656762">data</span><span class="op" id="3656766">[</span><span class="num" id="3656767">3</span><span class="op" id="3656768">]</span><span class="op" id="3656769">)</span><span class="op" id="3656770">&lt;&lt;</span><span class="num" id="3656772">8</span>&nbsp;<span class="op" id="3656774">|</span>&nbsp;<span class="builtintype" id="3656776">int</span><span class="op" id="3656779">(</span><span class="ident" id="3656780">b</span><span class="op" id="3656781">.</span><span class="ident" id="3656782">data</span><span class="op" id="3656786">[</span><span class="num" id="3656787">4</span><span class="op" id="3656788">]</span><span class="op" id="3656789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656792">if</span>&nbsp;<span class="ident" id="3656795">c</span><span class="op" id="3656796">.</span><span class="ident" id="3656797">haveVers</span>&nbsp;<span class="op" id="3656806">&amp;&amp;</span>&nbsp;<span class="ident" id="3656809">vers</span>&nbsp;<span class="op" id="3656814">!=</span>&nbsp;<span class="ident" id="3656817">c</span><span class="op" id="3656818">.</span><span class="ident" id="3656819">vers</span>&nbsp;<span class="op" id="3656824">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3656828">c</span><span class="op" id="3656829">.</span><span class="ident" id="3656830">sendAlert</span><span class="op" id="3656839">(</span><span class="ident" id="3656840">alertProtocolVersion</span><span class="op" id="3656860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656864">return</span>&nbsp;<span class="ident" id="3656871">c</span><span class="op" id="3656872">.</span><span class="ident" id="3656873">in</span><span class="op" id="3656875">.</span><span class="ident" id="3656876">setErrorLocked</span><span class="op" id="3656890">(</span><span class="ident" id="3656891">fmt</span><span class="op" id="3656894">.</span><span class="ident" id="3656895">Errorf</span><span class="op" id="3656901">(</span><span class="string" id="3656902">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3656966">,</span>&nbsp;<span class="ident" id="3656968">vers</span><span class="op" id="3656972">,</span>&nbsp;<span class="ident" id="3656974">c</span><span class="op" id="3656975">.</span><span class="ident" id="3656976">vers</span><span class="op" id="3656980">)</span><span class="op" id="3656981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3656984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656987">if</span>&nbsp;<span class="ident" id="3656990">n</span>&nbsp;<span class="op" id="3656992">&gt;</span>&nbsp;<span class="ident" id="3656994">maxCiphertext</span>&nbsp;<span class="op" id="3657008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657012">c</span><span class="op" id="3657013">.</span><span class="ident" id="3657014">sendAlert</span><span class="op" id="3657023">(</span><span class="ident" id="3657024">alertRecordOverflow</span><span class="op" id="3657043">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657047">return</span>&nbsp;<span class="ident" id="3657054">c</span><span class="op" id="3657055">.</span><span class="ident" id="3657056">in</span><span class="op" id="3657058">.</span><span class="ident" id="3657059">setErrorLocked</span><span class="op" id="3657073">(</span><span class="ident" id="3657074">fmt</span><span class="op" id="3657077">.</span><span class="ident" id="3657078">Errorf</span><span class="op" id="3657084">(</span><span class="string" id="3657085">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3657132">,</span>&nbsp;<span class="ident" id="3657134">n</span><span class="op" id="3657135">)</span><span class="op" id="3657136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3657139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657142">if</span>&nbsp;<span class="op" id="3657145">!</span><span class="ident" id="3657146">c</span><span class="op" id="3657147">.</span><span class="ident" id="3657148">haveVers</span>&nbsp;<span class="op" id="3657157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3657161">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3657202">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3657239">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3657296">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3657333">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3657389">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3657438">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3657494">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657523">if</span>&nbsp;<span class="op" id="3657526">(</span><span class="ident" id="3657527">typ</span>&nbsp;<span class="op" id="3657531">!=</span>&nbsp;<span class="ident" id="3657534">recordTypeAlert</span>&nbsp;<span class="op" id="3657550">&amp;&amp;</span>&nbsp;<span class="ident" id="3657553">typ</span>&nbsp;<span class="op" id="3657557">!=</span>&nbsp;<span class="ident" id="3657560">want</span><span class="op" id="3657564">)</span>&nbsp;<span class="op" id="3657566">||</span>&nbsp;<span class="ident" id="3657569">vers</span>&nbsp;<span class="op" id="3657574">&gt;=</span>&nbsp;<span class="num" id="3657577">0x1000</span>&nbsp;<span class="op" id="3657584">||</span>&nbsp;<span class="ident" id="3657587">n</span>&nbsp;<span class="op" id="3657589">&gt;=</span>&nbsp;<span class="num" id="3657592">0x3000</span>&nbsp;<span class="op" id="3657599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657604">c</span><span class="op" id="3657605">.</span><span class="ident" id="3657606">sendAlert</span><span class="op" id="3657615">(</span><span class="ident" id="3657616">alertUnexpectedMessage</span><span class="op" id="3657638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657643">return</span>&nbsp;<span class="ident" id="3657650">c</span><span class="op" id="3657651">.</span><span class="ident" id="3657652">in</span><span class="op" id="3657654">.</span><span class="ident" id="3657655">setErrorLocked</span><span class="op" id="3657669">(</span><span class="ident" id="3657670">fmt</span><span class="op" id="3657673">.</span><span class="ident" id="3657674">Errorf</span><span class="op" id="3657680">(</span><span class="string" id="3657681">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="3657735">)</span><span class="op" id="3657736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3657740">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3657743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657746">if</span>&nbsp;<span class="ident" id="3657749">err</span>&nbsp;<span class="op" id="3657753">:=</span>&nbsp;<span class="ident" id="3657756">b</span><span class="op" id="3657757">.</span><span class="ident" id="3657758">readFromUntil</span><span class="op" id="3657771">(</span><span class="ident" id="3657772">c</span><span class="op" id="3657773">.</span><span class="ident" id="3657774">conn</span><span class="op" id="3657778">,</span>&nbsp;<span class="ident" id="3657780">recordHeaderLen</span><span class="op" id="3657795">+</span><span class="ident" id="3657796">n</span><span class="op" id="3657797">)</span><span class="op" id="3657798">;</span>&nbsp;<span class="ident" id="3657800">err</span>&nbsp;<span class="op" id="3657804">!=</span>&nbsp;<span class="ident" id="3657807">nil</span>&nbsp;<span class="op" id="3657811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657815">if</span>&nbsp;<span class="ident" id="3657818">err</span>&nbsp;<span class="op" id="3657822">==</span>&nbsp;<span class="ident" id="3657825">io</span><span class="op" id="3657827">.</span><span class="ident" id="3657828">EOF</span>&nbsp;<span class="op" id="3657832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657837">err</span>&nbsp;<span class="op" id="3657841">=</span>&nbsp;<span class="ident" id="3657843">io</span><span class="op" id="3657845">.</span><span class="ident" id="3657846">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3657865">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657869">if</span>&nbsp;<span class="ident" id="3657872">e</span><span class="op" id="3657873">,</span>&nbsp;<span class="ident" id="3657875">ok</span>&nbsp;<span class="op" id="3657878">:=</span>&nbsp;<span class="ident" id="3657881">err</span><span class="op" id="3657884">.</span><span class="op" id="3657885">(</span><span class="ident" id="3657886">net</span><span class="op" id="3657889">.</span><span class="ident" id="3657890">Error</span><span class="op" id="3657895">)</span><span class="op" id="3657896">;</span>&nbsp;<span class="op" id="3657898">!</span><span class="ident" id="3657899">ok</span>&nbsp;<span class="op" id="3657902">||</span>&nbsp;<span class="op" id="3657905">!</span><span class="ident" id="3657906">e</span><span class="op" id="3657907">.</span><span class="ident" id="3657908">Temporary</span><span class="op" id="3657917">(</span><span class="op" id="3657918">)</span>&nbsp;<span class="op" id="3657920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657925">c</span><span class="op" id="3657926">.</span><span class="ident" id="3657927">in</span><span class="op" id="3657929">.</span><span class="ident" id="3657930">setErrorLocked</span><span class="op" id="3657944">(</span><span class="ident" id="3657945">err</span><span class="op" id="3657948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3657952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657956">return</span>&nbsp;<span class="ident" id="3657963">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3657968">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3657972">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657993">b</span><span class="op" id="3657994">,</span>&nbsp;<span class="ident" id="3657996">c</span><span class="op" id="3657997">.</span><span class="ident" id="3657998">rawInput</span>&nbsp;<span class="op" id="3658007">=</span>&nbsp;<span class="ident" id="3658009">c</span><span class="op" id="3658010">.</span><span class="ident" id="3658011">in</span><span class="op" id="3658013">.</span><span class="ident" id="3658014">splitBlock</span><span class="op" id="3658024">(</span><span class="ident" id="3658025">b</span><span class="op" id="3658026">,</span>&nbsp;<span class="ident" id="3658028">recordHeaderLen</span><span class="op" id="3658043">+</span><span class="ident" id="3658044">n</span><span class="op" id="3658045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658048">ok</span><span class="op" id="3658050">,</span>&nbsp;<span class="ident" id="3658052">off</span><span class="op" id="3658055">,</span>&nbsp;<span class="ident" id="3658057">err</span>&nbsp;<span class="op" id="3658061">:=</span>&nbsp;<span class="ident" id="3658064">c</span><span class="op" id="3658065">.</span><span class="ident" id="3658066">in</span><span class="op" id="3658068">.</span><span class="ident" id="3658069">decrypt</span><span class="op" id="3658076">(</span><span class="ident" id="3658077">b</span><span class="op" id="3658078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658081">if</span>&nbsp;<span class="op" id="3658084">!</span><span class="ident" id="3658085">ok</span>&nbsp;<span class="op" id="3658088">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658092">c</span><span class="op" id="3658093">.</span><span class="ident" id="3658094">in</span><span class="op" id="3658096">.</span><span class="ident" id="3658097">setErrorLocked</span><span class="op" id="3658111">(</span><span class="ident" id="3658112">c</span><span class="op" id="3658113">.</span><span class="ident" id="3658114">sendAlert</span><span class="op" id="3658123">(</span><span class="ident" id="3658124">err</span><span class="op" id="3658127">)</span><span class="op" id="3658128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3658131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658134">b</span><span class="op" id="3658135">.</span><span class="ident" id="3658136">off</span>&nbsp;<span class="op" id="3658140">=</span>&nbsp;<span class="ident" id="3658142">off</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658147">data</span>&nbsp;<span class="op" id="3658152">:=</span>&nbsp;<span class="ident" id="3658155">b</span><span class="op" id="3658156">.</span><span class="ident" id="3658157">data</span><span class="op" id="3658161">[</span><span class="ident" id="3658162">b</span><span class="op" id="3658163">.</span><span class="ident" id="3658164">off</span><span class="op" id="3658167">:</span><span class="op" id="3658168">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658171">if</span>&nbsp;<span class="builtinfunc" id="3658174">len</span><span class="op" id="3658177">(</span><span class="ident" id="3658178">data</span><span class="op" id="3658182">)</span>&nbsp;<span class="op" id="3658184">&gt;</span>&nbsp;<span class="ident" id="3658186">maxPlaintext</span>&nbsp;<span class="op" id="3658199">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658203">err</span>&nbsp;<span class="op" id="3658207">:=</span>&nbsp;<span class="ident" id="3658210">c</span><span class="op" id="3658211">.</span><span class="ident" id="3658212">sendAlert</span><span class="op" id="3658221">(</span><span class="ident" id="3658222">alertRecordOverflow</span><span class="op" id="3658241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658245">c</span><span class="op" id="3658246">.</span><span class="ident" id="3658247">in</span><span class="op" id="3658249">.</span><span class="ident" id="3658250">freeBlock</span><span class="op" id="3658259">(</span><span class="ident" id="3658260">b</span><span class="op" id="3658261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658265">return</span>&nbsp;<span class="ident" id="3658272">c</span><span class="op" id="3658273">.</span><span class="ident" id="3658274">in</span><span class="op" id="3658276">.</span><span class="ident" id="3658277">setErrorLocked</span><span class="op" id="3658291">(</span><span class="ident" id="3658292">err</span><span class="op" id="3658295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3658298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658302">switch</span>&nbsp;<span class="ident" id="3658309">typ</span>&nbsp;<span class="op" id="3658313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658316">default</span><span class="op" id="3658323">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658327">c</span><span class="op" id="3658328">.</span><span class="ident" id="3658329">in</span><span class="op" id="3658331">.</span><span class="ident" id="3658332">setErrorLocked</span><span class="op" id="3658346">(</span><span class="ident" id="3658347">c</span><span class="op" id="3658348">.</span><span class="ident" id="3658349">sendAlert</span><span class="op" id="3658358">(</span><span class="ident" id="3658359">alertUnexpectedMessage</span><span class="op" id="3658381">)</span><span class="op" id="3658382">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658386">case</span>&nbsp;<span class="ident" id="3658391">recordTypeAlert</span><span class="op" id="3658406">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658410">if</span>&nbsp;<span class="builtinfunc" id="3658413">len</span><span class="op" id="3658416">(</span><span class="ident" id="3658417">data</span><span class="op" id="3658421">)</span>&nbsp;<span class="op" id="3658423">!=</span>&nbsp;<span class="num" id="3658426">2</span>&nbsp;<span class="op" id="3658428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658433">c</span><span class="op" id="3658434">.</span><span class="ident" id="3658435">in</span><span class="op" id="3658437">.</span><span class="ident" id="3658438">setErrorLocked</span><span class="op" id="3658452">(</span><span class="ident" id="3658453">c</span><span class="op" id="3658454">.</span><span class="ident" id="3658455">sendAlert</span><span class="op" id="3658464">(</span><span class="ident" id="3658465">alertUnexpectedMessage</span><span class="op" id="3658487">)</span><span class="op" id="3658488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658493">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3658501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658505">if</span>&nbsp;<span class="ident" id="3658508">alert</span><span class="op" id="3658513">(</span><span class="ident" id="3658514">data</span><span class="op" id="3658518">[</span><span class="num" id="3658519">1</span><span class="op" id="3658520">]</span><span class="op" id="3658521">)</span>&nbsp;<span class="op" id="3658523">==</span>&nbsp;<span class="ident" id="3658526">alertCloseNotify</span>&nbsp;<span class="op" id="3658543">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658548">c</span><span class="op" id="3658549">.</span><span class="ident" id="3658550">in</span><span class="op" id="3658552">.</span><span class="ident" id="3658553">setErrorLocked</span><span class="op" id="3658567">(</span><span class="ident" id="3658568">io</span><span class="op" id="3658570">.</span><span class="ident" id="3658571">EOF</span><span class="op" id="3658574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658579">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3658587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658591">switch</span>&nbsp;<span class="ident" id="3658598">data</span><span class="op" id="3658602">[</span><span class="num" id="3658603">0</span><span class="op" id="3658604">]</span>&nbsp;<span class="op" id="3658606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658610">case</span>&nbsp;<span class="ident" id="3658615">alertLevelWarning</span><span class="op" id="3658632">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3658637">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658661">c</span><span class="op" id="3658662">.</span><span class="ident" id="3658663">in</span><span class="op" id="3658665">.</span><span class="ident" id="3658666">freeBlock</span><span class="op" id="3658675">(</span><span class="ident" id="3658676">b</span><span class="op" id="3658677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658682">goto</span>&nbsp;<span class="ident" id="3658687">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658695">case</span>&nbsp;<span class="ident" id="3658700">alertLevelError</span><span class="op" id="3658715">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658720">c</span><span class="op" id="3658721">.</span><span class="ident" id="3658722">in</span><span class="op" id="3658724">.</span><span class="ident" id="3658725">setErrorLocked</span><span class="op" id="3658739">(</span><span class="op" id="3658740">&amp;</span><span class="ident" id="3658741">net</span><span class="op" id="3658744">.</span><span class="ident" id="3658745">OpError</span><span class="op" id="3658752">{</span><span class="ident" id="3658753">Op</span><span class="op" id="3658755">:</span>&nbsp;<span class="string" id="3658757">&#34;remote&nbsp;error&#34;</span><span class="op" id="3658771">,</span>&nbsp;<span class="ident" id="3658773">Err</span><span class="op" id="3658776">:</span>&nbsp;<span class="ident" id="3658778">alert</span><span class="op" id="3658783">(</span><span class="ident" id="3658784">data</span><span class="op" id="3658788">[</span><span class="num" id="3658789">1</span><span class="op" id="3658790">]</span><span class="op" id="3658791">)</span><span class="op" id="3658792">}</span><span class="op" id="3658793">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658797">default</span><span class="op" id="3658804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658809">c</span><span class="op" id="3658810">.</span><span class="ident" id="3658811">in</span><span class="op" id="3658813">.</span><span class="ident" id="3658814">setErrorLocked</span><span class="op" id="3658828">(</span><span class="ident" id="3658829">c</span><span class="op" id="3658830">.</span><span class="ident" id="3658831">sendAlert</span><span class="op" id="3658840">(</span><span class="ident" id="3658841">alertUnexpectedMessage</span><span class="op" id="3658863">)</span><span class="op" id="3658864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3658868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658872">case</span>&nbsp;<span class="ident" id="3658877">recordTypeChangeCipherSpec</span><span class="op" id="3658903">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658907">if</span>&nbsp;<span class="ident" id="3658910">typ</span>&nbsp;<span class="op" id="3658914">!=</span>&nbsp;<span class="ident" id="3658917">want</span>&nbsp;<span class="op" id="3658922">||</span>&nbsp;<span class="builtinfunc" id="3658925">len</span><span class="op" id="3658928">(</span><span class="ident" id="3658929">data</span><span class="op" id="3658933">)</span>&nbsp;<span class="op" id="3658935">!=</span>&nbsp;<span class="num" id="3658938">1</span>&nbsp;<span class="op" id="3658940">||</span>&nbsp;<span class="ident" id="3658943">data</span><span class="op" id="3658947">[</span><span class="num" id="3658948">0</span><span class="op" id="3658949">]</span>&nbsp;<span class="op" id="3658951">!=</span>&nbsp;<span class="num" id="3658954">1</span>&nbsp;<span class="op" id="3658956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658961">c</span><span class="op" id="3658962">.</span><span class="ident" id="3658963">in</span><span class="op" id="3658965">.</span><span class="ident" id="3658966">setErrorLocked</span><span class="op" id="3658980">(</span><span class="ident" id="3658981">c</span><span class="op" id="3658982">.</span><span class="ident" id="3658983">sendAlert</span><span class="op" id="3658992">(</span><span class="ident" id="3658993">alertUnexpectedMessage</span><span class="op" id="3659015">)</span><span class="op" id="3659016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659021">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3659029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659033">err</span>&nbsp;<span class="op" id="3659037">:=</span>&nbsp;<span class="ident" id="3659040">c</span><span class="op" id="3659041">.</span><span class="ident" id="3659042">in</span><span class="op" id="3659044">.</span><span class="ident" id="3659045">changeCipherSpec</span><span class="op" id="3659061">(</span><span class="op" id="3659062">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659066">if</span>&nbsp;<span class="ident" id="3659069">err</span>&nbsp;<span class="op" id="3659073">!=</span>&nbsp;<span class="ident" id="3659076">nil</span>&nbsp;<span class="op" id="3659080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659085">c</span><span class="op" id="3659086">.</span><span class="ident" id="3659087">in</span><span class="op" id="3659089">.</span><span class="ident" id="3659090">setErrorLocked</span><span class="op" id="3659104">(</span><span class="ident" id="3659105">c</span><span class="op" id="3659106">.</span><span class="ident" id="3659107">sendAlert</span><span class="op" id="3659116">(</span><span class="ident" id="3659117">err</span><span class="op" id="3659120">.</span><span class="op" id="3659121">(</span><span class="ident" id="3659122">alert</span><span class="op" id="3659127">)</span><span class="op" id="3659128">)</span><span class="op" id="3659129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3659133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659137">case</span>&nbsp;<span class="ident" id="3659142">recordTypeApplicationData</span><span class="op" id="3659167">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659171">if</span>&nbsp;<span class="ident" id="3659174">typ</span>&nbsp;<span class="op" id="3659178">!=</span>&nbsp;<span class="ident" id="3659181">want</span>&nbsp;<span class="op" id="3659186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659191">c</span><span class="op" id="3659192">.</span><span class="ident" id="3659193">in</span><span class="op" id="3659195">.</span><span class="ident" id="3659196">setErrorLocked</span><span class="op" id="3659210">(</span><span class="ident" id="3659211">c</span><span class="op" id="3659212">.</span><span class="ident" id="3659213">sendAlert</span><span class="op" id="3659222">(</span><span class="ident" id="3659223">alertUnexpectedMessage</span><span class="op" id="3659245">)</span><span class="op" id="3659246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659251">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3659259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659263">c</span><span class="op" id="3659264">.</span><span class="ident" id="3659265">input</span>&nbsp;<span class="op" id="3659271">=</span>&nbsp;<span class="ident" id="3659273">b</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659277">b</span>&nbsp;<span class="op" id="3659279">=</span>&nbsp;<span class="ident" id="3659281">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659287">case</span>&nbsp;<span class="ident" id="3659292">recordTypeHandshake</span><span class="op" id="3659311">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3659315">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659374">if</span>&nbsp;<span class="ident" id="3659377">typ</span>&nbsp;<span class="op" id="3659381">!=</span>&nbsp;<span class="ident" id="3659384">want</span>&nbsp;<span class="op" id="3659389">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659394">return</span>&nbsp;<span class="ident" id="3659401">c</span><span class="op" id="3659402">.</span><span class="ident" id="3659403">in</span><span class="op" id="3659405">.</span><span class="ident" id="3659406">setErrorLocked</span><span class="op" id="3659420">(</span><span class="ident" id="3659421">c</span><span class="op" id="3659422">.</span><span class="ident" id="3659423">sendAlert</span><span class="op" id="3659432">(</span><span class="ident" id="3659433">alertNoRenegotiation</span><span class="op" id="3659453">)</span><span class="op" id="3659454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3659458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659462">c</span><span class="op" id="3659463">.</span><span class="ident" id="3659464">hand</span><span class="op" id="3659468">.</span><span class="ident" id="3659469">Write</span><span class="op" id="3659474">(</span><span class="ident" id="3659475">data</span><span class="op" id="3659479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3659482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659486">if</span>&nbsp;<span class="ident" id="3659489">b</span>&nbsp;<span class="op" id="3659491">!=</span>&nbsp;<span class="ident" id="3659494">nil</span>&nbsp;<span class="op" id="3659498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659502">c</span><span class="op" id="3659503">.</span><span class="ident" id="3659504">in</span><span class="op" id="3659506">.</span><span class="ident" id="3659507">freeBlock</span><span class="op" id="3659516">(</span><span class="ident" id="3659517">b</span><span class="op" id="3659518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3659521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659524">return</span>&nbsp;<span class="ident" id="3659531">c</span><span class="op" id="3659532">.</span><span class="ident" id="3659533">in</span><span class="op" id="3659535">.</span><span class="ident" id="3659536">err</span><br>
<span class="lineno"></span><span class="op" id="3659540">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="3659543">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="3659583">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3659604">func</span>&nbsp;<span class="op" id="3659609">(</span><span class="ident" id="3659610">c</span>&nbsp;<span class="op" id="3659612">*</span><span class="ident" id="3659613">Conn</span><span class="op" id="3659617">)</span>&nbsp;<span class="ident" id="3659619">sendAlertLocked</span><span class="op" id="3659634">(</span><span class="ident" id="3659635">err</span>&nbsp;<span class="ident" id="3659639">alert</span><span class="op" id="3659644">)</span>&nbsp;<span class="builtintype" id="3659646">error</span>&nbsp;<span class="op" id="3659652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659655">switch</span>&nbsp;<span class="ident" id="3659662">err</span>&nbsp;<span class="op" id="3659666">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659669">case</span>&nbsp;<span class="ident" id="3659674">alertNoRenegotiation</span><span class="op" id="3659694">,</span>&nbsp;<span class="ident" id="3659696">alertCloseNotify</span><span class="op" id="3659712">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659716">c</span><span class="op" id="3659717">.</span><span class="ident" id="3659718">tmp</span><span class="op" id="3659721">[</span><span class="num" id="3659722">0</span><span class="op" id="3659723">]</span>&nbsp;<span class="op" id="3659725">=</span>&nbsp;<span class="ident" id="3659727">alertLevelWarning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659746">default</span><span class="op" id="3659753">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659757">c</span><span class="op" id="3659758">.</span><span class="ident" id="3659759">tmp</span><span class="op" id="3659762">[</span><span class="num" id="3659763">0</span><span class="op" id="3659764">]</span>&nbsp;<span class="op" id="3659766">=</span>&nbsp;<span class="ident" id="3659768">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3659785">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659788">c</span><span class="op" id="3659789">.</span><span class="ident" id="3659790">tmp</span><span class="op" id="3659793">[</span><span class="num" id="3659794">1</span><span class="op" id="3659795">]</span>&nbsp;<span class="op" id="3659797">=</span>&nbsp;<span class="builtintype" id="3659799">byte</span><span class="op" id="3659803">(</span><span class="ident" id="3659804">err</span><span class="op" id="3659807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659810">c</span><span class="op" id="3659811">.</span><span class="ident" id="3659812">writeRecord</span><span class="op" id="3659823">(</span><span class="ident" id="3659824">recordTypeAlert</span><span class="op" id="3659839">,</span>&nbsp;<span class="ident" id="3659841">c</span><span class="op" id="3659842">.</span><span class="ident" id="3659843">tmp</span><span class="op" id="3659846">[</span><span class="num" id="3659847">0</span><span class="op" id="3659848">:</span><span class="num" id="3659849">2</span><span class="op" id="3659850">]</span><span class="op" id="3659851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3659854">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659915">if</span>&nbsp;<span class="ident" id="3659918">err</span>&nbsp;<span class="op" id="3659922">!=</span>&nbsp;<span class="ident" id="3659925">alertCloseNotify</span>&nbsp;<span class="op" id="3659942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659946">return</span>&nbsp;<span class="ident" id="3659953">c</span><span class="op" id="3659954">.</span><span class="ident" id="3659955">out</span><span class="op" id="3659958">.</span><span class="ident" id="3659959">setErrorLocked</span><span class="op" id="3659973">(</span><span class="op" id="3659974">&amp;</span><span class="ident" id="3659975">net</span><span class="op" id="3659978">.</span><span class="ident" id="3659979">OpError</span><span class="op" id="3659986">{</span><span class="ident" id="3659987">Op</span><span class="op" id="3659989">:</span>&nbsp;<span class="string" id="3659991">&#34;local&nbsp;error&#34;</span><span class="op" id="3660004">,</span>&nbsp;<span class="ident" id="3660006">Err</span><span class="op" id="3660009">:</span>&nbsp;<span class="ident" id="3660011">err</span><span class="op" id="3660014">}</span><span class="op" id="3660015">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3660018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660021">return</span>&nbsp;<span class="ident" id="3660028">nil</span><br>
<span class="lineno"></span><span class="op" id="3660032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3660035">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="3660075">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="3660095">func</span>&nbsp;<span class="op" id="3660100">(</span><span class="ident" id="3660101">c</span>&nbsp;<span class="op" id="3660103">*</span><span class="ident" id="3660104">Conn</span><span class="op" id="3660108">)</span>&nbsp;<span class="ident" id="3660110">sendAlert</span><span class="op" id="3660119">(</span><span class="ident" id="3660120">err</span>&nbsp;<span class="ident" id="3660124">alert</span><span class="op" id="3660129">)</span>&nbsp;<span class="builtintype" id="3660131">error</span>&nbsp;<span class="op" id="3660137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3660140">c</span><span class="op" id="3660141">.</span><span class="ident" id="3660142">out</span><span class="op" id="3660145">.</span><span class="ident" id="3660146">Lock</span><span class="op" id="3660150">(</span><span class="op" id="3660151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660154">defer</span>&nbsp;<span class="ident" id="3660160">c</span><span class="op" id="3660161">.</span><span class="ident" id="3660162">out</span><span class="op" id="3660165">.</span><span class="ident" id="3660166">Unlock</span><span class="op" id="3660172">(</span><span class="op" id="3660173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660176">return</span>&nbsp;<span class="ident" id="3660183">c</span><span class="op" id="3660184">.</span><span class="ident" id="3660185">sendAlertLocked</span><span class="op" id="3660200">(</span><span class="ident" id="3660201">err</span><span class="op" id="3660204">)</span><br>
<span class="lineno">690</span><span class="op" id="3660206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3660209">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="3660276">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3660333">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="3660354">func</span>&nbsp;<span class="op" id="3660359">(</span><span class="ident" id="3660360">c</span>&nbsp;<span class="op" id="3660362">*</span><span class="ident" id="3660363">Conn</span><span class="op" id="3660367">)</span>&nbsp;<span class="ident" id="3660369">writeRecord</span><span class="op" id="3660380">(</span><span class="ident" id="3660381">typ</span>&nbsp;<span class="ident" id="3660385">recordType</span><span class="op" id="3660395">,</span>&nbsp;<span class="ident" id="3660397">data</span>&nbsp;<span class="op" id="3660402">[</span><span class="op" id="3660403">]</span><span class="builtintype" id="3660404">byte</span><span class="op" id="3660408">)</span>&nbsp;<span class="op" id="3660410">(</span><span class="ident" id="3660411">n</span>&nbsp;<span class="builtintype" id="3660413">int</span><span class="op" id="3660416">,</span>&nbsp;<span class="ident" id="3660418">err</span>&nbsp;<span class="builtintype" id="3660422">error</span><span class="op" id="3660427">)</span>&nbsp;<span class="op" id="3660429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3660432">b</span>&nbsp;<span class="op" id="3660434">:=</span>&nbsp;<span class="ident" id="3660437">c</span><span class="op" id="3660438">.</span><span class="ident" id="3660439">out</span><span class="op" id="3660442">.</span><span class="ident" id="3660443">newBlock</span><span class="op" id="3660451">(</span><span class="op" id="3660452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660455">for</span>&nbsp;<span class="builtinfunc" id="3660459">len</span><span class="op" id="3660462">(</span><span class="ident" id="3660463">data</span><span class="op" id="3660467">)</span>&nbsp;<span class="op" id="3660469">&gt;</span>&nbsp;<span class="num" id="3660471">0</span>&nbsp;<span class="op" id="3660473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3660477">m</span>&nbsp;<span class="op" id="3660479">:=</span>&nbsp;<span class="builtinfunc" id="3660482">len</span><span class="op" id="3660485">(</span><span class="ident" id="3660486">data</span><span class="op" id="3660490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660494">if</span>&nbsp;<span class="ident" id="3660497">m</span>&nbsp;<span class="op" id="3660499">&gt;</span>&nbsp;<span class="ident" id="3660501">maxPlaintext</span>&nbsp;<span class="op" id="3660514">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3660519">m</span>&nbsp;<span class="op" id="3660521">=</span>&nbsp;<span class="ident" id="3660523">maxPlaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3660538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3660542">explicitIVLen</span>&nbsp;<span class="op" id="3660556">:=</span>&nbsp;<span class="num" id="3660559">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3660563">explicitIVIsSeq</span>&nbsp;<span class="op" id="3660579">:=</span>&nbsp;<span class="builtintype" id="3660582">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660591">var</span>&nbsp;<span class="ident" id="3660595">cbc</span>&nbsp;<span class="ident" id="3660599">cbcMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660609">if</span>&nbsp;<span class="ident" id="3660612">c</span><span class="op" id="3660613">.</span><span class="ident" id="3660614">out</span><span class="op" id="3660617">.</span><span class="ident" id="3660618">version</span>&nbsp;<span class="op" id="3660626">&gt;=</span>&nbsp;<span class="ident" id="3660629">VersionTLS11</span>&nbsp;<span class="op" id="3660642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660647">var</span>&nbsp;<span class="ident" id="3660651">ok</span>&nbsp;<span class="builtintype" id="3660654">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660662">if</span>&nbsp;<span class="ident" id="3660665">cbc</span><span class="op" id="3660668">,</span>&nbsp;<span class="ident" id="3660670">ok</span>&nbsp;<span class="op" id="3660673">=</span>&nbsp;<span class="ident" id="3660675">c</span><span class="op" id="3660676">.</span><span class="ident" id="3660677">out</span><span class="op" id="3660680">.</span><span class="ident" id="3660681">cipher</span><span class="op" id="3660687">.</span><span class="op" id="3660688">(</span><span class="ident" id="3660689">cbcMode</span><span class="op" id="3660696">)</span><span class="op" id="3660697">;</span>&nbsp;<span class="ident" id="3660699">ok</span>&nbsp;<span class="op" id="3660702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3660708">explicitIVLen</span>&nbsp;<span class="op" id="3660722">=</span>&nbsp;<span class="ident" id="3660724">cbc</span><span class="op" id="3660727">.</span><span class="ident" id="3660728">BlockSize</span><span class="op" id="3660737">(</span><span class="op" id="3660738">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3660743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3660747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660751">if</span>&nbsp;<span class="ident" id="3660754">explicitIVLen</span>&nbsp;<span class="op" id="3660768">==</span>&nbsp;<span class="num" id="3660771">0</span>&nbsp;<span class="op" id="3660773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660778">if</span>&nbsp;<span class="ident" id="3660781">_</span><span class="op" id="3660782">,</span>&nbsp;<span class="ident" id="3660784">ok</span>&nbsp;<span class="op" id="3660787">:=</span>&nbsp;<span class="ident" id="3660790">c</span><span class="op" id="3660791">.</span><span class="ident" id="3660792">out</span><span class="op" id="3660795">.</span><span class="ident" id="3660796">cipher</span><span class="op" id="3660802">.</span><span class="op" id="3660803">(</span><span class="ident" id="3660804">cipher</span><span class="op" id="3660810">.</span><span class="ident" id="3660811">AEAD</span><span class="op" id="3660815">)</span><span class="op" id="3660816">;</span>&nbsp;<span class="ident" id="3660818">ok</span>&nbsp;<span class="op" id="3660821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3660827">explicitIVLen</span>&nbsp;<span class="op" id="3660841">=</span>&nbsp;<span class="num" id="3660843">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3660849">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3660895">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3660942">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3660992">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3661039">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3661090">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661111">explicitIVIsSeq</span>&nbsp;<span class="op" id="3661127">=</span>&nbsp;<span class="builtintype" id="3661129">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661145">b</span><span class="op" id="3661146">.</span><span class="ident" id="3661147">resize</span><span class="op" id="3661153">(</span><span class="ident" id="3661154">recordHeaderLen</span>&nbsp;<span class="op" id="3661170">+</span>&nbsp;<span class="ident" id="3661172">explicitIVLen</span>&nbsp;<span class="op" id="3661186">+</span>&nbsp;<span class="ident" id="3661188">m</span><span class="op" id="3661189">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661193">b</span><span class="op" id="3661194">.</span><span class="ident" id="3661195">data</span><span class="op" id="3661199">[</span><span class="num" id="3661200">0</span><span class="op" id="3661201">]</span>&nbsp;<span class="op" id="3661203">=</span>&nbsp;<span class="builtintype" id="3661205">byte</span><span class="op" id="3661209">(</span><span class="ident" id="3661210">typ</span><span class="op" id="3661213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661217">vers</span>&nbsp;<span class="op" id="3661222">:=</span>&nbsp;<span class="ident" id="3661225">c</span><span class="op" id="3661226">.</span><span class="ident" id="3661227">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661234">if</span>&nbsp;<span class="ident" id="3661237">vers</span>&nbsp;<span class="op" id="3661242">==</span>&nbsp;<span class="num" id="3661245">0</span>&nbsp;<span class="op" id="3661247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3661252">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3661305">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661361">vers</span>&nbsp;<span class="op" id="3661366">=</span>&nbsp;<span class="ident" id="3661368">VersionTLS10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661387">b</span><span class="op" id="3661388">.</span><span class="ident" id="3661389">data</span><span class="op" id="3661393">[</span><span class="num" id="3661394">1</span><span class="op" id="3661395">]</span>&nbsp;<span class="op" id="3661397">=</span>&nbsp;<span class="builtintype" id="3661399">byte</span><span class="op" id="3661403">(</span><span class="ident" id="3661404">vers</span>&nbsp;<span class="op" id="3661409">&gt;&gt;</span>&nbsp;<span class="num" id="3661412">8</span><span class="op" id="3661413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661417">b</span><span class="op" id="3661418">.</span><span class="ident" id="3661419">data</span><span class="op" id="3661423">[</span><span class="num" id="3661424">2</span><span class="op" id="3661425">]</span>&nbsp;<span class="op" id="3661427">=</span>&nbsp;<span class="builtintype" id="3661429">byte</span><span class="op" id="3661433">(</span><span class="ident" id="3661434">vers</span><span class="op" id="3661438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661442">b</span><span class="op" id="3661443">.</span><span class="ident" id="3661444">data</span><span class="op" id="3661448">[</span><span class="num" id="3661449">3</span><span class="op" id="3661450">]</span>&nbsp;<span class="op" id="3661452">=</span>&nbsp;<span class="builtintype" id="3661454">byte</span><span class="op" id="3661458">(</span><span class="ident" id="3661459">m</span>&nbsp;<span class="op" id="3661461">&gt;&gt;</span>&nbsp;<span class="num" id="3661464">8</span><span class="op" id="3661465">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661469">b</span><span class="op" id="3661470">.</span><span class="ident" id="3661471">data</span><span class="op" id="3661475">[</span><span class="num" id="3661476">4</span><span class="op" id="3661477">]</span>&nbsp;<span class="op" id="3661479">=</span>&nbsp;<span class="builtintype" id="3661481">byte</span><span class="op" id="3661485">(</span><span class="ident" id="3661486">m</span><span class="op" id="3661487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661491">if</span>&nbsp;<span class="ident" id="3661494">explicitIVLen</span>&nbsp;<span class="op" id="3661508">&gt;</span>&nbsp;<span class="num" id="3661510">0</span>&nbsp;<span class="op" id="3661512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661517">explicitIV</span>&nbsp;<span class="op" id="3661528">:=</span>&nbsp;<span class="ident" id="3661531">b</span><span class="op" id="3661532">.</span><span class="ident" id="3661533">data</span><span class="op" id="3661537">[</span><span class="ident" id="3661538">recordHeaderLen</span>&nbsp;<span class="op" id="3661554">:</span>&nbsp;<span class="ident" id="3661556">recordHeaderLen</span><span class="op" id="3661571">+</span><span class="ident" id="3661572">explicitIVLen</span><span class="op" id="3661585">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661590">if</span>&nbsp;<span class="ident" id="3661593">explicitIVIsSeq</span>&nbsp;<span class="op" id="3661609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3661615">copy</span><span class="op" id="3661619">(</span><span class="ident" id="3661620">explicitIV</span><span class="op" id="3661630">,</span>&nbsp;<span class="ident" id="3661632">c</span><span class="op" id="3661633">.</span><span class="ident" id="3661634">out</span><span class="op" id="3661637">.</span><span class="ident" id="3661638">seq</span><span class="op" id="3661641">[</span><span class="op" id="3661642">:</span><span class="op" id="3661643">]</span><span class="op" id="3661644">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661649">}</span>&nbsp;<span class="keyword" id="3661651">else</span>&nbsp;<span class="op" id="3661656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661662">if</span>&nbsp;<span class="ident" id="3661665">_</span><span class="op" id="3661666">,</span>&nbsp;<span class="ident" id="3661668">err</span>&nbsp;<span class="op" id="3661672">=</span>&nbsp;<span class="ident" id="3661674">io</span><span class="op" id="3661676">.</span><span class="ident" id="3661677">ReadFull</span><span class="op" id="3661685">(</span><span class="ident" id="3661686">c</span><span class="op" id="3661687">.</span><span class="ident" id="3661688">config</span><span class="op" id="3661694">.</span><span class="ident" id="3661695">rand</span><span class="op" id="3661699">(</span><span class="op" id="3661700">)</span><span class="op" id="3661701">,</span>&nbsp;<span class="ident" id="3661703">explicitIV</span><span class="op" id="3661713">)</span><span class="op" id="3661714">;</span>&nbsp;<span class="ident" id="3661716">err</span>&nbsp;<span class="op" id="3661720">!=</span>&nbsp;<span class="ident" id="3661723">nil</span>&nbsp;<span class="op" id="3661727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661734">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661749">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3661757">copy</span><span class="op" id="3661761">(</span><span class="ident" id="3661762">b</span><span class="op" id="3661763">.</span><span class="ident" id="3661764">data</span><span class="op" id="3661768">[</span><span class="ident" id="3661769">recordHeaderLen</span><span class="op" id="3661784">+</span><span class="ident" id="3661785">explicitIVLen</span><span class="op" id="3661798">:</span><span class="op" id="3661799">]</span><span class="op" id="3661800">,</span>&nbsp;<span class="ident" id="3661802">data</span><span class="op" id="3661806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661810">c</span><span class="op" id="3661811">.</span><span class="ident" id="3661812">out</span><span class="op" id="3661815">.</span><span class="ident" id="3661816">encrypt</span><span class="op" id="3661823">(</span><span class="ident" id="3661824">b</span><span class="op" id="3661825">,</span>&nbsp;<span class="ident" id="3661827">explicitIVLen</span><span class="op" id="3661840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661844">_</span><span class="op" id="3661845">,</span>&nbsp;<span class="ident" id="3661847">err</span>&nbsp;<span class="op" id="3661851">=</span>&nbsp;<span class="ident" id="3661853">c</span><span class="op" id="3661854">.</span><span class="ident" id="3661855">conn</span><span class="op" id="3661859">.</span><span class="ident" id="3661860">Write</span><span class="op" id="3661865">(</span><span class="ident" id="3661866">b</span><span class="op" id="3661867">.</span><span class="ident" id="3661868">data</span><span class="op" id="3661872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661876">if</span>&nbsp;<span class="ident" id="3661879">err</span>&nbsp;<span class="op" id="3661883">!=</span>&nbsp;<span class="ident" id="3661886">nil</span>&nbsp;<span class="op" id="3661890">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661895">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661907">n</span>&nbsp;<span class="op" id="3661909">+=</span>&nbsp;<span class="ident" id="3661912">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661916">data</span>&nbsp;<span class="op" id="3661921">=</span>&nbsp;<span class="ident" id="3661923">data</span><span class="op" id="3661927">[</span><span class="ident" id="3661928">m</span><span class="op" id="3661929">:</span><span class="op" id="3661930">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661933">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661936">c</span><span class="op" id="3661937">.</span><span class="ident" id="3661938">out</span><span class="op" id="3661941">.</span><span class="ident" id="3661942">freeBlock</span><span class="op" id="3661951">(</span><span class="ident" id="3661952">b</span><span class="op" id="3661953">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661957">if</span>&nbsp;<span class="ident" id="3661960">typ</span>&nbsp;<span class="op" id="3661964">==</span>&nbsp;<span class="ident" id="3661967">recordTypeChangeCipherSpec</span>&nbsp;<span class="op" id="3661994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661998">err</span>&nbsp;<span class="op" id="3662002">=</span>&nbsp;<span class="ident" id="3662004">c</span><span class="op" id="3662005">.</span><span class="ident" id="3662006">out</span><span class="op" id="3662009">.</span><span class="ident" id="3662010">changeCipherSpec</span><span class="op" id="3662026">(</span><span class="op" id="3662027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662031">if</span>&nbsp;<span class="ident" id="3662034">err</span>&nbsp;<span class="op" id="3662038">!=</span>&nbsp;<span class="ident" id="3662041">nil</span>&nbsp;<span class="op" id="3662045">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3662050">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3662088">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3662131">c</span><span class="op" id="3662132">.</span><span class="ident" id="3662133">tmp</span><span class="op" id="3662136">[</span><span class="num" id="3662137">0</span><span class="op" id="3662138">]</span>&nbsp;<span class="op" id="3662140">=</span>&nbsp;<span class="ident" id="3662142">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3662161">c</span><span class="op" id="3662162">.</span><span class="ident" id="3662163">tmp</span><span class="op" id="3662166">[</span><span class="num" id="3662167">1</span><span class="op" id="3662168">]</span>&nbsp;<span class="op" id="3662170">=</span>&nbsp;<span class="builtintype" id="3662172">byte</span><span class="op" id="3662176">(</span><span class="ident" id="3662177">err</span><span class="op" id="3662180">.</span><span class="op" id="3662181">(</span><span class="ident" id="3662182">alert</span><span class="op" id="3662187">)</span><span class="op" id="3662188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3662193">c</span><span class="op" id="3662194">.</span><span class="ident" id="3662195">writeRecord</span><span class="op" id="3662206">(</span><span class="ident" id="3662207">recordTypeAlert</span><span class="op" id="3662222">,</span>&nbsp;<span class="ident" id="3662224">c</span><span class="op" id="3662225">.</span><span class="ident" id="3662226">tmp</span><span class="op" id="3662229">[</span><span class="num" id="3662230">0</span><span class="op" id="3662231">:</span><span class="num" id="3662232">2</span><span class="op" id="3662233">]</span><span class="op" id="3662234">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662239">return</span>&nbsp;<span class="ident" id="3662246">n</span><span class="op" id="3662247">,</span>&nbsp;<span class="ident" id="3662249">c</span><span class="op" id="3662250">.</span><span class="ident" id="3662251">out</span><span class="op" id="3662254">.</span><span class="ident" id="3662255">setErrorLocked</span><span class="op" id="3662269">(</span><span class="op" id="3662270">&amp;</span><span class="ident" id="3662271">net</span><span class="op" id="3662274">.</span><span class="ident" id="3662275">OpError</span><span class="op" id="3662282">{</span><span class="ident" id="3662283">Op</span><span class="op" id="3662285">:</span>&nbsp;<span class="string" id="3662287">&#34;local&nbsp;error&#34;</span><span class="op" id="3662300">,</span>&nbsp;<span class="ident" id="3662302">Err</span><span class="op" id="3662305">:</span>&nbsp;<span class="ident" id="3662307">err</span><span class="op" id="3662310">}</span><span class="op" id="3662311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3662315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3662318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662321">return</span><br>
<span class="lineno"></span><span class="op" id="3662328">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="3662331">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3662386">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="3662407">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3662443">func</span>&nbsp;<span class="op" id="3662448">(</span><span class="ident" id="3662449">c</span>&nbsp;<span class="op" id="3662451">*</span><span class="ident" id="3662452">Conn</span><span class="op" id="3662456">)</span>&nbsp;<span class="ident" id="3662458">readHandshake</span><span class="op" id="3662471">(</span><span class="op" id="3662472">)</span>&nbsp;<span class="op" id="3662474">(</span><span class="keyword" id="3662475">interface</span><span class="op" id="3662484">{</span><span class="op" id="3662485">}</span><span class="op" id="3662486">,</span>&nbsp;<span class="builtintype" id="3662488">error</span><span class="op" id="3662493">)</span>&nbsp;<span class="op" id="3662495">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662498">for</span>&nbsp;<span class="ident" id="3662502">c</span><span class="op" id="3662503">.</span><span class="ident" id="3662504">hand</span><span class="op" id="3662508">.</span><span class="ident" id="3662509">Len</span><span class="op" id="3662512">(</span><span class="op" id="3662513">)</span>&nbsp;<span class="op" id="3662515">&lt;</span>&nbsp;<span class="num" id="3662517">4</span>&nbsp;<span class="op" id="3662519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662523">if</span>&nbsp;<span class="ident" id="3662526">err</span>&nbsp;<span class="op" id="3662530">:=</span>&nbsp;<span class="ident" id="3662533">c</span><span class="op" id="3662534">.</span><span class="ident" id="3662535">in</span><span class="op" id="3662537">.</span><span class="ident" id="3662538">err</span><span class="op" id="3662541">;</span>&nbsp;<span class="ident" id="3662543">err</span>&nbsp;<span class="op" id="3662547">!=</span>&nbsp;<span class="ident" id="3662550">nil</span>&nbsp;<span class="op" id="3662554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662559">return</span>&nbsp;<span class="ident" id="3662566">nil</span><span class="op" id="3662569">,</span>&nbsp;<span class="ident" id="3662571">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3662577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662581">if</span>&nbsp;<span class="ident" id="3662584">err</span>&nbsp;<span class="op" id="3662588">:=</span>&nbsp;<span class="ident" id="3662591">c</span><span class="op" id="3662592">.</span><span class="ident" id="3662593">readRecord</span><span class="op" id="3662603">(</span><span class="ident" id="3662604">recordTypeHandshake</span><span class="op" id="3662623">)</span><span class="op" id="3662624">;</span>&nbsp;<span class="ident" id="3662626">err</span>&nbsp;<span class="op" id="3662630">!=</span>&nbsp;<span class="ident" id="3662633">nil</span>&nbsp;<span class="op" id="3662637">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662642">return</span>&nbsp;<span class="ident" id="3662649">nil</span><span class="op" id="3662652">,</span>&nbsp;<span class="ident" id="3662654">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3662660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3662663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3662667">data</span>&nbsp;<span class="op" id="3662672">:=</span>&nbsp;<span class="ident" id="3662675">c</span><span class="op" id="3662676">.</span><span class="ident" id="3662677">hand</span><span class="op" id="3662681">.</span><span class="ident" id="3662682">Bytes</span><span class="op" id="3662687">(</span><span class="op" id="3662688">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3662691">n</span>&nbsp;<span class="op" id="3662693">:=</span>&nbsp;<span class="builtintype" id="3662696">int</span><span class="op" id="3662699">(</span><span class="ident" id="3662700">data</span><span class="op" id="3662704">[</span><span class="num" id="3662705">1</span><span class="op" id="3662706">]</span><span class="op" id="3662707">)</span><span class="op" id="3662708">&lt;&lt;</span><span class="num" id="3662710">16</span>&nbsp;<span class="op" id="3662713">|</span>&nbsp;<span class="builtintype" id="3662715">int</span><span class="op" id="3662718">(</span><span class="ident" id="3662719">data</span><span class="op" id="3662723">[</span><span class="num" id="3662724">2</span><span class="op" id="3662725">]</span><span class="op" id="3662726">)</span><span class="op" id="3662727">&lt;&lt;</span><span class="num" id="3662729">8</span>&nbsp;<span class="op" id="3662731">|</span>&nbsp;<span class="builtintype" id="3662733">int</span><span class="op" id="3662736">(</span><span class="ident" id="3662737">data</span><span class="op" id="3662741">[</span><span class="num" id="3662742">3</span><span class="op" id="3662743">]</span><span class="op" id="3662744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662747">if</span>&nbsp;<span class="ident" id="3662750">n</span>&nbsp;<span class="op" id="3662752">&gt;</span>&nbsp;<span class="ident" id="3662754">maxHandshake</span>&nbsp;<span class="op" id="3662767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662771">return</span>&nbsp;<span class="ident" id="3662778">nil</span><span class="op" id="3662781">,</span>&nbsp;<span class="ident" id="3662783">c</span><span class="op" id="3662784">.</span><span class="ident" id="3662785">in</span><span class="op" id="3662787">.</span><span class="ident" id="3662788">setErrorLocked</span><span class="op" id="3662802">(</span><span class="ident" id="3662803">c</span><span class="op" id="3662804">.</span><span class="ident" id="3662805">sendAlert</span><span class="op" id="3662814">(</span><span class="ident" id="3662815">alertInternalError</span><span class="op" id="3662833">)</span><span class="op" id="3662834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3662837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662840">for</span>&nbsp;<span class="ident" id="3662844">c</span><span class="op" id="3662845">.</span><span class="ident" id="3662846">hand</span><span class="op" id="3662850">.</span><span class="ident" id="3662851">Len</span><span class="op" id="3662854">(</span><span class="op" id="3662855">)</span>&nbsp;<span class="op" id="3662857">&lt;</span>&nbsp;<span class="num" id="3662859">4</span><span class="op" id="3662860">+</span><span class="ident" id="3662861">n</span>&nbsp;<span class="op" id="3662863">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662867">if</span>&nbsp;<span class="ident" id="3662870">err</span>&nbsp;<span class="op" id="3662874">:=</span>&nbsp;<span class="ident" id="3662877">c</span><span class="op" id="3662878">.</span><span class="ident" id="3662879">in</span><span class="op" id="3662881">.</span><span class="ident" id="3662882">err</span><span class="op" id="3662885">;</span>&nbsp;<span class="ident" id="3662887">err</span>&nbsp;<span class="op" id="3662891">!=</span>&nbsp;<span class="ident" id="3662894">nil</span>&nbsp;<span class="op" id="3662898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662903">return</span>&nbsp;<span class="ident" id="3662910">nil</span><span class="op" id="3662913">,</span>&nbsp;<span class="ident" id="3662915">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3662921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662925">if</span>&nbsp;<span class="ident" id="3662928">err</span>&nbsp;<span class="op" id="3662932">:=</span>&nbsp;<span class="ident" id="3662935">c</span><span class="op" id="3662936">.</span><span class="ident" id="3662937">readRecord</span><span class="op" id="3662947">(</span><span class="ident" id="3662948">recordTypeHandshake</span><span class="op" id="3662967">)</span><span class="op" id="3662968">;</span>&nbsp;<span class="ident" id="3662970">err</span>&nbsp;<span class="op" id="3662974">!=</span>&nbsp;<span class="ident" id="3662977">nil</span>&nbsp;<span class="op" id="3662981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662986">return</span>&nbsp;<span class="ident" id="3662993">nil</span><span class="op" id="3662996">,</span>&nbsp;<span class="ident" id="3662998">err</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3663004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3663007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663010">data</span>&nbsp;<span class="op" id="3663015">=</span>&nbsp;<span class="ident" id="3663017">c</span><span class="op" id="3663018">.</span><span class="ident" id="3663019">hand</span><span class="op" id="3663023">.</span><span class="ident" id="3663024">Next</span><span class="op" id="3663028">(</span><span class="num" id="3663029">4</span>&nbsp;<span class="op" id="3663031">+</span>&nbsp;<span class="ident" id="3663033">n</span><span class="op" id="3663034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663037">var</span>&nbsp;<span class="ident" id="3663041">m</span>&nbsp;<span class="ident" id="3663043">handshakeMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663061">switch</span>&nbsp;<span class="ident" id="3663068">data</span><span class="op" id="3663072">[</span><span class="num" id="3663073">0</span><span class="op" id="3663074">]</span>&nbsp;<span class="op" id="3663076">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663079">case</span>&nbsp;<span class="ident" id="3663084">typeClientHello</span><span class="op" id="3663099">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663103">m</span>&nbsp;<span class="op" id="3663105">=</span>&nbsp;<span class="builtinfunc" id="3663107">new</span><span class="op" id="3663110">(</span><span class="ident" id="3663111">clientHelloMsg</span><span class="op" id="3663125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663128">case</span>&nbsp;<span class="ident" id="3663133">typeServerHello</span><span class="op" id="3663148">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663152">m</span>&nbsp;<span class="op" id="3663154">=</span>&nbsp;<span class="builtinfunc" id="3663156">new</span><span class="op" id="3663159">(</span><span class="ident" id="3663160">serverHelloMsg</span><span class="op" id="3663174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663177">case</span>&nbsp;<span class="ident" id="3663182">typeNewSessionTicket</span><span class="op" id="3663202">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663206">m</span>&nbsp;<span class="op" id="3663208">=</span>&nbsp;<span class="builtinfunc" id="3663210">new</span><span class="op" id="3663213">(</span><span class="ident" id="3663214">newSessionTicketMsg</span><span class="op" id="3663233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663236">case</span>&nbsp;<span class="ident" id="3663241">typeCertificate</span><span class="op" id="3663256">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663260">m</span>&nbsp;<span class="op" id="3663262">=</span>&nbsp;<span class="builtinfunc" id="3663264">new</span><span class="op" id="3663267">(</span><span class="ident" id="3663268">certificateMsg</span><span class="op" id="3663282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663285">case</span>&nbsp;<span class="ident" id="3663290">typeCertificateRequest</span><span class="op" id="3663312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663316">m</span>&nbsp;<span class="op" id="3663318">=</span>&nbsp;<span class="op" id="3663320">&amp;</span><span class="ident" id="3663321">certificateRequestMsg</span><span class="op" id="3663342">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663347">hasSignatureAndHash</span><span class="op" id="3663366">:</span>&nbsp;<span class="ident" id="3663368">c</span><span class="op" id="3663369">.</span><span class="ident" id="3663370">vers</span>&nbsp;<span class="op" id="3663375">&gt;=</span>&nbsp;<span class="ident" id="3663378">VersionTLS12</span><span class="op" id="3663390">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3663394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663397">case</span>&nbsp;<span class="ident" id="3663402">typeCertificateStatus</span><span class="op" id="3663423">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663427">m</span>&nbsp;<span class="op" id="3663429">=</span>&nbsp;<span class="builtinfunc" id="3663431">new</span><span class="op" id="3663434">(</span><span class="ident" id="3663435">certificateStatusMsg</span><span class="op" id="3663455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663458">case</span>&nbsp;<span class="ident" id="3663463">typeServerKeyExchange</span><span class="op" id="3663484">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663488">m</span>&nbsp;<span class="op" id="3663490">=</span>&nbsp;<span class="builtinfunc" id="3663492">new</span><span class="op" id="3663495">(</span><span class="ident" id="3663496">serverKeyExchangeMsg</span><span class="op" id="3663516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663519">case</span>&nbsp;<span class="ident" id="3663524">typeServerHelloDone</span><span class="op" id="3663543">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663547">m</span>&nbsp;<span class="op" id="3663549">=</span>&nbsp;<span class="builtinfunc" id="3663551">new</span><span class="op" id="3663554">(</span><span class="ident" id="3663555">serverHelloDoneMsg</span><span class="op" id="3663573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663576">case</span>&nbsp;<span class="ident" id="3663581">typeClientKeyExchange</span><span class="op" id="3663602">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663606">m</span>&nbsp;<span class="op" id="3663608">=</span>&nbsp;<span class="builtinfunc" id="3663610">new</span><span class="op" id="3663613">(</span><span class="ident" id="3663614">clientKeyExchangeMsg</span><span class="op" id="3663634">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663637">case</span>&nbsp;<span class="ident" id="3663642">typeCertificateVerify</span><span class="op" id="3663663">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663667">m</span>&nbsp;<span class="op" id="3663669">=</span>&nbsp;<span class="op" id="3663671">&amp;</span><span class="ident" id="3663672">certificateVerifyMsg</span><span class="op" id="3663692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663697">hasSignatureAndHash</span><span class="op" id="3663716">:</span>&nbsp;<span class="ident" id="3663718">c</span><span class="op" id="3663719">.</span><span class="ident" id="3663720">vers</span>&nbsp;<span class="op" id="3663725">&gt;=</span>&nbsp;<span class="ident" id="3663728">VersionTLS12</span><span class="op" id="3663740">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3663744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663747">case</span>&nbsp;<span class="ident" id="3663752">typeNextProtocol</span><span class="op" id="3663768">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663772">m</span>&nbsp;<span class="op" id="3663774">=</span>&nbsp;<span class="builtinfunc" id="3663776">new</span><span class="op" id="3663779">(</span><span class="ident" id="3663780">nextProtoMsg</span><span class="op" id="3663792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663795">case</span>&nbsp;<span class="ident" id="3663800">typeFinished</span><span class="op" id="3663812">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663816">m</span>&nbsp;<span class="op" id="3663818">=</span>&nbsp;<span class="builtinfunc" id="3663820">new</span><span class="op" id="3663823">(</span><span class="ident" id="3663824">finishedMsg</span><span class="op" id="3663835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663838">default</span><span class="op" id="3663845">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3663849">return</span>&nbsp;<span class="ident" id="3663856">nil</span><span class="op" id="3663859">,</span>&nbsp;<span class="ident" id="3663861">c</span><span class="op" id="3663862">.</span><span class="ident" id="3663863">in</span><span class="op" id="3663865">.</span><span class="ident" id="3663866">setErrorLocked</span><span class="op" id="3663880">(</span><span class="ident" id="3663881">c</span><span class="op" id="3663882">.</span><span class="ident" id="3663883">sendAlert</span><span class="op" id="3663892">(</span><span class="ident" id="3663893">alertUnexpectedMessage</span><span class="op" id="3663915">)</span><span class="op" id="3663916">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3663919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3663923">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3663963">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664013">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664068">data</span>&nbsp;<span class="op" id="3664073">=</span>&nbsp;<span class="builtinfunc" id="3664075">append</span><span class="op" id="3664081">(</span><span class="op" id="3664082">[</span><span class="op" id="3664083">]</span><span class="builtintype" id="3664084">byte</span><span class="op" id="3664088">(</span><span class="ident" id="3664089">nil</span><span class="op" id="3664092">)</span><span class="op" id="3664093">,</span>&nbsp;<span class="ident" id="3664095">data</span><span class="op" id="3664099">...</span><span class="op" id="3664102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664106">if</span>&nbsp;<span class="op" id="3664109">!</span><span class="ident" id="3664110">m</span><span class="op" id="3664111">.</span><span class="ident" id="3664112">unmarshal</span><span class="op" id="3664121">(</span><span class="ident" id="3664122">data</span><span class="op" id="3664126">)</span>&nbsp;<span class="op" id="3664128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664132">return</span>&nbsp;<span class="ident" id="3664139">nil</span><span class="op" id="3664142">,</span>&nbsp;<span class="ident" id="3664144">c</span><span class="op" id="3664145">.</span><span class="ident" id="3664146">in</span><span class="op" id="3664148">.</span><span class="ident" id="3664149">setErrorLocked</span><span class="op" id="3664163">(</span><span class="ident" id="3664164">c</span><span class="op" id="3664165">.</span><span class="ident" id="3664166">sendAlert</span><span class="op" id="3664175">(</span><span class="ident" id="3664176">alertUnexpectedMessage</span><span class="op" id="3664198">)</span><span class="op" id="3664199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3664202">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664205">return</span>&nbsp;<span class="ident" id="3664212">m</span><span class="op" id="3664213">,</span>&nbsp;<span class="ident" id="3664215">nil</span><br>
<span class="lineno"></span><span class="op" id="3664219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3664222">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3664262">func</span>&nbsp;<span class="op" id="3664267">(</span><span class="ident" id="3664268">c</span>&nbsp;<span class="op" id="3664270">*</span><span class="ident" id="3664271">Conn</span><span class="op" id="3664275">)</span>&nbsp;<span class="ident" id="3664277">Write</span><span class="op" id="3664282">(</span><span class="ident" id="3664283">b</span>&nbsp;<span class="op" id="3664285">[</span><span class="op" id="3664286">]</span><span class="builtintype" id="3664287">byte</span><span class="op" id="3664291">)</span>&nbsp;<span class="op" id="3664293">(</span><span class="builtintype" id="3664294">int</span><span class="op" id="3664297">,</span>&nbsp;<span class="builtintype" id="3664299">error</span><span class="op" id="3664304">)</span>&nbsp;<span class="op" id="3664306">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664309">if</span>&nbsp;<span class="ident" id="3664312">err</span>&nbsp;<span class="op" id="3664316">:=</span>&nbsp;<span class="ident" id="3664319">c</span><span class="op" id="3664320">.</span><span class="ident" id="3664321">Handshake</span><span class="op" id="3664330">(</span><span class="op" id="3664331">)</span><span class="op" id="3664332">;</span>&nbsp;<span class="ident" id="3664334">err</span>&nbsp;<span class="op" id="3664338">!=</span>&nbsp;<span class="ident" id="3664341">nil</span>&nbsp;<span class="op" id="3664345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664349">return</span>&nbsp;<span class="num" id="3664356">0</span><span class="op" id="3664357">,</span>&nbsp;<span class="ident" id="3664359">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3664364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664368">c</span><span class="op" id="3664369">.</span><span class="ident" id="3664370">out</span><span class="op" id="3664373">.</span><span class="ident" id="3664374">Lock</span><span class="op" id="3664378">(</span><span class="op" id="3664379">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664382">defer</span>&nbsp;<span class="ident" id="3664388">c</span><span class="op" id="3664389">.</span><span class="ident" id="3664390">out</span><span class="op" id="3664393">.</span><span class="ident" id="3664394">Unlock</span><span class="op" id="3664400">(</span><span class="op" id="3664401">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664405">if</span>&nbsp;<span class="ident" id="3664408">err</span>&nbsp;<span class="op" id="3664412">:=</span>&nbsp;<span class="ident" id="3664415">c</span><span class="op" id="3664416">.</span><span class="ident" id="3664417">out</span><span class="op" id="3664420">.</span><span class="ident" id="3664421">err</span><span class="op" id="3664424">;</span>&nbsp;<span class="ident" id="3664426">err</span>&nbsp;<span class="op" id="3664430">!=</span>&nbsp;<span class="ident" id="3664433">nil</span>&nbsp;<span class="op" id="3664437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664441">return</span>&nbsp;<span class="num" id="3664448">0</span><span class="op" id="3664449">,</span>&nbsp;<span class="ident" id="3664451">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3664456">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664460">if</span>&nbsp;<span class="op" id="3664463">!</span><span class="ident" id="3664464">c</span><span class="op" id="3664465">.</span><span class="ident" id="3664466">handshakeComplete</span>&nbsp;<span class="op" id="3664484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664488">return</span>&nbsp;<span class="num" id="3664495">0</span><span class="op" id="3664496">,</span>&nbsp;<span class="ident" id="3664498">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3664518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664522">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664584">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664649">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664710">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664771">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664775">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664820">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664876">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664941">var</span>&nbsp;<span class="ident" id="3664945">m</span>&nbsp;<span class="builtintype" id="3664947">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664952">if</span>&nbsp;<span class="builtinfunc" id="3664955">len</span><span class="op" id="3664958">(</span><span class="ident" id="3664959">b</span><span class="op" id="3664960">)</span>&nbsp;<span class="op" id="3664962">&gt;</span>&nbsp;<span class="num" id="3664964">1</span>&nbsp;<span class="op" id="3664966">&amp;&amp;</span>&nbsp;<span class="ident" id="3664969">c</span><span class="op" id="3664970">.</span><span class="ident" id="3664971">vers</span>&nbsp;<span class="op" id="3664976">&lt;=</span>&nbsp;<span class="ident" id="3664979">VersionTLS10</span>&nbsp;<span class="op" id="3664992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3664996">if</span>&nbsp;<span class="ident" id="3664999">_</span><span class="op" id="3665000">,</span>&nbsp;<span class="ident" id="3665002">ok</span>&nbsp;<span class="op" id="3665005">:=</span>&nbsp;<span class="ident" id="3665008">c</span><span class="op" id="3665009">.</span><span class="ident" id="3665010">out</span><span class="op" id="3665013">.</span><span class="ident" id="3665014">cipher</span><span class="op" id="3665020">.</span><span class="op" id="3665021">(</span><span class="ident" id="3665022">cipher</span><span class="op" id="3665028">.</span><span class="ident" id="3665029">BlockMode</span><span class="op" id="3665038">)</span><span class="op" id="3665039">;</span>&nbsp;<span class="ident" id="3665041">ok</span>&nbsp;<span class="op" id="3665044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665049">n</span><span class="op" id="3665050">,</span>&nbsp;<span class="ident" id="3665052">err</span>&nbsp;<span class="op" id="3665056">:=</span>&nbsp;<span class="ident" id="3665059">c</span><span class="op" id="3665060">.</span><span class="ident" id="3665061">writeRecord</span><span class="op" id="3665072">(</span><span class="ident" id="3665073">recordTypeApplicationData</span><span class="op" id="3665098">,</span>&nbsp;<span class="ident" id="3665100">b</span><span class="op" id="3665101">[</span><span class="op" id="3665102">:</span><span class="num" id="3665103">1</span><span class="op" id="3665104">]</span><span class="op" id="3665105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665110">if</span>&nbsp;<span class="ident" id="3665113">err</span>&nbsp;<span class="op" id="3665117">!=</span>&nbsp;<span class="ident" id="3665120">nil</span>&nbsp;<span class="op" id="3665124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665130">return</span>&nbsp;<span class="ident" id="3665137">n</span><span class="op" id="3665138">,</span>&nbsp;<span class="ident" id="3665140">c</span><span class="op" id="3665141">.</span><span class="ident" id="3665142">out</span><span class="op" id="3665145">.</span><span class="ident" id="3665146">setErrorLocked</span><span class="op" id="3665160">(</span><span class="ident" id="3665161">err</span><span class="op" id="3665164">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3665169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665174">m</span><span class="op" id="3665175">,</span>&nbsp;<span class="ident" id="3665177">b</span>&nbsp;<span class="op" id="3665179">=</span>&nbsp;<span class="num" id="3665181">1</span><span class="op" id="3665182">,</span>&nbsp;<span class="ident" id="3665184">b</span><span class="op" id="3665185">[</span><span class="num" id="3665186">1</span><span class="op" id="3665187">:</span><span class="op" id="3665188">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3665192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3665195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665199">n</span><span class="op" id="3665200">,</span>&nbsp;<span class="ident" id="3665202">err</span>&nbsp;<span class="op" id="3665206">:=</span>&nbsp;<span class="ident" id="3665209">c</span><span class="op" id="3665210">.</span><span class="ident" id="3665211">writeRecord</span><span class="op" id="3665222">(</span><span class="ident" id="3665223">recordTypeApplicationData</span><span class="op" id="3665248">,</span>&nbsp;<span class="ident" id="3665250">b</span><span class="op" id="3665251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665254">return</span>&nbsp;<span class="ident" id="3665261">n</span>&nbsp;<span class="op" id="3665263">+</span>&nbsp;<span class="ident" id="3665265">m</span><span class="op" id="3665266">,</span>&nbsp;<span class="ident" id="3665268">c</span><span class="op" id="3665269">.</span><span class="ident" id="3665270">out</span><span class="op" id="3665273">.</span><span class="ident" id="3665274">setErrorLocked</span><span class="op" id="3665288">(</span><span class="ident" id="3665289">err</span><span class="op" id="3665292">)</span><br>
<span class="lineno"></span><span class="op" id="3665294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3665297">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="3665375">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="3665441">func</span>&nbsp;<span class="op" id="3665446">(</span><span class="ident" id="3665447">c</span>&nbsp;<span class="op" id="3665449">*</span><span class="ident" id="3665450">Conn</span><span class="op" id="3665454">)</span>&nbsp;<span class="ident" id="3665456">Read</span><span class="op" id="3665460">(</span><span class="ident" id="3665461">b</span>&nbsp;<span class="op" id="3665463">[</span><span class="op" id="3665464">]</span><span class="builtintype" id="3665465">byte</span><span class="op" id="3665469">)</span>&nbsp;<span class="op" id="3665471">(</span><span class="ident" id="3665472">n</span>&nbsp;<span class="builtintype" id="3665474">int</span><span class="op" id="3665477">,</span>&nbsp;<span class="ident" id="3665479">err</span>&nbsp;<span class="builtintype" id="3665483">error</span><span class="op" id="3665488">)</span>&nbsp;<span class="op" id="3665490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665493">if</span>&nbsp;<span class="ident" id="3665496">err</span>&nbsp;<span class="op" id="3665500">=</span>&nbsp;<span class="ident" id="3665502">c</span><span class="op" id="3665503">.</span><span class="ident" id="3665504">Handshake</span><span class="op" id="3665513">(</span><span class="op" id="3665514">)</span><span class="op" id="3665515">;</span>&nbsp;<span class="ident" id="3665517">err</span>&nbsp;<span class="op" id="3665521">!=</span>&nbsp;<span class="ident" id="3665524">nil</span>&nbsp;<span class="op" id="3665528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665532">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3665540">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665543">if</span>&nbsp;<span class="builtinfunc" id="3665546">len</span><span class="op" id="3665549">(</span><span class="ident" id="3665550">b</span><span class="op" id="3665551">)</span>&nbsp;<span class="op" id="3665553">==</span>&nbsp;<span class="num" id="3665556">0</span>&nbsp;<span class="op" id="3665558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665562">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665621">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665674">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3665682">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665686">c</span><span class="op" id="3665687">.</span><span class="ident" id="3665688">in</span><span class="op" id="3665690">.</span><span class="ident" id="3665691">Lock</span><span class="op" id="3665695">(</span><span class="op" id="3665696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665699">defer</span>&nbsp;<span class="ident" id="3665705">c</span><span class="op" id="3665706">.</span><span class="ident" id="3665707">in</span><span class="op" id="3665709">.</span><span class="ident" id="3665710">Unlock</span><span class="op" id="3665716">(</span><span class="op" id="3665717">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665721">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665791">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665859">const</span>&nbsp;<span class="ident" id="3665865">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="3665892">=</span>&nbsp;<span class="num" id="3665894">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665899">for</span>&nbsp;<span class="ident" id="3665903">emptyRecordCount</span>&nbsp;<span class="op" id="3665920">:=</span>&nbsp;<span class="num" id="3665923">0</span><span class="op" id="3665924">;</span>&nbsp;<span class="ident" id="3665926">emptyRecordCount</span>&nbsp;<span class="op" id="3665943">&lt;=</span>&nbsp;<span class="ident" id="3665946">maxConsecutiveEmptyRecords</span><span class="op" id="3665972">;</span>&nbsp;<span class="ident" id="3665974">emptyRecordCount</span><span class="op" id="3665990">++</span>&nbsp;<span class="op" id="3665993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3665997">for</span>&nbsp;<span class="ident" id="3666001">c</span><span class="op" id="3666002">.</span><span class="ident" id="3666003">input</span>&nbsp;<span class="op" id="3666009">==</span>&nbsp;<span class="ident" id="3666012">nil</span>&nbsp;<span class="op" id="3666016">&amp;&amp;</span>&nbsp;<span class="ident" id="3666019">c</span><span class="op" id="3666020">.</span><span class="ident" id="3666021">in</span><span class="op" id="3666023">.</span><span class="ident" id="3666024">err</span>&nbsp;<span class="op" id="3666028">==</span>&nbsp;<span class="ident" id="3666031">nil</span>&nbsp;<span class="op" id="3666035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666040">if</span>&nbsp;<span class="ident" id="3666043">err</span>&nbsp;<span class="op" id="3666047">:=</span>&nbsp;<span class="ident" id="3666050">c</span><span class="op" id="3666051">.</span><span class="ident" id="3666052">readRecord</span><span class="op" id="3666062">(</span><span class="ident" id="3666063">recordTypeApplicationData</span><span class="op" id="3666088">)</span><span class="op" id="3666089">;</span>&nbsp;<span class="ident" id="3666091">err</span>&nbsp;<span class="op" id="3666095">!=</span>&nbsp;<span class="ident" id="3666098">nil</span>&nbsp;<span class="op" id="3666102">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666108">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666139">return</span>&nbsp;<span class="num" id="3666146">0</span><span class="op" id="3666147">,</span>&nbsp;<span class="ident" id="3666149">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3666156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3666160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666164">if</span>&nbsp;<span class="ident" id="3666167">err</span>&nbsp;<span class="op" id="3666171">:=</span>&nbsp;<span class="ident" id="3666174">c</span><span class="op" id="3666175">.</span><span class="ident" id="3666176">in</span><span class="op" id="3666178">.</span><span class="ident" id="3666179">err</span><span class="op" id="3666182">;</span>&nbsp;<span class="ident" id="3666184">err</span>&nbsp;<span class="op" id="3666188">!=</span>&nbsp;<span class="ident" id="3666191">nil</span>&nbsp;<span class="op" id="3666195">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666200">return</span>&nbsp;<span class="num" id="3666207">0</span><span class="op" id="3666208">,</span>&nbsp;<span class="ident" id="3666210">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3666216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666221">n</span><span class="op" id="3666222">,</span>&nbsp;<span class="ident" id="3666224">err</span>&nbsp;<span class="op" id="3666228">=</span>&nbsp;<span class="ident" id="3666230">c</span><span class="op" id="3666231">.</span><span class="ident" id="3666232">input</span><span class="op" id="3666237">.</span><span class="ident" id="3666238">Read</span><span class="op" id="3666242">(</span><span class="ident" id="3666243">b</span><span class="op" id="3666244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666248">if</span>&nbsp;<span class="ident" id="3666251">c</span><span class="op" id="3666252">.</span><span class="ident" id="3666253">input</span><span class="op" id="3666258">.</span><span class="ident" id="3666259">off</span>&nbsp;<span class="op" id="3666263">&gt;=</span>&nbsp;<span class="builtinfunc" id="3666266">len</span><span class="op" id="3666269">(</span><span class="ident" id="3666270">c</span><span class="op" id="3666271">.</span><span class="ident" id="3666272">input</span><span class="op" id="3666277">.</span><span class="ident" id="3666278">data</span><span class="op" id="3666282">)</span>&nbsp;<span class="op" id="3666284">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666289">c</span><span class="op" id="3666290">.</span><span class="ident" id="3666291">in</span><span class="op" id="3666293">.</span><span class="ident" id="3666294">freeBlock</span><span class="op" id="3666303">(</span><span class="ident" id="3666304">c</span><span class="op" id="3666305">.</span><span class="ident" id="3666306">input</span><span class="op" id="3666311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666316">c</span><span class="op" id="3666317">.</span><span class="ident" id="3666318">input</span>&nbsp;<span class="op" id="3666324">=</span>&nbsp;<span class="ident" id="3666326">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3666332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666337">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666394">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666453">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666506">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666560">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666613">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666669">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666726">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666776">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666790">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666839">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3666877">if</span>&nbsp;<span class="ident" id="3666880">ri</span>&nbsp;<span class="op" id="3666883">:=</span>&nbsp;<span class="ident" id="3666886">c</span><span class="op" id="3666887">.</span><span class="ident" id="3666888">rawInput</span><span class="op" id="3666896">;</span>&nbsp;<span class="ident" id="3666898">ri</span>&nbsp;<span class="op" id="3666901">!=</span>&nbsp;<span class="ident" id="3666904">nil</span>&nbsp;<span class="op" id="3666908">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666914">n</span>&nbsp;<span class="op" id="3666916">!=</span>&nbsp;<span class="num" id="3666919">0</span>&nbsp;<span class="op" id="3666921">&amp;&amp;</span>&nbsp;<span class="ident" id="3666924">err</span>&nbsp;<span class="op" id="3666928">==</span>&nbsp;<span class="ident" id="3666931">nil</span>&nbsp;<span class="op" id="3666935">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666941">c</span><span class="op" id="3666942">.</span><span class="ident" id="3666943">input</span>&nbsp;<span class="op" id="3666949">==</span>&nbsp;<span class="ident" id="3666952">nil</span>&nbsp;<span class="op" id="3666956">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3666959">len</span><span class="op" id="3666962">(</span><span class="ident" id="3666963">ri</span><span class="op" id="3666965">.</span><span class="ident" id="3666966">data</span><span class="op" id="3666970">)</span>&nbsp;<span class="op" id="3666972">&gt;</span>&nbsp;<span class="num" id="3666974">0</span>&nbsp;<span class="op" id="3666976">&amp;&amp;</span>&nbsp;<span class="ident" id="3666979">recordType</span><span class="op" id="3666989">(</span><span class="ident" id="3666990">ri</span><span class="op" id="3666992">.</span><span class="ident" id="3666993">data</span><span class="op" id="3666997">[</span><span class="num" id="3666998">0</span><span class="op" id="3666999">]</span><span class="op" id="3667000">)</span>&nbsp;<span class="op" id="3667002">==</span>&nbsp;<span class="ident" id="3667005">recordTypeAlert</span>&nbsp;<span class="op" id="3667021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667026">if</span>&nbsp;<span class="ident" id="3667029">recErr</span>&nbsp;<span class="op" id="3667036">:=</span>&nbsp;<span class="ident" id="3667039">c</span><span class="op" id="3667040">.</span><span class="ident" id="3667041">readRecord</span><span class="op" id="3667051">(</span><span class="ident" id="3667052">recordTypeApplicationData</span><span class="op" id="3667077">)</span><span class="op" id="3667078">;</span>&nbsp;<span class="ident" id="3667080">recErr</span>&nbsp;<span class="op" id="3667087">!=</span>&nbsp;<span class="ident" id="3667090">nil</span>&nbsp;<span class="op" id="3667094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667100">err</span>&nbsp;<span class="op" id="3667104">=</span>&nbsp;<span class="ident" id="3667106">recErr</span>&nbsp;<span class="comment" id="3667113">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667158">if</span>&nbsp;<span class="ident" id="3667161">n</span>&nbsp;<span class="op" id="3667163">!=</span>&nbsp;<span class="num" id="3667166">0</span>&nbsp;<span class="op" id="3667168">||</span>&nbsp;<span class="ident" id="3667171">err</span>&nbsp;<span class="op" id="3667175">!=</span>&nbsp;<span class="ident" id="3667178">nil</span>&nbsp;<span class="op" id="3667182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667187">return</span>&nbsp;<span class="ident" id="3667194">n</span><span class="op" id="3667195">,</span>&nbsp;<span class="ident" id="3667197">err</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667210">return</span>&nbsp;<span class="num" id="3667217">0</span><span class="op" id="3667218">,</span>&nbsp;<span class="ident" id="3667220">io</span><span class="op" id="3667222">.</span><span class="ident" id="3667223">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="3667237">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="3667240">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3667272">func</span>&nbsp;<span class="op" id="3667277">(</span><span class="ident" id="3667278">c</span>&nbsp;<span class="op" id="3667280">*</span><span class="ident" id="3667281">Conn</span><span class="op" id="3667285">)</span>&nbsp;<span class="ident" id="3667287">Close</span><span class="op" id="3667292">(</span><span class="op" id="3667293">)</span>&nbsp;<span class="builtintype" id="3667295">error</span>&nbsp;<span class="op" id="3667301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667304">var</span>&nbsp;<span class="ident" id="3667308">alertErr</span>&nbsp;<span class="builtintype" id="3667317">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667325">c</span><span class="op" id="3667326">.</span><span class="ident" id="3667327">handshakeMutex</span><span class="op" id="3667341">.</span><span class="ident" id="3667342">Lock</span><span class="op" id="3667346">(</span><span class="op" id="3667347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667350">defer</span>&nbsp;<span class="ident" id="3667356">c</span><span class="op" id="3667357">.</span><span class="ident" id="3667358">handshakeMutex</span><span class="op" id="3667372">.</span><span class="ident" id="3667373">Unlock</span><span class="op" id="3667379">(</span><span class="op" id="3667380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667383">if</span>&nbsp;<span class="ident" id="3667386">c</span><span class="op" id="3667387">.</span><span class="ident" id="3667388">handshakeComplete</span>&nbsp;<span class="op" id="3667406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667410">alertErr</span>&nbsp;<span class="op" id="3667419">=</span>&nbsp;<span class="ident" id="3667421">c</span><span class="op" id="3667422">.</span><span class="ident" id="3667423">sendAlert</span><span class="op" id="3667432">(</span><span class="ident" id="3667433">alertCloseNotify</span><span class="op" id="3667449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667452">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667456">if</span>&nbsp;<span class="ident" id="3667459">err</span>&nbsp;<span class="op" id="3667463">:=</span>&nbsp;<span class="ident" id="3667466">c</span><span class="op" id="3667467">.</span><span class="ident" id="3667468">conn</span><span class="op" id="3667472">.</span><span class="ident" id="3667473">Close</span><span class="op" id="3667478">(</span><span class="op" id="3667479">)</span><span class="op" id="3667480">;</span>&nbsp;<span class="ident" id="3667482">err</span>&nbsp;<span class="op" id="3667486">!=</span>&nbsp;<span class="ident" id="3667489">nil</span>&nbsp;<span class="op" id="3667493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667497">return</span>&nbsp;<span class="ident" id="3667504">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667512">return</span>&nbsp;<span class="ident" id="3667519">alertErr</span><br>
<span class="lineno">960</span><span class="op" id="3667528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3667531">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="3667580">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="3667620">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="3667673">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="3667740">func</span>&nbsp;<span class="op" id="3667745">(</span><span class="ident" id="3667746">c</span>&nbsp;<span class="op" id="3667748">*</span><span class="ident" id="3667749">Conn</span><span class="op" id="3667753">)</span>&nbsp;<span class="ident" id="3667755">Handshake</span><span class="op" id="3667764">(</span><span class="op" id="3667765">)</span>&nbsp;<span class="builtintype" id="3667767">error</span>&nbsp;<span class="op" id="3667773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667776">c</span><span class="op" id="3667777">.</span><span class="ident" id="3667778">handshakeMutex</span><span class="op" id="3667792">.</span><span class="ident" id="3667793">Lock</span><span class="op" id="3667797">(</span><span class="op" id="3667798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667801">defer</span>&nbsp;<span class="ident" id="3667807">c</span><span class="op" id="3667808">.</span><span class="ident" id="3667809">handshakeMutex</span><span class="op" id="3667823">.</span><span class="ident" id="3667824">Unlock</span><span class="op" id="3667830">(</span><span class="op" id="3667831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667834">if</span>&nbsp;<span class="ident" id="3667837">err</span>&nbsp;<span class="op" id="3667841">:=</span>&nbsp;<span class="ident" id="3667844">c</span><span class="op" id="3667845">.</span><span class="ident" id="3667846">handshakeErr</span><span class="op" id="3667858">;</span>&nbsp;<span class="ident" id="3667860">err</span>&nbsp;<span class="op" id="3667864">!=</span>&nbsp;<span class="ident" id="3667867">nil</span>&nbsp;<span class="op" id="3667871">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667875">return</span>&nbsp;<span class="ident" id="3667882">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667890">if</span>&nbsp;<span class="ident" id="3667893">c</span><span class="op" id="3667894">.</span><span class="ident" id="3667895">handshakeComplete</span>&nbsp;<span class="op" id="3667913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667917">return</span>&nbsp;<span class="ident" id="3667924">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667929">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667933">if</span>&nbsp;<span class="ident" id="3667936">c</span><span class="op" id="3667937">.</span><span class="ident" id="3667938">isClient</span>&nbsp;<span class="op" id="3667947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667951">c</span><span class="op" id="3667952">.</span><span class="ident" id="3667953">handshakeErr</span>&nbsp;<span class="op" id="3667966">=</span>&nbsp;<span class="ident" id="3667968">c</span><span class="op" id="3667969">.</span><span class="ident" id="3667970">clientHandshake</span><span class="op" id="3667985">(</span><span class="op" id="3667986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667989">}</span>&nbsp;<span class="keyword" id="3667991">else</span>&nbsp;<span class="op" id="3667996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668000">c</span><span class="op" id="3668001">.</span><span class="ident" id="3668002">handshakeErr</span>&nbsp;<span class="op" id="3668015">=</span>&nbsp;<span class="ident" id="3668017">c</span><span class="op" id="3668018">.</span><span class="ident" id="3668019">serverHandshake</span><span class="op" id="3668034">(</span><span class="op" id="3668035">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668041">return</span>&nbsp;<span class="ident" id="3668048">c</span><span class="op" id="3668049">.</span><span class="ident" id="3668050">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="3668063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3668066">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="3668133">func</span>&nbsp;<span class="op" id="3668138">(</span><span class="ident" id="3668139">c</span>&nbsp;<span class="op" id="3668141">*</span><span class="ident" id="3668142">Conn</span><span class="op" id="3668146">)</span>&nbsp;<span class="ident" id="3668148">ConnectionState</span><span class="op" id="3668163">(</span><span class="op" id="3668164">)</span>&nbsp;<span class="ident" id="3668166">ConnectionState</span>&nbsp;<span class="op" id="3668182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668185">c</span><span class="op" id="3668186">.</span><span class="ident" id="3668187">handshakeMutex</span><span class="op" id="3668201">.</span><span class="ident" id="3668202">Lock</span><span class="op" id="3668206">(</span><span class="op" id="3668207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668210">defer</span>&nbsp;<span class="ident" id="3668216">c</span><span class="op" id="3668217">.</span><span class="ident" id="3668218">handshakeMutex</span><span class="op" id="3668232">.</span><span class="ident" id="3668233">Unlock</span><span class="op" id="3668239">(</span><span class="op" id="3668240">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668244">var</span>&nbsp;<span class="ident" id="3668248">state</span>&nbsp;<span class="ident" id="3668254">ConnectionState</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668271">state</span><span class="op" id="3668276">.</span><span class="ident" id="3668277">HandshakeComplete</span>&nbsp;<span class="op" id="3668295">=</span>&nbsp;<span class="ident" id="3668297">c</span><span class="op" id="3668298">.</span><span class="ident" id="3668299">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668318">if</span>&nbsp;<span class="ident" id="3668321">c</span><span class="op" id="3668322">.</span><span class="ident" id="3668323">handshakeComplete</span>&nbsp;<span class="op" id="3668341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668345">state</span><span class="op" id="3668350">.</span><span class="ident" id="3668351">Version</span>&nbsp;<span class="op" id="3668359">=</span>&nbsp;<span class="ident" id="3668361">c</span><span class="op" id="3668362">.</span><span class="ident" id="3668363">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668370">state</span><span class="op" id="3668375">.</span><span class="ident" id="3668376">NegotiatedProtocol</span>&nbsp;<span class="op" id="3668395">=</span>&nbsp;<span class="ident" id="3668397">c</span><span class="op" id="3668398">.</span><span class="ident" id="3668399">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668416">state</span><span class="op" id="3668421">.</span><span class="ident" id="3668422">DidResume</span>&nbsp;<span class="op" id="3668432">=</span>&nbsp;<span class="ident" id="3668434">c</span><span class="op" id="3668435">.</span><span class="ident" id="3668436">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668448">state</span><span class="op" id="3668453">.</span><span class="ident" id="3668454">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="3668481">=</span>&nbsp;<span class="op" id="3668483">!</span><span class="ident" id="3668484">c</span><span class="op" id="3668485">.</span><span class="ident" id="3668486">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668511">state</span><span class="op" id="3668516">.</span><span class="ident" id="3668517">CipherSuite</span>&nbsp;<span class="op" id="3668529">=</span>&nbsp;<span class="ident" id="3668531">c</span><span class="op" id="3668532">.</span><span class="ident" id="3668533">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668547">state</span><span class="op" id="3668552">.</span><span class="ident" id="3668553">PeerCertificates</span>&nbsp;<span class="op" id="3668570">=</span>&nbsp;<span class="ident" id="3668572">c</span><span class="op" id="3668573">.</span><span class="ident" id="3668574">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668593">state</span><span class="op" id="3668598">.</span><span class="ident" id="3668599">VerifiedChains</span>&nbsp;<span class="op" id="3668614">=</span>&nbsp;<span class="ident" id="3668616">c</span><span class="op" id="3668617">.</span><span class="ident" id="3668618">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668635">state</span><span class="op" id="3668640">.</span><span class="ident" id="3668641">ServerName</span>&nbsp;<span class="op" id="3668652">=</span>&nbsp;<span class="ident" id="3668654">c</span><span class="op" id="3668655">.</span><span class="ident" id="3668656">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668669">if</span>&nbsp;<span class="op" id="3668672">!</span><span class="ident" id="3668673">c</span><span class="op" id="3668674">.</span><span class="ident" id="3668675">didResume</span>&nbsp;<span class="op" id="3668685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668690">state</span><span class="op" id="3668695">.</span><span class="ident" id="3668696">TLSUnique</span>&nbsp;<span class="op" id="3668706">=</span>&nbsp;<span class="ident" id="3668708">c</span><span class="op" id="3668709">.</span><span class="ident" id="3668710">firstFinished</span><span class="op" id="3668723">[</span><span class="op" id="3668724">:</span><span class="op" id="3668725">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668736">return</span>&nbsp;<span class="ident" id="3668743">state</span><br>
<span class="lineno"></span><span class="op" id="3668749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3668752">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="3668826">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="3668871">func</span>&nbsp;<span class="op" id="3668876">(</span><span class="ident" id="3668877">c</span>&nbsp;<span class="op" id="3668879">*</span><span class="ident" id="3668880">Conn</span><span class="op" id="3668884">)</span>&nbsp;<span class="ident" id="3668886">OCSPResponse</span><span class="op" id="3668898">(</span><span class="op" id="3668899">)</span>&nbsp;<span class="op" id="3668901">[</span><span class="op" id="3668902">]</span><span class="builtintype" id="3668903">byte</span>&nbsp;<span class="op" id="3668908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668911">c</span><span class="op" id="3668912">.</span><span class="ident" id="3668913">handshakeMutex</span><span class="op" id="3668927">.</span><span class="ident" id="3668928">Lock</span><span class="op" id="3668932">(</span><span class="op" id="3668933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668936">defer</span>&nbsp;<span class="ident" id="3668942">c</span><span class="op" id="3668943">.</span><span class="ident" id="3668944">handshakeMutex</span><span class="op" id="3668958">.</span><span class="ident" id="3668959">Unlock</span><span class="op" id="3668965">(</span><span class="op" id="3668966">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668970">return</span>&nbsp;<span class="ident" id="3668977">c</span><span class="op" id="3668978">.</span><span class="ident" id="3668979">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="3668992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3668995">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3669065">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3669140">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="3669167">func</span>&nbsp;<span class="op" id="3669172">(</span><span class="ident" id="3669173">c</span>&nbsp;<span class="op" id="3669175">*</span><span class="ident" id="3669176">Conn</span><span class="op" id="3669180">)</span>&nbsp;<span class="ident" id="3669182">VerifyHostname</span><span class="op" id="3669196">(</span><span class="ident" id="3669197">host</span>&nbsp;<span class="builtintype" id="3669202">string</span><span class="op" id="3669208">)</span>&nbsp;<span class="builtintype" id="3669210">error</span>&nbsp;<span class="op" id="3669216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669219">c</span><span class="op" id="3669220">.</span><span class="ident" id="3669221">handshakeMutex</span><span class="op" id="3669235">.</span><span class="ident" id="3669236">Lock</span><span class="op" id="3669240">(</span><span class="op" id="3669241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669244">defer</span>&nbsp;<span class="ident" id="3669250">c</span><span class="op" id="3669251">.</span><span class="ident" id="3669252">handshakeMutex</span><span class="op" id="3669266">.</span><span class="ident" id="3669267">Unlock</span><span class="op" id="3669273">(</span><span class="op" id="3669274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669277">if</span>&nbsp;<span class="op" id="3669280">!</span><span class="ident" id="3669281">c</span><span class="op" id="3669282">.</span><span class="ident" id="3669283">isClient</span>&nbsp;<span class="op" id="3669292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669296">return</span>&nbsp;<span class="ident" id="3669303">errors</span><span class="op" id="3669309">.</span><span class="ident" id="3669310">New</span><span class="op" id="3669313">(</span><span class="string" id="3669314">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="3669367">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669373">if</span>&nbsp;<span class="op" id="3669376">!</span><span class="ident" id="3669377">c</span><span class="op" id="3669378">.</span><span class="ident" id="3669379">handshakeComplete</span>&nbsp;<span class="op" id="3669397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669401">return</span>&nbsp;<span class="ident" id="3669408">errors</span><span class="op" id="3669414">.</span><span class="ident" id="3669415">New</span><span class="op" id="3669418">(</span><span class="string" id="3669419">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="3669462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669468">return</span>&nbsp;<span class="ident" id="3669475">c</span><span class="op" id="3669476">.</span><span class="ident" id="3669477">peerCertificates</span><span class="op" id="3669493">[</span><span class="num" id="3669494">0</span><span class="op" id="3669495">]</span><span class="op" id="3669496">.</span><span class="ident" id="3669497">VerifyHostname</span><span class="op" id="3669511">(</span><span class="ident" id="3669512">host</span><span class="op" id="3669516">)</span><br>
<span class="lineno">1030</span><span class="op" id="3669518">}</span>
</div>
</body>
</html>
