<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html" class="current">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1493191">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1493246">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1493300">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1493351">package</span>&nbsp;<span class="ident" id="1493359">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1493368">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&#39;s&nbsp;map&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1493427">//</span><br>
<span class="lineno"></span><span class="comment" id="1493430">//&nbsp;A&nbsp;map&nbsp;is&nbsp;just&nbsp;a&nbsp;hash&nbsp;table.&nbsp;&nbsp;The&nbsp;data&nbsp;is&nbsp;arranged</span><br>
<span class="lineno">10</span><span class="comment" id="1493483">//&nbsp;into&nbsp;an&nbsp;array&nbsp;of&nbsp;buckets.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;up&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1493540">//&nbsp;8&nbsp;key/value&nbsp;pairs.&nbsp;&nbsp;The&nbsp;low-order&nbsp;bits&nbsp;of&nbsp;the&nbsp;hash&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1493598">//&nbsp;used&nbsp;to&nbsp;select&nbsp;a&nbsp;bucket.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span><span class="comment" id="1493654">//&nbsp;high-order&nbsp;bits&nbsp;of&nbsp;each&nbsp;hash&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;entries</span><br>
<span class="lineno"></span><span class="comment" id="1493713">//&nbsp;within&nbsp;a&nbsp;single&nbsp;bucket.</span><br>
<span class="lineno">15</span><span class="comment" id="1493740">//</span><br>
<span class="lineno"></span><span class="comment" id="1493743">//&nbsp;If&nbsp;more&nbsp;than&nbsp;8&nbsp;keys&nbsp;hash&nbsp;to&nbsp;a&nbsp;bucket,&nbsp;we&nbsp;chain&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1493796">//&nbsp;extra&nbsp;buckets.</span><br>
<span class="lineno"></span><span class="comment" id="1493814">//</span><br>
<span class="lineno"></span><span class="comment" id="1493817">//&nbsp;When&nbsp;the&nbsp;hashtable&nbsp;grows,&nbsp;we&nbsp;allocate&nbsp;a&nbsp;new&nbsp;array</span><br>
<span class="lineno">20</span><span class="comment" id="1493870">//&nbsp;of&nbsp;buckets&nbsp;twice&nbsp;as&nbsp;big.&nbsp;&nbsp;Buckets&nbsp;are&nbsp;incrementally</span><br>
<span class="lineno"></span><span class="comment" id="1493925">//&nbsp;copied&nbsp;from&nbsp;the&nbsp;old&nbsp;bucket&nbsp;array&nbsp;to&nbsp;the&nbsp;new&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span><span class="comment" id="1493986">//</span><br>
<span class="lineno"></span><span class="comment" id="1493989">//&nbsp;Map&nbsp;iterators&nbsp;walk&nbsp;through&nbsp;the&nbsp;array&nbsp;of&nbsp;buckets&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1494044">//&nbsp;return&nbsp;the&nbsp;keys&nbsp;in&nbsp;walk&nbsp;order&nbsp;(bucket&nbsp;#,&nbsp;then&nbsp;overflow</span><br>
<span class="lineno">25</span><span class="comment" id="1494102">//&nbsp;chain&nbsp;order,&nbsp;then&nbsp;bucket&nbsp;index).&nbsp;&nbsp;To&nbsp;maintain&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="1494161">//&nbsp;semantics,&nbsp;we&nbsp;never&nbsp;move&nbsp;keys&nbsp;within&nbsp;their&nbsp;bucket&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="1494218">//&nbsp;we&nbsp;did,&nbsp;keys&nbsp;might&nbsp;be&nbsp;returned&nbsp;0&nbsp;or&nbsp;2&nbsp;times).&nbsp;&nbsp;When</span><br>
<span class="lineno"></span><span class="comment" id="1494273">//&nbsp;growing&nbsp;the&nbsp;table,&nbsp;iterators&nbsp;remain&nbsp;iterating&nbsp;through&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1494334">//&nbsp;old&nbsp;table&nbsp;and&nbsp;must&nbsp;check&nbsp;the&nbsp;new&nbsp;table&nbsp;if&nbsp;the&nbsp;bucket</span><br>
<span class="lineno">30</span><span class="comment" id="1494390">//&nbsp;they&nbsp;are&nbsp;iterating&nbsp;through&nbsp;has&nbsp;been&nbsp;moved&nbsp;(&#34;evacuated&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1494449">//&nbsp;to&nbsp;the&nbsp;new&nbsp;table.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1494471">//&nbsp;Picking&nbsp;loadFactor:&nbsp;too&nbsp;large&nbsp;and&nbsp;we&nbsp;have&nbsp;lots&nbsp;of&nbsp;overflow</span><br>
<span class="lineno"></span><span class="comment" id="1494533">//&nbsp;buckets,&nbsp;too&nbsp;small&nbsp;and&nbsp;we&nbsp;waste&nbsp;a&nbsp;lot&nbsp;of&nbsp;space.&nbsp;&nbsp;I&nbsp;wrote</span><br>
<span class="lineno">35</span><span class="comment" id="1494593">//&nbsp;a&nbsp;simple&nbsp;program&nbsp;to&nbsp;check&nbsp;some&nbsp;stats&nbsp;for&nbsp;different&nbsp;loads:</span><br>
<span class="lineno"></span><span class="comment" id="1494654">//&nbsp;(64-bit,&nbsp;8&nbsp;byte&nbsp;keys&nbsp;and&nbsp;values)</span><br>
<span class="lineno"></span><span class="comment" id="1494690">//&nbsp;&nbsp;loadFactor&nbsp;&nbsp;&nbsp;&nbsp;%overflow&nbsp;&nbsp;bytes/entry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;missprobe</span><br>
<span class="lineno"></span><span class="comment" id="1494757">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00</span><br>
<span class="lineno"></span><span class="comment" id="1494824">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17.30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50</span><br>
<span class="lineno">40</span><span class="comment" id="1494891">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;14.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00</span><br>
<span class="lineno"></span><span class="comment" id="1494958">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12.94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50</span><br>
<span class="lineno"></span><span class="comment" id="1495025">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15.27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11.67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00</span><br>
<span class="lineno"></span><span class="comment" id="1495092">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50</span><br>
<span class="lineno"></span><span class="comment" id="1495159">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;27.14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00</span><br>
<span class="lineno">45</span><span class="comment" id="1495226">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;34.03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50</span><br>
<span class="lineno"></span><span class="comment" id="1495293">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;41.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00</span><br>
<span class="lineno"></span><span class="comment" id="1495360">//</span><br>
<span class="lineno"></span><span class="comment" id="1495363">//&nbsp;%overflow&nbsp;&nbsp;&nbsp;=&nbsp;percentage&nbsp;of&nbsp;buckets&nbsp;which&nbsp;have&nbsp;an&nbsp;overflow&nbsp;bucket</span><br>
<span class="lineno"></span><span class="comment" id="1495432">//&nbsp;bytes/entry&nbsp;=&nbsp;overhead&nbsp;bytes&nbsp;used&nbsp;per&nbsp;key/value&nbsp;pair</span><br>
<span class="lineno">50</span><span class="comment" id="1495488">//&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;a&nbsp;present&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1495557">//&nbsp;missprobe&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;an&nbsp;absent&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1495626">//</span><br>
<span class="lineno"></span><span class="comment" id="1495629">//&nbsp;Keep&nbsp;in&nbsp;mind&nbsp;this&nbsp;data&nbsp;is&nbsp;for&nbsp;maximally&nbsp;loaded&nbsp;tables,&nbsp;i.e.&nbsp;just</span><br>
<span class="lineno"></span><span class="comment" id="1495697">//&nbsp;before&nbsp;the&nbsp;table&nbsp;grows.&nbsp;&nbsp;Typical&nbsp;tables&nbsp;will&nbsp;be&nbsp;somewhat&nbsp;less&nbsp;loaded.</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="1495771">import</span>&nbsp;<span class="op" id="1495778">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1495781">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1495790">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1495793">const</span>&nbsp;<span class="op" id="1495799">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1495802">//&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;key/value&nbsp;pairs&nbsp;a&nbsp;bucket&nbsp;can&nbsp;hold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495859">bucketCntBits</span>&nbsp;<span class="op" id="1495873">=</span>&nbsp;<span class="num" id="1495875">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495878">bucketCnt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495892">=</span>&nbsp;<span class="num" id="1495894">1</span>&nbsp;<span class="op" id="1495896">&lt;&lt;</span>&nbsp;<span class="ident" id="1495899">bucketCntBits</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1495915">//&nbsp;Maximum&nbsp;average&nbsp;load&nbsp;of&nbsp;a&nbsp;bucket&nbsp;that&nbsp;triggers&nbsp;growth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495974">loadFactor</span>&nbsp;<span class="op" id="1495985">=</span>&nbsp;<span class="num" id="1495987">6.5</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1495993">//&nbsp;Maximum&nbsp;key&nbsp;or&nbsp;value&nbsp;size&nbsp;to&nbsp;keep&nbsp;inline&nbsp;(instead&nbsp;of&nbsp;mallocing&nbsp;per&nbsp;element).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1496074">//&nbsp;Must&nbsp;fit&nbsp;in&nbsp;a&nbsp;uint8.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1496099">//&nbsp;Fast&nbsp;versions&nbsp;cannot&nbsp;handle&nbsp;big&nbsp;values&nbsp;-&nbsp;the&nbsp;cutoff&nbsp;size&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1496164">//&nbsp;fast&nbsp;versions&nbsp;in&nbsp;../../cmd/gc/walk.c&nbsp;must&nbsp;be&nbsp;at&nbsp;most&nbsp;this&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496233">maxKeySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1496246">=</span>&nbsp;<span class="num" id="1496248">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496253">maxValueSize</span>&nbsp;<span class="op" id="1496266">=</span>&nbsp;<span class="num" id="1496268">128</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1496274">//&nbsp;data&nbsp;offset&nbsp;should&nbsp;be&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;bmap&nbsp;struct,&nbsp;but&nbsp;needs&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1496345">//&nbsp;aligned&nbsp;correctly.&nbsp;&nbsp;For&nbsp;amd64p32&nbsp;this&nbsp;means&nbsp;64-bit&nbsp;alignment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1496410">//&nbsp;even&nbsp;though&nbsp;pointers&nbsp;are&nbsp;32&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496447">dataOffset</span>&nbsp;<span class="op" id="1496458">=</span>&nbsp;<span class="ident" id="1496460">unsafe</span><span class="op" id="1496466">.</span><span class="ident" id="1496467">Offsetof</span><span class="op" id="1496475">(</span><span class="keyword" id="1496476">struct</span>&nbsp;<span class="op" id="1496483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496487">b</span>&nbsp;<span class="ident" id="1496489">bmap</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496496">v</span>&nbsp;<span class="ident" id="1496498">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1496505">}</span><span class="op" id="1496506">{</span><span class="op" id="1496507">}</span><span class="op" id="1496508">.</span><span class="ident" id="1496509">v</span><span class="op" id="1496510">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1496514">//&nbsp;Possible&nbsp;tophash&nbsp;values.&nbsp;&nbsp;We&nbsp;reserve&nbsp;a&nbsp;few&nbsp;possibilities&nbsp;for&nbsp;special&nbsp;marks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1496594">//&nbsp;Each&nbsp;bucket&nbsp;(including&nbsp;its&nbsp;overflow&nbsp;buckets,&nbsp;if&nbsp;any)&nbsp;will&nbsp;have&nbsp;either&nbsp;all&nbsp;or&nbsp;none&nbsp;of&nbsp;its</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1496687">//&nbsp;entries&nbsp;in&nbsp;the&nbsp;evacuated*&nbsp;states&nbsp;(except&nbsp;during&nbsp;the&nbsp;evacuate()&nbsp;method,&nbsp;which&nbsp;only&nbsp;happens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1496781">//&nbsp;during&nbsp;map&nbsp;writes&nbsp;and&nbsp;thus&nbsp;no&nbsp;one&nbsp;else&nbsp;can&nbsp;observe&nbsp;the&nbsp;map&nbsp;during&nbsp;that&nbsp;time).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496863">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1496878">=</span>&nbsp;<span class="num" id="1496880">0</span>&nbsp;<span class="comment" id="1496882">//&nbsp;cell&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496900">evacuatedEmpty</span>&nbsp;<span class="op" id="1496915">=</span>&nbsp;<span class="num" id="1496917">1</span>&nbsp;<span class="comment" id="1496919">//&nbsp;cell&nbsp;is&nbsp;empty,&nbsp;bucket&nbsp;is&nbsp;evacuated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496959">evacuatedX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1496974">=</span>&nbsp;<span class="num" id="1496976">2</span>&nbsp;<span class="comment" id="1496978">//&nbsp;key/value&nbsp;is&nbsp;valid.&nbsp;&nbsp;Entry&nbsp;has&nbsp;been&nbsp;evacuated&nbsp;to&nbsp;first&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497059">evacuatedY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497074">=</span>&nbsp;<span class="num" id="1497076">3</span>&nbsp;<span class="comment" id="1497078">//&nbsp;same&nbsp;as&nbsp;above,&nbsp;but&nbsp;evacuated&nbsp;to&nbsp;second&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497143">minTopHash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497158">=</span>&nbsp;<span class="num" id="1497160">4</span>&nbsp;<span class="comment" id="1497162">//&nbsp;minimum&nbsp;tophash&nbsp;for&nbsp;a&nbsp;normal&nbsp;filled&nbsp;cell.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1497209">//&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497219">iterator</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497231">=</span>&nbsp;<span class="num" id="1497233">1</span>&nbsp;<span class="comment" id="1497235">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;buckets</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497278">oldIterator</span>&nbsp;<span class="op" id="1497290">=</span>&nbsp;<span class="num" id="1497292">2</span>&nbsp;<span class="comment" id="1497294">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;oldbuckets</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1497341">//&nbsp;sentinel&nbsp;bucket&nbsp;ID&nbsp;for&nbsp;iterator&nbsp;checks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497384">noCheck</span>&nbsp;<span class="op" id="1497392">=</span>&nbsp;<span class="num" id="1497394">1</span><span class="op" id="1497395">&lt;&lt;</span><span class="op" id="1497397">(</span><span class="num" id="1497398">8</span><span class="op" id="1497399">*</span><span class="ident" id="1497400">ptrSize</span><span class="op" id="1497407">)</span>&nbsp;<span class="op" id="1497409">-</span>&nbsp;<span class="num" id="1497411">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1497415">//&nbsp;trigger&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;at&nbsp;every&nbsp;alloc&nbsp;called&nbsp;from&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497485">checkgc</span>&nbsp;<span class="op" id="1497493">=</span>&nbsp;<span class="builtintype" id="1497495">false</span><br>
<span class="lineno"></span><span class="op" id="1497501">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1497504">//&nbsp;A&nbsp;header&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno">105</span><span class="keyword" id="1497530">type</span>&nbsp;<span class="ident" id="1497535">hmap</span>&nbsp;<span class="keyword" id="1497540">struct</span>&nbsp;<span class="op" id="1497547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1497550">//&nbsp;Note:&nbsp;the&nbsp;format&nbsp;of&nbsp;the&nbsp;Hmap&nbsp;is&nbsp;encoded&nbsp;in&nbsp;../../cmd/gc/reflect.c&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1497624">//&nbsp;../reflect/type.go.&nbsp;&nbsp;Don&#39;t&nbsp;change&nbsp;this&nbsp;structure&nbsp;without&nbsp;also&nbsp;changing&nbsp;that&nbsp;code!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497710">count</span>&nbsp;<span class="builtintype" id="1497716">int</span>&nbsp;<span class="comment" id="1497720">//&nbsp;#&nbsp;live&nbsp;cells&nbsp;==&nbsp;size&nbsp;of&nbsp;map.&nbsp;&nbsp;Must&nbsp;be&nbsp;first&nbsp;(used&nbsp;by&nbsp;len()&nbsp;builtin)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497792">flags</span>&nbsp;<span class="builtintype" id="1497798">uint32</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497806">hash0</span>&nbsp;<span class="builtintype" id="1497812">uint32</span>&nbsp;<span class="comment" id="1497819">//&nbsp;hash&nbsp;seed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497833">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1497839">uint8</span>&nbsp;&nbsp;<span class="comment" id="1497846">//&nbsp;log_2&nbsp;of&nbsp;#&nbsp;of&nbsp;buckets&nbsp;(can&nbsp;hold&nbsp;up&nbsp;to&nbsp;loadFactor&nbsp;*&nbsp;2^B&nbsp;items)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497913">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497924">unsafe</span><span class="op" id="1497930">.</span><span class="ident" id="1497931">Pointer</span>&nbsp;<span class="comment" id="1497939">//&nbsp;array&nbsp;of&nbsp;2^B&nbsp;Buckets.&nbsp;may&nbsp;be&nbsp;nil&nbsp;if&nbsp;count==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497989">oldbuckets</span>&nbsp;<span class="ident" id="1498000">unsafe</span><span class="op" id="1498006">.</span><span class="ident" id="1498007">Pointer</span>&nbsp;<span class="comment" id="1498015">//&nbsp;previous&nbsp;bucket&nbsp;array&nbsp;of&nbsp;half&nbsp;the&nbsp;size,&nbsp;non-nil&nbsp;only&nbsp;when&nbsp;growing</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498085">nevacuate</span>&nbsp;&nbsp;<span class="builtintype" id="1498096">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498111">//&nbsp;progress&nbsp;counter&nbsp;for&nbsp;evacuation&nbsp;(buckets&nbsp;less&nbsp;than&nbsp;this&nbsp;have&nbsp;been&nbsp;evacuated)</span><br>
<span class="lineno"></span><span class="op" id="1498191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1498194">//&nbsp;A&nbsp;bucket&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="1498220">type</span>&nbsp;<span class="ident" id="1498225">bmap</span>&nbsp;<span class="keyword" id="1498230">struct</span>&nbsp;<span class="op" id="1498237">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498240">tophash</span>&nbsp;&nbsp;<span class="op" id="1498249">[</span><span class="ident" id="1498250">bucketCnt</span><span class="op" id="1498259">]</span><span class="builtintype" id="1498260">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498267">overflow</span>&nbsp;<span class="op" id="1498276">*</span><span class="ident" id="1498277">bmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498283">//&nbsp;Followed&nbsp;by&nbsp;bucketCnt&nbsp;keys&nbsp;and&nbsp;then&nbsp;bucketCnt&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498341">//&nbsp;NOTE:&nbsp;packing&nbsp;all&nbsp;the&nbsp;keys&nbsp;together&nbsp;and&nbsp;then&nbsp;all&nbsp;the&nbsp;values&nbsp;together&nbsp;makes&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498424">//&nbsp;code&nbsp;a&nbsp;bit&nbsp;more&nbsp;complicated&nbsp;than&nbsp;alternating&nbsp;key/value/key/value/...&nbsp;but&nbsp;it&nbsp;allows</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498511">//&nbsp;us&nbsp;to&nbsp;eliminate&nbsp;padding&nbsp;which&nbsp;would&nbsp;be&nbsp;needed&nbsp;for,&nbsp;e.g.,&nbsp;map[int64]int8.</span><br>
<span class="lineno"></span><span class="op" id="1498587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1498590">//&nbsp;A&nbsp;hash&nbsp;iteration&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1498621">//&nbsp;If&nbsp;you&nbsp;modify&nbsp;hiter,&nbsp;also&nbsp;change&nbsp;cmd/gc/reflect.c&nbsp;to&nbsp;indicate</span><br>
<span class="lineno">130</span><span class="comment" id="1498686">//&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="1498719">type</span>&nbsp;<span class="ident" id="1498724">hiter</span>&nbsp;<span class="keyword" id="1498730">struct</span>&nbsp;<span class="op" id="1498737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498740">key</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498752">unsafe</span><span class="op" id="1498758">.</span><span class="ident" id="1498759">Pointer</span>&nbsp;<span class="comment" id="1498767">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;first&nbsp;position.&nbsp;&nbsp;Write&nbsp;nil&nbsp;to&nbsp;indicate&nbsp;iteration&nbsp;end&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498857">value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498869">unsafe</span><span class="op" id="1498875">.</span><span class="ident" id="1498876">Pointer</span>&nbsp;<span class="comment" id="1498884">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;second&nbsp;position&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498937">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498949">*</span><span class="ident" id="1498950">maptype</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498959">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498971">*</span><span class="ident" id="1498972">hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498978">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498990">unsafe</span><span class="op" id="1498996">.</span><span class="ident" id="1498997">Pointer</span>&nbsp;<span class="comment" id="1499005">//&nbsp;bucket&nbsp;ptr&nbsp;at&nbsp;hash_iter&nbsp;initialization&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499053">bptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499065">*</span><span class="ident" id="1499066">bmap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1499080">//&nbsp;current&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499099">startBucket</span>&nbsp;<span class="builtintype" id="1499111">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1499126">//&nbsp;bucket&nbsp;iteration&nbsp;started&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499158">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1499170">uint8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1499185">//&nbsp;intra-bucket&nbsp;offset&nbsp;to&nbsp;start&nbsp;from&nbsp;during&nbsp;iteration&nbsp;(should&nbsp;be&nbsp;big&nbsp;enough&nbsp;to&nbsp;hold&nbsp;bucketCnt-1)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499283">wrapped</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1499295">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1499310">//&nbsp;already&nbsp;wrapped&nbsp;around&nbsp;from&nbsp;end&nbsp;of&nbsp;bucket&nbsp;array&nbsp;to&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499375">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1499387">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499394">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1499406">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499413">bucket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1499425">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499434">checkBucket</span>&nbsp;<span class="builtintype" id="1499446">uintptr</span><br>
<span class="lineno">145</span><span class="op" id="1499454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1499457">func</span>&nbsp;<span class="ident" id="1499462">evacuated</span><span class="op" id="1499471">(</span><span class="ident" id="1499472">b</span>&nbsp;<span class="op" id="1499474">*</span><span class="ident" id="1499475">bmap</span><span class="op" id="1499479">)</span>&nbsp;<span class="builtintype" id="1499481">bool</span>&nbsp;<span class="op" id="1499486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499489">h</span>&nbsp;<span class="op" id="1499491">:=</span>&nbsp;<span class="ident" id="1499494">b</span><span class="op" id="1499495">.</span><span class="ident" id="1499496">tophash</span><span class="op" id="1499503">[</span><span class="num" id="1499504">0</span><span class="op" id="1499505">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499508">return</span>&nbsp;<span class="ident" id="1499515">h</span>&nbsp;<span class="op" id="1499517">&gt;</span>&nbsp;<span class="ident" id="1499519">empty</span>&nbsp;<span class="op" id="1499525">&amp;&amp;</span>&nbsp;<span class="ident" id="1499528">h</span>&nbsp;<span class="op" id="1499530">&lt;</span>&nbsp;<span class="ident" id="1499532">minTopHash</span><br>
<span class="lineno">150</span><span class="op" id="1499543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1499546">func</span>&nbsp;<span class="ident" id="1499551">makemap</span><span class="op" id="1499558">(</span><span class="ident" id="1499559">t</span>&nbsp;<span class="op" id="1499561">*</span><span class="ident" id="1499562">maptype</span><span class="op" id="1499569">,</span>&nbsp;<span class="ident" id="1499571">hint</span>&nbsp;<span class="ident" id="1499576">int64</span><span class="op" id="1499581">)</span>&nbsp;<span class="op" id="1499583">*</span><span class="ident" id="1499584">hmap</span>&nbsp;<span class="op" id="1499589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499592">if</span>&nbsp;<span class="ident" id="1499595">sz</span>&nbsp;<span class="op" id="1499598">:=</span>&nbsp;<span class="ident" id="1499601">unsafe</span><span class="op" id="1499607">.</span><span class="ident" id="1499608">Sizeof</span><span class="op" id="1499614">(</span><span class="ident" id="1499615">hmap</span><span class="op" id="1499619">{</span><span class="op" id="1499620">}</span><span class="op" id="1499621">)</span><span class="op" id="1499622">;</span>&nbsp;<span class="ident" id="1499624">sz</span>&nbsp;<span class="op" id="1499627">&gt;</span>&nbsp;<span class="num" id="1499629">48</span>&nbsp;<span class="op" id="1499632">||</span>&nbsp;<span class="ident" id="1499635">sz</span>&nbsp;<span class="op" id="1499638">!=</span>&nbsp;<span class="builtintype" id="1499641">uintptr</span><span class="op" id="1499648">(</span><span class="ident" id="1499649">t</span><span class="op" id="1499650">.</span><span class="ident" id="1499651">hmap</span><span class="op" id="1499655">.</span><span class="ident" id="1499656">size</span><span class="op" id="1499660">)</span>&nbsp;<span class="op" id="1499662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499666">gothrow</span><span class="op" id="1499673">(</span><span class="string" id="1499674">&#34;bad&nbsp;hmap&nbsp;size&#34;</span><span class="op" id="1499689">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499696">if</span>&nbsp;<span class="ident" id="1499699">hint</span>&nbsp;<span class="op" id="1499704">&lt;</span>&nbsp;<span class="num" id="1499706">0</span>&nbsp;<span class="op" id="1499708">||</span>&nbsp;<span class="ident" id="1499711">int64</span><span class="op" id="1499716">(</span><span class="builtintype" id="1499717">int32</span><span class="op" id="1499722">(</span><span class="ident" id="1499723">hint</span><span class="op" id="1499727">)</span><span class="op" id="1499728">)</span>&nbsp;<span class="op" id="1499730">!=</span>&nbsp;<span class="ident" id="1499733">hint</span>&nbsp;<span class="op" id="1499738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1499742">panic</span><span class="op" id="1499747">(</span><span class="string" id="1499748">&#34;makemap:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1499776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1499780">//&nbsp;TODO:&nbsp;make&nbsp;hint&nbsp;an&nbsp;int,&nbsp;then&nbsp;none&nbsp;of&nbsp;this&nbsp;nonsense</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499839">if</span>&nbsp;<span class="op" id="1499842">!</span><span class="ident" id="1499843">ismapkey</span><span class="op" id="1499851">(</span><span class="ident" id="1499852">t</span><span class="op" id="1499853">.</span><span class="ident" id="1499854">key</span><span class="op" id="1499857">)</span>&nbsp;<span class="op" id="1499859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499863">gothrow</span><span class="op" id="1499870">(</span><span class="string" id="1499871">&#34;runtime.makemap:&nbsp;unsupported&nbsp;map&nbsp;key&nbsp;type&#34;</span><span class="op" id="1499914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499917">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1499921">//&nbsp;check&nbsp;compiler&#39;s&nbsp;and&nbsp;reflect&#39;s&nbsp;math</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499961">if</span>&nbsp;<span class="ident" id="1499964">t</span><span class="op" id="1499965">.</span><span class="ident" id="1499966">key</span><span class="op" id="1499969">.</span><span class="ident" id="1499970">size</span>&nbsp;<span class="op" id="1499975">&gt;</span>&nbsp;<span class="ident" id="1499977">maxKeySize</span>&nbsp;<span class="op" id="1499988">&amp;&amp;</span>&nbsp;<span class="op" id="1499991">(</span><span class="op" id="1499992">!</span><span class="ident" id="1499993">t</span><span class="op" id="1499994">.</span><span class="ident" id="1499995">indirectkey</span>&nbsp;<span class="op" id="1500007">||</span>&nbsp;<span class="ident" id="1500010">t</span><span class="op" id="1500011">.</span><span class="ident" id="1500012">keysize</span>&nbsp;<span class="op" id="1500020">!=</span>&nbsp;<span class="builtintype" id="1500023">uint8</span><span class="op" id="1500028">(</span><span class="ident" id="1500029">ptrSize</span><span class="op" id="1500036">)</span><span class="op" id="1500037">)</span>&nbsp;<span class="op" id="1500039">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500044">t</span><span class="op" id="1500045">.</span><span class="ident" id="1500046">key</span><span class="op" id="1500049">.</span><span class="ident" id="1500050">size</span>&nbsp;<span class="op" id="1500055">&lt;=</span>&nbsp;<span class="ident" id="1500058">maxKeySize</span>&nbsp;<span class="op" id="1500069">&amp;&amp;</span>&nbsp;<span class="op" id="1500072">(</span><span class="ident" id="1500073">t</span><span class="op" id="1500074">.</span><span class="ident" id="1500075">indirectkey</span>&nbsp;<span class="op" id="1500087">||</span>&nbsp;<span class="ident" id="1500090">t</span><span class="op" id="1500091">.</span><span class="ident" id="1500092">keysize</span>&nbsp;<span class="op" id="1500100">!=</span>&nbsp;<span class="builtintype" id="1500103">uint8</span><span class="op" id="1500108">(</span><span class="ident" id="1500109">t</span><span class="op" id="1500110">.</span><span class="ident" id="1500111">key</span><span class="op" id="1500114">.</span><span class="ident" id="1500115">size</span><span class="op" id="1500119">)</span><span class="op" id="1500120">)</span>&nbsp;<span class="op" id="1500122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500126">gothrow</span><span class="op" id="1500133">(</span><span class="string" id="1500134">&#34;key&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1500150">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500156">if</span>&nbsp;<span class="ident" id="1500159">t</span><span class="op" id="1500160">.</span><span class="ident" id="1500161">elem</span><span class="op" id="1500165">.</span><span class="ident" id="1500166">size</span>&nbsp;<span class="op" id="1500171">&gt;</span>&nbsp;<span class="ident" id="1500173">maxValueSize</span>&nbsp;<span class="op" id="1500186">&amp;&amp;</span>&nbsp;<span class="op" id="1500189">(</span><span class="op" id="1500190">!</span><span class="ident" id="1500191">t</span><span class="op" id="1500192">.</span><span class="ident" id="1500193">indirectvalue</span>&nbsp;<span class="op" id="1500207">||</span>&nbsp;<span class="ident" id="1500210">t</span><span class="op" id="1500211">.</span><span class="ident" id="1500212">valuesize</span>&nbsp;<span class="op" id="1500222">!=</span>&nbsp;<span class="builtintype" id="1500225">uint8</span><span class="op" id="1500230">(</span><span class="ident" id="1500231">ptrSize</span><span class="op" id="1500238">)</span><span class="op" id="1500239">)</span>&nbsp;<span class="op" id="1500241">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500246">t</span><span class="op" id="1500247">.</span><span class="ident" id="1500248">elem</span><span class="op" id="1500252">.</span><span class="ident" id="1500253">size</span>&nbsp;<span class="op" id="1500258">&lt;=</span>&nbsp;<span class="ident" id="1500261">maxValueSize</span>&nbsp;<span class="op" id="1500274">&amp;&amp;</span>&nbsp;<span class="op" id="1500277">(</span><span class="ident" id="1500278">t</span><span class="op" id="1500279">.</span><span class="ident" id="1500280">indirectvalue</span>&nbsp;<span class="op" id="1500294">||</span>&nbsp;<span class="ident" id="1500297">t</span><span class="op" id="1500298">.</span><span class="ident" id="1500299">valuesize</span>&nbsp;<span class="op" id="1500309">!=</span>&nbsp;<span class="builtintype" id="1500312">uint8</span><span class="op" id="1500317">(</span><span class="ident" id="1500318">t</span><span class="op" id="1500319">.</span><span class="ident" id="1500320">elem</span><span class="op" id="1500324">.</span><span class="ident" id="1500325">size</span><span class="op" id="1500329">)</span><span class="op" id="1500330">)</span>&nbsp;<span class="op" id="1500332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500336">gothrow</span><span class="op" id="1500343">(</span><span class="string" id="1500344">&#34;value&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1500362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500365">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500369">//&nbsp;invariants&nbsp;we&nbsp;depend&nbsp;on.&nbsp;&nbsp;We&nbsp;should&nbsp;probably&nbsp;check&nbsp;these&nbsp;at&nbsp;compile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1500446">//&nbsp;somewhere,&nbsp;but&nbsp;for&nbsp;now&nbsp;we&#39;ll&nbsp;do&nbsp;it&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500491">if</span>&nbsp;<span class="ident" id="1500494">t</span><span class="op" id="1500495">.</span><span class="ident" id="1500496">key</span><span class="op" id="1500499">.</span><span class="ident" id="1500500">align</span>&nbsp;<span class="op" id="1500506">&gt;</span>&nbsp;<span class="ident" id="1500508">bucketCnt</span>&nbsp;<span class="op" id="1500518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500522">gothrow</span><span class="op" id="1500529">(</span><span class="string" id="1500530">&#34;key&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1500549">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500555">if</span>&nbsp;<span class="ident" id="1500558">t</span><span class="op" id="1500559">.</span><span class="ident" id="1500560">elem</span><span class="op" id="1500564">.</span><span class="ident" id="1500565">align</span>&nbsp;<span class="op" id="1500571">&gt;</span>&nbsp;<span class="ident" id="1500573">bucketCnt</span>&nbsp;<span class="op" id="1500583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500587">gothrow</span><span class="op" id="1500594">(</span><span class="string" id="1500595">&#34;value&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1500616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500622">if</span>&nbsp;<span class="builtintype" id="1500625">uintptr</span><span class="op" id="1500632">(</span><span class="ident" id="1500633">t</span><span class="op" id="1500634">.</span><span class="ident" id="1500635">key</span><span class="op" id="1500638">.</span><span class="ident" id="1500639">size</span><span class="op" id="1500643">)</span><span class="op" id="1500644">%</span><span class="builtintype" id="1500645">uintptr</span><span class="op" id="1500652">(</span><span class="ident" id="1500653">t</span><span class="op" id="1500654">.</span><span class="ident" id="1500655">key</span><span class="op" id="1500658">.</span><span class="ident" id="1500659">align</span><span class="op" id="1500664">)</span>&nbsp;<span class="op" id="1500666">!=</span>&nbsp;<span class="num" id="1500669">0</span>&nbsp;<span class="op" id="1500671">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500675">gothrow</span><span class="op" id="1500682">(</span><span class="string" id="1500683">&#34;key&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;key&nbsp;align&#34;</span><span class="op" id="1500721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500727">if</span>&nbsp;<span class="builtintype" id="1500730">uintptr</span><span class="op" id="1500737">(</span><span class="ident" id="1500738">t</span><span class="op" id="1500739">.</span><span class="ident" id="1500740">elem</span><span class="op" id="1500744">.</span><span class="ident" id="1500745">size</span><span class="op" id="1500749">)</span><span class="op" id="1500750">%</span><span class="builtintype" id="1500751">uintptr</span><span class="op" id="1500758">(</span><span class="ident" id="1500759">t</span><span class="op" id="1500760">.</span><span class="ident" id="1500761">elem</span><span class="op" id="1500765">.</span><span class="ident" id="1500766">align</span><span class="op" id="1500771">)</span>&nbsp;<span class="op" id="1500773">!=</span>&nbsp;<span class="num" id="1500776">0</span>&nbsp;<span class="op" id="1500778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500782">gothrow</span><span class="op" id="1500789">(</span><span class="string" id="1500790">&#34;value&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;value&nbsp;align&#34;</span><span class="op" id="1500832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500835">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500838">if</span>&nbsp;<span class="ident" id="1500841">bucketCnt</span>&nbsp;<span class="op" id="1500851">&lt;</span>&nbsp;<span class="num" id="1500853">8</span>&nbsp;<span class="op" id="1500855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500859">gothrow</span><span class="op" id="1500866">(</span><span class="string" id="1500867">&#34;bucketsize&nbsp;too&nbsp;small&nbsp;for&nbsp;proper&nbsp;alignment&#34;</span><span class="op" id="1500910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500916">if</span>&nbsp;<span class="ident" id="1500919">dataOffset</span><span class="op" id="1500929">%</span><span class="builtintype" id="1500930">uintptr</span><span class="op" id="1500937">(</span><span class="ident" id="1500938">t</span><span class="op" id="1500939">.</span><span class="ident" id="1500940">key</span><span class="op" id="1500943">.</span><span class="ident" id="1500944">align</span><span class="op" id="1500949">)</span>&nbsp;<span class="op" id="1500951">!=</span>&nbsp;<span class="num" id="1500954">0</span>&nbsp;<span class="op" id="1500956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500960">gothrow</span><span class="op" id="1500967">(</span><span class="string" id="1500968">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(key)&#34;</span><span class="op" id="1500998">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501004">if</span>&nbsp;<span class="ident" id="1501007">dataOffset</span><span class="op" id="1501017">%</span><span class="builtintype" id="1501018">uintptr</span><span class="op" id="1501025">(</span><span class="ident" id="1501026">t</span><span class="op" id="1501027">.</span><span class="ident" id="1501028">elem</span><span class="op" id="1501032">.</span><span class="ident" id="1501033">align</span><span class="op" id="1501038">)</span>&nbsp;<span class="op" id="1501040">!=</span>&nbsp;<span class="num" id="1501043">0</span>&nbsp;<span class="op" id="1501045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501049">gothrow</span><span class="op" id="1501056">(</span><span class="string" id="1501057">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(value)&#34;</span><span class="op" id="1501089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501096">//&nbsp;find&nbsp;size&nbsp;parameter&nbsp;which&nbsp;will&nbsp;hold&nbsp;the&nbsp;requested&nbsp;#&nbsp;of&nbsp;elements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501164">B</span>&nbsp;<span class="op" id="1501166">:=</span>&nbsp;<span class="builtintype" id="1501169">uint8</span><span class="op" id="1501174">(</span><span class="num" id="1501175">0</span><span class="op" id="1501176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501179">for</span>&nbsp;<span class="op" id="1501183">;</span>&nbsp;<span class="ident" id="1501185">hint</span>&nbsp;<span class="op" id="1501190">&gt;</span>&nbsp;<span class="ident" id="1501192">bucketCnt</span>&nbsp;<span class="op" id="1501202">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1501205">float32</span><span class="op" id="1501212">(</span><span class="ident" id="1501213">hint</span><span class="op" id="1501217">)</span>&nbsp;<span class="op" id="1501219">&gt;</span>&nbsp;<span class="ident" id="1501221">loadFactor</span><span class="op" id="1501231">*</span><span class="builtintype" id="1501232">float32</span><span class="op" id="1501239">(</span><span class="builtintype" id="1501240">uintptr</span><span class="op" id="1501247">(</span><span class="num" id="1501248">1</span><span class="op" id="1501249">)</span><span class="op" id="1501250">&lt;&lt;</span><span class="ident" id="1501252">B</span><span class="op" id="1501253">)</span><span class="op" id="1501254">;</span>&nbsp;<span class="ident" id="1501256">B</span><span class="op" id="1501257">++</span>&nbsp;<span class="op" id="1501260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501267">//&nbsp;allocate&nbsp;initial&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501299">//&nbsp;if&nbsp;B&nbsp;==&nbsp;0,&nbsp;the&nbsp;buckets&nbsp;field&nbsp;is&nbsp;allocated&nbsp;lazily&nbsp;later&nbsp;(in&nbsp;mapassign)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501373">//&nbsp;If&nbsp;hint&nbsp;is&nbsp;large&nbsp;zeroing&nbsp;this&nbsp;memory&nbsp;could&nbsp;take&nbsp;a&nbsp;while.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501434">var</span>&nbsp;<span class="ident" id="1501438">buckets</span>&nbsp;<span class="ident" id="1501446">unsafe</span><span class="op" id="1501452">.</span><span class="ident" id="1501453">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501462">if</span>&nbsp;<span class="ident" id="1501465">B</span>&nbsp;<span class="op" id="1501467">!=</span>&nbsp;<span class="num" id="1501470">0</span>&nbsp;<span class="op" id="1501472">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501476">if</span>&nbsp;<span class="ident" id="1501479">checkgc</span>&nbsp;<span class="op" id="1501487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501492">memstats</span><span class="op" id="1501500">.</span><span class="ident" id="1501501">next_gc</span>&nbsp;<span class="op" id="1501509">=</span>&nbsp;<span class="ident" id="1501511">memstats</span><span class="op" id="1501519">.</span><span class="ident" id="1501520">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501537">buckets</span>&nbsp;<span class="op" id="1501545">=</span>&nbsp;<span class="ident" id="1501547">newarray</span><span class="op" id="1501555">(</span><span class="ident" id="1501556">t</span><span class="op" id="1501557">.</span><span class="ident" id="1501558">bucket</span><span class="op" id="1501564">,</span>&nbsp;<span class="builtintype" id="1501566">uintptr</span><span class="op" id="1501573">(</span><span class="num" id="1501574">1</span><span class="op" id="1501575">)</span><span class="op" id="1501576">&lt;&lt;</span><span class="ident" id="1501578">B</span><span class="op" id="1501579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501582">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501586">//&nbsp;initialize&nbsp;Hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501606">if</span>&nbsp;<span class="ident" id="1501609">checkgc</span>&nbsp;<span class="op" id="1501617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501621">memstats</span><span class="op" id="1501629">.</span><span class="ident" id="1501630">next_gc</span>&nbsp;<span class="op" id="1501638">=</span>&nbsp;<span class="ident" id="1501640">memstats</span><span class="op" id="1501648">.</span><span class="ident" id="1501649">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501661">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501664">h</span>&nbsp;<span class="op" id="1501666">:=</span>&nbsp;<span class="op" id="1501669">(</span><span class="op" id="1501670">*</span><span class="ident" id="1501671">hmap</span><span class="op" id="1501675">)</span><span class="op" id="1501676">(</span><span class="ident" id="1501677">newobject</span><span class="op" id="1501686">(</span><span class="ident" id="1501687">t</span><span class="op" id="1501688">.</span><span class="ident" id="1501689">hmap</span><span class="op" id="1501693">)</span><span class="op" id="1501694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501697">h</span><span class="op" id="1501698">.</span><span class="ident" id="1501699">count</span>&nbsp;<span class="op" id="1501705">=</span>&nbsp;<span class="num" id="1501707">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501710">h</span><span class="op" id="1501711">.</span><span class="ident" id="1501712">B</span>&nbsp;<span class="op" id="1501714">=</span>&nbsp;<span class="ident" id="1501716">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501719">h</span><span class="op" id="1501720">.</span><span class="ident" id="1501721">flags</span>&nbsp;<span class="op" id="1501727">=</span>&nbsp;<span class="num" id="1501729">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501732">h</span><span class="op" id="1501733">.</span><span class="ident" id="1501734">hash0</span>&nbsp;<span class="op" id="1501740">=</span>&nbsp;<span class="ident" id="1501742">fastrand1</span><span class="op" id="1501751">(</span><span class="op" id="1501752">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501755">h</span><span class="op" id="1501756">.</span><span class="ident" id="1501757">buckets</span>&nbsp;<span class="op" id="1501765">=</span>&nbsp;<span class="ident" id="1501767">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501776">h</span><span class="op" id="1501777">.</span><span class="ident" id="1501778">oldbuckets</span>&nbsp;<span class="op" id="1501789">=</span>&nbsp;<span class="builtintype" id="1501791">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501796">h</span><span class="op" id="1501797">.</span><span class="ident" id="1501798">nevacuate</span>&nbsp;<span class="op" id="1501808">=</span>&nbsp;<span class="num" id="1501810">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501814">return</span>&nbsp;<span class="ident" id="1501821">h</span><br>
<span class="lineno">230</span><span class="op" id="1501823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1501826">//&nbsp;mapaccess1&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;h[key].&nbsp;&nbsp;Never&nbsp;returns&nbsp;nil,&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1501897">//&nbsp;it&nbsp;will&nbsp;return&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;zero&nbsp;object&nbsp;for&nbsp;the&nbsp;value&nbsp;type&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="1501968">//&nbsp;the&nbsp;key&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">235</span><span class="comment" id="1501998">//&nbsp;NOTE:&nbsp;The&nbsp;returned&nbsp;pointer&nbsp;may&nbsp;keep&nbsp;the&nbsp;whole&nbsp;map&nbsp;live,&nbsp;so&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1502066">//&nbsp;hold&nbsp;onto&nbsp;it&nbsp;for&nbsp;very&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="1502097">func</span>&nbsp;<span class="ident" id="1502102">mapaccess1</span><span class="op" id="1502112">(</span><span class="ident" id="1502113">t</span>&nbsp;<span class="op" id="1502115">*</span><span class="ident" id="1502116">maptype</span><span class="op" id="1502123">,</span>&nbsp;<span class="ident" id="1502125">h</span>&nbsp;<span class="op" id="1502127">*</span><span class="ident" id="1502128">hmap</span><span class="op" id="1502132">,</span>&nbsp;<span class="ident" id="1502134">key</span>&nbsp;<span class="ident" id="1502138">unsafe</span><span class="op" id="1502144">.</span><span class="ident" id="1502145">Pointer</span><span class="op" id="1502152">)</span>&nbsp;<span class="ident" id="1502154">unsafe</span><span class="op" id="1502160">.</span><span class="ident" id="1502161">Pointer</span>&nbsp;<span class="op" id="1502169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502172">if</span>&nbsp;<span class="ident" id="1502175">raceenabled</span>&nbsp;<span class="op" id="1502187">&amp;&amp;</span>&nbsp;<span class="ident" id="1502190">h</span>&nbsp;<span class="op" id="1502192">!=</span>&nbsp;<span class="builtintype" id="1502195">nil</span>&nbsp;<span class="op" id="1502199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502203">callerpc</span>&nbsp;<span class="op" id="1502212">:=</span>&nbsp;<span class="ident" id="1502215">getcallerpc</span><span class="op" id="1502226">(</span><span class="ident" id="1502227">unsafe</span><span class="op" id="1502233">.</span><span class="ident" id="1502234">Pointer</span><span class="op" id="1502241">(</span><span class="op" id="1502242">&amp;</span><span class="ident" id="1502243">t</span><span class="op" id="1502244">)</span><span class="op" id="1502245">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502249">pc</span>&nbsp;<span class="op" id="1502252">:=</span>&nbsp;<span class="ident" id="1502255">funcPC</span><span class="op" id="1502261">(</span><span class="ident" id="1502262">mapaccess1</span><span class="op" id="1502272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502276">racereadpc</span><span class="op" id="1502286">(</span><span class="ident" id="1502287">unsafe</span><span class="op" id="1502293">.</span><span class="ident" id="1502294">Pointer</span><span class="op" id="1502301">(</span><span class="ident" id="1502302">h</span><span class="op" id="1502303">)</span><span class="op" id="1502304">,</span>&nbsp;<span class="ident" id="1502306">callerpc</span><span class="op" id="1502314">,</span>&nbsp;<span class="ident" id="1502316">pc</span><span class="op" id="1502318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502322">raceReadObjectPC</span><span class="op" id="1502338">(</span><span class="ident" id="1502339">t</span><span class="op" id="1502340">.</span><span class="ident" id="1502341">key</span><span class="op" id="1502344">,</span>&nbsp;<span class="ident" id="1502346">key</span><span class="op" id="1502349">,</span>&nbsp;<span class="ident" id="1502351">callerpc</span><span class="op" id="1502359">,</span>&nbsp;<span class="ident" id="1502361">pc</span><span class="op" id="1502363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502369">if</span>&nbsp;<span class="ident" id="1502372">h</span>&nbsp;<span class="op" id="1502374">==</span>&nbsp;<span class="builtintype" id="1502377">nil</span>&nbsp;<span class="op" id="1502381">||</span>&nbsp;<span class="ident" id="1502384">h</span><span class="op" id="1502385">.</span><span class="ident" id="1502386">count</span>&nbsp;<span class="op" id="1502392">==</span>&nbsp;<span class="num" id="1502395">0</span>&nbsp;<span class="op" id="1502397">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502401">return</span>&nbsp;<span class="ident" id="1502408">unsafe</span><span class="op" id="1502414">.</span><span class="ident" id="1502415">Pointer</span><span class="op" id="1502422">(</span><span class="ident" id="1502423">t</span><span class="op" id="1502424">.</span><span class="ident" id="1502425">elem</span><span class="op" id="1502429">.</span><span class="ident" id="1502430">zero</span><span class="op" id="1502434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502440">alg</span>&nbsp;<span class="op" id="1502444">:=</span>&nbsp;<span class="ident" id="1502447">goalg</span><span class="op" id="1502452">(</span><span class="ident" id="1502453">t</span><span class="op" id="1502454">.</span><span class="ident" id="1502455">key</span><span class="op" id="1502458">.</span><span class="ident" id="1502459">alg</span><span class="op" id="1502462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502465">hash</span>&nbsp;<span class="op" id="1502470">:=</span>&nbsp;<span class="ident" id="1502473">alg</span><span class="op" id="1502476">.</span><span class="ident" id="1502477">hash</span><span class="op" id="1502481">(</span><span class="ident" id="1502482">key</span><span class="op" id="1502485">,</span>&nbsp;<span class="builtintype" id="1502487">uintptr</span><span class="op" id="1502494">(</span><span class="ident" id="1502495">t</span><span class="op" id="1502496">.</span><span class="ident" id="1502497">key</span><span class="op" id="1502500">.</span><span class="ident" id="1502501">size</span><span class="op" id="1502505">)</span><span class="op" id="1502506">,</span>&nbsp;<span class="builtintype" id="1502508">uintptr</span><span class="op" id="1502515">(</span><span class="ident" id="1502516">h</span><span class="op" id="1502517">.</span><span class="ident" id="1502518">hash0</span><span class="op" id="1502523">)</span><span class="op" id="1502524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502527">m</span>&nbsp;<span class="op" id="1502529">:=</span>&nbsp;<span class="builtintype" id="1502532">uintptr</span><span class="op" id="1502539">(</span><span class="num" id="1502540">1</span><span class="op" id="1502541">)</span><span class="op" id="1502542">&lt;&lt;</span><span class="ident" id="1502544">h</span><span class="op" id="1502545">.</span><span class="ident" id="1502546">B</span>&nbsp;<span class="op" id="1502548">-</span>&nbsp;<span class="num" id="1502550">1</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502553">b</span>&nbsp;<span class="op" id="1502555">:=</span>&nbsp;<span class="op" id="1502558">(</span><span class="op" id="1502559">*</span><span class="ident" id="1502560">bmap</span><span class="op" id="1502564">)</span><span class="op" id="1502565">(</span><span class="ident" id="1502566">add</span><span class="op" id="1502569">(</span><span class="ident" id="1502570">h</span><span class="op" id="1502571">.</span><span class="ident" id="1502572">buckets</span><span class="op" id="1502579">,</span>&nbsp;<span class="op" id="1502581">(</span><span class="ident" id="1502582">hash</span><span class="op" id="1502586">&amp;</span><span class="ident" id="1502587">m</span><span class="op" id="1502588">)</span><span class="op" id="1502589">*</span><span class="builtintype" id="1502590">uintptr</span><span class="op" id="1502597">(</span><span class="ident" id="1502598">t</span><span class="op" id="1502599">.</span><span class="ident" id="1502600">bucketsize</span><span class="op" id="1502610">)</span><span class="op" id="1502611">)</span><span class="op" id="1502612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502615">if</span>&nbsp;<span class="ident" id="1502618">c</span>&nbsp;<span class="op" id="1502620">:=</span>&nbsp;<span class="ident" id="1502623">h</span><span class="op" id="1502624">.</span><span class="ident" id="1502625">oldbuckets</span><span class="op" id="1502635">;</span>&nbsp;<span class="ident" id="1502637">c</span>&nbsp;<span class="op" id="1502639">!=</span>&nbsp;<span class="builtintype" id="1502642">nil</span>&nbsp;<span class="op" id="1502646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502650">oldb</span>&nbsp;<span class="op" id="1502655">:=</span>&nbsp;<span class="op" id="1502658">(</span><span class="op" id="1502659">*</span><span class="ident" id="1502660">bmap</span><span class="op" id="1502664">)</span><span class="op" id="1502665">(</span><span class="ident" id="1502666">add</span><span class="op" id="1502669">(</span><span class="ident" id="1502670">c</span><span class="op" id="1502671">,</span>&nbsp;<span class="op" id="1502673">(</span><span class="ident" id="1502674">hash</span><span class="op" id="1502678">&amp;</span><span class="op" id="1502679">(</span><span class="ident" id="1502680">m</span><span class="op" id="1502681">&gt;&gt;</span><span class="num" id="1502683">1</span><span class="op" id="1502684">)</span><span class="op" id="1502685">)</span><span class="op" id="1502686">*</span><span class="builtintype" id="1502687">uintptr</span><span class="op" id="1502694">(</span><span class="ident" id="1502695">t</span><span class="op" id="1502696">.</span><span class="ident" id="1502697">bucketsize</span><span class="op" id="1502707">)</span><span class="op" id="1502708">)</span><span class="op" id="1502709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502713">if</span>&nbsp;<span class="op" id="1502716">!</span><span class="ident" id="1502717">evacuated</span><span class="op" id="1502726">(</span><span class="ident" id="1502727">oldb</span><span class="op" id="1502731">)</span>&nbsp;<span class="op" id="1502733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502738">b</span>&nbsp;<span class="op" id="1502740">=</span>&nbsp;<span class="ident" id="1502742">oldb</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502755">top</span>&nbsp;<span class="op" id="1502759">:=</span>&nbsp;<span class="builtintype" id="1502762">uint8</span><span class="op" id="1502767">(</span><span class="ident" id="1502768">hash</span>&nbsp;<span class="op" id="1502773">&gt;&gt;</span>&nbsp;<span class="op" id="1502776">(</span><span class="ident" id="1502777">ptrSize</span><span class="op" id="1502784">*</span><span class="num" id="1502785">8</span>&nbsp;<span class="op" id="1502787">-</span>&nbsp;<span class="num" id="1502789">8</span><span class="op" id="1502790">)</span><span class="op" id="1502791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502794">if</span>&nbsp;<span class="ident" id="1502797">top</span>&nbsp;<span class="op" id="1502801">&lt;</span>&nbsp;<span class="ident" id="1502803">minTopHash</span>&nbsp;<span class="op" id="1502814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502818">top</span>&nbsp;<span class="op" id="1502822">+=</span>&nbsp;<span class="ident" id="1502825">minTopHash</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502840">for</span>&nbsp;<span class="op" id="1502844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502848">for</span>&nbsp;<span class="ident" id="1502852">i</span>&nbsp;<span class="op" id="1502854">:=</span>&nbsp;<span class="builtintype" id="1502857">uintptr</span><span class="op" id="1502864">(</span><span class="num" id="1502865">0</span><span class="op" id="1502866">)</span><span class="op" id="1502867">;</span>&nbsp;<span class="ident" id="1502869">i</span>&nbsp;<span class="op" id="1502871">&lt;</span>&nbsp;<span class="ident" id="1502873">bucketCnt</span><span class="op" id="1502882">;</span>&nbsp;<span class="ident" id="1502884">i</span><span class="op" id="1502885">++</span>&nbsp;<span class="op" id="1502888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502893">if</span>&nbsp;<span class="ident" id="1502896">b</span><span class="op" id="1502897">.</span><span class="ident" id="1502898">tophash</span><span class="op" id="1502905">[</span><span class="ident" id="1502906">i</span><span class="op" id="1502907">]</span>&nbsp;<span class="op" id="1502909">!=</span>&nbsp;<span class="ident" id="1502912">top</span>&nbsp;<span class="op" id="1502916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502922">continue</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502939">k</span>&nbsp;<span class="op" id="1502941">:=</span>&nbsp;<span class="ident" id="1502944">add</span><span class="op" id="1502947">(</span><span class="ident" id="1502948">unsafe</span><span class="op" id="1502954">.</span><span class="ident" id="1502955">Pointer</span><span class="op" id="1502962">(</span><span class="ident" id="1502963">b</span><span class="op" id="1502964">)</span><span class="op" id="1502965">,</span>&nbsp;<span class="ident" id="1502967">dataOffset</span><span class="op" id="1502977">+</span><span class="ident" id="1502978">i</span><span class="op" id="1502979">*</span><span class="builtintype" id="1502980">uintptr</span><span class="op" id="1502987">(</span><span class="ident" id="1502988">t</span><span class="op" id="1502989">.</span><span class="ident" id="1502990">keysize</span><span class="op" id="1502997">)</span><span class="op" id="1502998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503003">if</span>&nbsp;<span class="ident" id="1503006">t</span><span class="op" id="1503007">.</span><span class="ident" id="1503008">indirectkey</span>&nbsp;<span class="op" id="1503020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503026">k</span>&nbsp;<span class="op" id="1503028">=</span>&nbsp;<span class="op" id="1503030">*</span><span class="op" id="1503031">(</span><span class="op" id="1503032">(</span><span class="op" id="1503033">*</span><span class="ident" id="1503034">unsafe</span><span class="op" id="1503040">.</span><span class="ident" id="1503041">Pointer</span><span class="op" id="1503048">)</span><span class="op" id="1503049">(</span><span class="ident" id="1503050">k</span><span class="op" id="1503051">)</span><span class="op" id="1503052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1503057">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503062">if</span>&nbsp;<span class="ident" id="1503065">alg</span><span class="op" id="1503068">.</span><span class="ident" id="1503069">equal</span><span class="op" id="1503074">(</span><span class="ident" id="1503075">key</span><span class="op" id="1503078">,</span>&nbsp;<span class="ident" id="1503080">k</span><span class="op" id="1503081">,</span>&nbsp;<span class="builtintype" id="1503083">uintptr</span><span class="op" id="1503090">(</span><span class="ident" id="1503091">t</span><span class="op" id="1503092">.</span><span class="ident" id="1503093">key</span><span class="op" id="1503096">.</span><span class="ident" id="1503097">size</span><span class="op" id="1503101">)</span><span class="op" id="1503102">)</span>&nbsp;<span class="op" id="1503104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503110">v</span>&nbsp;<span class="op" id="1503112">:=</span>&nbsp;<span class="ident" id="1503115">add</span><span class="op" id="1503118">(</span><span class="ident" id="1503119">unsafe</span><span class="op" id="1503125">.</span><span class="ident" id="1503126">Pointer</span><span class="op" id="1503133">(</span><span class="ident" id="1503134">b</span><span class="op" id="1503135">)</span><span class="op" id="1503136">,</span>&nbsp;<span class="ident" id="1503138">dataOffset</span><span class="op" id="1503148">+</span><span class="ident" id="1503149">bucketCnt</span><span class="op" id="1503158">*</span><span class="builtintype" id="1503159">uintptr</span><span class="op" id="1503166">(</span><span class="ident" id="1503167">t</span><span class="op" id="1503168">.</span><span class="ident" id="1503169">keysize</span><span class="op" id="1503176">)</span><span class="op" id="1503177">+</span><span class="ident" id="1503178">i</span><span class="op" id="1503179">*</span><span class="builtintype" id="1503180">uintptr</span><span class="op" id="1503187">(</span><span class="ident" id="1503188">t</span><span class="op" id="1503189">.</span><span class="ident" id="1503190">valuesize</span><span class="op" id="1503199">)</span><span class="op" id="1503200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503206">if</span>&nbsp;<span class="ident" id="1503209">t</span><span class="op" id="1503210">.</span><span class="ident" id="1503211">indirectvalue</span>&nbsp;<span class="op" id="1503225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503232">v</span>&nbsp;<span class="op" id="1503234">=</span>&nbsp;<span class="op" id="1503236">*</span><span class="op" id="1503237">(</span><span class="op" id="1503238">(</span><span class="op" id="1503239">*</span><span class="ident" id="1503240">unsafe</span><span class="op" id="1503246">.</span><span class="ident" id="1503247">Pointer</span><span class="op" id="1503254">)</span><span class="op" id="1503255">(</span><span class="ident" id="1503256">v</span><span class="op" id="1503257">)</span><span class="op" id="1503258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1503264">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503270">return</span>&nbsp;<span class="ident" id="1503277">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1503282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1503286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503290">b</span>&nbsp;<span class="op" id="1503292">=</span>&nbsp;<span class="ident" id="1503294">b</span><span class="op" id="1503295">.</span><span class="ident" id="1503296">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503307">if</span>&nbsp;<span class="ident" id="1503310">b</span>&nbsp;<span class="op" id="1503312">==</span>&nbsp;<span class="builtintype" id="1503315">nil</span>&nbsp;<span class="op" id="1503319">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503324">return</span>&nbsp;<span class="ident" id="1503331">unsafe</span><span class="op" id="1503337">.</span><span class="ident" id="1503338">Pointer</span><span class="op" id="1503345">(</span><span class="ident" id="1503346">t</span><span class="op" id="1503347">.</span><span class="ident" id="1503348">elem</span><span class="op" id="1503352">.</span><span class="ident" id="1503353">zero</span><span class="op" id="1503357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1503361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1503364">}</span><br>
<span class="lineno"></span><span class="op" id="1503366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="1503369">func</span>&nbsp;<span class="ident" id="1503374">mapaccess2</span><span class="op" id="1503384">(</span><span class="ident" id="1503385">t</span>&nbsp;<span class="op" id="1503387">*</span><span class="ident" id="1503388">maptype</span><span class="op" id="1503395">,</span>&nbsp;<span class="ident" id="1503397">h</span>&nbsp;<span class="op" id="1503399">*</span><span class="ident" id="1503400">hmap</span><span class="op" id="1503404">,</span>&nbsp;<span class="ident" id="1503406">key</span>&nbsp;<span class="ident" id="1503410">unsafe</span><span class="op" id="1503416">.</span><span class="ident" id="1503417">Pointer</span><span class="op" id="1503424">)</span>&nbsp;<span class="op" id="1503426">(</span><span class="ident" id="1503427">unsafe</span><span class="op" id="1503433">.</span><span class="ident" id="1503434">Pointer</span><span class="op" id="1503441">,</span>&nbsp;<span class="builtintype" id="1503443">bool</span><span class="op" id="1503447">)</span>&nbsp;<span class="op" id="1503449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503452">if</span>&nbsp;<span class="ident" id="1503455">raceenabled</span>&nbsp;<span class="op" id="1503467">&amp;&amp;</span>&nbsp;<span class="ident" id="1503470">h</span>&nbsp;<span class="op" id="1503472">!=</span>&nbsp;<span class="builtintype" id="1503475">nil</span>&nbsp;<span class="op" id="1503479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503483">callerpc</span>&nbsp;<span class="op" id="1503492">:=</span>&nbsp;<span class="ident" id="1503495">getcallerpc</span><span class="op" id="1503506">(</span><span class="ident" id="1503507">unsafe</span><span class="op" id="1503513">.</span><span class="ident" id="1503514">Pointer</span><span class="op" id="1503521">(</span><span class="op" id="1503522">&amp;</span><span class="ident" id="1503523">t</span><span class="op" id="1503524">)</span><span class="op" id="1503525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503529">pc</span>&nbsp;<span class="op" id="1503532">:=</span>&nbsp;<span class="ident" id="1503535">funcPC</span><span class="op" id="1503541">(</span><span class="ident" id="1503542">mapaccess2</span><span class="op" id="1503552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503556">racereadpc</span><span class="op" id="1503566">(</span><span class="ident" id="1503567">unsafe</span><span class="op" id="1503573">.</span><span class="ident" id="1503574">Pointer</span><span class="op" id="1503581">(</span><span class="ident" id="1503582">h</span><span class="op" id="1503583">)</span><span class="op" id="1503584">,</span>&nbsp;<span class="ident" id="1503586">callerpc</span><span class="op" id="1503594">,</span>&nbsp;<span class="ident" id="1503596">pc</span><span class="op" id="1503598">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503602">raceReadObjectPC</span><span class="op" id="1503618">(</span><span class="ident" id="1503619">t</span><span class="op" id="1503620">.</span><span class="ident" id="1503621">key</span><span class="op" id="1503624">,</span>&nbsp;<span class="ident" id="1503626">key</span><span class="op" id="1503629">,</span>&nbsp;<span class="ident" id="1503631">callerpc</span><span class="op" id="1503639">,</span>&nbsp;<span class="ident" id="1503641">pc</span><span class="op" id="1503643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1503646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503649">if</span>&nbsp;<span class="ident" id="1503652">h</span>&nbsp;<span class="op" id="1503654">==</span>&nbsp;<span class="builtintype" id="1503657">nil</span>&nbsp;<span class="op" id="1503661">||</span>&nbsp;<span class="ident" id="1503664">h</span><span class="op" id="1503665">.</span><span class="ident" id="1503666">count</span>&nbsp;<span class="op" id="1503672">==</span>&nbsp;<span class="num" id="1503675">0</span>&nbsp;<span class="op" id="1503677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503681">return</span>&nbsp;<span class="ident" id="1503688">unsafe</span><span class="op" id="1503694">.</span><span class="ident" id="1503695">Pointer</span><span class="op" id="1503702">(</span><span class="ident" id="1503703">t</span><span class="op" id="1503704">.</span><span class="ident" id="1503705">elem</span><span class="op" id="1503709">.</span><span class="ident" id="1503710">zero</span><span class="op" id="1503714">)</span><span class="op" id="1503715">,</span>&nbsp;<span class="builtintype" id="1503717">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1503724">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503727">alg</span>&nbsp;<span class="op" id="1503731">:=</span>&nbsp;<span class="ident" id="1503734">goalg</span><span class="op" id="1503739">(</span><span class="ident" id="1503740">t</span><span class="op" id="1503741">.</span><span class="ident" id="1503742">key</span><span class="op" id="1503745">.</span><span class="ident" id="1503746">alg</span><span class="op" id="1503749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503752">hash</span>&nbsp;<span class="op" id="1503757">:=</span>&nbsp;<span class="ident" id="1503760">alg</span><span class="op" id="1503763">.</span><span class="ident" id="1503764">hash</span><span class="op" id="1503768">(</span><span class="ident" id="1503769">key</span><span class="op" id="1503772">,</span>&nbsp;<span class="builtintype" id="1503774">uintptr</span><span class="op" id="1503781">(</span><span class="ident" id="1503782">t</span><span class="op" id="1503783">.</span><span class="ident" id="1503784">key</span><span class="op" id="1503787">.</span><span class="ident" id="1503788">size</span><span class="op" id="1503792">)</span><span class="op" id="1503793">,</span>&nbsp;<span class="builtintype" id="1503795">uintptr</span><span class="op" id="1503802">(</span><span class="ident" id="1503803">h</span><span class="op" id="1503804">.</span><span class="ident" id="1503805">hash0</span><span class="op" id="1503810">)</span><span class="op" id="1503811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503814">m</span>&nbsp;<span class="op" id="1503816">:=</span>&nbsp;<span class="builtintype" id="1503819">uintptr</span><span class="op" id="1503826">(</span><span class="num" id="1503827">1</span><span class="op" id="1503828">)</span><span class="op" id="1503829">&lt;&lt;</span><span class="ident" id="1503831">h</span><span class="op" id="1503832">.</span><span class="ident" id="1503833">B</span>&nbsp;<span class="op" id="1503835">-</span>&nbsp;<span class="num" id="1503837">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503840">b</span>&nbsp;<span class="op" id="1503842">:=</span>&nbsp;<span class="op" id="1503845">(</span><span class="op" id="1503846">*</span><span class="ident" id="1503847">bmap</span><span class="op" id="1503851">)</span><span class="op" id="1503852">(</span><span class="ident" id="1503853">unsafe</span><span class="op" id="1503859">.</span><span class="ident" id="1503860">Pointer</span><span class="op" id="1503867">(</span><span class="builtintype" id="1503868">uintptr</span><span class="op" id="1503875">(</span><span class="ident" id="1503876">h</span><span class="op" id="1503877">.</span><span class="ident" id="1503878">buckets</span><span class="op" id="1503885">)</span>&nbsp;<span class="op" id="1503887">+</span>&nbsp;<span class="op" id="1503889">(</span><span class="ident" id="1503890">hash</span><span class="op" id="1503894">&amp;</span><span class="ident" id="1503895">m</span><span class="op" id="1503896">)</span><span class="op" id="1503897">*</span><span class="builtintype" id="1503898">uintptr</span><span class="op" id="1503905">(</span><span class="ident" id="1503906">t</span><span class="op" id="1503907">.</span><span class="ident" id="1503908">bucketsize</span><span class="op" id="1503918">)</span><span class="op" id="1503919">)</span><span class="op" id="1503920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503923">if</span>&nbsp;<span class="ident" id="1503926">c</span>&nbsp;<span class="op" id="1503928">:=</span>&nbsp;<span class="ident" id="1503931">h</span><span class="op" id="1503932">.</span><span class="ident" id="1503933">oldbuckets</span><span class="op" id="1503943">;</span>&nbsp;<span class="ident" id="1503945">c</span>&nbsp;<span class="op" id="1503947">!=</span>&nbsp;<span class="builtintype" id="1503950">nil</span>&nbsp;<span class="op" id="1503954">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1503958">oldb</span>&nbsp;<span class="op" id="1503963">:=</span>&nbsp;<span class="op" id="1503966">(</span><span class="op" id="1503967">*</span><span class="ident" id="1503968">bmap</span><span class="op" id="1503972">)</span><span class="op" id="1503973">(</span><span class="ident" id="1503974">unsafe</span><span class="op" id="1503980">.</span><span class="ident" id="1503981">Pointer</span><span class="op" id="1503988">(</span><span class="builtintype" id="1503989">uintptr</span><span class="op" id="1503996">(</span><span class="ident" id="1503997">c</span><span class="op" id="1503998">)</span>&nbsp;<span class="op" id="1504000">+</span>&nbsp;<span class="op" id="1504002">(</span><span class="ident" id="1504003">hash</span><span class="op" id="1504007">&amp;</span><span class="op" id="1504008">(</span><span class="ident" id="1504009">m</span><span class="op" id="1504010">&gt;&gt;</span><span class="num" id="1504012">1</span><span class="op" id="1504013">)</span><span class="op" id="1504014">)</span><span class="op" id="1504015">*</span><span class="builtintype" id="1504016">uintptr</span><span class="op" id="1504023">(</span><span class="ident" id="1504024">t</span><span class="op" id="1504025">.</span><span class="ident" id="1504026">bucketsize</span><span class="op" id="1504036">)</span><span class="op" id="1504037">)</span><span class="op" id="1504038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504042">if</span>&nbsp;<span class="op" id="1504045">!</span><span class="ident" id="1504046">evacuated</span><span class="op" id="1504055">(</span><span class="ident" id="1504056">oldb</span><span class="op" id="1504060">)</span>&nbsp;<span class="op" id="1504062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504067">b</span>&nbsp;<span class="op" id="1504069">=</span>&nbsp;<span class="ident" id="1504071">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504081">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504084">top</span>&nbsp;<span class="op" id="1504088">:=</span>&nbsp;<span class="builtintype" id="1504091">uint8</span><span class="op" id="1504096">(</span><span class="ident" id="1504097">hash</span>&nbsp;<span class="op" id="1504102">&gt;&gt;</span>&nbsp;<span class="op" id="1504105">(</span><span class="ident" id="1504106">ptrSize</span><span class="op" id="1504113">*</span><span class="num" id="1504114">8</span>&nbsp;<span class="op" id="1504116">-</span>&nbsp;<span class="num" id="1504118">8</span><span class="op" id="1504119">)</span><span class="op" id="1504120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504123">if</span>&nbsp;<span class="ident" id="1504126">top</span>&nbsp;<span class="op" id="1504130">&lt;</span>&nbsp;<span class="ident" id="1504132">minTopHash</span>&nbsp;<span class="op" id="1504143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504147">top</span>&nbsp;<span class="op" id="1504151">+=</span>&nbsp;<span class="ident" id="1504154">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504169">for</span>&nbsp;<span class="op" id="1504173">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504177">for</span>&nbsp;<span class="ident" id="1504181">i</span>&nbsp;<span class="op" id="1504183">:=</span>&nbsp;<span class="builtintype" id="1504186">uintptr</span><span class="op" id="1504193">(</span><span class="num" id="1504194">0</span><span class="op" id="1504195">)</span><span class="op" id="1504196">;</span>&nbsp;<span class="ident" id="1504198">i</span>&nbsp;<span class="op" id="1504200">&lt;</span>&nbsp;<span class="ident" id="1504202">bucketCnt</span><span class="op" id="1504211">;</span>&nbsp;<span class="ident" id="1504213">i</span><span class="op" id="1504214">++</span>&nbsp;<span class="op" id="1504217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504222">if</span>&nbsp;<span class="ident" id="1504225">b</span><span class="op" id="1504226">.</span><span class="ident" id="1504227">tophash</span><span class="op" id="1504234">[</span><span class="ident" id="1504235">i</span><span class="op" id="1504236">]</span>&nbsp;<span class="op" id="1504238">!=</span>&nbsp;<span class="ident" id="1504241">top</span>&nbsp;<span class="op" id="1504245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504251">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504268">k</span>&nbsp;<span class="op" id="1504270">:=</span>&nbsp;<span class="ident" id="1504273">add</span><span class="op" id="1504276">(</span><span class="ident" id="1504277">unsafe</span><span class="op" id="1504283">.</span><span class="ident" id="1504284">Pointer</span><span class="op" id="1504291">(</span><span class="ident" id="1504292">b</span><span class="op" id="1504293">)</span><span class="op" id="1504294">,</span>&nbsp;<span class="ident" id="1504296">dataOffset</span><span class="op" id="1504306">+</span><span class="ident" id="1504307">i</span><span class="op" id="1504308">*</span><span class="builtintype" id="1504309">uintptr</span><span class="op" id="1504316">(</span><span class="ident" id="1504317">t</span><span class="op" id="1504318">.</span><span class="ident" id="1504319">keysize</span><span class="op" id="1504326">)</span><span class="op" id="1504327">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504332">if</span>&nbsp;<span class="ident" id="1504335">t</span><span class="op" id="1504336">.</span><span class="ident" id="1504337">indirectkey</span>&nbsp;<span class="op" id="1504349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504355">k</span>&nbsp;<span class="op" id="1504357">=</span>&nbsp;<span class="op" id="1504359">*</span><span class="op" id="1504360">(</span><span class="op" id="1504361">(</span><span class="op" id="1504362">*</span><span class="ident" id="1504363">unsafe</span><span class="op" id="1504369">.</span><span class="ident" id="1504370">Pointer</span><span class="op" id="1504377">)</span><span class="op" id="1504378">(</span><span class="ident" id="1504379">k</span><span class="op" id="1504380">)</span><span class="op" id="1504381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504391">if</span>&nbsp;<span class="ident" id="1504394">alg</span><span class="op" id="1504397">.</span><span class="ident" id="1504398">equal</span><span class="op" id="1504403">(</span><span class="ident" id="1504404">key</span><span class="op" id="1504407">,</span>&nbsp;<span class="ident" id="1504409">k</span><span class="op" id="1504410">,</span>&nbsp;<span class="builtintype" id="1504412">uintptr</span><span class="op" id="1504419">(</span><span class="ident" id="1504420">t</span><span class="op" id="1504421">.</span><span class="ident" id="1504422">key</span><span class="op" id="1504425">.</span><span class="ident" id="1504426">size</span><span class="op" id="1504430">)</span><span class="op" id="1504431">)</span>&nbsp;<span class="op" id="1504433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504439">v</span>&nbsp;<span class="op" id="1504441">:=</span>&nbsp;<span class="ident" id="1504444">add</span><span class="op" id="1504447">(</span><span class="ident" id="1504448">unsafe</span><span class="op" id="1504454">.</span><span class="ident" id="1504455">Pointer</span><span class="op" id="1504462">(</span><span class="ident" id="1504463">b</span><span class="op" id="1504464">)</span><span class="op" id="1504465">,</span>&nbsp;<span class="ident" id="1504467">dataOffset</span><span class="op" id="1504477">+</span><span class="ident" id="1504478">bucketCnt</span><span class="op" id="1504487">*</span><span class="builtintype" id="1504488">uintptr</span><span class="op" id="1504495">(</span><span class="ident" id="1504496">t</span><span class="op" id="1504497">.</span><span class="ident" id="1504498">keysize</span><span class="op" id="1504505">)</span><span class="op" id="1504506">+</span><span class="ident" id="1504507">i</span><span class="op" id="1504508">*</span><span class="builtintype" id="1504509">uintptr</span><span class="op" id="1504516">(</span><span class="ident" id="1504517">t</span><span class="op" id="1504518">.</span><span class="ident" id="1504519">valuesize</span><span class="op" id="1504528">)</span><span class="op" id="1504529">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504535">if</span>&nbsp;<span class="ident" id="1504538">t</span><span class="op" id="1504539">.</span><span class="ident" id="1504540">indirectvalue</span>&nbsp;<span class="op" id="1504554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504561">v</span>&nbsp;<span class="op" id="1504563">=</span>&nbsp;<span class="op" id="1504565">*</span><span class="op" id="1504566">(</span><span class="op" id="1504567">(</span><span class="op" id="1504568">*</span><span class="ident" id="1504569">unsafe</span><span class="op" id="1504575">.</span><span class="ident" id="1504576">Pointer</span><span class="op" id="1504583">)</span><span class="op" id="1504584">(</span><span class="ident" id="1504585">v</span><span class="op" id="1504586">)</span><span class="op" id="1504587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504599">return</span>&nbsp;<span class="ident" id="1504606">v</span><span class="op" id="1504607">,</span>&nbsp;<span class="builtintype" id="1504609">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504617">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504625">b</span>&nbsp;<span class="op" id="1504627">=</span>&nbsp;<span class="ident" id="1504629">b</span><span class="op" id="1504630">.</span><span class="ident" id="1504631">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504642">if</span>&nbsp;<span class="ident" id="1504645">b</span>&nbsp;<span class="op" id="1504647">==</span>&nbsp;<span class="builtintype" id="1504650">nil</span>&nbsp;<span class="op" id="1504654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504659">return</span>&nbsp;<span class="ident" id="1504666">unsafe</span><span class="op" id="1504672">.</span><span class="ident" id="1504673">Pointer</span><span class="op" id="1504680">(</span><span class="ident" id="1504681">t</span><span class="op" id="1504682">.</span><span class="ident" id="1504683">elem</span><span class="op" id="1504687">.</span><span class="ident" id="1504688">zero</span><span class="op" id="1504692">)</span><span class="op" id="1504693">,</span>&nbsp;<span class="builtintype" id="1504695">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504703">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504706">}</span><br>
<span class="lineno"></span><span class="op" id="1504708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1504711">//&nbsp;returns&nbsp;both&nbsp;key&nbsp;and&nbsp;value.&nbsp;&nbsp;Used&nbsp;by&nbsp;map&nbsp;iterator</span><br>
<span class="lineno"></span><span class="keyword" id="1504764">func</span>&nbsp;<span class="ident" id="1504769">mapaccessK</span><span class="op" id="1504779">(</span><span class="ident" id="1504780">t</span>&nbsp;<span class="op" id="1504782">*</span><span class="ident" id="1504783">maptype</span><span class="op" id="1504790">,</span>&nbsp;<span class="ident" id="1504792">h</span>&nbsp;<span class="op" id="1504794">*</span><span class="ident" id="1504795">hmap</span><span class="op" id="1504799">,</span>&nbsp;<span class="ident" id="1504801">key</span>&nbsp;<span class="ident" id="1504805">unsafe</span><span class="op" id="1504811">.</span><span class="ident" id="1504812">Pointer</span><span class="op" id="1504819">)</span>&nbsp;<span class="op" id="1504821">(</span><span class="ident" id="1504822">unsafe</span><span class="op" id="1504828">.</span><span class="ident" id="1504829">Pointer</span><span class="op" id="1504836">,</span>&nbsp;<span class="ident" id="1504838">unsafe</span><span class="op" id="1504844">.</span><span class="ident" id="1504845">Pointer</span><span class="op" id="1504852">)</span>&nbsp;<span class="op" id="1504854">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504857">if</span>&nbsp;<span class="ident" id="1504860">h</span>&nbsp;<span class="op" id="1504862">==</span>&nbsp;<span class="builtintype" id="1504865">nil</span>&nbsp;<span class="op" id="1504869">||</span>&nbsp;<span class="ident" id="1504872">h</span><span class="op" id="1504873">.</span><span class="ident" id="1504874">count</span>&nbsp;<span class="op" id="1504880">==</span>&nbsp;<span class="num" id="1504883">0</span>&nbsp;<span class="op" id="1504885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504889">return</span>&nbsp;<span class="builtintype" id="1504896">nil</span><span class="op" id="1504899">,</span>&nbsp;<span class="builtintype" id="1504901">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504909">alg</span>&nbsp;<span class="op" id="1504913">:=</span>&nbsp;<span class="ident" id="1504916">goalg</span><span class="op" id="1504921">(</span><span class="ident" id="1504922">t</span><span class="op" id="1504923">.</span><span class="ident" id="1504924">key</span><span class="op" id="1504927">.</span><span class="ident" id="1504928">alg</span><span class="op" id="1504931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504934">hash</span>&nbsp;<span class="op" id="1504939">:=</span>&nbsp;<span class="ident" id="1504942">alg</span><span class="op" id="1504945">.</span><span class="ident" id="1504946">hash</span><span class="op" id="1504950">(</span><span class="ident" id="1504951">key</span><span class="op" id="1504954">,</span>&nbsp;<span class="builtintype" id="1504956">uintptr</span><span class="op" id="1504963">(</span><span class="ident" id="1504964">t</span><span class="op" id="1504965">.</span><span class="ident" id="1504966">key</span><span class="op" id="1504969">.</span><span class="ident" id="1504970">size</span><span class="op" id="1504974">)</span><span class="op" id="1504975">,</span>&nbsp;<span class="builtintype" id="1504977">uintptr</span><span class="op" id="1504984">(</span><span class="ident" id="1504985">h</span><span class="op" id="1504986">.</span><span class="ident" id="1504987">hash0</span><span class="op" id="1504992">)</span><span class="op" id="1504993">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504996">m</span>&nbsp;<span class="op" id="1504998">:=</span>&nbsp;<span class="builtintype" id="1505001">uintptr</span><span class="op" id="1505008">(</span><span class="num" id="1505009">1</span><span class="op" id="1505010">)</span><span class="op" id="1505011">&lt;&lt;</span><span class="ident" id="1505013">h</span><span class="op" id="1505014">.</span><span class="ident" id="1505015">B</span>&nbsp;<span class="op" id="1505017">-</span>&nbsp;<span class="num" id="1505019">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505022">b</span>&nbsp;<span class="op" id="1505024">:=</span>&nbsp;<span class="op" id="1505027">(</span><span class="op" id="1505028">*</span><span class="ident" id="1505029">bmap</span><span class="op" id="1505033">)</span><span class="op" id="1505034">(</span><span class="ident" id="1505035">unsafe</span><span class="op" id="1505041">.</span><span class="ident" id="1505042">Pointer</span><span class="op" id="1505049">(</span><span class="builtintype" id="1505050">uintptr</span><span class="op" id="1505057">(</span><span class="ident" id="1505058">h</span><span class="op" id="1505059">.</span><span class="ident" id="1505060">buckets</span><span class="op" id="1505067">)</span>&nbsp;<span class="op" id="1505069">+</span>&nbsp;<span class="op" id="1505071">(</span><span class="ident" id="1505072">hash</span><span class="op" id="1505076">&amp;</span><span class="ident" id="1505077">m</span><span class="op" id="1505078">)</span><span class="op" id="1505079">*</span><span class="builtintype" id="1505080">uintptr</span><span class="op" id="1505087">(</span><span class="ident" id="1505088">t</span><span class="op" id="1505089">.</span><span class="ident" id="1505090">bucketsize</span><span class="op" id="1505100">)</span><span class="op" id="1505101">)</span><span class="op" id="1505102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505105">if</span>&nbsp;<span class="ident" id="1505108">c</span>&nbsp;<span class="op" id="1505110">:=</span>&nbsp;<span class="ident" id="1505113">h</span><span class="op" id="1505114">.</span><span class="ident" id="1505115">oldbuckets</span><span class="op" id="1505125">;</span>&nbsp;<span class="ident" id="1505127">c</span>&nbsp;<span class="op" id="1505129">!=</span>&nbsp;<span class="builtintype" id="1505132">nil</span>&nbsp;<span class="op" id="1505136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505140">oldb</span>&nbsp;<span class="op" id="1505145">:=</span>&nbsp;<span class="op" id="1505148">(</span><span class="op" id="1505149">*</span><span class="ident" id="1505150">bmap</span><span class="op" id="1505154">)</span><span class="op" id="1505155">(</span><span class="ident" id="1505156">unsafe</span><span class="op" id="1505162">.</span><span class="ident" id="1505163">Pointer</span><span class="op" id="1505170">(</span><span class="builtintype" id="1505171">uintptr</span><span class="op" id="1505178">(</span><span class="ident" id="1505179">c</span><span class="op" id="1505180">)</span>&nbsp;<span class="op" id="1505182">+</span>&nbsp;<span class="op" id="1505184">(</span><span class="ident" id="1505185">hash</span><span class="op" id="1505189">&amp;</span><span class="op" id="1505190">(</span><span class="ident" id="1505191">m</span><span class="op" id="1505192">&gt;&gt;</span><span class="num" id="1505194">1</span><span class="op" id="1505195">)</span><span class="op" id="1505196">)</span><span class="op" id="1505197">*</span><span class="builtintype" id="1505198">uintptr</span><span class="op" id="1505205">(</span><span class="ident" id="1505206">t</span><span class="op" id="1505207">.</span><span class="ident" id="1505208">bucketsize</span><span class="op" id="1505218">)</span><span class="op" id="1505219">)</span><span class="op" id="1505220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505224">if</span>&nbsp;<span class="op" id="1505227">!</span><span class="ident" id="1505228">evacuated</span><span class="op" id="1505237">(</span><span class="ident" id="1505238">oldb</span><span class="op" id="1505242">)</span>&nbsp;<span class="op" id="1505244">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505249">b</span>&nbsp;<span class="op" id="1505251">=</span>&nbsp;<span class="ident" id="1505253">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505266">top</span>&nbsp;<span class="op" id="1505270">:=</span>&nbsp;<span class="builtintype" id="1505273">uint8</span><span class="op" id="1505278">(</span><span class="ident" id="1505279">hash</span>&nbsp;<span class="op" id="1505284">&gt;&gt;</span>&nbsp;<span class="op" id="1505287">(</span><span class="ident" id="1505288">ptrSize</span><span class="op" id="1505295">*</span><span class="num" id="1505296">8</span>&nbsp;<span class="op" id="1505298">-</span>&nbsp;<span class="num" id="1505300">8</span><span class="op" id="1505301">)</span><span class="op" id="1505302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505305">if</span>&nbsp;<span class="ident" id="1505308">top</span>&nbsp;<span class="op" id="1505312">&lt;</span>&nbsp;<span class="ident" id="1505314">minTopHash</span>&nbsp;<span class="op" id="1505325">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505329">top</span>&nbsp;<span class="op" id="1505333">+=</span>&nbsp;<span class="ident" id="1505336">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505351">for</span>&nbsp;<span class="op" id="1505355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505359">for</span>&nbsp;<span class="ident" id="1505363">i</span>&nbsp;<span class="op" id="1505365">:=</span>&nbsp;<span class="builtintype" id="1505368">uintptr</span><span class="op" id="1505375">(</span><span class="num" id="1505376">0</span><span class="op" id="1505377">)</span><span class="op" id="1505378">;</span>&nbsp;<span class="ident" id="1505380">i</span>&nbsp;<span class="op" id="1505382">&lt;</span>&nbsp;<span class="ident" id="1505384">bucketCnt</span><span class="op" id="1505393">;</span>&nbsp;<span class="ident" id="1505395">i</span><span class="op" id="1505396">++</span>&nbsp;<span class="op" id="1505399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505404">if</span>&nbsp;<span class="ident" id="1505407">b</span><span class="op" id="1505408">.</span><span class="ident" id="1505409">tophash</span><span class="op" id="1505416">[</span><span class="ident" id="1505417">i</span><span class="op" id="1505418">]</span>&nbsp;<span class="op" id="1505420">!=</span>&nbsp;<span class="ident" id="1505423">top</span>&nbsp;<span class="op" id="1505427">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505433">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505450">k</span>&nbsp;<span class="op" id="1505452">:=</span>&nbsp;<span class="ident" id="1505455">add</span><span class="op" id="1505458">(</span><span class="ident" id="1505459">unsafe</span><span class="op" id="1505465">.</span><span class="ident" id="1505466">Pointer</span><span class="op" id="1505473">(</span><span class="ident" id="1505474">b</span><span class="op" id="1505475">)</span><span class="op" id="1505476">,</span>&nbsp;<span class="ident" id="1505478">dataOffset</span><span class="op" id="1505488">+</span><span class="ident" id="1505489">i</span><span class="op" id="1505490">*</span><span class="builtintype" id="1505491">uintptr</span><span class="op" id="1505498">(</span><span class="ident" id="1505499">t</span><span class="op" id="1505500">.</span><span class="ident" id="1505501">keysize</span><span class="op" id="1505508">)</span><span class="op" id="1505509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505514">if</span>&nbsp;<span class="ident" id="1505517">t</span><span class="op" id="1505518">.</span><span class="ident" id="1505519">indirectkey</span>&nbsp;<span class="op" id="1505531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505537">k</span>&nbsp;<span class="op" id="1505539">=</span>&nbsp;<span class="op" id="1505541">*</span><span class="op" id="1505542">(</span><span class="op" id="1505543">(</span><span class="op" id="1505544">*</span><span class="ident" id="1505545">unsafe</span><span class="op" id="1505551">.</span><span class="ident" id="1505552">Pointer</span><span class="op" id="1505559">)</span><span class="op" id="1505560">(</span><span class="ident" id="1505561">k</span><span class="op" id="1505562">)</span><span class="op" id="1505563">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505573">if</span>&nbsp;<span class="ident" id="1505576">alg</span><span class="op" id="1505579">.</span><span class="ident" id="1505580">equal</span><span class="op" id="1505585">(</span><span class="ident" id="1505586">key</span><span class="op" id="1505589">,</span>&nbsp;<span class="ident" id="1505591">k</span><span class="op" id="1505592">,</span>&nbsp;<span class="builtintype" id="1505594">uintptr</span><span class="op" id="1505601">(</span><span class="ident" id="1505602">t</span><span class="op" id="1505603">.</span><span class="ident" id="1505604">key</span><span class="op" id="1505607">.</span><span class="ident" id="1505608">size</span><span class="op" id="1505612">)</span><span class="op" id="1505613">)</span>&nbsp;<span class="op" id="1505615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505621">v</span>&nbsp;<span class="op" id="1505623">:=</span>&nbsp;<span class="ident" id="1505626">add</span><span class="op" id="1505629">(</span><span class="ident" id="1505630">unsafe</span><span class="op" id="1505636">.</span><span class="ident" id="1505637">Pointer</span><span class="op" id="1505644">(</span><span class="ident" id="1505645">b</span><span class="op" id="1505646">)</span><span class="op" id="1505647">,</span>&nbsp;<span class="ident" id="1505649">dataOffset</span><span class="op" id="1505659">+</span><span class="ident" id="1505660">bucketCnt</span><span class="op" id="1505669">*</span><span class="builtintype" id="1505670">uintptr</span><span class="op" id="1505677">(</span><span class="ident" id="1505678">t</span><span class="op" id="1505679">.</span><span class="ident" id="1505680">keysize</span><span class="op" id="1505687">)</span><span class="op" id="1505688">+</span><span class="ident" id="1505689">i</span><span class="op" id="1505690">*</span><span class="builtintype" id="1505691">uintptr</span><span class="op" id="1505698">(</span><span class="ident" id="1505699">t</span><span class="op" id="1505700">.</span><span class="ident" id="1505701">valuesize</span><span class="op" id="1505710">)</span><span class="op" id="1505711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505717">if</span>&nbsp;<span class="ident" id="1505720">t</span><span class="op" id="1505721">.</span><span class="ident" id="1505722">indirectvalue</span>&nbsp;<span class="op" id="1505736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505743">v</span>&nbsp;<span class="op" id="1505745">=</span>&nbsp;<span class="op" id="1505747">*</span><span class="op" id="1505748">(</span><span class="op" id="1505749">(</span><span class="op" id="1505750">*</span><span class="ident" id="1505751">unsafe</span><span class="op" id="1505757">.</span><span class="ident" id="1505758">Pointer</span><span class="op" id="1505765">)</span><span class="op" id="1505766">(</span><span class="ident" id="1505767">v</span><span class="op" id="1505768">)</span><span class="op" id="1505769">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505781">return</span>&nbsp;<span class="ident" id="1505788">k</span><span class="op" id="1505789">,</span>&nbsp;<span class="ident" id="1505791">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505804">b</span>&nbsp;<span class="op" id="1505806">=</span>&nbsp;<span class="ident" id="1505808">b</span><span class="op" id="1505809">.</span><span class="ident" id="1505810">overflow</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505821">if</span>&nbsp;<span class="ident" id="1505824">b</span>&nbsp;<span class="op" id="1505826">==</span>&nbsp;<span class="builtintype" id="1505829">nil</span>&nbsp;<span class="op" id="1505833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505838">return</span>&nbsp;<span class="builtintype" id="1505845">nil</span><span class="op" id="1505848">,</span>&nbsp;<span class="builtintype" id="1505850">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505859">}</span><br>
<span class="lineno"></span><span class="op" id="1505861">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="1505864">func</span>&nbsp;<span class="ident" id="1505869">mapassign1</span><span class="op" id="1505879">(</span><span class="ident" id="1505880">t</span>&nbsp;<span class="op" id="1505882">*</span><span class="ident" id="1505883">maptype</span><span class="op" id="1505890">,</span>&nbsp;<span class="ident" id="1505892">h</span>&nbsp;<span class="op" id="1505894">*</span><span class="ident" id="1505895">hmap</span><span class="op" id="1505899">,</span>&nbsp;<span class="ident" id="1505901">key</span>&nbsp;<span class="ident" id="1505905">unsafe</span><span class="op" id="1505911">.</span><span class="ident" id="1505912">Pointer</span><span class="op" id="1505919">,</span>&nbsp;<span class="ident" id="1505921">val</span>&nbsp;<span class="ident" id="1505925">unsafe</span><span class="op" id="1505931">.</span><span class="ident" id="1505932">Pointer</span><span class="op" id="1505939">)</span>&nbsp;<span class="op" id="1505941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505944">if</span>&nbsp;<span class="ident" id="1505947">h</span>&nbsp;<span class="op" id="1505949">==</span>&nbsp;<span class="builtintype" id="1505952">nil</span>&nbsp;<span class="op" id="1505956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1505960">panic</span><span class="op" id="1505965">(</span><span class="string" id="1505966">&#34;assignment&nbsp;to&nbsp;entry&nbsp;in&nbsp;nil&nbsp;map&#34;</span><span class="op" id="1505998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506001">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506004">if</span>&nbsp;<span class="ident" id="1506007">raceenabled</span>&nbsp;<span class="op" id="1506019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506023">callerpc</span>&nbsp;<span class="op" id="1506032">:=</span>&nbsp;<span class="ident" id="1506035">getcallerpc</span><span class="op" id="1506046">(</span><span class="ident" id="1506047">unsafe</span><span class="op" id="1506053">.</span><span class="ident" id="1506054">Pointer</span><span class="op" id="1506061">(</span><span class="op" id="1506062">&amp;</span><span class="ident" id="1506063">t</span><span class="op" id="1506064">)</span><span class="op" id="1506065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506069">pc</span>&nbsp;<span class="op" id="1506072">:=</span>&nbsp;<span class="ident" id="1506075">funcPC</span><span class="op" id="1506081">(</span><span class="ident" id="1506082">mapassign1</span><span class="op" id="1506092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506096">racewritepc</span><span class="op" id="1506107">(</span><span class="ident" id="1506108">unsafe</span><span class="op" id="1506114">.</span><span class="ident" id="1506115">Pointer</span><span class="op" id="1506122">(</span><span class="ident" id="1506123">h</span><span class="op" id="1506124">)</span><span class="op" id="1506125">,</span>&nbsp;<span class="ident" id="1506127">callerpc</span><span class="op" id="1506135">,</span>&nbsp;<span class="ident" id="1506137">pc</span><span class="op" id="1506139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506143">raceReadObjectPC</span><span class="op" id="1506159">(</span><span class="ident" id="1506160">t</span><span class="op" id="1506161">.</span><span class="ident" id="1506162">key</span><span class="op" id="1506165">,</span>&nbsp;<span class="ident" id="1506167">key</span><span class="op" id="1506170">,</span>&nbsp;<span class="ident" id="1506172">callerpc</span><span class="op" id="1506180">,</span>&nbsp;<span class="ident" id="1506182">pc</span><span class="op" id="1506184">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506188">raceReadObjectPC</span><span class="op" id="1506204">(</span><span class="ident" id="1506205">t</span><span class="op" id="1506206">.</span><span class="ident" id="1506207">elem</span><span class="op" id="1506211">,</span>&nbsp;<span class="ident" id="1506213">val</span><span class="op" id="1506216">,</span>&nbsp;<span class="ident" id="1506218">callerpc</span><span class="op" id="1506226">,</span>&nbsp;<span class="ident" id="1506228">pc</span><span class="op" id="1506230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506237">alg</span>&nbsp;<span class="op" id="1506241">:=</span>&nbsp;<span class="ident" id="1506244">goalg</span><span class="op" id="1506249">(</span><span class="ident" id="1506250">t</span><span class="op" id="1506251">.</span><span class="ident" id="1506252">key</span><span class="op" id="1506255">.</span><span class="ident" id="1506256">alg</span><span class="op" id="1506259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506262">hash</span>&nbsp;<span class="op" id="1506267">:=</span>&nbsp;<span class="ident" id="1506270">alg</span><span class="op" id="1506273">.</span><span class="ident" id="1506274">hash</span><span class="op" id="1506278">(</span><span class="ident" id="1506279">key</span><span class="op" id="1506282">,</span>&nbsp;<span class="builtintype" id="1506284">uintptr</span><span class="op" id="1506291">(</span><span class="ident" id="1506292">t</span><span class="op" id="1506293">.</span><span class="ident" id="1506294">key</span><span class="op" id="1506297">.</span><span class="ident" id="1506298">size</span><span class="op" id="1506302">)</span><span class="op" id="1506303">,</span>&nbsp;<span class="builtintype" id="1506305">uintptr</span><span class="op" id="1506312">(</span><span class="ident" id="1506313">h</span><span class="op" id="1506314">.</span><span class="ident" id="1506315">hash0</span><span class="op" id="1506320">)</span><span class="op" id="1506321">)</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506325">if</span>&nbsp;<span class="ident" id="1506328">h</span><span class="op" id="1506329">.</span><span class="ident" id="1506330">buckets</span>&nbsp;<span class="op" id="1506338">==</span>&nbsp;<span class="builtintype" id="1506341">nil</span>&nbsp;<span class="op" id="1506345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506349">if</span>&nbsp;<span class="ident" id="1506352">checkgc</span>&nbsp;<span class="op" id="1506360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506365">memstats</span><span class="op" id="1506373">.</span><span class="ident" id="1506374">next_gc</span>&nbsp;<span class="op" id="1506382">=</span>&nbsp;<span class="ident" id="1506384">memstats</span><span class="op" id="1506392">.</span><span class="ident" id="1506393">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506406">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506410">h</span><span class="op" id="1506411">.</span><span class="ident" id="1506412">buckets</span>&nbsp;<span class="op" id="1506420">=</span>&nbsp;<span class="ident" id="1506422">newarray</span><span class="op" id="1506430">(</span><span class="ident" id="1506431">t</span><span class="op" id="1506432">.</span><span class="ident" id="1506433">bucket</span><span class="op" id="1506439">,</span>&nbsp;<span class="num" id="1506441">1</span><span class="op" id="1506442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1506448">again</span><span class="op" id="1506453">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506456">bucket</span>&nbsp;<span class="op" id="1506463">:=</span>&nbsp;<span class="ident" id="1506466">hash</span>&nbsp;<span class="op" id="1506471">&amp;</span>&nbsp;<span class="op" id="1506473">(</span><span class="builtintype" id="1506474">uintptr</span><span class="op" id="1506481">(</span><span class="num" id="1506482">1</span><span class="op" id="1506483">)</span><span class="op" id="1506484">&lt;&lt;</span><span class="ident" id="1506486">h</span><span class="op" id="1506487">.</span><span class="ident" id="1506488">B</span>&nbsp;<span class="op" id="1506490">-</span>&nbsp;<span class="num" id="1506492">1</span><span class="op" id="1506493">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506496">if</span>&nbsp;<span class="ident" id="1506499">h</span><span class="op" id="1506500">.</span><span class="ident" id="1506501">oldbuckets</span>&nbsp;<span class="op" id="1506512">!=</span>&nbsp;<span class="builtintype" id="1506515">nil</span>&nbsp;<span class="op" id="1506519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506523">growWork</span><span class="op" id="1506531">(</span><span class="ident" id="1506532">t</span><span class="op" id="1506533">,</span>&nbsp;<span class="ident" id="1506535">h</span><span class="op" id="1506536">,</span>&nbsp;<span class="ident" id="1506538">bucket</span><span class="op" id="1506544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506550">b</span>&nbsp;<span class="op" id="1506552">:=</span>&nbsp;<span class="op" id="1506555">(</span><span class="op" id="1506556">*</span><span class="ident" id="1506557">bmap</span><span class="op" id="1506561">)</span><span class="op" id="1506562">(</span><span class="ident" id="1506563">unsafe</span><span class="op" id="1506569">.</span><span class="ident" id="1506570">Pointer</span><span class="op" id="1506577">(</span><span class="builtintype" id="1506578">uintptr</span><span class="op" id="1506585">(</span><span class="ident" id="1506586">h</span><span class="op" id="1506587">.</span><span class="ident" id="1506588">buckets</span><span class="op" id="1506595">)</span>&nbsp;<span class="op" id="1506597">+</span>&nbsp;<span class="ident" id="1506599">bucket</span><span class="op" id="1506605">*</span><span class="builtintype" id="1506606">uintptr</span><span class="op" id="1506613">(</span><span class="ident" id="1506614">t</span><span class="op" id="1506615">.</span><span class="ident" id="1506616">bucketsize</span><span class="op" id="1506626">)</span><span class="op" id="1506627">)</span><span class="op" id="1506628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506631">top</span>&nbsp;<span class="op" id="1506635">:=</span>&nbsp;<span class="builtintype" id="1506638">uint8</span><span class="op" id="1506643">(</span><span class="ident" id="1506644">hash</span>&nbsp;<span class="op" id="1506649">&gt;&gt;</span>&nbsp;<span class="op" id="1506652">(</span><span class="ident" id="1506653">ptrSize</span><span class="op" id="1506660">*</span><span class="num" id="1506661">8</span>&nbsp;<span class="op" id="1506663">-</span>&nbsp;<span class="num" id="1506665">8</span><span class="op" id="1506666">)</span><span class="op" id="1506667">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506670">if</span>&nbsp;<span class="ident" id="1506673">top</span>&nbsp;<span class="op" id="1506677">&lt;</span>&nbsp;<span class="ident" id="1506679">minTopHash</span>&nbsp;<span class="op" id="1506690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506694">top</span>&nbsp;<span class="op" id="1506698">+=</span>&nbsp;<span class="ident" id="1506701">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506717">var</span>&nbsp;<span class="ident" id="1506721">inserti</span>&nbsp;<span class="op" id="1506729">*</span><span class="builtintype" id="1506730">uint8</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506737">var</span>&nbsp;<span class="ident" id="1506741">insertk</span>&nbsp;<span class="ident" id="1506749">unsafe</span><span class="op" id="1506755">.</span><span class="ident" id="1506756">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506765">var</span>&nbsp;<span class="ident" id="1506769">insertv</span>&nbsp;<span class="ident" id="1506777">unsafe</span><span class="op" id="1506783">.</span><span class="ident" id="1506784">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506793">for</span>&nbsp;<span class="op" id="1506797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506801">for</span>&nbsp;<span class="ident" id="1506805">i</span>&nbsp;<span class="op" id="1506807">:=</span>&nbsp;<span class="builtintype" id="1506810">uintptr</span><span class="op" id="1506817">(</span><span class="num" id="1506818">0</span><span class="op" id="1506819">)</span><span class="op" id="1506820">;</span>&nbsp;<span class="ident" id="1506822">i</span>&nbsp;<span class="op" id="1506824">&lt;</span>&nbsp;<span class="ident" id="1506826">bucketCnt</span><span class="op" id="1506835">;</span>&nbsp;<span class="ident" id="1506837">i</span><span class="op" id="1506838">++</span>&nbsp;<span class="op" id="1506841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506846">if</span>&nbsp;<span class="ident" id="1506849">b</span><span class="op" id="1506850">.</span><span class="ident" id="1506851">tophash</span><span class="op" id="1506858">[</span><span class="ident" id="1506859">i</span><span class="op" id="1506860">]</span>&nbsp;<span class="op" id="1506862">!=</span>&nbsp;<span class="ident" id="1506865">top</span>&nbsp;<span class="op" id="1506869">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506875">if</span>&nbsp;<span class="ident" id="1506878">b</span><span class="op" id="1506879">.</span><span class="ident" id="1506880">tophash</span><span class="op" id="1506887">[</span><span class="ident" id="1506888">i</span><span class="op" id="1506889">]</span>&nbsp;<span class="op" id="1506891">==</span>&nbsp;<span class="ident" id="1506894">empty</span>&nbsp;<span class="op" id="1506900">&amp;&amp;</span>&nbsp;<span class="ident" id="1506903">inserti</span>&nbsp;<span class="op" id="1506911">==</span>&nbsp;<span class="builtintype" id="1506914">nil</span>&nbsp;<span class="op" id="1506918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506925">inserti</span>&nbsp;<span class="op" id="1506933">=</span>&nbsp;<span class="op" id="1506935">&amp;</span><span class="ident" id="1506936">b</span><span class="op" id="1506937">.</span><span class="ident" id="1506938">tophash</span><span class="op" id="1506945">[</span><span class="ident" id="1506946">i</span><span class="op" id="1506947">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506954">insertk</span>&nbsp;<span class="op" id="1506962">=</span>&nbsp;<span class="ident" id="1506964">add</span><span class="op" id="1506967">(</span><span class="ident" id="1506968">unsafe</span><span class="op" id="1506974">.</span><span class="ident" id="1506975">Pointer</span><span class="op" id="1506982">(</span><span class="ident" id="1506983">b</span><span class="op" id="1506984">)</span><span class="op" id="1506985">,</span>&nbsp;<span class="ident" id="1506987">dataOffset</span><span class="op" id="1506997">+</span><span class="ident" id="1506998">i</span><span class="op" id="1506999">*</span><span class="builtintype" id="1507000">uintptr</span><span class="op" id="1507007">(</span><span class="ident" id="1507008">t</span><span class="op" id="1507009">.</span><span class="ident" id="1507010">keysize</span><span class="op" id="1507017">)</span><span class="op" id="1507018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507025">insertv</span>&nbsp;<span class="op" id="1507033">=</span>&nbsp;<span class="ident" id="1507035">add</span><span class="op" id="1507038">(</span><span class="ident" id="1507039">unsafe</span><span class="op" id="1507045">.</span><span class="ident" id="1507046">Pointer</span><span class="op" id="1507053">(</span><span class="ident" id="1507054">b</span><span class="op" id="1507055">)</span><span class="op" id="1507056">,</span>&nbsp;<span class="ident" id="1507058">dataOffset</span><span class="op" id="1507068">+</span><span class="ident" id="1507069">bucketCnt</span><span class="op" id="1507078">*</span><span class="builtintype" id="1507079">uintptr</span><span class="op" id="1507086">(</span><span class="ident" id="1507087">t</span><span class="op" id="1507088">.</span><span class="ident" id="1507089">keysize</span><span class="op" id="1507096">)</span><span class="op" id="1507097">+</span><span class="ident" id="1507098">i</span><span class="op" id="1507099">*</span><span class="builtintype" id="1507100">uintptr</span><span class="op" id="1507107">(</span><span class="ident" id="1507108">t</span><span class="op" id="1507109">.</span><span class="ident" id="1507110">valuesize</span><span class="op" id="1507119">)</span><span class="op" id="1507120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507126">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507132">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507149">k</span>&nbsp;<span class="op" id="1507151">:=</span>&nbsp;<span class="ident" id="1507154">add</span><span class="op" id="1507157">(</span><span class="ident" id="1507158">unsafe</span><span class="op" id="1507164">.</span><span class="ident" id="1507165">Pointer</span><span class="op" id="1507172">(</span><span class="ident" id="1507173">b</span><span class="op" id="1507174">)</span><span class="op" id="1507175">,</span>&nbsp;<span class="ident" id="1507177">dataOffset</span><span class="op" id="1507187">+</span><span class="ident" id="1507188">i</span><span class="op" id="1507189">*</span><span class="builtintype" id="1507190">uintptr</span><span class="op" id="1507197">(</span><span class="ident" id="1507198">t</span><span class="op" id="1507199">.</span><span class="ident" id="1507200">keysize</span><span class="op" id="1507207">)</span><span class="op" id="1507208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507213">k2</span>&nbsp;<span class="op" id="1507216">:=</span>&nbsp;<span class="ident" id="1507219">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507224">if</span>&nbsp;<span class="ident" id="1507227">t</span><span class="op" id="1507228">.</span><span class="ident" id="1507229">indirectkey</span>&nbsp;<span class="op" id="1507241">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507247">k2</span>&nbsp;<span class="op" id="1507250">=</span>&nbsp;<span class="op" id="1507252">*</span><span class="op" id="1507253">(</span><span class="op" id="1507254">(</span><span class="op" id="1507255">*</span><span class="ident" id="1507256">unsafe</span><span class="op" id="1507262">.</span><span class="ident" id="1507263">Pointer</span><span class="op" id="1507270">)</span><span class="op" id="1507271">(</span><span class="ident" id="1507272">k2</span><span class="op" id="1507274">)</span><span class="op" id="1507275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507285">if</span>&nbsp;<span class="op" id="1507288">!</span><span class="ident" id="1507289">alg</span><span class="op" id="1507292">.</span><span class="ident" id="1507293">equal</span><span class="op" id="1507298">(</span><span class="ident" id="1507299">key</span><span class="op" id="1507302">,</span>&nbsp;<span class="ident" id="1507304">k2</span><span class="op" id="1507306">,</span>&nbsp;<span class="builtintype" id="1507308">uintptr</span><span class="op" id="1507315">(</span><span class="ident" id="1507316">t</span><span class="op" id="1507317">.</span><span class="ident" id="1507318">key</span><span class="op" id="1507321">.</span><span class="ident" id="1507322">size</span><span class="op" id="1507326">)</span><span class="op" id="1507327">)</span>&nbsp;<span class="op" id="1507329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507335">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507347">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507352">//&nbsp;already&nbsp;have&nbsp;a&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Update&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507402">memmove</span><span class="op" id="1507409">(</span><span class="ident" id="1507410">k2</span><span class="op" id="1507412">,</span>&nbsp;<span class="ident" id="1507414">key</span><span class="op" id="1507417">,</span>&nbsp;<span class="builtintype" id="1507419">uintptr</span><span class="op" id="1507426">(</span><span class="ident" id="1507427">t</span><span class="op" id="1507428">.</span><span class="ident" id="1507429">key</span><span class="op" id="1507432">.</span><span class="ident" id="1507433">size</span><span class="op" id="1507437">)</span><span class="op" id="1507438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507443">v</span>&nbsp;<span class="op" id="1507445">:=</span>&nbsp;<span class="ident" id="1507448">add</span><span class="op" id="1507451">(</span><span class="ident" id="1507452">unsafe</span><span class="op" id="1507458">.</span><span class="ident" id="1507459">Pointer</span><span class="op" id="1507466">(</span><span class="ident" id="1507467">b</span><span class="op" id="1507468">)</span><span class="op" id="1507469">,</span>&nbsp;<span class="ident" id="1507471">dataOffset</span><span class="op" id="1507481">+</span><span class="ident" id="1507482">bucketCnt</span><span class="op" id="1507491">*</span><span class="builtintype" id="1507492">uintptr</span><span class="op" id="1507499">(</span><span class="ident" id="1507500">t</span><span class="op" id="1507501">.</span><span class="ident" id="1507502">keysize</span><span class="op" id="1507509">)</span><span class="op" id="1507510">+</span><span class="ident" id="1507511">i</span><span class="op" id="1507512">*</span><span class="builtintype" id="1507513">uintptr</span><span class="op" id="1507520">(</span><span class="ident" id="1507521">t</span><span class="op" id="1507522">.</span><span class="ident" id="1507523">valuesize</span><span class="op" id="1507532">)</span><span class="op" id="1507533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507538">v2</span>&nbsp;<span class="op" id="1507541">:=</span>&nbsp;<span class="ident" id="1507544">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507549">if</span>&nbsp;<span class="ident" id="1507552">t</span><span class="op" id="1507553">.</span><span class="ident" id="1507554">indirectvalue</span>&nbsp;<span class="op" id="1507568">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507574">v2</span>&nbsp;<span class="op" id="1507577">=</span>&nbsp;<span class="op" id="1507579">*</span><span class="op" id="1507580">(</span><span class="op" id="1507581">(</span><span class="op" id="1507582">*</span><span class="ident" id="1507583">unsafe</span><span class="op" id="1507589">.</span><span class="ident" id="1507590">Pointer</span><span class="op" id="1507597">)</span><span class="op" id="1507598">(</span><span class="ident" id="1507599">v2</span><span class="op" id="1507601">)</span><span class="op" id="1507602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507612">memmove</span><span class="op" id="1507619">(</span><span class="ident" id="1507620">v2</span><span class="op" id="1507622">,</span>&nbsp;<span class="ident" id="1507624">val</span><span class="op" id="1507627">,</span>&nbsp;<span class="builtintype" id="1507629">uintptr</span><span class="op" id="1507636">(</span><span class="ident" id="1507637">t</span><span class="op" id="1507638">.</span><span class="ident" id="1507639">elem</span><span class="op" id="1507643">.</span><span class="ident" id="1507644">size</span><span class="op" id="1507648">)</span><span class="op" id="1507649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507654">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507663">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507667">if</span>&nbsp;<span class="ident" id="1507670">b</span><span class="op" id="1507671">.</span><span class="ident" id="1507672">overflow</span>&nbsp;<span class="op" id="1507681">==</span>&nbsp;<span class="builtintype" id="1507684">nil</span>&nbsp;<span class="op" id="1507688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507693">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507705">b</span>&nbsp;<span class="op" id="1507707">=</span>&nbsp;<span class="ident" id="1507709">b</span><span class="op" id="1507710">.</span><span class="ident" id="1507711">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507721">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507725">//&nbsp;did&nbsp;not&nbsp;find&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Allocate&nbsp;new&nbsp;cell&nbsp;&amp;&nbsp;add&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507791">if</span>&nbsp;<span class="builtintype" id="1507794">float32</span><span class="op" id="1507801">(</span><span class="ident" id="1507802">h</span><span class="op" id="1507803">.</span><span class="ident" id="1507804">count</span><span class="op" id="1507809">)</span>&nbsp;<span class="op" id="1507811">&gt;=</span>&nbsp;<span class="ident" id="1507814">loadFactor</span><span class="op" id="1507824">*</span><span class="builtintype" id="1507825">float32</span><span class="op" id="1507832">(</span><span class="op" id="1507833">(</span><span class="builtintype" id="1507834">uintptr</span><span class="op" id="1507841">(</span><span class="num" id="1507842">1</span><span class="op" id="1507843">)</span><span class="op" id="1507844">&lt;&lt;</span><span class="ident" id="1507846">h</span><span class="op" id="1507847">.</span><span class="ident" id="1507848">B</span><span class="op" id="1507849">)</span><span class="op" id="1507850">)</span>&nbsp;<span class="op" id="1507852">&amp;&amp;</span>&nbsp;<span class="ident" id="1507855">h</span><span class="op" id="1507856">.</span><span class="ident" id="1507857">count</span>&nbsp;<span class="op" id="1507863">&gt;=</span>&nbsp;<span class="ident" id="1507866">bucketCnt</span>&nbsp;<span class="op" id="1507876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507880">hashGrow</span><span class="op" id="1507888">(</span><span class="ident" id="1507889">t</span><span class="op" id="1507890">,</span>&nbsp;<span class="ident" id="1507892">h</span><span class="op" id="1507893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507897">goto</span>&nbsp;<span class="ident" id="1507902">again</span>&nbsp;<span class="comment" id="1507908">//&nbsp;Growing&nbsp;the&nbsp;table&nbsp;invalidates&nbsp;everything,&nbsp;so&nbsp;try&nbsp;again</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507971">if</span>&nbsp;<span class="ident" id="1507974">inserti</span>&nbsp;<span class="op" id="1507982">==</span>&nbsp;<span class="builtintype" id="1507985">nil</span>&nbsp;<span class="op" id="1507989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507993">//&nbsp;all&nbsp;current&nbsp;buckets&nbsp;are&nbsp;full,&nbsp;allocate&nbsp;a&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508048">if</span>&nbsp;<span class="ident" id="1508051">checkgc</span>&nbsp;<span class="op" id="1508059">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508064">memstats</span><span class="op" id="1508072">.</span><span class="ident" id="1508073">next_gc</span>&nbsp;<span class="op" id="1508081">=</span>&nbsp;<span class="ident" id="1508083">memstats</span><span class="op" id="1508091">.</span><span class="ident" id="1508092">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508109">newb</span>&nbsp;<span class="op" id="1508114">:=</span>&nbsp;<span class="op" id="1508117">(</span><span class="op" id="1508118">*</span><span class="ident" id="1508119">bmap</span><span class="op" id="1508123">)</span><span class="op" id="1508124">(</span><span class="ident" id="1508125">newobject</span><span class="op" id="1508134">(</span><span class="ident" id="1508135">t</span><span class="op" id="1508136">.</span><span class="ident" id="1508137">bucket</span><span class="op" id="1508143">)</span><span class="op" id="1508144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508148">b</span><span class="op" id="1508149">.</span><span class="ident" id="1508150">overflow</span>&nbsp;<span class="op" id="1508159">=</span>&nbsp;<span class="ident" id="1508161">newb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508168">inserti</span>&nbsp;<span class="op" id="1508176">=</span>&nbsp;<span class="op" id="1508178">&amp;</span><span class="ident" id="1508179">newb</span><span class="op" id="1508183">.</span><span class="ident" id="1508184">tophash</span><span class="op" id="1508191">[</span><span class="num" id="1508192">0</span><span class="op" id="1508193">]</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508197">insertk</span>&nbsp;<span class="op" id="1508205">=</span>&nbsp;<span class="ident" id="1508207">add</span><span class="op" id="1508210">(</span><span class="ident" id="1508211">unsafe</span><span class="op" id="1508217">.</span><span class="ident" id="1508218">Pointer</span><span class="op" id="1508225">(</span><span class="ident" id="1508226">newb</span><span class="op" id="1508230">)</span><span class="op" id="1508231">,</span>&nbsp;<span class="ident" id="1508233">dataOffset</span><span class="op" id="1508243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508247">insertv</span>&nbsp;<span class="op" id="1508255">=</span>&nbsp;<span class="ident" id="1508257">add</span><span class="op" id="1508260">(</span><span class="ident" id="1508261">insertk</span><span class="op" id="1508268">,</span>&nbsp;<span class="ident" id="1508270">bucketCnt</span><span class="op" id="1508279">*</span><span class="builtintype" id="1508280">uintptr</span><span class="op" id="1508287">(</span><span class="ident" id="1508288">t</span><span class="op" id="1508289">.</span><span class="ident" id="1508290">keysize</span><span class="op" id="1508297">)</span><span class="op" id="1508298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1508305">//&nbsp;store&nbsp;new&nbsp;key/value&nbsp;at&nbsp;insert&nbsp;position</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508348">if</span>&nbsp;<span class="ident" id="1508351">t</span><span class="op" id="1508352">.</span><span class="ident" id="1508353">indirectkey</span>&nbsp;<span class="op" id="1508365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508369">if</span>&nbsp;<span class="ident" id="1508372">checkgc</span>&nbsp;<span class="op" id="1508380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508385">memstats</span><span class="op" id="1508393">.</span><span class="ident" id="1508394">next_gc</span>&nbsp;<span class="op" id="1508402">=</span>&nbsp;<span class="ident" id="1508404">memstats</span><span class="op" id="1508412">.</span><span class="ident" id="1508413">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508430">kmem</span>&nbsp;<span class="op" id="1508435">:=</span>&nbsp;<span class="ident" id="1508438">newobject</span><span class="op" id="1508447">(</span><span class="ident" id="1508448">t</span><span class="op" id="1508449">.</span><span class="ident" id="1508450">key</span><span class="op" id="1508453">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508457">*</span><span class="op" id="1508458">(</span><span class="op" id="1508459">*</span><span class="ident" id="1508460">unsafe</span><span class="op" id="1508466">.</span><span class="ident" id="1508467">Pointer</span><span class="op" id="1508474">)</span><span class="op" id="1508475">(</span><span class="ident" id="1508476">insertk</span><span class="op" id="1508483">)</span>&nbsp;<span class="op" id="1508485">=</span>&nbsp;<span class="ident" id="1508487">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508494">insertk</span>&nbsp;<span class="op" id="1508502">=</span>&nbsp;<span class="ident" id="1508504">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508513">if</span>&nbsp;<span class="ident" id="1508516">t</span><span class="op" id="1508517">.</span><span class="ident" id="1508518">indirectvalue</span>&nbsp;<span class="op" id="1508532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508536">if</span>&nbsp;<span class="ident" id="1508539">checkgc</span>&nbsp;<span class="op" id="1508547">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508552">memstats</span><span class="op" id="1508560">.</span><span class="ident" id="1508561">next_gc</span>&nbsp;<span class="op" id="1508569">=</span>&nbsp;<span class="ident" id="1508571">memstats</span><span class="op" id="1508579">.</span><span class="ident" id="1508580">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508597">vmem</span>&nbsp;<span class="op" id="1508602">:=</span>&nbsp;<span class="ident" id="1508605">newobject</span><span class="op" id="1508614">(</span><span class="ident" id="1508615">t</span><span class="op" id="1508616">.</span><span class="ident" id="1508617">elem</span><span class="op" id="1508621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508625">*</span><span class="op" id="1508626">(</span><span class="op" id="1508627">*</span><span class="ident" id="1508628">unsafe</span><span class="op" id="1508634">.</span><span class="ident" id="1508635">Pointer</span><span class="op" id="1508642">)</span><span class="op" id="1508643">(</span><span class="ident" id="1508644">insertv</span><span class="op" id="1508651">)</span>&nbsp;<span class="op" id="1508653">=</span>&nbsp;<span class="ident" id="1508655">vmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508662">insertv</span>&nbsp;<span class="op" id="1508670">=</span>&nbsp;<span class="ident" id="1508672">vmem</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508681">memmove</span><span class="op" id="1508688">(</span><span class="ident" id="1508689">insertk</span><span class="op" id="1508696">,</span>&nbsp;<span class="ident" id="1508698">key</span><span class="op" id="1508701">,</span>&nbsp;<span class="builtintype" id="1508703">uintptr</span><span class="op" id="1508710">(</span><span class="ident" id="1508711">t</span><span class="op" id="1508712">.</span><span class="ident" id="1508713">key</span><span class="op" id="1508716">.</span><span class="ident" id="1508717">size</span><span class="op" id="1508721">)</span><span class="op" id="1508722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508725">memmove</span><span class="op" id="1508732">(</span><span class="ident" id="1508733">insertv</span><span class="op" id="1508740">,</span>&nbsp;<span class="ident" id="1508742">val</span><span class="op" id="1508745">,</span>&nbsp;<span class="builtintype" id="1508747">uintptr</span><span class="op" id="1508754">(</span><span class="ident" id="1508755">t</span><span class="op" id="1508756">.</span><span class="ident" id="1508757">elem</span><span class="op" id="1508761">.</span><span class="ident" id="1508762">size</span><span class="op" id="1508766">)</span><span class="op" id="1508767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508770">*</span><span class="ident" id="1508771">inserti</span>&nbsp;<span class="op" id="1508779">=</span>&nbsp;<span class="ident" id="1508781">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508786">h</span><span class="op" id="1508787">.</span><span class="ident" id="1508788">count</span><span class="op" id="1508793">++</span><br>
<span class="lineno">485</span><span class="op" id="1508796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1508799">func</span>&nbsp;<span class="ident" id="1508804">mapdelete</span><span class="op" id="1508813">(</span><span class="ident" id="1508814">t</span>&nbsp;<span class="op" id="1508816">*</span><span class="ident" id="1508817">maptype</span><span class="op" id="1508824">,</span>&nbsp;<span class="ident" id="1508826">h</span>&nbsp;<span class="op" id="1508828">*</span><span class="ident" id="1508829">hmap</span><span class="op" id="1508833">,</span>&nbsp;<span class="ident" id="1508835">key</span>&nbsp;<span class="ident" id="1508839">unsafe</span><span class="op" id="1508845">.</span><span class="ident" id="1508846">Pointer</span><span class="op" id="1508853">)</span>&nbsp;<span class="op" id="1508855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508858">if</span>&nbsp;<span class="ident" id="1508861">raceenabled</span>&nbsp;<span class="op" id="1508873">&amp;&amp;</span>&nbsp;<span class="ident" id="1508876">h</span>&nbsp;<span class="op" id="1508878">!=</span>&nbsp;<span class="builtintype" id="1508881">nil</span>&nbsp;<span class="op" id="1508885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508889">callerpc</span>&nbsp;<span class="op" id="1508898">:=</span>&nbsp;<span class="ident" id="1508901">getcallerpc</span><span class="op" id="1508912">(</span><span class="ident" id="1508913">unsafe</span><span class="op" id="1508919">.</span><span class="ident" id="1508920">Pointer</span><span class="op" id="1508927">(</span><span class="op" id="1508928">&amp;</span><span class="ident" id="1508929">t</span><span class="op" id="1508930">)</span><span class="op" id="1508931">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508935">pc</span>&nbsp;<span class="op" id="1508938">:=</span>&nbsp;<span class="ident" id="1508941">funcPC</span><span class="op" id="1508947">(</span><span class="ident" id="1508948">mapdelete</span><span class="op" id="1508957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508961">racewritepc</span><span class="op" id="1508972">(</span><span class="ident" id="1508973">unsafe</span><span class="op" id="1508979">.</span><span class="ident" id="1508980">Pointer</span><span class="op" id="1508987">(</span><span class="ident" id="1508988">h</span><span class="op" id="1508989">)</span><span class="op" id="1508990">,</span>&nbsp;<span class="ident" id="1508992">callerpc</span><span class="op" id="1509000">,</span>&nbsp;<span class="ident" id="1509002">pc</span><span class="op" id="1509004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509008">raceReadObjectPC</span><span class="op" id="1509024">(</span><span class="ident" id="1509025">t</span><span class="op" id="1509026">.</span><span class="ident" id="1509027">key</span><span class="op" id="1509030">,</span>&nbsp;<span class="ident" id="1509032">key</span><span class="op" id="1509035">,</span>&nbsp;<span class="ident" id="1509037">callerpc</span><span class="op" id="1509045">,</span>&nbsp;<span class="ident" id="1509047">pc</span><span class="op" id="1509049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509055">if</span>&nbsp;<span class="ident" id="1509058">h</span>&nbsp;<span class="op" id="1509060">==</span>&nbsp;<span class="builtintype" id="1509063">nil</span>&nbsp;<span class="op" id="1509067">||</span>&nbsp;<span class="ident" id="1509070">h</span><span class="op" id="1509071">.</span><span class="ident" id="1509072">count</span>&nbsp;<span class="op" id="1509078">==</span>&nbsp;<span class="num" id="1509081">0</span>&nbsp;<span class="op" id="1509083">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509087">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509098">alg</span>&nbsp;<span class="op" id="1509102">:=</span>&nbsp;<span class="ident" id="1509105">goalg</span><span class="op" id="1509110">(</span><span class="ident" id="1509111">t</span><span class="op" id="1509112">.</span><span class="ident" id="1509113">key</span><span class="op" id="1509116">.</span><span class="ident" id="1509117">alg</span><span class="op" id="1509120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509123">hash</span>&nbsp;<span class="op" id="1509128">:=</span>&nbsp;<span class="ident" id="1509131">alg</span><span class="op" id="1509134">.</span><span class="ident" id="1509135">hash</span><span class="op" id="1509139">(</span><span class="ident" id="1509140">key</span><span class="op" id="1509143">,</span>&nbsp;<span class="builtintype" id="1509145">uintptr</span><span class="op" id="1509152">(</span><span class="ident" id="1509153">t</span><span class="op" id="1509154">.</span><span class="ident" id="1509155">key</span><span class="op" id="1509158">.</span><span class="ident" id="1509159">size</span><span class="op" id="1509163">)</span><span class="op" id="1509164">,</span>&nbsp;<span class="builtintype" id="1509166">uintptr</span><span class="op" id="1509173">(</span><span class="ident" id="1509174">h</span><span class="op" id="1509175">.</span><span class="ident" id="1509176">hash0</span><span class="op" id="1509181">)</span><span class="op" id="1509182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509185">bucket</span>&nbsp;<span class="op" id="1509192">:=</span>&nbsp;<span class="ident" id="1509195">hash</span>&nbsp;<span class="op" id="1509200">&amp;</span>&nbsp;<span class="op" id="1509202">(</span><span class="builtintype" id="1509203">uintptr</span><span class="op" id="1509210">(</span><span class="num" id="1509211">1</span><span class="op" id="1509212">)</span><span class="op" id="1509213">&lt;&lt;</span><span class="ident" id="1509215">h</span><span class="op" id="1509216">.</span><span class="ident" id="1509217">B</span>&nbsp;<span class="op" id="1509219">-</span>&nbsp;<span class="num" id="1509221">1</span><span class="op" id="1509222">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509225">if</span>&nbsp;<span class="ident" id="1509228">h</span><span class="op" id="1509229">.</span><span class="ident" id="1509230">oldbuckets</span>&nbsp;<span class="op" id="1509241">!=</span>&nbsp;<span class="builtintype" id="1509244">nil</span>&nbsp;<span class="op" id="1509248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509252">growWork</span><span class="op" id="1509260">(</span><span class="ident" id="1509261">t</span><span class="op" id="1509262">,</span>&nbsp;<span class="ident" id="1509264">h</span><span class="op" id="1509265">,</span>&nbsp;<span class="ident" id="1509267">bucket</span><span class="op" id="1509273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509279">b</span>&nbsp;<span class="op" id="1509281">:=</span>&nbsp;<span class="op" id="1509284">(</span><span class="op" id="1509285">*</span><span class="ident" id="1509286">bmap</span><span class="op" id="1509290">)</span><span class="op" id="1509291">(</span><span class="ident" id="1509292">unsafe</span><span class="op" id="1509298">.</span><span class="ident" id="1509299">Pointer</span><span class="op" id="1509306">(</span><span class="builtintype" id="1509307">uintptr</span><span class="op" id="1509314">(</span><span class="ident" id="1509315">h</span><span class="op" id="1509316">.</span><span class="ident" id="1509317">buckets</span><span class="op" id="1509324">)</span>&nbsp;<span class="op" id="1509326">+</span>&nbsp;<span class="ident" id="1509328">bucket</span><span class="op" id="1509334">*</span><span class="builtintype" id="1509335">uintptr</span><span class="op" id="1509342">(</span><span class="ident" id="1509343">t</span><span class="op" id="1509344">.</span><span class="ident" id="1509345">bucketsize</span><span class="op" id="1509355">)</span><span class="op" id="1509356">)</span><span class="op" id="1509357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509360">top</span>&nbsp;<span class="op" id="1509364">:=</span>&nbsp;<span class="builtintype" id="1509367">uint8</span><span class="op" id="1509372">(</span><span class="ident" id="1509373">hash</span>&nbsp;<span class="op" id="1509378">&gt;&gt;</span>&nbsp;<span class="op" id="1509381">(</span><span class="ident" id="1509382">ptrSize</span><span class="op" id="1509389">*</span><span class="num" id="1509390">8</span>&nbsp;<span class="op" id="1509392">-</span>&nbsp;<span class="num" id="1509394">8</span><span class="op" id="1509395">)</span><span class="op" id="1509396">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509399">if</span>&nbsp;<span class="ident" id="1509402">top</span>&nbsp;<span class="op" id="1509406">&lt;</span>&nbsp;<span class="ident" id="1509408">minTopHash</span>&nbsp;<span class="op" id="1509419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509423">top</span>&nbsp;<span class="op" id="1509427">+=</span>&nbsp;<span class="ident" id="1509430">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509445">for</span>&nbsp;<span class="op" id="1509449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509453">for</span>&nbsp;<span class="ident" id="1509457">i</span>&nbsp;<span class="op" id="1509459">:=</span>&nbsp;<span class="builtintype" id="1509462">uintptr</span><span class="op" id="1509469">(</span><span class="num" id="1509470">0</span><span class="op" id="1509471">)</span><span class="op" id="1509472">;</span>&nbsp;<span class="ident" id="1509474">i</span>&nbsp;<span class="op" id="1509476">&lt;</span>&nbsp;<span class="ident" id="1509478">bucketCnt</span><span class="op" id="1509487">;</span>&nbsp;<span class="ident" id="1509489">i</span><span class="op" id="1509490">++</span>&nbsp;<span class="op" id="1509493">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509498">if</span>&nbsp;<span class="ident" id="1509501">b</span><span class="op" id="1509502">.</span><span class="ident" id="1509503">tophash</span><span class="op" id="1509510">[</span><span class="ident" id="1509511">i</span><span class="op" id="1509512">]</span>&nbsp;<span class="op" id="1509514">!=</span>&nbsp;<span class="ident" id="1509517">top</span>&nbsp;<span class="op" id="1509521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509527">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509544">k</span>&nbsp;<span class="op" id="1509546">:=</span>&nbsp;<span class="ident" id="1509549">add</span><span class="op" id="1509552">(</span><span class="ident" id="1509553">unsafe</span><span class="op" id="1509559">.</span><span class="ident" id="1509560">Pointer</span><span class="op" id="1509567">(</span><span class="ident" id="1509568">b</span><span class="op" id="1509569">)</span><span class="op" id="1509570">,</span>&nbsp;<span class="ident" id="1509572">dataOffset</span><span class="op" id="1509582">+</span><span class="ident" id="1509583">i</span><span class="op" id="1509584">*</span><span class="builtintype" id="1509585">uintptr</span><span class="op" id="1509592">(</span><span class="ident" id="1509593">t</span><span class="op" id="1509594">.</span><span class="ident" id="1509595">keysize</span><span class="op" id="1509602">)</span><span class="op" id="1509603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509608">k2</span>&nbsp;<span class="op" id="1509611">:=</span>&nbsp;<span class="ident" id="1509614">k</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509619">if</span>&nbsp;<span class="ident" id="1509622">t</span><span class="op" id="1509623">.</span><span class="ident" id="1509624">indirectkey</span>&nbsp;<span class="op" id="1509636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509642">k2</span>&nbsp;<span class="op" id="1509645">=</span>&nbsp;<span class="op" id="1509647">*</span><span class="op" id="1509648">(</span><span class="op" id="1509649">(</span><span class="op" id="1509650">*</span><span class="ident" id="1509651">unsafe</span><span class="op" id="1509657">.</span><span class="ident" id="1509658">Pointer</span><span class="op" id="1509665">)</span><span class="op" id="1509666">(</span><span class="ident" id="1509667">k2</span><span class="op" id="1509669">)</span><span class="op" id="1509670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509680">if</span>&nbsp;<span class="op" id="1509683">!</span><span class="ident" id="1509684">alg</span><span class="op" id="1509687">.</span><span class="ident" id="1509688">equal</span><span class="op" id="1509693">(</span><span class="ident" id="1509694">key</span><span class="op" id="1509697">,</span>&nbsp;<span class="ident" id="1509699">k2</span><span class="op" id="1509701">,</span>&nbsp;<span class="builtintype" id="1509703">uintptr</span><span class="op" id="1509710">(</span><span class="ident" id="1509711">t</span><span class="op" id="1509712">.</span><span class="ident" id="1509713">key</span><span class="op" id="1509716">.</span><span class="ident" id="1509717">size</span><span class="op" id="1509721">)</span><span class="op" id="1509722">)</span>&nbsp;<span class="op" id="1509724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509730">continue</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509747">memclr</span><span class="op" id="1509753">(</span><span class="ident" id="1509754">k</span><span class="op" id="1509755">,</span>&nbsp;<span class="builtintype" id="1509757">uintptr</span><span class="op" id="1509764">(</span><span class="ident" id="1509765">t</span><span class="op" id="1509766">.</span><span class="ident" id="1509767">keysize</span><span class="op" id="1509774">)</span><span class="op" id="1509775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509780">v</span>&nbsp;<span class="op" id="1509782">:=</span>&nbsp;<span class="ident" id="1509785">unsafe</span><span class="op" id="1509791">.</span><span class="ident" id="1509792">Pointer</span><span class="op" id="1509799">(</span><span class="builtintype" id="1509800">uintptr</span><span class="op" id="1509807">(</span><span class="ident" id="1509808">unsafe</span><span class="op" id="1509814">.</span><span class="ident" id="1509815">Pointer</span><span class="op" id="1509822">(</span><span class="ident" id="1509823">b</span><span class="op" id="1509824">)</span><span class="op" id="1509825">)</span>&nbsp;<span class="op" id="1509827">+</span>&nbsp;<span class="ident" id="1509829">dataOffset</span>&nbsp;<span class="op" id="1509840">+</span>&nbsp;<span class="ident" id="1509842">bucketCnt</span><span class="op" id="1509851">*</span><span class="builtintype" id="1509852">uintptr</span><span class="op" id="1509859">(</span><span class="ident" id="1509860">t</span><span class="op" id="1509861">.</span><span class="ident" id="1509862">keysize</span><span class="op" id="1509869">)</span>&nbsp;<span class="op" id="1509871">+</span>&nbsp;<span class="ident" id="1509873">i</span><span class="op" id="1509874">*</span><span class="builtintype" id="1509875">uintptr</span><span class="op" id="1509882">(</span><span class="ident" id="1509883">t</span><span class="op" id="1509884">.</span><span class="ident" id="1509885">valuesize</span><span class="op" id="1509894">)</span><span class="op" id="1509895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509900">memclr</span><span class="op" id="1509906">(</span><span class="ident" id="1509907">v</span><span class="op" id="1509908">,</span>&nbsp;<span class="builtintype" id="1509910">uintptr</span><span class="op" id="1509917">(</span><span class="ident" id="1509918">t</span><span class="op" id="1509919">.</span><span class="ident" id="1509920">valuesize</span><span class="op" id="1509929">)</span><span class="op" id="1509930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509935">b</span><span class="op" id="1509936">.</span><span class="ident" id="1509937">tophash</span><span class="op" id="1509944">[</span><span class="ident" id="1509945">i</span><span class="op" id="1509946">]</span>&nbsp;<span class="op" id="1509948">=</span>&nbsp;<span class="ident" id="1509950">empty</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509959">h</span><span class="op" id="1509960">.</span><span class="ident" id="1509961">count</span><span class="op" id="1509966">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509972">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509985">b</span>&nbsp;<span class="op" id="1509987">=</span>&nbsp;<span class="ident" id="1509989">b</span><span class="op" id="1509990">.</span><span class="ident" id="1509991">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510002">if</span>&nbsp;<span class="ident" id="1510005">b</span>&nbsp;<span class="op" id="1510007">==</span>&nbsp;<span class="builtintype" id="1510010">nil</span>&nbsp;<span class="op" id="1510014">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510019">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510031">}</span><br>
<span class="lineno"></span><span class="op" id="1510033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="1510036">func</span>&nbsp;<span class="ident" id="1510041">mapiterinit</span><span class="op" id="1510052">(</span><span class="ident" id="1510053">t</span>&nbsp;<span class="op" id="1510055">*</span><span class="ident" id="1510056">maptype</span><span class="op" id="1510063">,</span>&nbsp;<span class="ident" id="1510065">h</span>&nbsp;<span class="op" id="1510067">*</span><span class="ident" id="1510068">hmap</span><span class="op" id="1510072">,</span>&nbsp;<span class="ident" id="1510074">it</span>&nbsp;<span class="op" id="1510077">*</span><span class="ident" id="1510078">hiter</span><span class="op" id="1510083">)</span>&nbsp;<span class="op" id="1510085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1510088">//&nbsp;Clear&nbsp;pointer&nbsp;fields&nbsp;so&nbsp;garbage&nbsp;collector&nbsp;does&nbsp;not&nbsp;complain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510153">it</span><span class="op" id="1510155">.</span><span class="ident" id="1510156">key</span>&nbsp;<span class="op" id="1510160">=</span>&nbsp;<span class="builtintype" id="1510162">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510167">it</span><span class="op" id="1510169">.</span><span class="ident" id="1510170">value</span>&nbsp;<span class="op" id="1510176">=</span>&nbsp;<span class="builtintype" id="1510178">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510183">it</span><span class="op" id="1510185">.</span><span class="ident" id="1510186">t</span>&nbsp;<span class="op" id="1510188">=</span>&nbsp;<span class="builtintype" id="1510190">nil</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510195">it</span><span class="op" id="1510197">.</span><span class="ident" id="1510198">h</span>&nbsp;<span class="op" id="1510200">=</span>&nbsp;<span class="builtintype" id="1510202">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510207">it</span><span class="op" id="1510209">.</span><span class="ident" id="1510210">buckets</span>&nbsp;<span class="op" id="1510218">=</span>&nbsp;<span class="builtintype" id="1510220">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510225">it</span><span class="op" id="1510227">.</span><span class="ident" id="1510228">bptr</span>&nbsp;<span class="op" id="1510233">=</span>&nbsp;<span class="builtintype" id="1510235">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510241">if</span>&nbsp;<span class="ident" id="1510244">raceenabled</span>&nbsp;<span class="op" id="1510256">&amp;&amp;</span>&nbsp;<span class="ident" id="1510259">h</span>&nbsp;<span class="op" id="1510261">!=</span>&nbsp;<span class="builtintype" id="1510264">nil</span>&nbsp;<span class="op" id="1510268">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510272">callerpc</span>&nbsp;<span class="op" id="1510281">:=</span>&nbsp;<span class="ident" id="1510284">getcallerpc</span><span class="op" id="1510295">(</span><span class="ident" id="1510296">unsafe</span><span class="op" id="1510302">.</span><span class="ident" id="1510303">Pointer</span><span class="op" id="1510310">(</span><span class="op" id="1510311">&amp;</span><span class="ident" id="1510312">t</span><span class="op" id="1510313">)</span><span class="op" id="1510314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510318">racereadpc</span><span class="op" id="1510328">(</span><span class="ident" id="1510329">unsafe</span><span class="op" id="1510335">.</span><span class="ident" id="1510336">Pointer</span><span class="op" id="1510343">(</span><span class="ident" id="1510344">h</span><span class="op" id="1510345">)</span><span class="op" id="1510346">,</span>&nbsp;<span class="ident" id="1510348">callerpc</span><span class="op" id="1510356">,</span>&nbsp;<span class="ident" id="1510358">funcPC</span><span class="op" id="1510364">(</span><span class="ident" id="1510365">mapiterinit</span><span class="op" id="1510376">)</span><span class="op" id="1510377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510384">if</span>&nbsp;<span class="ident" id="1510387">h</span>&nbsp;<span class="op" id="1510389">==</span>&nbsp;<span class="builtintype" id="1510392">nil</span>&nbsp;<span class="op" id="1510396">||</span>&nbsp;<span class="ident" id="1510399">h</span><span class="op" id="1510400">.</span><span class="ident" id="1510401">count</span>&nbsp;<span class="op" id="1510407">==</span>&nbsp;<span class="num" id="1510410">0</span>&nbsp;<span class="op" id="1510412">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510416">it</span><span class="op" id="1510418">.</span><span class="ident" id="1510419">key</span>&nbsp;<span class="op" id="1510423">=</span>&nbsp;<span class="builtintype" id="1510425">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510431">it</span><span class="op" id="1510433">.</span><span class="ident" id="1510434">value</span>&nbsp;<span class="op" id="1510440">=</span>&nbsp;<span class="builtintype" id="1510442">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510448">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510460">if</span>&nbsp;<span class="ident" id="1510463">unsafe</span><span class="op" id="1510469">.</span><span class="ident" id="1510470">Sizeof</span><span class="op" id="1510476">(</span><span class="ident" id="1510477">hiter</span><span class="op" id="1510482">{</span><span class="op" id="1510483">}</span><span class="op" id="1510484">)</span><span class="op" id="1510485">/</span><span class="ident" id="1510486">ptrSize</span>&nbsp;<span class="op" id="1510494">!=</span>&nbsp;<span class="num" id="1510497">10</span>&nbsp;<span class="op" id="1510500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510504">gothrow</span><span class="op" id="1510511">(</span><span class="string" id="1510512">&#34;hash_iter&nbsp;size&nbsp;incorrect&#34;</span><span class="op" id="1510538">)</span>&nbsp;<span class="comment" id="1510540">//&nbsp;see&nbsp;../../cmd/gc/reflect.c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510574">it</span><span class="op" id="1510576">.</span><span class="ident" id="1510577">t</span>&nbsp;<span class="op" id="1510579">=</span>&nbsp;<span class="ident" id="1510581">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510584">it</span><span class="op" id="1510586">.</span><span class="ident" id="1510587">h</span>&nbsp;<span class="op" id="1510589">=</span>&nbsp;<span class="ident" id="1510591">h</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1510595">//&nbsp;grab&nbsp;snapshot&nbsp;of&nbsp;bucket&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510629">it</span><span class="op" id="1510631">.</span><span class="ident" id="1510632">B</span>&nbsp;<span class="op" id="1510634">=</span>&nbsp;<span class="ident" id="1510636">h</span><span class="op" id="1510637">.</span><span class="ident" id="1510638">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510641">it</span><span class="op" id="1510643">.</span><span class="ident" id="1510644">buckets</span>&nbsp;<span class="op" id="1510652">=</span>&nbsp;<span class="ident" id="1510654">h</span><span class="op" id="1510655">.</span><span class="ident" id="1510656">buckets</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1510666">//&nbsp;decide&nbsp;where&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510692">r</span>&nbsp;<span class="op" id="1510694">:=</span>&nbsp;<span class="builtintype" id="1510697">uintptr</span><span class="op" id="1510704">(</span><span class="ident" id="1510705">fastrand1</span><span class="op" id="1510714">(</span><span class="op" id="1510715">)</span><span class="op" id="1510716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510719">if</span>&nbsp;<span class="ident" id="1510722">h</span><span class="op" id="1510723">.</span><span class="ident" id="1510724">B</span>&nbsp;<span class="op" id="1510726">&gt;</span>&nbsp;<span class="num" id="1510728">31</span><span class="op" id="1510730">-</span><span class="ident" id="1510731">bucketCntBits</span>&nbsp;<span class="op" id="1510745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510749">r</span>&nbsp;<span class="op" id="1510751">+=</span>&nbsp;<span class="builtintype" id="1510754">uintptr</span><span class="op" id="1510761">(</span><span class="ident" id="1510762">fastrand1</span><span class="op" id="1510771">(</span><span class="op" id="1510772">)</span><span class="op" id="1510773">)</span>&nbsp;<span class="op" id="1510775">&lt;&lt;</span>&nbsp;<span class="num" id="1510778">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510782">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510785">it</span><span class="op" id="1510787">.</span><span class="ident" id="1510788">startBucket</span>&nbsp;<span class="op" id="1510800">=</span>&nbsp;<span class="ident" id="1510802">r</span>&nbsp;<span class="op" id="1510804">&amp;</span>&nbsp;<span class="op" id="1510806">(</span><span class="builtintype" id="1510807">uintptr</span><span class="op" id="1510814">(</span><span class="num" id="1510815">1</span><span class="op" id="1510816">)</span><span class="op" id="1510817">&lt;&lt;</span><span class="ident" id="1510819">h</span><span class="op" id="1510820">.</span><span class="ident" id="1510821">B</span>&nbsp;<span class="op" id="1510823">-</span>&nbsp;<span class="num" id="1510825">1</span><span class="op" id="1510826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510829">it</span><span class="op" id="1510831">.</span><span class="ident" id="1510832">offset</span>&nbsp;<span class="op" id="1510839">=</span>&nbsp;<span class="builtintype" id="1510841">uint8</span><span class="op" id="1510846">(</span><span class="ident" id="1510847">r</span>&nbsp;<span class="op" id="1510849">&gt;&gt;</span>&nbsp;<span class="ident" id="1510852">h</span><span class="op" id="1510853">.</span><span class="ident" id="1510854">B</span>&nbsp;<span class="op" id="1510856">&amp;</span>&nbsp;<span class="op" id="1510858">(</span><span class="ident" id="1510859">bucketCnt</span>&nbsp;<span class="op" id="1510869">-</span>&nbsp;<span class="num" id="1510871">1</span><span class="op" id="1510872">)</span><span class="op" id="1510873">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1510877">//&nbsp;iterator&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510896">it</span><span class="op" id="1510898">.</span><span class="ident" id="1510899">bucket</span>&nbsp;<span class="op" id="1510906">=</span>&nbsp;<span class="ident" id="1510908">it</span><span class="op" id="1510910">.</span><span class="ident" id="1510911">startBucket</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510924">it</span><span class="op" id="1510926">.</span><span class="ident" id="1510927">wrapped</span>&nbsp;<span class="op" id="1510935">=</span>&nbsp;<span class="builtintype" id="1510937">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510944">it</span><span class="op" id="1510946">.</span><span class="ident" id="1510947">bptr</span>&nbsp;<span class="op" id="1510952">=</span>&nbsp;<span class="builtintype" id="1510954">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1510960">//&nbsp;Remember&nbsp;we&nbsp;have&nbsp;an&nbsp;iterator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1510994">//&nbsp;Can&nbsp;run&nbsp;concurrently&nbsp;with&nbsp;another&nbsp;hash_iter_init().</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511050">for</span>&nbsp;<span class="op" id="1511054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511058">old</span>&nbsp;<span class="op" id="1511062">:=</span>&nbsp;<span class="ident" id="1511065">h</span><span class="op" id="1511066">.</span><span class="ident" id="1511067">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511075">if</span>&nbsp;<span class="ident" id="1511078">old</span>&nbsp;<span class="op" id="1511082">==</span>&nbsp;<span class="ident" id="1511085">old</span><span class="op" id="1511088">|</span><span class="ident" id="1511089">iterator</span><span class="op" id="1511097">|</span><span class="ident" id="1511098">oldIterator</span>&nbsp;<span class="op" id="1511110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511115">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511123">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511127">if</span>&nbsp;<span class="ident" id="1511130">cas</span><span class="op" id="1511133">(</span><span class="op" id="1511134">&amp;</span><span class="ident" id="1511135">h</span><span class="op" id="1511136">.</span><span class="ident" id="1511137">flags</span><span class="op" id="1511142">,</span>&nbsp;<span class="ident" id="1511144">old</span><span class="op" id="1511147">,</span>&nbsp;<span class="ident" id="1511149">old</span><span class="op" id="1511152">|</span><span class="ident" id="1511153">iterator</span><span class="op" id="1511161">|</span><span class="ident" id="1511162">oldIterator</span><span class="op" id="1511173">)</span>&nbsp;<span class="op" id="1511175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511180">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511195">mapiternext</span><span class="op" id="1511206">(</span><span class="ident" id="1511207">it</span><span class="op" id="1511209">)</span><br>
<span class="lineno"></span><span class="op" id="1511211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1511214">func</span>&nbsp;<span class="ident" id="1511219">mapiternext</span><span class="op" id="1511230">(</span><span class="ident" id="1511231">it</span>&nbsp;<span class="op" id="1511234">*</span><span class="ident" id="1511235">hiter</span><span class="op" id="1511240">)</span>&nbsp;<span class="op" id="1511242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511245">h</span>&nbsp;<span class="op" id="1511247">:=</span>&nbsp;<span class="ident" id="1511250">it</span><span class="op" id="1511252">.</span><span class="ident" id="1511253">h</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511256">if</span>&nbsp;<span class="ident" id="1511259">raceenabled</span>&nbsp;<span class="op" id="1511271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511275">callerpc</span>&nbsp;<span class="op" id="1511284">:=</span>&nbsp;<span class="ident" id="1511287">getcallerpc</span><span class="op" id="1511298">(</span><span class="ident" id="1511299">unsafe</span><span class="op" id="1511305">.</span><span class="ident" id="1511306">Pointer</span><span class="op" id="1511313">(</span><span class="op" id="1511314">&amp;</span><span class="ident" id="1511315">it</span><span class="op" id="1511317">)</span><span class="op" id="1511318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511322">racereadpc</span><span class="op" id="1511332">(</span><span class="ident" id="1511333">unsafe</span><span class="op" id="1511339">.</span><span class="ident" id="1511340">Pointer</span><span class="op" id="1511347">(</span><span class="ident" id="1511348">h</span><span class="op" id="1511349">)</span><span class="op" id="1511350">,</span>&nbsp;<span class="ident" id="1511352">callerpc</span><span class="op" id="1511360">,</span>&nbsp;<span class="ident" id="1511362">funcPC</span><span class="op" id="1511368">(</span><span class="ident" id="1511369">mapiternext</span><span class="op" id="1511380">)</span><span class="op" id="1511381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511387">t</span>&nbsp;<span class="op" id="1511389">:=</span>&nbsp;<span class="ident" id="1511392">it</span><span class="op" id="1511394">.</span><span class="ident" id="1511395">t</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511398">bucket</span>&nbsp;<span class="op" id="1511405">:=</span>&nbsp;<span class="ident" id="1511408">it</span><span class="op" id="1511410">.</span><span class="ident" id="1511411">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511419">b</span>&nbsp;<span class="op" id="1511421">:=</span>&nbsp;<span class="ident" id="1511424">it</span><span class="op" id="1511426">.</span><span class="ident" id="1511427">bptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511433">i</span>&nbsp;<span class="op" id="1511435">:=</span>&nbsp;<span class="ident" id="1511438">it</span><span class="op" id="1511440">.</span><span class="ident" id="1511441">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511444">checkBucket</span>&nbsp;<span class="op" id="1511456">:=</span>&nbsp;<span class="ident" id="1511459">it</span><span class="op" id="1511461">.</span><span class="ident" id="1511462">checkBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511475">alg</span>&nbsp;<span class="op" id="1511479">:=</span>&nbsp;<span class="ident" id="1511482">goalg</span><span class="op" id="1511487">(</span><span class="ident" id="1511488">t</span><span class="op" id="1511489">.</span><span class="ident" id="1511490">key</span><span class="op" id="1511493">.</span><span class="ident" id="1511494">alg</span><span class="op" id="1511497">)</span><br>
<span class="lineno">605</span><br>
<span class="lineno"></span><span class="ident" id="1511500">next</span><span class="op" id="1511504">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511507">if</span>&nbsp;<span class="ident" id="1511510">b</span>&nbsp;<span class="op" id="1511512">==</span>&nbsp;<span class="builtintype" id="1511515">nil</span>&nbsp;<span class="op" id="1511519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511523">if</span>&nbsp;<span class="ident" id="1511526">bucket</span>&nbsp;<span class="op" id="1511533">==</span>&nbsp;<span class="ident" id="1511536">it</span><span class="op" id="1511538">.</span><span class="ident" id="1511539">startBucket</span>&nbsp;<span class="op" id="1511551">&amp;&amp;</span>&nbsp;<span class="ident" id="1511554">it</span><span class="op" id="1511556">.</span><span class="ident" id="1511557">wrapped</span>&nbsp;<span class="op" id="1511565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1511570">//&nbsp;end&nbsp;of&nbsp;iteration</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511593">it</span><span class="op" id="1511595">.</span><span class="ident" id="1511596">key</span>&nbsp;<span class="op" id="1511600">=</span>&nbsp;<span class="builtintype" id="1511602">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511609">it</span><span class="op" id="1511611">.</span><span class="ident" id="1511612">value</span>&nbsp;<span class="op" id="1511618">=</span>&nbsp;<span class="builtintype" id="1511620">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511627">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511640">if</span>&nbsp;<span class="ident" id="1511643">h</span><span class="op" id="1511644">.</span><span class="ident" id="1511645">oldbuckets</span>&nbsp;<span class="op" id="1511656">!=</span>&nbsp;<span class="builtintype" id="1511659">nil</span>&nbsp;<span class="op" id="1511663">&amp;&amp;</span>&nbsp;<span class="ident" id="1511666">it</span><span class="op" id="1511668">.</span><span class="ident" id="1511669">B</span>&nbsp;<span class="op" id="1511671">==</span>&nbsp;<span class="ident" id="1511674">h</span><span class="op" id="1511675">.</span><span class="ident" id="1511676">B</span>&nbsp;<span class="op" id="1511678">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1511683">//&nbsp;Iterator&nbsp;was&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;grow,&nbsp;and&nbsp;the&nbsp;grow&nbsp;isn&#39;t&nbsp;done&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1511764">//&nbsp;If&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;looking&nbsp;at&nbsp;hasn&#39;t&nbsp;been&nbsp;filled&nbsp;in&nbsp;yet&nbsp;(i.e.&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1511841">//&nbsp;bucket&nbsp;hasn&#39;t&nbsp;been&nbsp;evacuated)&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;iterate&nbsp;through&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1511917">//&nbsp;bucket&nbsp;and&nbsp;only&nbsp;return&nbsp;the&nbsp;ones&nbsp;that&nbsp;will&nbsp;be&nbsp;migrated&nbsp;to&nbsp;this&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511993">oldbucket</span>&nbsp;<span class="op" id="1512003">:=</span>&nbsp;<span class="ident" id="1512006">bucket</span>&nbsp;<span class="op" id="1512013">&amp;</span>&nbsp;<span class="op" id="1512015">(</span><span class="builtintype" id="1512016">uintptr</span><span class="op" id="1512023">(</span><span class="num" id="1512024">1</span><span class="op" id="1512025">)</span><span class="op" id="1512026">&lt;&lt;</span><span class="op" id="1512028">(</span><span class="ident" id="1512029">it</span><span class="op" id="1512031">.</span><span class="ident" id="1512032">B</span><span class="op" id="1512033">-</span><span class="num" id="1512034">1</span><span class="op" id="1512035">)</span>&nbsp;<span class="op" id="1512037">-</span>&nbsp;<span class="num" id="1512039">1</span><span class="op" id="1512040">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512045">b</span>&nbsp;<span class="op" id="1512047">=</span>&nbsp;<span class="op" id="1512049">(</span><span class="op" id="1512050">*</span><span class="ident" id="1512051">bmap</span><span class="op" id="1512055">)</span><span class="op" id="1512056">(</span><span class="ident" id="1512057">add</span><span class="op" id="1512060">(</span><span class="ident" id="1512061">h</span><span class="op" id="1512062">.</span><span class="ident" id="1512063">oldbuckets</span><span class="op" id="1512073">,</span>&nbsp;<span class="ident" id="1512075">oldbucket</span><span class="op" id="1512084">*</span><span class="builtintype" id="1512085">uintptr</span><span class="op" id="1512092">(</span><span class="ident" id="1512093">t</span><span class="op" id="1512094">.</span><span class="ident" id="1512095">bucketsize</span><span class="op" id="1512105">)</span><span class="op" id="1512106">)</span><span class="op" id="1512107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512112">if</span>&nbsp;<span class="op" id="1512115">!</span><span class="ident" id="1512116">evacuated</span><span class="op" id="1512125">(</span><span class="ident" id="1512126">b</span><span class="op" id="1512127">)</span>&nbsp;<span class="op" id="1512129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512135">checkBucket</span>&nbsp;<span class="op" id="1512147">=</span>&nbsp;<span class="ident" id="1512149">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512159">}</span>&nbsp;<span class="keyword" id="1512161">else</span>&nbsp;<span class="op" id="1512166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512172">b</span>&nbsp;<span class="op" id="1512174">=</span>&nbsp;<span class="op" id="1512176">(</span><span class="op" id="1512177">*</span><span class="ident" id="1512178">bmap</span><span class="op" id="1512182">)</span><span class="op" id="1512183">(</span><span class="ident" id="1512184">add</span><span class="op" id="1512187">(</span><span class="ident" id="1512188">it</span><span class="op" id="1512190">.</span><span class="ident" id="1512191">buckets</span><span class="op" id="1512198">,</span>&nbsp;<span class="ident" id="1512200">bucket</span><span class="op" id="1512206">*</span><span class="builtintype" id="1512207">uintptr</span><span class="op" id="1512214">(</span><span class="ident" id="1512215">t</span><span class="op" id="1512216">.</span><span class="ident" id="1512217">bucketsize</span><span class="op" id="1512227">)</span><span class="op" id="1512228">)</span><span class="op" id="1512229">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512235">checkBucket</span>&nbsp;<span class="op" id="1512247">=</span>&nbsp;<span class="ident" id="1512249">noCheck</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512264">}</span>&nbsp;<span class="keyword" id="1512266">else</span>&nbsp;<span class="op" id="1512271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512276">b</span>&nbsp;<span class="op" id="1512278">=</span>&nbsp;<span class="op" id="1512280">(</span><span class="op" id="1512281">*</span><span class="ident" id="1512282">bmap</span><span class="op" id="1512286">)</span><span class="op" id="1512287">(</span><span class="ident" id="1512288">add</span><span class="op" id="1512291">(</span><span class="ident" id="1512292">it</span><span class="op" id="1512294">.</span><span class="ident" id="1512295">buckets</span><span class="op" id="1512302">,</span>&nbsp;<span class="ident" id="1512304">bucket</span><span class="op" id="1512310">*</span><span class="builtintype" id="1512311">uintptr</span><span class="op" id="1512318">(</span><span class="ident" id="1512319">t</span><span class="op" id="1512320">.</span><span class="ident" id="1512321">bucketsize</span><span class="op" id="1512331">)</span><span class="op" id="1512332">)</span><span class="op" id="1512333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512338">checkBucket</span>&nbsp;<span class="op" id="1512350">=</span>&nbsp;<span class="ident" id="1512352">noCheck</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512366">bucket</span><span class="op" id="1512372">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512377">if</span>&nbsp;<span class="ident" id="1512380">bucket</span>&nbsp;<span class="op" id="1512387">==</span>&nbsp;<span class="builtintype" id="1512390">uintptr</span><span class="op" id="1512397">(</span><span class="num" id="1512398">1</span><span class="op" id="1512399">)</span><span class="op" id="1512400">&lt;&lt;</span><span class="ident" id="1512402">it</span><span class="op" id="1512404">.</span><span class="ident" id="1512405">B</span>&nbsp;<span class="op" id="1512407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512412">bucket</span>&nbsp;<span class="op" id="1512419">=</span>&nbsp;<span class="num" id="1512421">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512426">it</span><span class="op" id="1512428">.</span><span class="ident" id="1512429">wrapped</span>&nbsp;<span class="op" id="1512437">=</span>&nbsp;<span class="builtintype" id="1512439">true</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512450">i</span>&nbsp;<span class="op" id="1512452">=</span>&nbsp;<span class="num" id="1512454">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512460">for</span>&nbsp;<span class="op" id="1512464">;</span>&nbsp;<span class="ident" id="1512466">i</span>&nbsp;<span class="op" id="1512468">&lt;</span>&nbsp;<span class="ident" id="1512470">bucketCnt</span><span class="op" id="1512479">;</span>&nbsp;<span class="ident" id="1512481">i</span><span class="op" id="1512482">++</span>&nbsp;<span class="op" id="1512485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512489">offi</span>&nbsp;<span class="op" id="1512494">:=</span>&nbsp;<span class="op" id="1512497">(</span><span class="ident" id="1512498">i</span>&nbsp;<span class="op" id="1512500">+</span>&nbsp;<span class="ident" id="1512502">it</span><span class="op" id="1512504">.</span><span class="ident" id="1512505">offset</span><span class="op" id="1512511">)</span>&nbsp;<span class="op" id="1512513">&amp;</span>&nbsp;<span class="op" id="1512515">(</span><span class="ident" id="1512516">bucketCnt</span>&nbsp;<span class="op" id="1512526">-</span>&nbsp;<span class="num" id="1512528">1</span><span class="op" id="1512529">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512533">k</span>&nbsp;<span class="op" id="1512535">:=</span>&nbsp;<span class="ident" id="1512538">add</span><span class="op" id="1512541">(</span><span class="ident" id="1512542">unsafe</span><span class="op" id="1512548">.</span><span class="ident" id="1512549">Pointer</span><span class="op" id="1512556">(</span><span class="ident" id="1512557">b</span><span class="op" id="1512558">)</span><span class="op" id="1512559">,</span>&nbsp;<span class="ident" id="1512561">dataOffset</span><span class="op" id="1512571">+</span><span class="builtintype" id="1512572">uintptr</span><span class="op" id="1512579">(</span><span class="ident" id="1512580">offi</span><span class="op" id="1512584">)</span><span class="op" id="1512585">*</span><span class="builtintype" id="1512586">uintptr</span><span class="op" id="1512593">(</span><span class="ident" id="1512594">t</span><span class="op" id="1512595">.</span><span class="ident" id="1512596">keysize</span><span class="op" id="1512603">)</span><span class="op" id="1512604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512608">v</span>&nbsp;<span class="op" id="1512610">:=</span>&nbsp;<span class="ident" id="1512613">add</span><span class="op" id="1512616">(</span><span class="ident" id="1512617">unsafe</span><span class="op" id="1512623">.</span><span class="ident" id="1512624">Pointer</span><span class="op" id="1512631">(</span><span class="ident" id="1512632">b</span><span class="op" id="1512633">)</span><span class="op" id="1512634">,</span>&nbsp;<span class="ident" id="1512636">dataOffset</span><span class="op" id="1512646">+</span><span class="ident" id="1512647">bucketCnt</span><span class="op" id="1512656">*</span><span class="builtintype" id="1512657">uintptr</span><span class="op" id="1512664">(</span><span class="ident" id="1512665">t</span><span class="op" id="1512666">.</span><span class="ident" id="1512667">keysize</span><span class="op" id="1512674">)</span><span class="op" id="1512675">+</span><span class="builtintype" id="1512676">uintptr</span><span class="op" id="1512683">(</span><span class="ident" id="1512684">offi</span><span class="op" id="1512688">)</span><span class="op" id="1512689">*</span><span class="builtintype" id="1512690">uintptr</span><span class="op" id="1512697">(</span><span class="ident" id="1512698">t</span><span class="op" id="1512699">.</span><span class="ident" id="1512700">valuesize</span><span class="op" id="1512709">)</span><span class="op" id="1512710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512714">if</span>&nbsp;<span class="ident" id="1512717">b</span><span class="op" id="1512718">.</span><span class="ident" id="1512719">tophash</span><span class="op" id="1512726">[</span><span class="ident" id="1512727">offi</span><span class="op" id="1512731">]</span>&nbsp;<span class="op" id="1512733">!=</span>&nbsp;<span class="ident" id="1512736">empty</span>&nbsp;<span class="op" id="1512742">&amp;&amp;</span>&nbsp;<span class="ident" id="1512745">b</span><span class="op" id="1512746">.</span><span class="ident" id="1512747">tophash</span><span class="op" id="1512754">[</span><span class="ident" id="1512755">offi</span><span class="op" id="1512759">]</span>&nbsp;<span class="op" id="1512761">!=</span>&nbsp;<span class="ident" id="1512764">evacuatedEmpty</span>&nbsp;<span class="op" id="1512779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512784">if</span>&nbsp;<span class="ident" id="1512787">checkBucket</span>&nbsp;<span class="op" id="1512799">!=</span>&nbsp;<span class="ident" id="1512802">noCheck</span>&nbsp;<span class="op" id="1512810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1512816">//&nbsp;Special&nbsp;case:&nbsp;iterator&nbsp;was&nbsp;started&nbsp;during&nbsp;a&nbsp;grow&nbsp;and&nbsp;the</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1512880">//&nbsp;grow&nbsp;is&nbsp;not&nbsp;done&nbsp;yet.&nbsp;&nbsp;We&#39;re&nbsp;working&nbsp;on&nbsp;a&nbsp;bucket&nbsp;whose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1512942">//&nbsp;oldbucket&nbsp;has&nbsp;not&nbsp;been&nbsp;evacuated&nbsp;yet.&nbsp;&nbsp;Or&nbsp;at&nbsp;least,&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513011">//&nbsp;evacuated&nbsp;when&nbsp;we&nbsp;started&nbsp;the&nbsp;bucket.&nbsp;&nbsp;So&nbsp;we&#39;re&nbsp;iterating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513076">//&nbsp;through&nbsp;the&nbsp;oldbucket,&nbsp;skipping&nbsp;any&nbsp;keys&nbsp;that&nbsp;will&nbsp;go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513137">//&nbsp;to&nbsp;the&nbsp;other&nbsp;new&nbsp;bucket&nbsp;(each&nbsp;oldbucket&nbsp;expands&nbsp;to&nbsp;two</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513199">//&nbsp;buckets&nbsp;during&nbsp;a&nbsp;grow).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513230">k2</span>&nbsp;<span class="op" id="1513233">:=</span>&nbsp;<span class="ident" id="1513236">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513242">if</span>&nbsp;<span class="ident" id="1513245">t</span><span class="op" id="1513246">.</span><span class="ident" id="1513247">indirectkey</span>&nbsp;<span class="op" id="1513259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513266">k2</span>&nbsp;<span class="op" id="1513269">=</span>&nbsp;<span class="op" id="1513271">*</span><span class="op" id="1513272">(</span><span class="op" id="1513273">(</span><span class="op" id="1513274">*</span><span class="ident" id="1513275">unsafe</span><span class="op" id="1513281">.</span><span class="ident" id="1513282">Pointer</span><span class="op" id="1513289">)</span><span class="op" id="1513290">(</span><span class="ident" id="1513291">k2</span><span class="op" id="1513293">)</span><span class="op" id="1513294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513300">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513306">if</span>&nbsp;<span class="ident" id="1513309">alg</span><span class="op" id="1513312">.</span><span class="ident" id="1513313">equal</span><span class="op" id="1513318">(</span><span class="ident" id="1513319">k2</span><span class="op" id="1513321">,</span>&nbsp;<span class="ident" id="1513323">k2</span><span class="op" id="1513325">,</span>&nbsp;<span class="builtintype" id="1513327">uintptr</span><span class="op" id="1513334">(</span><span class="ident" id="1513335">t</span><span class="op" id="1513336">.</span><span class="ident" id="1513337">key</span><span class="op" id="1513340">.</span><span class="ident" id="1513341">size</span><span class="op" id="1513345">)</span><span class="op" id="1513346">)</span>&nbsp;<span class="op" id="1513348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513355">//&nbsp;If&nbsp;the&nbsp;item&nbsp;in&nbsp;the&nbsp;oldbucket&nbsp;is&nbsp;not&nbsp;destined&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513412">//&nbsp;the&nbsp;current&nbsp;new&nbsp;bucket&nbsp;in&nbsp;the&nbsp;iteration,&nbsp;skip&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513470">hash</span>&nbsp;<span class="op" id="1513475">:=</span>&nbsp;<span class="ident" id="1513478">alg</span><span class="op" id="1513481">.</span><span class="ident" id="1513482">hash</span><span class="op" id="1513486">(</span><span class="ident" id="1513487">k2</span><span class="op" id="1513489">,</span>&nbsp;<span class="builtintype" id="1513491">uintptr</span><span class="op" id="1513498">(</span><span class="ident" id="1513499">t</span><span class="op" id="1513500">.</span><span class="ident" id="1513501">key</span><span class="op" id="1513504">.</span><span class="ident" id="1513505">size</span><span class="op" id="1513509">)</span><span class="op" id="1513510">,</span>&nbsp;<span class="builtintype" id="1513512">uintptr</span><span class="op" id="1513519">(</span><span class="ident" id="1513520">h</span><span class="op" id="1513521">.</span><span class="ident" id="1513522">hash0</span><span class="op" id="1513527">)</span><span class="op" id="1513528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513535">if</span>&nbsp;<span class="ident" id="1513538">hash</span><span class="op" id="1513542">&amp;</span><span class="op" id="1513543">(</span><span class="builtintype" id="1513544">uintptr</span><span class="op" id="1513551">(</span><span class="num" id="1513552">1</span><span class="op" id="1513553">)</span><span class="op" id="1513554">&lt;&lt;</span><span class="ident" id="1513556">it</span><span class="op" id="1513558">.</span><span class="ident" id="1513559">B</span><span class="op" id="1513560">-</span><span class="num" id="1513561">1</span><span class="op" id="1513562">)</span>&nbsp;<span class="op" id="1513564">!=</span>&nbsp;<span class="ident" id="1513567">checkBucket</span>&nbsp;<span class="op" id="1513579">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513587">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513607">}</span>&nbsp;<span class="keyword" id="1513609">else</span>&nbsp;<span class="op" id="1513614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513621">//&nbsp;Hash&nbsp;isn&#39;t&nbsp;repeatable&nbsp;if&nbsp;k&nbsp;!=&nbsp;k&nbsp;(NaNs).&nbsp;&nbsp;We&nbsp;need&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513680">//&nbsp;repeatable&nbsp;and&nbsp;randomish&nbsp;choice&nbsp;of&nbsp;which&nbsp;direction</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513739">//&nbsp;to&nbsp;send&nbsp;NaNs&nbsp;during&nbsp;evacuation.&nbsp;&nbsp;We&#39;ll&nbsp;use&nbsp;the&nbsp;low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513798">//&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;to&nbsp;decide&nbsp;which&nbsp;way&nbsp;NaNs&nbsp;go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513850">//&nbsp;NOTE:&nbsp;this&nbsp;case&nbsp;is&nbsp;why&nbsp;we&nbsp;need&nbsp;two&nbsp;evacuate&nbsp;tophash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513910">//&nbsp;values,&nbsp;evacuatedX&nbsp;and&nbsp;evacuatedY,&nbsp;that&nbsp;differ&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513968">//&nbsp;their&nbsp;low&nbsp;bit.</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513991">if</span>&nbsp;<span class="ident" id="1513994">checkBucket</span><span class="op" id="1514005">&gt;&gt;</span><span class="op" id="1514007">(</span><span class="ident" id="1514008">it</span><span class="op" id="1514010">.</span><span class="ident" id="1514011">B</span><span class="op" id="1514012">-</span><span class="num" id="1514013">1</span><span class="op" id="1514014">)</span>&nbsp;<span class="op" id="1514016">!=</span>&nbsp;<span class="builtintype" id="1514019">uintptr</span><span class="op" id="1514026">(</span><span class="ident" id="1514027">b</span><span class="op" id="1514028">.</span><span class="ident" id="1514029">tophash</span><span class="op" id="1514036">[</span><span class="ident" id="1514037">offi</span><span class="op" id="1514041">]</span><span class="op" id="1514042">&amp;</span><span class="num" id="1514043">1</span><span class="op" id="1514044">)</span>&nbsp;<span class="op" id="1514046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514054">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514079">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514084">if</span>&nbsp;<span class="ident" id="1514087">b</span><span class="op" id="1514088">.</span><span class="ident" id="1514089">tophash</span><span class="op" id="1514096">[</span><span class="ident" id="1514097">offi</span><span class="op" id="1514101">]</span>&nbsp;<span class="op" id="1514103">!=</span>&nbsp;<span class="ident" id="1514106">evacuatedX</span>&nbsp;<span class="op" id="1514117">&amp;&amp;</span>&nbsp;<span class="ident" id="1514120">b</span><span class="op" id="1514121">.</span><span class="ident" id="1514122">tophash</span><span class="op" id="1514129">[</span><span class="ident" id="1514130">offi</span><span class="op" id="1514134">]</span>&nbsp;<span class="op" id="1514136">!=</span>&nbsp;<span class="ident" id="1514139">evacuatedY</span>&nbsp;<span class="op" id="1514150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514156">//&nbsp;this&nbsp;is&nbsp;the&nbsp;golden&nbsp;data,&nbsp;we&nbsp;can&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514206">if</span>&nbsp;<span class="ident" id="1514209">t</span><span class="op" id="1514210">.</span><span class="ident" id="1514211">indirectkey</span>&nbsp;<span class="op" id="1514223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514230">k</span>&nbsp;<span class="op" id="1514232">=</span>&nbsp;<span class="op" id="1514234">*</span><span class="op" id="1514235">(</span><span class="op" id="1514236">(</span><span class="op" id="1514237">*</span><span class="ident" id="1514238">unsafe</span><span class="op" id="1514244">.</span><span class="ident" id="1514245">Pointer</span><span class="op" id="1514252">)</span><span class="op" id="1514253">(</span><span class="ident" id="1514254">k</span><span class="op" id="1514255">)</span><span class="op" id="1514256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514262">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514268">it</span><span class="op" id="1514270">.</span><span class="ident" id="1514271">key</span>&nbsp;<span class="op" id="1514275">=</span>&nbsp;<span class="ident" id="1514277">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514283">if</span>&nbsp;<span class="ident" id="1514286">t</span><span class="op" id="1514287">.</span><span class="ident" id="1514288">indirectvalue</span>&nbsp;<span class="op" id="1514302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514309">v</span>&nbsp;<span class="op" id="1514311">=</span>&nbsp;<span class="op" id="1514313">*</span><span class="op" id="1514314">(</span><span class="op" id="1514315">(</span><span class="op" id="1514316">*</span><span class="ident" id="1514317">unsafe</span><span class="op" id="1514323">.</span><span class="ident" id="1514324">Pointer</span><span class="op" id="1514331">)</span><span class="op" id="1514332">(</span><span class="ident" id="1514333">v</span><span class="op" id="1514334">)</span><span class="op" id="1514335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514347">it</span><span class="op" id="1514349">.</span><span class="ident" id="1514350">value</span>&nbsp;<span class="op" id="1514356">=</span>&nbsp;<span class="ident" id="1514358">v</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514363">}</span>&nbsp;<span class="keyword" id="1514365">else</span>&nbsp;<span class="op" id="1514370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514376">//&nbsp;The&nbsp;hash&nbsp;table&nbsp;has&nbsp;grown&nbsp;since&nbsp;the&nbsp;iterator&nbsp;was&nbsp;started.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514440">//&nbsp;The&nbsp;golden&nbsp;data&nbsp;for&nbsp;this&nbsp;key&nbsp;is&nbsp;now&nbsp;somewhere&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514499">k2</span>&nbsp;<span class="op" id="1514502">:=</span>&nbsp;<span class="ident" id="1514505">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514511">if</span>&nbsp;<span class="ident" id="1514514">t</span><span class="op" id="1514515">.</span><span class="ident" id="1514516">indirectkey</span>&nbsp;<span class="op" id="1514528">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514535">k2</span>&nbsp;<span class="op" id="1514538">=</span>&nbsp;<span class="op" id="1514540">*</span><span class="op" id="1514541">(</span><span class="op" id="1514542">(</span><span class="op" id="1514543">*</span><span class="ident" id="1514544">unsafe</span><span class="op" id="1514550">.</span><span class="ident" id="1514551">Pointer</span><span class="op" id="1514558">)</span><span class="op" id="1514559">(</span><span class="ident" id="1514560">k2</span><span class="op" id="1514562">)</span><span class="op" id="1514563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514575">if</span>&nbsp;<span class="ident" id="1514578">alg</span><span class="op" id="1514581">.</span><span class="ident" id="1514582">equal</span><span class="op" id="1514587">(</span><span class="ident" id="1514588">k2</span><span class="op" id="1514590">,</span>&nbsp;<span class="ident" id="1514592">k2</span><span class="op" id="1514594">,</span>&nbsp;<span class="builtintype" id="1514596">uintptr</span><span class="op" id="1514603">(</span><span class="ident" id="1514604">t</span><span class="op" id="1514605">.</span><span class="ident" id="1514606">key</span><span class="op" id="1514609">.</span><span class="ident" id="1514610">size</span><span class="op" id="1514614">)</span><span class="op" id="1514615">)</span>&nbsp;<span class="op" id="1514617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514624">//&nbsp;Check&nbsp;the&nbsp;current&nbsp;hash&nbsp;table&nbsp;for&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514675">//&nbsp;This&nbsp;code&nbsp;handles&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;key</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514724">//&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;updated,&nbsp;or&nbsp;deleted&nbsp;and&nbsp;reinserted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514786">//&nbsp;NOTE:&nbsp;we&nbsp;need&nbsp;to&nbsp;regrab&nbsp;the&nbsp;key&nbsp;as&nbsp;it&nbsp;has&nbsp;potentially&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514853">//&nbsp;updated&nbsp;to&nbsp;an&nbsp;equal()&nbsp;but&nbsp;not&nbsp;identical&nbsp;key&nbsp;(e.g.&nbsp;+0.0&nbsp;vs&nbsp;-0.0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514926">rk</span><span class="op" id="1514928">,</span>&nbsp;<span class="ident" id="1514930">rv</span>&nbsp;<span class="op" id="1514933">:=</span>&nbsp;<span class="ident" id="1514936">mapaccessK</span><span class="op" id="1514946">(</span><span class="ident" id="1514947">t</span><span class="op" id="1514948">,</span>&nbsp;<span class="ident" id="1514950">h</span><span class="op" id="1514951">,</span>&nbsp;<span class="ident" id="1514953">k2</span><span class="op" id="1514955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514962">if</span>&nbsp;<span class="ident" id="1514965">rk</span>&nbsp;<span class="op" id="1514968">==</span>&nbsp;<span class="builtintype" id="1514971">nil</span>&nbsp;<span class="op" id="1514975">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514983">continue</span>&nbsp;<span class="comment" id="1514992">//&nbsp;key&nbsp;has&nbsp;been&nbsp;deleted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515028">it</span><span class="op" id="1515030">.</span><span class="ident" id="1515031">key</span>&nbsp;<span class="op" id="1515035">=</span>&nbsp;<span class="ident" id="1515037">rk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515045">it</span><span class="op" id="1515047">.</span><span class="ident" id="1515048">value</span>&nbsp;<span class="op" id="1515054">=</span>&nbsp;<span class="ident" id="1515056">rv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515063">}</span>&nbsp;<span class="keyword" id="1515065">else</span>&nbsp;<span class="op" id="1515070">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1515077">//&nbsp;if&nbsp;key!=key&nbsp;then&nbsp;the&nbsp;entry&nbsp;can&#39;t&nbsp;be&nbsp;deleted&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1515132">//&nbsp;updated,&nbsp;so&nbsp;we&nbsp;can&nbsp;just&nbsp;return&nbsp;it.&nbsp;&nbsp;That&#39;s&nbsp;lucky&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1515193">//&nbsp;us&nbsp;because&nbsp;when&nbsp;key!=key&nbsp;we&nbsp;can&#39;t&nbsp;look&nbsp;it&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1515246">//&nbsp;successfully&nbsp;in&nbsp;the&nbsp;current&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515289">it</span><span class="op" id="1515291">.</span><span class="ident" id="1515292">key</span>&nbsp;<span class="op" id="1515296">=</span>&nbsp;<span class="ident" id="1515298">k2</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515306">if</span>&nbsp;<span class="ident" id="1515309">t</span><span class="op" id="1515310">.</span><span class="ident" id="1515311">indirectvalue</span>&nbsp;<span class="op" id="1515325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515333">v</span>&nbsp;<span class="op" id="1515335">=</span>&nbsp;<span class="op" id="1515337">*</span><span class="op" id="1515338">(</span><span class="op" id="1515339">(</span><span class="op" id="1515340">*</span><span class="ident" id="1515341">unsafe</span><span class="op" id="1515347">.</span><span class="ident" id="1515348">Pointer</span><span class="op" id="1515355">)</span><span class="op" id="1515356">(</span><span class="ident" id="1515357">v</span><span class="op" id="1515358">)</span><span class="op" id="1515359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515373">it</span><span class="op" id="1515375">.</span><span class="ident" id="1515376">value</span>&nbsp;<span class="op" id="1515382">=</span>&nbsp;<span class="ident" id="1515384">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515390">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515400">it</span><span class="op" id="1515402">.</span><span class="ident" id="1515403">bucket</span>&nbsp;<span class="op" id="1515410">=</span>&nbsp;<span class="ident" id="1515412">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515422">it</span><span class="op" id="1515424">.</span><span class="ident" id="1515425">bptr</span>&nbsp;<span class="op" id="1515430">=</span>&nbsp;<span class="ident" id="1515432">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515437">it</span><span class="op" id="1515439">.</span><span class="ident" id="1515440">i</span>&nbsp;<span class="op" id="1515442">=</span>&nbsp;<span class="ident" id="1515444">i</span>&nbsp;<span class="op" id="1515446">+</span>&nbsp;<span class="num" id="1515448">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515453">it</span><span class="op" id="1515455">.</span><span class="ident" id="1515456">checkBucket</span>&nbsp;<span class="op" id="1515468">=</span>&nbsp;<span class="ident" id="1515470">checkBucket</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515485">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515500">b</span>&nbsp;<span class="op" id="1515502">=</span>&nbsp;<span class="ident" id="1515504">b</span><span class="op" id="1515505">.</span><span class="ident" id="1515506">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515516">i</span>&nbsp;<span class="op" id="1515518">=</span>&nbsp;<span class="num" id="1515520">0</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515523">goto</span>&nbsp;<span class="ident" id="1515528">next</span><br>
<span class="lineno"></span><span class="op" id="1515533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1515536">func</span>&nbsp;<span class="ident" id="1515541">hashGrow</span><span class="op" id="1515549">(</span><span class="ident" id="1515550">t</span>&nbsp;<span class="op" id="1515552">*</span><span class="ident" id="1515553">maptype</span><span class="op" id="1515560">,</span>&nbsp;<span class="ident" id="1515562">h</span>&nbsp;<span class="op" id="1515564">*</span><span class="ident" id="1515565">hmap</span><span class="op" id="1515569">)</span>&nbsp;<span class="op" id="1515571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515574">if</span>&nbsp;<span class="ident" id="1515577">h</span><span class="op" id="1515578">.</span><span class="ident" id="1515579">oldbuckets</span>&nbsp;<span class="op" id="1515590">!=</span>&nbsp;<span class="builtintype" id="1515593">nil</span>&nbsp;<span class="op" id="1515597">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515601">gothrow</span><span class="op" id="1515608">(</span><span class="string" id="1515609">&#34;evacuation&nbsp;not&nbsp;done&nbsp;in&nbsp;time&#34;</span><span class="op" id="1515638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515644">oldbuckets</span>&nbsp;<span class="op" id="1515655">:=</span>&nbsp;<span class="ident" id="1515658">h</span><span class="op" id="1515659">.</span><span class="ident" id="1515660">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515669">if</span>&nbsp;<span class="ident" id="1515672">checkgc</span>&nbsp;<span class="op" id="1515680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515684">memstats</span><span class="op" id="1515692">.</span><span class="ident" id="1515693">next_gc</span>&nbsp;<span class="op" id="1515701">=</span>&nbsp;<span class="ident" id="1515703">memstats</span><span class="op" id="1515711">.</span><span class="ident" id="1515712">heap_alloc</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515727">newbuckets</span>&nbsp;<span class="op" id="1515738">:=</span>&nbsp;<span class="ident" id="1515741">newarray</span><span class="op" id="1515749">(</span><span class="ident" id="1515750">t</span><span class="op" id="1515751">.</span><span class="ident" id="1515752">bucket</span><span class="op" id="1515758">,</span>&nbsp;<span class="builtintype" id="1515760">uintptr</span><span class="op" id="1515767">(</span><span class="num" id="1515768">1</span><span class="op" id="1515769">)</span><span class="op" id="1515770">&lt;&lt;</span><span class="op" id="1515772">(</span><span class="ident" id="1515773">h</span><span class="op" id="1515774">.</span><span class="ident" id="1515775">B</span><span class="op" id="1515776">+</span><span class="num" id="1515777">1</span><span class="op" id="1515778">)</span><span class="op" id="1515779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515782">flags</span>&nbsp;<span class="op" id="1515788">:=</span>&nbsp;<span class="ident" id="1515791">h</span><span class="op" id="1515792">.</span><span class="ident" id="1515793">flags</span>&nbsp;<span class="op" id="1515799">&amp;^</span>&nbsp;<span class="op" id="1515802">(</span><span class="ident" id="1515803">iterator</span>&nbsp;<span class="op" id="1515812">|</span>&nbsp;<span class="ident" id="1515814">oldIterator</span><span class="op" id="1515825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1515828">if</span>&nbsp;<span class="ident" id="1515831">h</span><span class="op" id="1515832">.</span><span class="ident" id="1515833">flags</span><span class="op" id="1515838">&amp;</span><span class="ident" id="1515839">iterator</span>&nbsp;<span class="op" id="1515848">!=</span>&nbsp;<span class="num" id="1515851">0</span>&nbsp;<span class="op" id="1515853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515857">flags</span>&nbsp;<span class="op" id="1515863">|=</span>&nbsp;<span class="ident" id="1515866">oldIterator</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1515879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1515882">//&nbsp;commit&nbsp;the&nbsp;grow&nbsp;(atomic&nbsp;wrt&nbsp;gc)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515918">h</span><span class="op" id="1515919">.</span><span class="ident" id="1515920">B</span><span class="op" id="1515921">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515925">h</span><span class="op" id="1515926">.</span><span class="ident" id="1515927">flags</span>&nbsp;<span class="op" id="1515933">=</span>&nbsp;<span class="ident" id="1515935">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515942">h</span><span class="op" id="1515943">.</span><span class="ident" id="1515944">oldbuckets</span>&nbsp;<span class="op" id="1515955">=</span>&nbsp;<span class="ident" id="1515957">oldbuckets</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515969">h</span><span class="op" id="1515970">.</span><span class="ident" id="1515971">buckets</span>&nbsp;<span class="op" id="1515979">=</span>&nbsp;<span class="ident" id="1515981">newbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515993">h</span><span class="op" id="1515994">.</span><span class="ident" id="1515995">nevacuate</span>&nbsp;<span class="op" id="1516005">=</span>&nbsp;<span class="num" id="1516007">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1516011">//&nbsp;the&nbsp;actual&nbsp;copying&nbsp;of&nbsp;the&nbsp;hash&nbsp;table&nbsp;data&nbsp;is&nbsp;done&nbsp;incrementally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1516079">//&nbsp;by&nbsp;growWork()&nbsp;and&nbsp;evacuate().</span><br>
<span class="lineno">750</span><span class="op" id="1516112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1516115">func</span>&nbsp;<span class="ident" id="1516120">growWork</span><span class="op" id="1516128">(</span><span class="ident" id="1516129">t</span>&nbsp;<span class="op" id="1516131">*</span><span class="ident" id="1516132">maptype</span><span class="op" id="1516139">,</span>&nbsp;<span class="ident" id="1516141">h</span>&nbsp;<span class="op" id="1516143">*</span><span class="ident" id="1516144">hmap</span><span class="op" id="1516148">,</span>&nbsp;<span class="ident" id="1516150">bucket</span>&nbsp;<span class="builtintype" id="1516157">uintptr</span><span class="op" id="1516164">)</span>&nbsp;<span class="op" id="1516166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516169">noldbuckets</span>&nbsp;<span class="op" id="1516181">:=</span>&nbsp;<span class="builtintype" id="1516184">uintptr</span><span class="op" id="1516191">(</span><span class="num" id="1516192">1</span><span class="op" id="1516193">)</span>&nbsp;<span class="op" id="1516195">&lt;&lt;</span>&nbsp;<span class="op" id="1516198">(</span><span class="ident" id="1516199">h</span><span class="op" id="1516200">.</span><span class="ident" id="1516201">B</span>&nbsp;<span class="op" id="1516203">-</span>&nbsp;<span class="num" id="1516205">1</span><span class="op" id="1516206">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1516210">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;evacuate&nbsp;the&nbsp;oldbucket&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1516264">//&nbsp;to&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516301">evacuate</span><span class="op" id="1516309">(</span><span class="ident" id="1516310">t</span><span class="op" id="1516311">,</span>&nbsp;<span class="ident" id="1516313">h</span><span class="op" id="1516314">,</span>&nbsp;<span class="ident" id="1516316">bucket</span><span class="op" id="1516322">&amp;</span><span class="op" id="1516323">(</span><span class="ident" id="1516324">noldbuckets</span><span class="op" id="1516335">-</span><span class="num" id="1516336">1</span><span class="op" id="1516337">)</span><span class="op" id="1516338">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1516342">//&nbsp;evacuate&nbsp;one&nbsp;more&nbsp;oldbucket&nbsp;to&nbsp;make&nbsp;progress&nbsp;on&nbsp;growing</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1516402">if</span>&nbsp;<span class="ident" id="1516405">h</span><span class="op" id="1516406">.</span><span class="ident" id="1516407">oldbuckets</span>&nbsp;<span class="op" id="1516418">!=</span>&nbsp;<span class="builtintype" id="1516421">nil</span>&nbsp;<span class="op" id="1516425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516429">evacuate</span><span class="op" id="1516437">(</span><span class="ident" id="1516438">t</span><span class="op" id="1516439">,</span>&nbsp;<span class="ident" id="1516441">h</span><span class="op" id="1516442">,</span>&nbsp;<span class="ident" id="1516444">h</span><span class="op" id="1516445">.</span><span class="ident" id="1516446">nevacuate</span><span class="op" id="1516455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1516458">}</span><br>
<span class="lineno"></span><span class="op" id="1516460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="1516463">func</span>&nbsp;<span class="ident" id="1516468">evacuate</span><span class="op" id="1516476">(</span><span class="ident" id="1516477">t</span>&nbsp;<span class="op" id="1516479">*</span><span class="ident" id="1516480">maptype</span><span class="op" id="1516487">,</span>&nbsp;<span class="ident" id="1516489">h</span>&nbsp;<span class="op" id="1516491">*</span><span class="ident" id="1516492">hmap</span><span class="op" id="1516496">,</span>&nbsp;<span class="ident" id="1516498">oldbucket</span>&nbsp;<span class="builtintype" id="1516508">uintptr</span><span class="op" id="1516515">)</span>&nbsp;<span class="op" id="1516517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516520">b</span>&nbsp;<span class="op" id="1516522">:=</span>&nbsp;<span class="op" id="1516525">(</span><span class="op" id="1516526">*</span><span class="ident" id="1516527">bmap</span><span class="op" id="1516531">)</span><span class="op" id="1516532">(</span><span class="ident" id="1516533">add</span><span class="op" id="1516536">(</span><span class="ident" id="1516537">h</span><span class="op" id="1516538">.</span><span class="ident" id="1516539">oldbuckets</span><span class="op" id="1516549">,</span>&nbsp;<span class="ident" id="1516551">oldbucket</span><span class="op" id="1516560">*</span><span class="builtintype" id="1516561">uintptr</span><span class="op" id="1516568">(</span><span class="ident" id="1516569">t</span><span class="op" id="1516570">.</span><span class="ident" id="1516571">bucketsize</span><span class="op" id="1516581">)</span><span class="op" id="1516582">)</span><span class="op" id="1516583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516586">newbit</span>&nbsp;<span class="op" id="1516593">:=</span>&nbsp;<span class="builtintype" id="1516596">uintptr</span><span class="op" id="1516603">(</span><span class="num" id="1516604">1</span><span class="op" id="1516605">)</span>&nbsp;<span class="op" id="1516607">&lt;&lt;</span>&nbsp;<span class="op" id="1516610">(</span><span class="ident" id="1516611">h</span><span class="op" id="1516612">.</span><span class="ident" id="1516613">B</span>&nbsp;<span class="op" id="1516615">-</span>&nbsp;<span class="num" id="1516617">1</span><span class="op" id="1516618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516621">alg</span>&nbsp;<span class="op" id="1516625">:=</span>&nbsp;<span class="ident" id="1516628">goalg</span><span class="op" id="1516633">(</span><span class="ident" id="1516634">t</span><span class="op" id="1516635">.</span><span class="ident" id="1516636">key</span><span class="op" id="1516639">.</span><span class="ident" id="1516640">alg</span><span class="op" id="1516643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1516646">if</span>&nbsp;<span class="op" id="1516649">!</span><span class="ident" id="1516650">evacuated</span><span class="op" id="1516659">(</span><span class="ident" id="1516660">b</span><span class="op" id="1516661">)</span>&nbsp;<span class="op" id="1516663">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1516667">//&nbsp;TODO:&nbsp;reuse&nbsp;overflow&nbsp;buckets&nbsp;instead&nbsp;of&nbsp;using&nbsp;new&nbsp;ones,&nbsp;if&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1516737">//&nbsp;is&nbsp;no&nbsp;iterator&nbsp;using&nbsp;the&nbsp;old&nbsp;buckets.&nbsp;&nbsp;(If&nbsp;!oldIterator.)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516801">x</span>&nbsp;<span class="op" id="1516803">:=</span>&nbsp;<span class="op" id="1516806">(</span><span class="op" id="1516807">*</span><span class="ident" id="1516808">bmap</span><span class="op" id="1516812">)</span><span class="op" id="1516813">(</span><span class="ident" id="1516814">add</span><span class="op" id="1516817">(</span><span class="ident" id="1516818">h</span><span class="op" id="1516819">.</span><span class="ident" id="1516820">buckets</span><span class="op" id="1516827">,</span>&nbsp;<span class="ident" id="1516829">oldbucket</span><span class="op" id="1516838">*</span><span class="builtintype" id="1516839">uintptr</span><span class="op" id="1516846">(</span><span class="ident" id="1516847">t</span><span class="op" id="1516848">.</span><span class="ident" id="1516849">bucketsize</span><span class="op" id="1516859">)</span><span class="op" id="1516860">)</span><span class="op" id="1516861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516865">y</span>&nbsp;<span class="op" id="1516867">:=</span>&nbsp;<span class="op" id="1516870">(</span><span class="op" id="1516871">*</span><span class="ident" id="1516872">bmap</span><span class="op" id="1516876">)</span><span class="op" id="1516877">(</span><span class="ident" id="1516878">add</span><span class="op" id="1516881">(</span><span class="ident" id="1516882">h</span><span class="op" id="1516883">.</span><span class="ident" id="1516884">buckets</span><span class="op" id="1516891">,</span>&nbsp;<span class="op" id="1516893">(</span><span class="ident" id="1516894">oldbucket</span><span class="op" id="1516903">+</span><span class="ident" id="1516904">newbit</span><span class="op" id="1516910">)</span><span class="op" id="1516911">*</span><span class="builtintype" id="1516912">uintptr</span><span class="op" id="1516919">(</span><span class="ident" id="1516920">t</span><span class="op" id="1516921">.</span><span class="ident" id="1516922">bucketsize</span><span class="op" id="1516932">)</span><span class="op" id="1516933">)</span><span class="op" id="1516934">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516938">xi</span>&nbsp;<span class="op" id="1516941">:=</span>&nbsp;<span class="num" id="1516944">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516948">yi</span>&nbsp;<span class="op" id="1516951">:=</span>&nbsp;<span class="num" id="1516954">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1516958">xk</span>&nbsp;<span class="op" id="1516961">:=</span>&nbsp;<span class="ident" id="1516964">add</span><span class="op" id="1516967">(</span><span class="ident" id="1516968">unsafe</span><span class="op" id="1516974">.</span><span class="ident" id="1516975">Pointer</span><span class="op" id="1516982">(</span><span class="ident" id="1516983">x</span><span class="op" id="1516984">)</span><span class="op" id="1516985">,</span>&nbsp;<span class="ident" id="1516987">dataOffset</span><span class="op" id="1516997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517001">yk</span>&nbsp;<span class="op" id="1517004">:=</span>&nbsp;<span class="ident" id="1517007">add</span><span class="op" id="1517010">(</span><span class="ident" id="1517011">unsafe</span><span class="op" id="1517017">.</span><span class="ident" id="1517018">Pointer</span><span class="op" id="1517025">(</span><span class="ident" id="1517026">y</span><span class="op" id="1517027">)</span><span class="op" id="1517028">,</span>&nbsp;<span class="ident" id="1517030">dataOffset</span><span class="op" id="1517040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517044">xv</span>&nbsp;<span class="op" id="1517047">:=</span>&nbsp;<span class="ident" id="1517050">add</span><span class="op" id="1517053">(</span><span class="ident" id="1517054">xk</span><span class="op" id="1517056">,</span>&nbsp;<span class="ident" id="1517058">bucketCnt</span><span class="op" id="1517067">*</span><span class="builtintype" id="1517068">uintptr</span><span class="op" id="1517075">(</span><span class="ident" id="1517076">t</span><span class="op" id="1517077">.</span><span class="ident" id="1517078">keysize</span><span class="op" id="1517085">)</span><span class="op" id="1517086">)</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517090">yv</span>&nbsp;<span class="op" id="1517093">:=</span>&nbsp;<span class="ident" id="1517096">add</span><span class="op" id="1517099">(</span><span class="ident" id="1517100">yk</span><span class="op" id="1517102">,</span>&nbsp;<span class="ident" id="1517104">bucketCnt</span><span class="op" id="1517113">*</span><span class="builtintype" id="1517114">uintptr</span><span class="op" id="1517121">(</span><span class="ident" id="1517122">t</span><span class="op" id="1517123">.</span><span class="ident" id="1517124">keysize</span><span class="op" id="1517131">)</span><span class="op" id="1517132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517136">for</span>&nbsp;<span class="op" id="1517140">;</span>&nbsp;<span class="ident" id="1517142">b</span>&nbsp;<span class="op" id="1517144">!=</span>&nbsp;<span class="builtintype" id="1517147">nil</span><span class="op" id="1517150">;</span>&nbsp;<span class="ident" id="1517152">b</span>&nbsp;<span class="op" id="1517154">=</span>&nbsp;<span class="ident" id="1517156">b</span><span class="op" id="1517157">.</span><span class="ident" id="1517158">overflow</span>&nbsp;<span class="op" id="1517167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517172">k</span>&nbsp;<span class="op" id="1517174">:=</span>&nbsp;<span class="ident" id="1517177">add</span><span class="op" id="1517180">(</span><span class="ident" id="1517181">unsafe</span><span class="op" id="1517187">.</span><span class="ident" id="1517188">Pointer</span><span class="op" id="1517195">(</span><span class="ident" id="1517196">b</span><span class="op" id="1517197">)</span><span class="op" id="1517198">,</span>&nbsp;<span class="ident" id="1517200">dataOffset</span><span class="op" id="1517210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517215">v</span>&nbsp;<span class="op" id="1517217">:=</span>&nbsp;<span class="ident" id="1517220">add</span><span class="op" id="1517223">(</span><span class="ident" id="1517224">k</span><span class="op" id="1517225">,</span>&nbsp;<span class="ident" id="1517227">bucketCnt</span><span class="op" id="1517236">*</span><span class="builtintype" id="1517237">uintptr</span><span class="op" id="1517244">(</span><span class="ident" id="1517245">t</span><span class="op" id="1517246">.</span><span class="ident" id="1517247">keysize</span><span class="op" id="1517254">)</span><span class="op" id="1517255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517260">for</span>&nbsp;<span class="ident" id="1517264">i</span>&nbsp;<span class="op" id="1517266">:=</span>&nbsp;<span class="num" id="1517269">0</span><span class="op" id="1517270">;</span>&nbsp;<span class="ident" id="1517272">i</span>&nbsp;<span class="op" id="1517274">&lt;</span>&nbsp;<span class="ident" id="1517276">bucketCnt</span><span class="op" id="1517285">;</span>&nbsp;<span class="ident" id="1517287">i</span><span class="op" id="1517288">,</span>&nbsp;<span class="ident" id="1517290">k</span><span class="op" id="1517291">,</span>&nbsp;<span class="ident" id="1517293">v</span>&nbsp;<span class="op" id="1517295">=</span>&nbsp;<span class="ident" id="1517297">i</span><span class="op" id="1517298">+</span><span class="num" id="1517299">1</span><span class="op" id="1517300">,</span>&nbsp;<span class="ident" id="1517302">add</span><span class="op" id="1517305">(</span><span class="ident" id="1517306">k</span><span class="op" id="1517307">,</span>&nbsp;<span class="builtintype" id="1517309">uintptr</span><span class="op" id="1517316">(</span><span class="ident" id="1517317">t</span><span class="op" id="1517318">.</span><span class="ident" id="1517319">keysize</span><span class="op" id="1517326">)</span><span class="op" id="1517327">)</span><span class="op" id="1517328">,</span>&nbsp;<span class="ident" id="1517330">add</span><span class="op" id="1517333">(</span><span class="ident" id="1517334">v</span><span class="op" id="1517335">,</span>&nbsp;<span class="builtintype" id="1517337">uintptr</span><span class="op" id="1517344">(</span><span class="ident" id="1517345">t</span><span class="op" id="1517346">.</span><span class="ident" id="1517347">valuesize</span><span class="op" id="1517356">)</span><span class="op" id="1517357">)</span>&nbsp;<span class="op" id="1517359">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517365">top</span>&nbsp;<span class="op" id="1517369">:=</span>&nbsp;<span class="ident" id="1517372">b</span><span class="op" id="1517373">.</span><span class="ident" id="1517374">tophash</span><span class="op" id="1517381">[</span><span class="ident" id="1517382">i</span><span class="op" id="1517383">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517389">if</span>&nbsp;<span class="ident" id="1517392">top</span>&nbsp;<span class="op" id="1517396">==</span>&nbsp;<span class="ident" id="1517399">empty</span>&nbsp;<span class="op" id="1517405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517412">b</span><span class="op" id="1517413">.</span><span class="ident" id="1517414">tophash</span><span class="op" id="1517421">[</span><span class="ident" id="1517422">i</span><span class="op" id="1517423">]</span>&nbsp;<span class="op" id="1517425">=</span>&nbsp;<span class="ident" id="1517427">evacuatedEmpty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517447">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1517460">}</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517466">if</span>&nbsp;<span class="ident" id="1517469">top</span>&nbsp;<span class="op" id="1517473">&lt;</span>&nbsp;<span class="ident" id="1517475">minTopHash</span>&nbsp;<span class="op" id="1517486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517493">gothrow</span><span class="op" id="1517500">(</span><span class="string" id="1517501">&#34;bad&nbsp;map&nbsp;state&#34;</span><span class="op" id="1517516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1517522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517528">k2</span>&nbsp;<span class="op" id="1517531">:=</span>&nbsp;<span class="ident" id="1517534">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517540">if</span>&nbsp;<span class="ident" id="1517543">t</span><span class="op" id="1517544">.</span><span class="ident" id="1517545">indirectkey</span>&nbsp;<span class="op" id="1517557">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517564">k2</span>&nbsp;<span class="op" id="1517567">=</span>&nbsp;<span class="op" id="1517569">*</span><span class="op" id="1517570">(</span><span class="op" id="1517571">(</span><span class="op" id="1517572">*</span><span class="ident" id="1517573">unsafe</span><span class="op" id="1517579">.</span><span class="ident" id="1517580">Pointer</span><span class="op" id="1517587">)</span><span class="op" id="1517588">(</span><span class="ident" id="1517589">k2</span><span class="op" id="1517591">)</span><span class="op" id="1517592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1517598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517604">//&nbsp;Compute&nbsp;hash&nbsp;to&nbsp;make&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;(whether&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517673">//&nbsp;to&nbsp;send&nbsp;this&nbsp;key/value&nbsp;to&nbsp;bucket&nbsp;x&nbsp;or&nbsp;bucket&nbsp;y).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517729">hash</span>&nbsp;<span class="op" id="1517734">:=</span>&nbsp;<span class="ident" id="1517737">alg</span><span class="op" id="1517740">.</span><span class="ident" id="1517741">hash</span><span class="op" id="1517745">(</span><span class="ident" id="1517746">k2</span><span class="op" id="1517748">,</span>&nbsp;<span class="builtintype" id="1517750">uintptr</span><span class="op" id="1517757">(</span><span class="ident" id="1517758">t</span><span class="op" id="1517759">.</span><span class="ident" id="1517760">key</span><span class="op" id="1517763">.</span><span class="ident" id="1517764">size</span><span class="op" id="1517768">)</span><span class="op" id="1517769">,</span>&nbsp;<span class="builtintype" id="1517771">uintptr</span><span class="op" id="1517778">(</span><span class="ident" id="1517779">h</span><span class="op" id="1517780">.</span><span class="ident" id="1517781">hash0</span><span class="op" id="1517786">)</span><span class="op" id="1517787">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517793">if</span>&nbsp;<span class="ident" id="1517796">h</span><span class="op" id="1517797">.</span><span class="ident" id="1517798">flags</span><span class="op" id="1517803">&amp;</span><span class="ident" id="1517804">iterator</span>&nbsp;<span class="op" id="1517813">!=</span>&nbsp;<span class="num" id="1517816">0</span>&nbsp;<span class="op" id="1517818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517825">if</span>&nbsp;<span class="op" id="1517828">!</span><span class="ident" id="1517829">alg</span><span class="op" id="1517832">.</span><span class="ident" id="1517833">equal</span><span class="op" id="1517838">(</span><span class="ident" id="1517839">k2</span><span class="op" id="1517841">,</span>&nbsp;<span class="ident" id="1517843">k2</span><span class="op" id="1517845">,</span>&nbsp;<span class="builtintype" id="1517847">uintptr</span><span class="op" id="1517854">(</span><span class="ident" id="1517855">t</span><span class="op" id="1517856">.</span><span class="ident" id="1517857">key</span><span class="op" id="1517860">.</span><span class="ident" id="1517861">size</span><span class="op" id="1517865">)</span><span class="op" id="1517866">)</span>&nbsp;<span class="op" id="1517868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517876">//&nbsp;If&nbsp;key&nbsp;!=&nbsp;key&nbsp;(NaNs),&nbsp;then&nbsp;the&nbsp;hash&nbsp;could&nbsp;be&nbsp;(and&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517944">//&nbsp;will&nbsp;be)&nbsp;entirely&nbsp;different&nbsp;from&nbsp;the&nbsp;old&nbsp;hash.&nbsp;&nbsp;Moreover,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518011">//&nbsp;it&nbsp;isn&#39;t&nbsp;reproducible.&nbsp;&nbsp;Reproducibility&nbsp;is&nbsp;required&nbsp;in&nbsp;the</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518079">//&nbsp;presence&nbsp;of&nbsp;iterators,&nbsp;as&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518143">//&nbsp;match&nbsp;whatever&nbsp;decision&nbsp;the&nbsp;iterator&nbsp;made.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518195">//&nbsp;Fortunately,&nbsp;we&nbsp;have&nbsp;the&nbsp;freedom&nbsp;to&nbsp;send&nbsp;these&nbsp;keys&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518263">//&nbsp;way.&nbsp;&nbsp;Also,&nbsp;tophash&nbsp;is&nbsp;meaningless&nbsp;for&nbsp;these&nbsp;kinds&nbsp;of&nbsp;keys.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518332">//&nbsp;We&nbsp;let&nbsp;the&nbsp;low&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;drive&nbsp;the&nbsp;evacuation&nbsp;decision.</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518402">//&nbsp;We&nbsp;recompute&nbsp;a&nbsp;new&nbsp;random&nbsp;tophash&nbsp;for&nbsp;the&nbsp;next&nbsp;level&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518467">//&nbsp;these&nbsp;keys&nbsp;will&nbsp;get&nbsp;evenly&nbsp;distributed&nbsp;across&nbsp;all&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518534">//&nbsp;after&nbsp;multiple&nbsp;grows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518565">if</span>&nbsp;<span class="op" id="1518568">(</span><span class="ident" id="1518569">top</span>&nbsp;<span class="op" id="1518573">&amp;</span>&nbsp;<span class="num" id="1518575">1</span><span class="op" id="1518576">)</span>&nbsp;<span class="op" id="1518578">!=</span>&nbsp;<span class="num" id="1518581">0</span>&nbsp;<span class="op" id="1518583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518592">hash</span>&nbsp;<span class="op" id="1518597">|=</span>&nbsp;<span class="ident" id="1518600">newbit</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518613">}</span>&nbsp;<span class="keyword" id="1518615">else</span>&nbsp;<span class="op" id="1518620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518629">hash</span>&nbsp;<span class="op" id="1518634">&amp;^=</span>&nbsp;<span class="ident" id="1518638">newbit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518659">top</span>&nbsp;<span class="op" id="1518663">=</span>&nbsp;<span class="builtintype" id="1518665">uint8</span><span class="op" id="1518670">(</span><span class="ident" id="1518671">hash</span>&nbsp;<span class="op" id="1518676">&gt;&gt;</span>&nbsp;<span class="op" id="1518679">(</span><span class="ident" id="1518680">ptrSize</span><span class="op" id="1518687">*</span><span class="num" id="1518688">8</span>&nbsp;<span class="op" id="1518690">-</span>&nbsp;<span class="num" id="1518692">8</span><span class="op" id="1518693">)</span><span class="op" id="1518694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518702">if</span>&nbsp;<span class="ident" id="1518705">top</span>&nbsp;<span class="op" id="1518709">&lt;</span>&nbsp;<span class="ident" id="1518711">minTopHash</span>&nbsp;<span class="op" id="1518722">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518731">top</span>&nbsp;<span class="op" id="1518735">+=</span>&nbsp;<span class="ident" id="1518738">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518774">if</span>&nbsp;<span class="op" id="1518777">(</span><span class="ident" id="1518778">hash</span>&nbsp;<span class="op" id="1518783">&amp;</span>&nbsp;<span class="ident" id="1518785">newbit</span><span class="op" id="1518791">)</span>&nbsp;<span class="op" id="1518793">==</span>&nbsp;<span class="num" id="1518796">0</span>&nbsp;<span class="op" id="1518798">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518805">b</span><span class="op" id="1518806">.</span><span class="ident" id="1518807">tophash</span><span class="op" id="1518814">[</span><span class="ident" id="1518815">i</span><span class="op" id="1518816">]</span>&nbsp;<span class="op" id="1518818">=</span>&nbsp;<span class="ident" id="1518820">evacuatedX</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518836">if</span>&nbsp;<span class="ident" id="1518839">xi</span>&nbsp;<span class="op" id="1518842">==</span>&nbsp;<span class="ident" id="1518845">bucketCnt</span>&nbsp;<span class="op" id="1518855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518863">if</span>&nbsp;<span class="ident" id="1518866">checkgc</span>&nbsp;<span class="op" id="1518874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518883">memstats</span><span class="op" id="1518891">.</span><span class="ident" id="1518892">next_gc</span>&nbsp;<span class="op" id="1518900">=</span>&nbsp;<span class="ident" id="1518902">memstats</span><span class="op" id="1518910">.</span><span class="ident" id="1518911">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518928">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518936">newx</span>&nbsp;<span class="op" id="1518941">:=</span>&nbsp;<span class="op" id="1518944">(</span><span class="op" id="1518945">*</span><span class="ident" id="1518946">bmap</span><span class="op" id="1518950">)</span><span class="op" id="1518951">(</span><span class="ident" id="1518952">newobject</span><span class="op" id="1518961">(</span><span class="ident" id="1518962">t</span><span class="op" id="1518963">.</span><span class="ident" id="1518964">bucket</span><span class="op" id="1518970">)</span><span class="op" id="1518971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518979">x</span><span class="op" id="1518980">.</span><span class="ident" id="1518981">overflow</span>&nbsp;<span class="op" id="1518990">=</span>&nbsp;<span class="ident" id="1518992">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519003">x</span>&nbsp;<span class="op" id="1519005">=</span>&nbsp;<span class="ident" id="1519007">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519018">xi</span>&nbsp;<span class="op" id="1519021">=</span>&nbsp;<span class="num" id="1519023">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519031">xk</span>&nbsp;<span class="op" id="1519034">=</span>&nbsp;<span class="ident" id="1519036">add</span><span class="op" id="1519039">(</span><span class="ident" id="1519040">unsafe</span><span class="op" id="1519046">.</span><span class="ident" id="1519047">Pointer</span><span class="op" id="1519054">(</span><span class="ident" id="1519055">x</span><span class="op" id="1519056">)</span><span class="op" id="1519057">,</span>&nbsp;<span class="ident" id="1519059">dataOffset</span><span class="op" id="1519069">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519077">xv</span>&nbsp;<span class="op" id="1519080">=</span>&nbsp;<span class="ident" id="1519082">add</span><span class="op" id="1519085">(</span><span class="ident" id="1519086">xk</span><span class="op" id="1519088">,</span>&nbsp;<span class="ident" id="1519090">bucketCnt</span><span class="op" id="1519099">*</span><span class="builtintype" id="1519100">uintptr</span><span class="op" id="1519107">(</span><span class="ident" id="1519108">t</span><span class="op" id="1519109">.</span><span class="ident" id="1519110">keysize</span><span class="op" id="1519117">)</span><span class="op" id="1519118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519132">x</span><span class="op" id="1519133">.</span><span class="ident" id="1519134">tophash</span><span class="op" id="1519141">[</span><span class="ident" id="1519142">xi</span><span class="op" id="1519144">]</span>&nbsp;<span class="op" id="1519146">=</span>&nbsp;<span class="ident" id="1519148">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519157">if</span>&nbsp;<span class="ident" id="1519160">t</span><span class="op" id="1519161">.</span><span class="ident" id="1519162">indirectkey</span>&nbsp;<span class="op" id="1519174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519182">*</span><span class="op" id="1519183">(</span><span class="op" id="1519184">*</span><span class="ident" id="1519185">unsafe</span><span class="op" id="1519191">.</span><span class="ident" id="1519192">Pointer</span><span class="op" id="1519199">)</span><span class="op" id="1519200">(</span><span class="ident" id="1519201">xk</span><span class="op" id="1519203">)</span>&nbsp;<span class="op" id="1519205">=</span>&nbsp;<span class="ident" id="1519207">k2</span>&nbsp;<span class="comment" id="1519210">//&nbsp;copy&nbsp;pointer</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519231">}</span>&nbsp;<span class="keyword" id="1519233">else</span>&nbsp;<span class="op" id="1519238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519246">memmove</span><span class="op" id="1519253">(</span><span class="ident" id="1519254">xk</span><span class="op" id="1519256">,</span>&nbsp;<span class="ident" id="1519258">k</span><span class="op" id="1519259">,</span>&nbsp;<span class="builtintype" id="1519261">uintptr</span><span class="op" id="1519268">(</span><span class="ident" id="1519269">t</span><span class="op" id="1519270">.</span><span class="ident" id="1519271">key</span><span class="op" id="1519274">.</span><span class="ident" id="1519275">size</span><span class="op" id="1519279">)</span><span class="op" id="1519280">)</span>&nbsp;<span class="comment" id="1519282">//&nbsp;copy&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519308">if</span>&nbsp;<span class="ident" id="1519311">t</span><span class="op" id="1519312">.</span><span class="ident" id="1519313">indirectvalue</span>&nbsp;<span class="op" id="1519327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519335">*</span><span class="op" id="1519336">(</span><span class="op" id="1519337">*</span><span class="ident" id="1519338">unsafe</span><span class="op" id="1519344">.</span><span class="ident" id="1519345">Pointer</span><span class="op" id="1519352">)</span><span class="op" id="1519353">(</span><span class="ident" id="1519354">xv</span><span class="op" id="1519356">)</span>&nbsp;<span class="op" id="1519358">=</span>&nbsp;<span class="op" id="1519360">*</span><span class="op" id="1519361">(</span><span class="op" id="1519362">*</span><span class="ident" id="1519363">unsafe</span><span class="op" id="1519369">.</span><span class="ident" id="1519370">Pointer</span><span class="op" id="1519377">)</span><span class="op" id="1519378">(</span><span class="ident" id="1519379">v</span><span class="op" id="1519380">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519387">}</span>&nbsp;<span class="keyword" id="1519389">else</span>&nbsp;<span class="op" id="1519394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519402">memmove</span><span class="op" id="1519409">(</span><span class="ident" id="1519410">xv</span><span class="op" id="1519412">,</span>&nbsp;<span class="ident" id="1519414">v</span><span class="op" id="1519415">,</span>&nbsp;<span class="builtintype" id="1519417">uintptr</span><span class="op" id="1519424">(</span><span class="ident" id="1519425">t</span><span class="op" id="1519426">.</span><span class="ident" id="1519427">elem</span><span class="op" id="1519431">.</span><span class="ident" id="1519432">size</span><span class="op" id="1519436">)</span><span class="op" id="1519437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519451">xi</span><span class="op" id="1519453">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519461">xk</span>&nbsp;<span class="op" id="1519464">=</span>&nbsp;<span class="ident" id="1519466">add</span><span class="op" id="1519469">(</span><span class="ident" id="1519470">xk</span><span class="op" id="1519472">,</span>&nbsp;<span class="builtintype" id="1519474">uintptr</span><span class="op" id="1519481">(</span><span class="ident" id="1519482">t</span><span class="op" id="1519483">.</span><span class="ident" id="1519484">keysize</span><span class="op" id="1519491">)</span><span class="op" id="1519492">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519499">xv</span>&nbsp;<span class="op" id="1519502">=</span>&nbsp;<span class="ident" id="1519504">add</span><span class="op" id="1519507">(</span><span class="ident" id="1519508">xv</span><span class="op" id="1519510">,</span>&nbsp;<span class="builtintype" id="1519512">uintptr</span><span class="op" id="1519519">(</span><span class="ident" id="1519520">t</span><span class="op" id="1519521">.</span><span class="ident" id="1519522">valuesize</span><span class="op" id="1519531">)</span><span class="op" id="1519532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519538">}</span>&nbsp;<span class="keyword" id="1519540">else</span>&nbsp;<span class="op" id="1519545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519552">b</span><span class="op" id="1519553">.</span><span class="ident" id="1519554">tophash</span><span class="op" id="1519561">[</span><span class="ident" id="1519562">i</span><span class="op" id="1519563">]</span>&nbsp;<span class="op" id="1519565">=</span>&nbsp;<span class="ident" id="1519567">evacuatedY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519583">if</span>&nbsp;<span class="ident" id="1519586">yi</span>&nbsp;<span class="op" id="1519589">==</span>&nbsp;<span class="ident" id="1519592">bucketCnt</span>&nbsp;<span class="op" id="1519602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519610">if</span>&nbsp;<span class="ident" id="1519613">checkgc</span>&nbsp;<span class="op" id="1519621">{</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519630">memstats</span><span class="op" id="1519638">.</span><span class="ident" id="1519639">next_gc</span>&nbsp;<span class="op" id="1519647">=</span>&nbsp;<span class="ident" id="1519649">memstats</span><span class="op" id="1519657">.</span><span class="ident" id="1519658">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519683">newy</span>&nbsp;<span class="op" id="1519688">:=</span>&nbsp;<span class="op" id="1519691">(</span><span class="op" id="1519692">*</span><span class="ident" id="1519693">bmap</span><span class="op" id="1519697">)</span><span class="op" id="1519698">(</span><span class="ident" id="1519699">newobject</span><span class="op" id="1519708">(</span><span class="ident" id="1519709">t</span><span class="op" id="1519710">.</span><span class="ident" id="1519711">bucket</span><span class="op" id="1519717">)</span><span class="op" id="1519718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519726">y</span><span class="op" id="1519727">.</span><span class="ident" id="1519728">overflow</span>&nbsp;<span class="op" id="1519737">=</span>&nbsp;<span class="ident" id="1519739">newy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519750">y</span>&nbsp;<span class="op" id="1519752">=</span>&nbsp;<span class="ident" id="1519754">newy</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519765">yi</span>&nbsp;<span class="op" id="1519768">=</span>&nbsp;<span class="num" id="1519770">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519778">yk</span>&nbsp;<span class="op" id="1519781">=</span>&nbsp;<span class="ident" id="1519783">add</span><span class="op" id="1519786">(</span><span class="ident" id="1519787">unsafe</span><span class="op" id="1519793">.</span><span class="ident" id="1519794">Pointer</span><span class="op" id="1519801">(</span><span class="ident" id="1519802">y</span><span class="op" id="1519803">)</span><span class="op" id="1519804">,</span>&nbsp;<span class="ident" id="1519806">dataOffset</span><span class="op" id="1519816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519824">yv</span>&nbsp;<span class="op" id="1519827">=</span>&nbsp;<span class="ident" id="1519829">add</span><span class="op" id="1519832">(</span><span class="ident" id="1519833">yk</span><span class="op" id="1519835">,</span>&nbsp;<span class="ident" id="1519837">bucketCnt</span><span class="op" id="1519846">*</span><span class="builtintype" id="1519847">uintptr</span><span class="op" id="1519854">(</span><span class="ident" id="1519855">t</span><span class="op" id="1519856">.</span><span class="ident" id="1519857">keysize</span><span class="op" id="1519864">)</span><span class="op" id="1519865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519879">y</span><span class="op" id="1519880">.</span><span class="ident" id="1519881">tophash</span><span class="op" id="1519888">[</span><span class="ident" id="1519889">yi</span><span class="op" id="1519891">]</span>&nbsp;<span class="op" id="1519893">=</span>&nbsp;<span class="ident" id="1519895">top</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519904">if</span>&nbsp;<span class="ident" id="1519907">t</span><span class="op" id="1519908">.</span><span class="ident" id="1519909">indirectkey</span>&nbsp;<span class="op" id="1519921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519929">*</span><span class="op" id="1519930">(</span><span class="op" id="1519931">*</span><span class="ident" id="1519932">unsafe</span><span class="op" id="1519938">.</span><span class="ident" id="1519939">Pointer</span><span class="op" id="1519946">)</span><span class="op" id="1519947">(</span><span class="ident" id="1519948">yk</span><span class="op" id="1519950">)</span>&nbsp;<span class="op" id="1519952">=</span>&nbsp;<span class="ident" id="1519954">k2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519962">}</span>&nbsp;<span class="keyword" id="1519964">else</span>&nbsp;<span class="op" id="1519969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519977">memmove</span><span class="op" id="1519984">(</span><span class="ident" id="1519985">yk</span><span class="op" id="1519987">,</span>&nbsp;<span class="ident" id="1519989">k</span><span class="op" id="1519990">,</span>&nbsp;<span class="builtintype" id="1519992">uintptr</span><span class="op" id="1519999">(</span><span class="ident" id="1520000">t</span><span class="op" id="1520001">.</span><span class="ident" id="1520002">key</span><span class="op" id="1520005">.</span><span class="ident" id="1520006">size</span><span class="op" id="1520010">)</span><span class="op" id="1520011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520018">}</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520025">if</span>&nbsp;<span class="ident" id="1520028">t</span><span class="op" id="1520029">.</span><span class="ident" id="1520030">indirectvalue</span>&nbsp;<span class="op" id="1520044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520052">*</span><span class="op" id="1520053">(</span><span class="op" id="1520054">*</span><span class="ident" id="1520055">unsafe</span><span class="op" id="1520061">.</span><span class="ident" id="1520062">Pointer</span><span class="op" id="1520069">)</span><span class="op" id="1520070">(</span><span class="ident" id="1520071">yv</span><span class="op" id="1520073">)</span>&nbsp;<span class="op" id="1520075">=</span>&nbsp;<span class="op" id="1520077">*</span><span class="op" id="1520078">(</span><span class="op" id="1520079">*</span><span class="ident" id="1520080">unsafe</span><span class="op" id="1520086">.</span><span class="ident" id="1520087">Pointer</span><span class="op" id="1520094">)</span><span class="op" id="1520095">(</span><span class="ident" id="1520096">v</span><span class="op" id="1520097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520104">}</span>&nbsp;<span class="keyword" id="1520106">else</span>&nbsp;<span class="op" id="1520111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520119">memmove</span><span class="op" id="1520126">(</span><span class="ident" id="1520127">yv</span><span class="op" id="1520129">,</span>&nbsp;<span class="ident" id="1520131">v</span><span class="op" id="1520132">,</span>&nbsp;<span class="builtintype" id="1520134">uintptr</span><span class="op" id="1520141">(</span><span class="ident" id="1520142">t</span><span class="op" id="1520143">.</span><span class="ident" id="1520144">elem</span><span class="op" id="1520148">.</span><span class="ident" id="1520149">size</span><span class="op" id="1520153">)</span><span class="op" id="1520154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520161">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520168">yi</span><span class="op" id="1520170">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520178">yk</span>&nbsp;<span class="op" id="1520181">=</span>&nbsp;<span class="ident" id="1520183">add</span><span class="op" id="1520186">(</span><span class="ident" id="1520187">yk</span><span class="op" id="1520189">,</span>&nbsp;<span class="builtintype" id="1520191">uintptr</span><span class="op" id="1520198">(</span><span class="ident" id="1520199">t</span><span class="op" id="1520200">.</span><span class="ident" id="1520201">keysize</span><span class="op" id="1520208">)</span><span class="op" id="1520209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520216">yv</span>&nbsp;<span class="op" id="1520219">=</span>&nbsp;<span class="ident" id="1520221">add</span><span class="op" id="1520224">(</span><span class="ident" id="1520225">yv</span><span class="op" id="1520227">,</span>&nbsp;<span class="builtintype" id="1520229">uintptr</span><span class="op" id="1520236">(</span><span class="ident" id="1520237">t</span><span class="op" id="1520238">.</span><span class="ident" id="1520239">valuesize</span><span class="op" id="1520248">)</span><span class="op" id="1520249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520260">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520268">//&nbsp;Unlink&nbsp;the&nbsp;overflow&nbsp;buckets&nbsp;&amp;&nbsp;clear&nbsp;key/value&nbsp;to&nbsp;help&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520331">if</span>&nbsp;<span class="ident" id="1520334">h</span><span class="op" id="1520335">.</span><span class="ident" id="1520336">flags</span><span class="op" id="1520341">&amp;</span><span class="ident" id="1520342">oldIterator</span>&nbsp;<span class="op" id="1520354">==</span>&nbsp;<span class="num" id="1520357">0</span>&nbsp;<span class="op" id="1520359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520364">b</span>&nbsp;<span class="op" id="1520366">=</span>&nbsp;<span class="op" id="1520368">(</span><span class="op" id="1520369">*</span><span class="ident" id="1520370">bmap</span><span class="op" id="1520374">)</span><span class="op" id="1520375">(</span><span class="ident" id="1520376">add</span><span class="op" id="1520379">(</span><span class="ident" id="1520380">h</span><span class="op" id="1520381">.</span><span class="ident" id="1520382">oldbuckets</span><span class="op" id="1520392">,</span>&nbsp;<span class="ident" id="1520394">oldbucket</span><span class="op" id="1520403">*</span><span class="builtintype" id="1520404">uintptr</span><span class="op" id="1520411">(</span><span class="ident" id="1520412">t</span><span class="op" id="1520413">.</span><span class="ident" id="1520414">bucketsize</span><span class="op" id="1520424">)</span><span class="op" id="1520425">)</span><span class="op" id="1520426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520431">b</span><span class="op" id="1520432">.</span><span class="ident" id="1520433">overflow</span>&nbsp;<span class="op" id="1520442">=</span>&nbsp;<span class="builtintype" id="1520444">nil</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520451">memclr</span><span class="op" id="1520457">(</span><span class="ident" id="1520458">add</span><span class="op" id="1520461">(</span><span class="ident" id="1520462">unsafe</span><span class="op" id="1520468">.</span><span class="ident" id="1520469">Pointer</span><span class="op" id="1520476">(</span><span class="ident" id="1520477">b</span><span class="op" id="1520478">)</span><span class="op" id="1520479">,</span>&nbsp;<span class="ident" id="1520481">dataOffset</span><span class="op" id="1520491">)</span><span class="op" id="1520492">,</span>&nbsp;<span class="builtintype" id="1520494">uintptr</span><span class="op" id="1520501">(</span><span class="ident" id="1520502">t</span><span class="op" id="1520503">.</span><span class="ident" id="1520504">bucketsize</span><span class="op" id="1520514">)</span><span class="op" id="1520515">-</span><span class="ident" id="1520516">dataOffset</span><span class="op" id="1520526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520537">//&nbsp;Advance&nbsp;evacuation&nbsp;mark</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520565">if</span>&nbsp;<span class="ident" id="1520568">oldbucket</span>&nbsp;<span class="op" id="1520578">==</span>&nbsp;<span class="ident" id="1520581">h</span><span class="op" id="1520582">.</span><span class="ident" id="1520583">nevacuate</span>&nbsp;<span class="op" id="1520593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520597">h</span><span class="op" id="1520598">.</span><span class="ident" id="1520599">nevacuate</span>&nbsp;<span class="op" id="1520609">=</span>&nbsp;<span class="ident" id="1520611">oldbucket</span>&nbsp;<span class="op" id="1520621">+</span>&nbsp;<span class="num" id="1520623">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520627">if</span>&nbsp;<span class="ident" id="1520630">oldbucket</span><span class="op" id="1520639">+</span><span class="num" id="1520640">1</span>&nbsp;<span class="op" id="1520642">==</span>&nbsp;<span class="ident" id="1520645">newbit</span>&nbsp;<span class="op" id="1520652">{</span>&nbsp;<span class="comment" id="1520654">//&nbsp;newbit&nbsp;==&nbsp;#&nbsp;of&nbsp;oldbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520686">//&nbsp;Growing&nbsp;is&nbsp;all&nbsp;done.&nbsp;&nbsp;Free&nbsp;old&nbsp;main&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520742">h</span><span class="op" id="1520743">.</span><span class="ident" id="1520744">oldbuckets</span>&nbsp;<span class="op" id="1520755">=</span>&nbsp;<span class="builtintype" id="1520757">nil</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520766">}</span><br>
<span class="lineno"></span><span class="op" id="1520768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1520771">func</span>&nbsp;<span class="ident" id="1520776">ismapkey</span><span class="op" id="1520784">(</span><span class="ident" id="1520785">t</span>&nbsp;<span class="op" id="1520787">*</span><span class="ident" id="1520788">_type</span><span class="op" id="1520793">)</span>&nbsp;<span class="builtintype" id="1520795">bool</span>&nbsp;<span class="op" id="1520800">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520803">return</span>&nbsp;<span class="ident" id="1520810">goalg</span><span class="op" id="1520815">(</span><span class="ident" id="1520816">t</span><span class="op" id="1520817">.</span><span class="ident" id="1520818">alg</span><span class="op" id="1520821">)</span><span class="op" id="1520822">.</span><span class="ident" id="1520823">hash</span>&nbsp;<span class="op" id="1520828">!=</span>&nbsp;<span class="builtintype" id="1520831">nil</span><br>
<span class="lineno"></span><span class="op" id="1520835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1520838">//&nbsp;Reflect&nbsp;stubs.&nbsp;&nbsp;Called&nbsp;from&nbsp;../reflect/asm_*.s</span><br>
<span class="lineno"></span><br>
<span class="lineno">905</span><span class="keyword" id="1520889">func</span>&nbsp;<span class="ident" id="1520894">reflect_makemap</span><span class="op" id="1520909">(</span><span class="ident" id="1520910">t</span>&nbsp;<span class="op" id="1520912">*</span><span class="ident" id="1520913">maptype</span><span class="op" id="1520920">)</span>&nbsp;<span class="op" id="1520922">*</span><span class="ident" id="1520923">hmap</span>&nbsp;<span class="op" id="1520928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520931">return</span>&nbsp;<span class="ident" id="1520938">makemap</span><span class="op" id="1520945">(</span><span class="ident" id="1520946">t</span><span class="op" id="1520947">,</span>&nbsp;<span class="num" id="1520949">0</span><span class="op" id="1520950">)</span><br>
<span class="lineno"></span><span class="op" id="1520952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1520955">func</span>&nbsp;<span class="ident" id="1520960">reflect_mapaccess</span><span class="op" id="1520977">(</span><span class="ident" id="1520978">t</span>&nbsp;<span class="op" id="1520980">*</span><span class="ident" id="1520981">maptype</span><span class="op" id="1520988">,</span>&nbsp;<span class="ident" id="1520990">h</span>&nbsp;<span class="op" id="1520992">*</span><span class="ident" id="1520993">hmap</span><span class="op" id="1520997">,</span>&nbsp;<span class="ident" id="1520999">key</span>&nbsp;<span class="ident" id="1521003">unsafe</span><span class="op" id="1521009">.</span><span class="ident" id="1521010">Pointer</span><span class="op" id="1521017">)</span>&nbsp;<span class="ident" id="1521019">unsafe</span><span class="op" id="1521025">.</span><span class="ident" id="1521026">Pointer</span>&nbsp;<span class="op" id="1521034">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521037">val</span><span class="op" id="1521040">,</span>&nbsp;<span class="ident" id="1521042">ok</span>&nbsp;<span class="op" id="1521045">:=</span>&nbsp;<span class="ident" id="1521048">mapaccess2</span><span class="op" id="1521058">(</span><span class="ident" id="1521059">t</span><span class="op" id="1521060">,</span>&nbsp;<span class="ident" id="1521062">h</span><span class="op" id="1521063">,</span>&nbsp;<span class="ident" id="1521065">key</span><span class="op" id="1521068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521071">if</span>&nbsp;<span class="op" id="1521074">!</span><span class="ident" id="1521075">ok</span>&nbsp;<span class="op" id="1521078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1521082">//&nbsp;reflect&nbsp;wants&nbsp;nil&nbsp;for&nbsp;a&nbsp;missing&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521127">val</span>&nbsp;<span class="op" id="1521131">=</span>&nbsp;<span class="builtintype" id="1521133">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521138">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521141">return</span>&nbsp;<span class="ident" id="1521148">val</span><br>
<span class="lineno"></span><span class="op" id="1521152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1521155">func</span>&nbsp;<span class="ident" id="1521160">reflect_mapassign</span><span class="op" id="1521177">(</span><span class="ident" id="1521178">t</span>&nbsp;<span class="op" id="1521180">*</span><span class="ident" id="1521181">maptype</span><span class="op" id="1521188">,</span>&nbsp;<span class="ident" id="1521190">h</span>&nbsp;<span class="op" id="1521192">*</span><span class="ident" id="1521193">hmap</span><span class="op" id="1521197">,</span>&nbsp;<span class="ident" id="1521199">key</span>&nbsp;<span class="ident" id="1521203">unsafe</span><span class="op" id="1521209">.</span><span class="ident" id="1521210">Pointer</span><span class="op" id="1521217">,</span>&nbsp;<span class="ident" id="1521219">val</span>&nbsp;<span class="ident" id="1521223">unsafe</span><span class="op" id="1521229">.</span><span class="ident" id="1521230">Pointer</span><span class="op" id="1521237">)</span>&nbsp;<span class="op" id="1521239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521242">mapassign1</span><span class="op" id="1521252">(</span><span class="ident" id="1521253">t</span><span class="op" id="1521254">,</span>&nbsp;<span class="ident" id="1521256">h</span><span class="op" id="1521257">,</span>&nbsp;<span class="ident" id="1521259">key</span><span class="op" id="1521262">,</span>&nbsp;<span class="ident" id="1521264">val</span><span class="op" id="1521267">)</span><br>
<span class="lineno">920</span><span class="op" id="1521269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1521272">func</span>&nbsp;<span class="ident" id="1521277">reflect_mapdelete</span><span class="op" id="1521294">(</span><span class="ident" id="1521295">t</span>&nbsp;<span class="op" id="1521297">*</span><span class="ident" id="1521298">maptype</span><span class="op" id="1521305">,</span>&nbsp;<span class="ident" id="1521307">h</span>&nbsp;<span class="op" id="1521309">*</span><span class="ident" id="1521310">hmap</span><span class="op" id="1521314">,</span>&nbsp;<span class="ident" id="1521316">key</span>&nbsp;<span class="ident" id="1521320">unsafe</span><span class="op" id="1521326">.</span><span class="ident" id="1521327">Pointer</span><span class="op" id="1521334">)</span>&nbsp;<span class="op" id="1521336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521339">mapdelete</span><span class="op" id="1521348">(</span><span class="ident" id="1521349">t</span><span class="op" id="1521350">,</span>&nbsp;<span class="ident" id="1521352">h</span><span class="op" id="1521353">,</span>&nbsp;<span class="ident" id="1521355">key</span><span class="op" id="1521358">)</span><br>
<span class="lineno"></span><span class="op" id="1521360">}</span><br>
<span class="lineno">925</span><br>
<span class="lineno"></span><span class="keyword" id="1521363">func</span>&nbsp;<span class="ident" id="1521368">reflect_mapiterinit</span><span class="op" id="1521387">(</span><span class="ident" id="1521388">t</span>&nbsp;<span class="op" id="1521390">*</span><span class="ident" id="1521391">maptype</span><span class="op" id="1521398">,</span>&nbsp;<span class="ident" id="1521400">h</span>&nbsp;<span class="op" id="1521402">*</span><span class="ident" id="1521403">hmap</span><span class="op" id="1521407">)</span>&nbsp;<span class="op" id="1521409">*</span><span class="ident" id="1521410">hiter</span>&nbsp;<span class="op" id="1521416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521419">it</span>&nbsp;<span class="op" id="1521422">:=</span>&nbsp;<span class="builtinfunc" id="1521425">new</span><span class="op" id="1521428">(</span><span class="ident" id="1521429">hiter</span><span class="op" id="1521434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521437">mapiterinit</span><span class="op" id="1521448">(</span><span class="ident" id="1521449">t</span><span class="op" id="1521450">,</span>&nbsp;<span class="ident" id="1521452">h</span><span class="op" id="1521453">,</span>&nbsp;<span class="ident" id="1521455">it</span><span class="op" id="1521457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521460">return</span>&nbsp;<span class="ident" id="1521467">it</span><br>
<span class="lineno">930</span><span class="op" id="1521470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1521473">func</span>&nbsp;<span class="ident" id="1521478">reflect_mapiternext</span><span class="op" id="1521497">(</span><span class="ident" id="1521498">it</span>&nbsp;<span class="op" id="1521501">*</span><span class="ident" id="1521502">hiter</span><span class="op" id="1521507">)</span>&nbsp;<span class="op" id="1521509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521512">mapiternext</span><span class="op" id="1521523">(</span><span class="ident" id="1521524">it</span><span class="op" id="1521526">)</span><br>
<span class="lineno"></span><span class="op" id="1521528">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="keyword" id="1521531">func</span>&nbsp;<span class="ident" id="1521536">reflect_mapiterkey</span><span class="op" id="1521554">(</span><span class="ident" id="1521555">it</span>&nbsp;<span class="op" id="1521558">*</span><span class="ident" id="1521559">hiter</span><span class="op" id="1521564">)</span>&nbsp;<span class="ident" id="1521566">unsafe</span><span class="op" id="1521572">.</span><span class="ident" id="1521573">Pointer</span>&nbsp;<span class="op" id="1521581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521584">return</span>&nbsp;<span class="ident" id="1521591">it</span><span class="op" id="1521593">.</span><span class="ident" id="1521594">key</span><br>
<span class="lineno"></span><span class="op" id="1521598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">940</span><span class="keyword" id="1521601">func</span>&nbsp;<span class="ident" id="1521606">reflect_maplen</span><span class="op" id="1521620">(</span><span class="ident" id="1521621">h</span>&nbsp;<span class="op" id="1521623">*</span><span class="ident" id="1521624">hmap</span><span class="op" id="1521628">)</span>&nbsp;<span class="builtintype" id="1521630">int</span>&nbsp;<span class="op" id="1521634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521637">if</span>&nbsp;<span class="ident" id="1521640">h</span>&nbsp;<span class="op" id="1521642">==</span>&nbsp;<span class="builtintype" id="1521645">nil</span>&nbsp;<span class="op" id="1521649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521653">return</span>&nbsp;<span class="num" id="1521660">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521666">if</span>&nbsp;<span class="ident" id="1521669">raceenabled</span>&nbsp;<span class="op" id="1521681">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521685">callerpc</span>&nbsp;<span class="op" id="1521694">:=</span>&nbsp;<span class="ident" id="1521697">getcallerpc</span><span class="op" id="1521708">(</span><span class="ident" id="1521709">unsafe</span><span class="op" id="1521715">.</span><span class="ident" id="1521716">Pointer</span><span class="op" id="1521723">(</span><span class="op" id="1521724">&amp;</span><span class="ident" id="1521725">h</span><span class="op" id="1521726">)</span><span class="op" id="1521727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521731">racereadpc</span><span class="op" id="1521741">(</span><span class="ident" id="1521742">unsafe</span><span class="op" id="1521748">.</span><span class="ident" id="1521749">Pointer</span><span class="op" id="1521756">(</span><span class="ident" id="1521757">h</span><span class="op" id="1521758">)</span><span class="op" id="1521759">,</span>&nbsp;<span class="ident" id="1521761">callerpc</span><span class="op" id="1521769">,</span>&nbsp;<span class="ident" id="1521771">funcPC</span><span class="op" id="1521777">(</span><span class="ident" id="1521778">reflect_maplen</span><span class="op" id="1521792">)</span><span class="op" id="1521793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521799">return</span>&nbsp;<span class="ident" id="1521806">h</span><span class="op" id="1521807">.</span><span class="ident" id="1521808">count</span><br>
<span class="lineno"></span><span class="op" id="1521814">}</span><br>
<span class="lineno">950</span><br>
<span class="lineno"></span><span class="keyword" id="1521817">func</span>&nbsp;<span class="ident" id="1521822">reflect_ismapkey</span><span class="op" id="1521838">(</span><span class="ident" id="1521839">t</span>&nbsp;<span class="op" id="1521841">*</span><span class="ident" id="1521842">_type</span><span class="op" id="1521847">)</span>&nbsp;<span class="builtintype" id="1521849">bool</span>&nbsp;<span class="op" id="1521854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521857">return</span>&nbsp;<span class="ident" id="1521864">ismapkey</span><span class="op" id="1521872">(</span><span class="ident" id="1521873">t</span><span class="op" id="1521874">)</span><br>
<span class="lineno"></span><span class="op" id="1521876">}</span>
</div>
</body>
</html>
