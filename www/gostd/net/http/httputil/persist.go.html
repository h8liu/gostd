<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5871554">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5871609">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5871663">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5871714">package</span>&nbsp;<span class="ident" id="5871722">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5871732">import</span>&nbsp;<span class="op" id="5871739">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5871742">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5871751">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5871761">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5871767">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5871774">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5871786">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5871803">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="5871810">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5871813">var</span>&nbsp;<span class="op" id="5871817">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871820">ErrPersistEOF</span>&nbsp;<span class="op" id="5871834">=</span>&nbsp;<span class="op" id="5871836">&amp;</span><span class="ident" id="5871837">http</span><span class="op" id="5871841">.</span><span class="ident" id="5871842">ProtocolError</span><span class="op" id="5871855">{</span><span class="ident" id="5871856">ErrorString</span><span class="op" id="5871867">:</span>&nbsp;<span class="string" id="5871869">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="5871899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871902">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5871916">=</span>&nbsp;<span class="op" id="5871918">&amp;</span><span class="ident" id="5871919">http</span><span class="op" id="5871923">.</span><span class="ident" id="5871924">ProtocolError</span><span class="op" id="5871937">{</span><span class="ident" id="5871938">ErrorString</span><span class="op" id="5871949">:</span>&nbsp;<span class="string" id="5871951">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="5871978">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871981">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5871995">=</span>&nbsp;<span class="op" id="5871997">&amp;</span><span class="ident" id="5871998">http</span><span class="op" id="5872002">.</span><span class="ident" id="5872003">ProtocolError</span><span class="op" id="5872016">{</span><span class="ident" id="5872017">ErrorString</span><span class="op" id="5872028">:</span>&nbsp;<span class="string" id="5872030">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="5872046">}</span><br>
<span class="lineno"></span><span class="op" id="5872048">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5872051">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="5872109">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="5872174">var</span>&nbsp;<span class="ident" id="5872178">errClosed</span>&nbsp;<span class="op" id="5872188">=</span>&nbsp;<span class="ident" id="5872190">errors</span><span class="op" id="5872196">.</span><span class="ident" id="5872197">New</span><span class="op" id="5872200">(</span><span class="string" id="5872201">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="5872237">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5872240">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="5872310">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="5872384">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="5872453">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="5872528">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5872603">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="5872637">//</span><br>
<span class="lineno"></span><span class="comment" id="5872640">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="5872715">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5872743">type</span>&nbsp;<span class="ident" id="5872748">ServerConn</span>&nbsp;<span class="keyword" id="5872759">struct</span>&nbsp;<span class="op" id="5872766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872769">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5872785">sync</span><span class="op" id="5872789">.</span><span class="ident" id="5872790">Mutex</span>&nbsp;<span class="comment" id="5872796">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872841">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5872857">net</span><span class="op" id="5872860">.</span><span class="ident" id="5872861">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872867">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5872883">*</span><span class="ident" id="5872884">bufio</span><span class="op" id="5872889">.</span><span class="ident" id="5872890">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872898">re</span><span class="op" id="5872900">,</span>&nbsp;<span class="ident" id="5872902">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5872914">error</span>&nbsp;<span class="comment" id="5872920">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872942">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5872958">io</span><span class="op" id="5872960">.</span><span class="ident" id="5872961">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872973">nread</span><span class="op" id="5872978">,</span>&nbsp;<span class="ident" id="5872980">nwritten</span>&nbsp;<span class="builtintype" id="5872989">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872994">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873010">map</span><span class="op" id="5873013">[</span><span class="op" id="5873014">*</span><span class="ident" id="5873015">http</span><span class="op" id="5873019">.</span><span class="ident" id="5873020">Request</span><span class="op" id="5873027">]</span><span class="builtintype" id="5873028">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873035">pipe</span>&nbsp;<span class="ident" id="5873040">textproto</span><span class="op" id="5873049">.</span><span class="ident" id="5873050">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="5873059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5873062">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="5873139">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="5873187">//</span><br>
<span class="lineno"></span><span class="comment" id="5873190">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="5873265">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5873293">func</span>&nbsp;<span class="ident" id="5873298">NewServerConn</span><span class="op" id="5873311">(</span><span class="ident" id="5873312">c</span>&nbsp;<span class="ident" id="5873314">net</span><span class="op" id="5873317">.</span><span class="ident" id="5873318">Conn</span><span class="op" id="5873322">,</span>&nbsp;<span class="ident" id="5873324">r</span>&nbsp;<span class="op" id="5873326">*</span><span class="ident" id="5873327">bufio</span><span class="op" id="5873332">.</span><span class="ident" id="5873333">Reader</span><span class="op" id="5873339">)</span>&nbsp;<span class="op" id="5873341">*</span><span class="ident" id="5873342">ServerConn</span>&nbsp;<span class="op" id="5873353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873356">if</span>&nbsp;<span class="ident" id="5873359">r</span>&nbsp;<span class="op" id="5873361">==</span>&nbsp;<span class="ident" id="5873364">nil</span>&nbsp;<span class="op" id="5873368">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873372">r</span>&nbsp;<span class="op" id="5873374">=</span>&nbsp;<span class="ident" id="5873376">bufio</span><span class="op" id="5873381">.</span><span class="ident" id="5873382">NewReader</span><span class="op" id="5873391">(</span><span class="ident" id="5873392">c</span><span class="op" id="5873393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873399">return</span>&nbsp;<span class="op" id="5873406">&amp;</span><span class="ident" id="5873407">ServerConn</span><span class="op" id="5873417">{</span><span class="ident" id="5873418">c</span><span class="op" id="5873419">:</span>&nbsp;<span class="ident" id="5873421">c</span><span class="op" id="5873422">,</span>&nbsp;<span class="ident" id="5873424">r</span><span class="op" id="5873425">:</span>&nbsp;<span class="ident" id="5873427">r</span><span class="op" id="5873428">,</span>&nbsp;<span class="ident" id="5873430">pipereq</span><span class="op" id="5873437">:</span>&nbsp;<span class="builtinfunc" id="5873439">make</span><span class="op" id="5873443">(</span><span class="keyword" id="5873444">map</span><span class="op" id="5873447">[</span><span class="op" id="5873448">*</span><span class="ident" id="5873449">http</span><span class="op" id="5873453">.</span><span class="ident" id="5873454">Request</span><span class="op" id="5873461">]</span><span class="builtintype" id="5873462">uint</span><span class="op" id="5873466">)</span><span class="op" id="5873467">}</span><br>
<span class="lineno"></span><span class="op" id="5873469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5873472">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="5873552">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5873628">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="5873705">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="5873767">func</span>&nbsp;<span class="op" id="5873772">(</span><span class="ident" id="5873773">sc</span>&nbsp;<span class="op" id="5873776">*</span><span class="ident" id="5873777">ServerConn</span><span class="op" id="5873787">)</span>&nbsp;<span class="ident" id="5873789">Hijack</span><span class="op" id="5873795">(</span><span class="op" id="5873796">)</span>&nbsp;<span class="op" id="5873798">(</span><span class="ident" id="5873799">c</span>&nbsp;<span class="ident" id="5873801">net</span><span class="op" id="5873804">.</span><span class="ident" id="5873805">Conn</span><span class="op" id="5873809">,</span>&nbsp;<span class="ident" id="5873811">r</span>&nbsp;<span class="op" id="5873813">*</span><span class="ident" id="5873814">bufio</span><span class="op" id="5873819">.</span><span class="ident" id="5873820">Reader</span><span class="op" id="5873826">)</span>&nbsp;<span class="op" id="5873828">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873831">sc</span><span class="op" id="5873833">.</span><span class="ident" id="5873834">lk</span><span class="op" id="5873836">.</span><span class="ident" id="5873837">Lock</span><span class="op" id="5873841">(</span><span class="op" id="5873842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873845">defer</span>&nbsp;<span class="ident" id="5873851">sc</span><span class="op" id="5873853">.</span><span class="ident" id="5873854">lk</span><span class="op" id="5873856">.</span><span class="ident" id="5873857">Unlock</span><span class="op" id="5873863">(</span><span class="op" id="5873864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873867">c</span>&nbsp;<span class="op" id="5873869">=</span>&nbsp;<span class="ident" id="5873871">sc</span><span class="op" id="5873873">.</span><span class="ident" id="5873874">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873877">r</span>&nbsp;<span class="op" id="5873879">=</span>&nbsp;<span class="ident" id="5873881">sc</span><span class="op" id="5873883">.</span><span class="ident" id="5873884">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873887">sc</span><span class="op" id="5873889">.</span><span class="ident" id="5873890">c</span>&nbsp;<span class="op" id="5873892">=</span>&nbsp;<span class="ident" id="5873894">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873899">sc</span><span class="op" id="5873901">.</span><span class="ident" id="5873902">r</span>&nbsp;<span class="op" id="5873904">=</span>&nbsp;<span class="ident" id="5873906">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873911">return</span><br>
<span class="lineno"></span><span class="op" id="5873918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5873921">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="5873990">func</span>&nbsp;<span class="op" id="5873995">(</span><span class="ident" id="5873996">sc</span>&nbsp;<span class="op" id="5873999">*</span><span class="ident" id="5874000">ServerConn</span><span class="op" id="5874010">)</span>&nbsp;<span class="ident" id="5874012">Close</span><span class="op" id="5874017">(</span><span class="op" id="5874018">)</span>&nbsp;<span class="builtintype" id="5874020">error</span>&nbsp;<span class="op" id="5874026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874029">c</span><span class="op" id="5874030">,</span>&nbsp;<span class="ident" id="5874032">_</span>&nbsp;<span class="op" id="5874034">:=</span>&nbsp;<span class="ident" id="5874037">sc</span><span class="op" id="5874039">.</span><span class="ident" id="5874040">Hijack</span><span class="op" id="5874046">(</span><span class="op" id="5874047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874050">if</span>&nbsp;<span class="ident" id="5874053">c</span>&nbsp;<span class="op" id="5874055">!=</span>&nbsp;<span class="ident" id="5874058">nil</span>&nbsp;<span class="op" id="5874062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874066">return</span>&nbsp;<span class="ident" id="5874073">c</span><span class="op" id="5874074">.</span><span class="ident" id="5874075">Close</span><span class="op" id="5874080">(</span><span class="op" id="5874081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874084">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874087">return</span>&nbsp;<span class="ident" id="5874094">nil</span><br>
<span class="lineno"></span><span class="op" id="5874098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5874101">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="5874179">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="5874258">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5874335">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="5874360">func</span>&nbsp;<span class="op" id="5874365">(</span><span class="ident" id="5874366">sc</span>&nbsp;<span class="op" id="5874369">*</span><span class="ident" id="5874370">ServerConn</span><span class="op" id="5874380">)</span>&nbsp;<span class="ident" id="5874382">Read</span><span class="op" id="5874386">(</span><span class="op" id="5874387">)</span>&nbsp;<span class="op" id="5874389">(</span><span class="ident" id="5874390">req</span>&nbsp;<span class="op" id="5874394">*</span><span class="ident" id="5874395">http</span><span class="op" id="5874399">.</span><span class="ident" id="5874400">Request</span><span class="op" id="5874407">,</span>&nbsp;<span class="ident" id="5874409">err</span>&nbsp;<span class="builtintype" id="5874413">error</span><span class="op" id="5874418">)</span>&nbsp;<span class="op" id="5874420">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5874424">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874473">id</span>&nbsp;<span class="op" id="5874476">:=</span>&nbsp;<span class="ident" id="5874479">sc</span><span class="op" id="5874481">.</span><span class="ident" id="5874482">pipe</span><span class="op" id="5874486">.</span><span class="ident" id="5874487">Next</span><span class="op" id="5874491">(</span><span class="op" id="5874492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874495">sc</span><span class="op" id="5874497">.</span><span class="ident" id="5874498">pipe</span><span class="op" id="5874502">.</span><span class="ident" id="5874503">StartRequest</span><span class="op" id="5874515">(</span><span class="ident" id="5874516">id</span><span class="op" id="5874518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874521">defer</span>&nbsp;<span class="keyword" id="5874527">func</span><span class="op" id="5874531">(</span><span class="op" id="5874532">)</span>&nbsp;<span class="op" id="5874534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874538">sc</span><span class="op" id="5874540">.</span><span class="ident" id="5874541">pipe</span><span class="op" id="5874545">.</span><span class="ident" id="5874546">EndRequest</span><span class="op" id="5874556">(</span><span class="ident" id="5874557">id</span><span class="op" id="5874559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874563">if</span>&nbsp;<span class="ident" id="5874566">req</span>&nbsp;<span class="op" id="5874570">==</span>&nbsp;<span class="ident" id="5874573">nil</span>&nbsp;<span class="op" id="5874577">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874582">sc</span><span class="op" id="5874584">.</span><span class="ident" id="5874585">pipe</span><span class="op" id="5874589">.</span><span class="ident" id="5874590">StartResponse</span><span class="op" id="5874603">(</span><span class="ident" id="5874604">id</span><span class="op" id="5874606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874611">sc</span><span class="op" id="5874613">.</span><span class="ident" id="5874614">pipe</span><span class="op" id="5874618">.</span><span class="ident" id="5874619">EndResponse</span><span class="op" id="5874630">(</span><span class="ident" id="5874631">id</span><span class="op" id="5874633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874637">}</span>&nbsp;<span class="keyword" id="5874639">else</span>&nbsp;<span class="op" id="5874644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5874649">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874696">sc</span><span class="op" id="5874698">.</span><span class="ident" id="5874699">lk</span><span class="op" id="5874701">.</span><span class="ident" id="5874702">Lock</span><span class="op" id="5874706">(</span><span class="op" id="5874707">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874712">sc</span><span class="op" id="5874714">.</span><span class="ident" id="5874715">pipereq</span><span class="op" id="5874722">[</span><span class="ident" id="5874723">req</span><span class="op" id="5874726">]</span>&nbsp;<span class="op" id="5874728">=</span>&nbsp;<span class="ident" id="5874730">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874736">sc</span><span class="op" id="5874738">.</span><span class="ident" id="5874739">lk</span><span class="op" id="5874741">.</span><span class="ident" id="5874742">Unlock</span><span class="op" id="5874748">(</span><span class="op" id="5874749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874756">}</span><span class="op" id="5874757">(</span><span class="op" id="5874758">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874762">sc</span><span class="op" id="5874764">.</span><span class="ident" id="5874765">lk</span><span class="op" id="5874767">.</span><span class="ident" id="5874768">Lock</span><span class="op" id="5874772">(</span><span class="op" id="5874773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874776">if</span>&nbsp;<span class="ident" id="5874779">sc</span><span class="op" id="5874781">.</span><span class="ident" id="5874782">we</span>&nbsp;<span class="op" id="5874785">!=</span>&nbsp;<span class="ident" id="5874788">nil</span>&nbsp;<span class="op" id="5874792">{</span>&nbsp;<span class="comment" id="5874794">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874849">defer</span>&nbsp;<span class="ident" id="5874855">sc</span><span class="op" id="5874857">.</span><span class="ident" id="5874858">lk</span><span class="op" id="5874860">.</span><span class="ident" id="5874861">Unlock</span><span class="op" id="5874867">(</span><span class="op" id="5874868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874872">return</span>&nbsp;<span class="ident" id="5874879">nil</span><span class="op" id="5874882">,</span>&nbsp;<span class="ident" id="5874884">sc</span><span class="op" id="5874886">.</span><span class="ident" id="5874887">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874891">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874894">if</span>&nbsp;<span class="ident" id="5874897">sc</span><span class="op" id="5874899">.</span><span class="ident" id="5874900">re</span>&nbsp;<span class="op" id="5874903">!=</span>&nbsp;<span class="ident" id="5874906">nil</span>&nbsp;<span class="op" id="5874910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874914">defer</span>&nbsp;<span class="ident" id="5874920">sc</span><span class="op" id="5874922">.</span><span class="ident" id="5874923">lk</span><span class="op" id="5874925">.</span><span class="ident" id="5874926">Unlock</span><span class="op" id="5874932">(</span><span class="op" id="5874933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874937">return</span>&nbsp;<span class="ident" id="5874944">nil</span><span class="op" id="5874947">,</span>&nbsp;<span class="ident" id="5874949">sc</span><span class="op" id="5874951">.</span><span class="ident" id="5874952">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874959">if</span>&nbsp;<span class="ident" id="5874962">sc</span><span class="op" id="5874964">.</span><span class="ident" id="5874965">r</span>&nbsp;<span class="op" id="5874967">==</span>&nbsp;<span class="ident" id="5874970">nil</span>&nbsp;<span class="op" id="5874974">{</span>&nbsp;<span class="comment" id="5874976">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875023">defer</span>&nbsp;<span class="ident" id="5875029">sc</span><span class="op" id="5875031">.</span><span class="ident" id="5875032">lk</span><span class="op" id="5875034">.</span><span class="ident" id="5875035">Unlock</span><span class="op" id="5875041">(</span><span class="op" id="5875042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875046">return</span>&nbsp;<span class="ident" id="5875053">nil</span><span class="op" id="5875056">,</span>&nbsp;<span class="ident" id="5875058">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5875069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875072">r</span>&nbsp;<span class="op" id="5875074">:=</span>&nbsp;<span class="ident" id="5875077">sc</span><span class="op" id="5875079">.</span><span class="ident" id="5875080">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875083">lastbody</span>&nbsp;<span class="op" id="5875092">:=</span>&nbsp;<span class="ident" id="5875095">sc</span><span class="op" id="5875097">.</span><span class="ident" id="5875098">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875108">sc</span><span class="op" id="5875110">.</span><span class="ident" id="5875111">lastbody</span>&nbsp;<span class="op" id="5875120">=</span>&nbsp;<span class="ident" id="5875122">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875127">sc</span><span class="op" id="5875129">.</span><span class="ident" id="5875130">lk</span><span class="op" id="5875132">.</span><span class="ident" id="5875133">Unlock</span><span class="op" id="5875139">(</span><span class="op" id="5875140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5875144">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875220">if</span>&nbsp;<span class="ident" id="5875223">lastbody</span>&nbsp;<span class="op" id="5875232">!=</span>&nbsp;<span class="ident" id="5875235">nil</span>&nbsp;<span class="op" id="5875239">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5875243">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5875309">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5875367">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875382">err</span>&nbsp;<span class="op" id="5875386">=</span>&nbsp;<span class="ident" id="5875388">lastbody</span><span class="op" id="5875396">.</span><span class="ident" id="5875397">Close</span><span class="op" id="5875402">(</span><span class="op" id="5875403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875407">if</span>&nbsp;<span class="ident" id="5875410">err</span>&nbsp;<span class="op" id="5875414">!=</span>&nbsp;<span class="ident" id="5875417">nil</span>&nbsp;<span class="op" id="5875421">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875426">sc</span><span class="op" id="5875428">.</span><span class="ident" id="5875429">lk</span><span class="op" id="5875431">.</span><span class="ident" id="5875432">Lock</span><span class="op" id="5875436">(</span><span class="op" id="5875437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875442">defer</span>&nbsp;<span class="ident" id="5875448">sc</span><span class="op" id="5875450">.</span><span class="ident" id="5875451">lk</span><span class="op" id="5875453">.</span><span class="ident" id="5875454">Unlock</span><span class="op" id="5875460">(</span><span class="op" id="5875461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875466">sc</span><span class="op" id="5875468">.</span><span class="ident" id="5875469">re</span>&nbsp;<span class="op" id="5875472">=</span>&nbsp;<span class="ident" id="5875474">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875481">return</span>&nbsp;<span class="ident" id="5875488">nil</span><span class="op" id="5875491">,</span>&nbsp;<span class="ident" id="5875493">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5875499">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5875502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875506">req</span><span class="op" id="5875509">,</span>&nbsp;<span class="ident" id="5875511">err</span>&nbsp;<span class="op" id="5875515">=</span>&nbsp;<span class="ident" id="5875517">http</span><span class="op" id="5875521">.</span><span class="ident" id="5875522">ReadRequest</span><span class="op" id="5875533">(</span><span class="ident" id="5875534">r</span><span class="op" id="5875535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875538">sc</span><span class="op" id="5875540">.</span><span class="ident" id="5875541">lk</span><span class="op" id="5875543">.</span><span class="ident" id="5875544">Lock</span><span class="op" id="5875548">(</span><span class="op" id="5875549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875552">defer</span>&nbsp;<span class="ident" id="5875558">sc</span><span class="op" id="5875560">.</span><span class="ident" id="5875561">lk</span><span class="op" id="5875563">.</span><span class="ident" id="5875564">Unlock</span><span class="op" id="5875570">(</span><span class="op" id="5875571">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875574">if</span>&nbsp;<span class="ident" id="5875577">err</span>&nbsp;<span class="op" id="5875581">!=</span>&nbsp;<span class="ident" id="5875584">nil</span>&nbsp;<span class="op" id="5875588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875592">if</span>&nbsp;<span class="ident" id="5875595">err</span>&nbsp;<span class="op" id="5875599">==</span>&nbsp;<span class="ident" id="5875602">io</span><span class="op" id="5875604">.</span><span class="ident" id="5875605">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5875622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5875627">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5875682">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5875740">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875769">sc</span><span class="op" id="5875771">.</span><span class="ident" id="5875772">re</span>&nbsp;<span class="op" id="5875775">=</span>&nbsp;<span class="ident" id="5875777">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875794">return</span>&nbsp;<span class="ident" id="5875801">nil</span><span class="op" id="5875804">,</span>&nbsp;<span class="ident" id="5875806">sc</span><span class="op" id="5875808">.</span><span class="ident" id="5875809">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5875814">}</span>&nbsp;<span class="keyword" id="5875816">else</span>&nbsp;<span class="op" id="5875821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875826">sc</span><span class="op" id="5875828">.</span><span class="ident" id="5875829">re</span>&nbsp;<span class="op" id="5875832">=</span>&nbsp;<span class="ident" id="5875834">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875841">return</span>&nbsp;<span class="ident" id="5875848">req</span><span class="op" id="5875851">,</span>&nbsp;<span class="ident" id="5875853">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5875859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5875862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875865">sc</span><span class="op" id="5875867">.</span><span class="ident" id="5875868">lastbody</span>&nbsp;<span class="op" id="5875877">=</span>&nbsp;<span class="ident" id="5875879">req</span><span class="op" id="5875882">.</span><span class="ident" id="5875883">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875889">sc</span><span class="op" id="5875891">.</span><span class="ident" id="5875892">nread</span><span class="op" id="5875897">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875901">if</span>&nbsp;<span class="ident" id="5875904">req</span><span class="op" id="5875907">.</span><span class="ident" id="5875908">Close</span>&nbsp;<span class="op" id="5875914">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875918">sc</span><span class="op" id="5875920">.</span><span class="ident" id="5875921">re</span>&nbsp;<span class="op" id="5875924">=</span>&nbsp;<span class="ident" id="5875926">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875942">return</span>&nbsp;<span class="ident" id="5875949">req</span><span class="op" id="5875952">,</span>&nbsp;<span class="ident" id="5875954">sc</span><span class="op" id="5875956">.</span><span class="ident" id="5875957">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5875961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875964">return</span>&nbsp;<span class="ident" id="5875971">req</span><span class="op" id="5875974">,</span>&nbsp;<span class="ident" id="5875976">err</span><br>
<span class="lineno"></span><span class="op" id="5875980">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="5875983">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5876036">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5876082">func</span>&nbsp;<span class="op" id="5876087">(</span><span class="ident" id="5876088">sc</span>&nbsp;<span class="op" id="5876091">*</span><span class="ident" id="5876092">ServerConn</span><span class="op" id="5876102">)</span>&nbsp;<span class="ident" id="5876104">Pending</span><span class="op" id="5876111">(</span><span class="op" id="5876112">)</span>&nbsp;<span class="builtintype" id="5876114">int</span>&nbsp;<span class="op" id="5876118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876121">sc</span><span class="op" id="5876123">.</span><span class="ident" id="5876124">lk</span><span class="op" id="5876126">.</span><span class="ident" id="5876127">Lock</span><span class="op" id="5876131">(</span><span class="op" id="5876132">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876135">defer</span>&nbsp;<span class="ident" id="5876141">sc</span><span class="op" id="5876143">.</span><span class="ident" id="5876144">lk</span><span class="op" id="5876146">.</span><span class="ident" id="5876147">Unlock</span><span class="op" id="5876153">(</span><span class="op" id="5876154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876157">return</span>&nbsp;<span class="ident" id="5876164">sc</span><span class="op" id="5876166">.</span><span class="ident" id="5876167">nread</span>&nbsp;<span class="op" id="5876173">-</span>&nbsp;<span class="ident" id="5876175">sc</span><span class="op" id="5876177">.</span><span class="ident" id="5876178">nwritten</span><br>
<span class="lineno"></span><span class="op" id="5876187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5876190">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="5876275">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="5876353">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="5876429">func</span>&nbsp;<span class="op" id="5876434">(</span><span class="ident" id="5876435">sc</span>&nbsp;<span class="op" id="5876438">*</span><span class="ident" id="5876439">ServerConn</span><span class="op" id="5876449">)</span>&nbsp;<span class="ident" id="5876451">Write</span><span class="op" id="5876456">(</span><span class="ident" id="5876457">req</span>&nbsp;<span class="op" id="5876461">*</span><span class="ident" id="5876462">http</span><span class="op" id="5876466">.</span><span class="ident" id="5876467">Request</span><span class="op" id="5876474">,</span>&nbsp;<span class="ident" id="5876476">resp</span>&nbsp;<span class="op" id="5876481">*</span><span class="ident" id="5876482">http</span><span class="op" id="5876486">.</span><span class="ident" id="5876487">Response</span><span class="op" id="5876495">)</span>&nbsp;<span class="builtintype" id="5876497">error</span>&nbsp;<span class="op" id="5876503">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5876507">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876566">sc</span><span class="op" id="5876568">.</span><span class="ident" id="5876569">lk</span><span class="op" id="5876571">.</span><span class="ident" id="5876572">Lock</span><span class="op" id="5876576">(</span><span class="op" id="5876577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876580">id</span><span class="op" id="5876582">,</span>&nbsp;<span class="ident" id="5876584">ok</span>&nbsp;<span class="op" id="5876587">:=</span>&nbsp;<span class="ident" id="5876590">sc</span><span class="op" id="5876592">.</span><span class="ident" id="5876593">pipereq</span><span class="op" id="5876600">[</span><span class="ident" id="5876601">req</span><span class="op" id="5876604">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5876607">delete</span><span class="op" id="5876613">(</span><span class="ident" id="5876614">sc</span><span class="op" id="5876616">.</span><span class="ident" id="5876617">pipereq</span><span class="op" id="5876624">,</span>&nbsp;<span class="ident" id="5876626">req</span><span class="op" id="5876629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876632">if</span>&nbsp;<span class="op" id="5876635">!</span><span class="ident" id="5876636">ok</span>&nbsp;<span class="op" id="5876639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876643">sc</span><span class="op" id="5876645">.</span><span class="ident" id="5876646">lk</span><span class="op" id="5876648">.</span><span class="ident" id="5876649">Unlock</span><span class="op" id="5876655">(</span><span class="op" id="5876656">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876660">return</span>&nbsp;<span class="ident" id="5876667">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5876680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876683">sc</span><span class="op" id="5876685">.</span><span class="ident" id="5876686">lk</span><span class="op" id="5876688">.</span><span class="ident" id="5876689">Unlock</span><span class="op" id="5876695">(</span><span class="op" id="5876696">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5876700">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876726">sc</span><span class="op" id="5876728">.</span><span class="ident" id="5876729">pipe</span><span class="op" id="5876733">.</span><span class="ident" id="5876734">StartResponse</span><span class="op" id="5876747">(</span><span class="ident" id="5876748">id</span><span class="op" id="5876750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876753">defer</span>&nbsp;<span class="ident" id="5876759">sc</span><span class="op" id="5876761">.</span><span class="ident" id="5876762">pipe</span><span class="op" id="5876766">.</span><span class="ident" id="5876767">EndResponse</span><span class="op" id="5876778">(</span><span class="ident" id="5876779">id</span><span class="op" id="5876781">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876785">sc</span><span class="op" id="5876787">.</span><span class="ident" id="5876788">lk</span><span class="op" id="5876790">.</span><span class="ident" id="5876791">Lock</span><span class="op" id="5876795">(</span><span class="op" id="5876796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876799">if</span>&nbsp;<span class="ident" id="5876802">sc</span><span class="op" id="5876804">.</span><span class="ident" id="5876805">we</span>&nbsp;<span class="op" id="5876808">!=</span>&nbsp;<span class="ident" id="5876811">nil</span>&nbsp;<span class="op" id="5876815">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876819">defer</span>&nbsp;<span class="ident" id="5876825">sc</span><span class="op" id="5876827">.</span><span class="ident" id="5876828">lk</span><span class="op" id="5876830">.</span><span class="ident" id="5876831">Unlock</span><span class="op" id="5876837">(</span><span class="op" id="5876838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876842">return</span>&nbsp;<span class="ident" id="5876849">sc</span><span class="op" id="5876851">.</span><span class="ident" id="5876852">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5876856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876859">if</span>&nbsp;<span class="ident" id="5876862">sc</span><span class="op" id="5876864">.</span><span class="ident" id="5876865">c</span>&nbsp;<span class="op" id="5876867">==</span>&nbsp;<span class="ident" id="5876870">nil</span>&nbsp;<span class="op" id="5876874">{</span>&nbsp;<span class="comment" id="5876876">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876923">defer</span>&nbsp;<span class="ident" id="5876929">sc</span><span class="op" id="5876931">.</span><span class="ident" id="5876932">lk</span><span class="op" id="5876934">.</span><span class="ident" id="5876935">Unlock</span><span class="op" id="5876941">(</span><span class="op" id="5876942">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876946">return</span>&nbsp;<span class="ident" id="5876953">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5876964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876967">c</span>&nbsp;<span class="op" id="5876969">:=</span>&nbsp;<span class="ident" id="5876972">sc</span><span class="op" id="5876974">.</span><span class="ident" id="5876975">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876978">if</span>&nbsp;<span class="ident" id="5876981">sc</span><span class="op" id="5876983">.</span><span class="ident" id="5876984">nread</span>&nbsp;<span class="op" id="5876990">&lt;=</span>&nbsp;<span class="ident" id="5876993">sc</span><span class="op" id="5876995">.</span><span class="ident" id="5876996">nwritten</span>&nbsp;<span class="op" id="5877005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877009">defer</span>&nbsp;<span class="ident" id="5877015">sc</span><span class="op" id="5877017">.</span><span class="ident" id="5877018">lk</span><span class="op" id="5877020">.</span><span class="ident" id="5877021">Unlock</span><span class="op" id="5877027">(</span><span class="op" id="5877028">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877032">return</span>&nbsp;<span class="ident" id="5877039">errors</span><span class="op" id="5877045">.</span><span class="ident" id="5877046">New</span><span class="op" id="5877049">(</span><span class="string" id="5877050">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="5877077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5877080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877083">if</span>&nbsp;<span class="ident" id="5877086">resp</span><span class="op" id="5877090">.</span><span class="ident" id="5877091">Close</span>&nbsp;<span class="op" id="5877097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877101">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877163">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877226">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877249">sc</span><span class="op" id="5877251">.</span><span class="ident" id="5877252">re</span>&nbsp;<span class="op" id="5877255">=</span>&nbsp;<span class="ident" id="5877257">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5877272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877275">sc</span><span class="op" id="5877277">.</span><span class="ident" id="5877278">lk</span><span class="op" id="5877280">.</span><span class="ident" id="5877281">Unlock</span><span class="op" id="5877287">(</span><span class="op" id="5877288">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877292">err</span>&nbsp;<span class="op" id="5877296">:=</span>&nbsp;<span class="ident" id="5877299">resp</span><span class="op" id="5877303">.</span><span class="ident" id="5877304">Write</span><span class="op" id="5877309">(</span><span class="ident" id="5877310">c</span><span class="op" id="5877311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877314">sc</span><span class="op" id="5877316">.</span><span class="ident" id="5877317">lk</span><span class="op" id="5877319">.</span><span class="ident" id="5877320">Lock</span><span class="op" id="5877324">(</span><span class="op" id="5877325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877328">defer</span>&nbsp;<span class="ident" id="5877334">sc</span><span class="op" id="5877336">.</span><span class="ident" id="5877337">lk</span><span class="op" id="5877339">.</span><span class="ident" id="5877340">Unlock</span><span class="op" id="5877346">(</span><span class="op" id="5877347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877350">if</span>&nbsp;<span class="ident" id="5877353">err</span>&nbsp;<span class="op" id="5877357">!=</span>&nbsp;<span class="ident" id="5877360">nil</span>&nbsp;<span class="op" id="5877364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877368">sc</span><span class="op" id="5877370">.</span><span class="ident" id="5877371">we</span>&nbsp;<span class="op" id="5877374">=</span>&nbsp;<span class="ident" id="5877376">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877382">return</span>&nbsp;<span class="ident" id="5877389">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5877394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877397">sc</span><span class="op" id="5877399">.</span><span class="ident" id="5877400">nwritten</span><span class="op" id="5877408">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877413">return</span>&nbsp;<span class="ident" id="5877420">nil</span><br>
<span class="lineno">220</span><span class="op" id="5877424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5877427">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="5877497">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="5877566">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="5877621">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="5877695">//</span><br>
<span class="lineno"></span><span class="comment" id="5877698">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="5877766">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5877814">type</span>&nbsp;<span class="ident" id="5877819">ClientConn</span>&nbsp;<span class="keyword" id="5877830">struct</span>&nbsp;<span class="op" id="5877837">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877840">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5877856">sync</span><span class="op" id="5877860">.</span><span class="ident" id="5877861">Mutex</span>&nbsp;<span class="comment" id="5877867">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877912">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5877928">net</span><span class="op" id="5877931">.</span><span class="ident" id="5877932">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877938">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5877954">*</span><span class="ident" id="5877955">bufio</span><span class="op" id="5877960">.</span><span class="ident" id="5877961">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877969">re</span><span class="op" id="5877971">,</span>&nbsp;<span class="ident" id="5877973">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5877985">error</span>&nbsp;<span class="comment" id="5877991">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878013">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5878029">io</span><span class="op" id="5878031">.</span><span class="ident" id="5878032">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878044">nread</span><span class="op" id="5878049">,</span>&nbsp;<span class="ident" id="5878051">nwritten</span>&nbsp;<span class="builtintype" id="5878060">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878065">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5878081">map</span><span class="op" id="5878084">[</span><span class="op" id="5878085">*</span><span class="ident" id="5878086">http</span><span class="op" id="5878090">.</span><span class="ident" id="5878091">Request</span><span class="op" id="5878098">]</span><span class="builtintype" id="5878099">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878106">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5878115">textproto</span><span class="op" id="5878124">.</span><span class="ident" id="5878125">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878135">writeReq</span>&nbsp;<span class="keyword" id="5878144">func</span><span class="op" id="5878148">(</span><span class="op" id="5878149">*</span><span class="ident" id="5878150">http</span><span class="op" id="5878154">.</span><span class="ident" id="5878155">Request</span><span class="op" id="5878162">,</span>&nbsp;<span class="ident" id="5878164">io</span><span class="op" id="5878166">.</span><span class="ident" id="5878167">Writer</span><span class="op" id="5878173">)</span>&nbsp;<span class="builtintype" id="5878175">error</span><br>
<span class="lineno">240</span><span class="op" id="5878181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5878184">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="5878262">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="5878310">//</span><br>
<span class="lineno">245</span><span class="comment" id="5878313">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5878383">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5878421">func</span>&nbsp;<span class="ident" id="5878426">NewClientConn</span><span class="op" id="5878439">(</span><span class="ident" id="5878440">c</span>&nbsp;<span class="ident" id="5878442">net</span><span class="op" id="5878445">.</span><span class="ident" id="5878446">Conn</span><span class="op" id="5878450">,</span>&nbsp;<span class="ident" id="5878452">r</span>&nbsp;<span class="op" id="5878454">*</span><span class="ident" id="5878455">bufio</span><span class="op" id="5878460">.</span><span class="ident" id="5878461">Reader</span><span class="op" id="5878467">)</span>&nbsp;<span class="op" id="5878469">*</span><span class="ident" id="5878470">ClientConn</span>&nbsp;<span class="op" id="5878481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878484">if</span>&nbsp;<span class="ident" id="5878487">r</span>&nbsp;<span class="op" id="5878489">==</span>&nbsp;<span class="ident" id="5878492">nil</span>&nbsp;<span class="op" id="5878496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878500">r</span>&nbsp;<span class="op" id="5878502">=</span>&nbsp;<span class="ident" id="5878504">bufio</span><span class="op" id="5878509">.</span><span class="ident" id="5878510">NewReader</span><span class="op" id="5878519">(</span><span class="ident" id="5878520">c</span><span class="op" id="5878521">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878527">return</span>&nbsp;<span class="op" id="5878534">&amp;</span><span class="ident" id="5878535">ClientConn</span><span class="op" id="5878545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878549">c</span><span class="op" id="5878550">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5878559">c</span><span class="op" id="5878560">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878564">r</span><span class="op" id="5878565">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5878574">r</span><span class="op" id="5878575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878579">pipereq</span><span class="op" id="5878586">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5878589">make</span><span class="op" id="5878593">(</span><span class="keyword" id="5878594">map</span><span class="op" id="5878597">[</span><span class="op" id="5878598">*</span><span class="ident" id="5878599">http</span><span class="op" id="5878603">.</span><span class="ident" id="5878604">Request</span><span class="op" id="5878611">]</span><span class="builtintype" id="5878612">uint</span><span class="op" id="5878616">)</span><span class="op" id="5878617">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878621">writeReq</span><span class="op" id="5878629">:</span>&nbsp;<span class="op" id="5878631">(</span><span class="op" id="5878632">*</span><span class="ident" id="5878633">http</span><span class="op" id="5878637">.</span><span class="ident" id="5878638">Request</span><span class="op" id="5878645">)</span><span class="op" id="5878646">.</span><span class="ident" id="5878647">Write</span><span class="op" id="5878652">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878655">}</span><br>
<span class="lineno"></span><span class="op" id="5878657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5878660">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="5878727">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="5878765">//</span><br>
<span class="lineno"></span><span class="comment" id="5878768">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5878829">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="5878875">func</span>&nbsp;<span class="ident" id="5878880">NewProxyClientConn</span><span class="op" id="5878898">(</span><span class="ident" id="5878899">c</span>&nbsp;<span class="ident" id="5878901">net</span><span class="op" id="5878904">.</span><span class="ident" id="5878905">Conn</span><span class="op" id="5878909">,</span>&nbsp;<span class="ident" id="5878911">r</span>&nbsp;<span class="op" id="5878913">*</span><span class="ident" id="5878914">bufio</span><span class="op" id="5878919">.</span><span class="ident" id="5878920">Reader</span><span class="op" id="5878926">)</span>&nbsp;<span class="op" id="5878928">*</span><span class="ident" id="5878929">ClientConn</span>&nbsp;<span class="op" id="5878940">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878943">cc</span>&nbsp;<span class="op" id="5878946">:=</span>&nbsp;<span class="ident" id="5878949">NewClientConn</span><span class="op" id="5878962">(</span><span class="ident" id="5878963">c</span><span class="op" id="5878964">,</span>&nbsp;<span class="ident" id="5878966">r</span><span class="op" id="5878967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878970">cc</span><span class="op" id="5878972">.</span><span class="ident" id="5878973">writeReq</span>&nbsp;<span class="op" id="5878982">=</span>&nbsp;<span class="op" id="5878984">(</span><span class="op" id="5878985">*</span><span class="ident" id="5878986">http</span><span class="op" id="5878990">.</span><span class="ident" id="5878991">Request</span><span class="op" id="5878998">)</span><span class="op" id="5878999">.</span><span class="ident" id="5879000">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879012">return</span>&nbsp;<span class="ident" id="5879019">cc</span><br>
<span class="lineno"></span><span class="op" id="5879022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="5879025">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="5879105">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5879181">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="5879255">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="5879333">func</span>&nbsp;<span class="op" id="5879338">(</span><span class="ident" id="5879339">cc</span>&nbsp;<span class="op" id="5879342">*</span><span class="ident" id="5879343">ClientConn</span><span class="op" id="5879353">)</span>&nbsp;<span class="ident" id="5879355">Hijack</span><span class="op" id="5879361">(</span><span class="op" id="5879362">)</span>&nbsp;<span class="op" id="5879364">(</span><span class="ident" id="5879365">c</span>&nbsp;<span class="ident" id="5879367">net</span><span class="op" id="5879370">.</span><span class="ident" id="5879371">Conn</span><span class="op" id="5879375">,</span>&nbsp;<span class="ident" id="5879377">r</span>&nbsp;<span class="op" id="5879379">*</span><span class="ident" id="5879380">bufio</span><span class="op" id="5879385">.</span><span class="ident" id="5879386">Reader</span><span class="op" id="5879392">)</span>&nbsp;<span class="op" id="5879394">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879397">cc</span><span class="op" id="5879399">.</span><span class="ident" id="5879400">lk</span><span class="op" id="5879402">.</span><span class="ident" id="5879403">Lock</span><span class="op" id="5879407">(</span><span class="op" id="5879408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879411">defer</span>&nbsp;<span class="ident" id="5879417">cc</span><span class="op" id="5879419">.</span><span class="ident" id="5879420">lk</span><span class="op" id="5879422">.</span><span class="ident" id="5879423">Unlock</span><span class="op" id="5879429">(</span><span class="op" id="5879430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879433">c</span>&nbsp;<span class="op" id="5879435">=</span>&nbsp;<span class="ident" id="5879437">cc</span><span class="op" id="5879439">.</span><span class="ident" id="5879440">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879443">r</span>&nbsp;<span class="op" id="5879445">=</span>&nbsp;<span class="ident" id="5879447">cc</span><span class="op" id="5879449">.</span><span class="ident" id="5879450">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879453">cc</span><span class="op" id="5879455">.</span><span class="ident" id="5879456">c</span>&nbsp;<span class="op" id="5879458">=</span>&nbsp;<span class="ident" id="5879460">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879465">cc</span><span class="op" id="5879467">.</span><span class="ident" id="5879468">r</span>&nbsp;<span class="op" id="5879470">=</span>&nbsp;<span class="ident" id="5879472">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879477">return</span><br>
<span class="lineno"></span><span class="op" id="5879484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5879487">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="5879556">func</span>&nbsp;<span class="op" id="5879561">(</span><span class="ident" id="5879562">cc</span>&nbsp;<span class="op" id="5879565">*</span><span class="ident" id="5879566">ClientConn</span><span class="op" id="5879576">)</span>&nbsp;<span class="ident" id="5879578">Close</span><span class="op" id="5879583">(</span><span class="op" id="5879584">)</span>&nbsp;<span class="builtintype" id="5879586">error</span>&nbsp;<span class="op" id="5879592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879595">c</span><span class="op" id="5879596">,</span>&nbsp;<span class="ident" id="5879598">_</span>&nbsp;<span class="op" id="5879600">:=</span>&nbsp;<span class="ident" id="5879603">cc</span><span class="op" id="5879605">.</span><span class="ident" id="5879606">Hijack</span><span class="op" id="5879612">(</span><span class="op" id="5879613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879616">if</span>&nbsp;<span class="ident" id="5879619">c</span>&nbsp;<span class="op" id="5879621">!=</span>&nbsp;<span class="ident" id="5879624">nil</span>&nbsp;<span class="op" id="5879628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879632">return</span>&nbsp;<span class="ident" id="5879639">c</span><span class="op" id="5879640">.</span><span class="ident" id="5879641">Close</span><span class="op" id="5879646">(</span><span class="op" id="5879647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879650">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879653">return</span>&nbsp;<span class="ident" id="5879660">nil</span><br>
<span class="lineno"></span><span class="op" id="5879664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5879667">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5879747">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="5879824">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="5879904">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5879979">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="5880056">func</span>&nbsp;<span class="op" id="5880061">(</span><span class="ident" id="5880062">cc</span>&nbsp;<span class="op" id="5880065">*</span><span class="ident" id="5880066">ClientConn</span><span class="op" id="5880076">)</span>&nbsp;<span class="ident" id="5880078">Write</span><span class="op" id="5880083">(</span><span class="ident" id="5880084">req</span>&nbsp;<span class="op" id="5880088">*</span><span class="ident" id="5880089">http</span><span class="op" id="5880093">.</span><span class="ident" id="5880094">Request</span><span class="op" id="5880101">)</span>&nbsp;<span class="op" id="5880103">(</span><span class="ident" id="5880104">err</span>&nbsp;<span class="builtintype" id="5880108">error</span><span class="op" id="5880113">)</span>&nbsp;<span class="op" id="5880115">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5880119">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880158">id</span>&nbsp;<span class="op" id="5880161">:=</span>&nbsp;<span class="ident" id="5880164">cc</span><span class="op" id="5880166">.</span><span class="ident" id="5880167">pipe</span><span class="op" id="5880171">.</span><span class="ident" id="5880172">Next</span><span class="op" id="5880176">(</span><span class="op" id="5880177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880180">cc</span><span class="op" id="5880182">.</span><span class="ident" id="5880183">pipe</span><span class="op" id="5880187">.</span><span class="ident" id="5880188">StartRequest</span><span class="op" id="5880200">(</span><span class="ident" id="5880201">id</span><span class="op" id="5880203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880206">defer</span>&nbsp;<span class="keyword" id="5880212">func</span><span class="op" id="5880216">(</span><span class="op" id="5880217">)</span>&nbsp;<span class="op" id="5880219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880223">cc</span><span class="op" id="5880225">.</span><span class="ident" id="5880226">pipe</span><span class="op" id="5880230">.</span><span class="ident" id="5880231">EndRequest</span><span class="op" id="5880241">(</span><span class="ident" id="5880242">id</span><span class="op" id="5880244">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880248">if</span>&nbsp;<span class="ident" id="5880251">err</span>&nbsp;<span class="op" id="5880255">!=</span>&nbsp;<span class="ident" id="5880258">nil</span>&nbsp;<span class="op" id="5880262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880267">cc</span><span class="op" id="5880269">.</span><span class="ident" id="5880270">pipe</span><span class="op" id="5880274">.</span><span class="ident" id="5880275">StartResponse</span><span class="op" id="5880288">(</span><span class="ident" id="5880289">id</span><span class="op" id="5880291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880296">cc</span><span class="op" id="5880298">.</span><span class="ident" id="5880299">pipe</span><span class="op" id="5880303">.</span><span class="ident" id="5880304">EndResponse</span><span class="op" id="5880315">(</span><span class="ident" id="5880316">id</span><span class="op" id="5880318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880322">}</span>&nbsp;<span class="keyword" id="5880324">else</span>&nbsp;<span class="op" id="5880329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5880334">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880381">cc</span><span class="op" id="5880383">.</span><span class="ident" id="5880384">lk</span><span class="op" id="5880386">.</span><span class="ident" id="5880387">Lock</span><span class="op" id="5880391">(</span><span class="op" id="5880392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880397">cc</span><span class="op" id="5880399">.</span><span class="ident" id="5880400">pipereq</span><span class="op" id="5880407">[</span><span class="ident" id="5880408">req</span><span class="op" id="5880411">]</span>&nbsp;<span class="op" id="5880413">=</span>&nbsp;<span class="ident" id="5880415">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880421">cc</span><span class="op" id="5880423">.</span><span class="ident" id="5880424">lk</span><span class="op" id="5880426">.</span><span class="ident" id="5880427">Unlock</span><span class="op" id="5880433">(</span><span class="op" id="5880434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880441">}</span><span class="op" id="5880442">(</span><span class="op" id="5880443">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880447">cc</span><span class="op" id="5880449">.</span><span class="ident" id="5880450">lk</span><span class="op" id="5880452">.</span><span class="ident" id="5880453">Lock</span><span class="op" id="5880457">(</span><span class="op" id="5880458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880461">if</span>&nbsp;<span class="ident" id="5880464">cc</span><span class="op" id="5880466">.</span><span class="ident" id="5880467">re</span>&nbsp;<span class="op" id="5880470">!=</span>&nbsp;<span class="ident" id="5880473">nil</span>&nbsp;<span class="op" id="5880477">{</span>&nbsp;<span class="comment" id="5880479">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880531">defer</span>&nbsp;<span class="ident" id="5880537">cc</span><span class="op" id="5880539">.</span><span class="ident" id="5880540">lk</span><span class="op" id="5880542">.</span><span class="ident" id="5880543">Unlock</span><span class="op" id="5880549">(</span><span class="op" id="5880550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880554">return</span>&nbsp;<span class="ident" id="5880561">cc</span><span class="op" id="5880563">.</span><span class="ident" id="5880564">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880571">if</span>&nbsp;<span class="ident" id="5880574">cc</span><span class="op" id="5880576">.</span><span class="ident" id="5880577">we</span>&nbsp;<span class="op" id="5880580">!=</span>&nbsp;<span class="ident" id="5880583">nil</span>&nbsp;<span class="op" id="5880587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880591">defer</span>&nbsp;<span class="ident" id="5880597">cc</span><span class="op" id="5880599">.</span><span class="ident" id="5880600">lk</span><span class="op" id="5880602">.</span><span class="ident" id="5880603">Unlock</span><span class="op" id="5880609">(</span><span class="op" id="5880610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880614">return</span>&nbsp;<span class="ident" id="5880621">cc</span><span class="op" id="5880623">.</span><span class="ident" id="5880624">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880628">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880631">if</span>&nbsp;<span class="ident" id="5880634">cc</span><span class="op" id="5880636">.</span><span class="ident" id="5880637">c</span>&nbsp;<span class="op" id="5880639">==</span>&nbsp;<span class="ident" id="5880642">nil</span>&nbsp;<span class="op" id="5880646">{</span>&nbsp;<span class="comment" id="5880648">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880695">defer</span>&nbsp;<span class="ident" id="5880701">cc</span><span class="op" id="5880703">.</span><span class="ident" id="5880704">lk</span><span class="op" id="5880706">.</span><span class="ident" id="5880707">Unlock</span><span class="op" id="5880713">(</span><span class="op" id="5880714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880718">return</span>&nbsp;<span class="ident" id="5880725">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880739">c</span>&nbsp;<span class="op" id="5880741">:=</span>&nbsp;<span class="ident" id="5880744">cc</span><span class="op" id="5880746">.</span><span class="ident" id="5880747">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880750">if</span>&nbsp;<span class="ident" id="5880753">req</span><span class="op" id="5880756">.</span><span class="ident" id="5880757">Close</span>&nbsp;<span class="op" id="5880763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5880767">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5880828">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880869">cc</span><span class="op" id="5880871">.</span><span class="ident" id="5880872">we</span>&nbsp;<span class="op" id="5880875">=</span>&nbsp;<span class="ident" id="5880877">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880892">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880895">cc</span><span class="op" id="5880897">.</span><span class="ident" id="5880898">lk</span><span class="op" id="5880900">.</span><span class="ident" id="5880901">Unlock</span><span class="op" id="5880907">(</span><span class="op" id="5880908">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880912">err</span>&nbsp;<span class="op" id="5880916">=</span>&nbsp;<span class="ident" id="5880918">cc</span><span class="op" id="5880920">.</span><span class="ident" id="5880921">writeReq</span><span class="op" id="5880929">(</span><span class="ident" id="5880930">req</span><span class="op" id="5880933">,</span>&nbsp;<span class="ident" id="5880935">c</span><span class="op" id="5880936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880939">cc</span><span class="op" id="5880941">.</span><span class="ident" id="5880942">lk</span><span class="op" id="5880944">.</span><span class="ident" id="5880945">Lock</span><span class="op" id="5880949">(</span><span class="op" id="5880950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880953">defer</span>&nbsp;<span class="ident" id="5880959">cc</span><span class="op" id="5880961">.</span><span class="ident" id="5880962">lk</span><span class="op" id="5880964">.</span><span class="ident" id="5880965">Unlock</span><span class="op" id="5880971">(</span><span class="op" id="5880972">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880975">if</span>&nbsp;<span class="ident" id="5880978">err</span>&nbsp;<span class="op" id="5880982">!=</span>&nbsp;<span class="ident" id="5880985">nil</span>&nbsp;<span class="op" id="5880989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880993">cc</span><span class="op" id="5880995">.</span><span class="ident" id="5880996">we</span>&nbsp;<span class="op" id="5880999">=</span>&nbsp;<span class="ident" id="5881001">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881007">return</span>&nbsp;<span class="ident" id="5881014">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881022">cc</span><span class="op" id="5881024">.</span><span class="ident" id="5881025">nwritten</span><span class="op" id="5881033">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881038">return</span>&nbsp;<span class="ident" id="5881045">nil</span><br>
<span class="lineno"></span><span class="op" id="5881049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5881052">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="5881105">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5881147">func</span>&nbsp;<span class="op" id="5881152">(</span><span class="ident" id="5881153">cc</span>&nbsp;<span class="op" id="5881156">*</span><span class="ident" id="5881157">ClientConn</span><span class="op" id="5881167">)</span>&nbsp;<span class="ident" id="5881169">Pending</span><span class="op" id="5881176">(</span><span class="op" id="5881177">)</span>&nbsp;<span class="builtintype" id="5881179">int</span>&nbsp;<span class="op" id="5881183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881186">cc</span><span class="op" id="5881188">.</span><span class="ident" id="5881189">lk</span><span class="op" id="5881191">.</span><span class="ident" id="5881192">Lock</span><span class="op" id="5881196">(</span><span class="op" id="5881197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881200">defer</span>&nbsp;<span class="ident" id="5881206">cc</span><span class="op" id="5881208">.</span><span class="ident" id="5881209">lk</span><span class="op" id="5881211">.</span><span class="ident" id="5881212">Unlock</span><span class="op" id="5881218">(</span><span class="op" id="5881219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881222">return</span>&nbsp;<span class="ident" id="5881229">cc</span><span class="op" id="5881231">.</span><span class="ident" id="5881232">nwritten</span>&nbsp;<span class="op" id="5881241">-</span>&nbsp;<span class="ident" id="5881243">cc</span><span class="op" id="5881245">.</span><span class="ident" id="5881246">nread</span><br>
<span class="lineno">355</span><span class="op" id="5881252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5881255">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5881328">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="5881400">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="5881472">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="5881527">func</span>&nbsp;<span class="op" id="5881532">(</span><span class="ident" id="5881533">cc</span>&nbsp;<span class="op" id="5881536">*</span><span class="ident" id="5881537">ClientConn</span><span class="op" id="5881547">)</span>&nbsp;<span class="ident" id="5881549">Read</span><span class="op" id="5881553">(</span><span class="ident" id="5881554">req</span>&nbsp;<span class="op" id="5881558">*</span><span class="ident" id="5881559">http</span><span class="op" id="5881563">.</span><span class="ident" id="5881564">Request</span><span class="op" id="5881571">)</span>&nbsp;<span class="op" id="5881573">(</span><span class="ident" id="5881574">resp</span>&nbsp;<span class="op" id="5881579">*</span><span class="ident" id="5881580">http</span><span class="op" id="5881584">.</span><span class="ident" id="5881585">Response</span><span class="op" id="5881593">,</span>&nbsp;<span class="ident" id="5881595">err</span>&nbsp;<span class="builtintype" id="5881599">error</span><span class="op" id="5881604">)</span>&nbsp;<span class="op" id="5881606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5881609">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881668">cc</span><span class="op" id="5881670">.</span><span class="ident" id="5881671">lk</span><span class="op" id="5881673">.</span><span class="ident" id="5881674">Lock</span><span class="op" id="5881678">(</span><span class="op" id="5881679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881682">id</span><span class="op" id="5881684">,</span>&nbsp;<span class="ident" id="5881686">ok</span>&nbsp;<span class="op" id="5881689">:=</span>&nbsp;<span class="ident" id="5881692">cc</span><span class="op" id="5881694">.</span><span class="ident" id="5881695">pipereq</span><span class="op" id="5881702">[</span><span class="ident" id="5881703">req</span><span class="op" id="5881706">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5881709">delete</span><span class="op" id="5881715">(</span><span class="ident" id="5881716">cc</span><span class="op" id="5881718">.</span><span class="ident" id="5881719">pipereq</span><span class="op" id="5881726">,</span>&nbsp;<span class="ident" id="5881728">req</span><span class="op" id="5881731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881734">if</span>&nbsp;<span class="op" id="5881737">!</span><span class="ident" id="5881738">ok</span>&nbsp;<span class="op" id="5881741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881745">cc</span><span class="op" id="5881747">.</span><span class="ident" id="5881748">lk</span><span class="op" id="5881750">.</span><span class="ident" id="5881751">Unlock</span><span class="op" id="5881757">(</span><span class="op" id="5881758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881762">return</span>&nbsp;<span class="ident" id="5881769">nil</span><span class="op" id="5881772">,</span>&nbsp;<span class="ident" id="5881774">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881787">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881790">cc</span><span class="op" id="5881792">.</span><span class="ident" id="5881793">lk</span><span class="op" id="5881795">.</span><span class="ident" id="5881796">Unlock</span><span class="op" id="5881802">(</span><span class="op" id="5881803">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5881807">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881833">cc</span><span class="op" id="5881835">.</span><span class="ident" id="5881836">pipe</span><span class="op" id="5881840">.</span><span class="ident" id="5881841">StartResponse</span><span class="op" id="5881854">(</span><span class="ident" id="5881855">id</span><span class="op" id="5881857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881860">defer</span>&nbsp;<span class="ident" id="5881866">cc</span><span class="op" id="5881868">.</span><span class="ident" id="5881869">pipe</span><span class="op" id="5881873">.</span><span class="ident" id="5881874">EndResponse</span><span class="op" id="5881885">(</span><span class="ident" id="5881886">id</span><span class="op" id="5881888">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881892">cc</span><span class="op" id="5881894">.</span><span class="ident" id="5881895">lk</span><span class="op" id="5881897">.</span><span class="ident" id="5881898">Lock</span><span class="op" id="5881902">(</span><span class="op" id="5881903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881906">if</span>&nbsp;<span class="ident" id="5881909">cc</span><span class="op" id="5881911">.</span><span class="ident" id="5881912">re</span>&nbsp;<span class="op" id="5881915">!=</span>&nbsp;<span class="ident" id="5881918">nil</span>&nbsp;<span class="op" id="5881922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881926">defer</span>&nbsp;<span class="ident" id="5881932">cc</span><span class="op" id="5881934">.</span><span class="ident" id="5881935">lk</span><span class="op" id="5881937">.</span><span class="ident" id="5881938">Unlock</span><span class="op" id="5881944">(</span><span class="op" id="5881945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881949">return</span>&nbsp;<span class="ident" id="5881956">nil</span><span class="op" id="5881959">,</span>&nbsp;<span class="ident" id="5881961">cc</span><span class="op" id="5881963">.</span><span class="ident" id="5881964">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881971">if</span>&nbsp;<span class="ident" id="5881974">cc</span><span class="op" id="5881976">.</span><span class="ident" id="5881977">r</span>&nbsp;<span class="op" id="5881979">==</span>&nbsp;<span class="ident" id="5881982">nil</span>&nbsp;<span class="op" id="5881986">{</span>&nbsp;<span class="comment" id="5881988">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882035">defer</span>&nbsp;<span class="ident" id="5882041">cc</span><span class="op" id="5882043">.</span><span class="ident" id="5882044">lk</span><span class="op" id="5882046">.</span><span class="ident" id="5882047">Unlock</span><span class="op" id="5882053">(</span><span class="op" id="5882054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882058">return</span>&nbsp;<span class="ident" id="5882065">nil</span><span class="op" id="5882068">,</span>&nbsp;<span class="ident" id="5882070">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882081">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882084">r</span>&nbsp;<span class="op" id="5882086">:=</span>&nbsp;<span class="ident" id="5882089">cc</span><span class="op" id="5882091">.</span><span class="ident" id="5882092">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882095">lastbody</span>&nbsp;<span class="op" id="5882104">:=</span>&nbsp;<span class="ident" id="5882107">cc</span><span class="op" id="5882109">.</span><span class="ident" id="5882110">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882120">cc</span><span class="op" id="5882122">.</span><span class="ident" id="5882123">lastbody</span>&nbsp;<span class="op" id="5882132">=</span>&nbsp;<span class="ident" id="5882134">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882139">cc</span><span class="op" id="5882141">.</span><span class="ident" id="5882142">lk</span><span class="op" id="5882144">.</span><span class="ident" id="5882145">Unlock</span><span class="op" id="5882151">(</span><span class="op" id="5882152">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882156">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882232">if</span>&nbsp;<span class="ident" id="5882235">lastbody</span>&nbsp;<span class="op" id="5882244">!=</span>&nbsp;<span class="ident" id="5882247">nil</span>&nbsp;<span class="op" id="5882251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882255">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882321">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882379">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882394">err</span>&nbsp;<span class="op" id="5882398">=</span>&nbsp;<span class="ident" id="5882400">lastbody</span><span class="op" id="5882408">.</span><span class="ident" id="5882409">Close</span><span class="op" id="5882414">(</span><span class="op" id="5882415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882419">if</span>&nbsp;<span class="ident" id="5882422">err</span>&nbsp;<span class="op" id="5882426">!=</span>&nbsp;<span class="ident" id="5882429">nil</span>&nbsp;<span class="op" id="5882433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882438">cc</span><span class="op" id="5882440">.</span><span class="ident" id="5882441">lk</span><span class="op" id="5882443">.</span><span class="ident" id="5882444">Lock</span><span class="op" id="5882448">(</span><span class="op" id="5882449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882454">defer</span>&nbsp;<span class="ident" id="5882460">cc</span><span class="op" id="5882462">.</span><span class="ident" id="5882463">lk</span><span class="op" id="5882465">.</span><span class="ident" id="5882466">Unlock</span><span class="op" id="5882472">(</span><span class="op" id="5882473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882478">cc</span><span class="op" id="5882480">.</span><span class="ident" id="5882481">re</span>&nbsp;<span class="op" id="5882484">=</span>&nbsp;<span class="ident" id="5882486">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882493">return</span>&nbsp;<span class="ident" id="5882500">nil</span><span class="op" id="5882503">,</span>&nbsp;<span class="ident" id="5882505">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882518">resp</span><span class="op" id="5882522">,</span>&nbsp;<span class="ident" id="5882524">err</span>&nbsp;<span class="op" id="5882528">=</span>&nbsp;<span class="ident" id="5882530">http</span><span class="op" id="5882534">.</span><span class="ident" id="5882535">ReadResponse</span><span class="op" id="5882547">(</span><span class="ident" id="5882548">r</span><span class="op" id="5882549">,</span>&nbsp;<span class="ident" id="5882551">req</span><span class="op" id="5882554">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882557">cc</span><span class="op" id="5882559">.</span><span class="ident" id="5882560">lk</span><span class="op" id="5882562">.</span><span class="ident" id="5882563">Lock</span><span class="op" id="5882567">(</span><span class="op" id="5882568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882571">defer</span>&nbsp;<span class="ident" id="5882577">cc</span><span class="op" id="5882579">.</span><span class="ident" id="5882580">lk</span><span class="op" id="5882582">.</span><span class="ident" id="5882583">Unlock</span><span class="op" id="5882589">(</span><span class="op" id="5882590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882593">if</span>&nbsp;<span class="ident" id="5882596">err</span>&nbsp;<span class="op" id="5882600">!=</span>&nbsp;<span class="ident" id="5882603">nil</span>&nbsp;<span class="op" id="5882607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882611">cc</span><span class="op" id="5882613">.</span><span class="ident" id="5882614">re</span>&nbsp;<span class="op" id="5882617">=</span>&nbsp;<span class="ident" id="5882619">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882625">return</span>&nbsp;<span class="ident" id="5882632">resp</span><span class="op" id="5882636">,</span>&nbsp;<span class="ident" id="5882638">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882646">cc</span><span class="op" id="5882648">.</span><span class="ident" id="5882649">lastbody</span>&nbsp;<span class="op" id="5882658">=</span>&nbsp;<span class="ident" id="5882660">resp</span><span class="op" id="5882664">.</span><span class="ident" id="5882665">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882672">cc</span><span class="op" id="5882674">.</span><span class="ident" id="5882675">nread</span><span class="op" id="5882680">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882685">if</span>&nbsp;<span class="ident" id="5882688">resp</span><span class="op" id="5882692">.</span><span class="ident" id="5882693">Close</span>&nbsp;<span class="op" id="5882699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882703">cc</span><span class="op" id="5882705">.</span><span class="ident" id="5882706">re</span>&nbsp;<span class="op" id="5882709">=</span>&nbsp;<span class="ident" id="5882711">ErrPersistEOF</span>&nbsp;<span class="comment" id="5882725">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882759">return</span>&nbsp;<span class="ident" id="5882766">resp</span><span class="op" id="5882770">,</span>&nbsp;<span class="ident" id="5882772">cc</span><span class="op" id="5882774">.</span><span class="ident" id="5882775">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882782">return</span>&nbsp;<span class="ident" id="5882789">resp</span><span class="op" id="5882793">,</span>&nbsp;<span class="ident" id="5882795">err</span><br>
<span class="lineno">420</span><span class="op" id="5882799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5882802">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="5882874">func</span>&nbsp;<span class="op" id="5882879">(</span><span class="ident" id="5882880">cc</span>&nbsp;<span class="op" id="5882883">*</span><span class="ident" id="5882884">ClientConn</span><span class="op" id="5882894">)</span>&nbsp;<span class="ident" id="5882896">Do</span><span class="op" id="5882898">(</span><span class="ident" id="5882899">req</span>&nbsp;<span class="op" id="5882903">*</span><span class="ident" id="5882904">http</span><span class="op" id="5882908">.</span><span class="ident" id="5882909">Request</span><span class="op" id="5882916">)</span>&nbsp;<span class="op" id="5882918">(</span><span class="ident" id="5882919">resp</span>&nbsp;<span class="op" id="5882924">*</span><span class="ident" id="5882925">http</span><span class="op" id="5882929">.</span><span class="ident" id="5882930">Response</span><span class="op" id="5882938">,</span>&nbsp;<span class="ident" id="5882940">err</span>&nbsp;<span class="builtintype" id="5882944">error</span><span class="op" id="5882949">)</span>&nbsp;<span class="op" id="5882951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882954">err</span>&nbsp;<span class="op" id="5882958">=</span>&nbsp;<span class="ident" id="5882960">cc</span><span class="op" id="5882962">.</span><span class="ident" id="5882963">Write</span><span class="op" id="5882968">(</span><span class="ident" id="5882969">req</span><span class="op" id="5882972">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882975">if</span>&nbsp;<span class="ident" id="5882978">err</span>&nbsp;<span class="op" id="5882982">!=</span>&nbsp;<span class="ident" id="5882985">nil</span>&nbsp;<span class="op" id="5882989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882993">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5883001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5883004">return</span>&nbsp;<span class="ident" id="5883011">cc</span><span class="op" id="5883013">.</span><span class="ident" id="5883014">Read</span><span class="op" id="5883018">(</span><span class="ident" id="5883019">req</span><span class="op" id="5883022">)</span><br>
<span class="lineno"></span><span class="op" id="5883024">}</span>
</div>
</body>
</html>
