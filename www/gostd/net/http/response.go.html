<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4811329">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4811384">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4811438">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4811489">//&nbsp;HTTP&nbsp;Response&nbsp;reading&nbsp;and&nbsp;parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4811528">package</span>&nbsp;<span class="ident" id="4811536">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4811542">import</span>&nbsp;<span class="op" id="4811549">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811552">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811561">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811570">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811584">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811594">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811600">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811617">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811628">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811639">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="4811649">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4811652">var</span>&nbsp;<span class="ident" id="4811656">respExcludeHeader</span>&nbsp;<span class="op" id="4811674">=</span>&nbsp;<span class="keyword" id="4811676">map</span><span class="op" id="4811679">[</span><span class="builtintype" id="4811680">string</span><span class="op" id="4811686">]</span><span class="builtintype" id="4811687">bool</span><span class="op" id="4811691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811694">&#34;Content-Length&#34;</span><span class="op" id="4811710">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4811715">true</span><span class="op" id="4811719">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811722">&#34;Transfer-Encoding&#34;</span><span class="op" id="4811741">:</span>&nbsp;<span class="builtintype" id="4811743">true</span><span class="op" id="4811747">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811750">&#34;Trailer&#34;</span><span class="op" id="4811759">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4811771">true</span><span class="op" id="4811775">,</span><br>
<span class="lineno">25</span><span class="op" id="4811777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4811780">//&nbsp;Response&nbsp;represents&nbsp;the&nbsp;response&nbsp;from&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="4811838">//</span><br>
<span class="lineno"></span><span class="keyword" id="4811841">type</span>&nbsp;<span class="ident" id="4811846">Response</span>&nbsp;<span class="keyword" id="4811855">struct</span>&nbsp;<span class="op" id="4811862">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811865">Status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4811876">string</span>&nbsp;<span class="comment" id="4811883">//&nbsp;e.g.&nbsp;&#34;200&nbsp;OK&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811901">StatusCode</span>&nbsp;<span class="builtintype" id="4811912">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4811919">//&nbsp;e.g.&nbsp;200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811932">Proto</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4811943">string</span>&nbsp;<span class="comment" id="4811950">//&nbsp;e.g.&nbsp;&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811970">ProtoMajor</span>&nbsp;<span class="builtintype" id="4811981">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4811988">//&nbsp;e.g.&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811999">ProtoMinor</span>&nbsp;<span class="builtintype" id="4812010">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4812017">//&nbsp;e.g.&nbsp;0</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812029">//&nbsp;Header&nbsp;maps&nbsp;header&nbsp;keys&nbsp;to&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;response&nbsp;had&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812098">//&nbsp;headers&nbsp;with&nbsp;the&nbsp;same&nbsp;key,&nbsp;they&nbsp;may&nbsp;be&nbsp;concatenated,&nbsp;with&nbsp;comma</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812166">//&nbsp;delimiters.&nbsp;&nbsp;(Section&nbsp;4.2&nbsp;of&nbsp;RFC&nbsp;2616&nbsp;requires&nbsp;that&nbsp;multiple&nbsp;headers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812239">//&nbsp;be&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;a&nbsp;comma-delimited&nbsp;sequence.)&nbsp;Values</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812309">//&nbsp;duplicated&nbsp;by&nbsp;other&nbsp;fields&nbsp;in&nbsp;this&nbsp;struct&nbsp;(e.g.,&nbsp;ContentLength)&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812381">//&nbsp;omitted&nbsp;from&nbsp;Header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812406">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812410">//&nbsp;Keys&nbsp;in&nbsp;the&nbsp;map&nbsp;are&nbsp;canonicalized&nbsp;(see&nbsp;CanonicalHeaderKey).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812474">Header</span>&nbsp;<span class="ident" id="4812481">Header</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812490">//&nbsp;Body&nbsp;represents&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812529">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812533">//&nbsp;The&nbsp;http&nbsp;Client&nbsp;and&nbsp;Transport&nbsp;guarantee&nbsp;that&nbsp;Body&nbsp;is&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812597">//&nbsp;non-nil,&nbsp;even&nbsp;on&nbsp;responses&nbsp;without&nbsp;a&nbsp;body&nbsp;or&nbsp;responses&nbsp;with</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812661">//&nbsp;a&nbsp;zero-length&nbsp;body.&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812722">//&nbsp;close&nbsp;Body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812738">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812742">//&nbsp;The&nbsp;Body&nbsp;is&nbsp;automatically&nbsp;dechunked&nbsp;if&nbsp;the&nbsp;server&nbsp;replied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812804">//&nbsp;with&nbsp;a&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812844">Body</span>&nbsp;<span class="ident" id="4812849">io</span><span class="op" id="4812851">.</span><span class="ident" id="4812852">ReadCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812865">//&nbsp;ContentLength&nbsp;records&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;associated&nbsp;content.&nbsp;&nbsp;The</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4812934">//&nbsp;value&nbsp;-1&nbsp;indicates&nbsp;that&nbsp;the&nbsp;length&nbsp;is&nbsp;unknown.&nbsp;&nbsp;Unless&nbsp;Request.Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813008">//&nbsp;is&nbsp;&#34;HEAD&#34;,&nbsp;values&nbsp;&gt;=&nbsp;0&nbsp;indicate&nbsp;that&nbsp;the&nbsp;given&nbsp;number&nbsp;of&nbsp;bytes&nbsp;may</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813079">//&nbsp;be&nbsp;read&nbsp;from&nbsp;Body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813102">ContentLength</span>&nbsp;<span class="ident" id="4813116">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813124">//&nbsp;Contains&nbsp;transfer&nbsp;encodings&nbsp;from&nbsp;outer-most&nbsp;to&nbsp;inner-most.&nbsp;Value&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813196">//&nbsp;nil,&nbsp;means&nbsp;that&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813245">TransferEncoding</span>&nbsp;<span class="op" id="4813262">[</span><span class="op" id="4813263">]</span><span class="builtintype" id="4813264">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813273">//&nbsp;Close&nbsp;records&nbsp;whether&nbsp;the&nbsp;header&nbsp;directed&nbsp;that&nbsp;the&nbsp;connection&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813342">//&nbsp;closed&nbsp;after&nbsp;reading&nbsp;Body.&nbsp;&nbsp;The&nbsp;value&nbsp;is&nbsp;advice&nbsp;for&nbsp;clients:&nbsp;neither</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813415">//&nbsp;ReadResponse&nbsp;nor&nbsp;Response.Write&nbsp;ever&nbsp;closes&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813477">Close</span>&nbsp;<span class="builtintype" id="4813483">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813490">//&nbsp;Trailer&nbsp;maps&nbsp;trailer&nbsp;keys&nbsp;to&nbsp;values,&nbsp;in&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813543">//&nbsp;format&nbsp;as&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813569">Trailer</span>&nbsp;<span class="ident" id="4813577">Header</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813586">//&nbsp;The&nbsp;Request&nbsp;that&nbsp;was&nbsp;sent&nbsp;to&nbsp;obtain&nbsp;this&nbsp;Response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813641">//&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;nil&nbsp;(having&nbsp;already&nbsp;been&nbsp;consumed).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813699">//&nbsp;This&nbsp;is&nbsp;only&nbsp;populated&nbsp;for&nbsp;Client&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813747">Request</span>&nbsp;<span class="op" id="4813755">*</span><span class="ident" id="4813756">Request</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813766">//&nbsp;TLS&nbsp;contains&nbsp;information&nbsp;about&nbsp;the&nbsp;TLS&nbsp;connection&nbsp;on&nbsp;which&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813833">//&nbsp;response&nbsp;was&nbsp;received.&nbsp;It&nbsp;is&nbsp;nil&nbsp;for&nbsp;unencrypted&nbsp;responses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813897">//&nbsp;The&nbsp;pointer&nbsp;is&nbsp;shared&nbsp;between&nbsp;responses&nbsp;and&nbsp;should&nbsp;not&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4813959">//&nbsp;modified.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4813973">TLS</span>&nbsp;<span class="op" id="4813977">*</span><span class="ident" id="4813978">tls</span><span class="op" id="4813981">.</span><span class="ident" id="4813982">ConnectionState</span><br>
<span class="lineno"></span><span class="op" id="4813998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4814001">//&nbsp;Cookies&nbsp;parses&nbsp;and&nbsp;returns&nbsp;the&nbsp;cookies&nbsp;set&nbsp;in&nbsp;the&nbsp;Set-Cookie&nbsp;headers.</span><br>
<span class="lineno"></span><span class="keyword" id="4814074">func</span>&nbsp;<span class="op" id="4814079">(</span><span class="ident" id="4814080">r</span>&nbsp;<span class="op" id="4814082">*</span><span class="ident" id="4814083">Response</span><span class="op" id="4814091">)</span>&nbsp;<span class="ident" id="4814093">Cookies</span><span class="op" id="4814100">(</span><span class="op" id="4814101">)</span>&nbsp;<span class="op" id="4814103">[</span><span class="op" id="4814104">]</span><span class="op" id="4814105">*</span><span class="ident" id="4814106">Cookie</span>&nbsp;<span class="op" id="4814113">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814116">return</span>&nbsp;<span class="ident" id="4814123">readSetCookies</span><span class="op" id="4814137">(</span><span class="ident" id="4814138">r</span><span class="op" id="4814139">.</span><span class="ident" id="4814140">Header</span><span class="op" id="4814146">)</span><br>
<span class="lineno"></span><span class="op" id="4814148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4814151">var</span>&nbsp;<span class="ident" id="4814155">ErrNoLocation</span>&nbsp;<span class="op" id="4814169">=</span>&nbsp;<span class="ident" id="4814171">errors</span><span class="op" id="4814177">.</span><span class="ident" id="4814178">New</span><span class="op" id="4814181">(</span><span class="string" id="4814182">&#34;http:&nbsp;no&nbsp;Location&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="4814220">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4814223">//&nbsp;Location&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;response&#39;s&nbsp;&#34;Location&#34;&nbsp;header,</span><br>
<span class="lineno"></span><span class="comment" id="4814288">//&nbsp;if&nbsp;present.&nbsp;&nbsp;Relative&nbsp;redirects&nbsp;are&nbsp;resolved&nbsp;relative&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4814348">//&nbsp;the&nbsp;Response&#39;s&nbsp;Request.&nbsp;&nbsp;ErrNoLocation&nbsp;is&nbsp;returned&nbsp;if&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="4814408">//&nbsp;Location&nbsp;header&nbsp;is&nbsp;present.</span><br>
<span class="lineno"></span><span class="keyword" id="4814439">func</span>&nbsp;<span class="op" id="4814444">(</span><span class="ident" id="4814445">r</span>&nbsp;<span class="op" id="4814447">*</span><span class="ident" id="4814448">Response</span><span class="op" id="4814456">)</span>&nbsp;<span class="ident" id="4814458">Location</span><span class="op" id="4814466">(</span><span class="op" id="4814467">)</span>&nbsp;<span class="op" id="4814469">(</span><span class="op" id="4814470">*</span><span class="ident" id="4814471">url</span><span class="op" id="4814474">.</span><span class="ident" id="4814475">URL</span><span class="op" id="4814478">,</span>&nbsp;<span class="builtintype" id="4814480">error</span><span class="op" id="4814485">)</span>&nbsp;<span class="op" id="4814487">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814490">lv</span>&nbsp;<span class="op" id="4814493">:=</span>&nbsp;<span class="ident" id="4814496">r</span><span class="op" id="4814497">.</span><span class="ident" id="4814498">Header</span><span class="op" id="4814504">.</span><span class="ident" id="4814505">Get</span><span class="op" id="4814508">(</span><span class="string" id="4814509">&#34;Location&#34;</span><span class="op" id="4814519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814522">if</span>&nbsp;<span class="ident" id="4814525">lv</span>&nbsp;<span class="op" id="4814528">==</span>&nbsp;<span class="string" id="4814531">&#34;&#34;</span>&nbsp;<span class="op" id="4814534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814538">return</span>&nbsp;<span class="ident" id="4814545">nil</span><span class="op" id="4814548">,</span>&nbsp;<span class="ident" id="4814550">ErrNoLocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814568">if</span>&nbsp;<span class="ident" id="4814571">r</span><span class="op" id="4814572">.</span><span class="ident" id="4814573">Request</span>&nbsp;<span class="op" id="4814581">!=</span>&nbsp;<span class="ident" id="4814584">nil</span>&nbsp;<span class="op" id="4814588">&amp;&amp;</span>&nbsp;<span class="ident" id="4814591">r</span><span class="op" id="4814592">.</span><span class="ident" id="4814593">Request</span><span class="op" id="4814600">.</span><span class="ident" id="4814601">URL</span>&nbsp;<span class="op" id="4814605">!=</span>&nbsp;<span class="ident" id="4814608">nil</span>&nbsp;<span class="op" id="4814612">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814616">return</span>&nbsp;<span class="ident" id="4814623">r</span><span class="op" id="4814624">.</span><span class="ident" id="4814625">Request</span><span class="op" id="4814632">.</span><span class="ident" id="4814633">URL</span><span class="op" id="4814636">.</span><span class="ident" id="4814637">Parse</span><span class="op" id="4814642">(</span><span class="ident" id="4814643">lv</span><span class="op" id="4814645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814651">return</span>&nbsp;<span class="ident" id="4814658">url</span><span class="op" id="4814661">.</span><span class="ident" id="4814662">Parse</span><span class="op" id="4814667">(</span><span class="ident" id="4814668">lv</span><span class="op" id="4814670">)</span><br>
<span class="lineno"></span><span class="op" id="4814672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="4814675">//&nbsp;ReadResponse&nbsp;reads&nbsp;and&nbsp;returns&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="4814734">//&nbsp;The&nbsp;req&nbsp;parameter&nbsp;optionally&nbsp;specifies&nbsp;the&nbsp;Request&nbsp;that&nbsp;corresponds</span><br>
<span class="lineno"></span><span class="comment" id="4814805">//&nbsp;to&nbsp;this&nbsp;Response.&nbsp;If&nbsp;nil,&nbsp;a&nbsp;GET&nbsp;request&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="4814860">//&nbsp;Clients&nbsp;must&nbsp;call&nbsp;resp.Body.Close&nbsp;when&nbsp;finished&nbsp;reading&nbsp;resp.Body.</span><br>
<span class="lineno"></span><span class="comment" id="4814930">//&nbsp;After&nbsp;that&nbsp;call,&nbsp;clients&nbsp;can&nbsp;inspect&nbsp;resp.Trailer&nbsp;to&nbsp;find&nbsp;key/value</span><br>
<span class="lineno">115</span><span class="comment" id="4815001">//&nbsp;pairs&nbsp;included&nbsp;in&nbsp;the&nbsp;response&nbsp;trailer.</span><br>
<span class="lineno"></span><span class="keyword" id="4815044">func</span>&nbsp;<span class="ident" id="4815049">ReadResponse</span><span class="op" id="4815061">(</span><span class="ident" id="4815062">r</span>&nbsp;<span class="op" id="4815064">*</span><span class="ident" id="4815065">bufio</span><span class="op" id="4815070">.</span><span class="ident" id="4815071">Reader</span><span class="op" id="4815077">,</span>&nbsp;<span class="ident" id="4815079">req</span>&nbsp;<span class="op" id="4815083">*</span><span class="ident" id="4815084">Request</span><span class="op" id="4815091">)</span>&nbsp;<span class="op" id="4815093">(</span><span class="op" id="4815094">*</span><span class="ident" id="4815095">Response</span><span class="op" id="4815103">,</span>&nbsp;<span class="builtintype" id="4815105">error</span><span class="op" id="4815110">)</span>&nbsp;<span class="op" id="4815112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815115">tp</span>&nbsp;<span class="op" id="4815118">:=</span>&nbsp;<span class="ident" id="4815121">textproto</span><span class="op" id="4815130">.</span><span class="ident" id="4815131">NewReader</span><span class="op" id="4815140">(</span><span class="ident" id="4815141">r</span><span class="op" id="4815142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815145">resp</span>&nbsp;<span class="op" id="4815150">:=</span>&nbsp;<span class="op" id="4815153">&amp;</span><span class="ident" id="4815154">Response</span><span class="op" id="4815162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815166">Request</span><span class="op" id="4815173">:</span>&nbsp;<span class="ident" id="4815175">req</span><span class="op" id="4815178">,</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4815185">//&nbsp;Parse&nbsp;the&nbsp;first&nbsp;line&nbsp;of&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815227">line</span><span class="op" id="4815231">,</span>&nbsp;<span class="ident" id="4815233">err</span>&nbsp;<span class="op" id="4815237">:=</span>&nbsp;<span class="ident" id="4815240">tp</span><span class="op" id="4815242">.</span><span class="ident" id="4815243">ReadLine</span><span class="op" id="4815251">(</span><span class="op" id="4815252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815255">if</span>&nbsp;<span class="ident" id="4815258">err</span>&nbsp;<span class="op" id="4815262">!=</span>&nbsp;<span class="ident" id="4815265">nil</span>&nbsp;<span class="op" id="4815269">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815273">if</span>&nbsp;<span class="ident" id="4815276">err</span>&nbsp;<span class="op" id="4815280">==</span>&nbsp;<span class="ident" id="4815283">io</span><span class="op" id="4815285">.</span><span class="ident" id="4815286">EOF</span>&nbsp;<span class="op" id="4815290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815295">err</span>&nbsp;<span class="op" id="4815299">=</span>&nbsp;<span class="ident" id="4815301">io</span><span class="op" id="4815303">.</span><span class="ident" id="4815304">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815327">return</span>&nbsp;<span class="ident" id="4815334">nil</span><span class="op" id="4815337">,</span>&nbsp;<span class="ident" id="4815339">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815344">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815347">f</span>&nbsp;<span class="op" id="4815349">:=</span>&nbsp;<span class="ident" id="4815352">strings</span><span class="op" id="4815359">.</span><span class="ident" id="4815360">SplitN</span><span class="op" id="4815366">(</span><span class="ident" id="4815367">line</span><span class="op" id="4815371">,</span>&nbsp;<span class="string" id="4815373">&#34;&nbsp;&#34;</span><span class="op" id="4815376">,</span>&nbsp;<span class="num" id="4815378">3</span><span class="op" id="4815379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815382">if</span>&nbsp;<span class="builtinfunc" id="4815385">len</span><span class="op" id="4815388">(</span><span class="ident" id="4815389">f</span><span class="op" id="4815390">)</span>&nbsp;<span class="op" id="4815392">&lt;</span>&nbsp;<span class="num" id="4815394">2</span>&nbsp;<span class="op" id="4815396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815400">return</span>&nbsp;<span class="ident" id="4815407">nil</span><span class="op" id="4815410">,</span>&nbsp;<span class="op" id="4815412">&amp;</span><span class="ident" id="4815413">badStringError</span><span class="op" id="4815427">{</span><span class="string" id="4815428">&#34;malformed&nbsp;HTTP&nbsp;response&#34;</span><span class="op" id="4815453">,</span>&nbsp;<span class="ident" id="4815455">line</span><span class="op" id="4815459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815465">reasonPhrase</span>&nbsp;<span class="op" id="4815478">:=</span>&nbsp;<span class="string" id="4815481">&#34;&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815485">if</span>&nbsp;<span class="builtinfunc" id="4815488">len</span><span class="op" id="4815491">(</span><span class="ident" id="4815492">f</span><span class="op" id="4815493">)</span>&nbsp;<span class="op" id="4815495">&gt;</span>&nbsp;<span class="num" id="4815497">2</span>&nbsp;<span class="op" id="4815499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815503">reasonPhrase</span>&nbsp;<span class="op" id="4815516">=</span>&nbsp;<span class="ident" id="4815518">f</span><span class="op" id="4815519">[</span><span class="num" id="4815520">2</span><span class="op" id="4815521">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815527">resp</span><span class="op" id="4815531">.</span><span class="ident" id="4815532">Status</span>&nbsp;<span class="op" id="4815539">=</span>&nbsp;<span class="ident" id="4815541">f</span><span class="op" id="4815542">[</span><span class="num" id="4815543">1</span><span class="op" id="4815544">]</span>&nbsp;<span class="op" id="4815546">+</span>&nbsp;<span class="string" id="4815548">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="4815552">+</span>&nbsp;<span class="ident" id="4815554">reasonPhrase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815568">resp</span><span class="op" id="4815572">.</span><span class="ident" id="4815573">StatusCode</span><span class="op" id="4815583">,</span>&nbsp;<span class="ident" id="4815585">err</span>&nbsp;<span class="op" id="4815589">=</span>&nbsp;<span class="ident" id="4815591">strconv</span><span class="op" id="4815598">.</span><span class="ident" id="4815599">Atoi</span><span class="op" id="4815603">(</span><span class="ident" id="4815604">f</span><span class="op" id="4815605">[</span><span class="num" id="4815606">1</span><span class="op" id="4815607">]</span><span class="op" id="4815608">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815611">if</span>&nbsp;<span class="ident" id="4815614">err</span>&nbsp;<span class="op" id="4815618">!=</span>&nbsp;<span class="ident" id="4815621">nil</span>&nbsp;<span class="op" id="4815625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815629">return</span>&nbsp;<span class="ident" id="4815636">nil</span><span class="op" id="4815639">,</span>&nbsp;<span class="op" id="4815641">&amp;</span><span class="ident" id="4815642">badStringError</span><span class="op" id="4815656">{</span><span class="string" id="4815657">&#34;malformed&nbsp;HTTP&nbsp;status&nbsp;code&#34;</span><span class="op" id="4815685">,</span>&nbsp;<span class="ident" id="4815687">f</span><span class="op" id="4815688">[</span><span class="num" id="4815689">1</span><span class="op" id="4815690">]</span><span class="op" id="4815691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815698">resp</span><span class="op" id="4815702">.</span><span class="ident" id="4815703">Proto</span>&nbsp;<span class="op" id="4815709">=</span>&nbsp;<span class="ident" id="4815711">f</span><span class="op" id="4815712">[</span><span class="num" id="4815713">0</span><span class="op" id="4815714">]</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815717">var</span>&nbsp;<span class="ident" id="4815721">ok</span>&nbsp;<span class="builtintype" id="4815724">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815730">if</span>&nbsp;<span class="ident" id="4815733">resp</span><span class="op" id="4815737">.</span><span class="ident" id="4815738">ProtoMajor</span><span class="op" id="4815748">,</span>&nbsp;<span class="ident" id="4815750">resp</span><span class="op" id="4815754">.</span><span class="ident" id="4815755">ProtoMinor</span><span class="op" id="4815765">,</span>&nbsp;<span class="ident" id="4815767">ok</span>&nbsp;<span class="op" id="4815770">=</span>&nbsp;<span class="ident" id="4815772">ParseHTTPVersion</span><span class="op" id="4815788">(</span><span class="ident" id="4815789">resp</span><span class="op" id="4815793">.</span><span class="ident" id="4815794">Proto</span><span class="op" id="4815799">)</span><span class="op" id="4815800">;</span>&nbsp;<span class="op" id="4815802">!</span><span class="ident" id="4815803">ok</span>&nbsp;<span class="op" id="4815806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815810">return</span>&nbsp;<span class="ident" id="4815817">nil</span><span class="op" id="4815820">,</span>&nbsp;<span class="op" id="4815822">&amp;</span><span class="ident" id="4815823">badStringError</span><span class="op" id="4815837">{</span><span class="string" id="4815838">&#34;malformed&nbsp;HTTP&nbsp;version&#34;</span><span class="op" id="4815862">,</span>&nbsp;<span class="ident" id="4815864">resp</span><span class="op" id="4815868">.</span><span class="ident" id="4815869">Proto</span><span class="op" id="4815874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4815881">//&nbsp;Parse&nbsp;the&nbsp;response&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815913">mimeHeader</span><span class="op" id="4815923">,</span>&nbsp;<span class="ident" id="4815925">err</span>&nbsp;<span class="op" id="4815929">:=</span>&nbsp;<span class="ident" id="4815932">tp</span><span class="op" id="4815934">.</span><span class="ident" id="4815935">ReadMIMEHeader</span><span class="op" id="4815949">(</span><span class="op" id="4815950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815953">if</span>&nbsp;<span class="ident" id="4815956">err</span>&nbsp;<span class="op" id="4815960">!=</span>&nbsp;<span class="ident" id="4815963">nil</span>&nbsp;<span class="op" id="4815967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815971">if</span>&nbsp;<span class="ident" id="4815974">err</span>&nbsp;<span class="op" id="4815978">==</span>&nbsp;<span class="ident" id="4815981">io</span><span class="op" id="4815983">.</span><span class="ident" id="4815984">EOF</span>&nbsp;<span class="op" id="4815988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815993">err</span>&nbsp;<span class="op" id="4815997">=</span>&nbsp;<span class="ident" id="4815999">io</span><span class="op" id="4816001">.</span><span class="ident" id="4816002">ErrUnexpectedEOF</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816025">return</span>&nbsp;<span class="ident" id="4816032">nil</span><span class="op" id="4816035">,</span>&nbsp;<span class="ident" id="4816037">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816045">resp</span><span class="op" id="4816049">.</span><span class="ident" id="4816050">Header</span>&nbsp;<span class="op" id="4816057">=</span>&nbsp;<span class="ident" id="4816059">Header</span><span class="op" id="4816065">(</span><span class="ident" id="4816066">mimeHeader</span><span class="op" id="4816076">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816080">fixPragmaCacheControl</span><span class="op" id="4816101">(</span><span class="ident" id="4816102">resp</span><span class="op" id="4816106">.</span><span class="ident" id="4816107">Header</span><span class="op" id="4816113">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816117">err</span>&nbsp;<span class="op" id="4816121">=</span>&nbsp;<span class="ident" id="4816123">readTransfer</span><span class="op" id="4816135">(</span><span class="ident" id="4816136">resp</span><span class="op" id="4816140">,</span>&nbsp;<span class="ident" id="4816142">r</span><span class="op" id="4816143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816146">if</span>&nbsp;<span class="ident" id="4816149">err</span>&nbsp;<span class="op" id="4816153">!=</span>&nbsp;<span class="ident" id="4816156">nil</span>&nbsp;<span class="op" id="4816160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816164">return</span>&nbsp;<span class="ident" id="4816171">nil</span><span class="op" id="4816174">,</span>&nbsp;<span class="ident" id="4816176">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816185">return</span>&nbsp;<span class="ident" id="4816192">resp</span><span class="op" id="4816196">,</span>&nbsp;<span class="ident" id="4816198">nil</span><br>
<span class="lineno"></span><span class="op" id="4816202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="4816205">//&nbsp;RFC2616:&nbsp;Should&nbsp;treat</span><br>
<span class="lineno"></span><span class="comment" id="4816230">//&nbsp;&nbsp;&nbsp;&nbspPragma:&nbsp;no-cache</span><br>
<span class="lineno"></span><span class="comment" id="4816250">//&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="4816258">//&nbsp;&nbsp;&nbsp;&nbspCache-Control:&nbsp;no-cache</span><br>
<span class="lineno"></span><span class="keyword" id="4816285">func</span>&nbsp;<span class="ident" id="4816290">fixPragmaCacheControl</span><span class="op" id="4816311">(</span><span class="ident" id="4816312">header</span>&nbsp;<span class="ident" id="4816319">Header</span><span class="op" id="4816325">)</span>&nbsp;<span class="op" id="4816327">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816330">if</span>&nbsp;<span class="ident" id="4816333">hp</span><span class="op" id="4816335">,</span>&nbsp;<span class="ident" id="4816337">ok</span>&nbsp;<span class="op" id="4816340">:=</span>&nbsp;<span class="ident" id="4816343">header</span><span class="op" id="4816349">[</span><span class="string" id="4816350">&#34;Pragma&#34;</span><span class="op" id="4816358">]</span><span class="op" id="4816359">;</span>&nbsp;<span class="ident" id="4816361">ok</span>&nbsp;<span class="op" id="4816364">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4816367">len</span><span class="op" id="4816370">(</span><span class="ident" id="4816371">hp</span><span class="op" id="4816373">)</span>&nbsp;<span class="op" id="4816375">&gt;</span>&nbsp;<span class="num" id="4816377">0</span>&nbsp;<span class="op" id="4816379">&amp;&amp;</span>&nbsp;<span class="ident" id="4816382">hp</span><span class="op" id="4816384">[</span><span class="num" id="4816385">0</span><span class="op" id="4816386">]</span>&nbsp;<span class="op" id="4816388">==</span>&nbsp;<span class="string" id="4816391">&#34;no-cache&#34;</span>&nbsp;<span class="op" id="4816402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816406">if</span>&nbsp;<span class="ident" id="4816409">_</span><span class="op" id="4816410">,</span>&nbsp;<span class="ident" id="4816412">presentcc</span>&nbsp;<span class="op" id="4816422">:=</span>&nbsp;<span class="ident" id="4816425">header</span><span class="op" id="4816431">[</span><span class="string" id="4816432">&#34;Cache-Control&#34;</span><span class="op" id="4816447">]</span><span class="op" id="4816448">;</span>&nbsp;<span class="op" id="4816450">!</span><span class="ident" id="4816451">presentcc</span>&nbsp;<span class="op" id="4816461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816466">header</span><span class="op" id="4816472">[</span><span class="string" id="4816473">&#34;Cache-Control&#34;</span><span class="op" id="4816488">]</span>&nbsp;<span class="op" id="4816490">=</span>&nbsp;<span class="op" id="4816492">[</span><span class="op" id="4816493">]</span><span class="builtintype" id="4816494">string</span><span class="op" id="4816500">{</span><span class="string" id="4816501">&#34;no-cache&#34;</span><span class="op" id="4816511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816518">}</span><br>
<span class="lineno">180</span><span class="op" id="4816520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4816523">//&nbsp;ProtoAtLeast&nbsp;reports&nbsp;whether&nbsp;the&nbsp;HTTP&nbsp;protocol&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="4816578">//&nbsp;in&nbsp;the&nbsp;response&nbsp;is&nbsp;at&nbsp;least&nbsp;major.minor.</span><br>
<span class="lineno"></span><span class="keyword" id="4816622">func</span>&nbsp;<span class="op" id="4816627">(</span><span class="ident" id="4816628">r</span>&nbsp;<span class="op" id="4816630">*</span><span class="ident" id="4816631">Response</span><span class="op" id="4816639">)</span>&nbsp;<span class="ident" id="4816641">ProtoAtLeast</span><span class="op" id="4816653">(</span><span class="ident" id="4816654">major</span><span class="op" id="4816659">,</span>&nbsp;<span class="ident" id="4816661">minor</span>&nbsp;<span class="builtintype" id="4816667">int</span><span class="op" id="4816670">)</span>&nbsp;<span class="builtintype" id="4816672">bool</span>&nbsp;<span class="op" id="4816677">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816680">return</span>&nbsp;<span class="ident" id="4816687">r</span><span class="op" id="4816688">.</span><span class="ident" id="4816689">ProtoMajor</span>&nbsp;<span class="op" id="4816700">&gt;</span>&nbsp;<span class="ident" id="4816702">major</span>&nbsp;<span class="op" id="4816708">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816713">r</span><span class="op" id="4816714">.</span><span class="ident" id="4816715">ProtoMajor</span>&nbsp;<span class="op" id="4816726">==</span>&nbsp;<span class="ident" id="4816729">major</span>&nbsp;<span class="op" id="4816735">&amp;&amp;</span>&nbsp;<span class="ident" id="4816738">r</span><span class="op" id="4816739">.</span><span class="ident" id="4816740">ProtoMinor</span>&nbsp;<span class="op" id="4816751">&gt;=</span>&nbsp;<span class="ident" id="4816754">minor</span><br>
<span class="lineno"></span><span class="op" id="4816760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4816763">//&nbsp;Writes&nbsp;the&nbsp;response&nbsp;(header,&nbsp;body&nbsp;and&nbsp;trailer)&nbsp;in&nbsp;wire&nbsp;format.&nbsp;This&nbsp;method</span><br>
<span class="lineno">190</span><span class="comment" id="4816841">//&nbsp;consults&nbsp;the&nbsp;following&nbsp;fields&nbsp;of&nbsp;the&nbsp;response:</span><br>
<span class="lineno"></span><span class="comment" id="4816891">//</span><br>
<span class="lineno"></span><span class="comment" id="4816894">//&nbsp;&nbsp;StatusCode</span><br>
<span class="lineno"></span><span class="comment" id="4816909">//&nbsp;&nbsp;ProtoMajor</span><br>
<span class="lineno"></span><span class="comment" id="4816924">//&nbsp;&nbsp;ProtoMinor</span><br>
<span class="lineno">195</span><span class="comment" id="4816939">//&nbsp;&nbsp;Request.Method</span><br>
<span class="lineno"></span><span class="comment" id="4816958">//&nbsp;&nbsp;TransferEncoding</span><br>
<span class="lineno"></span><span class="comment" id="4816979">//&nbsp;&nbsp;Trailer</span><br>
<span class="lineno"></span><span class="comment" id="4816991">//&nbsp;&nbsp;Body</span><br>
<span class="lineno"></span><span class="comment" id="4817000">//&nbsp;&nbsp;ContentLength</span><br>
<span class="lineno">200</span><span class="comment" id="4817018">//&nbsp;&nbsp;Header,&nbsp;values&nbsp;for&nbsp;non-canonical&nbsp;keys&nbsp;will&nbsp;have&nbsp;unpredictable&nbsp;behavior</span><br>
<span class="lineno"></span><span class="comment" id="4817093">//</span><br>
<span class="lineno"></span><span class="comment" id="4817096">//&nbsp;Body&nbsp;is&nbsp;closed&nbsp;after&nbsp;it&nbsp;is&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="4817132">func</span>&nbsp;<span class="op" id="4817137">(</span><span class="ident" id="4817138">r</span>&nbsp;<span class="op" id="4817140">*</span><span class="ident" id="4817141">Response</span><span class="op" id="4817149">)</span>&nbsp;<span class="ident" id="4817151">Write</span><span class="op" id="4817156">(</span><span class="ident" id="4817157">w</span>&nbsp;<span class="ident" id="4817159">io</span><span class="op" id="4817161">.</span><span class="ident" id="4817162">Writer</span><span class="op" id="4817168">)</span>&nbsp;<span class="builtintype" id="4817170">error</span>&nbsp;<span class="op" id="4817176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4817179">//&nbsp;Status&nbsp;line</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817195">text</span>&nbsp;<span class="op" id="4817200">:=</span>&nbsp;<span class="ident" id="4817203">r</span><span class="op" id="4817204">.</span><span class="ident" id="4817205">Status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817213">if</span>&nbsp;<span class="ident" id="4817216">text</span>&nbsp;<span class="op" id="4817221">==</span>&nbsp;<span class="string" id="4817224">&#34;&#34;</span>&nbsp;<span class="op" id="4817227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817231">var</span>&nbsp;<span class="ident" id="4817235">ok</span>&nbsp;<span class="builtintype" id="4817238">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817245">text</span><span class="op" id="4817249">,</span>&nbsp;<span class="ident" id="4817251">ok</span>&nbsp;<span class="op" id="4817254">=</span>&nbsp;<span class="ident" id="4817256">statusText</span><span class="op" id="4817266">[</span><span class="ident" id="4817267">r</span><span class="op" id="4817268">.</span><span class="ident" id="4817269">StatusCode</span><span class="op" id="4817279">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817283">if</span>&nbsp;<span class="op" id="4817286">!</span><span class="ident" id="4817287">ok</span>&nbsp;<span class="op" id="4817290">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817295">text</span>&nbsp;<span class="op" id="4817300">=</span>&nbsp;<span class="string" id="4817302">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="4817317">+</span>&nbsp;<span class="ident" id="4817319">strconv</span><span class="op" id="4817326">.</span><span class="ident" id="4817327">Itoa</span><span class="op" id="4817331">(</span><span class="ident" id="4817332">r</span><span class="op" id="4817333">.</span><span class="ident" id="4817334">StatusCode</span><span class="op" id="4817344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817354">protoMajor</span><span class="op" id="4817364">,</span>&nbsp;<span class="ident" id="4817366">protoMinor</span>&nbsp;<span class="op" id="4817377">:=</span>&nbsp;<span class="ident" id="4817380">strconv</span><span class="op" id="4817387">.</span><span class="ident" id="4817388">Itoa</span><span class="op" id="4817392">(</span><span class="ident" id="4817393">r</span><span class="op" id="4817394">.</span><span class="ident" id="4817395">ProtoMajor</span><span class="op" id="4817405">)</span><span class="op" id="4817406">,</span>&nbsp;<span class="ident" id="4817408">strconv</span><span class="op" id="4817415">.</span><span class="ident" id="4817416">Itoa</span><span class="op" id="4817420">(</span><span class="ident" id="4817421">r</span><span class="op" id="4817422">.</span><span class="ident" id="4817423">ProtoMinor</span><span class="op" id="4817433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817436">statusCode</span>&nbsp;<span class="op" id="4817447">:=</span>&nbsp;<span class="ident" id="4817450">strconv</span><span class="op" id="4817457">.</span><span class="ident" id="4817458">Itoa</span><span class="op" id="4817462">(</span><span class="ident" id="4817463">r</span><span class="op" id="4817464">.</span><span class="ident" id="4817465">StatusCode</span><span class="op" id="4817475">)</span>&nbsp;<span class="op" id="4817477">+</span>&nbsp;<span class="string" id="4817479">&#34;&nbsp;&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817484">text</span>&nbsp;<span class="op" id="4817489">=</span>&nbsp;<span class="ident" id="4817491">strings</span><span class="op" id="4817498">.</span><span class="ident" id="4817499">TrimPrefix</span><span class="op" id="4817509">(</span><span class="ident" id="4817510">text</span><span class="op" id="4817514">,</span>&nbsp;<span class="ident" id="4817516">statusCode</span><span class="op" id="4817526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817529">if</span>&nbsp;<span class="ident" id="4817532">_</span><span class="op" id="4817533">,</span>&nbsp;<span class="ident" id="4817535">err</span>&nbsp;<span class="op" id="4817539">:=</span>&nbsp;<span class="ident" id="4817542">io</span><span class="op" id="4817544">.</span><span class="ident" id="4817545">WriteString</span><span class="op" id="4817556">(</span><span class="ident" id="4817557">w</span><span class="op" id="4817558">,</span>&nbsp;<span class="string" id="4817560">&#34;HTTP/&#34;</span><span class="op" id="4817567">+</span><span class="ident" id="4817568">protoMajor</span><span class="op" id="4817578">+</span><span class="string" id="4817579">&#34;.&#34;</span><span class="op" id="4817582">+</span><span class="ident" id="4817583">protoMinor</span><span class="op" id="4817593">+</span><span class="string" id="4817594">&#34;&nbsp;&#34;</span><span class="op" id="4817597">+</span><span class="ident" id="4817598">statusCode</span><span class="op" id="4817608">+</span><span class="ident" id="4817609">text</span><span class="op" id="4817613">+</span><span class="string" id="4817614">&#34;\r\n&#34;</span><span class="op" id="4817620">)</span><span class="op" id="4817621">;</span>&nbsp;<span class="ident" id="4817623">err</span>&nbsp;<span class="op" id="4817627">!=</span>&nbsp;<span class="ident" id="4817630">nil</span>&nbsp;<span class="op" id="4817634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817638">return</span>&nbsp;<span class="ident" id="4817645">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4817654">//&nbsp;Clone&nbsp;it,&nbsp;so&nbsp;we&nbsp;can&nbsp;modify&nbsp;r1&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817699">r1</span>&nbsp;<span class="op" id="4817702">:=</span>&nbsp;<span class="builtinfunc" id="4817705">new</span><span class="op" id="4817708">(</span><span class="ident" id="4817709">Response</span><span class="op" id="4817717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817720">*</span><span class="ident" id="4817721">r1</span>&nbsp;<span class="op" id="4817724">=</span>&nbsp;<span class="op" id="4817726">*</span><span class="ident" id="4817727">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817730">if</span>&nbsp;<span class="ident" id="4817733">r1</span><span class="op" id="4817735">.</span><span class="ident" id="4817736">ContentLength</span>&nbsp;<span class="op" id="4817750">==</span>&nbsp;<span class="num" id="4817753">0</span>&nbsp;<span class="op" id="4817755">&amp;&amp;</span>&nbsp;<span class="ident" id="4817758">r1</span><span class="op" id="4817760">.</span><span class="ident" id="4817761">Body</span>&nbsp;<span class="op" id="4817766">!=</span>&nbsp;<span class="ident" id="4817769">nil</span>&nbsp;<span class="op" id="4817773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4817777">//&nbsp;Is&nbsp;it&nbsp;actually&nbsp;0&nbsp;length?&nbsp;Or&nbsp;just&nbsp;unknown?</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817824">var</span>&nbsp;<span class="ident" id="4817828">buf</span>&nbsp;<span class="op" id="4817832">[</span><span class="num" id="4817833">1</span><span class="op" id="4817834">]</span><span class="builtintype" id="4817835">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817842">n</span><span class="op" id="4817843">,</span>&nbsp;<span class="ident" id="4817845">err</span>&nbsp;<span class="op" id="4817849">:=</span>&nbsp;<span class="ident" id="4817852">r1</span><span class="op" id="4817854">.</span><span class="ident" id="4817855">Body</span><span class="op" id="4817859">.</span><span class="ident" id="4817860">Read</span><span class="op" id="4817864">(</span><span class="ident" id="4817865">buf</span><span class="op" id="4817868">[</span><span class="op" id="4817869">:</span><span class="op" id="4817870">]</span><span class="op" id="4817871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817875">if</span>&nbsp;<span class="ident" id="4817878">err</span>&nbsp;<span class="op" id="4817882">!=</span>&nbsp;<span class="ident" id="4817885">nil</span>&nbsp;<span class="op" id="4817889">&amp;&amp;</span>&nbsp;<span class="ident" id="4817892">err</span>&nbsp;<span class="op" id="4817896">!=</span>&nbsp;<span class="ident" id="4817899">io</span><span class="op" id="4817901">.</span><span class="ident" id="4817902">EOF</span>&nbsp;<span class="op" id="4817906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817911">return</span>&nbsp;<span class="ident" id="4817918">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817924">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817928">if</span>&nbsp;<span class="ident" id="4817931">n</span>&nbsp;<span class="op" id="4817933">==</span>&nbsp;<span class="num" id="4817936">0</span>&nbsp;<span class="op" id="4817938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4817943">//&nbsp;Reset&nbsp;it&nbsp;to&nbsp;a&nbsp;known&nbsp;zero&nbsp;reader,&nbsp;in&nbsp;case&nbsp;underlying&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818005">//&nbsp;is&nbsp;unhappy&nbsp;being&nbsp;read&nbsp;repeatedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818045">r1</span><span class="op" id="4818047">.</span><span class="ident" id="4818048">Body</span>&nbsp;<span class="op" id="4818053">=</span>&nbsp;<span class="ident" id="4818055">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818067">}</span>&nbsp;<span class="keyword" id="4818069">else</span>&nbsp;<span class="op" id="4818074">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818079">r1</span><span class="op" id="4818081">.</span><span class="ident" id="4818082">ContentLength</span>&nbsp;<span class="op" id="4818096">=</span>&nbsp;<span class="op" id="4818098">-</span><span class="num" id="4818099">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818104">r1</span><span class="op" id="4818106">.</span><span class="ident" id="4818107">Body</span>&nbsp;<span class="op" id="4818112">=</span>&nbsp;<span class="keyword" id="4818114">struct</span>&nbsp;<span class="op" id="4818121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818127">io</span><span class="op" id="4818129">.</span><span class="ident" id="4818130">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818141">io</span><span class="op" id="4818143">.</span><span class="ident" id="4818144">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818154">}</span><span class="op" id="4818155">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818161">io</span><span class="op" id="4818163">.</span><span class="ident" id="4818164">MultiReader</span><span class="op" id="4818175">(</span><span class="ident" id="4818176">bytes</span><span class="op" id="4818181">.</span><span class="ident" id="4818182">NewReader</span><span class="op" id="4818191">(</span><span class="ident" id="4818192">buf</span><span class="op" id="4818195">[</span><span class="op" id="4818196">:</span><span class="num" id="4818197">1</span><span class="op" id="4818198">]</span><span class="op" id="4818199">)</span><span class="op" id="4818200">,</span>&nbsp;<span class="ident" id="4818202">r</span><span class="op" id="4818203">.</span><span class="ident" id="4818204">Body</span><span class="op" id="4818208">)</span><span class="op" id="4818209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818215">r</span><span class="op" id="4818216">.</span><span class="ident" id="4818217">Body</span><span class="op" id="4818221">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818233">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818236">//&nbsp;If&nbsp;we&#39;re&nbsp;sending&nbsp;a&nbsp;non-chunked&nbsp;HTTP/1.1&nbsp;response&nbsp;without&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818299">//&nbsp;content-length,&nbsp;the&nbsp;only&nbsp;way&nbsp;to&nbsp;do&nbsp;that&nbsp;is&nbsp;the&nbsp;old&nbsp;HTTP/1.0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818363">//&nbsp;way,&nbsp;by&nbsp;noting&nbsp;the&nbsp;EOF&nbsp;with&nbsp;a&nbsp;connection&nbsp;close,&nbsp;so&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818426">//&nbsp;to&nbsp;set&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818444">if</span>&nbsp;<span class="ident" id="4818447">r1</span><span class="op" id="4818449">.</span><span class="ident" id="4818450">ContentLength</span>&nbsp;<span class="op" id="4818464">==</span>&nbsp;<span class="op" id="4818467">-</span><span class="num" id="4818468">1</span>&nbsp;<span class="op" id="4818470">&amp;&amp;</span>&nbsp;<span class="op" id="4818473">!</span><span class="ident" id="4818474">r1</span><span class="op" id="4818476">.</span><span class="ident" id="4818477">Close</span>&nbsp;<span class="op" id="4818483">&amp;&amp;</span>&nbsp;<span class="ident" id="4818486">r1</span><span class="op" id="4818488">.</span><span class="ident" id="4818489">ProtoAtLeast</span><span class="op" id="4818501">(</span><span class="num" id="4818502">1</span><span class="op" id="4818503">,</span>&nbsp;<span class="num" id="4818505">1</span><span class="op" id="4818506">)</span>&nbsp;<span class="op" id="4818508">&amp;&amp;</span>&nbsp;<span class="op" id="4818511">!</span><span class="ident" id="4818512">chunked</span><span class="op" id="4818519">(</span><span class="ident" id="4818520">r1</span><span class="op" id="4818522">.</span><span class="ident" id="4818523">TransferEncoding</span><span class="op" id="4818539">)</span>&nbsp;<span class="op" id="4818541">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818545">r1</span><span class="op" id="4818547">.</span><span class="ident" id="4818548">Close</span>&nbsp;<span class="op" id="4818554">=</span>&nbsp;<span class="builtintype" id="4818556">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818566">//&nbsp;Process&nbsp;Body,ContentLength,Close,Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818611">tw</span><span class="op" id="4818613">,</span>&nbsp;<span class="ident" id="4818615">err</span>&nbsp;<span class="op" id="4818619">:=</span>&nbsp;<span class="ident" id="4818622">newTransferWriter</span><span class="op" id="4818639">(</span><span class="ident" id="4818640">r1</span><span class="op" id="4818642">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818645">if</span>&nbsp;<span class="ident" id="4818648">err</span>&nbsp;<span class="op" id="4818652">!=</span>&nbsp;<span class="ident" id="4818655">nil</span>&nbsp;<span class="op" id="4818659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818663">return</span>&nbsp;<span class="ident" id="4818670">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818678">err</span>&nbsp;<span class="op" id="4818682">=</span>&nbsp;<span class="ident" id="4818684">tw</span><span class="op" id="4818686">.</span><span class="ident" id="4818687">WriteHeader</span><span class="op" id="4818698">(</span><span class="ident" id="4818699">w</span><span class="op" id="4818700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818703">if</span>&nbsp;<span class="ident" id="4818706">err</span>&nbsp;<span class="op" id="4818710">!=</span>&nbsp;<span class="ident" id="4818713">nil</span>&nbsp;<span class="op" id="4818717">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818721">return</span>&nbsp;<span class="ident" id="4818728">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818737">//&nbsp;Rest&nbsp;of&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818756">err</span>&nbsp;<span class="op" id="4818760">=</span>&nbsp;<span class="ident" id="4818762">r</span><span class="op" id="4818763">.</span><span class="ident" id="4818764">Header</span><span class="op" id="4818770">.</span><span class="ident" id="4818771">WriteSubset</span><span class="op" id="4818782">(</span><span class="ident" id="4818783">w</span><span class="op" id="4818784">,</span>&nbsp;<span class="ident" id="4818786">respExcludeHeader</span><span class="op" id="4818803">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818806">if</span>&nbsp;<span class="ident" id="4818809">err</span>&nbsp;<span class="op" id="4818813">!=</span>&nbsp;<span class="ident" id="4818816">nil</span>&nbsp;<span class="op" id="4818820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818824">return</span>&nbsp;<span class="ident" id="4818831">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818840">//&nbsp;contentLengthAlreadySent&nbsp;may&nbsp;have&nbsp;been&nbsp;already&nbsp;sent&nbsp;for</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4818900">//&nbsp;POST/PUT&nbsp;requests,&nbsp;even&nbsp;if&nbsp;zero&nbsp;length.&nbsp;See&nbsp;Issue&nbsp;8180.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818960">contentLengthAlreadySent</span>&nbsp;<span class="op" id="4818985">:=</span>&nbsp;<span class="ident" id="4818988">tw</span><span class="op" id="4818990">.</span><span class="ident" id="4818991">shouldSendContentLength</span><span class="op" id="4819014">(</span><span class="op" id="4819015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819018">if</span>&nbsp;<span class="ident" id="4819021">r1</span><span class="op" id="4819023">.</span><span class="ident" id="4819024">ContentLength</span>&nbsp;<span class="op" id="4819038">==</span>&nbsp;<span class="num" id="4819041">0</span>&nbsp;<span class="op" id="4819043">&amp;&amp;</span>&nbsp;<span class="op" id="4819046">!</span><span class="ident" id="4819047">chunked</span><span class="op" id="4819054">(</span><span class="ident" id="4819055">r1</span><span class="op" id="4819057">.</span><span class="ident" id="4819058">TransferEncoding</span><span class="op" id="4819074">)</span>&nbsp;<span class="op" id="4819076">&amp;&amp;</span>&nbsp;<span class="op" id="4819079">!</span><span class="ident" id="4819080">contentLengthAlreadySent</span>&nbsp;<span class="op" id="4819105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819109">if</span>&nbsp;<span class="ident" id="4819112">_</span><span class="op" id="4819113">,</span>&nbsp;<span class="ident" id="4819115">err</span>&nbsp;<span class="op" id="4819119">:=</span>&nbsp;<span class="ident" id="4819122">io</span><span class="op" id="4819124">.</span><span class="ident" id="4819125">WriteString</span><span class="op" id="4819136">(</span><span class="ident" id="4819137">w</span><span class="op" id="4819138">,</span>&nbsp;<span class="string" id="4819140">&#34;Content-Length:&nbsp;0\r\n&#34;</span><span class="op" id="4819163">)</span><span class="op" id="4819164">;</span>&nbsp;<span class="ident" id="4819166">err</span>&nbsp;<span class="op" id="4819170">!=</span>&nbsp;<span class="ident" id="4819173">nil</span>&nbsp;<span class="op" id="4819177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819182">return</span>&nbsp;<span class="ident" id="4819189">err</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819202">//&nbsp;End-of-header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819220">if</span>&nbsp;<span class="ident" id="4819223">_</span><span class="op" id="4819224">,</span>&nbsp;<span class="ident" id="4819226">err</span>&nbsp;<span class="op" id="4819230">:=</span>&nbsp;<span class="ident" id="4819233">io</span><span class="op" id="4819235">.</span><span class="ident" id="4819236">WriteString</span><span class="op" id="4819247">(</span><span class="ident" id="4819248">w</span><span class="op" id="4819249">,</span>&nbsp;<span class="string" id="4819251">&#34;\r\n&#34;</span><span class="op" id="4819257">)</span><span class="op" id="4819258">;</span>&nbsp;<span class="ident" id="4819260">err</span>&nbsp;<span class="op" id="4819264">!=</span>&nbsp;<span class="ident" id="4819267">nil</span>&nbsp;<span class="op" id="4819271">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819275">return</span>&nbsp;<span class="ident" id="4819282">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819291">//&nbsp;Write&nbsp;body&nbsp;and&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819318">err</span>&nbsp;<span class="op" id="4819322">=</span>&nbsp;<span class="ident" id="4819324">tw</span><span class="op" id="4819326">.</span><span class="ident" id="4819327">WriteBody</span><span class="op" id="4819336">(</span><span class="ident" id="4819337">w</span><span class="op" id="4819338">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819341">if</span>&nbsp;<span class="ident" id="4819344">err</span>&nbsp;<span class="op" id="4819348">!=</span>&nbsp;<span class="ident" id="4819351">nil</span>&nbsp;<span class="op" id="4819355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819359">return</span>&nbsp;<span class="ident" id="4819366">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4819371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4819375">//&nbsp;Success</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4819387">return</span>&nbsp;<span class="ident" id="4819394">nil</span><br>
<span class="lineno"></span><span class="op" id="4819398">}</span>
</div>
</body>
</html>
