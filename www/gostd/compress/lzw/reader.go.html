<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5441297">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5441352">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5441406">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5441457">//&nbsp;Package&nbsp;lzw&nbsp;implements&nbsp;the&nbsp;Lempel-Ziv-Welch&nbsp;compressed&nbsp;data&nbsp;format,</span><br>
<span class="lineno"></span><span class="comment" id="5441528">//&nbsp;described&nbsp;in&nbsp;T.&nbsp;A.&nbsp;Welch,&nbsp;``A&nbsp;Technique&nbsp;for&nbsp;High-Performance&nbsp;Data</span><br>
<span class="lineno"></span><span class="comment" id="5441597">//&nbsp;Compression&#39;&#39;,&nbsp;Computer,&nbsp;17(6)&nbsp;(June&nbsp;1984),&nbsp;pp&nbsp;8-19.</span><br>
<span class="lineno"></span><span class="comment" id="5441653">//</span><br>
<span class="lineno"></span><span class="comment" id="5441656">//&nbsp;In&nbsp;particular,&nbsp;it&nbsp;implements&nbsp;LZW&nbsp;as&nbsp;used&nbsp;by&nbsp;the&nbsp;GIF&nbsp;and&nbsp;PDF&nbsp;file</span><br>
<span class="lineno">10</span><span class="comment" id="5441724">//&nbsp;formats,&nbsp;which&nbsp;means&nbsp;variable-width&nbsp;codes&nbsp;up&nbsp;to&nbsp;12&nbsp;bits&nbsp;and&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5441797">//&nbsp;two&nbsp;non-literal&nbsp;codes&nbsp;are&nbsp;a&nbsp;clear&nbsp;code&nbsp;and&nbsp;an&nbsp;EOF&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="5441856">//</span><br>
<span class="lineno"></span><span class="comment" id="5441859">//&nbsp;The&nbsp;TIFF&nbsp;file&nbsp;format&nbsp;uses&nbsp;a&nbsp;similar&nbsp;but&nbsp;incompatible&nbsp;version&nbsp;of&nbsp;the&nbsp;LZW</span><br>
<span class="lineno"></span><span class="comment" id="5441934">//&nbsp;algorithm.&nbsp;See&nbsp;the&nbsp;golang.org/x/image/tiff/lzw&nbsp;package&nbsp;for&nbsp;an</span><br>
<span class="lineno">15</span><span class="comment" id="5441999">//&nbsp;implementation.</span><br>
<span class="lineno"></span><span class="keyword" id="5442018">package</span>&nbsp;<span class="ident" id="5442026">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5442031">//&nbsp;TODO(nigeltao):&nbsp;check&nbsp;that&nbsp;PDF&nbsp;uses&nbsp;LZW&nbsp;in&nbsp;the&nbsp;same&nbsp;way&nbsp;as&nbsp;GIF,</span><br>
<span class="lineno"></span><span class="comment" id="5442098">//&nbsp;modulo&nbsp;LSB/MSB&nbsp;packing&nbsp;order.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5442132">import</span>&nbsp;<span class="op" id="5442139">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442142">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442151">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442161">&#34;fmt&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5442168">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5442173">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5442176">//&nbsp;Order&nbsp;specifies&nbsp;the&nbsp;bit&nbsp;ordering&nbsp;in&nbsp;an&nbsp;LZW&nbsp;data&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword" id="5442235">type</span>&nbsp;<span class="ident" id="5442240">Order</span>&nbsp;<span class="builtintype" id="5442246">int</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="5442251">const</span>&nbsp;<span class="op" id="5442257">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5442260">//&nbsp;LSB&nbsp;means&nbsp;Least&nbsp;Significant&nbsp;Bits&nbsp;first,&nbsp;as&nbsp;used&nbsp;in&nbsp;the&nbsp;GIF&nbsp;file&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5442336">LSB</span>&nbsp;<span class="ident" id="5442340">Order</span>&nbsp;<span class="op" id="5442346">=</span>&nbsp;<span class="ident" id="5442348">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5442354">//&nbsp;MSB&nbsp;means&nbsp;Most&nbsp;Significant&nbsp;Bits&nbsp;first,&nbsp;as&nbsp;used&nbsp;in&nbsp;the&nbsp;TIFF&nbsp;and&nbsp;PDF</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5442425">//&nbsp;file&nbsp;formats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5442443">MSB</span><br>
<span class="lineno"></span><span class="op" id="5442447">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5442450">const</span>&nbsp;<span class="op" id="5442456">(</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5442459">maxWidth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5442478">=</span>&nbsp;<span class="num" id="5442480">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5442484">decoderInvalidCode</span>&nbsp;<span class="op" id="5442503">=</span>&nbsp;<span class="num" id="5442505">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5442513">flushBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5442532">=</span>&nbsp;<span class="num" id="5442534">1</span>&nbsp;<span class="op" id="5442536">&lt;&lt;</span>&nbsp;<span class="ident" id="5442539">maxWidth</span><br>
<span class="lineno"></span><span class="op" id="5442548">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5442551">//&nbsp;decoder&nbsp;is&nbsp;the&nbsp;state&nbsp;from&nbsp;which&nbsp;the&nbsp;readXxx&nbsp;method&nbsp;converts&nbsp;a&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="5442621">//&nbsp;stream&nbsp;into&nbsp;a&nbsp;code&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword" id="5442651">type</span>&nbsp;<span class="ident" id="5442656">decoder</span>&nbsp;<span class="keyword" id="5442664">struct</span>&nbsp;<span class="op" id="5442671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5442674">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442683">io</span><span class="op" id="5442685">.</span><span class="ident" id="5442686">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5442698">bits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5442707">uint32</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5442715">nBits</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5442724">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5442730">width</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5442739">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5442745">read</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5442754">func</span><span class="op" id="5442758">(</span><span class="op" id="5442759">*</span><span class="ident" id="5442760">decoder</span><span class="op" id="5442767">)</span>&nbsp;<span class="op" id="5442769">(</span><span class="builtintype" id="5442770">uint16</span><span class="op" id="5442776">,</span>&nbsp;<span class="builtintype" id="5442778">error</span><span class="op" id="5442783">)</span>&nbsp;<span class="comment" id="5442785">//&nbsp;readLSB&nbsp;or&nbsp;readMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5442808">litWidth</span>&nbsp;<span class="builtintype" id="5442817">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5442848">//&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5442883">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5442892">error</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5442900">//&nbsp;The&nbsp;first&nbsp;1&lt;&lt;litWidth&nbsp;codes&nbsp;are&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5442951">//&nbsp;The&nbsp;next&nbsp;two&nbsp;codes&nbsp;mean&nbsp;clear&nbsp;and&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5442994">//&nbsp;Other&nbsp;valid&nbsp;codes&nbsp;are&nbsp;in&nbsp;the&nbsp;range&nbsp;[lo,&nbsp;hi]&nbsp;where&nbsp;lo&nbsp;:=&nbsp;clear&nbsp;+&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443065">//&nbsp;with&nbsp;the&nbsp;upper&nbsp;bound&nbsp;incrementing&nbsp;on&nbsp;each&nbsp;code&nbsp;seen.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443122">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443185">//&nbsp;last&nbsp;is&nbsp;the&nbsp;most&nbsp;recently&nbsp;seen&nbsp;code,&nbsp;or&nbsp;decoderInvalidCode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5443249">clear</span><span class="op" id="5443254">,</span>&nbsp;<span class="ident" id="5443256">eof</span><span class="op" id="5443259">,</span>&nbsp;<span class="ident" id="5443261">hi</span><span class="op" id="5443263">,</span>&nbsp;<span class="ident" id="5443265">overflow</span><span class="op" id="5443273">,</span>&nbsp;<span class="ident" id="5443275">last</span>&nbsp;<span class="builtintype" id="5443280">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443289">//&nbsp;Each&nbsp;code&nbsp;c&nbsp;in&nbsp;[lo,&nbsp;hi]&nbsp;expands&nbsp;to&nbsp;two&nbsp;or&nbsp;more&nbsp;bytes.&nbsp;For&nbsp;c&nbsp;!=&nbsp;hi:</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443360">//&nbsp;&nbsp;&nbsp;suffix[c]&nbsp;is&nbsp;the&nbsp;last&nbsp;of&nbsp;these&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443404">//&nbsp;&nbsp;&nbsp;prefix[c]&nbsp;is&nbsp;the&nbsp;code&nbsp;for&nbsp;all&nbsp;but&nbsp;the&nbsp;last&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443459">//&nbsp;&nbsp;&nbsp;This&nbsp;code&nbsp;can&nbsp;either&nbsp;be&nbsp;a&nbsp;literal&nbsp;code&nbsp;or&nbsp;another&nbsp;code&nbsp;in&nbsp;[lo,&nbsp;c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443532">//&nbsp;The&nbsp;c&nbsp;==&nbsp;hi&nbsp;case&nbsp;is&nbsp;a&nbsp;special&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5443572">suffix</span>&nbsp;<span class="op" id="5443579">[</span><span class="num" id="5443580">1</span>&nbsp;<span class="op" id="5443582">&lt;&lt;</span>&nbsp;<span class="ident" id="5443585">maxWidth</span><span class="op" id="5443593">]</span><span class="builtintype" id="5443594">uint8</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5443601">prefix</span>&nbsp;<span class="op" id="5443608">[</span><span class="num" id="5443609">1</span>&nbsp;<span class="op" id="5443611">&lt;&lt;</span>&nbsp;<span class="ident" id="5443614">maxWidth</span><span class="op" id="5443622">]</span><span class="builtintype" id="5443623">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443632">//&nbsp;output&nbsp;is&nbsp;the&nbsp;temporary&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443675">//&nbsp;Literal&nbsp;codes&nbsp;are&nbsp;accumulated&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443739">//&nbsp;Non-literal&nbsp;codes&nbsp;decode&nbsp;to&nbsp;a&nbsp;sequence&nbsp;of&nbsp;suffixes&nbsp;that&nbsp;are&nbsp;first</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443809">//&nbsp;written&nbsp;right-to-left&nbsp;from&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;buffer&nbsp;before&nbsp;being&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443882">//&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443914">//&nbsp;It&nbsp;is&nbsp;flushed&nbsp;when&nbsp;it&nbsp;contains&nbsp;&gt;=&nbsp;1&lt;&lt;maxWidth&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5443971">//&nbsp;so&nbsp;that&nbsp;there&nbsp;is&nbsp;always&nbsp;room&nbsp;to&nbsp;decode&nbsp;an&nbsp;entire&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444030">output</span>&nbsp;<span class="op" id="5444037">[</span><span class="num" id="5444038">2</span>&nbsp;<span class="op" id="5444040">*</span>&nbsp;<span class="num" id="5444042">1</span>&nbsp;<span class="op" id="5444044">&lt;&lt;</span>&nbsp;<span class="ident" id="5444047">maxWidth</span><span class="op" id="5444055">]</span><span class="builtintype" id="5444056">byte</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444062">o</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5444069">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5444076">//&nbsp;write&nbsp;index&nbsp;into&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444104">toRead</span>&nbsp;<span class="op" id="5444111">[</span><span class="op" id="5444112">]</span><span class="builtintype" id="5444113">byte</span>&nbsp;<span class="comment" id="5444118">//&nbsp;bytes&nbsp;to&nbsp;return&nbsp;from&nbsp;Read</span><br>
<span class="lineno"></span><span class="op" id="5444147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5444150">//&nbsp;readLSB&nbsp;returns&nbsp;the&nbsp;next&nbsp;code&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno">85</span><span class="keyword" id="5444224">func</span>&nbsp;<span class="op" id="5444229">(</span><span class="ident" id="5444230">d</span>&nbsp;<span class="op" id="5444232">*</span><span class="ident" id="5444233">decoder</span><span class="op" id="5444240">)</span>&nbsp;<span class="ident" id="5444242">readLSB</span><span class="op" id="5444249">(</span><span class="op" id="5444250">)</span>&nbsp;<span class="op" id="5444252">(</span><span class="builtintype" id="5444253">uint16</span><span class="op" id="5444259">,</span>&nbsp;<span class="builtintype" id="5444261">error</span><span class="op" id="5444266">)</span>&nbsp;<span class="op" id="5444268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444271">for</span>&nbsp;<span class="ident" id="5444275">d</span><span class="op" id="5444276">.</span><span class="ident" id="5444277">nBits</span>&nbsp;<span class="op" id="5444283">&lt;</span>&nbsp;<span class="ident" id="5444285">d</span><span class="op" id="5444286">.</span><span class="ident" id="5444287">width</span>&nbsp;<span class="op" id="5444293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444297">x</span><span class="op" id="5444298">,</span>&nbsp;<span class="ident" id="5444300">err</span>&nbsp;<span class="op" id="5444304">:=</span>&nbsp;<span class="ident" id="5444307">d</span><span class="op" id="5444308">.</span><span class="ident" id="5444309">r</span><span class="op" id="5444310">.</span><span class="ident" id="5444311">ReadByte</span><span class="op" id="5444319">(</span><span class="op" id="5444320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444324">if</span>&nbsp;<span class="ident" id="5444327">err</span>&nbsp;<span class="op" id="5444331">!=</span>&nbsp;<span class="ident" id="5444334">nil</span>&nbsp;<span class="op" id="5444338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444343">return</span>&nbsp;<span class="num" id="5444350">0</span><span class="op" id="5444351">,</span>&nbsp;<span class="ident" id="5444353">err</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5444359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444363">d</span><span class="op" id="5444364">.</span><span class="ident" id="5444365">bits</span>&nbsp;<span class="op" id="5444370">|=</span>&nbsp;<span class="builtintype" id="5444373">uint32</span><span class="op" id="5444379">(</span><span class="ident" id="5444380">x</span><span class="op" id="5444381">)</span>&nbsp;<span class="op" id="5444383">&lt;&lt;</span>&nbsp;<span class="ident" id="5444386">d</span><span class="op" id="5444387">.</span><span class="ident" id="5444388">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444396">d</span><span class="op" id="5444397">.</span><span class="ident" id="5444398">nBits</span>&nbsp;<span class="op" id="5444404">+=</span>&nbsp;<span class="num" id="5444407">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5444410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444413">code</span>&nbsp;<span class="op" id="5444418">:=</span>&nbsp;<span class="builtintype" id="5444421">uint16</span><span class="op" id="5444427">(</span><span class="ident" id="5444428">d</span><span class="op" id="5444429">.</span><span class="ident" id="5444430">bits</span>&nbsp;<span class="op" id="5444435">&amp;</span>&nbsp;<span class="op" id="5444437">(</span><span class="num" id="5444438">1</span><span class="op" id="5444439">&lt;&lt;</span><span class="ident" id="5444441">d</span><span class="op" id="5444442">.</span><span class="ident" id="5444443">width</span>&nbsp;<span class="op" id="5444449">-</span>&nbsp;<span class="num" id="5444451">1</span><span class="op" id="5444452">)</span><span class="op" id="5444453">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444456">d</span><span class="op" id="5444457">.</span><span class="ident" id="5444458">bits</span>&nbsp;<span class="op" id="5444463">&gt;&gt;=</span>&nbsp;<span class="ident" id="5444467">d</span><span class="op" id="5444468">.</span><span class="ident" id="5444469">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444476">d</span><span class="op" id="5444477">.</span><span class="ident" id="5444478">nBits</span>&nbsp;<span class="op" id="5444484">-=</span>&nbsp;<span class="ident" id="5444487">d</span><span class="op" id="5444488">.</span><span class="ident" id="5444489">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444496">return</span>&nbsp;<span class="ident" id="5444503">code</span><span class="op" id="5444507">,</span>&nbsp;<span class="ident" id="5444509">nil</span><br>
<span class="lineno"></span><span class="op" id="5444513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="5444516">//&nbsp;readMSB&nbsp;returns&nbsp;the&nbsp;next&nbsp;code&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5444589">func</span>&nbsp;<span class="op" id="5444594">(</span><span class="ident" id="5444595">d</span>&nbsp;<span class="op" id="5444597">*</span><span class="ident" id="5444598">decoder</span><span class="op" id="5444605">)</span>&nbsp;<span class="ident" id="5444607">readMSB</span><span class="op" id="5444614">(</span><span class="op" id="5444615">)</span>&nbsp;<span class="op" id="5444617">(</span><span class="builtintype" id="5444618">uint16</span><span class="op" id="5444624">,</span>&nbsp;<span class="builtintype" id="5444626">error</span><span class="op" id="5444631">)</span>&nbsp;<span class="op" id="5444633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444636">for</span>&nbsp;<span class="ident" id="5444640">d</span><span class="op" id="5444641">.</span><span class="ident" id="5444642">nBits</span>&nbsp;<span class="op" id="5444648">&lt;</span>&nbsp;<span class="ident" id="5444650">d</span><span class="op" id="5444651">.</span><span class="ident" id="5444652">width</span>&nbsp;<span class="op" id="5444658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444662">x</span><span class="op" id="5444663">,</span>&nbsp;<span class="ident" id="5444665">err</span>&nbsp;<span class="op" id="5444669">:=</span>&nbsp;<span class="ident" id="5444672">d</span><span class="op" id="5444673">.</span><span class="ident" id="5444674">r</span><span class="op" id="5444675">.</span><span class="ident" id="5444676">ReadByte</span><span class="op" id="5444684">(</span><span class="op" id="5444685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444689">if</span>&nbsp;<span class="ident" id="5444692">err</span>&nbsp;<span class="op" id="5444696">!=</span>&nbsp;<span class="ident" id="5444699">nil</span>&nbsp;<span class="op" id="5444703">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444708">return</span>&nbsp;<span class="num" id="5444715">0</span><span class="op" id="5444716">,</span>&nbsp;<span class="ident" id="5444718">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5444724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444728">d</span><span class="op" id="5444729">.</span><span class="ident" id="5444730">bits</span>&nbsp;<span class="op" id="5444735">|=</span>&nbsp;<span class="builtintype" id="5444738">uint32</span><span class="op" id="5444744">(</span><span class="ident" id="5444745">x</span><span class="op" id="5444746">)</span>&nbsp;<span class="op" id="5444748">&lt;&lt;</span>&nbsp;<span class="op" id="5444751">(</span><span class="num" id="5444752">24</span>&nbsp;<span class="op" id="5444755">-</span>&nbsp;<span class="ident" id="5444757">d</span><span class="op" id="5444758">.</span><span class="ident" id="5444759">nBits</span><span class="op" id="5444764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444768">d</span><span class="op" id="5444769">.</span><span class="ident" id="5444770">nBits</span>&nbsp;<span class="op" id="5444776">+=</span>&nbsp;<span class="num" id="5444779">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5444782">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444785">code</span>&nbsp;<span class="op" id="5444790">:=</span>&nbsp;<span class="builtintype" id="5444793">uint16</span><span class="op" id="5444799">(</span><span class="ident" id="5444800">d</span><span class="op" id="5444801">.</span><span class="ident" id="5444802">bits</span>&nbsp;<span class="op" id="5444807">&gt;&gt;</span>&nbsp;<span class="op" id="5444810">(</span><span class="num" id="5444811">32</span>&nbsp;<span class="op" id="5444814">-</span>&nbsp;<span class="ident" id="5444816">d</span><span class="op" id="5444817">.</span><span class="ident" id="5444818">width</span><span class="op" id="5444823">)</span><span class="op" id="5444824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444827">d</span><span class="op" id="5444828">.</span><span class="ident" id="5444829">bits</span>&nbsp;<span class="op" id="5444834">&lt;&lt;=</span>&nbsp;<span class="ident" id="5444838">d</span><span class="op" id="5444839">.</span><span class="ident" id="5444840">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444847">d</span><span class="op" id="5444848">.</span><span class="ident" id="5444849">nBits</span>&nbsp;<span class="op" id="5444855">-=</span>&nbsp;<span class="ident" id="5444858">d</span><span class="op" id="5444859">.</span><span class="ident" id="5444860">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444867">return</span>&nbsp;<span class="ident" id="5444874">code</span><span class="op" id="5444878">,</span>&nbsp;<span class="ident" id="5444880">nil</span><br>
<span class="lineno"></span><span class="op" id="5444884">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="5444887">func</span>&nbsp;<span class="op" id="5444892">(</span><span class="ident" id="5444893">d</span>&nbsp;<span class="op" id="5444895">*</span><span class="ident" id="5444896">decoder</span><span class="op" id="5444903">)</span>&nbsp;<span class="ident" id="5444905">Read</span><span class="op" id="5444909">(</span><span class="ident" id="5444910">b</span>&nbsp;<span class="op" id="5444912">[</span><span class="op" id="5444913">]</span><span class="builtintype" id="5444914">byte</span><span class="op" id="5444918">)</span>&nbsp;<span class="op" id="5444920">(</span><span class="builtintype" id="5444921">int</span><span class="op" id="5444924">,</span>&nbsp;<span class="builtintype" id="5444926">error</span><span class="op" id="5444931">)</span>&nbsp;<span class="op" id="5444933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444936">for</span>&nbsp;<span class="op" id="5444940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5444944">if</span>&nbsp;<span class="builtinfunc" id="5444947">len</span><span class="op" id="5444950">(</span><span class="ident" id="5444951">d</span><span class="op" id="5444952">.</span><span class="ident" id="5444953">toRead</span><span class="op" id="5444959">)</span>&nbsp;<span class="op" id="5444961">&gt;</span>&nbsp;<span class="num" id="5444963">0</span>&nbsp;<span class="op" id="5444965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444970">n</span>&nbsp;<span class="op" id="5444972">:=</span>&nbsp;<span class="builtinfunc" id="5444975">copy</span><span class="op" id="5444979">(</span><span class="ident" id="5444980">b</span><span class="op" id="5444981">,</span>&nbsp;<span class="ident" id="5444983">d</span><span class="op" id="5444984">.</span><span class="ident" id="5444985">toRead</span><span class="op" id="5444991">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5444996">d</span><span class="op" id="5444997">.</span><span class="ident" id="5444998">toRead</span>&nbsp;<span class="op" id="5445005">=</span>&nbsp;<span class="ident" id="5445007">d</span><span class="op" id="5445008">.</span><span class="ident" id="5445009">toRead</span><span class="op" id="5445015">[</span><span class="ident" id="5445016">n</span><span class="op" id="5445017">:</span><span class="op" id="5445018">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445023">return</span>&nbsp;<span class="ident" id="5445030">n</span><span class="op" id="5445031">,</span>&nbsp;<span class="ident" id="5445033">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445043">if</span>&nbsp;<span class="ident" id="5445046">d</span><span class="op" id="5445047">.</span><span class="ident" id="5445048">err</span>&nbsp;<span class="op" id="5445052">!=</span>&nbsp;<span class="ident" id="5445055">nil</span>&nbsp;<span class="op" id="5445059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445064">return</span>&nbsp;<span class="num" id="5445071">0</span><span class="op" id="5445072">,</span>&nbsp;<span class="ident" id="5445074">d</span><span class="op" id="5445075">.</span><span class="ident" id="5445076">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445086">d</span><span class="op" id="5445087">.</span><span class="ident" id="5445088">decode</span><span class="op" id="5445094">(</span><span class="op" id="5445095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445098">}</span><br>
<span class="lineno"></span><span class="op" id="5445100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5445103">//&nbsp;decode&nbsp;decompresses&nbsp;bytes&nbsp;from&nbsp;r&nbsp;and&nbsp;leaves&nbsp;them&nbsp;in&nbsp;d.toRead.</span><br>
<span class="lineno"></span><span class="comment" id="5445168">//&nbsp;read&nbsp;specifies&nbsp;how&nbsp;to&nbsp;decode&nbsp;bytes&nbsp;into&nbsp;codes.</span><br>
<span class="lineno"></span><span class="comment" id="5445218">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span><span class="keyword" id="5445269">func</span>&nbsp;<span class="op" id="5445274">(</span><span class="ident" id="5445275">d</span>&nbsp;<span class="op" id="5445277">*</span><span class="ident" id="5445278">decoder</span><span class="op" id="5445285">)</span>&nbsp;<span class="ident" id="5445287">decode</span><span class="op" id="5445293">(</span><span class="op" id="5445294">)</span>&nbsp;<span class="op" id="5445296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5445299">//&nbsp;Loop&nbsp;over&nbsp;the&nbsp;code&nbsp;stream,&nbsp;converting&nbsp;codes&nbsp;into&nbsp;decompressed&nbsp;bytes.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445372">for</span>&nbsp;<span class="op" id="5445376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445380">code</span><span class="op" id="5445384">,</span>&nbsp;<span class="ident" id="5445386">err</span>&nbsp;<span class="op" id="5445390">:=</span>&nbsp;<span class="ident" id="5445393">d</span><span class="op" id="5445394">.</span><span class="ident" id="5445395">read</span><span class="op" id="5445399">(</span><span class="ident" id="5445400">d</span><span class="op" id="5445401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445405">if</span>&nbsp;<span class="ident" id="5445408">err</span>&nbsp;<span class="op" id="5445412">!=</span>&nbsp;<span class="ident" id="5445415">nil</span>&nbsp;<span class="op" id="5445419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445424">if</span>&nbsp;<span class="ident" id="5445427">err</span>&nbsp;<span class="op" id="5445431">==</span>&nbsp;<span class="ident" id="5445434">io</span><span class="op" id="5445436">.</span><span class="ident" id="5445437">EOF</span>&nbsp;<span class="op" id="5445441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445447">err</span>&nbsp;<span class="op" id="5445451">=</span>&nbsp;<span class="ident" id="5445453">io</span><span class="op" id="5445455">.</span><span class="ident" id="5445456">ErrUnexpectedEOF</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445481">d</span><span class="op" id="5445482">.</span><span class="ident" id="5445483">err</span>&nbsp;<span class="op" id="5445487">=</span>&nbsp;<span class="ident" id="5445489">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445496">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445509">switch</span>&nbsp;<span class="op" id="5445516">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445520">case</span>&nbsp;<span class="ident" id="5445525">code</span>&nbsp;<span class="op" id="5445530">&lt;</span>&nbsp;<span class="ident" id="5445532">d</span><span class="op" id="5445533">.</span><span class="ident" id="5445534">clear</span><span class="op" id="5445539">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5445544">//&nbsp;We&nbsp;have&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445574">d</span><span class="op" id="5445575">.</span><span class="ident" id="5445576">output</span><span class="op" id="5445582">[</span><span class="ident" id="5445583">d</span><span class="op" id="5445584">.</span><span class="ident" id="5445585">o</span><span class="op" id="5445586">]</span>&nbsp;<span class="op" id="5445588">=</span>&nbsp;<span class="builtintype" id="5445590">uint8</span><span class="op" id="5445595">(</span><span class="ident" id="5445596">code</span><span class="op" id="5445600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445605">d</span><span class="op" id="5445606">.</span><span class="ident" id="5445607">o</span><span class="op" id="5445608">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445614">if</span>&nbsp;<span class="ident" id="5445617">d</span><span class="op" id="5445618">.</span><span class="ident" id="5445619">last</span>&nbsp;<span class="op" id="5445624">!=</span>&nbsp;<span class="ident" id="5445627">decoderInvalidCode</span>&nbsp;<span class="op" id="5445646">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5445652">//&nbsp;Save&nbsp;what&nbsp;the&nbsp;hi&nbsp;code&nbsp;expands&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445693">d</span><span class="op" id="5445694">.</span><span class="ident" id="5445695">suffix</span><span class="op" id="5445701">[</span><span class="ident" id="5445702">d</span><span class="op" id="5445703">.</span><span class="ident" id="5445704">hi</span><span class="op" id="5445706">]</span>&nbsp;<span class="op" id="5445708">=</span>&nbsp;<span class="builtintype" id="5445710">uint8</span><span class="op" id="5445715">(</span><span class="ident" id="5445716">code</span><span class="op" id="5445720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445726">d</span><span class="op" id="5445727">.</span><span class="ident" id="5445728">prefix</span><span class="op" id="5445734">[</span><span class="ident" id="5445735">d</span><span class="op" id="5445736">.</span><span class="ident" id="5445737">hi</span><span class="op" id="5445739">]</span>&nbsp;<span class="op" id="5445741">=</span>&nbsp;<span class="ident" id="5445743">d</span><span class="op" id="5445744">.</span><span class="ident" id="5445745">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5445753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445757">case</span>&nbsp;<span class="ident" id="5445762">code</span>&nbsp;<span class="op" id="5445767">==</span>&nbsp;<span class="ident" id="5445770">d</span><span class="op" id="5445771">.</span><span class="ident" id="5445772">clear</span><span class="op" id="5445777">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445782">d</span><span class="op" id="5445783">.</span><span class="ident" id="5445784">width</span>&nbsp;<span class="op" id="5445790">=</span>&nbsp;<span class="num" id="5445792">1</span>&nbsp;<span class="op" id="5445794">+</span>&nbsp;<span class="builtintype" id="5445796">uint</span><span class="op" id="5445800">(</span><span class="ident" id="5445801">d</span><span class="op" id="5445802">.</span><span class="ident" id="5445803">litWidth</span><span class="op" id="5445811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445816">d</span><span class="op" id="5445817">.</span><span class="ident" id="5445818">hi</span>&nbsp;<span class="op" id="5445821">=</span>&nbsp;<span class="ident" id="5445823">d</span><span class="op" id="5445824">.</span><span class="ident" id="5445825">eof</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445832">d</span><span class="op" id="5445833">.</span><span class="ident" id="5445834">overflow</span>&nbsp;<span class="op" id="5445843">=</span>&nbsp;<span class="num" id="5445845">1</span>&nbsp;<span class="op" id="5445847">&lt;&lt;</span>&nbsp;<span class="ident" id="5445850">d</span><span class="op" id="5445851">.</span><span class="ident" id="5445852">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445861">d</span><span class="op" id="5445862">.</span><span class="ident" id="5445863">last</span>&nbsp;<span class="op" id="5445868">=</span>&nbsp;<span class="ident" id="5445870">decoderInvalidCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445892">continue</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445903">case</span>&nbsp;<span class="ident" id="5445908">code</span>&nbsp;<span class="op" id="5445913">==</span>&nbsp;<span class="ident" id="5445916">d</span><span class="op" id="5445917">.</span><span class="ident" id="5445918">eof</span><span class="op" id="5445921">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445926">d</span><span class="op" id="5445927">.</span><span class="ident" id="5445928">flush</span><span class="op" id="5445933">(</span><span class="op" id="5445934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445939">d</span><span class="op" id="5445940">.</span><span class="ident" id="5445941">err</span>&nbsp;<span class="op" id="5445945">=</span>&nbsp;<span class="ident" id="5445947">io</span><span class="op" id="5445949">.</span><span class="ident" id="5445950">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445957">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5445966">case</span>&nbsp;<span class="ident" id="5445971">code</span>&nbsp;<span class="op" id="5445976">&lt;=</span>&nbsp;<span class="ident" id="5445979">d</span><span class="op" id="5445980">.</span><span class="ident" id="5445981">hi</span><span class="op" id="5445983">:</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5445988">c</span><span class="op" id="5445989">,</span>&nbsp;<span class="ident" id="5445991">i</span>&nbsp;<span class="op" id="5445993">:=</span>&nbsp;<span class="ident" id="5445996">code</span><span class="op" id="5446000">,</span>&nbsp;<span class="builtinfunc" id="5446002">len</span><span class="op" id="5446005">(</span><span class="ident" id="5446006">d</span><span class="op" id="5446007">.</span><span class="ident" id="5446008">output</span><span class="op" id="5446014">)</span><span class="op" id="5446015">-</span><span class="num" id="5446016">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446021">if</span>&nbsp;<span class="ident" id="5446024">code</span>&nbsp;<span class="op" id="5446029">==</span>&nbsp;<span class="ident" id="5446032">d</span><span class="op" id="5446033">.</span><span class="ident" id="5446034">hi</span>&nbsp;<span class="op" id="5446037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5446043">//&nbsp;code&nbsp;==&nbsp;hi&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;which&nbsp;expands&nbsp;to&nbsp;the&nbsp;last&nbsp;expansion</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5446115">//&nbsp;followed&nbsp;by&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;last&nbsp;expansion.&nbsp;To&nbsp;find&nbsp;the&nbsp;head,&nbsp;we&nbsp;walk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5446192">//&nbsp;the&nbsp;prefix&nbsp;chain&nbsp;until&nbsp;we&nbsp;find&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446246">c</span>&nbsp;<span class="op" id="5446248">=</span>&nbsp;<span class="ident" id="5446250">d</span><span class="op" id="5446251">.</span><span class="ident" id="5446252">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446261">for</span>&nbsp;<span class="ident" id="5446265">c</span>&nbsp;<span class="op" id="5446267">&gt;=</span>&nbsp;<span class="ident" id="5446270">d</span><span class="op" id="5446271">.</span><span class="ident" id="5446272">clear</span>&nbsp;<span class="op" id="5446278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446285">c</span>&nbsp;<span class="op" id="5446287">=</span>&nbsp;<span class="ident" id="5446289">d</span><span class="op" id="5446290">.</span><span class="ident" id="5446291">prefix</span><span class="op" id="5446297">[</span><span class="ident" id="5446298">c</span><span class="op" id="5446299">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446311">d</span><span class="op" id="5446312">.</span><span class="ident" id="5446313">output</span><span class="op" id="5446319">[</span><span class="ident" id="5446320">i</span><span class="op" id="5446321">]</span>&nbsp;<span class="op" id="5446323">=</span>&nbsp;<span class="builtintype" id="5446325">uint8</span><span class="op" id="5446330">(</span><span class="ident" id="5446331">c</span><span class="op" id="5446332">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446338">i</span><span class="op" id="5446339">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446346">c</span>&nbsp;<span class="op" id="5446348">=</span>&nbsp;<span class="ident" id="5446350">d</span><span class="op" id="5446351">.</span><span class="ident" id="5446352">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5446365">//&nbsp;Copy&nbsp;the&nbsp;suffix&nbsp;chain&nbsp;into&nbsp;output&nbsp;and&nbsp;then&nbsp;write&nbsp;that&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446431">for</span>&nbsp;<span class="ident" id="5446435">c</span>&nbsp;<span class="op" id="5446437">&gt;=</span>&nbsp;<span class="ident" id="5446440">d</span><span class="op" id="5446441">.</span><span class="ident" id="5446442">clear</span>&nbsp;<span class="op" id="5446448">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446454">d</span><span class="op" id="5446455">.</span><span class="ident" id="5446456">output</span><span class="op" id="5446462">[</span><span class="ident" id="5446463">i</span><span class="op" id="5446464">]</span>&nbsp;<span class="op" id="5446466">=</span>&nbsp;<span class="ident" id="5446468">d</span><span class="op" id="5446469">.</span><span class="ident" id="5446470">suffix</span><span class="op" id="5446476">[</span><span class="ident" id="5446477">c</span><span class="op" id="5446478">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446484">i</span><span class="op" id="5446485">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446492">c</span>&nbsp;<span class="op" id="5446494">=</span>&nbsp;<span class="ident" id="5446496">d</span><span class="op" id="5446497">.</span><span class="ident" id="5446498">prefix</span><span class="op" id="5446504">[</span><span class="ident" id="5446505">c</span><span class="op" id="5446506">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446516">d</span><span class="op" id="5446517">.</span><span class="ident" id="5446518">output</span><span class="op" id="5446524">[</span><span class="ident" id="5446525">i</span><span class="op" id="5446526">]</span>&nbsp;<span class="op" id="5446528">=</span>&nbsp;<span class="builtintype" id="5446530">uint8</span><span class="op" id="5446535">(</span><span class="ident" id="5446536">c</span><span class="op" id="5446537">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446542">d</span><span class="op" id="5446543">.</span><span class="ident" id="5446544">o</span>&nbsp;<span class="op" id="5446546">+=</span>&nbsp;<span class="builtinfunc" id="5446549">copy</span><span class="op" id="5446553">(</span><span class="ident" id="5446554">d</span><span class="op" id="5446555">.</span><span class="ident" id="5446556">output</span><span class="op" id="5446562">[</span><span class="ident" id="5446563">d</span><span class="op" id="5446564">.</span><span class="ident" id="5446565">o</span><span class="op" id="5446566">:</span><span class="op" id="5446567">]</span><span class="op" id="5446568">,</span>&nbsp;<span class="ident" id="5446570">d</span><span class="op" id="5446571">.</span><span class="ident" id="5446572">output</span><span class="op" id="5446578">[</span><span class="ident" id="5446579">i</span><span class="op" id="5446580">:</span><span class="op" id="5446581">]</span><span class="op" id="5446582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446587">if</span>&nbsp;<span class="ident" id="5446590">d</span><span class="op" id="5446591">.</span><span class="ident" id="5446592">last</span>&nbsp;<span class="op" id="5446597">!=</span>&nbsp;<span class="ident" id="5446600">decoderInvalidCode</span>&nbsp;<span class="op" id="5446619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5446625">//&nbsp;Save&nbsp;what&nbsp;the&nbsp;hi&nbsp;code&nbsp;expands&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446666">d</span><span class="op" id="5446667">.</span><span class="ident" id="5446668">suffix</span><span class="op" id="5446674">[</span><span class="ident" id="5446675">d</span><span class="op" id="5446676">.</span><span class="ident" id="5446677">hi</span><span class="op" id="5446679">]</span>&nbsp;<span class="op" id="5446681">=</span>&nbsp;<span class="builtintype" id="5446683">uint8</span><span class="op" id="5446688">(</span><span class="ident" id="5446689">c</span><span class="op" id="5446690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446696">d</span><span class="op" id="5446697">.</span><span class="ident" id="5446698">prefix</span><span class="op" id="5446704">[</span><span class="ident" id="5446705">d</span><span class="op" id="5446706">.</span><span class="ident" id="5446707">hi</span><span class="op" id="5446709">]</span>&nbsp;<span class="op" id="5446711">=</span>&nbsp;<span class="ident" id="5446713">d</span><span class="op" id="5446714">.</span><span class="ident" id="5446715">last</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446727">default</span><span class="op" id="5446734">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446739">d</span><span class="op" id="5446740">.</span><span class="ident" id="5446741">err</span>&nbsp;<span class="op" id="5446745">=</span>&nbsp;<span class="ident" id="5446747">errors</span><span class="op" id="5446753">.</span><span class="ident" id="5446754">New</span><span class="op" id="5446757">(</span><span class="string" id="5446758">&#34;lzw:&nbsp;invalid&nbsp;code&#34;</span><span class="op" id="5446777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446782">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446791">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446795">d</span><span class="op" id="5446796">.</span><span class="ident" id="5446797">last</span><span class="op" id="5446801">,</span>&nbsp;<span class="ident" id="5446803">d</span><span class="op" id="5446804">.</span><span class="ident" id="5446805">hi</span>&nbsp;<span class="op" id="5446808">=</span>&nbsp;<span class="ident" id="5446810">code</span><span class="op" id="5446814">,</span>&nbsp;<span class="ident" id="5446816">d</span><span class="op" id="5446817">.</span><span class="ident" id="5446818">hi</span><span class="op" id="5446820">+</span><span class="num" id="5446821">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446825">if</span>&nbsp;<span class="ident" id="5446828">d</span><span class="op" id="5446829">.</span><span class="ident" id="5446830">hi</span>&nbsp;<span class="op" id="5446833">&gt;=</span>&nbsp;<span class="ident" id="5446836">d</span><span class="op" id="5446837">.</span><span class="ident" id="5446838">overflow</span>&nbsp;<span class="op" id="5446847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446852">if</span>&nbsp;<span class="ident" id="5446855">d</span><span class="op" id="5446856">.</span><span class="ident" id="5446857">width</span>&nbsp;<span class="op" id="5446863">==</span>&nbsp;<span class="ident" id="5446866">maxWidth</span>&nbsp;<span class="op" id="5446875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446881">d</span><span class="op" id="5446882">.</span><span class="ident" id="5446883">last</span>&nbsp;<span class="op" id="5446888">=</span>&nbsp;<span class="ident" id="5446890">decoderInvalidCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446912">}</span>&nbsp;<span class="keyword" id="5446914">else</span>&nbsp;<span class="op" id="5446919">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446925">d</span><span class="op" id="5446926">.</span><span class="ident" id="5446927">width</span><span class="op" id="5446932">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446939">d</span><span class="op" id="5446940">.</span><span class="ident" id="5446941">overflow</span>&nbsp;<span class="op" id="5446950">&lt;&lt;=</span>&nbsp;<span class="num" id="5446954">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5446963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5446967">if</span>&nbsp;<span class="ident" id="5446970">d</span><span class="op" id="5446971">.</span><span class="ident" id="5446972">o</span>&nbsp;<span class="op" id="5446974">&gt;=</span>&nbsp;<span class="ident" id="5446977">flushBuffer</span>&nbsp;<span class="op" id="5446989">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5446994">d</span><span class="op" id="5446995">.</span><span class="ident" id="5446996">flush</span><span class="op" id="5447001">(</span><span class="op" id="5447002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447007">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447019">}</span><br>
<span class="lineno"></span><span class="op" id="5447021">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="5447024">func</span>&nbsp;<span class="op" id="5447029">(</span><span class="ident" id="5447030">d</span>&nbsp;<span class="op" id="5447032">*</span><span class="ident" id="5447033">decoder</span><span class="op" id="5447040">)</span>&nbsp;<span class="ident" id="5447042">flush</span><span class="op" id="5447047">(</span><span class="op" id="5447048">)</span>&nbsp;<span class="op" id="5447050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447053">d</span><span class="op" id="5447054">.</span><span class="ident" id="5447055">toRead</span>&nbsp;<span class="op" id="5447062">=</span>&nbsp;<span class="ident" id="5447064">d</span><span class="op" id="5447065">.</span><span class="ident" id="5447066">output</span><span class="op" id="5447072">[</span><span class="op" id="5447073">:</span><span class="ident" id="5447074">d</span><span class="op" id="5447075">.</span><span class="ident" id="5447076">o</span><span class="op" id="5447077">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447080">d</span><span class="op" id="5447081">.</span><span class="ident" id="5447082">o</span>&nbsp;<span class="op" id="5447084">=</span>&nbsp;<span class="num" id="5447086">0</span><br>
<span class="lineno"></span><span class="op" id="5447088">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="5447091">var</span>&nbsp;<span class="ident" id="5447095">errClosed</span>&nbsp;<span class="op" id="5447105">=</span>&nbsp;<span class="ident" id="5447107">errors</span><span class="op" id="5447113">.</span><span class="ident" id="5447114">New</span><span class="op" id="5447117">(</span><span class="string" id="5447118">&#34;compress/lzw:&nbsp;reader/writer&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5447157">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5447160">func</span>&nbsp;<span class="op" id="5447165">(</span><span class="ident" id="5447166">d</span>&nbsp;<span class="op" id="5447168">*</span><span class="ident" id="5447169">decoder</span><span class="op" id="5447176">)</span>&nbsp;<span class="ident" id="5447178">Close</span><span class="op" id="5447183">(</span><span class="op" id="5447184">)</span>&nbsp;<span class="builtintype" id="5447186">error</span>&nbsp;<span class="op" id="5447192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447195">d</span><span class="op" id="5447196">.</span><span class="ident" id="5447197">err</span>&nbsp;<span class="op" id="5447201">=</span>&nbsp;<span class="ident" id="5447203">errClosed</span>&nbsp;<span class="comment" id="5447213">//&nbsp;in&nbsp;case&nbsp;any&nbsp;Reads&nbsp;come&nbsp;along</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447246">return</span>&nbsp;<span class="ident" id="5447253">nil</span><br>
<span class="lineno"></span><span class="op" id="5447257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5447260">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.ReadCloser.</span><br>
<span class="lineno"></span><span class="comment" id="5447302">//&nbsp;Reads&nbsp;from&nbsp;the&nbsp;returned&nbsp;io.ReadCloser&nbsp;read&nbsp;and&nbsp;decompress&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">225</span><span class="comment" id="5447376">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="5447423">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="5447485">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;ReadCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5447559">//&nbsp;finished&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="5447580">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno">230</span><span class="comment" id="5447653">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="5447688">func</span>&nbsp;<span class="ident" id="5447693">NewReader</span><span class="op" id="5447702">(</span><span class="ident" id="5447703">r</span>&nbsp;<span class="ident" id="5447705">io</span><span class="op" id="5447707">.</span><span class="ident" id="5447708">Reader</span><span class="op" id="5447714">,</span>&nbsp;<span class="ident" id="5447716">order</span>&nbsp;<span class="ident" id="5447722">Order</span><span class="op" id="5447727">,</span>&nbsp;<span class="ident" id="5447729">litWidth</span>&nbsp;<span class="builtintype" id="5447738">int</span><span class="op" id="5447741">)</span>&nbsp;<span class="ident" id="5447743">io</span><span class="op" id="5447745">.</span><span class="ident" id="5447746">ReadCloser</span>&nbsp;<span class="op" id="5447757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447760">d</span>&nbsp;<span class="op" id="5447762">:=</span>&nbsp;<span class="builtinfunc" id="5447765">new</span><span class="op" id="5447768">(</span><span class="ident" id="5447769">decoder</span><span class="op" id="5447776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447779">switch</span>&nbsp;<span class="ident" id="5447786">order</span>&nbsp;<span class="op" id="5447792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447795">case</span>&nbsp;<span class="ident" id="5447800">LSB</span><span class="op" id="5447803">:</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447807">d</span><span class="op" id="5447808">.</span><span class="ident" id="5447809">read</span>&nbsp;<span class="op" id="5447814">=</span>&nbsp;<span class="op" id="5447816">(</span><span class="op" id="5447817">*</span><span class="ident" id="5447818">decoder</span><span class="op" id="5447825">)</span><span class="op" id="5447826">.</span><span class="ident" id="5447827">readLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447836">case</span>&nbsp;<span class="ident" id="5447841">MSB</span><span class="op" id="5447844">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447848">d</span><span class="op" id="5447849">.</span><span class="ident" id="5447850">read</span>&nbsp;<span class="op" id="5447855">=</span>&nbsp;<span class="op" id="5447857">(</span><span class="op" id="5447858">*</span><span class="ident" id="5447859">decoder</span><span class="op" id="5447866">)</span><span class="op" id="5447867">.</span><span class="ident" id="5447868">readMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447877">default</span><span class="op" id="5447884">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447888">d</span><span class="op" id="5447889">.</span><span class="ident" id="5447890">err</span>&nbsp;<span class="op" id="5447894">=</span>&nbsp;<span class="ident" id="5447896">errors</span><span class="op" id="5447902">.</span><span class="ident" id="5447903">New</span><span class="op" id="5447906">(</span><span class="string" id="5447907">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="5447927">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447931">return</span>&nbsp;<span class="ident" id="5447938">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5447941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5447944">if</span>&nbsp;<span class="ident" id="5447947">litWidth</span>&nbsp;<span class="op" id="5447956">&lt;</span>&nbsp;<span class="num" id="5447958">2</span>&nbsp;<span class="op" id="5447960">||</span>&nbsp;<span class="num" id="5447963">8</span>&nbsp;<span class="op" id="5447965">&lt;</span>&nbsp;<span class="ident" id="5447967">litWidth</span>&nbsp;<span class="op" id="5447976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5447980">d</span><span class="op" id="5447981">.</span><span class="ident" id="5447982">err</span>&nbsp;<span class="op" id="5447986">=</span>&nbsp;<span class="ident" id="5447988">fmt</span><span class="op" id="5447991">.</span><span class="ident" id="5447992">Errorf</span><span class="op" id="5447998">(</span><span class="string" id="5447999">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5448030">,</span>&nbsp;<span class="ident" id="5448032">litWidth</span><span class="op" id="5448040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448044">return</span>&nbsp;<span class="ident" id="5448051">d</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448057">if</span>&nbsp;<span class="ident" id="5448060">br</span><span class="op" id="5448062">,</span>&nbsp;<span class="ident" id="5448064">ok</span>&nbsp;<span class="op" id="5448067">:=</span>&nbsp;<span class="ident" id="5448070">r</span><span class="op" id="5448071">.</span><span class="op" id="5448072">(</span><span class="ident" id="5448073">io</span><span class="op" id="5448075">.</span><span class="ident" id="5448076">ByteReader</span><span class="op" id="5448086">)</span><span class="op" id="5448087">;</span>&nbsp;<span class="ident" id="5448089">ok</span>&nbsp;<span class="op" id="5448092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448096">d</span><span class="op" id="5448097">.</span><span class="ident" id="5448098">r</span>&nbsp;<span class="op" id="5448100">=</span>&nbsp;<span class="ident" id="5448102">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448106">}</span>&nbsp;<span class="keyword" id="5448108">else</span>&nbsp;<span class="op" id="5448113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448117">d</span><span class="op" id="5448118">.</span><span class="ident" id="5448119">r</span>&nbsp;<span class="op" id="5448121">=</span>&nbsp;<span class="ident" id="5448123">bufio</span><span class="op" id="5448128">.</span><span class="ident" id="5448129">NewReader</span><span class="op" id="5448138">(</span><span class="ident" id="5448139">r</span><span class="op" id="5448140">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5448143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448146">d</span><span class="op" id="5448147">.</span><span class="ident" id="5448148">litWidth</span>&nbsp;<span class="op" id="5448157">=</span>&nbsp;<span class="ident" id="5448159">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448169">d</span><span class="op" id="5448170">.</span><span class="ident" id="5448171">width</span>&nbsp;<span class="op" id="5448177">=</span>&nbsp;<span class="num" id="5448179">1</span>&nbsp;<span class="op" id="5448181">+</span>&nbsp;<span class="builtintype" id="5448183">uint</span><span class="op" id="5448187">(</span><span class="ident" id="5448188">litWidth</span><span class="op" id="5448196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448199">d</span><span class="op" id="5448200">.</span><span class="ident" id="5448201">clear</span>&nbsp;<span class="op" id="5448207">=</span>&nbsp;<span class="builtintype" id="5448209">uint16</span><span class="op" id="5448215">(</span><span class="num" id="5448216">1</span><span class="op" id="5448217">)</span>&nbsp;<span class="op" id="5448219">&lt;&lt;</span>&nbsp;<span class="builtintype" id="5448222">uint</span><span class="op" id="5448226">(</span><span class="ident" id="5448227">litWidth</span><span class="op" id="5448235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448238">d</span><span class="op" id="5448239">.</span><span class="ident" id="5448240">eof</span><span class="op" id="5448243">,</span>&nbsp;<span class="ident" id="5448245">d</span><span class="op" id="5448246">.</span><span class="ident" id="5448247">hi</span>&nbsp;<span class="op" id="5448250">=</span>&nbsp;<span class="ident" id="5448252">d</span><span class="op" id="5448253">.</span><span class="ident" id="5448254">clear</span><span class="op" id="5448259">+</span><span class="num" id="5448260">1</span><span class="op" id="5448261">,</span>&nbsp;<span class="ident" id="5448263">d</span><span class="op" id="5448264">.</span><span class="ident" id="5448265">clear</span><span class="op" id="5448270">+</span><span class="num" id="5448271">1</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448274">d</span><span class="op" id="5448275">.</span><span class="ident" id="5448276">overflow</span>&nbsp;<span class="op" id="5448285">=</span>&nbsp;<span class="builtintype" id="5448287">uint16</span><span class="op" id="5448293">(</span><span class="num" id="5448294">1</span><span class="op" id="5448295">)</span>&nbsp;<span class="op" id="5448297">&lt;&lt;</span>&nbsp;<span class="ident" id="5448300">d</span><span class="op" id="5448301">.</span><span class="ident" id="5448302">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5448309">d</span><span class="op" id="5448310">.</span><span class="ident" id="5448311">last</span>&nbsp;<span class="op" id="5448316">=</span>&nbsp;<span class="ident" id="5448318">decoderInvalidCode</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5448339">return</span>&nbsp;<span class="ident" id="5448346">d</span><br>
<span class="lineno"></span><span class="op" id="5448348">}</span>
</div>
</body>
</html>
