<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3825929">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3825984">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3826038">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3826088">//</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="3826092">/*<br>
<span class="lineno"></span>Package&nbsp;multipart&nbsp;implements&nbsp;MIME&nbsp;multipart&nbsp;parsing,&nbsp;as&nbsp;defined&nbsp;in&nbsp;RFC<br>
<span class="lineno"></span>2046.<br>
<span class="lineno"></span><br>
<span class="lineno">10</span>The&nbsp;implementation&nbsp;is&nbsp;sufficient&nbsp;for&nbsp;HTTP&nbsp;(RFC&nbsp;2388)&nbsp;and&nbsp;the&nbsp;multipart<br>
<span class="lineno"></span>bodies&nbsp;generated&nbsp;by&nbsp;popular&nbsp;browsers.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="3826285">package</span>&nbsp;<span class="ident" id="3826293">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="3826304">import</span>&nbsp;<span class="op" id="3826311">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3826314">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3826323">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3826332">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3826339">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3826345">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3826358">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3826366">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span><span class="op" id="3826382">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="3826385">var</span>&nbsp;<span class="ident" id="3826389">emptyParams</span>&nbsp;<span class="op" id="3826401">=</span>&nbsp;<span class="builtinfunc" id="3826403">make</span><span class="op" id="3826407">(</span><span class="keyword" id="3826408">map</span><span class="op" id="3826411">[</span><span class="builtintype" id="3826412">string</span><span class="op" id="3826418">]</span><span class="builtintype" id="3826419">string</span><span class="op" id="3826425">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3826428">//&nbsp;A&nbsp;Part&nbsp;represents&nbsp;a&nbsp;single&nbsp;part&nbsp;in&nbsp;a&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="3826484">type</span>&nbsp;<span class="ident" id="3826489">Part</span>&nbsp;<span class="keyword" id="3826494">struct</span>&nbsp;<span class="op" id="3826501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826504">//&nbsp;The&nbsp;headers&nbsp;of&nbsp;the&nbsp;body,&nbsp;if&nbsp;any,&nbsp;with&nbsp;the&nbsp;keys&nbsp;canonicalized</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826569">//&nbsp;in&nbsp;the&nbsp;same&nbsp;fashion&nbsp;that&nbsp;the&nbsp;Go&nbsp;http.Request&nbsp;headers&nbsp;are.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826631">//&nbsp;For&nbsp;example,&nbsp;&#34;foo-bar&#34;&nbsp;changes&nbsp;case&nbsp;to&nbsp;&#34;Foo-Bar&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826684">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826688">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;the&nbsp;&#34;Content-Transfer-Encoding&#34;&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826753">//&nbsp;has&nbsp;a&nbsp;value&nbsp;of&nbsp;&#34;quoted-printable&#34;,&nbsp;that&nbsp;header&nbsp;is&nbsp;instead</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826815">//&nbsp;hidden&nbsp;from&nbsp;this&nbsp;map&nbsp;and&nbsp;the&nbsp;body&nbsp;is&nbsp;transparently&nbsp;decoded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826878">//&nbsp;during&nbsp;Read&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826901">Header</span>&nbsp;<span class="ident" id="3826908">textproto</span><span class="op" id="3826917">.</span><span class="ident" id="3826918">MIMEHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826931">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3826941">*</span><span class="ident" id="3826942">bytes</span><span class="op" id="3826947">.</span><span class="ident" id="3826948">Buffer</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826956">mr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3826966">*</span><span class="ident" id="3826967">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826975">bytesRead</span>&nbsp;<span class="builtintype" id="3826985">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826991">disposition</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3827009">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827017">dispositionParams</span>&nbsp;<span class="keyword" id="3827035">map</span><span class="op" id="3827038">[</span><span class="builtintype" id="3827039">string</span><span class="op" id="3827045">]</span><span class="builtintype" id="3827046">string</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827055">//&nbsp;r&nbsp;is&nbsp;either&nbsp;a&nbsp;reader&nbsp;directly&nbsp;reading&nbsp;from&nbsp;mr,&nbsp;or&nbsp;it&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827116">//&nbsp;wrapper&nbsp;around&nbsp;such&nbsp;a&nbsp;reader,&nbsp;decoding&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827163">//&nbsp;Content-Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827193">r</span>&nbsp;<span class="ident" id="3827195">io</span><span class="op" id="3827197">.</span><span class="ident" id="3827198">Reader</span><br>
<span class="lineno">50</span><span class="op" id="3827205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3827208">//&nbsp;FormName&nbsp;returns&nbsp;the&nbsp;name&nbsp;parameter&nbsp;if&nbsp;p&nbsp;has&nbsp;a&nbsp;Content-Disposition</span><br>
<span class="lineno"></span><span class="comment" id="3827278">//&nbsp;of&nbsp;type&nbsp;&#34;form-data&#34;.&nbsp;&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3827342">func</span>&nbsp;<span class="op" id="3827347">(</span><span class="ident" id="3827348">p</span>&nbsp;<span class="op" id="3827350">*</span><span class="ident" id="3827351">Part</span><span class="op" id="3827355">)</span>&nbsp;<span class="ident" id="3827357">FormName</span><span class="op" id="3827365">(</span><span class="op" id="3827366">)</span>&nbsp;<span class="builtintype" id="3827368">string</span>&nbsp;<span class="op" id="3827375">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827378">//&nbsp;See&nbsp;http://tools.ietf.org/html/rfc2183&nbsp;section&nbsp;2&nbsp;for&nbsp;EBNF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827440">//&nbsp;of&nbsp;Content-Disposition&nbsp;value&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827481">if</span>&nbsp;<span class="ident" id="3827484">p</span><span class="op" id="3827485">.</span><span class="ident" id="3827486">dispositionParams</span>&nbsp;<span class="op" id="3827504">==</span>&nbsp;<span class="ident" id="3827507">nil</span>&nbsp;<span class="op" id="3827511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827515">p</span><span class="op" id="3827516">.</span><span class="ident" id="3827517">parseContentDisposition</span><span class="op" id="3827540">(</span><span class="op" id="3827541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3827544">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827547">if</span>&nbsp;<span class="ident" id="3827550">p</span><span class="op" id="3827551">.</span><span class="ident" id="3827552">disposition</span>&nbsp;<span class="op" id="3827564">!=</span>&nbsp;<span class="string" id="3827567">&#34;form-data&#34;</span>&nbsp;<span class="op" id="3827579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827583">return</span>&nbsp;<span class="string" id="3827590">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3827594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827597">return</span>&nbsp;<span class="ident" id="3827604">p</span><span class="op" id="3827605">.</span><span class="ident" id="3827606">dispositionParams</span><span class="op" id="3827623">[</span><span class="string" id="3827624">&#34;name&#34;</span><span class="op" id="3827630">]</span><br>
<span class="lineno"></span><span class="op" id="3827632">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="3827635">//&nbsp;FileName&nbsp;returns&nbsp;the&nbsp;filename&nbsp;parameter&nbsp;of&nbsp;the&nbsp;Part&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3827692">//&nbsp;Content-Disposition&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="3827723">func</span>&nbsp;<span class="op" id="3827728">(</span><span class="ident" id="3827729">p</span>&nbsp;<span class="op" id="3827731">*</span><span class="ident" id="3827732">Part</span><span class="op" id="3827736">)</span>&nbsp;<span class="ident" id="3827738">FileName</span><span class="op" id="3827746">(</span><span class="op" id="3827747">)</span>&nbsp;<span class="builtintype" id="3827749">string</span>&nbsp;<span class="op" id="3827756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827759">if</span>&nbsp;<span class="ident" id="3827762">p</span><span class="op" id="3827763">.</span><span class="ident" id="3827764">dispositionParams</span>&nbsp;<span class="op" id="3827782">==</span>&nbsp;<span class="ident" id="3827785">nil</span>&nbsp;<span class="op" id="3827789">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827793">p</span><span class="op" id="3827794">.</span><span class="ident" id="3827795">parseContentDisposition</span><span class="op" id="3827818">(</span><span class="op" id="3827819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3827822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827825">return</span>&nbsp;<span class="ident" id="3827832">p</span><span class="op" id="3827833">.</span><span class="ident" id="3827834">dispositionParams</span><span class="op" id="3827851">[</span><span class="string" id="3827852">&#34;filename&#34;</span><span class="op" id="3827862">]</span><br>
<span class="lineno"></span><span class="op" id="3827864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="3827867">func</span>&nbsp;<span class="op" id="3827872">(</span><span class="ident" id="3827873">p</span>&nbsp;<span class="op" id="3827875">*</span><span class="ident" id="3827876">Part</span><span class="op" id="3827880">)</span>&nbsp;<span class="ident" id="3827882">parseContentDisposition</span><span class="op" id="3827905">(</span><span class="op" id="3827906">)</span>&nbsp;<span class="op" id="3827908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827911">v</span>&nbsp;<span class="op" id="3827913">:=</span>&nbsp;<span class="ident" id="3827916">p</span><span class="op" id="3827917">.</span><span class="ident" id="3827918">Header</span><span class="op" id="3827924">.</span><span class="ident" id="3827925">Get</span><span class="op" id="3827928">(</span><span class="string" id="3827929">&#34;Content-Disposition&#34;</span><span class="op" id="3827950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827953">var</span>&nbsp;<span class="ident" id="3827957">err</span>&nbsp;<span class="builtintype" id="3827961">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827968">p</span><span class="op" id="3827969">.</span><span class="ident" id="3827970">disposition</span><span class="op" id="3827981">,</span>&nbsp;<span class="ident" id="3827983">p</span><span class="op" id="3827984">.</span><span class="ident" id="3827985">dispositionParams</span><span class="op" id="3828002">,</span>&nbsp;<span class="ident" id="3828004">err</span>&nbsp;<span class="op" id="3828008">=</span>&nbsp;<span class="ident" id="3828010">mime</span><span class="op" id="3828014">.</span><span class="ident" id="3828015">ParseMediaType</span><span class="op" id="3828029">(</span><span class="ident" id="3828030">v</span><span class="op" id="3828031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828034">if</span>&nbsp;<span class="ident" id="3828037">err</span>&nbsp;<span class="op" id="3828041">!=</span>&nbsp;<span class="ident" id="3828044">nil</span>&nbsp;<span class="op" id="3828048">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828052">p</span><span class="op" id="3828053">.</span><span class="ident" id="3828054">dispositionParams</span>&nbsp;<span class="op" id="3828072">=</span>&nbsp;<span class="ident" id="3828074">emptyParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828087">}</span><br>
<span class="lineno"></span><span class="op" id="3828089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3828092">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Reader&nbsp;reading&nbsp;from&nbsp;r&nbsp;using&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="3828161">//&nbsp;given&nbsp;MIME&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="comment" id="3828185">//</span><br>
<span class="lineno"></span><span class="comment" id="3828188">//&nbsp;The&nbsp;boundary&nbsp;is&nbsp;usually&nbsp;obtained&nbsp;from&nbsp;the&nbsp;&#34;boundary&#34;&nbsp;parameter&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3828257">//&nbsp;the&nbsp;message&#39;s&nbsp;&#34;Content-Type&#34;&nbsp;header.&nbsp;Use&nbsp;mime.ParseMediaType&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3828324">//&nbsp;parse&nbsp;such&nbsp;headers.</span><br>
<span class="lineno">90</span><span class="keyword" id="3828347">func</span>&nbsp;<span class="ident" id="3828352">NewReader</span><span class="op" id="3828361">(</span><span class="ident" id="3828362">r</span>&nbsp;<span class="ident" id="3828364">io</span><span class="op" id="3828366">.</span><span class="ident" id="3828367">Reader</span><span class="op" id="3828373">,</span>&nbsp;<span class="ident" id="3828375">boundary</span>&nbsp;<span class="builtintype" id="3828384">string</span><span class="op" id="3828390">)</span>&nbsp;<span class="op" id="3828392">*</span><span class="ident" id="3828393">Reader</span>&nbsp;<span class="op" id="3828400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828403">b</span>&nbsp;<span class="op" id="3828405">:=</span>&nbsp;<span class="op" id="3828408">[</span><span class="op" id="3828409">]</span><span class="builtintype" id="3828410">byte</span><span class="op" id="3828414">(</span><span class="string" id="3828415">&#34;\r\n--&#34;</span>&nbsp;<span class="op" id="3828424">+</span>&nbsp;<span class="ident" id="3828426">boundary</span>&nbsp;<span class="op" id="3828435">+</span>&nbsp;<span class="string" id="3828437">&#34;--&#34;</span><span class="op" id="3828441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828444">return</span>&nbsp;<span class="op" id="3828451">&amp;</span><span class="ident" id="3828452">Reader</span><span class="op" id="3828458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828462">bufReader</span><span class="op" id="3828471">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828480">bufio</span><span class="op" id="3828485">.</span><span class="ident" id="3828486">NewReader</span><span class="op" id="3828495">(</span><span class="ident" id="3828496">r</span><span class="op" id="3828497">)</span><span class="op" id="3828498">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828502">nl</span><span class="op" id="3828504">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828520">b</span><span class="op" id="3828521">[</span><span class="op" id="3828522">:</span><span class="num" id="3828523">2</span><span class="op" id="3828524">]</span><span class="op" id="3828525">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828529">nlDashBoundary</span><span class="op" id="3828543">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3828547">b</span><span class="op" id="3828548">[</span><span class="op" id="3828549">:</span><span class="builtinfunc" id="3828550">len</span><span class="op" id="3828553">(</span><span class="ident" id="3828554">b</span><span class="op" id="3828555">)</span><span class="op" id="3828556">-</span><span class="num" id="3828557">2</span><span class="op" id="3828558">]</span><span class="op" id="3828559">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828563">dashBoundaryDash</span><span class="op" id="3828579">:</span>&nbsp;<span class="ident" id="3828581">b</span><span class="op" id="3828582">[</span><span class="num" id="3828583">2</span><span class="op" id="3828584">:</span><span class="op" id="3828585">]</span><span class="op" id="3828586">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828590">dashBoundary</span><span class="op" id="3828602">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828608">b</span><span class="op" id="3828609">[</span><span class="num" id="3828610">2</span>&nbsp;<span class="op" id="3828612">:</span>&nbsp;<span class="builtinfunc" id="3828614">len</span><span class="op" id="3828617">(</span><span class="ident" id="3828618">b</span><span class="op" id="3828619">)</span><span class="op" id="3828620">-</span><span class="num" id="3828621">2</span><span class="op" id="3828622">]</span><span class="op" id="3828623">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828626">}</span><br>
<span class="lineno"></span><span class="op" id="3828628">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3828631">func</span>&nbsp;<span class="ident" id="3828636">newPart</span><span class="op" id="3828643">(</span><span class="ident" id="3828644">mr</span>&nbsp;<span class="op" id="3828647">*</span><span class="ident" id="3828648">Reader</span><span class="op" id="3828654">)</span>&nbsp;<span class="op" id="3828656">(</span><span class="op" id="3828657">*</span><span class="ident" id="3828658">Part</span><span class="op" id="3828662">,</span>&nbsp;<span class="builtintype" id="3828664">error</span><span class="op" id="3828669">)</span>&nbsp;<span class="op" id="3828671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828674">bp</span>&nbsp;<span class="op" id="3828677">:=</span>&nbsp;<span class="op" id="3828680">&amp;</span><span class="ident" id="3828681">Part</span><span class="op" id="3828685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828689">Header</span><span class="op" id="3828695">:</span>&nbsp;<span class="builtinfunc" id="3828697">make</span><span class="op" id="3828701">(</span><span class="keyword" id="3828702">map</span><span class="op" id="3828705">[</span><span class="builtintype" id="3828706">string</span><span class="op" id="3828712">]</span><span class="op" id="3828713">[</span><span class="op" id="3828714">]</span><span class="builtintype" id="3828715">string</span><span class="op" id="3828721">)</span><span class="op" id="3828722">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828726">mr</span><span class="op" id="3828728">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828734">mr</span><span class="op" id="3828736">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828740">buffer</span><span class="op" id="3828746">:</span>&nbsp;<span class="builtinfunc" id="3828748">new</span><span class="op" id="3828751">(</span><span class="ident" id="3828752">bytes</span><span class="op" id="3828757">.</span><span class="ident" id="3828758">Buffer</span><span class="op" id="3828764">)</span><span class="op" id="3828765">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828771">if</span>&nbsp;<span class="ident" id="3828774">err</span>&nbsp;<span class="op" id="3828778">:=</span>&nbsp;<span class="ident" id="3828781">bp</span><span class="op" id="3828783">.</span><span class="ident" id="3828784">populateHeaders</span><span class="op" id="3828799">(</span><span class="op" id="3828800">)</span><span class="op" id="3828801">;</span>&nbsp;<span class="ident" id="3828803">err</span>&nbsp;<span class="op" id="3828807">!=</span>&nbsp;<span class="ident" id="3828810">nil</span>&nbsp;<span class="op" id="3828814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828818">return</span>&nbsp;<span class="ident" id="3828825">nil</span><span class="op" id="3828828">,</span>&nbsp;<span class="ident" id="3828830">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828835">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828838">bp</span><span class="op" id="3828840">.</span><span class="ident" id="3828841">r</span>&nbsp;<span class="op" id="3828843">=</span>&nbsp;<span class="ident" id="3828845">partReader</span><span class="op" id="3828855">{</span><span class="ident" id="3828856">bp</span><span class="op" id="3828858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828861">const</span>&nbsp;<span class="ident" id="3828867">cte</span>&nbsp;<span class="op" id="3828871">=</span>&nbsp;<span class="string" id="3828873">&#34;Content-Transfer-Encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828902">if</span>&nbsp;<span class="ident" id="3828905">bp</span><span class="op" id="3828907">.</span><span class="ident" id="3828908">Header</span><span class="op" id="3828914">.</span><span class="ident" id="3828915">Get</span><span class="op" id="3828918">(</span><span class="ident" id="3828919">cte</span><span class="op" id="3828922">)</span>&nbsp;<span class="op" id="3828924">==</span>&nbsp;<span class="string" id="3828927">&#34;quoted-printable&#34;</span>&nbsp;<span class="op" id="3828946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828950">bp</span><span class="op" id="3828952">.</span><span class="ident" id="3828953">Header</span><span class="op" id="3828959">.</span><span class="ident" id="3828960">Del</span><span class="op" id="3828963">(</span><span class="ident" id="3828964">cte</span><span class="op" id="3828967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828971">bp</span><span class="op" id="3828973">.</span><span class="ident" id="3828974">r</span>&nbsp;<span class="op" id="3828976">=</span>&nbsp;<span class="ident" id="3828978">newQuotedPrintableReader</span><span class="op" id="3829002">(</span><span class="ident" id="3829003">bp</span><span class="op" id="3829005">.</span><span class="ident" id="3829006">r</span><span class="op" id="3829007">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829013">return</span>&nbsp;<span class="ident" id="3829020">bp</span><span class="op" id="3829022">,</span>&nbsp;<span class="ident" id="3829024">nil</span><br>
<span class="lineno"></span><span class="op" id="3829028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3829031">func</span>&nbsp;<span class="op" id="3829036">(</span><span class="ident" id="3829037">bp</span>&nbsp;<span class="op" id="3829040">*</span><span class="ident" id="3829041">Part</span><span class="op" id="3829045">)</span>&nbsp;<span class="ident" id="3829047">populateHeaders</span><span class="op" id="3829062">(</span><span class="op" id="3829063">)</span>&nbsp;<span class="builtintype" id="3829065">error</span>&nbsp;<span class="op" id="3829071">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829074">r</span>&nbsp;<span class="op" id="3829076">:=</span>&nbsp;<span class="ident" id="3829079">textproto</span><span class="op" id="3829088">.</span><span class="ident" id="3829089">NewReader</span><span class="op" id="3829098">(</span><span class="ident" id="3829099">bp</span><span class="op" id="3829101">.</span><span class="ident" id="3829102">mr</span><span class="op" id="3829104">.</span><span class="ident" id="3829105">bufReader</span><span class="op" id="3829114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829117">header</span><span class="op" id="3829123">,</span>&nbsp;<span class="ident" id="3829125">err</span>&nbsp;<span class="op" id="3829129">:=</span>&nbsp;<span class="ident" id="3829132">r</span><span class="op" id="3829133">.</span><span class="ident" id="3829134">ReadMIMEHeader</span><span class="op" id="3829148">(</span><span class="op" id="3829149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829152">if</span>&nbsp;<span class="ident" id="3829155">err</span>&nbsp;<span class="op" id="3829159">==</span>&nbsp;<span class="ident" id="3829162">nil</span>&nbsp;<span class="op" id="3829166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829170">bp</span><span class="op" id="3829172">.</span><span class="ident" id="3829173">Header</span>&nbsp;<span class="op" id="3829180">=</span>&nbsp;<span class="ident" id="3829182">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829190">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829193">return</span>&nbsp;<span class="ident" id="3829200">err</span><br>
<span class="lineno"></span><span class="op" id="3829204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3829207">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;body&nbsp;of&nbsp;a&nbsp;part,&nbsp;after&nbsp;its&nbsp;headers&nbsp;and&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3829274">//&nbsp;next&nbsp;part&nbsp;(if&nbsp;any)&nbsp;begins.</span><br>
<span class="lineno">130</span><span class="keyword" id="3829304">func</span>&nbsp;<span class="op" id="3829309">(</span><span class="ident" id="3829310">p</span>&nbsp;<span class="op" id="3829312">*</span><span class="ident" id="3829313">Part</span><span class="op" id="3829317">)</span>&nbsp;<span class="ident" id="3829319">Read</span><span class="op" id="3829323">(</span><span class="ident" id="3829324">d</span>&nbsp;<span class="op" id="3829326">[</span><span class="op" id="3829327">]</span><span class="builtintype" id="3829328">byte</span><span class="op" id="3829332">)</span>&nbsp;<span class="op" id="3829334">(</span><span class="ident" id="3829335">n</span>&nbsp;<span class="builtintype" id="3829337">int</span><span class="op" id="3829340">,</span>&nbsp;<span class="ident" id="3829342">err</span>&nbsp;<span class="builtintype" id="3829346">error</span><span class="op" id="3829351">)</span>&nbsp;<span class="op" id="3829353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829356">return</span>&nbsp;<span class="ident" id="3829363">p</span><span class="op" id="3829364">.</span><span class="ident" id="3829365">r</span><span class="op" id="3829366">.</span><span class="ident" id="3829367">Read</span><span class="op" id="3829371">(</span><span class="ident" id="3829372">d</span><span class="op" id="3829373">)</span><br>
<span class="lineno"></span><span class="op" id="3829375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3829378">//&nbsp;partReader&nbsp;implements&nbsp;io.Reader&nbsp;by&nbsp;reading&nbsp;raw&nbsp;bytes&nbsp;directly&nbsp;from&nbsp;the</span><br>
<span class="lineno">135</span><span class="comment" id="3829452">//&nbsp;wrapped&nbsp;*Part,&nbsp;without&nbsp;doing&nbsp;any&nbsp;Transfer-Encoding&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3829516">type</span>&nbsp;<span class="ident" id="3829521">partReader</span>&nbsp;<span class="keyword" id="3829532">struct</span>&nbsp;<span class="op" id="3829539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829542">p</span>&nbsp;<span class="op" id="3829544">*</span><span class="ident" id="3829545">Part</span><br>
<span class="lineno"></span><span class="op" id="3829550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3829553">func</span>&nbsp;<span class="op" id="3829558">(</span><span class="ident" id="3829559">pr</span>&nbsp;<span class="ident" id="3829562">partReader</span><span class="op" id="3829572">)</span>&nbsp;<span class="ident" id="3829574">Read</span><span class="op" id="3829578">(</span><span class="ident" id="3829579">d</span>&nbsp;<span class="op" id="3829581">[</span><span class="op" id="3829582">]</span><span class="builtintype" id="3829583">byte</span><span class="op" id="3829587">)</span>&nbsp;<span class="op" id="3829589">(</span><span class="ident" id="3829590">n</span>&nbsp;<span class="builtintype" id="3829592">int</span><span class="op" id="3829595">,</span>&nbsp;<span class="ident" id="3829597">err</span>&nbsp;<span class="builtintype" id="3829601">error</span><span class="op" id="3829606">)</span>&nbsp;<span class="op" id="3829608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829611">p</span>&nbsp;<span class="op" id="3829613">:=</span>&nbsp;<span class="ident" id="3829616">pr</span><span class="op" id="3829618">.</span><span class="ident" id="3829619">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829622">defer</span>&nbsp;<span class="keyword" id="3829628">func</span><span class="op" id="3829632">(</span><span class="op" id="3829633">)</span>&nbsp;<span class="op" id="3829635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829639">p</span><span class="op" id="3829640">.</span><span class="ident" id="3829641">bytesRead</span>&nbsp;<span class="op" id="3829651">+=</span>&nbsp;<span class="ident" id="3829654">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829657">}</span><span class="op" id="3829658">(</span><span class="op" id="3829659">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829662">if</span>&nbsp;<span class="ident" id="3829665">p</span><span class="op" id="3829666">.</span><span class="ident" id="3829667">buffer</span><span class="op" id="3829673">.</span><span class="ident" id="3829674">Len</span><span class="op" id="3829677">(</span><span class="op" id="3829678">)</span>&nbsp;<span class="op" id="3829680">&gt;=</span>&nbsp;<span class="builtinfunc" id="3829683">len</span><span class="op" id="3829686">(</span><span class="ident" id="3829687">d</span><span class="op" id="3829688">)</span>&nbsp;<span class="op" id="3829690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3829694">//&nbsp;Internal&nbsp;buffer&nbsp;of&nbsp;unconsumed&nbsp;data&nbsp;is&nbsp;large&nbsp;enough&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3829754">//&nbsp;the&nbsp;read&nbsp;request.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;parse&nbsp;more&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829815">return</span>&nbsp;<span class="ident" id="3829822">p</span><span class="op" id="3829823">.</span><span class="ident" id="3829824">buffer</span><span class="op" id="3829830">.</span><span class="ident" id="3829831">Read</span><span class="op" id="3829835">(</span><span class="ident" id="3829836">d</span><span class="op" id="3829837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829840">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829843">peek</span><span class="op" id="3829847">,</span>&nbsp;<span class="ident" id="3829849">err</span>&nbsp;<span class="op" id="3829853">:=</span>&nbsp;<span class="ident" id="3829856">p</span><span class="op" id="3829857">.</span><span class="ident" id="3829858">mr</span><span class="op" id="3829860">.</span><span class="ident" id="3829861">bufReader</span><span class="op" id="3829870">.</span><span class="ident" id="3829871">Peek</span><span class="op" id="3829875">(</span><span class="num" id="3829876">4096</span><span class="op" id="3829880">)</span>&nbsp;<span class="comment" id="3829882">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;buffer&nbsp;size&nbsp;accessor</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3829928">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;immediate&nbsp;empty&nbsp;part&nbsp;without&nbsp;a&nbsp;leading&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3829988">//&nbsp;before&nbsp;the&nbsp;boundary&nbsp;separator.&nbsp;&nbsp;Some&nbsp;MIME&nbsp;code&nbsp;makes&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3830051">//&nbsp;parts&nbsp;like&nbsp;this.&nbsp;Most&nbsp;browsers,&nbsp;however,&nbsp;write&nbsp;the&nbsp;\r\n</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3830111">//&nbsp;before&nbsp;the&nbsp;subsequent&nbsp;boundary&nbsp;even&nbsp;for&nbsp;empty&nbsp;parts&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3830171">//&nbsp;won&#39;t&nbsp;hit&nbsp;this&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830196">if</span>&nbsp;<span class="ident" id="3830199">p</span><span class="op" id="3830200">.</span><span class="ident" id="3830201">bytesRead</span>&nbsp;<span class="op" id="3830211">==</span>&nbsp;<span class="num" id="3830214">0</span>&nbsp;<span class="op" id="3830216">&amp;&amp;</span>&nbsp;<span class="ident" id="3830219">p</span><span class="op" id="3830220">.</span><span class="ident" id="3830221">mr</span><span class="op" id="3830223">.</span><span class="ident" id="3830224">peekBufferIsEmptyPart</span><span class="op" id="3830245">(</span><span class="ident" id="3830246">peek</span><span class="op" id="3830250">)</span>&nbsp;<span class="op" id="3830252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830256">return</span>&nbsp;<span class="num" id="3830263">0</span><span class="op" id="3830264">,</span>&nbsp;<span class="ident" id="3830266">io</span><span class="op" id="3830268">.</span><span class="ident" id="3830269">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3830274">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830277">unexpectedEOF</span>&nbsp;<span class="op" id="3830291">:=</span>&nbsp;<span class="ident" id="3830294">err</span>&nbsp;<span class="op" id="3830298">==</span>&nbsp;<span class="ident" id="3830301">io</span><span class="op" id="3830303">.</span><span class="ident" id="3830304">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830309">if</span>&nbsp;<span class="ident" id="3830312">err</span>&nbsp;<span class="op" id="3830316">!=</span>&nbsp;<span class="ident" id="3830319">nil</span>&nbsp;<span class="op" id="3830323">&amp;&amp;</span>&nbsp;<span class="op" id="3830326">!</span><span class="ident" id="3830327">unexpectedEOF</span>&nbsp;<span class="op" id="3830341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830345">return</span>&nbsp;<span class="num" id="3830352">0</span><span class="op" id="3830353">,</span>&nbsp;<span class="ident" id="3830355">fmt</span><span class="op" id="3830358">.</span><span class="ident" id="3830359">Errorf</span><span class="op" id="3830365">(</span><span class="string" id="3830366">&#34;multipart:&nbsp;Part&nbsp;Read:&nbsp;%v&#34;</span><span class="op" id="3830392">,</span>&nbsp;<span class="ident" id="3830394">err</span><span class="op" id="3830397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3830400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830403">if</span>&nbsp;<span class="ident" id="3830406">peek</span>&nbsp;<span class="op" id="3830411">==</span>&nbsp;<span class="ident" id="3830414">nil</span>&nbsp;<span class="op" id="3830418">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3830422">panic</span><span class="op" id="3830427">(</span><span class="string" id="3830428">&#34;nil&nbsp;peek&nbsp;buf&#34;</span><span class="op" id="3830442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3830445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3830449">//&nbsp;Search&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;for&nbsp;&#34;\r\n--boundary&#34;.&nbsp;If&nbsp;found,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3830508">//&nbsp;consume&nbsp;everything&nbsp;up&nbsp;to&nbsp;the&nbsp;boundary.&nbsp;If&nbsp;not,&nbsp;consume&nbsp;only</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3830572">//&nbsp;as&nbsp;much&nbsp;of&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;as&nbsp;cannot&nbsp;hold&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3830631">//&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830643">nCopy</span>&nbsp;<span class="op" id="3830649">:=</span>&nbsp;<span class="num" id="3830652">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830655">foundBoundary</span>&nbsp;<span class="op" id="3830669">:=</span>&nbsp;<span class="builtintype" id="3830672">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830679">if</span>&nbsp;<span class="ident" id="3830682">idx</span>&nbsp;<span class="op" id="3830686">:=</span>&nbsp;<span class="ident" id="3830689">bytes</span><span class="op" id="3830694">.</span><span class="ident" id="3830695">Index</span><span class="op" id="3830700">(</span><span class="ident" id="3830701">peek</span><span class="op" id="3830705">,</span>&nbsp;<span class="ident" id="3830707">p</span><span class="op" id="3830708">.</span><span class="ident" id="3830709">mr</span><span class="op" id="3830711">.</span><span class="ident" id="3830712">nlDashBoundary</span><span class="op" id="3830726">)</span><span class="op" id="3830727">;</span>&nbsp;<span class="ident" id="3830729">idx</span>&nbsp;<span class="op" id="3830733">!=</span>&nbsp;<span class="op" id="3830736">-</span><span class="num" id="3830737">1</span>&nbsp;<span class="op" id="3830739">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830743">nCopy</span>&nbsp;<span class="op" id="3830749">=</span>&nbsp;<span class="ident" id="3830751">idx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830757">foundBoundary</span>&nbsp;<span class="op" id="3830771">=</span>&nbsp;<span class="builtintype" id="3830773">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3830779">}</span>&nbsp;<span class="keyword" id="3830781">else</span>&nbsp;<span class="keyword" id="3830786">if</span>&nbsp;<span class="ident" id="3830789">safeCount</span>&nbsp;<span class="op" id="3830799">:=</span>&nbsp;<span class="builtinfunc" id="3830802">len</span><span class="op" id="3830805">(</span><span class="ident" id="3830806">peek</span><span class="op" id="3830810">)</span>&nbsp;<span class="op" id="3830812">-</span>&nbsp;<span class="builtinfunc" id="3830814">len</span><span class="op" id="3830817">(</span><span class="ident" id="3830818">p</span><span class="op" id="3830819">.</span><span class="ident" id="3830820">mr</span><span class="op" id="3830822">.</span><span class="ident" id="3830823">nlDashBoundary</span><span class="op" id="3830837">)</span><span class="op" id="3830838">;</span>&nbsp;<span class="ident" id="3830840">safeCount</span>&nbsp;<span class="op" id="3830850">&gt;</span>&nbsp;<span class="num" id="3830852">0</span>&nbsp;<span class="op" id="3830854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830858">nCopy</span>&nbsp;<span class="op" id="3830864">=</span>&nbsp;<span class="ident" id="3830866">safeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3830877">}</span>&nbsp;<span class="keyword" id="3830879">else</span>&nbsp;<span class="keyword" id="3830884">if</span>&nbsp;<span class="ident" id="3830887">unexpectedEOF</span>&nbsp;<span class="op" id="3830901">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3830905">//&nbsp;If&nbsp;we&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;peek&nbsp;buffer&nbsp;and&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3830959">//&nbsp;wasn&#39;t&nbsp;found&nbsp;(and&nbsp;can&#39;t&nbsp;possibly&nbsp;fit),&nbsp;we&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3831016">//&nbsp;hit&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file&nbsp;unexpectedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831059">return</span>&nbsp;<span class="num" id="3831066">0</span><span class="op" id="3831067">,</span>&nbsp;<span class="ident" id="3831069">io</span><span class="op" id="3831071">.</span><span class="ident" id="3831072">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3831090">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831093">if</span>&nbsp;<span class="ident" id="3831096">nCopy</span>&nbsp;<span class="op" id="3831102">&gt;</span>&nbsp;<span class="num" id="3831104">0</span>&nbsp;<span class="op" id="3831106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831110">if</span>&nbsp;<span class="ident" id="3831113">_</span><span class="op" id="3831114">,</span>&nbsp;<span class="ident" id="3831116">err</span>&nbsp;<span class="op" id="3831120">:=</span>&nbsp;<span class="ident" id="3831123">io</span><span class="op" id="3831125">.</span><span class="ident" id="3831126">CopyN</span><span class="op" id="3831131">(</span><span class="ident" id="3831132">p</span><span class="op" id="3831133">.</span><span class="ident" id="3831134">buffer</span><span class="op" id="3831140">,</span>&nbsp;<span class="ident" id="3831142">p</span><span class="op" id="3831143">.</span><span class="ident" id="3831144">mr</span><span class="op" id="3831146">.</span><span class="ident" id="3831147">bufReader</span><span class="op" id="3831156">,</span>&nbsp;<span class="ident" id="3831158">int64</span><span class="op" id="3831163">(</span><span class="ident" id="3831164">nCopy</span><span class="op" id="3831169">)</span><span class="op" id="3831170">)</span><span class="op" id="3831171">;</span>&nbsp;<span class="ident" id="3831173">err</span>&nbsp;<span class="op" id="3831177">!=</span>&nbsp;<span class="ident" id="3831180">nil</span>&nbsp;<span class="op" id="3831184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831189">return</span>&nbsp;<span class="num" id="3831196">0</span><span class="op" id="3831197">,</span>&nbsp;<span class="ident" id="3831199">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3831205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3831208">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831211">n</span><span class="op" id="3831212">,</span>&nbsp;<span class="ident" id="3831214">err</span>&nbsp;<span class="op" id="3831218">=</span>&nbsp;<span class="ident" id="3831220">p</span><span class="op" id="3831221">.</span><span class="ident" id="3831222">buffer</span><span class="op" id="3831228">.</span><span class="ident" id="3831229">Read</span><span class="op" id="3831233">(</span><span class="ident" id="3831234">d</span><span class="op" id="3831235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831238">if</span>&nbsp;<span class="ident" id="3831241">err</span>&nbsp;<span class="op" id="3831245">==</span>&nbsp;<span class="ident" id="3831248">io</span><span class="op" id="3831250">.</span><span class="ident" id="3831251">EOF</span>&nbsp;<span class="op" id="3831255">&amp;&amp;</span>&nbsp;<span class="op" id="3831258">!</span><span class="ident" id="3831259">foundBoundary</span>&nbsp;<span class="op" id="3831273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3831277">//&nbsp;If&nbsp;the&nbsp;boundary&nbsp;hasn&#39;t&nbsp;been&nbsp;reached&nbsp;there&#39;s&nbsp;more&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3831334">//&nbsp;read,&nbsp;so&nbsp;don&#39;t&nbsp;pass&nbsp;through&nbsp;an&nbsp;EOF&nbsp;from&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831390">err</span>&nbsp;<span class="op" id="3831394">=</span>&nbsp;<span class="ident" id="3831396">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3831401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831404">return</span><br>
<span class="lineno"></span><span class="op" id="3831411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3831414">func</span>&nbsp;<span class="op" id="3831419">(</span><span class="ident" id="3831420">p</span>&nbsp;<span class="op" id="3831422">*</span><span class="ident" id="3831423">Part</span><span class="op" id="3831427">)</span>&nbsp;<span class="ident" id="3831429">Close</span><span class="op" id="3831434">(</span><span class="op" id="3831435">)</span>&nbsp;<span class="builtintype" id="3831437">error</span>&nbsp;<span class="op" id="3831443">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831446">io</span><span class="op" id="3831448">.</span><span class="ident" id="3831449">Copy</span><span class="op" id="3831453">(</span><span class="ident" id="3831454">ioutil</span><span class="op" id="3831460">.</span><span class="ident" id="3831461">Discard</span><span class="op" id="3831468">,</span>&nbsp;<span class="ident" id="3831470">p</span><span class="op" id="3831471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831474">return</span>&nbsp;<span class="ident" id="3831481">nil</span><br>
<span class="lineno"></span><span class="op" id="3831485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3831488">//&nbsp;Reader&nbsp;is&nbsp;an&nbsp;iterator&nbsp;over&nbsp;parts&nbsp;in&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno">205</span><span class="comment" id="3831550">//&nbsp;Reader&#39;s&nbsp;underlying&nbsp;parser&nbsp;consumes&nbsp;its&nbsp;input&nbsp;as&nbsp;needed.&nbsp;&nbsp;Seeking</span><br>
<span class="lineno"></span><span class="comment" id="3831619">//&nbsp;isn&#39;t&nbsp;supported.</span><br>
<span class="lineno"></span><span class="keyword" id="3831639">type</span>&nbsp;<span class="ident" id="3831644">Reader</span>&nbsp;<span class="keyword" id="3831651">struct</span>&nbsp;<span class="op" id="3831658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831661">bufReader</span>&nbsp;<span class="op" id="3831671">*</span><span class="ident" id="3831672">bufio</span><span class="op" id="3831677">.</span><span class="ident" id="3831678">Reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831687">currentPart</span>&nbsp;<span class="op" id="3831699">*</span><span class="ident" id="3831700">Part</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831706">partsRead</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3831718">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831724">nl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3831741">[</span><span class="op" id="3831742">]</span><span class="builtintype" id="3831743">byte</span>&nbsp;<span class="comment" id="3831748">//&nbsp;&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;&nbsp;(set&nbsp;after&nbsp;seeing&nbsp;first&nbsp;boundary&nbsp;line)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831806">nlDashBoundary</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3831823">[</span><span class="op" id="3831824">]</span><span class="builtintype" id="3831825">byte</span>&nbsp;<span class="comment" id="3831830">//&nbsp;nl&nbsp;+&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831852">dashBoundaryDash</span>&nbsp;<span class="op" id="3831869">[</span><span class="op" id="3831870">]</span><span class="builtintype" id="3831871">byte</span>&nbsp;<span class="comment" id="3831876">//&nbsp;&#34;--boundary--&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831895">dashBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3831912">[</span><span class="op" id="3831913">]</span><span class="builtintype" id="3831914">byte</span>&nbsp;<span class="comment" id="3831919">//&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno"></span><span class="op" id="3831935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3831938">//&nbsp;NextPart&nbsp;returns&nbsp;the&nbsp;next&nbsp;part&nbsp;in&nbsp;the&nbsp;multipart&nbsp;or&nbsp;an&nbsp;error.</span><br>
<span class="lineno">220</span><span class="comment" id="3832002">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;parts,&nbsp;the&nbsp;error&nbsp;io.EOF&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3832065">func</span>&nbsp;<span class="op" id="3832070">(</span><span class="ident" id="3832071">r</span>&nbsp;<span class="op" id="3832073">*</span><span class="ident" id="3832074">Reader</span><span class="op" id="3832080">)</span>&nbsp;<span class="ident" id="3832082">NextPart</span><span class="op" id="3832090">(</span><span class="op" id="3832091">)</span>&nbsp;<span class="op" id="3832093">(</span><span class="op" id="3832094">*</span><span class="ident" id="3832095">Part</span><span class="op" id="3832099">,</span>&nbsp;<span class="builtintype" id="3832101">error</span><span class="op" id="3832106">)</span>&nbsp;<span class="op" id="3832108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832111">if</span>&nbsp;<span class="ident" id="3832114">r</span><span class="op" id="3832115">.</span><span class="ident" id="3832116">currentPart</span>&nbsp;<span class="op" id="3832128">!=</span>&nbsp;<span class="ident" id="3832131">nil</span>&nbsp;<span class="op" id="3832135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832139">r</span><span class="op" id="3832140">.</span><span class="ident" id="3832141">currentPart</span><span class="op" id="3832152">.</span><span class="ident" id="3832153">Close</span><span class="op" id="3832158">(</span><span class="op" id="3832159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832162">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832166">expectNewPart</span>&nbsp;<span class="op" id="3832180">:=</span>&nbsp;<span class="builtintype" id="3832183">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832190">for</span>&nbsp;<span class="op" id="3832194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832198">line</span><span class="op" id="3832202">,</span>&nbsp;<span class="ident" id="3832204">err</span>&nbsp;<span class="op" id="3832208">:=</span>&nbsp;<span class="ident" id="3832211">r</span><span class="op" id="3832212">.</span><span class="ident" id="3832213">bufReader</span><span class="op" id="3832222">.</span><span class="ident" id="3832223">ReadSlice</span><span class="op" id="3832232">(</span><span class="string" id="3832233">&#39;\n&#39;</span><span class="op" id="3832237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832241">if</span>&nbsp;<span class="ident" id="3832244">err</span>&nbsp;<span class="op" id="3832248">==</span>&nbsp;<span class="ident" id="3832251">io</span><span class="op" id="3832253">.</span><span class="ident" id="3832254">EOF</span>&nbsp;<span class="op" id="3832258">&amp;&amp;</span>&nbsp;<span class="ident" id="3832261">r</span><span class="op" id="3832262">.</span><span class="ident" id="3832263">isFinalBoundary</span><span class="op" id="3832278">(</span><span class="ident" id="3832279">line</span><span class="op" id="3832283">)</span>&nbsp;<span class="op" id="3832285">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832290">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;ends&nbsp;in&nbsp;&#34;--boundary--&#34;&nbsp;without&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832345">//&nbsp;trailing&nbsp;&#34;\r\n&#34;,&nbsp;ReadSlice&nbsp;will&nbsp;return&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832399">//&nbsp;(since&nbsp;it&#39;s&nbsp;missing&nbsp;the&nbsp;&#39;\n&#39;),&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;valid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832456">//&nbsp;multipart&nbsp;EOF&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;return&nbsp;io.EOF&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832515">//&nbsp;a&nbsp;fmt-wrapped&nbsp;one.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832540">return</span>&nbsp;<span class="ident" id="3832547">nil</span><span class="op" id="3832550">,</span>&nbsp;<span class="ident" id="3832552">io</span><span class="op" id="3832554">.</span><span class="ident" id="3832555">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832565">if</span>&nbsp;<span class="ident" id="3832568">err</span>&nbsp;<span class="op" id="3832572">!=</span>&nbsp;<span class="ident" id="3832575">nil</span>&nbsp;<span class="op" id="3832579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832584">return</span>&nbsp;<span class="ident" id="3832591">nil</span><span class="op" id="3832594">,</span>&nbsp;<span class="ident" id="3832596">fmt</span><span class="op" id="3832599">.</span><span class="ident" id="3832600">Errorf</span><span class="op" id="3832606">(</span><span class="string" id="3832607">&#34;multipart:&nbsp;NextPart:&nbsp;%v&#34;</span><span class="op" id="3832632">,</span>&nbsp;<span class="ident" id="3832634">err</span><span class="op" id="3832637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832641">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832646">if</span>&nbsp;<span class="ident" id="3832649">r</span><span class="op" id="3832650">.</span><span class="ident" id="3832651">isBoundaryDelimiterLine</span><span class="op" id="3832674">(</span><span class="ident" id="3832675">line</span><span class="op" id="3832679">)</span>&nbsp;<span class="op" id="3832681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832686">r</span><span class="op" id="3832687">.</span><span class="ident" id="3832688">partsRead</span><span class="op" id="3832697">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832703">bp</span><span class="op" id="3832705">,</span>&nbsp;<span class="ident" id="3832707">err</span>&nbsp;<span class="op" id="3832711">:=</span>&nbsp;<span class="ident" id="3832714">newPart</span><span class="op" id="3832721">(</span><span class="ident" id="3832722">r</span><span class="op" id="3832723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832728">if</span>&nbsp;<span class="ident" id="3832731">err</span>&nbsp;<span class="op" id="3832735">!=</span>&nbsp;<span class="ident" id="3832738">nil</span>&nbsp;<span class="op" id="3832742">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832748">return</span>&nbsp;<span class="ident" id="3832755">nil</span><span class="op" id="3832758">,</span>&nbsp;<span class="ident" id="3832760">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832772">r</span><span class="op" id="3832773">.</span><span class="ident" id="3832774">currentPart</span>&nbsp;<span class="op" id="3832786">=</span>&nbsp;<span class="ident" id="3832788">bp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832794">return</span>&nbsp;<span class="ident" id="3832801">bp</span><span class="op" id="3832803">,</span>&nbsp;<span class="ident" id="3832805">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832811">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832816">if</span>&nbsp;<span class="ident" id="3832819">r</span><span class="op" id="3832820">.</span><span class="ident" id="3832821">isFinalBoundary</span><span class="op" id="3832836">(</span><span class="ident" id="3832837">line</span><span class="op" id="3832841">)</span>&nbsp;<span class="op" id="3832843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832848">//&nbsp;Expected&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832867">return</span>&nbsp;<span class="ident" id="3832874">nil</span><span class="op" id="3832877">,</span>&nbsp;<span class="ident" id="3832879">io</span><span class="op" id="3832881">.</span><span class="ident" id="3832882">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832888">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832893">if</span>&nbsp;<span class="ident" id="3832896">expectNewPart</span>&nbsp;<span class="op" id="3832910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832915">return</span>&nbsp;<span class="ident" id="3832922">nil</span><span class="op" id="3832925">,</span>&nbsp;<span class="ident" id="3832927">fmt</span><span class="op" id="3832930">.</span><span class="ident" id="3832931">Errorf</span><span class="op" id="3832937">(</span><span class="string" id="3832938">&#34;multipart:&nbsp;expecting&nbsp;a&nbsp;new&nbsp;Part;&nbsp;got&nbsp;line&nbsp;%q&#34;</span><span class="op" id="3832984">,</span>&nbsp;<span class="builtintype" id="3832986">string</span><span class="op" id="3832992">(</span><span class="ident" id="3832993">line</span><span class="op" id="3832997">)</span><span class="op" id="3832998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3833002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833007">if</span>&nbsp;<span class="ident" id="3833010">r</span><span class="op" id="3833011">.</span><span class="ident" id="3833012">partsRead</span>&nbsp;<span class="op" id="3833022">==</span>&nbsp;<span class="num" id="3833025">0</span>&nbsp;<span class="op" id="3833027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833032">//&nbsp;skip&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833048">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3833059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833064">//&nbsp;Consume&nbsp;the&nbsp;&#34;\n&#34;&nbsp;or&nbsp;&#34;\r\n&#34;&nbsp;separator&nbsp;between&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833118">//&nbsp;body&nbsp;of&nbsp;the&nbsp;previous&nbsp;part&nbsp;and&nbsp;the&nbsp;boundary&nbsp;line&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833174">//&nbsp;now&nbsp;expect&nbsp;will&nbsp;follow.&nbsp;(either&nbsp;a&nbsp;new&nbsp;part&nbsp;or&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833229">//&nbsp;end&nbsp;boundary)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833248">if</span>&nbsp;<span class="ident" id="3833251">bytes</span><span class="op" id="3833256">.</span><span class="ident" id="3833257">Equal</span><span class="op" id="3833262">(</span><span class="ident" id="3833263">line</span><span class="op" id="3833267">,</span>&nbsp;<span class="ident" id="3833269">r</span><span class="op" id="3833270">.</span><span class="ident" id="3833271">nl</span><span class="op" id="3833273">)</span>&nbsp;<span class="op" id="3833275">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833280">expectNewPart</span>&nbsp;<span class="op" id="3833294">=</span>&nbsp;<span class="builtintype" id="3833296">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833304">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3833315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833320">return</span>&nbsp;<span class="ident" id="3833327">nil</span><span class="op" id="3833330">,</span>&nbsp;<span class="ident" id="3833332">fmt</span><span class="op" id="3833335">.</span><span class="ident" id="3833336">Errorf</span><span class="op" id="3833342">(</span><span class="string" id="3833343">&#34;multipart:&nbsp;unexpected&nbsp;line&nbsp;in&nbsp;Next():&nbsp;%q&#34;</span><span class="op" id="3833385">,</span>&nbsp;<span class="ident" id="3833387">line</span><span class="op" id="3833391">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3833394">}</span><br>
<span class="lineno"></span><span class="op" id="3833396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3833399">//&nbsp;isFinalBoundary&nbsp;reports&nbsp;whether&nbsp;line&nbsp;is&nbsp;the&nbsp;final&nbsp;boundary&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="3833466">//&nbsp;indicating&nbsp;that&nbsp;all&nbsp;parts&nbsp;are&nbsp;over.</span><br>
<span class="lineno">280</span><span class="comment" id="3833505">//&nbsp;It&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(\r\n)?$`</span><br>
<span class="lineno"></span><span class="keyword" id="3833549">func</span>&nbsp;<span class="op" id="3833554">(</span><span class="ident" id="3833555">mr</span>&nbsp;<span class="op" id="3833558">*</span><span class="ident" id="3833559">Reader</span><span class="op" id="3833565">)</span>&nbsp;<span class="ident" id="3833567">isFinalBoundary</span><span class="op" id="3833582">(</span><span class="ident" id="3833583">line</span>&nbsp;<span class="op" id="3833588">[</span><span class="op" id="3833589">]</span><span class="builtintype" id="3833590">byte</span><span class="op" id="3833594">)</span>&nbsp;<span class="builtintype" id="3833596">bool</span>&nbsp;<span class="op" id="3833601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833604">if</span>&nbsp;<span class="op" id="3833607">!</span><span class="ident" id="3833608">bytes</span><span class="op" id="3833613">.</span><span class="ident" id="3833614">HasPrefix</span><span class="op" id="3833623">(</span><span class="ident" id="3833624">line</span><span class="op" id="3833628">,</span>&nbsp;<span class="ident" id="3833630">mr</span><span class="op" id="3833632">.</span><span class="ident" id="3833633">dashBoundaryDash</span><span class="op" id="3833649">)</span>&nbsp;<span class="op" id="3833651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833655">return</span>&nbsp;<span class="builtintype" id="3833662">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3833669">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833672">rest</span>&nbsp;<span class="op" id="3833677">:=</span>&nbsp;<span class="ident" id="3833680">line</span><span class="op" id="3833684">[</span><span class="builtinfunc" id="3833685">len</span><span class="op" id="3833688">(</span><span class="ident" id="3833689">mr</span><span class="op" id="3833691">.</span><span class="ident" id="3833692">dashBoundaryDash</span><span class="op" id="3833708">)</span><span class="op" id="3833709">:</span><span class="op" id="3833710">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833713">rest</span>&nbsp;<span class="op" id="3833718">=</span>&nbsp;<span class="ident" id="3833720">skipLWSPChar</span><span class="op" id="3833732">(</span><span class="ident" id="3833733">rest</span><span class="op" id="3833737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833740">return</span>&nbsp;<span class="builtinfunc" id="3833747">len</span><span class="op" id="3833750">(</span><span class="ident" id="3833751">rest</span><span class="op" id="3833755">)</span>&nbsp;<span class="op" id="3833757">==</span>&nbsp;<span class="num" id="3833760">0</span>&nbsp;<span class="op" id="3833762">||</span>&nbsp;<span class="ident" id="3833765">bytes</span><span class="op" id="3833770">.</span><span class="ident" id="3833771">Equal</span><span class="op" id="3833776">(</span><span class="ident" id="3833777">rest</span><span class="op" id="3833781">,</span>&nbsp;<span class="ident" id="3833783">mr</span><span class="op" id="3833785">.</span><span class="ident" id="3833786">nl</span><span class="op" id="3833788">)</span><br>
<span class="lineno"></span><span class="op" id="3833790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="3833793">func</span>&nbsp;<span class="op" id="3833798">(</span><span class="ident" id="3833799">mr</span>&nbsp;<span class="op" id="3833802">*</span><span class="ident" id="3833803">Reader</span><span class="op" id="3833809">)</span>&nbsp;<span class="ident" id="3833811">isBoundaryDelimiterLine</span><span class="op" id="3833834">(</span><span class="ident" id="3833835">line</span>&nbsp;<span class="op" id="3833840">[</span><span class="op" id="3833841">]</span><span class="builtintype" id="3833842">byte</span><span class="op" id="3833846">)</span>&nbsp;<span class="op" id="3833848">(</span><span class="ident" id="3833849">ret</span>&nbsp;<span class="builtintype" id="3833853">bool</span><span class="op" id="3833857">)</span>&nbsp;<span class="op" id="3833859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833862">//&nbsp;http://tools.ietf.org/html/rfc2046#section-5.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833913">//&nbsp;&nbsp;&nbsp;The&nbsp;boundary&nbsp;delimiter&nbsp;line&nbsp;is&nbsp;then&nbsp;defined&nbsp;as&nbsp;a&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833973">//&nbsp;&nbsp;&nbsp;consisting&nbsp;entirely&nbsp;of&nbsp;two&nbsp;hyphen&nbsp;characters&nbsp;(&#34;-&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834030">//&nbsp;&nbsp;&nbsp;decimal&nbsp;value&nbsp;45)&nbsp;followed&nbsp;by&nbsp;the&nbsp;boundary&nbsp;parameter</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834089">//&nbsp;&nbsp;&nbsp;value&nbsp;from&nbsp;the&nbsp;Content-Type&nbsp;header&nbsp;field,&nbsp;optional&nbsp;linear</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834153">//&nbsp;&nbsp;&nbsp;whitespace,&nbsp;and&nbsp;a&nbsp;terminating&nbsp;CRLF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834195">if</span>&nbsp;<span class="op" id="3834198">!</span><span class="ident" id="3834199">bytes</span><span class="op" id="3834204">.</span><span class="ident" id="3834205">HasPrefix</span><span class="op" id="3834214">(</span><span class="ident" id="3834215">line</span><span class="op" id="3834219">,</span>&nbsp;<span class="ident" id="3834221">mr</span><span class="op" id="3834223">.</span><span class="ident" id="3834224">dashBoundary</span><span class="op" id="3834236">)</span>&nbsp;<span class="op" id="3834238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834242">return</span>&nbsp;<span class="builtintype" id="3834249">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3834256">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834259">rest</span>&nbsp;<span class="op" id="3834264">:=</span>&nbsp;<span class="ident" id="3834267">line</span><span class="op" id="3834271">[</span><span class="builtinfunc" id="3834272">len</span><span class="op" id="3834275">(</span><span class="ident" id="3834276">mr</span><span class="op" id="3834278">.</span><span class="ident" id="3834279">dashBoundary</span><span class="op" id="3834291">)</span><span class="op" id="3834292">:</span><span class="op" id="3834293">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834296">rest</span>&nbsp;<span class="op" id="3834301">=</span>&nbsp;<span class="ident" id="3834303">skipLWSPChar</span><span class="op" id="3834315">(</span><span class="ident" id="3834316">rest</span><span class="op" id="3834320">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834324">//&nbsp;On&nbsp;the&nbsp;first&nbsp;part,&nbsp;see&nbsp;our&nbsp;lines&nbsp;are&nbsp;ending&nbsp;in&nbsp;\n&nbsp;instead&nbsp;of&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834394">//&nbsp;and&nbsp;switch&nbsp;into&nbsp;that&nbsp;mode&nbsp;if&nbsp;so.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;spec,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834465">//&nbsp;but&nbsp;occurs&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834493">if</span>&nbsp;<span class="ident" id="3834496">mr</span><span class="op" id="3834498">.</span><span class="ident" id="3834499">partsRead</span>&nbsp;<span class="op" id="3834509">==</span>&nbsp;<span class="num" id="3834512">0</span>&nbsp;<span class="op" id="3834514">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3834517">len</span><span class="op" id="3834520">(</span><span class="ident" id="3834521">rest</span><span class="op" id="3834525">)</span>&nbsp;<span class="op" id="3834527">==</span>&nbsp;<span class="num" id="3834530">1</span>&nbsp;<span class="op" id="3834532">&amp;&amp;</span>&nbsp;<span class="ident" id="3834535">rest</span><span class="op" id="3834539">[</span><span class="num" id="3834540">0</span><span class="op" id="3834541">]</span>&nbsp;<span class="op" id="3834543">==</span>&nbsp;<span class="string" id="3834546">&#39;\n&#39;</span>&nbsp;<span class="op" id="3834551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834555">mr</span><span class="op" id="3834557">.</span><span class="ident" id="3834558">nl</span>&nbsp;<span class="op" id="3834561">=</span>&nbsp;<span class="ident" id="3834563">mr</span><span class="op" id="3834565">.</span><span class="ident" id="3834566">nl</span><span class="op" id="3834568">[</span><span class="num" id="3834569">1</span><span class="op" id="3834570">:</span><span class="op" id="3834571">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834575">mr</span><span class="op" id="3834577">.</span><span class="ident" id="3834578">nlDashBoundary</span>&nbsp;<span class="op" id="3834593">=</span>&nbsp;<span class="ident" id="3834595">mr</span><span class="op" id="3834597">.</span><span class="ident" id="3834598">nlDashBoundary</span><span class="op" id="3834612">[</span><span class="num" id="3834613">1</span><span class="op" id="3834614">:</span><span class="op" id="3834615">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3834618">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834621">return</span>&nbsp;<span class="ident" id="3834628">bytes</span><span class="op" id="3834633">.</span><span class="ident" id="3834634">Equal</span><span class="op" id="3834639">(</span><span class="ident" id="3834640">rest</span><span class="op" id="3834644">,</span>&nbsp;<span class="ident" id="3834646">mr</span><span class="op" id="3834648">.</span><span class="ident" id="3834649">nl</span><span class="op" id="3834651">)</span><br>
<span class="lineno"></span><span class="op" id="3834653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3834656">//&nbsp;peekBufferIsEmptyPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;provided&nbsp;peek-ahead</span><br>
<span class="lineno"></span><span class="comment" id="3834721">//&nbsp;buffer&nbsp;represents&nbsp;an&nbsp;empty&nbsp;part.&nbsp;It&nbsp;is&nbsp;called&nbsp;only&nbsp;if&nbsp;we&#39;ve&nbsp;not</span><br>
<span class="lineno">315</span><span class="comment" id="3834788">//&nbsp;already&nbsp;read&nbsp;any&nbsp;bytes&nbsp;in&nbsp;this&nbsp;part&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;MIME</span><br>
<span class="lineno"></span><span class="comment" id="3834859">//&nbsp;software&nbsp;not&nbsp;writing&nbsp;the&nbsp;\r\n&nbsp;on&nbsp;empty&nbsp;parts.&nbsp;Some&nbsp;does,&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3834924">//&nbsp;doesn&#39;t.</span><br>
<span class="lineno"></span><span class="comment" id="3834936">//</span><br>
<span class="lineno"></span><span class="comment" id="3834939">//&nbsp;This&nbsp;checks&nbsp;that&nbsp;what&nbsp;follows&nbsp;the&nbsp;&#34;--boundary&#34;&nbsp;is&nbsp;actually&nbsp;the&nbsp;end</span><br>
<span class="lineno">320</span><span class="comment" id="3835009">//&nbsp;(&#34;--boundary--&#34;&nbsp;with&nbsp;optional&nbsp;whitespace)&nbsp;or&nbsp;optional&nbsp;whitespace</span><br>
<span class="lineno"></span><span class="comment" id="3835077">//&nbsp;and&nbsp;then&nbsp;a&nbsp;newline,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;catch&nbsp;&#34;--boundaryFAKE&#34;,&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3835145">//&nbsp;case&nbsp;the&nbsp;whole&nbsp;line&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3835189">func</span>&nbsp;<span class="op" id="3835194">(</span><span class="ident" id="3835195">mr</span>&nbsp;<span class="op" id="3835198">*</span><span class="ident" id="3835199">Reader</span><span class="op" id="3835205">)</span>&nbsp;<span class="ident" id="3835207">peekBufferIsEmptyPart</span><span class="op" id="3835228">(</span><span class="ident" id="3835229">peek</span>&nbsp;<span class="op" id="3835234">[</span><span class="op" id="3835235">]</span><span class="builtintype" id="3835236">byte</span><span class="op" id="3835240">)</span>&nbsp;<span class="builtintype" id="3835242">bool</span>&nbsp;<span class="op" id="3835247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3835250">//&nbsp;End&nbsp;of&nbsp;parts&nbsp;case.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3835273">//&nbsp;Test&nbsp;whether&nbsp;peek&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(?:\r\n|$)`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835335">if</span>&nbsp;<span class="ident" id="3835338">bytes</span><span class="op" id="3835343">.</span><span class="ident" id="3835344">HasPrefix</span><span class="op" id="3835353">(</span><span class="ident" id="3835354">peek</span><span class="op" id="3835358">,</span>&nbsp;<span class="ident" id="3835360">mr</span><span class="op" id="3835362">.</span><span class="ident" id="3835363">dashBoundaryDash</span><span class="op" id="3835379">)</span>&nbsp;<span class="op" id="3835381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835385">rest</span>&nbsp;<span class="op" id="3835390">:=</span>&nbsp;<span class="ident" id="3835393">peek</span><span class="op" id="3835397">[</span><span class="builtinfunc" id="3835398">len</span><span class="op" id="3835401">(</span><span class="ident" id="3835402">mr</span><span class="op" id="3835404">.</span><span class="ident" id="3835405">dashBoundaryDash</span><span class="op" id="3835421">)</span><span class="op" id="3835422">:</span><span class="op" id="3835423">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835427">rest</span>&nbsp;<span class="op" id="3835432">=</span>&nbsp;<span class="ident" id="3835434">skipLWSPChar</span><span class="op" id="3835446">(</span><span class="ident" id="3835447">rest</span><span class="op" id="3835451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835455">return</span>&nbsp;<span class="ident" id="3835462">bytes</span><span class="op" id="3835467">.</span><span class="ident" id="3835468">HasPrefix</span><span class="op" id="3835477">(</span><span class="ident" id="3835478">rest</span><span class="op" id="3835482">,</span>&nbsp;<span class="ident" id="3835484">mr</span><span class="op" id="3835486">.</span><span class="ident" id="3835487">nl</span><span class="op" id="3835489">)</span>&nbsp;<span class="op" id="3835491">||</span>&nbsp;<span class="builtinfunc" id="3835494">len</span><span class="op" id="3835497">(</span><span class="ident" id="3835498">rest</span><span class="op" id="3835502">)</span>&nbsp;<span class="op" id="3835504">==</span>&nbsp;<span class="num" id="3835507">0</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835513">if</span>&nbsp;<span class="op" id="3835516">!</span><span class="ident" id="3835517">bytes</span><span class="op" id="3835522">.</span><span class="ident" id="3835523">HasPrefix</span><span class="op" id="3835532">(</span><span class="ident" id="3835533">peek</span><span class="op" id="3835537">,</span>&nbsp;<span class="ident" id="3835539">mr</span><span class="op" id="3835541">.</span><span class="ident" id="3835542">dashBoundary</span><span class="op" id="3835554">)</span>&nbsp;<span class="op" id="3835556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835560">return</span>&nbsp;<span class="builtintype" id="3835567">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3835577">//&nbsp;Test&nbsp;whether&nbsp;rest&nbsp;matches&nbsp;`^[&nbsp;\t]*\r\n`)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835622">rest</span>&nbsp;<span class="op" id="3835627">:=</span>&nbsp;<span class="ident" id="3835630">peek</span><span class="op" id="3835634">[</span><span class="builtinfunc" id="3835635">len</span><span class="op" id="3835638">(</span><span class="ident" id="3835639">mr</span><span class="op" id="3835641">.</span><span class="ident" id="3835642">dashBoundary</span><span class="op" id="3835654">)</span><span class="op" id="3835655">:</span><span class="op" id="3835656">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835659">rest</span>&nbsp;<span class="op" id="3835664">=</span>&nbsp;<span class="ident" id="3835666">skipLWSPChar</span><span class="op" id="3835678">(</span><span class="ident" id="3835679">rest</span><span class="op" id="3835683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835686">return</span>&nbsp;<span class="ident" id="3835693">bytes</span><span class="op" id="3835698">.</span><span class="ident" id="3835699">HasPrefix</span><span class="op" id="3835708">(</span><span class="ident" id="3835709">rest</span><span class="op" id="3835713">,</span>&nbsp;<span class="ident" id="3835715">mr</span><span class="op" id="3835717">.</span><span class="ident" id="3835718">nl</span><span class="op" id="3835720">)</span><br>
<span class="lineno"></span><span class="op" id="3835722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment" id="3835725">//&nbsp;skipLWSPChar&nbsp;returns&nbsp;b&nbsp;with&nbsp;leading&nbsp;spaces&nbsp;and&nbsp;tabs&nbsp;removed.</span><br>
<span class="lineno"></span><span class="comment" id="3835789">//&nbsp;RFC&nbsp;822&nbsp;defines:</span><br>
<span class="lineno"></span><span class="comment" id="3835809">//&nbsp;&nbsp;&nbsp;&nbsp;LWSP-char&nbsp;=&nbsp;SPACE&nbsp;/&nbsp;HTAB</span><br>
<span class="lineno"></span><span class="keyword" id="3835840">func</span>&nbsp;<span class="ident" id="3835845">skipLWSPChar</span><span class="op" id="3835857">(</span><span class="ident" id="3835858">b</span>&nbsp;<span class="op" id="3835860">[</span><span class="op" id="3835861">]</span><span class="builtintype" id="3835862">byte</span><span class="op" id="3835866">)</span>&nbsp;<span class="op" id="3835868">[</span><span class="op" id="3835869">]</span><span class="builtintype" id="3835870">byte</span>&nbsp;<span class="op" id="3835875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835878">for</span>&nbsp;<span class="builtinfunc" id="3835882">len</span><span class="op" id="3835885">(</span><span class="ident" id="3835886">b</span><span class="op" id="3835887">)</span>&nbsp;<span class="op" id="3835889">&gt;</span>&nbsp;<span class="num" id="3835891">0</span>&nbsp;<span class="op" id="3835893">&amp;&amp;</span>&nbsp;<span class="op" id="3835896">(</span><span class="ident" id="3835897">b</span><span class="op" id="3835898">[</span><span class="num" id="3835899">0</span><span class="op" id="3835900">]</span>&nbsp;<span class="op" id="3835902">==</span>&nbsp;<span class="string" id="3835905">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="3835909">||</span>&nbsp;<span class="ident" id="3835912">b</span><span class="op" id="3835913">[</span><span class="num" id="3835914">0</span><span class="op" id="3835915">]</span>&nbsp;<span class="op" id="3835917">==</span>&nbsp;<span class="string" id="3835920">&#39;\t&#39;</span><span class="op" id="3835924">)</span>&nbsp;<span class="op" id="3835926">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835930">b</span>&nbsp;<span class="op" id="3835932">=</span>&nbsp;<span class="ident" id="3835934">b</span><span class="op" id="3835935">[</span><span class="num" id="3835936">1</span><span class="op" id="3835937">:</span><span class="op" id="3835938">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835944">return</span>&nbsp;<span class="ident" id="3835951">b</span><br>
<span class="lineno"></span><span class="op" id="3835953">}</span>
</div>
</body>
</html>
