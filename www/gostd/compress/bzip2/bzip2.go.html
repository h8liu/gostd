<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/bzip2</h2>
<ul>
<li><a href="/gostd/compress/bzip2/bit_reader.go.html">bit_reader.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2.go.html" class="current">bzip2.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2_test.go.html">bzip2_test.go</a></li>
<li><a href="/gostd/compress/bzip2/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/compress/bzip2/move_to_front.go.html">move_to_front.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5633412">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5633467">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5633521">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5633572">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="5633621">package</span>&nbsp;<span class="ident" id="5633629">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5633636">import</span>&nbsp;<span class="string" id="5633643">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="5633649">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="5633728">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="5633779">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="5633835">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="5633883">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5633951">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="5633977">type</span>&nbsp;<span class="ident" id="5633982">StructuralError</span>&nbsp;<span class="builtintype" id="5633998">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5634006">func</span>&nbsp;<span class="op" id="5634011">(</span><span class="ident" id="5634012">s</span>&nbsp;<span class="ident" id="5634014">StructuralError</span><span class="op" id="5634029">)</span>&nbsp;<span class="ident" id="5634031">Error</span><span class="op" id="5634036">(</span><span class="op" id="5634037">)</span>&nbsp;<span class="builtintype" id="5634039">string</span>&nbsp;<span class="op" id="5634046">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5634049">return</span>&nbsp;<span class="string" id="5634056">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="5634079">+</span>&nbsp;<span class="builtintype" id="5634081">string</span><span class="op" id="5634087">(</span><span class="ident" id="5634088">s</span><span class="op" id="5634089">)</span><br>
<span class="lineno"></span><span class="op" id="5634091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5634094">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5634142">type</span>&nbsp;<span class="ident" id="5634147">reader</span>&nbsp;<span class="keyword" id="5634154">struct</span>&nbsp;<span class="op" id="5634161">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634164">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634177">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634188">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5634201">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634209">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5634222">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634230">wantBlockCRC</span>&nbsp;<span class="builtintype" id="5634243">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634251">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5634264">bool</span>&nbsp;<span class="comment" id="5634269">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634314">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5634327">int</span>&nbsp;&nbsp;<span class="comment" id="5634332">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634373">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5634386">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634392">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5634405">[</span><span class="op" id="5634406">]</span><span class="builtintype" id="5634407">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5634415">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634460">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5634473">[</span><span class="num" id="5634474">256</span><span class="op" id="5634477">]</span><span class="builtintype" id="5634478">uint</span>&nbsp;<span class="comment" id="5634483">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634522">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5634535">[</span><span class="op" id="5634536">]</span><span class="builtintype" id="5634537">uint32</span>&nbsp;&nbsp;<span class="comment" id="5634545">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634639">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5634652">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5634662">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634704">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5634716">[</span><span class="op" id="5634717">]</span><span class="builtintype" id="5634718">uint32</span>&nbsp;<span class="comment" id="5634725">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634774">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="5634786">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5634795">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634833">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5634845">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5634854">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634884">byteRepeats</span>&nbsp;<span class="builtintype" id="5634896">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5634905">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634949">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5634961">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5634970">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="5635017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5635020">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="5635092">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="5635139">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5635201">func</span>&nbsp;<span class="ident" id="5635206">NewReader</span><span class="op" id="5635215">(</span><span class="ident" id="5635216">r</span>&nbsp;<span class="ident" id="5635218">io</span><span class="op" id="5635220">.</span><span class="ident" id="5635221">Reader</span><span class="op" id="5635227">)</span>&nbsp;<span class="ident" id="5635229">io</span><span class="op" id="5635231">.</span><span class="ident" id="5635232">Reader</span>&nbsp;<span class="op" id="5635239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635242">bz2</span>&nbsp;<span class="op" id="5635246">:=</span>&nbsp;<span class="builtinfunc" id="5635249">new</span><span class="op" id="5635252">(</span><span class="ident" id="5635253">reader</span><span class="op" id="5635259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635262">bz2</span><span class="op" id="5635265">.</span><span class="ident" id="5635266">br</span>&nbsp;<span class="op" id="5635269">=</span>&nbsp;<span class="ident" id="5635271">newBitReader</span><span class="op" id="5635283">(</span><span class="ident" id="5635284">r</span><span class="op" id="5635285">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5635288">return</span>&nbsp;<span class="ident" id="5635295">bz2</span><br>
<span class="lineno"></span><span class="op" id="5635299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5635302">const</span>&nbsp;<span class="ident" id="5635308">bzip2FileMagic</span>&nbsp;<span class="op" id="5635323">=</span>&nbsp;<span class="num" id="5635325">0x425a</span>&nbsp;<span class="comment" id="5635332">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="5635340">const</span>&nbsp;<span class="ident" id="5635346">bzip2BlockMagic</span>&nbsp;<span class="op" id="5635362">=</span>&nbsp;<span class="num" id="5635364">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="5635379">const</span>&nbsp;<span class="ident" id="5635385">bzip2FinalMagic</span>&nbsp;<span class="op" id="5635401">=</span>&nbsp;<span class="num" id="5635403">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5635419">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5635453">func</span>&nbsp;<span class="op" id="5635458">(</span><span class="ident" id="5635459">bz2</span>&nbsp;<span class="op" id="5635463">*</span><span class="ident" id="5635464">reader</span><span class="op" id="5635470">)</span>&nbsp;<span class="ident" id="5635472">setup</span><span class="op" id="5635477">(</span><span class="ident" id="5635478">needMagic</span>&nbsp;<span class="builtintype" id="5635488">bool</span><span class="op" id="5635492">)</span>&nbsp;<span class="builtintype" id="5635494">error</span>&nbsp;<span class="op" id="5635500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635503">br</span>&nbsp;<span class="op" id="5635506">:=</span>&nbsp;<span class="op" id="5635509">&amp;</span><span class="ident" id="5635510">bz2</span><span class="op" id="5635513">.</span><span class="ident" id="5635514">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5635519">if</span>&nbsp;<span class="ident" id="5635522">needMagic</span>&nbsp;<span class="op" id="5635532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635536">magic</span>&nbsp;<span class="op" id="5635542">:=</span>&nbsp;<span class="ident" id="5635545">br</span><span class="op" id="5635547">.</span><span class="ident" id="5635548">ReadBits</span><span class="op" id="5635556">(</span><span class="num" id="5635557">16</span><span class="op" id="5635559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5635563">if</span>&nbsp;<span class="ident" id="5635566">magic</span>&nbsp;<span class="op" id="5635572">!=</span>&nbsp;<span class="ident" id="5635575">bzip2FileMagic</span>&nbsp;<span class="op" id="5635590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5635595">return</span>&nbsp;<span class="ident" id="5635602">StructuralError</span><span class="op" id="5635617">(</span><span class="string" id="5635618">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="5635635">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5635639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5635642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635646">t</span>&nbsp;<span class="op" id="5635648">:=</span>&nbsp;<span class="ident" id="5635651">br</span><span class="op" id="5635653">.</span><span class="ident" id="5635654">ReadBits</span><span class="op" id="5635662">(</span><span class="num" id="5635663">8</span><span class="op" id="5635664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5635667">if</span>&nbsp;<span class="ident" id="5635670">t</span>&nbsp;<span class="op" id="5635672">!=</span>&nbsp;<span class="string" id="5635675">&#39;h&#39;</span>&nbsp;<span class="op" id="5635679">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5635683">return</span>&nbsp;<span class="ident" id="5635690">StructuralError</span><span class="op" id="5635705">(</span><span class="string" id="5635706">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="5635736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5635739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635743">level</span>&nbsp;<span class="op" id="5635749">:=</span>&nbsp;<span class="ident" id="5635752">br</span><span class="op" id="5635754">.</span><span class="ident" id="5635755">ReadBits</span><span class="op" id="5635763">(</span><span class="num" id="5635764">8</span><span class="op" id="5635765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5635768">if</span>&nbsp;<span class="ident" id="5635771">level</span>&nbsp;<span class="op" id="5635777">&lt;</span>&nbsp;<span class="string" id="5635779">&#39;1&#39;</span>&nbsp;<span class="op" id="5635783">||</span>&nbsp;<span class="ident" id="5635786">level</span>&nbsp;<span class="op" id="5635792">&gt;</span>&nbsp;<span class="string" id="5635794">&#39;9&#39;</span>&nbsp;<span class="op" id="5635798">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5635802">return</span>&nbsp;<span class="ident" id="5635809">StructuralError</span><span class="op" id="5635824">(</span><span class="string" id="5635825">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="5635852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5635855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635859">bz2</span><span class="op" id="5635862">.</span><span class="ident" id="5635863">fileCRC</span>&nbsp;<span class="op" id="5635871">=</span>&nbsp;<span class="num" id="5635873">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635876">bz2</span><span class="op" id="5635879">.</span><span class="ident" id="5635880">blockSize</span>&nbsp;<span class="op" id="5635890">=</span>&nbsp;<span class="num" id="5635892">100</span>&nbsp;<span class="op" id="5635896">*</span>&nbsp;<span class="num" id="5635898">1024</span>&nbsp;<span class="op" id="5635903">*</span>&nbsp;<span class="op" id="5635905">(</span><span class="builtintype" id="5635906">int</span><span class="op" id="5635909">(</span><span class="ident" id="5635910">level</span><span class="op" id="5635915">)</span>&nbsp;<span class="op" id="5635917">-</span>&nbsp;<span class="string" id="5635919">&#39;0&#39;</span><span class="op" id="5635922">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5635925">if</span>&nbsp;<span class="ident" id="5635928">bz2</span><span class="op" id="5635931">.</span><span class="ident" id="5635932">blockSize</span>&nbsp;<span class="op" id="5635942">&gt;</span>&nbsp;<span class="builtinfunc" id="5635944">len</span><span class="op" id="5635947">(</span><span class="ident" id="5635948">bz2</span><span class="op" id="5635951">.</span><span class="ident" id="5635952">tt</span><span class="op" id="5635954">)</span>&nbsp;<span class="op" id="5635956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635960">bz2</span><span class="op" id="5635963">.</span><span class="ident" id="5635964">tt</span>&nbsp;<span class="op" id="5635967">=</span>&nbsp;<span class="builtinfunc" id="5635969">make</span><span class="op" id="5635973">(</span><span class="op" id="5635974">[</span><span class="op" id="5635975">]</span><span class="builtintype" id="5635976">uint32</span><span class="op" id="5635982">,</span>&nbsp;<span class="ident" id="5635984">bz2</span><span class="op" id="5635987">.</span><span class="ident" id="5635988">blockSize</span><span class="op" id="5635997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5636000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5636003">return</span>&nbsp;<span class="builtintype" id="5636010">nil</span><br>
<span class="lineno"></span><span class="op" id="5636014">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5636017">func</span>&nbsp;<span class="op" id="5636022">(</span><span class="ident" id="5636023">bz2</span>&nbsp;<span class="op" id="5636027">*</span><span class="ident" id="5636028">reader</span><span class="op" id="5636034">)</span>&nbsp;<span class="ident" id="5636036">Read</span><span class="op" id="5636040">(</span><span class="ident" id="5636041">buf</span>&nbsp;<span class="op" id="5636045">[</span><span class="op" id="5636046">]</span><span class="builtintype" id="5636047">byte</span><span class="op" id="5636051">)</span>&nbsp;<span class="op" id="5636053">(</span><span class="ident" id="5636054">n</span>&nbsp;<span class="builtintype" id="5636056">int</span><span class="op" id="5636059">,</span>&nbsp;<span class="ident" id="5636061">err</span>&nbsp;<span class="builtintype" id="5636065">error</span><span class="op" id="5636070">)</span>&nbsp;<span class="op" id="5636072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5636075">if</span>&nbsp;<span class="ident" id="5636078">bz2</span><span class="op" id="5636081">.</span><span class="ident" id="5636082">eof</span>&nbsp;<span class="op" id="5636086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5636090">return</span>&nbsp;<span class="num" id="5636097">0</span><span class="op" id="5636098">,</span>&nbsp;<span class="ident" id="5636100">io</span><span class="op" id="5636102">.</span><span class="ident" id="5636103">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5636108">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5636112">if</span>&nbsp;<span class="op" id="5636115">!</span><span class="ident" id="5636116">bz2</span><span class="op" id="5636119">.</span><span class="ident" id="5636120">setupDone</span>&nbsp;<span class="op" id="5636130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636134">err</span>&nbsp;<span class="op" id="5636138">=</span>&nbsp;<span class="ident" id="5636140">bz2</span><span class="op" id="5636143">.</span><span class="ident" id="5636144">setup</span><span class="op" id="5636149">(</span><span class="builtintype" id="5636150">true</span><span class="op" id="5636154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636158">brErr</span>&nbsp;<span class="op" id="5636164">:=</span>&nbsp;<span class="ident" id="5636167">bz2</span><span class="op" id="5636170">.</span><span class="ident" id="5636171">br</span><span class="op" id="5636173">.</span><span class="ident" id="5636174">Err</span><span class="op" id="5636177">(</span><span class="op" id="5636178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5636182">if</span>&nbsp;<span class="ident" id="5636185">brErr</span>&nbsp;<span class="op" id="5636191">!=</span>&nbsp;<span class="builtintype" id="5636194">nil</span>&nbsp;<span class="op" id="5636198">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636203">err</span>&nbsp;<span class="op" id="5636207">=</span>&nbsp;<span class="ident" id="5636209">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5636217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5636221">if</span>&nbsp;<span class="ident" id="5636224">err</span>&nbsp;<span class="op" id="5636228">!=</span>&nbsp;<span class="builtintype" id="5636231">nil</span>&nbsp;<span class="op" id="5636235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5636240">return</span>&nbsp;<span class="num" id="5636247">0</span><span class="op" id="5636248">,</span>&nbsp;<span class="ident" id="5636250">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5636256">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636260">bz2</span><span class="op" id="5636263">.</span><span class="ident" id="5636264">setupDone</span>&nbsp;<span class="op" id="5636274">=</span>&nbsp;<span class="builtintype" id="5636276">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5636282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636286">n</span><span class="op" id="5636287">,</span>&nbsp;<span class="ident" id="5636289">err</span>&nbsp;<span class="op" id="5636293">=</span>&nbsp;<span class="ident" id="5636295">bz2</span><span class="op" id="5636298">.</span><span class="ident" id="5636299">read</span><span class="op" id="5636303">(</span><span class="ident" id="5636304">buf</span><span class="op" id="5636307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636310">brErr</span>&nbsp;<span class="op" id="5636316">:=</span>&nbsp;<span class="ident" id="5636319">bz2</span><span class="op" id="5636322">.</span><span class="ident" id="5636323">br</span><span class="op" id="5636325">.</span><span class="ident" id="5636326">Err</span><span class="op" id="5636329">(</span><span class="op" id="5636330">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5636333">if</span>&nbsp;<span class="ident" id="5636336">brErr</span>&nbsp;<span class="op" id="5636342">!=</span>&nbsp;<span class="builtintype" id="5636345">nil</span>&nbsp;<span class="op" id="5636349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636353">err</span>&nbsp;<span class="op" id="5636357">=</span>&nbsp;<span class="ident" id="5636359">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5636366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5636369">return</span><br>
<span class="lineno"></span><span class="op" id="5636376">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5636379">func</span>&nbsp;<span class="op" id="5636384">(</span><span class="ident" id="5636385">bz2</span>&nbsp;<span class="op" id="5636389">*</span><span class="ident" id="5636390">reader</span><span class="op" id="5636396">)</span>&nbsp;<span class="ident" id="5636398">readFromBlock</span><span class="op" id="5636411">(</span><span class="ident" id="5636412">buf</span>&nbsp;<span class="op" id="5636416">[</span><span class="op" id="5636417">]</span><span class="builtintype" id="5636418">byte</span><span class="op" id="5636422">)</span>&nbsp;<span class="builtintype" id="5636424">int</span>&nbsp;<span class="op" id="5636428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5636431">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5636502">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5636567">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5636635">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5636704">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5636774">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636819">n</span>&nbsp;<span class="op" id="5636821">:=</span>&nbsp;<span class="num" id="5636824">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5636827">for</span>&nbsp;<span class="op" id="5636831">(</span><span class="ident" id="5636832">bz2</span><span class="op" id="5636835">.</span><span class="ident" id="5636836">repeats</span>&nbsp;<span class="op" id="5636844">&gt;</span>&nbsp;<span class="num" id="5636846">0</span>&nbsp;<span class="op" id="5636848">||</span>&nbsp;<span class="ident" id="5636851">bz2</span><span class="op" id="5636854">.</span><span class="ident" id="5636855">preRLEUsed</span>&nbsp;<span class="op" id="5636866">&lt;</span>&nbsp;<span class="builtinfunc" id="5636868">len</span><span class="op" id="5636871">(</span><span class="ident" id="5636872">bz2</span><span class="op" id="5636875">.</span><span class="ident" id="5636876">preRLE</span><span class="op" id="5636882">)</span><span class="op" id="5636883">)</span>&nbsp;<span class="op" id="5636885">&amp;&amp;</span>&nbsp;<span class="ident" id="5636888">n</span>&nbsp;<span class="op" id="5636890">&lt;</span>&nbsp;<span class="builtinfunc" id="5636892">len</span><span class="op" id="5636895">(</span><span class="ident" id="5636896">buf</span><span class="op" id="5636899">)</span>&nbsp;<span class="op" id="5636901">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5636905">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5636937">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5636983">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5637045">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5637108">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5637174">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5637235">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637249">if</span>&nbsp;<span class="ident" id="5637252">bz2</span><span class="op" id="5637255">.</span><span class="ident" id="5637256">repeats</span>&nbsp;<span class="op" id="5637264">&gt;</span>&nbsp;<span class="num" id="5637266">0</span>&nbsp;<span class="op" id="5637268">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637273">buf</span><span class="op" id="5637276">[</span><span class="ident" id="5637277">n</span><span class="op" id="5637278">]</span>&nbsp;<span class="op" id="5637280">=</span>&nbsp;<span class="builtintype" id="5637282">byte</span><span class="op" id="5637286">(</span><span class="ident" id="5637287">bz2</span><span class="op" id="5637290">.</span><span class="ident" id="5637291">lastByte</span><span class="op" id="5637299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637304">n</span><span class="op" id="5637305">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637311">bz2</span><span class="op" id="5637314">.</span><span class="ident" id="5637315">repeats</span><span class="op" id="5637322">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637328">if</span>&nbsp;<span class="ident" id="5637331">bz2</span><span class="op" id="5637334">.</span><span class="ident" id="5637335">repeats</span>&nbsp;<span class="op" id="5637343">==</span>&nbsp;<span class="num" id="5637346">0</span>&nbsp;<span class="op" id="5637348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637354">bz2</span><span class="op" id="5637357">.</span><span class="ident" id="5637358">lastByte</span>&nbsp;<span class="op" id="5637367">=</span>&nbsp;<span class="op" id="5637369">-</span><span class="num" id="5637370">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637380">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637396">bz2</span><span class="op" id="5637399">.</span><span class="ident" id="5637400">tPos</span>&nbsp;<span class="op" id="5637405">=</span>&nbsp;<span class="ident" id="5637407">bz2</span><span class="op" id="5637410">.</span><span class="ident" id="5637411">preRLE</span><span class="op" id="5637417">[</span><span class="ident" id="5637418">bz2</span><span class="op" id="5637421">.</span><span class="ident" id="5637422">tPos</span><span class="op" id="5637426">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637430">b</span>&nbsp;<span class="op" id="5637432">:=</span>&nbsp;<span class="builtintype" id="5637435">byte</span><span class="op" id="5637439">(</span><span class="ident" id="5637440">bz2</span><span class="op" id="5637443">.</span><span class="ident" id="5637444">tPos</span><span class="op" id="5637448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637452">bz2</span><span class="op" id="5637455">.</span><span class="ident" id="5637456">tPos</span>&nbsp;<span class="op" id="5637461">&gt;&gt;=</span>&nbsp;<span class="num" id="5637465">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637469">bz2</span><span class="op" id="5637472">.</span><span class="ident" id="5637473">preRLEUsed</span><span class="op" id="5637483">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637489">if</span>&nbsp;<span class="ident" id="5637492">bz2</span><span class="op" id="5637495">.</span><span class="ident" id="5637496">byteRepeats</span>&nbsp;<span class="op" id="5637508">==</span>&nbsp;<span class="num" id="5637511">3</span>&nbsp;<span class="op" id="5637513">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637518">bz2</span><span class="op" id="5637521">.</span><span class="ident" id="5637522">repeats</span>&nbsp;<span class="op" id="5637530">=</span>&nbsp;<span class="builtintype" id="5637532">uint</span><span class="op" id="5637536">(</span><span class="ident" id="5637537">b</span><span class="op" id="5637538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637543">bz2</span><span class="op" id="5637546">.</span><span class="ident" id="5637547">byteRepeats</span>&nbsp;<span class="op" id="5637559">=</span>&nbsp;<span class="num" id="5637561">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637566">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637582">if</span>&nbsp;<span class="ident" id="5637585">bz2</span><span class="op" id="5637588">.</span><span class="ident" id="5637589">lastByte</span>&nbsp;<span class="op" id="5637598">==</span>&nbsp;<span class="builtintype" id="5637601">int</span><span class="op" id="5637604">(</span><span class="ident" id="5637605">b</span><span class="op" id="5637606">)</span>&nbsp;<span class="op" id="5637608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637613">bz2</span><span class="op" id="5637616">.</span><span class="ident" id="5637617">byteRepeats</span><span class="op" id="5637628">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637633">}</span>&nbsp;<span class="keyword" id="5637635">else</span>&nbsp;<span class="op" id="5637640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637645">bz2</span><span class="op" id="5637648">.</span><span class="ident" id="5637649">byteRepeats</span>&nbsp;<span class="op" id="5637661">=</span>&nbsp;<span class="num" id="5637663">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637667">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637671">bz2</span><span class="op" id="5637674">.</span><span class="ident" id="5637675">lastByte</span>&nbsp;<span class="op" id="5637684">=</span>&nbsp;<span class="builtintype" id="5637686">int</span><span class="op" id="5637689">(</span><span class="ident" id="5637690">b</span><span class="op" id="5637691">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637696">buf</span><span class="op" id="5637699">[</span><span class="ident" id="5637700">n</span><span class="op" id="5637701">]</span>&nbsp;<span class="op" id="5637703">=</span>&nbsp;<span class="ident" id="5637705">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637709">n</span><span class="op" id="5637710">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637714">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637718">return</span>&nbsp;<span class="ident" id="5637725">n</span><br>
<span class="lineno"></span><span class="op" id="5637727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5637730">func</span>&nbsp;<span class="op" id="5637735">(</span><span class="ident" id="5637736">bz2</span>&nbsp;<span class="op" id="5637740">*</span><span class="ident" id="5637741">reader</span><span class="op" id="5637747">)</span>&nbsp;<span class="ident" id="5637749">read</span><span class="op" id="5637753">(</span><span class="ident" id="5637754">buf</span>&nbsp;<span class="op" id="5637758">[</span><span class="op" id="5637759">]</span><span class="builtintype" id="5637760">byte</span><span class="op" id="5637764">)</span>&nbsp;<span class="op" id="5637766">(</span><span class="builtintype" id="5637767">int</span><span class="op" id="5637770">,</span>&nbsp;<span class="builtintype" id="5637772">error</span><span class="op" id="5637777">)</span>&nbsp;<span class="op" id="5637779">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637782">for</span>&nbsp;<span class="op" id="5637786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637790">n</span>&nbsp;<span class="op" id="5637792">:=</span>&nbsp;<span class="ident" id="5637795">bz2</span><span class="op" id="5637798">.</span><span class="ident" id="5637799">readFromBlock</span><span class="op" id="5637812">(</span><span class="ident" id="5637813">buf</span><span class="op" id="5637816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637820">if</span>&nbsp;<span class="ident" id="5637823">n</span>&nbsp;<span class="op" id="5637825">&gt;</span>&nbsp;<span class="num" id="5637827">0</span>&nbsp;<span class="op" id="5637829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637834">bz2</span><span class="op" id="5637837">.</span><span class="ident" id="5637838">blockCRC</span>&nbsp;<span class="op" id="5637847">=</span>&nbsp;<span class="ident" id="5637849">updateCRC</span><span class="op" id="5637858">(</span><span class="ident" id="5637859">bz2</span><span class="op" id="5637862">.</span><span class="ident" id="5637863">blockCRC</span><span class="op" id="5637871">,</span>&nbsp;<span class="ident" id="5637873">buf</span><span class="op" id="5637876">[</span><span class="op" id="5637877">:</span><span class="ident" id="5637878">n</span><span class="op" id="5637879">]</span><span class="op" id="5637880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637885">return</span>&nbsp;<span class="ident" id="5637892">n</span><span class="op" id="5637893">,</span>&nbsp;<span class="builtintype" id="5637895">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5637906">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637936">if</span>&nbsp;<span class="ident" id="5637939">bz2</span><span class="op" id="5637942">.</span><span class="ident" id="5637943">blockCRC</span>&nbsp;<span class="op" id="5637952">!=</span>&nbsp;<span class="ident" id="5637955">bz2</span><span class="op" id="5637958">.</span><span class="ident" id="5637959">wantBlockCRC</span>&nbsp;<span class="op" id="5637972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637977">bz2</span><span class="op" id="5637980">.</span><span class="ident" id="5637981">br</span><span class="op" id="5637983">.</span><span class="ident" id="5637984">err</span>&nbsp;<span class="op" id="5637988">=</span>&nbsp;<span class="ident" id="5637990">StructuralError</span><span class="op" id="5638005">(</span><span class="string" id="5638006">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5638031">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638036">return</span>&nbsp;<span class="num" id="5638043">0</span><span class="op" id="5638044">,</span>&nbsp;<span class="ident" id="5638046">bz2</span><span class="op" id="5638049">.</span><span class="ident" id="5638050">br</span><span class="op" id="5638052">.</span><span class="ident" id="5638053">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5638064">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638086">br</span>&nbsp;<span class="op" id="5638089">:=</span>&nbsp;<span class="op" id="5638092">&amp;</span><span class="ident" id="5638093">bz2</span><span class="op" id="5638096">.</span><span class="ident" id="5638097">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638102">switch</span>&nbsp;<span class="ident" id="5638109">br</span><span class="op" id="5638111">.</span><span class="ident" id="5638112">ReadBits64</span><span class="op" id="5638122">(</span><span class="num" id="5638123">48</span><span class="op" id="5638125">)</span>&nbsp;<span class="op" id="5638127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638131">default</span><span class="op" id="5638138">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638143">return</span>&nbsp;<span class="num" id="5638150">0</span><span class="op" id="5638151">,</span>&nbsp;<span class="ident" id="5638153">StructuralError</span><span class="op" id="5638168">(</span><span class="string" id="5638169">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="5638192">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638197">case</span>&nbsp;<span class="ident" id="5638202">bzip2BlockMagic</span><span class="op" id="5638217">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5638222">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638244">err</span>&nbsp;<span class="op" id="5638248">:=</span>&nbsp;<span class="ident" id="5638251">bz2</span><span class="op" id="5638254">.</span><span class="ident" id="5638255">readBlock</span><span class="op" id="5638264">(</span><span class="op" id="5638265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638270">if</span>&nbsp;<span class="ident" id="5638273">err</span>&nbsp;<span class="op" id="5638277">!=</span>&nbsp;<span class="builtintype" id="5638280">nil</span>&nbsp;<span class="op" id="5638284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638290">return</span>&nbsp;<span class="num" id="5638297">0</span><span class="op" id="5638298">,</span>&nbsp;<span class="ident" id="5638300">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638307">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638312">case</span>&nbsp;<span class="ident" id="5638317">bzip2FinalMagic</span><span class="op" id="5638332">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5638337">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638366">wantFileCRC</span>&nbsp;<span class="op" id="5638378">:=</span>&nbsp;<span class="builtintype" id="5638381">uint32</span><span class="op" id="5638387">(</span><span class="ident" id="5638388">br</span><span class="op" id="5638390">.</span><span class="ident" id="5638391">ReadBits64</span><span class="op" id="5638401">(</span><span class="num" id="5638402">32</span><span class="op" id="5638404">)</span><span class="op" id="5638405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638410">if</span>&nbsp;<span class="ident" id="5638413">br</span><span class="op" id="5638415">.</span><span class="ident" id="5638416">err</span>&nbsp;<span class="op" id="5638420">!=</span>&nbsp;<span class="builtintype" id="5638423">nil</span>&nbsp;<span class="op" id="5638427">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638433">return</span>&nbsp;<span class="num" id="5638440">0</span><span class="op" id="5638441">,</span>&nbsp;<span class="ident" id="5638443">br</span><span class="op" id="5638445">.</span><span class="ident" id="5638446">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638458">if</span>&nbsp;<span class="ident" id="5638461">bz2</span><span class="op" id="5638464">.</span><span class="ident" id="5638465">fileCRC</span>&nbsp;<span class="op" id="5638473">!=</span>&nbsp;<span class="ident" id="5638476">wantFileCRC</span>&nbsp;<span class="op" id="5638488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638494">br</span><span class="op" id="5638496">.</span><span class="ident" id="5638497">err</span>&nbsp;<span class="op" id="5638501">=</span>&nbsp;<span class="ident" id="5638503">StructuralError</span><span class="op" id="5638518">(</span><span class="string" id="5638519">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5638543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638549">return</span>&nbsp;<span class="num" id="5638556">0</span><span class="op" id="5638557">,</span>&nbsp;<span class="ident" id="5638559">br</span><span class="op" id="5638561">.</span><span class="ident" id="5638562">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5638575">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5638610">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5638658">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638688">if</span>&nbsp;<span class="ident" id="5638691">br</span><span class="op" id="5638693">.</span><span class="ident" id="5638694">bits</span><span class="op" id="5638698">%</span><span class="num" id="5638699">8</span>&nbsp;<span class="op" id="5638701">!=</span>&nbsp;<span class="num" id="5638704">0</span>&nbsp;<span class="op" id="5638706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638712">br</span><span class="op" id="5638714">.</span><span class="ident" id="5638715">ReadBits</span><span class="op" id="5638723">(</span><span class="ident" id="5638724">br</span><span class="op" id="5638726">.</span><span class="ident" id="5638727">bits</span>&nbsp;<span class="op" id="5638732">%</span>&nbsp;<span class="num" id="5638734">8</span><span class="op" id="5638735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638745">b</span><span class="op" id="5638746">,</span>&nbsp;<span class="ident" id="5638748">err</span>&nbsp;<span class="op" id="5638752">:=</span>&nbsp;<span class="ident" id="5638755">br</span><span class="op" id="5638757">.</span><span class="ident" id="5638758">r</span><span class="op" id="5638759">.</span><span class="ident" id="5638760">ReadByte</span><span class="op" id="5638768">(</span><span class="op" id="5638769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638774">if</span>&nbsp;<span class="ident" id="5638777">err</span>&nbsp;<span class="op" id="5638781">==</span>&nbsp;<span class="ident" id="5638784">io</span><span class="op" id="5638786">.</span><span class="ident" id="5638787">EOF</span>&nbsp;<span class="op" id="5638791">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638797">br</span><span class="op" id="5638799">.</span><span class="ident" id="5638800">err</span>&nbsp;<span class="op" id="5638804">=</span>&nbsp;<span class="ident" id="5638806">io</span><span class="op" id="5638808">.</span><span class="ident" id="5638809">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638817">bz2</span><span class="op" id="5638820">.</span><span class="ident" id="5638821">eof</span>&nbsp;<span class="op" id="5638825">=</span>&nbsp;<span class="builtintype" id="5638827">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638836">return</span>&nbsp;<span class="num" id="5638843">0</span><span class="op" id="5638844">,</span>&nbsp;<span class="ident" id="5638846">io</span><span class="op" id="5638848">.</span><span class="ident" id="5638849">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638861">if</span>&nbsp;<span class="ident" id="5638864">err</span>&nbsp;<span class="op" id="5638868">!=</span>&nbsp;<span class="builtintype" id="5638871">nil</span>&nbsp;<span class="op" id="5638875">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638881">br</span><span class="op" id="5638883">.</span><span class="ident" id="5638884">err</span>&nbsp;<span class="op" id="5638888">=</span>&nbsp;<span class="ident" id="5638890">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638898">return</span>&nbsp;<span class="num" id="5638905">0</span><span class="op" id="5638906">,</span>&nbsp;<span class="ident" id="5638908">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638920">z</span><span class="op" id="5638921">,</span>&nbsp;<span class="ident" id="5638923">err</span>&nbsp;<span class="op" id="5638927">:=</span>&nbsp;<span class="ident" id="5638930">br</span><span class="op" id="5638932">.</span><span class="ident" id="5638933">r</span><span class="op" id="5638934">.</span><span class="ident" id="5638935">ReadByte</span><span class="op" id="5638943">(</span><span class="op" id="5638944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638949">if</span>&nbsp;<span class="ident" id="5638952">err</span>&nbsp;<span class="op" id="5638956">!=</span>&nbsp;<span class="builtintype" id="5638959">nil</span>&nbsp;<span class="op" id="5638963">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638969">if</span>&nbsp;<span class="ident" id="5638972">err</span>&nbsp;<span class="op" id="5638976">==</span>&nbsp;<span class="ident" id="5638979">io</span><span class="op" id="5638981">.</span><span class="ident" id="5638982">EOF</span>&nbsp;<span class="op" id="5638986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638993">err</span>&nbsp;<span class="op" id="5638997">=</span>&nbsp;<span class="ident" id="5638999">io</span><span class="op" id="5639001">.</span><span class="ident" id="5639002">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639029">br</span><span class="op" id="5639031">.</span><span class="ident" id="5639032">err</span>&nbsp;<span class="op" id="5639036">=</span>&nbsp;<span class="ident" id="5639038">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639046">return</span>&nbsp;<span class="num" id="5639053">0</span><span class="op" id="5639054">,</span>&nbsp;<span class="ident" id="5639056">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639068">if</span>&nbsp;<span class="ident" id="5639071">b</span>&nbsp;<span class="op" id="5639073">!=</span>&nbsp;<span class="string" id="5639076">&#39;B&#39;</span>&nbsp;<span class="op" id="5639080">||</span>&nbsp;<span class="ident" id="5639083">z</span>&nbsp;<span class="op" id="5639085">!=</span>&nbsp;<span class="string" id="5639088">&#39;Z&#39;</span>&nbsp;<span class="op" id="5639092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639098">return</span>&nbsp;<span class="num" id="5639105">0</span><span class="op" id="5639106">,</span>&nbsp;<span class="ident" id="5639108">StructuralError</span><span class="op" id="5639123">(</span><span class="string" id="5639124">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="5639162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639172">if</span>&nbsp;<span class="ident" id="5639175">err</span>&nbsp;<span class="op" id="5639179">:=</span>&nbsp;<span class="ident" id="5639182">bz2</span><span class="op" id="5639185">.</span><span class="ident" id="5639186">setup</span><span class="op" id="5639191">(</span><span class="builtintype" id="5639192">false</span><span class="op" id="5639197">)</span><span class="op" id="5639198">;</span>&nbsp;<span class="ident" id="5639200">err</span>&nbsp;<span class="op" id="5639204">!=</span>&nbsp;<span class="builtintype" id="5639207">nil</span>&nbsp;<span class="op" id="5639211">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639217">return</span>&nbsp;<span class="num" id="5639224">0</span><span class="op" id="5639225">,</span>&nbsp;<span class="ident" id="5639227">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639241">}</span><br>
<span class="lineno"></span><span class="op" id="5639243">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="5639246">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="5639332">func</span>&nbsp;<span class="op" id="5639337">(</span><span class="ident" id="5639338">bz2</span>&nbsp;<span class="op" id="5639342">*</span><span class="ident" id="5639343">reader</span><span class="op" id="5639349">)</span>&nbsp;<span class="ident" id="5639351">readBlock</span><span class="op" id="5639360">(</span><span class="op" id="5639361">)</span>&nbsp;<span class="op" id="5639363">(</span><span class="ident" id="5639364">err</span>&nbsp;<span class="builtintype" id="5639368">error</span><span class="op" id="5639373">)</span>&nbsp;<span class="op" id="5639375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639378">br</span>&nbsp;<span class="op" id="5639381">:=</span>&nbsp;<span class="op" id="5639384">&amp;</span><span class="ident" id="5639385">bz2</span><span class="op" id="5639388">.</span><span class="ident" id="5639389">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639393">bz2</span><span class="op" id="5639396">.</span><span class="ident" id="5639397">wantBlockCRC</span>&nbsp;<span class="op" id="5639410">=</span>&nbsp;<span class="builtintype" id="5639412">uint32</span><span class="op" id="5639418">(</span><span class="ident" id="5639419">br</span><span class="op" id="5639421">.</span><span class="ident" id="5639422">ReadBits64</span><span class="op" id="5639432">(</span><span class="num" id="5639433">32</span><span class="op" id="5639435">)</span><span class="op" id="5639436">)</span>&nbsp;<span class="comment" id="5639438">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639505">bz2</span><span class="op" id="5639508">.</span><span class="ident" id="5639509">blockCRC</span>&nbsp;<span class="op" id="5639518">=</span>&nbsp;<span class="num" id="5639520">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639523">bz2</span><span class="op" id="5639526">.</span><span class="ident" id="5639527">fileCRC</span>&nbsp;<span class="op" id="5639535">=</span>&nbsp;<span class="op" id="5639537">(</span><span class="ident" id="5639538">bz2</span><span class="op" id="5639541">.</span><span class="ident" id="5639542">fileCRC</span><span class="op" id="5639549">&lt;&lt;</span><span class="num" id="5639551">1</span>&nbsp;<span class="op" id="5639553">|</span>&nbsp;<span class="ident" id="5639555">bz2</span><span class="op" id="5639558">.</span><span class="ident" id="5639559">fileCRC</span><span class="op" id="5639566">&gt;&gt;</span><span class="num" id="5639568">31</span><span class="op" id="5639570">)</span>&nbsp;<span class="op" id="5639572">^</span>&nbsp;<span class="ident" id="5639574">bz2</span><span class="op" id="5639577">.</span><span class="ident" id="5639578">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639592">randomized</span>&nbsp;<span class="op" id="5639603">:=</span>&nbsp;<span class="ident" id="5639606">br</span><span class="op" id="5639608">.</span><span class="ident" id="5639609">ReadBits</span><span class="op" id="5639617">(</span><span class="num" id="5639618">1</span><span class="op" id="5639619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639622">if</span>&nbsp;<span class="ident" id="5639625">randomized</span>&nbsp;<span class="op" id="5639636">!=</span>&nbsp;<span class="num" id="5639639">0</span>&nbsp;<span class="op" id="5639641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639645">return</span>&nbsp;<span class="ident" id="5639652">StructuralError</span><span class="op" id="5639667">(</span><span class="string" id="5639668">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="5639697">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639703">origPtr</span>&nbsp;<span class="op" id="5639711">:=</span>&nbsp;<span class="builtintype" id="5639714">uint</span><span class="op" id="5639718">(</span><span class="ident" id="5639719">br</span><span class="op" id="5639721">.</span><span class="ident" id="5639722">ReadBits</span><span class="op" id="5639730">(</span><span class="num" id="5639731">24</span><span class="op" id="5639733">)</span><span class="op" id="5639734">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5639738">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5639810">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5639874">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639903">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="5639925">:=</span>&nbsp;<span class="ident" id="5639928">br</span><span class="op" id="5639930">.</span><span class="ident" id="5639931">ReadBits</span><span class="op" id="5639939">(</span><span class="num" id="5639940">16</span><span class="op" id="5639942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639945">symbolPresent</span>&nbsp;<span class="op" id="5639959">:=</span>&nbsp;<span class="builtinfunc" id="5639962">make</span><span class="op" id="5639966">(</span><span class="op" id="5639967">[</span><span class="op" id="5639968">]</span><span class="builtintype" id="5639969">bool</span><span class="op" id="5639973">,</span>&nbsp;<span class="num" id="5639975">256</span><span class="op" id="5639978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639981">numSymbols</span>&nbsp;<span class="op" id="5639992">:=</span>&nbsp;<span class="num" id="5639995">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639998">for</span>&nbsp;<span class="ident" id="5640002">symRange</span>&nbsp;<span class="op" id="5640011">:=</span>&nbsp;<span class="builtintype" id="5640014">uint</span><span class="op" id="5640018">(</span><span class="num" id="5640019">0</span><span class="op" id="5640020">)</span><span class="op" id="5640021">;</span>&nbsp;<span class="ident" id="5640023">symRange</span>&nbsp;<span class="op" id="5640032">&lt;</span>&nbsp;<span class="num" id="5640034">16</span><span class="op" id="5640036">;</span>&nbsp;<span class="ident" id="5640038">symRange</span><span class="op" id="5640046">++</span>&nbsp;<span class="op" id="5640049">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640053">if</span>&nbsp;<span class="ident" id="5640056">symbolRangeUsedBitmap</span><span class="op" id="5640077">&amp;</span><span class="op" id="5640078">(</span><span class="num" id="5640079">1</span><span class="op" id="5640080">&lt;&lt;</span><span class="op" id="5640082">(</span><span class="num" id="5640083">15</span><span class="op" id="5640085">-</span><span class="ident" id="5640086">symRange</span><span class="op" id="5640094">)</span><span class="op" id="5640095">)</span>&nbsp;<span class="op" id="5640097">!=</span>&nbsp;<span class="num" id="5640100">0</span>&nbsp;<span class="op" id="5640102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640107">bits</span>&nbsp;<span class="op" id="5640112">:=</span>&nbsp;<span class="ident" id="5640115">br</span><span class="op" id="5640117">.</span><span class="ident" id="5640118">ReadBits</span><span class="op" id="5640126">(</span><span class="num" id="5640127">16</span><span class="op" id="5640129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640134">for</span>&nbsp;<span class="ident" id="5640138">symbol</span>&nbsp;<span class="op" id="5640145">:=</span>&nbsp;<span class="builtintype" id="5640148">uint</span><span class="op" id="5640152">(</span><span class="num" id="5640153">0</span><span class="op" id="5640154">)</span><span class="op" id="5640155">;</span>&nbsp;<span class="ident" id="5640157">symbol</span>&nbsp;<span class="op" id="5640164">&lt;</span>&nbsp;<span class="num" id="5640166">16</span><span class="op" id="5640168">;</span>&nbsp;<span class="ident" id="5640170">symbol</span><span class="op" id="5640176">++</span>&nbsp;<span class="op" id="5640179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640185">if</span>&nbsp;<span class="ident" id="5640188">bits</span><span class="op" id="5640192">&amp;</span><span class="op" id="5640193">(</span><span class="num" id="5640194">1</span><span class="op" id="5640195">&lt;&lt;</span><span class="op" id="5640197">(</span><span class="num" id="5640198">15</span><span class="op" id="5640200">-</span><span class="ident" id="5640201">symbol</span><span class="op" id="5640207">)</span><span class="op" id="5640208">)</span>&nbsp;<span class="op" id="5640210">!=</span>&nbsp;<span class="num" id="5640213">0</span>&nbsp;<span class="op" id="5640215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640222">symbolPresent</span><span class="op" id="5640235">[</span><span class="num" id="5640236">16</span><span class="op" id="5640238">*</span><span class="ident" id="5640239">symRange</span><span class="op" id="5640247">+</span><span class="ident" id="5640248">symbol</span><span class="op" id="5640254">]</span>&nbsp;<span class="op" id="5640256">=</span>&nbsp;<span class="builtintype" id="5640258">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640268">numSymbols</span><span class="op" id="5640278">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640297">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640301">if</span>&nbsp;<span class="ident" id="5640304">numSymbols</span>&nbsp;<span class="op" id="5640315">==</span>&nbsp;<span class="num" id="5640318">0</span>&nbsp;<span class="op" id="5640320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5640324">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640358">return</span>&nbsp;<span class="ident" id="5640365">StructuralError</span><span class="op" id="5640380">(</span><span class="string" id="5640381">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="5640402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640405">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5640409">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640471">numHuffmanTrees</span>&nbsp;<span class="op" id="5640487">:=</span>&nbsp;<span class="ident" id="5640490">br</span><span class="op" id="5640492">.</span><span class="ident" id="5640493">ReadBits</span><span class="op" id="5640501">(</span><span class="num" id="5640502">3</span><span class="op" id="5640503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640506">if</span>&nbsp;<span class="ident" id="5640509">numHuffmanTrees</span>&nbsp;<span class="op" id="5640525">&lt;</span>&nbsp;<span class="num" id="5640527">2</span>&nbsp;<span class="op" id="5640529">||</span>&nbsp;<span class="ident" id="5640532">numHuffmanTrees</span>&nbsp;<span class="op" id="5640548">&gt;</span>&nbsp;<span class="num" id="5640550">6</span>&nbsp;<span class="op" id="5640552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640556">return</span>&nbsp;<span class="ident" id="5640563">StructuralError</span><span class="op" id="5640578">(</span><span class="string" id="5640579">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="5640612">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5640619">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5640689">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640761">numSelectors</span>&nbsp;<span class="op" id="5640774">:=</span>&nbsp;<span class="ident" id="5640777">br</span><span class="op" id="5640779">.</span><span class="ident" id="5640780">ReadBits</span><span class="op" id="5640788">(</span><span class="num" id="5640789">15</span><span class="op" id="5640791">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640794">treeIndexes</span>&nbsp;<span class="op" id="5640806">:=</span>&nbsp;<span class="builtinfunc" id="5640809">make</span><span class="op" id="5640813">(</span><span class="op" id="5640814">[</span><span class="op" id="5640815">]</span><span class="builtintype" id="5640816">uint8</span><span class="op" id="5640821">,</span>&nbsp;<span class="ident" id="5640823">numSelectors</span><span class="op" id="5640835">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5640839">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5640910">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640923">mtfTreeDecoder</span>&nbsp;<span class="op" id="5640938">:=</span>&nbsp;<span class="ident" id="5640941">newMTFDecoderWithRange</span><span class="op" id="5640963">(</span><span class="ident" id="5640964">numHuffmanTrees</span><span class="op" id="5640979">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640982">for</span>&nbsp;<span class="ident" id="5640986">i</span>&nbsp;<span class="op" id="5640988">:=</span>&nbsp;<span class="keyword" id="5640991">range</span>&nbsp;<span class="ident" id="5640997">treeIndexes</span>&nbsp;<span class="op" id="5641009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641013">c</span>&nbsp;<span class="op" id="5641015">:=</span>&nbsp;<span class="num" id="5641018">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641022">for</span>&nbsp;<span class="op" id="5641026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641031">inc</span>&nbsp;<span class="op" id="5641035">:=</span>&nbsp;<span class="ident" id="5641038">br</span><span class="op" id="5641040">.</span><span class="ident" id="5641041">ReadBits</span><span class="op" id="5641049">(</span><span class="num" id="5641050">1</span><span class="op" id="5641051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641056">if</span>&nbsp;<span class="ident" id="5641059">inc</span>&nbsp;<span class="op" id="5641063">==</span>&nbsp;<span class="num" id="5641066">0</span>&nbsp;<span class="op" id="5641068">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641074">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641088">c</span><span class="op" id="5641089">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641098">if</span>&nbsp;<span class="ident" id="5641101">c</span>&nbsp;<span class="op" id="5641103">&gt;=</span>&nbsp;<span class="ident" id="5641106">numHuffmanTrees</span>&nbsp;<span class="op" id="5641122">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641127">return</span>&nbsp;<span class="ident" id="5641134">StructuralError</span><span class="op" id="5641149">(</span><span class="string" id="5641150">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="5641172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641180">treeIndexes</span><span class="op" id="5641191">[</span><span class="ident" id="5641192">i</span><span class="op" id="5641193">]</span>&nbsp;<span class="op" id="5641195">=</span>&nbsp;<span class="builtintype" id="5641197">uint8</span><span class="op" id="5641202">(</span><span class="ident" id="5641203">mtfTreeDecoder</span><span class="op" id="5641217">.</span><span class="ident" id="5641218">Decode</span><span class="op" id="5641224">(</span><span class="ident" id="5641225">c</span><span class="op" id="5641226">)</span><span class="op" id="5641227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5641234">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5641304">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641346">symbols</span>&nbsp;<span class="op" id="5641354">:=</span>&nbsp;<span class="builtinfunc" id="5641357">make</span><span class="op" id="5641361">(</span><span class="op" id="5641362">[</span><span class="op" id="5641363">]</span><span class="builtintype" id="5641364">byte</span><span class="op" id="5641368">,</span>&nbsp;<span class="ident" id="5641370">numSymbols</span><span class="op" id="5641380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641383">nextSymbol</span>&nbsp;<span class="op" id="5641394">:=</span>&nbsp;<span class="num" id="5641397">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641400">for</span>&nbsp;<span class="ident" id="5641404">i</span>&nbsp;<span class="op" id="5641406">:=</span>&nbsp;<span class="num" id="5641409">0</span><span class="op" id="5641410">;</span>&nbsp;<span class="ident" id="5641412">i</span>&nbsp;<span class="op" id="5641414">&lt;</span>&nbsp;<span class="num" id="5641416">256</span><span class="op" id="5641419">;</span>&nbsp;<span class="ident" id="5641421">i</span><span class="op" id="5641422">++</span>&nbsp;<span class="op" id="5641425">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641429">if</span>&nbsp;<span class="ident" id="5641432">symbolPresent</span><span class="op" id="5641445">[</span><span class="ident" id="5641446">i</span><span class="op" id="5641447">]</span>&nbsp;<span class="op" id="5641449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641454">symbols</span><span class="op" id="5641461">[</span><span class="ident" id="5641462">nextSymbol</span><span class="op" id="5641472">]</span>&nbsp;<span class="op" id="5641474">=</span>&nbsp;<span class="builtintype" id="5641476">byte</span><span class="op" id="5641480">(</span><span class="ident" id="5641481">i</span><span class="op" id="5641482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641487">nextSymbol</span><span class="op" id="5641497">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641505">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641508">mtf</span>&nbsp;<span class="op" id="5641512">:=</span>&nbsp;<span class="ident" id="5641515">newMTFDecoder</span><span class="op" id="5641528">(</span><span class="ident" id="5641529">symbols</span><span class="op" id="5641536">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641540">numSymbols</span>&nbsp;<span class="op" id="5641551">+=</span>&nbsp;<span class="num" id="5641554">2</span>&nbsp;<span class="comment" id="5641556">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641597">huffmanTrees</span>&nbsp;<span class="op" id="5641610">:=</span>&nbsp;<span class="builtinfunc" id="5641613">make</span><span class="op" id="5641617">(</span><span class="op" id="5641618">[</span><span class="op" id="5641619">]</span><span class="ident" id="5641620">huffmanTree</span><span class="op" id="5641631">,</span>&nbsp;<span class="ident" id="5641633">numHuffmanTrees</span><span class="op" id="5641648">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5641652">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641712">lengths</span>&nbsp;<span class="op" id="5641720">:=</span>&nbsp;<span class="builtinfunc" id="5641723">make</span><span class="op" id="5641727">(</span><span class="op" id="5641728">[</span><span class="op" id="5641729">]</span><span class="builtintype" id="5641730">uint8</span><span class="op" id="5641735">,</span>&nbsp;<span class="ident" id="5641737">numSymbols</span><span class="op" id="5641747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641750">for</span>&nbsp;<span class="ident" id="5641754">i</span>&nbsp;<span class="op" id="5641756">:=</span>&nbsp;<span class="keyword" id="5641759">range</span>&nbsp;<span class="ident" id="5641765">huffmanTrees</span>&nbsp;<span class="op" id="5641778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5641782">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641847">length</span>&nbsp;<span class="op" id="5641854">:=</span>&nbsp;<span class="ident" id="5641857">br</span><span class="op" id="5641859">.</span><span class="ident" id="5641860">ReadBits</span><span class="op" id="5641868">(</span><span class="num" id="5641869">5</span><span class="op" id="5641870">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641874">for</span>&nbsp;<span class="ident" id="5641878">j</span>&nbsp;<span class="op" id="5641880">:=</span>&nbsp;<span class="keyword" id="5641883">range</span>&nbsp;<span class="ident" id="5641889">lengths</span>&nbsp;<span class="op" id="5641897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641902">for</span>&nbsp;<span class="op" id="5641906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641912">if</span>&nbsp;<span class="op" id="5641915">!</span><span class="ident" id="5641916">br</span><span class="op" id="5641918">.</span><span class="ident" id="5641919">ReadBit</span><span class="op" id="5641926">(</span><span class="op" id="5641927">)</span>&nbsp;<span class="op" id="5641929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641936">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641946">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641952">if</span>&nbsp;<span class="ident" id="5641955">br</span><span class="op" id="5641957">.</span><span class="ident" id="5641958">ReadBit</span><span class="op" id="5641965">(</span><span class="op" id="5641966">)</span>&nbsp;<span class="op" id="5641968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641975">length</span><span class="op" id="5641981">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641988">}</span>&nbsp;<span class="keyword" id="5641990">else</span>&nbsp;<span class="op" id="5641995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642002">length</span><span class="op" id="5642008">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642015">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642025">if</span>&nbsp;<span class="ident" id="5642028">length</span>&nbsp;<span class="op" id="5642035">&lt;</span>&nbsp;<span class="num" id="5642037">0</span>&nbsp;<span class="op" id="5642039">||</span>&nbsp;<span class="ident" id="5642042">length</span>&nbsp;<span class="op" id="5642049">&gt;</span>&nbsp;<span class="num" id="5642051">20</span>&nbsp;<span class="op" id="5642054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642060">return</span>&nbsp;<span class="ident" id="5642067">StructuralError</span><span class="op" id="5642082">(</span><span class="string" id="5642083">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5642112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642122">lengths</span><span class="op" id="5642129">[</span><span class="ident" id="5642130">j</span><span class="op" id="5642131">]</span>&nbsp;<span class="op" id="5642133">=</span>&nbsp;<span class="builtintype" id="5642135">uint8</span><span class="op" id="5642140">(</span><span class="ident" id="5642141">length</span><span class="op" id="5642147">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642155">huffmanTrees</span><span class="op" id="5642167">[</span><span class="ident" id="5642168">i</span><span class="op" id="5642169">]</span><span class="op" id="5642170">,</span>&nbsp;<span class="ident" id="5642172">err</span>&nbsp;<span class="op" id="5642176">=</span>&nbsp;<span class="ident" id="5642178">newHuffmanTree</span><span class="op" id="5642192">(</span><span class="ident" id="5642193">lengths</span><span class="op" id="5642200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642204">if</span>&nbsp;<span class="ident" id="5642207">err</span>&nbsp;<span class="op" id="5642211">!=</span>&nbsp;<span class="builtintype" id="5642214">nil</span>&nbsp;<span class="op" id="5642218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642223">return</span>&nbsp;<span class="ident" id="5642230">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642236">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642243">selectorIndex</span>&nbsp;<span class="op" id="5642257">:=</span>&nbsp;<span class="num" id="5642260">1</span>&nbsp;<span class="comment" id="5642262">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642293">if</span>&nbsp;<span class="builtinfunc" id="5642296">len</span><span class="op" id="5642299">(</span><span class="ident" id="5642300">treeIndexes</span><span class="op" id="5642311">)</span>&nbsp;<span class="op" id="5642313">==</span>&nbsp;<span class="num" id="5642316">0</span>&nbsp;<span class="op" id="5642318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642322">return</span>&nbsp;<span class="ident" id="5642329">StructuralError</span><span class="op" id="5642344">(</span><span class="string" id="5642345">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="5642370">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642376">if</span>&nbsp;<span class="builtintype" id="5642379">int</span><span class="op" id="5642382">(</span><span class="ident" id="5642383">treeIndexes</span><span class="op" id="5642394">[</span><span class="num" id="5642395">0</span><span class="op" id="5642396">]</span><span class="op" id="5642397">)</span>&nbsp;<span class="op" id="5642399">&gt;=</span>&nbsp;<span class="builtinfunc" id="5642402">len</span><span class="op" id="5642405">(</span><span class="ident" id="5642406">huffmanTrees</span><span class="op" id="5642418">)</span>&nbsp;<span class="op" id="5642420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642424">return</span>&nbsp;<span class="ident" id="5642431">StructuralError</span><span class="op" id="5642446">(</span><span class="string" id="5642447">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5642475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642481">currentHuffmanTree</span>&nbsp;<span class="op" id="5642500">:=</span>&nbsp;<span class="ident" id="5642503">huffmanTrees</span><span class="op" id="5642515">[</span><span class="ident" id="5642516">treeIndexes</span><span class="op" id="5642527">[</span><span class="num" id="5642528">0</span><span class="op" id="5642529">]</span><span class="op" id="5642530">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642533">bufIndex</span>&nbsp;<span class="op" id="5642542">:=</span>&nbsp;<span class="num" id="5642545">0</span>&nbsp;<span class="comment" id="5642547">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5642587">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5642659">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5642726">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5642796">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642809">repeat</span>&nbsp;<span class="op" id="5642816">:=</span>&nbsp;<span class="num" id="5642819">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642822">repeat_power</span>&nbsp;<span class="op" id="5642835">:=</span>&nbsp;<span class="num" id="5642838">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5642842">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642916">for</span>&nbsp;<span class="ident" id="5642920">i</span>&nbsp;<span class="op" id="5642922">:=</span>&nbsp;<span class="keyword" id="5642925">range</span>&nbsp;<span class="ident" id="5642931">bz2</span><span class="op" id="5642934">.</span><span class="ident" id="5642935">c</span>&nbsp;<span class="op" id="5642937">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642941">bz2</span><span class="op" id="5642944">.</span><span class="ident" id="5642945">c</span><span class="op" id="5642946">[</span><span class="ident" id="5642947">i</span><span class="op" id="5642948">]</span>&nbsp;<span class="op" id="5642950">=</span>&nbsp;<span class="num" id="5642952">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642959">decoded</span>&nbsp;<span class="op" id="5642967">:=</span>&nbsp;<span class="num" id="5642970">0</span>&nbsp;<span class="comment" id="5642972">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643034">for</span>&nbsp;<span class="op" id="5643038">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643042">if</span>&nbsp;<span class="ident" id="5643045">decoded</span>&nbsp;<span class="op" id="5643053">==</span>&nbsp;<span class="num" id="5643056">50</span>&nbsp;<span class="op" id="5643059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643064">if</span>&nbsp;<span class="ident" id="5643067">selectorIndex</span>&nbsp;<span class="op" id="5643081">&gt;=</span>&nbsp;<span class="ident" id="5643084">numSelectors</span>&nbsp;<span class="op" id="5643097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643103">return</span>&nbsp;<span class="ident" id="5643110">StructuralError</span><span class="op" id="5643125">(</span><span class="string" id="5643126">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="5643179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5643184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643189">if</span>&nbsp;<span class="builtintype" id="5643192">int</span><span class="op" id="5643195">(</span><span class="ident" id="5643196">treeIndexes</span><span class="op" id="5643207">[</span><span class="ident" id="5643208">selectorIndex</span><span class="op" id="5643221">]</span><span class="op" id="5643222">)</span>&nbsp;<span class="op" id="5643224">&gt;=</span>&nbsp;<span class="builtinfunc" id="5643227">len</span><span class="op" id="5643230">(</span><span class="ident" id="5643231">huffmanTrees</span><span class="op" id="5643243">)</span>&nbsp;<span class="op" id="5643245">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643251">return</span>&nbsp;<span class="ident" id="5643258">StructuralError</span><span class="op" id="5643273">(</span><span class="string" id="5643274">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5643302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5643307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643312">currentHuffmanTree</span>&nbsp;<span class="op" id="5643331">=</span>&nbsp;<span class="ident" id="5643333">huffmanTrees</span><span class="op" id="5643345">[</span><span class="ident" id="5643346">treeIndexes</span><span class="op" id="5643357">[</span><span class="ident" id="5643358">selectorIndex</span><span class="op" id="5643371">]</span><span class="op" id="5643372">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643377">selectorIndex</span><span class="op" id="5643390">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643396">decoded</span>&nbsp;<span class="op" id="5643404">=</span>&nbsp;<span class="num" id="5643406">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5643410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643415">v</span>&nbsp;<span class="op" id="5643417">:=</span>&nbsp;<span class="ident" id="5643420">currentHuffmanTree</span><span class="op" id="5643438">.</span><span class="ident" id="5643439">Decode</span><span class="op" id="5643445">(</span><span class="ident" id="5643446">br</span><span class="op" id="5643448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643452">decoded</span><span class="op" id="5643459">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643465">if</span>&nbsp;<span class="ident" id="5643468">v</span>&nbsp;<span class="op" id="5643470">&lt;</span>&nbsp;<span class="num" id="5643472">2</span>&nbsp;<span class="op" id="5643474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643479">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643525">if</span>&nbsp;<span class="ident" id="5643528">repeat</span>&nbsp;<span class="op" id="5643535">==</span>&nbsp;<span class="num" id="5643538">0</span>&nbsp;<span class="op" id="5643540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643546">repeat_power</span>&nbsp;<span class="op" id="5643559">=</span>&nbsp;<span class="num" id="5643561">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5643566">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643571">repeat</span>&nbsp;<span class="op" id="5643578">+=</span>&nbsp;<span class="ident" id="5643581">repeat_power</span>&nbsp;<span class="op" id="5643594">&lt;&lt;</span>&nbsp;<span class="ident" id="5643597">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643602">repeat_power</span>&nbsp;<span class="op" id="5643615">&lt;&lt;=</span>&nbsp;<span class="num" id="5643619">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643625">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643683">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643732">if</span>&nbsp;<span class="ident" id="5643735">repeat</span>&nbsp;<span class="op" id="5643742">&gt;</span>&nbsp;<span class="num" id="5643744">2</span><span class="op" id="5643745">*</span><span class="num" id="5643746">1024</span><span class="op" id="5643750">*</span><span class="num" id="5643751">1024</span>&nbsp;<span class="op" id="5643756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643762">return</span>&nbsp;<span class="ident" id="5643769">StructuralError</span><span class="op" id="5643784">(</span><span class="string" id="5643785">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="5643809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5643814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643819">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5643830">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643835">if</span>&nbsp;<span class="ident" id="5643838">repeat</span>&nbsp;<span class="op" id="5643845">&gt;</span>&nbsp;<span class="num" id="5643847">0</span>&nbsp;<span class="op" id="5643849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643854">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643912">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643952">if</span>&nbsp;<span class="ident" id="5643955">repeat</span>&nbsp;<span class="op" id="5643962">&gt;</span>&nbsp;<span class="ident" id="5643964">bz2</span><span class="op" id="5643967">.</span><span class="ident" id="5643968">blockSize</span><span class="op" id="5643977">-</span><span class="ident" id="5643978">bufIndex</span>&nbsp;<span class="op" id="5643987">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643993">return</span>&nbsp;<span class="ident" id="5644000">StructuralError</span><span class="op" id="5644015">(</span><span class="string" id="5644016">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="5644043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5644048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644053">for</span>&nbsp;<span class="ident" id="5644057">i</span>&nbsp;<span class="op" id="5644059">:=</span>&nbsp;<span class="num" id="5644062">0</span><span class="op" id="5644063">;</span>&nbsp;<span class="ident" id="5644065">i</span>&nbsp;<span class="op" id="5644067">&lt;</span>&nbsp;<span class="ident" id="5644069">repeat</span><span class="op" id="5644075">;</span>&nbsp;<span class="ident" id="5644077">i</span><span class="op" id="5644078">++</span>&nbsp;<span class="op" id="5644081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644087">b</span>&nbsp;<span class="op" id="5644089">:=</span>&nbsp;<span class="builtintype" id="5644092">byte</span><span class="op" id="5644096">(</span><span class="ident" id="5644097">mtf</span><span class="op" id="5644100">.</span><span class="ident" id="5644101">First</span><span class="op" id="5644106">(</span><span class="op" id="5644107">)</span><span class="op" id="5644108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644114">bz2</span><span class="op" id="5644117">.</span><span class="ident" id="5644118">tt</span><span class="op" id="5644120">[</span><span class="ident" id="5644121">bufIndex</span><span class="op" id="5644129">]</span>&nbsp;<span class="op" id="5644131">=</span>&nbsp;<span class="builtintype" id="5644133">uint32</span><span class="op" id="5644139">(</span><span class="ident" id="5644140">b</span><span class="op" id="5644141">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644147">bz2</span><span class="op" id="5644150">.</span><span class="ident" id="5644151">c</span><span class="op" id="5644152">[</span><span class="ident" id="5644153">b</span><span class="op" id="5644154">]</span><span class="op" id="5644155">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644162">bufIndex</span><span class="op" id="5644170">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5644176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644181">repeat</span>&nbsp;<span class="op" id="5644188">=</span>&nbsp;<span class="num" id="5644190">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5644194">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644199">if</span>&nbsp;<span class="builtintype" id="5644202">int</span><span class="op" id="5644205">(</span><span class="ident" id="5644206">v</span><span class="op" id="5644207">)</span>&nbsp;<span class="op" id="5644209">==</span>&nbsp;<span class="ident" id="5644212">numSymbols</span><span class="op" id="5644222">-</span><span class="num" id="5644223">1</span>&nbsp;<span class="op" id="5644225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644230">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644287">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644345">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644391">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5644399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644404">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644468">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644529">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644595">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644654">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644716">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644727">b</span>&nbsp;<span class="op" id="5644729">:=</span>&nbsp;<span class="builtintype" id="5644732">byte</span><span class="op" id="5644736">(</span><span class="ident" id="5644737">mtf</span><span class="op" id="5644740">.</span><span class="ident" id="5644741">Decode</span><span class="op" id="5644747">(</span><span class="builtintype" id="5644748">int</span><span class="op" id="5644751">(</span><span class="ident" id="5644752">v</span>&nbsp;<span class="op" id="5644754">-</span>&nbsp;<span class="num" id="5644756">1</span><span class="op" id="5644757">)</span><span class="op" id="5644758">)</span><span class="op" id="5644759">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644763">if</span>&nbsp;<span class="ident" id="5644766">bufIndex</span>&nbsp;<span class="op" id="5644775">&gt;=</span>&nbsp;<span class="ident" id="5644778">bz2</span><span class="op" id="5644781">.</span><span class="ident" id="5644782">blockSize</span>&nbsp;<span class="op" id="5644792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644797">return</span>&nbsp;<span class="ident" id="5644804">StructuralError</span><span class="op" id="5644819">(</span><span class="string" id="5644820">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="5644845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5644849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644853">bz2</span><span class="op" id="5644856">.</span><span class="ident" id="5644857">tt</span><span class="op" id="5644859">[</span><span class="ident" id="5644860">bufIndex</span><span class="op" id="5644868">]</span>&nbsp;<span class="op" id="5644870">=</span>&nbsp;<span class="builtintype" id="5644872">uint32</span><span class="op" id="5644878">(</span><span class="ident" id="5644879">b</span><span class="op" id="5644880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644884">bz2</span><span class="op" id="5644887">.</span><span class="ident" id="5644888">c</span><span class="op" id="5644889">[</span><span class="ident" id="5644890">b</span><span class="op" id="5644891">]</span><span class="op" id="5644892">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644897">bufIndex</span><span class="op" id="5644905">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5644909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644913">if</span>&nbsp;<span class="ident" id="5644916">origPtr</span>&nbsp;<span class="op" id="5644924">&gt;=</span>&nbsp;<span class="builtintype" id="5644927">uint</span><span class="op" id="5644931">(</span><span class="ident" id="5644932">bufIndex</span><span class="op" id="5644940">)</span>&nbsp;<span class="op" id="5644942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644946">return</span>&nbsp;<span class="ident" id="5644953">StructuralError</span><span class="op" id="5644968">(</span><span class="string" id="5644969">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="5644992">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5644995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644999">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5645066">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645108">bz2</span><span class="op" id="5645111">.</span><span class="ident" id="5645112">preRLE</span>&nbsp;<span class="op" id="5645119">=</span>&nbsp;<span class="ident" id="5645121">bz2</span><span class="op" id="5645124">.</span><span class="ident" id="5645125">tt</span><span class="op" id="5645127">[</span><span class="op" id="5645128">:</span><span class="ident" id="5645129">bufIndex</span><span class="op" id="5645137">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645140">bz2</span><span class="op" id="5645143">.</span><span class="ident" id="5645144">preRLEUsed</span>&nbsp;<span class="op" id="5645155">=</span>&nbsp;<span class="num" id="5645157">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645160">bz2</span><span class="op" id="5645163">.</span><span class="ident" id="5645164">tPos</span>&nbsp;<span class="op" id="5645169">=</span>&nbsp;<span class="ident" id="5645171">inverseBWT</span><span class="op" id="5645181">(</span><span class="ident" id="5645182">bz2</span><span class="op" id="5645185">.</span><span class="ident" id="5645186">preRLE</span><span class="op" id="5645192">,</span>&nbsp;<span class="ident" id="5645194">origPtr</span><span class="op" id="5645201">,</span>&nbsp;<span class="ident" id="5645203">bz2</span><span class="op" id="5645206">.</span><span class="ident" id="5645207">c</span><span class="op" id="5645208">[</span><span class="op" id="5645209">:</span><span class="op" id="5645210">]</span><span class="op" id="5645211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645214">bz2</span><span class="op" id="5645217">.</span><span class="ident" id="5645218">lastByte</span>&nbsp;<span class="op" id="5645227">=</span>&nbsp;<span class="op" id="5645229">-</span><span class="num" id="5645230">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645233">bz2</span><span class="op" id="5645236">.</span><span class="ident" id="5645237">byteRepeats</span>&nbsp;<span class="op" id="5645249">=</span>&nbsp;<span class="num" id="5645251">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645254">bz2</span><span class="op" id="5645257">.</span><span class="ident" id="5645258">repeats</span>&nbsp;<span class="op" id="5645266">=</span>&nbsp;<span class="num" id="5645268">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645272">return</span>&nbsp;<span class="builtintype" id="5645279">nil</span><br>
<span class="lineno"></span><span class="op" id="5645283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5645286">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="5645365">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="5645442">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5645518">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5645596">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="5645631">//</span><br>
<span class="lineno">455</span><span class="comment" id="5645634">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="5645711">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5645791">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5645868">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5645881">func</span>&nbsp;<span class="ident" id="5645886">inverseBWT</span><span class="op" id="5645896">(</span><span class="ident" id="5645897">tt</span>&nbsp;<span class="op" id="5645900">[</span><span class="op" id="5645901">]</span><span class="builtintype" id="5645902">uint32</span><span class="op" id="5645908">,</span>&nbsp;<span class="ident" id="5645910">origPtr</span>&nbsp;<span class="builtintype" id="5645918">uint</span><span class="op" id="5645922">,</span>&nbsp;<span class="ident" id="5645924">c</span>&nbsp;<span class="op" id="5645926">[</span><span class="op" id="5645927">]</span><span class="builtintype" id="5645928">uint</span><span class="op" id="5645932">)</span>&nbsp;<span class="builtintype" id="5645934">uint32</span>&nbsp;<span class="op" id="5645941">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645944">sum</span>&nbsp;<span class="op" id="5645948">:=</span>&nbsp;<span class="builtintype" id="5645951">uint</span><span class="op" id="5645955">(</span><span class="num" id="5645956">0</span><span class="op" id="5645957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645960">for</span>&nbsp;<span class="ident" id="5645964">i</span>&nbsp;<span class="op" id="5645966">:=</span>&nbsp;<span class="num" id="5645969">0</span><span class="op" id="5645970">;</span>&nbsp;<span class="ident" id="5645972">i</span>&nbsp;<span class="op" id="5645974">&lt;</span>&nbsp;<span class="num" id="5645976">256</span><span class="op" id="5645979">;</span>&nbsp;<span class="ident" id="5645981">i</span><span class="op" id="5645982">++</span>&nbsp;<span class="op" id="5645985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645989">sum</span>&nbsp;<span class="op" id="5645993">+=</span>&nbsp;<span class="ident" id="5645996">c</span><span class="op" id="5645997">[</span><span class="ident" id="5645998">i</span><span class="op" id="5645999">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646003">c</span><span class="op" id="5646004">[</span><span class="ident" id="5646005">i</span><span class="op" id="5646006">]</span>&nbsp;<span class="op" id="5646008">=</span>&nbsp;<span class="ident" id="5646010">sum</span>&nbsp;<span class="op" id="5646014">-</span>&nbsp;<span class="ident" id="5646016">c</span><span class="op" id="5646017">[</span><span class="ident" id="5646018">i</span><span class="op" id="5646019">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646022">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646026">for</span>&nbsp;<span class="ident" id="5646030">i</span>&nbsp;<span class="op" id="5646032">:=</span>&nbsp;<span class="keyword" id="5646035">range</span>&nbsp;<span class="ident" id="5646041">tt</span>&nbsp;<span class="op" id="5646044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646048">b</span>&nbsp;<span class="op" id="5646050">:=</span>&nbsp;<span class="ident" id="5646053">tt</span><span class="op" id="5646055">[</span><span class="ident" id="5646056">i</span><span class="op" id="5646057">]</span>&nbsp;<span class="op" id="5646059">&amp;</span>&nbsp;<span class="num" id="5646061">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646068">tt</span><span class="op" id="5646070">[</span><span class="ident" id="5646071">c</span><span class="op" id="5646072">[</span><span class="ident" id="5646073">b</span><span class="op" id="5646074">]</span><span class="op" id="5646075">]</span>&nbsp;<span class="op" id="5646077">|=</span>&nbsp;<span class="builtintype" id="5646080">uint32</span><span class="op" id="5646086">(</span><span class="ident" id="5646087">i</span><span class="op" id="5646088">)</span>&nbsp;<span class="op" id="5646090">&lt;&lt;</span>&nbsp;<span class="num" id="5646093">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646097">c</span><span class="op" id="5646098">[</span><span class="ident" id="5646099">b</span><span class="op" id="5646100">]</span><span class="op" id="5646101">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646109">return</span>&nbsp;<span class="ident" id="5646116">tt</span><span class="op" id="5646118">[</span><span class="ident" id="5646119">origPtr</span><span class="op" id="5646126">]</span>&nbsp;<span class="op" id="5646128">&gt;&gt;</span>&nbsp;<span class="num" id="5646131">8</span><br>
<span class="lineno"></span><span class="op" id="5646133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="5646136">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="5646224">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5646309">var</span>&nbsp;<span class="ident" id="5646313">crctab</span>&nbsp;<span class="op" id="5646320">[</span><span class="num" id="5646321">256</span><span class="op" id="5646324">]</span><span class="builtintype" id="5646325">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="5646333">func</span>&nbsp;<span class="ident" id="5646338">init</span><span class="op" id="5646342">(</span><span class="op" id="5646343">)</span>&nbsp;<span class="op" id="5646345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646348">const</span>&nbsp;<span class="ident" id="5646354">poly</span>&nbsp;<span class="op" id="5646359">=</span>&nbsp;<span class="num" id="5646361">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646373">for</span>&nbsp;<span class="ident" id="5646377">i</span>&nbsp;<span class="op" id="5646379">:=</span>&nbsp;<span class="keyword" id="5646382">range</span>&nbsp;<span class="ident" id="5646388">crctab</span>&nbsp;<span class="op" id="5646395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646399">crc</span>&nbsp;<span class="op" id="5646403">:=</span>&nbsp;<span class="builtintype" id="5646406">uint32</span><span class="op" id="5646412">(</span><span class="ident" id="5646413">i</span><span class="op" id="5646414">)</span>&nbsp;<span class="op" id="5646416">&lt;&lt;</span>&nbsp;<span class="num" id="5646419">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646424">for</span>&nbsp;<span class="ident" id="5646428">j</span>&nbsp;<span class="op" id="5646430">:=</span>&nbsp;<span class="num" id="5646433">0</span><span class="op" id="5646434">;</span>&nbsp;<span class="ident" id="5646436">j</span>&nbsp;<span class="op" id="5646438">&lt;</span>&nbsp;<span class="num" id="5646440">8</span><span class="op" id="5646441">;</span>&nbsp;<span class="ident" id="5646443">j</span><span class="op" id="5646444">++</span>&nbsp;<span class="op" id="5646447">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646452">if</span>&nbsp;<span class="ident" id="5646455">crc</span><span class="op" id="5646458">&amp;</span><span class="num" id="5646459">0x80000000</span>&nbsp;<span class="op" id="5646470">!=</span>&nbsp;<span class="num" id="5646473">0</span>&nbsp;<span class="op" id="5646475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646481">crc</span>&nbsp;<span class="op" id="5646485">=</span>&nbsp;<span class="op" id="5646487">(</span><span class="ident" id="5646488">crc</span>&nbsp;<span class="op" id="5646492">&lt;&lt;</span>&nbsp;<span class="num" id="5646495">1</span><span class="op" id="5646496">)</span>&nbsp;<span class="op" id="5646498">^</span>&nbsp;<span class="ident" id="5646500">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646508">}</span>&nbsp;<span class="keyword" id="5646510">else</span>&nbsp;<span class="op" id="5646515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646521">crc</span>&nbsp;<span class="op" id="5646525">&lt;&lt;=</span>&nbsp;<span class="num" id="5646529">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646534">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646542">crctab</span><span class="op" id="5646548">[</span><span class="ident" id="5646549">i</span><span class="op" id="5646550">]</span>&nbsp;<span class="op" id="5646552">=</span>&nbsp;<span class="ident" id="5646554">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646559">}</span><br>
<span class="lineno"></span><span class="op" id="5646561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="5646564">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="5646629">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="5646656">func</span>&nbsp;<span class="ident" id="5646661">updateCRC</span><span class="op" id="5646670">(</span><span class="ident" id="5646671">val</span>&nbsp;<span class="builtintype" id="5646675">uint32</span><span class="op" id="5646681">,</span>&nbsp;<span class="ident" id="5646683">b</span>&nbsp;<span class="op" id="5646685">[</span><span class="op" id="5646686">]</span><span class="builtintype" id="5646687">byte</span><span class="op" id="5646691">)</span>&nbsp;<span class="builtintype" id="5646693">uint32</span>&nbsp;<span class="op" id="5646700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646703">crc</span>&nbsp;<span class="op" id="5646707">:=</span>&nbsp;<span class="op" id="5646710">^</span><span class="ident" id="5646711">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646716">for</span>&nbsp;<span class="ident" id="5646720">_</span><span class="op" id="5646721">,</span>&nbsp;<span class="ident" id="5646723">v</span>&nbsp;<span class="op" id="5646725">:=</span>&nbsp;<span class="keyword" id="5646728">range</span>&nbsp;<span class="ident" id="5646734">b</span>&nbsp;<span class="op" id="5646736">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646740">crc</span>&nbsp;<span class="op" id="5646744">=</span>&nbsp;<span class="ident" id="5646746">crctab</span><span class="op" id="5646752">[</span><span class="builtintype" id="5646753">byte</span><span class="op" id="5646757">(</span><span class="ident" id="5646758">crc</span><span class="op" id="5646761">&gt;&gt;</span><span class="num" id="5646763">24</span><span class="op" id="5646765">)</span><span class="op" id="5646766">^</span><span class="ident" id="5646767">v</span><span class="op" id="5646768">]</span>&nbsp;<span class="op" id="5646770">^</span>&nbsp;<span class="op" id="5646772">(</span><span class="ident" id="5646773">crc</span>&nbsp;<span class="op" id="5646777">&lt;&lt;</span>&nbsp;<span class="num" id="5646780">8</span><span class="op" id="5646781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646787">return</span>&nbsp;<span class="op" id="5646794">^</span><span class="ident" id="5646795">crc</span><br>
<span class="lineno"></span><span class="op" id="5646799">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
