<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html" class="current">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3249234">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3249289">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3249343">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3249394">package</span>&nbsp;<span class="ident" id="3249402">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3249407">import</span>&nbsp;<span class="string" id="3249414">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3249429">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="3249483">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="3249539">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="3249578">type</span>&nbsp;<span class="ident" id="3249583">fdMutex</span>&nbsp;<span class="keyword" id="3249591">struct</span>&nbsp;<span class="op" id="3249598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3249601">state</span>&nbsp;<span class="builtintype" id="3249607">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3249615">rsema</span>&nbsp;<span class="builtintype" id="3249621">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3249629">wsema</span>&nbsp;<span class="builtintype" id="3249635">uint32</span><br>
<span class="lineno"></span><span class="op" id="3249642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3249645">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="3249687">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="3249772">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3249809">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3249847">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="3249906">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="3249955">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="3250005">const</span>&nbsp;<span class="op" id="3250011">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250014">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="3250027">=</span>&nbsp;<span class="num" id="3250029">1</span>&nbsp;<span class="op" id="3250031">&lt;&lt;</span>&nbsp;<span class="num" id="3250034">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250037">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3250050">=</span>&nbsp;<span class="num" id="3250052">1</span>&nbsp;<span class="op" id="3250054">&lt;&lt;</span>&nbsp;<span class="num" id="3250057">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250060">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3250073">=</span>&nbsp;<span class="num" id="3250075">1</span>&nbsp;<span class="op" id="3250077">&lt;&lt;</span>&nbsp;<span class="num" id="3250080">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250083">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250096">=</span>&nbsp;<span class="num" id="3250098">1</span>&nbsp;<span class="op" id="3250100">&lt;&lt;</span>&nbsp;<span class="num" id="3250103">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250106">mutexRefMask</span>&nbsp;<span class="op" id="3250119">=</span>&nbsp;<span class="op" id="3250121">(</span><span class="num" id="3250122">1</span><span class="op" id="3250123">&lt;&lt;</span><span class="num" id="3250125">20</span>&nbsp;<span class="op" id="3250128">-</span>&nbsp;<span class="num" id="3250130">1</span><span class="op" id="3250131">)</span>&nbsp;<span class="op" id="3250133">&lt;&lt;</span>&nbsp;<span class="num" id="3250136">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250139">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3250152">=</span>&nbsp;<span class="num" id="3250154">1</span>&nbsp;<span class="op" id="3250156">&lt;&lt;</span>&nbsp;<span class="num" id="3250159">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250163">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3250176">=</span>&nbsp;<span class="op" id="3250178">(</span><span class="num" id="3250179">1</span><span class="op" id="3250180">&lt;&lt;</span><span class="num" id="3250182">20</span>&nbsp;<span class="op" id="3250185">-</span>&nbsp;<span class="num" id="3250187">1</span><span class="op" id="3250188">)</span>&nbsp;<span class="op" id="3250190">&lt;&lt;</span>&nbsp;<span class="num" id="3250193">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250197">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3250210">=</span>&nbsp;<span class="num" id="3250212">1</span>&nbsp;<span class="op" id="3250214">&lt;&lt;</span>&nbsp;<span class="num" id="3250217">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250221">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3250234">=</span>&nbsp;<span class="op" id="3250236">(</span><span class="num" id="3250237">1</span><span class="op" id="3250238">&lt;&lt;</span><span class="num" id="3250240">20</span>&nbsp;<span class="op" id="3250243">-</span>&nbsp;<span class="num" id="3250245">1</span><span class="op" id="3250246">)</span>&nbsp;<span class="op" id="3250248">&lt;&lt;</span>&nbsp;<span class="num" id="3250251">43</span><br>
<span class="lineno">35</span><span class="op" id="3250254">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3250257">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="3250313">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="3250372">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="3250453">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3250530">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="3250603">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="3250653">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3250704">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="3250748">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3250835">func</span>&nbsp;<span class="op" id="3250840">(</span><span class="ident" id="3250841">mu</span>&nbsp;<span class="op" id="3250844">*</span><span class="ident" id="3250845"><a href="/gostd/net/fd_mutex.go.html#3249583">fdMutex</a></span><span class="op" id="3250852">)</span>&nbsp;<span class="ident" id="3250854">Incref</span><span class="op" id="3250860">(</span><span class="op" id="3250861">)</span>&nbsp;<span class="builtintype" id="3250863">bool</span>&nbsp;<span class="op" id="3250868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250871">for</span>&nbsp;<span class="op" id="3250875">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250879">old</span>&nbsp;<span class="op" id="3250883">:=</span>&nbsp;<span class="ident" id="3250886"><a href="/gostd/net/fd_mutex.go.html#3249414">atomic</a></span><span class="op" id="3250892">.</span><span class="ident" id="3250893"><a href="/gostd/sync/atomic/doc.go.html#1468085">LoadUint64</a></span><span class="op" id="3250903">(</span><span class="op" id="3250904">&amp;</span><span class="ident" id="3250905"><a href="/gostd/net/fd_mutex.go.html#3250841">mu</a></span><span class="op" id="3250907">.</span><span class="ident" id="3250908"><a href="/gostd/net/fd_mutex.go.html#3249601">state</a></span><span class="op" id="3250913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250917">if</span>&nbsp;<span class="ident" id="3250920"><a href="/gostd/net/fd_mutex.go.html#3250879">old</a></span><span class="op" id="3250923">&amp;</span><span class="ident" id="3250924"><a href="/gostd/net/fd_mutex.go.html#3250014">mutexClosed</a></span>&nbsp;<span class="op" id="3250936">!=</span>&nbsp;<span class="num" id="3250939">0</span>&nbsp;<span class="op" id="3250941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250946">return</span>&nbsp;<span class="builtintype" id="3250953">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3250965">new</span>&nbsp;<span class="op" id="3250969">:=</span>&nbsp;<span class="ident" id="3250972"><a href="/gostd/net/fd_mutex.go.html#3250879">old</a></span>&nbsp;<span class="op" id="3250976">+</span>&nbsp;<span class="ident" id="3250978"><a href="/gostd/net/fd_mutex.go.html#3250083">mutexRef</a></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250989">if</span>&nbsp;<span class="builtinfunc" id="3250992"><a href="/gostd/net/fd_mutex.go.html#3250965">new</a></span><span class="op" id="3250995">&amp;</span><span class="ident" id="3250996"><a href="/gostd/net/fd_mutex.go.html#3250106">mutexRefMask</a></span>&nbsp;<span class="op" id="3251009">==</span>&nbsp;<span class="num" id="3251012">0</span>&nbsp;<span class="op" id="3251014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3251019">panic</span><span class="op" id="3251024">(</span><span class="string" id="3251025">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3251052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251060">if</span>&nbsp;<span class="ident" id="3251063"><a href="/gostd/net/fd_mutex.go.html#3249414">atomic</a></span><span class="op" id="3251069">.</span><span class="ident" id="3251070"><a href="/gostd/sync/atomic/doc.go.html#1466448">CompareAndSwapUint64</a></span><span class="op" id="3251090">(</span><span class="op" id="3251091">&amp;</span><span class="ident" id="3251092"><a href="/gostd/net/fd_mutex.go.html#3250841">mu</a></span><span class="op" id="3251094">.</span><span class="ident" id="3251095"><a href="/gostd/net/fd_mutex.go.html#3249601">state</a></span><span class="op" id="3251100">,</span>&nbsp;<span class="ident" id="3251102"><a href="/gostd/net/fd_mutex.go.html#3250879">old</a></span><span class="op" id="3251105">,</span>&nbsp;<span class="builtinfunc" id="3251107"><a href="/gostd/net/fd_mutex.go.html#3250965">new</a></span><span class="op" id="3251110">)</span>&nbsp;<span class="op" id="3251112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251117">return</span>&nbsp;<span class="builtintype" id="3251124">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251134">}</span><br>
<span class="lineno"></span><span class="op" id="3251136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3251139">func</span>&nbsp;<span class="op" id="3251144">(</span><span class="ident" id="3251145">mu</span>&nbsp;<span class="op" id="3251148">*</span><span class="ident" id="3251149"><a href="/gostd/net/fd_mutex.go.html#3249583">fdMutex</a></span><span class="op" id="3251156">)</span>&nbsp;<span class="ident" id="3251158">IncrefAndClose</span><span class="op" id="3251172">(</span><span class="op" id="3251173">)</span>&nbsp;<span class="builtintype" id="3251175">bool</span>&nbsp;<span class="op" id="3251180">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251183">for</span>&nbsp;<span class="op" id="3251187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3251191">old</span>&nbsp;<span class="op" id="3251195">:=</span>&nbsp;<span class="ident" id="3251198"><a href="/gostd/net/fd_mutex.go.html#3249414">atomic</a></span><span class="op" id="3251204">.</span><span class="ident" id="3251205"><a href="/gostd/sync/atomic/doc.go.html#1468085">LoadUint64</a></span><span class="op" id="3251215">(</span><span class="op" id="3251216">&amp;</span><span class="ident" id="3251217"><a href="/gostd/net/fd_mutex.go.html#3251145">mu</a></span><span class="op" id="3251219">.</span><span class="ident" id="3251220"><a href="/gostd/net/fd_mutex.go.html#3249601">state</a></span><span class="op" id="3251225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251229">if</span>&nbsp;<span class="ident" id="3251232"><a href="/gostd/net/fd_mutex.go.html#3251191">old</a></span><span class="op" id="3251235">&amp;</span><span class="ident" id="3251236"><a href="/gostd/net/fd_mutex.go.html#3250014">mutexClosed</a></span>&nbsp;<span class="op" id="3251248">!=</span>&nbsp;<span class="num" id="3251251">0</span>&nbsp;<span class="op" id="3251253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251258">return</span>&nbsp;<span class="builtintype" id="3251265">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251273">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3251277">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3251322">new</span>&nbsp;<span class="op" id="3251326">:=</span>&nbsp;<span class="op" id="3251329">(</span><span class="ident" id="3251330"><a href="/gostd/net/fd_mutex.go.html#3251191">old</a></span>&nbsp;<span class="op" id="3251334">|</span>&nbsp;<span class="ident" id="3251336"><a href="/gostd/net/fd_mutex.go.html#3250014">mutexClosed</a></span><span class="op" id="3251347">)</span>&nbsp;<span class="op" id="3251349">+</span>&nbsp;<span class="ident" id="3251351"><a href="/gostd/net/fd_mutex.go.html#3250083">mutexRef</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251362">if</span>&nbsp;<span class="builtinfunc" id="3251365"><a href="/gostd/net/fd_mutex.go.html#3251322">new</a></span><span class="op" id="3251368">&amp;</span><span class="ident" id="3251369"><a href="/gostd/net/fd_mutex.go.html#3250106">mutexRefMask</a></span>&nbsp;<span class="op" id="3251382">==</span>&nbsp;<span class="num" id="3251385">0</span>&nbsp;<span class="op" id="3251387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3251392">panic</span><span class="op" id="3251397">(</span><span class="string" id="3251398">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3251425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251429">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3251433">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3251473"><a href="/gostd/net/fd_mutex.go.html#3251322">new</a></span>&nbsp;<span class="op" id="3251477">&amp;^=</span>&nbsp;<span class="ident" id="3251481"><a href="/gostd/net/fd_mutex.go.html#3250163">mutexRMask</a></span>&nbsp;<span class="op" id="3251492">|</span>&nbsp;<span class="ident" id="3251494"><a href="/gostd/net/fd_mutex.go.html#3250221">mutexWMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251507">if</span>&nbsp;<span class="ident" id="3251510"><a href="/gostd/net/fd_mutex.go.html#3249414">atomic</a></span><span class="op" id="3251516">.</span><span class="ident" id="3251517"><a href="/gostd/sync/atomic/doc.go.html#1466448">CompareAndSwapUint64</a></span><span class="op" id="3251537">(</span><span class="op" id="3251538">&amp;</span><span class="ident" id="3251539"><a href="/gostd/net/fd_mutex.go.html#3251145">mu</a></span><span class="op" id="3251541">.</span><span class="ident" id="3251542"><a href="/gostd/net/fd_mutex.go.html#3249601">state</a></span><span class="op" id="3251547">,</span>&nbsp;<span class="ident" id="3251549"><a href="/gostd/net/fd_mutex.go.html#3251191">old</a></span><span class="op" id="3251552">,</span>&nbsp;<span class="builtinfunc" id="3251554"><a href="/gostd/net/fd_mutex.go.html#3251322">new</a></span><span class="op" id="3251557">)</span>&nbsp;<span class="op" id="3251559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3251564">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3251603">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251653">for</span>&nbsp;<span class="ident" id="3251657"><a href="/gostd/net/fd_mutex.go.html#3251191">old</a></span><span class="op" id="3251660">&amp;</span><span class="ident" id="3251661"><a href="/gostd/net/fd_mutex.go.html#3250163">mutexRMask</a></span>&nbsp;<span class="op" id="3251672">!=</span>&nbsp;<span class="num" id="3251675">0</span>&nbsp;<span class="op" id="3251677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3251683"><a href="/gostd/net/fd_mutex.go.html#3251191">old</a></span>&nbsp;<span class="op" id="3251687">-=</span>&nbsp;<span class="ident" id="3251690"><a href="/gostd/net/fd_mutex.go.html#3250139">mutexRWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3251705"><a href="/gostd/net/fd_mutex.go.html#3253971">runtime_Semrelease</a></span><span class="op" id="3251723">(</span><span class="op" id="3251724">&amp;</span><span class="ident" id="3251725"><a href="/gostd/net/fd_mutex.go.html#3251145">mu</a></span><span class="op" id="3251727">.</span><span class="ident" id="3251728"><a href="/gostd/net/fd_mutex.go.html#3249615">rsema</a></span><span class="op" id="3251733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251743">for</span>&nbsp;<span class="ident" id="3251747"><a href="/gostd/net/fd_mutex.go.html#3251191">old</a></span><span class="op" id="3251750">&amp;</span><span class="ident" id="3251751"><a href="/gostd/net/fd_mutex.go.html#3250221">mutexWMask</a></span>&nbsp;<span class="op" id="3251762">!=</span>&nbsp;<span class="num" id="3251765">0</span>&nbsp;<span class="op" id="3251767">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3251773"><a href="/gostd/net/fd_mutex.go.html#3251191">old</a></span>&nbsp;<span class="op" id="3251777">-=</span>&nbsp;<span class="ident" id="3251780"><a href="/gostd/net/fd_mutex.go.html#3250197">mutexWWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3251795"><a href="/gostd/net/fd_mutex.go.html#3253971">runtime_Semrelease</a></span><span class="op" id="3251813">(</span><span class="op" id="3251814">&amp;</span><span class="ident" id="3251815"><a href="/gostd/net/fd_mutex.go.html#3251145">mu</a></span><span class="op" id="3251817">.</span><span class="ident" id="3251818"><a href="/gostd/net/fd_mutex.go.html#3249629">wsema</a></span><span class="op" id="3251823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251833">return</span>&nbsp;<span class="builtintype" id="3251840">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251847">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251850">}</span><br>
<span class="lineno"></span><span class="op" id="3251852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3251855">func</span>&nbsp;<span class="op" id="3251860">(</span><span class="ident" id="3251861">mu</span>&nbsp;<span class="op" id="3251864">*</span><span class="ident" id="3251865"><a href="/gostd/net/fd_mutex.go.html#3249583">fdMutex</a></span><span class="op" id="3251872">)</span>&nbsp;<span class="ident" id="3251874">Decref</span><span class="op" id="3251880">(</span><span class="op" id="3251881">)</span>&nbsp;<span class="builtintype" id="3251883">bool</span>&nbsp;<span class="op" id="3251888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251891">for</span>&nbsp;<span class="op" id="3251895">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3251899">old</span>&nbsp;<span class="op" id="3251903">:=</span>&nbsp;<span class="ident" id="3251906"><a href="/gostd/net/fd_mutex.go.html#3249414">atomic</a></span><span class="op" id="3251912">.</span><span class="ident" id="3251913"><a href="/gostd/sync/atomic/doc.go.html#1468085">LoadUint64</a></span><span class="op" id="3251923">(</span><span class="op" id="3251924">&amp;</span><span class="ident" id="3251925"><a href="/gostd/net/fd_mutex.go.html#3251861">mu</a></span><span class="op" id="3251927">.</span><span class="ident" id="3251928"><a href="/gostd/net/fd_mutex.go.html#3249601">state</a></span><span class="op" id="3251933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251937">if</span>&nbsp;<span class="ident" id="3251940"><a href="/gostd/net/fd_mutex.go.html#3251899">old</a></span><span class="op" id="3251943">&amp;</span><span class="ident" id="3251944"><a href="/gostd/net/fd_mutex.go.html#3250106">mutexRefMask</a></span>&nbsp;<span class="op" id="3251957">==</span>&nbsp;<span class="num" id="3251960">0</span>&nbsp;<span class="op" id="3251962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3251967">panic</span><span class="op" id="3251972">(</span><span class="string" id="3251973">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3252000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3252008">new</span>&nbsp;<span class="op" id="3252012">:=</span>&nbsp;<span class="ident" id="3252015"><a href="/gostd/net/fd_mutex.go.html#3251899">old</a></span>&nbsp;<span class="op" id="3252019">-</span>&nbsp;<span class="ident" id="3252021"><a href="/gostd/net/fd_mutex.go.html#3250083">mutexRef</a></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252032">if</span>&nbsp;<span class="ident" id="3252035"><a href="/gostd/net/fd_mutex.go.html#3249414">atomic</a></span><span class="op" id="3252041">.</span><span class="ident" id="3252042"><a href="/gostd/sync/atomic/doc.go.html#1466448">CompareAndSwapUint64</a></span><span class="op" id="3252062">(</span><span class="op" id="3252063">&amp;</span><span class="ident" id="3252064"><a href="/gostd/net/fd_mutex.go.html#3251861">mu</a></span><span class="op" id="3252066">.</span><span class="ident" id="3252067"><a href="/gostd/net/fd_mutex.go.html#3249601">state</a></span><span class="op" id="3252072">,</span>&nbsp;<span class="ident" id="3252074"><a href="/gostd/net/fd_mutex.go.html#3251899">old</a></span><span class="op" id="3252077">,</span>&nbsp;<span class="builtinfunc" id="3252079"><a href="/gostd/net/fd_mutex.go.html#3252008">new</a></span><span class="op" id="3252082">)</span>&nbsp;<span class="op" id="3252084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252089">return</span>&nbsp;<span class="builtinfunc" id="3252096"><a href="/gostd/net/fd_mutex.go.html#3252008">new</a></span><span class="op" id="3252099">&amp;</span><span class="op" id="3252100">(</span><span class="ident" id="3252101"><a href="/gostd/net/fd_mutex.go.html#3250014">mutexClosed</a></span><span class="op" id="3252112">|</span><span class="ident" id="3252113"><a href="/gostd/net/fd_mutex.go.html#3250106">mutexRefMask</a></span><span class="op" id="3252125">)</span>&nbsp;<span class="op" id="3252127">==</span>&nbsp;<span class="ident" id="3252130"><a href="/gostd/net/fd_mutex.go.html#3250014">mutexClosed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252147">}</span><br>
<span class="lineno"></span><span class="op" id="3252149">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3252152">func</span>&nbsp;<span class="op" id="3252157">(</span><span class="ident" id="3252158">mu</span>&nbsp;<span class="op" id="3252161">*</span><span class="ident" id="3252162"><a href="/gostd/net/fd_mutex.go.html#3249583">fdMutex</a></span><span class="op" id="3252169">)</span>&nbsp;<span class="ident" id="3252171">RWLock</span><span class="op" id="3252177">(</span><span class="ident" id="3252178">read</span>&nbsp;<span class="builtintype" id="3252183">bool</span><span class="op" id="3252187">)</span>&nbsp;<span class="builtintype" id="3252189">bool</span>&nbsp;<span class="op" id="3252194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252197">var</span>&nbsp;<span class="ident" id="3252201">mutexBit</span><span class="op" id="3252209">,</span>&nbsp;<span class="ident" id="3252211">mutexWait</span><span class="op" id="3252220">,</span>&nbsp;<span class="ident" id="3252222">mutexMask</span>&nbsp;<span class="builtintype" id="3252232">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252240">var</span>&nbsp;<span class="ident" id="3252244">mutexSema</span>&nbsp;<span class="op" id="3252254">*</span><span class="builtintype" id="3252255">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252263">if</span>&nbsp;<span class="ident" id="3252266"><a href="/gostd/net/fd_mutex.go.html#3252178">read</a></span>&nbsp;<span class="op" id="3252271">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252275"><a href="/gostd/net/fd_mutex.go.html#3252201">mutexBit</a></span>&nbsp;<span class="op" id="3252284">=</span>&nbsp;<span class="ident" id="3252286"><a href="/gostd/net/fd_mutex.go.html#3250037">mutexRLock</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252299"><a href="/gostd/net/fd_mutex.go.html#3252211">mutexWait</a></span>&nbsp;<span class="op" id="3252309">=</span>&nbsp;<span class="ident" id="3252311"><a href="/gostd/net/fd_mutex.go.html#3250139">mutexRWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252324"><a href="/gostd/net/fd_mutex.go.html#3252222">mutexMask</a></span>&nbsp;<span class="op" id="3252334">=</span>&nbsp;<span class="ident" id="3252336"><a href="/gostd/net/fd_mutex.go.html#3250163">mutexRMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252349"><a href="/gostd/net/fd_mutex.go.html#3252244">mutexSema</a></span>&nbsp;<span class="op" id="3252359">=</span>&nbsp;<span class="op" id="3252361">&amp;</span><span class="ident" id="3252362"><a href="/gostd/net/fd_mutex.go.html#3252158">mu</a></span><span class="op" id="3252364">.</span><span class="ident" id="3252365"><a href="/gostd/net/fd_mutex.go.html#3249615">rsema</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252372">}</span>&nbsp;<span class="keyword" id="3252374">else</span>&nbsp;<span class="op" id="3252379">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252383"><a href="/gostd/net/fd_mutex.go.html#3252201">mutexBit</a></span>&nbsp;<span class="op" id="3252392">=</span>&nbsp;<span class="ident" id="3252394"><a href="/gostd/net/fd_mutex.go.html#3250060">mutexWLock</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252407"><a href="/gostd/net/fd_mutex.go.html#3252211">mutexWait</a></span>&nbsp;<span class="op" id="3252417">=</span>&nbsp;<span class="ident" id="3252419"><a href="/gostd/net/fd_mutex.go.html#3250197">mutexWWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252432"><a href="/gostd/net/fd_mutex.go.html#3252222">mutexMask</a></span>&nbsp;<span class="op" id="3252442">=</span>&nbsp;<span class="ident" id="3252444"><a href="/gostd/net/fd_mutex.go.html#3250221">mutexWMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252457"><a href="/gostd/net/fd_mutex.go.html#3252244">mutexSema</a></span>&nbsp;<span class="op" id="3252467">=</span>&nbsp;<span class="op" id="3252469">&amp;</span><span class="ident" id="3252470"><a href="/gostd/net/fd_mutex.go.html#3252158">mu</a></span><span class="op" id="3252472">.</span><span class="ident" id="3252473"><a href="/gostd/net/fd_mutex.go.html#3249629">wsema</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252480">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252483">for</span>&nbsp;<span class="op" id="3252487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252491">old</span>&nbsp;<span class="op" id="3252495">:=</span>&nbsp;<span class="ident" id="3252498"><a href="/gostd/net/fd_mutex.go.html#3249414">atomic</a></span><span class="op" id="3252504">.</span><span class="ident" id="3252505"><a href="/gostd/sync/atomic/doc.go.html#1468085">LoadUint64</a></span><span class="op" id="3252515">(</span><span class="op" id="3252516">&amp;</span><span class="ident" id="3252517"><a href="/gostd/net/fd_mutex.go.html#3252158">mu</a></span><span class="op" id="3252519">.</span><span class="ident" id="3252520"><a href="/gostd/net/fd_mutex.go.html#3249601">state</a></span><span class="op" id="3252525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252529">if</span>&nbsp;<span class="ident" id="3252532"><a href="/gostd/net/fd_mutex.go.html#3252491">old</a></span><span class="op" id="3252535">&amp;</span><span class="ident" id="3252536"><a href="/gostd/net/fd_mutex.go.html#3250014">mutexClosed</a></span>&nbsp;<span class="op" id="3252548">!=</span>&nbsp;<span class="num" id="3252551">0</span>&nbsp;<span class="op" id="3252553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252558">return</span>&nbsp;<span class="builtintype" id="3252565">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252573">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252577">var</span>&nbsp;<span class="builtinfunc" id="3252581">new</span>&nbsp;<span class="builtintype" id="3252585">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252594">if</span>&nbsp;<span class="ident" id="3252597"><a href="/gostd/net/fd_mutex.go.html#3252491">old</a></span><span class="op" id="3252600">&amp;</span><span class="ident" id="3252601"><a href="/gostd/net/fd_mutex.go.html#3252201">mutexBit</a></span>&nbsp;<span class="op" id="3252610">==</span>&nbsp;<span class="num" id="3252613">0</span>&nbsp;<span class="op" id="3252615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3252620">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3252652"><a href="/gostd/net/fd_mutex.go.html#3252581">new</a></span>&nbsp;<span class="op" id="3252656">=</span>&nbsp;<span class="op" id="3252658">(</span><span class="ident" id="3252659"><a href="/gostd/net/fd_mutex.go.html#3252491">old</a></span>&nbsp;<span class="op" id="3252663">|</span>&nbsp;<span class="ident" id="3252665"><a href="/gostd/net/fd_mutex.go.html#3252201">mutexBit</a></span><span class="op" id="3252673">)</span>&nbsp;<span class="op" id="3252675">+</span>&nbsp;<span class="ident" id="3252677"><a href="/gostd/net/fd_mutex.go.html#3250083">mutexRef</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252689">if</span>&nbsp;<span class="builtinfunc" id="3252692"><a href="/gostd/net/fd_mutex.go.html#3252581">new</a></span><span class="op" id="3252695">&amp;</span><span class="ident" id="3252696"><a href="/gostd/net/fd_mutex.go.html#3250106">mutexRefMask</a></span>&nbsp;<span class="op" id="3252709">==</span>&nbsp;<span class="num" id="3252712">0</span>&nbsp;<span class="op" id="3252714">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3252720">panic</span><span class="op" id="3252725">(</span><span class="string" id="3252726">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3252753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252762">}</span>&nbsp;<span class="keyword" id="3252764">else</span>&nbsp;<span class="op" id="3252769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3252774">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3252795"><a href="/gostd/net/fd_mutex.go.html#3252581">new</a></span>&nbsp;<span class="op" id="3252799">=</span>&nbsp;<span class="ident" id="3252801"><a href="/gostd/net/fd_mutex.go.html#3252491">old</a></span>&nbsp;<span class="op" id="3252805">+</span>&nbsp;<span class="ident" id="3252807"><a href="/gostd/net/fd_mutex.go.html#3252211">mutexWait</a></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252820">if</span>&nbsp;<span class="builtinfunc" id="3252823"><a href="/gostd/net/fd_mutex.go.html#3252581">new</a></span><span class="op" id="3252826">&amp;</span><span class="ident" id="3252827"><a href="/gostd/net/fd_mutex.go.html#3252222">mutexMask</a></span>&nbsp;<span class="op" id="3252837">==</span>&nbsp;<span class="num" id="3252840">0</span>&nbsp;<span class="op" id="3252842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3252848">panic</span><span class="op" id="3252853">(</span><span class="string" id="3252854">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3252881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252894">if</span>&nbsp;<span class="ident" id="3252897"><a href="/gostd/net/fd_mutex.go.html#3249414">atomic</a></span><span class="op" id="3252903">.</span><span class="ident" id="3252904"><a href="/gostd/sync/atomic/doc.go.html#1466448">CompareAndSwapUint64</a></span><span class="op" id="3252924">(</span><span class="op" id="3252925">&amp;</span><span class="ident" id="3252926"><a href="/gostd/net/fd_mutex.go.html#3252158">mu</a></span><span class="op" id="3252928">.</span><span class="ident" id="3252929"><a href="/gostd/net/fd_mutex.go.html#3249601">state</a></span><span class="op" id="3252934">,</span>&nbsp;<span class="ident" id="3252936"><a href="/gostd/net/fd_mutex.go.html#3252491">old</a></span><span class="op" id="3252939">,</span>&nbsp;<span class="builtinfunc" id="3252941"><a href="/gostd/net/fd_mutex.go.html#3252581">new</a></span><span class="op" id="3252944">)</span>&nbsp;<span class="op" id="3252946">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252951">if</span>&nbsp;<span class="ident" id="3252954"><a href="/gostd/net/fd_mutex.go.html#3252491">old</a></span><span class="op" id="3252957">&amp;</span><span class="ident" id="3252958"><a href="/gostd/net/fd_mutex.go.html#3252201">mutexBit</a></span>&nbsp;<span class="op" id="3252967">==</span>&nbsp;<span class="num" id="3252970">0</span>&nbsp;<span class="op" id="3252972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252978">return</span>&nbsp;<span class="builtintype" id="3252985">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252998"><a href="/gostd/net/fd_mutex.go.html#3253933">runtime_Semacquire</a></span><span class="op" id="3253016">(</span><span class="ident" id="3253017"><a href="/gostd/net/fd_mutex.go.html#3252244">mutexSema</a></span><span class="op" id="3253026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3253031">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253079">}</span><br>
<span class="lineno"></span><span class="op" id="3253081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3253084">func</span>&nbsp;<span class="op" id="3253089">(</span><span class="ident" id="3253090">mu</span>&nbsp;<span class="op" id="3253093">*</span><span class="ident" id="3253094"><a href="/gostd/net/fd_mutex.go.html#3249583">fdMutex</a></span><span class="op" id="3253101">)</span>&nbsp;<span class="ident" id="3253103">RWUnlock</span><span class="op" id="3253111">(</span><span class="ident" id="3253112">read</span>&nbsp;<span class="builtintype" id="3253117">bool</span><span class="op" id="3253121">)</span>&nbsp;<span class="builtintype" id="3253123">bool</span>&nbsp;<span class="op" id="3253128">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253131">var</span>&nbsp;<span class="ident" id="3253135">mutexBit</span><span class="op" id="3253143">,</span>&nbsp;<span class="ident" id="3253145">mutexWait</span><span class="op" id="3253154">,</span>&nbsp;<span class="ident" id="3253156">mutexMask</span>&nbsp;<span class="builtintype" id="3253166">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253174">var</span>&nbsp;<span class="ident" id="3253178">mutexSema</span>&nbsp;<span class="op" id="3253188">*</span><span class="builtintype" id="3253189">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253197">if</span>&nbsp;<span class="ident" id="3253200"><a href="/gostd/net/fd_mutex.go.html#3253112">read</a></span>&nbsp;<span class="op" id="3253205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253209"><a href="/gostd/net/fd_mutex.go.html#3253135">mutexBit</a></span>&nbsp;<span class="op" id="3253218">=</span>&nbsp;<span class="ident" id="3253220"><a href="/gostd/net/fd_mutex.go.html#3250037">mutexRLock</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253233"><a href="/gostd/net/fd_mutex.go.html#3253145">mutexWait</a></span>&nbsp;<span class="op" id="3253243">=</span>&nbsp;<span class="ident" id="3253245"><a href="/gostd/net/fd_mutex.go.html#3250139">mutexRWait</a></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253258"><a href="/gostd/net/fd_mutex.go.html#3253156">mutexMask</a></span>&nbsp;<span class="op" id="3253268">=</span>&nbsp;<span class="ident" id="3253270"><a href="/gostd/net/fd_mutex.go.html#3250163">mutexRMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253283"><a href="/gostd/net/fd_mutex.go.html#3253178">mutexSema</a></span>&nbsp;<span class="op" id="3253293">=</span>&nbsp;<span class="op" id="3253295">&amp;</span><span class="ident" id="3253296"><a href="/gostd/net/fd_mutex.go.html#3253090">mu</a></span><span class="op" id="3253298">.</span><span class="ident" id="3253299"><a href="/gostd/net/fd_mutex.go.html#3249615">rsema</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253306">}</span>&nbsp;<span class="keyword" id="3253308">else</span>&nbsp;<span class="op" id="3253313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253317"><a href="/gostd/net/fd_mutex.go.html#3253135">mutexBit</a></span>&nbsp;<span class="op" id="3253326">=</span>&nbsp;<span class="ident" id="3253328"><a href="/gostd/net/fd_mutex.go.html#3250060">mutexWLock</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253341"><a href="/gostd/net/fd_mutex.go.html#3253145">mutexWait</a></span>&nbsp;<span class="op" id="3253351">=</span>&nbsp;<span class="ident" id="3253353"><a href="/gostd/net/fd_mutex.go.html#3250197">mutexWWait</a></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253366"><a href="/gostd/net/fd_mutex.go.html#3253156">mutexMask</a></span>&nbsp;<span class="op" id="3253376">=</span>&nbsp;<span class="ident" id="3253378"><a href="/gostd/net/fd_mutex.go.html#3250221">mutexWMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253391"><a href="/gostd/net/fd_mutex.go.html#3253178">mutexSema</a></span>&nbsp;<span class="op" id="3253401">=</span>&nbsp;<span class="op" id="3253403">&amp;</span><span class="ident" id="3253404"><a href="/gostd/net/fd_mutex.go.html#3253090">mu</a></span><span class="op" id="3253406">.</span><span class="ident" id="3253407"><a href="/gostd/net/fd_mutex.go.html#3249629">wsema</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253417">for</span>&nbsp;<span class="op" id="3253421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253425">old</span>&nbsp;<span class="op" id="3253429">:=</span>&nbsp;<span class="ident" id="3253432"><a href="/gostd/net/fd_mutex.go.html#3249414">atomic</a></span><span class="op" id="3253438">.</span><span class="ident" id="3253439"><a href="/gostd/sync/atomic/doc.go.html#1468085">LoadUint64</a></span><span class="op" id="3253449">(</span><span class="op" id="3253450">&amp;</span><span class="ident" id="3253451"><a href="/gostd/net/fd_mutex.go.html#3253090">mu</a></span><span class="op" id="3253453">.</span><span class="ident" id="3253454"><a href="/gostd/net/fd_mutex.go.html#3249601">state</a></span><span class="op" id="3253459">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253463">if</span>&nbsp;<span class="ident" id="3253466"><a href="/gostd/net/fd_mutex.go.html#3253425">old</a></span><span class="op" id="3253469">&amp;</span><span class="ident" id="3253470"><a href="/gostd/net/fd_mutex.go.html#3253135">mutexBit</a></span>&nbsp;<span class="op" id="3253479">==</span>&nbsp;<span class="num" id="3253482">0</span>&nbsp;<span class="op" id="3253484">||</span>&nbsp;<span class="ident" id="3253487"><a href="/gostd/net/fd_mutex.go.html#3253425">old</a></span><span class="op" id="3253490">&amp;</span><span class="ident" id="3253491"><a href="/gostd/net/fd_mutex.go.html#3250106">mutexRefMask</a></span>&nbsp;<span class="op" id="3253504">==</span>&nbsp;<span class="num" id="3253507">0</span>&nbsp;<span class="op" id="3253509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3253514">panic</span><span class="op" id="3253519">(</span><span class="string" id="3253520">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3253547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3253555">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3253619">new</span>&nbsp;<span class="op" id="3253623">:=</span>&nbsp;<span class="op" id="3253626">(</span><span class="ident" id="3253627"><a href="/gostd/net/fd_mutex.go.html#3253425">old</a></span>&nbsp;<span class="op" id="3253631">&amp;^</span>&nbsp;<span class="ident" id="3253634"><a href="/gostd/net/fd_mutex.go.html#3253135">mutexBit</a></span><span class="op" id="3253642">)</span>&nbsp;<span class="op" id="3253644">-</span>&nbsp;<span class="ident" id="3253646"><a href="/gostd/net/fd_mutex.go.html#3250083">mutexRef</a></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253657">if</span>&nbsp;<span class="ident" id="3253660"><a href="/gostd/net/fd_mutex.go.html#3253425">old</a></span><span class="op" id="3253663">&amp;</span><span class="ident" id="3253664"><a href="/gostd/net/fd_mutex.go.html#3253156">mutexMask</a></span>&nbsp;<span class="op" id="3253674">!=</span>&nbsp;<span class="num" id="3253677">0</span>&nbsp;<span class="op" id="3253679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3253684"><a href="/gostd/net/fd_mutex.go.html#3253619">new</a></span>&nbsp;<span class="op" id="3253688">-=</span>&nbsp;<span class="ident" id="3253691"><a href="/gostd/net/fd_mutex.go.html#3253145">mutexWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253707">if</span>&nbsp;<span class="ident" id="3253710"><a href="/gostd/net/fd_mutex.go.html#3249414">atomic</a></span><span class="op" id="3253716">.</span><span class="ident" id="3253717"><a href="/gostd/sync/atomic/doc.go.html#1466448">CompareAndSwapUint64</a></span><span class="op" id="3253737">(</span><span class="op" id="3253738">&amp;</span><span class="ident" id="3253739"><a href="/gostd/net/fd_mutex.go.html#3253090">mu</a></span><span class="op" id="3253741">.</span><span class="ident" id="3253742"><a href="/gostd/net/fd_mutex.go.html#3249601">state</a></span><span class="op" id="3253747">,</span>&nbsp;<span class="ident" id="3253749"><a href="/gostd/net/fd_mutex.go.html#3253425">old</a></span><span class="op" id="3253752">,</span>&nbsp;<span class="builtinfunc" id="3253754"><a href="/gostd/net/fd_mutex.go.html#3253619">new</a></span><span class="op" id="3253757">)</span>&nbsp;<span class="op" id="3253759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253764">if</span>&nbsp;<span class="ident" id="3253767"><a href="/gostd/net/fd_mutex.go.html#3253425">old</a></span><span class="op" id="3253770">&amp;</span><span class="ident" id="3253771"><a href="/gostd/net/fd_mutex.go.html#3253156">mutexMask</a></span>&nbsp;<span class="op" id="3253781">!=</span>&nbsp;<span class="num" id="3253784">0</span>&nbsp;<span class="op" id="3253786">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253792"><a href="/gostd/net/fd_mutex.go.html#3253971">runtime_Semrelease</a></span><span class="op" id="3253810">(</span><span class="ident" id="3253811"><a href="/gostd/net/fd_mutex.go.html#3253178">mutexSema</a></span><span class="op" id="3253820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253830">return</span>&nbsp;<span class="builtinfunc" id="3253837"><a href="/gostd/net/fd_mutex.go.html#3253619">new</a></span><span class="op" id="3253840">&amp;</span><span class="op" id="3253841">(</span><span class="ident" id="3253842"><a href="/gostd/net/fd_mutex.go.html#3250014">mutexClosed</a></span><span class="op" id="3253853">|</span><span class="ident" id="3253854"><a href="/gostd/net/fd_mutex.go.html#3250106">mutexRefMask</a></span><span class="op" id="3253866">)</span>&nbsp;<span class="op" id="3253868">==</span>&nbsp;<span class="ident" id="3253871"><a href="/gostd/net/fd_mutex.go.html#3250014">mutexClosed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253888">}</span><br>
<span class="lineno">180</span><span class="op" id="3253890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3253893">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3253928">func</span>&nbsp;<span class="ident" id="3253933">runtime_Semacquire</span><span class="op" id="3253951">(</span><span class="ident" id="3253952">sema</span>&nbsp;<span class="op" id="3253957">*</span><span class="builtintype" id="3253958">uint32</span><span class="op" id="3253964">)</span><br>
<span class="lineno"></span><span class="keyword" id="3253966">func</span>&nbsp;<span class="ident" id="3253971">runtime_Semrelease</span><span class="op" id="3253989">(</span><span class="ident" id="3253990">sema</span>&nbsp;<span class="op" id="3253995">*</span><span class="builtintype" id="3253996">uint32</span><span class="op" id="3254002">)</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
