<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1403316">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1403371">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1403425">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1403476">package</span>&nbsp;<span class="ident" id="1403484">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1403490">import</span>&nbsp;<span class="op" id="1403497">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1403500">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1403511">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1403526">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1403535">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1403538">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;temporary&nbsp;objects&nbsp;that&nbsp;may&nbsp;be&nbsp;individually&nbsp;saved&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1403613">//&nbsp;retrieved.</span><br>
<span class="lineno">15</span><span class="comment" id="1403627">//</span><br>
<span class="lineno"></span><span class="comment" id="1403630">//&nbsp;Any&nbsp;item&nbsp;stored&nbsp;in&nbsp;the&nbsp;Pool&nbsp;may&nbsp;be&nbsp;removed&nbsp;automatically&nbsp;at&nbsp;any&nbsp;time&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="1403710">//&nbsp;notification.&nbsp;If&nbsp;the&nbsp;Pool&nbsp;holds&nbsp;the&nbsp;only&nbsp;reference&nbsp;when&nbsp;this&nbsp;happens,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1403787">//&nbsp;item&nbsp;might&nbsp;be&nbsp;deallocated.</span><br>
<span class="lineno"></span><span class="comment" id="1403817">//</span><br>
<span class="lineno">20</span><span class="comment" id="1403820">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;safe&nbsp;for&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="1403885">//</span><br>
<span class="lineno"></span><span class="comment" id="1403888">//&nbsp;Pool&#39;s&nbsp;purpose&nbsp;is&nbsp;to&nbsp;cache&nbsp;allocated&nbsp;but&nbsp;unused&nbsp;items&nbsp;for&nbsp;later&nbsp;reuse,</span><br>
<span class="lineno"></span><span class="comment" id="1403962">//&nbsp;relieving&nbsp;pressure&nbsp;on&nbsp;the&nbsp;garbage&nbsp;collector.&nbsp;That&nbsp;is,&nbsp;it&nbsp;makes&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1404039">//&nbsp;build&nbsp;efficient,&nbsp;thread-safe&nbsp;free&nbsp;lists.&nbsp;However,&nbsp;it&nbsp;is&nbsp;not&nbsp;suitable&nbsp;for&nbsp;all</span><br>
<span class="lineno">25</span><span class="comment" id="1404119">//&nbsp;free&nbsp;lists.</span><br>
<span class="lineno"></span><span class="comment" id="1404134">//</span><br>
<span class="lineno"></span><span class="comment" id="1404137">//&nbsp;An&nbsp;appropriate&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;to&nbsp;manage&nbsp;a&nbsp;group&nbsp;of&nbsp;temporary&nbsp;items</span><br>
<span class="lineno"></span><span class="comment" id="1404209">//&nbsp;silently&nbsp;shared&nbsp;among&nbsp;and&nbsp;potentially&nbsp;reused&nbsp;by&nbsp;concurrent&nbsp;independent</span><br>
<span class="lineno"></span><span class="comment" id="1404283">//&nbsp;clients&nbsp;of&nbsp;a&nbsp;package.&nbsp;Pool&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;amortize&nbsp;allocation&nbsp;overhead</span><br>
<span class="lineno">30</span><span class="comment" id="1404360">//&nbsp;across&nbsp;many&nbsp;clients.</span><br>
<span class="lineno"></span><span class="comment" id="1404384">//</span><br>
<span class="lineno"></span><span class="comment" id="1404387">//&nbsp;An&nbsp;example&nbsp;of&nbsp;good&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;in&nbsp;the&nbsp;fmt&nbsp;package,&nbsp;which&nbsp;maintains&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1404464">//&nbsp;dynamically-sized&nbsp;store&nbsp;of&nbsp;temporary&nbsp;output&nbsp;buffers.&nbsp;The&nbsp;store&nbsp;scales&nbsp;under</span><br>
<span class="lineno"></span><span class="comment" id="1404543">//&nbsp;load&nbsp;(when&nbsp;many&nbsp;goroutines&nbsp;are&nbsp;actively&nbsp;printing)&nbsp;and&nbsp;shrinks&nbsp;when</span><br>
<span class="lineno">35</span><span class="comment" id="1404613">//&nbsp;quiescent.</span><br>
<span class="lineno"></span><span class="comment" id="1404627">//</span><br>
<span class="lineno"></span><span class="comment" id="1404630">//&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;a&nbsp;free&nbsp;list&nbsp;maintained&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;short-lived&nbsp;object&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1404710">//&nbsp;not&nbsp;a&nbsp;suitable&nbsp;use&nbsp;for&nbsp;a&nbsp;Pool,&nbsp;since&nbsp;the&nbsp;overhead&nbsp;does&nbsp;not&nbsp;amortize&nbsp;well&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1404789">//&nbsp;that&nbsp;scenario.&nbsp;It&nbsp;is&nbsp;more&nbsp;efficient&nbsp;to&nbsp;have&nbsp;such&nbsp;objects&nbsp;implement&nbsp;their&nbsp;own</span><br>
<span class="lineno">40</span><span class="comment" id="1404869">//&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="1404883">//</span><br>
<span class="lineno"></span><span class="keyword" id="1404886">type</span>&nbsp;<span class="ident" id="1404891">Pool</span>&nbsp;<span class="keyword" id="1404896">struct</span>&nbsp;<span class="op" id="1404903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1404906">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404916">unsafe</span><span class="op" id="1404922">.</span><span class="ident" id="1404923">Pointer</span>&nbsp;<span class="comment" id="1404931">//&nbsp;local&nbsp;fixed-size&nbsp;per-P&nbsp;pool,&nbsp;actual&nbsp;type&nbsp;is&nbsp;[P]poolLocal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1404992">localSize</span>&nbsp;<span class="builtintype" id="1405002">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1405017">//&nbsp;size&nbsp;of&nbsp;the&nbsp;local&nbsp;array</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1405046">//&nbsp;New&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;generate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1405098">//&nbsp;a&nbsp;value&nbsp;when&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1405147">//&nbsp;It&nbsp;may&nbsp;not&nbsp;be&nbsp;changed&nbsp;concurrently&nbsp;with&nbsp;calls&nbsp;to&nbsp;Get.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1405205">New</span>&nbsp;<span class="keyword" id="1405209">func</span><span class="op" id="1405213">(</span><span class="op" id="1405214">)</span>&nbsp;<span class="keyword" id="1405216">interface</span><span class="op" id="1405225">{</span><span class="op" id="1405226">}</span><br>
<span class="lineno">50</span><span class="op" id="1405228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1405231">//&nbsp;Local&nbsp;per-P&nbsp;Pool&nbsp;appendix.</span><br>
<span class="lineno"></span><span class="keyword" id="1405261">type</span>&nbsp;<span class="ident" id="1405266">poolLocal</span>&nbsp;<span class="keyword" id="1405276">struct</span>&nbsp;<span class="op" id="1405283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1405286">private</span>&nbsp;<span class="keyword" id="1405294">interface</span><span class="op" id="1405303">{</span><span class="op" id="1405304">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1405308">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;only&nbsp;by&nbsp;the&nbsp;respective&nbsp;P.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1405350">shared</span>&nbsp;&nbsp;<span class="op" id="1405358">[</span><span class="op" id="1405359">]</span><span class="keyword" id="1405360">interface</span><span class="op" id="1405369">{</span><span class="op" id="1405370">}</span>&nbsp;<span class="comment" id="1405372">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;by&nbsp;any&nbsp;P.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1405398">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1405420">//&nbsp;Protects&nbsp;shared.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1405441">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405449">[</span><span class="num" id="1405450">128</span><span class="op" id="1405453">]</span><span class="builtintype" id="1405454">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1405463">//&nbsp;Prevents&nbsp;false&nbsp;sharing.</span><br>
<span class="lineno"></span><span class="op" id="1405490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1405493">//&nbsp;Put&nbsp;adds&nbsp;x&nbsp;to&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1405520">func</span>&nbsp;<span class="op" id="1405525">(</span><span class="ident" id="1405526">p</span>&nbsp;<span class="op" id="1405528">*</span><span class="ident" id="1405529">Pool</span><span class="op" id="1405533">)</span>&nbsp;<span class="ident" id="1405535">Put</span><span class="op" id="1405538">(</span><span class="ident" id="1405539">x</span>&nbsp;<span class="keyword" id="1405541">interface</span><span class="op" id="1405550">{</span><span class="op" id="1405551">}</span><span class="op" id="1405552">)</span>&nbsp;<span class="op" id="1405554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1405557">if</span>&nbsp;<span class="ident" id="1405560">raceenabled</span>&nbsp;<span class="op" id="1405572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1405576">//&nbsp;Under&nbsp;race&nbsp;detector&nbsp;the&nbsp;Pool&nbsp;degenerates&nbsp;into&nbsp;no-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1405634">//&nbsp;It&#39;s&nbsp;conforming,&nbsp;simple&nbsp;and&nbsp;does&nbsp;not&nbsp;introduce&nbsp;excessive</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1405696">//&nbsp;happens-before&nbsp;edges&nbsp;between&nbsp;unrelated&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1405752">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1405760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1405763">if</span>&nbsp;<span class="ident" id="1405766">x</span>&nbsp;<span class="op" id="1405768">==</span>&nbsp;<span class="ident" id="1405771">nil</span>&nbsp;<span class="op" id="1405775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1405779">return</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1405787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1405790">l</span>&nbsp;<span class="op" id="1405792">:=</span>&nbsp;<span class="ident" id="1405795">p</span><span class="op" id="1405796">.</span><span class="ident" id="1405797">pin</span><span class="op" id="1405800">(</span><span class="op" id="1405801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1405804">if</span>&nbsp;<span class="ident" id="1405807">l</span><span class="op" id="1405808">.</span><span class="ident" id="1405809">private</span>&nbsp;<span class="op" id="1405817">==</span>&nbsp;<span class="ident" id="1405820">nil</span>&nbsp;<span class="op" id="1405824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1405828">l</span><span class="op" id="1405829">.</span><span class="ident" id="1405830">private</span>&nbsp;<span class="op" id="1405838">=</span>&nbsp;<span class="ident" id="1405840">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1405844">x</span>&nbsp;<span class="op" id="1405846">=</span>&nbsp;<span class="ident" id="1405848">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1405853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1405856">runtime_procUnpin</span><span class="op" id="1405873">(</span><span class="op" id="1405874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1405877">if</span>&nbsp;<span class="ident" id="1405880">x</span>&nbsp;<span class="op" id="1405882">==</span>&nbsp;<span class="ident" id="1405885">nil</span>&nbsp;<span class="op" id="1405889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1405893">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1405901">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1405904">l</span><span class="op" id="1405905">.</span><span class="ident" id="1405906">Lock</span><span class="op" id="1405910">(</span><span class="op" id="1405911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1405914">l</span><span class="op" id="1405915">.</span><span class="ident" id="1405916">shared</span>&nbsp;<span class="op" id="1405923">=</span>&nbsp;<span class="builtinfunc" id="1405925">append</span><span class="op" id="1405931">(</span><span class="ident" id="1405932">l</span><span class="op" id="1405933">.</span><span class="ident" id="1405934">shared</span><span class="op" id="1405940">,</span>&nbsp;<span class="ident" id="1405942">x</span><span class="op" id="1405943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1405946">l</span><span class="op" id="1405947">.</span><span class="ident" id="1405948">Unlock</span><span class="op" id="1405954">(</span><span class="op" id="1405955">)</span><br>
<span class="lineno"></span><span class="op" id="1405957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1405960">//&nbsp;Get&nbsp;selects&nbsp;an&nbsp;arbitrary&nbsp;item&nbsp;from&nbsp;the&nbsp;Pool,&nbsp;removes&nbsp;it&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1406028">//&nbsp;Pool,&nbsp;and&nbsp;returns&nbsp;it&nbsp;to&nbsp;the&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1406067">//&nbsp;Get&nbsp;may&nbsp;choose&nbsp;to&nbsp;ignore&nbsp;the&nbsp;pool&nbsp;and&nbsp;treat&nbsp;it&nbsp;as&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="1406127">//&nbsp;Callers&nbsp;should&nbsp;not&nbsp;assume&nbsp;any&nbsp;relation&nbsp;between&nbsp;values&nbsp;passed&nbsp;to&nbsp;Put&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1406202">//&nbsp;the&nbsp;values&nbsp;returned&nbsp;by&nbsp;Get.</span><br>
<span class="lineno">90</span><span class="comment" id="1406233">//</span><br>
<span class="lineno"></span><span class="comment" id="1406236">//&nbsp;If&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil&nbsp;and&nbsp;p.New&nbsp;is&nbsp;non-nil,&nbsp;Get&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="1406307">//&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;p.New.</span><br>
<span class="lineno"></span><span class="keyword" id="1406339">func</span>&nbsp;<span class="op" id="1406344">(</span><span class="ident" id="1406345">p</span>&nbsp;<span class="op" id="1406347">*</span><span class="ident" id="1406348">Pool</span><span class="op" id="1406352">)</span>&nbsp;<span class="ident" id="1406354">Get</span><span class="op" id="1406357">(</span><span class="op" id="1406358">)</span>&nbsp;<span class="keyword" id="1406360">interface</span><span class="op" id="1406369">{</span><span class="op" id="1406370">}</span>&nbsp;<span class="op" id="1406372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1406375">if</span>&nbsp;<span class="ident" id="1406378">raceenabled</span>&nbsp;<span class="op" id="1406390">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1406394">if</span>&nbsp;<span class="ident" id="1406397">p</span><span class="op" id="1406398">.</span><span class="ident" id="1406399">New</span>&nbsp;<span class="op" id="1406403">!=</span>&nbsp;<span class="ident" id="1406406">nil</span>&nbsp;<span class="op" id="1406410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1406415">return</span>&nbsp;<span class="ident" id="1406422">p</span><span class="op" id="1406423">.</span><span class="ident" id="1406424">New</span><span class="op" id="1406427">(</span><span class="op" id="1406428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1406432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1406436">return</span>&nbsp;<span class="ident" id="1406443">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1406448">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1406451">l</span>&nbsp;<span class="op" id="1406453">:=</span>&nbsp;<span class="ident" id="1406456">p</span><span class="op" id="1406457">.</span><span class="ident" id="1406458">pin</span><span class="op" id="1406461">(</span><span class="op" id="1406462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1406465">x</span>&nbsp;<span class="op" id="1406467">:=</span>&nbsp;<span class="ident" id="1406470">l</span><span class="op" id="1406471">.</span><span class="ident" id="1406472">private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1406481">l</span><span class="op" id="1406482">.</span><span class="ident" id="1406483">private</span>&nbsp;<span class="op" id="1406491">=</span>&nbsp;<span class="ident" id="1406493">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1406498">runtime_procUnpin</span><span class="op" id="1406515">(</span><span class="op" id="1406516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1406519">if</span>&nbsp;<span class="ident" id="1406522">x</span>&nbsp;<span class="op" id="1406524">!=</span>&nbsp;<span class="ident" id="1406527">nil</span>&nbsp;<span class="op" id="1406531">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1406535">return</span>&nbsp;<span class="ident" id="1406542">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1406545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1406548">l</span><span class="op" id="1406549">.</span><span class="ident" id="1406550">Lock</span><span class="op" id="1406554">(</span><span class="op" id="1406555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1406558">last</span>&nbsp;<span class="op" id="1406563">:=</span>&nbsp;<span class="builtinfunc" id="1406566">len</span><span class="op" id="1406569">(</span><span class="ident" id="1406570">l</span><span class="op" id="1406571">.</span><span class="ident" id="1406572">shared</span><span class="op" id="1406578">)</span>&nbsp;<span class="op" id="1406580">-</span>&nbsp;<span class="num" id="1406582">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1406585">if</span>&nbsp;<span class="ident" id="1406588">last</span>&nbsp;<span class="op" id="1406593">&gt;=</span>&nbsp;<span class="num" id="1406596">0</span>&nbsp;<span class="op" id="1406598">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1406602">x</span>&nbsp;<span class="op" id="1406604">=</span>&nbsp;<span class="ident" id="1406606">l</span><span class="op" id="1406607">.</span><span class="ident" id="1406608">shared</span><span class="op" id="1406614">[</span><span class="ident" id="1406615">last</span><span class="op" id="1406619">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1406623">l</span><span class="op" id="1406624">.</span><span class="ident" id="1406625">shared</span>&nbsp;<span class="op" id="1406632">=</span>&nbsp;<span class="ident" id="1406634">l</span><span class="op" id="1406635">.</span><span class="ident" id="1406636">shared</span><span class="op" id="1406642">[</span><span class="op" id="1406643">:</span><span class="ident" id="1406644">last</span><span class="op" id="1406648">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1406651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1406654">l</span><span class="op" id="1406655">.</span><span class="ident" id="1406656">Unlock</span><span class="op" id="1406662">(</span><span class="op" id="1406663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1406666">if</span>&nbsp;<span class="ident" id="1406669">x</span>&nbsp;<span class="op" id="1406671">!=</span>&nbsp;<span class="ident" id="1406674">nil</span>&nbsp;<span class="op" id="1406678">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1406682">return</span>&nbsp;<span class="ident" id="1406689">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1406692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1406695">return</span>&nbsp;<span class="ident" id="1406702">p</span><span class="op" id="1406703">.</span><span class="ident" id="1406704">getSlow</span><span class="op" id="1406711">(</span><span class="op" id="1406712">)</span><br>
<span class="lineno"></span><span class="op" id="1406714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="1406717">func</span>&nbsp;<span class="op" id="1406722">(</span><span class="ident" id="1406723">p</span>&nbsp;<span class="op" id="1406725">*</span><span class="ident" id="1406726">Pool</span><span class="op" id="1406730">)</span>&nbsp;<span class="ident" id="1406732">getSlow</span><span class="op" id="1406739">(</span><span class="op" id="1406740">)</span>&nbsp;<span class="op" id="1406742">(</span><span class="ident" id="1406743">x</span>&nbsp;<span class="keyword" id="1406745">interface</span><span class="op" id="1406754">{</span><span class="op" id="1406755">}</span><span class="op" id="1406756">)</span>&nbsp;<span class="op" id="1406758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1406761">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;pin&nbsp;regarding&nbsp;ordering&nbsp;of&nbsp;the&nbsp;loads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1406821">size</span>&nbsp;<span class="op" id="1406826">:=</span>&nbsp;<span class="ident" id="1406829">atomic</span><span class="op" id="1406835">.</span><span class="ident" id="1406836">LoadUintptr</span><span class="op" id="1406847">(</span><span class="op" id="1406848">&amp;</span><span class="ident" id="1406849">p</span><span class="op" id="1406850">.</span><span class="ident" id="1406851">localSize</span><span class="op" id="1406860">)</span>&nbsp;<span class="comment" id="1406862">//&nbsp;load-acquire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1406879">local</span>&nbsp;<span class="op" id="1406885">:=</span>&nbsp;<span class="ident" id="1406888">p</span><span class="op" id="1406889">.</span><span class="ident" id="1406890">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1406920">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1406937">//&nbsp;Try&nbsp;to&nbsp;steal&nbsp;one&nbsp;element&nbsp;from&nbsp;other&nbsp;procs.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1406984">pid</span>&nbsp;<span class="op" id="1406988">:=</span>&nbsp;<span class="ident" id="1406991">runtime_procPin</span><span class="op" id="1407006">(</span><span class="op" id="1407007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1407010">runtime_procUnpin</span><span class="op" id="1407027">(</span><span class="op" id="1407028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1407031">for</span>&nbsp;<span class="ident" id="1407035">i</span>&nbsp;<span class="op" id="1407037">:=</span>&nbsp;<span class="num" id="1407040">0</span><span class="op" id="1407041">;</span>&nbsp;<span class="ident" id="1407043">i</span>&nbsp;<span class="op" id="1407045">&lt;</span>&nbsp;<span class="builtintype" id="1407047">int</span><span class="op" id="1407050">(</span><span class="ident" id="1407051">size</span><span class="op" id="1407055">)</span><span class="op" id="1407056">;</span>&nbsp;<span class="ident" id="1407058">i</span><span class="op" id="1407059">++</span>&nbsp;<span class="op" id="1407062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1407066">l</span>&nbsp;<span class="op" id="1407068">:=</span>&nbsp;<span class="ident" id="1407071">indexLocal</span><span class="op" id="1407081">(</span><span class="ident" id="1407082">local</span><span class="op" id="1407087">,</span>&nbsp;<span class="op" id="1407089">(</span><span class="ident" id="1407090">pid</span><span class="op" id="1407093">+</span><span class="ident" id="1407094">i</span><span class="op" id="1407095">+</span><span class="num" id="1407096">1</span><span class="op" id="1407097">)</span><span class="op" id="1407098">%</span><span class="builtintype" id="1407099">int</span><span class="op" id="1407102">(</span><span class="ident" id="1407103">size</span><span class="op" id="1407107">)</span><span class="op" id="1407108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1407112">l</span><span class="op" id="1407113">.</span><span class="ident" id="1407114">Lock</span><span class="op" id="1407118">(</span><span class="op" id="1407119">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1407123">last</span>&nbsp;<span class="op" id="1407128">:=</span>&nbsp;<span class="builtinfunc" id="1407131">len</span><span class="op" id="1407134">(</span><span class="ident" id="1407135">l</span><span class="op" id="1407136">.</span><span class="ident" id="1407137">shared</span><span class="op" id="1407143">)</span>&nbsp;<span class="op" id="1407145">-</span>&nbsp;<span class="num" id="1407147">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1407151">if</span>&nbsp;<span class="ident" id="1407154">last</span>&nbsp;<span class="op" id="1407159">&gt;=</span>&nbsp;<span class="num" id="1407162">0</span>&nbsp;<span class="op" id="1407164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1407169">x</span>&nbsp;<span class="op" id="1407171">=</span>&nbsp;<span class="ident" id="1407173">l</span><span class="op" id="1407174">.</span><span class="ident" id="1407175">shared</span><span class="op" id="1407181">[</span><span class="ident" id="1407182">last</span><span class="op" id="1407186">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1407191">l</span><span class="op" id="1407192">.</span><span class="ident" id="1407193">shared</span>&nbsp;<span class="op" id="1407200">=</span>&nbsp;<span class="ident" id="1407202">l</span><span class="op" id="1407203">.</span><span class="ident" id="1407204">shared</span><span class="op" id="1407210">[</span><span class="op" id="1407211">:</span><span class="ident" id="1407212">last</span><span class="op" id="1407216">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1407221">l</span><span class="op" id="1407222">.</span><span class="ident" id="1407223">Unlock</span><span class="op" id="1407229">(</span><span class="op" id="1407230">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1407235">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1407243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1407247">l</span><span class="op" id="1407248">.</span><span class="ident" id="1407249">Unlock</span><span class="op" id="1407255">(</span><span class="op" id="1407256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1407259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1407263">if</span>&nbsp;<span class="ident" id="1407266">x</span>&nbsp;<span class="op" id="1407268">==</span>&nbsp;<span class="ident" id="1407271">nil</span>&nbsp;<span class="op" id="1407275">&amp;&amp;</span>&nbsp;<span class="ident" id="1407278">p</span><span class="op" id="1407279">.</span><span class="ident" id="1407280">New</span>&nbsp;<span class="op" id="1407284">!=</span>&nbsp;<span class="ident" id="1407287">nil</span>&nbsp;<span class="op" id="1407291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1407295">x</span>&nbsp;<span class="op" id="1407297">=</span>&nbsp;<span class="ident" id="1407299">p</span><span class="op" id="1407300">.</span><span class="ident" id="1407301">New</span><span class="op" id="1407304">(</span><span class="op" id="1407305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1407308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1407311">return</span>&nbsp;<span class="ident" id="1407318">x</span><br>
<span class="lineno"></span><span class="op" id="1407320">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1407323">//&nbsp;pin&nbsp;pins&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;P,&nbsp;disables&nbsp;preemption&nbsp;and&nbsp;returns&nbsp;poolLocal&nbsp;pool&nbsp;for&nbsp;the&nbsp;P.</span><br>
<span class="lineno"></span><span class="comment" id="1407421">//&nbsp;Caller&nbsp;must&nbsp;call&nbsp;runtime_procUnpin()&nbsp;when&nbsp;done&nbsp;with&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1407486">func</span>&nbsp;<span class="op" id="1407491">(</span><span class="ident" id="1407492">p</span>&nbsp;<span class="op" id="1407494">*</span><span class="ident" id="1407495">Pool</span><span class="op" id="1407499">)</span>&nbsp;<span class="ident" id="1407501">pin</span><span class="op" id="1407504">(</span><span class="op" id="1407505">)</span>&nbsp;<span class="op" id="1407507">*</span><span class="ident" id="1407508">poolLocal</span>&nbsp;<span class="op" id="1407518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1407521">pid</span>&nbsp;<span class="op" id="1407525">:=</span>&nbsp;<span class="ident" id="1407528">runtime_procPin</span><span class="op" id="1407543">(</span><span class="op" id="1407544">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1407547">//&nbsp;In&nbsp;pinSlow&nbsp;we&nbsp;store&nbsp;to&nbsp;localSize&nbsp;and&nbsp;then&nbsp;to&nbsp;local,&nbsp;here&nbsp;we&nbsp;load&nbsp;in&nbsp;opposite&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1407635">//&nbsp;Since&nbsp;we&#39;ve&nbsp;disabled&nbsp;preemption,&nbsp;GC&nbsp;can&nbsp;not&nbsp;happen&nbsp;in&nbsp;between.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1407702">//&nbsp;Thus&nbsp;here&nbsp;we&nbsp;must&nbsp;observe&nbsp;local&nbsp;at&nbsp;least&nbsp;as&nbsp;large&nbsp;localSize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1407767">//&nbsp;We&nbsp;can&nbsp;observe&nbsp;a&nbsp;newer/larger&nbsp;local,&nbsp;it&nbsp;is&nbsp;fine&nbsp;(we&nbsp;must&nbsp;observe&nbsp;its&nbsp;zero-initialized-ness).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1407864">s</span>&nbsp;<span class="op" id="1407866">:=</span>&nbsp;<span class="ident" id="1407869">atomic</span><span class="op" id="1407875">.</span><span class="ident" id="1407876">LoadUintptr</span><span class="op" id="1407887">(</span><span class="op" id="1407888">&amp;</span><span class="ident" id="1407889">p</span><span class="op" id="1407890">.</span><span class="ident" id="1407891">localSize</span><span class="op" id="1407900">)</span>&nbsp;<span class="comment" id="1407902">//&nbsp;load-acquire</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1407919">l</span>&nbsp;<span class="op" id="1407921">:=</span>&nbsp;<span class="ident" id="1407924">p</span><span class="op" id="1407925">.</span><span class="ident" id="1407926">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1407957">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1407974">if</span>&nbsp;<span class="builtintype" id="1407977">uintptr</span><span class="op" id="1407984">(</span><span class="ident" id="1407985">pid</span><span class="op" id="1407988">)</span>&nbsp;<span class="op" id="1407990">&lt;</span>&nbsp;<span class="ident" id="1407992">s</span>&nbsp;<span class="op" id="1407994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1407998">return</span>&nbsp;<span class="ident" id="1408005">indexLocal</span><span class="op" id="1408015">(</span><span class="ident" id="1408016">l</span><span class="op" id="1408017">,</span>&nbsp;<span class="ident" id="1408019">pid</span><span class="op" id="1408022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1408025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1408028">return</span>&nbsp;<span class="ident" id="1408035">p</span><span class="op" id="1408036">.</span><span class="ident" id="1408037">pinSlow</span><span class="op" id="1408044">(</span><span class="op" id="1408045">)</span><br>
<span class="lineno">160</span><span class="op" id="1408047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1408050">func</span>&nbsp;<span class="op" id="1408055">(</span><span class="ident" id="1408056">p</span>&nbsp;<span class="op" id="1408058">*</span><span class="ident" id="1408059">Pool</span><span class="op" id="1408063">)</span>&nbsp;<span class="ident" id="1408065">pinSlow</span><span class="op" id="1408072">(</span><span class="op" id="1408073">)</span>&nbsp;<span class="op" id="1408075">*</span><span class="ident" id="1408076">poolLocal</span>&nbsp;<span class="op" id="1408086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1408089">//&nbsp;Retry&nbsp;under&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1408116">//&nbsp;Can&nbsp;not&nbsp;lock&nbsp;the&nbsp;mutex&nbsp;while&nbsp;pinned.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1408157">runtime_procUnpin</span><span class="op" id="1408174">(</span><span class="op" id="1408175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1408178">allPoolsMu</span><span class="op" id="1408188">.</span><span class="ident" id="1408189">Lock</span><span class="op" id="1408193">(</span><span class="op" id="1408194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1408197">defer</span>&nbsp;<span class="ident" id="1408203">allPoolsMu</span><span class="op" id="1408213">.</span><span class="ident" id="1408214">Unlock</span><span class="op" id="1408220">(</span><span class="op" id="1408221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1408224">pid</span>&nbsp;<span class="op" id="1408228">:=</span>&nbsp;<span class="ident" id="1408231">runtime_procPin</span><span class="op" id="1408246">(</span><span class="op" id="1408247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1408250">//&nbsp;poolCleanup&nbsp;won&#39;t&nbsp;be&nbsp;called&nbsp;while&nbsp;we&nbsp;are&nbsp;pinned.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1408303">s</span>&nbsp;<span class="op" id="1408305">:=</span>&nbsp;<span class="ident" id="1408308">p</span><span class="op" id="1408309">.</span><span class="ident" id="1408310">localSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1408321">l</span>&nbsp;<span class="op" id="1408323">:=</span>&nbsp;<span class="ident" id="1408326">p</span><span class="op" id="1408327">.</span><span class="ident" id="1408328">local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1408335">if</span>&nbsp;<span class="builtintype" id="1408338">uintptr</span><span class="op" id="1408345">(</span><span class="ident" id="1408346">pid</span><span class="op" id="1408349">)</span>&nbsp;<span class="op" id="1408351">&lt;</span>&nbsp;<span class="ident" id="1408353">s</span>&nbsp;<span class="op" id="1408355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1408359">return</span>&nbsp;<span class="ident" id="1408366">indexLocal</span><span class="op" id="1408376">(</span><span class="ident" id="1408377">l</span><span class="op" id="1408378">,</span>&nbsp;<span class="ident" id="1408380">pid</span><span class="op" id="1408383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1408386">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1408389">if</span>&nbsp;<span class="ident" id="1408392">p</span><span class="op" id="1408393">.</span><span class="ident" id="1408394">local</span>&nbsp;<span class="op" id="1408400">==</span>&nbsp;<span class="ident" id="1408403">nil</span>&nbsp;<span class="op" id="1408407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1408411">allPools</span>&nbsp;<span class="op" id="1408420">=</span>&nbsp;<span class="builtinfunc" id="1408422">append</span><span class="op" id="1408428">(</span><span class="ident" id="1408429">allPools</span><span class="op" id="1408437">,</span>&nbsp;<span class="ident" id="1408439">p</span><span class="op" id="1408440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1408443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1408446">//&nbsp;If&nbsp;GOMAXPROCS&nbsp;changes&nbsp;between&nbsp;GCs,&nbsp;we&nbsp;re-allocate&nbsp;the&nbsp;array&nbsp;and&nbsp;lose&nbsp;the&nbsp;old&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1408532">size</span>&nbsp;<span class="op" id="1408537">:=</span>&nbsp;<span class="ident" id="1408540">runtime</span><span class="op" id="1408547">.</span><span class="ident" id="1408548">GOMAXPROCS</span><span class="op" id="1408558">(</span><span class="num" id="1408559">0</span><span class="op" id="1408560">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1408563">local</span>&nbsp;<span class="op" id="1408569">:=</span>&nbsp;<span class="builtinfunc" id="1408572">make</span><span class="op" id="1408576">(</span><span class="op" id="1408577">[</span><span class="op" id="1408578">]</span><span class="ident" id="1408579">poolLocal</span><span class="op" id="1408588">,</span>&nbsp;<span class="ident" id="1408590">size</span><span class="op" id="1408594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1408597">atomic</span><span class="op" id="1408603">.</span><span class="ident" id="1408604">StorePointer</span><span class="op" id="1408616">(</span><span class="op" id="1408617">(</span><span class="op" id="1408618">*</span><span class="ident" id="1408619">unsafe</span><span class="op" id="1408625">.</span><span class="ident" id="1408626">Pointer</span><span class="op" id="1408633">)</span><span class="op" id="1408634">(</span><span class="op" id="1408635">&amp;</span><span class="ident" id="1408636">p</span><span class="op" id="1408637">.</span><span class="ident" id="1408638">local</span><span class="op" id="1408643">)</span><span class="op" id="1408644">,</span>&nbsp;<span class="ident" id="1408646">unsafe</span><span class="op" id="1408652">.</span><span class="ident" id="1408653">Pointer</span><span class="op" id="1408660">(</span><span class="op" id="1408661">&amp;</span><span class="ident" id="1408662">local</span><span class="op" id="1408667">[</span><span class="num" id="1408668">0</span><span class="op" id="1408669">]</span><span class="op" id="1408670">)</span><span class="op" id="1408671">)</span>&nbsp;<span class="comment" id="1408673">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1408691">atomic</span><span class="op" id="1408697">.</span><span class="ident" id="1408698">StoreUintptr</span><span class="op" id="1408710">(</span><span class="op" id="1408711">&amp;</span><span class="ident" id="1408712">p</span><span class="op" id="1408713">.</span><span class="ident" id="1408714">localSize</span><span class="op" id="1408723">,</span>&nbsp;<span class="builtintype" id="1408725">uintptr</span><span class="op" id="1408732">(</span><span class="ident" id="1408733">size</span><span class="op" id="1408737">)</span><span class="op" id="1408738">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408767">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1408785">return</span>&nbsp;<span class="op" id="1408792">&amp;</span><span class="ident" id="1408793">local</span><span class="op" id="1408798">[</span><span class="ident" id="1408799">pid</span><span class="op" id="1408802">]</span><br>
<span class="lineno"></span><span class="op" id="1408804">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="1408807">func</span>&nbsp;<span class="ident" id="1408812">poolCleanup</span><span class="op" id="1408823">(</span><span class="op" id="1408824">)</span>&nbsp;<span class="op" id="1408826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1408829">//&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;world&nbsp;stopped,&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1408923">//&nbsp;It&nbsp;must&nbsp;not&nbsp;allocate&nbsp;and&nbsp;probably&nbsp;should&nbsp;not&nbsp;call&nbsp;any&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1409000">//&nbsp;Defensively&nbsp;zero&nbsp;out&nbsp;everything,&nbsp;2&nbsp;reasons:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1409048">//&nbsp;1.&nbsp;To&nbsp;prevent&nbsp;false&nbsp;retention&nbsp;of&nbsp;whole&nbsp;Pools.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1409098">//&nbsp;2.&nbsp;If&nbsp;GC&nbsp;happens&nbsp;while&nbsp;a&nbsp;goroutine&nbsp;works&nbsp;with&nbsp;l.shared&nbsp;in&nbsp;Put/Get,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1409169">//&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;retain&nbsp;whole&nbsp;Pool.&nbsp;So&nbsp;next&nbsp;cycle&nbsp;memory&nbsp;consumption&nbsp;would&nbsp;be&nbsp;doubled.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1409254">for</span>&nbsp;<span class="ident" id="1409258">i</span><span class="op" id="1409259">,</span>&nbsp;<span class="ident" id="1409261">p</span>&nbsp;<span class="op" id="1409263">:=</span>&nbsp;<span class="keyword" id="1409266">range</span>&nbsp;<span class="ident" id="1409272">allPools</span>&nbsp;<span class="op" id="1409281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1409285">allPools</span><span class="op" id="1409293">[</span><span class="ident" id="1409294">i</span><span class="op" id="1409295">]</span>&nbsp;<span class="op" id="1409297">=</span>&nbsp;<span class="ident" id="1409299">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1409305">for</span>&nbsp;<span class="ident" id="1409309">i</span>&nbsp;<span class="op" id="1409311">:=</span>&nbsp;<span class="num" id="1409314">0</span><span class="op" id="1409315">;</span>&nbsp;<span class="ident" id="1409317">i</span>&nbsp;<span class="op" id="1409319">&lt;</span>&nbsp;<span class="builtintype" id="1409321">int</span><span class="op" id="1409324">(</span><span class="ident" id="1409325">p</span><span class="op" id="1409326">.</span><span class="ident" id="1409327">localSize</span><span class="op" id="1409336">)</span><span class="op" id="1409337">;</span>&nbsp;<span class="ident" id="1409339">i</span><span class="op" id="1409340">++</span>&nbsp;<span class="op" id="1409343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1409348">l</span>&nbsp;<span class="op" id="1409350">:=</span>&nbsp;<span class="ident" id="1409353">indexLocal</span><span class="op" id="1409363">(</span><span class="ident" id="1409364">p</span><span class="op" id="1409365">.</span><span class="ident" id="1409366">local</span><span class="op" id="1409371">,</span>&nbsp;<span class="ident" id="1409373">i</span><span class="op" id="1409374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1409379">l</span><span class="op" id="1409380">.</span><span class="ident" id="1409381">private</span>&nbsp;<span class="op" id="1409389">=</span>&nbsp;<span class="ident" id="1409391">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1409398">for</span>&nbsp;<span class="ident" id="1409402">j</span>&nbsp;<span class="op" id="1409404">:=</span>&nbsp;<span class="keyword" id="1409407">range</span>&nbsp;<span class="ident" id="1409413">l</span><span class="op" id="1409414">.</span><span class="ident" id="1409415">shared</span>&nbsp;<span class="op" id="1409422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1409428">l</span><span class="op" id="1409429">.</span><span class="ident" id="1409430">shared</span><span class="op" id="1409436">[</span><span class="ident" id="1409437">j</span><span class="op" id="1409438">]</span>&nbsp;<span class="op" id="1409440">=</span>&nbsp;<span class="ident" id="1409442">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1409449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1409454">l</span><span class="op" id="1409455">.</span><span class="ident" id="1409456">shared</span>&nbsp;<span class="op" id="1409463">=</span>&nbsp;<span class="ident" id="1409465">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1409471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1409475">p</span><span class="op" id="1409476">.</span><span class="ident" id="1409477">local</span>&nbsp;<span class="op" id="1409483">=</span>&nbsp;<span class="ident" id="1409485">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1409491">p</span><span class="op" id="1409492">.</span><span class="ident" id="1409493">localSize</span>&nbsp;<span class="op" id="1409503">=</span>&nbsp;<span class="num" id="1409505">0</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1409508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1409511">allPools</span>&nbsp;<span class="op" id="1409520">=</span>&nbsp;<span class="op" id="1409522">[</span><span class="op" id="1409523">]</span><span class="op" id="1409524">*</span><span class="ident" id="1409525">Pool</span><span class="op" id="1409529">{</span><span class="op" id="1409530">}</span><br>
<span class="lineno"></span><span class="op" id="1409532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1409535">var</span>&nbsp;<span class="op" id="1409539">(</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1409542">allPoolsMu</span>&nbsp;<span class="ident" id="1409553">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1409560">allPools</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1409571">[</span><span class="op" id="1409572">]</span><span class="op" id="1409573">*</span><span class="ident" id="1409574">Pool</span><br>
<span class="lineno"></span><span class="op" id="1409579">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1409582">func</span>&nbsp;<span class="ident" id="1409587">init</span><span class="op" id="1409591">(</span><span class="op" id="1409592">)</span>&nbsp;<span class="op" id="1409594">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1409597">runtime_registerPoolCleanup</span><span class="op" id="1409624">(</span><span class="ident" id="1409625">poolCleanup</span><span class="op" id="1409636">)</span><br>
<span class="lineno"></span><span class="op" id="1409638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1409641">func</span>&nbsp;<span class="ident" id="1409646">indexLocal</span><span class="op" id="1409656">(</span><span class="ident" id="1409657">l</span>&nbsp;<span class="ident" id="1409659">unsafe</span><span class="op" id="1409665">.</span><span class="ident" id="1409666">Pointer</span><span class="op" id="1409673">,</span>&nbsp;<span class="ident" id="1409675">i</span>&nbsp;<span class="builtintype" id="1409677">int</span><span class="op" id="1409680">)</span>&nbsp;<span class="op" id="1409682">*</span><span class="ident" id="1409683">poolLocal</span>&nbsp;<span class="op" id="1409693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1409696">return</span>&nbsp;<span class="op" id="1409703">&amp;</span><span class="op" id="1409704">(</span><span class="op" id="1409705">*</span><span class="op" id="1409706">[</span><span class="num" id="1409707">1000000</span><span class="op" id="1409714">]</span><span class="ident" id="1409715">poolLocal</span><span class="op" id="1409724">)</span><span class="op" id="1409725">(</span><span class="ident" id="1409726">l</span><span class="op" id="1409727">)</span><span class="op" id="1409728">[</span><span class="ident" id="1409729">i</span><span class="op" id="1409730">]</span><br>
<span class="lineno">220</span><span class="op" id="1409732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1409735">//&nbsp;Implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1409762">func</span>&nbsp;<span class="ident" id="1409767">runtime_registerPoolCleanup</span><span class="op" id="1409794">(</span><span class="ident" id="1409795">cleanup</span>&nbsp;<span class="keyword" id="1409803">func</span><span class="op" id="1409807">(</span><span class="op" id="1409808">)</span><span class="op" id="1409809">)</span><br>
<span class="lineno"></span><span class="keyword" id="1409811">func</span>&nbsp;<span class="ident" id="1409816">runtime_procPin</span><span class="op" id="1409831">(</span><span class="op" id="1409832">)</span>&nbsp;<span class="builtintype" id="1409834">int</span><br>
<span class="lineno">225</span><span class="keyword" id="1409838">func</span>&nbsp;<span class="ident" id="1409843">runtime_procUnpin</span><span class="op" id="1409860">(</span><span class="op" id="1409861">)</span>
</div>
</body>
</html>
