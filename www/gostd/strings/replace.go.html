<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>strings</h2>
<ul>
<li><a href="/gostd/strings/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/strings/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/strings/reader.go.html">reader.go</a></li>
<li><a href="/gostd/strings/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/strings/replace.go.html" class="current">replace.go</a></li>
<li><a href="/gostd/strings/replace_test.go.html">replace_test.go</a></li>
<li><a href="/gostd/strings/search.go.html">search.go</a></li>
<li><a href="/gostd/strings/search_test.go.html">search_test.go</a></li>
<li><a href="/gostd/strings/strings.go.html">strings.go</a></li>
<li><a href="/gostd/strings/strings_decl.go.html">strings_decl.go</a></li>
<li><a href="/gostd/strings/strings_test.go.html">strings_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2883866">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2883921">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2883975">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2884026">package</span>&nbsp;<span class="ident" id="2884034">strings</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2884043">import</span>&nbsp;<span class="string" id="2884050">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2884056">//&nbsp;Replacer&nbsp;replaces&nbsp;a&nbsp;list&nbsp;of&nbsp;strings&nbsp;with&nbsp;replacements.</span><br>
<span class="lineno">10</span><span class="comment" id="2884114">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="2884171">type</span>&nbsp;<span class="ident" id="2884176">Replacer</span>&nbsp;<span class="keyword" id="2884185">struct</span>&nbsp;<span class="op" id="2884192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2884195">r</span>&nbsp;<span class="ident" id="2884197">replacer</span><br>
<span class="lineno"></span><span class="op" id="2884206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2884209">//&nbsp;replacer&nbsp;is&nbsp;the&nbsp;interface&nbsp;that&nbsp;a&nbsp;replacement&nbsp;algorithm&nbsp;needs&nbsp;to&nbsp;implement.</span><br>
<span class="lineno"></span><span class="keyword" id="2884287">type</span>&nbsp;<span class="ident" id="2884292">replacer</span>&nbsp;<span class="keyword" id="2884301">interface</span>&nbsp;<span class="op" id="2884311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2884314">Replace</span><span class="op" id="2884321">(</span><span class="ident" id="2884322">s</span>&nbsp;<span class="builtintype" id="2884324">string</span><span class="op" id="2884330">)</span>&nbsp;<span class="builtintype" id="2884332">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2884340">WriteString</span><span class="op" id="2884351">(</span><span class="ident" id="2884352">w</span>&nbsp;<span class="ident" id="2884354">io</span><span class="op" id="2884356">.</span><span class="ident" id="2884357">Writer</span><span class="op" id="2884363">,</span>&nbsp;<span class="ident" id="2884365">s</span>&nbsp;<span class="builtintype" id="2884367">string</span><span class="op" id="2884373">)</span>&nbsp;<span class="op" id="2884375">(</span><span class="ident" id="2884376">n</span>&nbsp;<span class="builtintype" id="2884378">int</span><span class="op" id="2884381">,</span>&nbsp;<span class="ident" id="2884383">err</span>&nbsp;<span class="builtintype" id="2884387">error</span><span class="op" id="2884392">)</span><br>
<span class="lineno"></span><span class="op" id="2884394">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="2884397">//&nbsp;NewReplacer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Replacer&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;old,&nbsp;new&nbsp;string&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment" id="2884473">//&nbsp;Replacements&nbsp;are&nbsp;performed&nbsp;in&nbsp;order,&nbsp;without&nbsp;overlapping&nbsp;matches.</span><br>
<span class="lineno"></span><span class="keyword" id="2884542">func</span>&nbsp;<span class="ident" id="2884547">NewReplacer</span><span class="op" id="2884558">(</span><span class="ident" id="2884559">oldnew</span>&nbsp;<span class="op" id="2884566">...</span><span class="builtintype" id="2884569">string</span><span class="op" id="2884575">)</span>&nbsp;<span class="op" id="2884577">*</span><span class="ident" id="2884578">Replacer</span>&nbsp;<span class="op" id="2884587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2884590">if</span>&nbsp;<span class="builtinfunc" id="2884593">len</span><span class="op" id="2884596">(</span><span class="ident" id="2884597">oldnew</span><span class="op" id="2884603">)</span><span class="op" id="2884604">%</span><span class="num" id="2884605">2</span>&nbsp;<span class="op" id="2884607">==</span>&nbsp;<span class="num" id="2884610">1</span>&nbsp;<span class="op" id="2884612">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2884616">panic</span><span class="op" id="2884621">(</span><span class="string" id="2884622">&#34;strings.NewReplacer:&nbsp;odd&nbsp;argument&nbsp;count&#34;</span><span class="op" id="2884663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2884666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2884670">if</span>&nbsp;<span class="builtinfunc" id="2884673">len</span><span class="op" id="2884676">(</span><span class="ident" id="2884677">oldnew</span><span class="op" id="2884683">)</span>&nbsp;<span class="op" id="2884685">==</span>&nbsp;<span class="num" id="2884688">2</span>&nbsp;<span class="op" id="2884690">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2884693">len</span><span class="op" id="2884696">(</span><span class="ident" id="2884697">oldnew</span><span class="op" id="2884703">[</span><span class="num" id="2884704">0</span><span class="op" id="2884705">]</span><span class="op" id="2884706">)</span>&nbsp;<span class="op" id="2884708">&gt;</span>&nbsp;<span class="num" id="2884710">1</span>&nbsp;<span class="op" id="2884712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2884716">return</span>&nbsp;<span class="op" id="2884723">&amp;</span><span class="ident" id="2884724">Replacer</span><span class="op" id="2884732">{</span><span class="ident" id="2884733">r</span><span class="op" id="2884734">:</span>&nbsp;<span class="ident" id="2884736">makeSingleStringReplacer</span><span class="op" id="2884760">(</span><span class="ident" id="2884761">oldnew</span><span class="op" id="2884767">[</span><span class="num" id="2884768">0</span><span class="op" id="2884769">]</span><span class="op" id="2884770">,</span>&nbsp;<span class="ident" id="2884772">oldnew</span><span class="op" id="2884778">[</span><span class="num" id="2884779">1</span><span class="op" id="2884780">]</span><span class="op" id="2884781">)</span><span class="op" id="2884782">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2884785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2884789">allNewBytes</span>&nbsp;<span class="op" id="2884801">:=</span>&nbsp;<span class="builtintype" id="2884804">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2884810">for</span>&nbsp;<span class="ident" id="2884814">i</span>&nbsp;<span class="op" id="2884816">:=</span>&nbsp;<span class="num" id="2884819">0</span><span class="op" id="2884820">;</span>&nbsp;<span class="ident" id="2884822">i</span>&nbsp;<span class="op" id="2884824">&lt;</span>&nbsp;<span class="builtinfunc" id="2884826">len</span><span class="op" id="2884829">(</span><span class="ident" id="2884830">oldnew</span><span class="op" id="2884836">)</span><span class="op" id="2884837">;</span>&nbsp;<span class="ident" id="2884839">i</span>&nbsp;<span class="op" id="2884841">+=</span>&nbsp;<span class="num" id="2884844">2</span>&nbsp;<span class="op" id="2884846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2884850">if</span>&nbsp;<span class="builtinfunc" id="2884853">len</span><span class="op" id="2884856">(</span><span class="ident" id="2884857">oldnew</span><span class="op" id="2884863">[</span><span class="ident" id="2884864">i</span><span class="op" id="2884865">]</span><span class="op" id="2884866">)</span>&nbsp;<span class="op" id="2884868">!=</span>&nbsp;<span class="num" id="2884871">1</span>&nbsp;<span class="op" id="2884873">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2884878">return</span>&nbsp;<span class="op" id="2884885">&amp;</span><span class="ident" id="2884886">Replacer</span><span class="op" id="2884894">{</span><span class="ident" id="2884895">r</span><span class="op" id="2884896">:</span>&nbsp;<span class="ident" id="2884898">makeGenericReplacer</span><span class="op" id="2884917">(</span><span class="ident" id="2884918">oldnew</span><span class="op" id="2884924">)</span><span class="op" id="2884925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2884929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2884933">if</span>&nbsp;<span class="builtinfunc" id="2884936">len</span><span class="op" id="2884939">(</span><span class="ident" id="2884940">oldnew</span><span class="op" id="2884946">[</span><span class="ident" id="2884947">i</span><span class="op" id="2884948">+</span><span class="num" id="2884949">1</span><span class="op" id="2884950">]</span><span class="op" id="2884951">)</span>&nbsp;<span class="op" id="2884953">!=</span>&nbsp;<span class="num" id="2884956">1</span>&nbsp;<span class="op" id="2884958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2884963">allNewBytes</span>&nbsp;<span class="op" id="2884975">=</span>&nbsp;<span class="builtintype" id="2884977">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2884985">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2884988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2884992">if</span>&nbsp;<span class="ident" id="2884995">allNewBytes</span>&nbsp;<span class="op" id="2885007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2885011">r</span>&nbsp;<span class="op" id="2885013">:=</span>&nbsp;<span class="ident" id="2885016">byteReplacer</span><span class="op" id="2885028">{</span><span class="op" id="2885029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2885033">for</span>&nbsp;<span class="ident" id="2885037">i</span>&nbsp;<span class="op" id="2885039">:=</span>&nbsp;<span class="keyword" id="2885042">range</span>&nbsp;<span class="ident" id="2885048">r</span>&nbsp;<span class="op" id="2885050">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2885055">r</span><span class="op" id="2885056">[</span><span class="ident" id="2885057">i</span><span class="op" id="2885058">]</span>&nbsp;<span class="op" id="2885060">=</span>&nbsp;<span class="builtintype" id="2885062">byte</span><span class="op" id="2885066">(</span><span class="ident" id="2885067">i</span><span class="op" id="2885068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2885072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2885076">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2885135">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2885182">for</span>&nbsp;<span class="ident" id="2885186">i</span>&nbsp;<span class="op" id="2885188">:=</span>&nbsp;<span class="builtinfunc" id="2885191">len</span><span class="op" id="2885194">(</span><span class="ident" id="2885195">oldnew</span><span class="op" id="2885201">)</span>&nbsp;<span class="op" id="2885203">-</span>&nbsp;<span class="num" id="2885205">2</span><span class="op" id="2885206">;</span>&nbsp;<span class="ident" id="2885208">i</span>&nbsp;<span class="op" id="2885210">&gt;=</span>&nbsp;<span class="num" id="2885213">0</span><span class="op" id="2885214">;</span>&nbsp;<span class="ident" id="2885216">i</span>&nbsp;<span class="op" id="2885218">-=</span>&nbsp;<span class="num" id="2885221">2</span>&nbsp;<span class="op" id="2885223">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2885228">o</span>&nbsp;<span class="op" id="2885230">:=</span>&nbsp;<span class="ident" id="2885233">oldnew</span><span class="op" id="2885239">[</span><span class="ident" id="2885240">i</span><span class="op" id="2885241">]</span><span class="op" id="2885242">[</span><span class="num" id="2885243">0</span><span class="op" id="2885244">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2885249">n</span>&nbsp;<span class="op" id="2885251">:=</span>&nbsp;<span class="ident" id="2885254">oldnew</span><span class="op" id="2885260">[</span><span class="ident" id="2885261">i</span><span class="op" id="2885262">+</span><span class="num" id="2885263">1</span><span class="op" id="2885264">]</span><span class="op" id="2885265">[</span><span class="num" id="2885266">0</span><span class="op" id="2885267">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2885272">r</span><span class="op" id="2885273">[</span><span class="ident" id="2885274">o</span><span class="op" id="2885275">]</span>&nbsp;<span class="op" id="2885277">=</span>&nbsp;<span class="ident" id="2885279">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2885283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2885287">return</span>&nbsp;<span class="op" id="2885294">&amp;</span><span class="ident" id="2885295">Replacer</span><span class="op" id="2885303">{</span><span class="ident" id="2885304">r</span><span class="op" id="2885305">:</span>&nbsp;<span class="op" id="2885307">&amp;</span><span class="ident" id="2885308">r</span><span class="op" id="2885309">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2885312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2885316">r</span>&nbsp;<span class="op" id="2885318">:=</span>&nbsp;<span class="ident" id="2885321">byteStringReplacer</span><span class="op" id="2885339">{</span><span class="op" id="2885340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2885343">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2885401">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2885447">for</span>&nbsp;<span class="ident" id="2885451">i</span>&nbsp;<span class="op" id="2885453">:=</span>&nbsp;<span class="builtinfunc" id="2885456">len</span><span class="op" id="2885459">(</span><span class="ident" id="2885460">oldnew</span><span class="op" id="2885466">)</span>&nbsp;<span class="op" id="2885468">-</span>&nbsp;<span class="num" id="2885470">2</span><span class="op" id="2885471">;</span>&nbsp;<span class="ident" id="2885473">i</span>&nbsp;<span class="op" id="2885475">&gt;=</span>&nbsp;<span class="num" id="2885478">0</span><span class="op" id="2885479">;</span>&nbsp;<span class="ident" id="2885481">i</span>&nbsp;<span class="op" id="2885483">-=</span>&nbsp;<span class="num" id="2885486">2</span>&nbsp;<span class="op" id="2885488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2885492">o</span>&nbsp;<span class="op" id="2885494">:=</span>&nbsp;<span class="ident" id="2885497">oldnew</span><span class="op" id="2885503">[</span><span class="ident" id="2885504">i</span><span class="op" id="2885505">]</span><span class="op" id="2885506">[</span><span class="num" id="2885507">0</span><span class="op" id="2885508">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2885512">n</span>&nbsp;<span class="op" id="2885514">:=</span>&nbsp;<span class="ident" id="2885517">oldnew</span><span class="op" id="2885523">[</span><span class="ident" id="2885524">i</span><span class="op" id="2885525">+</span><span class="num" id="2885526">1</span><span class="op" id="2885527">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2885531">r</span><span class="op" id="2885532">[</span><span class="ident" id="2885533">o</span><span class="op" id="2885534">]</span>&nbsp;<span class="op" id="2885536">=</span>&nbsp;<span class="op" id="2885538">[</span><span class="op" id="2885539">]</span><span class="builtintype" id="2885540">byte</span><span class="op" id="2885544">(</span><span class="ident" id="2885545">n</span><span class="op" id="2885546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2885549">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2885552">return</span>&nbsp;<span class="op" id="2885559">&amp;</span><span class="ident" id="2885560">Replacer</span><span class="op" id="2885568">{</span><span class="ident" id="2885569">r</span><span class="op" id="2885570">:</span>&nbsp;<span class="op" id="2885572">&amp;</span><span class="ident" id="2885573">r</span><span class="op" id="2885574">}</span><br>
<span class="lineno"></span><span class="op" id="2885576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2885579">//&nbsp;Replace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;s&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2885643">func</span>&nbsp;<span class="op" id="2885648">(</span><span class="ident" id="2885649">r</span>&nbsp;<span class="op" id="2885651">*</span><span class="ident" id="2885652">Replacer</span><span class="op" id="2885660">)</span>&nbsp;<span class="ident" id="2885662">Replace</span><span class="op" id="2885669">(</span><span class="ident" id="2885670">s</span>&nbsp;<span class="builtintype" id="2885672">string</span><span class="op" id="2885678">)</span>&nbsp;<span class="builtintype" id="2885680">string</span>&nbsp;<span class="op" id="2885687">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2885690">return</span>&nbsp;<span class="ident" id="2885697">r</span><span class="op" id="2885698">.</span><span class="ident" id="2885699">r</span><span class="op" id="2885700">.</span><span class="ident" id="2885701">Replace</span><span class="op" id="2885708">(</span><span class="ident" id="2885709">s</span><span class="op" id="2885710">)</span><br>
<span class="lineno"></span><span class="op" id="2885712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2885715">//&nbsp;WriteString&nbsp;writes&nbsp;s&nbsp;to&nbsp;w&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2885777">func</span>&nbsp;<span class="op" id="2885782">(</span><span class="ident" id="2885783">r</span>&nbsp;<span class="op" id="2885785">*</span><span class="ident" id="2885786">Replacer</span><span class="op" id="2885794">)</span>&nbsp;<span class="ident" id="2885796">WriteString</span><span class="op" id="2885807">(</span><span class="ident" id="2885808">w</span>&nbsp;<span class="ident" id="2885810">io</span><span class="op" id="2885812">.</span><span class="ident" id="2885813">Writer</span><span class="op" id="2885819">,</span>&nbsp;<span class="ident" id="2885821">s</span>&nbsp;<span class="builtintype" id="2885823">string</span><span class="op" id="2885829">)</span>&nbsp;<span class="op" id="2885831">(</span><span class="ident" id="2885832">n</span>&nbsp;<span class="builtintype" id="2885834">int</span><span class="op" id="2885837">,</span>&nbsp;<span class="ident" id="2885839">err</span>&nbsp;<span class="builtintype" id="2885843">error</span><span class="op" id="2885848">)</span>&nbsp;<span class="op" id="2885850">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2885853">return</span>&nbsp;<span class="ident" id="2885860">r</span><span class="op" id="2885861">.</span><span class="ident" id="2885862">r</span><span class="op" id="2885863">.</span><span class="ident" id="2885864">WriteString</span><span class="op" id="2885875">(</span><span class="ident" id="2885876">w</span><span class="op" id="2885877">,</span>&nbsp;<span class="ident" id="2885879">s</span><span class="op" id="2885880">)</span><br>
<span class="lineno"></span><span class="op" id="2885882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2885885">//&nbsp;trieNode&nbsp;is&nbsp;a&nbsp;node&nbsp;in&nbsp;a&nbsp;lookup&nbsp;trie&nbsp;for&nbsp;prioritized&nbsp;key/value&nbsp;pairs.&nbsp;Keys</span><br>
<span class="lineno"></span><span class="comment" id="2885962">//&nbsp;and&nbsp;values&nbsp;may&nbsp;be&nbsp;empty.&nbsp;For&nbsp;example,&nbsp;the&nbsp;trie&nbsp;containing&nbsp;keys&nbsp;&#34;ax&#34;,&nbsp;&#34;ay&#34;,</span><br>
<span class="lineno">80</span><span class="comment" id="2886040">//&nbsp;&#34;bcbc&#34;,&nbsp;&#34;x&#34;&nbsp;and&nbsp;&#34;xy&#34;&nbsp;could&nbsp;have&nbsp;eight&nbsp;nodes:</span><br>
<span class="lineno"></span><span class="comment" id="2886088">//</span><br>
<span class="lineno"></span><span class="comment" id="2886091">//&nbsp;&nbsp;n0&nbsp;&nbsp;-</span><br>
<span class="lineno"></span><span class="comment" id="2886101">//&nbsp;&nbsp;n1&nbsp;&nbsp;a-</span><br>
<span class="lineno"></span><span class="comment" id="2886112">//&nbsp;&nbsp;n2&nbsp;&nbsp;.x+</span><br>
<span class="lineno">85</span><span class="comment" id="2886124">//&nbsp;&nbsp;n3&nbsp;&nbsp;.y+</span><br>
<span class="lineno"></span><span class="comment" id="2886136">//&nbsp;&nbsp;n4&nbsp;&nbsp;b-</span><br>
<span class="lineno"></span><span class="comment" id="2886147">//&nbsp;&nbsp;n5&nbsp;&nbsp;.cbc+</span><br>
<span class="lineno"></span><span class="comment" id="2886161">//&nbsp;&nbsp;n6&nbsp;&nbsp;x+</span><br>
<span class="lineno"></span><span class="comment" id="2886172">//&nbsp;&nbsp;n7&nbsp;&nbsp;.y+</span><br>
<span class="lineno">90</span><span class="comment" id="2886184">//</span><br>
<span class="lineno"></span><span class="comment" id="2886187">//&nbsp;n0&nbsp;is&nbsp;the&nbsp;root&nbsp;node,&nbsp;and&nbsp;its&nbsp;children&nbsp;are&nbsp;n1,&nbsp;n4&nbsp;and&nbsp;n6;&nbsp;n1&#39;s&nbsp;children&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2886265">//&nbsp;n2&nbsp;and&nbsp;n3;&nbsp;n4&#39;s&nbsp;child&nbsp;is&nbsp;n5;&nbsp;n6&#39;s&nbsp;child&nbsp;is&nbsp;n7.&nbsp;Nodes&nbsp;n0,&nbsp;n1&nbsp;and&nbsp;n4&nbsp;(marked</span><br>
<span class="lineno"></span><span class="comment" id="2886343">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;-&#34;)&nbsp;are&nbsp;partial&nbsp;keys,&nbsp;and&nbsp;nodes&nbsp;n2,&nbsp;n3,&nbsp;n5,&nbsp;n6&nbsp;and&nbsp;n7</span><br>
<span class="lineno"></span><span class="comment" id="2886417">//&nbsp;(marked&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;)&nbsp;are&nbsp;complete&nbsp;keys.</span><br>
<span class="lineno">95</span><span class="keyword" id="2886468">type</span>&nbsp;<span class="ident" id="2886473">trieNode</span>&nbsp;<span class="keyword" id="2886482">struct</span>&nbsp;<span class="op" id="2886489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2886492">//&nbsp;value&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s&nbsp;key/value&nbsp;pair.&nbsp;It&nbsp;is&nbsp;empty&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2886565">//&nbsp;this&nbsp;node&nbsp;is&nbsp;not&nbsp;a&nbsp;complete&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2886602">value</span>&nbsp;<span class="builtintype" id="2886608">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2886616">//&nbsp;priority&nbsp;is&nbsp;the&nbsp;priority&nbsp;(higher&nbsp;is&nbsp;more&nbsp;important)&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2886691">//&nbsp;key/value&nbsp;pair;&nbsp;keys&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;matched&nbsp;shortest-&nbsp;or&nbsp;longest-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2886766">//&nbsp;first.&nbsp;Priority&nbsp;is&nbsp;positive&nbsp;if&nbsp;this&nbsp;node&nbsp;is&nbsp;a&nbsp;complete&nbsp;key,&nbsp;and&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2886839">//&nbsp;otherwise.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;positive/zero&nbsp;priorities&nbsp;are&nbsp;marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2886912">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;&nbsp;or&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2886944">priority</span>&nbsp;<span class="builtintype" id="2886953">int</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2886959">//&nbsp;A&nbsp;trie&nbsp;node&nbsp;may&nbsp;have&nbsp;zero,&nbsp;one&nbsp;or&nbsp;more&nbsp;child&nbsp;nodes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887015">//&nbsp;&nbsp;*&nbsp;if&nbsp;the&nbsp;remaining&nbsp;fields&nbsp;are&nbsp;zero,&nbsp;there&nbsp;are&nbsp;no&nbsp;children.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887079">//&nbsp;&nbsp;*&nbsp;if&nbsp;prefix&nbsp;and&nbsp;next&nbsp;are&nbsp;non-zero,&nbsp;there&nbsp;is&nbsp;one&nbsp;child&nbsp;in&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887147">//&nbsp;&nbsp;*&nbsp;if&nbsp;table&nbsp;is&nbsp;non-zero,&nbsp;it&nbsp;defines&nbsp;all&nbsp;the&nbsp;children.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887205">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887209">//&nbsp;Prefixes&nbsp;are&nbsp;preferred&nbsp;over&nbsp;tables&nbsp;when&nbsp;there&nbsp;is&nbsp;one&nbsp;child,&nbsp;but&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887281">//&nbsp;root&nbsp;node&nbsp;always&nbsp;uses&nbsp;a&nbsp;table&nbsp;for&nbsp;lookup&nbsp;efficiency.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887339">//&nbsp;prefix&nbsp;is&nbsp;the&nbsp;difference&nbsp;in&nbsp;keys&nbsp;between&nbsp;this&nbsp;trie&nbsp;node&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887413">//&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;node&nbsp;n4&nbsp;has&nbsp;prefix&nbsp;&#34;cbc&#34;&nbsp;and&nbsp;n4&#39;s&nbsp;next&nbsp;node&nbsp;is&nbsp;n5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887490">//&nbsp;Node&nbsp;n5&nbsp;has&nbsp;no&nbsp;children&nbsp;and&nbsp;so&nbsp;has&nbsp;zero&nbsp;prefix,&nbsp;next&nbsp;and&nbsp;table&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2887565">prefix</span>&nbsp;<span class="builtintype" id="2887572">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2887580">next</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2887587">*</span><span class="ident" id="2887588">trieNode</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887599">//&nbsp;table&nbsp;is&nbsp;a&nbsp;lookup&nbsp;table&nbsp;indexed&nbsp;by&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;key,&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887670">//&nbsp;remapping&nbsp;that&nbsp;byte&nbsp;through&nbsp;genericReplacer.mapping&nbsp;to&nbsp;create&nbsp;a&nbsp;dense</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887744">//&nbsp;index.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;keys&nbsp;only&nbsp;use&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;,&nbsp;&#39;c&#39;,&nbsp;&#39;x&#39;&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887818">//&nbsp;&#39;y&#39;,&nbsp;which&nbsp;remap&nbsp;to&nbsp;0,&nbsp;1,&nbsp;2,&nbsp;3&nbsp;and&nbsp;4.&nbsp;All&nbsp;other&nbsp;bytes&nbsp;remap&nbsp;to&nbsp;5,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887892">//&nbsp;genericReplacer.tableSize&nbsp;will&nbsp;be&nbsp;5.&nbsp;Node&nbsp;n0&#39;s&nbsp;table&nbsp;will&nbsp;be</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2887957">//&nbsp;[]*trieNode{&nbsp;0:n1,&nbsp;1:n4,&nbsp;3:n6&nbsp;},&nbsp;where&nbsp;the&nbsp;0,&nbsp;1&nbsp;and&nbsp;3&nbsp;are&nbsp;the&nbsp;remapped</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2888032">//&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;&nbsp;and&nbsp;&#39;x&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2888054">table</span>&nbsp;<span class="op" id="2888060">[</span><span class="op" id="2888061">]</span><span class="op" id="2888062">*</span><span class="ident" id="2888063">trieNode</span><br>
<span class="lineno"></span><span class="op" id="2888072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2888075">func</span>&nbsp;<span class="op" id="2888080">(</span><span class="ident" id="2888081">t</span>&nbsp;<span class="op" id="2888083">*</span><span class="ident" id="2888084">trieNode</span><span class="op" id="2888092">)</span>&nbsp;<span class="ident" id="2888094">add</span><span class="op" id="2888097">(</span><span class="ident" id="2888098">key</span><span class="op" id="2888101">,</span>&nbsp;<span class="ident" id="2888103">val</span>&nbsp;<span class="builtintype" id="2888107">string</span><span class="op" id="2888113">,</span>&nbsp;<span class="ident" id="2888115">priority</span>&nbsp;<span class="builtintype" id="2888124">int</span><span class="op" id="2888127">,</span>&nbsp;<span class="ident" id="2888129">r</span>&nbsp;<span class="op" id="2888131">*</span><span class="ident" id="2888132">genericReplacer</span><span class="op" id="2888147">)</span>&nbsp;<span class="op" id="2888149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2888152">if</span>&nbsp;<span class="ident" id="2888155">key</span>&nbsp;<span class="op" id="2888159">==</span>&nbsp;<span class="string" id="2888162">&#34;&#34;</span>&nbsp;<span class="op" id="2888165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2888169">if</span>&nbsp;<span class="ident" id="2888172">t</span><span class="op" id="2888173">.</span><span class="ident" id="2888174">priority</span>&nbsp;<span class="op" id="2888183">==</span>&nbsp;<span class="num" id="2888186">0</span>&nbsp;<span class="op" id="2888188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2888193">t</span><span class="op" id="2888194">.</span><span class="ident" id="2888195">value</span>&nbsp;<span class="op" id="2888201">=</span>&nbsp;<span class="ident" id="2888203">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2888210">t</span><span class="op" id="2888211">.</span><span class="ident" id="2888212">priority</span>&nbsp;<span class="op" id="2888221">=</span>&nbsp;<span class="ident" id="2888223">priority</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2888234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2888238">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2888246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2888250">if</span>&nbsp;<span class="ident" id="2888253">t</span><span class="op" id="2888254">.</span><span class="ident" id="2888255">prefix</span>&nbsp;<span class="op" id="2888262">!=</span>&nbsp;<span class="string" id="2888265">&#34;&#34;</span>&nbsp;<span class="op" id="2888268">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2888272">//&nbsp;Need&nbsp;to&nbsp;split&nbsp;the&nbsp;prefix&nbsp;among&nbsp;multiple&nbsp;nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2888324">var</span>&nbsp;<span class="ident" id="2888328">n</span>&nbsp;<span class="builtintype" id="2888330">int</span>&nbsp;<span class="comment" id="2888334">//&nbsp;length&nbsp;of&nbsp;the&nbsp;longest&nbsp;common&nbsp;prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2888375">for</span>&nbsp;<span class="op" id="2888379">;</span>&nbsp;<span class="ident" id="2888381">n</span>&nbsp;<span class="op" id="2888383">&lt;</span>&nbsp;<span class="builtinfunc" id="2888385">len</span><span class="op" id="2888388">(</span><span class="ident" id="2888389">t</span><span class="op" id="2888390">.</span><span class="ident" id="2888391">prefix</span><span class="op" id="2888397">)</span>&nbsp;<span class="op" id="2888399">&amp;&amp;</span>&nbsp;<span class="ident" id="2888402">n</span>&nbsp;<span class="op" id="2888404">&lt;</span>&nbsp;<span class="builtinfunc" id="2888406">len</span><span class="op" id="2888409">(</span><span class="ident" id="2888410">key</span><span class="op" id="2888413">)</span><span class="op" id="2888414">;</span>&nbsp;<span class="ident" id="2888416">n</span><span class="op" id="2888417">++</span>&nbsp;<span class="op" id="2888420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2888425">if</span>&nbsp;<span class="ident" id="2888428">t</span><span class="op" id="2888429">.</span><span class="ident" id="2888430">prefix</span><span class="op" id="2888436">[</span><span class="ident" id="2888437">n</span><span class="op" id="2888438">]</span>&nbsp;<span class="op" id="2888440">!=</span>&nbsp;<span class="ident" id="2888443">key</span><span class="op" id="2888446">[</span><span class="ident" id="2888447">n</span><span class="op" id="2888448">]</span>&nbsp;<span class="op" id="2888450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2888456">break</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2888465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2888469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2888473">if</span>&nbsp;<span class="ident" id="2888476">n</span>&nbsp;<span class="op" id="2888478">==</span>&nbsp;<span class="builtinfunc" id="2888481">len</span><span class="op" id="2888484">(</span><span class="ident" id="2888485">t</span><span class="op" id="2888486">.</span><span class="ident" id="2888487">prefix</span><span class="op" id="2888493">)</span>&nbsp;<span class="op" id="2888495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2888500">t</span><span class="op" id="2888501">.</span><span class="ident" id="2888502">next</span><span class="op" id="2888506">.</span><span class="ident" id="2888507">add</span><span class="op" id="2888510">(</span><span class="ident" id="2888511">key</span><span class="op" id="2888514">[</span><span class="ident" id="2888515">n</span><span class="op" id="2888516">:</span><span class="op" id="2888517">]</span><span class="op" id="2888518">,</span>&nbsp;<span class="ident" id="2888520">val</span><span class="op" id="2888523">,</span>&nbsp;<span class="ident" id="2888525">priority</span><span class="op" id="2888533">,</span>&nbsp;<span class="ident" id="2888535">r</span><span class="op" id="2888536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2888540">}</span>&nbsp;<span class="keyword" id="2888542">else</span>&nbsp;<span class="keyword" id="2888547">if</span>&nbsp;<span class="ident" id="2888550">n</span>&nbsp;<span class="op" id="2888552">==</span>&nbsp;<span class="num" id="2888555">0</span>&nbsp;<span class="op" id="2888557">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2888562">//&nbsp;First&nbsp;byte&nbsp;differs,&nbsp;start&nbsp;a&nbsp;new&nbsp;lookup&nbsp;table&nbsp;here.&nbsp;Looking&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2888630">//&nbsp;what&nbsp;is&nbsp;currently&nbsp;t.prefix[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;prefixNode,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2888695">//&nbsp;looking&nbsp;up&nbsp;key[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;keyNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2888741">var</span>&nbsp;<span class="ident" id="2888745">prefixNode</span>&nbsp;<span class="op" id="2888756">*</span><span class="ident" id="2888757">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2888769">if</span>&nbsp;<span class="builtinfunc" id="2888772">len</span><span class="op" id="2888775">(</span><span class="ident" id="2888776">t</span><span class="op" id="2888777">.</span><span class="ident" id="2888778">prefix</span><span class="op" id="2888784">)</span>&nbsp;<span class="op" id="2888786">==</span>&nbsp;<span class="num" id="2888789">1</span>&nbsp;<span class="op" id="2888791">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2888797">prefixNode</span>&nbsp;<span class="op" id="2888808">=</span>&nbsp;<span class="ident" id="2888810">t</span><span class="op" id="2888811">.</span><span class="ident" id="2888812">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2888820">}</span>&nbsp;<span class="keyword" id="2888822">else</span>&nbsp;<span class="op" id="2888827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2888833">prefixNode</span>&nbsp;<span class="op" id="2888844">=</span>&nbsp;<span class="op" id="2888846">&amp;</span><span class="ident" id="2888847">trieNode</span><span class="op" id="2888855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2888862">prefix</span><span class="op" id="2888868">:</span>&nbsp;<span class="ident" id="2888870">t</span><span class="op" id="2888871">.</span><span class="ident" id="2888872">prefix</span><span class="op" id="2888878">[</span><span class="num" id="2888879">1</span><span class="op" id="2888880">:</span><span class="op" id="2888881">]</span><span class="op" id="2888882">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2888889">next</span><span class="op" id="2888893">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2888897">t</span><span class="op" id="2888898">.</span><span class="ident" id="2888899">next</span><span class="op" id="2888903">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2888909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2888914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2888919">keyNode</span>&nbsp;<span class="op" id="2888927">:=</span>&nbsp;<span class="builtinfunc" id="2888930">new</span><span class="op" id="2888933">(</span><span class="ident" id="2888934">trieNode</span><span class="op" id="2888942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2888947">t</span><span class="op" id="2888948">.</span><span class="ident" id="2888949">table</span>&nbsp;<span class="op" id="2888955">=</span>&nbsp;<span class="builtinfunc" id="2888957">make</span><span class="op" id="2888961">(</span><span class="op" id="2888962">[</span><span class="op" id="2888963">]</span><span class="op" id="2888964">*</span><span class="ident" id="2888965">trieNode</span><span class="op" id="2888973">,</span>&nbsp;<span class="ident" id="2888975">r</span><span class="op" id="2888976">.</span><span class="ident" id="2888977">tableSize</span><span class="op" id="2888986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2888991">t</span><span class="op" id="2888992">.</span><span class="ident" id="2888993">table</span><span class="op" id="2888998">[</span><span class="ident" id="2888999">r</span><span class="op" id="2889000">.</span><span class="ident" id="2889001">mapping</span><span class="op" id="2889008">[</span><span class="ident" id="2889009">t</span><span class="op" id="2889010">.</span><span class="ident" id="2889011">prefix</span><span class="op" id="2889017">[</span><span class="num" id="2889018">0</span><span class="op" id="2889019">]</span><span class="op" id="2889020">]</span><span class="op" id="2889021">]</span>&nbsp;<span class="op" id="2889023">=</span>&nbsp;<span class="ident" id="2889025">prefixNode</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889039">t</span><span class="op" id="2889040">.</span><span class="ident" id="2889041">table</span><span class="op" id="2889046">[</span><span class="ident" id="2889047">r</span><span class="op" id="2889048">.</span><span class="ident" id="2889049">mapping</span><span class="op" id="2889056">[</span><span class="ident" id="2889057">key</span><span class="op" id="2889060">[</span><span class="num" id="2889061">0</span><span class="op" id="2889062">]</span><span class="op" id="2889063">]</span><span class="op" id="2889064">]</span>&nbsp;<span class="op" id="2889066">=</span>&nbsp;<span class="ident" id="2889068">keyNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889079">t</span><span class="op" id="2889080">.</span><span class="ident" id="2889081">prefix</span>&nbsp;<span class="op" id="2889088">=</span>&nbsp;<span class="string" id="2889090">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889096">t</span><span class="op" id="2889097">.</span><span class="ident" id="2889098">next</span>&nbsp;<span class="op" id="2889103">=</span>&nbsp;<span class="ident" id="2889105">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889112">keyNode</span><span class="op" id="2889119">.</span><span class="ident" id="2889120">add</span><span class="op" id="2889123">(</span><span class="ident" id="2889124">key</span><span class="op" id="2889127">[</span><span class="num" id="2889128">1</span><span class="op" id="2889129">:</span><span class="op" id="2889130">]</span><span class="op" id="2889131">,</span>&nbsp;<span class="ident" id="2889133">val</span><span class="op" id="2889136">,</span>&nbsp;<span class="ident" id="2889138">priority</span><span class="op" id="2889146">,</span>&nbsp;<span class="ident" id="2889148">r</span><span class="op" id="2889149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2889153">}</span>&nbsp;<span class="keyword" id="2889155">else</span>&nbsp;<span class="op" id="2889160">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2889165">//&nbsp;Insert&nbsp;new&nbsp;node&nbsp;after&nbsp;the&nbsp;common&nbsp;section&nbsp;of&nbsp;the&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889227">next</span>&nbsp;<span class="op" id="2889232">:=</span>&nbsp;<span class="op" id="2889235">&amp;</span><span class="ident" id="2889236">trieNode</span><span class="op" id="2889244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889250">prefix</span><span class="op" id="2889256">:</span>&nbsp;<span class="ident" id="2889258">t</span><span class="op" id="2889259">.</span><span class="ident" id="2889260">prefix</span><span class="op" id="2889266">[</span><span class="ident" id="2889267">n</span><span class="op" id="2889268">:</span><span class="op" id="2889269">]</span><span class="op" id="2889270">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889276">next</span><span class="op" id="2889280">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2889284">t</span><span class="op" id="2889285">.</span><span class="ident" id="2889286">next</span><span class="op" id="2889290">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2889295">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889300">t</span><span class="op" id="2889301">.</span><span class="ident" id="2889302">prefix</span>&nbsp;<span class="op" id="2889309">=</span>&nbsp;<span class="ident" id="2889311">t</span><span class="op" id="2889312">.</span><span class="ident" id="2889313">prefix</span><span class="op" id="2889319">[</span><span class="op" id="2889320">:</span><span class="ident" id="2889321">n</span><span class="op" id="2889322">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889327">t</span><span class="op" id="2889328">.</span><span class="ident" id="2889329">next</span>&nbsp;<span class="op" id="2889334">=</span>&nbsp;<span class="ident" id="2889336">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889344">next</span><span class="op" id="2889348">.</span><span class="ident" id="2889349">add</span><span class="op" id="2889352">(</span><span class="ident" id="2889353">key</span><span class="op" id="2889356">[</span><span class="ident" id="2889357">n</span><span class="op" id="2889358">:</span><span class="op" id="2889359">]</span><span class="op" id="2889360">,</span>&nbsp;<span class="ident" id="2889362">val</span><span class="op" id="2889365">,</span>&nbsp;<span class="ident" id="2889367">priority</span><span class="op" id="2889375">,</span>&nbsp;<span class="ident" id="2889377">r</span><span class="op" id="2889378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2889382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2889385">}</span>&nbsp;<span class="keyword" id="2889387">else</span>&nbsp;<span class="keyword" id="2889392">if</span>&nbsp;<span class="ident" id="2889395">t</span><span class="op" id="2889396">.</span><span class="ident" id="2889397">table</span>&nbsp;<span class="op" id="2889403">!=</span>&nbsp;<span class="ident" id="2889406">nil</span>&nbsp;<span class="op" id="2889410">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2889414">//&nbsp;Insert&nbsp;into&nbsp;existing&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889447">m</span>&nbsp;<span class="op" id="2889449">:=</span>&nbsp;<span class="ident" id="2889452">r</span><span class="op" id="2889453">.</span><span class="ident" id="2889454">mapping</span><span class="op" id="2889461">[</span><span class="ident" id="2889462">key</span><span class="op" id="2889465">[</span><span class="num" id="2889466">0</span><span class="op" id="2889467">]</span><span class="op" id="2889468">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2889472">if</span>&nbsp;<span class="ident" id="2889475">t</span><span class="op" id="2889476">.</span><span class="ident" id="2889477">table</span><span class="op" id="2889482">[</span><span class="ident" id="2889483">m</span><span class="op" id="2889484">]</span>&nbsp;<span class="op" id="2889486">==</span>&nbsp;<span class="ident" id="2889489">nil</span>&nbsp;<span class="op" id="2889493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889498">t</span><span class="op" id="2889499">.</span><span class="ident" id="2889500">table</span><span class="op" id="2889505">[</span><span class="ident" id="2889506">m</span><span class="op" id="2889507">]</span>&nbsp;<span class="op" id="2889509">=</span>&nbsp;<span class="builtinfunc" id="2889511">new</span><span class="op" id="2889514">(</span><span class="ident" id="2889515">trieNode</span><span class="op" id="2889523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2889527">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889531">t</span><span class="op" id="2889532">.</span><span class="ident" id="2889533">table</span><span class="op" id="2889538">[</span><span class="ident" id="2889539">m</span><span class="op" id="2889540">]</span><span class="op" id="2889541">.</span><span class="ident" id="2889542">add</span><span class="op" id="2889545">(</span><span class="ident" id="2889546">key</span><span class="op" id="2889549">[</span><span class="num" id="2889550">1</span><span class="op" id="2889551">:</span><span class="op" id="2889552">]</span><span class="op" id="2889553">,</span>&nbsp;<span class="ident" id="2889555">val</span><span class="op" id="2889558">,</span>&nbsp;<span class="ident" id="2889560">priority</span><span class="op" id="2889568">,</span>&nbsp;<span class="ident" id="2889570">r</span><span class="op" id="2889571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2889574">}</span>&nbsp;<span class="keyword" id="2889576">else</span>&nbsp;<span class="op" id="2889581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889585">t</span><span class="op" id="2889586">.</span><span class="ident" id="2889587">prefix</span>&nbsp;<span class="op" id="2889594">=</span>&nbsp;<span class="ident" id="2889596">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889602">t</span><span class="op" id="2889603">.</span><span class="ident" id="2889604">next</span>&nbsp;<span class="op" id="2889609">=</span>&nbsp;<span class="builtinfunc" id="2889611">new</span><span class="op" id="2889614">(</span><span class="ident" id="2889615">trieNode</span><span class="op" id="2889623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889627">t</span><span class="op" id="2889628">.</span><span class="ident" id="2889629">next</span><span class="op" id="2889633">.</span><span class="ident" id="2889634">add</span><span class="op" id="2889637">(</span><span class="string" id="2889638">&#34;&#34;</span><span class="op" id="2889640">,</span>&nbsp;<span class="ident" id="2889642">val</span><span class="op" id="2889645">,</span>&nbsp;<span class="ident" id="2889647">priority</span><span class="op" id="2889655">,</span>&nbsp;<span class="ident" id="2889657">r</span><span class="op" id="2889658">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2889661">}</span><br>
<span class="lineno"></span><span class="op" id="2889663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2889666">func</span>&nbsp;<span class="op" id="2889671">(</span><span class="ident" id="2889672">r</span>&nbsp;<span class="op" id="2889674">*</span><span class="ident" id="2889675">genericReplacer</span><span class="op" id="2889690">)</span>&nbsp;<span class="ident" id="2889692">lookup</span><span class="op" id="2889698">(</span><span class="ident" id="2889699">s</span>&nbsp;<span class="builtintype" id="2889701">string</span><span class="op" id="2889707">,</span>&nbsp;<span class="ident" id="2889709">ignoreRoot</span>&nbsp;<span class="builtintype" id="2889720">bool</span><span class="op" id="2889724">)</span>&nbsp;<span class="op" id="2889726">(</span><span class="ident" id="2889727">val</span>&nbsp;<span class="builtintype" id="2889731">string</span><span class="op" id="2889737">,</span>&nbsp;<span class="ident" id="2889739">keylen</span>&nbsp;<span class="builtintype" id="2889746">int</span><span class="op" id="2889749">,</span>&nbsp;<span class="ident" id="2889751">found</span>&nbsp;<span class="builtintype" id="2889757">bool</span><span class="op" id="2889761">)</span>&nbsp;<span class="op" id="2889763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2889766">//&nbsp;Iterate&nbsp;down&nbsp;the&nbsp;trie&nbsp;to&nbsp;the&nbsp;end,&nbsp;and&nbsp;grab&nbsp;the&nbsp;value&nbsp;and&nbsp;keylen&nbsp;with</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2889839">//&nbsp;the&nbsp;highest&nbsp;priority.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889865">bestPriority</span>&nbsp;<span class="op" id="2889878">:=</span>&nbsp;<span class="num" id="2889881">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889884">node</span>&nbsp;<span class="op" id="2889889">:=</span>&nbsp;<span class="op" id="2889892">&amp;</span><span class="ident" id="2889893">r</span><span class="op" id="2889894">.</span><span class="ident" id="2889895">root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2889901">n</span>&nbsp;<span class="op" id="2889903">:=</span>&nbsp;<span class="num" id="2889906">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2889909">for</span>&nbsp;<span class="ident" id="2889913">node</span>&nbsp;<span class="op" id="2889918">!=</span>&nbsp;<span class="ident" id="2889921">nil</span>&nbsp;<span class="op" id="2889925">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2889929">if</span>&nbsp;<span class="ident" id="2889932">node</span><span class="op" id="2889936">.</span><span class="ident" id="2889937">priority</span>&nbsp;<span class="op" id="2889946">&gt;</span>&nbsp;<span class="ident" id="2889948">bestPriority</span>&nbsp;<span class="op" id="2889961">&amp;&amp;</span>&nbsp;<span class="op" id="2889964">!</span><span class="op" id="2889965">(</span><span class="ident" id="2889966">ignoreRoot</span>&nbsp;<span class="op" id="2889977">&amp;&amp;</span>&nbsp;<span class="ident" id="2889980">node</span>&nbsp;<span class="op" id="2889985">==</span>&nbsp;<span class="op" id="2889988">&amp;</span><span class="ident" id="2889989">r</span><span class="op" id="2889990">.</span><span class="ident" id="2889991">root</span><span class="op" id="2889995">)</span>&nbsp;<span class="op" id="2889997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890002">bestPriority</span>&nbsp;<span class="op" id="2890015">=</span>&nbsp;<span class="ident" id="2890017">node</span><span class="op" id="2890021">.</span><span class="ident" id="2890022">priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890034">val</span>&nbsp;<span class="op" id="2890038">=</span>&nbsp;<span class="ident" id="2890040">node</span><span class="op" id="2890044">.</span><span class="ident" id="2890045">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890054">keylen</span>&nbsp;<span class="op" id="2890061">=</span>&nbsp;<span class="ident" id="2890063">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890068">found</span>&nbsp;<span class="op" id="2890074">=</span>&nbsp;<span class="builtintype" id="2890076">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2890083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2890088">if</span>&nbsp;<span class="ident" id="2890091">s</span>&nbsp;<span class="op" id="2890093">==</span>&nbsp;<span class="string" id="2890096">&#34;&#34;</span>&nbsp;<span class="op" id="2890099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2890104">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2890112">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2890116">if</span>&nbsp;<span class="ident" id="2890119">node</span><span class="op" id="2890123">.</span><span class="ident" id="2890124">table</span>&nbsp;<span class="op" id="2890130">!=</span>&nbsp;<span class="ident" id="2890133">nil</span>&nbsp;<span class="op" id="2890137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890142">index</span>&nbsp;<span class="op" id="2890148">:=</span>&nbsp;<span class="ident" id="2890151">r</span><span class="op" id="2890152">.</span><span class="ident" id="2890153">mapping</span><span class="op" id="2890160">[</span><span class="ident" id="2890161">s</span><span class="op" id="2890162">[</span><span class="num" id="2890163">0</span><span class="op" id="2890164">]</span><span class="op" id="2890165">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2890170">if</span>&nbsp;<span class="builtintype" id="2890173">int</span><span class="op" id="2890176">(</span><span class="ident" id="2890177">index</span><span class="op" id="2890182">)</span>&nbsp;<span class="op" id="2890184">==</span>&nbsp;<span class="ident" id="2890187">r</span><span class="op" id="2890188">.</span><span class="ident" id="2890189">tableSize</span>&nbsp;<span class="op" id="2890199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2890205">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2890214">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890219">node</span>&nbsp;<span class="op" id="2890224">=</span>&nbsp;<span class="ident" id="2890226">node</span><span class="op" id="2890230">.</span><span class="ident" id="2890231">table</span><span class="op" id="2890236">[</span><span class="ident" id="2890237">index</span><span class="op" id="2890242">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890247">s</span>&nbsp;<span class="op" id="2890249">=</span>&nbsp;<span class="ident" id="2890251">s</span><span class="op" id="2890252">[</span><span class="num" id="2890253">1</span><span class="op" id="2890254">:</span><span class="op" id="2890255">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890260">n</span><span class="op" id="2890261">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2890266">}</span>&nbsp;<span class="keyword" id="2890268">else</span>&nbsp;<span class="keyword" id="2890273">if</span>&nbsp;<span class="ident" id="2890276">node</span><span class="op" id="2890280">.</span><span class="ident" id="2890281">prefix</span>&nbsp;<span class="op" id="2890288">!=</span>&nbsp;<span class="string" id="2890291">&#34;&#34;</span>&nbsp;<span class="op" id="2890294">&amp;&amp;</span>&nbsp;<span class="ident" id="2890297">HasPrefix</span><span class="op" id="2890306">(</span><span class="ident" id="2890307">s</span><span class="op" id="2890308">,</span>&nbsp;<span class="ident" id="2890310">node</span><span class="op" id="2890314">.</span><span class="ident" id="2890315">prefix</span><span class="op" id="2890321">)</span>&nbsp;<span class="op" id="2890323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890328">n</span>&nbsp;<span class="op" id="2890330">+=</span>&nbsp;<span class="builtinfunc" id="2890333">len</span><span class="op" id="2890336">(</span><span class="ident" id="2890337">node</span><span class="op" id="2890341">.</span><span class="ident" id="2890342">prefix</span><span class="op" id="2890348">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890353">s</span>&nbsp;<span class="op" id="2890355">=</span>&nbsp;<span class="ident" id="2890357">s</span><span class="op" id="2890358">[</span><span class="builtinfunc" id="2890359">len</span><span class="op" id="2890362">(</span><span class="ident" id="2890363">node</span><span class="op" id="2890367">.</span><span class="ident" id="2890368">prefix</span><span class="op" id="2890374">)</span><span class="op" id="2890375">:</span><span class="op" id="2890376">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890381">node</span>&nbsp;<span class="op" id="2890386">=</span>&nbsp;<span class="ident" id="2890388">node</span><span class="op" id="2890392">.</span><span class="ident" id="2890393">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2890400">}</span>&nbsp;<span class="keyword" id="2890402">else</span>&nbsp;<span class="op" id="2890407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2890412">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2890420">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2890423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2890426">return</span><br>
<span class="lineno"></span><span class="op" id="2890433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2890436">//&nbsp;genericReplacer&nbsp;is&nbsp;the&nbsp;fully&nbsp;generic&nbsp;algorithm.</span><br>
<span class="lineno">230</span><span class="comment" id="2890487">//&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;fallback&nbsp;when&nbsp;nothing&nbsp;faster&nbsp;can&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2890547">type</span>&nbsp;<span class="ident" id="2890552">genericReplacer</span>&nbsp;<span class="keyword" id="2890568">struct</span>&nbsp;<span class="op" id="2890575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890578">root</span>&nbsp;<span class="ident" id="2890583">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2890593">//&nbsp;tableSize&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;trie&nbsp;node&#39;s&nbsp;lookup&nbsp;table.&nbsp;It&nbsp;is&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2890667">//&nbsp;of&nbsp;unique&nbsp;key&nbsp;bytes.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890692">tableSize</span>&nbsp;<span class="builtintype" id="2890702">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2890707">//&nbsp;mapping&nbsp;maps&nbsp;from&nbsp;key&nbsp;bytes&nbsp;to&nbsp;a&nbsp;dense&nbsp;index&nbsp;for&nbsp;trieNode.table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890776">mapping</span>&nbsp;<span class="op" id="2890784">[</span><span class="num" id="2890785">256</span><span class="op" id="2890788">]</span><span class="builtintype" id="2890789">byte</span><br>
<span class="lineno"></span><span class="op" id="2890794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="2890797">func</span>&nbsp;<span class="ident" id="2890802">makeGenericReplacer</span><span class="op" id="2890821">(</span><span class="ident" id="2890822">oldnew</span>&nbsp;<span class="op" id="2890829">[</span><span class="op" id="2890830">]</span><span class="builtintype" id="2890831">string</span><span class="op" id="2890837">)</span>&nbsp;<span class="op" id="2890839">*</span><span class="ident" id="2890840">genericReplacer</span>&nbsp;<span class="op" id="2890856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890859">r</span>&nbsp;<span class="op" id="2890861">:=</span>&nbsp;<span class="builtinfunc" id="2890864">new</span><span class="op" id="2890867">(</span><span class="ident" id="2890868">genericReplacer</span><span class="op" id="2890883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2890886">//&nbsp;Find&nbsp;each&nbsp;byte&nbsp;used,&nbsp;then&nbsp;assign&nbsp;them&nbsp;each&nbsp;an&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2890943">for</span>&nbsp;<span class="ident" id="2890947">i</span>&nbsp;<span class="op" id="2890949">:=</span>&nbsp;<span class="num" id="2890952">0</span><span class="op" id="2890953">;</span>&nbsp;<span class="ident" id="2890955">i</span>&nbsp;<span class="op" id="2890957">&lt;</span>&nbsp;<span class="builtinfunc" id="2890959">len</span><span class="op" id="2890962">(</span><span class="ident" id="2890963">oldnew</span><span class="op" id="2890969">)</span><span class="op" id="2890970">;</span>&nbsp;<span class="ident" id="2890972">i</span>&nbsp;<span class="op" id="2890974">+=</span>&nbsp;<span class="num" id="2890977">2</span>&nbsp;<span class="op" id="2890979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2890983">key</span>&nbsp;<span class="op" id="2890987">:=</span>&nbsp;<span class="ident" id="2890990">oldnew</span><span class="op" id="2890996">[</span><span class="ident" id="2890997">i</span><span class="op" id="2890998">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2891002">for</span>&nbsp;<span class="ident" id="2891006">j</span>&nbsp;<span class="op" id="2891008">:=</span>&nbsp;<span class="num" id="2891011">0</span><span class="op" id="2891012">;</span>&nbsp;<span class="ident" id="2891014">j</span>&nbsp;<span class="op" id="2891016">&lt;</span>&nbsp;<span class="builtinfunc" id="2891018">len</span><span class="op" id="2891021">(</span><span class="ident" id="2891022">key</span><span class="op" id="2891025">)</span><span class="op" id="2891026">;</span>&nbsp;<span class="ident" id="2891028">j</span><span class="op" id="2891029">++</span>&nbsp;<span class="op" id="2891032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2891037">r</span><span class="op" id="2891038">.</span><span class="ident" id="2891039">mapping</span><span class="op" id="2891046">[</span><span class="ident" id="2891047">key</span><span class="op" id="2891050">[</span><span class="ident" id="2891051">j</span><span class="op" id="2891052">]</span><span class="op" id="2891053">]</span>&nbsp;<span class="op" id="2891055">=</span>&nbsp;<span class="num" id="2891057">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2891061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2891064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2891068">for</span>&nbsp;<span class="ident" id="2891072">_</span><span class="op" id="2891073">,</span>&nbsp;<span class="ident" id="2891075">b</span>&nbsp;<span class="op" id="2891077">:=</span>&nbsp;<span class="keyword" id="2891080">range</span>&nbsp;<span class="ident" id="2891086">r</span><span class="op" id="2891087">.</span><span class="ident" id="2891088">mapping</span>&nbsp;<span class="op" id="2891096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2891100">r</span><span class="op" id="2891101">.</span><span class="ident" id="2891102">tableSize</span>&nbsp;<span class="op" id="2891112">+=</span>&nbsp;<span class="builtintype" id="2891115">int</span><span class="op" id="2891118">(</span><span class="ident" id="2891119">b</span><span class="op" id="2891120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2891123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2891127">var</span>&nbsp;<span class="ident" id="2891131">index</span>&nbsp;<span class="builtintype" id="2891137">byte</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2891143">for</span>&nbsp;<span class="ident" id="2891147">i</span><span class="op" id="2891148">,</span>&nbsp;<span class="ident" id="2891150">b</span>&nbsp;<span class="op" id="2891152">:=</span>&nbsp;<span class="keyword" id="2891155">range</span>&nbsp;<span class="ident" id="2891161">r</span><span class="op" id="2891162">.</span><span class="ident" id="2891163">mapping</span>&nbsp;<span class="op" id="2891171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2891175">if</span>&nbsp;<span class="ident" id="2891178">b</span>&nbsp;<span class="op" id="2891180">==</span>&nbsp;<span class="num" id="2891183">0</span>&nbsp;<span class="op" id="2891185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2891190">r</span><span class="op" id="2891191">.</span><span class="ident" id="2891192">mapping</span><span class="op" id="2891199">[</span><span class="ident" id="2891200">i</span><span class="op" id="2891201">]</span>&nbsp;<span class="op" id="2891203">=</span>&nbsp;<span class="builtintype" id="2891205">byte</span><span class="op" id="2891209">(</span><span class="ident" id="2891210">r</span><span class="op" id="2891211">.</span><span class="ident" id="2891212">tableSize</span><span class="op" id="2891221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2891225">}</span>&nbsp;<span class="keyword" id="2891227">else</span>&nbsp;<span class="op" id="2891232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2891237">r</span><span class="op" id="2891238">.</span><span class="ident" id="2891239">mapping</span><span class="op" id="2891246">[</span><span class="ident" id="2891247">i</span><span class="op" id="2891248">]</span>&nbsp;<span class="op" id="2891250">=</span>&nbsp;<span class="ident" id="2891252">index</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2891261">index</span><span class="op" id="2891266">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2891271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2891274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2891277">//&nbsp;Ensure&nbsp;root&nbsp;node&nbsp;uses&nbsp;a&nbsp;lookup&nbsp;table&nbsp;(for&nbsp;performance).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2891337">r</span><span class="op" id="2891338">.</span><span class="ident" id="2891339">root</span><span class="op" id="2891343">.</span><span class="ident" id="2891344">table</span>&nbsp;<span class="op" id="2891350">=</span>&nbsp;<span class="builtinfunc" id="2891352">make</span><span class="op" id="2891356">(</span><span class="op" id="2891357">[</span><span class="op" id="2891358">]</span><span class="op" id="2891359">*</span><span class="ident" id="2891360">trieNode</span><span class="op" id="2891368">,</span>&nbsp;<span class="ident" id="2891370">r</span><span class="op" id="2891371">.</span><span class="ident" id="2891372">tableSize</span><span class="op" id="2891381">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2891385">for</span>&nbsp;<span class="ident" id="2891389">i</span>&nbsp;<span class="op" id="2891391">:=</span>&nbsp;<span class="num" id="2891394">0</span><span class="op" id="2891395">;</span>&nbsp;<span class="ident" id="2891397">i</span>&nbsp;<span class="op" id="2891399">&lt;</span>&nbsp;<span class="builtinfunc" id="2891401">len</span><span class="op" id="2891404">(</span><span class="ident" id="2891405">oldnew</span><span class="op" id="2891411">)</span><span class="op" id="2891412">;</span>&nbsp;<span class="ident" id="2891414">i</span>&nbsp;<span class="op" id="2891416">+=</span>&nbsp;<span class="num" id="2891419">2</span>&nbsp;<span class="op" id="2891421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2891425">r</span><span class="op" id="2891426">.</span><span class="ident" id="2891427">root</span><span class="op" id="2891431">.</span><span class="ident" id="2891432">add</span><span class="op" id="2891435">(</span><span class="ident" id="2891436">oldnew</span><span class="op" id="2891442">[</span><span class="ident" id="2891443">i</span><span class="op" id="2891444">]</span><span class="op" id="2891445">,</span>&nbsp;<span class="ident" id="2891447">oldnew</span><span class="op" id="2891453">[</span><span class="ident" id="2891454">i</span><span class="op" id="2891455">+</span><span class="num" id="2891456">1</span><span class="op" id="2891457">]</span><span class="op" id="2891458">,</span>&nbsp;<span class="builtinfunc" id="2891460">len</span><span class="op" id="2891463">(</span><span class="ident" id="2891464">oldnew</span><span class="op" id="2891470">)</span><span class="op" id="2891471">-</span><span class="ident" id="2891472">i</span><span class="op" id="2891473">,</span>&nbsp;<span class="ident" id="2891475">r</span><span class="op" id="2891476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2891479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2891482">return</span>&nbsp;<span class="ident" id="2891489">r</span><br>
<span class="lineno">270</span><span class="op" id="2891491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2891494">type</span>&nbsp;<span class="ident" id="2891499">appendSliceWriter</span>&nbsp;<span class="op" id="2891517">[</span><span class="op" id="2891518">]</span><span class="builtintype" id="2891519">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2891525">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;to&nbsp;satisfy&nbsp;io.Writer.</span><br>
<span class="lineno">275</span><span class="keyword" id="2891577">func</span>&nbsp;<span class="op" id="2891582">(</span><span class="ident" id="2891583">w</span>&nbsp;<span class="op" id="2891585">*</span><span class="ident" id="2891586">appendSliceWriter</span><span class="op" id="2891603">)</span>&nbsp;<span class="ident" id="2891605">Write</span><span class="op" id="2891610">(</span><span class="ident" id="2891611">p</span>&nbsp;<span class="op" id="2891613">[</span><span class="op" id="2891614">]</span><span class="builtintype" id="2891615">byte</span><span class="op" id="2891619">)</span>&nbsp;<span class="op" id="2891621">(</span><span class="builtintype" id="2891622">int</span><span class="op" id="2891625">,</span>&nbsp;<span class="builtintype" id="2891627">error</span><span class="op" id="2891632">)</span>&nbsp;<span class="op" id="2891634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2891637">*</span><span class="ident" id="2891638">w</span>&nbsp;<span class="op" id="2891640">=</span>&nbsp;<span class="builtinfunc" id="2891642">append</span><span class="op" id="2891648">(</span><span class="op" id="2891649">*</span><span class="ident" id="2891650">w</span><span class="op" id="2891651">,</span>&nbsp;<span class="ident" id="2891653">p</span><span class="op" id="2891654">...</span><span class="op" id="2891657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2891660">return</span>&nbsp;<span class="builtinfunc" id="2891667">len</span><span class="op" id="2891670">(</span><span class="ident" id="2891671">p</span><span class="op" id="2891672">)</span><span class="op" id="2891673">,</span>&nbsp;<span class="ident" id="2891675">nil</span><br>
<span class="lineno"></span><span class="op" id="2891679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="2891682">//&nbsp;WriteString&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;without&nbsp;string-&gt;[]byte-&gt;string&nbsp;allocations.</span><br>
<span class="lineno"></span><span class="keyword" id="2891762">func</span>&nbsp;<span class="op" id="2891767">(</span><span class="ident" id="2891768">w</span>&nbsp;<span class="op" id="2891770">*</span><span class="ident" id="2891771">appendSliceWriter</span><span class="op" id="2891788">)</span>&nbsp;<span class="ident" id="2891790">WriteString</span><span class="op" id="2891801">(</span><span class="ident" id="2891802">s</span>&nbsp;<span class="builtintype" id="2891804">string</span><span class="op" id="2891810">)</span>&nbsp;<span class="op" id="2891812">(</span><span class="builtintype" id="2891813">int</span><span class="op" id="2891816">,</span>&nbsp;<span class="builtintype" id="2891818">error</span><span class="op" id="2891823">)</span>&nbsp;<span class="op" id="2891825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2891828">*</span><span class="ident" id="2891829">w</span>&nbsp;<span class="op" id="2891831">=</span>&nbsp;<span class="builtinfunc" id="2891833">append</span><span class="op" id="2891839">(</span><span class="op" id="2891840">*</span><span class="ident" id="2891841">w</span><span class="op" id="2891842">,</span>&nbsp;<span class="ident" id="2891844">s</span><span class="op" id="2891845">...</span><span class="op" id="2891848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2891851">return</span>&nbsp;<span class="builtinfunc" id="2891858">len</span><span class="op" id="2891861">(</span><span class="ident" id="2891862">s</span><span class="op" id="2891863">)</span><span class="op" id="2891864">,</span>&nbsp;<span class="ident" id="2891866">nil</span><br>
<span class="lineno"></span><span class="op" id="2891870">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="2891873">type</span>&nbsp;<span class="ident" id="2891878">stringWriterIface</span>&nbsp;<span class="keyword" id="2891896">interface</span>&nbsp;<span class="op" id="2891906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2891909">WriteString</span><span class="op" id="2891920">(</span><span class="builtintype" id="2891921">string</span><span class="op" id="2891927">)</span>&nbsp;<span class="op" id="2891929">(</span><span class="builtintype" id="2891930">int</span><span class="op" id="2891933">,</span>&nbsp;<span class="builtintype" id="2891935">error</span><span class="op" id="2891940">)</span><br>
<span class="lineno"></span><span class="op" id="2891942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="2891945">type</span>&nbsp;<span class="ident" id="2891950">stringWriter</span>&nbsp;<span class="keyword" id="2891963">struct</span>&nbsp;<span class="op" id="2891970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2891973">w</span>&nbsp;<span class="ident" id="2891975">io</span><span class="op" id="2891977">.</span><span class="ident" id="2891978">Writer</span><br>
<span class="lineno"></span><span class="op" id="2891985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2891988">func</span>&nbsp;<span class="op" id="2891993">(</span><span class="ident" id="2891994">w</span>&nbsp;<span class="ident" id="2891996">stringWriter</span><span class="op" id="2892008">)</span>&nbsp;<span class="ident" id="2892010">WriteString</span><span class="op" id="2892021">(</span><span class="ident" id="2892022">s</span>&nbsp;<span class="builtintype" id="2892024">string</span><span class="op" id="2892030">)</span>&nbsp;<span class="op" id="2892032">(</span><span class="builtintype" id="2892033">int</span><span class="op" id="2892036">,</span>&nbsp;<span class="builtintype" id="2892038">error</span><span class="op" id="2892043">)</span>&nbsp;<span class="op" id="2892045">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2892048">return</span>&nbsp;<span class="ident" id="2892055">w</span><span class="op" id="2892056">.</span><span class="ident" id="2892057">w</span><span class="op" id="2892058">.</span><span class="ident" id="2892059">Write</span><span class="op" id="2892064">(</span><span class="op" id="2892065">[</span><span class="op" id="2892066">]</span><span class="builtintype" id="2892067">byte</span><span class="op" id="2892071">(</span><span class="ident" id="2892072">s</span><span class="op" id="2892073">)</span><span class="op" id="2892074">)</span><br>
<span class="lineno"></span><span class="op" id="2892076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2892079">func</span>&nbsp;<span class="ident" id="2892084">getStringWriter</span><span class="op" id="2892099">(</span><span class="ident" id="2892100">w</span>&nbsp;<span class="ident" id="2892102">io</span><span class="op" id="2892104">.</span><span class="ident" id="2892105">Writer</span><span class="op" id="2892111">)</span>&nbsp;<span class="ident" id="2892113">stringWriterIface</span>&nbsp;<span class="op" id="2892131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2892134">sw</span><span class="op" id="2892136">,</span>&nbsp;<span class="ident" id="2892138">ok</span>&nbsp;<span class="op" id="2892141">:=</span>&nbsp;<span class="ident" id="2892144">w</span><span class="op" id="2892145">.</span><span class="op" id="2892146">(</span><span class="ident" id="2892147">stringWriterIface</span><span class="op" id="2892164">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2892167">if</span>&nbsp;<span class="op" id="2892170">!</span><span class="ident" id="2892171">ok</span>&nbsp;<span class="op" id="2892174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2892178">sw</span>&nbsp;<span class="op" id="2892181">=</span>&nbsp;<span class="ident" id="2892183">stringWriter</span><span class="op" id="2892195">{</span><span class="ident" id="2892196">w</span><span class="op" id="2892197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2892200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2892203">return</span>&nbsp;<span class="ident" id="2892210">sw</span><br>
<span class="lineno"></span><span class="op" id="2892213">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="2892216">func</span>&nbsp;<span class="op" id="2892221">(</span><span class="ident" id="2892222">r</span>&nbsp;<span class="op" id="2892224">*</span><span class="ident" id="2892225">genericReplacer</span><span class="op" id="2892240">)</span>&nbsp;<span class="ident" id="2892242">Replace</span><span class="op" id="2892249">(</span><span class="ident" id="2892250">s</span>&nbsp;<span class="builtintype" id="2892252">string</span><span class="op" id="2892258">)</span>&nbsp;<span class="builtintype" id="2892260">string</span>&nbsp;<span class="op" id="2892267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2892270">buf</span>&nbsp;<span class="op" id="2892274">:=</span>&nbsp;<span class="builtinfunc" id="2892277">make</span><span class="op" id="2892281">(</span><span class="ident" id="2892282">appendSliceWriter</span><span class="op" id="2892299">,</span>&nbsp;<span class="num" id="2892301">0</span><span class="op" id="2892302">,</span>&nbsp;<span class="builtinfunc" id="2892304">len</span><span class="op" id="2892307">(</span><span class="ident" id="2892308">s</span><span class="op" id="2892309">)</span><span class="op" id="2892310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2892313">r</span><span class="op" id="2892314">.</span><span class="ident" id="2892315">WriteString</span><span class="op" id="2892326">(</span><span class="op" id="2892327">&amp;</span><span class="ident" id="2892328">buf</span><span class="op" id="2892331">,</span>&nbsp;<span class="ident" id="2892333">s</span><span class="op" id="2892334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2892337">return</span>&nbsp;<span class="builtintype" id="2892344">string</span><span class="op" id="2892350">(</span><span class="ident" id="2892351">buf</span><span class="op" id="2892354">)</span><br>
<span class="lineno">310</span><span class="op" id="2892356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2892359">func</span>&nbsp;<span class="op" id="2892364">(</span><span class="ident" id="2892365">r</span>&nbsp;<span class="op" id="2892367">*</span><span class="ident" id="2892368">genericReplacer</span><span class="op" id="2892383">)</span>&nbsp;<span class="ident" id="2892385">WriteString</span><span class="op" id="2892396">(</span><span class="ident" id="2892397">w</span>&nbsp;<span class="ident" id="2892399">io</span><span class="op" id="2892401">.</span><span class="ident" id="2892402">Writer</span><span class="op" id="2892408">,</span>&nbsp;<span class="ident" id="2892410">s</span>&nbsp;<span class="builtintype" id="2892412">string</span><span class="op" id="2892418">)</span>&nbsp;<span class="op" id="2892420">(</span><span class="ident" id="2892421">n</span>&nbsp;<span class="builtintype" id="2892423">int</span><span class="op" id="2892426">,</span>&nbsp;<span class="ident" id="2892428">err</span>&nbsp;<span class="builtintype" id="2892432">error</span><span class="op" id="2892437">)</span>&nbsp;<span class="op" id="2892439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2892442">sw</span>&nbsp;<span class="op" id="2892445">:=</span>&nbsp;<span class="ident" id="2892448">getStringWriter</span><span class="op" id="2892463">(</span><span class="ident" id="2892464">w</span><span class="op" id="2892465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2892468">var</span>&nbsp;<span class="ident" id="2892472">last</span><span class="op" id="2892476">,</span>&nbsp;<span class="ident" id="2892478">wn</span>&nbsp;<span class="builtintype" id="2892481">int</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2892486">var</span>&nbsp;<span class="ident" id="2892490">prevMatchEmpty</span>&nbsp;<span class="builtintype" id="2892505">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2892511">for</span>&nbsp;<span class="ident" id="2892515">i</span>&nbsp;<span class="op" id="2892517">:=</span>&nbsp;<span class="num" id="2892520">0</span><span class="op" id="2892521">;</span>&nbsp;<span class="ident" id="2892523">i</span>&nbsp;<span class="op" id="2892525">&lt;=</span>&nbsp;<span class="builtinfunc" id="2892528">len</span><span class="op" id="2892531">(</span><span class="ident" id="2892532">s</span><span class="op" id="2892533">)</span><span class="op" id="2892534">;</span>&nbsp;<span class="op" id="2892536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2892540">//&nbsp;Fast&nbsp;path:&nbsp;s[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;prefix&nbsp;of&nbsp;any&nbsp;pattern.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2892593">if</span>&nbsp;<span class="ident" id="2892596">i</span>&nbsp;<span class="op" id="2892598">!=</span>&nbsp;<span class="builtinfunc" id="2892601">len</span><span class="op" id="2892604">(</span><span class="ident" id="2892605">s</span><span class="op" id="2892606">)</span>&nbsp;<span class="op" id="2892608">&amp;&amp;</span>&nbsp;<span class="ident" id="2892611">r</span><span class="op" id="2892612">.</span><span class="ident" id="2892613">root</span><span class="op" id="2892617">.</span><span class="ident" id="2892618">priority</span>&nbsp;<span class="op" id="2892627">==</span>&nbsp;<span class="num" id="2892630">0</span>&nbsp;<span class="op" id="2892632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2892637">index</span>&nbsp;<span class="op" id="2892643">:=</span>&nbsp;<span class="builtintype" id="2892646">int</span><span class="op" id="2892649">(</span><span class="ident" id="2892650">r</span><span class="op" id="2892651">.</span><span class="ident" id="2892652">mapping</span><span class="op" id="2892659">[</span><span class="ident" id="2892660">s</span><span class="op" id="2892661">[</span><span class="ident" id="2892662">i</span><span class="op" id="2892663">]</span><span class="op" id="2892664">]</span><span class="op" id="2892665">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2892670">if</span>&nbsp;<span class="ident" id="2892673">index</span>&nbsp;<span class="op" id="2892679">==</span>&nbsp;<span class="ident" id="2892682">r</span><span class="op" id="2892683">.</span><span class="ident" id="2892684">tableSize</span>&nbsp;<span class="op" id="2892694">||</span>&nbsp;<span class="ident" id="2892697">r</span><span class="op" id="2892698">.</span><span class="ident" id="2892699">root</span><span class="op" id="2892703">.</span><span class="ident" id="2892704">table</span><span class="op" id="2892709">[</span><span class="ident" id="2892710">index</span><span class="op" id="2892715">]</span>&nbsp;<span class="op" id="2892717">==</span>&nbsp;<span class="ident" id="2892720">nil</span>&nbsp;<span class="op" id="2892724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2892730">i</span><span class="op" id="2892731">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2892738">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2892750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2892754">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2892759">//&nbsp;Ignore&nbsp;the&nbsp;empty&nbsp;match&nbsp;iff&nbsp;the&nbsp;previous&nbsp;loop&nbsp;found&nbsp;the&nbsp;empty&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2892832">val</span><span class="op" id="2892835">,</span>&nbsp;<span class="ident" id="2892837">keylen</span><span class="op" id="2892843">,</span>&nbsp;<span class="ident" id="2892845">match</span>&nbsp;<span class="op" id="2892851">:=</span>&nbsp;<span class="ident" id="2892854">r</span><span class="op" id="2892855">.</span><span class="ident" id="2892856">lookup</span><span class="op" id="2892862">(</span><span class="ident" id="2892863">s</span><span class="op" id="2892864">[</span><span class="ident" id="2892865">i</span><span class="op" id="2892866">:</span><span class="op" id="2892867">]</span><span class="op" id="2892868">,</span>&nbsp;<span class="ident" id="2892870">prevMatchEmpty</span><span class="op" id="2892884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2892888">prevMatchEmpty</span>&nbsp;<span class="op" id="2892903">=</span>&nbsp;<span class="ident" id="2892905">match</span>&nbsp;<span class="op" id="2892911">&amp;&amp;</span>&nbsp;<span class="ident" id="2892914">keylen</span>&nbsp;<span class="op" id="2892921">==</span>&nbsp;<span class="num" id="2892924">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2892928">if</span>&nbsp;<span class="ident" id="2892931">match</span>&nbsp;<span class="op" id="2892937">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2892942">wn</span><span class="op" id="2892944">,</span>&nbsp;<span class="ident" id="2892946">err</span>&nbsp;<span class="op" id="2892950">=</span>&nbsp;<span class="ident" id="2892952">sw</span><span class="op" id="2892954">.</span><span class="ident" id="2892955">WriteString</span><span class="op" id="2892966">(</span><span class="ident" id="2892967">s</span><span class="op" id="2892968">[</span><span class="ident" id="2892969">last</span><span class="op" id="2892973">:</span><span class="ident" id="2892974">i</span><span class="op" id="2892975">]</span><span class="op" id="2892976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2892981">n</span>&nbsp;<span class="op" id="2892983">+=</span>&nbsp;<span class="ident" id="2892986">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2892992">if</span>&nbsp;<span class="ident" id="2892995">err</span>&nbsp;<span class="op" id="2892999">!=</span>&nbsp;<span class="ident" id="2893002">nil</span>&nbsp;<span class="op" id="2893006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2893012">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2893022">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893027">wn</span><span class="op" id="2893029">,</span>&nbsp;<span class="ident" id="2893031">err</span>&nbsp;<span class="op" id="2893035">=</span>&nbsp;<span class="ident" id="2893037">sw</span><span class="op" id="2893039">.</span><span class="ident" id="2893040">WriteString</span><span class="op" id="2893051">(</span><span class="ident" id="2893052">val</span><span class="op" id="2893055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893060">n</span>&nbsp;<span class="op" id="2893062">+=</span>&nbsp;<span class="ident" id="2893065">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2893071">if</span>&nbsp;<span class="ident" id="2893074">err</span>&nbsp;<span class="op" id="2893078">!=</span>&nbsp;<span class="ident" id="2893081">nil</span>&nbsp;<span class="op" id="2893085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2893091">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2893101">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893106">i</span>&nbsp;<span class="op" id="2893108">+=</span>&nbsp;<span class="ident" id="2893111">keylen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893121">last</span>&nbsp;<span class="op" id="2893126">=</span>&nbsp;<span class="ident" id="2893128">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2893133">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2893144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893148">i</span><span class="op" id="2893149">++</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2893153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2893156">if</span>&nbsp;<span class="ident" id="2893159">last</span>&nbsp;<span class="op" id="2893164">!=</span>&nbsp;<span class="builtinfunc" id="2893167">len</span><span class="op" id="2893170">(</span><span class="ident" id="2893171">s</span><span class="op" id="2893172">)</span>&nbsp;<span class="op" id="2893174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893178">wn</span><span class="op" id="2893180">,</span>&nbsp;<span class="ident" id="2893182">err</span>&nbsp;<span class="op" id="2893186">=</span>&nbsp;<span class="ident" id="2893188">sw</span><span class="op" id="2893190">.</span><span class="ident" id="2893191">WriteString</span><span class="op" id="2893202">(</span><span class="ident" id="2893203">s</span><span class="op" id="2893204">[</span><span class="ident" id="2893205">last</span><span class="op" id="2893209">:</span><span class="op" id="2893210">]</span><span class="op" id="2893211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893215">n</span>&nbsp;<span class="op" id="2893217">+=</span>&nbsp;<span class="ident" id="2893220">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2893224">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2893227">return</span><br>
<span class="lineno"></span><span class="op" id="2893234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2893237">//&nbsp;singleStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;there&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="2893314">//&nbsp;one&nbsp;string&nbsp;to&nbsp;replace&nbsp;(and&nbsp;that&nbsp;string&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;byte).</span><br>
<span class="lineno">355</span><span class="keyword" id="2893381">type</span>&nbsp;<span class="ident" id="2893386">singleStringReplacer</span>&nbsp;<span class="keyword" id="2893407">struct</span>&nbsp;<span class="op" id="2893414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893417">finder</span>&nbsp;<span class="op" id="2893424">*</span><span class="ident" id="2893425">stringFinder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2893439">//&nbsp;value&nbsp;is&nbsp;the&nbsp;new&nbsp;string&nbsp;that&nbsp;replaces&nbsp;that&nbsp;pattern&nbsp;when&nbsp;it&#39;s&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893511">value</span>&nbsp;<span class="builtintype" id="2893517">string</span><br>
<span class="lineno"></span><span class="op" id="2893524">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="2893527">func</span>&nbsp;<span class="ident" id="2893532">makeSingleStringReplacer</span><span class="op" id="2893556">(</span><span class="ident" id="2893557">pattern</span>&nbsp;<span class="builtintype" id="2893565">string</span><span class="op" id="2893571">,</span>&nbsp;<span class="ident" id="2893573">value</span>&nbsp;<span class="builtintype" id="2893579">string</span><span class="op" id="2893585">)</span>&nbsp;<span class="op" id="2893587">*</span><span class="ident" id="2893588">singleStringReplacer</span>&nbsp;<span class="op" id="2893609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2893612">return</span>&nbsp;<span class="op" id="2893619">&amp;</span><span class="ident" id="2893620">singleStringReplacer</span><span class="op" id="2893640">{</span><span class="ident" id="2893641">finder</span><span class="op" id="2893647">:</span>&nbsp;<span class="ident" id="2893649">makeStringFinder</span><span class="op" id="2893665">(</span><span class="ident" id="2893666">pattern</span><span class="op" id="2893673">)</span><span class="op" id="2893674">,</span>&nbsp;<span class="ident" id="2893676">value</span><span class="op" id="2893681">:</span>&nbsp;<span class="ident" id="2893683">value</span><span class="op" id="2893688">}</span><br>
<span class="lineno"></span><span class="op" id="2893690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="keyword" id="2893693">func</span>&nbsp;<span class="op" id="2893698">(</span><span class="ident" id="2893699">r</span>&nbsp;<span class="op" id="2893701">*</span><span class="ident" id="2893702">singleStringReplacer</span><span class="op" id="2893722">)</span>&nbsp;<span class="ident" id="2893724">Replace</span><span class="op" id="2893731">(</span><span class="ident" id="2893732">s</span>&nbsp;<span class="builtintype" id="2893734">string</span><span class="op" id="2893740">)</span>&nbsp;<span class="builtintype" id="2893742">string</span>&nbsp;<span class="op" id="2893749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2893752">var</span>&nbsp;<span class="ident" id="2893756">buf</span>&nbsp;<span class="op" id="2893760">[</span><span class="op" id="2893761">]</span><span class="builtintype" id="2893762">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893768">i</span><span class="op" id="2893769">,</span>&nbsp;<span class="ident" id="2893771">matched</span>&nbsp;<span class="op" id="2893779">:=</span>&nbsp;<span class="num" id="2893782">0</span><span class="op" id="2893783">,</span>&nbsp;<span class="builtintype" id="2893785">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2893792">for</span>&nbsp;<span class="op" id="2893796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893800">match</span>&nbsp;<span class="op" id="2893806">:=</span>&nbsp;<span class="ident" id="2893809">r</span><span class="op" id="2893810">.</span><span class="ident" id="2893811">finder</span><span class="op" id="2893817">.</span><span class="ident" id="2893818">next</span><span class="op" id="2893822">(</span><span class="ident" id="2893823">s</span><span class="op" id="2893824">[</span><span class="ident" id="2893825">i</span><span class="op" id="2893826">:</span><span class="op" id="2893827">]</span><span class="op" id="2893828">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2893832">if</span>&nbsp;<span class="ident" id="2893835">match</span>&nbsp;<span class="op" id="2893841">==</span>&nbsp;<span class="op" id="2893844">-</span><span class="num" id="2893845">1</span>&nbsp;<span class="op" id="2893847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2893852">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2893860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893864">matched</span>&nbsp;<span class="op" id="2893872">=</span>&nbsp;<span class="builtintype" id="2893874">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893881">buf</span>&nbsp;<span class="op" id="2893885">=</span>&nbsp;<span class="builtinfunc" id="2893887">append</span><span class="op" id="2893893">(</span><span class="ident" id="2893894">buf</span><span class="op" id="2893897">,</span>&nbsp;<span class="ident" id="2893899">s</span><span class="op" id="2893900">[</span><span class="ident" id="2893901">i</span><span class="op" id="2893902">:</span><span class="ident" id="2893903">i</span><span class="op" id="2893904">+</span><span class="ident" id="2893905">match</span><span class="op" id="2893910">]</span><span class="op" id="2893911">...</span><span class="op" id="2893914">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893918">buf</span>&nbsp;<span class="op" id="2893922">=</span>&nbsp;<span class="builtinfunc" id="2893924">append</span><span class="op" id="2893930">(</span><span class="ident" id="2893931">buf</span><span class="op" id="2893934">,</span>&nbsp;<span class="ident" id="2893936">r</span><span class="op" id="2893937">.</span><span class="ident" id="2893938">value</span><span class="op" id="2893943">...</span><span class="op" id="2893946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2893950">i</span>&nbsp;<span class="op" id="2893952">+=</span>&nbsp;<span class="ident" id="2893955">match</span>&nbsp;<span class="op" id="2893961">+</span>&nbsp;<span class="builtinfunc" id="2893963">len</span><span class="op" id="2893966">(</span><span class="ident" id="2893967">r</span><span class="op" id="2893968">.</span><span class="ident" id="2893969">finder</span><span class="op" id="2893975">.</span><span class="ident" id="2893976">pattern</span><span class="op" id="2893983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2893986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2893989">if</span>&nbsp;<span class="op" id="2893992">!</span><span class="ident" id="2893993">matched</span>&nbsp;<span class="op" id="2894001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894005">return</span>&nbsp;<span class="ident" id="2894012">s</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2894015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894018">buf</span>&nbsp;<span class="op" id="2894022">=</span>&nbsp;<span class="builtinfunc" id="2894024">append</span><span class="op" id="2894030">(</span><span class="ident" id="2894031">buf</span><span class="op" id="2894034">,</span>&nbsp;<span class="ident" id="2894036">s</span><span class="op" id="2894037">[</span><span class="ident" id="2894038">i</span><span class="op" id="2894039">:</span><span class="op" id="2894040">]</span><span class="op" id="2894041">...</span><span class="op" id="2894044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894047">return</span>&nbsp;<span class="builtintype" id="2894054">string</span><span class="op" id="2894060">(</span><span class="ident" id="2894061">buf</span><span class="op" id="2894064">)</span><br>
<span class="lineno"></span><span class="op" id="2894066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="2894069">func</span>&nbsp;<span class="op" id="2894074">(</span><span class="ident" id="2894075">r</span>&nbsp;<span class="op" id="2894077">*</span><span class="ident" id="2894078">singleStringReplacer</span><span class="op" id="2894098">)</span>&nbsp;<span class="ident" id="2894100">WriteString</span><span class="op" id="2894111">(</span><span class="ident" id="2894112">w</span>&nbsp;<span class="ident" id="2894114">io</span><span class="op" id="2894116">.</span><span class="ident" id="2894117">Writer</span><span class="op" id="2894123">,</span>&nbsp;<span class="ident" id="2894125">s</span>&nbsp;<span class="builtintype" id="2894127">string</span><span class="op" id="2894133">)</span>&nbsp;<span class="op" id="2894135">(</span><span class="ident" id="2894136">n</span>&nbsp;<span class="builtintype" id="2894138">int</span><span class="op" id="2894141">,</span>&nbsp;<span class="ident" id="2894143">err</span>&nbsp;<span class="builtintype" id="2894147">error</span><span class="op" id="2894152">)</span>&nbsp;<span class="op" id="2894154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894157">sw</span>&nbsp;<span class="op" id="2894160">:=</span>&nbsp;<span class="ident" id="2894163">getStringWriter</span><span class="op" id="2894178">(</span><span class="ident" id="2894179">w</span><span class="op" id="2894180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894183">var</span>&nbsp;<span class="ident" id="2894187">i</span><span class="op" id="2894188">,</span>&nbsp;<span class="ident" id="2894190">wn</span>&nbsp;<span class="builtintype" id="2894193">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894198">for</span>&nbsp;<span class="op" id="2894202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894206">match</span>&nbsp;<span class="op" id="2894212">:=</span>&nbsp;<span class="ident" id="2894215">r</span><span class="op" id="2894216">.</span><span class="ident" id="2894217">finder</span><span class="op" id="2894223">.</span><span class="ident" id="2894224">next</span><span class="op" id="2894228">(</span><span class="ident" id="2894229">s</span><span class="op" id="2894230">[</span><span class="ident" id="2894231">i</span><span class="op" id="2894232">:</span><span class="op" id="2894233">]</span><span class="op" id="2894234">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894238">if</span>&nbsp;<span class="ident" id="2894241">match</span>&nbsp;<span class="op" id="2894247">==</span>&nbsp;<span class="op" id="2894250">-</span><span class="num" id="2894251">1</span>&nbsp;<span class="op" id="2894253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894258">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2894266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894270">wn</span><span class="op" id="2894272">,</span>&nbsp;<span class="ident" id="2894274">err</span>&nbsp;<span class="op" id="2894278">=</span>&nbsp;<span class="ident" id="2894280">sw</span><span class="op" id="2894282">.</span><span class="ident" id="2894283">WriteString</span><span class="op" id="2894294">(</span><span class="ident" id="2894295">s</span><span class="op" id="2894296">[</span><span class="ident" id="2894297">i</span>&nbsp;<span class="op" id="2894299">:</span>&nbsp;<span class="ident" id="2894301">i</span><span class="op" id="2894302">+</span><span class="ident" id="2894303">match</span><span class="op" id="2894308">]</span><span class="op" id="2894309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894313">n</span>&nbsp;<span class="op" id="2894315">+=</span>&nbsp;<span class="ident" id="2894318">wn</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894323">if</span>&nbsp;<span class="ident" id="2894326">err</span>&nbsp;<span class="op" id="2894330">!=</span>&nbsp;<span class="ident" id="2894333">nil</span>&nbsp;<span class="op" id="2894337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894342">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2894351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894355">wn</span><span class="op" id="2894357">,</span>&nbsp;<span class="ident" id="2894359">err</span>&nbsp;<span class="op" id="2894363">=</span>&nbsp;<span class="ident" id="2894365">sw</span><span class="op" id="2894367">.</span><span class="ident" id="2894368">WriteString</span><span class="op" id="2894379">(</span><span class="ident" id="2894380">r</span><span class="op" id="2894381">.</span><span class="ident" id="2894382">value</span><span class="op" id="2894387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894391">n</span>&nbsp;<span class="op" id="2894393">+=</span>&nbsp;<span class="ident" id="2894396">wn</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894401">if</span>&nbsp;<span class="ident" id="2894404">err</span>&nbsp;<span class="op" id="2894408">!=</span>&nbsp;<span class="ident" id="2894411">nil</span>&nbsp;<span class="op" id="2894415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894420">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2894429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894433">i</span>&nbsp;<span class="op" id="2894435">+=</span>&nbsp;<span class="ident" id="2894438">match</span>&nbsp;<span class="op" id="2894444">+</span>&nbsp;<span class="builtinfunc" id="2894446">len</span><span class="op" id="2894449">(</span><span class="ident" id="2894450">r</span><span class="op" id="2894451">.</span><span class="ident" id="2894452">finder</span><span class="op" id="2894458">.</span><span class="ident" id="2894459">pattern</span><span class="op" id="2894466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2894469">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894472">wn</span><span class="op" id="2894474">,</span>&nbsp;<span class="ident" id="2894476">err</span>&nbsp;<span class="op" id="2894480">=</span>&nbsp;<span class="ident" id="2894482">sw</span><span class="op" id="2894484">.</span><span class="ident" id="2894485">WriteString</span><span class="op" id="2894496">(</span><span class="ident" id="2894497">s</span><span class="op" id="2894498">[</span><span class="ident" id="2894499">i</span><span class="op" id="2894500">:</span><span class="op" id="2894501">]</span><span class="op" id="2894502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894505">n</span>&nbsp;<span class="op" id="2894507">+=</span>&nbsp;<span class="ident" id="2894510">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894514">return</span><br>
<span class="lineno"></span><span class="op" id="2894521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="2894524">//&nbsp;byteReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the&nbsp;&#34;old&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2894593">//&nbsp;and&nbsp;&#34;new&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2894637">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;bytes&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2894698">type</span>&nbsp;<span class="ident" id="2894703">byteReplacer</span>&nbsp;<span class="op" id="2894716">[</span><span class="num" id="2894717">256</span><span class="op" id="2894720">]</span><span class="builtintype" id="2894721">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="2894727">func</span>&nbsp;<span class="op" id="2894732">(</span><span class="ident" id="2894733">r</span>&nbsp;<span class="op" id="2894735">*</span><span class="ident" id="2894736">byteReplacer</span><span class="op" id="2894748">)</span>&nbsp;<span class="ident" id="2894750">Replace</span><span class="op" id="2894757">(</span><span class="ident" id="2894758">s</span>&nbsp;<span class="builtintype" id="2894760">string</span><span class="op" id="2894766">)</span>&nbsp;<span class="builtintype" id="2894768">string</span>&nbsp;<span class="op" id="2894775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894778">var</span>&nbsp;<span class="ident" id="2894782">buf</span>&nbsp;<span class="op" id="2894786">[</span><span class="op" id="2894787">]</span><span class="builtintype" id="2894788">byte</span>&nbsp;<span class="comment" id="2894793">//&nbsp;lazily&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894814">for</span>&nbsp;<span class="ident" id="2894818">i</span>&nbsp;<span class="op" id="2894820">:=</span>&nbsp;<span class="num" id="2894823">0</span><span class="op" id="2894824">;</span>&nbsp;<span class="ident" id="2894826">i</span>&nbsp;<span class="op" id="2894828">&lt;</span>&nbsp;<span class="builtinfunc" id="2894830">len</span><span class="op" id="2894833">(</span><span class="ident" id="2894834">s</span><span class="op" id="2894835">)</span><span class="op" id="2894836">;</span>&nbsp;<span class="ident" id="2894838">i</span><span class="op" id="2894839">++</span>&nbsp;<span class="op" id="2894842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894846">b</span>&nbsp;<span class="op" id="2894848">:=</span>&nbsp;<span class="ident" id="2894851">s</span><span class="op" id="2894852">[</span><span class="ident" id="2894853">i</span><span class="op" id="2894854">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894858">if</span>&nbsp;<span class="ident" id="2894861">r</span><span class="op" id="2894862">[</span><span class="ident" id="2894863">b</span><span class="op" id="2894864">]</span>&nbsp;<span class="op" id="2894866">!=</span>&nbsp;<span class="ident" id="2894869">b</span>&nbsp;<span class="op" id="2894871">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894876">if</span>&nbsp;<span class="ident" id="2894879">buf</span>&nbsp;<span class="op" id="2894883">==</span>&nbsp;<span class="ident" id="2894886">nil</span>&nbsp;<span class="op" id="2894890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894896">buf</span>&nbsp;<span class="op" id="2894900">=</span>&nbsp;<span class="op" id="2894902">[</span><span class="op" id="2894903">]</span><span class="builtintype" id="2894904">byte</span><span class="op" id="2894908">(</span><span class="ident" id="2894909">s</span><span class="op" id="2894910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2894915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2894920">buf</span><span class="op" id="2894923">[</span><span class="ident" id="2894924">i</span><span class="op" id="2894925">]</span>&nbsp;<span class="op" id="2894927">=</span>&nbsp;<span class="ident" id="2894929">r</span><span class="op" id="2894930">[</span><span class="ident" id="2894931">b</span><span class="op" id="2894932">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2894936">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2894939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894942">if</span>&nbsp;<span class="ident" id="2894945">buf</span>&nbsp;<span class="op" id="2894949">==</span>&nbsp;<span class="ident" id="2894952">nil</span>&nbsp;<span class="op" id="2894956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894960">return</span>&nbsp;<span class="ident" id="2894967">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2894970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2894973">return</span>&nbsp;<span class="builtintype" id="2894980">string</span><span class="op" id="2894986">(</span><span class="ident" id="2894987">buf</span><span class="op" id="2894990">)</span><br>
<span class="lineno">430</span><span class="op" id="2894992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2894995">func</span>&nbsp;<span class="op" id="2895000">(</span><span class="ident" id="2895001">r</span>&nbsp;<span class="op" id="2895003">*</span><span class="ident" id="2895004">byteReplacer</span><span class="op" id="2895016">)</span>&nbsp;<span class="ident" id="2895018">WriteString</span><span class="op" id="2895029">(</span><span class="ident" id="2895030">w</span>&nbsp;<span class="ident" id="2895032">io</span><span class="op" id="2895034">.</span><span class="ident" id="2895035">Writer</span><span class="op" id="2895041">,</span>&nbsp;<span class="ident" id="2895043">s</span>&nbsp;<span class="builtintype" id="2895045">string</span><span class="op" id="2895051">)</span>&nbsp;<span class="op" id="2895053">(</span><span class="ident" id="2895054">n</span>&nbsp;<span class="builtintype" id="2895056">int</span><span class="op" id="2895059">,</span>&nbsp;<span class="ident" id="2895061">err</span>&nbsp;<span class="builtintype" id="2895065">error</span><span class="op" id="2895070">)</span>&nbsp;<span class="op" id="2895072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2895075">//&nbsp;TODO(bradfitz):&nbsp;use&nbsp;io.WriteString&nbsp;with&nbsp;slices&nbsp;of&nbsp;s,&nbsp;avoiding&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2895153">bufsize</span>&nbsp;<span class="op" id="2895161">:=</span>&nbsp;<span class="num" id="2895164">32</span>&nbsp;<span class="op" id="2895167">&lt;&lt;</span>&nbsp;<span class="num" id="2895170">10</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2895174">if</span>&nbsp;<span class="builtinfunc" id="2895177">len</span><span class="op" id="2895180">(</span><span class="ident" id="2895181">s</span><span class="op" id="2895182">)</span>&nbsp;<span class="op" id="2895184">&lt;</span>&nbsp;<span class="ident" id="2895186">bufsize</span>&nbsp;<span class="op" id="2895194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2895198">bufsize</span>&nbsp;<span class="op" id="2895206">=</span>&nbsp;<span class="builtinfunc" id="2895208">len</span><span class="op" id="2895211">(</span><span class="ident" id="2895212">s</span><span class="op" id="2895213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2895216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2895219">buf</span>&nbsp;<span class="op" id="2895223">:=</span>&nbsp;<span class="builtinfunc" id="2895226">make</span><span class="op" id="2895230">(</span><span class="op" id="2895231">[</span><span class="op" id="2895232">]</span><span class="builtintype" id="2895233">byte</span><span class="op" id="2895237">,</span>&nbsp;<span class="ident" id="2895239">bufsize</span><span class="op" id="2895246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2895250">for</span>&nbsp;<span class="builtinfunc" id="2895254">len</span><span class="op" id="2895257">(</span><span class="ident" id="2895258">s</span><span class="op" id="2895259">)</span>&nbsp;<span class="op" id="2895261">&gt;</span>&nbsp;<span class="num" id="2895263">0</span>&nbsp;<span class="op" id="2895265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2895269">ncopy</span>&nbsp;<span class="op" id="2895275">:=</span>&nbsp;<span class="builtinfunc" id="2895278">copy</span><span class="op" id="2895282">(</span><span class="ident" id="2895283">buf</span><span class="op" id="2895286">,</span>&nbsp;<span class="ident" id="2895288">s</span><span class="op" id="2895289">[</span><span class="op" id="2895290">:</span><span class="op" id="2895291">]</span><span class="op" id="2895292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2895296">s</span>&nbsp;<span class="op" id="2895298">=</span>&nbsp;<span class="ident" id="2895300">s</span><span class="op" id="2895301">[</span><span class="ident" id="2895302">ncopy</span><span class="op" id="2895307">:</span><span class="op" id="2895308">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2895312">for</span>&nbsp;<span class="ident" id="2895316">i</span><span class="op" id="2895317">,</span>&nbsp;<span class="ident" id="2895319">b</span>&nbsp;<span class="op" id="2895321">:=</span>&nbsp;<span class="keyword" id="2895324">range</span>&nbsp;<span class="ident" id="2895330">buf</span><span class="op" id="2895333">[</span><span class="op" id="2895334">:</span><span class="ident" id="2895335">ncopy</span><span class="op" id="2895340">]</span>&nbsp;<span class="op" id="2895342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2895347">buf</span><span class="op" id="2895350">[</span><span class="ident" id="2895351">i</span><span class="op" id="2895352">]</span>&nbsp;<span class="op" id="2895354">=</span>&nbsp;<span class="ident" id="2895356">r</span><span class="op" id="2895357">[</span><span class="ident" id="2895358">b</span><span class="op" id="2895359">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2895363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2895367">wn</span><span class="op" id="2895369">,</span>&nbsp;<span class="ident" id="2895371">err</span>&nbsp;<span class="op" id="2895375">:=</span>&nbsp;<span class="ident" id="2895378">w</span><span class="op" id="2895379">.</span><span class="ident" id="2895380">Write</span><span class="op" id="2895385">(</span><span class="ident" id="2895386">buf</span><span class="op" id="2895389">[</span><span class="op" id="2895390">:</span><span class="ident" id="2895391">ncopy</span><span class="op" id="2895396">]</span><span class="op" id="2895397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2895401">n</span>&nbsp;<span class="op" id="2895403">+=</span>&nbsp;<span class="ident" id="2895406">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2895411">if</span>&nbsp;<span class="ident" id="2895414">err</span>&nbsp;<span class="op" id="2895418">!=</span>&nbsp;<span class="ident" id="2895421">nil</span>&nbsp;<span class="op" id="2895425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2895430">return</span>&nbsp;<span class="ident" id="2895437">n</span><span class="op" id="2895438">,</span>&nbsp;<span class="ident" id="2895440">err</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2895446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2895449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2895452">return</span>&nbsp;<span class="ident" id="2895459">n</span><span class="op" id="2895460">,</span>&nbsp;<span class="ident" id="2895462">nil</span><br>
<span class="lineno"></span><span class="op" id="2895466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="2895469">//&nbsp;byteStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2895538">//&nbsp;&#34;old&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes&nbsp;but&nbsp;the&nbsp;&#34;new&#34;&nbsp;values&nbsp;vary&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2895612">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;byte&nbsp;slices&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2895679">//&nbsp;A&nbsp;nil&nbsp;[]byte&nbsp;means&nbsp;that&nbsp;the&nbsp;old&nbsp;byte&nbsp;should&nbsp;not&nbsp;be&nbsp;replaced.</span><br>
<span class="lineno"></span><span class="keyword" id="2895743">type</span>&nbsp;<span class="ident" id="2895748">byteStringReplacer</span>&nbsp;<span class="op" id="2895767">[</span><span class="num" id="2895768">256</span><span class="op" id="2895771">]</span><span class="op" id="2895772">[</span><span class="op" id="2895773">]</span><span class="builtintype" id="2895774">byte</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="2895780">func</span>&nbsp;<span class="op" id="2895785">(</span><span class="ident" id="2895786">r</span>&nbsp;<span class="op" id="2895788">*</span><span class="ident" id="2895789">byteStringReplacer</span><span class="op" id="2895807">)</span>&nbsp;<span class="ident" id="2895809">Replace</span><span class="op" id="2895816">(</span><span class="ident" id="2895817">s</span>&nbsp;<span class="builtintype" id="2895819">string</span><span class="op" id="2895825">)</span>&nbsp;<span class="builtintype" id="2895827">string</span>&nbsp;<span class="op" id="2895834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2895837">newSize</span>&nbsp;<span class="op" id="2895845">:=</span>&nbsp;<span class="builtinfunc" id="2895848">len</span><span class="op" id="2895851">(</span><span class="ident" id="2895852">s</span><span class="op" id="2895853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2895856">anyChanges</span>&nbsp;<span class="op" id="2895867">:=</span>&nbsp;<span class="builtintype" id="2895870">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2895877">for</span>&nbsp;<span class="ident" id="2895881">i</span>&nbsp;<span class="op" id="2895883">:=</span>&nbsp;<span class="num" id="2895886">0</span><span class="op" id="2895887">;</span>&nbsp;<span class="ident" id="2895889">i</span>&nbsp;<span class="op" id="2895891">&lt;</span>&nbsp;<span class="builtinfunc" id="2895893">len</span><span class="op" id="2895896">(</span><span class="ident" id="2895897">s</span><span class="op" id="2895898">)</span><span class="op" id="2895899">;</span>&nbsp;<span class="ident" id="2895901">i</span><span class="op" id="2895902">++</span>&nbsp;<span class="op" id="2895905">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2895909">b</span>&nbsp;<span class="op" id="2895911">:=</span>&nbsp;<span class="ident" id="2895914">s</span><span class="op" id="2895915">[</span><span class="ident" id="2895916">i</span><span class="op" id="2895917">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2895921">if</span>&nbsp;<span class="ident" id="2895924">r</span><span class="op" id="2895925">[</span><span class="ident" id="2895926">b</span><span class="op" id="2895927">]</span>&nbsp;<span class="op" id="2895929">!=</span>&nbsp;<span class="ident" id="2895932">nil</span>&nbsp;<span class="op" id="2895936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2895941">anyChanges</span>&nbsp;<span class="op" id="2895952">=</span>&nbsp;<span class="builtintype" id="2895954">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2895962">//&nbsp;The&nbsp;-1&nbsp;is&nbsp;because&nbsp;we&nbsp;are&nbsp;replacing&nbsp;1&nbsp;byte&nbsp;with&nbsp;len(r[b])&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896032">newSize</span>&nbsp;<span class="op" id="2896040">+=</span>&nbsp;<span class="builtinfunc" id="2896043">len</span><span class="op" id="2896046">(</span><span class="ident" id="2896047">r</span><span class="op" id="2896048">[</span><span class="ident" id="2896049">b</span><span class="op" id="2896050">]</span><span class="op" id="2896051">)</span>&nbsp;<span class="op" id="2896053">-</span>&nbsp;<span class="num" id="2896055">1</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2896059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2896062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896065">if</span>&nbsp;<span class="op" id="2896068">!</span><span class="ident" id="2896069">anyChanges</span>&nbsp;<span class="op" id="2896080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896084">return</span>&nbsp;<span class="ident" id="2896091">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2896094">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896097">buf</span>&nbsp;<span class="op" id="2896101">:=</span>&nbsp;<span class="builtinfunc" id="2896104">make</span><span class="op" id="2896108">(</span><span class="op" id="2896109">[</span><span class="op" id="2896110">]</span><span class="builtintype" id="2896111">byte</span><span class="op" id="2896115">,</span>&nbsp;<span class="ident" id="2896117">newSize</span><span class="op" id="2896124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896127">bi</span>&nbsp;<span class="op" id="2896130">:=</span>&nbsp;<span class="ident" id="2896133">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896138">for</span>&nbsp;<span class="ident" id="2896142">i</span>&nbsp;<span class="op" id="2896144">:=</span>&nbsp;<span class="num" id="2896147">0</span><span class="op" id="2896148">;</span>&nbsp;<span class="ident" id="2896150">i</span>&nbsp;<span class="op" id="2896152">&lt;</span>&nbsp;<span class="builtinfunc" id="2896154">len</span><span class="op" id="2896157">(</span><span class="ident" id="2896158">s</span><span class="op" id="2896159">)</span><span class="op" id="2896160">;</span>&nbsp;<span class="ident" id="2896162">i</span><span class="op" id="2896163">++</span>&nbsp;<span class="op" id="2896166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896170">b</span>&nbsp;<span class="op" id="2896172">:=</span>&nbsp;<span class="ident" id="2896175">s</span><span class="op" id="2896176">[</span><span class="ident" id="2896177">i</span><span class="op" id="2896178">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896182">if</span>&nbsp;<span class="ident" id="2896185">r</span><span class="op" id="2896186">[</span><span class="ident" id="2896187">b</span><span class="op" id="2896188">]</span>&nbsp;<span class="op" id="2896190">!=</span>&nbsp;<span class="ident" id="2896193">nil</span>&nbsp;<span class="op" id="2896197">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896202">n</span>&nbsp;<span class="op" id="2896204">:=</span>&nbsp;<span class="builtinfunc" id="2896207">copy</span><span class="op" id="2896211">(</span><span class="ident" id="2896212">bi</span><span class="op" id="2896214">,</span>&nbsp;<span class="ident" id="2896216">r</span><span class="op" id="2896217">[</span><span class="ident" id="2896218">b</span><span class="op" id="2896219">]</span><span class="op" id="2896220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896225">bi</span>&nbsp;<span class="op" id="2896228">=</span>&nbsp;<span class="ident" id="2896230">bi</span><span class="op" id="2896232">[</span><span class="ident" id="2896233">n</span><span class="op" id="2896234">:</span><span class="op" id="2896235">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2896239">}</span>&nbsp;<span class="keyword" id="2896241">else</span>&nbsp;<span class="op" id="2896246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896251">bi</span><span class="op" id="2896253">[</span><span class="num" id="2896254">0</span><span class="op" id="2896255">]</span>&nbsp;<span class="op" id="2896257">=</span>&nbsp;<span class="ident" id="2896259">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896264">bi</span>&nbsp;<span class="op" id="2896267">=</span>&nbsp;<span class="ident" id="2896269">bi</span><span class="op" id="2896271">[</span><span class="num" id="2896272">1</span><span class="op" id="2896273">:</span><span class="op" id="2896274">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2896278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2896281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896284">return</span>&nbsp;<span class="builtintype" id="2896291">string</span><span class="op" id="2896297">(</span><span class="ident" id="2896298">buf</span><span class="op" id="2896301">)</span><br>
<span class="lineno"></span><span class="op" id="2896303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="keyword" id="2896306">func</span>&nbsp;<span class="op" id="2896311">(</span><span class="ident" id="2896312">r</span>&nbsp;<span class="op" id="2896314">*</span><span class="ident" id="2896315">byteStringReplacer</span><span class="op" id="2896333">)</span>&nbsp;<span class="ident" id="2896335">WriteString</span><span class="op" id="2896346">(</span><span class="ident" id="2896347">w</span>&nbsp;<span class="ident" id="2896349">io</span><span class="op" id="2896351">.</span><span class="ident" id="2896352">Writer</span><span class="op" id="2896358">,</span>&nbsp;<span class="ident" id="2896360">s</span>&nbsp;<span class="builtintype" id="2896362">string</span><span class="op" id="2896368">)</span>&nbsp;<span class="op" id="2896370">(</span><span class="ident" id="2896371">n</span>&nbsp;<span class="builtintype" id="2896373">int</span><span class="op" id="2896376">,</span>&nbsp;<span class="ident" id="2896378">err</span>&nbsp;<span class="builtintype" id="2896382">error</span><span class="op" id="2896387">)</span>&nbsp;<span class="op" id="2896389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896392">sw</span>&nbsp;<span class="op" id="2896395">:=</span>&nbsp;<span class="ident" id="2896398">getStringWriter</span><span class="op" id="2896413">(</span><span class="ident" id="2896414">w</span><span class="op" id="2896415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896418">last</span>&nbsp;<span class="op" id="2896423">:=</span>&nbsp;<span class="num" id="2896426">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896429">for</span>&nbsp;<span class="ident" id="2896433">i</span>&nbsp;<span class="op" id="2896435">:=</span>&nbsp;<span class="num" id="2896438">0</span><span class="op" id="2896439">;</span>&nbsp;<span class="ident" id="2896441">i</span>&nbsp;<span class="op" id="2896443">&lt;</span>&nbsp;<span class="builtinfunc" id="2896445">len</span><span class="op" id="2896448">(</span><span class="ident" id="2896449">s</span><span class="op" id="2896450">)</span><span class="op" id="2896451">;</span>&nbsp;<span class="ident" id="2896453">i</span><span class="op" id="2896454">++</span>&nbsp;<span class="op" id="2896457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896461">b</span>&nbsp;<span class="op" id="2896463">:=</span>&nbsp;<span class="ident" id="2896466">s</span><span class="op" id="2896467">[</span><span class="ident" id="2896468">i</span><span class="op" id="2896469">]</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896473">if</span>&nbsp;<span class="ident" id="2896476">r</span><span class="op" id="2896477">[</span><span class="ident" id="2896478">b</span><span class="op" id="2896479">]</span>&nbsp;<span class="op" id="2896481">==</span>&nbsp;<span class="ident" id="2896484">nil</span>&nbsp;<span class="op" id="2896488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896493">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2896504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896508">if</span>&nbsp;<span class="ident" id="2896511">last</span>&nbsp;<span class="op" id="2896516">!=</span>&nbsp;<span class="ident" id="2896519">i</span>&nbsp;<span class="op" id="2896521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896526">nw</span><span class="op" id="2896528">,</span>&nbsp;<span class="ident" id="2896530">err</span>&nbsp;<span class="op" id="2896534">:=</span>&nbsp;<span class="ident" id="2896537">sw</span><span class="op" id="2896539">.</span><span class="ident" id="2896540">WriteString</span><span class="op" id="2896551">(</span><span class="ident" id="2896552">s</span><span class="op" id="2896553">[</span><span class="ident" id="2896554">last</span><span class="op" id="2896558">:</span><span class="ident" id="2896559">i</span><span class="op" id="2896560">]</span><span class="op" id="2896561">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896566">n</span>&nbsp;<span class="op" id="2896568">+=</span>&nbsp;<span class="ident" id="2896571">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896577">if</span>&nbsp;<span class="ident" id="2896580">err</span>&nbsp;<span class="op" id="2896584">!=</span>&nbsp;<span class="ident" id="2896587">nil</span>&nbsp;<span class="op" id="2896591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896597">return</span>&nbsp;<span class="ident" id="2896604">n</span><span class="op" id="2896605">,</span>&nbsp;<span class="ident" id="2896607">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2896614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2896618">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896622">last</span>&nbsp;<span class="op" id="2896627">=</span>&nbsp;<span class="ident" id="2896629">i</span>&nbsp;<span class="op" id="2896631">+</span>&nbsp;<span class="num" id="2896633">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896637">nw</span><span class="op" id="2896639">,</span>&nbsp;<span class="ident" id="2896641">err</span>&nbsp;<span class="op" id="2896645">:=</span>&nbsp;<span class="ident" id="2896648">w</span><span class="op" id="2896649">.</span><span class="ident" id="2896650">Write</span><span class="op" id="2896655">(</span><span class="ident" id="2896656">r</span><span class="op" id="2896657">[</span><span class="ident" id="2896658">b</span><span class="op" id="2896659">]</span><span class="op" id="2896660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896664">n</span>&nbsp;<span class="op" id="2896666">+=</span>&nbsp;<span class="ident" id="2896669">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896674">if</span>&nbsp;<span class="ident" id="2896677">err</span>&nbsp;<span class="op" id="2896681">!=</span>&nbsp;<span class="ident" id="2896684">nil</span>&nbsp;<span class="op" id="2896688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896693">return</span>&nbsp;<span class="ident" id="2896700">n</span><span class="op" id="2896701">,</span>&nbsp;<span class="ident" id="2896703">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2896709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2896712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896715">if</span>&nbsp;<span class="ident" id="2896718">last</span>&nbsp;<span class="op" id="2896723">!=</span>&nbsp;<span class="builtinfunc" id="2896726">len</span><span class="op" id="2896729">(</span><span class="ident" id="2896730">s</span><span class="op" id="2896731">)</span>&nbsp;<span class="op" id="2896733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896737">var</span>&nbsp;<span class="ident" id="2896741">nw</span>&nbsp;<span class="builtintype" id="2896744">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896750">nw</span><span class="op" id="2896752">,</span>&nbsp;<span class="ident" id="2896754">err</span>&nbsp;<span class="op" id="2896758">=</span>&nbsp;<span class="ident" id="2896760">sw</span><span class="op" id="2896762">.</span><span class="ident" id="2896763">WriteString</span><span class="op" id="2896774">(</span><span class="ident" id="2896775">s</span><span class="op" id="2896776">[</span><span class="ident" id="2896777">last</span><span class="op" id="2896781">:</span><span class="op" id="2896782">]</span><span class="op" id="2896783">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2896787">n</span>&nbsp;<span class="op" id="2896789">+=</span>&nbsp;<span class="ident" id="2896792">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2896796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2896799">return</span><br>
<span class="lineno"></span><span class="op" id="2896806">}</span>
</div>
</body>
</html>
