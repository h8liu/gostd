<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4554929">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4554984">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4555038">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4555089">package</span>&nbsp;<span class="ident" id="4555097">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4555107">import</span>&nbsp;<span class="op" id="4555114">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4555117">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4555126">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4555133">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4555141">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4555147">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4555164">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="4555186">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="4555189">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4555250">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="4555321">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4555411">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="4555479">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="4555492">func</span>&nbsp;<span class="ident" id="4555497">escapeTemplate</span><span class="op" id="4555511">(</span><span class="ident" id="4555512">tmpl</span>&nbsp;<span class="op" id="4555517">*</span><span class="ident" id="4555518">Template</span><span class="op" id="4555526">,</span>&nbsp;<span class="ident" id="4555528">node</span>&nbsp;<span class="ident" id="4555533">parse</span><span class="op" id="4555538">.</span><span class="ident" id="4555539">Node</span><span class="op" id="4555543">,</span>&nbsp;<span class="ident" id="4555545">name</span>&nbsp;<span class="builtintype" id="4555550">string</span><span class="op" id="4555556">)</span>&nbsp;<span class="builtintype" id="4555558">error</span>&nbsp;<span class="op" id="4555564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555567">e</span>&nbsp;<span class="op" id="4555569">:=</span>&nbsp;<span class="ident" id="4555572">newEscaper</span><span class="op" id="4555582">(</span><span class="ident" id="4555583">tmpl</span><span class="op" id="4555587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555590">c</span><span class="op" id="4555591">,</span>&nbsp;<span class="ident" id="4555593">_</span>&nbsp;<span class="op" id="4555595">:=</span>&nbsp;<span class="ident" id="4555598">e</span><span class="op" id="4555599">.</span><span class="ident" id="4555600">escapeTree</span><span class="op" id="4555610">(</span><span class="ident" id="4555611">context</span><span class="op" id="4555618">{</span><span class="op" id="4555619">}</span><span class="op" id="4555620">,</span>&nbsp;<span class="ident" id="4555622">node</span><span class="op" id="4555626">,</span>&nbsp;<span class="ident" id="4555628">name</span><span class="op" id="4555632">,</span>&nbsp;<span class="num" id="4555634">0</span><span class="op" id="4555635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555638">var</span>&nbsp;<span class="ident" id="4555642">err</span>&nbsp;<span class="builtintype" id="4555646">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555653">if</span>&nbsp;<span class="ident" id="4555656">c</span><span class="op" id="4555657">.</span><span class="ident" id="4555658">err</span>&nbsp;<span class="op" id="4555662">!=</span>&nbsp;<span class="ident" id="4555665">nil</span>&nbsp;<span class="op" id="4555669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555673">err</span><span class="op" id="4555676">,</span>&nbsp;<span class="ident" id="4555678">c</span><span class="op" id="4555679">.</span><span class="ident" id="4555680">err</span><span class="op" id="4555683">.</span><span class="ident" id="4555684">Name</span>&nbsp;<span class="op" id="4555689">=</span>&nbsp;<span class="ident" id="4555691">c</span><span class="op" id="4555692">.</span><span class="ident" id="4555693">err</span><span class="op" id="4555696">,</span>&nbsp;<span class="ident" id="4555698">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555704">}</span>&nbsp;<span class="keyword" id="4555706">else</span>&nbsp;<span class="keyword" id="4555711">if</span>&nbsp;<span class="ident" id="4555714">c</span><span class="op" id="4555715">.</span><span class="ident" id="4555716">state</span>&nbsp;<span class="op" id="4555722">!=</span>&nbsp;<span class="ident" id="4555725">stateText</span>&nbsp;<span class="op" id="4555735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555739">err</span>&nbsp;<span class="op" id="4555743">=</span>&nbsp;<span class="op" id="4555745">&amp;</span><span class="ident" id="4555746">Error</span><span class="op" id="4555751">{</span><span class="ident" id="4555752">ErrEndContext</span><span class="op" id="4555765">,</span>&nbsp;<span class="ident" id="4555767">nil</span><span class="op" id="4555770">,</span>&nbsp;<span class="ident" id="4555772">name</span><span class="op" id="4555776">,</span>&nbsp;<span class="num" id="4555778">0</span><span class="op" id="4555779">,</span>&nbsp;<span class="ident" id="4555781">fmt</span><span class="op" id="4555784">.</span><span class="ident" id="4555785">Sprintf</span><span class="op" id="4555792">(</span><span class="string" id="4555793">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="4555825">,</span>&nbsp;<span class="ident" id="4555827">c</span><span class="op" id="4555828">)</span><span class="op" id="4555829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555832">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555835">if</span>&nbsp;<span class="ident" id="4555838">err</span>&nbsp;<span class="op" id="4555842">!=</span>&nbsp;<span class="ident" id="4555845">nil</span>&nbsp;<span class="op" id="4555849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4555853">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555897">if</span>&nbsp;<span class="ident" id="4555900">t</span>&nbsp;<span class="op" id="4555902">:=</span>&nbsp;<span class="ident" id="4555905">tmpl</span><span class="op" id="4555909">.</span><span class="ident" id="4555910">set</span><span class="op" id="4555913">[</span><span class="ident" id="4555914">name</span><span class="op" id="4555918">]</span><span class="op" id="4555919">;</span>&nbsp;<span class="ident" id="4555921">t</span>&nbsp;<span class="op" id="4555923">!=</span>&nbsp;<span class="ident" id="4555926">nil</span>&nbsp;<span class="op" id="4555930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555935">t</span><span class="op" id="4555936">.</span><span class="ident" id="4555937">escapeErr</span>&nbsp;<span class="op" id="4555947">=</span>&nbsp;<span class="ident" id="4555949">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555956">t</span><span class="op" id="4555957">.</span><span class="ident" id="4555958">text</span><span class="op" id="4555962">.</span><span class="ident" id="4555963">Tree</span>&nbsp;<span class="op" id="4555968">=</span>&nbsp;<span class="ident" id="4555970">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4555977">t</span><span class="op" id="4555978">.</span><span class="ident" id="4555979">Tree</span>&nbsp;<span class="op" id="4555984">=</span>&nbsp;<span class="ident" id="4555986">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4555992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4555996">return</span>&nbsp;<span class="ident" id="4556003">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4556008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556011">e</span><span class="op" id="4556012">.</span><span class="ident" id="4556013">commit</span><span class="op" id="4556019">(</span><span class="op" id="4556020">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556023">if</span>&nbsp;<span class="ident" id="4556026">t</span>&nbsp;<span class="op" id="4556028">:=</span>&nbsp;<span class="ident" id="4556031">tmpl</span><span class="op" id="4556035">.</span><span class="ident" id="4556036">set</span><span class="op" id="4556039">[</span><span class="ident" id="4556040">name</span><span class="op" id="4556044">]</span><span class="op" id="4556045">;</span>&nbsp;<span class="ident" id="4556047">t</span>&nbsp;<span class="op" id="4556049">!=</span>&nbsp;<span class="ident" id="4556052">nil</span>&nbsp;<span class="op" id="4556056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556060">t</span><span class="op" id="4556061">.</span><span class="ident" id="4556062">escapeErr</span>&nbsp;<span class="op" id="4556072">=</span>&nbsp;<span class="ident" id="4556074">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4556085">t</span><span class="op" id="4556086">.</span><span class="ident" id="4556087">Tree</span>&nbsp;<span class="op" id="4556092">=</span>&nbsp;<span class="ident" id="4556094">t</span><span class="op" id="4556095">.</span><span class="ident" id="4556096">text</span><span class="op" id="4556100">.</span><span class="ident" id="4556101">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4556107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4556110">return</span>&nbsp;<span class="ident" id="4556117">nil</span><br>
<span class="lineno">45</span><span class="op" id="4556121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4556124">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="4556198">var</span>&nbsp;<span class="ident" id="4556202">funcMap</span>&nbsp;<span class="op" id="4556210">=</span>&nbsp;<span class="ident" id="4556212">template</span><span class="op" id="4556220">.</span><span class="ident" id="4556221">FuncMap</span><span class="op" id="4556228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556231">&#34;html_template_attrescaper&#34;</span><span class="op" id="4556258">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4556264">attrEscaper</span><span class="op" id="4556275">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556278">&#34;html_template_commentescaper&#34;</span><span class="op" id="4556308">:</span>&nbsp;&nbsp;<span class="ident" id="4556311">commentEscaper</span><span class="op" id="4556325">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556328">&#34;html_template_cssescaper&#34;</span><span class="op" id="4556354">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4556361">cssEscaper</span><span class="op" id="4556371">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556374">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="4556404">:</span>&nbsp;&nbsp;<span class="ident" id="4556407">cssValueFilter</span><span class="op" id="4556421">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556424">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="4556454">:</span>&nbsp;&nbsp;<span class="ident" id="4556457">htmlNameFilter</span><span class="op" id="4556471">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556474">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4556501">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4556507">htmlEscaper</span><span class="op" id="4556518">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556521">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="4556552">:</span>&nbsp;<span class="ident" id="4556554">jsRegexpEscaper</span><span class="op" id="4556569">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556572">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="4556600">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4556605">jsStrEscaper</span><span class="op" id="4556617">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556620">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="4556648">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4556653">jsValEscaper</span><span class="op" id="4556665">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556668">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4556698">:</span>&nbsp;&nbsp;<span class="ident" id="4556701">htmlNospaceEscaper</span><span class="op" id="4556719">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556722">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="4556751">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4556755">rcdataEscaper</span><span class="op" id="4556768">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556771">&#34;html_template_urlescaper&#34;</span><span class="op" id="4556797">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4556804">urlEscaper</span><span class="op" id="4556814">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556817">&#34;html_template_urlfilter&#34;</span><span class="op" id="4556842">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4556850">urlFilter</span><span class="op" id="4556859">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4556862">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4556891">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4556895">urlNormalizer</span><span class="op" id="4556908">,</span><br>
<span class="lineno"></span><span class="op" id="4556910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4556913">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="4556991">var</span>&nbsp;<span class="ident" id="4556995">equivEscapers</span>&nbsp;<span class="op" id="4557009">=</span>&nbsp;<span class="keyword" id="4557011">map</span><span class="op" id="4557014">[</span><span class="builtintype" id="4557015">string</span><span class="op" id="4557021">]</span><span class="builtintype" id="4557022">string</span><span class="op" id="4557028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4557031">&#34;html_template_attrescaper&#34;</span><span class="op" id="4557058">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4557063">&#34;html&#34;</span><span class="op" id="4557069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4557072">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4557099">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4557104">&#34;html&#34;</span><span class="op" id="4557110">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4557113">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4557143">:</span>&nbsp;<span class="string" id="4557145">&#34;html&#34;</span><span class="op" id="4557151">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4557154">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="4557183">:</span>&nbsp;&nbsp;<span class="string" id="4557186">&#34;html&#34;</span><span class="op" id="4557192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4557195">&#34;html_template_urlescaper&#34;</span><span class="op" id="4557221">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4557227">&#34;urlquery&#34;</span><span class="op" id="4557237">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4557240">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4557269">:</span>&nbsp;&nbsp;<span class="string" id="4557272">&#34;urlquery&#34;</span><span class="op" id="4557282">,</span><br>
<span class="lineno"></span><span class="op" id="4557284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4557287">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="4557366">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="4557395">type</span>&nbsp;<span class="ident" id="4557400">escaper</span>&nbsp;<span class="keyword" id="4557408">struct</span>&nbsp;<span class="op" id="4557415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557418">tmpl</span>&nbsp;<span class="op" id="4557423">*</span><span class="ident" id="4557424">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4557434">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4557505">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557556">output</span>&nbsp;<span class="keyword" id="4557563">map</span><span class="op" id="4557566">[</span><span class="builtintype" id="4557567">string</span><span class="op" id="4557573">]</span><span class="ident" id="4557574">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4557583">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4557656">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557709">derived</span>&nbsp;<span class="keyword" id="4557717">map</span><span class="op" id="4557720">[</span><span class="builtintype" id="4557721">string</span><span class="op" id="4557727">]</span><span class="op" id="4557728">*</span><span class="ident" id="4557729">template</span><span class="op" id="4557737">.</span><span class="ident" id="4557738">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4557748">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4557816">called</span>&nbsp;<span class="keyword" id="4557823">map</span><span class="op" id="4557826">[</span><span class="builtintype" id="4557827">string</span><span class="op" id="4557833">]</span><span class="builtintype" id="4557834">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4557840">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4557907">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4557973">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558035">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="4558053">map</span><span class="op" id="4558056">[</span><span class="op" id="4558057">*</span><span class="ident" id="4558058">parse</span><span class="op" id="4558063">.</span><span class="ident" id="4558064">ActionNode</span><span class="op" id="4558074">]</span><span class="op" id="4558075">[</span><span class="op" id="4558076">]</span><span class="builtintype" id="4558077">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558085">templateNodeEdits</span>&nbsp;<span class="keyword" id="4558103">map</span><span class="op" id="4558106">[</span><span class="op" id="4558107">*</span><span class="ident" id="4558108">parse</span><span class="op" id="4558113">.</span><span class="ident" id="4558114">TemplateNode</span><span class="op" id="4558126">]</span><span class="builtintype" id="4558127">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558135">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4558153">map</span><span class="op" id="4558156">[</span><span class="op" id="4558157">*</span><span class="ident" id="4558158">parse</span><span class="op" id="4558163">.</span><span class="ident" id="4558164">TextNode</span><span class="op" id="4558172">]</span><span class="op" id="4558173">[</span><span class="op" id="4558174">]</span><span class="builtintype" id="4558175">byte</span><br>
<span class="lineno"></span><span class="op" id="4558180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4558183">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="4558240">func</span>&nbsp;<span class="ident" id="4558245">newEscaper</span><span class="op" id="4558255">(</span><span class="ident" id="4558256">t</span>&nbsp;<span class="op" id="4558258">*</span><span class="ident" id="4558259">Template</span><span class="op" id="4558267">)</span>&nbsp;<span class="op" id="4558269">*</span><span class="ident" id="4558270">escaper</span>&nbsp;<span class="op" id="4558278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558281">return</span>&nbsp;<span class="op" id="4558288">&amp;</span><span class="ident" id="4558289">escaper</span><span class="op" id="4558296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4558300">t</span><span class="op" id="4558301">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558305">map</span><span class="op" id="4558308">[</span><span class="builtintype" id="4558309">string</span><span class="op" id="4558315">]</span><span class="ident" id="4558316">context</span><span class="op" id="4558323">{</span><span class="op" id="4558324">}</span><span class="op" id="4558325">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558329">map</span><span class="op" id="4558332">[</span><span class="builtintype" id="4558333">string</span><span class="op" id="4558339">]</span><span class="op" id="4558340">*</span><span class="ident" id="4558341">template</span><span class="op" id="4558349">.</span><span class="ident" id="4558350">Template</span><span class="op" id="4558358">{</span><span class="op" id="4558359">}</span><span class="op" id="4558360">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558364">map</span><span class="op" id="4558367">[</span><span class="builtintype" id="4558368">string</span><span class="op" id="4558374">]</span><span class="builtintype" id="4558375">bool</span><span class="op" id="4558379">{</span><span class="op" id="4558380">}</span><span class="op" id="4558381">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558385">map</span><span class="op" id="4558388">[</span><span class="op" id="4558389">*</span><span class="ident" id="4558390">parse</span><span class="op" id="4558395">.</span><span class="ident" id="4558396">ActionNode</span><span class="op" id="4558406">]</span><span class="op" id="4558407">[</span><span class="op" id="4558408">]</span><span class="builtintype" id="4558409">string</span><span class="op" id="4558415">{</span><span class="op" id="4558416">}</span><span class="op" id="4558417">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558421">map</span><span class="op" id="4558424">[</span><span class="op" id="4558425">*</span><span class="ident" id="4558426">parse</span><span class="op" id="4558431">.</span><span class="ident" id="4558432">TemplateNode</span><span class="op" id="4558444">]</span><span class="builtintype" id="4558445">string</span><span class="op" id="4558451">{</span><span class="op" id="4558452">}</span><span class="op" id="4558453">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558457">map</span><span class="op" id="4558460">[</span><span class="op" id="4558461">*</span><span class="ident" id="4558462">parse</span><span class="op" id="4558467">.</span><span class="ident" id="4558468">TextNode</span><span class="op" id="4558476">]</span><span class="op" id="4558477">[</span><span class="op" id="4558478">]</span><span class="builtintype" id="4558479">byte</span><span class="op" id="4558483">{</span><span class="op" id="4558484">}</span><span class="op" id="4558485">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4558488">}</span><br>
<span class="lineno"></span><span class="op" id="4558490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4558493">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="4558574">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="4558650">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="4558729">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="4558806">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="4558830">const</span>&nbsp;<span class="ident" id="4558836">filterFailsafe</span>&nbsp;<span class="op" id="4558851">=</span>&nbsp;<span class="string" id="4558853">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="4558865">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4558900">func</span>&nbsp;<span class="op" id="4558905">(</span><span class="ident" id="4558906">e</span>&nbsp;<span class="op" id="4558908">*</span><span class="ident" id="4558909">escaper</span><span class="op" id="4558916">)</span>&nbsp;<span class="ident" id="4558918">escape</span><span class="op" id="4558924">(</span><span class="ident" id="4558925">c</span>&nbsp;<span class="ident" id="4558927">context</span><span class="op" id="4558934">,</span>&nbsp;<span class="ident" id="4558936">n</span>&nbsp;<span class="ident" id="4558938">parse</span><span class="op" id="4558943">.</span><span class="ident" id="4558944">Node</span><span class="op" id="4558948">)</span>&nbsp;<span class="ident" id="4558950">context</span>&nbsp;<span class="op" id="4558958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558961">switch</span>&nbsp;<span class="ident" id="4558968">n</span>&nbsp;<span class="op" id="4558970">:=</span>&nbsp;<span class="ident" id="4558973">n</span><span class="op" id="4558974">.</span><span class="op" id="4558975">(</span><span class="keyword" id="4558976">type</span><span class="op" id="4558980">)</span>&nbsp;<span class="op" id="4558982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4558985">case</span>&nbsp;<span class="op" id="4558990">*</span><span class="ident" id="4558991">parse</span><span class="op" id="4558996">.</span><span class="ident" id="4558997">ActionNode</span><span class="op" id="4559007">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559011">return</span>&nbsp;<span class="ident" id="4559018">e</span><span class="op" id="4559019">.</span><span class="ident" id="4559020">escapeAction</span><span class="op" id="4559032">(</span><span class="ident" id="4559033">c</span><span class="op" id="4559034">,</span>&nbsp;<span class="ident" id="4559036">n</span><span class="op" id="4559037">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559040">case</span>&nbsp;<span class="op" id="4559045">*</span><span class="ident" id="4559046">parse</span><span class="op" id="4559051">.</span><span class="ident" id="4559052">IfNode</span><span class="op" id="4559058">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559062">return</span>&nbsp;<span class="ident" id="4559069">e</span><span class="op" id="4559070">.</span><span class="ident" id="4559071">escapeBranch</span><span class="op" id="4559083">(</span><span class="ident" id="4559084">c</span><span class="op" id="4559085">,</span>&nbsp;<span class="op" id="4559087">&amp;</span><span class="ident" id="4559088">n</span><span class="op" id="4559089">.</span><span class="ident" id="4559090">BranchNode</span><span class="op" id="4559100">,</span>&nbsp;<span class="string" id="4559102">&#34;if&#34;</span><span class="op" id="4559106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559109">case</span>&nbsp;<span class="op" id="4559114">*</span><span class="ident" id="4559115">parse</span><span class="op" id="4559120">.</span><span class="ident" id="4559121">ListNode</span><span class="op" id="4559129">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559133">return</span>&nbsp;<span class="ident" id="4559140">e</span><span class="op" id="4559141">.</span><span class="ident" id="4559142">escapeList</span><span class="op" id="4559152">(</span><span class="ident" id="4559153">c</span><span class="op" id="4559154">,</span>&nbsp;<span class="ident" id="4559156">n</span><span class="op" id="4559157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559160">case</span>&nbsp;<span class="op" id="4559165">*</span><span class="ident" id="4559166">parse</span><span class="op" id="4559171">.</span><span class="ident" id="4559172">RangeNode</span><span class="op" id="4559181">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559185">return</span>&nbsp;<span class="ident" id="4559192">e</span><span class="op" id="4559193">.</span><span class="ident" id="4559194">escapeBranch</span><span class="op" id="4559206">(</span><span class="ident" id="4559207">c</span><span class="op" id="4559208">,</span>&nbsp;<span class="op" id="4559210">&amp;</span><span class="ident" id="4559211">n</span><span class="op" id="4559212">.</span><span class="ident" id="4559213">BranchNode</span><span class="op" id="4559223">,</span>&nbsp;<span class="string" id="4559225">&#34;range&#34;</span><span class="op" id="4559232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559235">case</span>&nbsp;<span class="op" id="4559240">*</span><span class="ident" id="4559241">parse</span><span class="op" id="4559246">.</span><span class="ident" id="4559247">TemplateNode</span><span class="op" id="4559259">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559263">return</span>&nbsp;<span class="ident" id="4559270">e</span><span class="op" id="4559271">.</span><span class="ident" id="4559272">escapeTemplate</span><span class="op" id="4559286">(</span><span class="ident" id="4559287">c</span><span class="op" id="4559288">,</span>&nbsp;<span class="ident" id="4559290">n</span><span class="op" id="4559291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559294">case</span>&nbsp;<span class="op" id="4559299">*</span><span class="ident" id="4559300">parse</span><span class="op" id="4559305">.</span><span class="ident" id="4559306">TextNode</span><span class="op" id="4559314">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559318">return</span>&nbsp;<span class="ident" id="4559325">e</span><span class="op" id="4559326">.</span><span class="ident" id="4559327">escapeText</span><span class="op" id="4559337">(</span><span class="ident" id="4559338">c</span><span class="op" id="4559339">,</span>&nbsp;<span class="ident" id="4559341">n</span><span class="op" id="4559342">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559345">case</span>&nbsp;<span class="op" id="4559350">*</span><span class="ident" id="4559351">parse</span><span class="op" id="4559356">.</span><span class="ident" id="4559357">WithNode</span><span class="op" id="4559365">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559369">return</span>&nbsp;<span class="ident" id="4559376">e</span><span class="op" id="4559377">.</span><span class="ident" id="4559378">escapeBranch</span><span class="op" id="4559390">(</span><span class="ident" id="4559391">c</span><span class="op" id="4559392">,</span>&nbsp;<span class="op" id="4559394">&amp;</span><span class="ident" id="4559395">n</span><span class="op" id="4559396">.</span><span class="ident" id="4559397">BranchNode</span><span class="op" id="4559407">,</span>&nbsp;<span class="string" id="4559409">&#34;with&#34;</span><span class="op" id="4559415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4559418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4559421">panic</span><span class="op" id="4559426">(</span><span class="string" id="4559427">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="4559439">+</span>&nbsp;<span class="ident" id="4559441">n</span><span class="op" id="4559442">.</span><span class="ident" id="4559443">String</span><span class="op" id="4559449">(</span><span class="op" id="4559450">)</span>&nbsp;<span class="op" id="4559452">+</span>&nbsp;<span class="string" id="4559454">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="4559473">)</span><br>
<span class="lineno"></span><span class="op" id="4559475">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="4559478">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4559527">func</span>&nbsp;<span class="op" id="4559532">(</span><span class="ident" id="4559533">e</span>&nbsp;<span class="op" id="4559535">*</span><span class="ident" id="4559536">escaper</span><span class="op" id="4559543">)</span>&nbsp;<span class="ident" id="4559545">escapeAction</span><span class="op" id="4559557">(</span><span class="ident" id="4559558">c</span>&nbsp;<span class="ident" id="4559560">context</span><span class="op" id="4559567">,</span>&nbsp;<span class="ident" id="4559569">n</span>&nbsp;<span class="op" id="4559571">*</span><span class="ident" id="4559572">parse</span><span class="op" id="4559577">.</span><span class="ident" id="4559578">ActionNode</span><span class="op" id="4559588">)</span>&nbsp;<span class="ident" id="4559590">context</span>&nbsp;<span class="op" id="4559598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559601">if</span>&nbsp;<span class="builtinfunc" id="4559604">len</span><span class="op" id="4559607">(</span><span class="ident" id="4559608">n</span><span class="op" id="4559609">.</span><span class="ident" id="4559610">Pipe</span><span class="op" id="4559614">.</span><span class="ident" id="4559615">Decl</span><span class="op" id="4559619">)</span>&nbsp;<span class="op" id="4559621">!=</span>&nbsp;<span class="num" id="4559624">0</span>&nbsp;<span class="op" id="4559626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4559630">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559686">return</span>&nbsp;<span class="ident" id="4559693">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4559696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559699">c</span>&nbsp;<span class="op" id="4559701">=</span>&nbsp;<span class="ident" id="4559703">nudge</span><span class="op" id="4559708">(</span><span class="ident" id="4559709">c</span><span class="op" id="4559710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559713">s</span>&nbsp;<span class="op" id="4559715">:=</span>&nbsp;<span class="builtinfunc" id="4559718">make</span><span class="op" id="4559722">(</span><span class="op" id="4559723">[</span><span class="op" id="4559724">]</span><span class="builtintype" id="4559725">string</span><span class="op" id="4559731">,</span>&nbsp;<span class="num" id="4559733">0</span><span class="op" id="4559734">,</span>&nbsp;<span class="num" id="4559736">3</span><span class="op" id="4559737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559740">switch</span>&nbsp;<span class="ident" id="4559747">c</span><span class="op" id="4559748">.</span><span class="ident" id="4559749">state</span>&nbsp;<span class="op" id="4559755">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559758">case</span>&nbsp;<span class="ident" id="4559763">stateError</span><span class="op" id="4559773">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559777">return</span>&nbsp;<span class="ident" id="4559784">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559787">case</span>&nbsp;<span class="ident" id="4559792">stateURL</span><span class="op" id="4559800">,</span>&nbsp;<span class="ident" id="4559802">stateCSSDqStr</span><span class="op" id="4559815">,</span>&nbsp;<span class="ident" id="4559817">stateCSSSqStr</span><span class="op" id="4559830">,</span>&nbsp;<span class="ident" id="4559832">stateCSSDqURL</span><span class="op" id="4559845">,</span>&nbsp;<span class="ident" id="4559847">stateCSSSqURL</span><span class="op" id="4559860">,</span>&nbsp;<span class="ident" id="4559862">stateCSSURL</span><span class="op" id="4559873">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559877">switch</span>&nbsp;<span class="ident" id="4559884">c</span><span class="op" id="4559885">.</span><span class="ident" id="4559886">urlPart</span>&nbsp;<span class="op" id="4559894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559898">case</span>&nbsp;<span class="ident" id="4559903">urlPartNone</span><span class="op" id="4559914">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4559919">s</span>&nbsp;<span class="op" id="4559921">=</span>&nbsp;<span class="builtinfunc" id="4559923">append</span><span class="op" id="4559929">(</span><span class="ident" id="4559930">s</span><span class="op" id="4559931">,</span>&nbsp;<span class="string" id="4559933">&#34;html_template_urlfilter&#34;</span><span class="op" id="4559958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559963">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4559977">case</span>&nbsp;<span class="ident" id="4559982">urlPartPreQuery</span><span class="op" id="4559997">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560002">switch</span>&nbsp;<span class="ident" id="4560009">c</span><span class="op" id="4560010">.</span><span class="ident" id="4560011">state</span>&nbsp;<span class="op" id="4560017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560022">case</span>&nbsp;<span class="ident" id="4560027">stateCSSDqStr</span><span class="op" id="4560040">,</span>&nbsp;<span class="ident" id="4560042">stateCSSSqStr</span><span class="op" id="4560055">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560061">s</span>&nbsp;<span class="op" id="4560063">=</span>&nbsp;<span class="builtinfunc" id="4560065">append</span><span class="op" id="4560071">(</span><span class="ident" id="4560072">s</span><span class="op" id="4560073">,</span>&nbsp;<span class="string" id="4560075">&#34;html_template_cssescaper&#34;</span><span class="op" id="4560101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560106">default</span><span class="op" id="4560113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560119">s</span>&nbsp;<span class="op" id="4560121">=</span>&nbsp;<span class="builtinfunc" id="4560123">append</span><span class="op" id="4560129">(</span><span class="ident" id="4560130">s</span><span class="op" id="4560131">,</span>&nbsp;<span class="string" id="4560133">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4560162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560171">case</span>&nbsp;<span class="ident" id="4560176">urlPartQueryOrFrag</span><span class="op" id="4560194">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560199">s</span>&nbsp;<span class="op" id="4560201">=</span>&nbsp;<span class="builtinfunc" id="4560203">append</span><span class="op" id="4560209">(</span><span class="ident" id="4560210">s</span><span class="op" id="4560211">,</span>&nbsp;<span class="string" id="4560213">&#34;html_template_urlescaper&#34;</span><span class="op" id="4560239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560243">case</span>&nbsp;<span class="ident" id="4560248">urlPartUnknown</span><span class="op" id="4560262">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560267">return</span>&nbsp;<span class="ident" id="4560274">context</span><span class="op" id="4560281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560287">state</span><span class="op" id="4560292">:</span>&nbsp;<span class="ident" id="4560294">stateError</span><span class="op" id="4560304">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560310">err</span><span class="op" id="4560313">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4560317">errorf</span><span class="op" id="4560323">(</span><span class="ident" id="4560324">ErrAmbigContext</span><span class="op" id="4560339">,</span>&nbsp;<span class="ident" id="4560341">n</span><span class="op" id="4560342">,</span>&nbsp;<span class="ident" id="4560344">n</span><span class="op" id="4560345">.</span><span class="ident" id="4560346">Line</span><span class="op" id="4560350">,</span>&nbsp;<span class="string" id="4560352">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="4560392">,</span>&nbsp;<span class="ident" id="4560394">n</span><span class="op" id="4560395">)</span><span class="op" id="4560396">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560405">default</span><span class="op" id="4560412">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4560417">panic</span><span class="op" id="4560422">(</span><span class="ident" id="4560423">c</span><span class="op" id="4560424">.</span><span class="ident" id="4560425">urlPart</span><span class="op" id="4560432">.</span><span class="ident" id="4560433">String</span><span class="op" id="4560439">(</span><span class="op" id="4560440">)</span><span class="op" id="4560441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4560445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560448">case</span>&nbsp;<span class="ident" id="4560453">stateJS</span><span class="op" id="4560460">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560464">s</span>&nbsp;<span class="op" id="4560466">=</span>&nbsp;<span class="builtinfunc" id="4560468">append</span><span class="op" id="4560474">(</span><span class="ident" id="4560475">s</span><span class="op" id="4560476">,</span>&nbsp;<span class="string" id="4560478">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="4560506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4560510">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560560">c</span><span class="op" id="4560561">.</span><span class="ident" id="4560562">jsCtx</span>&nbsp;<span class="op" id="4560568">=</span>&nbsp;<span class="ident" id="4560570">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560582">case</span>&nbsp;<span class="ident" id="4560587">stateJSDqStr</span><span class="op" id="4560599">,</span>&nbsp;<span class="ident" id="4560601">stateJSSqStr</span><span class="op" id="4560613">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560617">s</span>&nbsp;<span class="op" id="4560619">=</span>&nbsp;<span class="builtinfunc" id="4560621">append</span><span class="op" id="4560627">(</span><span class="ident" id="4560628">s</span><span class="op" id="4560629">,</span>&nbsp;<span class="string" id="4560631">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="4560659">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560662">case</span>&nbsp;<span class="ident" id="4560667">stateJSRegexp</span><span class="op" id="4560680">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560684">s</span>&nbsp;<span class="op" id="4560686">=</span>&nbsp;<span class="builtinfunc" id="4560688">append</span><span class="op" id="4560694">(</span><span class="ident" id="4560695">s</span><span class="op" id="4560696">,</span>&nbsp;<span class="string" id="4560698">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="4560729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560732">case</span>&nbsp;<span class="ident" id="4560737">stateCSS</span><span class="op" id="4560745">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560749">s</span>&nbsp;<span class="op" id="4560751">=</span>&nbsp;<span class="builtinfunc" id="4560753">append</span><span class="op" id="4560759">(</span><span class="ident" id="4560760">s</span><span class="op" id="4560761">,</span>&nbsp;<span class="string" id="4560763">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="4560793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560796">case</span>&nbsp;<span class="ident" id="4560801">stateText</span><span class="op" id="4560810">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560814">s</span>&nbsp;<span class="op" id="4560816">=</span>&nbsp;<span class="builtinfunc" id="4560818">append</span><span class="op" id="4560824">(</span><span class="ident" id="4560825">s</span><span class="op" id="4560826">,</span>&nbsp;<span class="string" id="4560828">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4560855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560858">case</span>&nbsp;<span class="ident" id="4560863">stateRCDATA</span><span class="op" id="4560874">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4560878">s</span>&nbsp;<span class="op" id="4560880">=</span>&nbsp;<span class="builtinfunc" id="4560882">append</span><span class="op" id="4560888">(</span><span class="ident" id="4560889">s</span><span class="op" id="4560890">,</span>&nbsp;<span class="string" id="4560892">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="4560921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560924">case</span>&nbsp;<span class="ident" id="4560929">stateAttr</span><span class="op" id="4560938">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4560942">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4560976">case</span>&nbsp;<span class="ident" id="4560981">stateAttrName</span><span class="op" id="4560994">,</span>&nbsp;<span class="ident" id="4560996">stateTag</span><span class="op" id="4561004">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561008">c</span><span class="op" id="4561009">.</span><span class="ident" id="4561010">state</span>&nbsp;<span class="op" id="4561016">=</span>&nbsp;<span class="ident" id="4561018">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561034">s</span>&nbsp;<span class="op" id="4561036">=</span>&nbsp;<span class="builtinfunc" id="4561038">append</span><span class="op" id="4561044">(</span><span class="ident" id="4561045">s</span><span class="op" id="4561046">,</span>&nbsp;<span class="string" id="4561048">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="4561078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561081">default</span><span class="op" id="4561088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561092">if</span>&nbsp;<span class="ident" id="4561095">isComment</span><span class="op" id="4561104">(</span><span class="ident" id="4561105">c</span><span class="op" id="4561106">.</span><span class="ident" id="4561107">state</span><span class="op" id="4561112">)</span>&nbsp;<span class="op" id="4561114">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561119">s</span>&nbsp;<span class="op" id="4561121">=</span>&nbsp;<span class="builtinfunc" id="4561123">append</span><span class="op" id="4561129">(</span><span class="ident" id="4561130">s</span><span class="op" id="4561131">,</span>&nbsp;<span class="string" id="4561133">&#34;html_template_commentescaper&#34;</span><span class="op" id="4561163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4561167">}</span>&nbsp;<span class="keyword" id="4561169">else</span>&nbsp;<span class="op" id="4561174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4561179">panic</span><span class="op" id="4561184">(</span><span class="string" id="4561185">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="4561205">+</span>&nbsp;<span class="ident" id="4561207">c</span><span class="op" id="4561208">.</span><span class="ident" id="4561209">state</span><span class="op" id="4561214">.</span><span class="ident" id="4561215">String</span><span class="op" id="4561221">(</span><span class="op" id="4561222">)</span><span class="op" id="4561223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4561227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4561230">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561233">switch</span>&nbsp;<span class="ident" id="4561240">c</span><span class="op" id="4561241">.</span><span class="ident" id="4561242">delim</span>&nbsp;<span class="op" id="4561248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561251">case</span>&nbsp;<span class="ident" id="4561256">delimNone</span><span class="op" id="4561265">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4561269">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561320">case</span>&nbsp;<span class="ident" id="4561325">delimSpaceOrTagEnd</span><span class="op" id="4561343">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561347">s</span>&nbsp;<span class="op" id="4561349">=</span>&nbsp;<span class="builtinfunc" id="4561351">append</span><span class="op" id="4561357">(</span><span class="ident" id="4561358">s</span><span class="op" id="4561359">,</span>&nbsp;<span class="string" id="4561361">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4561391">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561394">default</span><span class="op" id="4561401">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561405">s</span>&nbsp;<span class="op" id="4561407">=</span>&nbsp;<span class="builtinfunc" id="4561409">append</span><span class="op" id="4561415">(</span><span class="ident" id="4561416">s</span><span class="op" id="4561417">,</span>&nbsp;<span class="string" id="4561419">&#34;html_template_attrescaper&#34;</span><span class="op" id="4561446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4561449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4561452">e</span><span class="op" id="4561453">.</span><span class="ident" id="4561454">editActionNode</span><span class="op" id="4561468">(</span><span class="ident" id="4561469">n</span><span class="op" id="4561470">,</span>&nbsp;<span class="ident" id="4561472">s</span><span class="op" id="4561473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561476">return</span>&nbsp;<span class="ident" id="4561483">c</span><br>
<span class="lineno">205</span><span class="op" id="4561485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4561488">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="4561573">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="4561636">func</span>&nbsp;<span class="ident" id="4561641">allIdents</span><span class="op" id="4561650">(</span><span class="ident" id="4561651">node</span>&nbsp;<span class="ident" id="4561656">parse</span><span class="op" id="4561661">.</span><span class="ident" id="4561662">Node</span><span class="op" id="4561666">)</span>&nbsp;<span class="op" id="4561668">[</span><span class="op" id="4561669">]</span><span class="builtintype" id="4561670">string</span>&nbsp;<span class="op" id="4561677">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561680">switch</span>&nbsp;<span class="ident" id="4561687">node</span>&nbsp;<span class="op" id="4561692">:=</span>&nbsp;<span class="ident" id="4561695">node</span><span class="op" id="4561699">.</span><span class="op" id="4561700">(</span><span class="keyword" id="4561701">type</span><span class="op" id="4561705">)</span>&nbsp;<span class="op" id="4561707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561710">case</span>&nbsp;<span class="op" id="4561715">*</span><span class="ident" id="4561716">parse</span><span class="op" id="4561721">.</span><span class="ident" id="4561722">IdentifierNode</span><span class="op" id="4561736">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561740">return</span>&nbsp;<span class="op" id="4561747">[</span><span class="op" id="4561748">]</span><span class="builtintype" id="4561749">string</span><span class="op" id="4561755">{</span><span class="ident" id="4561756">node</span><span class="op" id="4561760">.</span><span class="ident" id="4561761">Ident</span><span class="op" id="4561766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561769">case</span>&nbsp;<span class="op" id="4561774">*</span><span class="ident" id="4561775">parse</span><span class="op" id="4561780">.</span><span class="ident" id="4561781">FieldNode</span><span class="op" id="4561790">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4561794">return</span>&nbsp;<span class="ident" id="4561801">node</span><span class="op" id="4561805">.</span><span class="ident" id="4561806">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4561813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4561816">panic</span><span class="op" id="4561821">(</span><span class="string" id="4561822">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="4561859">)</span><br>
<span class="lineno"></span><span class="op" id="4561861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4561864">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="4561934">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="4561968">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="4562041">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4562118">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="4562192">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="4562222">func</span>&nbsp;<span class="ident" id="4562227">ensurePipelineContains</span><span class="op" id="4562249">(</span><span class="ident" id="4562250">p</span>&nbsp;<span class="op" id="4562252">*</span><span class="ident" id="4562253">parse</span><span class="op" id="4562258">.</span><span class="ident" id="4562259">PipeNode</span><span class="op" id="4562267">,</span>&nbsp;<span class="ident" id="4562269">s</span>&nbsp;<span class="op" id="4562271">[</span><span class="op" id="4562272">]</span><span class="builtintype" id="4562273">string</span><span class="op" id="4562279">)</span>&nbsp;<span class="op" id="4562281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562284">if</span>&nbsp;<span class="builtinfunc" id="4562287">len</span><span class="op" id="4562290">(</span><span class="ident" id="4562291">s</span><span class="op" id="4562292">)</span>&nbsp;<span class="op" id="4562294">==</span>&nbsp;<span class="num" id="4562297">0</span>&nbsp;<span class="op" id="4562299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562303">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4562311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562314">n</span>&nbsp;<span class="op" id="4562316">:=</span>&nbsp;<span class="builtinfunc" id="4562319">len</span><span class="op" id="4562322">(</span><span class="ident" id="4562323">p</span><span class="op" id="4562324">.</span><span class="ident" id="4562325">Cmds</span><span class="op" id="4562329">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4562332">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562390">idents</span>&nbsp;<span class="op" id="4562397">:=</span>&nbsp;<span class="ident" id="4562400">p</span><span class="op" id="4562401">.</span><span class="ident" id="4562402">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562408">for</span>&nbsp;<span class="ident" id="4562412">i</span>&nbsp;<span class="op" id="4562414">:=</span>&nbsp;<span class="ident" id="4562417">n</span>&nbsp;<span class="op" id="4562419">-</span>&nbsp;<span class="num" id="4562421">1</span><span class="op" id="4562422">;</span>&nbsp;<span class="ident" id="4562424">i</span>&nbsp;<span class="op" id="4562426">&gt;=</span>&nbsp;<span class="num" id="4562429">0</span><span class="op" id="4562430">;</span>&nbsp;<span class="ident" id="4562432">i</span><span class="op" id="4562433">--</span>&nbsp;<span class="op" id="4562436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562440">if</span>&nbsp;<span class="ident" id="4562443">cmd</span>&nbsp;<span class="op" id="4562447">:=</span>&nbsp;<span class="ident" id="4562450">p</span><span class="op" id="4562451">.</span><span class="ident" id="4562452">Cmds</span><span class="op" id="4562456">[</span><span class="ident" id="4562457">i</span><span class="op" id="4562458">]</span><span class="op" id="4562459">;</span>&nbsp;<span class="builtinfunc" id="4562461">len</span><span class="op" id="4562464">(</span><span class="ident" id="4562465">cmd</span><span class="op" id="4562468">.</span><span class="ident" id="4562469">Args</span><span class="op" id="4562473">)</span>&nbsp;<span class="op" id="4562475">!=</span>&nbsp;<span class="num" id="4562478">0</span>&nbsp;<span class="op" id="4562480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562485">if</span>&nbsp;<span class="ident" id="4562488">_</span><span class="op" id="4562489">,</span>&nbsp;<span class="ident" id="4562491">ok</span>&nbsp;<span class="op" id="4562494">:=</span>&nbsp;<span class="ident" id="4562497">cmd</span><span class="op" id="4562500">.</span><span class="ident" id="4562501">Args</span><span class="op" id="4562505">[</span><span class="num" id="4562506">0</span><span class="op" id="4562507">]</span><span class="op" id="4562508">.</span><span class="op" id="4562509">(</span><span class="op" id="4562510">*</span><span class="ident" id="4562511">parse</span><span class="op" id="4562516">.</span><span class="ident" id="4562517">IdentifierNode</span><span class="op" id="4562531">)</span><span class="op" id="4562532">;</span>&nbsp;<span class="ident" id="4562534">ok</span>&nbsp;<span class="op" id="4562537">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562543">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4562555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4562559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562563">idents</span>&nbsp;<span class="op" id="4562570">=</span>&nbsp;<span class="ident" id="4562572">p</span><span class="op" id="4562573">.</span><span class="ident" id="4562574">Cmds</span><span class="op" id="4562578">[</span><span class="ident" id="4562579">i</span><span class="op" id="4562580">+</span><span class="num" id="4562581">1</span><span class="op" id="4562582">:</span><span class="op" id="4562583">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4562586">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562589">dups</span>&nbsp;<span class="op" id="4562594">:=</span>&nbsp;<span class="num" id="4562597">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562600">for</span>&nbsp;<span class="ident" id="4562604">_</span><span class="op" id="4562605">,</span>&nbsp;<span class="ident" id="4562607">idNode</span>&nbsp;<span class="op" id="4562614">:=</span>&nbsp;<span class="keyword" id="4562617">range</span>&nbsp;<span class="ident" id="4562623">idents</span>&nbsp;<span class="op" id="4562630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562634">for</span>&nbsp;<span class="ident" id="4562638">_</span><span class="op" id="4562639">,</span>&nbsp;<span class="ident" id="4562641">ident</span>&nbsp;<span class="op" id="4562647">:=</span>&nbsp;<span class="keyword" id="4562650">range</span>&nbsp;<span class="ident" id="4562656">allIdents</span><span class="op" id="4562665">(</span><span class="ident" id="4562666">idNode</span><span class="op" id="4562672">.</span><span class="ident" id="4562673">Args</span><span class="op" id="4562677">[</span><span class="num" id="4562678">0</span><span class="op" id="4562679">]</span><span class="op" id="4562680">)</span>&nbsp;<span class="op" id="4562682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562687">if</span>&nbsp;<span class="ident" id="4562690">escFnsEq</span><span class="op" id="4562698">(</span><span class="ident" id="4562699">s</span><span class="op" id="4562700">[</span><span class="ident" id="4562701">dups</span><span class="op" id="4562705">]</span><span class="op" id="4562706">,</span>&nbsp;<span class="ident" id="4562708">ident</span><span class="op" id="4562713">)</span>&nbsp;<span class="op" id="4562715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562721">dups</span><span class="op" id="4562725">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562732">if</span>&nbsp;<span class="ident" id="4562735">dups</span>&nbsp;<span class="op" id="4562740">==</span>&nbsp;<span class="builtinfunc" id="4562743">len</span><span class="op" id="4562746">(</span><span class="ident" id="4562747">s</span><span class="op" id="4562748">)</span>&nbsp;<span class="op" id="4562750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562757">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4562768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4562773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4562777">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4562780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562783">newCmds</span>&nbsp;<span class="op" id="4562791">:=</span>&nbsp;<span class="builtinfunc" id="4562794">make</span><span class="op" id="4562798">(</span><span class="op" id="4562799">[</span><span class="op" id="4562800">]</span><span class="op" id="4562801">*</span><span class="ident" id="4562802">parse</span><span class="op" id="4562807">.</span><span class="ident" id="4562808">CommandNode</span><span class="op" id="4562819">,</span>&nbsp;<span class="ident" id="4562821">n</span><span class="op" id="4562822">-</span><span class="builtinfunc" id="4562823">len</span><span class="op" id="4562826">(</span><span class="ident" id="4562827">idents</span><span class="op" id="4562833">)</span><span class="op" id="4562834">,</span>&nbsp;<span class="ident" id="4562836">n</span><span class="op" id="4562837">+</span><span class="builtinfunc" id="4562838">len</span><span class="op" id="4562841">(</span><span class="ident" id="4562842">s</span><span class="op" id="4562843">)</span><span class="op" id="4562844">-</span><span class="ident" id="4562845">dups</span><span class="op" id="4562849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4562852">copy</span><span class="op" id="4562856">(</span><span class="ident" id="4562857">newCmds</span><span class="op" id="4562864">,</span>&nbsp;<span class="ident" id="4562866">p</span><span class="op" id="4562867">.</span><span class="ident" id="4562868">Cmds</span><span class="op" id="4562872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4562875">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4562942">for</span>&nbsp;<span class="ident" id="4562946">_</span><span class="op" id="4562947">,</span>&nbsp;<span class="ident" id="4562949">idNode</span>&nbsp;<span class="op" id="4562956">:=</span>&nbsp;<span class="keyword" id="4562959">range</span>&nbsp;<span class="ident" id="4562965">idents</span>&nbsp;<span class="op" id="4562972">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4562976">pos</span>&nbsp;<span class="op" id="4562980">:=</span>&nbsp;<span class="ident" id="4562983">idNode</span><span class="op" id="4562989">.</span><span class="ident" id="4562990">Args</span><span class="op" id="4562994">[</span><span class="num" id="4562995">0</span><span class="op" id="4562996">]</span><span class="op" id="4562997">.</span><span class="ident" id="4562998">Position</span><span class="op" id="4563006">(</span><span class="op" id="4563007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4563011">for</span>&nbsp;<span class="ident" id="4563015">_</span><span class="op" id="4563016">,</span>&nbsp;<span class="ident" id="4563018">ident</span>&nbsp;<span class="op" id="4563024">:=</span>&nbsp;<span class="keyword" id="4563027">range</span>&nbsp;<span class="ident" id="4563033">allIdents</span><span class="op" id="4563042">(</span><span class="ident" id="4563043">idNode</span><span class="op" id="4563049">.</span><span class="ident" id="4563050">Args</span><span class="op" id="4563054">[</span><span class="num" id="4563055">0</span><span class="op" id="4563056">]</span><span class="op" id="4563057">)</span>&nbsp;<span class="op" id="4563059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563064">i</span>&nbsp;<span class="op" id="4563066">:=</span>&nbsp;<span class="ident" id="4563069">indexOfStr</span><span class="op" id="4563079">(</span><span class="ident" id="4563080">ident</span><span class="op" id="4563085">,</span>&nbsp;<span class="ident" id="4563087">s</span><span class="op" id="4563088">,</span>&nbsp;<span class="ident" id="4563090">escFnsEq</span><span class="op" id="4563098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4563103">if</span>&nbsp;<span class="ident" id="4563106">i</span>&nbsp;<span class="op" id="4563108">!=</span>&nbsp;<span class="op" id="4563111">-</span><span class="num" id="4563112">1</span>&nbsp;<span class="op" id="4563114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4563120">for</span>&nbsp;<span class="ident" id="4563124">_</span><span class="op" id="4563125">,</span>&nbsp;<span class="ident" id="4563127">name</span>&nbsp;<span class="op" id="4563132">:=</span>&nbsp;<span class="keyword" id="4563135">range</span>&nbsp;<span class="ident" id="4563141">s</span><span class="op" id="4563142">[</span><span class="op" id="4563143">:</span><span class="ident" id="4563144">i</span><span class="op" id="4563145">]</span>&nbsp;<span class="op" id="4563147">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563154">newCmds</span>&nbsp;<span class="op" id="4563162">=</span>&nbsp;<span class="ident" id="4563164">appendCmd</span><span class="op" id="4563173">(</span><span class="ident" id="4563174">newCmds</span><span class="op" id="4563181">,</span>&nbsp;<span class="ident" id="4563183">newIdentCmd</span><span class="op" id="4563194">(</span><span class="ident" id="4563195">name</span><span class="op" id="4563199">,</span>&nbsp;<span class="ident" id="4563201">pos</span><span class="op" id="4563204">)</span><span class="op" id="4563205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563217">s</span>&nbsp;<span class="op" id="4563219">=</span>&nbsp;<span class="ident" id="4563221">s</span><span class="op" id="4563222">[</span><span class="ident" id="4563223">i</span><span class="op" id="4563224">+</span><span class="num" id="4563225">1</span><span class="op" id="4563226">:</span><span class="op" id="4563227">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563236">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563240">newCmds</span>&nbsp;<span class="op" id="4563248">=</span>&nbsp;<span class="ident" id="4563250">appendCmd</span><span class="op" id="4563259">(</span><span class="ident" id="4563260">newCmds</span><span class="op" id="4563267">,</span>&nbsp;<span class="ident" id="4563269">idNode</span><span class="op" id="4563275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4563281">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4563318">for</span>&nbsp;<span class="ident" id="4563322">_</span><span class="op" id="4563323">,</span>&nbsp;<span class="ident" id="4563325">name</span>&nbsp;<span class="op" id="4563330">:=</span>&nbsp;<span class="keyword" id="4563333">range</span>&nbsp;<span class="ident" id="4563339">s</span>&nbsp;<span class="op" id="4563341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563345">newCmds</span>&nbsp;<span class="op" id="4563353">=</span>&nbsp;<span class="ident" id="4563355">appendCmd</span><span class="op" id="4563364">(</span><span class="ident" id="4563365">newCmds</span><span class="op" id="4563372">,</span>&nbsp;<span class="ident" id="4563374">newIdentCmd</span><span class="op" id="4563385">(</span><span class="ident" id="4563386">name</span><span class="op" id="4563390">,</span>&nbsp;<span class="ident" id="4563392">p</span><span class="op" id="4563393">.</span><span class="ident" id="4563394">Position</span><span class="op" id="4563402">(</span><span class="op" id="4563403">)</span><span class="op" id="4563404">)</span><span class="op" id="4563405">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4563411">p</span><span class="op" id="4563412">.</span><span class="ident" id="4563413">Cmds</span>&nbsp;<span class="op" id="4563418">=</span>&nbsp;<span class="ident" id="4563420">newCmds</span><br>
<span class="lineno"></span><span class="op" id="4563428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4563431">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="4563511">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="4563525">var</span>&nbsp;<span class="ident" id="4563529">redundantFuncs</span>&nbsp;<span class="op" id="4563544">=</span>&nbsp;<span class="keyword" id="4563546">map</span><span class="op" id="4563549">[</span><span class="builtintype" id="4563550">string</span><span class="op" id="4563556">]</span><span class="keyword" id="4563557">map</span><span class="op" id="4563560">[</span><span class="builtintype" id="4563561">string</span><span class="op" id="4563567">]</span><span class="builtintype" id="4563568">bool</span><span class="op" id="4563572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4563575">&#34;html_template_commentescaper&#34;</span><span class="op" id="4563605">:</span>&nbsp;<span class="op" id="4563607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4563611">&#34;html_template_attrescaper&#34;</span><span class="op" id="4563638">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4563643">true</span><span class="op" id="4563647">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4563651">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4563681">:</span>&nbsp;<span class="builtintype" id="4563683">true</span><span class="op" id="4563687">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4563691">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4563718">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4563723">true</span><span class="op" id="4563727">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563730">}</span><span class="op" id="4563731">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4563734">&#34;html_template_cssescaper&#34;</span><span class="op" id="4563760">:</span>&nbsp;<span class="op" id="4563762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4563766">&#34;html_template_attrescaper&#34;</span><span class="op" id="4563793">:</span>&nbsp;<span class="builtintype" id="4563795">true</span><span class="op" id="4563799">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563802">}</span><span class="op" id="4563803">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4563806">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="4563837">:</span>&nbsp;<span class="op" id="4563839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4563843">&#34;html_template_attrescaper&#34;</span><span class="op" id="4563870">:</span>&nbsp;<span class="builtintype" id="4563872">true</span><span class="op" id="4563876">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563879">}</span><span class="op" id="4563880">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4563883">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="4563911">:</span>&nbsp;<span class="op" id="4563913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4563917">&#34;html_template_attrescaper&#34;</span><span class="op" id="4563944">:</span>&nbsp;<span class="builtintype" id="4563946">true</span><span class="op" id="4563950">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4563953">}</span><span class="op" id="4563954">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4563957">&#34;html_template_urlescaper&#34;</span><span class="op" id="4563983">:</span>&nbsp;<span class="op" id="4563985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4563989">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4564018">:</span>&nbsp;<span class="builtintype" id="4564020">true</span><span class="op" id="4564024">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4564027">}</span><span class="op" id="4564028">,</span><br>
<span class="lineno"></span><span class="op" id="4564030">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="4564033">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="4564107">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="4564156">func</span>&nbsp;<span class="ident" id="4564161">appendCmd</span><span class="op" id="4564170">(</span><span class="ident" id="4564171">cmds</span>&nbsp;<span class="op" id="4564176">[</span><span class="op" id="4564177">]</span><span class="op" id="4564178">*</span><span class="ident" id="4564179">parse</span><span class="op" id="4564184">.</span><span class="ident" id="4564185">CommandNode</span><span class="op" id="4564196">,</span>&nbsp;<span class="ident" id="4564198">cmd</span>&nbsp;<span class="op" id="4564202">*</span><span class="ident" id="4564203">parse</span><span class="op" id="4564208">.</span><span class="ident" id="4564209">CommandNode</span><span class="op" id="4564220">)</span>&nbsp;<span class="op" id="4564222">[</span><span class="op" id="4564223">]</span><span class="op" id="4564224">*</span><span class="ident" id="4564225">parse</span><span class="op" id="4564230">.</span><span class="ident" id="4564231">CommandNode</span>&nbsp;<span class="op" id="4564243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564246">if</span>&nbsp;<span class="ident" id="4564249">n</span>&nbsp;<span class="op" id="4564251">:=</span>&nbsp;<span class="builtinfunc" id="4564254">len</span><span class="op" id="4564257">(</span><span class="ident" id="4564258">cmds</span><span class="op" id="4564262">)</span><span class="op" id="4564263">;</span>&nbsp;<span class="ident" id="4564265">n</span>&nbsp;<span class="op" id="4564267">!=</span>&nbsp;<span class="num" id="4564270">0</span>&nbsp;<span class="op" id="4564272">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564276">last</span><span class="op" id="4564280">,</span>&nbsp;<span class="ident" id="4564282">ok</span>&nbsp;<span class="op" id="4564285">:=</span>&nbsp;<span class="ident" id="4564288">cmds</span><span class="op" id="4564292">[</span><span class="ident" id="4564293">n</span><span class="op" id="4564294">-</span><span class="num" id="4564295">1</span><span class="op" id="4564296">]</span><span class="op" id="4564297">.</span><span class="ident" id="4564298">Args</span><span class="op" id="4564302">[</span><span class="num" id="4564303">0</span><span class="op" id="4564304">]</span><span class="op" id="4564305">.</span><span class="op" id="4564306">(</span><span class="op" id="4564307">*</span><span class="ident" id="4564308">parse</span><span class="op" id="4564313">.</span><span class="ident" id="4564314">IdentifierNode</span><span class="op" id="4564328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564332">next</span><span class="op" id="4564336">,</span>&nbsp;<span class="ident" id="4564338">_</span>&nbsp;<span class="op" id="4564340">:=</span>&nbsp;<span class="ident" id="4564343">cmd</span><span class="op" id="4564346">.</span><span class="ident" id="4564347">Args</span><span class="op" id="4564351">[</span><span class="num" id="4564352">0</span><span class="op" id="4564353">]</span><span class="op" id="4564354">.</span><span class="op" id="4564355">(</span><span class="op" id="4564356">*</span><span class="ident" id="4564357">parse</span><span class="op" id="4564362">.</span><span class="ident" id="4564363">IdentifierNode</span><span class="op" id="4564377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564381">if</span>&nbsp;<span class="ident" id="4564384">ok</span>&nbsp;<span class="op" id="4564387">&amp;&amp;</span>&nbsp;<span class="ident" id="4564390">redundantFuncs</span><span class="op" id="4564404">[</span><span class="ident" id="4564405">last</span><span class="op" id="4564409">.</span><span class="ident" id="4564410">Ident</span><span class="op" id="4564415">]</span><span class="op" id="4564416">[</span><span class="ident" id="4564417">next</span><span class="op" id="4564421">.</span><span class="ident" id="4564422">Ident</span><span class="op" id="4564427">]</span>&nbsp;<span class="op" id="4564429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564434">return</span>&nbsp;<span class="ident" id="4564441">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4564448">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4564451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564454">return</span>&nbsp;<span class="builtinfunc" id="4564461">append</span><span class="op" id="4564467">(</span><span class="ident" id="4564468">cmds</span><span class="op" id="4564472">,</span>&nbsp;<span class="ident" id="4564474">cmd</span><span class="op" id="4564477">)</span><br>
<span class="lineno"></span><span class="op" id="4564479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4564482">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="4564562">func</span>&nbsp;<span class="ident" id="4564567">indexOfStr</span><span class="op" id="4564577">(</span><span class="ident" id="4564578">s</span>&nbsp;<span class="builtintype" id="4564580">string</span><span class="op" id="4564586">,</span>&nbsp;<span class="ident" id="4564588">strs</span>&nbsp;<span class="op" id="4564593">[</span><span class="op" id="4564594">]</span><span class="builtintype" id="4564595">string</span><span class="op" id="4564601">,</span>&nbsp;<span class="ident" id="4564603">eq</span>&nbsp;<span class="keyword" id="4564606">func</span><span class="op" id="4564610">(</span><span class="ident" id="4564611">a</span><span class="op" id="4564612">,</span>&nbsp;<span class="ident" id="4564614">b</span>&nbsp;<span class="builtintype" id="4564616">string</span><span class="op" id="4564622">)</span>&nbsp;<span class="builtintype" id="4564624">bool</span><span class="op" id="4564628">)</span>&nbsp;<span class="builtintype" id="4564630">int</span>&nbsp;<span class="op" id="4564634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564637">for</span>&nbsp;<span class="ident" id="4564641">i</span><span class="op" id="4564642">,</span>&nbsp;<span class="ident" id="4564644">t</span>&nbsp;<span class="op" id="4564646">:=</span>&nbsp;<span class="keyword" id="4564649">range</span>&nbsp;<span class="ident" id="4564655">strs</span>&nbsp;<span class="op" id="4564660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564664">if</span>&nbsp;<span class="ident" id="4564667">eq</span><span class="op" id="4564669">(</span><span class="ident" id="4564670">s</span><span class="op" id="4564671">,</span>&nbsp;<span class="ident" id="4564673">t</span><span class="op" id="4564674">)</span>&nbsp;<span class="op" id="4564676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564681">return</span>&nbsp;<span class="ident" id="4564688">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4564692">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4564695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564698">return</span>&nbsp;<span class="op" id="4564705">-</span><span class="num" id="4564706">1</span><br>
<span class="lineno"></span><span class="op" id="4564708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4564711">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="4564782">func</span>&nbsp;<span class="ident" id="4564787">escFnsEq</span><span class="op" id="4564795">(</span><span class="ident" id="4564796">a</span><span class="op" id="4564797">,</span>&nbsp;<span class="ident" id="4564799">b</span>&nbsp;<span class="builtintype" id="4564801">string</span><span class="op" id="4564807">)</span>&nbsp;<span class="builtintype" id="4564809">bool</span>&nbsp;<span class="op" id="4564814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564817">if</span>&nbsp;<span class="ident" id="4564820">e</span>&nbsp;<span class="op" id="4564822">:=</span>&nbsp;<span class="ident" id="4564825">equivEscapers</span><span class="op" id="4564838">[</span><span class="ident" id="4564839">a</span><span class="op" id="4564840">]</span><span class="op" id="4564841">;</span>&nbsp;<span class="ident" id="4564843">e</span>&nbsp;<span class="op" id="4564845">!=</span>&nbsp;<span class="string" id="4564848">&#34;&#34;</span>&nbsp;<span class="op" id="4564851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564855">a</span>&nbsp;<span class="op" id="4564857">=</span>&nbsp;<span class="ident" id="4564859">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4564862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564865">if</span>&nbsp;<span class="ident" id="4564868">e</span>&nbsp;<span class="op" id="4564870">:=</span>&nbsp;<span class="ident" id="4564873">equivEscapers</span><span class="op" id="4564886">[</span><span class="ident" id="4564887">b</span><span class="op" id="4564888">]</span><span class="op" id="4564889">;</span>&nbsp;<span class="ident" id="4564891">e</span>&nbsp;<span class="op" id="4564893">!=</span>&nbsp;<span class="string" id="4564896">&#34;&#34;</span>&nbsp;<span class="op" id="4564899">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4564903">b</span>&nbsp;<span class="op" id="4564905">=</span>&nbsp;<span class="ident" id="4564907">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4564910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4564913">return</span>&nbsp;<span class="ident" id="4564920">a</span>&nbsp;<span class="op" id="4564922">==</span>&nbsp;<span class="ident" id="4564925">b</span><br>
<span class="lineno"></span><span class="op" id="4564927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="4564930">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4565001">func</span>&nbsp;<span class="ident" id="4565006">newIdentCmd</span><span class="op" id="4565017">(</span><span class="ident" id="4565018">identifier</span>&nbsp;<span class="builtintype" id="4565029">string</span><span class="op" id="4565035">,</span>&nbsp;<span class="ident" id="4565037">pos</span>&nbsp;<span class="ident" id="4565041">parse</span><span class="op" id="4565046">.</span><span class="ident" id="4565047">Pos</span><span class="op" id="4565050">)</span>&nbsp;<span class="op" id="4565052">*</span><span class="ident" id="4565053">parse</span><span class="op" id="4565058">.</span><span class="ident" id="4565059">CommandNode</span>&nbsp;<span class="op" id="4565071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565074">return</span>&nbsp;<span class="op" id="4565081">&amp;</span><span class="ident" id="4565082">parse</span><span class="op" id="4565087">.</span><span class="ident" id="4565088">CommandNode</span><span class="op" id="4565099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565103">NodeType</span><span class="op" id="4565111">:</span>&nbsp;<span class="ident" id="4565113">parse</span><span class="op" id="4565118">.</span><span class="ident" id="4565119">NodeCommand</span><span class="op" id="4565130">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565134">Args</span><span class="op" id="4565138">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4565144">[</span><span class="op" id="4565145">]</span><span class="ident" id="4565146">parse</span><span class="op" id="4565151">.</span><span class="ident" id="4565152">Node</span><span class="op" id="4565156">{</span><span class="ident" id="4565157">parse</span><span class="op" id="4565162">.</span><span class="ident" id="4565163">NewIdentifier</span><span class="op" id="4565176">(</span><span class="ident" id="4565177">identifier</span><span class="op" id="4565187">)</span><span class="op" id="4565188">.</span><span class="ident" id="4565189">SetTree</span><span class="op" id="4565196">(</span><span class="ident" id="4565197">nil</span><span class="op" id="4565200">)</span><span class="op" id="4565201">.</span><span class="ident" id="4565202">SetPos</span><span class="op" id="4565208">(</span><span class="ident" id="4565209">pos</span><span class="op" id="4565212">)</span><span class="op" id="4565213">}</span><span class="op" id="4565214">,</span>&nbsp;<span class="comment" id="4565216">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4565235">}</span><br>
<span class="lineno"></span><span class="op" id="4565237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4565240">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4565315">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="4565354">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="4565379">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="4565397">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="4565476">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="4565495">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="4565554">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="4565617">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="4565695">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="4565727">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="4565793">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="4565858">func</span>&nbsp;<span class="ident" id="4565863">nudge</span><span class="op" id="4565868">(</span><span class="ident" id="4565869">c</span>&nbsp;<span class="ident" id="4565871">context</span><span class="op" id="4565878">)</span>&nbsp;<span class="ident" id="4565880">context</span>&nbsp;<span class="op" id="4565888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565891">switch</span>&nbsp;<span class="ident" id="4565898">c</span><span class="op" id="4565899">.</span><span class="ident" id="4565900">state</span>&nbsp;<span class="op" id="4565906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4565909">case</span>&nbsp;<span class="ident" id="4565914">stateTag</span><span class="op" id="4565922">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4565926">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4565985">c</span><span class="op" id="4565986">.</span><span class="ident" id="4565987">state</span>&nbsp;<span class="op" id="4565993">=</span>&nbsp;<span class="ident" id="4565995">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566010">case</span>&nbsp;<span class="ident" id="4566015">stateBeforeValue</span><span class="op" id="4566031">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4566035">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566097">c</span><span class="op" id="4566098">.</span><span class="ident" id="4566099">state</span><span class="op" id="4566104">,</span>&nbsp;<span class="ident" id="4566106">c</span><span class="op" id="4566107">.</span><span class="ident" id="4566108">delim</span><span class="op" id="4566113">,</span>&nbsp;<span class="ident" id="4566115">c</span><span class="op" id="4566116">.</span><span class="ident" id="4566117">attr</span>&nbsp;<span class="op" id="4566122">=</span>&nbsp;<span class="ident" id="4566124">attrStartStates</span><span class="op" id="4566139">[</span><span class="ident" id="4566140">c</span><span class="op" id="4566141">.</span><span class="ident" id="4566142">attr</span><span class="op" id="4566146">]</span><span class="op" id="4566147">,</span>&nbsp;<span class="ident" id="4566149">delimSpaceOrTagEnd</span><span class="op" id="4566167">,</span>&nbsp;<span class="ident" id="4566169">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566179">case</span>&nbsp;<span class="ident" id="4566184">stateAfterName</span><span class="op" id="4566198">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4566202">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566261">c</span><span class="op" id="4566262">.</span><span class="ident" id="4566263">state</span><span class="op" id="4566268">,</span>&nbsp;<span class="ident" id="4566270">c</span><span class="op" id="4566271">.</span><span class="ident" id="4566272">attr</span>&nbsp;<span class="op" id="4566277">=</span>&nbsp;<span class="ident" id="4566279">stateAttrName</span><span class="op" id="4566292">,</span>&nbsp;<span class="ident" id="4566294">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4566304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566307">return</span>&nbsp;<span class="ident" id="4566314">c</span><br>
<span class="lineno"></span><span class="op" id="4566316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="4566319">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4566394">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4566473">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="4566503">func</span>&nbsp;<span class="ident" id="4566508">join</span><span class="op" id="4566512">(</span><span class="ident" id="4566513">a</span><span class="op" id="4566514">,</span>&nbsp;<span class="ident" id="4566516">b</span>&nbsp;<span class="ident" id="4566518">context</span><span class="op" id="4566525">,</span>&nbsp;<span class="ident" id="4566527">node</span>&nbsp;<span class="ident" id="4566532">parse</span><span class="op" id="4566537">.</span><span class="ident" id="4566538">Node</span><span class="op" id="4566542">,</span>&nbsp;<span class="ident" id="4566544">nodeName</span>&nbsp;<span class="builtintype" id="4566553">string</span><span class="op" id="4566559">)</span>&nbsp;<span class="ident" id="4566561">context</span>&nbsp;<span class="op" id="4566569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566572">if</span>&nbsp;<span class="ident" id="4566575">a</span><span class="op" id="4566576">.</span><span class="ident" id="4566577">state</span>&nbsp;<span class="op" id="4566583">==</span>&nbsp;<span class="ident" id="4566586">stateError</span>&nbsp;<span class="op" id="4566597">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566601">return</span>&nbsp;<span class="ident" id="4566608">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4566611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566614">if</span>&nbsp;<span class="ident" id="4566617">b</span><span class="op" id="4566618">.</span><span class="ident" id="4566619">state</span>&nbsp;<span class="op" id="4566625">==</span>&nbsp;<span class="ident" id="4566628">stateError</span>&nbsp;<span class="op" id="4566639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566643">return</span>&nbsp;<span class="ident" id="4566650">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4566653">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566656">if</span>&nbsp;<span class="ident" id="4566659">a</span><span class="op" id="4566660">.</span><span class="ident" id="4566661">eq</span><span class="op" id="4566663">(</span><span class="ident" id="4566664">b</span><span class="op" id="4566665">)</span>&nbsp;<span class="op" id="4566667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566671">return</span>&nbsp;<span class="ident" id="4566678">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4566681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566685">c</span>&nbsp;<span class="op" id="4566687">:=</span>&nbsp;<span class="ident" id="4566690">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566693">c</span><span class="op" id="4566694">.</span><span class="ident" id="4566695">urlPart</span>&nbsp;<span class="op" id="4566703">=</span>&nbsp;<span class="ident" id="4566705">b</span><span class="op" id="4566706">.</span><span class="ident" id="4566707">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566716">if</span>&nbsp;<span class="ident" id="4566719">c</span><span class="op" id="4566720">.</span><span class="ident" id="4566721">eq</span><span class="op" id="4566723">(</span><span class="ident" id="4566724">b</span><span class="op" id="4566725">)</span>&nbsp;<span class="op" id="4566727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4566731">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566773">c</span><span class="op" id="4566774">.</span><span class="ident" id="4566775">urlPart</span>&nbsp;<span class="op" id="4566783">=</span>&nbsp;<span class="ident" id="4566785">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566802">return</span>&nbsp;<span class="ident" id="4566809">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4566812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566816">c</span>&nbsp;<span class="op" id="4566818">=</span>&nbsp;<span class="ident" id="4566820">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566823">c</span><span class="op" id="4566824">.</span><span class="ident" id="4566825">jsCtx</span>&nbsp;<span class="op" id="4566831">=</span>&nbsp;<span class="ident" id="4566833">b</span><span class="op" id="4566834">.</span><span class="ident" id="4566835">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566842">if</span>&nbsp;<span class="ident" id="4566845">c</span><span class="op" id="4566846">.</span><span class="ident" id="4566847">eq</span><span class="op" id="4566849">(</span><span class="ident" id="4566850">b</span><span class="op" id="4566851">)</span>&nbsp;<span class="op" id="4566853">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4566857">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4566897">c</span><span class="op" id="4566898">.</span><span class="ident" id="4566899">jsCtx</span>&nbsp;<span class="op" id="4566905">=</span>&nbsp;<span class="ident" id="4566907">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4566922">return</span>&nbsp;<span class="ident" id="4566929">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4566932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4566936">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4566993">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4567013">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4567050">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4567114">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4567144">if</span>&nbsp;<span class="ident" id="4567147">c</span><span class="op" id="4567148">,</span>&nbsp;<span class="ident" id="4567150">d</span>&nbsp;<span class="op" id="4567152">:=</span>&nbsp;<span class="ident" id="4567155">nudge</span><span class="op" id="4567160">(</span><span class="ident" id="4567161">a</span><span class="op" id="4567162">)</span><span class="op" id="4567163">,</span>&nbsp;<span class="ident" id="4567165">nudge</span><span class="op" id="4567170">(</span><span class="ident" id="4567171">b</span><span class="op" id="4567172">)</span><span class="op" id="4567173">;</span>&nbsp;<span class="op" id="4567175">!</span><span class="op" id="4567176">(</span><span class="ident" id="4567177">c</span><span class="op" id="4567178">.</span><span class="ident" id="4567179">eq</span><span class="op" id="4567181">(</span><span class="ident" id="4567182">a</span><span class="op" id="4567183">)</span>&nbsp;<span class="op" id="4567185">&amp;&amp;</span>&nbsp;<span class="ident" id="4567188">d</span><span class="op" id="4567189">.</span><span class="ident" id="4567190">eq</span><span class="op" id="4567192">(</span><span class="ident" id="4567193">b</span><span class="op" id="4567194">)</span><span class="op" id="4567195">)</span>&nbsp;<span class="op" id="4567197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4567201">if</span>&nbsp;<span class="ident" id="4567204">e</span>&nbsp;<span class="op" id="4567206">:=</span>&nbsp;<span class="ident" id="4567209">join</span><span class="op" id="4567213">(</span><span class="ident" id="4567214">c</span><span class="op" id="4567215">,</span>&nbsp;<span class="ident" id="4567217">d</span><span class="op" id="4567218">,</span>&nbsp;<span class="ident" id="4567220">node</span><span class="op" id="4567224">,</span>&nbsp;<span class="ident" id="4567226">nodeName</span><span class="op" id="4567234">)</span><span class="op" id="4567235">;</span>&nbsp;<span class="ident" id="4567237">e</span><span class="op" id="4567238">.</span><span class="ident" id="4567239">state</span>&nbsp;<span class="op" id="4567245">!=</span>&nbsp;<span class="ident" id="4567248">stateError</span>&nbsp;<span class="op" id="4567259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4567264">return</span>&nbsp;<span class="ident" id="4567271">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4567275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4567278">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4567282">return</span>&nbsp;<span class="ident" id="4567289">context</span><span class="op" id="4567296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4567300">state</span><span class="op" id="4567305">:</span>&nbsp;<span class="ident" id="4567307">stateError</span><span class="op" id="4567317">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4567321">err</span><span class="op" id="4567324">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4567328">errorf</span><span class="op" id="4567334">(</span><span class="ident" id="4567335">ErrBranchEnd</span><span class="op" id="4567347">,</span>&nbsp;<span class="ident" id="4567349">node</span><span class="op" id="4567353">,</span>&nbsp;<span class="num" id="4567355">0</span><span class="op" id="4567356">,</span>&nbsp;<span class="string" id="4567358">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="4567409">,</span>&nbsp;<span class="ident" id="4567411">nodeName</span><span class="op" id="4567419">,</span>&nbsp;<span class="ident" id="4567421">a</span><span class="op" id="4567422">,</span>&nbsp;<span class="ident" id="4567424">b</span><span class="op" id="4567425">)</span><span class="op" id="4567426">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4567429">}</span><br>
<span class="lineno">410</span><span class="op" id="4567431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4567434">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4567508">func</span>&nbsp;<span class="op" id="4567513">(</span><span class="ident" id="4567514">e</span>&nbsp;<span class="op" id="4567516">*</span><span class="ident" id="4567517">escaper</span><span class="op" id="4567524">)</span>&nbsp;<span class="ident" id="4567526">escapeBranch</span><span class="op" id="4567538">(</span><span class="ident" id="4567539">c</span>&nbsp;<span class="ident" id="4567541">context</span><span class="op" id="4567548">,</span>&nbsp;<span class="ident" id="4567550">n</span>&nbsp;<span class="op" id="4567552">*</span><span class="ident" id="4567553">parse</span><span class="op" id="4567558">.</span><span class="ident" id="4567559">BranchNode</span><span class="op" id="4567569">,</span>&nbsp;<span class="ident" id="4567571">nodeName</span>&nbsp;<span class="builtintype" id="4567580">string</span><span class="op" id="4567586">)</span>&nbsp;<span class="ident" id="4567588">context</span>&nbsp;<span class="op" id="4567596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4567599">c0</span>&nbsp;<span class="op" id="4567602">:=</span>&nbsp;<span class="ident" id="4567605">e</span><span class="op" id="4567606">.</span><span class="ident" id="4567607">escapeList</span><span class="op" id="4567617">(</span><span class="ident" id="4567618">c</span><span class="op" id="4567619">,</span>&nbsp;<span class="ident" id="4567621">n</span><span class="op" id="4567622">.</span><span class="ident" id="4567623">List</span><span class="op" id="4567627">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4567630">if</span>&nbsp;<span class="ident" id="4567633">nodeName</span>&nbsp;<span class="op" id="4567642">==</span>&nbsp;<span class="string" id="4567645">&#34;range&#34;</span>&nbsp;<span class="op" id="4567653">&amp;&amp;</span>&nbsp;<span class="ident" id="4567656">c0</span><span class="op" id="4567658">.</span><span class="ident" id="4567659">state</span>&nbsp;<span class="op" id="4567665">!=</span>&nbsp;<span class="ident" id="4567668">stateError</span>&nbsp;<span class="op" id="4567679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4567683">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4567752">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4567821">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4567853">c1</span><span class="op" id="4567855">,</span>&nbsp;<span class="ident" id="4567857">_</span>&nbsp;<span class="op" id="4567859">:=</span>&nbsp;<span class="ident" id="4567862">e</span><span class="op" id="4567863">.</span><span class="ident" id="4567864">escapeListConditionally</span><span class="op" id="4567887">(</span><span class="ident" id="4567888">c0</span><span class="op" id="4567890">,</span>&nbsp;<span class="ident" id="4567892">n</span><span class="op" id="4567893">.</span><span class="ident" id="4567894">List</span><span class="op" id="4567898">,</span>&nbsp;<span class="ident" id="4567900">nil</span><span class="op" id="4567903">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4567907">c0</span>&nbsp;<span class="op" id="4567910">=</span>&nbsp;<span class="ident" id="4567912">join</span><span class="op" id="4567916">(</span><span class="ident" id="4567917">c0</span><span class="op" id="4567919">,</span>&nbsp;<span class="ident" id="4567921">c1</span><span class="op" id="4567923">,</span>&nbsp;<span class="ident" id="4567925">n</span><span class="op" id="4567926">,</span>&nbsp;<span class="ident" id="4567928">nodeName</span><span class="op" id="4567936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4567940">if</span>&nbsp;<span class="ident" id="4567943">c0</span><span class="op" id="4567945">.</span><span class="ident" id="4567946">state</span>&nbsp;<span class="op" id="4567952">==</span>&nbsp;<span class="ident" id="4567955">stateError</span>&nbsp;<span class="op" id="4567966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4567971">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4568028">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4568085">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4568112">c0</span><span class="op" id="4568114">.</span><span class="ident" id="4568115">err</span><span class="op" id="4568118">.</span><span class="ident" id="4568119">Line</span>&nbsp;<span class="op" id="4568124">=</span>&nbsp;<span class="ident" id="4568126">n</span><span class="op" id="4568127">.</span><span class="ident" id="4568128">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4568136">c0</span><span class="op" id="4568138">.</span><span class="ident" id="4568139">err</span><span class="op" id="4568142">.</span><span class="ident" id="4568143">Description</span>&nbsp;<span class="op" id="4568155">=</span>&nbsp;<span class="string" id="4568157">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="4568184">+</span>&nbsp;<span class="ident" id="4568186">c0</span><span class="op" id="4568188">.</span><span class="ident" id="4568189">err</span><span class="op" id="4568192">.</span><span class="ident" id="4568193">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4568208">return</span>&nbsp;<span class="ident" id="4568215">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4568220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4568223">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4568226">c1</span>&nbsp;<span class="op" id="4568229">:=</span>&nbsp;<span class="ident" id="4568232">e</span><span class="op" id="4568233">.</span><span class="ident" id="4568234">escapeList</span><span class="op" id="4568244">(</span><span class="ident" id="4568245">c</span><span class="op" id="4568246">,</span>&nbsp;<span class="ident" id="4568248">n</span><span class="op" id="4568249">.</span><span class="ident" id="4568250">ElseList</span><span class="op" id="4568258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4568261">return</span>&nbsp;<span class="ident" id="4568268">join</span><span class="op" id="4568272">(</span><span class="ident" id="4568273">c0</span><span class="op" id="4568275">,</span>&nbsp;<span class="ident" id="4568277">c1</span><span class="op" id="4568279">,</span>&nbsp;<span class="ident" id="4568281">n</span><span class="op" id="4568282">,</span>&nbsp;<span class="ident" id="4568284">nodeName</span><span class="op" id="4568292">)</span><br>
<span class="lineno"></span><span class="op" id="4568294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4568297">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="4568341">func</span>&nbsp;<span class="op" id="4568346">(</span><span class="ident" id="4568347">e</span>&nbsp;<span class="op" id="4568349">*</span><span class="ident" id="4568350">escaper</span><span class="op" id="4568357">)</span>&nbsp;<span class="ident" id="4568359">escapeList</span><span class="op" id="4568369">(</span><span class="ident" id="4568370">c</span>&nbsp;<span class="ident" id="4568372">context</span><span class="op" id="4568379">,</span>&nbsp;<span class="ident" id="4568381">n</span>&nbsp;<span class="op" id="4568383">*</span><span class="ident" id="4568384">parse</span><span class="op" id="4568389">.</span><span class="ident" id="4568390">ListNode</span><span class="op" id="4568398">)</span>&nbsp;<span class="ident" id="4568400">context</span>&nbsp;<span class="op" id="4568408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4568411">if</span>&nbsp;<span class="ident" id="4568414">n</span>&nbsp;<span class="op" id="4568416">==</span>&nbsp;<span class="ident" id="4568419">nil</span>&nbsp;<span class="op" id="4568423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4568427">return</span>&nbsp;<span class="ident" id="4568434">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4568437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4568440">for</span>&nbsp;<span class="ident" id="4568444">_</span><span class="op" id="4568445">,</span>&nbsp;<span class="ident" id="4568447">m</span>&nbsp;<span class="op" id="4568449">:=</span>&nbsp;<span class="keyword" id="4568452">range</span>&nbsp;<span class="ident" id="4568458">n</span><span class="op" id="4568459">.</span><span class="ident" id="4568460">Nodes</span>&nbsp;<span class="op" id="4568466">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4568470">c</span>&nbsp;<span class="op" id="4568472">=</span>&nbsp;<span class="ident" id="4568474">e</span><span class="op" id="4568475">.</span><span class="ident" id="4568476">escape</span><span class="op" id="4568482">(</span><span class="ident" id="4568483">c</span><span class="op" id="4568484">,</span>&nbsp;<span class="ident" id="4568486">m</span><span class="op" id="4568487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4568490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4568493">return</span>&nbsp;<span class="ident" id="4568500">c</span><br>
<span class="lineno"></span><span class="op" id="4568502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="4568505">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4568581">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="4568653">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="4568733">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="4568780">func</span>&nbsp;<span class="op" id="4568785">(</span><span class="ident" id="4568786">e</span>&nbsp;<span class="op" id="4568788">*</span><span class="ident" id="4568789">escaper</span><span class="op" id="4568796">)</span>&nbsp;<span class="ident" id="4568798">escapeListConditionally</span><span class="op" id="4568821">(</span><span class="ident" id="4568822">c</span>&nbsp;<span class="ident" id="4568824">context</span><span class="op" id="4568831">,</span>&nbsp;<span class="ident" id="4568833">n</span>&nbsp;<span class="op" id="4568835">*</span><span class="ident" id="4568836">parse</span><span class="op" id="4568841">.</span><span class="ident" id="4568842">ListNode</span><span class="op" id="4568850">,</span>&nbsp;<span class="ident" id="4568852">filter</span>&nbsp;<span class="keyword" id="4568859">func</span><span class="op" id="4568863">(</span><span class="op" id="4568864">*</span><span class="ident" id="4568865">escaper</span><span class="op" id="4568872">,</span>&nbsp;<span class="ident" id="4568874">context</span><span class="op" id="4568881">)</span>&nbsp;<span class="builtintype" id="4568883">bool</span><span class="op" id="4568887">)</span>&nbsp;<span class="op" id="4568889">(</span><span class="ident" id="4568890">context</span><span class="op" id="4568897">,</span>&nbsp;<span class="builtintype" id="4568899">bool</span><span class="op" id="4568903">)</span>&nbsp;<span class="op" id="4568905">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4568908">e1</span>&nbsp;<span class="op" id="4568911">:=</span>&nbsp;<span class="ident" id="4568914">newEscaper</span><span class="op" id="4568924">(</span><span class="ident" id="4568925">e</span><span class="op" id="4568926">.</span><span class="ident" id="4568927">tmpl</span><span class="op" id="4568931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4568934">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4568975">for</span>&nbsp;<span class="ident" id="4568979">k</span><span class="op" id="4568980">,</span>&nbsp;<span class="ident" id="4568982">v</span>&nbsp;<span class="op" id="4568984">:=</span>&nbsp;<span class="keyword" id="4568987">range</span>&nbsp;<span class="ident" id="4568993">e</span><span class="op" id="4568994">.</span><span class="ident" id="4568995">output</span>&nbsp;<span class="op" id="4569002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4569006">e1</span><span class="op" id="4569008">.</span><span class="ident" id="4569009">output</span><span class="op" id="4569015">[</span><span class="ident" id="4569016">k</span><span class="op" id="4569017">]</span>&nbsp;<span class="op" id="4569019">=</span>&nbsp;<span class="ident" id="4569021">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4569024">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4569027">c</span>&nbsp;<span class="op" id="4569029">=</span>&nbsp;<span class="ident" id="4569031">e1</span><span class="op" id="4569033">.</span><span class="ident" id="4569034">escapeList</span><span class="op" id="4569044">(</span><span class="ident" id="4569045">c</span><span class="op" id="4569046">,</span>&nbsp;<span class="ident" id="4569048">n</span><span class="op" id="4569049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4569052">ok</span>&nbsp;<span class="op" id="4569055">:=</span>&nbsp;<span class="ident" id="4569058">filter</span>&nbsp;<span class="op" id="4569065">!=</span>&nbsp;<span class="ident" id="4569068">nil</span>&nbsp;<span class="op" id="4569072">&amp;&amp;</span>&nbsp;<span class="ident" id="4569075">filter</span><span class="op" id="4569081">(</span><span class="ident" id="4569082">e1</span><span class="op" id="4569084">,</span>&nbsp;<span class="ident" id="4569086">c</span><span class="op" id="4569087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4569090">if</span>&nbsp;<span class="ident" id="4569093">ok</span>&nbsp;<span class="op" id="4569096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4569100">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4569152">for</span>&nbsp;<span class="ident" id="4569156">k</span><span class="op" id="4569157">,</span>&nbsp;<span class="ident" id="4569159">v</span>&nbsp;<span class="op" id="4569161">:=</span>&nbsp;<span class="keyword" id="4569164">range</span>&nbsp;<span class="ident" id="4569170">e1</span><span class="op" id="4569172">.</span><span class="ident" id="4569173">output</span>&nbsp;<span class="op" id="4569180">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4569185">e</span><span class="op" id="4569186">.</span><span class="ident" id="4569187">output</span><span class="op" id="4569193">[</span><span class="ident" id="4569194">k</span><span class="op" id="4569195">]</span>&nbsp;<span class="op" id="4569197">=</span>&nbsp;<span class="ident" id="4569199">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4569203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4569207">for</span>&nbsp;<span class="ident" id="4569211">k</span><span class="op" id="4569212">,</span>&nbsp;<span class="ident" id="4569214">v</span>&nbsp;<span class="op" id="4569216">:=</span>&nbsp;<span class="keyword" id="4569219">range</span>&nbsp;<span class="ident" id="4569225">e1</span><span class="op" id="4569227">.</span><span class="ident" id="4569228">derived</span>&nbsp;<span class="op" id="4569236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4569241">e</span><span class="op" id="4569242">.</span><span class="ident" id="4569243">derived</span><span class="op" id="4569250">[</span><span class="ident" id="4569251">k</span><span class="op" id="4569252">]</span>&nbsp;<span class="op" id="4569254">=</span>&nbsp;<span class="ident" id="4569256">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4569260">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4569264">for</span>&nbsp;<span class="ident" id="4569268">k</span><span class="op" id="4569269">,</span>&nbsp;<span class="ident" id="4569271">v</span>&nbsp;<span class="op" id="4569273">:=</span>&nbsp;<span class="keyword" id="4569276">range</span>&nbsp;<span class="ident" id="4569282">e1</span><span class="op" id="4569284">.</span><span class="ident" id="4569285">called</span>&nbsp;<span class="op" id="4569292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4569297">e</span><span class="op" id="4569298">.</span><span class="ident" id="4569299">called</span><span class="op" id="4569305">[</span><span class="ident" id="4569306">k</span><span class="op" id="4569307">]</span>&nbsp;<span class="op" id="4569309">=</span>&nbsp;<span class="ident" id="4569311">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4569315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4569319">for</span>&nbsp;<span class="ident" id="4569323">k</span><span class="op" id="4569324">,</span>&nbsp;<span class="ident" id="4569326">v</span>&nbsp;<span class="op" id="4569328">:=</span>&nbsp;<span class="keyword" id="4569331">range</span>&nbsp;<span class="ident" id="4569337">e1</span><span class="op" id="4569339">.</span><span class="ident" id="4569340">actionNodeEdits</span>&nbsp;<span class="op" id="4569356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4569361">e</span><span class="op" id="4569362">.</span><span class="ident" id="4569363">editActionNode</span><span class="op" id="4569377">(</span><span class="ident" id="4569378">k</span><span class="op" id="4569379">,</span>&nbsp;<span class="ident" id="4569381">v</span><span class="op" id="4569382">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4569386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4569390">for</span>&nbsp;<span class="ident" id="4569394">k</span><span class="op" id="4569395">,</span>&nbsp;<span class="ident" id="4569397">v</span>&nbsp;<span class="op" id="4569399">:=</span>&nbsp;<span class="keyword" id="4569402">range</span>&nbsp;<span class="ident" id="4569408">e1</span><span class="op" id="4569410">.</span><span class="ident" id="4569411">templateNodeEdits</span>&nbsp;<span class="op" id="4569429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4569434">e</span><span class="op" id="4569435">.</span><span class="ident" id="4569436">editTemplateNode</span><span class="op" id="4569452">(</span><span class="ident" id="4569453">k</span><span class="op" id="4569454">,</span>&nbsp;<span class="ident" id="4569456">v</span><span class="op" id="4569457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4569461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4569465">for</span>&nbsp;<span class="ident" id="4569469">k</span><span class="op" id="4569470">,</span>&nbsp;<span class="ident" id="4569472">v</span>&nbsp;<span class="op" id="4569474">:=</span>&nbsp;<span class="keyword" id="4569477">range</span>&nbsp;<span class="ident" id="4569483">e1</span><span class="op" id="4569485">.</span><span class="ident" id="4569486">textNodeEdits</span>&nbsp;<span class="op" id="4569500">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4569505">e</span><span class="op" id="4569506">.</span><span class="ident" id="4569507">editTextNode</span><span class="op" id="4569519">(</span><span class="ident" id="4569520">k</span><span class="op" id="4569521">,</span>&nbsp;<span class="ident" id="4569523">v</span><span class="op" id="4569524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4569528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4569531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4569534">return</span>&nbsp;<span class="ident" id="4569541">c</span><span class="op" id="4569542">,</span>&nbsp;<span class="ident" id="4569544">ok</span><br>
<span class="lineno"></span><span class="op" id="4569547">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="4569550">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4569602">func</span>&nbsp;<span class="op" id="4569607">(</span><span class="ident" id="4569608">e</span>&nbsp;<span class="op" id="4569610">*</span><span class="ident" id="4569611">escaper</span><span class="op" id="4569618">)</span>&nbsp;<span class="ident" id="4569620">escapeTemplate</span><span class="op" id="4569634">(</span><span class="ident" id="4569635">c</span>&nbsp;<span class="ident" id="4569637">context</span><span class="op" id="4569644">,</span>&nbsp;<span class="ident" id="4569646">n</span>&nbsp;<span class="op" id="4569648">*</span><span class="ident" id="4569649">parse</span><span class="op" id="4569654">.</span><span class="ident" id="4569655">TemplateNode</span><span class="op" id="4569667">)</span>&nbsp;<span class="ident" id="4569669">context</span>&nbsp;<span class="op" id="4569677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4569680">c</span><span class="op" id="4569681">,</span>&nbsp;<span class="ident" id="4569683">name</span>&nbsp;<span class="op" id="4569688">:=</span>&nbsp;<span class="ident" id="4569691">e</span><span class="op" id="4569692">.</span><span class="ident" id="4569693">escapeTree</span><span class="op" id="4569703">(</span><span class="ident" id="4569704">c</span><span class="op" id="4569705">,</span>&nbsp;<span class="ident" id="4569707">n</span><span class="op" id="4569708">,</span>&nbsp;<span class="ident" id="4569710">n</span><span class="op" id="4569711">.</span><span class="ident" id="4569712">Name</span><span class="op" id="4569716">,</span>&nbsp;<span class="ident" id="4569718">n</span><span class="op" id="4569719">.</span><span class="ident" id="4569720">Line</span><span class="op" id="4569724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4569727">if</span>&nbsp;<span class="ident" id="4569730">name</span>&nbsp;<span class="op" id="4569735">!=</span>&nbsp;<span class="ident" id="4569738">n</span><span class="op" id="4569739">.</span><span class="ident" id="4569740">Name</span>&nbsp;<span class="op" id="4569745">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4569749">e</span><span class="op" id="4569750">.</span><span class="ident" id="4569751">editTemplateNode</span><span class="op" id="4569767">(</span><span class="ident" id="4569768">n</span><span class="op" id="4569769">,</span>&nbsp;<span class="ident" id="4569771">name</span><span class="op" id="4569775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4569778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4569781">return</span>&nbsp;<span class="ident" id="4569788">c</span><br>
<span class="lineno"></span><span class="op" id="4569790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="4569793">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="4569867">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="4569912">func</span>&nbsp;<span class="op" id="4569917">(</span><span class="ident" id="4569918">e</span>&nbsp;<span class="op" id="4569920">*</span><span class="ident" id="4569921">escaper</span><span class="op" id="4569928">)</span>&nbsp;<span class="ident" id="4569930">escapeTree</span><span class="op" id="4569940">(</span><span class="ident" id="4569941">c</span>&nbsp;<span class="ident" id="4569943">context</span><span class="op" id="4569950">,</span>&nbsp;<span class="ident" id="4569952">node</span>&nbsp;<span class="ident" id="4569957">parse</span><span class="op" id="4569962">.</span><span class="ident" id="4569963">Node</span><span class="op" id="4569967">,</span>&nbsp;<span class="ident" id="4569969">name</span>&nbsp;<span class="builtintype" id="4569974">string</span><span class="op" id="4569980">,</span>&nbsp;<span class="ident" id="4569982">line</span>&nbsp;<span class="builtintype" id="4569987">int</span><span class="op" id="4569990">)</span>&nbsp;<span class="op" id="4569992">(</span><span class="ident" id="4569993">context</span><span class="op" id="4570000">,</span>&nbsp;<span class="builtintype" id="4570002">string</span><span class="op" id="4570008">)</span>&nbsp;<span class="op" id="4570010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4570013">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4570087">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4570103">dname</span>&nbsp;<span class="op" id="4570109">:=</span>&nbsp;<span class="ident" id="4570112">c</span><span class="op" id="4570113">.</span><span class="ident" id="4570114">mangle</span><span class="op" id="4570120">(</span><span class="ident" id="4570121">name</span><span class="op" id="4570125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4570128">e</span><span class="op" id="4570129">.</span><span class="ident" id="4570130">called</span><span class="op" id="4570136">[</span><span class="ident" id="4570137">dname</span><span class="op" id="4570142">]</span>&nbsp;<span class="op" id="4570144">=</span>&nbsp;<span class="builtintype" id="4570146">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4570152">if</span>&nbsp;<span class="ident" id="4570155">out</span><span class="op" id="4570158">,</span>&nbsp;<span class="ident" id="4570160">ok</span>&nbsp;<span class="op" id="4570163">:=</span>&nbsp;<span class="ident" id="4570166">e</span><span class="op" id="4570167">.</span><span class="ident" id="4570168">output</span><span class="op" id="4570174">[</span><span class="ident" id="4570175">dname</span><span class="op" id="4570180">]</span><span class="op" id="4570181">;</span>&nbsp;<span class="ident" id="4570183">ok</span>&nbsp;<span class="op" id="4570186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4570190">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4570212">return</span>&nbsp;<span class="ident" id="4570219">out</span><span class="op" id="4570222">,</span>&nbsp;<span class="ident" id="4570224">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4570231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4570234">t</span>&nbsp;<span class="op" id="4570236">:=</span>&nbsp;<span class="ident" id="4570239">e</span><span class="op" id="4570240">.</span><span class="ident" id="4570241">template</span><span class="op" id="4570249">(</span><span class="ident" id="4570250">name</span><span class="op" id="4570254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4570257">if</span>&nbsp;<span class="ident" id="4570260">t</span>&nbsp;<span class="op" id="4570262">==</span>&nbsp;<span class="ident" id="4570265">nil</span>&nbsp;<span class="op" id="4570269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4570273">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4570354">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4570409">if</span>&nbsp;<span class="ident" id="4570412">e</span><span class="op" id="4570413">.</span><span class="ident" id="4570414">tmpl</span><span class="op" id="4570418">.</span><span class="ident" id="4570419">set</span><span class="op" id="4570422">[</span><span class="ident" id="4570423">name</span><span class="op" id="4570427">]</span>&nbsp;<span class="op" id="4570429">!=</span>&nbsp;<span class="ident" id="4570432">nil</span>&nbsp;<span class="op" id="4570436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4570441">return</span>&nbsp;<span class="ident" id="4570448">context</span><span class="op" id="4570455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4570461">state</span><span class="op" id="4570466">:</span>&nbsp;<span class="ident" id="4570468">stateError</span><span class="op" id="4570478">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4570484">err</span><span class="op" id="4570487">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4570491">errorf</span><span class="op" id="4570497">(</span><span class="ident" id="4570498">ErrNoSuchTemplate</span><span class="op" id="4570515">,</span>&nbsp;<span class="ident" id="4570517">node</span><span class="op" id="4570521">,</span>&nbsp;<span class="ident" id="4570523">line</span><span class="op" id="4570527">,</span>&nbsp;<span class="string" id="4570529">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="4570568">,</span>&nbsp;<span class="ident" id="4570570">name</span><span class="op" id="4570574">)</span><span class="op" id="4570575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4570580">}</span><span class="op" id="4570581">,</span>&nbsp;<span class="ident" id="4570583">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4570591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4570595">return</span>&nbsp;<span class="ident" id="4570602">context</span><span class="op" id="4570609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4570614">state</span><span class="op" id="4570619">:</span>&nbsp;<span class="ident" id="4570621">stateError</span><span class="op" id="4570631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4570636">err</span><span class="op" id="4570639">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4570643">errorf</span><span class="op" id="4570649">(</span><span class="ident" id="4570650">ErrNoSuchTemplate</span><span class="op" id="4570667">,</span>&nbsp;<span class="ident" id="4570669">node</span><span class="op" id="4570673">,</span>&nbsp;<span class="ident" id="4570675">line</span><span class="op" id="4570679">,</span>&nbsp;<span class="string" id="4570681">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="4570702">,</span>&nbsp;<span class="ident" id="4570704">name</span><span class="op" id="4570708">)</span><span class="op" id="4570709">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4570713">}</span><span class="op" id="4570714">,</span>&nbsp;<span class="ident" id="4570716">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4570723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4570726">if</span>&nbsp;<span class="ident" id="4570729">dname</span>&nbsp;<span class="op" id="4570735">!=</span>&nbsp;<span class="ident" id="4570738">name</span>&nbsp;<span class="op" id="4570743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4570747">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4570818">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4570882">dt</span>&nbsp;<span class="op" id="4570885">:=</span>&nbsp;<span class="ident" id="4570888">e</span><span class="op" id="4570889">.</span><span class="ident" id="4570890">template</span><span class="op" id="4570898">(</span><span class="ident" id="4570899">dname</span><span class="op" id="4570904">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4570908">if</span>&nbsp;<span class="ident" id="4570911">dt</span>&nbsp;<span class="op" id="4570914">==</span>&nbsp;<span class="ident" id="4570917">nil</span>&nbsp;<span class="op" id="4570921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4570926">dt</span>&nbsp;<span class="op" id="4570929">=</span>&nbsp;<span class="ident" id="4570931">template</span><span class="op" id="4570939">.</span><span class="ident" id="4570940">New</span><span class="op" id="4570943">(</span><span class="ident" id="4570944">dname</span><span class="op" id="4570949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4570954">dt</span><span class="op" id="4570956">.</span><span class="ident" id="4570957">Tree</span>&nbsp;<span class="op" id="4570962">=</span>&nbsp;<span class="op" id="4570964">&amp;</span><span class="ident" id="4570965">parse</span><span class="op" id="4570970">.</span><span class="ident" id="4570971">Tree</span><span class="op" id="4570975">{</span><span class="ident" id="4570976">Name</span><span class="op" id="4570980">:</span>&nbsp;<span class="ident" id="4570982">dname</span><span class="op" id="4570987">,</span>&nbsp;<span class="ident" id="4570989">Root</span><span class="op" id="4570993">:</span>&nbsp;<span class="ident" id="4570995">t</span><span class="op" id="4570996">.</span><span class="ident" id="4570997">Root</span><span class="op" id="4571001">.</span><span class="ident" id="4571002">CopyList</span><span class="op" id="4571010">(</span><span class="op" id="4571011">)</span><span class="op" id="4571012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4571017">e</span><span class="op" id="4571018">.</span><span class="ident" id="4571019">derived</span><span class="op" id="4571026">[</span><span class="ident" id="4571027">dname</span><span class="op" id="4571032">]</span>&nbsp;<span class="op" id="4571034">=</span>&nbsp;<span class="ident" id="4571036">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4571041">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4571045">t</span>&nbsp;<span class="op" id="4571047">=</span>&nbsp;<span class="ident" id="4571049">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4571053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4571056">return</span>&nbsp;<span class="ident" id="4571063">e</span><span class="op" id="4571064">.</span><span class="ident" id="4571065">computeOutCtx</span><span class="op" id="4571078">(</span><span class="ident" id="4571079">c</span><span class="op" id="4571080">,</span>&nbsp;<span class="ident" id="4571082">t</span><span class="op" id="4571083">)</span><span class="op" id="4571084">,</span>&nbsp;<span class="ident" id="4571086">dname</span><br>
<span class="lineno"></span><span class="op" id="4571092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="4571095">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="4571175">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="4571221">func</span>&nbsp;<span class="op" id="4571226">(</span><span class="ident" id="4571227">e</span>&nbsp;<span class="op" id="4571229">*</span><span class="ident" id="4571230">escaper</span><span class="op" id="4571237">)</span>&nbsp;<span class="ident" id="4571239">computeOutCtx</span><span class="op" id="4571252">(</span><span class="ident" id="4571253">c</span>&nbsp;<span class="ident" id="4571255">context</span><span class="op" id="4571262">,</span>&nbsp;<span class="ident" id="4571264">t</span>&nbsp;<span class="op" id="4571266">*</span><span class="ident" id="4571267">template</span><span class="op" id="4571275">.</span><span class="ident" id="4571276">Template</span><span class="op" id="4571284">)</span>&nbsp;<span class="ident" id="4571286">context</span>&nbsp;<span class="op" id="4571294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4571297">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4571334">c1</span><span class="op" id="4571336">,</span>&nbsp;<span class="ident" id="4571338">ok</span>&nbsp;<span class="op" id="4571341">:=</span>&nbsp;<span class="ident" id="4571344">e</span><span class="op" id="4571345">.</span><span class="ident" id="4571346">escapeTemplateBody</span><span class="op" id="4571364">(</span><span class="ident" id="4571365">c</span><span class="op" id="4571366">,</span>&nbsp;<span class="ident" id="4571368">t</span><span class="op" id="4571369">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4571372">if</span>&nbsp;<span class="op" id="4571375">!</span><span class="ident" id="4571376">ok</span>&nbsp;<span class="op" id="4571379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4571383">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4571449">if</span>&nbsp;<span class="ident" id="4571452">c2</span><span class="op" id="4571454">,</span>&nbsp;<span class="ident" id="4571456">ok2</span>&nbsp;<span class="op" id="4571460">:=</span>&nbsp;<span class="ident" id="4571463">e</span><span class="op" id="4571464">.</span><span class="ident" id="4571465">escapeTemplateBody</span><span class="op" id="4571483">(</span><span class="ident" id="4571484">c1</span><span class="op" id="4571486">,</span>&nbsp;<span class="ident" id="4571488">t</span><span class="op" id="4571489">)</span><span class="op" id="4571490">;</span>&nbsp;<span class="ident" id="4571492">ok2</span>&nbsp;<span class="op" id="4571496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4571501">c1</span><span class="op" id="4571503">,</span>&nbsp;<span class="ident" id="4571505">ok</span>&nbsp;<span class="op" id="4571508">=</span>&nbsp;<span class="ident" id="4571510">c2</span><span class="op" id="4571512">,</span>&nbsp;<span class="builtintype" id="4571514">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4571521">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4571525">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4571587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4571590">if</span>&nbsp;<span class="op" id="4571593">!</span><span class="ident" id="4571594">ok</span>&nbsp;<span class="op" id="4571597">&amp;&amp;</span>&nbsp;<span class="ident" id="4571600">c1</span><span class="op" id="4571602">.</span><span class="ident" id="4571603">state</span>&nbsp;<span class="op" id="4571609">!=</span>&nbsp;<span class="ident" id="4571612">stateError</span>&nbsp;<span class="op" id="4571623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4571627">return</span>&nbsp;<span class="ident" id="4571634">context</span><span class="op" id="4571641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4571646">state</span><span class="op" id="4571651">:</span>&nbsp;<span class="ident" id="4571653">stateError</span><span class="op" id="4571663">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4571668">err</span><span class="op" id="4571671">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4571675">errorf</span><span class="op" id="4571681">(</span><span class="ident" id="4571682">ErrOutputContext</span><span class="op" id="4571698">,</span>&nbsp;<span class="ident" id="4571700">t</span><span class="op" id="4571701">.</span><span class="ident" id="4571702">Tree</span><span class="op" id="4571706">.</span><span class="ident" id="4571707">Root</span><span class="op" id="4571711">,</span>&nbsp;<span class="num" id="4571713">0</span><span class="op" id="4571714">,</span>&nbsp;<span class="string" id="4571716">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="4571763">,</span>&nbsp;<span class="ident" id="4571765">t</span><span class="op" id="4571766">.</span><span class="ident" id="4571767">Name</span><span class="op" id="4571771">(</span><span class="op" id="4571772">)</span><span class="op" id="4571773">)</span><span class="op" id="4571774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4571778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4571781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4571784">return</span>&nbsp;<span class="ident" id="4571791">c1</span><br>
<span class="lineno"></span><span class="op" id="4571794">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="4571797">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="4571872">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4571949">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="4571976">func</span>&nbsp;<span class="op" id="4571981">(</span><span class="ident" id="4571982">e</span>&nbsp;<span class="op" id="4571984">*</span><span class="ident" id="4571985">escaper</span><span class="op" id="4571992">)</span>&nbsp;<span class="ident" id="4571994">escapeTemplateBody</span><span class="op" id="4572012">(</span><span class="ident" id="4572013">c</span>&nbsp;<span class="ident" id="4572015">context</span><span class="op" id="4572022">,</span>&nbsp;<span class="ident" id="4572024">t</span>&nbsp;<span class="op" id="4572026">*</span><span class="ident" id="4572027">template</span><span class="op" id="4572035">.</span><span class="ident" id="4572036">Template</span><span class="op" id="4572044">)</span>&nbsp;<span class="op" id="4572046">(</span><span class="ident" id="4572047">context</span><span class="op" id="4572054">,</span>&nbsp;<span class="builtintype" id="4572056">bool</span><span class="op" id="4572060">)</span>&nbsp;<span class="op" id="4572062">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4572065">filter</span>&nbsp;<span class="op" id="4572072">:=</span>&nbsp;<span class="keyword" id="4572075">func</span><span class="op" id="4572079">(</span><span class="ident" id="4572080">e1</span>&nbsp;<span class="op" id="4572083">*</span><span class="ident" id="4572084">escaper</span><span class="op" id="4572091">,</span>&nbsp;<span class="ident" id="4572093">c1</span>&nbsp;<span class="ident" id="4572096">context</span><span class="op" id="4572103">)</span>&nbsp;<span class="builtintype" id="4572105">bool</span>&nbsp;<span class="op" id="4572110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572114">if</span>&nbsp;<span class="ident" id="4572117">c1</span><span class="op" id="4572119">.</span><span class="ident" id="4572120">state</span>&nbsp;<span class="op" id="4572126">==</span>&nbsp;<span class="ident" id="4572129">stateError</span>&nbsp;<span class="op" id="4572140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4572145">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572187">return</span>&nbsp;<span class="builtintype" id="4572194">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4572202">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572206">if</span>&nbsp;<span class="op" id="4572209">!</span><span class="ident" id="4572210">e1</span><span class="op" id="4572212">.</span><span class="ident" id="4572213">called</span><span class="op" id="4572219">[</span><span class="ident" id="4572220">t</span><span class="op" id="4572221">.</span><span class="ident" id="4572222">Name</span><span class="op" id="4572226">(</span><span class="op" id="4572227">)</span><span class="op" id="4572228">]</span>&nbsp;<span class="op" id="4572230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4572235">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4572287">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572318">return</span>&nbsp;<span class="builtintype" id="4572325">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4572332">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4572336">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572398">return</span>&nbsp;<span class="ident" id="4572405">c</span><span class="op" id="4572406">.</span><span class="ident" id="4572407">eq</span><span class="op" id="4572409">(</span><span class="ident" id="4572410">c1</span><span class="op" id="4572412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4572415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4572418">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4572491">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4572565">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4572635">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4572663">e</span><span class="op" id="4572664">.</span><span class="ident" id="4572665">output</span><span class="op" id="4572671">[</span><span class="ident" id="4572672">t</span><span class="op" id="4572673">.</span><span class="ident" id="4572674">Name</span><span class="op" id="4572678">(</span><span class="op" id="4572679">)</span><span class="op" id="4572680">]</span>&nbsp;<span class="op" id="4572682">=</span>&nbsp;<span class="ident" id="4572684">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572687">return</span>&nbsp;<span class="ident" id="4572694">e</span><span class="op" id="4572695">.</span><span class="ident" id="4572696">escapeListConditionally</span><span class="op" id="4572719">(</span><span class="ident" id="4572720">c</span><span class="op" id="4572721">,</span>&nbsp;<span class="ident" id="4572723">t</span><span class="op" id="4572724">.</span><span class="ident" id="4572725">Tree</span><span class="op" id="4572729">.</span><span class="ident" id="4572730">Root</span><span class="op" id="4572734">,</span>&nbsp;<span class="ident" id="4572736">filter</span><span class="op" id="4572742">)</span><br>
<span class="lineno"></span><span class="op" id="4572744">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="4572747">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="4572821">var</span>&nbsp;<span class="ident" id="4572825">delimEnds</span>&nbsp;<span class="op" id="4572835">=</span>&nbsp;<span class="op" id="4572837">[</span><span class="op" id="4572838">...</span><span class="op" id="4572841">]</span><span class="builtintype" id="4572842">string</span><span class="op" id="4572848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4572851">delimDoubleQuote</span><span class="op" id="4572867">:</span>&nbsp;<span class="string" id="4572869">`&#34;`</span><span class="op" id="4572872">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4572875">delimSingleQuote</span><span class="op" id="4572891">:</span>&nbsp;<span class="string" id="4572893">&#34;&#39;&#34;</span><span class="op" id="4572896">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4572899">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4572968">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4573013">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4573053">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4573127">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4573199">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4573249">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4573255">delimSpaceOrTagEnd</span><span class="op" id="4573273">:</span>&nbsp;<span class="string" id="4573275">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="4573287">,</span><br>
<span class="lineno"></span><span class="op" id="4573289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="4573292">var</span>&nbsp;<span class="ident" id="4573296">doctypeBytes</span>&nbsp;<span class="op" id="4573309">=</span>&nbsp;<span class="op" id="4573311">[</span><span class="op" id="4573312">]</span><span class="builtintype" id="4573313">byte</span><span class="op" id="4573317">(</span><span class="string" id="4573318">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="4573329">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4573332">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4573376">func</span>&nbsp;<span class="op" id="4573381">(</span><span class="ident" id="4573382">e</span>&nbsp;<span class="op" id="4573384">*</span><span class="ident" id="4573385">escaper</span><span class="op" id="4573392">)</span>&nbsp;<span class="ident" id="4573394">escapeText</span><span class="op" id="4573404">(</span><span class="ident" id="4573405">c</span>&nbsp;<span class="ident" id="4573407">context</span><span class="op" id="4573414">,</span>&nbsp;<span class="ident" id="4573416">n</span>&nbsp;<span class="op" id="4573418">*</span><span class="ident" id="4573419">parse</span><span class="op" id="4573424">.</span><span class="ident" id="4573425">TextNode</span><span class="op" id="4573433">)</span>&nbsp;<span class="ident" id="4573435">context</span>&nbsp;<span class="op" id="4573443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4573446">s</span><span class="op" id="4573447">,</span>&nbsp;<span class="ident" id="4573449">written</span><span class="op" id="4573456">,</span>&nbsp;<span class="ident" id="4573458">i</span><span class="op" id="4573459">,</span>&nbsp;<span class="ident" id="4573461">b</span>&nbsp;<span class="op" id="4573463">:=</span>&nbsp;<span class="ident" id="4573466">n</span><span class="op" id="4573467">.</span><span class="ident" id="4573468">Text</span><span class="op" id="4573472">,</span>&nbsp;<span class="num" id="4573474">0</span><span class="op" id="4573475">,</span>&nbsp;<span class="num" id="4573477">0</span><span class="op" id="4573478">,</span>&nbsp;<span class="builtinfunc" id="4573480">new</span><span class="op" id="4573483">(</span><span class="ident" id="4573484">bytes</span><span class="op" id="4573489">.</span><span class="ident" id="4573490">Buffer</span><span class="op" id="4573496">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4573499">for</span>&nbsp;<span class="ident" id="4573503">i</span>&nbsp;<span class="op" id="4573505">!=</span>&nbsp;<span class="builtinfunc" id="4573508">len</span><span class="op" id="4573511">(</span><span class="ident" id="4573512">s</span><span class="op" id="4573513">)</span>&nbsp;<span class="op" id="4573515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4573519">c1</span><span class="op" id="4573521">,</span>&nbsp;<span class="ident" id="4573523">nread</span>&nbsp;<span class="op" id="4573529">:=</span>&nbsp;<span class="ident" id="4573532">contextAfterText</span><span class="op" id="4573548">(</span><span class="ident" id="4573549">c</span><span class="op" id="4573550">,</span>&nbsp;<span class="ident" id="4573552">s</span><span class="op" id="4573553">[</span><span class="ident" id="4573554">i</span><span class="op" id="4573555">:</span><span class="op" id="4573556">]</span><span class="op" id="4573557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4573561">i1</span>&nbsp;<span class="op" id="4573564">:=</span>&nbsp;<span class="ident" id="4573567">i</span>&nbsp;<span class="op" id="4573569">+</span>&nbsp;<span class="ident" id="4573571">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4573579">if</span>&nbsp;<span class="ident" id="4573582">c</span><span class="op" id="4573583">.</span><span class="ident" id="4573584">state</span>&nbsp;<span class="op" id="4573590">==</span>&nbsp;<span class="ident" id="4573593">stateText</span>&nbsp;<span class="op" id="4573603">||</span>&nbsp;<span class="ident" id="4573606">c</span><span class="op" id="4573607">.</span><span class="ident" id="4573608">state</span>&nbsp;<span class="op" id="4573614">==</span>&nbsp;<span class="ident" id="4573617">stateRCDATA</span>&nbsp;<span class="op" id="4573629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4573634">end</span>&nbsp;<span class="op" id="4573638">:=</span>&nbsp;<span class="ident" id="4573641">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4573647">if</span>&nbsp;<span class="ident" id="4573650">c1</span><span class="op" id="4573652">.</span><span class="ident" id="4573653">state</span>&nbsp;<span class="op" id="4573659">!=</span>&nbsp;<span class="ident" id="4573662">c</span><span class="op" id="4573663">.</span><span class="ident" id="4573664">state</span>&nbsp;<span class="op" id="4573670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4573676">for</span>&nbsp;<span class="ident" id="4573680">j</span>&nbsp;<span class="op" id="4573682">:=</span>&nbsp;<span class="ident" id="4573685">end</span>&nbsp;<span class="op" id="4573689">-</span>&nbsp;<span class="num" id="4573691">1</span><span class="op" id="4573692">;</span>&nbsp;<span class="ident" id="4573694">j</span>&nbsp;<span class="op" id="4573696">&gt;=</span>&nbsp;<span class="ident" id="4573699">i</span><span class="op" id="4573700">;</span>&nbsp;<span class="ident" id="4573702">j</span><span class="op" id="4573703">--</span>&nbsp;<span class="op" id="4573706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4573713">if</span>&nbsp;<span class="ident" id="4573716">s</span><span class="op" id="4573717">[</span><span class="ident" id="4573718">j</span><span class="op" id="4573719">]</span>&nbsp;<span class="op" id="4573721">==</span>&nbsp;<span class="string" id="4573724">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="4573728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4573736">end</span>&nbsp;<span class="op" id="4573740">=</span>&nbsp;<span class="ident" id="4573742">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4573750">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4573761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4573767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4573772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4573777">for</span>&nbsp;<span class="ident" id="4573781">j</span>&nbsp;<span class="op" id="4573783">:=</span>&nbsp;<span class="ident" id="4573786">i</span><span class="op" id="4573787">;</span>&nbsp;<span class="ident" id="4573789">j</span>&nbsp;<span class="op" id="4573791">&lt;</span>&nbsp;<span class="ident" id="4573793">end</span><span class="op" id="4573796">;</span>&nbsp;<span class="ident" id="4573798">j</span><span class="op" id="4573799">++</span>&nbsp;<span class="op" id="4573802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4573808">if</span>&nbsp;<span class="ident" id="4573811">s</span><span class="op" id="4573812">[</span><span class="ident" id="4573813">j</span><span class="op" id="4573814">]</span>&nbsp;<span class="op" id="4573816">==</span>&nbsp;<span class="string" id="4573819">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="4573823">&amp;&amp;</span>&nbsp;<span class="op" id="4573826">!</span><span class="ident" id="4573827">bytes</span><span class="op" id="4573832">.</span><span class="ident" id="4573833">HasPrefix</span><span class="op" id="4573842">(</span><span class="ident" id="4573843">bytes</span><span class="op" id="4573848">.</span><span class="ident" id="4573849">ToUpper</span><span class="op" id="4573856">(</span><span class="ident" id="4573857">s</span><span class="op" id="4573858">[</span><span class="ident" id="4573859">j</span><span class="op" id="4573860">:</span><span class="op" id="4573861">]</span><span class="op" id="4573862">)</span><span class="op" id="4573863">,</span>&nbsp;<span class="ident" id="4573865">doctypeBytes</span><span class="op" id="4573877">)</span>&nbsp;<span class="op" id="4573879">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4573886">b</span><span class="op" id="4573887">.</span><span class="ident" id="4573888">Write</span><span class="op" id="4573893">(</span><span class="ident" id="4573894">s</span><span class="op" id="4573895">[</span><span class="ident" id="4573896">written</span><span class="op" id="4573903">:</span><span class="ident" id="4573904">j</span><span class="op" id="4573905">]</span><span class="op" id="4573906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4573913">b</span><span class="op" id="4573914">.</span><span class="ident" id="4573915">WriteString</span><span class="op" id="4573926">(</span><span class="string" id="4573927">&#34;&amp;lt;&#34;</span><span class="op" id="4573933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4573940">written</span>&nbsp;<span class="op" id="4573948">=</span>&nbsp;<span class="ident" id="4573950">j</span>&nbsp;<span class="op" id="4573952">+</span>&nbsp;<span class="num" id="4573954">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4573960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4573965">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4573969">}</span>&nbsp;<span class="keyword" id="4573971">else</span>&nbsp;<span class="keyword" id="4573976">if</span>&nbsp;<span class="ident" id="4573979">isComment</span><span class="op" id="4573988">(</span><span class="ident" id="4573989">c</span><span class="op" id="4573990">.</span><span class="ident" id="4573991">state</span><span class="op" id="4573996">)</span>&nbsp;<span class="op" id="4573998">&amp;&amp;</span>&nbsp;<span class="ident" id="4574001">c</span><span class="op" id="4574002">.</span><span class="ident" id="4574003">delim</span>&nbsp;<span class="op" id="4574009">==</span>&nbsp;<span class="ident" id="4574012">delimNone</span>&nbsp;<span class="op" id="4574022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574027">switch</span>&nbsp;<span class="ident" id="4574034">c</span><span class="op" id="4574035">.</span><span class="ident" id="4574036">state</span>&nbsp;<span class="op" id="4574042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574047">case</span>&nbsp;<span class="ident" id="4574052">stateJSBlockCmt</span><span class="op" id="4574067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574073">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574109">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574158">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574210">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574260">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574308">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574357">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574388">if</span>&nbsp;<span class="ident" id="4574391">bytes</span><span class="op" id="4574396">.</span><span class="ident" id="4574397">IndexAny</span><span class="op" id="4574405">(</span><span class="ident" id="4574406">s</span><span class="op" id="4574407">[</span><span class="ident" id="4574408">written</span><span class="op" id="4574415">:</span><span class="ident" id="4574416">i1</span><span class="op" id="4574418">]</span><span class="op" id="4574419">,</span>&nbsp;<span class="string" id="4574421">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="4574439">)</span>&nbsp;<span class="op" id="4574441">!=</span>&nbsp;<span class="op" id="4574444">-</span><span class="num" id="4574445">1</span>&nbsp;<span class="op" id="4574447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574454">b</span><span class="op" id="4574455">.</span><span class="ident" id="4574456">WriteByte</span><span class="op" id="4574465">(</span><span class="string" id="4574466">&#39;\n&#39;</span><span class="op" id="4574470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4574476">}</span>&nbsp;<span class="keyword" id="4574478">else</span>&nbsp;<span class="op" id="4574483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574490">b</span><span class="op" id="4574491">.</span><span class="ident" id="4574492">WriteByte</span><span class="op" id="4574501">(</span><span class="string" id="4574502">&#39;&nbsp;&#39;</span><span class="op" id="4574505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4574511">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574516">case</span>&nbsp;<span class="ident" id="4574521">stateCSSBlockCmt</span><span class="op" id="4574537">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574543">b</span><span class="op" id="4574544">.</span><span class="ident" id="4574545">WriteByte</span><span class="op" id="4574554">(</span><span class="string" id="4574555">&#39;&nbsp;&#39;</span><span class="op" id="4574558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4574563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574568">written</span>&nbsp;<span class="op" id="4574576">=</span>&nbsp;<span class="ident" id="4574578">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4574583">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574587">if</span>&nbsp;<span class="ident" id="4574590">c</span><span class="op" id="4574591">.</span><span class="ident" id="4574592">state</span>&nbsp;<span class="op" id="4574598">!=</span>&nbsp;<span class="ident" id="4574601">c1</span><span class="op" id="4574603">.</span><span class="ident" id="4574604">state</span>&nbsp;<span class="op" id="4574610">&amp;&amp;</span>&nbsp;<span class="ident" id="4574613">isComment</span><span class="op" id="4574622">(</span><span class="ident" id="4574623">c1</span><span class="op" id="4574625">.</span><span class="ident" id="4574626">state</span><span class="op" id="4574631">)</span>&nbsp;<span class="op" id="4574633">&amp;&amp;</span>&nbsp;<span class="ident" id="4574636">c1</span><span class="op" id="4574638">.</span><span class="ident" id="4574639">delim</span>&nbsp;<span class="op" id="4574645">==</span>&nbsp;<span class="ident" id="4574648">delimNone</span>&nbsp;<span class="op" id="4574658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574663">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574729">cs</span>&nbsp;<span class="op" id="4574732">:=</span>&nbsp;<span class="ident" id="4574735">i1</span>&nbsp;<span class="op" id="4574738">-</span>&nbsp;<span class="num" id="4574740">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574745">if</span>&nbsp;<span class="ident" id="4574748">c1</span><span class="op" id="4574750">.</span><span class="ident" id="4574751">state</span>&nbsp;<span class="op" id="4574757">==</span>&nbsp;<span class="ident" id="4574760">stateHTMLCmt</span>&nbsp;<span class="op" id="4574773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574779">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574817">cs</span>&nbsp;<span class="op" id="4574820">-=</span>&nbsp;<span class="num" id="4574823">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4574828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574833">b</span><span class="op" id="4574834">.</span><span class="ident" id="4574835">Write</span><span class="op" id="4574840">(</span><span class="ident" id="4574841">s</span><span class="op" id="4574842">[</span><span class="ident" id="4574843">written</span><span class="op" id="4574850">:</span><span class="ident" id="4574851">cs</span><span class="op" id="4574853">]</span><span class="op" id="4574854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574859">written</span>&nbsp;<span class="op" id="4574867">=</span>&nbsp;<span class="ident" id="4574869">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4574874">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574878">if</span>&nbsp;<span class="ident" id="4574881">i</span>&nbsp;<span class="op" id="4574883">==</span>&nbsp;<span class="ident" id="4574886">i1</span>&nbsp;<span class="op" id="4574889">&amp;&amp;</span>&nbsp;<span class="ident" id="4574892">c</span><span class="op" id="4574893">.</span><span class="ident" id="4574894">state</span>&nbsp;<span class="op" id="4574900">==</span>&nbsp;<span class="ident" id="4574903">c1</span><span class="op" id="4574905">.</span><span class="ident" id="4574906">state</span>&nbsp;<span class="op" id="4574912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4574917">panic</span><span class="op" id="4574922">(</span><span class="ident" id="4574923">fmt</span><span class="op" id="4574926">.</span><span class="ident" id="4574927">Sprintf</span><span class="op" id="4574934">(</span><span class="string" id="4574935">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="4574974">,</span>&nbsp;<span class="ident" id="4574976">c</span><span class="op" id="4574977">,</span>&nbsp;<span class="ident" id="4574979">c1</span><span class="op" id="4574981">,</span>&nbsp;<span class="ident" id="4574983">s</span><span class="op" id="4574984">[</span><span class="op" id="4574985">:</span><span class="ident" id="4574986">i</span><span class="op" id="4574987">]</span><span class="op" id="4574988">,</span>&nbsp;<span class="ident" id="4574990">s</span><span class="op" id="4574991">[</span><span class="ident" id="4574992">i</span><span class="op" id="4574993">:</span><span class="op" id="4574994">]</span><span class="op" id="4574995">)</span><span class="op" id="4574996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4575000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4575004">c</span><span class="op" id="4575005">,</span>&nbsp;<span class="ident" id="4575007">i</span>&nbsp;<span class="op" id="4575009">=</span>&nbsp;<span class="ident" id="4575011">c1</span><span class="op" id="4575013">,</span>&nbsp;<span class="ident" id="4575015">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4575019">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575023">if</span>&nbsp;<span class="ident" id="4575026">written</span>&nbsp;<span class="op" id="4575034">!=</span>&nbsp;<span class="num" id="4575037">0</span>&nbsp;<span class="op" id="4575039">&amp;&amp;</span>&nbsp;<span class="ident" id="4575042">c</span><span class="op" id="4575043">.</span><span class="ident" id="4575044">state</span>&nbsp;<span class="op" id="4575050">!=</span>&nbsp;<span class="ident" id="4575053">stateError</span>&nbsp;<span class="op" id="4575064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575068">if</span>&nbsp;<span class="op" id="4575071">!</span><span class="ident" id="4575072">isComment</span><span class="op" id="4575081">(</span><span class="ident" id="4575082">c</span><span class="op" id="4575083">.</span><span class="ident" id="4575084">state</span><span class="op" id="4575089">)</span>&nbsp;<span class="op" id="4575091">||</span>&nbsp;<span class="ident" id="4575094">c</span><span class="op" id="4575095">.</span><span class="ident" id="4575096">delim</span>&nbsp;<span class="op" id="4575102">!=</span>&nbsp;<span class="ident" id="4575105">delimNone</span>&nbsp;<span class="op" id="4575115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4575120">b</span><span class="op" id="4575121">.</span><span class="ident" id="4575122">Write</span><span class="op" id="4575127">(</span><span class="ident" id="4575128">n</span><span class="op" id="4575129">.</span><span class="ident" id="4575130">Text</span><span class="op" id="4575134">[</span><span class="ident" id="4575135">written</span><span class="op" id="4575142">:</span><span class="op" id="4575143">]</span><span class="op" id="4575144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4575148">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4575152">e</span><span class="op" id="4575153">.</span><span class="ident" id="4575154">editTextNode</span><span class="op" id="4575166">(</span><span class="ident" id="4575167">n</span><span class="op" id="4575168">,</span>&nbsp;<span class="ident" id="4575170">b</span><span class="op" id="4575171">.</span><span class="ident" id="4575172">Bytes</span><span class="op" id="4575177">(</span><span class="op" id="4575178">)</span><span class="op" id="4575179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4575182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575185">return</span>&nbsp;<span class="ident" id="4575192">c</span><br>
<span class="lineno"></span><span class="op" id="4575194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="4575197">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4575277">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="4575355">func</span>&nbsp;<span class="ident" id="4575360">contextAfterText</span><span class="op" id="4575376">(</span><span class="ident" id="4575377">c</span>&nbsp;<span class="ident" id="4575379">context</span><span class="op" id="4575386">,</span>&nbsp;<span class="ident" id="4575388">s</span>&nbsp;<span class="op" id="4575390">[</span><span class="op" id="4575391">]</span><span class="builtintype" id="4575392">byte</span><span class="op" id="4575396">)</span>&nbsp;<span class="op" id="4575398">(</span><span class="ident" id="4575399">context</span><span class="op" id="4575406">,</span>&nbsp;<span class="builtintype" id="4575408">int</span><span class="op" id="4575411">)</span>&nbsp;<span class="op" id="4575413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575416">if</span>&nbsp;<span class="ident" id="4575419">c</span><span class="op" id="4575420">.</span><span class="ident" id="4575421">delim</span>&nbsp;<span class="op" id="4575427">==</span>&nbsp;<span class="ident" id="4575430">delimNone</span>&nbsp;<span class="op" id="4575440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4575444">c1</span><span class="op" id="4575446">,</span>&nbsp;<span class="ident" id="4575448">i</span>&nbsp;<span class="op" id="4575450">:=</span>&nbsp;<span class="ident" id="4575453">tSpecialTagEnd</span><span class="op" id="4575467">(</span><span class="ident" id="4575468">c</span><span class="op" id="4575469">,</span>&nbsp;<span class="ident" id="4575471">s</span><span class="op" id="4575472">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575476">if</span>&nbsp;<span class="ident" id="4575479">i</span>&nbsp;<span class="op" id="4575481">==</span>&nbsp;<span class="num" id="4575484">0</span>&nbsp;<span class="op" id="4575486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575491">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575547">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575597">return</span>&nbsp;<span class="ident" id="4575604">c1</span><span class="op" id="4575606">,</span>&nbsp;<span class="num" id="4575608">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4575612">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575616">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575661">return</span>&nbsp;<span class="ident" id="4575668">transitionFunc</span><span class="op" id="4575682">[</span><span class="ident" id="4575683">c</span><span class="op" id="4575684">.</span><span class="ident" id="4575685">state</span><span class="op" id="4575690">]</span><span class="op" id="4575691">(</span><span class="ident" id="4575692">c</span><span class="op" id="4575693">,</span>&nbsp;<span class="ident" id="4575695">s</span><span class="op" id="4575696">[</span><span class="op" id="4575697">:</span><span class="ident" id="4575698">i</span><span class="op" id="4575699">]</span><span class="op" id="4575700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4575703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4575707">i</span>&nbsp;<span class="op" id="4575709">:=</span>&nbsp;<span class="ident" id="4575712">bytes</span><span class="op" id="4575717">.</span><span class="ident" id="4575718">IndexAny</span><span class="op" id="4575726">(</span><span class="ident" id="4575727">s</span><span class="op" id="4575728">,</span>&nbsp;<span class="ident" id="4575730">delimEnds</span><span class="op" id="4575739">[</span><span class="ident" id="4575740">c</span><span class="op" id="4575741">.</span><span class="ident" id="4575742">delim</span><span class="op" id="4575747">]</span><span class="op" id="4575748">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575751">if</span>&nbsp;<span class="ident" id="4575754">i</span>&nbsp;<span class="op" id="4575756">==</span>&nbsp;<span class="op" id="4575759">-</span><span class="num" id="4575760">1</span>&nbsp;<span class="op" id="4575762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4575766">i</span>&nbsp;<span class="op" id="4575768">=</span>&nbsp;<span class="builtinfunc" id="4575770">len</span><span class="op" id="4575773">(</span><span class="ident" id="4575774">s</span><span class="op" id="4575775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4575778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575781">if</span>&nbsp;<span class="ident" id="4575784">c</span><span class="op" id="4575785">.</span><span class="ident" id="4575786">delim</span>&nbsp;<span class="op" id="4575792">==</span>&nbsp;<span class="ident" id="4575795">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="4575814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575818">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575895">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575943">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576001">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576067">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576117">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576170">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576215">if</span>&nbsp;<span class="ident" id="4576218">j</span>&nbsp;<span class="op" id="4576220">:=</span>&nbsp;<span class="ident" id="4576223">bytes</span><span class="op" id="4576228">.</span><span class="ident" id="4576229">IndexAny</span><span class="op" id="4576237">(</span><span class="ident" id="4576238">s</span><span class="op" id="4576239">[</span><span class="op" id="4576240">:</span><span class="ident" id="4576241">i</span><span class="op" id="4576242">]</span><span class="op" id="4576243">,</span>&nbsp;<span class="string" id="4576245">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="4576253">)</span><span class="op" id="4576254">;</span>&nbsp;<span class="ident" id="4576256">j</span>&nbsp;<span class="op" id="4576258">&gt;=</span>&nbsp;<span class="num" id="4576261">0</span>&nbsp;<span class="op" id="4576263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576268">return</span>&nbsp;<span class="ident" id="4576275">context</span><span class="op" id="4576282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576288">state</span><span class="op" id="4576293">:</span>&nbsp;<span class="ident" id="4576295">stateError</span><span class="op" id="4576305">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576311">err</span><span class="op" id="4576314">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4576318">errorf</span><span class="op" id="4576324">(</span><span class="ident" id="4576325">ErrBadHTML</span><span class="op" id="4576335">,</span>&nbsp;<span class="ident" id="4576337">nil</span><span class="op" id="4576340">,</span>&nbsp;<span class="num" id="4576342">0</span><span class="op" id="4576343">,</span>&nbsp;<span class="string" id="4576345">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="4576370">,</span>&nbsp;<span class="ident" id="4576372">s</span><span class="op" id="4576373">[</span><span class="ident" id="4576374">j</span><span class="op" id="4576375">:</span><span class="ident" id="4576376">j</span><span class="op" id="4576377">+</span><span class="num" id="4576378">1</span><span class="op" id="4576379">]</span><span class="op" id="4576380">,</span>&nbsp;<span class="ident" id="4576382">s</span><span class="op" id="4576383">[</span><span class="op" id="4576384">:</span><span class="ident" id="4576385">i</span><span class="op" id="4576386">]</span><span class="op" id="4576387">)</span><span class="op" id="4576388">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576393">}</span><span class="op" id="4576394">,</span>&nbsp;<span class="builtinfunc" id="4576396">len</span><span class="op" id="4576399">(</span><span class="ident" id="4576400">s</span><span class="op" id="4576401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576411">if</span>&nbsp;<span class="ident" id="4576414">i</span>&nbsp;<span class="op" id="4576416">==</span>&nbsp;<span class="builtinfunc" id="4576419">len</span><span class="op" id="4576422">(</span><span class="ident" id="4576423">s</span><span class="op" id="4576424">)</span>&nbsp;<span class="op" id="4576426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576430">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576464">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576522">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576573">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576628">for</span>&nbsp;<span class="ident" id="4576632">u</span>&nbsp;<span class="op" id="4576634">:=</span>&nbsp;<span class="op" id="4576637">[</span><span class="op" id="4576638">]</span><span class="builtintype" id="4576639">byte</span><span class="op" id="4576643">(</span><span class="ident" id="4576644">html</span><span class="op" id="4576648">.</span><span class="ident" id="4576649">UnescapeString</span><span class="op" id="4576663">(</span><span class="builtintype" id="4576664">string</span><span class="op" id="4576670">(</span><span class="ident" id="4576671">s</span><span class="op" id="4576672">)</span><span class="op" id="4576673">)</span><span class="op" id="4576674">)</span><span class="op" id="4576675">;</span>&nbsp;<span class="builtinfunc" id="4576677">len</span><span class="op" id="4576680">(</span><span class="ident" id="4576681">u</span><span class="op" id="4576682">)</span>&nbsp;<span class="op" id="4576684">!=</span>&nbsp;<span class="num" id="4576687">0</span><span class="op" id="4576688">;</span>&nbsp;<span class="op" id="4576690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576695">c1</span><span class="op" id="4576697">,</span>&nbsp;<span class="ident" id="4576699">i1</span>&nbsp;<span class="op" id="4576702">:=</span>&nbsp;<span class="ident" id="4576705">transitionFunc</span><span class="op" id="4576719">[</span><span class="ident" id="4576720">c</span><span class="op" id="4576721">.</span><span class="ident" id="4576722">state</span><span class="op" id="4576727">]</span><span class="op" id="4576728">(</span><span class="ident" id="4576729">c</span><span class="op" id="4576730">,</span>&nbsp;<span class="ident" id="4576732">u</span><span class="op" id="4576733">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576738">c</span><span class="op" id="4576739">,</span>&nbsp;<span class="ident" id="4576741">u</span>&nbsp;<span class="op" id="4576743">=</span>&nbsp;<span class="ident" id="4576745">c1</span><span class="op" id="4576747">,</span>&nbsp;<span class="ident" id="4576749">u</span><span class="op" id="4576750">[</span><span class="ident" id="4576751">i1</span><span class="op" id="4576753">:</span><span class="op" id="4576754">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576762">return</span>&nbsp;<span class="ident" id="4576769">c</span><span class="op" id="4576770">,</span>&nbsp;<span class="builtinfunc" id="4576772">len</span><span class="op" id="4576775">(</span><span class="ident" id="4576776">s</span><span class="op" id="4576777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576783">if</span>&nbsp;<span class="ident" id="4576786">c</span><span class="op" id="4576787">.</span><span class="ident" id="4576788">delim</span>&nbsp;<span class="op" id="4576794">!=</span>&nbsp;<span class="ident" id="4576797">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="4576816">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576820">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576844">i</span><span class="op" id="4576845">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576852">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576914">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576948">return</span>&nbsp;<span class="ident" id="4576955">context</span><span class="op" id="4576962">{</span><span class="ident" id="4576963">state</span><span class="op" id="4576968">:</span>&nbsp;<span class="ident" id="4576970">stateTag</span><span class="op" id="4576978">,</span>&nbsp;<span class="ident" id="4576980">element</span><span class="op" id="4576987">:</span>&nbsp;<span class="ident" id="4576989">c</span><span class="op" id="4576990">.</span><span class="ident" id="4576991">element</span><span class="op" id="4576998">}</span><span class="op" id="4576999">,</span>&nbsp;<span class="ident" id="4577001">i</span><br>
<span class="lineno"></span><span class="op" id="4577003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4577006">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="4577081">func</span>&nbsp;<span class="op" id="4577086">(</span><span class="ident" id="4577087">e</span>&nbsp;<span class="op" id="4577089">*</span><span class="ident" id="4577090">escaper</span><span class="op" id="4577097">)</span>&nbsp;<span class="ident" id="4577099">editActionNode</span><span class="op" id="4577113">(</span><span class="ident" id="4577114">n</span>&nbsp;<span class="op" id="4577116">*</span><span class="ident" id="4577117">parse</span><span class="op" id="4577122">.</span><span class="ident" id="4577123">ActionNode</span><span class="op" id="4577133">,</span>&nbsp;<span class="ident" id="4577135">cmds</span>&nbsp;<span class="op" id="4577140">[</span><span class="op" id="4577141">]</span><span class="builtintype" id="4577142">string</span><span class="op" id="4577148">)</span>&nbsp;<span class="op" id="4577150">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577153">if</span>&nbsp;<span class="ident" id="4577156">_</span><span class="op" id="4577157">,</span>&nbsp;<span class="ident" id="4577159">ok</span>&nbsp;<span class="op" id="4577162">:=</span>&nbsp;<span class="ident" id="4577165">e</span><span class="op" id="4577166">.</span><span class="ident" id="4577167">actionNodeEdits</span><span class="op" id="4577182">[</span><span class="ident" id="4577183">n</span><span class="op" id="4577184">]</span><span class="op" id="4577185">;</span>&nbsp;<span class="ident" id="4577187">ok</span>&nbsp;<span class="op" id="4577190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4577194">panic</span><span class="op" id="4577199">(</span><span class="ident" id="4577200">fmt</span><span class="op" id="4577203">.</span><span class="ident" id="4577204">Sprintf</span><span class="op" id="4577211">(</span><span class="string" id="4577212">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="4577246">,</span>&nbsp;<span class="ident" id="4577248">n</span><span class="op" id="4577249">)</span><span class="op" id="4577250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4577253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577256">e</span><span class="op" id="4577257">.</span><span class="ident" id="4577258">actionNodeEdits</span><span class="op" id="4577273">[</span><span class="ident" id="4577274">n</span><span class="op" id="4577275">]</span>&nbsp;<span class="op" id="4577277">=</span>&nbsp;<span class="ident" id="4577279">cmds</span><br>
<span class="lineno"></span><span class="op" id="4577284">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="4577287">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="4577367">func</span>&nbsp;<span class="op" id="4577372">(</span><span class="ident" id="4577373">e</span>&nbsp;<span class="op" id="4577375">*</span><span class="ident" id="4577376">escaper</span><span class="op" id="4577383">)</span>&nbsp;<span class="ident" id="4577385">editTemplateNode</span><span class="op" id="4577401">(</span><span class="ident" id="4577402">n</span>&nbsp;<span class="op" id="4577404">*</span><span class="ident" id="4577405">parse</span><span class="op" id="4577410">.</span><span class="ident" id="4577411">TemplateNode</span><span class="op" id="4577423">,</span>&nbsp;<span class="ident" id="4577425">callee</span>&nbsp;<span class="builtintype" id="4577432">string</span><span class="op" id="4577438">)</span>&nbsp;<span class="op" id="4577440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577443">if</span>&nbsp;<span class="ident" id="4577446">_</span><span class="op" id="4577447">,</span>&nbsp;<span class="ident" id="4577449">ok</span>&nbsp;<span class="op" id="4577452">:=</span>&nbsp;<span class="ident" id="4577455">e</span><span class="op" id="4577456">.</span><span class="ident" id="4577457">templateNodeEdits</span><span class="op" id="4577474">[</span><span class="ident" id="4577475">n</span><span class="op" id="4577476">]</span><span class="op" id="4577477">;</span>&nbsp;<span class="ident" id="4577479">ok</span>&nbsp;<span class="op" id="4577482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4577486">panic</span><span class="op" id="4577491">(</span><span class="ident" id="4577492">fmt</span><span class="op" id="4577495">.</span><span class="ident" id="4577496">Sprintf</span><span class="op" id="4577503">(</span><span class="string" id="4577504">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="4577538">,</span>&nbsp;<span class="ident" id="4577540">n</span><span class="op" id="4577541">)</span><span class="op" id="4577542">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4577545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577548">e</span><span class="op" id="4577549">.</span><span class="ident" id="4577550">templateNodeEdits</span><span class="op" id="4577567">[</span><span class="ident" id="4577568">n</span><span class="op" id="4577569">]</span>&nbsp;<span class="op" id="4577571">=</span>&nbsp;<span class="ident" id="4577573">callee</span><br>
<span class="lineno"></span><span class="op" id="4577580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4577583">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="4577649">func</span>&nbsp;<span class="op" id="4577654">(</span><span class="ident" id="4577655">e</span>&nbsp;<span class="op" id="4577657">*</span><span class="ident" id="4577658">escaper</span><span class="op" id="4577665">)</span>&nbsp;<span class="ident" id="4577667">editTextNode</span><span class="op" id="4577679">(</span><span class="ident" id="4577680">n</span>&nbsp;<span class="op" id="4577682">*</span><span class="ident" id="4577683">parse</span><span class="op" id="4577688">.</span><span class="ident" id="4577689">TextNode</span><span class="op" id="4577697">,</span>&nbsp;<span class="ident" id="4577699">text</span>&nbsp;<span class="op" id="4577704">[</span><span class="op" id="4577705">]</span><span class="builtintype" id="4577706">byte</span><span class="op" id="4577710">)</span>&nbsp;<span class="op" id="4577712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577715">if</span>&nbsp;<span class="ident" id="4577718">_</span><span class="op" id="4577719">,</span>&nbsp;<span class="ident" id="4577721">ok</span>&nbsp;<span class="op" id="4577724">:=</span>&nbsp;<span class="ident" id="4577727">e</span><span class="op" id="4577728">.</span><span class="ident" id="4577729">textNodeEdits</span><span class="op" id="4577742">[</span><span class="ident" id="4577743">n</span><span class="op" id="4577744">]</span><span class="op" id="4577745">;</span>&nbsp;<span class="ident" id="4577747">ok</span>&nbsp;<span class="op" id="4577750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4577754">panic</span><span class="op" id="4577759">(</span><span class="ident" id="4577760">fmt</span><span class="op" id="4577763">.</span><span class="ident" id="4577764">Sprintf</span><span class="op" id="4577771">(</span><span class="string" id="4577772">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="4577806">,</span>&nbsp;<span class="ident" id="4577808">n</span><span class="op" id="4577809">)</span><span class="op" id="4577810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4577813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577816">e</span><span class="op" id="4577817">.</span><span class="ident" id="4577818">textNodeEdits</span><span class="op" id="4577831">[</span><span class="ident" id="4577832">n</span><span class="op" id="4577833">]</span>&nbsp;<span class="op" id="4577835">=</span>&nbsp;<span class="ident" id="4577837">text</span><br>
<span class="lineno">735</span><span class="op" id="4577842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4577845">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="4577924">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="4577989">func</span>&nbsp;<span class="op" id="4577994">(</span><span class="ident" id="4577995">e</span>&nbsp;<span class="op" id="4577997">*</span><span class="ident" id="4577998">escaper</span><span class="op" id="4578005">)</span>&nbsp;<span class="ident" id="4578007">commit</span><span class="op" id="4578013">(</span><span class="op" id="4578014">)</span>&nbsp;<span class="op" id="4578016">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578019">for</span>&nbsp;<span class="ident" id="4578023">name</span>&nbsp;<span class="op" id="4578028">:=</span>&nbsp;<span class="keyword" id="4578031">range</span>&nbsp;<span class="ident" id="4578037">e</span><span class="op" id="4578038">.</span><span class="ident" id="4578039">output</span>&nbsp;<span class="op" id="4578046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578050">e</span><span class="op" id="4578051">.</span><span class="ident" id="4578052">template</span><span class="op" id="4578060">(</span><span class="ident" id="4578061">name</span><span class="op" id="4578065">)</span><span class="op" id="4578066">.</span><span class="ident" id="4578067">Funcs</span><span class="op" id="4578072">(</span><span class="ident" id="4578073">funcMap</span><span class="op" id="4578080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578086">for</span>&nbsp;<span class="ident" id="4578090">_</span><span class="op" id="4578091">,</span>&nbsp;<span class="ident" id="4578093">t</span>&nbsp;<span class="op" id="4578095">:=</span>&nbsp;<span class="keyword" id="4578098">range</span>&nbsp;<span class="ident" id="4578104">e</span><span class="op" id="4578105">.</span><span class="ident" id="4578106">derived</span>&nbsp;<span class="op" id="4578114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578118">if</span>&nbsp;<span class="ident" id="4578121">_</span><span class="op" id="4578122">,</span>&nbsp;<span class="ident" id="4578124">err</span>&nbsp;<span class="op" id="4578128">:=</span>&nbsp;<span class="ident" id="4578131">e</span><span class="op" id="4578132">.</span><span class="ident" id="4578133">tmpl</span><span class="op" id="4578137">.</span><span class="ident" id="4578138">text</span><span class="op" id="4578142">.</span><span class="ident" id="4578143">AddParseTree</span><span class="op" id="4578155">(</span><span class="ident" id="4578156">t</span><span class="op" id="4578157">.</span><span class="ident" id="4578158">Name</span><span class="op" id="4578162">(</span><span class="op" id="4578163">)</span><span class="op" id="4578164">,</span>&nbsp;<span class="ident" id="4578166">t</span><span class="op" id="4578167">.</span><span class="ident" id="4578168">Tree</span><span class="op" id="4578172">)</span><span class="op" id="4578173">;</span>&nbsp;<span class="ident" id="4578175">err</span>&nbsp;<span class="op" id="4578179">!=</span>&nbsp;<span class="ident" id="4578182">nil</span>&nbsp;<span class="op" id="4578186">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4578191">panic</span><span class="op" id="4578196">(</span><span class="string" id="4578197">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="4578228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578238">for</span>&nbsp;<span class="ident" id="4578242">n</span><span class="op" id="4578243">,</span>&nbsp;<span class="ident" id="4578245">s</span>&nbsp;<span class="op" id="4578247">:=</span>&nbsp;<span class="keyword" id="4578250">range</span>&nbsp;<span class="ident" id="4578256">e</span><span class="op" id="4578257">.</span><span class="ident" id="4578258">actionNodeEdits</span>&nbsp;<span class="op" id="4578274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578278">ensurePipelineContains</span><span class="op" id="4578300">(</span><span class="ident" id="4578301">n</span><span class="op" id="4578302">.</span><span class="ident" id="4578303">Pipe</span><span class="op" id="4578307">,</span>&nbsp;<span class="ident" id="4578309">s</span><span class="op" id="4578310">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578316">for</span>&nbsp;<span class="ident" id="4578320">n</span><span class="op" id="4578321">,</span>&nbsp;<span class="ident" id="4578323">name</span>&nbsp;<span class="op" id="4578328">:=</span>&nbsp;<span class="keyword" id="4578331">range</span>&nbsp;<span class="ident" id="4578337">e</span><span class="op" id="4578338">.</span><span class="ident" id="4578339">templateNodeEdits</span>&nbsp;<span class="op" id="4578357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578361">n</span><span class="op" id="4578362">.</span><span class="ident" id="4578363">Name</span>&nbsp;<span class="op" id="4578368">=</span>&nbsp;<span class="ident" id="4578370">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578379">for</span>&nbsp;<span class="ident" id="4578383">n</span><span class="op" id="4578384">,</span>&nbsp;<span class="ident" id="4578386">s</span>&nbsp;<span class="op" id="4578388">:=</span>&nbsp;<span class="keyword" id="4578391">range</span>&nbsp;<span class="ident" id="4578397">e</span><span class="op" id="4578398">.</span><span class="ident" id="4578399">textNodeEdits</span>&nbsp;<span class="op" id="4578413">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578417">n</span><span class="op" id="4578418">.</span><span class="ident" id="4578419">Text</span>&nbsp;<span class="op" id="4578424">=</span>&nbsp;<span class="ident" id="4578426">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578429">}</span><br>
<span class="lineno"></span><span class="op" id="4578431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4578434">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="4578504">func</span>&nbsp;<span class="op" id="4578509">(</span><span class="ident" id="4578510">e</span>&nbsp;<span class="op" id="4578512">*</span><span class="ident" id="4578513">escaper</span><span class="op" id="4578520">)</span>&nbsp;<span class="ident" id="4578522">template</span><span class="op" id="4578530">(</span><span class="ident" id="4578531">name</span>&nbsp;<span class="builtintype" id="4578536">string</span><span class="op" id="4578542">)</span>&nbsp;<span class="op" id="4578544">*</span><span class="ident" id="4578545">template</span><span class="op" id="4578553">.</span><span class="ident" id="4578554">Template</span>&nbsp;<span class="op" id="4578563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578566">t</span>&nbsp;<span class="op" id="4578568">:=</span>&nbsp;<span class="ident" id="4578571">e</span><span class="op" id="4578572">.</span><span class="ident" id="4578573">tmpl</span><span class="op" id="4578577">.</span><span class="ident" id="4578578">text</span><span class="op" id="4578582">.</span><span class="ident" id="4578583">Lookup</span><span class="op" id="4578589">(</span><span class="ident" id="4578590">name</span><span class="op" id="4578594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578597">if</span>&nbsp;<span class="ident" id="4578600">t</span>&nbsp;<span class="op" id="4578602">==</span>&nbsp;<span class="ident" id="4578605">nil</span>&nbsp;<span class="op" id="4578609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578613">t</span>&nbsp;<span class="op" id="4578615">=</span>&nbsp;<span class="ident" id="4578617">e</span><span class="op" id="4578618">.</span><span class="ident" id="4578619">derived</span><span class="op" id="4578626">[</span><span class="ident" id="4578627">name</span><span class="op" id="4578631">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578634">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578637">return</span>&nbsp;<span class="ident" id="4578644">t</span><br>
<span class="lineno"></span><span class="op" id="4578646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4578649">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4578719">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="4578781">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="4578861">func</span>&nbsp;<span class="ident" id="4578866">HTMLEscape</span><span class="op" id="4578876">(</span><span class="ident" id="4578877">w</span>&nbsp;<span class="ident" id="4578879">io</span><span class="op" id="4578881">.</span><span class="ident" id="4578882">Writer</span><span class="op" id="4578888">,</span>&nbsp;<span class="ident" id="4578890">b</span>&nbsp;<span class="op" id="4578892">[</span><span class="op" id="4578893">]</span><span class="builtintype" id="4578894">byte</span><span class="op" id="4578898">)</span>&nbsp;<span class="op" id="4578900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578903">template</span><span class="op" id="4578911">.</span><span class="ident" id="4578912">HTMLEscape</span><span class="op" id="4578922">(</span><span class="ident" id="4578923">w</span><span class="op" id="4578924">,</span>&nbsp;<span class="ident" id="4578926">b</span><span class="op" id="4578927">)</span><br>
<span class="lineno"></span><span class="op" id="4578929">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="4578932">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="4579014">func</span>&nbsp;<span class="ident" id="4579019">HTMLEscapeString</span><span class="op" id="4579035">(</span><span class="ident" id="4579036">s</span>&nbsp;<span class="builtintype" id="4579038">string</span><span class="op" id="4579044">)</span>&nbsp;<span class="builtintype" id="4579046">string</span>&nbsp;<span class="op" id="4579053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579056">return</span>&nbsp;<span class="ident" id="4579063">template</span><span class="op" id="4579071">.</span><span class="ident" id="4579072">HTMLEscapeString</span><span class="op" id="4579088">(</span><span class="ident" id="4579089">s</span><span class="op" id="4579090">)</span><br>
<span class="lineno"></span><span class="op" id="4579092">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="4579095">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="4579161">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="4579197">func</span>&nbsp;<span class="ident" id="4579202">HTMLEscaper</span><span class="op" id="4579213">(</span><span class="ident" id="4579214">args</span>&nbsp;<span class="op" id="4579219">...</span><span class="keyword" id="4579222">interface</span><span class="op" id="4579231">{</span><span class="op" id="4579232">}</span><span class="op" id="4579233">)</span>&nbsp;<span class="builtintype" id="4579235">string</span>&nbsp;<span class="op" id="4579242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579245">return</span>&nbsp;<span class="ident" id="4579252">template</span><span class="op" id="4579260">.</span><span class="ident" id="4579261">HTMLEscaper</span><span class="op" id="4579272">(</span><span class="ident" id="4579273">args</span><span class="op" id="4579277">...</span><span class="op" id="4579280">)</span><br>
<span class="lineno">785</span><span class="op" id="4579282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4579285">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="4579369">func</span>&nbsp;<span class="ident" id="4579374">JSEscape</span><span class="op" id="4579382">(</span><span class="ident" id="4579383">w</span>&nbsp;<span class="ident" id="4579385">io</span><span class="op" id="4579387">.</span><span class="ident" id="4579388">Writer</span><span class="op" id="4579394">,</span>&nbsp;<span class="ident" id="4579396">b</span>&nbsp;<span class="op" id="4579398">[</span><span class="op" id="4579399">]</span><span class="builtintype" id="4579400">byte</span><span class="op" id="4579404">)</span>&nbsp;<span class="op" id="4579406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579409">template</span><span class="op" id="4579417">.</span><span class="ident" id="4579418">JSEscape</span><span class="op" id="4579426">(</span><span class="ident" id="4579427">w</span><span class="op" id="4579428">,</span>&nbsp;<span class="ident" id="4579430">b</span><span class="op" id="4579431">)</span><br>
<span class="lineno">790</span><span class="op" id="4579433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4579436">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="4579522">func</span>&nbsp;<span class="ident" id="4579527">JSEscapeString</span><span class="op" id="4579541">(</span><span class="ident" id="4579542">s</span>&nbsp;<span class="builtintype" id="4579544">string</span><span class="op" id="4579550">)</span>&nbsp;<span class="builtintype" id="4579552">string</span>&nbsp;<span class="op" id="4579559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579562">return</span>&nbsp;<span class="ident" id="4579569">template</span><span class="op" id="4579577">.</span><span class="ident" id="4579578">JSEscapeString</span><span class="op" id="4579592">(</span><span class="ident" id="4579593">s</span><span class="op" id="4579594">)</span><br>
<span class="lineno">795</span><span class="op" id="4579596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4579599">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="4579669">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="4579705">func</span>&nbsp;<span class="ident" id="4579710">JSEscaper</span><span class="op" id="4579719">(</span><span class="ident" id="4579720">args</span>&nbsp;<span class="op" id="4579725">...</span><span class="keyword" id="4579728">interface</span><span class="op" id="4579737">{</span><span class="op" id="4579738">}</span><span class="op" id="4579739">)</span>&nbsp;<span class="builtintype" id="4579741">string</span>&nbsp;<span class="op" id="4579748">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579751">return</span>&nbsp;<span class="ident" id="4579758">template</span><span class="op" id="4579766">.</span><span class="ident" id="4579767">JSEscaper</span><span class="op" id="4579776">(</span><span class="ident" id="4579777">args</span><span class="op" id="4579781">...</span><span class="op" id="4579784">)</span><br>
<span class="lineno"></span><span class="op" id="4579786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4579789">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4579867">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="4579933">func</span>&nbsp;<span class="ident" id="4579938">URLQueryEscaper</span><span class="op" id="4579953">(</span><span class="ident" id="4579954">args</span>&nbsp;<span class="op" id="4579959">...</span><span class="keyword" id="4579962">interface</span><span class="op" id="4579971">{</span><span class="op" id="4579972">}</span><span class="op" id="4579973">)</span>&nbsp;<span class="builtintype" id="4579975">string</span>&nbsp;<span class="op" id="4579982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579985">return</span>&nbsp;<span class="ident" id="4579992">template</span><span class="op" id="4580000">.</span><span class="ident" id="4580001">URLQueryEscaper</span><span class="op" id="4580016">(</span><span class="ident" id="4580017">args</span><span class="op" id="4580021">...</span><span class="op" id="4580024">)</span><br>
<span class="lineno"></span><span class="op" id="4580026">}</span>
</div>
</body>
</html>
