<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8136066">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8136121">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8136175">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8136226">//&nbsp;+build&nbsp;!windows,!nacl,!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8136259">package</span>&nbsp;<span class="ident" id="8136267">syslog</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8136275">import</span>&nbsp;<span class="op" id="8136282">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8136285">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8136294">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8136301">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8136307">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8136320">&#34;log&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8136327">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8136334">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8136340">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8136348">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8136359">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="8136366">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8136369">func</span>&nbsp;<span class="ident" id="8136374">runPktSyslog</span><span class="op" id="8136386">(</span><span class="ident" id="8136387">c</span>&nbsp;<span class="ident" id="8136389">net</span><span class="op" id="8136392">.</span><span class="ident" id="8136393">PacketConn</span><span class="op" id="8136403">,</span>&nbsp;<span class="ident" id="8136405">done</span>&nbsp;<span class="keyword" id="8136410">chan</span><span class="op" id="8136414">&lt;-</span>&nbsp;<span class="builtintype" id="8136417">string</span><span class="op" id="8136423">)</span>&nbsp;<span class="op" id="8136425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136428">var</span>&nbsp;<span class="ident" id="8136432">buf</span>&nbsp;<span class="op" id="8136436">[</span><span class="num" id="8136437">4096</span><span class="op" id="8136441">]</span><span class="builtintype" id="8136442">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136448">var</span>&nbsp;<span class="ident" id="8136452">rcvd</span>&nbsp;<span class="builtintype" id="8136457">string</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8136465">ct</span>&nbsp;<span class="op" id="8136468">:=</span>&nbsp;<span class="num" id="8136471">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136474">for</span>&nbsp;<span class="op" id="8136478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136482">var</span>&nbsp;<span class="ident" id="8136486">n</span>&nbsp;<span class="builtintype" id="8136488">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136494">var</span>&nbsp;<span class="ident" id="8136498">err</span>&nbsp;<span class="builtintype" id="8136502">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8136511">c</span><span class="op" id="8136512">.</span><span class="ident" id="8136513">SetReadDeadline</span><span class="op" id="8136528">(</span><span class="ident" id="8136529">time</span><span class="op" id="8136533">.</span><span class="ident" id="8136534">Now</span><span class="op" id="8136537">(</span><span class="op" id="8136538">)</span><span class="op" id="8136539">.</span><span class="ident" id="8136540">Add</span><span class="op" id="8136543">(</span><span class="num" id="8136544">100</span>&nbsp;<span class="op" id="8136548">*</span>&nbsp;<span class="ident" id="8136550">time</span><span class="op" id="8136554">.</span><span class="ident" id="8136555">Millisecond</span><span class="op" id="8136566">)</span><span class="op" id="8136567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8136571">n</span><span class="op" id="8136572">,</span>&nbsp;<span class="ident" id="8136574">_</span><span class="op" id="8136575">,</span>&nbsp;<span class="ident" id="8136577">err</span>&nbsp;<span class="op" id="8136581">=</span>&nbsp;<span class="ident" id="8136583">c</span><span class="op" id="8136584">.</span><span class="ident" id="8136585">ReadFrom</span><span class="op" id="8136593">(</span><span class="ident" id="8136594">buf</span><span class="op" id="8136597">[</span><span class="op" id="8136598">:</span><span class="op" id="8136599">]</span><span class="op" id="8136600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8136604">rcvd</span>&nbsp;<span class="op" id="8136609">+=</span>&nbsp;<span class="builtintype" id="8136612">string</span><span class="op" id="8136618">(</span><span class="ident" id="8136619">buf</span><span class="op" id="8136622">[</span><span class="op" id="8136623">:</span><span class="ident" id="8136624">n</span><span class="op" id="8136625">]</span><span class="op" id="8136626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136630">if</span>&nbsp;<span class="ident" id="8136633">err</span>&nbsp;<span class="op" id="8136637">!=</span>&nbsp;<span class="ident" id="8136640">nil</span>&nbsp;<span class="op" id="8136644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136649">if</span>&nbsp;<span class="ident" id="8136652">oe</span><span class="op" id="8136654">,</span>&nbsp;<span class="ident" id="8136656">ok</span>&nbsp;<span class="op" id="8136659">:=</span>&nbsp;<span class="ident" id="8136662">err</span><span class="op" id="8136665">.</span><span class="op" id="8136666">(</span><span class="op" id="8136667">*</span><span class="ident" id="8136668">net</span><span class="op" id="8136671">.</span><span class="ident" id="8136672">OpError</span><span class="op" id="8136679">)</span><span class="op" id="8136680">;</span>&nbsp;<span class="ident" id="8136682">ok</span>&nbsp;<span class="op" id="8136685">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136691">if</span>&nbsp;<span class="ident" id="8136694">ct</span>&nbsp;<span class="op" id="8136697">&lt;</span>&nbsp;<span class="num" id="8136699">3</span>&nbsp;<span class="op" id="8136701">&amp;&amp;</span>&nbsp;<span class="ident" id="8136704">oe</span><span class="op" id="8136706">.</span><span class="ident" id="8136707">Temporary</span><span class="op" id="8136716">(</span><span class="op" id="8136717">)</span>&nbsp;<span class="op" id="8136719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8136726">ct</span><span class="op" id="8136728">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136736">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8136749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8136754">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136759">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8136767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8136770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8136773">c</span><span class="op" id="8136774">.</span><span class="ident" id="8136775">Close</span><span class="op" id="8136780">(</span><span class="op" id="8136781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8136784">done</span>&nbsp;<span class="op" id="8136789">&lt;-</span>&nbsp;<span class="ident" id="8136792">rcvd</span><br>
<span class="lineno">45</span><span class="op" id="8136797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8136800">var</span>&nbsp;<span class="ident" id="8136804">crashy</span>&nbsp;<span class="op" id="8136811">=</span>&nbsp;<span class="ident" id="8136813">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8136820">func</span>&nbsp;<span class="ident" id="8136825">runStreamSyslog</span><span class="op" id="8136840">(</span><span class="ident" id="8136841">l</span>&nbsp;<span class="ident" id="8136843">net</span><span class="op" id="8136846">.</span><span class="ident" id="8136847">Listener</span><span class="op" id="8136855">,</span>&nbsp;<span class="ident" id="8136857">done</span>&nbsp;<span class="keyword" id="8136862">chan</span><span class="op" id="8136866">&lt;-</span>&nbsp;<span class="builtintype" id="8136869">string</span><span class="op" id="8136875">,</span>&nbsp;<span class="ident" id="8136877">wg</span>&nbsp;<span class="op" id="8136880">*</span><span class="ident" id="8136881">sync</span><span class="op" id="8136885">.</span><span class="ident" id="8136886">WaitGroup</span><span class="op" id="8136895">)</span>&nbsp;<span class="op" id="8136897">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136900">for</span>&nbsp;<span class="op" id="8136904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136908">var</span>&nbsp;<span class="ident" id="8136912">c</span>&nbsp;<span class="ident" id="8136914">net</span><span class="op" id="8136917">.</span><span class="ident" id="8136918">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136925">var</span>&nbsp;<span class="ident" id="8136929">err</span>&nbsp;<span class="builtintype" id="8136933">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136941">if</span>&nbsp;<span class="ident" id="8136944">c</span><span class="op" id="8136945">,</span>&nbsp;<span class="ident" id="8136947">err</span>&nbsp;<span class="op" id="8136951">=</span>&nbsp;<span class="ident" id="8136953">l</span><span class="op" id="8136954">.</span><span class="ident" id="8136955">Accept</span><span class="op" id="8136961">(</span><span class="op" id="8136962">)</span><span class="op" id="8136963">;</span>&nbsp;<span class="ident" id="8136965">err</span>&nbsp;<span class="op" id="8136969">!=</span>&nbsp;<span class="ident" id="8136972">nil</span>&nbsp;<span class="op" id="8136976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8136981">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8136990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8136994">wg</span><span class="op" id="8136996">.</span><span class="ident" id="8136997">Add</span><span class="op" id="8137000">(</span><span class="num" id="8137001">1</span><span class="op" id="8137002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8137006">go</span>&nbsp;<span class="keyword" id="8137009">func</span><span class="op" id="8137013">(</span><span class="ident" id="8137014">c</span>&nbsp;<span class="ident" id="8137016">net</span><span class="op" id="8137019">.</span><span class="ident" id="8137020">Conn</span><span class="op" id="8137024">)</span>&nbsp;<span class="op" id="8137026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8137031">defer</span>&nbsp;<span class="ident" id="8137037">wg</span><span class="op" id="8137039">.</span><span class="ident" id="8137040">Done</span><span class="op" id="8137044">(</span><span class="op" id="8137045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137050">c</span><span class="op" id="8137051">.</span><span class="ident" id="8137052">SetReadDeadline</span><span class="op" id="8137067">(</span><span class="ident" id="8137068">time</span><span class="op" id="8137072">.</span><span class="ident" id="8137073">Now</span><span class="op" id="8137076">(</span><span class="op" id="8137077">)</span><span class="op" id="8137078">.</span><span class="ident" id="8137079">Add</span><span class="op" id="8137082">(</span><span class="num" id="8137083">5</span>&nbsp;<span class="op" id="8137085">*</span>&nbsp;<span class="ident" id="8137087">time</span><span class="op" id="8137091">.</span><span class="ident" id="8137092">Second</span><span class="op" id="8137098">)</span><span class="op" id="8137099">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137104">b</span>&nbsp;<span class="op" id="8137106">:=</span>&nbsp;<span class="ident" id="8137109">bufio</span><span class="op" id="8137114">.</span><span class="ident" id="8137115">NewReader</span><span class="op" id="8137124">(</span><span class="ident" id="8137125">c</span><span class="op" id="8137126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8137131">for</span>&nbsp;<span class="ident" id="8137135">ct</span>&nbsp;<span class="op" id="8137138">:=</span>&nbsp;<span class="num" id="8137141">1</span><span class="op" id="8137142">;</span>&nbsp;<span class="op" id="8137144">!</span><span class="ident" id="8137145">crashy</span>&nbsp;<span class="op" id="8137152">||</span>&nbsp;<span class="ident" id="8137155">ct</span><span class="op" id="8137157">&amp;</span><span class="num" id="8137158">7</span>&nbsp;<span class="op" id="8137160">!=</span>&nbsp;<span class="num" id="8137163">0</span><span class="op" id="8137164">;</span>&nbsp;<span class="ident" id="8137166">ct</span><span class="op" id="8137168">++</span>&nbsp;<span class="op" id="8137171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137177">s</span><span class="op" id="8137178">,</span>&nbsp;<span class="ident" id="8137180">err</span>&nbsp;<span class="op" id="8137184">:=</span>&nbsp;<span class="ident" id="8137187">b</span><span class="op" id="8137188">.</span><span class="ident" id="8137189">ReadString</span><span class="op" id="8137199">(</span><span class="string" id="8137200">&#39;\n&#39;</span><span class="op" id="8137204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8137210">if</span>&nbsp;<span class="ident" id="8137213">err</span>&nbsp;<span class="op" id="8137217">!=</span>&nbsp;<span class="ident" id="8137220">nil</span>&nbsp;<span class="op" id="8137224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8137231">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8137241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137247">done</span>&nbsp;<span class="op" id="8137252">&lt;-</span>&nbsp;<span class="ident" id="8137255">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8137260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137265">c</span><span class="op" id="8137266">.</span><span class="ident" id="8137267">Close</span><span class="op" id="8137272">(</span><span class="op" id="8137273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8137277">}</span><span class="op" id="8137278">(</span><span class="ident" id="8137279">c</span><span class="op" id="8137280">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8137283">}</span><br>
<span class="lineno"></span><span class="op" id="8137285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8137288">func</span>&nbsp;<span class="ident" id="8137293">startServer</span><span class="op" id="8137304">(</span><span class="ident" id="8137305">n</span><span class="op" id="8137306">,</span>&nbsp;<span class="ident" id="8137308">la</span>&nbsp;<span class="builtintype" id="8137311">string</span><span class="op" id="8137317">,</span>&nbsp;<span class="ident" id="8137319">done</span>&nbsp;<span class="keyword" id="8137324">chan</span><span class="op" id="8137328">&lt;-</span>&nbsp;<span class="builtintype" id="8137331">string</span><span class="op" id="8137337">)</span>&nbsp;<span class="op" id="8137339">(</span><span class="ident" id="8137340">addr</span>&nbsp;<span class="builtintype" id="8137345">string</span><span class="op" id="8137351">,</span>&nbsp;<span class="ident" id="8137353">sock</span>&nbsp;<span class="ident" id="8137358">io</span><span class="op" id="8137360">.</span><span class="ident" id="8137361">Closer</span><span class="op" id="8137367">,</span>&nbsp;<span class="ident" id="8137369">wg</span>&nbsp;<span class="op" id="8137372">*</span><span class="ident" id="8137373">sync</span><span class="op" id="8137377">.</span><span class="ident" id="8137378">WaitGroup</span><span class="op" id="8137387">)</span>&nbsp;<span class="op" id="8137389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8137392">if</span>&nbsp;<span class="ident" id="8137395">n</span>&nbsp;<span class="op" id="8137397">==</span>&nbsp;<span class="string" id="8137400">&#34;udp&#34;</span>&nbsp;<span class="op" id="8137406">||</span>&nbsp;<span class="ident" id="8137409">n</span>&nbsp;<span class="op" id="8137411">==</span>&nbsp;<span class="string" id="8137414">&#34;tcp&#34;</span>&nbsp;<span class="op" id="8137420">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137424">la</span>&nbsp;<span class="op" id="8137427">=</span>&nbsp;<span class="string" id="8137429">&#34;127.0.0.1:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8137444">}</span>&nbsp;<span class="keyword" id="8137446">else</span>&nbsp;<span class="op" id="8137451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8137455">//&nbsp;unix&nbsp;and&nbsp;unixgram:&nbsp;choose&nbsp;an&nbsp;address&nbsp;if&nbsp;none&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8137511">if</span>&nbsp;<span class="ident" id="8137514">la</span>&nbsp;<span class="op" id="8137517">==</span>&nbsp;<span class="string" id="8137520">&#34;&#34;</span>&nbsp;<span class="op" id="8137523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8137528">//&nbsp;use&nbsp;ioutil.TempFile&nbsp;to&nbsp;get&nbsp;a&nbsp;name&nbsp;that&nbsp;is&nbsp;unique</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137583">f</span><span class="op" id="8137584">,</span>&nbsp;<span class="ident" id="8137586">err</span>&nbsp;<span class="op" id="8137590">:=</span>&nbsp;<span class="ident" id="8137593">ioutil</span><span class="op" id="8137599">.</span><span class="ident" id="8137600">TempFile</span><span class="op" id="8137608">(</span><span class="string" id="8137609">&#34;&#34;</span><span class="op" id="8137611">,</span>&nbsp;<span class="string" id="8137613">&#34;syslogtest&#34;</span><span class="op" id="8137625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8137630">if</span>&nbsp;<span class="ident" id="8137633">err</span>&nbsp;<span class="op" id="8137637">!=</span>&nbsp;<span class="ident" id="8137640">nil</span>&nbsp;<span class="op" id="8137644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137650">log</span><span class="op" id="8137653">.</span><span class="ident" id="8137654">Fatal</span><span class="op" id="8137659">(</span><span class="string" id="8137660">&#34;TempFile:&nbsp;&#34;</span><span class="op" id="8137672">,</span>&nbsp;<span class="ident" id="8137674">err</span><span class="op" id="8137677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8137682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137687">f</span><span class="op" id="8137688">.</span><span class="ident" id="8137689">Close</span><span class="op" id="8137694">(</span><span class="op" id="8137695">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137700">la</span>&nbsp;<span class="op" id="8137703">=</span>&nbsp;<span class="ident" id="8137705">f</span><span class="op" id="8137706">.</span><span class="ident" id="8137707">Name</span><span class="op" id="8137711">(</span><span class="op" id="8137712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8137716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137720">os</span><span class="op" id="8137722">.</span><span class="ident" id="8137723">Remove</span><span class="op" id="8137729">(</span><span class="ident" id="8137730">la</span><span class="op" id="8137732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8137735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137739">wg</span>&nbsp;<span class="op" id="8137742">=</span>&nbsp;<span class="builtinfunc" id="8137744">new</span><span class="op" id="8137747">(</span><span class="ident" id="8137748">sync</span><span class="op" id="8137752">.</span><span class="ident" id="8137753">WaitGroup</span><span class="op" id="8137762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8137765">if</span>&nbsp;<span class="ident" id="8137768">n</span>&nbsp;<span class="op" id="8137770">==</span>&nbsp;<span class="string" id="8137773">&#34;udp&#34;</span>&nbsp;<span class="op" id="8137779">||</span>&nbsp;<span class="ident" id="8137782">n</span>&nbsp;<span class="op" id="8137784">==</span>&nbsp;<span class="string" id="8137787">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="8137798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137802">l</span><span class="op" id="8137803">,</span>&nbsp;<span class="ident" id="8137805">e</span>&nbsp;<span class="op" id="8137807">:=</span>&nbsp;<span class="ident" id="8137810">net</span><span class="op" id="8137813">.</span><span class="ident" id="8137814">ListenPacket</span><span class="op" id="8137826">(</span><span class="ident" id="8137827">n</span><span class="op" id="8137828">,</span>&nbsp;<span class="ident" id="8137830">la</span><span class="op" id="8137832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8137836">if</span>&nbsp;<span class="ident" id="8137839">e</span>&nbsp;<span class="op" id="8137841">!=</span>&nbsp;<span class="ident" id="8137844">nil</span>&nbsp;<span class="op" id="8137848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137853">log</span><span class="op" id="8137856">.</span><span class="ident" id="8137857">Fatalf</span><span class="op" id="8137863">(</span><span class="string" id="8137864">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8137888">,</span>&nbsp;<span class="ident" id="8137890">e</span><span class="op" id="8137891">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8137895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137899">addr</span>&nbsp;<span class="op" id="8137904">=</span>&nbsp;<span class="ident" id="8137906">l</span><span class="op" id="8137907">.</span><span class="ident" id="8137908">LocalAddr</span><span class="op" id="8137917">(</span><span class="op" id="8137918">)</span><span class="op" id="8137919">.</span><span class="ident" id="8137920">String</span><span class="op" id="8137926">(</span><span class="op" id="8137927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137931">sock</span>&nbsp;<span class="op" id="8137936">=</span>&nbsp;<span class="ident" id="8137938">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137942">wg</span><span class="op" id="8137944">.</span><span class="ident" id="8137945">Add</span><span class="op" id="8137948">(</span><span class="num" id="8137949">1</span><span class="op" id="8137950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8137954">go</span>&nbsp;<span class="keyword" id="8137957">func</span><span class="op" id="8137961">(</span><span class="op" id="8137962">)</span>&nbsp;<span class="op" id="8137964">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8137969">defer</span>&nbsp;<span class="ident" id="8137975">wg</span><span class="op" id="8137977">.</span><span class="ident" id="8137978">Done</span><span class="op" id="8137982">(</span><span class="op" id="8137983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8137988">runPktSyslog</span><span class="op" id="8138000">(</span><span class="ident" id="8138001">l</span><span class="op" id="8138002">,</span>&nbsp;<span class="ident" id="8138004">done</span><span class="op" id="8138008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8138012">}</span><span class="op" id="8138013">(</span><span class="op" id="8138014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8138017">}</span>&nbsp;<span class="keyword" id="8138019">else</span>&nbsp;<span class="op" id="8138024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138028">l</span><span class="op" id="8138029">,</span>&nbsp;<span class="ident" id="8138031">e</span>&nbsp;<span class="op" id="8138033">:=</span>&nbsp;<span class="ident" id="8138036">net</span><span class="op" id="8138039">.</span><span class="ident" id="8138040">Listen</span><span class="op" id="8138046">(</span><span class="ident" id="8138047">n</span><span class="op" id="8138048">,</span>&nbsp;<span class="ident" id="8138050">la</span><span class="op" id="8138052">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138056">if</span>&nbsp;<span class="ident" id="8138059">e</span>&nbsp;<span class="op" id="8138061">!=</span>&nbsp;<span class="ident" id="8138064">nil</span>&nbsp;<span class="op" id="8138068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138073">log</span><span class="op" id="8138076">.</span><span class="ident" id="8138077">Fatalf</span><span class="op" id="8138083">(</span><span class="string" id="8138084">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8138108">,</span>&nbsp;<span class="ident" id="8138110">e</span><span class="op" id="8138111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8138115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138119">addr</span>&nbsp;<span class="op" id="8138124">=</span>&nbsp;<span class="ident" id="8138126">l</span><span class="op" id="8138127">.</span><span class="ident" id="8138128">Addr</span><span class="op" id="8138132">(</span><span class="op" id="8138133">)</span><span class="op" id="8138134">.</span><span class="ident" id="8138135">String</span><span class="op" id="8138141">(</span><span class="op" id="8138142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138146">sock</span>&nbsp;<span class="op" id="8138151">=</span>&nbsp;<span class="ident" id="8138153">l</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138157">wg</span><span class="op" id="8138159">.</span><span class="ident" id="8138160">Add</span><span class="op" id="8138163">(</span><span class="num" id="8138164">1</span><span class="op" id="8138165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138169">go</span>&nbsp;<span class="keyword" id="8138172">func</span><span class="op" id="8138176">(</span><span class="op" id="8138177">)</span>&nbsp;<span class="op" id="8138179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138184">defer</span>&nbsp;<span class="ident" id="8138190">wg</span><span class="op" id="8138192">.</span><span class="ident" id="8138193">Done</span><span class="op" id="8138197">(</span><span class="op" id="8138198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138203">runStreamSyslog</span><span class="op" id="8138218">(</span><span class="ident" id="8138219">l</span><span class="op" id="8138220">,</span>&nbsp;<span class="ident" id="8138222">done</span><span class="op" id="8138226">,</span>&nbsp;<span class="ident" id="8138228">wg</span><span class="op" id="8138230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8138234">}</span><span class="op" id="8138235">(</span><span class="op" id="8138236">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8138239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138242">return</span><br>
<span class="lineno"></span><span class="op" id="8138249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8138252">func</span>&nbsp;<span class="ident" id="8138257">TestWithSimulated</span><span class="op" id="8138274">(</span><span class="ident" id="8138275">t</span>&nbsp;<span class="op" id="8138277">*</span><span class="ident" id="8138278">testing</span><span class="op" id="8138285">.</span><span class="ident" id="8138286">T</span><span class="op" id="8138287">)</span>&nbsp;<span class="op" id="8138289">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138292">msg</span>&nbsp;<span class="op" id="8138296">:=</span>&nbsp;<span class="string" id="8138299">&#34;Test&nbsp;123&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138311">transport</span>&nbsp;<span class="op" id="8138321">:=</span>&nbsp;<span class="op" id="8138324">[</span><span class="op" id="8138325">]</span><span class="builtintype" id="8138326">string</span><span class="op" id="8138332">{</span><span class="string" id="8138333">&#34;unix&#34;</span><span class="op" id="8138339">,</span>&nbsp;<span class="string" id="8138341">&#34;unixgram&#34;</span><span class="op" id="8138351">,</span>&nbsp;<span class="string" id="8138353">&#34;udp&#34;</span><span class="op" id="8138358">,</span>&nbsp;<span class="string" id="8138360">&#34;tcp&#34;</span><span class="op" id="8138365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138369">for</span>&nbsp;<span class="ident" id="8138373">_</span><span class="op" id="8138374">,</span>&nbsp;<span class="ident" id="8138376">tr</span>&nbsp;<span class="op" id="8138379">:=</span>&nbsp;<span class="keyword" id="8138382">range</span>&nbsp;<span class="ident" id="8138388">transport</span>&nbsp;<span class="op" id="8138398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138402">done</span>&nbsp;<span class="op" id="8138407">:=</span>&nbsp;<span class="builtinfunc" id="8138410">make</span><span class="op" id="8138414">(</span><span class="keyword" id="8138415">chan</span>&nbsp;<span class="builtintype" id="8138420">string</span><span class="op" id="8138426">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138430">addr</span><span class="op" id="8138434">,</span>&nbsp;<span class="ident" id="8138436">sock</span><span class="op" id="8138440">,</span>&nbsp;<span class="ident" id="8138442">srvWG</span>&nbsp;<span class="op" id="8138448">:=</span>&nbsp;<span class="ident" id="8138451">startServer</span><span class="op" id="8138462">(</span><span class="ident" id="8138463">tr</span><span class="op" id="8138465">,</span>&nbsp;<span class="string" id="8138467">&#34;&#34;</span><span class="op" id="8138469">,</span>&nbsp;<span class="ident" id="8138471">done</span><span class="op" id="8138475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138479">defer</span>&nbsp;<span class="ident" id="8138485">srvWG</span><span class="op" id="8138490">.</span><span class="ident" id="8138491">Wait</span><span class="op" id="8138495">(</span><span class="op" id="8138496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138500">defer</span>&nbsp;<span class="ident" id="8138506">sock</span><span class="op" id="8138510">.</span><span class="ident" id="8138511">Close</span><span class="op" id="8138516">(</span><span class="op" id="8138517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138521">if</span>&nbsp;<span class="ident" id="8138524">tr</span>&nbsp;<span class="op" id="8138527">==</span>&nbsp;<span class="string" id="8138530">&#34;unix&#34;</span>&nbsp;<span class="op" id="8138537">||</span>&nbsp;<span class="ident" id="8138540">tr</span>&nbsp;<span class="op" id="8138543">==</span>&nbsp;<span class="string" id="8138546">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="8138557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138562">defer</span>&nbsp;<span class="ident" id="8138568">os</span><span class="op" id="8138570">.</span><span class="ident" id="8138571">Remove</span><span class="op" id="8138577">(</span><span class="ident" id="8138578">addr</span><span class="op" id="8138582">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8138586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138590">s</span><span class="op" id="8138591">,</span>&nbsp;<span class="ident" id="8138593">err</span>&nbsp;<span class="op" id="8138597">:=</span>&nbsp;<span class="ident" id="8138600">Dial</span><span class="op" id="8138604">(</span><span class="ident" id="8138605">tr</span><span class="op" id="8138607">,</span>&nbsp;<span class="ident" id="8138609">addr</span><span class="op" id="8138613">,</span>&nbsp;<span class="ident" id="8138615">LOG_INFO</span><span class="op" id="8138623">|</span><span class="ident" id="8138624">LOG_USER</span><span class="op" id="8138632">,</span>&nbsp;<span class="string" id="8138634">&#34;syslog_test&#34;</span><span class="op" id="8138647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138651">if</span>&nbsp;<span class="ident" id="8138654">err</span>&nbsp;<span class="op" id="8138658">!=</span>&nbsp;<span class="ident" id="8138661">nil</span>&nbsp;<span class="op" id="8138665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138670">t</span><span class="op" id="8138671">.</span><span class="ident" id="8138672">Fatalf</span><span class="op" id="8138678">(</span><span class="string" id="8138679">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8138698">,</span>&nbsp;<span class="ident" id="8138700">err</span><span class="op" id="8138703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8138707">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138711">err</span>&nbsp;<span class="op" id="8138715">=</span>&nbsp;<span class="ident" id="8138717">s</span><span class="op" id="8138718">.</span><span class="ident" id="8138719">Info</span><span class="op" id="8138723">(</span><span class="ident" id="8138724">msg</span><span class="op" id="8138727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138731">if</span>&nbsp;<span class="ident" id="8138734">err</span>&nbsp;<span class="op" id="8138738">!=</span>&nbsp;<span class="ident" id="8138741">nil</span>&nbsp;<span class="op" id="8138745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138750">t</span><span class="op" id="8138751">.</span><span class="ident" id="8138752">Fatalf</span><span class="op" id="8138758">(</span><span class="string" id="8138759">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8138775">,</span>&nbsp;<span class="ident" id="8138777">err</span><span class="op" id="8138780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8138784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138788">check</span><span class="op" id="8138793">(</span><span class="ident" id="8138794">t</span><span class="op" id="8138795">,</span>&nbsp;<span class="ident" id="8138797">msg</span><span class="op" id="8138800">,</span>&nbsp;<span class="op" id="8138802">&lt;-</span><span class="ident" id="8138804">done</span><span class="op" id="8138808">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138812">s</span><span class="op" id="8138813">.</span><span class="ident" id="8138814">Close</span><span class="op" id="8138819">(</span><span class="op" id="8138820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8138823">}</span><br>
<span class="lineno"></span><span class="op" id="8138825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8138828">func</span>&nbsp;<span class="ident" id="8138833">TestFlap</span><span class="op" id="8138841">(</span><span class="ident" id="8138842">t</span>&nbsp;<span class="op" id="8138844">*</span><span class="ident" id="8138845">testing</span><span class="op" id="8138852">.</span><span class="ident" id="8138853">T</span><span class="op" id="8138854">)</span>&nbsp;<span class="op" id="8138856">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138859">net</span>&nbsp;<span class="op" id="8138863">:=</span>&nbsp;<span class="string" id="8138866">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138874">done</span>&nbsp;<span class="op" id="8138879">:=</span>&nbsp;<span class="builtinfunc" id="8138882">make</span><span class="op" id="8138886">(</span><span class="keyword" id="8138887">chan</span>&nbsp;<span class="builtintype" id="8138892">string</span><span class="op" id="8138898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8138901">addr</span><span class="op" id="8138905">,</span>&nbsp;<span class="ident" id="8138907">sock</span><span class="op" id="8138911">,</span>&nbsp;<span class="ident" id="8138913">srvWG</span>&nbsp;<span class="op" id="8138919">:=</span>&nbsp;<span class="ident" id="8138922">startServer</span><span class="op" id="8138933">(</span><span class="ident" id="8138934">net</span><span class="op" id="8138937">,</span>&nbsp;<span class="string" id="8138939">&#34;&#34;</span><span class="op" id="8138941">,</span>&nbsp;<span class="ident" id="8138943">done</span><span class="op" id="8138947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138950">defer</span>&nbsp;<span class="ident" id="8138956">srvWG</span><span class="op" id="8138961">.</span><span class="ident" id="8138962">Wait</span><span class="op" id="8138966">(</span><span class="op" id="8138967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138970">defer</span>&nbsp;<span class="ident" id="8138976">os</span><span class="op" id="8138978">.</span><span class="ident" id="8138979">Remove</span><span class="op" id="8138985">(</span><span class="ident" id="8138986">addr</span><span class="op" id="8138990">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8138993">defer</span>&nbsp;<span class="ident" id="8138999">sock</span><span class="op" id="8139003">.</span><span class="ident" id="8139004">Close</span><span class="op" id="8139009">(</span><span class="op" id="8139010">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139014">s</span><span class="op" id="8139015">,</span>&nbsp;<span class="ident" id="8139017">err</span>&nbsp;<span class="op" id="8139021">:=</span>&nbsp;<span class="ident" id="8139024">Dial</span><span class="op" id="8139028">(</span><span class="ident" id="8139029">net</span><span class="op" id="8139032">,</span>&nbsp;<span class="ident" id="8139034">addr</span><span class="op" id="8139038">,</span>&nbsp;<span class="ident" id="8139040">LOG_INFO</span><span class="op" id="8139048">|</span><span class="ident" id="8139049">LOG_USER</span><span class="op" id="8139057">,</span>&nbsp;<span class="string" id="8139059">&#34;syslog_test&#34;</span><span class="op" id="8139072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8139075">if</span>&nbsp;<span class="ident" id="8139078">err</span>&nbsp;<span class="op" id="8139082">!=</span>&nbsp;<span class="ident" id="8139085">nil</span>&nbsp;<span class="op" id="8139089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139093">t</span><span class="op" id="8139094">.</span><span class="ident" id="8139095">Fatalf</span><span class="op" id="8139101">(</span><span class="string" id="8139102">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8139121">,</span>&nbsp;<span class="ident" id="8139123">err</span><span class="op" id="8139126">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8139129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139132">msg</span>&nbsp;<span class="op" id="8139136">:=</span>&nbsp;<span class="string" id="8139139">&#34;Moo&nbsp;2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139148">err</span>&nbsp;<span class="op" id="8139152">=</span>&nbsp;<span class="ident" id="8139154">s</span><span class="op" id="8139155">.</span><span class="ident" id="8139156">Info</span><span class="op" id="8139160">(</span><span class="ident" id="8139161">msg</span><span class="op" id="8139164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8139167">if</span>&nbsp;<span class="ident" id="8139170">err</span>&nbsp;<span class="op" id="8139174">!=</span>&nbsp;<span class="ident" id="8139177">nil</span>&nbsp;<span class="op" id="8139181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139185">t</span><span class="op" id="8139186">.</span><span class="ident" id="8139187">Fatalf</span><span class="op" id="8139193">(</span><span class="string" id="8139194">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8139210">,</span>&nbsp;<span class="ident" id="8139212">err</span><span class="op" id="8139215">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8139218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139221">check</span><span class="op" id="8139226">(</span><span class="ident" id="8139227">t</span><span class="op" id="8139228">,</span>&nbsp;<span class="ident" id="8139230">msg</span><span class="op" id="8139233">,</span>&nbsp;<span class="op" id="8139235">&lt;-</span><span class="ident" id="8139237">done</span><span class="op" id="8139241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8139245">//&nbsp;restart&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139268">_</span><span class="op" id="8139269">,</span>&nbsp;<span class="ident" id="8139271">sock2</span><span class="op" id="8139276">,</span>&nbsp;<span class="ident" id="8139278">srvWG2</span>&nbsp;<span class="op" id="8139285">:=</span>&nbsp;<span class="ident" id="8139288">startServer</span><span class="op" id="8139299">(</span><span class="ident" id="8139300">net</span><span class="op" id="8139303">,</span>&nbsp;<span class="ident" id="8139305">addr</span><span class="op" id="8139309">,</span>&nbsp;<span class="ident" id="8139311">done</span><span class="op" id="8139315">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8139318">defer</span>&nbsp;<span class="ident" id="8139324">srvWG2</span><span class="op" id="8139330">.</span><span class="ident" id="8139331">Wait</span><span class="op" id="8139335">(</span><span class="op" id="8139336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8139339">defer</span>&nbsp;<span class="ident" id="8139345">sock2</span><span class="op" id="8139350">.</span><span class="ident" id="8139351">Close</span><span class="op" id="8139356">(</span><span class="op" id="8139357">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8139361">//&nbsp;and&nbsp;try&nbsp;retransmitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139388">msg</span>&nbsp;<span class="op" id="8139392">=</span>&nbsp;<span class="string" id="8139394">&#34;Moo&nbsp;3&#34;</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139403">err</span>&nbsp;<span class="op" id="8139407">=</span>&nbsp;<span class="ident" id="8139409">s</span><span class="op" id="8139410">.</span><span class="ident" id="8139411">Info</span><span class="op" id="8139415">(</span><span class="ident" id="8139416">msg</span><span class="op" id="8139419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8139422">if</span>&nbsp;<span class="ident" id="8139425">err</span>&nbsp;<span class="op" id="8139429">!=</span>&nbsp;<span class="ident" id="8139432">nil</span>&nbsp;<span class="op" id="8139436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139440">t</span><span class="op" id="8139441">.</span><span class="ident" id="8139442">Fatalf</span><span class="op" id="8139448">(</span><span class="string" id="8139449">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8139465">,</span>&nbsp;<span class="ident" id="8139467">err</span><span class="op" id="8139470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8139473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139476">check</span><span class="op" id="8139481">(</span><span class="ident" id="8139482">t</span><span class="op" id="8139483">,</span>&nbsp;<span class="ident" id="8139485">msg</span><span class="op" id="8139488">,</span>&nbsp;<span class="op" id="8139490">&lt;-</span><span class="ident" id="8139492">done</span><span class="op" id="8139496">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139500">s</span><span class="op" id="8139501">.</span><span class="ident" id="8139502">Close</span><span class="op" id="8139507">(</span><span class="op" id="8139508">)</span><br>
<span class="lineno"></span><span class="op" id="8139510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8139513">func</span>&nbsp;<span class="ident" id="8139518">TestNew</span><span class="op" id="8139525">(</span><span class="ident" id="8139526">t</span>&nbsp;<span class="op" id="8139528">*</span><span class="ident" id="8139529">testing</span><span class="op" id="8139536">.</span><span class="ident" id="8139537">T</span><span class="op" id="8139538">)</span>&nbsp;<span class="op" id="8139540">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8139543">if</span>&nbsp;<span class="ident" id="8139546">LOG_LOCAL7</span>&nbsp;<span class="op" id="8139557">!=</span>&nbsp;<span class="num" id="8139560">23</span><span class="op" id="8139562">&lt;&lt;</span><span class="num" id="8139564">3</span>&nbsp;<span class="op" id="8139566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139570">t</span><span class="op" id="8139571">.</span><span class="ident" id="8139572">Fatalf</span><span class="op" id="8139578">(</span><span class="string" id="8139579">&#34;LOG_LOCAL7&nbsp;has&nbsp;wrong&nbsp;value&#34;</span><span class="op" id="8139607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8139610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8139613">if</span>&nbsp;<span class="ident" id="8139616">testing</span><span class="op" id="8139623">.</span><span class="ident" id="8139624">Short</span><span class="op" id="8139629">(</span><span class="op" id="8139630">)</span>&nbsp;<span class="op" id="8139632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8139636">//&nbsp;Depends&nbsp;on&nbsp;syslog&nbsp;daemon&nbsp;running,&nbsp;and&nbsp;sometimes&nbsp;it&#39;s&nbsp;not.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139699">t</span><span class="op" id="8139700">.</span><span class="ident" id="8139701">Skip</span><span class="op" id="8139705">(</span><span class="string" id="8139706">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="8139742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8139745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139749">s</span><span class="op" id="8139750">,</span>&nbsp;<span class="ident" id="8139752">err</span>&nbsp;<span class="op" id="8139756">:=</span>&nbsp;<span class="ident" id="8139759">New</span><span class="op" id="8139762">(</span><span class="ident" id="8139763">LOG_INFO</span><span class="op" id="8139771">|</span><span class="ident" id="8139772">LOG_USER</span><span class="op" id="8139780">,</span>&nbsp;<span class="string" id="8139782">&#34;the_tag&#34;</span><span class="op" id="8139791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8139794">if</span>&nbsp;<span class="ident" id="8139797">err</span>&nbsp;<span class="op" id="8139801">!=</span>&nbsp;<span class="ident" id="8139804">nil</span>&nbsp;<span class="op" id="8139808">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139812">t</span><span class="op" id="8139813">.</span><span class="ident" id="8139814">Fatalf</span><span class="op" id="8139820">(</span><span class="string" id="8139821">&#34;New()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8139839">,</span>&nbsp;<span class="ident" id="8139841">err</span><span class="op" id="8139844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8139847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8139850">//&nbsp;Don&#39;t&nbsp;send&nbsp;any&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139879">s</span><span class="op" id="8139880">.</span><span class="ident" id="8139881">Close</span><span class="op" id="8139886">(</span><span class="op" id="8139887">)</span><br>
<span class="lineno"></span><span class="op" id="8139889">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="8139892">func</span>&nbsp;<span class="ident" id="8139897">TestNewLogger</span><span class="op" id="8139910">(</span><span class="ident" id="8139911">t</span>&nbsp;<span class="op" id="8139913">*</span><span class="ident" id="8139914">testing</span><span class="op" id="8139921">.</span><span class="ident" id="8139922">T</span><span class="op" id="8139923">)</span>&nbsp;<span class="op" id="8139925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8139928">if</span>&nbsp;<span class="ident" id="8139931">testing</span><span class="op" id="8139938">.</span><span class="ident" id="8139939">Short</span><span class="op" id="8139944">(</span><span class="op" id="8139945">)</span>&nbsp;<span class="op" id="8139947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8139951">t</span><span class="op" id="8139952">.</span><span class="ident" id="8139953">Skip</span><span class="op" id="8139957">(</span><span class="string" id="8139958">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="8139994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8139997">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140000">f</span><span class="op" id="8140001">,</span>&nbsp;<span class="ident" id="8140003">err</span>&nbsp;<span class="op" id="8140007">:=</span>&nbsp;<span class="ident" id="8140010">NewLogger</span><span class="op" id="8140019">(</span><span class="ident" id="8140020">LOG_USER</span><span class="op" id="8140028">|</span><span class="ident" id="8140029">LOG_INFO</span><span class="op" id="8140037">,</span>&nbsp;<span class="num" id="8140039">0</span><span class="op" id="8140040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8140043">if</span>&nbsp;<span class="ident" id="8140046">f</span>&nbsp;<span class="op" id="8140048">==</span>&nbsp;<span class="ident" id="8140051">nil</span>&nbsp;<span class="op" id="8140055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140059">t</span><span class="op" id="8140060">.</span><span class="ident" id="8140061">Error</span><span class="op" id="8140066">(</span><span class="ident" id="8140067">err</span><span class="op" id="8140070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8140073">}</span><br>
<span class="lineno"></span><span class="op" id="8140075">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="8140078">func</span>&nbsp;<span class="ident" id="8140083">TestDial</span><span class="op" id="8140091">(</span><span class="ident" id="8140092">t</span>&nbsp;<span class="op" id="8140094">*</span><span class="ident" id="8140095">testing</span><span class="op" id="8140102">.</span><span class="ident" id="8140103">T</span><span class="op" id="8140104">)</span>&nbsp;<span class="op" id="8140106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8140109">if</span>&nbsp;<span class="ident" id="8140112">testing</span><span class="op" id="8140119">.</span><span class="ident" id="8140120">Short</span><span class="op" id="8140125">(</span><span class="op" id="8140126">)</span>&nbsp;<span class="op" id="8140128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140132">t</span><span class="op" id="8140133">.</span><span class="ident" id="8140134">Skip</span><span class="op" id="8140138">(</span><span class="string" id="8140139">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="8140175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8140178">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140181">f</span><span class="op" id="8140182">,</span>&nbsp;<span class="ident" id="8140184">err</span>&nbsp;<span class="op" id="8140188">:=</span>&nbsp;<span class="ident" id="8140191">Dial</span><span class="op" id="8140195">(</span><span class="string" id="8140196">&#34;&#34;</span><span class="op" id="8140198">,</span>&nbsp;<span class="string" id="8140200">&#34;&#34;</span><span class="op" id="8140202">,</span>&nbsp;<span class="op" id="8140204">(</span><span class="ident" id="8140205">LOG_LOCAL7</span><span class="op" id="8140215">|</span><span class="ident" id="8140216">LOG_DEBUG</span><span class="op" id="8140225">)</span><span class="op" id="8140226">+</span><span class="num" id="8140227">1</span><span class="op" id="8140228">,</span>&nbsp;<span class="string" id="8140230">&#34;syslog_test&#34;</span><span class="op" id="8140243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8140246">if</span>&nbsp;<span class="ident" id="8140249">f</span>&nbsp;<span class="op" id="8140251">!=</span>&nbsp;<span class="ident" id="8140254">nil</span>&nbsp;<span class="op" id="8140258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140262">t</span><span class="op" id="8140263">.</span><span class="ident" id="8140264">Fatalf</span><span class="op" id="8140270">(</span><span class="string" id="8140271">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="8140305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8140308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140311">f</span><span class="op" id="8140312">,</span>&nbsp;<span class="ident" id="8140314">err</span>&nbsp;<span class="op" id="8140318">=</span>&nbsp;<span class="ident" id="8140320">Dial</span><span class="op" id="8140324">(</span><span class="string" id="8140325">&#34;&#34;</span><span class="op" id="8140327">,</span>&nbsp;<span class="string" id="8140329">&#34;&#34;</span><span class="op" id="8140331">,</span>&nbsp;<span class="op" id="8140333">-</span><span class="num" id="8140334">1</span><span class="op" id="8140335">,</span>&nbsp;<span class="string" id="8140337">&#34;syslog_test&#34;</span><span class="op" id="8140350">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8140353">if</span>&nbsp;<span class="ident" id="8140356">f</span>&nbsp;<span class="op" id="8140358">!=</span>&nbsp;<span class="ident" id="8140361">nil</span>&nbsp;<span class="op" id="8140365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140369">t</span><span class="op" id="8140370">.</span><span class="ident" id="8140371">Fatalf</span><span class="op" id="8140377">(</span><span class="string" id="8140378">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="8140412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8140415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140418">l</span><span class="op" id="8140419">,</span>&nbsp;<span class="ident" id="8140421">err</span>&nbsp;<span class="op" id="8140425">:=</span>&nbsp;<span class="ident" id="8140428">Dial</span><span class="op" id="8140432">(</span><span class="string" id="8140433">&#34;&#34;</span><span class="op" id="8140435">,</span>&nbsp;<span class="string" id="8140437">&#34;&#34;</span><span class="op" id="8140439">,</span>&nbsp;<span class="ident" id="8140441">LOG_USER</span><span class="op" id="8140449">|</span><span class="ident" id="8140450">LOG_ERR</span><span class="op" id="8140457">,</span>&nbsp;<span class="string" id="8140459">&#34;syslog_test&#34;</span><span class="op" id="8140472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8140475">if</span>&nbsp;<span class="ident" id="8140478">err</span>&nbsp;<span class="op" id="8140482">!=</span>&nbsp;<span class="ident" id="8140485">nil</span>&nbsp;<span class="op" id="8140489">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140493">t</span><span class="op" id="8140494">.</span><span class="ident" id="8140495">Fatalf</span><span class="op" id="8140501">(</span><span class="string" id="8140502">&#34;Dial()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8140521">,</span>&nbsp;<span class="ident" id="8140523">err</span><span class="op" id="8140526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8140529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140532">l</span><span class="op" id="8140533">.</span><span class="ident" id="8140534">Close</span><span class="op" id="8140539">(</span><span class="op" id="8140540">)</span><br>
<span class="lineno"></span><span class="op" id="8140542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="8140545">func</span>&nbsp;<span class="ident" id="8140550">check</span><span class="op" id="8140555">(</span><span class="ident" id="8140556">t</span>&nbsp;<span class="op" id="8140558">*</span><span class="ident" id="8140559">testing</span><span class="op" id="8140566">.</span><span class="ident" id="8140567">T</span><span class="op" id="8140568">,</span>&nbsp;<span class="ident" id="8140570">in</span><span class="op" id="8140572">,</span>&nbsp;<span class="ident" id="8140574">out</span>&nbsp;<span class="builtintype" id="8140578">string</span><span class="op" id="8140584">)</span>&nbsp;<span class="op" id="8140586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140589">tmpl</span>&nbsp;<span class="op" id="8140594">:=</span>&nbsp;<span class="ident" id="8140597">fmt</span><span class="op" id="8140600">.</span><span class="ident" id="8140601">Sprintf</span><span class="op" id="8140608">(</span><span class="string" id="8140609">&#34;&lt;%d&gt;%%s&nbsp;%%s&nbsp;syslog_test[%%d]:&nbsp;%s\n&#34;</span><span class="op" id="8140645">,</span>&nbsp;<span class="ident" id="8140647">LOG_USER</span><span class="op" id="8140655">+</span><span class="ident" id="8140656">LOG_INFO</span><span class="op" id="8140664">,</span>&nbsp;<span class="ident" id="8140666">in</span><span class="op" id="8140668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8140671">if</span>&nbsp;<span class="ident" id="8140674">hostname</span><span class="op" id="8140682">,</span>&nbsp;<span class="ident" id="8140684">err</span>&nbsp;<span class="op" id="8140688">:=</span>&nbsp;<span class="ident" id="8140691">os</span><span class="op" id="8140693">.</span><span class="ident" id="8140694">Hostname</span><span class="op" id="8140702">(</span><span class="op" id="8140703">)</span><span class="op" id="8140704">;</span>&nbsp;<span class="ident" id="8140706">err</span>&nbsp;<span class="op" id="8140710">!=</span>&nbsp;<span class="ident" id="8140713">nil</span>&nbsp;<span class="op" id="8140717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140721">t</span><span class="op" id="8140722">.</span><span class="ident" id="8140723">Error</span><span class="op" id="8140728">(</span><span class="string" id="8140729">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="8140756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8140759">}</span>&nbsp;<span class="keyword" id="8140761">else</span>&nbsp;<span class="op" id="8140766">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8140770">var</span>&nbsp;<span class="ident" id="8140774">parsedHostname</span><span class="op" id="8140788">,</span>&nbsp;<span class="ident" id="8140790">timestamp</span>&nbsp;<span class="builtintype" id="8140800">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8140809">var</span>&nbsp;<span class="ident" id="8140813">pid</span>&nbsp;<span class="builtintype" id="8140817">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8140823">if</span>&nbsp;<span class="ident" id="8140826">n</span><span class="op" id="8140827">,</span>&nbsp;<span class="ident" id="8140829">err</span>&nbsp;<span class="op" id="8140833">:=</span>&nbsp;<span class="ident" id="8140836">fmt</span><span class="op" id="8140839">.</span><span class="ident" id="8140840">Sscanf</span><span class="op" id="8140846">(</span><span class="ident" id="8140847">out</span><span class="op" id="8140850">,</span>&nbsp;<span class="ident" id="8140852">tmpl</span><span class="op" id="8140856">,</span>&nbsp;<span class="op" id="8140858">&amp;</span><span class="ident" id="8140859">timestamp</span><span class="op" id="8140868">,</span>&nbsp;<span class="op" id="8140870">&amp;</span><span class="ident" id="8140871">parsedHostname</span><span class="op" id="8140885">,</span>&nbsp;<span class="op" id="8140887">&amp;</span><span class="ident" id="8140888">pid</span><span class="op" id="8140891">)</span><span class="op" id="8140892">;</span>&nbsp;<span class="ident" id="8140894">n</span>&nbsp;<span class="op" id="8140896">!=</span>&nbsp;<span class="num" id="8140899">3</span>&nbsp;<span class="op" id="8140901">||</span>&nbsp;<span class="ident" id="8140904">err</span>&nbsp;<span class="op" id="8140908">!=</span>&nbsp;<span class="ident" id="8140911">nil</span>&nbsp;<span class="op" id="8140915">||</span>&nbsp;<span class="ident" id="8140918">hostname</span>&nbsp;<span class="op" id="8140927">!=</span>&nbsp;<span class="ident" id="8140930">parsedHostname</span>&nbsp;<span class="op" id="8140945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8140950">t</span><span class="op" id="8140951">.</span><span class="ident" id="8140952">Errorf</span><span class="op" id="8140958">(</span><span class="string" id="8140959">&#34;Got&nbsp;%q,&nbsp;does&nbsp;not&nbsp;match&nbsp;template&nbsp;%q&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="8141003">,</span>&nbsp;<span class="ident" id="8141005">out</span><span class="op" id="8141008">,</span>&nbsp;<span class="ident" id="8141010">tmpl</span><span class="op" id="8141014">,</span>&nbsp;<span class="ident" id="8141016">n</span><span class="op" id="8141017">,</span>&nbsp;<span class="ident" id="8141019">err</span><span class="op" id="8141022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8141026">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8141029">}</span><br>
<span class="lineno"></span><span class="op" id="8141031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8141034">func</span>&nbsp;<span class="ident" id="8141039">TestWrite</span><span class="op" id="8141048">(</span><span class="ident" id="8141049">t</span>&nbsp;<span class="op" id="8141051">*</span><span class="ident" id="8141052">testing</span><span class="op" id="8141059">.</span><span class="ident" id="8141060">T</span><span class="op" id="8141061">)</span>&nbsp;<span class="op" id="8141063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141066">tests</span>&nbsp;<span class="op" id="8141072">:=</span>&nbsp;<span class="op" id="8141075">[</span><span class="op" id="8141076">]</span><span class="keyword" id="8141077">struct</span>&nbsp;<span class="op" id="8141084">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141088">pri</span>&nbsp;<span class="ident" id="8141092">Priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141103">pre</span>&nbsp;<span class="builtintype" id="8141107">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141116">msg</span>&nbsp;<span class="builtintype" id="8141120">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141129">exp</span>&nbsp;<span class="builtintype" id="8141133">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8141141">}</span><span class="op" id="8141142">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8141146">{</span><span class="ident" id="8141147">LOG_USER</span>&nbsp;<span class="op" id="8141156">|</span>&nbsp;<span class="ident" id="8141158">LOG_ERR</span><span class="op" id="8141165">,</span>&nbsp;<span class="string" id="8141167">&#34;syslog_test&#34;</span><span class="op" id="8141180">,</span>&nbsp;<span class="string" id="8141182">&#34;&#34;</span><span class="op" id="8141184">,</span>&nbsp;<span class="string" id="8141186">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;\n&#34;</span><span class="op" id="8141213">}</span><span class="op" id="8141214">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8141218">{</span><span class="ident" id="8141219">LOG_USER</span>&nbsp;<span class="op" id="8141228">|</span>&nbsp;<span class="ident" id="8141230">LOG_ERR</span><span class="op" id="8141237">,</span>&nbsp;<span class="string" id="8141239">&#34;syslog_test&#34;</span><span class="op" id="8141252">,</span>&nbsp;<span class="string" id="8141254">&#34;write&nbsp;test&#34;</span><span class="op" id="8141266">,</span>&nbsp;<span class="string" id="8141268">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test\n&#34;</span><span class="op" id="8141305">}</span><span class="op" id="8141306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8141310">//&nbsp;Write&nbsp;should&nbsp;not&nbsp;add&nbsp;\n&nbsp;if&nbsp;there&nbsp;already&nbsp;is&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8141363">{</span><span class="ident" id="8141364">LOG_USER</span>&nbsp;<span class="op" id="8141373">|</span>&nbsp;<span class="ident" id="8141375">LOG_ERR</span><span class="op" id="8141382">,</span>&nbsp;<span class="string" id="8141384">&#34;syslog_test&#34;</span><span class="op" id="8141397">,</span>&nbsp;<span class="string" id="8141399">&#34;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="8141415">,</span>&nbsp;<span class="string" id="8141417">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="8141456">}</span><span class="op" id="8141457">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8141460">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8141464">if</span>&nbsp;<span class="ident" id="8141467">hostname</span><span class="op" id="8141475">,</span>&nbsp;<span class="ident" id="8141477">err</span>&nbsp;<span class="op" id="8141481">:=</span>&nbsp;<span class="ident" id="8141484">os</span><span class="op" id="8141486">.</span><span class="ident" id="8141487">Hostname</span><span class="op" id="8141495">(</span><span class="op" id="8141496">)</span><span class="op" id="8141497">;</span>&nbsp;<span class="ident" id="8141499">err</span>&nbsp;<span class="op" id="8141503">!=</span>&nbsp;<span class="ident" id="8141506">nil</span>&nbsp;<span class="op" id="8141510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141514">t</span><span class="op" id="8141515">.</span><span class="ident" id="8141516">Fatalf</span><span class="op" id="8141522">(</span><span class="string" id="8141523">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="8141550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8141553">}</span>&nbsp;<span class="keyword" id="8141555">else</span>&nbsp;<span class="op" id="8141560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8141564">for</span>&nbsp;<span class="ident" id="8141568">_</span><span class="op" id="8141569">,</span>&nbsp;<span class="ident" id="8141571">test</span>&nbsp;<span class="op" id="8141576">:=</span>&nbsp;<span class="keyword" id="8141579">range</span>&nbsp;<span class="ident" id="8141585">tests</span>&nbsp;<span class="op" id="8141591">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141596">done</span>&nbsp;<span class="op" id="8141601">:=</span>&nbsp;<span class="builtinfunc" id="8141604">make</span><span class="op" id="8141608">(</span><span class="keyword" id="8141609">chan</span>&nbsp;<span class="builtintype" id="8141614">string</span><span class="op" id="8141620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141625">addr</span><span class="op" id="8141629">,</span>&nbsp;<span class="ident" id="8141631">sock</span><span class="op" id="8141635">,</span>&nbsp;<span class="ident" id="8141637">srvWG</span>&nbsp;<span class="op" id="8141643">:=</span>&nbsp;<span class="ident" id="8141646">startServer</span><span class="op" id="8141657">(</span><span class="string" id="8141658">&#34;udp&#34;</span><span class="op" id="8141663">,</span>&nbsp;<span class="string" id="8141665">&#34;&#34;</span><span class="op" id="8141667">,</span>&nbsp;<span class="ident" id="8141669">done</span><span class="op" id="8141673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8141678">defer</span>&nbsp;<span class="ident" id="8141684">srvWG</span><span class="op" id="8141689">.</span><span class="ident" id="8141690">Wait</span><span class="op" id="8141694">(</span><span class="op" id="8141695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8141700">defer</span>&nbsp;<span class="ident" id="8141706">sock</span><span class="op" id="8141710">.</span><span class="ident" id="8141711">Close</span><span class="op" id="8141716">(</span><span class="op" id="8141717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141722">l</span><span class="op" id="8141723">,</span>&nbsp;<span class="ident" id="8141725">err</span>&nbsp;<span class="op" id="8141729">:=</span>&nbsp;<span class="ident" id="8141732">Dial</span><span class="op" id="8141736">(</span><span class="string" id="8141737">&#34;udp&#34;</span><span class="op" id="8141742">,</span>&nbsp;<span class="ident" id="8141744">addr</span><span class="op" id="8141748">,</span>&nbsp;<span class="ident" id="8141750">test</span><span class="op" id="8141754">.</span><span class="ident" id="8141755">pri</span><span class="op" id="8141758">,</span>&nbsp;<span class="ident" id="8141760">test</span><span class="op" id="8141764">.</span><span class="ident" id="8141765">pre</span><span class="op" id="8141768">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8141773">if</span>&nbsp;<span class="ident" id="8141776">err</span>&nbsp;<span class="op" id="8141780">!=</span>&nbsp;<span class="ident" id="8141783">nil</span>&nbsp;<span class="op" id="8141787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141793">t</span><span class="op" id="8141794">.</span><span class="ident" id="8141795">Fatalf</span><span class="op" id="8141801">(</span><span class="string" id="8141802">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8141828">,</span>&nbsp;<span class="ident" id="8141830">err</span><span class="op" id="8141833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8141838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8141843">defer</span>&nbsp;<span class="ident" id="8141849">l</span><span class="op" id="8141850">.</span><span class="ident" id="8141851">Close</span><span class="op" id="8141856">(</span><span class="op" id="8141857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141862">_</span><span class="op" id="8141863">,</span>&nbsp;<span class="ident" id="8141865">err</span>&nbsp;<span class="op" id="8141869">=</span>&nbsp;<span class="ident" id="8141871">io</span><span class="op" id="8141873">.</span><span class="ident" id="8141874">WriteString</span><span class="op" id="8141885">(</span><span class="ident" id="8141886">l</span><span class="op" id="8141887">,</span>&nbsp;<span class="ident" id="8141889">test</span><span class="op" id="8141893">.</span><span class="ident" id="8141894">msg</span><span class="op" id="8141897">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8141902">if</span>&nbsp;<span class="ident" id="8141905">err</span>&nbsp;<span class="op" id="8141909">!=</span>&nbsp;<span class="ident" id="8141912">nil</span>&nbsp;<span class="op" id="8141916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141922">t</span><span class="op" id="8141923">.</span><span class="ident" id="8141924">Fatalf</span><span class="op" id="8141930">(</span><span class="string" id="8141931">&#34;WriteString()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8141957">,</span>&nbsp;<span class="ident" id="8141959">err</span><span class="op" id="8141962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8141967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141972">rcvd</span>&nbsp;<span class="op" id="8141977">:=</span>&nbsp;<span class="op" id="8141980">&lt;-</span><span class="ident" id="8141982">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8141990">test</span><span class="op" id="8141994">.</span><span class="ident" id="8141995">exp</span>&nbsp;<span class="op" id="8141999">=</span>&nbsp;<span class="ident" id="8142001">fmt</span><span class="op" id="8142004">.</span><span class="ident" id="8142005">Sprintf</span><span class="op" id="8142012">(</span><span class="string" id="8142013">&#34;&lt;%d&gt;&#34;</span><span class="op" id="8142019">,</span>&nbsp;<span class="ident" id="8142021">test</span><span class="op" id="8142025">.</span><span class="ident" id="8142026">pri</span><span class="op" id="8142029">)</span>&nbsp;<span class="op" id="8142031">+</span>&nbsp;<span class="ident" id="8142033">test</span><span class="op" id="8142037">.</span><span class="ident" id="8142038">exp</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142045">var</span>&nbsp;<span class="ident" id="8142049">parsedHostname</span><span class="op" id="8142063">,</span>&nbsp;<span class="ident" id="8142065">timestamp</span>&nbsp;<span class="builtintype" id="8142075">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142085">var</span>&nbsp;<span class="ident" id="8142089">pid</span>&nbsp;<span class="builtintype" id="8142093">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142100">if</span>&nbsp;<span class="ident" id="8142103">n</span><span class="op" id="8142104">,</span>&nbsp;<span class="ident" id="8142106">err</span>&nbsp;<span class="op" id="8142110">:=</span>&nbsp;<span class="ident" id="8142113">fmt</span><span class="op" id="8142116">.</span><span class="ident" id="8142117">Sscanf</span><span class="op" id="8142123">(</span><span class="ident" id="8142124">rcvd</span><span class="op" id="8142128">,</span>&nbsp;<span class="ident" id="8142130">test</span><span class="op" id="8142134">.</span><span class="ident" id="8142135">exp</span><span class="op" id="8142138">,</span>&nbsp;<span class="op" id="8142140">&amp;</span><span class="ident" id="8142141">timestamp</span><span class="op" id="8142150">,</span>&nbsp;<span class="op" id="8142152">&amp;</span><span class="ident" id="8142153">parsedHostname</span><span class="op" id="8142167">,</span>&nbsp;<span class="op" id="8142169">&amp;</span><span class="ident" id="8142170">pid</span><span class="op" id="8142173">)</span><span class="op" id="8142174">;</span>&nbsp;<span class="ident" id="8142176">n</span>&nbsp;<span class="op" id="8142178">!=</span>&nbsp;<span class="num" id="8142181">3</span>&nbsp;<span class="op" id="8142183">||</span>&nbsp;<span class="ident" id="8142186">err</span>&nbsp;<span class="op" id="8142190">!=</span>&nbsp;<span class="ident" id="8142193">nil</span>&nbsp;<span class="op" id="8142197">||</span>&nbsp;<span class="ident" id="8142200">hostname</span>&nbsp;<span class="op" id="8142209">!=</span>&nbsp;<span class="ident" id="8142212">parsedHostname</span>&nbsp;<span class="op" id="8142227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8142233">t</span><span class="op" id="8142234">.</span><span class="ident" id="8142235">Errorf</span><span class="op" id="8142241">(</span><span class="string" id="8142242">&#34;s.Info()&nbsp;=&nbsp;&#39;%q&#39;,&nbsp;didn&#39;t&nbsp;match&nbsp;&#39;%q&#39;&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="8142286">,</span>&nbsp;<span class="ident" id="8142288">rcvd</span><span class="op" id="8142292">,</span>&nbsp;<span class="ident" id="8142294">test</span><span class="op" id="8142298">.</span><span class="ident" id="8142299">exp</span><span class="op" id="8142302">,</span>&nbsp;<span class="ident" id="8142304">n</span><span class="op" id="8142305">,</span>&nbsp;<span class="ident" id="8142307">err</span><span class="op" id="8142310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8142315">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8142319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8142322">}</span><br>
<span class="lineno"></span><span class="op" id="8142324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8142327">func</span>&nbsp;<span class="ident" id="8142332">TestConcurrentWrite</span><span class="op" id="8142351">(</span><span class="ident" id="8142352">t</span>&nbsp;<span class="op" id="8142354">*</span><span class="ident" id="8142355">testing</span><span class="op" id="8142362">.</span><span class="ident" id="8142363">T</span><span class="op" id="8142364">)</span>&nbsp;<span class="op" id="8142366">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8142369">addr</span><span class="op" id="8142373">,</span>&nbsp;<span class="ident" id="8142375">sock</span><span class="op" id="8142379">,</span>&nbsp;<span class="ident" id="8142381">srvWG</span>&nbsp;<span class="op" id="8142387">:=</span>&nbsp;<span class="ident" id="8142390">startServer</span><span class="op" id="8142401">(</span><span class="string" id="8142402">&#34;udp&#34;</span><span class="op" id="8142407">,</span>&nbsp;<span class="string" id="8142409">&#34;&#34;</span><span class="op" id="8142411">,</span>&nbsp;<span class="builtinfunc" id="8142413">make</span><span class="op" id="8142417">(</span><span class="keyword" id="8142418">chan</span>&nbsp;<span class="builtintype" id="8142423">string</span><span class="op" id="8142429">,</span>&nbsp;<span class="num" id="8142431">1</span><span class="op" id="8142432">)</span><span class="op" id="8142433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142436">defer</span>&nbsp;<span class="ident" id="8142442">srvWG</span><span class="op" id="8142447">.</span><span class="ident" id="8142448">Wait</span><span class="op" id="8142452">(</span><span class="op" id="8142453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142456">defer</span>&nbsp;<span class="ident" id="8142462">sock</span><span class="op" id="8142466">.</span><span class="ident" id="8142467">Close</span><span class="op" id="8142472">(</span><span class="op" id="8142473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8142476">w</span><span class="op" id="8142477">,</span>&nbsp;<span class="ident" id="8142479">err</span>&nbsp;<span class="op" id="8142483">:=</span>&nbsp;<span class="ident" id="8142486">Dial</span><span class="op" id="8142490">(</span><span class="string" id="8142491">&#34;udp&#34;</span><span class="op" id="8142496">,</span>&nbsp;<span class="ident" id="8142498">addr</span><span class="op" id="8142502">,</span>&nbsp;<span class="ident" id="8142504">LOG_USER</span><span class="op" id="8142512">|</span><span class="ident" id="8142513">LOG_ERR</span><span class="op" id="8142520">,</span>&nbsp;<span class="string" id="8142522">&#34;how&#39;s&nbsp;it&nbsp;going?&#34;</span><span class="op" id="8142539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142542">if</span>&nbsp;<span class="ident" id="8142545">err</span>&nbsp;<span class="op" id="8142549">!=</span>&nbsp;<span class="ident" id="8142552">nil</span>&nbsp;<span class="op" id="8142556">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8142560">t</span><span class="op" id="8142561">.</span><span class="ident" id="8142562">Fatalf</span><span class="op" id="8142568">(</span><span class="string" id="8142569">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8142595">,</span>&nbsp;<span class="ident" id="8142597">err</span><span class="op" id="8142600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8142603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142606">var</span>&nbsp;<span class="ident" id="8142610">wg</span>&nbsp;<span class="ident" id="8142613">sync</span><span class="op" id="8142617">.</span><span class="ident" id="8142618">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142629">for</span>&nbsp;<span class="ident" id="8142633">i</span>&nbsp;<span class="op" id="8142635">:=</span>&nbsp;<span class="num" id="8142638">0</span><span class="op" id="8142639">;</span>&nbsp;<span class="ident" id="8142641">i</span>&nbsp;<span class="op" id="8142643">&lt;</span>&nbsp;<span class="num" id="8142645">10</span><span class="op" id="8142647">;</span>&nbsp;<span class="ident" id="8142649">i</span><span class="op" id="8142650">++</span>&nbsp;<span class="op" id="8142653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8142657">wg</span><span class="op" id="8142659">.</span><span class="ident" id="8142660">Add</span><span class="op" id="8142663">(</span><span class="num" id="8142664">1</span><span class="op" id="8142665">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142669">go</span>&nbsp;<span class="keyword" id="8142672">func</span><span class="op" id="8142676">(</span><span class="op" id="8142677">)</span>&nbsp;<span class="op" id="8142679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142684">defer</span>&nbsp;<span class="ident" id="8142690">wg</span><span class="op" id="8142692">.</span><span class="ident" id="8142693">Done</span><span class="op" id="8142697">(</span><span class="op" id="8142698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8142703">err</span>&nbsp;<span class="op" id="8142707">:=</span>&nbsp;<span class="ident" id="8142710">w</span><span class="op" id="8142711">.</span><span class="ident" id="8142712">Info</span><span class="op" id="8142716">(</span><span class="string" id="8142717">&#34;test&#34;</span><span class="op" id="8142723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142728">if</span>&nbsp;<span class="ident" id="8142731">err</span>&nbsp;<span class="op" id="8142735">!=</span>&nbsp;<span class="ident" id="8142738">nil</span>&nbsp;<span class="op" id="8142742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8142748">t</span><span class="op" id="8142749">.</span><span class="ident" id="8142750">Errorf</span><span class="op" id="8142756">(</span><span class="string" id="8142757">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8142776">,</span>&nbsp;<span class="ident" id="8142778">err</span><span class="op" id="8142781">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142787">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8142797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8142801">}</span><span class="op" id="8142802">(</span><span class="op" id="8142803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8142806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8142809">wg</span><span class="op" id="8142811">.</span><span class="ident" id="8142812">Wait</span><span class="op" id="8142816">(</span><span class="op" id="8142817">)</span><br>
<span class="lineno">300</span><span class="op" id="8142819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8142822">func</span>&nbsp;<span class="ident" id="8142827">TestConcurrentReconnect</span><span class="op" id="8142850">(</span><span class="ident" id="8142851">t</span>&nbsp;<span class="op" id="8142853">*</span><span class="ident" id="8142854">testing</span><span class="op" id="8142861">.</span><span class="ident" id="8142862">T</span><span class="op" id="8142863">)</span>&nbsp;<span class="op" id="8142865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8142868">crashy</span>&nbsp;<span class="op" id="8142875">=</span>&nbsp;<span class="ident" id="8142877">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142883">defer</span>&nbsp;<span class="keyword" id="8142889">func</span><span class="op" id="8142893">(</span><span class="op" id="8142894">)</span>&nbsp;<span class="op" id="8142896">{</span>&nbsp;<span class="ident" id="8142898">crashy</span>&nbsp;<span class="op" id="8142905">=</span>&nbsp;<span class="ident" id="8142907">false</span>&nbsp;<span class="op" id="8142913">}</span><span class="op" id="8142914">(</span><span class="op" id="8142915">)</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142919">const</span>&nbsp;<span class="ident" id="8142925">N</span>&nbsp;<span class="op" id="8142927">=</span>&nbsp;<span class="num" id="8142929">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8142933">const</span>&nbsp;<span class="ident" id="8142939">M</span>&nbsp;<span class="op" id="8142941">=</span>&nbsp;<span class="num" id="8142943">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8142948">net</span>&nbsp;<span class="op" id="8142952">:=</span>&nbsp;<span class="string" id="8142955">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8142963">done</span>&nbsp;<span class="op" id="8142968">:=</span>&nbsp;<span class="builtinfunc" id="8142971">make</span><span class="op" id="8142975">(</span><span class="keyword" id="8142976">chan</span>&nbsp;<span class="builtintype" id="8142981">string</span><span class="op" id="8142987">,</span>&nbsp;<span class="ident" id="8142989">N</span><span class="op" id="8142990">*</span><span class="ident" id="8142991">M</span><span class="op" id="8142992">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8142995">addr</span><span class="op" id="8142999">,</span>&nbsp;<span class="ident" id="8143001">sock</span><span class="op" id="8143005">,</span>&nbsp;<span class="ident" id="8143007">srvWG</span>&nbsp;<span class="op" id="8143013">:=</span>&nbsp;<span class="ident" id="8143016">startServer</span><span class="op" id="8143027">(</span><span class="ident" id="8143028">net</span><span class="op" id="8143031">,</span>&nbsp;<span class="string" id="8143033">&#34;&#34;</span><span class="op" id="8143035">,</span>&nbsp;<span class="ident" id="8143037">done</span><span class="op" id="8143041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143044">defer</span>&nbsp;<span class="ident" id="8143050">os</span><span class="op" id="8143052">.</span><span class="ident" id="8143053">Remove</span><span class="op" id="8143059">(</span><span class="ident" id="8143060">addr</span><span class="op" id="8143064">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8143068">//&nbsp;count&nbsp;all&nbsp;the&nbsp;messages&nbsp;arriving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143104">count</span>&nbsp;<span class="op" id="8143110">:=</span>&nbsp;<span class="builtinfunc" id="8143113">make</span><span class="op" id="8143117">(</span><span class="keyword" id="8143118">chan</span>&nbsp;<span class="builtintype" id="8143123">int</span><span class="op" id="8143126">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143129">go</span>&nbsp;<span class="keyword" id="8143132">func</span><span class="op" id="8143136">(</span><span class="op" id="8143137">)</span>&nbsp;<span class="op" id="8143139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143143">ct</span>&nbsp;<span class="op" id="8143146">:=</span>&nbsp;<span class="num" id="8143149">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143153">for</span>&nbsp;<span class="keyword" id="8143157">range</span>&nbsp;<span class="ident" id="8143163">done</span>&nbsp;<span class="op" id="8143168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143173">ct</span><span class="op" id="8143175">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8143181">//&nbsp;we&nbsp;are&nbsp;looking&nbsp;for&nbsp;500&nbsp;out&nbsp;of&nbsp;1000&nbsp;events</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8143229">//&nbsp;here&nbsp;because&nbsp;lots&nbsp;of&nbsp;log&nbsp;messages&nbsp;are&nbsp;lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8143278">//&nbsp;in&nbsp;buffers&nbsp;(kernel&nbsp;and/or&nbsp;bufio)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143317">if</span>&nbsp;<span class="ident" id="8143320">ct</span>&nbsp;<span class="op" id="8143323">&gt;</span>&nbsp;<span class="ident" id="8143325">N</span><span class="op" id="8143326">*</span><span class="ident" id="8143327">M</span><span class="op" id="8143328">/</span><span class="num" id="8143329">2</span>&nbsp;<span class="op" id="8143331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143337">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8143346">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8143350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143354">count</span>&nbsp;<span class="op" id="8143360">&lt;-</span>&nbsp;<span class="ident" id="8143363">ct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8143367">}</span><span class="op" id="8143368">(</span><span class="op" id="8143369">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143373">var</span>&nbsp;<span class="ident" id="8143377">wg</span>&nbsp;<span class="ident" id="8143380">sync</span><span class="op" id="8143384">.</span><span class="ident" id="8143385">WaitGroup</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143396">wg</span><span class="op" id="8143398">.</span><span class="ident" id="8143399">Add</span><span class="op" id="8143402">(</span><span class="ident" id="8143403">N</span><span class="op" id="8143404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143407">for</span>&nbsp;<span class="ident" id="8143411">i</span>&nbsp;<span class="op" id="8143413">:=</span>&nbsp;<span class="num" id="8143416">0</span><span class="op" id="8143417">;</span>&nbsp;<span class="ident" id="8143419">i</span>&nbsp;<span class="op" id="8143421">&lt;</span>&nbsp;<span class="ident" id="8143423">N</span><span class="op" id="8143424">;</span>&nbsp;<span class="ident" id="8143426">i</span><span class="op" id="8143427">++</span>&nbsp;<span class="op" id="8143430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143434">go</span>&nbsp;<span class="keyword" id="8143437">func</span><span class="op" id="8143441">(</span><span class="op" id="8143442">)</span>&nbsp;<span class="op" id="8143444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143449">defer</span>&nbsp;<span class="ident" id="8143455">wg</span><span class="op" id="8143457">.</span><span class="ident" id="8143458">Done</span><span class="op" id="8143462">(</span><span class="op" id="8143463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143468">w</span><span class="op" id="8143469">,</span>&nbsp;<span class="ident" id="8143471">err</span>&nbsp;<span class="op" id="8143475">:=</span>&nbsp;<span class="ident" id="8143478">Dial</span><span class="op" id="8143482">(</span><span class="ident" id="8143483">net</span><span class="op" id="8143486">,</span>&nbsp;<span class="ident" id="8143488">addr</span><span class="op" id="8143492">,</span>&nbsp;<span class="ident" id="8143494">LOG_USER</span><span class="op" id="8143502">|</span><span class="ident" id="8143503">LOG_ERR</span><span class="op" id="8143510">,</span>&nbsp;<span class="string" id="8143512">&#34;tag&#34;</span><span class="op" id="8143517">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143522">if</span>&nbsp;<span class="ident" id="8143525">err</span>&nbsp;<span class="op" id="8143529">!=</span>&nbsp;<span class="ident" id="8143532">nil</span>&nbsp;<span class="op" id="8143536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143542">t</span><span class="op" id="8143543">.</span><span class="ident" id="8143544">Fatalf</span><span class="op" id="8143550">(</span><span class="string" id="8143551">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8143577">,</span>&nbsp;<span class="ident" id="8143579">err</span><span class="op" id="8143582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8143587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143592">defer</span>&nbsp;<span class="ident" id="8143598">w</span><span class="op" id="8143599">.</span><span class="ident" id="8143600">Close</span><span class="op" id="8143605">(</span><span class="op" id="8143606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143611">for</span>&nbsp;<span class="ident" id="8143615">i</span>&nbsp;<span class="op" id="8143617">:=</span>&nbsp;<span class="num" id="8143620">0</span><span class="op" id="8143621">;</span>&nbsp;<span class="ident" id="8143623">i</span>&nbsp;<span class="op" id="8143625">&lt;</span>&nbsp;<span class="ident" id="8143627">M</span><span class="op" id="8143628">;</span>&nbsp;<span class="ident" id="8143630">i</span><span class="op" id="8143631">++</span>&nbsp;<span class="op" id="8143634">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143640">err</span>&nbsp;<span class="op" id="8143644">:=</span>&nbsp;<span class="ident" id="8143647">w</span><span class="op" id="8143648">.</span><span class="ident" id="8143649">Info</span><span class="op" id="8143653">(</span><span class="string" id="8143654">&#34;test&#34;</span><span class="op" id="8143660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143666">if</span>&nbsp;<span class="ident" id="8143669">err</span>&nbsp;<span class="op" id="8143673">!=</span>&nbsp;<span class="ident" id="8143676">nil</span>&nbsp;<span class="op" id="8143680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143687">t</span><span class="op" id="8143688">.</span><span class="ident" id="8143689">Errorf</span><span class="op" id="8143695">(</span><span class="string" id="8143696">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8143715">,</span>&nbsp;<span class="ident" id="8143717">err</span><span class="op" id="8143720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143727">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8143738">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8143743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8143747">}</span><span class="op" id="8143748">(</span><span class="op" id="8143749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8143752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143755">wg</span><span class="op" id="8143757">.</span><span class="ident" id="8143758">Wait</span><span class="op" id="8143762">(</span><span class="op" id="8143763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143766">sock</span><span class="op" id="8143770">.</span><span class="ident" id="8143771">Close</span><span class="op" id="8143776">(</span><span class="op" id="8143777">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143780">srvWG</span><span class="op" id="8143785">.</span><span class="ident" id="8143786">Wait</span><span class="op" id="8143790">(</span><span class="op" id="8143791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8143794">close</span><span class="op" id="8143799">(</span><span class="ident" id="8143800">done</span><span class="op" id="8143804">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143808">select</span>&nbsp;<span class="op" id="8143815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143818">case</span>&nbsp;<span class="op" id="8143823">&lt;-</span><span class="ident" id="8143825">count</span><span class="op" id="8143830">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8143833">case</span>&nbsp;<span class="op" id="8143838">&lt;-</span><span class="ident" id="8143840">time</span><span class="op" id="8143844">.</span><span class="ident" id="8143845">After</span><span class="op" id="8143850">(</span><span class="num" id="8143851">100</span>&nbsp;<span class="op" id="8143855">*</span>&nbsp;<span class="ident" id="8143857">time</span><span class="op" id="8143861">.</span><span class="ident" id="8143862">Millisecond</span><span class="op" id="8143873">)</span><span class="op" id="8143874">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8143878">t</span><span class="op" id="8143879">.</span><span class="ident" id="8143880">Error</span><span class="op" id="8143885">(</span><span class="string" id="8143886">&#34;timeout&nbsp;in&nbsp;concurrent&nbsp;reconnect&#34;</span><span class="op" id="8143919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8143922">}</span><br>
<span class="lineno"></span><span class="op" id="8143924">}</span>
</div>
</body>
</html>
