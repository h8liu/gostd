<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1498057">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1498113">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1498167">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1498218">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1498236">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1498287">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1498334">//</span><br>
<span class="lineno"></span><span class="comment" id="1498337">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1498403">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1498474">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1498543">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1498582">//</span><br>
<span class="lineno"></span><span class="comment" id="1498585">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1498659">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1498731">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1498800">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1498872">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1498939">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1499015">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1499087">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1499161">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1499239">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1499317">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1499397">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1499468">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1499546">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1499619">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1499641">//</span><br>
<span class="lineno">30</span><span class="comment" id="1499644">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1499716">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1499797">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1499874">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1499944">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1500017">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1500093">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1500167">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1500248">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1500332">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1500414">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1500453">//</span><br>
<span class="lineno"></span><span class="comment" id="1500456">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1500517">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1500595">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1500661">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1500734">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1500808">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1500881">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1500957">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1501022">package</span>&nbsp;<span class="ident" id="1501030">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1501039">import</span>&nbsp;<span class="string" id="1501046">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1501056">const</span>&nbsp;<span class="op" id="1501062">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501065">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501081">=</span>&nbsp;<span class="num" id="1501083">1</span>&nbsp;<span class="op" id="1501085">&lt;&lt;</span>&nbsp;<span class="num" id="1501088">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501092">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501108">=</span>&nbsp;<span class="num" id="1501110">1</span>&nbsp;<span class="op" id="1501112">&lt;&lt;</span>&nbsp;<span class="num" id="1501115">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501119">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501135">=</span>&nbsp;<span class="num" id="1501137">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501140">maxCPUProfStack</span>&nbsp;<span class="op" id="1501156">=</span>&nbsp;<span class="num" id="1501158">64</span><br>
<span class="lineno">60</span><span class="op" id="1501161">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1501164">type</span>&nbsp;<span class="ident" id="1501169">cpuprofEntry</span>&nbsp;<span class="keyword" id="1501182">struct</span>&nbsp;<span class="op" id="1501189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501192">count</span>&nbsp;<span class="builtintype" id="1501198">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501207">depth</span>&nbsp;<span class="builtintype" id="1501213">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501222">stack</span>&nbsp;<span class="op" id="1501228">[</span><span class="ident" id="1501229">maxCPUProfStack</span><span class="op" id="1501244">]</span><span class="builtintype" id="1501245">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1501253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1501256">type</span>&nbsp;<span class="ident" id="1501261">cpuProfile</span>&nbsp;<span class="keyword" id="1501272">struct</span>&nbsp;<span class="op" id="1501279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501282">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1501289">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501297">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501317">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1501324">note</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501332">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501357">count</span>&nbsp;&nbsp;<span class="builtintype" id="1501364">uintptr</span>&nbsp;<span class="comment" id="1501372">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501387">evicts</span>&nbsp;<span class="builtintype" id="1501394">uintptr</span>&nbsp;<span class="comment" id="1501402">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501421">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1501428">uintptr</span>&nbsp;<span class="comment" id="1501436">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501475">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501507">hash</span>&nbsp;<span class="op" id="1501512">[</span><span class="ident" id="1501513">numBuckets</span><span class="op" id="1501523">]</span><span class="keyword" id="1501524">struct</span>&nbsp;<span class="op" id="1501531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501535">entry</span>&nbsp;<span class="op" id="1501541">[</span><span class="ident" id="1501542">assoc</span><span class="op" id="1501547">]</span><span class="ident" id="1501548">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501566">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501603">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501653">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501703">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501711">[</span><span class="num" id="1501712">2</span><span class="op" id="1501713">]</span><span class="op" id="1501714">[</span><span class="ident" id="1501715">logSize</span>&nbsp;<span class="op" id="1501723">/</span>&nbsp;<span class="num" id="1501725">2</span><span class="op" id="1501726">]</span><span class="builtintype" id="1501727">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501736">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1501744">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501753">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1501761">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501768">handoff</span>&nbsp;<span class="builtintype" id="1501776">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501785">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501803">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501854">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501894">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1501903">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501911">wholding</span>&nbsp;<span class="builtintype" id="1501920">bool</span>&nbsp;<span class="comment" id="1501925">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501966">flushing</span>&nbsp;<span class="builtintype" id="1501975">bool</span>&nbsp;<span class="comment" id="1501980">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502022">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1502031">bool</span>&nbsp;<span class="comment" id="1502036">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1502084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1502087">var</span>&nbsp;<span class="op" id="1502091">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502094">cpuprofLock</span>&nbsp;<span class="ident" id="1502106">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502113">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502125">*</span><span class="ident" id="1502126">cpuProfile</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502139">eod</span>&nbsp;<span class="op" id="1502143">=</span>&nbsp;<span class="op" id="1502145">[</span><span class="num" id="1502146">3</span><span class="op" id="1502147">]</span><span class="builtintype" id="1502148">uintptr</span><span class="op" id="1502155">{</span><span class="num" id="1502156">0</span><span class="op" id="1502157">,</span>&nbsp;<span class="num" id="1502159">1</span><span class="op" id="1502160">,</span>&nbsp;<span class="num" id="1502162">0</span><span class="op" id="1502163">}</span><br>
<span class="lineno"></span><span class="op" id="1502165">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1502168">func</span>&nbsp;<span class="ident" id="1502173">setcpuprofilerate_m</span><span class="op" id="1502192">(</span><span class="op" id="1502193">)</span>&nbsp;<span class="comment" id="1502195">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1502206">func</span>&nbsp;<span class="ident" id="1502211">setcpuprofilerate</span><span class="op" id="1502228">(</span><span class="ident" id="1502229">hz</span>&nbsp;<span class="builtintype" id="1502232">int32</span><span class="op" id="1502237">)</span>&nbsp;<span class="op" id="1502239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502242">g</span>&nbsp;<span class="op" id="1502244">:=</span>&nbsp;<span class="ident" id="1502247">getg</span><span class="op" id="1502251">(</span><span class="op" id="1502252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502255">g</span><span class="op" id="1502256">.</span><span class="ident" id="1502257">m</span><span class="op" id="1502258">.</span><span class="ident" id="1502259">scalararg</span><span class="op" id="1502268">[</span><span class="num" id="1502269">0</span><span class="op" id="1502270">]</span>&nbsp;<span class="op" id="1502272">=</span>&nbsp;<span class="builtintype" id="1502274">uintptr</span><span class="op" id="1502281">(</span><span class="ident" id="1502282">hz</span><span class="op" id="1502284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502287">onM</span><span class="op" id="1502290">(</span><span class="ident" id="1502291">setcpuprofilerate_m</span><span class="op" id="1502310">)</span><br>
<span class="lineno">110</span><span class="op" id="1502312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1502315">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1502371">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1502429">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1502468">func</span>&nbsp;<span class="ident" id="1502473">lostProfileData</span><span class="op" id="1502488">(</span><span class="op" id="1502489">)</span>&nbsp;<span class="op" id="1502491">{</span><span class="op" id="1502492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1502495">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1502570">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1502624">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1502707">//</span><br>
<span class="lineno"></span><span class="comment" id="1502710">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1502766">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1502832">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1502863">func</span>&nbsp;<span class="ident" id="1502868">SetCPUProfileRate</span><span class="op" id="1502885">(</span><span class="ident" id="1502886">hz</span>&nbsp;<span class="builtintype" id="1502889">int</span><span class="op" id="1502892">)</span>&nbsp;<span class="op" id="1502894">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502897">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502935">if</span>&nbsp;<span class="ident" id="1502938">hz</span>&nbsp;<span class="op" id="1502941">&lt;</span>&nbsp;<span class="num" id="1502943">0</span>&nbsp;<span class="op" id="1502945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502949">hz</span>&nbsp;<span class="op" id="1502952">=</span>&nbsp;<span class="num" id="1502954">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502960">if</span>&nbsp;<span class="ident" id="1502963">hz</span>&nbsp;<span class="op" id="1502966">&gt;</span>&nbsp;<span class="num" id="1502968">1000000</span>&nbsp;<span class="op" id="1502976">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502980">hz</span>&nbsp;<span class="op" id="1502983">=</span>&nbsp;<span class="num" id="1502985">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502998">lock</span><span class="op" id="1503002">(</span><span class="op" id="1503003">&amp;</span><span class="ident" id="1503004">cpuprofLock</span><span class="op" id="1503015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503018">if</span>&nbsp;<span class="ident" id="1503021">hz</span>&nbsp;<span class="op" id="1503024">&gt;</span>&nbsp;<span class="num" id="1503026">0</span>&nbsp;<span class="op" id="1503028">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503032">if</span>&nbsp;<span class="ident" id="1503035">cpuprof</span>&nbsp;<span class="op" id="1503043">==</span>&nbsp;<span class="ident" id="1503046">nil</span>&nbsp;<span class="op" id="1503050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503055">cpuprof</span>&nbsp;<span class="op" id="1503063">=</span>&nbsp;<span class="op" id="1503065">(</span><span class="op" id="1503066">*</span><span class="ident" id="1503067">cpuProfile</span><span class="op" id="1503077">)</span><span class="op" id="1503078">(</span><span class="ident" id="1503079">sysAlloc</span><span class="op" id="1503087">(</span><span class="ident" id="1503088">unsafe</span><span class="op" id="1503094">.</span><span class="ident" id="1503095">Sizeof</span><span class="op" id="1503101">(</span><span class="ident" id="1503102">cpuProfile</span><span class="op" id="1503112">{</span><span class="op" id="1503113">}</span><span class="op" id="1503114">)</span><span class="op" id="1503115">,</span>&nbsp;<span class="op" id="1503117">&amp;</span><span class="ident" id="1503118">memstats</span><span class="op" id="1503126">.</span><span class="ident" id="1503127">other_sys</span><span class="op" id="1503136">)</span><span class="op" id="1503137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503142">if</span>&nbsp;<span class="ident" id="1503145">cpuprof</span>&nbsp;<span class="op" id="1503153">==</span>&nbsp;<span class="ident" id="1503156">nil</span>&nbsp;<span class="op" id="1503160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1503166">print</span><span class="op" id="1503171">(</span><span class="string" id="1503172">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1503221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503227">unlock</span><span class="op" id="1503233">(</span><span class="op" id="1503234">&amp;</span><span class="ident" id="1503235">cpuprofLock</span><span class="op" id="1503246">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503252">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503270">if</span>&nbsp;<span class="ident" id="1503273">cpuprof</span><span class="op" id="1503280">.</span><span class="ident" id="1503281">on</span>&nbsp;<span class="op" id="1503284">||</span>&nbsp;<span class="ident" id="1503287">cpuprof</span><span class="op" id="1503294">.</span><span class="ident" id="1503295">handoff</span>&nbsp;<span class="op" id="1503303">!=</span>&nbsp;<span class="num" id="1503306">0</span>&nbsp;<span class="op" id="1503308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1503313">print</span><span class="op" id="1503318">(</span><span class="string" id="1503319">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1503396">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503401">unlock</span><span class="op" id="1503407">(</span><span class="op" id="1503408">&amp;</span><span class="ident" id="1503409">cpuprofLock</span><span class="op" id="1503420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503425">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503439">cpuprof</span><span class="op" id="1503446">.</span><span class="ident" id="1503447">on</span>&nbsp;<span class="op" id="1503450">=</span>&nbsp;<span class="builtintype" id="1503452">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1503459">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1503492">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503582">p</span>&nbsp;<span class="op" id="1503584">:=</span>&nbsp;<span class="op" id="1503587">&amp;</span><span class="ident" id="1503588">cpuprof</span><span class="op" id="1503595">.</span><span class="ident" id="1503596">log</span><span class="op" id="1503599">[</span><span class="num" id="1503600">0</span><span class="op" id="1503601">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503605">p</span><span class="op" id="1503606">[</span><span class="num" id="1503607">0</span><span class="op" id="1503608">]</span>&nbsp;<span class="op" id="1503610">=</span>&nbsp;<span class="num" id="1503612">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503630">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503652">p</span><span class="op" id="1503653">[</span><span class="num" id="1503654">1</span><span class="op" id="1503655">]</span>&nbsp;<span class="op" id="1503657">=</span>&nbsp;<span class="num" id="1503659">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503677">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503699">p</span><span class="op" id="1503700">[</span><span class="num" id="1503701">2</span><span class="op" id="1503702">]</span>&nbsp;<span class="op" id="1503704">=</span>&nbsp;<span class="num" id="1503706">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503724">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503744">p</span><span class="op" id="1503745">[</span><span class="num" id="1503746">3</span><span class="op" id="1503747">]</span>&nbsp;<span class="op" id="1503749">=</span>&nbsp;<span class="builtintype" id="1503751">uintptr</span><span class="op" id="1503758">(</span><span class="num" id="1503759">1e6</span>&nbsp;<span class="op" id="1503763">/</span>&nbsp;<span class="ident" id="1503765">hz</span><span class="op" id="1503767">)</span>&nbsp;<span class="comment" id="1503769">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503796">p</span><span class="op" id="1503797">[</span><span class="num" id="1503798">4</span><span class="op" id="1503799">]</span>&nbsp;<span class="op" id="1503801">=</span>&nbsp;<span class="num" id="1503803">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503807">cpuprof</span><span class="op" id="1503814">.</span><span class="ident" id="1503815">nlog</span>&nbsp;<span class="op" id="1503820">=</span>&nbsp;<span class="num" id="1503822">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503826">cpuprof</span><span class="op" id="1503833">.</span><span class="ident" id="1503834">toggle</span>&nbsp;<span class="op" id="1503841">=</span>&nbsp;<span class="num" id="1503843">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503847">cpuprof</span><span class="op" id="1503854">.</span><span class="ident" id="1503855">wholding</span>&nbsp;<span class="op" id="1503864">=</span>&nbsp;<span class="builtintype" id="1503866">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503874">cpuprof</span><span class="op" id="1503881">.</span><span class="ident" id="1503882">wtoggle</span>&nbsp;<span class="op" id="1503890">=</span>&nbsp;<span class="num" id="1503892">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503896">cpuprof</span><span class="op" id="1503903">.</span><span class="ident" id="1503904">flushing</span>&nbsp;<span class="op" id="1503913">=</span>&nbsp;<span class="builtintype" id="1503915">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503923">cpuprof</span><span class="op" id="1503930">.</span><span class="ident" id="1503931">eodSent</span>&nbsp;<span class="op" id="1503939">=</span>&nbsp;<span class="builtintype" id="1503941">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503949">noteclear</span><span class="op" id="1503958">(</span><span class="op" id="1503959">&amp;</span><span class="ident" id="1503960">cpuprof</span><span class="op" id="1503967">.</span><span class="ident" id="1503968">wait</span><span class="op" id="1503972">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503977">setcpuprofilerate</span><span class="op" id="1503994">(</span><span class="builtintype" id="1503995">int32</span><span class="op" id="1504000">(</span><span class="ident" id="1504001">hz</span><span class="op" id="1504003">)</span><span class="op" id="1504004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504007">}</span>&nbsp;<span class="keyword" id="1504009">else</span>&nbsp;<span class="keyword" id="1504014">if</span>&nbsp;<span class="ident" id="1504017">cpuprof</span>&nbsp;<span class="op" id="1504025">!=</span>&nbsp;<span class="ident" id="1504028">nil</span>&nbsp;<span class="op" id="1504032">&amp;&amp;</span>&nbsp;<span class="ident" id="1504035">cpuprof</span><span class="op" id="1504042">.</span><span class="ident" id="1504043">on</span>&nbsp;<span class="op" id="1504046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504050">setcpuprofilerate</span><span class="op" id="1504067">(</span><span class="num" id="1504068">0</span><span class="op" id="1504069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504073">cpuprof</span><span class="op" id="1504080">.</span><span class="ident" id="1504081">on</span>&nbsp;<span class="op" id="1504084">=</span>&nbsp;<span class="builtintype" id="1504086">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1504095">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1504168">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504227">for</span>&nbsp;<span class="op" id="1504231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504236">n</span>&nbsp;<span class="op" id="1504238">:=</span>&nbsp;<span class="ident" id="1504241">cpuprof</span><span class="op" id="1504248">.</span><span class="ident" id="1504249">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504260">if</span>&nbsp;<span class="ident" id="1504263">n</span><span class="op" id="1504264">&amp;</span><span class="num" id="1504265">0x80000000</span>&nbsp;<span class="op" id="1504276">!=</span>&nbsp;<span class="num" id="1504279">0</span>&nbsp;<span class="op" id="1504281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1504287">print</span><span class="op" id="1504292">(</span><span class="string" id="1504293">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1504330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504340">if</span>&nbsp;<span class="ident" id="1504343">cas</span><span class="op" id="1504346">(</span><span class="op" id="1504347">&amp;</span><span class="ident" id="1504348">cpuprof</span><span class="op" id="1504355">.</span><span class="ident" id="1504356">handoff</span><span class="op" id="1504363">,</span>&nbsp;<span class="ident" id="1504365">n</span><span class="op" id="1504366">,</span>&nbsp;<span class="ident" id="1504368">n</span><span class="op" id="1504369">|</span><span class="num" id="1504370">0x80000000</span><span class="op" id="1504380">)</span>&nbsp;<span class="op" id="1504382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504388">if</span>&nbsp;<span class="ident" id="1504391">n</span>&nbsp;<span class="op" id="1504393">==</span>&nbsp;<span class="num" id="1504396">0</span>&nbsp;<span class="op" id="1504398">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1504405">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504475">notewakeup</span><span class="op" id="1504485">(</span><span class="op" id="1504486">&amp;</span><span class="ident" id="1504487">cpuprof</span><span class="op" id="1504494">.</span><span class="ident" id="1504495">wait</span><span class="op" id="1504499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504511">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504520">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504530">unlock</span><span class="op" id="1504536">(</span><span class="op" id="1504537">&amp;</span><span class="ident" id="1504538">cpuprofLock</span><span class="op" id="1504549">)</span><br>
<span class="lineno"></span><span class="op" id="1504551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1504554">func</span>&nbsp;<span class="ident" id="1504559">cpuproftick</span><span class="op" id="1504570">(</span><span class="ident" id="1504571">pc</span>&nbsp;<span class="op" id="1504574">*</span><span class="builtintype" id="1504575">uintptr</span><span class="op" id="1504582">,</span>&nbsp;<span class="ident" id="1504584">n</span>&nbsp;<span class="builtintype" id="1504586">int32</span><span class="op" id="1504591">)</span>&nbsp;<span class="op" id="1504593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504596">if</span>&nbsp;<span class="ident" id="1504599">n</span>&nbsp;<span class="op" id="1504601">&gt;</span>&nbsp;<span class="ident" id="1504603">maxCPUProfStack</span>&nbsp;<span class="op" id="1504619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504623">n</span>&nbsp;<span class="op" id="1504625">=</span>&nbsp;<span class="ident" id="1504627">maxCPUProfStack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504647">s</span>&nbsp;<span class="op" id="1504649">:=</span>&nbsp;<span class="op" id="1504652">(</span><span class="op" id="1504653">*</span><span class="op" id="1504654">[</span><span class="ident" id="1504655">maxCPUProfStack</span><span class="op" id="1504670">]</span><span class="builtintype" id="1504671">uintptr</span><span class="op" id="1504678">)</span><span class="op" id="1504679">(</span><span class="ident" id="1504680">unsafe</span><span class="op" id="1504686">.</span><span class="ident" id="1504687">Pointer</span><span class="op" id="1504694">(</span><span class="ident" id="1504695">pc</span><span class="op" id="1504697">)</span><span class="op" id="1504698">)</span><span class="op" id="1504699">[</span><span class="op" id="1504700">:</span><span class="ident" id="1504701">n</span><span class="op" id="1504702">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504705">cpuprof</span><span class="op" id="1504712">.</span><span class="ident" id="1504713">add</span><span class="op" id="1504716">(</span><span class="ident" id="1504717">s</span><span class="op" id="1504718">)</span><br>
<span class="lineno"></span><span class="op" id="1504720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1504723">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1504767">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1504835">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1504896">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1504966">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1505009">func</span>&nbsp;<span class="op" id="1505014">(</span><span class="ident" id="1505015">p</span>&nbsp;<span class="op" id="1505017">*</span><span class="ident" id="1505018">cpuProfile</span><span class="op" id="1505028">)</span>&nbsp;<span class="ident" id="1505030">add</span><span class="op" id="1505033">(</span><span class="ident" id="1505034">pc</span>&nbsp;<span class="op" id="1505037">[</span><span class="op" id="1505038">]</span><span class="builtintype" id="1505039">uintptr</span><span class="op" id="1505046">)</span>&nbsp;<span class="op" id="1505048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505051">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505069">h</span>&nbsp;<span class="op" id="1505071">:=</span>&nbsp;<span class="builtintype" id="1505074">uintptr</span><span class="op" id="1505081">(</span><span class="num" id="1505082">0</span><span class="op" id="1505083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505086">for</span>&nbsp;<span class="ident" id="1505090">_</span><span class="op" id="1505091">,</span>&nbsp;<span class="ident" id="1505093">x</span>&nbsp;<span class="op" id="1505095">:=</span>&nbsp;<span class="keyword" id="1505098">range</span>&nbsp;<span class="ident" id="1505104">pc</span>&nbsp;<span class="op" id="1505107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505111">h</span>&nbsp;<span class="op" id="1505113">=</span>&nbsp;<span class="ident" id="1505115">h</span><span class="op" id="1505116">&lt;&lt;</span><span class="num" id="1505118">8</span>&nbsp;<span class="op" id="1505120">|</span>&nbsp;<span class="op" id="1505122">(</span><span class="ident" id="1505123">h</span>&nbsp;<span class="op" id="1505125">&gt;&gt;</span>&nbsp;<span class="op" id="1505128">(</span><span class="num" id="1505129">8</span>&nbsp;<span class="op" id="1505131">*</span>&nbsp;<span class="op" id="1505133">(</span><span class="ident" id="1505134">unsafe</span><span class="op" id="1505140">.</span><span class="ident" id="1505141">Sizeof</span><span class="op" id="1505147">(</span><span class="ident" id="1505148">h</span><span class="op" id="1505149">)</span>&nbsp;<span class="op" id="1505151">-</span>&nbsp;<span class="num" id="1505153">1</span><span class="op" id="1505154">)</span><span class="op" id="1505155">)</span><span class="op" id="1505156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505160">h</span>&nbsp;<span class="op" id="1505162">+=</span>&nbsp;<span class="ident" id="1505165">x</span><span class="op" id="1505166">*</span><span class="num" id="1505167">31</span>&nbsp;<span class="op" id="1505170">+</span>&nbsp;<span class="ident" id="1505172">x</span><span class="op" id="1505173">*</span><span class="num" id="1505174">7</span>&nbsp;<span class="op" id="1505176">+</span>&nbsp;<span class="ident" id="1505178">x</span><span class="op" id="1505179">*</span><span class="num" id="1505180">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505183">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505186">p</span><span class="op" id="1505187">.</span><span class="ident" id="1505188">count</span><span class="op" id="1505193">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505198">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505250">b</span>&nbsp;<span class="op" id="1505252">:=</span>&nbsp;<span class="op" id="1505255">&amp;</span><span class="ident" id="1505256">p</span><span class="op" id="1505257">.</span><span class="ident" id="1505258">hash</span><span class="op" id="1505262">[</span><span class="ident" id="1505263">h</span><span class="op" id="1505264">%</span><span class="ident" id="1505265">numBuckets</span><span class="op" id="1505275">]</span><br>
<span class="lineno"></span><span class="ident" id="1505277">Assoc</span><span class="op" id="1505282">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505285">for</span>&nbsp;<span class="ident" id="1505289">i</span>&nbsp;<span class="op" id="1505291">:=</span>&nbsp;<span class="keyword" id="1505294">range</span>&nbsp;<span class="ident" id="1505300">b</span><span class="op" id="1505301">.</span><span class="ident" id="1505302">entry</span>&nbsp;<span class="op" id="1505308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505312">e</span>&nbsp;<span class="op" id="1505314">:=</span>&nbsp;<span class="op" id="1505317">&amp;</span><span class="ident" id="1505318">b</span><span class="op" id="1505319">.</span><span class="ident" id="1505320">entry</span><span class="op" id="1505325">[</span><span class="ident" id="1505326">i</span><span class="op" id="1505327">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505331">if</span>&nbsp;<span class="ident" id="1505334">e</span><span class="op" id="1505335">.</span><span class="ident" id="1505336">depth</span>&nbsp;<span class="op" id="1505342">!=</span>&nbsp;<span class="builtintype" id="1505345">uintptr</span><span class="op" id="1505352">(</span><span class="builtinfunc" id="1505353">len</span><span class="op" id="1505356">(</span><span class="ident" id="1505357">pc</span><span class="op" id="1505359">)</span><span class="op" id="1505360">)</span>&nbsp;<span class="op" id="1505362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505367">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505378">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505382">for</span>&nbsp;<span class="ident" id="1505386">j</span>&nbsp;<span class="op" id="1505388">:=</span>&nbsp;<span class="keyword" id="1505391">range</span>&nbsp;<span class="ident" id="1505397">pc</span>&nbsp;<span class="op" id="1505400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505405">if</span>&nbsp;<span class="ident" id="1505408">e</span><span class="op" id="1505409">.</span><span class="ident" id="1505410">stack</span><span class="op" id="1505415">[</span><span class="ident" id="1505416">j</span><span class="op" id="1505417">]</span>&nbsp;<span class="op" id="1505419">!=</span>&nbsp;<span class="ident" id="1505422">pc</span><span class="op" id="1505424">[</span><span class="ident" id="1505425">j</span><span class="op" id="1505426">]</span>&nbsp;<span class="op" id="1505428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505434">continue</span>&nbsp;<span class="ident" id="1505443">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505456">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505460">e</span><span class="op" id="1505461">.</span><span class="ident" id="1505462">count</span><span class="op" id="1505467">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505472">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505484">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505521">var</span>&nbsp;<span class="ident" id="1505525">e</span>&nbsp;<span class="op" id="1505527">*</span><span class="ident" id="1505528">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505542">for</span>&nbsp;<span class="ident" id="1505546">i</span>&nbsp;<span class="op" id="1505548">:=</span>&nbsp;<span class="keyword" id="1505551">range</span>&nbsp;<span class="ident" id="1505557">b</span><span class="op" id="1505558">.</span><span class="ident" id="1505559">entry</span>&nbsp;<span class="op" id="1505565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505569">if</span>&nbsp;<span class="ident" id="1505572">e</span>&nbsp;<span class="op" id="1505574">==</span>&nbsp;<span class="ident" id="1505577">nil</span>&nbsp;<span class="op" id="1505581">||</span>&nbsp;<span class="ident" id="1505584">b</span><span class="op" id="1505585">.</span><span class="ident" id="1505586">entry</span><span class="op" id="1505591">[</span><span class="ident" id="1505592">i</span><span class="op" id="1505593">]</span><span class="op" id="1505594">.</span><span class="ident" id="1505595">count</span>&nbsp;<span class="op" id="1505601">&lt;</span>&nbsp;<span class="ident" id="1505603">e</span><span class="op" id="1505604">.</span><span class="ident" id="1505605">count</span>&nbsp;<span class="op" id="1505611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505616">e</span>&nbsp;<span class="op" id="1505618">=</span>&nbsp;<span class="op" id="1505620">&amp;</span><span class="ident" id="1505621">b</span><span class="op" id="1505622">.</span><span class="ident" id="1505623">entry</span><span class="op" id="1505628">[</span><span class="ident" id="1505629">i</span><span class="op" id="1505630">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505634">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505640">if</span>&nbsp;<span class="ident" id="1505643">e</span><span class="op" id="1505644">.</span><span class="ident" id="1505645">count</span>&nbsp;<span class="op" id="1505651">&gt;</span>&nbsp;<span class="num" id="1505653">0</span>&nbsp;<span class="op" id="1505655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505659">if</span>&nbsp;<span class="op" id="1505662">!</span><span class="ident" id="1505663">p</span><span class="op" id="1505664">.</span><span class="ident" id="1505665">evict</span><span class="op" id="1505670">(</span><span class="ident" id="1505671">e</span><span class="op" id="1505672">)</span>&nbsp;<span class="op" id="1505674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505679">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505728">p</span><span class="op" id="1505729">.</span><span class="ident" id="1505730">lost</span><span class="op" id="1505734">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505740">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505753">p</span><span class="op" id="1505754">.</span><span class="ident" id="1505755">evicts</span><span class="op" id="1505761">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505769">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505804">e</span><span class="op" id="1505805">.</span><span class="ident" id="1505806">depth</span>&nbsp;<span class="op" id="1505812">=</span>&nbsp;<span class="builtintype" id="1505814">uintptr</span><span class="op" id="1505821">(</span><span class="builtinfunc" id="1505822">len</span><span class="op" id="1505825">(</span><span class="ident" id="1505826">pc</span><span class="op" id="1505828">)</span><span class="op" id="1505829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505832">e</span><span class="op" id="1505833">.</span><span class="ident" id="1505834">count</span>&nbsp;<span class="op" id="1505840">=</span>&nbsp;<span class="num" id="1505842">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1505845">copy</span><span class="op" id="1505849">(</span><span class="ident" id="1505850">e</span><span class="op" id="1505851">.</span><span class="ident" id="1505852">stack</span><span class="op" id="1505857">[</span><span class="op" id="1505858">:</span><span class="op" id="1505859">]</span><span class="op" id="1505860">,</span>&nbsp;<span class="ident" id="1505862">pc</span><span class="op" id="1505864">)</span><br>
<span class="lineno"></span><span class="op" id="1505866">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1505869">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1505930">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1505991">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1506054">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1506113">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1506171">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1506212">func</span>&nbsp;<span class="op" id="1506217">(</span><span class="ident" id="1506218">p</span>&nbsp;<span class="op" id="1506220">*</span><span class="ident" id="1506221">cpuProfile</span><span class="op" id="1506231">)</span>&nbsp;<span class="ident" id="1506233">evict</span><span class="op" id="1506238">(</span><span class="ident" id="1506239">e</span>&nbsp;<span class="op" id="1506241">*</span><span class="ident" id="1506242">cpuprofEntry</span><span class="op" id="1506254">)</span>&nbsp;<span class="builtintype" id="1506256">bool</span>&nbsp;<span class="op" id="1506261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506264">d</span>&nbsp;<span class="op" id="1506266">:=</span>&nbsp;<span class="ident" id="1506269">e</span><span class="op" id="1506270">.</span><span class="ident" id="1506271">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506278">nslot</span>&nbsp;<span class="op" id="1506284">:=</span>&nbsp;<span class="ident" id="1506287">d</span>&nbsp;<span class="op" id="1506289">+</span>&nbsp;<span class="num" id="1506291">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506294">log</span>&nbsp;<span class="op" id="1506298">:=</span>&nbsp;<span class="op" id="1506301">&amp;</span><span class="ident" id="1506302">p</span><span class="op" id="1506303">.</span><span class="ident" id="1506304">log</span><span class="op" id="1506307">[</span><span class="ident" id="1506308">p</span><span class="op" id="1506309">.</span><span class="ident" id="1506310">toggle</span><span class="op" id="1506316">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506319">if</span>&nbsp;<span class="ident" id="1506322">p</span><span class="op" id="1506323">.</span><span class="ident" id="1506324">nlog</span><span class="op" id="1506328">+</span><span class="ident" id="1506329">nslot</span>&nbsp;<span class="op" id="1506335">&gt;</span>&nbsp;<span class="builtintype" id="1506337">uintptr</span><span class="op" id="1506344">(</span><span class="builtinfunc" id="1506345">len</span><span class="op" id="1506348">(</span><span class="ident" id="1506349">p</span><span class="op" id="1506350">.</span><span class="ident" id="1506351">log</span><span class="op" id="1506354">[</span><span class="num" id="1506355">0</span><span class="op" id="1506356">]</span><span class="op" id="1506357">)</span><span class="op" id="1506358">)</span>&nbsp;<span class="op" id="1506360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506364">if</span>&nbsp;<span class="op" id="1506367">!</span><span class="ident" id="1506368">p</span><span class="op" id="1506369">.</span><span class="ident" id="1506370">flushlog</span><span class="op" id="1506378">(</span><span class="op" id="1506379">)</span>&nbsp;<span class="op" id="1506381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506386">return</span>&nbsp;<span class="builtintype" id="1506393">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506401">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506405">log</span>&nbsp;<span class="op" id="1506409">=</span>&nbsp;<span class="op" id="1506411">&amp;</span><span class="ident" id="1506412">p</span><span class="op" id="1506413">.</span><span class="ident" id="1506414">log</span><span class="op" id="1506417">[</span><span class="ident" id="1506418">p</span><span class="op" id="1506419">.</span><span class="ident" id="1506420">toggle</span><span class="op" id="1506426">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506433">q</span>&nbsp;<span class="op" id="1506435">:=</span>&nbsp;<span class="ident" id="1506438">p</span><span class="op" id="1506439">.</span><span class="ident" id="1506440">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506446">log</span><span class="op" id="1506449">[</span><span class="ident" id="1506450">q</span><span class="op" id="1506451">]</span>&nbsp;<span class="op" id="1506453">=</span>&nbsp;<span class="ident" id="1506455">e</span><span class="op" id="1506456">.</span><span class="ident" id="1506457">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506464">q</span><span class="op" id="1506465">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506469">log</span><span class="op" id="1506472">[</span><span class="ident" id="1506473">q</span><span class="op" id="1506474">]</span>&nbsp;<span class="op" id="1506476">=</span>&nbsp;<span class="ident" id="1506478">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506481">q</span><span class="op" id="1506482">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1506486">copy</span><span class="op" id="1506490">(</span><span class="ident" id="1506491">log</span><span class="op" id="1506494">[</span><span class="ident" id="1506495">q</span><span class="op" id="1506496">:</span><span class="op" id="1506497">]</span><span class="op" id="1506498">,</span>&nbsp;<span class="ident" id="1506500">e</span><span class="op" id="1506501">.</span><span class="ident" id="1506502">stack</span><span class="op" id="1506507">[</span><span class="op" id="1506508">:</span><span class="ident" id="1506509">d</span><span class="op" id="1506510">]</span><span class="op" id="1506511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506514">q</span>&nbsp;<span class="op" id="1506516">+=</span>&nbsp;<span class="ident" id="1506519">d</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506522">p</span><span class="op" id="1506523">.</span><span class="ident" id="1506524">nlog</span>&nbsp;<span class="op" id="1506529">=</span>&nbsp;<span class="ident" id="1506531">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506534">e</span><span class="op" id="1506535">.</span><span class="ident" id="1506536">count</span>&nbsp;<span class="op" id="1506542">=</span>&nbsp;<span class="num" id="1506544">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506547">return</span>&nbsp;<span class="builtintype" id="1506554">true</span><br>
<span class="lineno"></span><span class="op" id="1506559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1506562">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1506634">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1506717">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1506789">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1506868">func</span>&nbsp;<span class="op" id="1506873">(</span><span class="ident" id="1506874">p</span>&nbsp;<span class="op" id="1506876">*</span><span class="ident" id="1506877">cpuProfile</span><span class="op" id="1506887">)</span>&nbsp;<span class="ident" id="1506889">flushlog</span><span class="op" id="1506897">(</span><span class="op" id="1506898">)</span>&nbsp;<span class="builtintype" id="1506900">bool</span>&nbsp;<span class="op" id="1506905">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506908">if</span>&nbsp;<span class="op" id="1506911">!</span><span class="ident" id="1506912">cas</span><span class="op" id="1506915">(</span><span class="op" id="1506916">&amp;</span><span class="ident" id="1506917">p</span><span class="op" id="1506918">.</span><span class="ident" id="1506919">handoff</span><span class="op" id="1506926">,</span>&nbsp;<span class="num" id="1506928">0</span><span class="op" id="1506929">,</span>&nbsp;<span class="builtintype" id="1506931">uint32</span><span class="op" id="1506937">(</span><span class="ident" id="1506938">p</span><span class="op" id="1506939">.</span><span class="ident" id="1506940">nlog</span><span class="op" id="1506944">)</span><span class="op" id="1506945">)</span>&nbsp;<span class="op" id="1506947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506951">return</span>&nbsp;<span class="builtintype" id="1506958">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506968">notewakeup</span><span class="op" id="1506978">(</span><span class="op" id="1506979">&amp;</span><span class="ident" id="1506980">p</span><span class="op" id="1506981">.</span><span class="ident" id="1506982">wait</span><span class="op" id="1506986">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506990">p</span><span class="op" id="1506991">.</span><span class="ident" id="1506992">toggle</span>&nbsp;<span class="op" id="1506999">=</span>&nbsp;<span class="num" id="1507001">1</span>&nbsp;<span class="op" id="1507003">-</span>&nbsp;<span class="ident" id="1507005">p</span><span class="op" id="1507006">.</span><span class="ident" id="1507007">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507015">log</span>&nbsp;<span class="op" id="1507019">:=</span>&nbsp;<span class="op" id="1507022">&amp;</span><span class="ident" id="1507023">p</span><span class="op" id="1507024">.</span><span class="ident" id="1507025">log</span><span class="op" id="1507028">[</span><span class="ident" id="1507029">p</span><span class="op" id="1507030">.</span><span class="ident" id="1507031">toggle</span><span class="op" id="1507037">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507040">q</span>&nbsp;<span class="op" id="1507042">:=</span>&nbsp;<span class="builtintype" id="1507045">uintptr</span><span class="op" id="1507052">(</span><span class="num" id="1507053">0</span><span class="op" id="1507054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507057">if</span>&nbsp;<span class="ident" id="1507060">p</span><span class="op" id="1507061">.</span><span class="ident" id="1507062">lost</span>&nbsp;<span class="op" id="1507067">&gt;</span>&nbsp;<span class="num" id="1507069">0</span>&nbsp;<span class="op" id="1507071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507075">lostPC</span>&nbsp;<span class="op" id="1507082">:=</span>&nbsp;<span class="ident" id="1507085">funcPC</span><span class="op" id="1507091">(</span><span class="ident" id="1507092">lostProfileData</span><span class="op" id="1507107">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507111">log</span><span class="op" id="1507114">[</span><span class="num" id="1507115">0</span><span class="op" id="1507116">]</span>&nbsp;<span class="op" id="1507118">=</span>&nbsp;<span class="ident" id="1507120">p</span><span class="op" id="1507121">.</span><span class="ident" id="1507122">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507129">log</span><span class="op" id="1507132">[</span><span class="num" id="1507133">1</span><span class="op" id="1507134">]</span>&nbsp;<span class="op" id="1507136">=</span>&nbsp;<span class="num" id="1507138">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507142">log</span><span class="op" id="1507145">[</span><span class="num" id="1507146">2</span><span class="op" id="1507147">]</span>&nbsp;<span class="op" id="1507149">=</span>&nbsp;<span class="ident" id="1507151">lostPC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507160">q</span>&nbsp;<span class="op" id="1507162">=</span>&nbsp;<span class="num" id="1507164">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507168">p</span><span class="op" id="1507169">.</span><span class="ident" id="1507170">lost</span>&nbsp;<span class="op" id="1507175">=</span>&nbsp;<span class="num" id="1507177">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507183">p</span><span class="op" id="1507184">.</span><span class="ident" id="1507185">nlog</span>&nbsp;<span class="op" id="1507190">=</span>&nbsp;<span class="ident" id="1507192">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507195">return</span>&nbsp;<span class="builtintype" id="1507202">true</span><br>
<span class="lineno"></span><span class="op" id="1507207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1507210">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1507283">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1507356">func</span>&nbsp;<span class="op" id="1507361">(</span><span class="ident" id="1507362">p</span>&nbsp;<span class="op" id="1507364">*</span><span class="ident" id="1507365">cpuProfile</span><span class="op" id="1507375">)</span>&nbsp;<span class="ident" id="1507377">getprofile</span><span class="op" id="1507387">(</span><span class="op" id="1507388">)</span>&nbsp;<span class="op" id="1507390">[</span><span class="op" id="1507391">]</span><span class="builtintype" id="1507392">byte</span>&nbsp;<span class="op" id="1507397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507400">if</span>&nbsp;<span class="ident" id="1507403">p</span>&nbsp;<span class="op" id="1507405">==</span>&nbsp;<span class="ident" id="1507408">nil</span>&nbsp;<span class="op" id="1507412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507416">return</span>&nbsp;<span class="ident" id="1507423">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507432">if</span>&nbsp;<span class="ident" id="1507435">p</span><span class="op" id="1507436">.</span><span class="ident" id="1507437">wholding</span>&nbsp;<span class="op" id="1507446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507450">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507501">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507563">for</span>&nbsp;<span class="op" id="1507567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507572">n</span>&nbsp;<span class="op" id="1507574">:=</span>&nbsp;<span class="ident" id="1507577">p</span><span class="op" id="1507578">.</span><span class="ident" id="1507579">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507590">if</span>&nbsp;<span class="ident" id="1507593">n</span>&nbsp;<span class="op" id="1507595">==</span>&nbsp;<span class="num" id="1507598">0</span>&nbsp;<span class="op" id="1507600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1507606">print</span><span class="op" id="1507611">(</span><span class="string" id="1507612">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1507663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507669">return</span>&nbsp;<span class="ident" id="1507676">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507688">if</span>&nbsp;<span class="ident" id="1507691">n</span><span class="op" id="1507692">&amp;</span><span class="num" id="1507693">0x80000000</span>&nbsp;<span class="op" id="1507704">!=</span>&nbsp;<span class="num" id="1507707">0</span>&nbsp;<span class="op" id="1507709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507715">p</span><span class="op" id="1507716">.</span><span class="ident" id="1507717">wtoggle</span>&nbsp;<span class="op" id="1507725">=</span>&nbsp;<span class="num" id="1507727">1</span>&nbsp;<span class="op" id="1507729">-</span>&nbsp;<span class="ident" id="1507731">p</span><span class="op" id="1507732">.</span><span class="ident" id="1507733">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507745">p</span><span class="op" id="1507746">.</span><span class="ident" id="1507747">wholding</span>&nbsp;<span class="op" id="1507756">=</span>&nbsp;<span class="builtintype" id="1507758">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507768">p</span><span class="op" id="1507769">.</span><span class="ident" id="1507770">flushing</span>&nbsp;<span class="op" id="1507779">=</span>&nbsp;<span class="builtintype" id="1507781">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507790">goto</span>&nbsp;<span class="ident" id="1507795">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507809">if</span>&nbsp;<span class="ident" id="1507812">cas</span><span class="op" id="1507815">(</span><span class="op" id="1507816">&amp;</span><span class="ident" id="1507817">p</span><span class="op" id="1507818">.</span><span class="ident" id="1507819">handoff</span><span class="op" id="1507826">,</span>&nbsp;<span class="ident" id="1507828">n</span><span class="op" id="1507829">,</span>&nbsp;<span class="num" id="1507831">0</span><span class="op" id="1507832">)</span>&nbsp;<span class="op" id="1507834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507840">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507849">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507857">p</span><span class="op" id="1507858">.</span><span class="ident" id="1507859">wtoggle</span>&nbsp;<span class="op" id="1507867">=</span>&nbsp;<span class="num" id="1507869">1</span>&nbsp;<span class="op" id="1507871">-</span>&nbsp;<span class="ident" id="1507873">p</span><span class="op" id="1507874">.</span><span class="ident" id="1507875">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507885">p</span><span class="op" id="1507886">.</span><span class="ident" id="1507887">wholding</span>&nbsp;<span class="op" id="1507896">=</span>&nbsp;<span class="builtintype" id="1507898">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507909">if</span>&nbsp;<span class="ident" id="1507912">p</span><span class="op" id="1507913">.</span><span class="ident" id="1507914">flushing</span>&nbsp;<span class="op" id="1507923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507927">goto</span>&nbsp;<span class="ident" id="1507932">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507943">if</span>&nbsp;<span class="op" id="1507946">!</span><span class="ident" id="1507947">p</span><span class="op" id="1507948">.</span><span class="ident" id="1507949">on</span>&nbsp;<span class="op" id="1507952">&amp;&amp;</span>&nbsp;<span class="ident" id="1507955">p</span><span class="op" id="1507956">.</span><span class="ident" id="1507957">handoff</span>&nbsp;<span class="op" id="1507965">==</span>&nbsp;<span class="num" id="1507968">0</span>&nbsp;<span class="op" id="1507970">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507974">return</span>&nbsp;<span class="ident" id="1507981">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507990">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508012">notetsleepg</span><span class="op" id="1508023">(</span><span class="op" id="1508024">&amp;</span><span class="ident" id="1508025">p</span><span class="op" id="1508026">.</span><span class="ident" id="1508027">wait</span><span class="op" id="1508031">,</span>&nbsp;<span class="op" id="1508033">-</span><span class="num" id="1508034">1</span><span class="op" id="1508035">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508038">noteclear</span><span class="op" id="1508047">(</span><span class="op" id="1508048">&amp;</span><span class="ident" id="1508049">p</span><span class="op" id="1508050">.</span><span class="ident" id="1508051">wait</span><span class="op" id="1508055">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508059">switch</span>&nbsp;<span class="ident" id="1508066">n</span>&nbsp;<span class="op" id="1508068">:=</span>&nbsp;<span class="ident" id="1508071">p</span><span class="op" id="1508072">.</span><span class="ident" id="1508073">handoff</span><span class="op" id="1508080">;</span>&nbsp;<span class="op" id="1508082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508085">case</span>&nbsp;<span class="ident" id="1508090">n</span>&nbsp;<span class="op" id="1508092">==</span>&nbsp;<span class="num" id="1508095">0</span><span class="op" id="1508096">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1508100">print</span><span class="op" id="1508105">(</span><span class="string" id="1508106">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1508154">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508158">return</span>&nbsp;<span class="ident" id="1508165">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508170">case</span>&nbsp;<span class="ident" id="1508175">n</span>&nbsp;<span class="op" id="1508177">==</span>&nbsp;<span class="num" id="1508180">0x80000000</span><span class="op" id="1508190">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508194">p</span><span class="op" id="1508195">.</span><span class="ident" id="1508196">flushing</span>&nbsp;<span class="op" id="1508205">=</span>&nbsp;<span class="builtintype" id="1508207">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508214">goto</span>&nbsp;<span class="ident" id="1508219">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508226">default</span><span class="op" id="1508233">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508237">n</span>&nbsp;<span class="op" id="1508239">&amp;^=</span>&nbsp;<span class="num" id="1508243">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508257">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508288">p</span><span class="op" id="1508289">.</span><span class="ident" id="1508290">wholding</span>&nbsp;<span class="op" id="1508299">=</span>&nbsp;<span class="builtintype" id="1508301">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508309">return</span>&nbsp;<span class="ident" id="1508316">uintptrBytes</span><span class="op" id="1508328">(</span><span class="ident" id="1508329">p</span><span class="op" id="1508330">.</span><span class="ident" id="1508331">log</span><span class="op" id="1508334">[</span><span class="ident" id="1508335">p</span><span class="op" id="1508336">.</span><span class="ident" id="1508337">wtoggle</span><span class="op" id="1508344">]</span><span class="op" id="1508345">[</span><span class="op" id="1508346">:</span><span class="ident" id="1508347">n</span><span class="op" id="1508348">]</span><span class="op" id="1508349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508356">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508375">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508427">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508492">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1508544">Flush</span><span class="op" id="1508549">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508552">for</span>&nbsp;<span class="ident" id="1508556">i</span>&nbsp;<span class="op" id="1508558">:=</span>&nbsp;<span class="keyword" id="1508561">range</span>&nbsp;<span class="ident" id="1508567">p</span><span class="op" id="1508568">.</span><span class="ident" id="1508569">hash</span>&nbsp;<span class="op" id="1508574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508578">b</span>&nbsp;<span class="op" id="1508580">:=</span>&nbsp;<span class="op" id="1508583">&amp;</span><span class="ident" id="1508584">p</span><span class="op" id="1508585">.</span><span class="ident" id="1508586">hash</span><span class="op" id="1508590">[</span><span class="ident" id="1508591">i</span><span class="op" id="1508592">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508596">for</span>&nbsp;<span class="ident" id="1508600">j</span>&nbsp;<span class="op" id="1508602">:=</span>&nbsp;<span class="keyword" id="1508605">range</span>&nbsp;<span class="ident" id="1508611">b</span><span class="op" id="1508612">.</span><span class="ident" id="1508613">entry</span>&nbsp;<span class="op" id="1508619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508624">e</span>&nbsp;<span class="op" id="1508626">:=</span>&nbsp;<span class="op" id="1508629">&amp;</span><span class="ident" id="1508630">b</span><span class="op" id="1508631">.</span><span class="ident" id="1508632">entry</span><span class="op" id="1508637">[</span><span class="ident" id="1508638">j</span><span class="op" id="1508639">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508644">if</span>&nbsp;<span class="ident" id="1508647">e</span><span class="op" id="1508648">.</span><span class="ident" id="1508649">count</span>&nbsp;<span class="op" id="1508655">&gt;</span>&nbsp;<span class="num" id="1508657">0</span>&nbsp;<span class="op" id="1508659">&amp;&amp;</span>&nbsp;<span class="op" id="1508662">!</span><span class="ident" id="1508663">p</span><span class="op" id="1508664">.</span><span class="ident" id="1508665">evict</span><span class="op" id="1508670">(</span><span class="ident" id="1508671">e</span><span class="op" id="1508672">)</span>&nbsp;<span class="op" id="1508674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508680">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508745">break</span>&nbsp;<span class="ident" id="1508751">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508771">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508800">if</span>&nbsp;<span class="ident" id="1508803">p</span><span class="op" id="1508804">.</span><span class="ident" id="1508805">nlog</span>&nbsp;<span class="op" id="1508810">&gt;</span>&nbsp;<span class="num" id="1508812">0</span>&nbsp;<span class="op" id="1508814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508818">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508870">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508918">n</span>&nbsp;<span class="op" id="1508920">:=</span>&nbsp;<span class="ident" id="1508923">p</span><span class="op" id="1508924">.</span><span class="ident" id="1508925">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508932">p</span><span class="op" id="1508933">.</span><span class="ident" id="1508934">nlog</span>&nbsp;<span class="op" id="1508939">=</span>&nbsp;<span class="num" id="1508941">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508945">return</span>&nbsp;<span class="ident" id="1508952">uintptrBytes</span><span class="op" id="1508964">(</span><span class="ident" id="1508965">p</span><span class="op" id="1508966">.</span><span class="ident" id="1508967">log</span><span class="op" id="1508970">[</span><span class="ident" id="1508971">p</span><span class="op" id="1508972">.</span><span class="ident" id="1508973">toggle</span><span class="op" id="1508979">]</span><span class="op" id="1508980">[</span><span class="op" id="1508981">:</span><span class="ident" id="1508982">n</span><span class="op" id="1508983">]</span><span class="op" id="1508984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508991">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509054">if</span>&nbsp;<span class="op" id="1509057">!</span><span class="ident" id="1509058">p</span><span class="op" id="1509059">.</span><span class="ident" id="1509060">eodSent</span>&nbsp;<span class="op" id="1509068">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1509072">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1509138">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509203">p</span><span class="op" id="1509204">.</span><span class="ident" id="1509205">eodSent</span>&nbsp;<span class="op" id="1509213">=</span>&nbsp;<span class="builtintype" id="1509215">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509222">return</span>&nbsp;<span class="ident" id="1509229">uintptrBytes</span><span class="op" id="1509241">(</span><span class="ident" id="1509242">eod</span><span class="op" id="1509245">[</span><span class="op" id="1509246">:</span><span class="op" id="1509247">]</span><span class="op" id="1509248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509251">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1509255">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509299">p</span><span class="op" id="1509300">.</span><span class="ident" id="1509301">flushing</span>&nbsp;<span class="op" id="1509310">=</span>&nbsp;<span class="builtintype" id="1509312">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509319">if</span>&nbsp;<span class="op" id="1509322">!</span><span class="ident" id="1509323">cas</span><span class="op" id="1509326">(</span><span class="op" id="1509327">&amp;</span><span class="ident" id="1509328">p</span><span class="op" id="1509329">.</span><span class="ident" id="1509330">handoff</span><span class="op" id="1509337">,</span>&nbsp;<span class="ident" id="1509339">p</span><span class="op" id="1509340">.</span><span class="ident" id="1509341">handoff</span><span class="op" id="1509348">,</span>&nbsp;<span class="num" id="1509350">0</span><span class="op" id="1509351">)</span>&nbsp;<span class="op" id="1509353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1509357">print</span><span class="op" id="1509362">(</span><span class="string" id="1509363">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1509411">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509417">return</span>&nbsp;<span class="ident" id="1509424">nil</span><br>
<span class="lineno"></span><span class="op" id="1509428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1509431">func</span>&nbsp;<span class="ident" id="1509436">uintptrBytes</span><span class="op" id="1509448">(</span><span class="ident" id="1509449">p</span>&nbsp;<span class="op" id="1509451">[</span><span class="op" id="1509452">]</span><span class="builtintype" id="1509453">uintptr</span><span class="op" id="1509460">)</span>&nbsp;<span class="op" id="1509462">(</span><span class="ident" id="1509463">ret</span>&nbsp;<span class="op" id="1509467">[</span><span class="op" id="1509468">]</span><span class="builtintype" id="1509469">byte</span><span class="op" id="1509473">)</span>&nbsp;<span class="op" id="1509475">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509478">pp</span>&nbsp;<span class="op" id="1509481">:=</span>&nbsp;<span class="op" id="1509484">(</span><span class="op" id="1509485">*</span><span class="ident" id="1509486">sliceStruct</span><span class="op" id="1509497">)</span><span class="op" id="1509498">(</span><span class="ident" id="1509499">unsafe</span><span class="op" id="1509505">.</span><span class="ident" id="1509506">Pointer</span><span class="op" id="1509513">(</span><span class="op" id="1509514">&amp;</span><span class="ident" id="1509515">p</span><span class="op" id="1509516">)</span><span class="op" id="1509517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509520">rp</span>&nbsp;<span class="op" id="1509523">:=</span>&nbsp;<span class="op" id="1509526">(</span><span class="op" id="1509527">*</span><span class="ident" id="1509528">sliceStruct</span><span class="op" id="1509539">)</span><span class="op" id="1509540">(</span><span class="ident" id="1509541">unsafe</span><span class="op" id="1509547">.</span><span class="ident" id="1509548">Pointer</span><span class="op" id="1509555">(</span><span class="op" id="1509556">&amp;</span><span class="ident" id="1509557">ret</span><span class="op" id="1509560">)</span><span class="op" id="1509561">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509565">rp</span><span class="op" id="1509567">.</span><span class="ident" id="1509568">array</span>&nbsp;<span class="op" id="1509574">=</span>&nbsp;<span class="ident" id="1509576">pp</span><span class="op" id="1509578">.</span><span class="ident" id="1509579">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509586">rp</span><span class="op" id="1509588">.</span><span class="builtinfunc" id="1509589">len</span>&nbsp;<span class="op" id="1509593">=</span>&nbsp;<span class="ident" id="1509595">pp</span><span class="op" id="1509597">.</span><span class="builtinfunc" id="1509598">len</span>&nbsp;<span class="op" id="1509602">*</span>&nbsp;<span class="builtintype" id="1509604">int</span><span class="op" id="1509607">(</span><span class="ident" id="1509608">unsafe</span><span class="op" id="1509614">.</span><span class="ident" id="1509615">Sizeof</span><span class="op" id="1509621">(</span><span class="ident" id="1509622">p</span><span class="op" id="1509623">[</span><span class="num" id="1509624">0</span><span class="op" id="1509625">]</span><span class="op" id="1509626">)</span><span class="op" id="1509627">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509630">rp</span><span class="op" id="1509632">.</span><span class="builtinfunc" id="1509633">cap</span>&nbsp;<span class="op" id="1509637">=</span>&nbsp;<span class="ident" id="1509639">rp</span><span class="op" id="1509641">.</span><span class="builtinfunc" id="1509642">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509648">return</span><br>
<span class="lineno"></span><span class="op" id="1509655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1509658">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1509737">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1509822">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1509901">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1509976">//</span><br>
<span class="lineno">420</span><span class="comment" id="1509979">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1510035">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1510101">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1510125">func</span>&nbsp;<span class="ident" id="1510130">CPUProfile</span><span class="op" id="1510140">(</span><span class="op" id="1510141">)</span>&nbsp;<span class="op" id="1510143">[</span><span class="op" id="1510144">]</span><span class="builtintype" id="1510145">byte</span>&nbsp;<span class="op" id="1510150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510153">return</span>&nbsp;<span class="ident" id="1510160">cpuprof</span><span class="op" id="1510167">.</span><span class="ident" id="1510168">getprofile</span><span class="op" id="1510178">(</span><span class="op" id="1510179">)</span><br>
<span class="lineno">425</span><span class="op" id="1510181">}</span>
</div>
</body>
</html>
