<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html" class="current">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5904049">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5904104">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5904158">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5904209">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5904264">package</span>&nbsp;<span class="ident" id="5904272">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5904277">import</span>&nbsp;<span class="op" id="5904284">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5904287">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5904299">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5904307">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="5904317">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5904320">const</span>&nbsp;<span class="ident" id="5904326">uint64Size</span>&nbsp;<span class="op" id="5904337">=</span>&nbsp;<span class="num" id="5904339">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5904342">type</span>&nbsp;<span class="ident" id="5904347">encHelper</span>&nbsp;<span class="keyword" id="5904357">func</span><span class="op" id="5904361">(</span><span class="ident" id="5904362">state</span>&nbsp;<span class="op" id="5904368">*</span><span class="ident" id="5904369">encoderState</span><span class="op" id="5904381">,</span>&nbsp;<span class="ident" id="5904383">v</span>&nbsp;<span class="ident" id="5904385">reflect</span><span class="op" id="5904392">.</span><span class="ident" id="5904393">Value</span><span class="op" id="5904398">)</span>&nbsp;<span class="builtintype" id="5904400">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5904406">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="5904483">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="5904549">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5904619">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="5904650">type</span>&nbsp;<span class="ident" id="5904655">encoderState</span>&nbsp;<span class="keyword" id="5904668">struct</span>&nbsp;<span class="op" id="5904675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904678">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5904687">*</span><span class="ident" id="5904688">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904697">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5904706">*</span><span class="ident" id="5904707">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904718">sendZero</span>&nbsp;<span class="builtintype" id="5904727">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904748">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904818">fieldnum</span>&nbsp;<span class="builtintype" id="5904827">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904848">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904883">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5904892">[</span><span class="num" id="5904893">1</span>&nbsp;<span class="op" id="5904895">+</span>&nbsp;<span class="ident" id="5904897">uint64Size</span><span class="op" id="5904907">]</span><span class="builtintype" id="5904908">byte</span>&nbsp;<span class="comment" id="5904913">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904971">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5904980">*</span><span class="ident" id="5904981">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5905001">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="5905018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5905021">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="5905107">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5905202">type</span>&nbsp;<span class="ident" id="5905207">encBuffer</span>&nbsp;<span class="keyword" id="5905217">struct</span>&nbsp;<span class="op" id="5905224">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905227">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5905235">[</span><span class="op" id="5905236">]</span><span class="builtintype" id="5905237">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905243">scratch</span>&nbsp;<span class="op" id="5905251">[</span><span class="num" id="5905252">64</span><span class="op" id="5905254">]</span><span class="builtintype" id="5905255">byte</span><br>
<span class="lineno"></span><span class="op" id="5905260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5905263">func</span>&nbsp;<span class="op" id="5905268">(</span><span class="ident" id="5905269">e</span>&nbsp;<span class="op" id="5905271">*</span><span class="ident" id="5905272">encBuffer</span><span class="op" id="5905281">)</span>&nbsp;<span class="ident" id="5905283">WriteByte</span><span class="op" id="5905292">(</span><span class="ident" id="5905293">c</span>&nbsp;<span class="builtintype" id="5905295">byte</span><span class="op" id="5905299">)</span>&nbsp;<span class="op" id="5905301">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905304">e</span><span class="op" id="5905305">.</span><span class="ident" id="5905306">data</span>&nbsp;<span class="op" id="5905311">=</span>&nbsp;<span class="builtinfunc" id="5905313">append</span><span class="op" id="5905319">(</span><span class="ident" id="5905320">e</span><span class="op" id="5905321">.</span><span class="ident" id="5905322">data</span><span class="op" id="5905326">,</span>&nbsp;<span class="ident" id="5905328">c</span><span class="op" id="5905329">)</span><br>
<span class="lineno"></span><span class="op" id="5905331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5905334">func</span>&nbsp;<span class="op" id="5905339">(</span><span class="ident" id="5905340">e</span>&nbsp;<span class="op" id="5905342">*</span><span class="ident" id="5905343">encBuffer</span><span class="op" id="5905352">)</span>&nbsp;<span class="ident" id="5905354">Write</span><span class="op" id="5905359">(</span><span class="ident" id="5905360">p</span>&nbsp;<span class="op" id="5905362">[</span><span class="op" id="5905363">]</span><span class="builtintype" id="5905364">byte</span><span class="op" id="5905368">)</span>&nbsp;<span class="op" id="5905370">(</span><span class="builtintype" id="5905371">int</span><span class="op" id="5905374">,</span>&nbsp;<span class="builtintype" id="5905376">error</span><span class="op" id="5905381">)</span>&nbsp;<span class="op" id="5905383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905386">e</span><span class="op" id="5905387">.</span><span class="ident" id="5905388">data</span>&nbsp;<span class="op" id="5905393">=</span>&nbsp;<span class="builtinfunc" id="5905395">append</span><span class="op" id="5905401">(</span><span class="ident" id="5905402">e</span><span class="op" id="5905403">.</span><span class="ident" id="5905404">data</span><span class="op" id="5905408">,</span>&nbsp;<span class="ident" id="5905410">p</span><span class="op" id="5905411">...</span><span class="op" id="5905414">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5905417">return</span>&nbsp;<span class="builtinfunc" id="5905424">len</span><span class="op" id="5905427">(</span><span class="ident" id="5905428">p</span><span class="op" id="5905429">)</span><span class="op" id="5905430">,</span>&nbsp;<span class="builtintype" id="5905432">nil</span><br>
<span class="lineno"></span><span class="op" id="5905436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5905439">func</span>&nbsp;<span class="op" id="5905444">(</span><span class="ident" id="5905445">e</span>&nbsp;<span class="op" id="5905447">*</span><span class="ident" id="5905448">encBuffer</span><span class="op" id="5905457">)</span>&nbsp;<span class="ident" id="5905459">WriteString</span><span class="op" id="5905470">(</span><span class="ident" id="5905471">s</span>&nbsp;<span class="builtintype" id="5905473">string</span><span class="op" id="5905479">)</span>&nbsp;<span class="op" id="5905481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905484">e</span><span class="op" id="5905485">.</span><span class="ident" id="5905486">data</span>&nbsp;<span class="op" id="5905491">=</span>&nbsp;<span class="builtinfunc" id="5905493">append</span><span class="op" id="5905499">(</span><span class="ident" id="5905500">e</span><span class="op" id="5905501">.</span><span class="ident" id="5905502">data</span><span class="op" id="5905506">,</span>&nbsp;<span class="ident" id="5905508">s</span><span class="op" id="5905509">...</span><span class="op" id="5905512">)</span><br>
<span class="lineno">50</span><span class="op" id="5905514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5905517">func</span>&nbsp;<span class="op" id="5905522">(</span><span class="ident" id="5905523">e</span>&nbsp;<span class="op" id="5905525">*</span><span class="ident" id="5905526">encBuffer</span><span class="op" id="5905535">)</span>&nbsp;<span class="ident" id="5905537">Len</span><span class="op" id="5905540">(</span><span class="op" id="5905541">)</span>&nbsp;<span class="builtintype" id="5905543">int</span>&nbsp;<span class="op" id="5905547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5905550">return</span>&nbsp;<span class="builtinfunc" id="5905557">len</span><span class="op" id="5905560">(</span><span class="ident" id="5905561">e</span><span class="op" id="5905562">.</span><span class="ident" id="5905563">data</span><span class="op" id="5905567">)</span><br>
<span class="lineno"></span><span class="op" id="5905569">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="5905572">func</span>&nbsp;<span class="op" id="5905577">(</span><span class="ident" id="5905578">e</span>&nbsp;<span class="op" id="5905580">*</span><span class="ident" id="5905581">encBuffer</span><span class="op" id="5905590">)</span>&nbsp;<span class="ident" id="5905592">Bytes</span><span class="op" id="5905597">(</span><span class="op" id="5905598">)</span>&nbsp;<span class="op" id="5905600">[</span><span class="op" id="5905601">]</span><span class="builtintype" id="5905602">byte</span>&nbsp;<span class="op" id="5905607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5905610">return</span>&nbsp;<span class="ident" id="5905617">e</span><span class="op" id="5905618">.</span><span class="ident" id="5905619">data</span><br>
<span class="lineno"></span><span class="op" id="5905624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5905627">func</span>&nbsp;<span class="op" id="5905632">(</span><span class="ident" id="5905633">e</span>&nbsp;<span class="op" id="5905635">*</span><span class="ident" id="5905636">encBuffer</span><span class="op" id="5905645">)</span>&nbsp;<span class="ident" id="5905647">Reset</span><span class="op" id="5905652">(</span><span class="op" id="5905653">)</span>&nbsp;<span class="op" id="5905655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905658">e</span><span class="op" id="5905659">.</span><span class="ident" id="5905660">data</span>&nbsp;<span class="op" id="5905665">=</span>&nbsp;<span class="ident" id="5905667">e</span><span class="op" id="5905668">.</span><span class="ident" id="5905669">data</span><span class="op" id="5905673">[</span><span class="num" id="5905674">0</span><span class="op" id="5905675">:</span><span class="num" id="5905676">0</span><span class="op" id="5905677">]</span><br>
<span class="lineno"></span><span class="op" id="5905679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5905682">func</span>&nbsp;<span class="op" id="5905687">(</span><span class="ident" id="5905688">enc</span>&nbsp;<span class="op" id="5905692">*</span><span class="ident" id="5905693">Encoder</span><span class="op" id="5905700">)</span>&nbsp;<span class="ident" id="5905702">newEncoderState</span><span class="op" id="5905717">(</span><span class="ident" id="5905718">b</span>&nbsp;<span class="op" id="5905720">*</span><span class="ident" id="5905721">encBuffer</span><span class="op" id="5905730">)</span>&nbsp;<span class="op" id="5905732">*</span><span class="ident" id="5905733">encoderState</span>&nbsp;<span class="op" id="5905746">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905749">e</span>&nbsp;<span class="op" id="5905751">:=</span>&nbsp;<span class="ident" id="5905754">enc</span><span class="op" id="5905757">.</span><span class="ident" id="5905758">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5905768">if</span>&nbsp;<span class="ident" id="5905771">e</span>&nbsp;<span class="op" id="5905773">==</span>&nbsp;<span class="builtintype" id="5905776">nil</span>&nbsp;<span class="op" id="5905780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905784">e</span>&nbsp;<span class="op" id="5905786">=</span>&nbsp;<span class="builtinfunc" id="5905788">new</span><span class="op" id="5905791">(</span><span class="ident" id="5905792">encoderState</span><span class="op" id="5905804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905808">e</span><span class="op" id="5905809">.</span><span class="ident" id="5905810">enc</span>&nbsp;<span class="op" id="5905814">=</span>&nbsp;<span class="ident" id="5905816">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5905821">}</span>&nbsp;<span class="keyword" id="5905823">else</span>&nbsp;<span class="op" id="5905828">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905832">enc</span><span class="op" id="5905835">.</span><span class="ident" id="5905836">freeList</span>&nbsp;<span class="op" id="5905845">=</span>&nbsp;<span class="ident" id="5905847">e</span><span class="op" id="5905848">.</span><span class="ident" id="5905849">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5905855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905858">e</span><span class="op" id="5905859">.</span><span class="ident" id="5905860">sendZero</span>&nbsp;<span class="op" id="5905869">=</span>&nbsp;<span class="builtintype" id="5905871">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905878">e</span><span class="op" id="5905879">.</span><span class="ident" id="5905880">fieldnum</span>&nbsp;<span class="op" id="5905889">=</span>&nbsp;<span class="num" id="5905891">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905894">e</span><span class="op" id="5905895">.</span><span class="ident" id="5905896">b</span>&nbsp;<span class="op" id="5905898">=</span>&nbsp;<span class="ident" id="5905900">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5905903">if</span>&nbsp;<span class="builtinfunc" id="5905906">len</span><span class="op" id="5905909">(</span><span class="ident" id="5905910">b</span><span class="op" id="5905911">.</span><span class="ident" id="5905912">data</span><span class="op" id="5905916">)</span>&nbsp;<span class="op" id="5905918">==</span>&nbsp;<span class="num" id="5905921">0</span>&nbsp;<span class="op" id="5905923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905927">b</span><span class="op" id="5905928">.</span><span class="ident" id="5905929">data</span>&nbsp;<span class="op" id="5905934">=</span>&nbsp;<span class="ident" id="5905936">b</span><span class="op" id="5905937">.</span><span class="ident" id="5905938">scratch</span><span class="op" id="5905945">[</span><span class="num" id="5905946">0</span><span class="op" id="5905947">:</span><span class="num" id="5905948">0</span><span class="op" id="5905949">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5905952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5905955">return</span>&nbsp;<span class="ident" id="5905962">e</span><br>
<span class="lineno"></span><span class="op" id="5905964">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="5905967">func</span>&nbsp;<span class="op" id="5905972">(</span><span class="ident" id="5905973">enc</span>&nbsp;<span class="op" id="5905977">*</span><span class="ident" id="5905978">Encoder</span><span class="op" id="5905985">)</span>&nbsp;<span class="ident" id="5905987">freeEncoderState</span><span class="op" id="5906003">(</span><span class="ident" id="5906004">e</span>&nbsp;<span class="op" id="5906006">*</span><span class="ident" id="5906007">encoderState</span><span class="op" id="5906019">)</span>&nbsp;<span class="op" id="5906021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906024">e</span><span class="op" id="5906025">.</span><span class="ident" id="5906026">next</span>&nbsp;<span class="op" id="5906031">=</span>&nbsp;<span class="ident" id="5906033">enc</span><span class="op" id="5906036">.</span><span class="ident" id="5906037">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906047">enc</span><span class="op" id="5906050">.</span><span class="ident" id="5906051">freeList</span>&nbsp;<span class="op" id="5906060">=</span>&nbsp;<span class="ident" id="5906062">e</span><br>
<span class="lineno"></span><span class="op" id="5906064">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="5906067">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="5906138">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="5906199">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="5906267">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="5906300">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="5906361">func</span>&nbsp;<span class="op" id="5906366">(</span><span class="ident" id="5906367">state</span>&nbsp;<span class="op" id="5906373">*</span><span class="ident" id="5906374">encoderState</span><span class="op" id="5906386">)</span>&nbsp;<span class="ident" id="5906388">encodeUint</span><span class="op" id="5906398">(</span><span class="ident" id="5906399">x</span>&nbsp;<span class="ident" id="5906401">uint64</span><span class="op" id="5906407">)</span>&nbsp;<span class="op" id="5906409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906412">if</span>&nbsp;<span class="ident" id="5906415">x</span>&nbsp;<span class="op" id="5906417">&lt;=</span>&nbsp;<span class="num" id="5906420">0x7F</span>&nbsp;<span class="op" id="5906425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906429">state</span><span class="op" id="5906434">.</span><span class="ident" id="5906435">b</span><span class="op" id="5906436">.</span><span class="ident" id="5906437">WriteByte</span><span class="op" id="5906446">(</span><span class="builtintype" id="5906447">uint8</span><span class="op" id="5906452">(</span><span class="ident" id="5906453">x</span><span class="op" id="5906454">)</span><span class="op" id="5906455">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906459">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5906467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906470">i</span>&nbsp;<span class="op" id="5906472">:=</span>&nbsp;<span class="ident" id="5906475">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906487">for</span>&nbsp;<span class="ident" id="5906491">x</span>&nbsp;<span class="op" id="5906493">&gt;</span>&nbsp;<span class="num" id="5906495">0</span>&nbsp;<span class="op" id="5906497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906501">state</span><span class="op" id="5906506">.</span><span class="ident" id="5906507">buf</span><span class="op" id="5906510">[</span><span class="ident" id="5906511">i</span><span class="op" id="5906512">]</span>&nbsp;<span class="op" id="5906514">=</span>&nbsp;<span class="builtintype" id="5906516">uint8</span><span class="op" id="5906521">(</span><span class="ident" id="5906522">x</span><span class="op" id="5906523">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906527">x</span>&nbsp;<span class="op" id="5906529">&gt;&gt;=</span>&nbsp;<span class="num" id="5906533">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906537">i</span><span class="op" id="5906538">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5906542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906545">state</span><span class="op" id="5906550">.</span><span class="ident" id="5906551">buf</span><span class="op" id="5906554">[</span><span class="ident" id="5906555">i</span><span class="op" id="5906556">]</span>&nbsp;<span class="op" id="5906558">=</span>&nbsp;<span class="builtintype" id="5906560">uint8</span><span class="op" id="5906565">(</span><span class="ident" id="5906566">i</span>&nbsp;<span class="op" id="5906568">-</span>&nbsp;<span class="ident" id="5906570">uint64Size</span><span class="op" id="5906580">)</span>&nbsp;<span class="comment" id="5906582">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906608">state</span><span class="op" id="5906613">.</span><span class="ident" id="5906614">b</span><span class="op" id="5906615">.</span><span class="ident" id="5906616">Write</span><span class="op" id="5906621">(</span><span class="ident" id="5906622">state</span><span class="op" id="5906627">.</span><span class="ident" id="5906628">buf</span><span class="op" id="5906631">[</span><span class="ident" id="5906632">i</span>&nbsp;<span class="op" id="5906634">:</span>&nbsp;<span class="ident" id="5906636">uint64Size</span><span class="op" id="5906646">+</span><span class="num" id="5906647">1</span><span class="op" id="5906648">]</span><span class="op" id="5906649">)</span><br>
<span class="lineno">105</span><span class="op" id="5906651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5906654">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="5906712">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="5906798">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="5906826">func</span>&nbsp;<span class="op" id="5906831">(</span><span class="ident" id="5906832">state</span>&nbsp;<span class="op" id="5906838">*</span><span class="ident" id="5906839">encoderState</span><span class="op" id="5906851">)</span>&nbsp;<span class="ident" id="5906853">encodeInt</span><span class="op" id="5906862">(</span><span class="ident" id="5906863">i</span>&nbsp;<span class="ident" id="5906865">int64</span><span class="op" id="5906870">)</span>&nbsp;<span class="op" id="5906872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906875">var</span>&nbsp;<span class="ident" id="5906879">x</span>&nbsp;<span class="ident" id="5906881">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906889">if</span>&nbsp;<span class="ident" id="5906892">i</span>&nbsp;<span class="op" id="5906894">&lt;</span>&nbsp;<span class="num" id="5906896">0</span>&nbsp;<span class="op" id="5906898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906902">x</span>&nbsp;<span class="op" id="5906904">=</span>&nbsp;<span class="ident" id="5906906">uint64</span><span class="op" id="5906912">(</span><span class="op" id="5906913">^</span><span class="ident" id="5906914">i</span><span class="op" id="5906915">&lt;&lt;</span><span class="num" id="5906917">1</span><span class="op" id="5906918">)</span>&nbsp;<span class="op" id="5906920">|</span>&nbsp;<span class="num" id="5906922">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5906925">}</span>&nbsp;<span class="keyword" id="5906927">else</span>&nbsp;<span class="op" id="5906932">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906936">x</span>&nbsp;<span class="op" id="5906938">=</span>&nbsp;<span class="ident" id="5906940">uint64</span><span class="op" id="5906946">(</span><span class="ident" id="5906947">i</span>&nbsp;<span class="op" id="5906949">&lt;&lt;</span>&nbsp;<span class="num" id="5906952">1</span><span class="op" id="5906953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5906956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906959">state</span><span class="op" id="5906964">.</span><span class="ident" id="5906965">encodeUint</span><span class="op" id="5906975">(</span><span class="ident" id="5906976">uint64</span><span class="op" id="5906982">(</span><span class="ident" id="5906983">x</span><span class="op" id="5906984">)</span><span class="op" id="5906985">)</span><br>
<span class="lineno"></span><span class="op" id="5906987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="5906990">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5907058">type</span>&nbsp;<span class="ident" id="5907063">encOp</span>&nbsp;<span class="keyword" id="5907069">func</span><span class="op" id="5907073">(</span><span class="ident" id="5907074">i</span>&nbsp;<span class="op" id="5907076">*</span><span class="ident" id="5907077">encInstr</span><span class="op" id="5907085">,</span>&nbsp;<span class="ident" id="5907087">state</span>&nbsp;<span class="op" id="5907093">*</span><span class="ident" id="5907094">encoderState</span><span class="op" id="5907106">,</span>&nbsp;<span class="ident" id="5907108">v</span>&nbsp;<span class="ident" id="5907110">reflect</span><span class="op" id="5907117">.</span><span class="ident" id="5907118">Value</span><span class="op" id="5907123">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5907126">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="5907172">type</span>&nbsp;<span class="ident" id="5907177">encInstr</span>&nbsp;<span class="keyword" id="5907186">struct</span>&nbsp;<span class="op" id="5907193">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907196">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907202">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907209">field</span>&nbsp;<span class="builtintype" id="5907215">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5907221">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907247">index</span>&nbsp;<span class="op" id="5907253">[</span><span class="op" id="5907254">]</span><span class="builtintype" id="5907255">int</span>&nbsp;<span class="comment" id="5907259">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907276">indir</span>&nbsp;<span class="builtintype" id="5907282">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5907288">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="5907354">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5907357">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="5907450">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="5907504">func</span>&nbsp;<span class="op" id="5907509">(</span><span class="ident" id="5907510">state</span>&nbsp;<span class="op" id="5907516">*</span><span class="ident" id="5907517">encoderState</span><span class="op" id="5907529">)</span>&nbsp;<span class="ident" id="5907531">update</span><span class="op" id="5907537">(</span><span class="ident" id="5907538">instr</span>&nbsp;<span class="op" id="5907544">*</span><span class="ident" id="5907545">encInstr</span><span class="op" id="5907553">)</span>&nbsp;<span class="op" id="5907555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907558">if</span>&nbsp;<span class="ident" id="5907561">instr</span>&nbsp;<span class="op" id="5907567">!=</span>&nbsp;<span class="builtintype" id="5907570">nil</span>&nbsp;<span class="op" id="5907574">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907578">state</span><span class="op" id="5907583">.</span><span class="ident" id="5907584">encodeUint</span><span class="op" id="5907594">(</span><span class="ident" id="5907595">uint64</span><span class="op" id="5907601">(</span><span class="ident" id="5907602">instr</span><span class="op" id="5907607">.</span><span class="ident" id="5907608">field</span>&nbsp;<span class="op" id="5907614">-</span>&nbsp;<span class="ident" id="5907616">state</span><span class="op" id="5907621">.</span><span class="ident" id="5907622">fieldnum</span><span class="op" id="5907630">)</span><span class="op" id="5907631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907635">state</span><span class="op" id="5907640">.</span><span class="ident" id="5907641">fieldnum</span>&nbsp;<span class="op" id="5907650">=</span>&nbsp;<span class="ident" id="5907652">instr</span><span class="op" id="5907657">.</span><span class="ident" id="5907658">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5907665">}</span><br>
<span class="lineno"></span><span class="op" id="5907667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="5907670">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="5907734">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="5907802">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5907869">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="5907936">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="5908000">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5908067">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="5908133">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5908145">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="5908212">func</span>&nbsp;<span class="ident" id="5908217">encIndirect</span><span class="op" id="5908228">(</span><span class="ident" id="5908229">pv</span>&nbsp;<span class="ident" id="5908232">reflect</span><span class="op" id="5908239">.</span><span class="ident" id="5908240">Value</span><span class="op" id="5908245">,</span>&nbsp;<span class="ident" id="5908247">indir</span>&nbsp;<span class="builtintype" id="5908253">int</span><span class="op" id="5908256">)</span>&nbsp;<span class="ident" id="5908258">reflect</span><span class="op" id="5908265">.</span><span class="ident" id="5908266">Value</span>&nbsp;<span class="op" id="5908272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908275">for</span>&nbsp;<span class="op" id="5908279">;</span>&nbsp;<span class="ident" id="5908281">indir</span>&nbsp;<span class="op" id="5908287">&gt;</span>&nbsp;<span class="num" id="5908289">0</span><span class="op" id="5908290">;</span>&nbsp;<span class="ident" id="5908292">indir</span><span class="op" id="5908297">--</span>&nbsp;<span class="op" id="5908300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908304">if</span>&nbsp;<span class="ident" id="5908307">pv</span><span class="op" id="5908309">.</span><span class="ident" id="5908310">IsNil</span><span class="op" id="5908315">(</span><span class="op" id="5908316">)</span>&nbsp;<span class="op" id="5908318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908323">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908331">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908335">pv</span>&nbsp;<span class="op" id="5908338">=</span>&nbsp;<span class="ident" id="5908340">pv</span><span class="op" id="5908342">.</span><span class="ident" id="5908343">Elem</span><span class="op" id="5908347">(</span><span class="op" id="5908348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908354">return</span>&nbsp;<span class="ident" id="5908361">pv</span><br>
<span class="lineno"></span><span class="op" id="5908364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="5908367">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="5908434">func</span>&nbsp;<span class="ident" id="5908439">encBool</span><span class="op" id="5908446">(</span><span class="ident" id="5908447">i</span>&nbsp;<span class="op" id="5908449">*</span><span class="ident" id="5908450">encInstr</span><span class="op" id="5908458">,</span>&nbsp;<span class="ident" id="5908460">state</span>&nbsp;<span class="op" id="5908466">*</span><span class="ident" id="5908467">encoderState</span><span class="op" id="5908479">,</span>&nbsp;<span class="ident" id="5908481">v</span>&nbsp;<span class="ident" id="5908483">reflect</span><span class="op" id="5908490">.</span><span class="ident" id="5908491">Value</span><span class="op" id="5908496">)</span>&nbsp;<span class="op" id="5908498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908501">b</span>&nbsp;<span class="op" id="5908503">:=</span>&nbsp;<span class="ident" id="5908506">v</span><span class="op" id="5908507">.</span><span class="ident" id="5908508">Bool</span><span class="op" id="5908512">(</span><span class="op" id="5908513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908516">if</span>&nbsp;<span class="ident" id="5908519">b</span>&nbsp;<span class="op" id="5908521">||</span>&nbsp;<span class="ident" id="5908524">state</span><span class="op" id="5908529">.</span><span class="ident" id="5908530">sendZero</span>&nbsp;<span class="op" id="5908539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908543">state</span><span class="op" id="5908548">.</span><span class="ident" id="5908549">update</span><span class="op" id="5908555">(</span><span class="ident" id="5908556">i</span><span class="op" id="5908557">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908561">if</span>&nbsp;<span class="ident" id="5908564">b</span>&nbsp;<span class="op" id="5908566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908571">state</span><span class="op" id="5908576">.</span><span class="ident" id="5908577">encodeUint</span><span class="op" id="5908587">(</span><span class="num" id="5908588">1</span><span class="op" id="5908589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908593">}</span>&nbsp;<span class="keyword" id="5908595">else</span>&nbsp;<span class="op" id="5908600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908605">state</span><span class="op" id="5908610">.</span><span class="ident" id="5908611">encodeUint</span><span class="op" id="5908621">(</span><span class="num" id="5908622">0</span><span class="op" id="5908623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908627">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908630">}</span><br>
<span class="lineno"></span><span class="op" id="5908632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5908635">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5908718">func</span>&nbsp;<span class="ident" id="5908723">encInt</span><span class="op" id="5908729">(</span><span class="ident" id="5908730">i</span>&nbsp;<span class="op" id="5908732">*</span><span class="ident" id="5908733">encInstr</span><span class="op" id="5908741">,</span>&nbsp;<span class="ident" id="5908743">state</span>&nbsp;<span class="op" id="5908749">*</span><span class="ident" id="5908750">encoderState</span><span class="op" id="5908762">,</span>&nbsp;<span class="ident" id="5908764">v</span>&nbsp;<span class="ident" id="5908766">reflect</span><span class="op" id="5908773">.</span><span class="ident" id="5908774">Value</span><span class="op" id="5908779">)</span>&nbsp;<span class="op" id="5908781">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908784">value</span>&nbsp;<span class="op" id="5908790">:=</span>&nbsp;<span class="ident" id="5908793">v</span><span class="op" id="5908794">.</span><span class="ident" id="5908795">Int</span><span class="op" id="5908798">(</span><span class="op" id="5908799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908802">if</span>&nbsp;<span class="ident" id="5908805">value</span>&nbsp;<span class="op" id="5908811">!=</span>&nbsp;<span class="num" id="5908814">0</span>&nbsp;<span class="op" id="5908816">||</span>&nbsp;<span class="ident" id="5908819">state</span><span class="op" id="5908824">.</span><span class="ident" id="5908825">sendZero</span>&nbsp;<span class="op" id="5908834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908838">state</span><span class="op" id="5908843">.</span><span class="ident" id="5908844">update</span><span class="op" id="5908850">(</span><span class="ident" id="5908851">i</span><span class="op" id="5908852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908856">state</span><span class="op" id="5908861">.</span><span class="ident" id="5908862">encodeInt</span><span class="op" id="5908871">(</span><span class="ident" id="5908872">value</span><span class="op" id="5908877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908880">}</span><br>
<span class="lineno">180</span><span class="op" id="5908882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5908885">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5908984">func</span>&nbsp;<span class="ident" id="5908989">encUint</span><span class="op" id="5908996">(</span><span class="ident" id="5908997">i</span>&nbsp;<span class="op" id="5908999">*</span><span class="ident" id="5909000">encInstr</span><span class="op" id="5909008">,</span>&nbsp;<span class="ident" id="5909010">state</span>&nbsp;<span class="op" id="5909016">*</span><span class="ident" id="5909017">encoderState</span><span class="op" id="5909029">,</span>&nbsp;<span class="ident" id="5909031">v</span>&nbsp;<span class="ident" id="5909033">reflect</span><span class="op" id="5909040">.</span><span class="ident" id="5909041">Value</span><span class="op" id="5909046">)</span>&nbsp;<span class="op" id="5909048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909051">value</span>&nbsp;<span class="op" id="5909057">:=</span>&nbsp;<span class="ident" id="5909060">v</span><span class="op" id="5909061">.</span><span class="ident" id="5909062">Uint</span><span class="op" id="5909066">(</span><span class="op" id="5909067">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909070">if</span>&nbsp;<span class="ident" id="5909073">value</span>&nbsp;<span class="op" id="5909079">!=</span>&nbsp;<span class="num" id="5909082">0</span>&nbsp;<span class="op" id="5909084">||</span>&nbsp;<span class="ident" id="5909087">state</span><span class="op" id="5909092">.</span><span class="ident" id="5909093">sendZero</span>&nbsp;<span class="op" id="5909102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909106">state</span><span class="op" id="5909111">.</span><span class="ident" id="5909112">update</span><span class="op" id="5909118">(</span><span class="ident" id="5909119">i</span><span class="op" id="5909120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909124">state</span><span class="op" id="5909129">.</span><span class="ident" id="5909130">encodeUint</span><span class="op" id="5909140">(</span><span class="ident" id="5909141">value</span><span class="op" id="5909146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5909149">}</span><br>
<span class="lineno"></span><span class="op" id="5909151">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5909154">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="5909229">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="5909299">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5909371">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="5909443">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5909508">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="5909522">func</span>&nbsp;<span class="ident" id="5909527">floatBits</span><span class="op" id="5909536">(</span><span class="ident" id="5909537">f</span>&nbsp;<span class="builtintype" id="5909539">float64</span><span class="op" id="5909546">)</span>&nbsp;<span class="ident" id="5909548">uint64</span>&nbsp;<span class="op" id="5909555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909558">u</span>&nbsp;<span class="op" id="5909560">:=</span>&nbsp;<span class="ident" id="5909563">math</span><span class="op" id="5909567">.</span><span class="ident" id="5909568">Float64bits</span><span class="op" id="5909579">(</span><span class="ident" id="5909580">f</span><span class="op" id="5909581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909584">var</span>&nbsp;<span class="ident" id="5909588">v</span>&nbsp;<span class="ident" id="5909590">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909598">for</span>&nbsp;<span class="ident" id="5909602">i</span>&nbsp;<span class="op" id="5909604">:=</span>&nbsp;<span class="num" id="5909607">0</span><span class="op" id="5909608">;</span>&nbsp;<span class="ident" id="5909610">i</span>&nbsp;<span class="op" id="5909612">&lt;</span>&nbsp;<span class="num" id="5909614">8</span><span class="op" id="5909615">;</span>&nbsp;<span class="ident" id="5909617">i</span><span class="op" id="5909618">++</span>&nbsp;<span class="op" id="5909621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909625">v</span>&nbsp;<span class="op" id="5909627">&lt;&lt;=</span>&nbsp;<span class="num" id="5909631">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909635">v</span>&nbsp;<span class="op" id="5909637">|=</span>&nbsp;<span class="ident" id="5909640">u</span>&nbsp;<span class="op" id="5909642">&amp;</span>&nbsp;<span class="num" id="5909644">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909651">u</span>&nbsp;<span class="op" id="5909653">&gt;&gt;=</span>&nbsp;<span class="num" id="5909657">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5909660">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909663">return</span>&nbsp;<span class="ident" id="5909670">v</span><br>
<span class="lineno"></span><span class="op" id="5909672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5909675">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5909755">func</span>&nbsp;<span class="ident" id="5909760">encFloat</span><span class="op" id="5909768">(</span><span class="ident" id="5909769">i</span>&nbsp;<span class="op" id="5909771">*</span><span class="ident" id="5909772">encInstr</span><span class="op" id="5909780">,</span>&nbsp;<span class="ident" id="5909782">state</span>&nbsp;<span class="op" id="5909788">*</span><span class="ident" id="5909789">encoderState</span><span class="op" id="5909801">,</span>&nbsp;<span class="ident" id="5909803">v</span>&nbsp;<span class="ident" id="5909805">reflect</span><span class="op" id="5909812">.</span><span class="ident" id="5909813">Value</span><span class="op" id="5909818">)</span>&nbsp;<span class="op" id="5909820">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909823">f</span>&nbsp;<span class="op" id="5909825">:=</span>&nbsp;<span class="ident" id="5909828">v</span><span class="op" id="5909829">.</span><span class="ident" id="5909830">Float</span><span class="op" id="5909835">(</span><span class="op" id="5909836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909839">if</span>&nbsp;<span class="ident" id="5909842">f</span>&nbsp;<span class="op" id="5909844">!=</span>&nbsp;<span class="num" id="5909847">0</span>&nbsp;<span class="op" id="5909849">||</span>&nbsp;<span class="ident" id="5909852">state</span><span class="op" id="5909857">.</span><span class="ident" id="5909858">sendZero</span>&nbsp;<span class="op" id="5909867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909871">bits</span>&nbsp;<span class="op" id="5909876">:=</span>&nbsp;<span class="ident" id="5909879">floatBits</span><span class="op" id="5909888">(</span><span class="ident" id="5909889">f</span><span class="op" id="5909890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909894">state</span><span class="op" id="5909899">.</span><span class="ident" id="5909900">update</span><span class="op" id="5909906">(</span><span class="ident" id="5909907">i</span><span class="op" id="5909908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909912">state</span><span class="op" id="5909917">.</span><span class="ident" id="5909918">encodeUint</span><span class="op" id="5909928">(</span><span class="ident" id="5909929">bits</span><span class="op" id="5909933">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5909936">}</span><br>
<span class="lineno"></span><span class="op" id="5909938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5909941">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5910021">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="5910100">func</span>&nbsp;<span class="ident" id="5910105">encComplex</span><span class="op" id="5910115">(</span><span class="ident" id="5910116">i</span>&nbsp;<span class="op" id="5910118">*</span><span class="ident" id="5910119">encInstr</span><span class="op" id="5910127">,</span>&nbsp;<span class="ident" id="5910129">state</span>&nbsp;<span class="op" id="5910135">*</span><span class="ident" id="5910136">encoderState</span><span class="op" id="5910148">,</span>&nbsp;<span class="ident" id="5910150">v</span>&nbsp;<span class="ident" id="5910152">reflect</span><span class="op" id="5910159">.</span><span class="ident" id="5910160">Value</span><span class="op" id="5910165">)</span>&nbsp;<span class="op" id="5910167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910170">c</span>&nbsp;<span class="op" id="5910172">:=</span>&nbsp;<span class="ident" id="5910175">v</span><span class="op" id="5910176">.</span><span class="ident" id="5910177">Complex</span><span class="op" id="5910184">(</span><span class="op" id="5910185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5910188">if</span>&nbsp;<span class="ident" id="5910191">c</span>&nbsp;<span class="op" id="5910193">!=</span>&nbsp;<span class="num" id="5910196">0</span><span class="op" id="5910197">+</span><span class="num" id="5910198">0i</span>&nbsp;<span class="op" id="5910201">||</span>&nbsp;<span class="ident" id="5910204">state</span><span class="op" id="5910209">.</span><span class="ident" id="5910210">sendZero</span>&nbsp;<span class="op" id="5910219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910223">rpart</span>&nbsp;<span class="op" id="5910229">:=</span>&nbsp;<span class="ident" id="5910232">floatBits</span><span class="op" id="5910241">(</span><span class="builtinfunc" id="5910242">real</span><span class="op" id="5910246">(</span><span class="ident" id="5910247">c</span><span class="op" id="5910248">)</span><span class="op" id="5910249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910253">ipart</span>&nbsp;<span class="op" id="5910259">:=</span>&nbsp;<span class="ident" id="5910262">floatBits</span><span class="op" id="5910271">(</span><span class="builtinfunc" id="5910272">imag</span><span class="op" id="5910276">(</span><span class="ident" id="5910277">c</span><span class="op" id="5910278">)</span><span class="op" id="5910279">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910283">state</span><span class="op" id="5910288">.</span><span class="ident" id="5910289">update</span><span class="op" id="5910295">(</span><span class="ident" id="5910296">i</span><span class="op" id="5910297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910301">state</span><span class="op" id="5910306">.</span><span class="ident" id="5910307">encodeUint</span><span class="op" id="5910317">(</span><span class="ident" id="5910318">rpart</span><span class="op" id="5910323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910327">state</span><span class="op" id="5910332">.</span><span class="ident" id="5910333">encodeUint</span><span class="op" id="5910343">(</span><span class="ident" id="5910344">ipart</span><span class="op" id="5910349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5910352">}</span><br>
<span class="lineno"></span><span class="op" id="5910354">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5910357">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5910414">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5910489">func</span>&nbsp;<span class="ident" id="5910494">encUint8Array</span><span class="op" id="5910507">(</span><span class="ident" id="5910508">i</span>&nbsp;<span class="op" id="5910510">*</span><span class="ident" id="5910511">encInstr</span><span class="op" id="5910519">,</span>&nbsp;<span class="ident" id="5910521">state</span>&nbsp;<span class="op" id="5910527">*</span><span class="ident" id="5910528">encoderState</span><span class="op" id="5910540">,</span>&nbsp;<span class="ident" id="5910542">v</span>&nbsp;<span class="ident" id="5910544">reflect</span><span class="op" id="5910551">.</span><span class="ident" id="5910552">Value</span><span class="op" id="5910557">)</span>&nbsp;<span class="op" id="5910559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910562">b</span>&nbsp;<span class="op" id="5910564">:=</span>&nbsp;<span class="ident" id="5910567">v</span><span class="op" id="5910568">.</span><span class="ident" id="5910569">Bytes</span><span class="op" id="5910574">(</span><span class="op" id="5910575">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5910578">if</span>&nbsp;<span class="builtinfunc" id="5910581">len</span><span class="op" id="5910584">(</span><span class="ident" id="5910585">b</span><span class="op" id="5910586">)</span>&nbsp;<span class="op" id="5910588">&gt;</span>&nbsp;<span class="num" id="5910590">0</span>&nbsp;<span class="op" id="5910592">||</span>&nbsp;<span class="ident" id="5910595">state</span><span class="op" id="5910600">.</span><span class="ident" id="5910601">sendZero</span>&nbsp;<span class="op" id="5910610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910614">state</span><span class="op" id="5910619">.</span><span class="ident" id="5910620">update</span><span class="op" id="5910626">(</span><span class="ident" id="5910627">i</span><span class="op" id="5910628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910632">state</span><span class="op" id="5910637">.</span><span class="ident" id="5910638">encodeUint</span><span class="op" id="5910648">(</span><span class="ident" id="5910649">uint64</span><span class="op" id="5910655">(</span><span class="builtinfunc" id="5910656">len</span><span class="op" id="5910659">(</span><span class="ident" id="5910660">b</span><span class="op" id="5910661">)</span><span class="op" id="5910662">)</span><span class="op" id="5910663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910667">state</span><span class="op" id="5910672">.</span><span class="ident" id="5910673">b</span><span class="op" id="5910674">.</span><span class="ident" id="5910675">Write</span><span class="op" id="5910680">(</span><span class="ident" id="5910681">b</span><span class="op" id="5910682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5910685">}</span><br>
<span class="lineno">240</span><span class="op" id="5910687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5910690">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5910739">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5910810">func</span>&nbsp;<span class="ident" id="5910815">encString</span><span class="op" id="5910824">(</span><span class="ident" id="5910825">i</span>&nbsp;<span class="op" id="5910827">*</span><span class="ident" id="5910828">encInstr</span><span class="op" id="5910836">,</span>&nbsp;<span class="ident" id="5910838">state</span>&nbsp;<span class="op" id="5910844">*</span><span class="ident" id="5910845">encoderState</span><span class="op" id="5910857">,</span>&nbsp;<span class="ident" id="5910859">v</span>&nbsp;<span class="ident" id="5910861">reflect</span><span class="op" id="5910868">.</span><span class="ident" id="5910869">Value</span><span class="op" id="5910874">)</span>&nbsp;<span class="op" id="5910876">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910879">s</span>&nbsp;<span class="op" id="5910881">:=</span>&nbsp;<span class="ident" id="5910884">v</span><span class="op" id="5910885">.</span><span class="ident" id="5910886">String</span><span class="op" id="5910892">(</span><span class="op" id="5910893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5910896">if</span>&nbsp;<span class="builtinfunc" id="5910899">len</span><span class="op" id="5910902">(</span><span class="ident" id="5910903">s</span><span class="op" id="5910904">)</span>&nbsp;<span class="op" id="5910906">&gt;</span>&nbsp;<span class="num" id="5910908">0</span>&nbsp;<span class="op" id="5910910">||</span>&nbsp;<span class="ident" id="5910913">state</span><span class="op" id="5910918">.</span><span class="ident" id="5910919">sendZero</span>&nbsp;<span class="op" id="5910928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910932">state</span><span class="op" id="5910937">.</span><span class="ident" id="5910938">update</span><span class="op" id="5910944">(</span><span class="ident" id="5910945">i</span><span class="op" id="5910946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910950">state</span><span class="op" id="5910955">.</span><span class="ident" id="5910956">encodeUint</span><span class="op" id="5910966">(</span><span class="ident" id="5910967">uint64</span><span class="op" id="5910973">(</span><span class="builtinfunc" id="5910974">len</span><span class="op" id="5910977">(</span><span class="ident" id="5910978">s</span><span class="op" id="5910979">)</span><span class="op" id="5910980">)</span><span class="op" id="5910981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910985">state</span><span class="op" id="5910990">.</span><span class="ident" id="5910991">b</span><span class="op" id="5910992">.</span><span class="ident" id="5910993">WriteString</span><span class="op" id="5911004">(</span><span class="ident" id="5911005">s</span><span class="op" id="5911006">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5911009">}</span><br>
<span class="lineno"></span><span class="op" id="5911011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5911014">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="5911074">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="5911105">func</span>&nbsp;<span class="ident" id="5911110">encStructTerminator</span><span class="op" id="5911129">(</span><span class="ident" id="5911130">i</span>&nbsp;<span class="op" id="5911132">*</span><span class="ident" id="5911133">encInstr</span><span class="op" id="5911141">,</span>&nbsp;<span class="ident" id="5911143">state</span>&nbsp;<span class="op" id="5911149">*</span><span class="ident" id="5911150">encoderState</span><span class="op" id="5911162">,</span>&nbsp;<span class="ident" id="5911164">v</span>&nbsp;<span class="ident" id="5911166">reflect</span><span class="op" id="5911173">.</span><span class="ident" id="5911174">Value</span><span class="op" id="5911179">)</span>&nbsp;<span class="op" id="5911181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5911184">state</span><span class="op" id="5911189">.</span><span class="ident" id="5911190">encodeUint</span><span class="op" id="5911200">(</span><span class="num" id="5911201">0</span><span class="op" id="5911202">)</span><br>
<span class="lineno"></span><span class="op" id="5911204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5911207">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5911228">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="5911306">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="5911386">type</span>&nbsp;<span class="ident" id="5911391">encEngine</span>&nbsp;<span class="keyword" id="5911401">struct</span>&nbsp;<span class="op" id="5911408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5911411">instr</span>&nbsp;<span class="op" id="5911417">[</span><span class="op" id="5911418">]</span><span class="ident" id="5911419">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="5911428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5911431">const</span>&nbsp;<span class="ident" id="5911437">singletonField</span>&nbsp;<span class="op" id="5911452">=</span>&nbsp;<span class="num" id="5911454">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5911457">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="5911524">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="5911578">func</span>&nbsp;<span class="ident" id="5911583">valid</span><span class="op" id="5911588">(</span><span class="ident" id="5911589">v</span>&nbsp;<span class="ident" id="5911591">reflect</span><span class="op" id="5911598">.</span><span class="ident" id="5911599">Value</span><span class="op" id="5911604">)</span>&nbsp;<span class="builtintype" id="5911606">bool</span>&nbsp;<span class="op" id="5911611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5911614">switch</span>&nbsp;<span class="ident" id="5911621">v</span><span class="op" id="5911622">.</span><span class="ident" id="5911623">Kind</span><span class="op" id="5911627">(</span><span class="op" id="5911628">)</span>&nbsp;<span class="op" id="5911630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5911633">case</span>&nbsp;<span class="ident" id="5911638">reflect</span><span class="op" id="5911645">.</span><span class="ident" id="5911646">Invalid</span><span class="op" id="5911653">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5911657">return</span>&nbsp;<span class="builtintype" id="5911664">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5911671">case</span>&nbsp;<span class="ident" id="5911676">reflect</span><span class="op" id="5911683">.</span><span class="ident" id="5911684">Ptr</span><span class="op" id="5911687">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5911691">return</span>&nbsp;<span class="op" id="5911698">!</span><span class="ident" id="5911699">v</span><span class="op" id="5911700">.</span><span class="ident" id="5911701">IsNil</span><span class="op" id="5911706">(</span><span class="op" id="5911707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5911710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5911713">return</span>&nbsp;<span class="builtintype" id="5911720">true</span><br>
<span class="lineno"></span><span class="op" id="5911725">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="5911728">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5911789">func</span>&nbsp;<span class="op" id="5911794">(</span><span class="ident" id="5911795">enc</span>&nbsp;<span class="op" id="5911799">*</span><span class="ident" id="5911800">Encoder</span><span class="op" id="5911807">)</span>&nbsp;<span class="ident" id="5911809">encodeSingle</span><span class="op" id="5911821">(</span><span class="ident" id="5911822">b</span>&nbsp;<span class="op" id="5911824">*</span><span class="ident" id="5911825">encBuffer</span><span class="op" id="5911834">,</span>&nbsp;<span class="ident" id="5911836">engine</span>&nbsp;<span class="op" id="5911843">*</span><span class="ident" id="5911844">encEngine</span><span class="op" id="5911853">,</span>&nbsp;<span class="ident" id="5911855">value</span>&nbsp;<span class="ident" id="5911861">reflect</span><span class="op" id="5911868">.</span><span class="ident" id="5911869">Value</span><span class="op" id="5911874">)</span>&nbsp;<span class="op" id="5911876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5911879">state</span>&nbsp;<span class="op" id="5911885">:=</span>&nbsp;<span class="ident" id="5911888">enc</span><span class="op" id="5911891">.</span><span class="ident" id="5911892">newEncoderState</span><span class="op" id="5911907">(</span><span class="ident" id="5911908">b</span><span class="op" id="5911909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5911912">defer</span>&nbsp;<span class="ident" id="5911918">enc</span><span class="op" id="5911921">.</span><span class="ident" id="5911922">freeEncoderState</span><span class="op" id="5911938">(</span><span class="ident" id="5911939">state</span><span class="op" id="5911944">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5911947">state</span><span class="op" id="5911952">.</span><span class="ident" id="5911953">fieldnum</span>&nbsp;<span class="op" id="5911962">=</span>&nbsp;<span class="ident" id="5911964">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5911980">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5912053">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5912124">state</span><span class="op" id="5912129">.</span><span class="ident" id="5912130">sendZero</span>&nbsp;<span class="op" id="5912139">=</span>&nbsp;<span class="builtintype" id="5912141">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5912147">instr</span>&nbsp;<span class="op" id="5912153">:=</span>&nbsp;<span class="op" id="5912156">&amp;</span><span class="ident" id="5912157">engine</span><span class="op" id="5912163">.</span><span class="ident" id="5912164">instr</span><span class="op" id="5912169">[</span><span class="ident" id="5912170">singletonField</span><span class="op" id="5912184">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5912187">if</span>&nbsp;<span class="ident" id="5912190">instr</span><span class="op" id="5912195">.</span><span class="ident" id="5912196">indir</span>&nbsp;<span class="op" id="5912202">&gt;</span>&nbsp;<span class="num" id="5912204">0</span>&nbsp;<span class="op" id="5912206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5912210">value</span>&nbsp;<span class="op" id="5912216">=</span>&nbsp;<span class="ident" id="5912218">encIndirect</span><span class="op" id="5912229">(</span><span class="ident" id="5912230">value</span><span class="op" id="5912235">,</span>&nbsp;<span class="ident" id="5912237">instr</span><span class="op" id="5912242">.</span><span class="ident" id="5912243">indir</span><span class="op" id="5912248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5912251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5912254">if</span>&nbsp;<span class="ident" id="5912257">valid</span><span class="op" id="5912262">(</span><span class="ident" id="5912263">value</span><span class="op" id="5912268">)</span>&nbsp;<span class="op" id="5912270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5912274">instr</span><span class="op" id="5912279">.</span><span class="ident" id="5912280">op</span><span class="op" id="5912282">(</span><span class="ident" id="5912283">instr</span><span class="op" id="5912288">,</span>&nbsp;<span class="ident" id="5912290">state</span><span class="op" id="5912295">,</span>&nbsp;<span class="ident" id="5912297">value</span><span class="op" id="5912302">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5912305">}</span><br>
<span class="lineno"></span><span class="op" id="5912307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5912310">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5912357">func</span>&nbsp;<span class="op" id="5912362">(</span><span class="ident" id="5912363">enc</span>&nbsp;<span class="op" id="5912367">*</span><span class="ident" id="5912368">Encoder</span><span class="op" id="5912375">)</span>&nbsp;<span class="ident" id="5912377">encodeStruct</span><span class="op" id="5912389">(</span><span class="ident" id="5912390">b</span>&nbsp;<span class="op" id="5912392">*</span><span class="ident" id="5912393">encBuffer</span><span class="op" id="5912402">,</span>&nbsp;<span class="ident" id="5912404">engine</span>&nbsp;<span class="op" id="5912411">*</span><span class="ident" id="5912412">encEngine</span><span class="op" id="5912421">,</span>&nbsp;<span class="ident" id="5912423">value</span>&nbsp;<span class="ident" id="5912429">reflect</span><span class="op" id="5912436">.</span><span class="ident" id="5912437">Value</span><span class="op" id="5912442">)</span>&nbsp;<span class="op" id="5912444">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5912447">if</span>&nbsp;<span class="op" id="5912450">!</span><span class="ident" id="5912451">valid</span><span class="op" id="5912456">(</span><span class="ident" id="5912457">value</span><span class="op" id="5912462">)</span>&nbsp;<span class="op" id="5912464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5912468">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5912476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5912479">state</span>&nbsp;<span class="op" id="5912485">:=</span>&nbsp;<span class="ident" id="5912488">enc</span><span class="op" id="5912491">.</span><span class="ident" id="5912492">newEncoderState</span><span class="op" id="5912507">(</span><span class="ident" id="5912508">b</span><span class="op" id="5912509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5912512">defer</span>&nbsp;<span class="ident" id="5912518">enc</span><span class="op" id="5912521">.</span><span class="ident" id="5912522">freeEncoderState</span><span class="op" id="5912538">(</span><span class="ident" id="5912539">state</span><span class="op" id="5912544">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5912547">state</span><span class="op" id="5912552">.</span><span class="ident" id="5912553">fieldnum</span>&nbsp;<span class="op" id="5912562">=</span>&nbsp;<span class="op" id="5912564">-</span><span class="num" id="5912565">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5912568">for</span>&nbsp;<span class="ident" id="5912572">i</span>&nbsp;<span class="op" id="5912574">:=</span>&nbsp;<span class="num" id="5912577">0</span><span class="op" id="5912578">;</span>&nbsp;<span class="ident" id="5912580">i</span>&nbsp;<span class="op" id="5912582">&lt;</span>&nbsp;<span class="builtinfunc" id="5912584">len</span><span class="op" id="5912587">(</span><span class="ident" id="5912588">engine</span><span class="op" id="5912594">.</span><span class="ident" id="5912595">instr</span><span class="op" id="5912600">)</span><span class="op" id="5912601">;</span>&nbsp;<span class="ident" id="5912603">i</span><span class="op" id="5912604">++</span>&nbsp;<span class="op" id="5912607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5912611">instr</span>&nbsp;<span class="op" id="5912617">:=</span>&nbsp;<span class="op" id="5912620">&amp;</span><span class="ident" id="5912621">engine</span><span class="op" id="5912627">.</span><span class="ident" id="5912628">instr</span><span class="op" id="5912633">[</span><span class="ident" id="5912634">i</span><span class="op" id="5912635">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5912639">if</span>&nbsp;<span class="ident" id="5912642">i</span>&nbsp;<span class="op" id="5912644">&gt;=</span>&nbsp;<span class="ident" id="5912647">value</span><span class="op" id="5912652">.</span><span class="ident" id="5912653">NumField</span><span class="op" id="5912661">(</span><span class="op" id="5912662">)</span>&nbsp;<span class="op" id="5912664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5912669">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5912695">instr</span><span class="op" id="5912700">.</span><span class="ident" id="5912701">op</span><span class="op" id="5912703">(</span><span class="ident" id="5912704">instr</span><span class="op" id="5912709">,</span>&nbsp;<span class="ident" id="5912711">state</span><span class="op" id="5912716">,</span>&nbsp;<span class="ident" id="5912718">reflect</span><span class="op" id="5912725">.</span><span class="ident" id="5912726">Value</span><span class="op" id="5912731">{</span><span class="op" id="5912732">}</span><span class="op" id="5912733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5912738">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5912746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5912750">field</span>&nbsp;<span class="op" id="5912756">:=</span>&nbsp;<span class="ident" id="5912759">value</span><span class="op" id="5912764">.</span><span class="ident" id="5912765">FieldByIndex</span><span class="op" id="5912777">(</span><span class="ident" id="5912778">instr</span><span class="op" id="5912783">.</span><span class="ident" id="5912784">index</span><span class="op" id="5912789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5912793">if</span>&nbsp;<span class="ident" id="5912796">instr</span><span class="op" id="5912801">.</span><span class="ident" id="5912802">indir</span>&nbsp;<span class="op" id="5912808">&gt;</span>&nbsp;<span class="num" id="5912810">0</span>&nbsp;<span class="op" id="5912812">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5912817">field</span>&nbsp;<span class="op" id="5912823">=</span>&nbsp;<span class="ident" id="5912825">encIndirect</span><span class="op" id="5912836">(</span><span class="ident" id="5912837">field</span><span class="op" id="5912842">,</span>&nbsp;<span class="ident" id="5912844">instr</span><span class="op" id="5912849">.</span><span class="ident" id="5912850">indir</span><span class="op" id="5912855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5912860">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5912932">if</span>&nbsp;<span class="op" id="5912935">!</span><span class="ident" id="5912936">valid</span><span class="op" id="5912941">(</span><span class="ident" id="5912942">field</span><span class="op" id="5912947">)</span>&nbsp;<span class="op" id="5912949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5912955">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5912967">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5912971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5912975">instr</span><span class="op" id="5912980">.</span><span class="ident" id="5912981">op</span><span class="op" id="5912983">(</span><span class="ident" id="5912984">instr</span><span class="op" id="5912989">,</span>&nbsp;<span class="ident" id="5912991">state</span><span class="op" id="5912996">,</span>&nbsp;<span class="ident" id="5912998">field</span><span class="op" id="5913003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5913006">}</span><br>
<span class="lineno"></span><span class="op" id="5913008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="5913011">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="5913044">func</span>&nbsp;<span class="op" id="5913049">(</span><span class="ident" id="5913050">enc</span>&nbsp;<span class="op" id="5913054">*</span><span class="ident" id="5913055">Encoder</span><span class="op" id="5913062">)</span>&nbsp;<span class="ident" id="5913064">encodeArray</span><span class="op" id="5913075">(</span><span class="ident" id="5913076">b</span>&nbsp;<span class="op" id="5913078">*</span><span class="ident" id="5913079">encBuffer</span><span class="op" id="5913088">,</span>&nbsp;<span class="ident" id="5913090">value</span>&nbsp;<span class="ident" id="5913096">reflect</span><span class="op" id="5913103">.</span><span class="ident" id="5913104">Value</span><span class="op" id="5913109">,</span>&nbsp;<span class="ident" id="5913111">op</span>&nbsp;<span class="ident" id="5913114">encOp</span><span class="op" id="5913119">,</span>&nbsp;<span class="ident" id="5913121">elemIndir</span>&nbsp;<span class="builtintype" id="5913131">int</span><span class="op" id="5913134">,</span>&nbsp;<span class="ident" id="5913136">length</span>&nbsp;<span class="builtintype" id="5913143">int</span><span class="op" id="5913146">,</span>&nbsp;<span class="ident" id="5913148">helper</span>&nbsp;<span class="ident" id="5913155">encHelper</span><span class="op" id="5913164">)</span>&nbsp;<span class="op" id="5913166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913169">state</span>&nbsp;<span class="op" id="5913175">:=</span>&nbsp;<span class="ident" id="5913178">enc</span><span class="op" id="5913181">.</span><span class="ident" id="5913182">newEncoderState</span><span class="op" id="5913197">(</span><span class="ident" id="5913198">b</span><span class="op" id="5913199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5913202">defer</span>&nbsp;<span class="ident" id="5913208">enc</span><span class="op" id="5913211">.</span><span class="ident" id="5913212">freeEncoderState</span><span class="op" id="5913228">(</span><span class="ident" id="5913229">state</span><span class="op" id="5913234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913237">state</span><span class="op" id="5913242">.</span><span class="ident" id="5913243">fieldnum</span>&nbsp;<span class="op" id="5913252">=</span>&nbsp;<span class="op" id="5913254">-</span><span class="num" id="5913255">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913258">state</span><span class="op" id="5913263">.</span><span class="ident" id="5913264">sendZero</span>&nbsp;<span class="op" id="5913273">=</span>&nbsp;<span class="builtintype" id="5913275">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913281">state</span><span class="op" id="5913286">.</span><span class="ident" id="5913287">encodeUint</span><span class="op" id="5913297">(</span><span class="ident" id="5913298">uint64</span><span class="op" id="5913304">(</span><span class="ident" id="5913305">length</span><span class="op" id="5913311">)</span><span class="op" id="5913312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5913315">if</span>&nbsp;<span class="ident" id="5913318">helper</span>&nbsp;<span class="op" id="5913325">!=</span>&nbsp;<span class="builtintype" id="5913328">nil</span>&nbsp;<span class="op" id="5913332">&amp;&amp;</span>&nbsp;<span class="ident" id="5913335">helper</span><span class="op" id="5913341">(</span><span class="ident" id="5913342">state</span><span class="op" id="5913347">,</span>&nbsp;<span class="ident" id="5913349">value</span><span class="op" id="5913354">)</span>&nbsp;<span class="op" id="5913356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5913360">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5913368">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5913371">for</span>&nbsp;<span class="ident" id="5913375">i</span>&nbsp;<span class="op" id="5913377">:=</span>&nbsp;<span class="num" id="5913380">0</span><span class="op" id="5913381">;</span>&nbsp;<span class="ident" id="5913383">i</span>&nbsp;<span class="op" id="5913385">&lt;</span>&nbsp;<span class="ident" id="5913387">length</span><span class="op" id="5913393">;</span>&nbsp;<span class="ident" id="5913395">i</span><span class="op" id="5913396">++</span>&nbsp;<span class="op" id="5913399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913403">elem</span>&nbsp;<span class="op" id="5913408">:=</span>&nbsp;<span class="ident" id="5913411">value</span><span class="op" id="5913416">.</span><span class="ident" id="5913417">Index</span><span class="op" id="5913422">(</span><span class="ident" id="5913423">i</span><span class="op" id="5913424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5913428">if</span>&nbsp;<span class="ident" id="5913431">elemIndir</span>&nbsp;<span class="op" id="5913441">&gt;</span>&nbsp;<span class="num" id="5913443">0</span>&nbsp;<span class="op" id="5913445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913450">elem</span>&nbsp;<span class="op" id="5913455">=</span>&nbsp;<span class="ident" id="5913457">encIndirect</span><span class="op" id="5913468">(</span><span class="ident" id="5913469">elem</span><span class="op" id="5913473">,</span>&nbsp;<span class="ident" id="5913475">elemIndir</span><span class="op" id="5913484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5913489">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5913560">if</span>&nbsp;<span class="op" id="5913563">!</span><span class="ident" id="5913564">valid</span><span class="op" id="5913569">(</span><span class="ident" id="5913570">elem</span><span class="op" id="5913574">)</span>&nbsp;<span class="op" id="5913576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913582">errorf</span><span class="op" id="5913588">(</span><span class="string" id="5913589">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="5913615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5913620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5913624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913628">op</span><span class="op" id="5913630">(</span><span class="builtintype" id="5913631">nil</span><span class="op" id="5913634">,</span>&nbsp;<span class="ident" id="5913636">state</span><span class="op" id="5913641">,</span>&nbsp;<span class="ident" id="5913643">elem</span><span class="op" id="5913647">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5913650">}</span><br>
<span class="lineno"></span><span class="op" id="5913652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5913655">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5913723">func</span>&nbsp;<span class="ident" id="5913728">encodeReflectValue</span><span class="op" id="5913746">(</span><span class="ident" id="5913747">state</span>&nbsp;<span class="op" id="5913753">*</span><span class="ident" id="5913754">encoderState</span><span class="op" id="5913766">,</span>&nbsp;<span class="ident" id="5913768">v</span>&nbsp;<span class="ident" id="5913770">reflect</span><span class="op" id="5913777">.</span><span class="ident" id="5913778">Value</span><span class="op" id="5913783">,</span>&nbsp;<span class="ident" id="5913785">op</span>&nbsp;<span class="ident" id="5913788">encOp</span><span class="op" id="5913793">,</span>&nbsp;<span class="ident" id="5913795">indir</span>&nbsp;<span class="builtintype" id="5913801">int</span><span class="op" id="5913804">)</span>&nbsp;<span class="op" id="5913806">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5913809">for</span>&nbsp;<span class="ident" id="5913813">i</span>&nbsp;<span class="op" id="5913815">:=</span>&nbsp;<span class="num" id="5913818">0</span><span class="op" id="5913819">;</span>&nbsp;<span class="ident" id="5913821">i</span>&nbsp;<span class="op" id="5913823">&lt;</span>&nbsp;<span class="ident" id="5913825">indir</span>&nbsp;<span class="op" id="5913831">&amp;&amp;</span>&nbsp;<span class="ident" id="5913834">v</span><span class="op" id="5913835">.</span><span class="ident" id="5913836">IsValid</span><span class="op" id="5913843">(</span><span class="op" id="5913844">)</span><span class="op" id="5913845">;</span>&nbsp;<span class="ident" id="5913847">i</span><span class="op" id="5913848">++</span>&nbsp;<span class="op" id="5913851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913855">v</span>&nbsp;<span class="op" id="5913857">=</span>&nbsp;<span class="ident" id="5913859">reflect</span><span class="op" id="5913866">.</span><span class="ident" id="5913867">Indirect</span><span class="op" id="5913875">(</span><span class="ident" id="5913876">v</span><span class="op" id="5913877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5913880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5913883">if</span>&nbsp;<span class="op" id="5913886">!</span><span class="ident" id="5913887">v</span><span class="op" id="5913888">.</span><span class="ident" id="5913889">IsValid</span><span class="op" id="5913896">(</span><span class="op" id="5913897">)</span>&nbsp;<span class="op" id="5913899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913903">errorf</span><span class="op" id="5913909">(</span><span class="string" id="5913910">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="5913943">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5913946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5913949">op</span><span class="op" id="5913951">(</span><span class="builtintype" id="5913952">nil</span><span class="op" id="5913955">,</span>&nbsp;<span class="ident" id="5913957">state</span><span class="op" id="5913962">,</span>&nbsp;<span class="ident" id="5913964">v</span><span class="op" id="5913965">)</span><br>
<span class="lineno"></span><span class="op" id="5913967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5913970">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="5914044">func</span>&nbsp;<span class="op" id="5914049">(</span><span class="ident" id="5914050">enc</span>&nbsp;<span class="op" id="5914054">*</span><span class="ident" id="5914055">Encoder</span><span class="op" id="5914062">)</span>&nbsp;<span class="ident" id="5914064">encodeMap</span><span class="op" id="5914073">(</span><span class="ident" id="5914074">b</span>&nbsp;<span class="op" id="5914076">*</span><span class="ident" id="5914077">encBuffer</span><span class="op" id="5914086">,</span>&nbsp;<span class="ident" id="5914088">mv</span>&nbsp;<span class="ident" id="5914091">reflect</span><span class="op" id="5914098">.</span><span class="ident" id="5914099">Value</span><span class="op" id="5914104">,</span>&nbsp;<span class="ident" id="5914106">keyOp</span><span class="op" id="5914111">,</span>&nbsp;<span class="ident" id="5914113">elemOp</span>&nbsp;<span class="ident" id="5914120">encOp</span><span class="op" id="5914125">,</span>&nbsp;<span class="ident" id="5914127">keyIndir</span><span class="op" id="5914135">,</span>&nbsp;<span class="ident" id="5914137">elemIndir</span>&nbsp;<span class="builtintype" id="5914147">int</span><span class="op" id="5914150">)</span>&nbsp;<span class="op" id="5914152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5914155">state</span>&nbsp;<span class="op" id="5914161">:=</span>&nbsp;<span class="ident" id="5914164">enc</span><span class="op" id="5914167">.</span><span class="ident" id="5914168">newEncoderState</span><span class="op" id="5914183">(</span><span class="ident" id="5914184">b</span><span class="op" id="5914185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5914188">state</span><span class="op" id="5914193">.</span><span class="ident" id="5914194">fieldnum</span>&nbsp;<span class="op" id="5914203">=</span>&nbsp;<span class="op" id="5914205">-</span><span class="num" id="5914206">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5914209">state</span><span class="op" id="5914214">.</span><span class="ident" id="5914215">sendZero</span>&nbsp;<span class="op" id="5914224">=</span>&nbsp;<span class="builtintype" id="5914226">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5914232">keys</span>&nbsp;<span class="op" id="5914237">:=</span>&nbsp;<span class="ident" id="5914240">mv</span><span class="op" id="5914242">.</span><span class="ident" id="5914243">MapKeys</span><span class="op" id="5914250">(</span><span class="op" id="5914251">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5914254">state</span><span class="op" id="5914259">.</span><span class="ident" id="5914260">encodeUint</span><span class="op" id="5914270">(</span><span class="ident" id="5914271">uint64</span><span class="op" id="5914277">(</span><span class="builtinfunc" id="5914278">len</span><span class="op" id="5914281">(</span><span class="ident" id="5914282">keys</span><span class="op" id="5914286">)</span><span class="op" id="5914287">)</span><span class="op" id="5914288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5914291">for</span>&nbsp;<span class="ident" id="5914295">_</span><span class="op" id="5914296">,</span>&nbsp;<span class="ident" id="5914298">key</span>&nbsp;<span class="op" id="5914302">:=</span>&nbsp;<span class="keyword" id="5914305">range</span>&nbsp;<span class="ident" id="5914311">keys</span>&nbsp;<span class="op" id="5914316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5914320">encodeReflectValue</span><span class="op" id="5914338">(</span><span class="ident" id="5914339">state</span><span class="op" id="5914344">,</span>&nbsp;<span class="ident" id="5914346">key</span><span class="op" id="5914349">,</span>&nbsp;<span class="ident" id="5914351">keyOp</span><span class="op" id="5914356">,</span>&nbsp;<span class="ident" id="5914358">keyIndir</span><span class="op" id="5914366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5914370">encodeReflectValue</span><span class="op" id="5914388">(</span><span class="ident" id="5914389">state</span><span class="op" id="5914394">,</span>&nbsp;<span class="ident" id="5914396">mv</span><span class="op" id="5914398">.</span><span class="ident" id="5914399">MapIndex</span><span class="op" id="5914407">(</span><span class="ident" id="5914408">key</span><span class="op" id="5914411">)</span><span class="op" id="5914412">,</span>&nbsp;<span class="ident" id="5914414">elemOp</span><span class="op" id="5914420">,</span>&nbsp;<span class="ident" id="5914422">elemIndir</span><span class="op" id="5914431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5914434">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5914437">enc</span><span class="op" id="5914440">.</span><span class="ident" id="5914441">freeEncoderState</span><span class="op" id="5914457">(</span><span class="ident" id="5914458">state</span><span class="op" id="5914463">)</span><br>
<span class="lineno"></span><span class="op" id="5914465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5914468">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="5914519">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="5914601">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="5914688">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="5914771">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5914796">func</span>&nbsp;<span class="op" id="5914801">(</span><span class="ident" id="5914802">enc</span>&nbsp;<span class="op" id="5914806">*</span><span class="ident" id="5914807">Encoder</span><span class="op" id="5914814">)</span>&nbsp;<span class="ident" id="5914816">encodeInterface</span><span class="op" id="5914831">(</span><span class="ident" id="5914832">b</span>&nbsp;<span class="op" id="5914834">*</span><span class="ident" id="5914835">encBuffer</span><span class="op" id="5914844">,</span>&nbsp;<span class="ident" id="5914846">iv</span>&nbsp;<span class="ident" id="5914849">reflect</span><span class="op" id="5914856">.</span><span class="ident" id="5914857">Value</span><span class="op" id="5914862">)</span>&nbsp;<span class="op" id="5914864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5914867">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5914932">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915003">elem</span>&nbsp;<span class="op" id="5915008">:=</span>&nbsp;<span class="ident" id="5915011">iv</span><span class="op" id="5915013">.</span><span class="ident" id="5915014">Elem</span><span class="op" id="5915018">(</span><span class="op" id="5915019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5915022">if</span>&nbsp;<span class="ident" id="5915025">elem</span><span class="op" id="5915029">.</span><span class="ident" id="5915030">Kind</span><span class="op" id="5915034">(</span><span class="op" id="5915035">)</span>&nbsp;<span class="op" id="5915037">==</span>&nbsp;<span class="ident" id="5915040">reflect</span><span class="op" id="5915047">.</span><span class="ident" id="5915048">Ptr</span>&nbsp;<span class="op" id="5915052">&amp;&amp;</span>&nbsp;<span class="ident" id="5915055">elem</span><span class="op" id="5915059">.</span><span class="ident" id="5915060">IsNil</span><span class="op" id="5915065">(</span><span class="op" id="5915066">)</span>&nbsp;<span class="op" id="5915068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915072">errorf</span><span class="op" id="5915078">(</span><span class="string" id="5915079">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="5915139">,</span>&nbsp;<span class="ident" id="5915141">iv</span><span class="op" id="5915143">.</span><span class="ident" id="5915144">Elem</span><span class="op" id="5915148">(</span><span class="op" id="5915149">)</span><span class="op" id="5915150">.</span><span class="ident" id="5915151">Type</span><span class="op" id="5915155">(</span><span class="op" id="5915156">)</span><span class="op" id="5915157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5915160">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915163">state</span>&nbsp;<span class="op" id="5915169">:=</span>&nbsp;<span class="ident" id="5915172">enc</span><span class="op" id="5915175">.</span><span class="ident" id="5915176">newEncoderState</span><span class="op" id="5915191">(</span><span class="ident" id="5915192">b</span><span class="op" id="5915193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915196">state</span><span class="op" id="5915201">.</span><span class="ident" id="5915202">fieldnum</span>&nbsp;<span class="op" id="5915211">=</span>&nbsp;<span class="op" id="5915213">-</span><span class="num" id="5915214">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915217">state</span><span class="op" id="5915222">.</span><span class="ident" id="5915223">sendZero</span>&nbsp;<span class="op" id="5915232">=</span>&nbsp;<span class="builtintype" id="5915234">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5915240">if</span>&nbsp;<span class="ident" id="5915243">iv</span><span class="op" id="5915245">.</span><span class="ident" id="5915246">IsNil</span><span class="op" id="5915251">(</span><span class="op" id="5915252">)</span>&nbsp;<span class="op" id="5915254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915258">state</span><span class="op" id="5915263">.</span><span class="ident" id="5915264">encodeUint</span><span class="op" id="5915274">(</span><span class="num" id="5915275">0</span><span class="op" id="5915276">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5915280">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5915288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915292">ut</span>&nbsp;<span class="op" id="5915295">:=</span>&nbsp;<span class="ident" id="5915298">userType</span><span class="op" id="5915306">(</span><span class="ident" id="5915307">iv</span><span class="op" id="5915309">.</span><span class="ident" id="5915310">Elem</span><span class="op" id="5915314">(</span><span class="op" id="5915315">)</span><span class="op" id="5915316">.</span><span class="ident" id="5915317">Type</span><span class="op" id="5915321">(</span><span class="op" id="5915322">)</span><span class="op" id="5915323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915326">registerLock</span><span class="op" id="5915338">.</span><span class="ident" id="5915339">RLock</span><span class="op" id="5915344">(</span><span class="op" id="5915345">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915348">name</span><span class="op" id="5915352">,</span>&nbsp;<span class="ident" id="5915354">ok</span>&nbsp;<span class="op" id="5915357">:=</span>&nbsp;<span class="ident" id="5915360">concreteTypeToName</span><span class="op" id="5915378">[</span><span class="ident" id="5915379">ut</span><span class="op" id="5915381">.</span><span class="ident" id="5915382">base</span><span class="op" id="5915386">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915389">registerLock</span><span class="op" id="5915401">.</span><span class="ident" id="5915402">RUnlock</span><span class="op" id="5915409">(</span><span class="op" id="5915410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5915413">if</span>&nbsp;<span class="op" id="5915416">!</span><span class="ident" id="5915417">ok</span>&nbsp;<span class="op" id="5915420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915424">errorf</span><span class="op" id="5915430">(</span><span class="string" id="5915431">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="5915470">,</span>&nbsp;<span class="ident" id="5915472">ut</span><span class="op" id="5915474">.</span><span class="ident" id="5915475">base</span><span class="op" id="5915479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5915482">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5915485">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915504">state</span><span class="op" id="5915509">.</span><span class="ident" id="5915510">encodeUint</span><span class="op" id="5915520">(</span><span class="ident" id="5915521">uint64</span><span class="op" id="5915527">(</span><span class="builtinfunc" id="5915528">len</span><span class="op" id="5915531">(</span><span class="ident" id="5915532">name</span><span class="op" id="5915536">)</span><span class="op" id="5915537">)</span><span class="op" id="5915538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915541">state</span><span class="op" id="5915546">.</span><span class="ident" id="5915547">b</span><span class="op" id="5915548">.</span><span class="ident" id="5915549">WriteString</span><span class="op" id="5915560">(</span><span class="ident" id="5915561">name</span><span class="op" id="5915565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5915568">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915605">enc</span><span class="op" id="5915608">.</span><span class="ident" id="5915609">sendTypeDescriptor</span><span class="op" id="5915627">(</span><span class="ident" id="5915628">enc</span><span class="op" id="5915631">.</span><span class="ident" id="5915632">writer</span><span class="op" id="5915638">(</span><span class="op" id="5915639">)</span><span class="op" id="5915640">,</span>&nbsp;<span class="ident" id="5915642">state</span><span class="op" id="5915647">,</span>&nbsp;<span class="ident" id="5915649">ut</span><span class="op" id="5915651">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5915654">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915676">enc</span><span class="op" id="5915679">.</span><span class="ident" id="5915680">sendTypeId</span><span class="op" id="5915690">(</span><span class="ident" id="5915691">state</span><span class="op" id="5915696">,</span>&nbsp;<span class="ident" id="5915698">ut</span><span class="op" id="5915700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5915703">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5915772">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915826">enc</span><span class="op" id="5915829">.</span><span class="ident" id="5915830">pushWriter</span><span class="op" id="5915840">(</span><span class="ident" id="5915841">b</span><span class="op" id="5915842">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915845">data</span>&nbsp;<span class="op" id="5915850">:=</span>&nbsp;<span class="builtinfunc" id="5915853">new</span><span class="op" id="5915856">(</span><span class="ident" id="5915857">encBuffer</span><span class="op" id="5915866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915869">data</span><span class="op" id="5915873">.</span><span class="ident" id="5915874">Write</span><span class="op" id="5915879">(</span><span class="ident" id="5915880">spaceForLength</span><span class="op" id="5915894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915897">enc</span><span class="op" id="5915900">.</span><span class="ident" id="5915901">encode</span><span class="op" id="5915907">(</span><span class="ident" id="5915908">data</span><span class="op" id="5915912">,</span>&nbsp;<span class="ident" id="5915914">elem</span><span class="op" id="5915918">,</span>&nbsp;<span class="ident" id="5915920">ut</span><span class="op" id="5915922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5915925">if</span>&nbsp;<span class="ident" id="5915928">enc</span><span class="op" id="5915931">.</span><span class="ident" id="5915932">err</span>&nbsp;<span class="op" id="5915936">!=</span>&nbsp;<span class="builtintype" id="5915939">nil</span>&nbsp;<span class="op" id="5915943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915947">error_</span><span class="op" id="5915953">(</span><span class="ident" id="5915954">enc</span><span class="op" id="5915957">.</span><span class="ident" id="5915958">err</span><span class="op" id="5915961">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5915964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915967">enc</span><span class="op" id="5915970">.</span><span class="ident" id="5915971">popWriter</span><span class="op" id="5915980">(</span><span class="op" id="5915981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5915984">enc</span><span class="op" id="5915987">.</span><span class="ident" id="5915988">writeMessage</span><span class="op" id="5916000">(</span><span class="ident" id="5916001">b</span><span class="op" id="5916002">,</span>&nbsp;<span class="ident" id="5916004">data</span><span class="op" id="5916008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916011">if</span>&nbsp;<span class="ident" id="5916014">enc</span><span class="op" id="5916017">.</span><span class="ident" id="5916018">err</span>&nbsp;<span class="op" id="5916022">!=</span>&nbsp;<span class="builtintype" id="5916025">nil</span>&nbsp;<span class="op" id="5916029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5916033">error_</span><span class="op" id="5916039">(</span><span class="ident" id="5916040">enc</span><span class="op" id="5916043">.</span><span class="ident" id="5916044">err</span><span class="op" id="5916047">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5916050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5916053">enc</span><span class="op" id="5916056">.</span><span class="ident" id="5916057">freeEncoderState</span><span class="op" id="5916073">(</span><span class="ident" id="5916074">state</span><span class="op" id="5916079">)</span><br>
<span class="lineno"></span><span class="op" id="5916081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5916084">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="5916145">func</span>&nbsp;<span class="ident" id="5916150">isZero</span><span class="op" id="5916156">(</span><span class="ident" id="5916157">val</span>&nbsp;<span class="ident" id="5916161">reflect</span><span class="op" id="5916168">.</span><span class="ident" id="5916169">Value</span><span class="op" id="5916174">)</span>&nbsp;<span class="builtintype" id="5916176">bool</span>&nbsp;<span class="op" id="5916181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916184">switch</span>&nbsp;<span class="ident" id="5916191">val</span><span class="op" id="5916194">.</span><span class="ident" id="5916195">Kind</span><span class="op" id="5916199">(</span><span class="op" id="5916200">)</span>&nbsp;<span class="op" id="5916202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916205">case</span>&nbsp;<span class="ident" id="5916210">reflect</span><span class="op" id="5916217">.</span><span class="ident" id="5916218">Array</span><span class="op" id="5916223">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916227">for</span>&nbsp;<span class="ident" id="5916231">i</span>&nbsp;<span class="op" id="5916233">:=</span>&nbsp;<span class="num" id="5916236">0</span><span class="op" id="5916237">;</span>&nbsp;<span class="ident" id="5916239">i</span>&nbsp;<span class="op" id="5916241">&lt;</span>&nbsp;<span class="ident" id="5916243">val</span><span class="op" id="5916246">.</span><span class="ident" id="5916247">Len</span><span class="op" id="5916250">(</span><span class="op" id="5916251">)</span><span class="op" id="5916252">;</span>&nbsp;<span class="ident" id="5916254">i</span><span class="op" id="5916255">++</span>&nbsp;<span class="op" id="5916258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916263">if</span>&nbsp;<span class="op" id="5916266">!</span><span class="ident" id="5916267">isZero</span><span class="op" id="5916273">(</span><span class="ident" id="5916274">val</span><span class="op" id="5916277">.</span><span class="ident" id="5916278">Index</span><span class="op" id="5916283">(</span><span class="ident" id="5916284">i</span><span class="op" id="5916285">)</span><span class="op" id="5916286">)</span>&nbsp;<span class="op" id="5916288">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916294">return</span>&nbsp;<span class="builtintype" id="5916301">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5916310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5916314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916318">return</span>&nbsp;<span class="builtintype" id="5916325">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916331">case</span>&nbsp;<span class="ident" id="5916336">reflect</span><span class="op" id="5916343">.</span><span class="ident" id="5916344">Map</span><span class="op" id="5916347">,</span>&nbsp;<span class="ident" id="5916349">reflect</span><span class="op" id="5916356">.</span><span class="ident" id="5916357">Slice</span><span class="op" id="5916362">,</span>&nbsp;<span class="ident" id="5916364">reflect</span><span class="op" id="5916371">.</span><span class="ident" id="5916372">String</span><span class="op" id="5916378">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916382">return</span>&nbsp;<span class="ident" id="5916389">val</span><span class="op" id="5916392">.</span><span class="ident" id="5916393">Len</span><span class="op" id="5916396">(</span><span class="op" id="5916397">)</span>&nbsp;<span class="op" id="5916399">==</span>&nbsp;<span class="num" id="5916402">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916405">case</span>&nbsp;<span class="ident" id="5916410">reflect</span><span class="op" id="5916417">.</span><span class="ident" id="5916418">Bool</span><span class="op" id="5916422">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916426">return</span>&nbsp;<span class="op" id="5916433">!</span><span class="ident" id="5916434">val</span><span class="op" id="5916437">.</span><span class="ident" id="5916438">Bool</span><span class="op" id="5916442">(</span><span class="op" id="5916443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916446">case</span>&nbsp;<span class="ident" id="5916451">reflect</span><span class="op" id="5916458">.</span><span class="ident" id="5916459">Complex64</span><span class="op" id="5916468">,</span>&nbsp;<span class="ident" id="5916470">reflect</span><span class="op" id="5916477">.</span><span class="ident" id="5916478">Complex128</span><span class="op" id="5916488">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916492">return</span>&nbsp;<span class="ident" id="5916499">val</span><span class="op" id="5916502">.</span><span class="ident" id="5916503">Complex</span><span class="op" id="5916510">(</span><span class="op" id="5916511">)</span>&nbsp;<span class="op" id="5916513">==</span>&nbsp;<span class="num" id="5916516">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916519">case</span>&nbsp;<span class="ident" id="5916524">reflect</span><span class="op" id="5916531">.</span><span class="ident" id="5916532">Chan</span><span class="op" id="5916536">,</span>&nbsp;<span class="ident" id="5916538">reflect</span><span class="op" id="5916545">.</span><span class="ident" id="5916546">Func</span><span class="op" id="5916550">,</span>&nbsp;<span class="ident" id="5916552">reflect</span><span class="op" id="5916559">.</span><span class="ident" id="5916560">Interface</span><span class="op" id="5916569">,</span>&nbsp;<span class="ident" id="5916571">reflect</span><span class="op" id="5916578">.</span><span class="ident" id="5916579">Ptr</span><span class="op" id="5916582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916586">return</span>&nbsp;<span class="ident" id="5916593">val</span><span class="op" id="5916596">.</span><span class="ident" id="5916597">IsNil</span><span class="op" id="5916602">(</span><span class="op" id="5916603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916606">case</span>&nbsp;<span class="ident" id="5916611">reflect</span><span class="op" id="5916618">.</span><span class="ident" id="5916619">Int</span><span class="op" id="5916622">,</span>&nbsp;<span class="ident" id="5916624">reflect</span><span class="op" id="5916631">.</span><span class="ident" id="5916632">Int8</span><span class="op" id="5916636">,</span>&nbsp;<span class="ident" id="5916638">reflect</span><span class="op" id="5916645">.</span><span class="ident" id="5916646">Int16</span><span class="op" id="5916651">,</span>&nbsp;<span class="ident" id="5916653">reflect</span><span class="op" id="5916660">.</span><span class="ident" id="5916661">Int32</span><span class="op" id="5916666">,</span>&nbsp;<span class="ident" id="5916668">reflect</span><span class="op" id="5916675">.</span><span class="ident" id="5916676">Int64</span><span class="op" id="5916681">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916685">return</span>&nbsp;<span class="ident" id="5916692">val</span><span class="op" id="5916695">.</span><span class="ident" id="5916696">Int</span><span class="op" id="5916699">(</span><span class="op" id="5916700">)</span>&nbsp;<span class="op" id="5916702">==</span>&nbsp;<span class="num" id="5916705">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916708">case</span>&nbsp;<span class="ident" id="5916713">reflect</span><span class="op" id="5916720">.</span><span class="ident" id="5916721">Float32</span><span class="op" id="5916728">,</span>&nbsp;<span class="ident" id="5916730">reflect</span><span class="op" id="5916737">.</span><span class="ident" id="5916738">Float64</span><span class="op" id="5916745">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916749">return</span>&nbsp;<span class="ident" id="5916756">val</span><span class="op" id="5916759">.</span><span class="ident" id="5916760">Float</span><span class="op" id="5916765">(</span><span class="op" id="5916766">)</span>&nbsp;<span class="op" id="5916768">==</span>&nbsp;<span class="num" id="5916771">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916774">case</span>&nbsp;<span class="ident" id="5916779">reflect</span><span class="op" id="5916786">.</span><span class="ident" id="5916787">Uint</span><span class="op" id="5916791">,</span>&nbsp;<span class="ident" id="5916793">reflect</span><span class="op" id="5916800">.</span><span class="ident" id="5916801">Uint8</span><span class="op" id="5916806">,</span>&nbsp;<span class="ident" id="5916808">reflect</span><span class="op" id="5916815">.</span><span class="ident" id="5916816">Uint16</span><span class="op" id="5916822">,</span>&nbsp;<span class="ident" id="5916824">reflect</span><span class="op" id="5916831">.</span><span class="ident" id="5916832">Uint32</span><span class="op" id="5916838">,</span>&nbsp;<span class="ident" id="5916840">reflect</span><span class="op" id="5916847">.</span><span class="ident" id="5916848">Uint64</span><span class="op" id="5916854">,</span>&nbsp;<span class="ident" id="5916856">reflect</span><span class="op" id="5916863">.</span><span class="ident" id="5916864">Uintptr</span><span class="op" id="5916871">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916875">return</span>&nbsp;<span class="ident" id="5916882">val</span><span class="op" id="5916885">.</span><span class="ident" id="5916886">Uint</span><span class="op" id="5916890">(</span><span class="op" id="5916891">)</span>&nbsp;<span class="op" id="5916893">==</span>&nbsp;<span class="num" id="5916896">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916899">case</span>&nbsp;<span class="ident" id="5916904">reflect</span><span class="op" id="5916911">.</span><span class="ident" id="5916912">Struct</span><span class="op" id="5916918">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916922">for</span>&nbsp;<span class="ident" id="5916926">i</span>&nbsp;<span class="op" id="5916928">:=</span>&nbsp;<span class="num" id="5916931">0</span><span class="op" id="5916932">;</span>&nbsp;<span class="ident" id="5916934">i</span>&nbsp;<span class="op" id="5916936">&lt;</span>&nbsp;<span class="ident" id="5916938">val</span><span class="op" id="5916941">.</span><span class="ident" id="5916942">NumField</span><span class="op" id="5916950">(</span><span class="op" id="5916951">)</span><span class="op" id="5916952">;</span>&nbsp;<span class="ident" id="5916954">i</span><span class="op" id="5916955">++</span>&nbsp;<span class="op" id="5916958">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916963">if</span>&nbsp;<span class="op" id="5916966">!</span><span class="ident" id="5916967">isZero</span><span class="op" id="5916973">(</span><span class="ident" id="5916974">val</span><span class="op" id="5916977">.</span><span class="ident" id="5916978">Field</span><span class="op" id="5916983">(</span><span class="ident" id="5916984">i</span><span class="op" id="5916985">)</span><span class="op" id="5916986">)</span>&nbsp;<span class="op" id="5916988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5916994">return</span>&nbsp;<span class="builtintype" id="5917001">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5917010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5917014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5917018">return</span>&nbsp;<span class="builtintype" id="5917025">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5917031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5917034">panic</span><span class="op" id="5917039">(</span><span class="string" id="5917040">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="5917066">+</span>&nbsp;<span class="ident" id="5917068">val</span><span class="op" id="5917071">.</span><span class="ident" id="5917072">Type</span><span class="op" id="5917076">(</span><span class="op" id="5917077">)</span><span class="op" id="5917078">.</span><span class="ident" id="5917079">String</span><span class="op" id="5917085">(</span><span class="op" id="5917086">)</span><span class="op" id="5917087">)</span><br>
<span class="lineno"></span><span class="op" id="5917089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5917092">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="5917167">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="5917204">func</span>&nbsp;<span class="op" id="5917209">(</span><span class="ident" id="5917210">enc</span>&nbsp;<span class="op" id="5917214">*</span><span class="ident" id="5917215">Encoder</span><span class="op" id="5917222">)</span>&nbsp;<span class="ident" id="5917224">encodeGobEncoder</span><span class="op" id="5917240">(</span><span class="ident" id="5917241">b</span>&nbsp;<span class="op" id="5917243">*</span><span class="ident" id="5917244">encBuffer</span><span class="op" id="5917253">,</span>&nbsp;<span class="ident" id="5917255">ut</span>&nbsp;<span class="op" id="5917258">*</span><span class="ident" id="5917259">userTypeInfo</span><span class="op" id="5917271">,</span>&nbsp;<span class="ident" id="5917273">v</span>&nbsp;<span class="ident" id="5917275">reflect</span><span class="op" id="5917282">.</span><span class="ident" id="5917283">Value</span><span class="op" id="5917288">)</span>&nbsp;<span class="op" id="5917290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5917293">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5917351">var</span>&nbsp;<span class="ident" id="5917355">data</span>&nbsp;<span class="op" id="5917360">[</span><span class="op" id="5917361">]</span><span class="builtintype" id="5917362">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5917368">var</span>&nbsp;<span class="ident" id="5917372">err</span>&nbsp;<span class="builtintype" id="5917376">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5917383">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5917414">switch</span>&nbsp;<span class="ident" id="5917421">ut</span><span class="op" id="5917423">.</span><span class="ident" id="5917424">externalEnc</span>&nbsp;<span class="op" id="5917436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5917439">case</span>&nbsp;<span class="ident" id="5917444">xGob</span><span class="op" id="5917448">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917452">data</span><span class="op" id="5917456">,</span>&nbsp;<span class="ident" id="5917458">err</span>&nbsp;<span class="op" id="5917462">=</span>&nbsp;<span class="ident" id="5917464">v</span><span class="op" id="5917465">.</span><span class="ident" id="5917466">Interface</span><span class="op" id="5917475">(</span><span class="op" id="5917476">)</span><span class="op" id="5917477">.</span><span class="op" id="5917478">(</span><span class="ident" id="5917479">GobEncoder</span><span class="op" id="5917489">)</span><span class="op" id="5917490">.</span><span class="ident" id="5917491">GobEncode</span><span class="op" id="5917500">(</span><span class="op" id="5917501">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5917504">case</span>&nbsp;<span class="ident" id="5917509">xBinary</span><span class="op" id="5917516">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917520">data</span><span class="op" id="5917524">,</span>&nbsp;<span class="ident" id="5917526">err</span>&nbsp;<span class="op" id="5917530">=</span>&nbsp;<span class="ident" id="5917532">v</span><span class="op" id="5917533">.</span><span class="ident" id="5917534">Interface</span><span class="op" id="5917543">(</span><span class="op" id="5917544">)</span><span class="op" id="5917545">.</span><span class="op" id="5917546">(</span><span class="ident" id="5917547">encoding</span><span class="op" id="5917555">.</span><span class="ident" id="5917556">BinaryMarshaler</span><span class="op" id="5917571">)</span><span class="op" id="5917572">.</span><span class="ident" id="5917573">MarshalBinary</span><span class="op" id="5917586">(</span><span class="op" id="5917587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5917590">case</span>&nbsp;<span class="ident" id="5917595">xText</span><span class="op" id="5917600">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917604">data</span><span class="op" id="5917608">,</span>&nbsp;<span class="ident" id="5917610">err</span>&nbsp;<span class="op" id="5917614">=</span>&nbsp;<span class="ident" id="5917616">v</span><span class="op" id="5917617">.</span><span class="ident" id="5917618">Interface</span><span class="op" id="5917627">(</span><span class="op" id="5917628">)</span><span class="op" id="5917629">.</span><span class="op" id="5917630">(</span><span class="ident" id="5917631">encoding</span><span class="op" id="5917639">.</span><span class="ident" id="5917640">TextMarshaler</span><span class="op" id="5917653">)</span><span class="op" id="5917654">.</span><span class="ident" id="5917655">MarshalText</span><span class="op" id="5917666">(</span><span class="op" id="5917667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5917670">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5917673">if</span>&nbsp;<span class="ident" id="5917676">err</span>&nbsp;<span class="op" id="5917680">!=</span>&nbsp;<span class="builtintype" id="5917683">nil</span>&nbsp;<span class="op" id="5917687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917691">error_</span><span class="op" id="5917697">(</span><span class="ident" id="5917698">err</span><span class="op" id="5917701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5917704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917707">state</span>&nbsp;<span class="op" id="5917713">:=</span>&nbsp;<span class="ident" id="5917716">enc</span><span class="op" id="5917719">.</span><span class="ident" id="5917720">newEncoderState</span><span class="op" id="5917735">(</span><span class="ident" id="5917736">b</span><span class="op" id="5917737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917740">state</span><span class="op" id="5917745">.</span><span class="ident" id="5917746">fieldnum</span>&nbsp;<span class="op" id="5917755">=</span>&nbsp;<span class="op" id="5917757">-</span><span class="num" id="5917758">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917761">state</span><span class="op" id="5917766">.</span><span class="ident" id="5917767">encodeUint</span><span class="op" id="5917777">(</span><span class="ident" id="5917778">uint64</span><span class="op" id="5917784">(</span><span class="builtinfunc" id="5917785">len</span><span class="op" id="5917788">(</span><span class="ident" id="5917789">data</span><span class="op" id="5917793">)</span><span class="op" id="5917794">)</span><span class="op" id="5917795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917798">state</span><span class="op" id="5917803">.</span><span class="ident" id="5917804">b</span><span class="op" id="5917805">.</span><span class="ident" id="5917806">Write</span><span class="op" id="5917811">(</span><span class="ident" id="5917812">data</span><span class="op" id="5917816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917819">enc</span><span class="op" id="5917822">.</span><span class="ident" id="5917823">freeEncoderState</span><span class="op" id="5917839">(</span><span class="ident" id="5917840">state</span><span class="op" id="5917845">)</span><br>
<span class="lineno"></span><span class="op" id="5917847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="5917850">var</span>&nbsp;<span class="ident" id="5917854">encOpTable</span>&nbsp;<span class="op" id="5917865">=</span>&nbsp;<span class="op" id="5917867">[</span><span class="op" id="5917868">...</span><span class="op" id="5917871">]</span><span class="ident" id="5917872">encOp</span><span class="op" id="5917877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917880">reflect</span><span class="op" id="5917887">.</span><span class="ident" id="5917888">Bool</span><span class="op" id="5917892">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917900">encBool</span><span class="op" id="5917907">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917910">reflect</span><span class="op" id="5917917">.</span><span class="ident" id="5917918">Int</span><span class="op" id="5917921">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917930">encInt</span><span class="op" id="5917936">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917939">reflect</span><span class="op" id="5917946">.</span><span class="ident" id="5917947">Int8</span><span class="op" id="5917951">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917959">encInt</span><span class="op" id="5917965">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917968">reflect</span><span class="op" id="5917975">.</span><span class="ident" id="5917976">Int16</span><span class="op" id="5917981">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917988">encInt</span><span class="op" id="5917994">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5917997">reflect</span><span class="op" id="5918004">.</span><span class="ident" id="5918005">Int32</span><span class="op" id="5918010">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918017">encInt</span><span class="op" id="5918023">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918026">reflect</span><span class="op" id="5918033">.</span><span class="ident" id="5918034">Int64</span><span class="op" id="5918039">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918046">encInt</span><span class="op" id="5918052">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918055">reflect</span><span class="op" id="5918062">.</span><span class="ident" id="5918063">Uint</span><span class="op" id="5918067">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918075">encUint</span><span class="op" id="5918082">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918085">reflect</span><span class="op" id="5918092">.</span><span class="ident" id="5918093">Uint8</span><span class="op" id="5918098">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918105">encUint</span><span class="op" id="5918112">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918115">reflect</span><span class="op" id="5918122">.</span><span class="ident" id="5918123">Uint16</span><span class="op" id="5918129">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918135">encUint</span><span class="op" id="5918142">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918145">reflect</span><span class="op" id="5918152">.</span><span class="ident" id="5918153">Uint32</span><span class="op" id="5918159">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918165">encUint</span><span class="op" id="5918172">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918175">reflect</span><span class="op" id="5918182">.</span><span class="ident" id="5918183">Uint64</span><span class="op" id="5918189">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918195">encUint</span><span class="op" id="5918202">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918205">reflect</span><span class="op" id="5918212">.</span><span class="ident" id="5918213">Uintptr</span><span class="op" id="5918220">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918225">encUint</span><span class="op" id="5918232">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918235">reflect</span><span class="op" id="5918242">.</span><span class="ident" id="5918243">Float32</span><span class="op" id="5918250">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918255">encFloat</span><span class="op" id="5918263">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918266">reflect</span><span class="op" id="5918273">.</span><span class="ident" id="5918274">Float64</span><span class="op" id="5918281">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918286">encFloat</span><span class="op" id="5918294">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918297">reflect</span><span class="op" id="5918304">.</span><span class="ident" id="5918305">Complex64</span><span class="op" id="5918314">:</span>&nbsp;&nbsp;<span class="ident" id="5918317">encComplex</span><span class="op" id="5918327">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918330">reflect</span><span class="op" id="5918337">.</span><span class="ident" id="5918338">Complex128</span><span class="op" id="5918348">:</span>&nbsp;<span class="ident" id="5918350">encComplex</span><span class="op" id="5918360">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918363">reflect</span><span class="op" id="5918370">.</span><span class="ident" id="5918371">String</span><span class="op" id="5918377">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918383">encString</span><span class="op" id="5918392">,</span><br>
<span class="lineno"></span><span class="op" id="5918394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="5918397">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5918479">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5918517">func</span>&nbsp;<span class="ident" id="5918522">encOpFor</span><span class="op" id="5918530">(</span><span class="ident" id="5918531">rt</span>&nbsp;<span class="ident" id="5918534">reflect</span><span class="op" id="5918541">.</span><span class="ident" id="5918542">Type</span><span class="op" id="5918546">,</span>&nbsp;<span class="ident" id="5918548">inProgress</span>&nbsp;<span class="keyword" id="5918559">map</span><span class="op" id="5918562">[</span><span class="ident" id="5918563">reflect</span><span class="op" id="5918570">.</span><span class="ident" id="5918571">Type</span><span class="op" id="5918575">]</span><span class="op" id="5918576">*</span><span class="ident" id="5918577">encOp</span><span class="op" id="5918582">,</span>&nbsp;<span class="ident" id="5918584">building</span>&nbsp;<span class="keyword" id="5918593">map</span><span class="op" id="5918596">[</span><span class="op" id="5918597">*</span><span class="ident" id="5918598">typeInfo</span><span class="op" id="5918606">]</span><span class="builtintype" id="5918607">bool</span><span class="op" id="5918611">)</span>&nbsp;<span class="op" id="5918613">(</span><span class="op" id="5918614">*</span><span class="ident" id="5918615">encOp</span><span class="op" id="5918620">,</span>&nbsp;<span class="builtintype" id="5918622">int</span><span class="op" id="5918625">)</span>&nbsp;<span class="op" id="5918627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5918630">ut</span>&nbsp;<span class="op" id="5918633">:=</span>&nbsp;<span class="ident" id="5918636">userType</span><span class="op" id="5918644">(</span><span class="ident" id="5918645">rt</span><span class="op" id="5918647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5918650">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5918730">if</span>&nbsp;<span class="ident" id="5918733">ut</span><span class="op" id="5918735">.</span><span class="ident" id="5918736">externalEnc</span>&nbsp;<span class="op" id="5918748">!=</span>&nbsp;<span class="num" id="5918751">0</span>&nbsp;<span class="op" id="5918753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5918757">return</span>&nbsp;<span class="ident" id="5918764">gobEncodeOpFor</span><span class="op" id="5918778">(</span><span class="ident" id="5918779">ut</span><span class="op" id="5918781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5918784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5918787">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5918872">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5918929">if</span>&nbsp;<span class="ident" id="5918932">opPtr</span>&nbsp;<span class="op" id="5918938">:=</span>&nbsp;<span class="ident" id="5918941">inProgress</span><span class="op" id="5918951">[</span><span class="ident" id="5918952">rt</span><span class="op" id="5918954">]</span><span class="op" id="5918955">;</span>&nbsp;<span class="ident" id="5918957">opPtr</span>&nbsp;<span class="op" id="5918963">!=</span>&nbsp;<span class="builtintype" id="5918966">nil</span>&nbsp;<span class="op" id="5918970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5918974">return</span>&nbsp;<span class="ident" id="5918981">opPtr</span><span class="op" id="5918986">,</span>&nbsp;<span class="ident" id="5918988">ut</span><span class="op" id="5918990">.</span><span class="ident" id="5918991">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5918998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919001">typ</span>&nbsp;<span class="op" id="5919005">:=</span>&nbsp;<span class="ident" id="5919008">ut</span><span class="op" id="5919010">.</span><span class="ident" id="5919011">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919017">indir</span>&nbsp;<span class="op" id="5919023">:=</span>&nbsp;<span class="ident" id="5919026">ut</span><span class="op" id="5919028">.</span><span class="ident" id="5919029">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919036">k</span>&nbsp;<span class="op" id="5919038">:=</span>&nbsp;<span class="ident" id="5919041">typ</span><span class="op" id="5919044">.</span><span class="ident" id="5919045">Kind</span><span class="op" id="5919049">(</span><span class="op" id="5919050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5919053">var</span>&nbsp;<span class="ident" id="5919057">op</span>&nbsp;<span class="ident" id="5919060">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5919067">if</span>&nbsp;<span class="builtintype" id="5919070">int</span><span class="op" id="5919073">(</span><span class="ident" id="5919074">k</span><span class="op" id="5919075">)</span>&nbsp;<span class="op" id="5919077">&lt;</span>&nbsp;<span class="builtinfunc" id="5919079">len</span><span class="op" id="5919082">(</span><span class="ident" id="5919083">encOpTable</span><span class="op" id="5919093">)</span>&nbsp;<span class="op" id="5919095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919099">op</span>&nbsp;<span class="op" id="5919102">=</span>&nbsp;<span class="ident" id="5919104">encOpTable</span><span class="op" id="5919114">[</span><span class="ident" id="5919115">k</span><span class="op" id="5919116">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5919119">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5919122">if</span>&nbsp;<span class="ident" id="5919125">op</span>&nbsp;<span class="op" id="5919128">==</span>&nbsp;<span class="builtintype" id="5919131">nil</span>&nbsp;<span class="op" id="5919135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919139">inProgress</span><span class="op" id="5919149">[</span><span class="ident" id="5919150">rt</span><span class="op" id="5919152">]</span>&nbsp;<span class="op" id="5919154">=</span>&nbsp;<span class="op" id="5919156">&amp;</span><span class="ident" id="5919157">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5919162">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5919181">switch</span>&nbsp;<span class="ident" id="5919188">t</span>&nbsp;<span class="op" id="5919190">:=</span>&nbsp;<span class="ident" id="5919193">typ</span><span class="op" id="5919196">;</span>&nbsp;<span class="ident" id="5919198">t</span><span class="op" id="5919199">.</span><span class="ident" id="5919200">Kind</span><span class="op" id="5919204">(</span><span class="op" id="5919205">)</span>&nbsp;<span class="op" id="5919207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5919211">case</span>&nbsp;<span class="ident" id="5919216">reflect</span><span class="op" id="5919223">.</span><span class="ident" id="5919224">Slice</span><span class="op" id="5919229">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5919234">if</span>&nbsp;<span class="ident" id="5919237">t</span><span class="op" id="5919238">.</span><span class="ident" id="5919239">Elem</span><span class="op" id="5919243">(</span><span class="op" id="5919244">)</span><span class="op" id="5919245">.</span><span class="ident" id="5919246">Kind</span><span class="op" id="5919250">(</span><span class="op" id="5919251">)</span>&nbsp;<span class="op" id="5919253">==</span>&nbsp;<span class="ident" id="5919256">reflect</span><span class="op" id="5919263">.</span><span class="ident" id="5919264">Uint8</span>&nbsp;<span class="op" id="5919270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919276">op</span>&nbsp;<span class="op" id="5919279">=</span>&nbsp;<span class="ident" id="5919281">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5919299">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5919308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5919313">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919384">elemOp</span><span class="op" id="5919390">,</span>&nbsp;<span class="ident" id="5919392">elemIndir</span>&nbsp;<span class="op" id="5919402">:=</span>&nbsp;<span class="ident" id="5919405">encOpFor</span><span class="op" id="5919413">(</span><span class="ident" id="5919414">t</span><span class="op" id="5919415">.</span><span class="ident" id="5919416">Elem</span><span class="op" id="5919420">(</span><span class="op" id="5919421">)</span><span class="op" id="5919422">,</span>&nbsp;<span class="ident" id="5919424">inProgress</span><span class="op" id="5919434">,</span>&nbsp;<span class="ident" id="5919436">building</span><span class="op" id="5919444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919449">helper</span>&nbsp;<span class="op" id="5919456">:=</span>&nbsp;<span class="ident" id="5919459">encSliceHelper</span><span class="op" id="5919473">[</span><span class="ident" id="5919474">t</span><span class="op" id="5919475">.</span><span class="ident" id="5919476">Elem</span><span class="op" id="5919480">(</span><span class="op" id="5919481">)</span><span class="op" id="5919482">.</span><span class="ident" id="5919483">Kind</span><span class="op" id="5919487">(</span><span class="op" id="5919488">)</span><span class="op" id="5919489">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919494">op</span>&nbsp;<span class="op" id="5919497">=</span>&nbsp;<span class="keyword" id="5919499">func</span><span class="op" id="5919503">(</span><span class="ident" id="5919504">i</span>&nbsp;<span class="op" id="5919506">*</span><span class="ident" id="5919507">encInstr</span><span class="op" id="5919515">,</span>&nbsp;<span class="ident" id="5919517">state</span>&nbsp;<span class="op" id="5919523">*</span><span class="ident" id="5919524">encoderState</span><span class="op" id="5919536">,</span>&nbsp;<span class="ident" id="5919538">slice</span>&nbsp;<span class="ident" id="5919544">reflect</span><span class="op" id="5919551">.</span><span class="ident" id="5919552">Value</span><span class="op" id="5919557">)</span>&nbsp;<span class="op" id="5919559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5919565">if</span>&nbsp;<span class="op" id="5919568">!</span><span class="ident" id="5919569">state</span><span class="op" id="5919574">.</span><span class="ident" id="5919575">sendZero</span>&nbsp;<span class="op" id="5919584">&amp;&amp;</span>&nbsp;<span class="ident" id="5919587">slice</span><span class="op" id="5919592">.</span><span class="ident" id="5919593">Len</span><span class="op" id="5919596">(</span><span class="op" id="5919597">)</span>&nbsp;<span class="op" id="5919599">==</span>&nbsp;<span class="num" id="5919602">0</span>&nbsp;<span class="op" id="5919604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5919611">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5919622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919628">state</span><span class="op" id="5919633">.</span><span class="ident" id="5919634">update</span><span class="op" id="5919640">(</span><span class="ident" id="5919641">i</span><span class="op" id="5919642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919648">state</span><span class="op" id="5919653">.</span><span class="ident" id="5919654">enc</span><span class="op" id="5919657">.</span><span class="ident" id="5919658">encodeArray</span><span class="op" id="5919669">(</span><span class="ident" id="5919670">state</span><span class="op" id="5919675">.</span><span class="ident" id="5919676">b</span><span class="op" id="5919677">,</span>&nbsp;<span class="ident" id="5919679">slice</span><span class="op" id="5919684">,</span>&nbsp;<span class="op" id="5919686">*</span><span class="ident" id="5919687">elemOp</span><span class="op" id="5919693">,</span>&nbsp;<span class="ident" id="5919695">elemIndir</span><span class="op" id="5919704">,</span>&nbsp;<span class="ident" id="5919706">slice</span><span class="op" id="5919711">.</span><span class="ident" id="5919712">Len</span><span class="op" id="5919715">(</span><span class="op" id="5919716">)</span><span class="op" id="5919717">,</span>&nbsp;<span class="ident" id="5919719">helper</span><span class="op" id="5919725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5919730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5919734">case</span>&nbsp;<span class="ident" id="5919739">reflect</span><span class="op" id="5919746">.</span><span class="ident" id="5919747">Array</span><span class="op" id="5919752">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5919757">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919798">elemOp</span><span class="op" id="5919804">,</span>&nbsp;<span class="ident" id="5919806">elemIndir</span>&nbsp;<span class="op" id="5919816">:=</span>&nbsp;<span class="ident" id="5919819">encOpFor</span><span class="op" id="5919827">(</span><span class="ident" id="5919828">t</span><span class="op" id="5919829">.</span><span class="ident" id="5919830">Elem</span><span class="op" id="5919834">(</span><span class="op" id="5919835">)</span><span class="op" id="5919836">,</span>&nbsp;<span class="ident" id="5919838">inProgress</span><span class="op" id="5919848">,</span>&nbsp;<span class="ident" id="5919850">building</span><span class="op" id="5919858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919863">helper</span>&nbsp;<span class="op" id="5919870">:=</span>&nbsp;<span class="ident" id="5919873">encArrayHelper</span><span class="op" id="5919887">[</span><span class="ident" id="5919888">t</span><span class="op" id="5919889">.</span><span class="ident" id="5919890">Elem</span><span class="op" id="5919894">(</span><span class="op" id="5919895">)</span><span class="op" id="5919896">.</span><span class="ident" id="5919897">Kind</span><span class="op" id="5919901">(</span><span class="op" id="5919902">)</span><span class="op" id="5919903">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919908">op</span>&nbsp;<span class="op" id="5919911">=</span>&nbsp;<span class="keyword" id="5919913">func</span><span class="op" id="5919917">(</span><span class="ident" id="5919918">i</span>&nbsp;<span class="op" id="5919920">*</span><span class="ident" id="5919921">encInstr</span><span class="op" id="5919929">,</span>&nbsp;<span class="ident" id="5919931">state</span>&nbsp;<span class="op" id="5919937">*</span><span class="ident" id="5919938">encoderState</span><span class="op" id="5919950">,</span>&nbsp;<span class="ident" id="5919952">array</span>&nbsp;<span class="ident" id="5919958">reflect</span><span class="op" id="5919965">.</span><span class="ident" id="5919966">Value</span><span class="op" id="5919971">)</span>&nbsp;<span class="op" id="5919973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919979">state</span><span class="op" id="5919984">.</span><span class="ident" id="5919985">update</span><span class="op" id="5919991">(</span><span class="ident" id="5919992">i</span><span class="op" id="5919993">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5919999">state</span><span class="op" id="5920004">.</span><span class="ident" id="5920005">enc</span><span class="op" id="5920008">.</span><span class="ident" id="5920009">encodeArray</span><span class="op" id="5920020">(</span><span class="ident" id="5920021">state</span><span class="op" id="5920026">.</span><span class="ident" id="5920027">b</span><span class="op" id="5920028">,</span>&nbsp;<span class="ident" id="5920030">array</span><span class="op" id="5920035">,</span>&nbsp;<span class="op" id="5920037">*</span><span class="ident" id="5920038">elemOp</span><span class="op" id="5920044">,</span>&nbsp;<span class="ident" id="5920046">elemIndir</span><span class="op" id="5920055">,</span>&nbsp;<span class="ident" id="5920057">array</span><span class="op" id="5920062">.</span><span class="ident" id="5920063">Len</span><span class="op" id="5920066">(</span><span class="op" id="5920067">)</span><span class="op" id="5920068">,</span>&nbsp;<span class="ident" id="5920070">helper</span><span class="op" id="5920076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5920081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5920085">case</span>&nbsp;<span class="ident" id="5920090">reflect</span><span class="op" id="5920097">.</span><span class="ident" id="5920098">Map</span><span class="op" id="5920101">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5920106">keyOp</span><span class="op" id="5920111">,</span>&nbsp;<span class="ident" id="5920113">keyIndir</span>&nbsp;<span class="op" id="5920122">:=</span>&nbsp;<span class="ident" id="5920125">encOpFor</span><span class="op" id="5920133">(</span><span class="ident" id="5920134">t</span><span class="op" id="5920135">.</span><span class="ident" id="5920136">Key</span><span class="op" id="5920139">(</span><span class="op" id="5920140">)</span><span class="op" id="5920141">,</span>&nbsp;<span class="ident" id="5920143">inProgress</span><span class="op" id="5920153">,</span>&nbsp;<span class="ident" id="5920155">building</span><span class="op" id="5920163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5920168">elemOp</span><span class="op" id="5920174">,</span>&nbsp;<span class="ident" id="5920176">elemIndir</span>&nbsp;<span class="op" id="5920186">:=</span>&nbsp;<span class="ident" id="5920189">encOpFor</span><span class="op" id="5920197">(</span><span class="ident" id="5920198">t</span><span class="op" id="5920199">.</span><span class="ident" id="5920200">Elem</span><span class="op" id="5920204">(</span><span class="op" id="5920205">)</span><span class="op" id="5920206">,</span>&nbsp;<span class="ident" id="5920208">inProgress</span><span class="op" id="5920218">,</span>&nbsp;<span class="ident" id="5920220">building</span><span class="op" id="5920228">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5920233">op</span>&nbsp;<span class="op" id="5920236">=</span>&nbsp;<span class="keyword" id="5920238">func</span><span class="op" id="5920242">(</span><span class="ident" id="5920243">i</span>&nbsp;<span class="op" id="5920245">*</span><span class="ident" id="5920246">encInstr</span><span class="op" id="5920254">,</span>&nbsp;<span class="ident" id="5920256">state</span>&nbsp;<span class="op" id="5920262">*</span><span class="ident" id="5920263">encoderState</span><span class="op" id="5920275">,</span>&nbsp;<span class="ident" id="5920277">mv</span>&nbsp;<span class="ident" id="5920280">reflect</span><span class="op" id="5920287">.</span><span class="ident" id="5920288">Value</span><span class="op" id="5920293">)</span>&nbsp;<span class="op" id="5920295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5920301">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5920359">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5920428">if</span>&nbsp;<span class="op" id="5920431">!</span><span class="ident" id="5920432">state</span><span class="op" id="5920437">.</span><span class="ident" id="5920438">sendZero</span>&nbsp;<span class="op" id="5920447">&amp;&amp;</span>&nbsp;<span class="ident" id="5920450">mv</span><span class="op" id="5920452">.</span><span class="ident" id="5920453">IsNil</span><span class="op" id="5920458">(</span><span class="op" id="5920459">)</span>&nbsp;<span class="op" id="5920461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5920468">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5920479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5920485">state</span><span class="op" id="5920490">.</span><span class="ident" id="5920491">update</span><span class="op" id="5920497">(</span><span class="ident" id="5920498">i</span><span class="op" id="5920499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5920505">state</span><span class="op" id="5920510">.</span><span class="ident" id="5920511">enc</span><span class="op" id="5920514">.</span><span class="ident" id="5920515">encodeMap</span><span class="op" id="5920524">(</span><span class="ident" id="5920525">state</span><span class="op" id="5920530">.</span><span class="ident" id="5920531">b</span><span class="op" id="5920532">,</span>&nbsp;<span class="ident" id="5920534">mv</span><span class="op" id="5920536">,</span>&nbsp;<span class="op" id="5920538">*</span><span class="ident" id="5920539">keyOp</span><span class="op" id="5920544">,</span>&nbsp;<span class="op" id="5920546">*</span><span class="ident" id="5920547">elemOp</span><span class="op" id="5920553">,</span>&nbsp;<span class="ident" id="5920555">keyIndir</span><span class="op" id="5920563">,</span>&nbsp;<span class="ident" id="5920565">elemIndir</span><span class="op" id="5920574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5920579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5920583">case</span>&nbsp;<span class="ident" id="5920588">reflect</span><span class="op" id="5920595">.</span><span class="ident" id="5920596">Struct</span><span class="op" id="5920602">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5920607">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5920682">getEncEngine</span><span class="op" id="5920694">(</span><span class="ident" id="5920695">userType</span><span class="op" id="5920703">(</span><span class="ident" id="5920704">typ</span><span class="op" id="5920707">)</span><span class="op" id="5920708">,</span>&nbsp;<span class="ident" id="5920710">building</span><span class="op" id="5920718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5920723">info</span>&nbsp;<span class="op" id="5920728">:=</span>&nbsp;<span class="ident" id="5920731">mustGetTypeInfo</span><span class="op" id="5920746">(</span><span class="ident" id="5920747">typ</span><span class="op" id="5920750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5920755">op</span>&nbsp;<span class="op" id="5920758">=</span>&nbsp;<span class="keyword" id="5920760">func</span><span class="op" id="5920764">(</span><span class="ident" id="5920765">i</span>&nbsp;<span class="op" id="5920767">*</span><span class="ident" id="5920768">encInstr</span><span class="op" id="5920776">,</span>&nbsp;<span class="ident" id="5920778">state</span>&nbsp;<span class="op" id="5920784">*</span><span class="ident" id="5920785">encoderState</span><span class="op" id="5920797">,</span>&nbsp;<span class="ident" id="5920799">sv</span>&nbsp;<span class="ident" id="5920802">reflect</span><span class="op" id="5920809">.</span><span class="ident" id="5920810">Value</span><span class="op" id="5920815">)</span>&nbsp;<span class="op" id="5920817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5920823">state</span><span class="op" id="5920828">.</span><span class="ident" id="5920829">update</span><span class="op" id="5920835">(</span><span class="ident" id="5920836">i</span><span class="op" id="5920837">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5920843">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5920914">enc</span>&nbsp;<span class="op" id="5920918">:=</span>&nbsp;<span class="ident" id="5920921">info</span><span class="op" id="5920925">.</span><span class="ident" id="5920926">encoder</span><span class="op" id="5920933">.</span><span class="ident" id="5920934">Load</span><span class="op" id="5920938">(</span><span class="op" id="5920939">)</span><span class="op" id="5920940">.</span><span class="op" id="5920941">(</span><span class="op" id="5920942">*</span><span class="ident" id="5920943">encEngine</span><span class="op" id="5920952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5920958">state</span><span class="op" id="5920963">.</span><span class="ident" id="5920964">enc</span><span class="op" id="5920967">.</span><span class="ident" id="5920968">encodeStruct</span><span class="op" id="5920980">(</span><span class="ident" id="5920981">state</span><span class="op" id="5920986">.</span><span class="ident" id="5920987">b</span><span class="op" id="5920988">,</span>&nbsp;<span class="ident" id="5920990">enc</span><span class="op" id="5920993">,</span>&nbsp;<span class="ident" id="5920995">sv</span><span class="op" id="5920997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5921002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5921006">case</span>&nbsp;<span class="ident" id="5921011">reflect</span><span class="op" id="5921018">.</span><span class="ident" id="5921019">Interface</span><span class="op" id="5921028">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5921033">op</span>&nbsp;<span class="op" id="5921036">=</span>&nbsp;<span class="keyword" id="5921038">func</span><span class="op" id="5921042">(</span><span class="ident" id="5921043">i</span>&nbsp;<span class="op" id="5921045">*</span><span class="ident" id="5921046">encInstr</span><span class="op" id="5921054">,</span>&nbsp;<span class="ident" id="5921056">state</span>&nbsp;<span class="op" id="5921062">*</span><span class="ident" id="5921063">encoderState</span><span class="op" id="5921075">,</span>&nbsp;<span class="ident" id="5921077">iv</span>&nbsp;<span class="ident" id="5921080">reflect</span><span class="op" id="5921087">.</span><span class="ident" id="5921088">Value</span><span class="op" id="5921093">)</span>&nbsp;<span class="op" id="5921095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5921101">if</span>&nbsp;<span class="op" id="5921104">!</span><span class="ident" id="5921105">state</span><span class="op" id="5921110">.</span><span class="ident" id="5921111">sendZero</span>&nbsp;<span class="op" id="5921120">&amp;&amp;</span>&nbsp;<span class="op" id="5921123">(</span><span class="op" id="5921124">!</span><span class="ident" id="5921125">iv</span><span class="op" id="5921127">.</span><span class="ident" id="5921128">IsValid</span><span class="op" id="5921135">(</span><span class="op" id="5921136">)</span>&nbsp;<span class="op" id="5921138">||</span>&nbsp;<span class="ident" id="5921141">iv</span><span class="op" id="5921143">.</span><span class="ident" id="5921144">IsNil</span><span class="op" id="5921149">(</span><span class="op" id="5921150">)</span><span class="op" id="5921151">)</span>&nbsp;<span class="op" id="5921153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5921160">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5921171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5921177">state</span><span class="op" id="5921182">.</span><span class="ident" id="5921183">update</span><span class="op" id="5921189">(</span><span class="ident" id="5921190">i</span><span class="op" id="5921191">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5921197">state</span><span class="op" id="5921202">.</span><span class="ident" id="5921203">enc</span><span class="op" id="5921206">.</span><span class="ident" id="5921207">encodeInterface</span><span class="op" id="5921222">(</span><span class="ident" id="5921223">state</span><span class="op" id="5921228">.</span><span class="ident" id="5921229">b</span><span class="op" id="5921230">,</span>&nbsp;<span class="ident" id="5921232">iv</span><span class="op" id="5921234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5921239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5921243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5921246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5921249">if</span>&nbsp;<span class="ident" id="5921252">op</span>&nbsp;<span class="op" id="5921255">==</span>&nbsp;<span class="builtintype" id="5921258">nil</span>&nbsp;<span class="op" id="5921262">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5921266">errorf</span><span class="op" id="5921272">(</span><span class="string" id="5921273">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="5921303">,</span>&nbsp;<span class="ident" id="5921305">rt</span><span class="op" id="5921307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5921310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5921313">return</span>&nbsp;<span class="op" id="5921320">&amp;</span><span class="ident" id="5921321">op</span><span class="op" id="5921323">,</span>&nbsp;<span class="ident" id="5921325">indir</span><br>
<span class="lineno"></span><span class="op" id="5921331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="5921334">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="5921417">func</span>&nbsp;<span class="ident" id="5921422">gobEncodeOpFor</span><span class="op" id="5921436">(</span><span class="ident" id="5921437">ut</span>&nbsp;<span class="op" id="5921440">*</span><span class="ident" id="5921441">userTypeInfo</span><span class="op" id="5921453">)</span>&nbsp;<span class="op" id="5921455">(</span><span class="op" id="5921456">*</span><span class="ident" id="5921457">encOp</span><span class="op" id="5921462">,</span>&nbsp;<span class="builtintype" id="5921464">int</span><span class="op" id="5921467">)</span>&nbsp;<span class="op" id="5921469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5921472">rt</span>&nbsp;<span class="op" id="5921475">:=</span>&nbsp;<span class="ident" id="5921478">ut</span><span class="op" id="5921480">.</span><span class="ident" id="5921481">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5921487">if</span>&nbsp;<span class="ident" id="5921490">ut</span><span class="op" id="5921492">.</span><span class="ident" id="5921493">encIndir</span>&nbsp;<span class="op" id="5921502">==</span>&nbsp;<span class="op" id="5921505">-</span><span class="num" id="5921506">1</span>&nbsp;<span class="op" id="5921508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5921512">rt</span>&nbsp;<span class="op" id="5921515">=</span>&nbsp;<span class="ident" id="5921517">reflect</span><span class="op" id="5921524">.</span><span class="ident" id="5921525">PtrTo</span><span class="op" id="5921530">(</span><span class="ident" id="5921531">rt</span><span class="op" id="5921533">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5921536">}</span>&nbsp;<span class="keyword" id="5921538">else</span>&nbsp;<span class="keyword" id="5921543">if</span>&nbsp;<span class="ident" id="5921546">ut</span><span class="op" id="5921548">.</span><span class="ident" id="5921549">encIndir</span>&nbsp;<span class="op" id="5921558">&gt;</span>&nbsp;<span class="num" id="5921560">0</span>&nbsp;<span class="op" id="5921562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5921566">for</span>&nbsp;<span class="ident" id="5921570">i</span>&nbsp;<span class="op" id="5921572">:=</span>&nbsp;<span class="builtintype" id="5921575">int8</span><span class="op" id="5921579">(</span><span class="num" id="5921580">0</span><span class="op" id="5921581">)</span><span class="op" id="5921582">;</span>&nbsp;<span class="ident" id="5921584">i</span>&nbsp;<span class="op" id="5921586">&lt;</span>&nbsp;<span class="ident" id="5921588">ut</span><span class="op" id="5921590">.</span><span class="ident" id="5921591">encIndir</span><span class="op" id="5921599">;</span>&nbsp;<span class="ident" id="5921601">i</span><span class="op" id="5921602">++</span>&nbsp;<span class="op" id="5921605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5921610">rt</span>&nbsp;<span class="op" id="5921613">=</span>&nbsp;<span class="ident" id="5921615">rt</span><span class="op" id="5921617">.</span><span class="ident" id="5921618">Elem</span><span class="op" id="5921622">(</span><span class="op" id="5921623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5921627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5921630">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5921633">var</span>&nbsp;<span class="ident" id="5921637">op</span>&nbsp;<span class="ident" id="5921640">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5921647">op</span>&nbsp;<span class="op" id="5921650">=</span>&nbsp;<span class="keyword" id="5921652">func</span><span class="op" id="5921656">(</span><span class="ident" id="5921657">i</span>&nbsp;<span class="op" id="5921659">*</span><span class="ident" id="5921660">encInstr</span><span class="op" id="5921668">,</span>&nbsp;<span class="ident" id="5921670">state</span>&nbsp;<span class="op" id="5921676">*</span><span class="ident" id="5921677">encoderState</span><span class="op" id="5921689">,</span>&nbsp;<span class="ident" id="5921691">v</span>&nbsp;<span class="ident" id="5921693">reflect</span><span class="op" id="5921700">.</span><span class="ident" id="5921701">Value</span><span class="op" id="5921706">)</span>&nbsp;<span class="op" id="5921708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5921712">if</span>&nbsp;<span class="ident" id="5921715">ut</span><span class="op" id="5921717">.</span><span class="ident" id="5921718">encIndir</span>&nbsp;<span class="op" id="5921727">==</span>&nbsp;<span class="op" id="5921730">-</span><span class="num" id="5921731">1</span>&nbsp;<span class="op" id="5921733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5921738">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5921799">if</span>&nbsp;<span class="op" id="5921802">!</span><span class="ident" id="5921803">v</span><span class="op" id="5921804">.</span><span class="ident" id="5921805">CanAddr</span><span class="op" id="5921812">(</span><span class="op" id="5921813">)</span>&nbsp;<span class="op" id="5921815">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5921821">errorf</span><span class="op" id="5921827">(</span><span class="string" id="5921828">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="5921860">,</span>&nbsp;<span class="ident" id="5921862">rt</span><span class="op" id="5921864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5921869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5921874">v</span>&nbsp;<span class="op" id="5921876">=</span>&nbsp;<span class="ident" id="5921878">v</span><span class="op" id="5921879">.</span><span class="ident" id="5921880">Addr</span><span class="op" id="5921884">(</span><span class="op" id="5921885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5921889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5921893">if</span>&nbsp;<span class="op" id="5921896">!</span><span class="ident" id="5921897">state</span><span class="op" id="5921902">.</span><span class="ident" id="5921903">sendZero</span>&nbsp;<span class="op" id="5921912">&amp;&amp;</span>&nbsp;<span class="ident" id="5921915">isZero</span><span class="op" id="5921921">(</span><span class="ident" id="5921922">v</span><span class="op" id="5921923">)</span>&nbsp;<span class="op" id="5921925">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5921930">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5921939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5921943">state</span><span class="op" id="5921948">.</span><span class="ident" id="5921949">update</span><span class="op" id="5921955">(</span><span class="ident" id="5921956">i</span><span class="op" id="5921957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5921961">state</span><span class="op" id="5921966">.</span><span class="ident" id="5921967">enc</span><span class="op" id="5921970">.</span><span class="ident" id="5921971">encodeGobEncoder</span><span class="op" id="5921987">(</span><span class="ident" id="5921988">state</span><span class="op" id="5921993">.</span><span class="ident" id="5921994">b</span><span class="op" id="5921995">,</span>&nbsp;<span class="ident" id="5921997">ut</span><span class="op" id="5921999">,</span>&nbsp;<span class="ident" id="5922001">v</span><span class="op" id="5922002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5922005">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5922008">return</span>&nbsp;<span class="op" id="5922015">&amp;</span><span class="ident" id="5922016">op</span><span class="op" id="5922018">,</span>&nbsp;<span class="builtintype" id="5922020">int</span><span class="op" id="5922023">(</span><span class="ident" id="5922024">ut</span><span class="op" id="5922026">.</span><span class="ident" id="5922027">encIndir</span><span class="op" id="5922035">)</span>&nbsp;<span class="comment" id="5922037">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="5922100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5922103">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5922157">func</span>&nbsp;<span class="ident" id="5922162">compileEnc</span><span class="op" id="5922172">(</span><span class="ident" id="5922173">ut</span>&nbsp;<span class="op" id="5922176">*</span><span class="ident" id="5922177">userTypeInfo</span><span class="op" id="5922189">,</span>&nbsp;<span class="ident" id="5922191">building</span>&nbsp;<span class="keyword" id="5922200">map</span><span class="op" id="5922203">[</span><span class="op" id="5922204">*</span><span class="ident" id="5922205">typeInfo</span><span class="op" id="5922213">]</span><span class="builtintype" id="5922214">bool</span><span class="op" id="5922218">)</span>&nbsp;<span class="op" id="5922220">*</span><span class="ident" id="5922221">encEngine</span>&nbsp;<span class="op" id="5922231">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922234">srt</span>&nbsp;<span class="op" id="5922238">:=</span>&nbsp;<span class="ident" id="5922241">ut</span><span class="op" id="5922243">.</span><span class="ident" id="5922244">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922250">engine</span>&nbsp;<span class="op" id="5922257">:=</span>&nbsp;<span class="builtinfunc" id="5922260">new</span><span class="op" id="5922263">(</span><span class="ident" id="5922264">encEngine</span><span class="op" id="5922273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922276">seen</span>&nbsp;<span class="op" id="5922281">:=</span>&nbsp;<span class="builtinfunc" id="5922284">make</span><span class="op" id="5922288">(</span><span class="keyword" id="5922289">map</span><span class="op" id="5922292">[</span><span class="ident" id="5922293">reflect</span><span class="op" id="5922300">.</span><span class="ident" id="5922301">Type</span><span class="op" id="5922305">]</span><span class="op" id="5922306">*</span><span class="ident" id="5922307">encOp</span><span class="op" id="5922312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922315">rt</span>&nbsp;<span class="op" id="5922318">:=</span>&nbsp;<span class="ident" id="5922321">ut</span><span class="op" id="5922323">.</span><span class="ident" id="5922324">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5922330">if</span>&nbsp;<span class="ident" id="5922333">ut</span><span class="op" id="5922335">.</span><span class="ident" id="5922336">externalEnc</span>&nbsp;<span class="op" id="5922348">!=</span>&nbsp;<span class="num" id="5922351">0</span>&nbsp;<span class="op" id="5922353">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922357">rt</span>&nbsp;<span class="op" id="5922360">=</span>&nbsp;<span class="ident" id="5922362">ut</span><span class="op" id="5922364">.</span><span class="ident" id="5922365">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5922371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5922374">if</span>&nbsp;<span class="ident" id="5922377">ut</span><span class="op" id="5922379">.</span><span class="ident" id="5922380">externalEnc</span>&nbsp;<span class="op" id="5922392">==</span>&nbsp;<span class="num" id="5922395">0</span>&nbsp;<span class="op" id="5922397">&amp;&amp;</span>&nbsp;<span class="ident" id="5922400">srt</span><span class="op" id="5922403">.</span><span class="ident" id="5922404">Kind</span><span class="op" id="5922408">(</span><span class="op" id="5922409">)</span>&nbsp;<span class="op" id="5922411">==</span>&nbsp;<span class="ident" id="5922414">reflect</span><span class="op" id="5922421">.</span><span class="ident" id="5922422">Struct</span>&nbsp;<span class="op" id="5922429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5922433">for</span>&nbsp;<span class="ident" id="5922437">fieldNum</span><span class="op" id="5922445">,</span>&nbsp;<span class="ident" id="5922447">wireFieldNum</span>&nbsp;<span class="op" id="5922460">:=</span>&nbsp;<span class="num" id="5922463">0</span><span class="op" id="5922464">,</span>&nbsp;<span class="num" id="5922466">0</span><span class="op" id="5922467">;</span>&nbsp;<span class="ident" id="5922469">fieldNum</span>&nbsp;<span class="op" id="5922478">&lt;</span>&nbsp;<span class="ident" id="5922480">srt</span><span class="op" id="5922483">.</span><span class="ident" id="5922484">NumField</span><span class="op" id="5922492">(</span><span class="op" id="5922493">)</span><span class="op" id="5922494">;</span>&nbsp;<span class="ident" id="5922496">fieldNum</span><span class="op" id="5922504">++</span>&nbsp;<span class="op" id="5922507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922512">f</span>&nbsp;<span class="op" id="5922514">:=</span>&nbsp;<span class="ident" id="5922517">srt</span><span class="op" id="5922520">.</span><span class="ident" id="5922521">Field</span><span class="op" id="5922526">(</span><span class="ident" id="5922527">fieldNum</span><span class="op" id="5922535">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5922540">if</span>&nbsp;<span class="op" id="5922543">!</span><span class="ident" id="5922544">isSent</span><span class="op" id="5922550">(</span><span class="op" id="5922551">&amp;</span><span class="ident" id="5922552">f</span><span class="op" id="5922553">)</span>&nbsp;<span class="op" id="5922555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5922561">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5922573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922578">op</span><span class="op" id="5922580">,</span>&nbsp;<span class="ident" id="5922582">indir</span>&nbsp;<span class="op" id="5922588">:=</span>&nbsp;<span class="ident" id="5922591">encOpFor</span><span class="op" id="5922599">(</span><span class="ident" id="5922600">f</span><span class="op" id="5922601">.</span><span class="ident" id="5922602">Type</span><span class="op" id="5922606">,</span>&nbsp;<span class="ident" id="5922608">seen</span><span class="op" id="5922612">,</span>&nbsp;<span class="ident" id="5922614">building</span><span class="op" id="5922622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922627">engine</span><span class="op" id="5922633">.</span><span class="ident" id="5922634">instr</span>&nbsp;<span class="op" id="5922640">=</span>&nbsp;<span class="builtinfunc" id="5922642">append</span><span class="op" id="5922648">(</span><span class="ident" id="5922649">engine</span><span class="op" id="5922655">.</span><span class="ident" id="5922656">instr</span><span class="op" id="5922661">,</span>&nbsp;<span class="ident" id="5922663">encInstr</span><span class="op" id="5922671">{</span><span class="op" id="5922672">*</span><span class="ident" id="5922673">op</span><span class="op" id="5922675">,</span>&nbsp;<span class="ident" id="5922677">wireFieldNum</span><span class="op" id="5922689">,</span>&nbsp;<span class="ident" id="5922691">f</span><span class="op" id="5922692">.</span><span class="ident" id="5922693">Index</span><span class="op" id="5922698">,</span>&nbsp;<span class="ident" id="5922700">indir</span><span class="op" id="5922705">}</span><span class="op" id="5922706">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922711">wireFieldNum</span><span class="op" id="5922723">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5922728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5922732">if</span>&nbsp;<span class="ident" id="5922735">srt</span><span class="op" id="5922738">.</span><span class="ident" id="5922739">NumField</span><span class="op" id="5922747">(</span><span class="op" id="5922748">)</span>&nbsp;<span class="op" id="5922750">&gt;</span>&nbsp;<span class="num" id="5922752">0</span>&nbsp;<span class="op" id="5922754">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5922757">len</span><span class="op" id="5922760">(</span><span class="ident" id="5922761">engine</span><span class="op" id="5922767">.</span><span class="ident" id="5922768">instr</span><span class="op" id="5922773">)</span>&nbsp;<span class="op" id="5922775">==</span>&nbsp;<span class="num" id="5922778">0</span>&nbsp;<span class="op" id="5922780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922785">errorf</span><span class="op" id="5922791">(</span><span class="string" id="5922792">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="5922824">,</span>&nbsp;<span class="ident" id="5922826">rt</span><span class="op" id="5922828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5922832">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922836">engine</span><span class="op" id="5922842">.</span><span class="ident" id="5922843">instr</span>&nbsp;<span class="op" id="5922849">=</span>&nbsp;<span class="builtinfunc" id="5922851">append</span><span class="op" id="5922857">(</span><span class="ident" id="5922858">engine</span><span class="op" id="5922864">.</span><span class="ident" id="5922865">instr</span><span class="op" id="5922870">,</span>&nbsp;<span class="ident" id="5922872">encInstr</span><span class="op" id="5922880">{</span><span class="ident" id="5922881">encStructTerminator</span><span class="op" id="5922900">,</span>&nbsp;<span class="num" id="5922902">0</span><span class="op" id="5922903">,</span>&nbsp;<span class="builtintype" id="5922905">nil</span><span class="op" id="5922908">,</span>&nbsp;<span class="num" id="5922910">0</span><span class="op" id="5922911">}</span><span class="op" id="5922912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5922915">}</span>&nbsp;<span class="keyword" id="5922917">else</span>&nbsp;<span class="op" id="5922922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922926">engine</span><span class="op" id="5922932">.</span><span class="ident" id="5922933">instr</span>&nbsp;<span class="op" id="5922939">=</span>&nbsp;<span class="builtinfunc" id="5922941">make</span><span class="op" id="5922945">(</span><span class="op" id="5922946">[</span><span class="op" id="5922947">]</span><span class="ident" id="5922948">encInstr</span><span class="op" id="5922956">,</span>&nbsp;<span class="num" id="5922958">1</span><span class="op" id="5922959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5922963">op</span><span class="op" id="5922965">,</span>&nbsp;<span class="ident" id="5922967">indir</span>&nbsp;<span class="op" id="5922973">:=</span>&nbsp;<span class="ident" id="5922976">encOpFor</span><span class="op" id="5922984">(</span><span class="ident" id="5922985">rt</span><span class="op" id="5922987">,</span>&nbsp;<span class="ident" id="5922989">seen</span><span class="op" id="5922993">,</span>&nbsp;<span class="ident" id="5922995">building</span><span class="op" id="5923003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923007">engine</span><span class="op" id="5923013">.</span><span class="ident" id="5923014">instr</span><span class="op" id="5923019">[</span><span class="num" id="5923020">0</span><span class="op" id="5923021">]</span>&nbsp;<span class="op" id="5923023">=</span>&nbsp;<span class="ident" id="5923025">encInstr</span><span class="op" id="5923033">{</span><span class="op" id="5923034">*</span><span class="ident" id="5923035">op</span><span class="op" id="5923037">,</span>&nbsp;<span class="ident" id="5923039">singletonField</span><span class="op" id="5923053">,</span>&nbsp;<span class="builtintype" id="5923055">nil</span><span class="op" id="5923058">,</span>&nbsp;<span class="ident" id="5923060">indir</span><span class="op" id="5923065">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5923068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5923071">return</span>&nbsp;<span class="ident" id="5923078">engine</span><br>
<span class="lineno"></span><span class="op" id="5923085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5923088">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="5923144">func</span>&nbsp;<span class="ident" id="5923149">getEncEngine</span><span class="op" id="5923161">(</span><span class="ident" id="5923162">ut</span>&nbsp;<span class="op" id="5923165">*</span><span class="ident" id="5923166">userTypeInfo</span><span class="op" id="5923178">,</span>&nbsp;<span class="ident" id="5923180">building</span>&nbsp;<span class="keyword" id="5923189">map</span><span class="op" id="5923192">[</span><span class="op" id="5923193">*</span><span class="ident" id="5923194">typeInfo</span><span class="op" id="5923202">]</span><span class="builtintype" id="5923203">bool</span><span class="op" id="5923207">)</span>&nbsp;<span class="op" id="5923209">*</span><span class="ident" id="5923210">encEngine</span>&nbsp;<span class="op" id="5923220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923223">info</span><span class="op" id="5923227">,</span>&nbsp;<span class="ident" id="5923229">err</span>&nbsp;<span class="op" id="5923233">:=</span>&nbsp;<span class="ident" id="5923236">getTypeInfo</span><span class="op" id="5923247">(</span><span class="ident" id="5923248">ut</span><span class="op" id="5923250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5923253">if</span>&nbsp;<span class="ident" id="5923256">err</span>&nbsp;<span class="op" id="5923260">!=</span>&nbsp;<span class="builtintype" id="5923263">nil</span>&nbsp;<span class="op" id="5923267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923271">error_</span><span class="op" id="5923277">(</span><span class="ident" id="5923278">err</span><span class="op" id="5923281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5923284">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923287">enc</span><span class="op" id="5923290">,</span>&nbsp;<span class="ident" id="5923292">ok</span>&nbsp;<span class="op" id="5923295">:=</span>&nbsp;<span class="ident" id="5923298">info</span><span class="op" id="5923302">.</span><span class="ident" id="5923303">encoder</span><span class="op" id="5923310">.</span><span class="ident" id="5923311">Load</span><span class="op" id="5923315">(</span><span class="op" id="5923316">)</span><span class="op" id="5923317">.</span><span class="op" id="5923318">(</span><span class="op" id="5923319">*</span><span class="ident" id="5923320">encEngine</span><span class="op" id="5923329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5923332">if</span>&nbsp;<span class="op" id="5923335">!</span><span class="ident" id="5923336">ok</span>&nbsp;<span class="op" id="5923339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923343">enc</span>&nbsp;<span class="op" id="5923347">=</span>&nbsp;<span class="ident" id="5923349">buildEncEngine</span><span class="op" id="5923363">(</span><span class="ident" id="5923364">info</span><span class="op" id="5923368">,</span>&nbsp;<span class="ident" id="5923370">ut</span><span class="op" id="5923372">,</span>&nbsp;<span class="ident" id="5923374">building</span><span class="op" id="5923382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5923385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5923388">return</span>&nbsp;<span class="ident" id="5923395">enc</span><br>
<span class="lineno">660</span><span class="op" id="5923399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5923402">func</span>&nbsp;<span class="ident" id="5923407">buildEncEngine</span><span class="op" id="5923421">(</span><span class="ident" id="5923422">info</span>&nbsp;<span class="op" id="5923427">*</span><span class="ident" id="5923428">typeInfo</span><span class="op" id="5923436">,</span>&nbsp;<span class="ident" id="5923438">ut</span>&nbsp;<span class="op" id="5923441">*</span><span class="ident" id="5923442">userTypeInfo</span><span class="op" id="5923454">,</span>&nbsp;<span class="ident" id="5923456">building</span>&nbsp;<span class="keyword" id="5923465">map</span><span class="op" id="5923468">[</span><span class="op" id="5923469">*</span><span class="ident" id="5923470">typeInfo</span><span class="op" id="5923478">]</span><span class="builtintype" id="5923479">bool</span><span class="op" id="5923483">)</span>&nbsp;<span class="op" id="5923485">*</span><span class="ident" id="5923486">encEngine</span>&nbsp;<span class="op" id="5923496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5923499">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5923530">if</span>&nbsp;<span class="ident" id="5923533">building</span>&nbsp;<span class="op" id="5923542">!=</span>&nbsp;<span class="builtintype" id="5923545">nil</span>&nbsp;<span class="op" id="5923549">&amp;&amp;</span>&nbsp;<span class="ident" id="5923552">building</span><span class="op" id="5923560">[</span><span class="ident" id="5923561">info</span><span class="op" id="5923565">]</span>&nbsp;<span class="op" id="5923567">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5923571">return</span>&nbsp;<span class="builtintype" id="5923578">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5923583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923586">info</span><span class="op" id="5923590">.</span><span class="ident" id="5923591">encInit</span><span class="op" id="5923598">.</span><span class="ident" id="5923599">Lock</span><span class="op" id="5923603">(</span><span class="op" id="5923604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5923607">defer</span>&nbsp;<span class="ident" id="5923613">info</span><span class="op" id="5923617">.</span><span class="ident" id="5923618">encInit</span><span class="op" id="5923625">.</span><span class="ident" id="5923626">Unlock</span><span class="op" id="5923632">(</span><span class="op" id="5923633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923636">enc</span><span class="op" id="5923639">,</span>&nbsp;<span class="ident" id="5923641">ok</span>&nbsp;<span class="op" id="5923644">:=</span>&nbsp;<span class="ident" id="5923647">info</span><span class="op" id="5923651">.</span><span class="ident" id="5923652">encoder</span><span class="op" id="5923659">.</span><span class="ident" id="5923660">Load</span><span class="op" id="5923664">(</span><span class="op" id="5923665">)</span><span class="op" id="5923666">.</span><span class="op" id="5923667">(</span><span class="op" id="5923668">*</span><span class="ident" id="5923669">encEngine</span><span class="op" id="5923678">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5923681">if</span>&nbsp;<span class="op" id="5923684">!</span><span class="ident" id="5923685">ok</span>&nbsp;<span class="op" id="5923688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5923692">if</span>&nbsp;<span class="ident" id="5923695">building</span>&nbsp;<span class="op" id="5923704">==</span>&nbsp;<span class="builtintype" id="5923707">nil</span>&nbsp;<span class="op" id="5923711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923716">building</span>&nbsp;<span class="op" id="5923725">=</span>&nbsp;<span class="builtinfunc" id="5923727">make</span><span class="op" id="5923731">(</span><span class="keyword" id="5923732">map</span><span class="op" id="5923735">[</span><span class="op" id="5923736">*</span><span class="ident" id="5923737">typeInfo</span><span class="op" id="5923745">]</span><span class="builtintype" id="5923746">bool</span><span class="op" id="5923750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5923754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923758">building</span><span class="op" id="5923766">[</span><span class="ident" id="5923767">info</span><span class="op" id="5923771">]</span>&nbsp;<span class="op" id="5923773">=</span>&nbsp;<span class="builtintype" id="5923775">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923782">enc</span>&nbsp;<span class="op" id="5923786">=</span>&nbsp;<span class="ident" id="5923788">compileEnc</span><span class="op" id="5923798">(</span><span class="ident" id="5923799">ut</span><span class="op" id="5923801">,</span>&nbsp;<span class="ident" id="5923803">building</span><span class="op" id="5923811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923815">info</span><span class="op" id="5923819">.</span><span class="ident" id="5923820">encoder</span><span class="op" id="5923827">.</span><span class="ident" id="5923828">Store</span><span class="op" id="5923833">(</span><span class="ident" id="5923834">enc</span><span class="op" id="5923837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5923840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5923843">return</span>&nbsp;<span class="ident" id="5923850">enc</span><br>
<span class="lineno"></span><span class="op" id="5923854">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="5923857">func</span>&nbsp;<span class="op" id="5923862">(</span><span class="ident" id="5923863">enc</span>&nbsp;<span class="op" id="5923867">*</span><span class="ident" id="5923868">Encoder</span><span class="op" id="5923875">)</span>&nbsp;<span class="ident" id="5923877">encode</span><span class="op" id="5923883">(</span><span class="ident" id="5923884">b</span>&nbsp;<span class="op" id="5923886">*</span><span class="ident" id="5923887">encBuffer</span><span class="op" id="5923896">,</span>&nbsp;<span class="ident" id="5923898">value</span>&nbsp;<span class="ident" id="5923904">reflect</span><span class="op" id="5923911">.</span><span class="ident" id="5923912">Value</span><span class="op" id="5923917">,</span>&nbsp;<span class="ident" id="5923919">ut</span>&nbsp;<span class="op" id="5923922">*</span><span class="ident" id="5923923">userTypeInfo</span><span class="op" id="5923935">)</span>&nbsp;<span class="op" id="5923937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5923940">defer</span>&nbsp;<span class="ident" id="5923946">catchError</span><span class="op" id="5923956">(</span><span class="op" id="5923957">&amp;</span><span class="ident" id="5923958">enc</span><span class="op" id="5923961">.</span><span class="ident" id="5923962">err</span><span class="op" id="5923965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5923968">engine</span>&nbsp;<span class="op" id="5923975">:=</span>&nbsp;<span class="ident" id="5923978">getEncEngine</span><span class="op" id="5923990">(</span><span class="ident" id="5923991">ut</span><span class="op" id="5923993">,</span>&nbsp;<span class="builtintype" id="5923995">nil</span><span class="op" id="5923998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5924001">indir</span>&nbsp;<span class="op" id="5924007">:=</span>&nbsp;<span class="ident" id="5924010">ut</span><span class="op" id="5924012">.</span><span class="ident" id="5924013">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5924020">if</span>&nbsp;<span class="ident" id="5924023">ut</span><span class="op" id="5924025">.</span><span class="ident" id="5924026">externalEnc</span>&nbsp;<span class="op" id="5924038">!=</span>&nbsp;<span class="num" id="5924041">0</span>&nbsp;<span class="op" id="5924043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5924047">indir</span>&nbsp;<span class="op" id="5924053">=</span>&nbsp;<span class="builtintype" id="5924055">int</span><span class="op" id="5924058">(</span><span class="ident" id="5924059">ut</span><span class="op" id="5924061">.</span><span class="ident" id="5924062">encIndir</span><span class="op" id="5924070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5924073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5924076">for</span>&nbsp;<span class="ident" id="5924080">i</span>&nbsp;<span class="op" id="5924082">:=</span>&nbsp;<span class="num" id="5924085">0</span><span class="op" id="5924086">;</span>&nbsp;<span class="ident" id="5924088">i</span>&nbsp;<span class="op" id="5924090">&lt;</span>&nbsp;<span class="ident" id="5924092">indir</span><span class="op" id="5924097">;</span>&nbsp;<span class="ident" id="5924099">i</span><span class="op" id="5924100">++</span>&nbsp;<span class="op" id="5924103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5924107">value</span>&nbsp;<span class="op" id="5924113">=</span>&nbsp;<span class="ident" id="5924115">reflect</span><span class="op" id="5924122">.</span><span class="ident" id="5924123">Indirect</span><span class="op" id="5924131">(</span><span class="ident" id="5924132">value</span><span class="op" id="5924137">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5924140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5924143">if</span>&nbsp;<span class="ident" id="5924146">ut</span><span class="op" id="5924148">.</span><span class="ident" id="5924149">externalEnc</span>&nbsp;<span class="op" id="5924161">==</span>&nbsp;<span class="num" id="5924164">0</span>&nbsp;<span class="op" id="5924166">&amp;&amp;</span>&nbsp;<span class="ident" id="5924169">value</span><span class="op" id="5924174">.</span><span class="ident" id="5924175">Type</span><span class="op" id="5924179">(</span><span class="op" id="5924180">)</span><span class="op" id="5924181">.</span><span class="ident" id="5924182">Kind</span><span class="op" id="5924186">(</span><span class="op" id="5924187">)</span>&nbsp;<span class="op" id="5924189">==</span>&nbsp;<span class="ident" id="5924192">reflect</span><span class="op" id="5924199">.</span><span class="ident" id="5924200">Struct</span>&nbsp;<span class="op" id="5924207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5924211">enc</span><span class="op" id="5924214">.</span><span class="ident" id="5924215">encodeStruct</span><span class="op" id="5924227">(</span><span class="ident" id="5924228">b</span><span class="op" id="5924229">,</span>&nbsp;<span class="ident" id="5924231">engine</span><span class="op" id="5924237">,</span>&nbsp;<span class="ident" id="5924239">value</span><span class="op" id="5924244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5924247">}</span>&nbsp;<span class="keyword" id="5924249">else</span>&nbsp;<span class="op" id="5924254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5924258">enc</span><span class="op" id="5924261">.</span><span class="ident" id="5924262">encodeSingle</span><span class="op" id="5924274">(</span><span class="ident" id="5924275">b</span><span class="op" id="5924276">,</span>&nbsp;<span class="ident" id="5924278">engine</span><span class="op" id="5924284">,</span>&nbsp;<span class="ident" id="5924286">value</span><span class="op" id="5924291">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5924294">}</span><br>
<span class="lineno"></span><span class="op" id="5924296">}</span>
</div>
</body>
</html>
