<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>time</h2>
<ul>
<li><a href="/gostd/time/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/time/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/time/format.go.html">format.go</a></li>
<li><a href="/gostd/time/format_test.go.html">format_test.go</a></li>
<li><a href="/gostd/time/internal_test.go.html">internal_test.go</a></li>
<li><a href="/gostd/time/sleep.go.html">sleep.go</a></li>
<li><a href="/gostd/time/sleep_test.go.html">sleep_test.go</a></li>
<li><a href="/gostd/time/sys_unix.go.html">sys_unix.go</a></li>
<li><a href="/gostd/time/tick.go.html">tick.go</a></li>
<li><a href="/gostd/time/tick_test.go.html">tick_test.go</a></li>
<li><a href="/gostd/time/time.go.html">time.go</a></li>
<li><a href="/gostd/time/time_test.go.html">time_test.go</a></li>
<li><a href="/gostd/time/zoneinfo.go.html">zoneinfo.go</a></li>
<li><a href="/gostd/time/zoneinfo_read.go.html">zoneinfo_read.go</a></li>
<li><a href="/gostd/time/zoneinfo_test.go.html">zoneinfo_test.go</a></li>
<li><a href="/gostd/time/zoneinfo_unix.go.html">zoneinfo_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7124652">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7124707">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7124761">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7124812">package</span>&nbsp;<span class="ident" id="7124820">time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7124826">func</span>&nbsp;<span class="ident" id="7124831">init</span><span class="op" id="7124835">(</span><span class="op" id="7124836">)</span>&nbsp;<span class="op" id="7124838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7124841">//&nbsp;force&nbsp;US/Pacific&nbsp;for&nbsp;time&nbsp;zone&nbsp;tests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7124882">ForceUSPacificForTesting</span><span class="op" id="7124906">(</span><span class="op" id="7124907">)</span><br>
<span class="lineno">10</span><span class="op" id="7124909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7124912">var</span>&nbsp;<span class="ident" id="7124916">Interrupt</span>&nbsp;<span class="op" id="7124926">=</span>&nbsp;<span class="ident" id="7124928">interrupt</span><br>
<span class="lineno"></span><span class="keyword" id="7124938">var</span>&nbsp;<span class="ident" id="7124942">DaysIn</span>&nbsp;<span class="op" id="7124949">=</span>&nbsp;<span class="ident" id="7124951">daysIn</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="7124959">func</span>&nbsp;<span class="ident" id="7124964">empty</span><span class="op" id="7124969">(</span><span class="ident" id="7124970">arg</span>&nbsp;<span class="keyword" id="7124974">interface</span><span class="op" id="7124983">{</span><span class="op" id="7124984">}</span><span class="op" id="7124985">,</span>&nbsp;<span class="ident" id="7124987">seq</span>&nbsp;<span class="builtintype" id="7124991">uintptr</span><span class="op" id="7124998">)</span>&nbsp;<span class="op" id="7125000">{</span><span class="op" id="7125001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7125004">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;runtimeTimer&nbsp;with&nbsp;a&nbsp;duration&nbsp;so&nbsp;large&nbsp;it&nbsp;overflows</span><br>
<span class="lineno"></span><span class="comment" id="7125070">//&nbsp;does&nbsp;not&nbsp;cause&nbsp;other&nbsp;timers&nbsp;to&nbsp;hang.</span><br>
<span class="lineno"></span><span class="comment" id="7125110">//</span><br>
<span class="lineno">20</span><span class="comment" id="7125113">//&nbsp;This&nbsp;test&nbsp;has&nbsp;to&nbsp;be&nbsp;in&nbsp;internal_test.go&nbsp;since&nbsp;it&nbsp;fiddles&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="7125178">//&nbsp;unexported&nbsp;data&nbsp;structures.</span><br>
<span class="lineno"></span><span class="keyword" id="7125209">func</span>&nbsp;<span class="ident" id="7125214">CheckRuntimeTimerOverflow</span><span class="op" id="7125239">(</span><span class="op" id="7125240">)</span>&nbsp;<span class="op" id="7125242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7125245">//&nbsp;We&nbsp;manually&nbsp;create&nbsp;a&nbsp;runtimeTimer&nbsp;to&nbsp;bypass&nbsp;the&nbsp;overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7125306">//&nbsp;detection&nbsp;logic&nbsp;in&nbsp;NewTimer:&nbsp;we&#39;re&nbsp;testing&nbsp;the&nbsp;underlying</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7125368">//&nbsp;runtime.addtimer&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7125399">r</span>&nbsp;<span class="op" id="7125401">:=</span>&nbsp;<span class="op" id="7125404">&amp;</span><span class="ident" id="7125405">runtimeTimer</span><span class="op" id="7125417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7125421">when</span><span class="op" id="7125425">:</span>&nbsp;<span class="ident" id="7125427">runtimeNano</span><span class="op" id="7125438">(</span><span class="op" id="7125439">)</span>&nbsp;<span class="op" id="7125441">+</span>&nbsp;<span class="op" id="7125443">(</span><span class="num" id="7125444">1</span><span class="op" id="7125445">&lt;&lt;</span><span class="num" id="7125447">63</span>&nbsp;<span class="op" id="7125450">-</span>&nbsp;<span class="num" id="7125452">1</span><span class="op" id="7125453">)</span><span class="op" id="7125454">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7125458">f</span><span class="op" id="7125459">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7125464">empty</span><span class="op" id="7125469">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7125473">arg</span><span class="op" id="7125476">:</span>&nbsp;&nbsp;<span class="ident" id="7125479">nil</span><span class="op" id="7125482">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7125485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7125488">startTimer</span><span class="op" id="7125498">(</span><span class="ident" id="7125499">r</span><span class="op" id="7125500">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7125504">//&nbsp;Start&nbsp;a&nbsp;goroutine&nbsp;that&nbsp;should&nbsp;send&nbsp;on&nbsp;t.C&nbsp;right&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7125562">t</span>&nbsp;<span class="op" id="7125564">:=</span>&nbsp;<span class="ident" id="7125567">NewTimer</span><span class="op" id="7125575">(</span><span class="num" id="7125576">1</span><span class="op" id="7125577">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7125581">defer</span>&nbsp;<span class="keyword" id="7125587">func</span><span class="op" id="7125591">(</span><span class="op" id="7125592">)</span>&nbsp;<span class="op" id="7125594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7125598">//&nbsp;Subsequent&nbsp;tests&nbsp;won&#39;t&nbsp;work&nbsp;correctly&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;stop&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7125662">//&nbsp;overflow&nbsp;timer&nbsp;and&nbsp;kick&nbsp;the&nbsp;timer&nbsp;proc&nbsp;back&nbsp;into&nbsp;service.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7125725">//</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7125730">//&nbsp;The&nbsp;timer&nbsp;proc&nbsp;is&nbsp;now&nbsp;sleeping&nbsp;and&nbsp;can&nbsp;only&nbsp;be&nbsp;awoken&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7125792">//&nbsp;adding&nbsp;a&nbsp;timer&nbsp;to&nbsp;the&nbsp;*beginning*&nbsp;of&nbsp;the&nbsp;heap.&nbsp;We&nbsp;can&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7125853">//&nbsp;wake&nbsp;it&nbsp;up&nbsp;by&nbsp;calling&nbsp;NewTimer&nbsp;since&nbsp;other&nbsp;tests&nbsp;may&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7125916">//&nbsp;left&nbsp;timers&nbsp;running&nbsp;that&nbsp;should&nbsp;have&nbsp;expired&nbsp;before&nbsp;ours.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7125979">//&nbsp;Instead&nbsp;we&nbsp;zero&nbsp;the&nbsp;overflow&nbsp;timer&nbsp;duration&nbsp;and&nbsp;start&nbsp;it</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7126041">//&nbsp;once&nbsp;more.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7126057">stopTimer</span><span class="op" id="7126066">(</span><span class="ident" id="7126067">r</span><span class="op" id="7126068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7126072">t</span><span class="op" id="7126073">.</span><span class="ident" id="7126074">Stop</span><span class="op" id="7126078">(</span><span class="op" id="7126079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7126083">r</span><span class="op" id="7126084">.</span><span class="ident" id="7126085">when</span>&nbsp;<span class="op" id="7126090">=</span>&nbsp;<span class="num" id="7126092">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7126096">startTimer</span><span class="op" id="7126106">(</span><span class="ident" id="7126107">r</span><span class="op" id="7126108">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7126111">}</span><span class="op" id="7126112">(</span><span class="op" id="7126113">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7126117">//&nbsp;If&nbsp;the&nbsp;test&nbsp;fails,&nbsp;we&nbsp;will&nbsp;hang&nbsp;here&nbsp;until&nbsp;the&nbsp;timeout&nbsp;in&nbsp;the&nbsp;testing&nbsp;package</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7126199">//&nbsp;fires,&nbsp;which&nbsp;is&nbsp;10&nbsp;minutes.&nbsp;It&nbsp;would&nbsp;be&nbsp;nice&nbsp;to&nbsp;catch&nbsp;the&nbsp;problem&nbsp;sooner,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7126277">//&nbsp;but&nbsp;there&nbsp;is&nbsp;no&nbsp;reliable&nbsp;way&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;timerproc&nbsp;schedules&nbsp;without</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7126356">//&nbsp;doing&nbsp;something&nbsp;involving&nbsp;timerproc&nbsp;itself.&nbsp;Previous&nbsp;failed&nbsp;attempts&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7126434">//&nbsp;tried&nbsp;calling&nbsp;runtime.Gosched&nbsp;and&nbsp;runtime.GC,&nbsp;but&nbsp;neither&nbsp;is&nbsp;reliable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7126509">//&nbsp;So&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;hope:&nbsp;We&nbsp;hope&nbsp;we&nbsp;don&#39;t&nbsp;hang&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7126566">&lt;-</span><span class="ident" id="7126568">t</span><span class="op" id="7126569">.</span><span class="ident" id="7126570">C</span><br>
<span class="lineno"></span><span class="op" id="7126572">}</span>
</div>
</body>
</html>
