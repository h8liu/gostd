<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7009418">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7009473">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7009527">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7009578">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="7009641">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="7009705">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7009762">package</span>&nbsp;<span class="ident" id="7009770">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="7009775">import</span>&nbsp;<span class="op" id="7009782">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009785">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009794">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009804">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009811">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009817">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009829">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009850">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009856">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009867">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009878">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7009885">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7009888">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="7009958">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="7010022">func</span>&nbsp;<span class="ident" id="7010027">TestHostingOurselves</span><span class="op" id="7010047">(</span><span class="ident" id="7010048">t</span>&nbsp;<span class="op" id="7010050">*</span><span class="ident" id="7010051"><a href="/net/http/cgi/matryoshka_test.go.html#7009867">testing</a></span><span class="op" id="7010058">.</span><span class="ident" id="7010059">T</span><span class="op" id="7010060">)</span>&nbsp;<span class="op" id="7010062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010065">if</span>&nbsp;<span class="ident" id="7010068"><a href="/net/http/cgi/matryoshka_test.go.html#7009856">runtime</a></span><span class="op" id="7010075">.</span><span class="ident" id="7010076">GOOS</span>&nbsp;<span class="op" id="7010081">==</span>&nbsp;<span class="string" id="7010084">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7010091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010095"><a href="/net/http/cgi/matryoshka_test.go.html#7010048">t</a></span><span class="op" id="7010096">.</span><span class="ident" id="7010097">Skip</span><span class="op" id="7010101">(</span><span class="string" id="7010102">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7010120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010123">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010127">h</span>&nbsp;<span class="op" id="7010129">:=</span>&nbsp;<span class="op" id="7010132">&amp;</span><span class="ident" id="7010133"><a href="/net/http/cgi/host.go.html#6144504">Handler</a></span><span class="op" id="7010140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010144">Path</span><span class="op" id="7010148">:</span>&nbsp;<span class="ident" id="7010150"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7010152">.</span><span class="ident" id="7010153">Args</span><span class="op" id="7010157">[</span><span class="num" id="7010158">0</span><span class="op" id="7010159">]</span><span class="op" id="7010160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010164">Root</span><span class="op" id="7010168">:</span>&nbsp;<span class="string" id="7010170">&#34;/test.go&#34;</span><span class="op" id="7010180">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010184">Args</span><span class="op" id="7010188">:</span>&nbsp;<span class="op" id="7010190">[</span><span class="op" id="7010191">]</span><span class="builtintype" id="7010192">string</span><span class="op" id="7010198">{</span><span class="string" id="7010199">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7010232">}</span><span class="op" id="7010233">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010239">expectedMap</span>&nbsp;<span class="op" id="7010251">:=</span>&nbsp;<span class="keyword" id="7010254">map</span><span class="op" id="7010257">[</span><span class="builtintype" id="7010258">string</span><span class="op" id="7010264">]</span><span class="builtintype" id="7010265">string</span><span class="op" id="7010271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010275">&#34;test&#34;</span><span class="op" id="7010281">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010300">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="7010318">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010322">&#34;param-a&#34;</span><span class="op" id="7010331">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010347">&#34;b&#34;</span><span class="op" id="7010350">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010354">&#34;param-foo&#34;</span><span class="op" id="7010365">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010379">&#34;bar&#34;</span><span class="op" id="7010384">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010388">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="7010411">:</span>&nbsp;<span class="string" id="7010413">&#34;CGI/1.1&#34;</span><span class="op" id="7010422">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010426">&#34;env-HTTP_HOST&#34;</span><span class="op" id="7010441">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010451">&#34;example.com&#34;</span><span class="op" id="7010464">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010468">&#34;env-PATH_INFO&#34;</span><span class="op" id="7010483">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010493">&#34;&#34;</span><span class="op" id="7010495">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010499">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7010517">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010524">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="7010537">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010541">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="7010558">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010566">&#34;1.2.3.4&#34;</span><span class="op" id="7010575">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010579">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="7010596">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010604">&#34;1.2.3.4&#34;</span><span class="op" id="7010613">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010617">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7010637">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010642">&#34;GET&#34;</span><span class="op" id="7010647">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010651">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7010668">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010676">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="7010698">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010702">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7010723">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7010727"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7010729">.</span><span class="ident" id="7010730">Args</span><span class="op" id="7010734">[</span><span class="num" id="7010735">0</span><span class="op" id="7010736">]</span><span class="op" id="7010737">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010741">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7010758">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010766">&#34;/test.go&#34;</span><span class="op" id="7010776">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010780">&#34;env-SERVER_NAME&#34;</span><span class="op" id="7010797">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010805">&#34;example.com&#34;</span><span class="op" id="7010818">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010822">&#34;env-SERVER_PORT&#34;</span><span class="op" id="7010839">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7010847">&#34;80&#34;</span><span class="op" id="7010851">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010855">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="7010876">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7010880">&#34;go&#34;</span><span class="op" id="7010884">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010890">replay</span>&nbsp;<span class="op" id="7010897">:=</span>&nbsp;<span class="ident" id="7010900"><a href="/net/http/cgi/host_test.go.html#6998398">runCgiTest</a></span><span class="op" id="7010910">(</span><span class="ident" id="7010911"><a href="/net/http/cgi/matryoshka_test.go.html#7010048">t</a></span><span class="op" id="7010912">,</span>&nbsp;<span class="ident" id="7010914"><a href="/net/http/cgi/matryoshka_test.go.html#7010127">h</a></span><span class="op" id="7010915">,</span>&nbsp;<span class="string" id="7010917">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7010975">,</span>&nbsp;<span class="ident" id="7010977"><a href="/net/http/cgi/matryoshka_test.go.html#7010239">expectedMap</a></span><span class="op" id="7010988">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010992">if</span>&nbsp;<span class="ident" id="7010995">expected</span><span class="op" id="7011003">,</span>&nbsp;<span class="ident" id="7011005">got</span>&nbsp;<span class="op" id="7011009">:=</span>&nbsp;<span class="string" id="7011012">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="7011038">,</span>&nbsp;<span class="ident" id="7011040"><a href="/net/http/cgi/matryoshka_test.go.html#7010890">replay</a></span><span class="op" id="7011046">.</span><span class="ident" id="7011047">Header</span><span class="op" id="7011053">(</span><span class="op" id="7011054">)</span><span class="op" id="7011055">.</span><span class="ident" id="7011056">Get</span><span class="op" id="7011059">(</span><span class="string" id="7011060">&#34;Content-Type&#34;</span><span class="op" id="7011074">)</span><span class="op" id="7011075">;</span>&nbsp;<span class="ident" id="7011077"><a href="/net/http/cgi/matryoshka_test.go.html#7011005">got</a></span>&nbsp;<span class="op" id="7011081">!=</span>&nbsp;<span class="ident" id="7011084"><a href="/net/http/cgi/matryoshka_test.go.html#7010995">expected</a></span>&nbsp;<span class="op" id="7011093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011097"><a href="/net/http/cgi/matryoshka_test.go.html#7010048">t</a></span><span class="op" id="7011098">.</span><span class="ident" id="7011099">Errorf</span><span class="op" id="7011105">(</span><span class="string" id="7011106">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7011145">,</span>&nbsp;<span class="ident" id="7011147"><a href="/net/http/cgi/matryoshka_test.go.html#7011005">got</a></span><span class="op" id="7011150">,</span>&nbsp;<span class="ident" id="7011152"><a href="/net/http/cgi/matryoshka_test.go.html#7010995">expected</a></span><span class="op" id="7011160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011166">if</span>&nbsp;<span class="ident" id="7011169">expected</span><span class="op" id="7011177">,</span>&nbsp;<span class="ident" id="7011179">got</span>&nbsp;<span class="op" id="7011183">:=</span>&nbsp;<span class="string" id="7011186">&#34;X-Test-Value&#34;</span><span class="op" id="7011200">,</span>&nbsp;<span class="ident" id="7011202"><a href="/net/http/cgi/matryoshka_test.go.html#7010890">replay</a></span><span class="op" id="7011208">.</span><span class="ident" id="7011209">Header</span><span class="op" id="7011215">(</span><span class="op" id="7011216">)</span><span class="op" id="7011217">.</span><span class="ident" id="7011218">Get</span><span class="op" id="7011221">(</span><span class="string" id="7011222">&#34;X-Test-Header&#34;</span><span class="op" id="7011237">)</span><span class="op" id="7011238">;</span>&nbsp;<span class="ident" id="7011240"><a href="/net/http/cgi/matryoshka_test.go.html#7011179">got</a></span>&nbsp;<span class="op" id="7011244">!=</span>&nbsp;<span class="ident" id="7011247"><a href="/net/http/cgi/matryoshka_test.go.html#7011169">expected</a></span>&nbsp;<span class="op" id="7011256">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011260"><a href="/net/http/cgi/matryoshka_test.go.html#7010048">t</a></span><span class="op" id="7011261">.</span><span class="ident" id="7011262">Errorf</span><span class="op" id="7011268">(</span><span class="string" id="7011269">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7011309">,</span>&nbsp;<span class="ident" id="7011311"><a href="/net/http/cgi/matryoshka_test.go.html#7011179">got</a></span><span class="op" id="7011314">,</span>&nbsp;<span class="ident" id="7011316"><a href="/net/http/cgi/matryoshka_test.go.html#7011169">expected</a></span><span class="op" id="7011324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011327">}</span><br>
<span class="lineno"></span><span class="op" id="7011329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7011332">type</span>&nbsp;<span class="ident" id="7011337">customWriterRecorder</span>&nbsp;<span class="keyword" id="7011358">struct</span>&nbsp;<span class="op" id="7011365">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011368">w</span>&nbsp;<span class="ident" id="7011370"><a href="/net/http/cgi/matryoshka_test.go.html#7009811">io</a></span><span class="op" id="7011372">.</span><span class="ident" id="7011373">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011381">*</span><span class="ident" id="7011382"><a href="/net/http/cgi/matryoshka_test.go.html#7009829">httptest</a></span><span class="op" id="7011390">.</span><span class="ident" id="7011391">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="7011408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7011411">func</span>&nbsp;<span class="op" id="7011416">(</span><span class="ident" id="7011417">r</span>&nbsp;<span class="op" id="7011419">*</span><span class="ident" id="7011420"><a href="/net/http/cgi/matryoshka_test.go.html#7011337">customWriterRecorder</a></span><span class="op" id="7011440">)</span>&nbsp;<span class="ident" id="7011442">Write</span><span class="op" id="7011447">(</span><span class="ident" id="7011448">p</span>&nbsp;<span class="op" id="7011450">[</span><span class="op" id="7011451">]</span><span class="builtintype" id="7011452">byte</span><span class="op" id="7011456">)</span>&nbsp;<span class="op" id="7011458">(</span><span class="ident" id="7011459">n</span>&nbsp;<span class="builtintype" id="7011461">int</span><span class="op" id="7011464">,</span>&nbsp;<span class="ident" id="7011466">err</span>&nbsp;<span class="builtintype" id="7011470">error</span><span class="op" id="7011475">)</span>&nbsp;<span class="op" id="7011477">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011480">return</span>&nbsp;<span class="ident" id="7011487"><a href="/net/http/cgi/matryoshka_test.go.html#7011417">r</a></span><span class="op" id="7011488">.</span><span class="ident" id="7011489">w</span><span class="op" id="7011490">.</span><span class="ident" id="7011491">Write</span><span class="op" id="7011496">(</span><span class="ident" id="7011497"><a href="/net/http/cgi/matryoshka_test.go.html#7011448">p</a></span><span class="op" id="7011498">)</span><br>
<span class="lineno"></span><span class="op" id="7011500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7011503">type</span>&nbsp;<span class="ident" id="7011508">limitWriter</span>&nbsp;<span class="keyword" id="7011520">struct</span>&nbsp;<span class="op" id="7011527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011530">w</span>&nbsp;<span class="ident" id="7011532"><a href="/net/http/cgi/matryoshka_test.go.html#7009811">io</a></span><span class="op" id="7011534">.</span><span class="ident" id="7011535">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011543">n</span>&nbsp;<span class="builtintype" id="7011545">int</span><br>
<span class="lineno"></span><span class="op" id="7011549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7011552">func</span>&nbsp;<span class="op" id="7011557">(</span><span class="ident" id="7011558">w</span>&nbsp;<span class="op" id="7011560">*</span><span class="ident" id="7011561"><a href="/net/http/cgi/matryoshka_test.go.html#7011508">limitWriter</a></span><span class="op" id="7011572">)</span>&nbsp;<span class="ident" id="7011574">Write</span><span class="op" id="7011579">(</span><span class="ident" id="7011580">p</span>&nbsp;<span class="op" id="7011582">[</span><span class="op" id="7011583">]</span><span class="builtintype" id="7011584">byte</span><span class="op" id="7011588">)</span>&nbsp;<span class="op" id="7011590">(</span><span class="ident" id="7011591">n</span>&nbsp;<span class="builtintype" id="7011593">int</span><span class="op" id="7011596">,</span>&nbsp;<span class="ident" id="7011598">err</span>&nbsp;<span class="builtintype" id="7011602">error</span><span class="op" id="7011607">)</span>&nbsp;<span class="op" id="7011609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011612">if</span>&nbsp;<span class="builtinfunc" id="7011615">len</span><span class="op" id="7011618">(</span><span class="ident" id="7011619"><a href="/net/http/cgi/matryoshka_test.go.html#7011580">p</a></span><span class="op" id="7011620">)</span>&nbsp;<span class="op" id="7011622">&gt;</span>&nbsp;<span class="ident" id="7011624"><a href="/net/http/cgi/matryoshka_test.go.html#7011558">w</a></span><span class="op" id="7011625">.</span><span class="ident" id="7011626">n</span>&nbsp;<span class="op" id="7011628">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011632"><a href="/net/http/cgi/matryoshka_test.go.html#7011580">p</a></span>&nbsp;<span class="op" id="7011634">=</span>&nbsp;<span class="ident" id="7011636"><a href="/net/http/cgi/matryoshka_test.go.html#7011580">p</a></span><span class="op" id="7011637">[</span><span class="op" id="7011638">:</span><span class="ident" id="7011639"><a href="/net/http/cgi/matryoshka_test.go.html#7011558">w</a></span><span class="op" id="7011640">.</span><span class="ident" id="7011641">n</span><span class="op" id="7011642">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011648">if</span>&nbsp;<span class="builtinfunc" id="7011651">len</span><span class="op" id="7011654">(</span><span class="ident" id="7011655"><a href="/net/http/cgi/matryoshka_test.go.html#7011580">p</a></span><span class="op" id="7011656">)</span>&nbsp;<span class="op" id="7011658">&gt;</span>&nbsp;<span class="num" id="7011660">0</span>&nbsp;<span class="op" id="7011662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011666"><a href="/net/http/cgi/matryoshka_test.go.html#7011591">n</a></span><span class="op" id="7011667">,</span>&nbsp;<span class="ident" id="7011669"><a href="/net/http/cgi/matryoshka_test.go.html#7011598">err</a></span>&nbsp;<span class="op" id="7011673">=</span>&nbsp;<span class="ident" id="7011675"><a href="/net/http/cgi/matryoshka_test.go.html#7011558">w</a></span><span class="op" id="7011676">.</span><span class="ident" id="7011677">w</span><span class="op" id="7011678">.</span><span class="ident" id="7011679">Write</span><span class="op" id="7011684">(</span><span class="ident" id="7011685"><a href="/net/http/cgi/matryoshka_test.go.html#7011580">p</a></span><span class="op" id="7011686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011690"><a href="/net/http/cgi/matryoshka_test.go.html#7011558">w</a></span><span class="op" id="7011691">.</span><span class="ident" id="7011692">n</span>&nbsp;<span class="op" id="7011694">-=</span>&nbsp;<span class="ident" id="7011697"><a href="/net/http/cgi/matryoshka_test.go.html#7011591">n</a></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011703">if</span>&nbsp;<span class="ident" id="7011706"><a href="/net/http/cgi/matryoshka_test.go.html#7011558">w</a></span><span class="op" id="7011707">.</span><span class="ident" id="7011708">n</span>&nbsp;<span class="op" id="7011710">==</span>&nbsp;<span class="num" id="7011713">0</span>&nbsp;<span class="op" id="7011715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011719"><a href="/net/http/cgi/matryoshka_test.go.html#7011598">err</a></span>&nbsp;<span class="op" id="7011723">=</span>&nbsp;<span class="ident" id="7011725"><a href="/net/http/cgi/matryoshka_test.go.html#7009794">errors</a></span><span class="op" id="7011731">.</span><span class="ident" id="7011732">New</span><span class="op" id="7011735">(</span><span class="string" id="7011736">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="7011754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011760">return</span><br>
<span class="lineno">90</span><span class="op" id="7011767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7011770">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="7011840">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="7011867">func</span>&nbsp;<span class="ident" id="7011872">TestKillChildAfterCopyError</span><span class="op" id="7011899">(</span><span class="ident" id="7011900">t</span>&nbsp;<span class="op" id="7011902">*</span><span class="ident" id="7011903"><a href="/net/http/cgi/matryoshka_test.go.html#7009867">testing</a></span><span class="op" id="7011910">.</span><span class="ident" id="7011911">T</span><span class="op" id="7011912">)</span>&nbsp;<span class="op" id="7011914">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011917">if</span>&nbsp;<span class="ident" id="7011920"><a href="/net/http/cgi/matryoshka_test.go.html#7009856">runtime</a></span><span class="op" id="7011927">.</span><span class="ident" id="7011928">GOOS</span>&nbsp;<span class="op" id="7011933">==</span>&nbsp;<span class="string" id="7011936">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7011943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011947"><a href="/net/http/cgi/matryoshka_test.go.html#7011900">t</a></span><span class="op" id="7011948">.</span><span class="ident" id="7011949">Skip</span><span class="op" id="7011953">(</span><span class="string" id="7011954">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7011972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011979">defer</span>&nbsp;<span class="keyword" id="7011985">func</span><span class="op" id="7011989">(</span><span class="op" id="7011990">)</span>&nbsp;<span class="op" id="7011992">{</span>&nbsp;<span class="ident" id="7011994"><a href="/net/http/cgi/host.go.html#6152923">testHookStartProcess</a></span>&nbsp;<span class="op" id="7012015">=</span>&nbsp;<span class="ident" id="7012017">nil</span>&nbsp;<span class="op" id="7012021">}</span><span class="op" id="7012022">(</span><span class="op" id="7012023">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012026">proc</span>&nbsp;<span class="op" id="7012031">:=</span>&nbsp;<span class="builtinfunc" id="7012034">make</span><span class="op" id="7012038">(</span><span class="keyword" id="7012039">chan</span>&nbsp;<span class="op" id="7012044">*</span><span class="ident" id="7012045"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7012047">.</span><span class="ident" id="7012048">Process</span><span class="op" id="7012055">,</span>&nbsp;<span class="num" id="7012057">1</span><span class="op" id="7012058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012061"><a href="/net/http/cgi/host.go.html#6152923">testHookStartProcess</a></span>&nbsp;<span class="op" id="7012082">=</span>&nbsp;<span class="keyword" id="7012084">func</span><span class="op" id="7012088">(</span><span class="ident" id="7012089">p</span>&nbsp;<span class="op" id="7012091">*</span><span class="ident" id="7012092"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7012094">.</span><span class="ident" id="7012095">Process</span><span class="op" id="7012102">)</span>&nbsp;<span class="op" id="7012104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012108"><a href="/net/http/cgi/matryoshka_test.go.html#7012026">proc</a></span>&nbsp;<span class="op" id="7012113">&lt;-</span>&nbsp;<span class="ident" id="7012116"><a href="/net/http/cgi/matryoshka_test.go.html#7012089">p</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012123">h</span>&nbsp;<span class="op" id="7012125">:=</span>&nbsp;<span class="op" id="7012128">&amp;</span><span class="ident" id="7012129"><a href="/net/http/cgi/host.go.html#6144504">Handler</a></span><span class="op" id="7012136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012140">Path</span><span class="op" id="7012144">:</span>&nbsp;<span class="ident" id="7012146"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7012148">.</span><span class="ident" id="7012149">Args</span><span class="op" id="7012153">[</span><span class="num" id="7012154">0</span><span class="op" id="7012155">]</span><span class="op" id="7012156">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012160">Root</span><span class="op" id="7012164">:</span>&nbsp;<span class="string" id="7012166">&#34;/test.go&#34;</span><span class="op" id="7012176">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012180">Args</span><span class="op" id="7012184">:</span>&nbsp;<span class="op" id="7012186">[</span><span class="op" id="7012187">]</span><span class="builtintype" id="7012188">string</span><span class="op" id="7012194">{</span><span class="string" id="7012195">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7012228">}</span><span class="op" id="7012229">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012232">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012235">req</span><span class="op" id="7012238">,</span>&nbsp;<span class="ident" id="7012240">_</span>&nbsp;<span class="op" id="7012242">:=</span>&nbsp;<span class="ident" id="7012245"><a href="/net/http/cgi/matryoshka_test.go.html#7009817">http</a></span><span class="op" id="7012249">.</span><span class="ident" id="7012250">NewRequest</span><span class="op" id="7012260">(</span><span class="string" id="7012261">&#34;GET&#34;</span><span class="op" id="7012266">,</span>&nbsp;<span class="string" id="7012268">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="7012313">,</span>&nbsp;<span class="ident" id="7012315">nil</span><span class="op" id="7012318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012321">rec</span>&nbsp;<span class="op" id="7012325">:=</span>&nbsp;<span class="ident" id="7012328"><a href="/net/http/cgi/matryoshka_test.go.html#7009829">httptest</a></span><span class="op" id="7012336">.</span><span class="ident" id="7012337">NewRecorder</span><span class="op" id="7012348">(</span><span class="op" id="7012349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012352">var</span>&nbsp;<span class="ident" id="7012356">out</span>&nbsp;<span class="ident" id="7012360"><a href="/net/http/cgi/matryoshka_test.go.html#7009785">bytes</a></span><span class="op" id="7012365">.</span><span class="ident" id="7012366">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012374">const</span>&nbsp;<span class="ident" id="7012380">writeLen</span>&nbsp;<span class="op" id="7012389">=</span>&nbsp;<span class="num" id="7012391">50</span>&nbsp;<span class="op" id="7012394">&lt;&lt;</span>&nbsp;<span class="num" id="7012397">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012401">rw</span>&nbsp;<span class="op" id="7012404">:=</span>&nbsp;<span class="op" id="7012407">&amp;</span><span class="ident" id="7012408"><a href="/net/http/cgi/matryoshka_test.go.html#7011337">customWriterRecorder</a></span><span class="op" id="7012428">{</span><span class="op" id="7012429">&amp;</span><span class="ident" id="7012430"><a href="/net/http/cgi/matryoshka_test.go.html#7011508">limitWriter</a></span><span class="op" id="7012441">{</span><span class="op" id="7012442">&amp;</span><span class="ident" id="7012443"><a href="/net/http/cgi/matryoshka_test.go.html#7012356">out</a></span><span class="op" id="7012446">,</span>&nbsp;<span class="ident" id="7012448"><a href="/net/http/cgi/matryoshka_test.go.html#7012380">writeLen</a></span><span class="op" id="7012456">}</span><span class="op" id="7012457">,</span>&nbsp;<span class="ident" id="7012459"><a href="/net/http/cgi/matryoshka_test.go.html#7012321">rec</a></span><span class="op" id="7012462">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012466">donec</span>&nbsp;<span class="op" id="7012472">:=</span>&nbsp;<span class="builtinfunc" id="7012475">make</span><span class="op" id="7012479">(</span><span class="keyword" id="7012480">chan</span>&nbsp;<span class="builtintype" id="7012485">bool</span><span class="op" id="7012489">,</span>&nbsp;<span class="num" id="7012491">1</span><span class="op" id="7012492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012495">go</span>&nbsp;<span class="keyword" id="7012498">func</span><span class="op" id="7012502">(</span><span class="op" id="7012503">)</span>&nbsp;<span class="op" id="7012505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012509"><a href="/net/http/cgi/matryoshka_test.go.html#7012123">h</a></span><span class="op" id="7012510">.</span><span class="ident" id="7012511">ServeHTTP</span><span class="op" id="7012520">(</span><span class="ident" id="7012521"><a href="/net/http/cgi/matryoshka_test.go.html#7012401">rw</a></span><span class="op" id="7012523">,</span>&nbsp;<span class="ident" id="7012525"><a href="/net/http/cgi/matryoshka_test.go.html#7012235">req</a></span><span class="op" id="7012528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012532"><a href="/net/http/cgi/matryoshka_test.go.html#7012466">donec</a></span>&nbsp;<span class="op" id="7012538">&lt;-</span>&nbsp;<span class="builtintype" id="7012541">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012547">}</span><span class="op" id="7012548">(</span><span class="op" id="7012549">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012553">select</span>&nbsp;<span class="op" id="7012560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012563">case</span>&nbsp;<span class="op" id="7012568">&lt;-</span><span class="ident" id="7012570"><a href="/net/http/cgi/matryoshka_test.go.html#7012466">donec</a></span><span class="op" id="7012575">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012579">if</span>&nbsp;<span class="ident" id="7012582"><a href="/net/http/cgi/matryoshka_test.go.html#7012356">out</a></span><span class="op" id="7012585">.</span><span class="ident" id="7012586">Len</span><span class="op" id="7012589">(</span><span class="op" id="7012590">)</span>&nbsp;<span class="op" id="7012592">!=</span>&nbsp;<span class="ident" id="7012595"><a href="/net/http/cgi/matryoshka_test.go.html#7012380">writeLen</a></span>&nbsp;<span class="op" id="7012604">||</span>&nbsp;<span class="ident" id="7012607"><a href="/net/http/cgi/matryoshka_test.go.html#7012356">out</a></span><span class="op" id="7012610">.</span><span class="ident" id="7012611">Bytes</span><span class="op" id="7012616">(</span><span class="op" id="7012617">)</span><span class="op" id="7012618">[</span><span class="num" id="7012619">0</span><span class="op" id="7012620">]</span>&nbsp;<span class="op" id="7012622">!=</span>&nbsp;<span class="string" id="7012625">&#39;a&#39;</span>&nbsp;<span class="op" id="7012629">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012634"><a href="/net/http/cgi/matryoshka_test.go.html#7011900">t</a></span><span class="op" id="7012635">.</span><span class="ident" id="7012636">Errorf</span><span class="op" id="7012642">(</span><span class="string" id="7012643">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="7012666">,</span>&nbsp;<span class="ident" id="7012668"><a href="/net/http/cgi/matryoshka_test.go.html#7012356">out</a></span><span class="op" id="7012671">.</span><span class="ident" id="7012672">Bytes</span><span class="op" id="7012677">(</span><span class="op" id="7012678">)</span><span class="op" id="7012679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012686">case</span>&nbsp;<span class="op" id="7012691">&lt;-</span><span class="ident" id="7012693"><a href="/net/http/cgi/matryoshka_test.go.html#7009878">time</a></span><span class="op" id="7012697">.</span><span class="ident" id="7012698">After</span><span class="op" id="7012703">(</span><span class="num" id="7012704">5</span>&nbsp;<span class="op" id="7012706">*</span>&nbsp;<span class="ident" id="7012708"><a href="/net/http/cgi/matryoshka_test.go.html#7009878">time</a></span><span class="op" id="7012712">.</span><span class="ident" id="7012713">Second</span><span class="op" id="7012719">)</span><span class="op" id="7012720">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012724"><a href="/net/http/cgi/matryoshka_test.go.html#7011900">t</a></span><span class="op" id="7012725">.</span><span class="ident" id="7012726">Errorf</span><span class="op" id="7012732">(</span><span class="string" id="7012733">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="7012793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012797">select</span>&nbsp;<span class="op" id="7012804">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012808">case</span>&nbsp;<span class="ident" id="7012813">p</span>&nbsp;<span class="op" id="7012815">:=</span>&nbsp;<span class="op" id="7012818">&lt;-</span><span class="ident" id="7012820"><a href="/net/http/cgi/matryoshka_test.go.html#7012026">proc</a></span><span class="op" id="7012824">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012829"><a href="/net/http/cgi/matryoshka_test.go.html#7012813">p</a></span><span class="op" id="7012830">.</span><span class="ident" id="7012831">Kill</span><span class="op" id="7012835">(</span><span class="op" id="7012836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012841"><a href="/net/http/cgi/matryoshka_test.go.html#7011900">t</a></span><span class="op" id="7012842">.</span><span class="ident" id="7012843">Logf</span><span class="op" id="7012847">(</span><span class="string" id="7012848">&#34;killed&nbsp;process&#34;</span><span class="op" id="7012864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012868">default</span><span class="op" id="7012875">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012880"><a href="/net/http/cgi/matryoshka_test.go.html#7011900">t</a></span><span class="op" id="7012881">.</span><span class="ident" id="7012882">Logf</span><span class="op" id="7012886">(</span><span class="string" id="7012887">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="7012908">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012915">}</span><br>
<span class="lineno"></span><span class="op" id="7012917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7012920">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="7012977">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="7013002">func</span>&nbsp;<span class="ident" id="7013007">TestChildOnlyHeaders</span><span class="op" id="7013027">(</span><span class="ident" id="7013028">t</span>&nbsp;<span class="op" id="7013030">*</span><span class="ident" id="7013031"><a href="/net/http/cgi/matryoshka_test.go.html#7009867">testing</a></span><span class="op" id="7013038">.</span><span class="ident" id="7013039">T</span><span class="op" id="7013040">)</span>&nbsp;<span class="op" id="7013042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013045">if</span>&nbsp;<span class="ident" id="7013048"><a href="/net/http/cgi/matryoshka_test.go.html#7009856">runtime</a></span><span class="op" id="7013055">.</span><span class="ident" id="7013056">GOOS</span>&nbsp;<span class="op" id="7013061">==</span>&nbsp;<span class="string" id="7013064">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7013071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013075"><a href="/net/http/cgi/matryoshka_test.go.html#7013028">t</a></span><span class="op" id="7013076">.</span><span class="ident" id="7013077">Skip</span><span class="op" id="7013081">(</span><span class="string" id="7013082">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7013100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013103">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013107">h</span>&nbsp;<span class="op" id="7013109">:=</span>&nbsp;<span class="op" id="7013112">&amp;</span><span class="ident" id="7013113"><a href="/net/http/cgi/host.go.html#6144504">Handler</a></span><span class="op" id="7013120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013124">Path</span><span class="op" id="7013128">:</span>&nbsp;<span class="ident" id="7013130"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7013132">.</span><span class="ident" id="7013133">Args</span><span class="op" id="7013137">[</span><span class="num" id="7013138">0</span><span class="op" id="7013139">]</span><span class="op" id="7013140">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013144">Root</span><span class="op" id="7013148">:</span>&nbsp;<span class="string" id="7013150">&#34;/test.go&#34;</span><span class="op" id="7013160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013164">Args</span><span class="op" id="7013168">:</span>&nbsp;<span class="op" id="7013170">[</span><span class="op" id="7013171">]</span><span class="builtintype" id="7013172">string</span><span class="op" id="7013178">{</span><span class="string" id="7013179">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7013212">}</span><span class="op" id="7013213">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013219">expectedMap</span>&nbsp;<span class="op" id="7013231">:=</span>&nbsp;<span class="keyword" id="7013234">map</span><span class="op" id="7013237">[</span><span class="builtintype" id="7013238">string</span><span class="op" id="7013244">]</span><span class="builtintype" id="7013245">string</span><span class="op" id="7013251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7013255">&#34;_body&#34;</span><span class="op" id="7013262">:</span>&nbsp;<span class="string" id="7013264">&#34;&#34;</span><span class="op" id="7013266">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013272">replay</span>&nbsp;<span class="op" id="7013279">:=</span>&nbsp;<span class="ident" id="7013282"><a href="/net/http/cgi/host_test.go.html#6998398">runCgiTest</a></span><span class="op" id="7013292">(</span><span class="ident" id="7013293"><a href="/net/http/cgi/matryoshka_test.go.html#7013028">t</a></span><span class="op" id="7013294">,</span>&nbsp;<span class="ident" id="7013296"><a href="/net/http/cgi/matryoshka_test.go.html#7013107">h</a></span><span class="op" id="7013297">,</span>&nbsp;<span class="string" id="7013299">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7013355">,</span>&nbsp;<span class="ident" id="7013357"><a href="/net/http/cgi/matryoshka_test.go.html#7013219">expectedMap</a></span><span class="op" id="7013368">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013371">if</span>&nbsp;<span class="ident" id="7013374">expected</span><span class="op" id="7013382">,</span>&nbsp;<span class="ident" id="7013384">got</span>&nbsp;<span class="op" id="7013388">:=</span>&nbsp;<span class="string" id="7013391">&#34;X-Test-Value&#34;</span><span class="op" id="7013405">,</span>&nbsp;<span class="ident" id="7013407"><a href="/net/http/cgi/matryoshka_test.go.html#7013272">replay</a></span><span class="op" id="7013413">.</span><span class="ident" id="7013414">Header</span><span class="op" id="7013420">(</span><span class="op" id="7013421">)</span><span class="op" id="7013422">.</span><span class="ident" id="7013423">Get</span><span class="op" id="7013426">(</span><span class="string" id="7013427">&#34;X-Test-Header&#34;</span><span class="op" id="7013442">)</span><span class="op" id="7013443">;</span>&nbsp;<span class="ident" id="7013445"><a href="/net/http/cgi/matryoshka_test.go.html#7013384">got</a></span>&nbsp;<span class="op" id="7013449">!=</span>&nbsp;<span class="ident" id="7013452"><a href="/net/http/cgi/matryoshka_test.go.html#7013374">expected</a></span>&nbsp;<span class="op" id="7013461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013465"><a href="/net/http/cgi/matryoshka_test.go.html#7013028">t</a></span><span class="op" id="7013466">.</span><span class="ident" id="7013467">Errorf</span><span class="op" id="7013473">(</span><span class="string" id="7013474">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7013514">,</span>&nbsp;<span class="ident" id="7013516"><a href="/net/http/cgi/matryoshka_test.go.html#7013384">got</a></span><span class="op" id="7013519">,</span>&nbsp;<span class="ident" id="7013521"><a href="/net/http/cgi/matryoshka_test.go.html#7013374">expected</a></span><span class="op" id="7013529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013532">}</span><br>
<span class="lineno"></span><span class="op" id="7013534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="7013537">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="7013562">func</span>&nbsp;<span class="ident" id="7013567">Test500WithNoHeaders</span><span class="op" id="7013587">(</span><span class="ident" id="7013588">t</span>&nbsp;<span class="op" id="7013590">*</span><span class="ident" id="7013591"><a href="/net/http/cgi/matryoshka_test.go.html#7009867">testing</a></span><span class="op" id="7013598">.</span><span class="ident" id="7013599">T</span><span class="op" id="7013600">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7013606">{</span>&nbsp;<span class="ident" id="7013608"><a href="/net/http/cgi/matryoshka_test.go.html#7013820">want500Test</a></span><span class="op" id="7013619">(</span><span class="ident" id="7013620"><a href="/net/http/cgi/matryoshka_test.go.html#7013588">t</a></span><span class="op" id="7013621">,</span>&nbsp;<span class="string" id="7013623">&#34;/immediate-disconnect&#34;</span><span class="op" id="7013646">)</span>&nbsp;<span class="op" id="7013648">}</span><br>
<span class="lineno"></span><span class="keyword" id="7013650">func</span>&nbsp;<span class="ident" id="7013655">Test500WithNoContentType</span><span class="op" id="7013679">(</span><span class="ident" id="7013680">t</span>&nbsp;<span class="op" id="7013682">*</span><span class="ident" id="7013683"><a href="/net/http/cgi/matryoshka_test.go.html#7009867">testing</a></span><span class="op" id="7013690">.</span><span class="ident" id="7013691">T</span><span class="op" id="7013692">)</span>&nbsp;<span class="op" id="7013694">{</span>&nbsp;<span class="ident" id="7013696"><a href="/net/http/cgi/matryoshka_test.go.html#7013820">want500Test</a></span><span class="op" id="7013707">(</span><span class="ident" id="7013708"><a href="/net/http/cgi/matryoshka_test.go.html#7013680">t</a></span><span class="op" id="7013709">,</span>&nbsp;<span class="string" id="7013711">&#34;/no-content-type&#34;</span><span class="op" id="7013729">)</span>&nbsp;<span class="op" id="7013731">}</span><br>
<span class="lineno"></span><span class="keyword" id="7013733">func</span>&nbsp;<span class="ident" id="7013738">Test500WithEmptyHeaders</span><span class="op" id="7013761">(</span><span class="ident" id="7013762">t</span>&nbsp;<span class="op" id="7013764">*</span><span class="ident" id="7013765"><a href="/net/http/cgi/matryoshka_test.go.html#7009867">testing</a></span><span class="op" id="7013772">.</span><span class="ident" id="7013773">T</span><span class="op" id="7013774">)</span>&nbsp;&nbsp;<span class="op" id="7013777">{</span>&nbsp;<span class="ident" id="7013779"><a href="/net/http/cgi/matryoshka_test.go.html#7013820">want500Test</a></span><span class="op" id="7013790">(</span><span class="ident" id="7013791"><a href="/net/http/cgi/matryoshka_test.go.html#7013762">t</a></span><span class="op" id="7013792">,</span>&nbsp;<span class="string" id="7013794">&#34;/empty-headers&#34;</span><span class="op" id="7013810">)</span>&nbsp;<span class="op" id="7013812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7013815">func</span>&nbsp;<span class="ident" id="7013820">want500Test</span><span class="op" id="7013831">(</span><span class="ident" id="7013832">t</span>&nbsp;<span class="op" id="7013834">*</span><span class="ident" id="7013835"><a href="/net/http/cgi/matryoshka_test.go.html#7009867">testing</a></span><span class="op" id="7013842">.</span><span class="ident" id="7013843">T</span><span class="op" id="7013844">,</span>&nbsp;<span class="ident" id="7013846">path</span>&nbsp;<span class="builtintype" id="7013851">string</span><span class="op" id="7013857">)</span>&nbsp;<span class="op" id="7013859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013862">h</span>&nbsp;<span class="op" id="7013864">:=</span>&nbsp;<span class="op" id="7013867">&amp;</span><span class="ident" id="7013868"><a href="/net/http/cgi/host.go.html#6144504">Handler</a></span><span class="op" id="7013875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013879">Path</span><span class="op" id="7013883">:</span>&nbsp;<span class="ident" id="7013885"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7013887">.</span><span class="ident" id="7013888">Args</span><span class="op" id="7013892">[</span><span class="num" id="7013893">0</span><span class="op" id="7013894">]</span><span class="op" id="7013895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013899">Root</span><span class="op" id="7013903">:</span>&nbsp;<span class="string" id="7013905">&#34;/test.go&#34;</span><span class="op" id="7013915">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013919">Args</span><span class="op" id="7013923">:</span>&nbsp;<span class="op" id="7013925">[</span><span class="op" id="7013926">]</span><span class="builtintype" id="7013927">string</span><span class="op" id="7013933">{</span><span class="string" id="7013934">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7013967">}</span><span class="op" id="7013968">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013974">expectedMap</span>&nbsp;<span class="op" id="7013986">:=</span>&nbsp;<span class="keyword" id="7013989">map</span><span class="op" id="7013992">[</span><span class="builtintype" id="7013993">string</span><span class="op" id="7013999">]</span><span class="builtintype" id="7014000">string</span><span class="op" id="7014006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7014010">&#34;_body&#34;</span><span class="op" id="7014017">:</span>&nbsp;<span class="string" id="7014019">&#34;&#34;</span><span class="op" id="7014021">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014027">replay</span>&nbsp;<span class="op" id="7014034">:=</span>&nbsp;<span class="ident" id="7014037"><a href="/net/http/cgi/host_test.go.html#6998398">runCgiTest</a></span><span class="op" id="7014047">(</span><span class="ident" id="7014048"><a href="/net/http/cgi/matryoshka_test.go.html#7013832">t</a></span><span class="op" id="7014049">,</span>&nbsp;<span class="ident" id="7014051"><a href="/net/http/cgi/matryoshka_test.go.html#7013862">h</a></span><span class="op" id="7014052">,</span>&nbsp;<span class="string" id="7014054">&#34;GET&nbsp;&#34;</span><span class="op" id="7014060">+</span><span class="ident" id="7014061"><a href="/net/http/cgi/matryoshka_test.go.html#7013846">path</a></span><span class="op" id="7014065">+</span><span class="string" id="7014066">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7014100">,</span>&nbsp;<span class="ident" id="7014102"><a href="/net/http/cgi/matryoshka_test.go.html#7013974">expectedMap</a></span><span class="op" id="7014113">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014116">if</span>&nbsp;<span class="ident" id="7014119"><a href="/net/http/cgi/matryoshka_test.go.html#7014027">replay</a></span><span class="op" id="7014125">.</span><span class="ident" id="7014126">Code</span>&nbsp;<span class="op" id="7014131">!=</span>&nbsp;<span class="num" id="7014134">500</span>&nbsp;<span class="op" id="7014138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014142"><a href="/net/http/cgi/matryoshka_test.go.html#7013832">t</a></span><span class="op" id="7014143">.</span><span class="ident" id="7014144">Errorf</span><span class="op" id="7014150">(</span><span class="string" id="7014151">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="7014174">,</span>&nbsp;<span class="ident" id="7014176"><a href="/net/http/cgi/matryoshka_test.go.html#7014027">replay</a></span><span class="op" id="7014182">.</span><span class="ident" id="7014183">Code</span><span class="op" id="7014187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014190">}</span><br>
<span class="lineno"></span><span class="op" id="7014192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="7014195">type</span>&nbsp;<span class="ident" id="7014200">neverEnding</span>&nbsp;<span class="builtintype" id="7014212">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7014218">func</span>&nbsp;<span class="op" id="7014223">(</span><span class="ident" id="7014224">b</span>&nbsp;<span class="ident" id="7014226"><a href="/net/http/cgi/matryoshka_test.go.html#7014200">neverEnding</a></span><span class="op" id="7014237">)</span>&nbsp;<span class="ident" id="7014239">Read</span><span class="op" id="7014243">(</span><span class="ident" id="7014244">p</span>&nbsp;<span class="op" id="7014246">[</span><span class="op" id="7014247">]</span><span class="builtintype" id="7014248">byte</span><span class="op" id="7014252">)</span>&nbsp;<span class="op" id="7014254">(</span><span class="ident" id="7014255">n</span>&nbsp;<span class="builtintype" id="7014257">int</span><span class="op" id="7014260">,</span>&nbsp;<span class="ident" id="7014262">err</span>&nbsp;<span class="builtintype" id="7014266">error</span><span class="op" id="7014271">)</span>&nbsp;<span class="op" id="7014273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014276">for</span>&nbsp;<span class="ident" id="7014280">i</span>&nbsp;<span class="op" id="7014282">:=</span>&nbsp;<span class="keyword" id="7014285">range</span>&nbsp;<span class="ident" id="7014291"><a href="/net/http/cgi/matryoshka_test.go.html#7014244">p</a></span>&nbsp;<span class="op" id="7014293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014297"><a href="/net/http/cgi/matryoshka_test.go.html#7014244">p</a></span><span class="op" id="7014298">[</span><span class="ident" id="7014299"><a href="/net/http/cgi/matryoshka_test.go.html#7014280">i</a></span><span class="op" id="7014300">]</span>&nbsp;<span class="op" id="7014302">=</span>&nbsp;<span class="builtintype" id="7014304">byte</span><span class="op" id="7014308">(</span><span class="ident" id="7014309"><a href="/net/http/cgi/matryoshka_test.go.html#7014224">b</a></span><span class="op" id="7014310">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014316">return</span>&nbsp;<span class="builtinfunc" id="7014323">len</span><span class="op" id="7014326">(</span><span class="ident" id="7014327"><a href="/net/http/cgi/matryoshka_test.go.html#7014244">p</a></span><span class="op" id="7014328">)</span><span class="op" id="7014329">,</span>&nbsp;<span class="ident" id="7014331">nil</span><br>
<span class="lineno"></span><span class="op" id="7014335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7014338">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="7014368">func</span>&nbsp;<span class="ident" id="7014373">TestBeChildCGIProcess</span><span class="op" id="7014394">(</span><span class="ident" id="7014395">t</span>&nbsp;<span class="op" id="7014397">*</span><span class="ident" id="7014398"><a href="/net/http/cgi/matryoshka_test.go.html#7009867">testing</a></span><span class="op" id="7014405">.</span><span class="ident" id="7014406">T</span><span class="op" id="7014407">)</span>&nbsp;<span class="op" id="7014409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014412">if</span>&nbsp;<span class="ident" id="7014415"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7014417">.</span><span class="ident" id="7014418">Getenv</span><span class="op" id="7014424">(</span><span class="string" id="7014425">&#34;REQUEST_METHOD&#34;</span><span class="op" id="7014441">)</span>&nbsp;<span class="op" id="7014443">==</span>&nbsp;<span class="string" id="7014446">&#34;&#34;</span>&nbsp;<span class="op" id="7014449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7014453">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014499">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014507">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014510">switch</span>&nbsp;<span class="ident" id="7014517"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7014519">.</span><span class="ident" id="7014520">Getenv</span><span class="op" id="7014526">(</span><span class="string" id="7014527">&#34;REQUEST_URI&#34;</span><span class="op" id="7014540">)</span>&nbsp;<span class="op" id="7014542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014545">case</span>&nbsp;<span class="string" id="7014550">&#34;/immediate-disconnect&#34;</span><span class="op" id="7014573">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014577"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7014579">.</span><span class="ident" id="7014580">Exit</span><span class="op" id="7014584">(</span><span class="num" id="7014585">0</span><span class="op" id="7014586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014589">case</span>&nbsp;<span class="string" id="7014594">&#34;/no-content-type&#34;</span><span class="op" id="7014612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014616"><a href="/net/http/cgi/matryoshka_test.go.html#7009804">fmt</a></span><span class="op" id="7014619">.</span><span class="ident" id="7014620">Printf</span><span class="op" id="7014626">(</span><span class="string" id="7014627">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="7014657">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014661"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7014663">.</span><span class="ident" id="7014664">Exit</span><span class="op" id="7014668">(</span><span class="num" id="7014669">0</span><span class="op" id="7014670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014673">case</span>&nbsp;<span class="string" id="7014678">&#34;/empty-headers&#34;</span><span class="op" id="7014694">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014698"><a href="/net/http/cgi/matryoshka_test.go.html#7009804">fmt</a></span><span class="op" id="7014701">.</span><span class="ident" id="7014702">Printf</span><span class="op" id="7014708">(</span><span class="string" id="7014709">&#34;\nHello&#34;</span><span class="op" id="7014718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014722"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7014724">.</span><span class="ident" id="7014725">Exit</span><span class="op" id="7014729">(</span><span class="num" id="7014730">0</span><span class="op" id="7014731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014734">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014737"><a href="/net/http/cgi/child.go.html#6141913">Serve</a></span><span class="op" id="7014742">(</span><span class="ident" id="7014743"><a href="/net/http/cgi/matryoshka_test.go.html#7009817">http</a></span><span class="op" id="7014747">.</span><span class="ident" id="7014748">HandlerFunc</span><span class="op" id="7014759">(</span><span class="keyword" id="7014760">func</span><span class="op" id="7014764">(</span><span class="ident" id="7014765">rw</span>&nbsp;<span class="ident" id="7014768"><a href="/net/http/cgi/matryoshka_test.go.html#7009817">http</a></span><span class="op" id="7014772">.</span><span class="ident" id="7014773">ResponseWriter</span><span class="op" id="7014787">,</span>&nbsp;<span class="ident" id="7014789">req</span>&nbsp;<span class="op" id="7014793">*</span><span class="ident" id="7014794"><a href="/net/http/cgi/matryoshka_test.go.html#7009817">http</a></span><span class="op" id="7014798">.</span><span class="ident" id="7014799">Request</span><span class="op" id="7014806">)</span>&nbsp;<span class="op" id="7014808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014812"><a href="/net/http/cgi/matryoshka_test.go.html#7014765">rw</a></span><span class="op" id="7014814">.</span><span class="ident" id="7014815">Header</span><span class="op" id="7014821">(</span><span class="op" id="7014822">)</span><span class="op" id="7014823">.</span><span class="ident" id="7014824">Set</span><span class="op" id="7014827">(</span><span class="string" id="7014828">&#34;X-Test-Header&#34;</span><span class="op" id="7014843">,</span>&nbsp;<span class="string" id="7014845">&#34;X-Test-Value&#34;</span><span class="op" id="7014859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014863"><a href="/net/http/cgi/matryoshka_test.go.html#7014789">req</a></span><span class="op" id="7014866">.</span><span class="ident" id="7014867">ParseForm</span><span class="op" id="7014876">(</span><span class="op" id="7014877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014881">if</span>&nbsp;<span class="ident" id="7014884"><a href="/net/http/cgi/matryoshka_test.go.html#7014789">req</a></span><span class="op" id="7014887">.</span><span class="ident" id="7014888">FormValue</span><span class="op" id="7014897">(</span><span class="string" id="7014898">&#34;no-body&#34;</span><span class="op" id="7014907">)</span>&nbsp;<span class="op" id="7014909">==</span>&nbsp;<span class="string" id="7014912">&#34;1&#34;</span>&nbsp;<span class="op" id="7014916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014921">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014934">if</span>&nbsp;<span class="ident" id="7014937"><a href="/net/http/cgi/matryoshka_test.go.html#7014789">req</a></span><span class="op" id="7014940">.</span><span class="ident" id="7014941">FormValue</span><span class="op" id="7014950">(</span><span class="string" id="7014951">&#34;write-forever&#34;</span><span class="op" id="7014966">)</span>&nbsp;<span class="op" id="7014968">==</span>&nbsp;<span class="string" id="7014971">&#34;1&#34;</span>&nbsp;<span class="op" id="7014975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014980"><a href="/net/http/cgi/matryoshka_test.go.html#7009811">io</a></span><span class="op" id="7014982">.</span><span class="ident" id="7014983">Copy</span><span class="op" id="7014987">(</span><span class="ident" id="7014988"><a href="/net/http/cgi/matryoshka_test.go.html#7014765">rw</a></span><span class="op" id="7014990">,</span>&nbsp;<span class="ident" id="7014992"><a href="/net/http/cgi/matryoshka_test.go.html#7014200">neverEnding</a></span><span class="op" id="7015003">(</span><span class="string" id="7015004">&#39;a&#39;</span><span class="op" id="7015007">)</span><span class="op" id="7015008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015013">for</span>&nbsp;<span class="op" id="7015017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015023"><a href="/net/http/cgi/matryoshka_test.go.html#7009878">time</a></span><span class="op" id="7015027">.</span><span class="ident" id="7015028">Sleep</span><span class="op" id="7015033">(</span><span class="num" id="7015034">5</span>&nbsp;<span class="op" id="7015036">*</span>&nbsp;<span class="ident" id="7015038"><a href="/net/http/cgi/matryoshka_test.go.html#7009878">time</a></span><span class="op" id="7015042">.</span><span class="ident" id="7015043">Second</span><span class="op" id="7015049">)</span>&nbsp;<span class="comment" id="7015051">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015092"><a href="/net/http/cgi/matryoshka_test.go.html#7009804">fmt</a></span><span class="op" id="7015095">.</span><span class="ident" id="7015096">Fprintf</span><span class="op" id="7015103">(</span><span class="ident" id="7015104"><a href="/net/http/cgi/matryoshka_test.go.html#7014765">rw</a></span><span class="op" id="7015106">,</span>&nbsp;<span class="string" id="7015108">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="7015133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015137">for</span>&nbsp;<span class="ident" id="7015141">k</span><span class="op" id="7015142">,</span>&nbsp;<span class="ident" id="7015144">vv</span>&nbsp;<span class="op" id="7015147">:=</span>&nbsp;<span class="keyword" id="7015150">range</span>&nbsp;<span class="ident" id="7015156"><a href="/net/http/cgi/matryoshka_test.go.html#7014789">req</a></span><span class="op" id="7015159">.</span><span class="ident" id="7015160">Form</span>&nbsp;<span class="op" id="7015165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015170">for</span>&nbsp;<span class="ident" id="7015174">_</span><span class="op" id="7015175">,</span>&nbsp;<span class="ident" id="7015177">v</span>&nbsp;<span class="op" id="7015179">:=</span>&nbsp;<span class="keyword" id="7015182">range</span>&nbsp;<span class="ident" id="7015188"><a href="/net/http/cgi/matryoshka_test.go.html#7015144">vv</a></span>&nbsp;<span class="op" id="7015191">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015197"><a href="/net/http/cgi/matryoshka_test.go.html#7009804">fmt</a></span><span class="op" id="7015200">.</span><span class="ident" id="7015201">Fprintf</span><span class="op" id="7015208">(</span><span class="ident" id="7015209"><a href="/net/http/cgi/matryoshka_test.go.html#7014765">rw</a></span><span class="op" id="7015211">,</span>&nbsp;<span class="string" id="7015213">&#34;param-%s=%s\n&#34;</span><span class="op" id="7015228">,</span>&nbsp;<span class="ident" id="7015230"><a href="/net/http/cgi/matryoshka_test.go.html#7015141">k</a></span><span class="op" id="7015231">,</span>&nbsp;<span class="ident" id="7015233"><a href="/net/http/cgi/matryoshka_test.go.html#7015177">v</a></span><span class="op" id="7015234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015247">for</span>&nbsp;<span class="ident" id="7015251">_</span><span class="op" id="7015252">,</span>&nbsp;<span class="ident" id="7015254">kv</span>&nbsp;<span class="op" id="7015257">:=</span>&nbsp;<span class="keyword" id="7015260">range</span>&nbsp;<span class="ident" id="7015266"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7015268">.</span><span class="ident" id="7015269">Environ</span><span class="op" id="7015276">(</span><span class="op" id="7015277">)</span>&nbsp;<span class="op" id="7015279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015284"><a href="/net/http/cgi/matryoshka_test.go.html#7009804">fmt</a></span><span class="op" id="7015287">.</span><span class="ident" id="7015288">Fprintf</span><span class="op" id="7015295">(</span><span class="ident" id="7015296"><a href="/net/http/cgi/matryoshka_test.go.html#7014765">rw</a></span><span class="op" id="7015298">,</span>&nbsp;<span class="string" id="7015300">&#34;env-%s\n&#34;</span><span class="op" id="7015310">,</span>&nbsp;<span class="ident" id="7015312"><a href="/net/http/cgi/matryoshka_test.go.html#7015254">kv</a></span><span class="op" id="7015314">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015321">}</span><span class="op" id="7015322">)</span><span class="op" id="7015323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015326"><a href="/net/http/cgi/matryoshka_test.go.html#7009850">os</a></span><span class="op" id="7015328">.</span><span class="ident" id="7015329">Exit</span><span class="op" id="7015333">(</span><span class="num" id="7015334">0</span><span class="op" id="7015335">)</span><br>
<span class="lineno"></span><span class="op" id="7015337">}</span>
</div>
</body>
</html>
