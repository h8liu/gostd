<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/parser</h2>
<ul>
<li><a href="/gostd/go/parser/error_test.go.html">error_test.go</a></li>
<li><a href="/gostd/go/parser/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/parser/interface.go.html">interface.go</a></li>
<li><a href="/gostd/go/parser/parser.go.html">parser.go</a></li>
<li><a href="/gostd/go/parser/parser_test.go.html">parser_test.go</a></li>
<li><a href="/gostd/go/parser/performance_test.go.html">performance_test.go</a></li>
<li><a href="/gostd/go/parser/short_test.go.html">short_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5718509">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5718564">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5718618">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5718669">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;exported&nbsp;entry&nbsp;points&nbsp;for&nbsp;invoking&nbsp;the&nbsp;parser.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5718743">package</span>&nbsp;<span class="ident" id="5718751">parser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5718759">import</span>&nbsp;<span class="op" id="5718766">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5718769">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5718778">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5718788">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5718798">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5718810">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5718816">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5718829">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5718835">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5718852">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5718862">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="5718865">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;readSource&nbsp;converts&nbsp;src&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;possible;</span><br>
<span class="lineno"></span><span class="comment" id="5718932">//&nbsp;otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error.&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;readSource&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5719000">//&nbsp;the&nbsp;result&nbsp;of&nbsp;reading&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="5719057">//</span><br>
<span class="lineno">25</span><span class="keyword" id="5719060">func</span>&nbsp;<span class="ident" id="5719065">readSource</span><span class="op" id="5719075">(</span><span class="ident" id="5719076">filename</span>&nbsp;<span class="builtintype" id="5719085">string</span><span class="op" id="5719091">,</span>&nbsp;<span class="ident" id="5719093">src</span>&nbsp;<span class="keyword" id="5719097">interface</span><span class="op" id="5719106">{</span><span class="op" id="5719107">}</span><span class="op" id="5719108">)</span>&nbsp;<span class="op" id="5719110">(</span><span class="op" id="5719111">[</span><span class="op" id="5719112">]</span><span class="builtintype" id="5719113">byte</span><span class="op" id="5719117">,</span>&nbsp;<span class="builtintype" id="5719119">error</span><span class="op" id="5719124">)</span>&nbsp;<span class="op" id="5719126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719129">if</span>&nbsp;<span class="ident" id="5719132">src</span>&nbsp;<span class="op" id="5719136">!=</span>&nbsp;<span class="ident" id="5719139">nil</span>&nbsp;<span class="op" id="5719143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719147">switch</span>&nbsp;<span class="ident" id="5719154">s</span>&nbsp;<span class="op" id="5719156">:=</span>&nbsp;<span class="ident" id="5719159">src</span><span class="op" id="5719162">.</span><span class="op" id="5719163">(</span><span class="keyword" id="5719164">type</span><span class="op" id="5719168">)</span>&nbsp;<span class="op" id="5719170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719174">case</span>&nbsp;<span class="builtintype" id="5719179">string</span><span class="op" id="5719185">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719190">return</span>&nbsp;<span class="op" id="5719197">[</span><span class="op" id="5719198">]</span><span class="builtintype" id="5719199">byte</span><span class="op" id="5719203">(</span><span class="ident" id="5719204">s</span><span class="op" id="5719205">)</span><span class="op" id="5719206">,</span>&nbsp;<span class="ident" id="5719208">nil</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719214">case</span>&nbsp;<span class="op" id="5719219">[</span><span class="op" id="5719220">]</span><span class="builtintype" id="5719221">byte</span><span class="op" id="5719225">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719230">return</span>&nbsp;<span class="ident" id="5719237">s</span><span class="op" id="5719238">,</span>&nbsp;<span class="ident" id="5719240">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719246">case</span>&nbsp;<span class="op" id="5719251">*</span><span class="ident" id="5719252">bytes</span><span class="op" id="5719257">.</span><span class="ident" id="5719258">Buffer</span><span class="op" id="5719264">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5719269">//&nbsp;is&nbsp;io.Reader,&nbsp;but&nbsp;src&nbsp;is&nbsp;already&nbsp;available&nbsp;in&nbsp;[]byte&nbsp;form</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719333">if</span>&nbsp;<span class="ident" id="5719336">s</span>&nbsp;<span class="op" id="5719338">!=</span>&nbsp;<span class="ident" id="5719341">nil</span>&nbsp;<span class="op" id="5719345">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719351">return</span>&nbsp;<span class="ident" id="5719358">s</span><span class="op" id="5719359">.</span><span class="ident" id="5719360">Bytes</span><span class="op" id="5719365">(</span><span class="op" id="5719366">)</span><span class="op" id="5719367">,</span>&nbsp;<span class="ident" id="5719369">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5719376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719380">case</span>&nbsp;<span class="ident" id="5719385">io</span><span class="op" id="5719387">.</span><span class="ident" id="5719388">Reader</span><span class="op" id="5719394">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719399">var</span>&nbsp;<span class="ident" id="5719403">buf</span>&nbsp;<span class="ident" id="5719407">bytes</span><span class="op" id="5719412">.</span><span class="ident" id="5719413">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719423">if</span>&nbsp;<span class="ident" id="5719426">_</span><span class="op" id="5719427">,</span>&nbsp;<span class="ident" id="5719429">err</span>&nbsp;<span class="op" id="5719433">:=</span>&nbsp;<span class="ident" id="5719436">io</span><span class="op" id="5719438">.</span><span class="ident" id="5719439">Copy</span><span class="op" id="5719443">(</span><span class="op" id="5719444">&amp;</span><span class="ident" id="5719445">buf</span><span class="op" id="5719448">,</span>&nbsp;<span class="ident" id="5719450">s</span><span class="op" id="5719451">)</span><span class="op" id="5719452">;</span>&nbsp;<span class="ident" id="5719454">err</span>&nbsp;<span class="op" id="5719458">!=</span>&nbsp;<span class="ident" id="5719461">nil</span>&nbsp;<span class="op" id="5719465">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719471">return</span>&nbsp;<span class="ident" id="5719478">nil</span><span class="op" id="5719481">,</span>&nbsp;<span class="ident" id="5719483">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5719490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719495">return</span>&nbsp;<span class="ident" id="5719502">buf</span><span class="op" id="5719505">.</span><span class="ident" id="5719506">Bytes</span><span class="op" id="5719511">(</span><span class="op" id="5719512">)</span><span class="op" id="5719513">,</span>&nbsp;<span class="ident" id="5719515">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5719521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719525">return</span>&nbsp;<span class="ident" id="5719532">nil</span><span class="op" id="5719535">,</span>&nbsp;<span class="ident" id="5719537">errors</span><span class="op" id="5719543">.</span><span class="ident" id="5719544">New</span><span class="op" id="5719547">(</span><span class="string" id="5719548">&#34;invalid&nbsp;source&#34;</span><span class="op" id="5719564">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5719567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5719570">return</span>&nbsp;<span class="ident" id="5719577">ioutil</span><span class="op" id="5719583">.</span><span class="ident" id="5719584">ReadFile</span><span class="op" id="5719592">(</span><span class="ident" id="5719593">filename</span><span class="op" id="5719601">)</span><br>
<span class="lineno"></span><span class="op" id="5719603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5719606">//&nbsp;A&nbsp;Mode&nbsp;value&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;flags&nbsp;(or&nbsp;0).</span><br>
<span class="lineno">50</span><span class="comment" id="5719648">//&nbsp;They&nbsp;control&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;code&nbsp;parsed&nbsp;and&nbsp;other&nbsp;optional</span><br>
<span class="lineno"></span><span class="comment" id="5719716">//&nbsp;parser&nbsp;functionality.</span><br>
<span class="lineno"></span><span class="comment" id="5719741">//</span><br>
<span class="lineno"></span><span class="keyword" id="5719744">type</span>&nbsp;<span class="ident" id="5719749">Mode</span>&nbsp;<span class="builtintype" id="5719754">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5719760">const</span>&nbsp;<span class="op" id="5719766">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719769">PackageClauseOnly</span>&nbsp;<span class="ident" id="5719787">Mode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5719804">=</span>&nbsp;<span class="num" id="5719806">1</span>&nbsp;<span class="op" id="5719808">&lt;&lt;</span>&nbsp;<span class="ident" id="5719811">iota</span>&nbsp;<span class="comment" id="5719816">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;package&nbsp;clause</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719854">ImportsOnly</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5719901">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;import&nbsp;declarations</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5719944">ParseComments</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5719991">//&nbsp;parse&nbsp;comments&nbsp;and&nbsp;add&nbsp;them&nbsp;to&nbsp;AST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720030">Trace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5720077">//&nbsp;print&nbsp;a&nbsp;trace&nbsp;of&nbsp;parsed&nbsp;productions</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720117">DeclarationErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5720164">//&nbsp;report&nbsp;declaration&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720194">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5720241">//&nbsp;same&nbsp;as&nbsp;AllErrors,&nbsp;for&nbsp;backward-compatibility</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5720291">AllErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5720309">=</span>&nbsp;<span class="ident" id="5720311">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5720338">//&nbsp;report&nbsp;all&nbsp;errors&nbsp;(not&nbsp;just&nbsp;the&nbsp;first&nbsp;10&nbsp;on&nbsp;different&nbsp;lines)</span><br>
<span class="lineno"></span><span class="op" id="5720402">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5720405">//&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;code&nbsp;of&nbsp;a&nbsp;single&nbsp;Go&nbsp;source&nbsp;file&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5720480">//&nbsp;the&nbsp;corresponding&nbsp;ast.File&nbsp;node.&nbsp;The&nbsp;source&nbsp;code&nbsp;may&nbsp;be&nbsp;provided&nbsp;via</span><br>
<span class="lineno"></span><span class="comment" id="5720552">//&nbsp;the&nbsp;filename&nbsp;of&nbsp;the&nbsp;source&nbsp;file,&nbsp;or&nbsp;via&nbsp;the&nbsp;src&nbsp;parameter.</span><br>
<span class="lineno"></span><span class="comment" id="5720614">//</span><br>
<span class="lineno"></span><span class="comment" id="5720617">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;from&nbsp;src&nbsp;and&nbsp;the&nbsp;filename&nbsp;is</span><br>
<span class="lineno">70</span><span class="comment" id="5720692">//&nbsp;only&nbsp;used&nbsp;when&nbsp;recording&nbsp;position&nbsp;information.&nbsp;The&nbsp;type&nbsp;of&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="5720767">//&nbsp;for&nbsp;the&nbsp;src&nbsp;parameter&nbsp;must&nbsp;be&nbsp;string,&nbsp;[]byte,&nbsp;or&nbsp;io.Reader.</span><br>
<span class="lineno"></span><span class="comment" id="5720830">//&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="5720897">//</span><br>
<span class="lineno"></span><span class="comment" id="5720900">//&nbsp;The&nbsp;mode&nbsp;parameter&nbsp;controls&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;text&nbsp;parsed&nbsp;and&nbsp;other</span><br>
<span class="lineno">75</span><span class="comment" id="5720974">//&nbsp;optional&nbsp;parser&nbsp;functionality.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5721048">//&nbsp;file&nbsp;set&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="5721066">//</span><br>
<span class="lineno"></span><span class="comment" id="5721069">//&nbsp;If&nbsp;the&nbsp;source&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;the&nbsp;returned&nbsp;AST&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5721142">//&nbsp;indicates&nbsp;the&nbsp;specific&nbsp;failure.&nbsp;If&nbsp;the&nbsp;source&nbsp;was&nbsp;read&nbsp;but&nbsp;syntax</span><br>
<span class="lineno">80</span><span class="comment" id="5721211">//&nbsp;errors&nbsp;were&nbsp;found,&nbsp;the&nbsp;result&nbsp;is&nbsp;a&nbsp;partial&nbsp;AST&nbsp;(with&nbsp;ast.Bad*&nbsp;nodes</span><br>
<span class="lineno"></span><span class="comment" id="5721282">//&nbsp;representing&nbsp;the&nbsp;fragments&nbsp;of&nbsp;erroneous&nbsp;source&nbsp;code).&nbsp;Multiple&nbsp;errors</span><br>
<span class="lineno"></span><span class="comment" id="5721355">//&nbsp;are&nbsp;returned&nbsp;via&nbsp;a&nbsp;scanner.ErrorList&nbsp;which&nbsp;is&nbsp;sorted&nbsp;by&nbsp;file&nbsp;position.</span><br>
<span class="lineno"></span><span class="comment" id="5721429">//</span><br>
<span class="lineno"></span><span class="keyword" id="5721432">func</span>&nbsp;<span class="ident" id="5721437">ParseFile</span><span class="op" id="5721446">(</span><span class="ident" id="5721447">fset</span>&nbsp;<span class="op" id="5721452">*</span><span class="ident" id="5721453">token</span><span class="op" id="5721458">.</span><span class="ident" id="5721459">FileSet</span><span class="op" id="5721466">,</span>&nbsp;<span class="ident" id="5721468">filename</span>&nbsp;<span class="builtintype" id="5721477">string</span><span class="op" id="5721483">,</span>&nbsp;<span class="ident" id="5721485">src</span>&nbsp;<span class="keyword" id="5721489">interface</span><span class="op" id="5721498">{</span><span class="op" id="5721499">}</span><span class="op" id="5721500">,</span>&nbsp;<span class="ident" id="5721502">mode</span>&nbsp;<span class="ident" id="5721507">Mode</span><span class="op" id="5721511">)</span>&nbsp;<span class="op" id="5721513">(</span><span class="ident" id="5721514">f</span>&nbsp;<span class="op" id="5721516">*</span><span class="ident" id="5721517">ast</span><span class="op" id="5721520">.</span><span class="ident" id="5721521">File</span><span class="op" id="5721525">,</span>&nbsp;<span class="ident" id="5721527">err</span>&nbsp;<span class="builtintype" id="5721531">error</span><span class="op" id="5721536">)</span>&nbsp;<span class="op" id="5721538">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5721541">//&nbsp;get&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721556">text</span><span class="op" id="5721560">,</span>&nbsp;<span class="ident" id="5721562">err</span>&nbsp;<span class="op" id="5721566">:=</span>&nbsp;<span class="ident" id="5721569">readSource</span><span class="op" id="5721579">(</span><span class="ident" id="5721580">filename</span><span class="op" id="5721588">,</span>&nbsp;<span class="ident" id="5721590">src</span><span class="op" id="5721593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721596">if</span>&nbsp;<span class="ident" id="5721599">err</span>&nbsp;<span class="op" id="5721603">!=</span>&nbsp;<span class="ident" id="5721606">nil</span>&nbsp;<span class="op" id="5721610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721614">return</span>&nbsp;<span class="ident" id="5721621">nil</span><span class="op" id="5721624">,</span>&nbsp;<span class="ident" id="5721626">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721631">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721635">var</span>&nbsp;<span class="ident" id="5721639">p</span>&nbsp;<span class="ident" id="5721641">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721649">defer</span>&nbsp;<span class="keyword" id="5721655">func</span><span class="op" id="5721659">(</span><span class="op" id="5721660">)</span>&nbsp;<span class="op" id="5721662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721666">if</span>&nbsp;<span class="ident" id="5721669">e</span>&nbsp;<span class="op" id="5721671">:=</span>&nbsp;<span class="builtinfunc" id="5721674">recover</span><span class="op" id="5721681">(</span><span class="op" id="5721682">)</span><span class="op" id="5721683">;</span>&nbsp;<span class="ident" id="5721685">e</span>&nbsp;<span class="op" id="5721687">!=</span>&nbsp;<span class="ident" id="5721690">nil</span>&nbsp;<span class="op" id="5721694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721699">_</span>&nbsp;<span class="op" id="5721701">=</span>&nbsp;<span class="ident" id="5721703">e</span><span class="op" id="5721704">.</span><span class="op" id="5721705">(</span><span class="ident" id="5721706">bailout</span><span class="op" id="5721713">)</span>&nbsp;<span class="comment" id="5721715">//&nbsp;re-panics&nbsp;if&nbsp;it&#39;s&nbsp;not&nbsp;a&nbsp;bailout</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5721757">//&nbsp;set&nbsp;result&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5721780">if</span>&nbsp;<span class="ident" id="5721783">f</span>&nbsp;<span class="op" id="5721785">==</span>&nbsp;<span class="ident" id="5721788">nil</span>&nbsp;<span class="op" id="5721792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5721797">//&nbsp;source&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;Go&nbsp;source&nbsp;file&nbsp;-&nbsp;satisfy</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5721850">//&nbsp;ParseFile&nbsp;API&nbsp;and&nbsp;return&nbsp;a&nbsp;valid&nbsp;(but)&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5721901">//&nbsp;*ast.File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721917">f</span>&nbsp;<span class="op" id="5721919">=</span>&nbsp;<span class="op" id="5721921">&amp;</span><span class="ident" id="5721922">ast</span><span class="op" id="5721925">.</span><span class="ident" id="5721926">File</span><span class="op" id="5721930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721936">Name</span><span class="op" id="5721940">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5721943">new</span><span class="op" id="5721946">(</span><span class="ident" id="5721947">ast</span><span class="op" id="5721950">.</span><span class="ident" id="5721951">Ident</span><span class="op" id="5721956">)</span><span class="op" id="5721957">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5721963">Scope</span><span class="op" id="5721968">:</span>&nbsp;<span class="ident" id="5721970">ast</span><span class="op" id="5721973">.</span><span class="ident" id="5721974">NewScope</span><span class="op" id="5721982">(</span><span class="ident" id="5721983">nil</span><span class="op" id="5721986">)</span><span class="op" id="5721987">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5721996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722001">p</span><span class="op" id="5722002">.</span><span class="ident" id="5722003">errors</span><span class="op" id="5722009">.</span><span class="ident" id="5722010">Sort</span><span class="op" id="5722014">(</span><span class="op" id="5722015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722019">err</span>&nbsp;<span class="op" id="5722023">=</span>&nbsp;<span class="ident" id="5722025">p</span><span class="op" id="5722026">.</span><span class="ident" id="5722027">errors</span><span class="op" id="5722033">.</span><span class="ident" id="5722034">Err</span><span class="op" id="5722037">(</span><span class="op" id="5722038">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5722041">}</span><span class="op" id="5722042">(</span><span class="op" id="5722043">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5722047">//&nbsp;parse&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722064">p</span><span class="op" id="5722065">.</span><span class="ident" id="5722066">init</span><span class="op" id="5722070">(</span><span class="ident" id="5722071">fset</span><span class="op" id="5722075">,</span>&nbsp;<span class="ident" id="5722077">filename</span><span class="op" id="5722085">,</span>&nbsp;<span class="ident" id="5722087">text</span><span class="op" id="5722091">,</span>&nbsp;<span class="ident" id="5722093">mode</span><span class="op" id="5722097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722100">f</span>&nbsp;<span class="op" id="5722102">=</span>&nbsp;<span class="ident" id="5722104">p</span><span class="op" id="5722105">.</span><span class="ident" id="5722106">parseFile</span><span class="op" id="5722115">(</span><span class="op" id="5722116">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722120">return</span><br>
<span class="lineno"></span><span class="op" id="5722127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5722130">//&nbsp;ParseDir&nbsp;calls&nbsp;ParseFile&nbsp;for&nbsp;all&nbsp;files&nbsp;with&nbsp;names&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;&nbsp;in&nbsp;the</span><br>
<span class="lineno">120</span><span class="comment" id="5722206">//&nbsp;directory&nbsp;specified&nbsp;by&nbsp;path&nbsp;and&nbsp;returns&nbsp;a&nbsp;map&nbsp;of&nbsp;package&nbsp;name&nbsp;-&gt;&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="5722282">//&nbsp;AST&nbsp;with&nbsp;all&nbsp;the&nbsp;packages&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="5722318">//</span><br>
<span class="lineno"></span><span class="comment" id="5722321">//&nbsp;If&nbsp;filter&nbsp;!=&nbsp;nil,&nbsp;only&nbsp;the&nbsp;files&nbsp;with&nbsp;os.FileInfo&nbsp;entries&nbsp;passing&nbsp;through</span><br>
<span class="lineno"></span><span class="comment" id="5722398">//&nbsp;the&nbsp;filter&nbsp;(and&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;)&nbsp;are&nbsp;considered.&nbsp;The&nbsp;mode&nbsp;bits&nbsp;are&nbsp;passed</span><br>
<span class="lineno">125</span><span class="comment" id="5722475">//&nbsp;to&nbsp;ParseFile&nbsp;unchanged.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="5722544">//</span><br>
<span class="lineno"></span><span class="comment" id="5722547">//&nbsp;If&nbsp;the&nbsp;directory&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;a&nbsp;nil&nbsp;map&nbsp;and&nbsp;the&nbsp;respective&nbsp;error&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5722624">//&nbsp;returned.&nbsp;If&nbsp;a&nbsp;parse&nbsp;error&nbsp;occurred,&nbsp;a&nbsp;non-nil&nbsp;but&nbsp;incomplete&nbsp;map&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5722701">//&nbsp;first&nbsp;error&nbsp;encountered&nbsp;are&nbsp;returned.</span><br>
<span class="lineno">130</span><span class="comment" id="5722742">//</span><br>
<span class="lineno"></span><span class="keyword" id="5722745">func</span>&nbsp;<span class="ident" id="5722750">ParseDir</span><span class="op" id="5722758">(</span><span class="ident" id="5722759">fset</span>&nbsp;<span class="op" id="5722764">*</span><span class="ident" id="5722765">token</span><span class="op" id="5722770">.</span><span class="ident" id="5722771">FileSet</span><span class="op" id="5722778">,</span>&nbsp;<span class="ident" id="5722780">path</span>&nbsp;<span class="builtintype" id="5722785">string</span><span class="op" id="5722791">,</span>&nbsp;<span class="ident" id="5722793">filter</span>&nbsp;<span class="keyword" id="5722800">func</span><span class="op" id="5722804">(</span><span class="ident" id="5722805">os</span><span class="op" id="5722807">.</span><span class="ident" id="5722808">FileInfo</span><span class="op" id="5722816">)</span>&nbsp;<span class="builtintype" id="5722818">bool</span><span class="op" id="5722822">,</span>&nbsp;<span class="ident" id="5722824">mode</span>&nbsp;<span class="ident" id="5722829">Mode</span><span class="op" id="5722833">)</span>&nbsp;<span class="op" id="5722835">(</span><span class="ident" id="5722836">pkgs</span>&nbsp;<span class="keyword" id="5722841">map</span><span class="op" id="5722844">[</span><span class="builtintype" id="5722845">string</span><span class="op" id="5722851">]</span><span class="op" id="5722852">*</span><span class="ident" id="5722853">ast</span><span class="op" id="5722856">.</span><span class="ident" id="5722857">Package</span><span class="op" id="5722864">,</span>&nbsp;<span class="ident" id="5722866">first</span>&nbsp;<span class="builtintype" id="5722872">error</span><span class="op" id="5722877">)</span>&nbsp;<span class="op" id="5722879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722882">fd</span><span class="op" id="5722884">,</span>&nbsp;<span class="ident" id="5722886">err</span>&nbsp;<span class="op" id="5722890">:=</span>&nbsp;<span class="ident" id="5722893">os</span><span class="op" id="5722895">.</span><span class="ident" id="5722896">Open</span><span class="op" id="5722900">(</span><span class="ident" id="5722901">path</span><span class="op" id="5722905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722908">if</span>&nbsp;<span class="ident" id="5722911">err</span>&nbsp;<span class="op" id="5722915">!=</span>&nbsp;<span class="ident" id="5722918">nil</span>&nbsp;<span class="op" id="5722922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722926">return</span>&nbsp;<span class="ident" id="5722933">nil</span><span class="op" id="5722936">,</span>&nbsp;<span class="ident" id="5722938">err</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5722943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722946">defer</span>&nbsp;<span class="ident" id="5722952">fd</span><span class="op" id="5722954">.</span><span class="ident" id="5722955">Close</span><span class="op" id="5722960">(</span><span class="op" id="5722961">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5722965">list</span><span class="op" id="5722969">,</span>&nbsp;<span class="ident" id="5722971">err</span>&nbsp;<span class="op" id="5722975">:=</span>&nbsp;<span class="ident" id="5722978">fd</span><span class="op" id="5722980">.</span><span class="ident" id="5722981">Readdir</span><span class="op" id="5722988">(</span><span class="op" id="5722989">-</span><span class="num" id="5722990">1</span><span class="op" id="5722991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5722994">if</span>&nbsp;<span class="ident" id="5722997">err</span>&nbsp;<span class="op" id="5723001">!=</span>&nbsp;<span class="ident" id="5723004">nil</span>&nbsp;<span class="op" id="5723008">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723012">return</span>&nbsp;<span class="ident" id="5723019">nil</span><span class="op" id="5723022">,</span>&nbsp;<span class="ident" id="5723024">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723033">pkgs</span>&nbsp;<span class="op" id="5723038">=</span>&nbsp;<span class="builtinfunc" id="5723040">make</span><span class="op" id="5723044">(</span><span class="keyword" id="5723045">map</span><span class="op" id="5723048">[</span><span class="builtintype" id="5723049">string</span><span class="op" id="5723055">]</span><span class="op" id="5723056">*</span><span class="ident" id="5723057">ast</span><span class="op" id="5723060">.</span><span class="ident" id="5723061">Package</span><span class="op" id="5723068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723071">for</span>&nbsp;<span class="ident" id="5723075">_</span><span class="op" id="5723076">,</span>&nbsp;<span class="ident" id="5723078">d</span>&nbsp;<span class="op" id="5723080">:=</span>&nbsp;<span class="keyword" id="5723083">range</span>&nbsp;<span class="ident" id="5723089">list</span>&nbsp;<span class="op" id="5723094">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723098">if</span>&nbsp;<span class="ident" id="5723101">strings</span><span class="op" id="5723108">.</span><span class="ident" id="5723109">HasSuffix</span><span class="op" id="5723118">(</span><span class="ident" id="5723119">d</span><span class="op" id="5723120">.</span><span class="ident" id="5723121">Name</span><span class="op" id="5723125">(</span><span class="op" id="5723126">)</span><span class="op" id="5723127">,</span>&nbsp;<span class="string" id="5723129">&#34;.go&#34;</span><span class="op" id="5723134">)</span>&nbsp;<span class="op" id="5723136">&amp;&amp;</span>&nbsp;<span class="op" id="5723139">(</span><span class="ident" id="5723140">filter</span>&nbsp;<span class="op" id="5723147">==</span>&nbsp;<span class="ident" id="5723150">nil</span>&nbsp;<span class="op" id="5723154">||</span>&nbsp;<span class="ident" id="5723157">filter</span><span class="op" id="5723163">(</span><span class="ident" id="5723164">d</span><span class="op" id="5723165">)</span><span class="op" id="5723166">)</span>&nbsp;<span class="op" id="5723168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723173">filename</span>&nbsp;<span class="op" id="5723182">:=</span>&nbsp;<span class="ident" id="5723185">filepath</span><span class="op" id="5723193">.</span><span class="ident" id="5723194">Join</span><span class="op" id="5723198">(</span><span class="ident" id="5723199">path</span><span class="op" id="5723203">,</span>&nbsp;<span class="ident" id="5723205">d</span><span class="op" id="5723206">.</span><span class="ident" id="5723207">Name</span><span class="op" id="5723211">(</span><span class="op" id="5723212">)</span><span class="op" id="5723213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723218">if</span>&nbsp;<span class="ident" id="5723221">src</span><span class="op" id="5723224">,</span>&nbsp;<span class="ident" id="5723226">err</span>&nbsp;<span class="op" id="5723230">:=</span>&nbsp;<span class="ident" id="5723233">ParseFile</span><span class="op" id="5723242">(</span><span class="ident" id="5723243">fset</span><span class="op" id="5723247">,</span>&nbsp;<span class="ident" id="5723249">filename</span><span class="op" id="5723257">,</span>&nbsp;<span class="ident" id="5723259">nil</span><span class="op" id="5723262">,</span>&nbsp;<span class="ident" id="5723264">mode</span><span class="op" id="5723268">)</span><span class="op" id="5723269">;</span>&nbsp;<span class="ident" id="5723271">err</span>&nbsp;<span class="op" id="5723275">==</span>&nbsp;<span class="ident" id="5723278">nil</span>&nbsp;<span class="op" id="5723282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723288">name</span>&nbsp;<span class="op" id="5723293">:=</span>&nbsp;<span class="ident" id="5723296">src</span><span class="op" id="5723299">.</span><span class="ident" id="5723300">Name</span><span class="op" id="5723304">.</span><span class="ident" id="5723305">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723314">pkg</span><span class="op" id="5723317">,</span>&nbsp;<span class="ident" id="5723319">found</span>&nbsp;<span class="op" id="5723325">:=</span>&nbsp;<span class="ident" id="5723328">pkgs</span><span class="op" id="5723332">[</span><span class="ident" id="5723333">name</span><span class="op" id="5723337">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723343">if</span>&nbsp;<span class="op" id="5723346">!</span><span class="ident" id="5723347">found</span>&nbsp;<span class="op" id="5723353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723360">pkg</span>&nbsp;<span class="op" id="5723364">=</span>&nbsp;<span class="op" id="5723366">&amp;</span><span class="ident" id="5723367">ast</span><span class="op" id="5723370">.</span><span class="ident" id="5723371">Package</span><span class="op" id="5723378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723386">Name</span><span class="op" id="5723390">:</span>&nbsp;&nbsp;<span class="ident" id="5723393">name</span><span class="op" id="5723397">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723405">Files</span><span class="op" id="5723410">:</span>&nbsp;<span class="builtinfunc" id="5723412">make</span><span class="op" id="5723416">(</span><span class="keyword" id="5723417">map</span><span class="op" id="5723420">[</span><span class="builtintype" id="5723421">string</span><span class="op" id="5723427">]</span><span class="op" id="5723428">*</span><span class="ident" id="5723429">ast</span><span class="op" id="5723432">.</span><span class="ident" id="5723433">File</span><span class="op" id="5723437">)</span><span class="op" id="5723438">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723445">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723452">pkgs</span><span class="op" id="5723456">[</span><span class="ident" id="5723457">name</span><span class="op" id="5723461">]</span>&nbsp;<span class="op" id="5723463">=</span>&nbsp;<span class="ident" id="5723465">pkg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723479">pkg</span><span class="op" id="5723482">.</span><span class="ident" id="5723483">Files</span><span class="op" id="5723488">[</span><span class="ident" id="5723489">filename</span><span class="op" id="5723497">]</span>&nbsp;<span class="op" id="5723499">=</span>&nbsp;<span class="ident" id="5723501">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723508">}</span>&nbsp;<span class="keyword" id="5723510">else</span>&nbsp;<span class="keyword" id="5723515">if</span>&nbsp;<span class="ident" id="5723518">first</span>&nbsp;<span class="op" id="5723524">==</span>&nbsp;<span class="ident" id="5723527">nil</span>&nbsp;<span class="op" id="5723531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723537">first</span>&nbsp;<span class="op" id="5723543">=</span>&nbsp;<span class="ident" id="5723545">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5723559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723563">return</span><br>
<span class="lineno">165</span><span class="op" id="5723570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5723573">//&nbsp;ParseExpr&nbsp;is&nbsp;a&nbsp;convenience&nbsp;function&nbsp;for&nbsp;obtaining&nbsp;the&nbsp;AST&nbsp;of&nbsp;an&nbsp;expression&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="5723654">//&nbsp;The&nbsp;position&nbsp;information&nbsp;recorded&nbsp;in&nbsp;the&nbsp;AST&nbsp;is&nbsp;undefined.&nbsp;The&nbsp;filename&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="5723734">//&nbsp;in&nbsp;error&nbsp;messages&nbsp;is&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno">170</span><span class="comment" id="5723776">//</span><br>
<span class="lineno"></span><span class="keyword" id="5723779">func</span>&nbsp;<span class="ident" id="5723784">ParseExpr</span><span class="op" id="5723793">(</span><span class="ident" id="5723794">x</span>&nbsp;<span class="builtintype" id="5723796">string</span><span class="op" id="5723802">)</span>&nbsp;<span class="op" id="5723804">(</span><span class="ident" id="5723805">ast</span><span class="op" id="5723808">.</span><span class="ident" id="5723809">Expr</span><span class="op" id="5723813">,</span>&nbsp;<span class="builtintype" id="5723815">error</span><span class="op" id="5723820">)</span>&nbsp;<span class="op" id="5723822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5723825">var</span>&nbsp;<span class="ident" id="5723829">p</span>&nbsp;<span class="ident" id="5723831">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5723839">p</span><span class="op" id="5723840">.</span><span class="ident" id="5723841">init</span><span class="op" id="5723845">(</span><span class="ident" id="5723846">token</span><span class="op" id="5723851">.</span><span class="ident" id="5723852">NewFileSet</span><span class="op" id="5723862">(</span><span class="op" id="5723863">)</span><span class="op" id="5723864">,</span>&nbsp;<span class="string" id="5723866">&#34;&#34;</span><span class="op" id="5723868">,</span>&nbsp;<span class="op" id="5723870">[</span><span class="op" id="5723871">]</span><span class="builtintype" id="5723872">byte</span><span class="op" id="5723876">(</span><span class="ident" id="5723877">x</span><span class="op" id="5723878">)</span><span class="op" id="5723879">,</span>&nbsp;<span class="num" id="5723881">0</span><span class="op" id="5723882">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5723886">//&nbsp;Set&nbsp;up&nbsp;pkg-level&nbsp;scopes&nbsp;to&nbsp;avoid&nbsp;nil-pointer&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5723943">//&nbsp;This&nbsp;is&nbsp;not&nbsp;needed&nbsp;for&nbsp;a&nbsp;correct&nbsp;expression&nbsp;x&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724000">//&nbsp;parser&nbsp;will&nbsp;be&nbsp;ok&nbsp;with&nbsp;a&nbsp;nil&nbsp;topScope,&nbsp;but&nbsp;be&nbsp;cautious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724059">//&nbsp;in&nbsp;case&nbsp;of&nbsp;an&nbsp;erroneous&nbsp;x.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724090">p</span><span class="op" id="5724091">.</span><span class="ident" id="5724092">openScope</span><span class="op" id="5724101">(</span><span class="op" id="5724102">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724105">p</span><span class="op" id="5724106">.</span><span class="ident" id="5724107">pkgScope</span>&nbsp;<span class="op" id="5724116">=</span>&nbsp;<span class="ident" id="5724118">p</span><span class="op" id="5724119">.</span><span class="ident" id="5724120">topScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724130">e</span>&nbsp;<span class="op" id="5724132">:=</span>&nbsp;<span class="ident" id="5724135">p</span><span class="op" id="5724136">.</span><span class="ident" id="5724137">parseRhsOrType</span><span class="op" id="5724151">(</span><span class="op" id="5724152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724155">p</span><span class="op" id="5724156">.</span><span class="ident" id="5724157">closeScope</span><span class="op" id="5724167">(</span><span class="op" id="5724168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724171">assert</span><span class="op" id="5724177">(</span><span class="ident" id="5724178">p</span><span class="op" id="5724179">.</span><span class="ident" id="5724180">topScope</span>&nbsp;<span class="op" id="5724189">==</span>&nbsp;<span class="ident" id="5724192">nil</span><span class="op" id="5724195">,</span>&nbsp;<span class="string" id="5724197">&#34;unbalanced&nbsp;scopes&#34;</span><span class="op" id="5724216">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724220">//&nbsp;If&nbsp;a&nbsp;semicolon&nbsp;was&nbsp;inserted,&nbsp;consume&nbsp;it;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5724265">//&nbsp;report&nbsp;an&nbsp;error&nbsp;if&nbsp;there&#39;s&nbsp;more&nbsp;tokens.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724309">if</span>&nbsp;<span class="ident" id="5724312">p</span><span class="op" id="5724313">.</span><span class="ident" id="5724314">tok</span>&nbsp;<span class="op" id="5724318">==</span>&nbsp;<span class="ident" id="5724321">token</span><span class="op" id="5724326">.</span><span class="ident" id="5724327">SEMICOLON</span>&nbsp;<span class="op" id="5724337">&amp;&amp;</span>&nbsp;<span class="ident" id="5724340">p</span><span class="op" id="5724341">.</span><span class="ident" id="5724342">lit</span>&nbsp;<span class="op" id="5724346">==</span>&nbsp;<span class="string" id="5724349">&#34;\n&#34;</span>&nbsp;<span class="op" id="5724354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724358">p</span><span class="op" id="5724359">.</span><span class="ident" id="5724360">next</span><span class="op" id="5724364">(</span><span class="op" id="5724365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5724368">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724371">p</span><span class="op" id="5724372">.</span><span class="ident" id="5724373">expect</span><span class="op" id="5724379">(</span><span class="ident" id="5724380">token</span><span class="op" id="5724385">.</span><span class="ident" id="5724386">EOF</span><span class="op" id="5724389">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724393">if</span>&nbsp;<span class="ident" id="5724396">p</span><span class="op" id="5724397">.</span><span class="ident" id="5724398">errors</span><span class="op" id="5724404">.</span><span class="ident" id="5724405">Len</span><span class="op" id="5724408">(</span><span class="op" id="5724409">)</span>&nbsp;<span class="op" id="5724411">&gt;</span>&nbsp;<span class="num" id="5724413">0</span>&nbsp;<span class="op" id="5724415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5724419">p</span><span class="op" id="5724420">.</span><span class="ident" id="5724421">errors</span><span class="op" id="5724427">.</span><span class="ident" id="5724428">Sort</span><span class="op" id="5724432">(</span><span class="op" id="5724433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724437">return</span>&nbsp;<span class="ident" id="5724444">nil</span><span class="op" id="5724447">,</span>&nbsp;<span class="ident" id="5724449">p</span><span class="op" id="5724450">.</span><span class="ident" id="5724451">errors</span><span class="op" id="5724457">.</span><span class="ident" id="5724458">Err</span><span class="op" id="5724461">(</span><span class="op" id="5724462">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5724465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5724469">return</span>&nbsp;<span class="ident" id="5724476">e</span><span class="op" id="5724477">,</span>&nbsp;<span class="ident" id="5724479">nil</span><br>
<span class="lineno"></span><span class="op" id="5724483">}</span>
</div>
</body>
</html>
