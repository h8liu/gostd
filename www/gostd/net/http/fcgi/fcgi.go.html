<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html" class="current">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6117783">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6117838">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6117892">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6117943">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="6117992">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="6118043">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="6118120">package</span>&nbsp;<span class="ident" id="6118128">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6118134">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6118213">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6118227">import</span>&nbsp;<span class="op" id="6118234">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6118237">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6118246">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6118255">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6118274">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6118284">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6118290">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6118297">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6118300">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6118343">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="6118398">type</span>&nbsp;<span class="ident" id="6118403">recType</span>&nbsp;<span class="builtintype" id="6118411">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6118418">const</span>&nbsp;<span class="op" id="6118424">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118427">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118447">recType</span>&nbsp;<span class="op" id="6118455">=</span>&nbsp;<span class="num" id="6118457">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118460">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118480">recType</span>&nbsp;<span class="op" id="6118488">=</span>&nbsp;<span class="num" id="6118490">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118493">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118513">recType</span>&nbsp;<span class="op" id="6118521">=</span>&nbsp;<span class="num" id="6118523">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118526">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118546">recType</span>&nbsp;<span class="op" id="6118554">=</span>&nbsp;<span class="num" id="6118556">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118559">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118579">recType</span>&nbsp;<span class="op" id="6118587">=</span>&nbsp;<span class="num" id="6118589">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118592">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118612">recType</span>&nbsp;<span class="op" id="6118620">=</span>&nbsp;<span class="num" id="6118622">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118625">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118645">recType</span>&nbsp;<span class="op" id="6118653">=</span>&nbsp;<span class="num" id="6118655">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118658">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118678">recType</span>&nbsp;<span class="op" id="6118686">=</span>&nbsp;<span class="num" id="6118688">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118691">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118711">recType</span>&nbsp;<span class="op" id="6118719">=</span>&nbsp;<span class="num" id="6118721">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118724">typeGetValuesResult</span>&nbsp;<span class="ident" id="6118744">recType</span>&nbsp;<span class="op" id="6118752">=</span>&nbsp;<span class="num" id="6118754">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118758">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118778">recType</span>&nbsp;<span class="op" id="6118786">=</span>&nbsp;<span class="num" id="6118788">11</span><br>
<span class="lineno"></span><span class="op" id="6118791">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="6118794">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="6118869">const</span>&nbsp;<span class="ident" id="6118875">flagKeepConn</span>&nbsp;<span class="op" id="6118888">=</span>&nbsp;<span class="num" id="6118890">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6118893">const</span>&nbsp;<span class="op" id="6118899">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118902">maxWrite</span>&nbsp;<span class="op" id="6118911">=</span>&nbsp;<span class="num" id="6118913">65535</span>&nbsp;<span class="comment" id="6118919">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118943">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6118952">=</span>&nbsp;<span class="num" id="6118954">255</span><br>
<span class="lineno"></span><span class="op" id="6118958">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6118961">const</span>&nbsp;<span class="op" id="6118967">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118970">roleResponder</span>&nbsp;<span class="op" id="6118984">=</span>&nbsp;<span class="ident" id="6118986">iota</span>&nbsp;<span class="op" id="6118991">+</span>&nbsp;<span class="num" id="6118993">1</span>&nbsp;<span class="comment" id="6118995">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119032">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119048">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="6119059">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6119062">const</span>&nbsp;<span class="op" id="6119068">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119071">statusRequestComplete</span>&nbsp;<span class="op" id="6119093">=</span>&nbsp;<span class="ident" id="6119095">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119101">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119122">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119140">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="6119158">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6119161">const</span>&nbsp;<span class="ident" id="6119167">headerLen</span>&nbsp;<span class="op" id="6119177">=</span>&nbsp;<span class="num" id="6119179">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6119182">type</span>&nbsp;<span class="ident" id="6119187">header</span>&nbsp;<span class="keyword" id="6119194">struct</span>&nbsp;<span class="op" id="6119201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119204">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6119218">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119225">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119239">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119248">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6119262">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119270">ContentLength</span>&nbsp;<span class="builtintype" id="6119284">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119292">PaddingLength</span>&nbsp;<span class="builtintype" id="6119306">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119313">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6119327">uint8</span><br>
<span class="lineno">70</span><span class="op" id="6119333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6119336">type</span>&nbsp;<span class="ident" id="6119341">beginRequest</span>&nbsp;<span class="keyword" id="6119354">struct</span>&nbsp;<span class="op" id="6119361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119364">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6119373">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119381">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6119390">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119397">reserved</span>&nbsp;<span class="op" id="6119406">[</span><span class="num" id="6119407">5</span><span class="op" id="6119408">]</span><span class="builtintype" id="6119409">uint8</span><br>
<span class="lineno"></span><span class="op" id="6119415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6119418">func</span>&nbsp;<span class="op" id="6119423">(</span><span class="ident" id="6119424">br</span>&nbsp;<span class="op" id="6119427">*</span><span class="ident" id="6119428">beginRequest</span><span class="op" id="6119440">)</span>&nbsp;<span class="ident" id="6119442">read</span><span class="op" id="6119446">(</span><span class="ident" id="6119447">content</span>&nbsp;<span class="op" id="6119455">[</span><span class="op" id="6119456">]</span><span class="builtintype" id="6119457">byte</span><span class="op" id="6119461">)</span>&nbsp;<span class="builtintype" id="6119463">error</span>&nbsp;<span class="op" id="6119469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6119472">if</span>&nbsp;<span class="builtinfunc" id="6119475">len</span><span class="op" id="6119478">(</span><span class="ident" id="6119479">content</span><span class="op" id="6119486">)</span>&nbsp;<span class="op" id="6119488">!=</span>&nbsp;<span class="num" id="6119491">8</span>&nbsp;<span class="op" id="6119493">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6119497">return</span>&nbsp;<span class="ident" id="6119504">errors</span><span class="op" id="6119510">.</span><span class="ident" id="6119511">New</span><span class="op" id="6119514">(</span><span class="string" id="6119515">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="6119551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6119554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119557">br</span><span class="op" id="6119559">.</span><span class="ident" id="6119560">role</span>&nbsp;<span class="op" id="6119565">=</span>&nbsp;<span class="ident" id="6119567">binary</span><span class="op" id="6119573">.</span><span class="ident" id="6119574">BigEndian</span><span class="op" id="6119583">.</span><span class="ident" id="6119584">Uint16</span><span class="op" id="6119590">(</span><span class="ident" id="6119591">content</span><span class="op" id="6119598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119601">br</span><span class="op" id="6119603">.</span><span class="ident" id="6119604">flags</span>&nbsp;<span class="op" id="6119610">=</span>&nbsp;<span class="ident" id="6119612">content</span><span class="op" id="6119619">[</span><span class="num" id="6119620">2</span><span class="op" id="6119621">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6119624">return</span>&nbsp;<span class="builtintype" id="6119631">nil</span><br>
<span class="lineno">85</span><span class="op" id="6119635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6119638">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="6119695">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="6119759">var</span>&nbsp;<span class="ident" id="6119763">pad</span>&nbsp;<span class="op" id="6119767">[</span><span class="ident" id="6119768">maxPad</span><span class="op" id="6119774">]</span><span class="builtintype" id="6119775">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="6119781">func</span>&nbsp;<span class="op" id="6119786">(</span><span class="ident" id="6119787">h</span>&nbsp;<span class="op" id="6119789">*</span><span class="ident" id="6119790">header</span><span class="op" id="6119796">)</span>&nbsp;<span class="ident" id="6119798">init</span><span class="op" id="6119802">(</span><span class="ident" id="6119803">recType</span>&nbsp;<span class="ident" id="6119811">recType</span><span class="op" id="6119818">,</span>&nbsp;<span class="ident" id="6119820">reqId</span>&nbsp;<span class="builtintype" id="6119826">uint16</span><span class="op" id="6119832">,</span>&nbsp;<span class="ident" id="6119834">contentLength</span>&nbsp;<span class="builtintype" id="6119848">int</span><span class="op" id="6119851">)</span>&nbsp;<span class="op" id="6119853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119856">h</span><span class="op" id="6119857">.</span><span class="ident" id="6119858">Version</span>&nbsp;<span class="op" id="6119866">=</span>&nbsp;<span class="num" id="6119868">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119871">h</span><span class="op" id="6119872">.</span><span class="ident" id="6119873">Type</span>&nbsp;<span class="op" id="6119878">=</span>&nbsp;<span class="ident" id="6119880">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119889">h</span><span class="op" id="6119890">.</span><span class="ident" id="6119891">Id</span>&nbsp;<span class="op" id="6119894">=</span>&nbsp;<span class="ident" id="6119896">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119903">h</span><span class="op" id="6119904">.</span><span class="ident" id="6119905">ContentLength</span>&nbsp;<span class="op" id="6119919">=</span>&nbsp;<span class="builtintype" id="6119921">uint16</span><span class="op" id="6119927">(</span><span class="ident" id="6119928">contentLength</span><span class="op" id="6119941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119944">h</span><span class="op" id="6119945">.</span><span class="ident" id="6119946">PaddingLength</span>&nbsp;<span class="op" id="6119960">=</span>&nbsp;<span class="builtintype" id="6119962">uint8</span><span class="op" id="6119967">(</span><span class="op" id="6119968">-</span><span class="ident" id="6119969">contentLength</span>&nbsp;<span class="op" id="6119983">&amp;</span>&nbsp;<span class="num" id="6119985">7</span><span class="op" id="6119986">)</span><br>
<span class="lineno"></span><span class="op" id="6119988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6119991">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="6120022">type</span>&nbsp;<span class="ident" id="6120027">conn</span>&nbsp;<span class="keyword" id="6120032">struct</span>&nbsp;<span class="op" id="6120039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120042">mutex</span>&nbsp;<span class="ident" id="6120048">sync</span><span class="op" id="6120052">.</span><span class="ident" id="6120053">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120060">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6120066">io</span><span class="op" id="6120068">.</span><span class="ident" id="6120069">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6120087">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120112">buf</span>&nbsp;<span class="ident" id="6120116">bytes</span><span class="op" id="6120121">.</span><span class="ident" id="6120122">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120130">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6120134">header</span><br>
<span class="lineno"></span><span class="op" id="6120141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6120144">func</span>&nbsp;<span class="ident" id="6120149">newConn</span><span class="op" id="6120156">(</span><span class="ident" id="6120157">rwc</span>&nbsp;<span class="ident" id="6120161">io</span><span class="op" id="6120163">.</span><span class="ident" id="6120164">ReadWriteCloser</span><span class="op" id="6120179">)</span>&nbsp;<span class="op" id="6120181">*</span><span class="ident" id="6120182">conn</span>&nbsp;<span class="op" id="6120187">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120190">return</span>&nbsp;<span class="op" id="6120197">&amp;</span><span class="ident" id="6120198">conn</span><span class="op" id="6120202">{</span><span class="ident" id="6120203">rwc</span><span class="op" id="6120206">:</span>&nbsp;<span class="ident" id="6120208">rwc</span><span class="op" id="6120211">}</span><br>
<span class="lineno"></span><span class="op" id="6120213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6120216">func</span>&nbsp;<span class="op" id="6120221">(</span><span class="ident" id="6120222">c</span>&nbsp;<span class="op" id="6120224">*</span><span class="ident" id="6120225">conn</span><span class="op" id="6120229">)</span>&nbsp;<span class="ident" id="6120231">Close</span><span class="op" id="6120236">(</span><span class="op" id="6120237">)</span>&nbsp;<span class="builtintype" id="6120239">error</span>&nbsp;<span class="op" id="6120245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120248">c</span><span class="op" id="6120249">.</span><span class="ident" id="6120250">mutex</span><span class="op" id="6120255">.</span><span class="ident" id="6120256">Lock</span><span class="op" id="6120260">(</span><span class="op" id="6120261">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120264">defer</span>&nbsp;<span class="ident" id="6120270">c</span><span class="op" id="6120271">.</span><span class="ident" id="6120272">mutex</span><span class="op" id="6120277">.</span><span class="ident" id="6120278">Unlock</span><span class="op" id="6120284">(</span><span class="op" id="6120285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120288">return</span>&nbsp;<span class="ident" id="6120295">c</span><span class="op" id="6120296">.</span><span class="ident" id="6120297">rwc</span><span class="op" id="6120300">.</span><span class="ident" id="6120301">Close</span><span class="op" id="6120306">(</span><span class="op" id="6120307">)</span><br>
<span class="lineno"></span><span class="op" id="6120309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6120312">type</span>&nbsp;<span class="ident" id="6120317">record</span>&nbsp;<span class="keyword" id="6120324">struct</span>&nbsp;<span class="op" id="6120331">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120334">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6120338">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120346">buf</span>&nbsp;<span class="op" id="6120350">[</span><span class="ident" id="6120351">maxWrite</span>&nbsp;<span class="op" id="6120360">+</span>&nbsp;<span class="ident" id="6120362">maxPad</span><span class="op" id="6120368">]</span><span class="builtintype" id="6120369">byte</span><br>
<span class="lineno"></span><span class="op" id="6120374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6120377">func</span>&nbsp;<span class="op" id="6120382">(</span><span class="ident" id="6120383">rec</span>&nbsp;<span class="op" id="6120387">*</span><span class="ident" id="6120388">record</span><span class="op" id="6120394">)</span>&nbsp;<span class="ident" id="6120396">read</span><span class="op" id="6120400">(</span><span class="ident" id="6120401">r</span>&nbsp;<span class="ident" id="6120403">io</span><span class="op" id="6120405">.</span><span class="ident" id="6120406">Reader</span><span class="op" id="6120412">)</span>&nbsp;<span class="op" id="6120414">(</span><span class="ident" id="6120415">err</span>&nbsp;<span class="builtintype" id="6120419">error</span><span class="op" id="6120424">)</span>&nbsp;<span class="op" id="6120426">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120429">if</span>&nbsp;<span class="ident" id="6120432">err</span>&nbsp;<span class="op" id="6120436">=</span>&nbsp;<span class="ident" id="6120438">binary</span><span class="op" id="6120444">.</span><span class="ident" id="6120445">Read</span><span class="op" id="6120449">(</span><span class="ident" id="6120450">r</span><span class="op" id="6120451">,</span>&nbsp;<span class="ident" id="6120453">binary</span><span class="op" id="6120459">.</span><span class="ident" id="6120460">BigEndian</span><span class="op" id="6120469">,</span>&nbsp;<span class="op" id="6120471">&amp;</span><span class="ident" id="6120472">rec</span><span class="op" id="6120475">.</span><span class="ident" id="6120476">h</span><span class="op" id="6120477">)</span><span class="op" id="6120478">;</span>&nbsp;<span class="ident" id="6120480">err</span>&nbsp;<span class="op" id="6120484">!=</span>&nbsp;<span class="builtintype" id="6120487">nil</span>&nbsp;<span class="op" id="6120491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120495">return</span>&nbsp;<span class="ident" id="6120502">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6120507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120510">if</span>&nbsp;<span class="ident" id="6120513">rec</span><span class="op" id="6120516">.</span><span class="ident" id="6120517">h</span><span class="op" id="6120518">.</span><span class="ident" id="6120519">Version</span>&nbsp;<span class="op" id="6120527">!=</span>&nbsp;<span class="num" id="6120530">1</span>&nbsp;<span class="op" id="6120532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120536">return</span>&nbsp;<span class="ident" id="6120543">errors</span><span class="op" id="6120549">.</span><span class="ident" id="6120550">New</span><span class="op" id="6120553">(</span><span class="string" id="6120554">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="6120584">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6120587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120590">n</span>&nbsp;<span class="op" id="6120592">:=</span>&nbsp;<span class="builtintype" id="6120595">int</span><span class="op" id="6120598">(</span><span class="ident" id="6120599">rec</span><span class="op" id="6120602">.</span><span class="ident" id="6120603">h</span><span class="op" id="6120604">.</span><span class="ident" id="6120605">ContentLength</span><span class="op" id="6120618">)</span>&nbsp;<span class="op" id="6120620">+</span>&nbsp;<span class="builtintype" id="6120622">int</span><span class="op" id="6120625">(</span><span class="ident" id="6120626">rec</span><span class="op" id="6120629">.</span><span class="ident" id="6120630">h</span><span class="op" id="6120631">.</span><span class="ident" id="6120632">PaddingLength</span><span class="op" id="6120645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120648">if</span>&nbsp;<span class="ident" id="6120651">_</span><span class="op" id="6120652">,</span>&nbsp;<span class="ident" id="6120654">err</span>&nbsp;<span class="op" id="6120658">=</span>&nbsp;<span class="ident" id="6120660">io</span><span class="op" id="6120662">.</span><span class="ident" id="6120663">ReadFull</span><span class="op" id="6120671">(</span><span class="ident" id="6120672">r</span><span class="op" id="6120673">,</span>&nbsp;<span class="ident" id="6120675">rec</span><span class="op" id="6120678">.</span><span class="ident" id="6120679">buf</span><span class="op" id="6120682">[</span><span class="op" id="6120683">:</span><span class="ident" id="6120684">n</span><span class="op" id="6120685">]</span><span class="op" id="6120686">)</span><span class="op" id="6120687">;</span>&nbsp;<span class="ident" id="6120689">err</span>&nbsp;<span class="op" id="6120693">!=</span>&nbsp;<span class="builtintype" id="6120696">nil</span>&nbsp;<span class="op" id="6120700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120704">return</span>&nbsp;<span class="ident" id="6120711">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6120716">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120719">return</span>&nbsp;<span class="builtintype" id="6120726">nil</span><br>
<span class="lineno"></span><span class="op" id="6120730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6120733">func</span>&nbsp;<span class="op" id="6120738">(</span><span class="ident" id="6120739">r</span>&nbsp;<span class="op" id="6120741">*</span><span class="ident" id="6120742">record</span><span class="op" id="6120748">)</span>&nbsp;<span class="ident" id="6120750">content</span><span class="op" id="6120757">(</span><span class="op" id="6120758">)</span>&nbsp;<span class="op" id="6120760">[</span><span class="op" id="6120761">]</span><span class="builtintype" id="6120762">byte</span>&nbsp;<span class="op" id="6120767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120770">return</span>&nbsp;<span class="ident" id="6120777">r</span><span class="op" id="6120778">.</span><span class="ident" id="6120779">buf</span><span class="op" id="6120782">[</span><span class="op" id="6120783">:</span><span class="ident" id="6120784">r</span><span class="op" id="6120785">.</span><span class="ident" id="6120786">h</span><span class="op" id="6120787">.</span><span class="ident" id="6120788">ContentLength</span><span class="op" id="6120801">]</span><br>
<span class="lineno">140</span><span class="op" id="6120803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6120806">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="6120855">func</span>&nbsp;<span class="op" id="6120860">(</span><span class="ident" id="6120861">c</span>&nbsp;<span class="op" id="6120863">*</span><span class="ident" id="6120864">conn</span><span class="op" id="6120868">)</span>&nbsp;<span class="ident" id="6120870">writeRecord</span><span class="op" id="6120881">(</span><span class="ident" id="6120882">recType</span>&nbsp;<span class="ident" id="6120890">recType</span><span class="op" id="6120897">,</span>&nbsp;<span class="ident" id="6120899">reqId</span>&nbsp;<span class="builtintype" id="6120905">uint16</span><span class="op" id="6120911">,</span>&nbsp;<span class="ident" id="6120913">b</span>&nbsp;<span class="op" id="6120915">[</span><span class="op" id="6120916">]</span><span class="builtintype" id="6120917">byte</span><span class="op" id="6120921">)</span>&nbsp;<span class="builtintype" id="6120923">error</span>&nbsp;<span class="op" id="6120929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120932">c</span><span class="op" id="6120933">.</span><span class="ident" id="6120934">mutex</span><span class="op" id="6120939">.</span><span class="ident" id="6120940">Lock</span><span class="op" id="6120944">(</span><span class="op" id="6120945">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120948">defer</span>&nbsp;<span class="ident" id="6120954">c</span><span class="op" id="6120955">.</span><span class="ident" id="6120956">mutex</span><span class="op" id="6120961">.</span><span class="ident" id="6120962">Unlock</span><span class="op" id="6120968">(</span><span class="op" id="6120969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120972">c</span><span class="op" id="6120973">.</span><span class="ident" id="6120974">buf</span><span class="op" id="6120977">.</span><span class="ident" id="6120978">Reset</span><span class="op" id="6120983">(</span><span class="op" id="6120984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120987">c</span><span class="op" id="6120988">.</span><span class="ident" id="6120989">h</span><span class="op" id="6120990">.</span><span class="ident" id="6120991">init</span><span class="op" id="6120995">(</span><span class="ident" id="6120996">recType</span><span class="op" id="6121003">,</span>&nbsp;<span class="ident" id="6121005">reqId</span><span class="op" id="6121010">,</span>&nbsp;<span class="builtinfunc" id="6121012">len</span><span class="op" id="6121015">(</span><span class="ident" id="6121016">b</span><span class="op" id="6121017">)</span><span class="op" id="6121018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121021">if</span>&nbsp;<span class="ident" id="6121024">err</span>&nbsp;<span class="op" id="6121028">:=</span>&nbsp;<span class="ident" id="6121031">binary</span><span class="op" id="6121037">.</span><span class="ident" id="6121038">Write</span><span class="op" id="6121043">(</span><span class="op" id="6121044">&amp;</span><span class="ident" id="6121045">c</span><span class="op" id="6121046">.</span><span class="ident" id="6121047">buf</span><span class="op" id="6121050">,</span>&nbsp;<span class="ident" id="6121052">binary</span><span class="op" id="6121058">.</span><span class="ident" id="6121059">BigEndian</span><span class="op" id="6121068">,</span>&nbsp;<span class="ident" id="6121070">c</span><span class="op" id="6121071">.</span><span class="ident" id="6121072">h</span><span class="op" id="6121073">)</span><span class="op" id="6121074">;</span>&nbsp;<span class="ident" id="6121076">err</span>&nbsp;<span class="op" id="6121080">!=</span>&nbsp;<span class="builtintype" id="6121083">nil</span>&nbsp;<span class="op" id="6121087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121091">return</span>&nbsp;<span class="ident" id="6121098">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6121103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121106">if</span>&nbsp;<span class="ident" id="6121109">_</span><span class="op" id="6121110">,</span>&nbsp;<span class="ident" id="6121112">err</span>&nbsp;<span class="op" id="6121116">:=</span>&nbsp;<span class="ident" id="6121119">c</span><span class="op" id="6121120">.</span><span class="ident" id="6121121">buf</span><span class="op" id="6121124">.</span><span class="ident" id="6121125">Write</span><span class="op" id="6121130">(</span><span class="ident" id="6121131">b</span><span class="op" id="6121132">)</span><span class="op" id="6121133">;</span>&nbsp;<span class="ident" id="6121135">err</span>&nbsp;<span class="op" id="6121139">!=</span>&nbsp;<span class="builtintype" id="6121142">nil</span>&nbsp;<span class="op" id="6121146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121150">return</span>&nbsp;<span class="ident" id="6121157">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6121162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121165">if</span>&nbsp;<span class="ident" id="6121168">_</span><span class="op" id="6121169">,</span>&nbsp;<span class="ident" id="6121171">err</span>&nbsp;<span class="op" id="6121175">:=</span>&nbsp;<span class="ident" id="6121178">c</span><span class="op" id="6121179">.</span><span class="ident" id="6121180">buf</span><span class="op" id="6121183">.</span><span class="ident" id="6121184">Write</span><span class="op" id="6121189">(</span><span class="ident" id="6121190">pad</span><span class="op" id="6121193">[</span><span class="op" id="6121194">:</span><span class="ident" id="6121195">c</span><span class="op" id="6121196">.</span><span class="ident" id="6121197">h</span><span class="op" id="6121198">.</span><span class="ident" id="6121199">PaddingLength</span><span class="op" id="6121212">]</span><span class="op" id="6121213">)</span><span class="op" id="6121214">;</span>&nbsp;<span class="ident" id="6121216">err</span>&nbsp;<span class="op" id="6121220">!=</span>&nbsp;<span class="builtintype" id="6121223">nil</span>&nbsp;<span class="op" id="6121227">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121231">return</span>&nbsp;<span class="ident" id="6121238">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6121243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121246">_</span><span class="op" id="6121247">,</span>&nbsp;<span class="ident" id="6121249">err</span>&nbsp;<span class="op" id="6121253">:=</span>&nbsp;<span class="ident" id="6121256">c</span><span class="op" id="6121257">.</span><span class="ident" id="6121258">rwc</span><span class="op" id="6121261">.</span><span class="ident" id="6121262">Write</span><span class="op" id="6121267">(</span><span class="ident" id="6121268">c</span><span class="op" id="6121269">.</span><span class="ident" id="6121270">buf</span><span class="op" id="6121273">.</span><span class="ident" id="6121274">Bytes</span><span class="op" id="6121279">(</span><span class="op" id="6121280">)</span><span class="op" id="6121281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121284">return</span>&nbsp;<span class="ident" id="6121291">err</span><br>
<span class="lineno"></span><span class="op" id="6121295">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="6121298">func</span>&nbsp;<span class="op" id="6121303">(</span><span class="ident" id="6121304">c</span>&nbsp;<span class="op" id="6121306">*</span><span class="ident" id="6121307">conn</span><span class="op" id="6121311">)</span>&nbsp;<span class="ident" id="6121313">writeBeginRequest</span><span class="op" id="6121330">(</span><span class="ident" id="6121331">reqId</span>&nbsp;<span class="builtintype" id="6121337">uint16</span><span class="op" id="6121343">,</span>&nbsp;<span class="ident" id="6121345">role</span>&nbsp;<span class="builtintype" id="6121350">uint16</span><span class="op" id="6121356">,</span>&nbsp;<span class="ident" id="6121358">flags</span>&nbsp;<span class="builtintype" id="6121364">uint8</span><span class="op" id="6121369">)</span>&nbsp;<span class="builtintype" id="6121371">error</span>&nbsp;<span class="op" id="6121377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121380">b</span>&nbsp;<span class="op" id="6121382">:=</span>&nbsp;<span class="op" id="6121385">[</span><span class="num" id="6121386">8</span><span class="op" id="6121387">]</span><span class="builtintype" id="6121388">byte</span><span class="op" id="6121392">{</span><span class="builtintype" id="6121393">byte</span><span class="op" id="6121397">(</span><span class="ident" id="6121398">role</span>&nbsp;<span class="op" id="6121403">&gt;&gt;</span>&nbsp;<span class="num" id="6121406">8</span><span class="op" id="6121407">)</span><span class="op" id="6121408">,</span>&nbsp;<span class="builtintype" id="6121410">byte</span><span class="op" id="6121414">(</span><span class="ident" id="6121415">role</span><span class="op" id="6121419">)</span><span class="op" id="6121420">,</span>&nbsp;<span class="ident" id="6121422">flags</span><span class="op" id="6121427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121430">return</span>&nbsp;<span class="ident" id="6121437">c</span><span class="op" id="6121438">.</span><span class="ident" id="6121439">writeRecord</span><span class="op" id="6121450">(</span><span class="ident" id="6121451">typeBeginRequest</span><span class="op" id="6121467">,</span>&nbsp;<span class="ident" id="6121469">reqId</span><span class="op" id="6121474">,</span>&nbsp;<span class="ident" id="6121476">b</span><span class="op" id="6121477">[</span><span class="op" id="6121478">:</span><span class="op" id="6121479">]</span><span class="op" id="6121480">)</span><br>
<span class="lineno"></span><span class="op" id="6121482">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="6121485">func</span>&nbsp;<span class="op" id="6121490">(</span><span class="ident" id="6121491">c</span>&nbsp;<span class="op" id="6121493">*</span><span class="ident" id="6121494">conn</span><span class="op" id="6121498">)</span>&nbsp;<span class="ident" id="6121500">writeEndRequest</span><span class="op" id="6121515">(</span><span class="ident" id="6121516">reqId</span>&nbsp;<span class="builtintype" id="6121522">uint16</span><span class="op" id="6121528">,</span>&nbsp;<span class="ident" id="6121530">appStatus</span>&nbsp;<span class="builtintype" id="6121540">int</span><span class="op" id="6121543">,</span>&nbsp;<span class="ident" id="6121545">protocolStatus</span>&nbsp;<span class="builtintype" id="6121560">uint8</span><span class="op" id="6121565">)</span>&nbsp;<span class="builtintype" id="6121567">error</span>&nbsp;<span class="op" id="6121573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121576">b</span>&nbsp;<span class="op" id="6121578">:=</span>&nbsp;<span class="builtinfunc" id="6121581">make</span><span class="op" id="6121585">(</span><span class="op" id="6121586">[</span><span class="op" id="6121587">]</span><span class="builtintype" id="6121588">byte</span><span class="op" id="6121592">,</span>&nbsp;<span class="num" id="6121594">8</span><span class="op" id="6121595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121598">binary</span><span class="op" id="6121604">.</span><span class="ident" id="6121605">BigEndian</span><span class="op" id="6121614">.</span><span class="ident" id="6121615">PutUint32</span><span class="op" id="6121624">(</span><span class="ident" id="6121625">b</span><span class="op" id="6121626">,</span>&nbsp;<span class="builtintype" id="6121628">uint32</span><span class="op" id="6121634">(</span><span class="ident" id="6121635">appStatus</span><span class="op" id="6121644">)</span><span class="op" id="6121645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121648">b</span><span class="op" id="6121649">[</span><span class="num" id="6121650">4</span><span class="op" id="6121651">]</span>&nbsp;<span class="op" id="6121653">=</span>&nbsp;<span class="ident" id="6121655">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121671">return</span>&nbsp;<span class="ident" id="6121678">c</span><span class="op" id="6121679">.</span><span class="ident" id="6121680">writeRecord</span><span class="op" id="6121691">(</span><span class="ident" id="6121692">typeEndRequest</span><span class="op" id="6121706">,</span>&nbsp;<span class="ident" id="6121708">reqId</span><span class="op" id="6121713">,</span>&nbsp;<span class="ident" id="6121715">b</span><span class="op" id="6121716">)</span><br>
<span class="lineno"></span><span class="op" id="6121718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6121721">func</span>&nbsp;<span class="op" id="6121726">(</span><span class="ident" id="6121727">c</span>&nbsp;<span class="op" id="6121729">*</span><span class="ident" id="6121730">conn</span><span class="op" id="6121734">)</span>&nbsp;<span class="ident" id="6121736">writePairs</span><span class="op" id="6121746">(</span><span class="ident" id="6121747">recType</span>&nbsp;<span class="ident" id="6121755">recType</span><span class="op" id="6121762">,</span>&nbsp;<span class="ident" id="6121764">reqId</span>&nbsp;<span class="builtintype" id="6121770">uint16</span><span class="op" id="6121776">,</span>&nbsp;<span class="ident" id="6121778">pairs</span>&nbsp;<span class="keyword" id="6121784">map</span><span class="op" id="6121787">[</span><span class="builtintype" id="6121788">string</span><span class="op" id="6121794">]</span><span class="builtintype" id="6121795">string</span><span class="op" id="6121801">)</span>&nbsp;<span class="builtintype" id="6121803">error</span>&nbsp;<span class="op" id="6121809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121812">w</span>&nbsp;<span class="op" id="6121814">:=</span>&nbsp;<span class="ident" id="6121817">newWriter</span><span class="op" id="6121826">(</span><span class="ident" id="6121827">c</span><span class="op" id="6121828">,</span>&nbsp;<span class="ident" id="6121830">recType</span><span class="op" id="6121837">,</span>&nbsp;<span class="ident" id="6121839">reqId</span><span class="op" id="6121844">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121847">b</span>&nbsp;<span class="op" id="6121849">:=</span>&nbsp;<span class="builtinfunc" id="6121852">make</span><span class="op" id="6121856">(</span><span class="op" id="6121857">[</span><span class="op" id="6121858">]</span><span class="builtintype" id="6121859">byte</span><span class="op" id="6121863">,</span>&nbsp;<span class="num" id="6121865">8</span><span class="op" id="6121866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121869">for</span>&nbsp;<span class="ident" id="6121873">k</span><span class="op" id="6121874">,</span>&nbsp;<span class="ident" id="6121876">v</span>&nbsp;<span class="op" id="6121878">:=</span>&nbsp;<span class="keyword" id="6121881">range</span>&nbsp;<span class="ident" id="6121887">pairs</span>&nbsp;<span class="op" id="6121893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121897">n</span>&nbsp;<span class="op" id="6121899">:=</span>&nbsp;<span class="ident" id="6121902">encodeSize</span><span class="op" id="6121912">(</span><span class="ident" id="6121913">b</span><span class="op" id="6121914">,</span>&nbsp;<span class="builtintype" id="6121916">uint32</span><span class="op" id="6121922">(</span><span class="builtinfunc" id="6121923">len</span><span class="op" id="6121926">(</span><span class="ident" id="6121927">k</span><span class="op" id="6121928">)</span><span class="op" id="6121929">)</span><span class="op" id="6121930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121934">n</span>&nbsp;<span class="op" id="6121936">+=</span>&nbsp;<span class="ident" id="6121939">encodeSize</span><span class="op" id="6121949">(</span><span class="ident" id="6121950">b</span><span class="op" id="6121951">[</span><span class="ident" id="6121952">n</span><span class="op" id="6121953">:</span><span class="op" id="6121954">]</span><span class="op" id="6121955">,</span>&nbsp;<span class="builtintype" id="6121957">uint32</span><span class="op" id="6121963">(</span><span class="builtinfunc" id="6121964">len</span><span class="op" id="6121967">(</span><span class="ident" id="6121968">v</span><span class="op" id="6121969">)</span><span class="op" id="6121970">)</span><span class="op" id="6121971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121975">if</span>&nbsp;<span class="ident" id="6121978">_</span><span class="op" id="6121979">,</span>&nbsp;<span class="ident" id="6121981">err</span>&nbsp;<span class="op" id="6121985">:=</span>&nbsp;<span class="ident" id="6121988">w</span><span class="op" id="6121989">.</span><span class="ident" id="6121990">Write</span><span class="op" id="6121995">(</span><span class="ident" id="6121996">b</span><span class="op" id="6121997">[</span><span class="op" id="6121998">:</span><span class="ident" id="6121999">n</span><span class="op" id="6122000">]</span><span class="op" id="6122001">)</span><span class="op" id="6122002">;</span>&nbsp;<span class="ident" id="6122004">err</span>&nbsp;<span class="op" id="6122008">!=</span>&nbsp;<span class="builtintype" id="6122011">nil</span>&nbsp;<span class="op" id="6122015">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122020">return</span>&nbsp;<span class="ident" id="6122027">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122037">if</span>&nbsp;<span class="ident" id="6122040">_</span><span class="op" id="6122041">,</span>&nbsp;<span class="ident" id="6122043">err</span>&nbsp;<span class="op" id="6122047">:=</span>&nbsp;<span class="ident" id="6122050">w</span><span class="op" id="6122051">.</span><span class="ident" id="6122052">WriteString</span><span class="op" id="6122063">(</span><span class="ident" id="6122064">k</span><span class="op" id="6122065">)</span><span class="op" id="6122066">;</span>&nbsp;<span class="ident" id="6122068">err</span>&nbsp;<span class="op" id="6122072">!=</span>&nbsp;<span class="builtintype" id="6122075">nil</span>&nbsp;<span class="op" id="6122079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122084">return</span>&nbsp;<span class="ident" id="6122091">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122097">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122101">if</span>&nbsp;<span class="ident" id="6122104">_</span><span class="op" id="6122105">,</span>&nbsp;<span class="ident" id="6122107">err</span>&nbsp;<span class="op" id="6122111">:=</span>&nbsp;<span class="ident" id="6122114">w</span><span class="op" id="6122115">.</span><span class="ident" id="6122116">WriteString</span><span class="op" id="6122127">(</span><span class="ident" id="6122128">v</span><span class="op" id="6122129">)</span><span class="op" id="6122130">;</span>&nbsp;<span class="ident" id="6122132">err</span>&nbsp;<span class="op" id="6122136">!=</span>&nbsp;<span class="builtintype" id="6122139">nil</span>&nbsp;<span class="op" id="6122143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122148">return</span>&nbsp;<span class="ident" id="6122155">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6122167">w</span><span class="op" id="6122168">.</span><span class="ident" id="6122169">Close</span><span class="op" id="6122174">(</span><span class="op" id="6122175">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122178">return</span>&nbsp;<span class="builtintype" id="6122185">nil</span><br>
<span class="lineno"></span><span class="op" id="6122189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6122192">func</span>&nbsp;<span class="ident" id="6122197">readSize</span><span class="op" id="6122205">(</span><span class="ident" id="6122206">s</span>&nbsp;<span class="op" id="6122208">[</span><span class="op" id="6122209">]</span><span class="builtintype" id="6122210">byte</span><span class="op" id="6122214">)</span>&nbsp;<span class="op" id="6122216">(</span><span class="builtintype" id="6122217">uint32</span><span class="op" id="6122223">,</span>&nbsp;<span class="builtintype" id="6122225">int</span><span class="op" id="6122228">)</span>&nbsp;<span class="op" id="6122230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122233">if</span>&nbsp;<span class="builtinfunc" id="6122236">len</span><span class="op" id="6122239">(</span><span class="ident" id="6122240">s</span><span class="op" id="6122241">)</span>&nbsp;<span class="op" id="6122243">==</span>&nbsp;<span class="num" id="6122246">0</span>&nbsp;<span class="op" id="6122248">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122252">return</span>&nbsp;<span class="num" id="6122259">0</span><span class="op" id="6122260">,</span>&nbsp;<span class="num" id="6122262">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6122268">size</span><span class="op" id="6122272">,</span>&nbsp;<span class="ident" id="6122274">n</span>&nbsp;<span class="op" id="6122276">:=</span>&nbsp;<span class="builtintype" id="6122279">uint32</span><span class="op" id="6122285">(</span><span class="ident" id="6122286">s</span><span class="op" id="6122287">[</span><span class="num" id="6122288">0</span><span class="op" id="6122289">]</span><span class="op" id="6122290">)</span><span class="op" id="6122291">,</span>&nbsp;<span class="num" id="6122293">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122296">if</span>&nbsp;<span class="ident" id="6122299">size</span><span class="op" id="6122303">&amp;</span><span class="op" id="6122304">(</span><span class="num" id="6122305">1</span><span class="op" id="6122306">&lt;&lt;</span><span class="num" id="6122308">7</span><span class="op" id="6122309">)</span>&nbsp;<span class="op" id="6122311">!=</span>&nbsp;<span class="num" id="6122314">0</span>&nbsp;<span class="op" id="6122316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122320">if</span>&nbsp;<span class="builtinfunc" id="6122323">len</span><span class="op" id="6122326">(</span><span class="ident" id="6122327">s</span><span class="op" id="6122328">)</span>&nbsp;<span class="op" id="6122330">&lt;</span>&nbsp;<span class="num" id="6122332">4</span>&nbsp;<span class="op" id="6122334">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122339">return</span>&nbsp;<span class="num" id="6122346">0</span><span class="op" id="6122347">,</span>&nbsp;<span class="num" id="6122349">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6122357">n</span>&nbsp;<span class="op" id="6122359">=</span>&nbsp;<span class="num" id="6122361">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6122365">size</span>&nbsp;<span class="op" id="6122370">=</span>&nbsp;<span class="ident" id="6122372">binary</span><span class="op" id="6122378">.</span><span class="ident" id="6122379">BigEndian</span><span class="op" id="6122388">.</span><span class="ident" id="6122389">Uint32</span><span class="op" id="6122395">(</span><span class="ident" id="6122396">s</span><span class="op" id="6122397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6122401">size</span>&nbsp;<span class="op" id="6122406">&amp;^=</span>&nbsp;<span class="num" id="6122410">1</span>&nbsp;<span class="op" id="6122412">&lt;&lt;</span>&nbsp;<span class="num" id="6122415">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122422">return</span>&nbsp;<span class="ident" id="6122429">size</span><span class="op" id="6122433">,</span>&nbsp;<span class="ident" id="6122435">n</span><br>
<span class="lineno"></span><span class="op" id="6122437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6122440">func</span>&nbsp;<span class="ident" id="6122445">readString</span><span class="op" id="6122455">(</span><span class="ident" id="6122456">s</span>&nbsp;<span class="op" id="6122458">[</span><span class="op" id="6122459">]</span><span class="builtintype" id="6122460">byte</span><span class="op" id="6122464">,</span>&nbsp;<span class="ident" id="6122466">size</span>&nbsp;<span class="builtintype" id="6122471">uint32</span><span class="op" id="6122477">)</span>&nbsp;<span class="builtintype" id="6122479">string</span>&nbsp;<span class="op" id="6122486">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122489">if</span>&nbsp;<span class="ident" id="6122492">size</span>&nbsp;<span class="op" id="6122497">&gt;</span>&nbsp;<span class="builtintype" id="6122499">uint32</span><span class="op" id="6122505">(</span><span class="builtinfunc" id="6122506">len</span><span class="op" id="6122509">(</span><span class="ident" id="6122510">s</span><span class="op" id="6122511">)</span><span class="op" id="6122512">)</span>&nbsp;<span class="op" id="6122514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122518">return</span>&nbsp;<span class="string" id="6122525">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122532">return</span>&nbsp;<span class="builtintype" id="6122539">string</span><span class="op" id="6122545">(</span><span class="ident" id="6122546">s</span><span class="op" id="6122547">[</span><span class="op" id="6122548">:</span><span class="ident" id="6122549">size</span><span class="op" id="6122553">]</span><span class="op" id="6122554">)</span><br>
<span class="lineno"></span><span class="op" id="6122556">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6122559">func</span>&nbsp;<span class="ident" id="6122564">encodeSize</span><span class="op" id="6122574">(</span><span class="ident" id="6122575">b</span>&nbsp;<span class="op" id="6122577">[</span><span class="op" id="6122578">]</span><span class="builtintype" id="6122579">byte</span><span class="op" id="6122583">,</span>&nbsp;<span class="ident" id="6122585">size</span>&nbsp;<span class="builtintype" id="6122590">uint32</span><span class="op" id="6122596">)</span>&nbsp;<span class="builtintype" id="6122598">int</span>&nbsp;<span class="op" id="6122602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122605">if</span>&nbsp;<span class="ident" id="6122608">size</span>&nbsp;<span class="op" id="6122613">&gt;</span>&nbsp;<span class="num" id="6122615">127</span>&nbsp;<span class="op" id="6122619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6122623">size</span>&nbsp;<span class="op" id="6122628">|=</span>&nbsp;<span class="num" id="6122631">1</span>&nbsp;<span class="op" id="6122633">&lt;&lt;</span>&nbsp;<span class="num" id="6122636">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6122641">binary</span><span class="op" id="6122647">.</span><span class="ident" id="6122648">BigEndian</span><span class="op" id="6122657">.</span><span class="ident" id="6122658">PutUint32</span><span class="op" id="6122667">(</span><span class="ident" id="6122668">b</span><span class="op" id="6122669">,</span>&nbsp;<span class="ident" id="6122671">size</span><span class="op" id="6122675">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122679">return</span>&nbsp;<span class="num" id="6122686">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6122692">b</span><span class="op" id="6122693">[</span><span class="num" id="6122694">0</span><span class="op" id="6122695">]</span>&nbsp;<span class="op" id="6122697">=</span>&nbsp;<span class="builtintype" id="6122699">byte</span><span class="op" id="6122703">(</span><span class="ident" id="6122704">size</span><span class="op" id="6122708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122711">return</span>&nbsp;<span class="num" id="6122718">1</span><br>
<span class="lineno"></span><span class="op" id="6122720">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="6122723">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6122805">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6122816">type</span>&nbsp;<span class="ident" id="6122821">bufWriter</span>&nbsp;<span class="keyword" id="6122831">struct</span>&nbsp;<span class="op" id="6122838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6122841">closer</span>&nbsp;<span class="ident" id="6122848">io</span><span class="op" id="6122850">.</span><span class="ident" id="6122851">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122859">*</span><span class="ident" id="6122860">bufio</span><span class="op" id="6122865">.</span><span class="ident" id="6122866">Writer</span><br>
<span class="lineno"></span><span class="op" id="6122873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6122876">func</span>&nbsp;<span class="op" id="6122881">(</span><span class="ident" id="6122882">w</span>&nbsp;<span class="op" id="6122884">*</span><span class="ident" id="6122885">bufWriter</span><span class="op" id="6122894">)</span>&nbsp;<span class="ident" id="6122896">Close</span><span class="op" id="6122901">(</span><span class="op" id="6122902">)</span>&nbsp;<span class="builtintype" id="6122904">error</span>&nbsp;<span class="op" id="6122910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122913">if</span>&nbsp;<span class="ident" id="6122916">err</span>&nbsp;<span class="op" id="6122920">:=</span>&nbsp;<span class="ident" id="6122923">w</span><span class="op" id="6122924">.</span><span class="ident" id="6122925">Writer</span><span class="op" id="6122931">.</span><span class="ident" id="6122932">Flush</span><span class="op" id="6122937">(</span><span class="op" id="6122938">)</span><span class="op" id="6122939">;</span>&nbsp;<span class="ident" id="6122941">err</span>&nbsp;<span class="op" id="6122945">!=</span>&nbsp;<span class="builtintype" id="6122948">nil</span>&nbsp;<span class="op" id="6122952">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6122956">w</span><span class="op" id="6122957">.</span><span class="ident" id="6122958">closer</span><span class="op" id="6122964">.</span><span class="ident" id="6122965">Close</span><span class="op" id="6122970">(</span><span class="op" id="6122971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122975">return</span>&nbsp;<span class="ident" id="6122982">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122990">return</span>&nbsp;<span class="ident" id="6122997">w</span><span class="op" id="6122998">.</span><span class="ident" id="6122999">closer</span><span class="op" id="6123005">.</span><span class="ident" id="6123006">Close</span><span class="op" id="6123011">(</span><span class="op" id="6123012">)</span><br>
<span class="lineno"></span><span class="op" id="6123014">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="6123017">func</span>&nbsp;<span class="ident" id="6123022">newWriter</span><span class="op" id="6123031">(</span><span class="ident" id="6123032">c</span>&nbsp;<span class="op" id="6123034">*</span><span class="ident" id="6123035">conn</span><span class="op" id="6123039">,</span>&nbsp;<span class="ident" id="6123041">recType</span>&nbsp;<span class="ident" id="6123049">recType</span><span class="op" id="6123056">,</span>&nbsp;<span class="ident" id="6123058">reqId</span>&nbsp;<span class="builtintype" id="6123064">uint16</span><span class="op" id="6123070">)</span>&nbsp;<span class="op" id="6123072">*</span><span class="ident" id="6123073">bufWriter</span>&nbsp;<span class="op" id="6123083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123086">s</span>&nbsp;<span class="op" id="6123088">:=</span>&nbsp;<span class="op" id="6123091">&amp;</span><span class="ident" id="6123092">streamWriter</span><span class="op" id="6123104">{</span><span class="ident" id="6123105">c</span><span class="op" id="6123106">:</span>&nbsp;<span class="ident" id="6123108">c</span><span class="op" id="6123109">,</span>&nbsp;<span class="ident" id="6123111">recType</span><span class="op" id="6123118">:</span>&nbsp;<span class="ident" id="6123120">recType</span><span class="op" id="6123127">,</span>&nbsp;<span class="ident" id="6123129">reqId</span><span class="op" id="6123134">:</span>&nbsp;<span class="ident" id="6123136">reqId</span><span class="op" id="6123141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123144">w</span>&nbsp;<span class="op" id="6123146">:=</span>&nbsp;<span class="ident" id="6123149">bufio</span><span class="op" id="6123154">.</span><span class="ident" id="6123155">NewWriterSize</span><span class="op" id="6123168">(</span><span class="ident" id="6123169">s</span><span class="op" id="6123170">,</span>&nbsp;<span class="ident" id="6123172">maxWrite</span><span class="op" id="6123180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6123183">return</span>&nbsp;<span class="op" id="6123190">&amp;</span><span class="ident" id="6123191">bufWriter</span><span class="op" id="6123200">{</span><span class="ident" id="6123201">s</span><span class="op" id="6123202">,</span>&nbsp;<span class="ident" id="6123204">w</span><span class="op" id="6123205">}</span><br>
<span class="lineno">245</span><span class="op" id="6123207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6123210">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="6123290">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="6123334">type</span>&nbsp;<span class="ident" id="6123339">streamWriter</span>&nbsp;<span class="keyword" id="6123352">struct</span>&nbsp;<span class="op" id="6123359">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123362">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6123370">*</span><span class="ident" id="6123371">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123377">recType</span>&nbsp;<span class="ident" id="6123385">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123394">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6123402">uint16</span><br>
<span class="lineno"></span><span class="op" id="6123409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6123412">func</span>&nbsp;<span class="op" id="6123417">(</span><span class="ident" id="6123418">w</span>&nbsp;<span class="op" id="6123420">*</span><span class="ident" id="6123421">streamWriter</span><span class="op" id="6123433">)</span>&nbsp;<span class="ident" id="6123435">Write</span><span class="op" id="6123440">(</span><span class="ident" id="6123441">p</span>&nbsp;<span class="op" id="6123443">[</span><span class="op" id="6123444">]</span><span class="builtintype" id="6123445">byte</span><span class="op" id="6123449">)</span>&nbsp;<span class="op" id="6123451">(</span><span class="builtintype" id="6123452">int</span><span class="op" id="6123455">,</span>&nbsp;<span class="builtintype" id="6123457">error</span><span class="op" id="6123462">)</span>&nbsp;<span class="op" id="6123464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123467">nn</span>&nbsp;<span class="op" id="6123470">:=</span>&nbsp;<span class="num" id="6123473">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6123476">for</span>&nbsp;<span class="builtinfunc" id="6123480">len</span><span class="op" id="6123483">(</span><span class="ident" id="6123484">p</span><span class="op" id="6123485">)</span>&nbsp;<span class="op" id="6123487">&gt;</span>&nbsp;<span class="num" id="6123489">0</span>&nbsp;<span class="op" id="6123491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123495">n</span>&nbsp;<span class="op" id="6123497">:=</span>&nbsp;<span class="builtinfunc" id="6123500">len</span><span class="op" id="6123503">(</span><span class="ident" id="6123504">p</span><span class="op" id="6123505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6123509">if</span>&nbsp;<span class="ident" id="6123512">n</span>&nbsp;<span class="op" id="6123514">&gt;</span>&nbsp;<span class="ident" id="6123516">maxWrite</span>&nbsp;<span class="op" id="6123525">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123530">n</span>&nbsp;<span class="op" id="6123532">=</span>&nbsp;<span class="ident" id="6123534">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6123545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6123549">if</span>&nbsp;<span class="ident" id="6123552">err</span>&nbsp;<span class="op" id="6123556">:=</span>&nbsp;<span class="ident" id="6123559">w</span><span class="op" id="6123560">.</span><span class="ident" id="6123561">c</span><span class="op" id="6123562">.</span><span class="ident" id="6123563">writeRecord</span><span class="op" id="6123574">(</span><span class="ident" id="6123575">w</span><span class="op" id="6123576">.</span><span class="ident" id="6123577">recType</span><span class="op" id="6123584">,</span>&nbsp;<span class="ident" id="6123586">w</span><span class="op" id="6123587">.</span><span class="ident" id="6123588">reqId</span><span class="op" id="6123593">,</span>&nbsp;<span class="ident" id="6123595">p</span><span class="op" id="6123596">[</span><span class="op" id="6123597">:</span><span class="ident" id="6123598">n</span><span class="op" id="6123599">]</span><span class="op" id="6123600">)</span><span class="op" id="6123601">;</span>&nbsp;<span class="ident" id="6123603">err</span>&nbsp;<span class="op" id="6123607">!=</span>&nbsp;<span class="builtintype" id="6123610">nil</span>&nbsp;<span class="op" id="6123614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6123619">return</span>&nbsp;<span class="ident" id="6123626">nn</span><span class="op" id="6123628">,</span>&nbsp;<span class="ident" id="6123630">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6123636">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123640">nn</span>&nbsp;<span class="op" id="6123643">+=</span>&nbsp;<span class="ident" id="6123646">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123650">p</span>&nbsp;<span class="op" id="6123652">=</span>&nbsp;<span class="ident" id="6123654">p</span><span class="op" id="6123655">[</span><span class="ident" id="6123656">n</span><span class="op" id="6123657">:</span><span class="op" id="6123658">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6123661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6123664">return</span>&nbsp;<span class="ident" id="6123671">nn</span><span class="op" id="6123673">,</span>&nbsp;<span class="builtintype" id="6123675">nil</span><br>
<span class="lineno"></span><span class="op" id="6123679">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6123682">func</span>&nbsp;<span class="op" id="6123687">(</span><span class="ident" id="6123688">w</span>&nbsp;<span class="op" id="6123690">*</span><span class="ident" id="6123691">streamWriter</span><span class="op" id="6123703">)</span>&nbsp;<span class="ident" id="6123705">Close</span><span class="op" id="6123710">(</span><span class="op" id="6123711">)</span>&nbsp;<span class="builtintype" id="6123713">error</span>&nbsp;<span class="op" id="6123719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6123722">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6123764">return</span>&nbsp;<span class="ident" id="6123771">w</span><span class="op" id="6123772">.</span><span class="ident" id="6123773">c</span><span class="op" id="6123774">.</span><span class="ident" id="6123775">writeRecord</span><span class="op" id="6123786">(</span><span class="ident" id="6123787">w</span><span class="op" id="6123788">.</span><span class="ident" id="6123789">recType</span><span class="op" id="6123796">,</span>&nbsp;<span class="ident" id="6123798">w</span><span class="op" id="6123799">.</span><span class="ident" id="6123800">reqId</span><span class="op" id="6123805">,</span>&nbsp;<span class="builtintype" id="6123807">nil</span><span class="op" id="6123810">)</span><br>
<span class="lineno"></span><span class="op" id="6123812">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
