<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6282820">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6282875">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6282929">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6282980">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="6283029">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="6283080">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="6283157">package</span>&nbsp;<span class="ident" id="6283165">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6283171">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6283250">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6283264">import</span>&nbsp;<span class="op" id="6283271">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6283274">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6283283">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6283292">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6283311">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6283321">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6283327">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6283334">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6283337">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6283380">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="6283435">type</span>&nbsp;<span class="ident" id="6283440">recType</span>&nbsp;<span class="builtintype" id="6283448">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6283455">const</span>&nbsp;<span class="op" id="6283461">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283464">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283484">recType</span>&nbsp;<span class="op" id="6283492">=</span>&nbsp;<span class="num" id="6283494">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283497">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283517">recType</span>&nbsp;<span class="op" id="6283525">=</span>&nbsp;<span class="num" id="6283527">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283530">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283550">recType</span>&nbsp;<span class="op" id="6283558">=</span>&nbsp;<span class="num" id="6283560">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283563">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283583">recType</span>&nbsp;<span class="op" id="6283591">=</span>&nbsp;<span class="num" id="6283593">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283596">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283616">recType</span>&nbsp;<span class="op" id="6283624">=</span>&nbsp;<span class="num" id="6283626">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283629">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283649">recType</span>&nbsp;<span class="op" id="6283657">=</span>&nbsp;<span class="num" id="6283659">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283662">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283682">recType</span>&nbsp;<span class="op" id="6283690">=</span>&nbsp;<span class="num" id="6283692">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283695">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283715">recType</span>&nbsp;<span class="op" id="6283723">=</span>&nbsp;<span class="num" id="6283725">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283728">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283748">recType</span>&nbsp;<span class="op" id="6283756">=</span>&nbsp;<span class="num" id="6283758">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283761">typeGetValuesResult</span>&nbsp;<span class="ident" id="6283781">recType</span>&nbsp;<span class="op" id="6283789">=</span>&nbsp;<span class="num" id="6283791">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283795">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283815">recType</span>&nbsp;<span class="op" id="6283823">=</span>&nbsp;<span class="num" id="6283825">11</span><br>
<span class="lineno"></span><span class="op" id="6283828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="6283831">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="6283906">const</span>&nbsp;<span class="ident" id="6283912">flagKeepConn</span>&nbsp;<span class="op" id="6283925">=</span>&nbsp;<span class="num" id="6283927">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6283930">const</span>&nbsp;<span class="op" id="6283936">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283939">maxWrite</span>&nbsp;<span class="op" id="6283948">=</span>&nbsp;<span class="num" id="6283950">65535</span>&nbsp;<span class="comment" id="6283956">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283980">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6283989">=</span>&nbsp;<span class="num" id="6283991">255</span><br>
<span class="lineno"></span><span class="op" id="6283995">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6283998">const</span>&nbsp;<span class="op" id="6284004">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284007">roleResponder</span>&nbsp;<span class="op" id="6284021">=</span>&nbsp;<span class="ident" id="6284023">iota</span>&nbsp;<span class="op" id="6284028">+</span>&nbsp;<span class="num" id="6284030">1</span>&nbsp;<span class="comment" id="6284032">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284069">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284085">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="6284096">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6284099">const</span>&nbsp;<span class="op" id="6284105">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284108">statusRequestComplete</span>&nbsp;<span class="op" id="6284130">=</span>&nbsp;<span class="ident" id="6284132">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284138">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284159">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284177">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="6284195">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6284198">const</span>&nbsp;<span class="ident" id="6284204">headerLen</span>&nbsp;<span class="op" id="6284214">=</span>&nbsp;<span class="num" id="6284216">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6284219">type</span>&nbsp;<span class="ident" id="6284224">header</span>&nbsp;<span class="keyword" id="6284231">struct</span>&nbsp;<span class="op" id="6284238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284241">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6284255">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284262">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284276">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284285">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6284299">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284307">ContentLength</span>&nbsp;<span class="builtintype" id="6284321">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284329">PaddingLength</span>&nbsp;<span class="builtintype" id="6284343">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284350">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6284364">uint8</span><br>
<span class="lineno">70</span><span class="op" id="6284370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6284373">type</span>&nbsp;<span class="ident" id="6284378">beginRequest</span>&nbsp;<span class="keyword" id="6284391">struct</span>&nbsp;<span class="op" id="6284398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284401">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6284410">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284418">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6284427">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284434">reserved</span>&nbsp;<span class="op" id="6284443">[</span><span class="num" id="6284444">5</span><span class="op" id="6284445">]</span><span class="builtintype" id="6284446">uint8</span><br>
<span class="lineno"></span><span class="op" id="6284452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6284455">func</span>&nbsp;<span class="op" id="6284460">(</span><span class="ident" id="6284461">br</span>&nbsp;<span class="op" id="6284464">*</span><span class="ident" id="6284465">beginRequest</span><span class="op" id="6284477">)</span>&nbsp;<span class="ident" id="6284479">read</span><span class="op" id="6284483">(</span><span class="ident" id="6284484">content</span>&nbsp;<span class="op" id="6284492">[</span><span class="op" id="6284493">]</span><span class="builtintype" id="6284494">byte</span><span class="op" id="6284498">)</span>&nbsp;<span class="builtintype" id="6284500">error</span>&nbsp;<span class="op" id="6284506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284509">if</span>&nbsp;<span class="builtinfunc" id="6284512">len</span><span class="op" id="6284515">(</span><span class="ident" id="6284516">content</span><span class="op" id="6284523">)</span>&nbsp;<span class="op" id="6284525">!=</span>&nbsp;<span class="num" id="6284528">8</span>&nbsp;<span class="op" id="6284530">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284534">return</span>&nbsp;<span class="ident" id="6284541">errors</span><span class="op" id="6284547">.</span><span class="ident" id="6284548">New</span><span class="op" id="6284551">(</span><span class="string" id="6284552">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="6284588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284594">br</span><span class="op" id="6284596">.</span><span class="ident" id="6284597">role</span>&nbsp;<span class="op" id="6284602">=</span>&nbsp;<span class="ident" id="6284604">binary</span><span class="op" id="6284610">.</span><span class="ident" id="6284611">BigEndian</span><span class="op" id="6284620">.</span><span class="ident" id="6284621">Uint16</span><span class="op" id="6284627">(</span><span class="ident" id="6284628">content</span><span class="op" id="6284635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284638">br</span><span class="op" id="6284640">.</span><span class="ident" id="6284641">flags</span>&nbsp;<span class="op" id="6284647">=</span>&nbsp;<span class="ident" id="6284649">content</span><span class="op" id="6284656">[</span><span class="num" id="6284657">2</span><span class="op" id="6284658">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284661">return</span>&nbsp;<span class="ident" id="6284668">nil</span><br>
<span class="lineno">85</span><span class="op" id="6284672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6284675">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="6284732">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="6284796">var</span>&nbsp;<span class="ident" id="6284800">pad</span>&nbsp;<span class="op" id="6284804">[</span><span class="ident" id="6284805">maxPad</span><span class="op" id="6284811">]</span><span class="builtintype" id="6284812">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="6284818">func</span>&nbsp;<span class="op" id="6284823">(</span><span class="ident" id="6284824">h</span>&nbsp;<span class="op" id="6284826">*</span><span class="ident" id="6284827">header</span><span class="op" id="6284833">)</span>&nbsp;<span class="ident" id="6284835">init</span><span class="op" id="6284839">(</span><span class="ident" id="6284840">recType</span>&nbsp;<span class="ident" id="6284848">recType</span><span class="op" id="6284855">,</span>&nbsp;<span class="ident" id="6284857">reqId</span>&nbsp;<span class="builtintype" id="6284863">uint16</span><span class="op" id="6284869">,</span>&nbsp;<span class="ident" id="6284871">contentLength</span>&nbsp;<span class="builtintype" id="6284885">int</span><span class="op" id="6284888">)</span>&nbsp;<span class="op" id="6284890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284893">h</span><span class="op" id="6284894">.</span><span class="ident" id="6284895">Version</span>&nbsp;<span class="op" id="6284903">=</span>&nbsp;<span class="num" id="6284905">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284908">h</span><span class="op" id="6284909">.</span><span class="ident" id="6284910">Type</span>&nbsp;<span class="op" id="6284915">=</span>&nbsp;<span class="ident" id="6284917">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284926">h</span><span class="op" id="6284927">.</span><span class="ident" id="6284928">Id</span>&nbsp;<span class="op" id="6284931">=</span>&nbsp;<span class="ident" id="6284933">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284940">h</span><span class="op" id="6284941">.</span><span class="ident" id="6284942">ContentLength</span>&nbsp;<span class="op" id="6284956">=</span>&nbsp;<span class="builtintype" id="6284958">uint16</span><span class="op" id="6284964">(</span><span class="ident" id="6284965">contentLength</span><span class="op" id="6284978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284981">h</span><span class="op" id="6284982">.</span><span class="ident" id="6284983">PaddingLength</span>&nbsp;<span class="op" id="6284997">=</span>&nbsp;<span class="builtintype" id="6284999">uint8</span><span class="op" id="6285004">(</span><span class="op" id="6285005">-</span><span class="ident" id="6285006">contentLength</span>&nbsp;<span class="op" id="6285020">&amp;</span>&nbsp;<span class="num" id="6285022">7</span><span class="op" id="6285023">)</span><br>
<span class="lineno"></span><span class="op" id="6285025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6285028">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="6285059">type</span>&nbsp;<span class="ident" id="6285064">conn</span>&nbsp;<span class="keyword" id="6285069">struct</span>&nbsp;<span class="op" id="6285076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285079">mutex</span>&nbsp;<span class="ident" id="6285085">sync</span><span class="op" id="6285089">.</span><span class="ident" id="6285090">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285097">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6285103">io</span><span class="op" id="6285105">.</span><span class="ident" id="6285106">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6285124">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285149">buf</span>&nbsp;<span class="ident" id="6285153">bytes</span><span class="op" id="6285158">.</span><span class="ident" id="6285159">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285167">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6285171">header</span><br>
<span class="lineno"></span><span class="op" id="6285178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6285181">func</span>&nbsp;<span class="ident" id="6285186">newConn</span><span class="op" id="6285193">(</span><span class="ident" id="6285194">rwc</span>&nbsp;<span class="ident" id="6285198">io</span><span class="op" id="6285200">.</span><span class="ident" id="6285201">ReadWriteCloser</span><span class="op" id="6285216">)</span>&nbsp;<span class="op" id="6285218">*</span><span class="ident" id="6285219">conn</span>&nbsp;<span class="op" id="6285224">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285227">return</span>&nbsp;<span class="op" id="6285234">&amp;</span><span class="ident" id="6285235">conn</span><span class="op" id="6285239">{</span><span class="ident" id="6285240">rwc</span><span class="op" id="6285243">:</span>&nbsp;<span class="ident" id="6285245">rwc</span><span class="op" id="6285248">}</span><br>
<span class="lineno"></span><span class="op" id="6285250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6285253">func</span>&nbsp;<span class="op" id="6285258">(</span><span class="ident" id="6285259">c</span>&nbsp;<span class="op" id="6285261">*</span><span class="ident" id="6285262">conn</span><span class="op" id="6285266">)</span>&nbsp;<span class="ident" id="6285268">Close</span><span class="op" id="6285273">(</span><span class="op" id="6285274">)</span>&nbsp;<span class="builtintype" id="6285276">error</span>&nbsp;<span class="op" id="6285282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285285">c</span><span class="op" id="6285286">.</span><span class="ident" id="6285287">mutex</span><span class="op" id="6285292">.</span><span class="ident" id="6285293">Lock</span><span class="op" id="6285297">(</span><span class="op" id="6285298">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285301">defer</span>&nbsp;<span class="ident" id="6285307">c</span><span class="op" id="6285308">.</span><span class="ident" id="6285309">mutex</span><span class="op" id="6285314">.</span><span class="ident" id="6285315">Unlock</span><span class="op" id="6285321">(</span><span class="op" id="6285322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285325">return</span>&nbsp;<span class="ident" id="6285332">c</span><span class="op" id="6285333">.</span><span class="ident" id="6285334">rwc</span><span class="op" id="6285337">.</span><span class="ident" id="6285338">Close</span><span class="op" id="6285343">(</span><span class="op" id="6285344">)</span><br>
<span class="lineno"></span><span class="op" id="6285346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6285349">type</span>&nbsp;<span class="ident" id="6285354">record</span>&nbsp;<span class="keyword" id="6285361">struct</span>&nbsp;<span class="op" id="6285368">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285371">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6285375">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285383">buf</span>&nbsp;<span class="op" id="6285387">[</span><span class="ident" id="6285388">maxWrite</span>&nbsp;<span class="op" id="6285397">+</span>&nbsp;<span class="ident" id="6285399">maxPad</span><span class="op" id="6285405">]</span><span class="builtintype" id="6285406">byte</span><br>
<span class="lineno"></span><span class="op" id="6285411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6285414">func</span>&nbsp;<span class="op" id="6285419">(</span><span class="ident" id="6285420">rec</span>&nbsp;<span class="op" id="6285424">*</span><span class="ident" id="6285425">record</span><span class="op" id="6285431">)</span>&nbsp;<span class="ident" id="6285433">read</span><span class="op" id="6285437">(</span><span class="ident" id="6285438">r</span>&nbsp;<span class="ident" id="6285440">io</span><span class="op" id="6285442">.</span><span class="ident" id="6285443">Reader</span><span class="op" id="6285449">)</span>&nbsp;<span class="op" id="6285451">(</span><span class="ident" id="6285452">err</span>&nbsp;<span class="builtintype" id="6285456">error</span><span class="op" id="6285461">)</span>&nbsp;<span class="op" id="6285463">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285466">if</span>&nbsp;<span class="ident" id="6285469">err</span>&nbsp;<span class="op" id="6285473">=</span>&nbsp;<span class="ident" id="6285475">binary</span><span class="op" id="6285481">.</span><span class="ident" id="6285482">Read</span><span class="op" id="6285486">(</span><span class="ident" id="6285487">r</span><span class="op" id="6285488">,</span>&nbsp;<span class="ident" id="6285490">binary</span><span class="op" id="6285496">.</span><span class="ident" id="6285497">BigEndian</span><span class="op" id="6285506">,</span>&nbsp;<span class="op" id="6285508">&amp;</span><span class="ident" id="6285509">rec</span><span class="op" id="6285512">.</span><span class="ident" id="6285513">h</span><span class="op" id="6285514">)</span><span class="op" id="6285515">;</span>&nbsp;<span class="ident" id="6285517">err</span>&nbsp;<span class="op" id="6285521">!=</span>&nbsp;<span class="ident" id="6285524">nil</span>&nbsp;<span class="op" id="6285528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285532">return</span>&nbsp;<span class="ident" id="6285539">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285547">if</span>&nbsp;<span class="ident" id="6285550">rec</span><span class="op" id="6285553">.</span><span class="ident" id="6285554">h</span><span class="op" id="6285555">.</span><span class="ident" id="6285556">Version</span>&nbsp;<span class="op" id="6285564">!=</span>&nbsp;<span class="num" id="6285567">1</span>&nbsp;<span class="op" id="6285569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285573">return</span>&nbsp;<span class="ident" id="6285580">errors</span><span class="op" id="6285586">.</span><span class="ident" id="6285587">New</span><span class="op" id="6285590">(</span><span class="string" id="6285591">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="6285621">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285627">n</span>&nbsp;<span class="op" id="6285629">:=</span>&nbsp;<span class="builtintype" id="6285632">int</span><span class="op" id="6285635">(</span><span class="ident" id="6285636">rec</span><span class="op" id="6285639">.</span><span class="ident" id="6285640">h</span><span class="op" id="6285641">.</span><span class="ident" id="6285642">ContentLength</span><span class="op" id="6285655">)</span>&nbsp;<span class="op" id="6285657">+</span>&nbsp;<span class="builtintype" id="6285659">int</span><span class="op" id="6285662">(</span><span class="ident" id="6285663">rec</span><span class="op" id="6285666">.</span><span class="ident" id="6285667">h</span><span class="op" id="6285668">.</span><span class="ident" id="6285669">PaddingLength</span><span class="op" id="6285682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285685">if</span>&nbsp;<span class="ident" id="6285688">_</span><span class="op" id="6285689">,</span>&nbsp;<span class="ident" id="6285691">err</span>&nbsp;<span class="op" id="6285695">=</span>&nbsp;<span class="ident" id="6285697">io</span><span class="op" id="6285699">.</span><span class="ident" id="6285700">ReadFull</span><span class="op" id="6285708">(</span><span class="ident" id="6285709">r</span><span class="op" id="6285710">,</span>&nbsp;<span class="ident" id="6285712">rec</span><span class="op" id="6285715">.</span><span class="ident" id="6285716">buf</span><span class="op" id="6285719">[</span><span class="op" id="6285720">:</span><span class="ident" id="6285721">n</span><span class="op" id="6285722">]</span><span class="op" id="6285723">)</span><span class="op" id="6285724">;</span>&nbsp;<span class="ident" id="6285726">err</span>&nbsp;<span class="op" id="6285730">!=</span>&nbsp;<span class="ident" id="6285733">nil</span>&nbsp;<span class="op" id="6285737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285741">return</span>&nbsp;<span class="ident" id="6285748">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285753">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285756">return</span>&nbsp;<span class="ident" id="6285763">nil</span><br>
<span class="lineno"></span><span class="op" id="6285767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6285770">func</span>&nbsp;<span class="op" id="6285775">(</span><span class="ident" id="6285776">r</span>&nbsp;<span class="op" id="6285778">*</span><span class="ident" id="6285779">record</span><span class="op" id="6285785">)</span>&nbsp;<span class="ident" id="6285787">content</span><span class="op" id="6285794">(</span><span class="op" id="6285795">)</span>&nbsp;<span class="op" id="6285797">[</span><span class="op" id="6285798">]</span><span class="builtintype" id="6285799">byte</span>&nbsp;<span class="op" id="6285804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285807">return</span>&nbsp;<span class="ident" id="6285814">r</span><span class="op" id="6285815">.</span><span class="ident" id="6285816">buf</span><span class="op" id="6285819">[</span><span class="op" id="6285820">:</span><span class="ident" id="6285821">r</span><span class="op" id="6285822">.</span><span class="ident" id="6285823">h</span><span class="op" id="6285824">.</span><span class="ident" id="6285825">ContentLength</span><span class="op" id="6285838">]</span><br>
<span class="lineno">140</span><span class="op" id="6285840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6285843">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="6285892">func</span>&nbsp;<span class="op" id="6285897">(</span><span class="ident" id="6285898">c</span>&nbsp;<span class="op" id="6285900">*</span><span class="ident" id="6285901">conn</span><span class="op" id="6285905">)</span>&nbsp;<span class="ident" id="6285907">writeRecord</span><span class="op" id="6285918">(</span><span class="ident" id="6285919">recType</span>&nbsp;<span class="ident" id="6285927">recType</span><span class="op" id="6285934">,</span>&nbsp;<span class="ident" id="6285936">reqId</span>&nbsp;<span class="builtintype" id="6285942">uint16</span><span class="op" id="6285948">,</span>&nbsp;<span class="ident" id="6285950">b</span>&nbsp;<span class="op" id="6285952">[</span><span class="op" id="6285953">]</span><span class="builtintype" id="6285954">byte</span><span class="op" id="6285958">)</span>&nbsp;<span class="builtintype" id="6285960">error</span>&nbsp;<span class="op" id="6285966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285969">c</span><span class="op" id="6285970">.</span><span class="ident" id="6285971">mutex</span><span class="op" id="6285976">.</span><span class="ident" id="6285977">Lock</span><span class="op" id="6285981">(</span><span class="op" id="6285982">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285985">defer</span>&nbsp;<span class="ident" id="6285991">c</span><span class="op" id="6285992">.</span><span class="ident" id="6285993">mutex</span><span class="op" id="6285998">.</span><span class="ident" id="6285999">Unlock</span><span class="op" id="6286005">(</span><span class="op" id="6286006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286009">c</span><span class="op" id="6286010">.</span><span class="ident" id="6286011">buf</span><span class="op" id="6286014">.</span><span class="ident" id="6286015">Reset</span><span class="op" id="6286020">(</span><span class="op" id="6286021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286024">c</span><span class="op" id="6286025">.</span><span class="ident" id="6286026">h</span><span class="op" id="6286027">.</span><span class="ident" id="6286028">init</span><span class="op" id="6286032">(</span><span class="ident" id="6286033">recType</span><span class="op" id="6286040">,</span>&nbsp;<span class="ident" id="6286042">reqId</span><span class="op" id="6286047">,</span>&nbsp;<span class="builtinfunc" id="6286049">len</span><span class="op" id="6286052">(</span><span class="ident" id="6286053">b</span><span class="op" id="6286054">)</span><span class="op" id="6286055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286058">if</span>&nbsp;<span class="ident" id="6286061">err</span>&nbsp;<span class="op" id="6286065">:=</span>&nbsp;<span class="ident" id="6286068">binary</span><span class="op" id="6286074">.</span><span class="ident" id="6286075">Write</span><span class="op" id="6286080">(</span><span class="op" id="6286081">&amp;</span><span class="ident" id="6286082">c</span><span class="op" id="6286083">.</span><span class="ident" id="6286084">buf</span><span class="op" id="6286087">,</span>&nbsp;<span class="ident" id="6286089">binary</span><span class="op" id="6286095">.</span><span class="ident" id="6286096">BigEndian</span><span class="op" id="6286105">,</span>&nbsp;<span class="ident" id="6286107">c</span><span class="op" id="6286108">.</span><span class="ident" id="6286109">h</span><span class="op" id="6286110">)</span><span class="op" id="6286111">;</span>&nbsp;<span class="ident" id="6286113">err</span>&nbsp;<span class="op" id="6286117">!=</span>&nbsp;<span class="ident" id="6286120">nil</span>&nbsp;<span class="op" id="6286124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286128">return</span>&nbsp;<span class="ident" id="6286135">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6286140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286143">if</span>&nbsp;<span class="ident" id="6286146">_</span><span class="op" id="6286147">,</span>&nbsp;<span class="ident" id="6286149">err</span>&nbsp;<span class="op" id="6286153">:=</span>&nbsp;<span class="ident" id="6286156">c</span><span class="op" id="6286157">.</span><span class="ident" id="6286158">buf</span><span class="op" id="6286161">.</span><span class="ident" id="6286162">Write</span><span class="op" id="6286167">(</span><span class="ident" id="6286168">b</span><span class="op" id="6286169">)</span><span class="op" id="6286170">;</span>&nbsp;<span class="ident" id="6286172">err</span>&nbsp;<span class="op" id="6286176">!=</span>&nbsp;<span class="ident" id="6286179">nil</span>&nbsp;<span class="op" id="6286183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286187">return</span>&nbsp;<span class="ident" id="6286194">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6286199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286202">if</span>&nbsp;<span class="ident" id="6286205">_</span><span class="op" id="6286206">,</span>&nbsp;<span class="ident" id="6286208">err</span>&nbsp;<span class="op" id="6286212">:=</span>&nbsp;<span class="ident" id="6286215">c</span><span class="op" id="6286216">.</span><span class="ident" id="6286217">buf</span><span class="op" id="6286220">.</span><span class="ident" id="6286221">Write</span><span class="op" id="6286226">(</span><span class="ident" id="6286227">pad</span><span class="op" id="6286230">[</span><span class="op" id="6286231">:</span><span class="ident" id="6286232">c</span><span class="op" id="6286233">.</span><span class="ident" id="6286234">h</span><span class="op" id="6286235">.</span><span class="ident" id="6286236">PaddingLength</span><span class="op" id="6286249">]</span><span class="op" id="6286250">)</span><span class="op" id="6286251">;</span>&nbsp;<span class="ident" id="6286253">err</span>&nbsp;<span class="op" id="6286257">!=</span>&nbsp;<span class="ident" id="6286260">nil</span>&nbsp;<span class="op" id="6286264">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286268">return</span>&nbsp;<span class="ident" id="6286275">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6286280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286283">_</span><span class="op" id="6286284">,</span>&nbsp;<span class="ident" id="6286286">err</span>&nbsp;<span class="op" id="6286290">:=</span>&nbsp;<span class="ident" id="6286293">c</span><span class="op" id="6286294">.</span><span class="ident" id="6286295">rwc</span><span class="op" id="6286298">.</span><span class="ident" id="6286299">Write</span><span class="op" id="6286304">(</span><span class="ident" id="6286305">c</span><span class="op" id="6286306">.</span><span class="ident" id="6286307">buf</span><span class="op" id="6286310">.</span><span class="ident" id="6286311">Bytes</span><span class="op" id="6286316">(</span><span class="op" id="6286317">)</span><span class="op" id="6286318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286321">return</span>&nbsp;<span class="ident" id="6286328">err</span><br>
<span class="lineno"></span><span class="op" id="6286332">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="6286335">func</span>&nbsp;<span class="op" id="6286340">(</span><span class="ident" id="6286341">c</span>&nbsp;<span class="op" id="6286343">*</span><span class="ident" id="6286344">conn</span><span class="op" id="6286348">)</span>&nbsp;<span class="ident" id="6286350">writeBeginRequest</span><span class="op" id="6286367">(</span><span class="ident" id="6286368">reqId</span>&nbsp;<span class="builtintype" id="6286374">uint16</span><span class="op" id="6286380">,</span>&nbsp;<span class="ident" id="6286382">role</span>&nbsp;<span class="builtintype" id="6286387">uint16</span><span class="op" id="6286393">,</span>&nbsp;<span class="ident" id="6286395">flags</span>&nbsp;<span class="builtintype" id="6286401">uint8</span><span class="op" id="6286406">)</span>&nbsp;<span class="builtintype" id="6286408">error</span>&nbsp;<span class="op" id="6286414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286417">b</span>&nbsp;<span class="op" id="6286419">:=</span>&nbsp;<span class="op" id="6286422">[</span><span class="num" id="6286423">8</span><span class="op" id="6286424">]</span><span class="builtintype" id="6286425">byte</span><span class="op" id="6286429">{</span><span class="builtintype" id="6286430">byte</span><span class="op" id="6286434">(</span><span class="ident" id="6286435">role</span>&nbsp;<span class="op" id="6286440">&gt;&gt;</span>&nbsp;<span class="num" id="6286443">8</span><span class="op" id="6286444">)</span><span class="op" id="6286445">,</span>&nbsp;<span class="builtintype" id="6286447">byte</span><span class="op" id="6286451">(</span><span class="ident" id="6286452">role</span><span class="op" id="6286456">)</span><span class="op" id="6286457">,</span>&nbsp;<span class="ident" id="6286459">flags</span><span class="op" id="6286464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286467">return</span>&nbsp;<span class="ident" id="6286474">c</span><span class="op" id="6286475">.</span><span class="ident" id="6286476">writeRecord</span><span class="op" id="6286487">(</span><span class="ident" id="6286488">typeBeginRequest</span><span class="op" id="6286504">,</span>&nbsp;<span class="ident" id="6286506">reqId</span><span class="op" id="6286511">,</span>&nbsp;<span class="ident" id="6286513">b</span><span class="op" id="6286514">[</span><span class="op" id="6286515">:</span><span class="op" id="6286516">]</span><span class="op" id="6286517">)</span><br>
<span class="lineno"></span><span class="op" id="6286519">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="6286522">func</span>&nbsp;<span class="op" id="6286527">(</span><span class="ident" id="6286528">c</span>&nbsp;<span class="op" id="6286530">*</span><span class="ident" id="6286531">conn</span><span class="op" id="6286535">)</span>&nbsp;<span class="ident" id="6286537">writeEndRequest</span><span class="op" id="6286552">(</span><span class="ident" id="6286553">reqId</span>&nbsp;<span class="builtintype" id="6286559">uint16</span><span class="op" id="6286565">,</span>&nbsp;<span class="ident" id="6286567">appStatus</span>&nbsp;<span class="builtintype" id="6286577">int</span><span class="op" id="6286580">,</span>&nbsp;<span class="ident" id="6286582">protocolStatus</span>&nbsp;<span class="builtintype" id="6286597">uint8</span><span class="op" id="6286602">)</span>&nbsp;<span class="builtintype" id="6286604">error</span>&nbsp;<span class="op" id="6286610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286613">b</span>&nbsp;<span class="op" id="6286615">:=</span>&nbsp;<span class="builtinfunc" id="6286618">make</span><span class="op" id="6286622">(</span><span class="op" id="6286623">[</span><span class="op" id="6286624">]</span><span class="builtintype" id="6286625">byte</span><span class="op" id="6286629">,</span>&nbsp;<span class="num" id="6286631">8</span><span class="op" id="6286632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286635">binary</span><span class="op" id="6286641">.</span><span class="ident" id="6286642">BigEndian</span><span class="op" id="6286651">.</span><span class="ident" id="6286652">PutUint32</span><span class="op" id="6286661">(</span><span class="ident" id="6286662">b</span><span class="op" id="6286663">,</span>&nbsp;<span class="builtintype" id="6286665">uint32</span><span class="op" id="6286671">(</span><span class="ident" id="6286672">appStatus</span><span class="op" id="6286681">)</span><span class="op" id="6286682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286685">b</span><span class="op" id="6286686">[</span><span class="num" id="6286687">4</span><span class="op" id="6286688">]</span>&nbsp;<span class="op" id="6286690">=</span>&nbsp;<span class="ident" id="6286692">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286708">return</span>&nbsp;<span class="ident" id="6286715">c</span><span class="op" id="6286716">.</span><span class="ident" id="6286717">writeRecord</span><span class="op" id="6286728">(</span><span class="ident" id="6286729">typeEndRequest</span><span class="op" id="6286743">,</span>&nbsp;<span class="ident" id="6286745">reqId</span><span class="op" id="6286750">,</span>&nbsp;<span class="ident" id="6286752">b</span><span class="op" id="6286753">)</span><br>
<span class="lineno"></span><span class="op" id="6286755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6286758">func</span>&nbsp;<span class="op" id="6286763">(</span><span class="ident" id="6286764">c</span>&nbsp;<span class="op" id="6286766">*</span><span class="ident" id="6286767">conn</span><span class="op" id="6286771">)</span>&nbsp;<span class="ident" id="6286773">writePairs</span><span class="op" id="6286783">(</span><span class="ident" id="6286784">recType</span>&nbsp;<span class="ident" id="6286792">recType</span><span class="op" id="6286799">,</span>&nbsp;<span class="ident" id="6286801">reqId</span>&nbsp;<span class="builtintype" id="6286807">uint16</span><span class="op" id="6286813">,</span>&nbsp;<span class="ident" id="6286815">pairs</span>&nbsp;<span class="keyword" id="6286821">map</span><span class="op" id="6286824">[</span><span class="builtintype" id="6286825">string</span><span class="op" id="6286831">]</span><span class="builtintype" id="6286832">string</span><span class="op" id="6286838">)</span>&nbsp;<span class="builtintype" id="6286840">error</span>&nbsp;<span class="op" id="6286846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286849">w</span>&nbsp;<span class="op" id="6286851">:=</span>&nbsp;<span class="ident" id="6286854">newWriter</span><span class="op" id="6286863">(</span><span class="ident" id="6286864">c</span><span class="op" id="6286865">,</span>&nbsp;<span class="ident" id="6286867">recType</span><span class="op" id="6286874">,</span>&nbsp;<span class="ident" id="6286876">reqId</span><span class="op" id="6286881">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286884">b</span>&nbsp;<span class="op" id="6286886">:=</span>&nbsp;<span class="builtinfunc" id="6286889">make</span><span class="op" id="6286893">(</span><span class="op" id="6286894">[</span><span class="op" id="6286895">]</span><span class="builtintype" id="6286896">byte</span><span class="op" id="6286900">,</span>&nbsp;<span class="num" id="6286902">8</span><span class="op" id="6286903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286906">for</span>&nbsp;<span class="ident" id="6286910">k</span><span class="op" id="6286911">,</span>&nbsp;<span class="ident" id="6286913">v</span>&nbsp;<span class="op" id="6286915">:=</span>&nbsp;<span class="keyword" id="6286918">range</span>&nbsp;<span class="ident" id="6286924">pairs</span>&nbsp;<span class="op" id="6286930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286934">n</span>&nbsp;<span class="op" id="6286936">:=</span>&nbsp;<span class="ident" id="6286939">encodeSize</span><span class="op" id="6286949">(</span><span class="ident" id="6286950">b</span><span class="op" id="6286951">,</span>&nbsp;<span class="builtintype" id="6286953">uint32</span><span class="op" id="6286959">(</span><span class="builtinfunc" id="6286960">len</span><span class="op" id="6286963">(</span><span class="ident" id="6286964">k</span><span class="op" id="6286965">)</span><span class="op" id="6286966">)</span><span class="op" id="6286967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286971">n</span>&nbsp;<span class="op" id="6286973">+=</span>&nbsp;<span class="ident" id="6286976">encodeSize</span><span class="op" id="6286986">(</span><span class="ident" id="6286987">b</span><span class="op" id="6286988">[</span><span class="ident" id="6286989">n</span><span class="op" id="6286990">:</span><span class="op" id="6286991">]</span><span class="op" id="6286992">,</span>&nbsp;<span class="builtintype" id="6286994">uint32</span><span class="op" id="6287000">(</span><span class="builtinfunc" id="6287001">len</span><span class="op" id="6287004">(</span><span class="ident" id="6287005">v</span><span class="op" id="6287006">)</span><span class="op" id="6287007">)</span><span class="op" id="6287008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287012">if</span>&nbsp;<span class="ident" id="6287015">_</span><span class="op" id="6287016">,</span>&nbsp;<span class="ident" id="6287018">err</span>&nbsp;<span class="op" id="6287022">:=</span>&nbsp;<span class="ident" id="6287025">w</span><span class="op" id="6287026">.</span><span class="ident" id="6287027">Write</span><span class="op" id="6287032">(</span><span class="ident" id="6287033">b</span><span class="op" id="6287034">[</span><span class="op" id="6287035">:</span><span class="ident" id="6287036">n</span><span class="op" id="6287037">]</span><span class="op" id="6287038">)</span><span class="op" id="6287039">;</span>&nbsp;<span class="ident" id="6287041">err</span>&nbsp;<span class="op" id="6287045">!=</span>&nbsp;<span class="ident" id="6287048">nil</span>&nbsp;<span class="op" id="6287052">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287057">return</span>&nbsp;<span class="ident" id="6287064">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287074">if</span>&nbsp;<span class="ident" id="6287077">_</span><span class="op" id="6287078">,</span>&nbsp;<span class="ident" id="6287080">err</span>&nbsp;<span class="op" id="6287084">:=</span>&nbsp;<span class="ident" id="6287087">w</span><span class="op" id="6287088">.</span><span class="ident" id="6287089">WriteString</span><span class="op" id="6287100">(</span><span class="ident" id="6287101">k</span><span class="op" id="6287102">)</span><span class="op" id="6287103">;</span>&nbsp;<span class="ident" id="6287105">err</span>&nbsp;<span class="op" id="6287109">!=</span>&nbsp;<span class="ident" id="6287112">nil</span>&nbsp;<span class="op" id="6287116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287121">return</span>&nbsp;<span class="ident" id="6287128">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287134">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287138">if</span>&nbsp;<span class="ident" id="6287141">_</span><span class="op" id="6287142">,</span>&nbsp;<span class="ident" id="6287144">err</span>&nbsp;<span class="op" id="6287148">:=</span>&nbsp;<span class="ident" id="6287151">w</span><span class="op" id="6287152">.</span><span class="ident" id="6287153">WriteString</span><span class="op" id="6287164">(</span><span class="ident" id="6287165">v</span><span class="op" id="6287166">)</span><span class="op" id="6287167">;</span>&nbsp;<span class="ident" id="6287169">err</span>&nbsp;<span class="op" id="6287173">!=</span>&nbsp;<span class="ident" id="6287176">nil</span>&nbsp;<span class="op" id="6287180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287185">return</span>&nbsp;<span class="ident" id="6287192">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287204">w</span><span class="op" id="6287205">.</span><span class="ident" id="6287206">Close</span><span class="op" id="6287211">(</span><span class="op" id="6287212">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287215">return</span>&nbsp;<span class="ident" id="6287222">nil</span><br>
<span class="lineno"></span><span class="op" id="6287226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6287229">func</span>&nbsp;<span class="ident" id="6287234">readSize</span><span class="op" id="6287242">(</span><span class="ident" id="6287243">s</span>&nbsp;<span class="op" id="6287245">[</span><span class="op" id="6287246">]</span><span class="builtintype" id="6287247">byte</span><span class="op" id="6287251">)</span>&nbsp;<span class="op" id="6287253">(</span><span class="builtintype" id="6287254">uint32</span><span class="op" id="6287260">,</span>&nbsp;<span class="builtintype" id="6287262">int</span><span class="op" id="6287265">)</span>&nbsp;<span class="op" id="6287267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287270">if</span>&nbsp;<span class="builtinfunc" id="6287273">len</span><span class="op" id="6287276">(</span><span class="ident" id="6287277">s</span><span class="op" id="6287278">)</span>&nbsp;<span class="op" id="6287280">==</span>&nbsp;<span class="num" id="6287283">0</span>&nbsp;<span class="op" id="6287285">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287289">return</span>&nbsp;<span class="num" id="6287296">0</span><span class="op" id="6287297">,</span>&nbsp;<span class="num" id="6287299">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287305">size</span><span class="op" id="6287309">,</span>&nbsp;<span class="ident" id="6287311">n</span>&nbsp;<span class="op" id="6287313">:=</span>&nbsp;<span class="builtintype" id="6287316">uint32</span><span class="op" id="6287322">(</span><span class="ident" id="6287323">s</span><span class="op" id="6287324">[</span><span class="num" id="6287325">0</span><span class="op" id="6287326">]</span><span class="op" id="6287327">)</span><span class="op" id="6287328">,</span>&nbsp;<span class="num" id="6287330">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287333">if</span>&nbsp;<span class="ident" id="6287336">size</span><span class="op" id="6287340">&amp;</span><span class="op" id="6287341">(</span><span class="num" id="6287342">1</span><span class="op" id="6287343">&lt;&lt;</span><span class="num" id="6287345">7</span><span class="op" id="6287346">)</span>&nbsp;<span class="op" id="6287348">!=</span>&nbsp;<span class="num" id="6287351">0</span>&nbsp;<span class="op" id="6287353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287357">if</span>&nbsp;<span class="builtinfunc" id="6287360">len</span><span class="op" id="6287363">(</span><span class="ident" id="6287364">s</span><span class="op" id="6287365">)</span>&nbsp;<span class="op" id="6287367">&lt;</span>&nbsp;<span class="num" id="6287369">4</span>&nbsp;<span class="op" id="6287371">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287376">return</span>&nbsp;<span class="num" id="6287383">0</span><span class="op" id="6287384">,</span>&nbsp;<span class="num" id="6287386">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287394">n</span>&nbsp;<span class="op" id="6287396">=</span>&nbsp;<span class="num" id="6287398">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287402">size</span>&nbsp;<span class="op" id="6287407">=</span>&nbsp;<span class="ident" id="6287409">binary</span><span class="op" id="6287415">.</span><span class="ident" id="6287416">BigEndian</span><span class="op" id="6287425">.</span><span class="ident" id="6287426">Uint32</span><span class="op" id="6287432">(</span><span class="ident" id="6287433">s</span><span class="op" id="6287434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287438">size</span>&nbsp;<span class="op" id="6287443">&amp;^=</span>&nbsp;<span class="num" id="6287447">1</span>&nbsp;<span class="op" id="6287449">&lt;&lt;</span>&nbsp;<span class="num" id="6287452">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287459">return</span>&nbsp;<span class="ident" id="6287466">size</span><span class="op" id="6287470">,</span>&nbsp;<span class="ident" id="6287472">n</span><br>
<span class="lineno"></span><span class="op" id="6287474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6287477">func</span>&nbsp;<span class="ident" id="6287482">readString</span><span class="op" id="6287492">(</span><span class="ident" id="6287493">s</span>&nbsp;<span class="op" id="6287495">[</span><span class="op" id="6287496">]</span><span class="builtintype" id="6287497">byte</span><span class="op" id="6287501">,</span>&nbsp;<span class="ident" id="6287503">size</span>&nbsp;<span class="builtintype" id="6287508">uint32</span><span class="op" id="6287514">)</span>&nbsp;<span class="builtintype" id="6287516">string</span>&nbsp;<span class="op" id="6287523">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287526">if</span>&nbsp;<span class="ident" id="6287529">size</span>&nbsp;<span class="op" id="6287534">&gt;</span>&nbsp;<span class="builtintype" id="6287536">uint32</span><span class="op" id="6287542">(</span><span class="builtinfunc" id="6287543">len</span><span class="op" id="6287546">(</span><span class="ident" id="6287547">s</span><span class="op" id="6287548">)</span><span class="op" id="6287549">)</span>&nbsp;<span class="op" id="6287551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287555">return</span>&nbsp;<span class="string" id="6287562">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287569">return</span>&nbsp;<span class="builtintype" id="6287576">string</span><span class="op" id="6287582">(</span><span class="ident" id="6287583">s</span><span class="op" id="6287584">[</span><span class="op" id="6287585">:</span><span class="ident" id="6287586">size</span><span class="op" id="6287590">]</span><span class="op" id="6287591">)</span><br>
<span class="lineno"></span><span class="op" id="6287593">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6287596">func</span>&nbsp;<span class="ident" id="6287601">encodeSize</span><span class="op" id="6287611">(</span><span class="ident" id="6287612">b</span>&nbsp;<span class="op" id="6287614">[</span><span class="op" id="6287615">]</span><span class="builtintype" id="6287616">byte</span><span class="op" id="6287620">,</span>&nbsp;<span class="ident" id="6287622">size</span>&nbsp;<span class="builtintype" id="6287627">uint32</span><span class="op" id="6287633">)</span>&nbsp;<span class="builtintype" id="6287635">int</span>&nbsp;<span class="op" id="6287639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287642">if</span>&nbsp;<span class="ident" id="6287645">size</span>&nbsp;<span class="op" id="6287650">&gt;</span>&nbsp;<span class="num" id="6287652">127</span>&nbsp;<span class="op" id="6287656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287660">size</span>&nbsp;<span class="op" id="6287665">|=</span>&nbsp;<span class="num" id="6287668">1</span>&nbsp;<span class="op" id="6287670">&lt;&lt;</span>&nbsp;<span class="num" id="6287673">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287678">binary</span><span class="op" id="6287684">.</span><span class="ident" id="6287685">BigEndian</span><span class="op" id="6287694">.</span><span class="ident" id="6287695">PutUint32</span><span class="op" id="6287704">(</span><span class="ident" id="6287705">b</span><span class="op" id="6287706">,</span>&nbsp;<span class="ident" id="6287708">size</span><span class="op" id="6287712">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287716">return</span>&nbsp;<span class="num" id="6287723">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287729">b</span><span class="op" id="6287730">[</span><span class="num" id="6287731">0</span><span class="op" id="6287732">]</span>&nbsp;<span class="op" id="6287734">=</span>&nbsp;<span class="builtintype" id="6287736">byte</span><span class="op" id="6287740">(</span><span class="ident" id="6287741">size</span><span class="op" id="6287745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287748">return</span>&nbsp;<span class="num" id="6287755">1</span><br>
<span class="lineno"></span><span class="op" id="6287757">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="6287760">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6287842">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6287853">type</span>&nbsp;<span class="ident" id="6287858">bufWriter</span>&nbsp;<span class="keyword" id="6287868">struct</span>&nbsp;<span class="op" id="6287875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287878">closer</span>&nbsp;<span class="ident" id="6287885">io</span><span class="op" id="6287887">.</span><span class="ident" id="6287888">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287896">*</span><span class="ident" id="6287897">bufio</span><span class="op" id="6287902">.</span><span class="ident" id="6287903">Writer</span><br>
<span class="lineno"></span><span class="op" id="6287910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6287913">func</span>&nbsp;<span class="op" id="6287918">(</span><span class="ident" id="6287919">w</span>&nbsp;<span class="op" id="6287921">*</span><span class="ident" id="6287922">bufWriter</span><span class="op" id="6287931">)</span>&nbsp;<span class="ident" id="6287933">Close</span><span class="op" id="6287938">(</span><span class="op" id="6287939">)</span>&nbsp;<span class="builtintype" id="6287941">error</span>&nbsp;<span class="op" id="6287947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287950">if</span>&nbsp;<span class="ident" id="6287953">err</span>&nbsp;<span class="op" id="6287957">:=</span>&nbsp;<span class="ident" id="6287960">w</span><span class="op" id="6287961">.</span><span class="ident" id="6287962">Writer</span><span class="op" id="6287968">.</span><span class="ident" id="6287969">Flush</span><span class="op" id="6287974">(</span><span class="op" id="6287975">)</span><span class="op" id="6287976">;</span>&nbsp;<span class="ident" id="6287978">err</span>&nbsp;<span class="op" id="6287982">!=</span>&nbsp;<span class="ident" id="6287985">nil</span>&nbsp;<span class="op" id="6287989">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287993">w</span><span class="op" id="6287994">.</span><span class="ident" id="6287995">closer</span><span class="op" id="6288001">.</span><span class="ident" id="6288002">Close</span><span class="op" id="6288007">(</span><span class="op" id="6288008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288012">return</span>&nbsp;<span class="ident" id="6288019">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6288024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288027">return</span>&nbsp;<span class="ident" id="6288034">w</span><span class="op" id="6288035">.</span><span class="ident" id="6288036">closer</span><span class="op" id="6288042">.</span><span class="ident" id="6288043">Close</span><span class="op" id="6288048">(</span><span class="op" id="6288049">)</span><br>
<span class="lineno"></span><span class="op" id="6288051">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="6288054">func</span>&nbsp;<span class="ident" id="6288059">newWriter</span><span class="op" id="6288068">(</span><span class="ident" id="6288069">c</span>&nbsp;<span class="op" id="6288071">*</span><span class="ident" id="6288072">conn</span><span class="op" id="6288076">,</span>&nbsp;<span class="ident" id="6288078">recType</span>&nbsp;<span class="ident" id="6288086">recType</span><span class="op" id="6288093">,</span>&nbsp;<span class="ident" id="6288095">reqId</span>&nbsp;<span class="builtintype" id="6288101">uint16</span><span class="op" id="6288107">)</span>&nbsp;<span class="op" id="6288109">*</span><span class="ident" id="6288110">bufWriter</span>&nbsp;<span class="op" id="6288120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288123">s</span>&nbsp;<span class="op" id="6288125">:=</span>&nbsp;<span class="op" id="6288128">&amp;</span><span class="ident" id="6288129">streamWriter</span><span class="op" id="6288141">{</span><span class="ident" id="6288142">c</span><span class="op" id="6288143">:</span>&nbsp;<span class="ident" id="6288145">c</span><span class="op" id="6288146">,</span>&nbsp;<span class="ident" id="6288148">recType</span><span class="op" id="6288155">:</span>&nbsp;<span class="ident" id="6288157">recType</span><span class="op" id="6288164">,</span>&nbsp;<span class="ident" id="6288166">reqId</span><span class="op" id="6288171">:</span>&nbsp;<span class="ident" id="6288173">reqId</span><span class="op" id="6288178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288181">w</span>&nbsp;<span class="op" id="6288183">:=</span>&nbsp;<span class="ident" id="6288186">bufio</span><span class="op" id="6288191">.</span><span class="ident" id="6288192">NewWriterSize</span><span class="op" id="6288205">(</span><span class="ident" id="6288206">s</span><span class="op" id="6288207">,</span>&nbsp;<span class="ident" id="6288209">maxWrite</span><span class="op" id="6288217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288220">return</span>&nbsp;<span class="op" id="6288227">&amp;</span><span class="ident" id="6288228">bufWriter</span><span class="op" id="6288237">{</span><span class="ident" id="6288238">s</span><span class="op" id="6288239">,</span>&nbsp;<span class="ident" id="6288241">w</span><span class="op" id="6288242">}</span><br>
<span class="lineno">245</span><span class="op" id="6288244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6288247">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="6288327">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="6288371">type</span>&nbsp;<span class="ident" id="6288376">streamWriter</span>&nbsp;<span class="keyword" id="6288389">struct</span>&nbsp;<span class="op" id="6288396">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288399">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6288407">*</span><span class="ident" id="6288408">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288414">recType</span>&nbsp;<span class="ident" id="6288422">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288431">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6288439">uint16</span><br>
<span class="lineno"></span><span class="op" id="6288446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6288449">func</span>&nbsp;<span class="op" id="6288454">(</span><span class="ident" id="6288455">w</span>&nbsp;<span class="op" id="6288457">*</span><span class="ident" id="6288458">streamWriter</span><span class="op" id="6288470">)</span>&nbsp;<span class="ident" id="6288472">Write</span><span class="op" id="6288477">(</span><span class="ident" id="6288478">p</span>&nbsp;<span class="op" id="6288480">[</span><span class="op" id="6288481">]</span><span class="builtintype" id="6288482">byte</span><span class="op" id="6288486">)</span>&nbsp;<span class="op" id="6288488">(</span><span class="builtintype" id="6288489">int</span><span class="op" id="6288492">,</span>&nbsp;<span class="builtintype" id="6288494">error</span><span class="op" id="6288499">)</span>&nbsp;<span class="op" id="6288501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288504">nn</span>&nbsp;<span class="op" id="6288507">:=</span>&nbsp;<span class="num" id="6288510">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288513">for</span>&nbsp;<span class="builtinfunc" id="6288517">len</span><span class="op" id="6288520">(</span><span class="ident" id="6288521">p</span><span class="op" id="6288522">)</span>&nbsp;<span class="op" id="6288524">&gt;</span>&nbsp;<span class="num" id="6288526">0</span>&nbsp;<span class="op" id="6288528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288532">n</span>&nbsp;<span class="op" id="6288534">:=</span>&nbsp;<span class="builtinfunc" id="6288537">len</span><span class="op" id="6288540">(</span><span class="ident" id="6288541">p</span><span class="op" id="6288542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288546">if</span>&nbsp;<span class="ident" id="6288549">n</span>&nbsp;<span class="op" id="6288551">&gt;</span>&nbsp;<span class="ident" id="6288553">maxWrite</span>&nbsp;<span class="op" id="6288562">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288567">n</span>&nbsp;<span class="op" id="6288569">=</span>&nbsp;<span class="ident" id="6288571">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6288582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288586">if</span>&nbsp;<span class="ident" id="6288589">err</span>&nbsp;<span class="op" id="6288593">:=</span>&nbsp;<span class="ident" id="6288596">w</span><span class="op" id="6288597">.</span><span class="ident" id="6288598">c</span><span class="op" id="6288599">.</span><span class="ident" id="6288600">writeRecord</span><span class="op" id="6288611">(</span><span class="ident" id="6288612">w</span><span class="op" id="6288613">.</span><span class="ident" id="6288614">recType</span><span class="op" id="6288621">,</span>&nbsp;<span class="ident" id="6288623">w</span><span class="op" id="6288624">.</span><span class="ident" id="6288625">reqId</span><span class="op" id="6288630">,</span>&nbsp;<span class="ident" id="6288632">p</span><span class="op" id="6288633">[</span><span class="op" id="6288634">:</span><span class="ident" id="6288635">n</span><span class="op" id="6288636">]</span><span class="op" id="6288637">)</span><span class="op" id="6288638">;</span>&nbsp;<span class="ident" id="6288640">err</span>&nbsp;<span class="op" id="6288644">!=</span>&nbsp;<span class="ident" id="6288647">nil</span>&nbsp;<span class="op" id="6288651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288656">return</span>&nbsp;<span class="ident" id="6288663">nn</span><span class="op" id="6288665">,</span>&nbsp;<span class="ident" id="6288667">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6288673">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288677">nn</span>&nbsp;<span class="op" id="6288680">+=</span>&nbsp;<span class="ident" id="6288683">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288687">p</span>&nbsp;<span class="op" id="6288689">=</span>&nbsp;<span class="ident" id="6288691">p</span><span class="op" id="6288692">[</span><span class="ident" id="6288693">n</span><span class="op" id="6288694">:</span><span class="op" id="6288695">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6288698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288701">return</span>&nbsp;<span class="ident" id="6288708">nn</span><span class="op" id="6288710">,</span>&nbsp;<span class="ident" id="6288712">nil</span><br>
<span class="lineno"></span><span class="op" id="6288716">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6288719">func</span>&nbsp;<span class="op" id="6288724">(</span><span class="ident" id="6288725">w</span>&nbsp;<span class="op" id="6288727">*</span><span class="ident" id="6288728">streamWriter</span><span class="op" id="6288740">)</span>&nbsp;<span class="ident" id="6288742">Close</span><span class="op" id="6288747">(</span><span class="op" id="6288748">)</span>&nbsp;<span class="builtintype" id="6288750">error</span>&nbsp;<span class="op" id="6288756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6288759">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288801">return</span>&nbsp;<span class="ident" id="6288808">w</span><span class="op" id="6288809">.</span><span class="ident" id="6288810">c</span><span class="op" id="6288811">.</span><span class="ident" id="6288812">writeRecord</span><span class="op" id="6288823">(</span><span class="ident" id="6288824">w</span><span class="op" id="6288825">.</span><span class="ident" id="6288826">recType</span><span class="op" id="6288833">,</span>&nbsp;<span class="ident" id="6288835">w</span><span class="op" id="6288836">.</span><span class="ident" id="6288837">reqId</span><span class="op" id="6288842">,</span>&nbsp;<span class="ident" id="6288844">nil</span><span class="op" id="6288847">)</span><br>
<span class="lineno"></span><span class="op" id="6288849">}</span>
</div>
</body>
</html>
