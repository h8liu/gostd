<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1657611">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1657666">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1657720">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1657771">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1657814">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1657860">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="1657912">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="1657952">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="1658003">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1658041">//</span><br>
<span class="lineno"></span><span class="comment" id="1658044">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="1658092">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1658148">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="1658205">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="1658268">//</span><br>
<span class="lineno"></span><span class="comment" id="1658271">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="1658323">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1658358">package</span>&nbsp;<span class="ident" id="1658366">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1658375">import</span>&nbsp;<span class="string" id="1658382">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1658392">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1658435">type</span>&nbsp;<span class="ident" id="1658440">semaRoot</span>&nbsp;<span class="keyword" id="1658449">struct</span>&nbsp;<span class="op" id="1658456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658459">lock</span>&nbsp;&nbsp;<span class="ident" id="1658465">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658472">head</span>&nbsp;&nbsp;<span class="op" id="1658478">*</span><span class="ident" id="1658479">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658486">tail</span>&nbsp;&nbsp;<span class="op" id="1658492">*</span><span class="ident" id="1658493">sudog</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658500">nwait</span>&nbsp;<span class="builtintype" id="1658506">uint32</span>&nbsp;<span class="comment" id="1658513">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="1658554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1658557">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="1658607">const</span>&nbsp;<span class="ident" id="1658613">semTabSize</span>&nbsp;<span class="op" id="1658624">=</span>&nbsp;<span class="num" id="1658626">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1658631">var</span>&nbsp;<span class="ident" id="1658635">semtable</span>&nbsp;<span class="op" id="1658644">[</span><span class="ident" id="1658645">semTabSize</span><span class="op" id="1658655">]</span><span class="keyword" id="1658656">struct</span>&nbsp;<span class="op" id="1658663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658666">root</span>&nbsp;<span class="ident" id="1658671">semaRoot</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658681">pad</span>&nbsp;&nbsp;<span class="op" id="1658686">[</span><span class="ident" id="1658687">_CacheLineSize</span>&nbsp;<span class="op" id="1658702">-</span>&nbsp;<span class="ident" id="1658704">unsafe</span><span class="op" id="1658710">.</span><span class="ident" id="1658711">Sizeof</span><span class="op" id="1658717">(</span><span class="ident" id="1658718">semaRoot</span><span class="op" id="1658726">{</span><span class="op" id="1658727">}</span><span class="op" id="1658728">)</span><span class="op" id="1658729">]</span><span class="builtintype" id="1658730">byte</span><br>
<span class="lineno"></span><span class="op" id="1658735">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1658738">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="1658772">func</span>&nbsp;<span class="ident" id="1658777">asyncsemacquire</span><span class="op" id="1658792">(</span><span class="ident" id="1658793">addr</span>&nbsp;<span class="op" id="1658798">*</span><span class="builtintype" id="1658799">uint32</span><span class="op" id="1658805">)</span>&nbsp;<span class="op" id="1658807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658810">semacquire</span><span class="op" id="1658820">(</span><span class="ident" id="1658821">addr</span><span class="op" id="1658825">,</span>&nbsp;<span class="builtintype" id="1658827">true</span><span class="op" id="1658831">)</span><br>
<span class="lineno"></span><span class="op" id="1658833">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="1658836">func</span>&nbsp;<span class="ident" id="1658841">asyncsemrelease</span><span class="op" id="1658856">(</span><span class="ident" id="1658857">addr</span>&nbsp;<span class="op" id="1658862">*</span><span class="builtintype" id="1658863">uint32</span><span class="op" id="1658869">)</span>&nbsp;<span class="op" id="1658871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658874">semrelease</span><span class="op" id="1658884">(</span><span class="ident" id="1658885">addr</span><span class="op" id="1658889">)</span><br>
<span class="lineno"></span><span class="op" id="1658891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1658894">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1658918">func</span>&nbsp;<span class="ident" id="1658923">semacquire</span><span class="op" id="1658933">(</span><span class="ident" id="1658934">addr</span>&nbsp;<span class="op" id="1658939">*</span><span class="builtintype" id="1658940">uint32</span><span class="op" id="1658946">,</span>&nbsp;<span class="ident" id="1658948">profile</span>&nbsp;<span class="builtintype" id="1658956">bool</span><span class="op" id="1658960">)</span>&nbsp;<span class="op" id="1658962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1658965">gp</span>&nbsp;<span class="op" id="1658968">:=</span>&nbsp;<span class="ident" id="1658971">getg</span><span class="op" id="1658975">(</span><span class="op" id="1658976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1658979">if</span>&nbsp;<span class="ident" id="1658982">gp</span>&nbsp;<span class="op" id="1658985">!=</span>&nbsp;<span class="ident" id="1658988">gp</span><span class="op" id="1658990">.</span><span class="ident" id="1658991">m</span><span class="op" id="1658992">.</span><span class="ident" id="1658993">curg</span>&nbsp;<span class="op" id="1658998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659002">gothrow</span><span class="op" id="1659009">(</span><span class="string" id="1659010">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="1659041">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659048">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659063">if</span>&nbsp;<span class="ident" id="1659066">cansemacquire</span><span class="op" id="1659079">(</span><span class="ident" id="1659080">addr</span><span class="op" id="1659084">)</span>&nbsp;<span class="op" id="1659086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659090">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659102">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659119">//&nbsp;&nbsp;&nbsp;&nbspincrement&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659146">//&nbsp;&nbsp;&nbsp;&nbsptry&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659203">//&nbsp;&nbsp;&nbsp;&nbspenqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659234">//&nbsp;&nbsp;&nbsp;&nbspsleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659244">//&nbsp;&nbsp;&nbsp;&nbsp(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659292">s</span>&nbsp;<span class="op" id="1659294">:=</span>&nbsp;<span class="ident" id="1659297">acquireSudog</span><span class="op" id="1659309">(</span><span class="op" id="1659310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659313">root</span>&nbsp;<span class="op" id="1659318">:=</span>&nbsp;<span class="ident" id="1659321">semroot</span><span class="op" id="1659328">(</span><span class="ident" id="1659329">addr</span><span class="op" id="1659333">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659336">t0</span>&nbsp;<span class="op" id="1659339">:=</span>&nbsp;<span class="ident" id="1659342">int64</span><span class="op" id="1659347">(</span><span class="num" id="1659348">0</span><span class="op" id="1659349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659352">s</span><span class="op" id="1659353">.</span><span class="ident" id="1659354">releasetime</span>&nbsp;<span class="op" id="1659366">=</span>&nbsp;<span class="num" id="1659368">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659371">if</span>&nbsp;<span class="ident" id="1659374">profile</span>&nbsp;<span class="op" id="1659382">&amp;&amp;</span>&nbsp;<span class="ident" id="1659385">blockprofilerate</span>&nbsp;<span class="op" id="1659402">&gt;</span>&nbsp;<span class="num" id="1659404">0</span>&nbsp;<span class="op" id="1659406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659410">t0</span>&nbsp;<span class="op" id="1659413">=</span>&nbsp;<span class="ident" id="1659415">cputicks</span><span class="op" id="1659423">(</span><span class="op" id="1659424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659428">s</span><span class="op" id="1659429">.</span><span class="ident" id="1659430">releasetime</span>&nbsp;<span class="op" id="1659442">=</span>&nbsp;<span class="op" id="1659444">-</span><span class="num" id="1659445">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659451">for</span>&nbsp;<span class="op" id="1659455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659459">lock</span><span class="op" id="1659463">(</span><span class="op" id="1659464">&amp;</span><span class="ident" id="1659465">root</span><span class="op" id="1659469">.</span><span class="ident" id="1659470">lock</span><span class="op" id="1659474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659478">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659544">xadd</span><span class="op" id="1659548">(</span><span class="op" id="1659549">&amp;</span><span class="ident" id="1659550">root</span><span class="op" id="1659554">.</span><span class="ident" id="1659555">nwait</span><span class="op" id="1659560">,</span>&nbsp;<span class="num" id="1659562">1</span><span class="op" id="1659563">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659567">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659616">if</span>&nbsp;<span class="ident" id="1659619">cansemacquire</span><span class="op" id="1659632">(</span><span class="ident" id="1659633">addr</span><span class="op" id="1659637">)</span>&nbsp;<span class="op" id="1659639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659644">xadd</span><span class="op" id="1659648">(</span><span class="op" id="1659649">&amp;</span><span class="ident" id="1659650">root</span><span class="op" id="1659654">.</span><span class="ident" id="1659655">nwait</span><span class="op" id="1659660">,</span>&nbsp;<span class="op" id="1659662">-</span><span class="num" id="1659663">1</span><span class="op" id="1659664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659669">unlock</span><span class="op" id="1659675">(</span><span class="op" id="1659676">&amp;</span><span class="ident" id="1659677">root</span><span class="op" id="1659681">.</span><span class="ident" id="1659682">lock</span><span class="op" id="1659686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659691">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659703">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1659767">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659810">root</span><span class="op" id="1659814">.</span><span class="ident" id="1659815">queue</span><span class="op" id="1659820">(</span><span class="ident" id="1659821">addr</span><span class="op" id="1659825">,</span>&nbsp;<span class="ident" id="1659827">s</span><span class="op" id="1659828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659832">goparkunlock</span><span class="op" id="1659844">(</span><span class="op" id="1659845">&amp;</span><span class="ident" id="1659846">root</span><span class="op" id="1659850">.</span><span class="ident" id="1659851">lock</span><span class="op" id="1659855">,</span>&nbsp;<span class="string" id="1659857">&#34;semacquire&#34;</span><span class="op" id="1659869">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659873">if</span>&nbsp;<span class="ident" id="1659876">cansemacquire</span><span class="op" id="1659889">(</span><span class="ident" id="1659890">addr</span><span class="op" id="1659894">)</span>&nbsp;<span class="op" id="1659896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659901">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1659915">if</span>&nbsp;<span class="ident" id="1659918">s</span><span class="op" id="1659919">.</span><span class="ident" id="1659920">releasetime</span>&nbsp;<span class="op" id="1659932">&gt;</span>&nbsp;<span class="num" id="1659934">0</span>&nbsp;<span class="op" id="1659936">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659940">blockevent</span><span class="op" id="1659950">(</span><span class="ident" id="1659951">int64</span><span class="op" id="1659956">(</span><span class="ident" id="1659957">s</span><span class="op" id="1659958">.</span><span class="ident" id="1659959">releasetime</span><span class="op" id="1659970">)</span><span class="op" id="1659971">-</span><span class="ident" id="1659972">t0</span><span class="op" id="1659974">,</span>&nbsp;<span class="num" id="1659976">3</span><span class="op" id="1659977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1659980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1659983">releaseSudog</span><span class="op" id="1659995">(</span><span class="ident" id="1659996">s</span><span class="op" id="1659997">)</span><br>
<span class="lineno"></span><span class="op" id="1659999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1660002">func</span>&nbsp;<span class="ident" id="1660007">semrelease</span><span class="op" id="1660017">(</span><span class="ident" id="1660018">addr</span>&nbsp;<span class="op" id="1660023">*</span><span class="builtintype" id="1660024">uint32</span><span class="op" id="1660030">)</span>&nbsp;<span class="op" id="1660032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660035">root</span>&nbsp;<span class="op" id="1660040">:=</span>&nbsp;<span class="ident" id="1660043">semroot</span><span class="op" id="1660050">(</span><span class="ident" id="1660051">addr</span><span class="op" id="1660055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660058">xadd</span><span class="op" id="1660062">(</span><span class="ident" id="1660063">addr</span><span class="op" id="1660067">,</span>&nbsp;<span class="num" id="1660069">1</span><span class="op" id="1660070">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1660074">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1660101">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1660169">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660199">if</span>&nbsp;<span class="ident" id="1660202">atomicload</span><span class="op" id="1660212">(</span><span class="op" id="1660213">&amp;</span><span class="ident" id="1660214">root</span><span class="op" id="1660218">.</span><span class="ident" id="1660219">nwait</span><span class="op" id="1660224">)</span>&nbsp;<span class="op" id="1660226">==</span>&nbsp;<span class="num" id="1660229">0</span>&nbsp;<span class="op" id="1660231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660235">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1660243">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1660247">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660297">lock</span><span class="op" id="1660301">(</span><span class="op" id="1660302">&amp;</span><span class="ident" id="1660303">root</span><span class="op" id="1660307">.</span><span class="ident" id="1660308">lock</span><span class="op" id="1660312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660315">if</span>&nbsp;<span class="ident" id="1660318">atomicload</span><span class="op" id="1660328">(</span><span class="op" id="1660329">&amp;</span><span class="ident" id="1660330">root</span><span class="op" id="1660334">.</span><span class="ident" id="1660335">nwait</span><span class="op" id="1660340">)</span>&nbsp;<span class="op" id="1660342">==</span>&nbsp;<span class="num" id="1660345">0</span>&nbsp;<span class="op" id="1660347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1660351">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1660408">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660454">unlock</span><span class="op" id="1660460">(</span><span class="op" id="1660461">&amp;</span><span class="ident" id="1660462">root</span><span class="op" id="1660466">.</span><span class="ident" id="1660467">lock</span><span class="op" id="1660471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660475">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1660483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660486">s</span>&nbsp;<span class="op" id="1660488">:=</span>&nbsp;<span class="ident" id="1660491">root</span><span class="op" id="1660495">.</span><span class="ident" id="1660496">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660502">for</span>&nbsp;<span class="op" id="1660506">;</span>&nbsp;<span class="ident" id="1660508">s</span>&nbsp;<span class="op" id="1660510">!=</span>&nbsp;<span class="ident" id="1660513">nil</span><span class="op" id="1660516">;</span>&nbsp;<span class="ident" id="1660518">s</span>&nbsp;<span class="op" id="1660520">=</span>&nbsp;<span class="ident" id="1660522">s</span><span class="op" id="1660523">.</span><span class="ident" id="1660524">next</span>&nbsp;<span class="op" id="1660529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660533">if</span>&nbsp;<span class="ident" id="1660536">s</span><span class="op" id="1660537">.</span><span class="ident" id="1660538">elem</span>&nbsp;<span class="op" id="1660543">==</span>&nbsp;<span class="ident" id="1660546">unsafe</span><span class="op" id="1660552">.</span><span class="ident" id="1660553">Pointer</span><span class="op" id="1660560">(</span><span class="ident" id="1660561">addr</span><span class="op" id="1660565">)</span>&nbsp;<span class="op" id="1660567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660572">xadd</span><span class="op" id="1660576">(</span><span class="op" id="1660577">&amp;</span><span class="ident" id="1660578">root</span><span class="op" id="1660582">.</span><span class="ident" id="1660583">nwait</span><span class="op" id="1660588">,</span>&nbsp;<span class="op" id="1660590">-</span><span class="num" id="1660591">1</span><span class="op" id="1660592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660597">root</span><span class="op" id="1660601">.</span><span class="ident" id="1660602">dequeue</span><span class="op" id="1660609">(</span><span class="ident" id="1660610">s</span><span class="op" id="1660611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660616">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1660624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1660627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660630">unlock</span><span class="op" id="1660636">(</span><span class="op" id="1660637">&amp;</span><span class="ident" id="1660638">root</span><span class="op" id="1660642">.</span><span class="ident" id="1660643">lock</span><span class="op" id="1660647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660650">if</span>&nbsp;<span class="ident" id="1660653">s</span>&nbsp;<span class="op" id="1660655">!=</span>&nbsp;<span class="ident" id="1660658">nil</span>&nbsp;<span class="op" id="1660662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660666">if</span>&nbsp;<span class="ident" id="1660669">s</span><span class="op" id="1660670">.</span><span class="ident" id="1660671">releasetime</span>&nbsp;<span class="op" id="1660683">!=</span>&nbsp;<span class="num" id="1660686">0</span>&nbsp;<span class="op" id="1660688">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660693">s</span><span class="op" id="1660694">.</span><span class="ident" id="1660695">releasetime</span>&nbsp;<span class="op" id="1660707">=</span>&nbsp;<span class="ident" id="1660709">cputicks</span><span class="op" id="1660717">(</span><span class="op" id="1660718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1660722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660726">goready</span><span class="op" id="1660733">(</span><span class="ident" id="1660734">s</span><span class="op" id="1660735">.</span><span class="ident" id="1660736">g</span><span class="op" id="1660737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1660740">}</span><br>
<span class="lineno"></span><span class="op" id="1660742">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1660745">func</span>&nbsp;<span class="ident" id="1660750">semroot</span><span class="op" id="1660757">(</span><span class="ident" id="1660758">addr</span>&nbsp;<span class="op" id="1660763">*</span><span class="builtintype" id="1660764">uint32</span><span class="op" id="1660770">)</span>&nbsp;<span class="op" id="1660772">*</span><span class="ident" id="1660773">semaRoot</span>&nbsp;<span class="op" id="1660782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660785">return</span>&nbsp;<span class="op" id="1660792">&amp;</span><span class="ident" id="1660793">semtable</span><span class="op" id="1660801">[</span><span class="op" id="1660802">(</span><span class="builtintype" id="1660803">uintptr</span><span class="op" id="1660810">(</span><span class="ident" id="1660811">unsafe</span><span class="op" id="1660817">.</span><span class="ident" id="1660818">Pointer</span><span class="op" id="1660825">(</span><span class="ident" id="1660826">addr</span><span class="op" id="1660830">)</span><span class="op" id="1660831">)</span><span class="op" id="1660832">&gt;&gt;</span><span class="num" id="1660834">3</span><span class="op" id="1660835">)</span><span class="op" id="1660836">%</span><span class="ident" id="1660837">semTabSize</span><span class="op" id="1660847">]</span><span class="op" id="1660848">.</span><span class="ident" id="1660849">root</span><br>
<span class="lineno"></span><span class="op" id="1660854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1660857">func</span>&nbsp;<span class="ident" id="1660862">cansemacquire</span><span class="op" id="1660875">(</span><span class="ident" id="1660876">addr</span>&nbsp;<span class="op" id="1660881">*</span><span class="builtintype" id="1660882">uint32</span><span class="op" id="1660888">)</span>&nbsp;<span class="builtintype" id="1660890">bool</span>&nbsp;<span class="op" id="1660895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660898">for</span>&nbsp;<span class="op" id="1660902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1660906">v</span>&nbsp;<span class="op" id="1660908">:=</span>&nbsp;<span class="ident" id="1660911">atomicload</span><span class="op" id="1660921">(</span><span class="ident" id="1660922">addr</span><span class="op" id="1660926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660930">if</span>&nbsp;<span class="ident" id="1660933">v</span>&nbsp;<span class="op" id="1660935">==</span>&nbsp;<span class="num" id="1660938">0</span>&nbsp;<span class="op" id="1660940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660945">return</span>&nbsp;<span class="builtintype" id="1660952">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1660960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660964">if</span>&nbsp;<span class="ident" id="1660967">cas</span><span class="op" id="1660970">(</span><span class="ident" id="1660971">addr</span><span class="op" id="1660975">,</span>&nbsp;<span class="ident" id="1660977">v</span><span class="op" id="1660978">,</span>&nbsp;<span class="ident" id="1660980">v</span><span class="op" id="1660981">-</span><span class="num" id="1660982">1</span><span class="op" id="1660983">)</span>&nbsp;<span class="op" id="1660985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1660990">return</span>&nbsp;<span class="builtintype" id="1660997">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1661004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1661007">}</span><br>
<span class="lineno">150</span><span class="op" id="1661009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1661012">func</span>&nbsp;<span class="op" id="1661017">(</span><span class="ident" id="1661018">root</span>&nbsp;<span class="op" id="1661023">*</span><span class="ident" id="1661024">semaRoot</span><span class="op" id="1661032">)</span>&nbsp;<span class="ident" id="1661034">queue</span><span class="op" id="1661039">(</span><span class="ident" id="1661040">addr</span>&nbsp;<span class="op" id="1661045">*</span><span class="builtintype" id="1661046">uint32</span><span class="op" id="1661052">,</span>&nbsp;<span class="ident" id="1661054">s</span>&nbsp;<span class="op" id="1661056">*</span><span class="ident" id="1661057">sudog</span><span class="op" id="1661062">)</span>&nbsp;<span class="op" id="1661064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661067">s</span><span class="op" id="1661068">.</span><span class="ident" id="1661069">g</span>&nbsp;<span class="op" id="1661071">=</span>&nbsp;<span class="ident" id="1661073">getg</span><span class="op" id="1661077">(</span><span class="op" id="1661078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661081">s</span><span class="op" id="1661082">.</span><span class="ident" id="1661083">elem</span>&nbsp;<span class="op" id="1661088">=</span>&nbsp;<span class="ident" id="1661090">unsafe</span><span class="op" id="1661096">.</span><span class="ident" id="1661097">Pointer</span><span class="op" id="1661104">(</span><span class="ident" id="1661105">addr</span><span class="op" id="1661109">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661112">s</span><span class="op" id="1661113">.</span><span class="ident" id="1661114">next</span>&nbsp;<span class="op" id="1661119">=</span>&nbsp;<span class="ident" id="1661121">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661126">s</span><span class="op" id="1661127">.</span><span class="ident" id="1661128">prev</span>&nbsp;<span class="op" id="1661133">=</span>&nbsp;<span class="ident" id="1661135">root</span><span class="op" id="1661139">.</span><span class="ident" id="1661140">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1661146">if</span>&nbsp;<span class="ident" id="1661149">root</span><span class="op" id="1661153">.</span><span class="ident" id="1661154">tail</span>&nbsp;<span class="op" id="1661159">!=</span>&nbsp;<span class="ident" id="1661162">nil</span>&nbsp;<span class="op" id="1661166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661170">root</span><span class="op" id="1661174">.</span><span class="ident" id="1661175">tail</span><span class="op" id="1661179">.</span><span class="ident" id="1661180">next</span>&nbsp;<span class="op" id="1661185">=</span>&nbsp;<span class="ident" id="1661187">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1661190">}</span>&nbsp;<span class="keyword" id="1661192">else</span>&nbsp;<span class="op" id="1661197">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661201">root</span><span class="op" id="1661205">.</span><span class="ident" id="1661206">head</span>&nbsp;<span class="op" id="1661211">=</span>&nbsp;<span class="ident" id="1661213">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1661216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661219">root</span><span class="op" id="1661223">.</span><span class="ident" id="1661224">tail</span>&nbsp;<span class="op" id="1661229">=</span>&nbsp;<span class="ident" id="1661231">s</span><br>
<span class="lineno"></span><span class="op" id="1661233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="1661236">func</span>&nbsp;<span class="op" id="1661241">(</span><span class="ident" id="1661242">root</span>&nbsp;<span class="op" id="1661247">*</span><span class="ident" id="1661248">semaRoot</span><span class="op" id="1661256">)</span>&nbsp;<span class="ident" id="1661258">dequeue</span><span class="op" id="1661265">(</span><span class="ident" id="1661266">s</span>&nbsp;<span class="op" id="1661268">*</span><span class="ident" id="1661269">sudog</span><span class="op" id="1661274">)</span>&nbsp;<span class="op" id="1661276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1661279">if</span>&nbsp;<span class="ident" id="1661282">s</span><span class="op" id="1661283">.</span><span class="ident" id="1661284">next</span>&nbsp;<span class="op" id="1661289">!=</span>&nbsp;<span class="ident" id="1661292">nil</span>&nbsp;<span class="op" id="1661296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661300">s</span><span class="op" id="1661301">.</span><span class="ident" id="1661302">next</span><span class="op" id="1661306">.</span><span class="ident" id="1661307">prev</span>&nbsp;<span class="op" id="1661312">=</span>&nbsp;<span class="ident" id="1661314">s</span><span class="op" id="1661315">.</span><span class="ident" id="1661316">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1661322">}</span>&nbsp;<span class="keyword" id="1661324">else</span>&nbsp;<span class="op" id="1661329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661333">root</span><span class="op" id="1661337">.</span><span class="ident" id="1661338">tail</span>&nbsp;<span class="op" id="1661343">=</span>&nbsp;<span class="ident" id="1661345">s</span><span class="op" id="1661346">.</span><span class="ident" id="1661347">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1661353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1661356">if</span>&nbsp;<span class="ident" id="1661359">s</span><span class="op" id="1661360">.</span><span class="ident" id="1661361">prev</span>&nbsp;<span class="op" id="1661366">!=</span>&nbsp;<span class="ident" id="1661369">nil</span>&nbsp;<span class="op" id="1661373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661377">s</span><span class="op" id="1661378">.</span><span class="ident" id="1661379">prev</span><span class="op" id="1661383">.</span><span class="ident" id="1661384">next</span>&nbsp;<span class="op" id="1661389">=</span>&nbsp;<span class="ident" id="1661391">s</span><span class="op" id="1661392">.</span><span class="ident" id="1661393">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1661399">}</span>&nbsp;<span class="keyword" id="1661401">else</span>&nbsp;<span class="op" id="1661406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661410">root</span><span class="op" id="1661414">.</span><span class="ident" id="1661415">head</span>&nbsp;<span class="op" id="1661420">=</span>&nbsp;<span class="ident" id="1661422">s</span><span class="op" id="1661423">.</span><span class="ident" id="1661424">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1661430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661433">s</span><span class="op" id="1661434">.</span><span class="ident" id="1661435">elem</span>&nbsp;<span class="op" id="1661440">=</span>&nbsp;<span class="ident" id="1661442">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661447">s</span><span class="op" id="1661448">.</span><span class="ident" id="1661449">next</span>&nbsp;<span class="op" id="1661454">=</span>&nbsp;<span class="ident" id="1661456">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661461">s</span><span class="op" id="1661462">.</span><span class="ident" id="1661463">prev</span>&nbsp;<span class="op" id="1661468">=</span>&nbsp;<span class="ident" id="1661470">nil</span><br>
<span class="lineno"></span><span class="op" id="1661474">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="1661477">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="1661517">type</span>&nbsp;<span class="ident" id="1661522">syncSema</span>&nbsp;<span class="keyword" id="1661531">struct</span>&nbsp;<span class="op" id="1661538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661541">lock</span>&nbsp;<span class="ident" id="1661546">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661553">head</span>&nbsp;<span class="op" id="1661558">*</span><span class="ident" id="1661559">sudog</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661566">tail</span>&nbsp;<span class="op" id="1661571">*</span><span class="ident" id="1661572">sudog</span><br>
<span class="lineno"></span><span class="op" id="1661578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1661581">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1661659">func</span>&nbsp;<span class="ident" id="1661664">syncsemacquire</span><span class="op" id="1661678">(</span><span class="ident" id="1661679">s</span>&nbsp;<span class="op" id="1661681">*</span><span class="ident" id="1661682">syncSema</span><span class="op" id="1661690">)</span>&nbsp;<span class="op" id="1661692">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661695">lock</span><span class="op" id="1661699">(</span><span class="op" id="1661700">&amp;</span><span class="ident" id="1661701">s</span><span class="op" id="1661702">.</span><span class="ident" id="1661703">lock</span><span class="op" id="1661707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1661710">if</span>&nbsp;<span class="ident" id="1661713">s</span><span class="op" id="1661714">.</span><span class="ident" id="1661715">head</span>&nbsp;<span class="op" id="1661720">!=</span>&nbsp;<span class="ident" id="1661723">nil</span>&nbsp;<span class="op" id="1661727">&amp;&amp;</span>&nbsp;<span class="ident" id="1661730">s</span><span class="op" id="1661731">.</span><span class="ident" id="1661732">head</span><span class="op" id="1661736">.</span><span class="ident" id="1661737">nrelease</span>&nbsp;<span class="op" id="1661746">&gt;</span>&nbsp;<span class="num" id="1661748">0</span>&nbsp;<span class="op" id="1661750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1661754">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1661793">var</span>&nbsp;<span class="ident" id="1661797">wake</span>&nbsp;<span class="op" id="1661802">*</span><span class="ident" id="1661803">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661811">s</span><span class="op" id="1661812">.</span><span class="ident" id="1661813">head</span><span class="op" id="1661817">.</span><span class="ident" id="1661818">nrelease</span><span class="op" id="1661826">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1661831">if</span>&nbsp;<span class="ident" id="1661834">s</span><span class="op" id="1661835">.</span><span class="ident" id="1661836">head</span><span class="op" id="1661840">.</span><span class="ident" id="1661841">nrelease</span>&nbsp;<span class="op" id="1661850">==</span>&nbsp;<span class="num" id="1661853">0</span>&nbsp;<span class="op" id="1661855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661860">wake</span>&nbsp;<span class="op" id="1661865">=</span>&nbsp;<span class="ident" id="1661867">s</span><span class="op" id="1661868">.</span><span class="ident" id="1661869">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661877">s</span><span class="op" id="1661878">.</span><span class="ident" id="1661879">head</span>&nbsp;<span class="op" id="1661884">=</span>&nbsp;<span class="ident" id="1661886">wake</span><span class="op" id="1661890">.</span><span class="ident" id="1661891">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1661899">if</span>&nbsp;<span class="ident" id="1661902">s</span><span class="op" id="1661903">.</span><span class="ident" id="1661904">head</span>&nbsp;<span class="op" id="1661909">==</span>&nbsp;<span class="ident" id="1661912">nil</span>&nbsp;<span class="op" id="1661916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661922">s</span><span class="op" id="1661923">.</span><span class="ident" id="1661924">tail</span>&nbsp;<span class="op" id="1661929">=</span>&nbsp;<span class="ident" id="1661931">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1661938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1661942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661946">unlock</span><span class="op" id="1661952">(</span><span class="op" id="1661953">&amp;</span><span class="ident" id="1661954">s</span><span class="op" id="1661955">.</span><span class="ident" id="1661956">lock</span><span class="op" id="1661960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1661964">if</span>&nbsp;<span class="ident" id="1661967">wake</span>&nbsp;<span class="op" id="1661972">!=</span>&nbsp;<span class="ident" id="1661975">nil</span>&nbsp;<span class="op" id="1661979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661984">wake</span><span class="op" id="1661988">.</span><span class="ident" id="1661989">next</span>&nbsp;<span class="op" id="1661994">=</span>&nbsp;<span class="ident" id="1661996">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662003">goready</span><span class="op" id="1662010">(</span><span class="ident" id="1662011">wake</span><span class="op" id="1662015">.</span><span class="ident" id="1662016">g</span><span class="op" id="1662017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662024">}</span>&nbsp;<span class="keyword" id="1662026">else</span>&nbsp;<span class="op" id="1662031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1662035">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662056">w</span>&nbsp;<span class="op" id="1662058">:=</span>&nbsp;<span class="ident" id="1662061">acquireSudog</span><span class="op" id="1662073">(</span><span class="op" id="1662074">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662078">w</span><span class="op" id="1662079">.</span><span class="ident" id="1662080">g</span>&nbsp;<span class="op" id="1662082">=</span>&nbsp;<span class="ident" id="1662084">getg</span><span class="op" id="1662088">(</span><span class="op" id="1662089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662093">w</span><span class="op" id="1662094">.</span><span class="ident" id="1662095">nrelease</span>&nbsp;<span class="op" id="1662104">=</span>&nbsp;<span class="op" id="1662106">-</span><span class="num" id="1662107">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662111">w</span><span class="op" id="1662112">.</span><span class="ident" id="1662113">next</span>&nbsp;<span class="op" id="1662118">=</span>&nbsp;<span class="ident" id="1662120">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662126">w</span><span class="op" id="1662127">.</span><span class="ident" id="1662128">releasetime</span>&nbsp;<span class="op" id="1662140">=</span>&nbsp;<span class="num" id="1662142">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662146">t0</span>&nbsp;<span class="op" id="1662149">:=</span>&nbsp;<span class="ident" id="1662152">int64</span><span class="op" id="1662157">(</span><span class="num" id="1662158">0</span><span class="op" id="1662159">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662163">if</span>&nbsp;<span class="ident" id="1662166">blockprofilerate</span>&nbsp;<span class="op" id="1662183">&gt;</span>&nbsp;<span class="num" id="1662185">0</span>&nbsp;<span class="op" id="1662187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662192">t0</span>&nbsp;<span class="op" id="1662195">=</span>&nbsp;<span class="ident" id="1662197">cputicks</span><span class="op" id="1662205">(</span><span class="op" id="1662206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662211">w</span><span class="op" id="1662212">.</span><span class="ident" id="1662213">releasetime</span>&nbsp;<span class="op" id="1662225">=</span>&nbsp;<span class="op" id="1662227">-</span><span class="num" id="1662228">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662236">if</span>&nbsp;<span class="ident" id="1662239">s</span><span class="op" id="1662240">.</span><span class="ident" id="1662241">tail</span>&nbsp;<span class="op" id="1662246">==</span>&nbsp;<span class="ident" id="1662249">nil</span>&nbsp;<span class="op" id="1662253">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662258">s</span><span class="op" id="1662259">.</span><span class="ident" id="1662260">head</span>&nbsp;<span class="op" id="1662265">=</span>&nbsp;<span class="ident" id="1662267">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662271">}</span>&nbsp;<span class="keyword" id="1662273">else</span>&nbsp;<span class="op" id="1662278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662283">s</span><span class="op" id="1662284">.</span><span class="ident" id="1662285">tail</span><span class="op" id="1662289">.</span><span class="ident" id="1662290">next</span>&nbsp;<span class="op" id="1662295">=</span>&nbsp;<span class="ident" id="1662297">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662305">s</span><span class="op" id="1662306">.</span><span class="ident" id="1662307">tail</span>&nbsp;<span class="op" id="1662312">=</span>&nbsp;<span class="ident" id="1662314">w</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662318">goparkunlock</span><span class="op" id="1662330">(</span><span class="op" id="1662331">&amp;</span><span class="ident" id="1662332">s</span><span class="op" id="1662333">.</span><span class="ident" id="1662334">lock</span><span class="op" id="1662338">,</span>&nbsp;<span class="string" id="1662340">&#34;semacquire&#34;</span><span class="op" id="1662352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662356">if</span>&nbsp;<span class="ident" id="1662359">t0</span>&nbsp;<span class="op" id="1662362">!=</span>&nbsp;<span class="num" id="1662365">0</span>&nbsp;<span class="op" id="1662367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662372">blockevent</span><span class="op" id="1662382">(</span><span class="ident" id="1662383">int64</span><span class="op" id="1662388">(</span><span class="ident" id="1662389">w</span><span class="op" id="1662390">.</span><span class="ident" id="1662391">releasetime</span><span class="op" id="1662402">)</span><span class="op" id="1662403">-</span><span class="ident" id="1662404">t0</span><span class="op" id="1662406">,</span>&nbsp;<span class="num" id="1662408">2</span><span class="op" id="1662409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662417">releaseSudog</span><span class="op" id="1662429">(</span><span class="ident" id="1662430">w</span><span class="op" id="1662431">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662434">}</span><br>
<span class="lineno"></span><span class="op" id="1662436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1662439">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1662517">func</span>&nbsp;<span class="ident" id="1662522">syncsemrelease</span><span class="op" id="1662536">(</span><span class="ident" id="1662537">s</span>&nbsp;<span class="op" id="1662539">*</span><span class="ident" id="1662540">syncSema</span><span class="op" id="1662548">,</span>&nbsp;<span class="ident" id="1662550">n</span>&nbsp;<span class="builtintype" id="1662552">uint32</span><span class="op" id="1662558">)</span>&nbsp;<span class="op" id="1662560">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662563">lock</span><span class="op" id="1662567">(</span><span class="op" id="1662568">&amp;</span><span class="ident" id="1662569">s</span><span class="op" id="1662570">.</span><span class="ident" id="1662571">lock</span><span class="op" id="1662575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662578">for</span>&nbsp;<span class="ident" id="1662582">n</span>&nbsp;<span class="op" id="1662584">&gt;</span>&nbsp;<span class="num" id="1662586">0</span>&nbsp;<span class="op" id="1662588">&amp;&amp;</span>&nbsp;<span class="ident" id="1662591">s</span><span class="op" id="1662592">.</span><span class="ident" id="1662593">head</span>&nbsp;<span class="op" id="1662598">!=</span>&nbsp;<span class="ident" id="1662601">nil</span>&nbsp;<span class="op" id="1662605">&amp;&amp;</span>&nbsp;<span class="ident" id="1662608">s</span><span class="op" id="1662609">.</span><span class="ident" id="1662610">head</span><span class="op" id="1662614">.</span><span class="ident" id="1662615">nrelease</span>&nbsp;<span class="op" id="1662624">&lt;</span>&nbsp;<span class="num" id="1662626">0</span>&nbsp;<span class="op" id="1662628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1662632">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662671">wake</span>&nbsp;<span class="op" id="1662676">:=</span>&nbsp;<span class="ident" id="1662679">s</span><span class="op" id="1662680">.</span><span class="ident" id="1662681">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662688">s</span><span class="op" id="1662689">.</span><span class="ident" id="1662690">head</span>&nbsp;<span class="op" id="1662695">=</span>&nbsp;<span class="ident" id="1662697">wake</span><span class="op" id="1662701">.</span><span class="ident" id="1662702">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662709">if</span>&nbsp;<span class="ident" id="1662712">s</span><span class="op" id="1662713">.</span><span class="ident" id="1662714">head</span>&nbsp;<span class="op" id="1662719">==</span>&nbsp;<span class="ident" id="1662722">nil</span>&nbsp;<span class="op" id="1662726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662731">s</span><span class="op" id="1662732">.</span><span class="ident" id="1662733">tail</span>&nbsp;<span class="op" id="1662738">=</span>&nbsp;<span class="ident" id="1662740">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662750">if</span>&nbsp;<span class="ident" id="1662753">wake</span><span class="op" id="1662757">.</span><span class="ident" id="1662758">releasetime</span>&nbsp;<span class="op" id="1662770">!=</span>&nbsp;<span class="num" id="1662773">0</span>&nbsp;<span class="op" id="1662775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662780">wake</span><span class="op" id="1662784">.</span><span class="ident" id="1662785">releasetime</span>&nbsp;<span class="op" id="1662797">=</span>&nbsp;<span class="ident" id="1662799">cputicks</span><span class="op" id="1662807">(</span><span class="op" id="1662808">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662816">wake</span><span class="op" id="1662820">.</span><span class="ident" id="1662821">next</span>&nbsp;<span class="op" id="1662826">=</span>&nbsp;<span class="ident" id="1662828">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662834">goready</span><span class="op" id="1662841">(</span><span class="ident" id="1662842">wake</span><span class="op" id="1662846">.</span><span class="ident" id="1662847">g</span><span class="op" id="1662848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662852">n</span><span class="op" id="1662853">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662857">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662860">if</span>&nbsp;<span class="ident" id="1662863">n</span>&nbsp;<span class="op" id="1662865">&gt;</span>&nbsp;<span class="num" id="1662867">0</span>&nbsp;<span class="op" id="1662869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1662873">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662893">w</span>&nbsp;<span class="op" id="1662895">:=</span>&nbsp;<span class="ident" id="1662898">acquireSudog</span><span class="op" id="1662910">(</span><span class="op" id="1662911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662915">w</span><span class="op" id="1662916">.</span><span class="ident" id="1662917">g</span>&nbsp;<span class="op" id="1662919">=</span>&nbsp;<span class="ident" id="1662921">getg</span><span class="op" id="1662925">(</span><span class="op" id="1662926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662930">w</span><span class="op" id="1662931">.</span><span class="ident" id="1662932">nrelease</span>&nbsp;<span class="op" id="1662941">=</span>&nbsp;<span class="builtintype" id="1662943">int32</span><span class="op" id="1662948">(</span><span class="ident" id="1662949">n</span><span class="op" id="1662950">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662954">w</span><span class="op" id="1662955">.</span><span class="ident" id="1662956">next</span>&nbsp;<span class="op" id="1662961">=</span>&nbsp;<span class="ident" id="1662963">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662969">w</span><span class="op" id="1662970">.</span><span class="ident" id="1662971">releasetime</span>&nbsp;<span class="op" id="1662983">=</span>&nbsp;<span class="num" id="1662985">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662989">if</span>&nbsp;<span class="ident" id="1662992">s</span><span class="op" id="1662993">.</span><span class="ident" id="1662994">tail</span>&nbsp;<span class="op" id="1662999">==</span>&nbsp;<span class="ident" id="1663002">nil</span>&nbsp;<span class="op" id="1663006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663011">s</span><span class="op" id="1663012">.</span><span class="ident" id="1663013">head</span>&nbsp;<span class="op" id="1663018">=</span>&nbsp;<span class="ident" id="1663020">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1663024">}</span>&nbsp;<span class="keyword" id="1663026">else</span>&nbsp;<span class="op" id="1663031">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663036">s</span><span class="op" id="1663037">.</span><span class="ident" id="1663038">tail</span><span class="op" id="1663042">.</span><span class="ident" id="1663043">next</span>&nbsp;<span class="op" id="1663048">=</span>&nbsp;<span class="ident" id="1663050">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1663054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663058">s</span><span class="op" id="1663059">.</span><span class="ident" id="1663060">tail</span>&nbsp;<span class="op" id="1663065">=</span>&nbsp;<span class="ident" id="1663067">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663071">goparkunlock</span><span class="op" id="1663083">(</span><span class="op" id="1663084">&amp;</span><span class="ident" id="1663085">s</span><span class="op" id="1663086">.</span><span class="ident" id="1663087">lock</span><span class="op" id="1663091">,</span>&nbsp;<span class="string" id="1663093">&#34;semarelease&#34;</span><span class="op" id="1663106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663110">releaseSudog</span><span class="op" id="1663122">(</span><span class="ident" id="1663123">w</span><span class="op" id="1663124">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1663127">}</span>&nbsp;<span class="keyword" id="1663129">else</span>&nbsp;<span class="op" id="1663134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663138">unlock</span><span class="op" id="1663144">(</span><span class="op" id="1663145">&amp;</span><span class="ident" id="1663146">s</span><span class="op" id="1663147">.</span><span class="ident" id="1663148">lock</span><span class="op" id="1663152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1663155">}</span><br>
<span class="lineno"></span><span class="op" id="1663157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1663160">func</span>&nbsp;<span class="ident" id="1663165">syncsemcheck</span><span class="op" id="1663177">(</span><span class="ident" id="1663178">sz</span>&nbsp;<span class="builtintype" id="1663181">uintptr</span><span class="op" id="1663188">)</span>&nbsp;<span class="op" id="1663190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1663193">if</span>&nbsp;<span class="ident" id="1663196">sz</span>&nbsp;<span class="op" id="1663199">!=</span>&nbsp;<span class="ident" id="1663202">unsafe</span><span class="op" id="1663208">.</span><span class="ident" id="1663209">Sizeof</span><span class="op" id="1663215">(</span><span class="ident" id="1663216">syncSema</span><span class="op" id="1663224">{</span><span class="op" id="1663225">}</span><span class="op" id="1663226">)</span>&nbsp;<span class="op" id="1663228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1663232">print</span><span class="op" id="1663237">(</span><span class="string" id="1663238">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="1663274">,</span>&nbsp;<span class="ident" id="1663276">sz</span><span class="op" id="1663278">,</span>&nbsp;<span class="string" id="1663280">&#34;&nbsp;runtime=&#34;</span><span class="op" id="1663291">,</span>&nbsp;<span class="ident" id="1663293">unsafe</span><span class="op" id="1663299">.</span><span class="ident" id="1663300">Sizeof</span><span class="op" id="1663306">(</span><span class="ident" id="1663307">syncSema</span><span class="op" id="1663315">{</span><span class="op" id="1663316">}</span><span class="op" id="1663317">)</span><span class="op" id="1663318">,</span>&nbsp;<span class="string" id="1663320">&#34;\n&#34;</span><span class="op" id="1663324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663328">gothrow</span><span class="op" id="1663335">(</span><span class="string" id="1663336">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="1663355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1663358">}</span><br>
<span class="lineno">275</span><span class="op" id="1663360">}</span>
</div>
</body>
</html>
