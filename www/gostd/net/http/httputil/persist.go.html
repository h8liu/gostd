<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4988705">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4988760">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4988814">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4988865">package</span>&nbsp;<span class="ident" id="4988873">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4988883">import</span>&nbsp;<span class="op" id="4988890">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4988893">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4988902">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4988912">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4988918">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4988925">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4988937">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4988954">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="4988961">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4988964">var</span>&nbsp;<span class="op" id="4988968">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4988971">ErrPersistEOF</span>&nbsp;<span class="op" id="4988985">=</span>&nbsp;<span class="op" id="4988987">&amp;</span><span class="ident" id="4988988">http</span><span class="op" id="4988992">.</span><span class="ident" id="4988993">ProtocolError</span><span class="op" id="4989006">{</span><span class="ident" id="4989007">ErrorString</span><span class="op" id="4989018">:</span>&nbsp;<span class="string" id="4989020">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="4989050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989053">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4989067">=</span>&nbsp;<span class="op" id="4989069">&amp;</span><span class="ident" id="4989070">http</span><span class="op" id="4989074">.</span><span class="ident" id="4989075">ProtocolError</span><span class="op" id="4989088">{</span><span class="ident" id="4989089">ErrorString</span><span class="op" id="4989100">:</span>&nbsp;<span class="string" id="4989102">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="4989129">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989132">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4989146">=</span>&nbsp;<span class="op" id="4989148">&amp;</span><span class="ident" id="4989149">http</span><span class="op" id="4989153">.</span><span class="ident" id="4989154">ProtocolError</span><span class="op" id="4989167">{</span><span class="ident" id="4989168">ErrorString</span><span class="op" id="4989179">:</span>&nbsp;<span class="string" id="4989181">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="4989197">}</span><br>
<span class="lineno"></span><span class="op" id="4989199">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4989202">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="4989260">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="4989325">var</span>&nbsp;<span class="ident" id="4989329">errClosed</span>&nbsp;<span class="op" id="4989339">=</span>&nbsp;<span class="ident" id="4989341">errors</span><span class="op" id="4989347">.</span><span class="ident" id="4989348">New</span><span class="op" id="4989351">(</span><span class="string" id="4989352">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="4989388">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4989391">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="4989461">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="4989535">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="4989604">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="4989679">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4989754">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="4989788">//</span><br>
<span class="lineno"></span><span class="comment" id="4989791">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="4989866">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4989894">type</span>&nbsp;<span class="ident" id="4989899">ServerConn</span>&nbsp;<span class="keyword" id="4989910">struct</span>&nbsp;<span class="op" id="4989917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989920">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989936">sync</span><span class="op" id="4989940">.</span><span class="ident" id="4989941">Mutex</span>&nbsp;<span class="comment" id="4989947">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989992">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990008">net</span><span class="op" id="4990011">.</span><span class="ident" id="4990012">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990018">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4990034">*</span><span class="ident" id="4990035">bufio</span><span class="op" id="4990040">.</span><span class="ident" id="4990041">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990049">re</span><span class="op" id="4990051">,</span>&nbsp;<span class="ident" id="4990053">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4990065">error</span>&nbsp;<span class="comment" id="4990071">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990093">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990109">io</span><span class="op" id="4990111">.</span><span class="ident" id="4990112">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990124">nread</span><span class="op" id="4990129">,</span>&nbsp;<span class="ident" id="4990131">nwritten</span>&nbsp;<span class="builtintype" id="4990140">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990145">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4990161">map</span><span class="op" id="4990164">[</span><span class="op" id="4990165">*</span><span class="ident" id="4990166">http</span><span class="op" id="4990170">.</span><span class="ident" id="4990171">Request</span><span class="op" id="4990178">]</span><span class="builtintype" id="4990179">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990186">pipe</span>&nbsp;<span class="ident" id="4990191">textproto</span><span class="op" id="4990200">.</span><span class="ident" id="4990201">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="4990210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4990213">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="4990290">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="4990338">//</span><br>
<span class="lineno"></span><span class="comment" id="4990341">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="4990416">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4990444">func</span>&nbsp;<span class="ident" id="4990449">NewServerConn</span><span class="op" id="4990462">(</span><span class="ident" id="4990463">c</span>&nbsp;<span class="ident" id="4990465">net</span><span class="op" id="4990468">.</span><span class="ident" id="4990469">Conn</span><span class="op" id="4990473">,</span>&nbsp;<span class="ident" id="4990475">r</span>&nbsp;<span class="op" id="4990477">*</span><span class="ident" id="4990478">bufio</span><span class="op" id="4990483">.</span><span class="ident" id="4990484">Reader</span><span class="op" id="4990490">)</span>&nbsp;<span class="op" id="4990492">*</span><span class="ident" id="4990493">ServerConn</span>&nbsp;<span class="op" id="4990504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990507">if</span>&nbsp;<span class="ident" id="4990510">r</span>&nbsp;<span class="op" id="4990512">==</span>&nbsp;<span class="ident" id="4990515">nil</span>&nbsp;<span class="op" id="4990519">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990523">r</span>&nbsp;<span class="op" id="4990525">=</span>&nbsp;<span class="ident" id="4990527">bufio</span><span class="op" id="4990532">.</span><span class="ident" id="4990533">NewReader</span><span class="op" id="4990542">(</span><span class="ident" id="4990543">c</span><span class="op" id="4990544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4990547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990550">return</span>&nbsp;<span class="op" id="4990557">&amp;</span><span class="ident" id="4990558">ServerConn</span><span class="op" id="4990568">{</span><span class="ident" id="4990569">c</span><span class="op" id="4990570">:</span>&nbsp;<span class="ident" id="4990572">c</span><span class="op" id="4990573">,</span>&nbsp;<span class="ident" id="4990575">r</span><span class="op" id="4990576">:</span>&nbsp;<span class="ident" id="4990578">r</span><span class="op" id="4990579">,</span>&nbsp;<span class="ident" id="4990581">pipereq</span><span class="op" id="4990588">:</span>&nbsp;<span class="builtinfunc" id="4990590">make</span><span class="op" id="4990594">(</span><span class="keyword" id="4990595">map</span><span class="op" id="4990598">[</span><span class="op" id="4990599">*</span><span class="ident" id="4990600">http</span><span class="op" id="4990604">.</span><span class="ident" id="4990605">Request</span><span class="op" id="4990612">]</span><span class="builtintype" id="4990613">uint</span><span class="op" id="4990617">)</span><span class="op" id="4990618">}</span><br>
<span class="lineno"></span><span class="op" id="4990620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="4990623">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="4990703">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4990779">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="4990856">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="4990918">func</span>&nbsp;<span class="op" id="4990923">(</span><span class="ident" id="4990924">sc</span>&nbsp;<span class="op" id="4990927">*</span><span class="ident" id="4990928">ServerConn</span><span class="op" id="4990938">)</span>&nbsp;<span class="ident" id="4990940">Hijack</span><span class="op" id="4990946">(</span><span class="op" id="4990947">)</span>&nbsp;<span class="op" id="4990949">(</span><span class="ident" id="4990950">c</span>&nbsp;<span class="ident" id="4990952">net</span><span class="op" id="4990955">.</span><span class="ident" id="4990956">Conn</span><span class="op" id="4990960">,</span>&nbsp;<span class="ident" id="4990962">r</span>&nbsp;<span class="op" id="4990964">*</span><span class="ident" id="4990965">bufio</span><span class="op" id="4990970">.</span><span class="ident" id="4990971">Reader</span><span class="op" id="4990977">)</span>&nbsp;<span class="op" id="4990979">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990982">sc</span><span class="op" id="4990984">.</span><span class="ident" id="4990985">lk</span><span class="op" id="4990987">.</span><span class="ident" id="4990988">Lock</span><span class="op" id="4990992">(</span><span class="op" id="4990993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990996">defer</span>&nbsp;<span class="ident" id="4991002">sc</span><span class="op" id="4991004">.</span><span class="ident" id="4991005">lk</span><span class="op" id="4991007">.</span><span class="ident" id="4991008">Unlock</span><span class="op" id="4991014">(</span><span class="op" id="4991015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991018">c</span>&nbsp;<span class="op" id="4991020">=</span>&nbsp;<span class="ident" id="4991022">sc</span><span class="op" id="4991024">.</span><span class="ident" id="4991025">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991028">r</span>&nbsp;<span class="op" id="4991030">=</span>&nbsp;<span class="ident" id="4991032">sc</span><span class="op" id="4991034">.</span><span class="ident" id="4991035">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991038">sc</span><span class="op" id="4991040">.</span><span class="ident" id="4991041">c</span>&nbsp;<span class="op" id="4991043">=</span>&nbsp;<span class="ident" id="4991045">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991050">sc</span><span class="op" id="4991052">.</span><span class="ident" id="4991053">r</span>&nbsp;<span class="op" id="4991055">=</span>&nbsp;<span class="ident" id="4991057">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991062">return</span><br>
<span class="lineno"></span><span class="op" id="4991069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4991072">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="4991141">func</span>&nbsp;<span class="op" id="4991146">(</span><span class="ident" id="4991147">sc</span>&nbsp;<span class="op" id="4991150">*</span><span class="ident" id="4991151">ServerConn</span><span class="op" id="4991161">)</span>&nbsp;<span class="ident" id="4991163">Close</span><span class="op" id="4991168">(</span><span class="op" id="4991169">)</span>&nbsp;<span class="builtintype" id="4991171">error</span>&nbsp;<span class="op" id="4991177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991180">c</span><span class="op" id="4991181">,</span>&nbsp;<span class="ident" id="4991183">_</span>&nbsp;<span class="op" id="4991185">:=</span>&nbsp;<span class="ident" id="4991188">sc</span><span class="op" id="4991190">.</span><span class="ident" id="4991191">Hijack</span><span class="op" id="4991197">(</span><span class="op" id="4991198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991201">if</span>&nbsp;<span class="ident" id="4991204">c</span>&nbsp;<span class="op" id="4991206">!=</span>&nbsp;<span class="ident" id="4991209">nil</span>&nbsp;<span class="op" id="4991213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991217">return</span>&nbsp;<span class="ident" id="4991224">c</span><span class="op" id="4991225">.</span><span class="ident" id="4991226">Close</span><span class="op" id="4991231">(</span><span class="op" id="4991232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4991235">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991238">return</span>&nbsp;<span class="ident" id="4991245">nil</span><br>
<span class="lineno"></span><span class="op" id="4991249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4991252">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4991330">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="4991409">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4991486">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="4991511">func</span>&nbsp;<span class="op" id="4991516">(</span><span class="ident" id="4991517">sc</span>&nbsp;<span class="op" id="4991520">*</span><span class="ident" id="4991521">ServerConn</span><span class="op" id="4991531">)</span>&nbsp;<span class="ident" id="4991533">Read</span><span class="op" id="4991537">(</span><span class="op" id="4991538">)</span>&nbsp;<span class="op" id="4991540">(</span><span class="ident" id="4991541">req</span>&nbsp;<span class="op" id="4991545">*</span><span class="ident" id="4991546">http</span><span class="op" id="4991550">.</span><span class="ident" id="4991551">Request</span><span class="op" id="4991558">,</span>&nbsp;<span class="ident" id="4991560">err</span>&nbsp;<span class="builtintype" id="4991564">error</span><span class="op" id="4991569">)</span>&nbsp;<span class="op" id="4991571">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4991575">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991624">id</span>&nbsp;<span class="op" id="4991627">:=</span>&nbsp;<span class="ident" id="4991630">sc</span><span class="op" id="4991632">.</span><span class="ident" id="4991633">pipe</span><span class="op" id="4991637">.</span><span class="ident" id="4991638">Next</span><span class="op" id="4991642">(</span><span class="op" id="4991643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991646">sc</span><span class="op" id="4991648">.</span><span class="ident" id="4991649">pipe</span><span class="op" id="4991653">.</span><span class="ident" id="4991654">StartRequest</span><span class="op" id="4991666">(</span><span class="ident" id="4991667">id</span><span class="op" id="4991669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991672">defer</span>&nbsp;<span class="keyword" id="4991678">func</span><span class="op" id="4991682">(</span><span class="op" id="4991683">)</span>&nbsp;<span class="op" id="4991685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991689">sc</span><span class="op" id="4991691">.</span><span class="ident" id="4991692">pipe</span><span class="op" id="4991696">.</span><span class="ident" id="4991697">EndRequest</span><span class="op" id="4991707">(</span><span class="ident" id="4991708">id</span><span class="op" id="4991710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991714">if</span>&nbsp;<span class="ident" id="4991717">req</span>&nbsp;<span class="op" id="4991721">==</span>&nbsp;<span class="ident" id="4991724">nil</span>&nbsp;<span class="op" id="4991728">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991733">sc</span><span class="op" id="4991735">.</span><span class="ident" id="4991736">pipe</span><span class="op" id="4991740">.</span><span class="ident" id="4991741">StartResponse</span><span class="op" id="4991754">(</span><span class="ident" id="4991755">id</span><span class="op" id="4991757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991762">sc</span><span class="op" id="4991764">.</span><span class="ident" id="4991765">pipe</span><span class="op" id="4991769">.</span><span class="ident" id="4991770">EndResponse</span><span class="op" id="4991781">(</span><span class="ident" id="4991782">id</span><span class="op" id="4991784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4991788">}</span>&nbsp;<span class="keyword" id="4991790">else</span>&nbsp;<span class="op" id="4991795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4991800">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991847">sc</span><span class="op" id="4991849">.</span><span class="ident" id="4991850">lk</span><span class="op" id="4991852">.</span><span class="ident" id="4991853">Lock</span><span class="op" id="4991857">(</span><span class="op" id="4991858">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991863">sc</span><span class="op" id="4991865">.</span><span class="ident" id="4991866">pipereq</span><span class="op" id="4991873">[</span><span class="ident" id="4991874">req</span><span class="op" id="4991877">]</span>&nbsp;<span class="op" id="4991879">=</span>&nbsp;<span class="ident" id="4991881">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991887">sc</span><span class="op" id="4991889">.</span><span class="ident" id="4991890">lk</span><span class="op" id="4991892">.</span><span class="ident" id="4991893">Unlock</span><span class="op" id="4991899">(</span><span class="op" id="4991900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4991904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4991907">}</span><span class="op" id="4991908">(</span><span class="op" id="4991909">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991913">sc</span><span class="op" id="4991915">.</span><span class="ident" id="4991916">lk</span><span class="op" id="4991918">.</span><span class="ident" id="4991919">Lock</span><span class="op" id="4991923">(</span><span class="op" id="4991924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991927">if</span>&nbsp;<span class="ident" id="4991930">sc</span><span class="op" id="4991932">.</span><span class="ident" id="4991933">we</span>&nbsp;<span class="op" id="4991936">!=</span>&nbsp;<span class="ident" id="4991939">nil</span>&nbsp;<span class="op" id="4991943">{</span>&nbsp;<span class="comment" id="4991945">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992000">defer</span>&nbsp;<span class="ident" id="4992006">sc</span><span class="op" id="4992008">.</span><span class="ident" id="4992009">lk</span><span class="op" id="4992011">.</span><span class="ident" id="4992012">Unlock</span><span class="op" id="4992018">(</span><span class="op" id="4992019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992023">return</span>&nbsp;<span class="ident" id="4992030">nil</span><span class="op" id="4992033">,</span>&nbsp;<span class="ident" id="4992035">sc</span><span class="op" id="4992037">.</span><span class="ident" id="4992038">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992042">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992045">if</span>&nbsp;<span class="ident" id="4992048">sc</span><span class="op" id="4992050">.</span><span class="ident" id="4992051">re</span>&nbsp;<span class="op" id="4992054">!=</span>&nbsp;<span class="ident" id="4992057">nil</span>&nbsp;<span class="op" id="4992061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992065">defer</span>&nbsp;<span class="ident" id="4992071">sc</span><span class="op" id="4992073">.</span><span class="ident" id="4992074">lk</span><span class="op" id="4992076">.</span><span class="ident" id="4992077">Unlock</span><span class="op" id="4992083">(</span><span class="op" id="4992084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992088">return</span>&nbsp;<span class="ident" id="4992095">nil</span><span class="op" id="4992098">,</span>&nbsp;<span class="ident" id="4992100">sc</span><span class="op" id="4992102">.</span><span class="ident" id="4992103">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992110">if</span>&nbsp;<span class="ident" id="4992113">sc</span><span class="op" id="4992115">.</span><span class="ident" id="4992116">r</span>&nbsp;<span class="op" id="4992118">==</span>&nbsp;<span class="ident" id="4992121">nil</span>&nbsp;<span class="op" id="4992125">{</span>&nbsp;<span class="comment" id="4992127">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992174">defer</span>&nbsp;<span class="ident" id="4992180">sc</span><span class="op" id="4992182">.</span><span class="ident" id="4992183">lk</span><span class="op" id="4992185">.</span><span class="ident" id="4992186">Unlock</span><span class="op" id="4992192">(</span><span class="op" id="4992193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992197">return</span>&nbsp;<span class="ident" id="4992204">nil</span><span class="op" id="4992207">,</span>&nbsp;<span class="ident" id="4992209">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992223">r</span>&nbsp;<span class="op" id="4992225">:=</span>&nbsp;<span class="ident" id="4992228">sc</span><span class="op" id="4992230">.</span><span class="ident" id="4992231">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992234">lastbody</span>&nbsp;<span class="op" id="4992243">:=</span>&nbsp;<span class="ident" id="4992246">sc</span><span class="op" id="4992248">.</span><span class="ident" id="4992249">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992259">sc</span><span class="op" id="4992261">.</span><span class="ident" id="4992262">lastbody</span>&nbsp;<span class="op" id="4992271">=</span>&nbsp;<span class="ident" id="4992273">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992278">sc</span><span class="op" id="4992280">.</span><span class="ident" id="4992281">lk</span><span class="op" id="4992283">.</span><span class="ident" id="4992284">Unlock</span><span class="op" id="4992290">(</span><span class="op" id="4992291">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992295">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992371">if</span>&nbsp;<span class="ident" id="4992374">lastbody</span>&nbsp;<span class="op" id="4992383">!=</span>&nbsp;<span class="ident" id="4992386">nil</span>&nbsp;<span class="op" id="4992390">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992394">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992460">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992518">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992533">err</span>&nbsp;<span class="op" id="4992537">=</span>&nbsp;<span class="ident" id="4992539">lastbody</span><span class="op" id="4992547">.</span><span class="ident" id="4992548">Close</span><span class="op" id="4992553">(</span><span class="op" id="4992554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992558">if</span>&nbsp;<span class="ident" id="4992561">err</span>&nbsp;<span class="op" id="4992565">!=</span>&nbsp;<span class="ident" id="4992568">nil</span>&nbsp;<span class="op" id="4992572">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992577">sc</span><span class="op" id="4992579">.</span><span class="ident" id="4992580">lk</span><span class="op" id="4992582">.</span><span class="ident" id="4992583">Lock</span><span class="op" id="4992587">(</span><span class="op" id="4992588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992593">defer</span>&nbsp;<span class="ident" id="4992599">sc</span><span class="op" id="4992601">.</span><span class="ident" id="4992602">lk</span><span class="op" id="4992604">.</span><span class="ident" id="4992605">Unlock</span><span class="op" id="4992611">(</span><span class="op" id="4992612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992617">sc</span><span class="op" id="4992619">.</span><span class="ident" id="4992620">re</span>&nbsp;<span class="op" id="4992623">=</span>&nbsp;<span class="ident" id="4992625">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992632">return</span>&nbsp;<span class="ident" id="4992639">nil</span><span class="op" id="4992642">,</span>&nbsp;<span class="ident" id="4992644">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992650">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992657">req</span><span class="op" id="4992660">,</span>&nbsp;<span class="ident" id="4992662">err</span>&nbsp;<span class="op" id="4992666">=</span>&nbsp;<span class="ident" id="4992668">http</span><span class="op" id="4992672">.</span><span class="ident" id="4992673">ReadRequest</span><span class="op" id="4992684">(</span><span class="ident" id="4992685">r</span><span class="op" id="4992686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992689">sc</span><span class="op" id="4992691">.</span><span class="ident" id="4992692">lk</span><span class="op" id="4992694">.</span><span class="ident" id="4992695">Lock</span><span class="op" id="4992699">(</span><span class="op" id="4992700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992703">defer</span>&nbsp;<span class="ident" id="4992709">sc</span><span class="op" id="4992711">.</span><span class="ident" id="4992712">lk</span><span class="op" id="4992714">.</span><span class="ident" id="4992715">Unlock</span><span class="op" id="4992721">(</span><span class="op" id="4992722">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992725">if</span>&nbsp;<span class="ident" id="4992728">err</span>&nbsp;<span class="op" id="4992732">!=</span>&nbsp;<span class="ident" id="4992735">nil</span>&nbsp;<span class="op" id="4992739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992743">if</span>&nbsp;<span class="ident" id="4992746">err</span>&nbsp;<span class="op" id="4992750">==</span>&nbsp;<span class="ident" id="4992753">io</span><span class="op" id="4992755">.</span><span class="ident" id="4992756">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="4992773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992778">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992833">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992891">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992920">sc</span><span class="op" id="4992922">.</span><span class="ident" id="4992923">re</span>&nbsp;<span class="op" id="4992926">=</span>&nbsp;<span class="ident" id="4992928">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992945">return</span>&nbsp;<span class="ident" id="4992952">nil</span><span class="op" id="4992955">,</span>&nbsp;<span class="ident" id="4992957">sc</span><span class="op" id="4992959">.</span><span class="ident" id="4992960">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992965">}</span>&nbsp;<span class="keyword" id="4992967">else</span>&nbsp;<span class="op" id="4992972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992977">sc</span><span class="op" id="4992979">.</span><span class="ident" id="4992980">re</span>&nbsp;<span class="op" id="4992983">=</span>&nbsp;<span class="ident" id="4992985">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992992">return</span>&nbsp;<span class="ident" id="4992999">req</span><span class="op" id="4993002">,</span>&nbsp;<span class="ident" id="4993004">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993016">sc</span><span class="op" id="4993018">.</span><span class="ident" id="4993019">lastbody</span>&nbsp;<span class="op" id="4993028">=</span>&nbsp;<span class="ident" id="4993030">req</span><span class="op" id="4993033">.</span><span class="ident" id="4993034">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993040">sc</span><span class="op" id="4993042">.</span><span class="ident" id="4993043">nread</span><span class="op" id="4993048">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993052">if</span>&nbsp;<span class="ident" id="4993055">req</span><span class="op" id="4993058">.</span><span class="ident" id="4993059">Close</span>&nbsp;<span class="op" id="4993065">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993069">sc</span><span class="op" id="4993071">.</span><span class="ident" id="4993072">re</span>&nbsp;<span class="op" id="4993075">=</span>&nbsp;<span class="ident" id="4993077">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993093">return</span>&nbsp;<span class="ident" id="4993100">req</span><span class="op" id="4993103">,</span>&nbsp;<span class="ident" id="4993105">sc</span><span class="op" id="4993107">.</span><span class="ident" id="4993108">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993115">return</span>&nbsp;<span class="ident" id="4993122">req</span><span class="op" id="4993125">,</span>&nbsp;<span class="ident" id="4993127">err</span><br>
<span class="lineno"></span><span class="op" id="4993131">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="4993134">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4993187">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4993233">func</span>&nbsp;<span class="op" id="4993238">(</span><span class="ident" id="4993239">sc</span>&nbsp;<span class="op" id="4993242">*</span><span class="ident" id="4993243">ServerConn</span><span class="op" id="4993253">)</span>&nbsp;<span class="ident" id="4993255">Pending</span><span class="op" id="4993262">(</span><span class="op" id="4993263">)</span>&nbsp;<span class="builtintype" id="4993265">int</span>&nbsp;<span class="op" id="4993269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993272">sc</span><span class="op" id="4993274">.</span><span class="ident" id="4993275">lk</span><span class="op" id="4993277">.</span><span class="ident" id="4993278">Lock</span><span class="op" id="4993282">(</span><span class="op" id="4993283">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993286">defer</span>&nbsp;<span class="ident" id="4993292">sc</span><span class="op" id="4993294">.</span><span class="ident" id="4993295">lk</span><span class="op" id="4993297">.</span><span class="ident" id="4993298">Unlock</span><span class="op" id="4993304">(</span><span class="op" id="4993305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993308">return</span>&nbsp;<span class="ident" id="4993315">sc</span><span class="op" id="4993317">.</span><span class="ident" id="4993318">nread</span>&nbsp;<span class="op" id="4993324">-</span>&nbsp;<span class="ident" id="4993326">sc</span><span class="op" id="4993328">.</span><span class="ident" id="4993329">nwritten</span><br>
<span class="lineno"></span><span class="op" id="4993338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4993341">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="4993426">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="4993504">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="4993580">func</span>&nbsp;<span class="op" id="4993585">(</span><span class="ident" id="4993586">sc</span>&nbsp;<span class="op" id="4993589">*</span><span class="ident" id="4993590">ServerConn</span><span class="op" id="4993600">)</span>&nbsp;<span class="ident" id="4993602">Write</span><span class="op" id="4993607">(</span><span class="ident" id="4993608">req</span>&nbsp;<span class="op" id="4993612">*</span><span class="ident" id="4993613">http</span><span class="op" id="4993617">.</span><span class="ident" id="4993618">Request</span><span class="op" id="4993625">,</span>&nbsp;<span class="ident" id="4993627">resp</span>&nbsp;<span class="op" id="4993632">*</span><span class="ident" id="4993633">http</span><span class="op" id="4993637">.</span><span class="ident" id="4993638">Response</span><span class="op" id="4993646">)</span>&nbsp;<span class="builtintype" id="4993648">error</span>&nbsp;<span class="op" id="4993654">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993658">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993717">sc</span><span class="op" id="4993719">.</span><span class="ident" id="4993720">lk</span><span class="op" id="4993722">.</span><span class="ident" id="4993723">Lock</span><span class="op" id="4993727">(</span><span class="op" id="4993728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993731">id</span><span class="op" id="4993733">,</span>&nbsp;<span class="ident" id="4993735">ok</span>&nbsp;<span class="op" id="4993738">:=</span>&nbsp;<span class="ident" id="4993741">sc</span><span class="op" id="4993743">.</span><span class="ident" id="4993744">pipereq</span><span class="op" id="4993751">[</span><span class="ident" id="4993752">req</span><span class="op" id="4993755">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4993758">delete</span><span class="op" id="4993764">(</span><span class="ident" id="4993765">sc</span><span class="op" id="4993767">.</span><span class="ident" id="4993768">pipereq</span><span class="op" id="4993775">,</span>&nbsp;<span class="ident" id="4993777">req</span><span class="op" id="4993780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993783">if</span>&nbsp;<span class="op" id="4993786">!</span><span class="ident" id="4993787">ok</span>&nbsp;<span class="op" id="4993790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993794">sc</span><span class="op" id="4993796">.</span><span class="ident" id="4993797">lk</span><span class="op" id="4993799">.</span><span class="ident" id="4993800">Unlock</span><span class="op" id="4993806">(</span><span class="op" id="4993807">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993811">return</span>&nbsp;<span class="ident" id="4993818">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993834">sc</span><span class="op" id="4993836">.</span><span class="ident" id="4993837">lk</span><span class="op" id="4993839">.</span><span class="ident" id="4993840">Unlock</span><span class="op" id="4993846">(</span><span class="op" id="4993847">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993851">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993877">sc</span><span class="op" id="4993879">.</span><span class="ident" id="4993880">pipe</span><span class="op" id="4993884">.</span><span class="ident" id="4993885">StartResponse</span><span class="op" id="4993898">(</span><span class="ident" id="4993899">id</span><span class="op" id="4993901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993904">defer</span>&nbsp;<span class="ident" id="4993910">sc</span><span class="op" id="4993912">.</span><span class="ident" id="4993913">pipe</span><span class="op" id="4993917">.</span><span class="ident" id="4993918">EndResponse</span><span class="op" id="4993929">(</span><span class="ident" id="4993930">id</span><span class="op" id="4993932">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993936">sc</span><span class="op" id="4993938">.</span><span class="ident" id="4993939">lk</span><span class="op" id="4993941">.</span><span class="ident" id="4993942">Lock</span><span class="op" id="4993946">(</span><span class="op" id="4993947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993950">if</span>&nbsp;<span class="ident" id="4993953">sc</span><span class="op" id="4993955">.</span><span class="ident" id="4993956">we</span>&nbsp;<span class="op" id="4993959">!=</span>&nbsp;<span class="ident" id="4993962">nil</span>&nbsp;<span class="op" id="4993966">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993970">defer</span>&nbsp;<span class="ident" id="4993976">sc</span><span class="op" id="4993978">.</span><span class="ident" id="4993979">lk</span><span class="op" id="4993981">.</span><span class="ident" id="4993982">Unlock</span><span class="op" id="4993988">(</span><span class="op" id="4993989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993993">return</span>&nbsp;<span class="ident" id="4994000">sc</span><span class="op" id="4994002">.</span><span class="ident" id="4994003">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994010">if</span>&nbsp;<span class="ident" id="4994013">sc</span><span class="op" id="4994015">.</span><span class="ident" id="4994016">c</span>&nbsp;<span class="op" id="4994018">==</span>&nbsp;<span class="ident" id="4994021">nil</span>&nbsp;<span class="op" id="4994025">{</span>&nbsp;<span class="comment" id="4994027">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994074">defer</span>&nbsp;<span class="ident" id="4994080">sc</span><span class="op" id="4994082">.</span><span class="ident" id="4994083">lk</span><span class="op" id="4994085">.</span><span class="ident" id="4994086">Unlock</span><span class="op" id="4994092">(</span><span class="op" id="4994093">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994097">return</span>&nbsp;<span class="ident" id="4994104">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994118">c</span>&nbsp;<span class="op" id="4994120">:=</span>&nbsp;<span class="ident" id="4994123">sc</span><span class="op" id="4994125">.</span><span class="ident" id="4994126">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994129">if</span>&nbsp;<span class="ident" id="4994132">sc</span><span class="op" id="4994134">.</span><span class="ident" id="4994135">nread</span>&nbsp;<span class="op" id="4994141">&lt;=</span>&nbsp;<span class="ident" id="4994144">sc</span><span class="op" id="4994146">.</span><span class="ident" id="4994147">nwritten</span>&nbsp;<span class="op" id="4994156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994160">defer</span>&nbsp;<span class="ident" id="4994166">sc</span><span class="op" id="4994168">.</span><span class="ident" id="4994169">lk</span><span class="op" id="4994171">.</span><span class="ident" id="4994172">Unlock</span><span class="op" id="4994178">(</span><span class="op" id="4994179">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994183">return</span>&nbsp;<span class="ident" id="4994190">errors</span><span class="op" id="4994196">.</span><span class="ident" id="4994197">New</span><span class="op" id="4994200">(</span><span class="string" id="4994201">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="4994228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994234">if</span>&nbsp;<span class="ident" id="4994237">resp</span><span class="op" id="4994241">.</span><span class="ident" id="4994242">Close</span>&nbsp;<span class="op" id="4994248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4994252">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4994314">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4994377">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994400">sc</span><span class="op" id="4994402">.</span><span class="ident" id="4994403">re</span>&nbsp;<span class="op" id="4994406">=</span>&nbsp;<span class="ident" id="4994408">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994426">sc</span><span class="op" id="4994428">.</span><span class="ident" id="4994429">lk</span><span class="op" id="4994431">.</span><span class="ident" id="4994432">Unlock</span><span class="op" id="4994438">(</span><span class="op" id="4994439">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994443">err</span>&nbsp;<span class="op" id="4994447">:=</span>&nbsp;<span class="ident" id="4994450">resp</span><span class="op" id="4994454">.</span><span class="ident" id="4994455">Write</span><span class="op" id="4994460">(</span><span class="ident" id="4994461">c</span><span class="op" id="4994462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994465">sc</span><span class="op" id="4994467">.</span><span class="ident" id="4994468">lk</span><span class="op" id="4994470">.</span><span class="ident" id="4994471">Lock</span><span class="op" id="4994475">(</span><span class="op" id="4994476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994479">defer</span>&nbsp;<span class="ident" id="4994485">sc</span><span class="op" id="4994487">.</span><span class="ident" id="4994488">lk</span><span class="op" id="4994490">.</span><span class="ident" id="4994491">Unlock</span><span class="op" id="4994497">(</span><span class="op" id="4994498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994501">if</span>&nbsp;<span class="ident" id="4994504">err</span>&nbsp;<span class="op" id="4994508">!=</span>&nbsp;<span class="ident" id="4994511">nil</span>&nbsp;<span class="op" id="4994515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994519">sc</span><span class="op" id="4994521">.</span><span class="ident" id="4994522">we</span>&nbsp;<span class="op" id="4994525">=</span>&nbsp;<span class="ident" id="4994527">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994533">return</span>&nbsp;<span class="ident" id="4994540">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994548">sc</span><span class="op" id="4994550">.</span><span class="ident" id="4994551">nwritten</span><span class="op" id="4994559">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994564">return</span>&nbsp;<span class="ident" id="4994571">nil</span><br>
<span class="lineno">220</span><span class="op" id="4994575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4994578">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="4994648">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="4994717">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="4994772">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="4994846">//</span><br>
<span class="lineno"></span><span class="comment" id="4994849">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="4994917">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4994965">type</span>&nbsp;<span class="ident" id="4994970">ClientConn</span>&nbsp;<span class="keyword" id="4994981">struct</span>&nbsp;<span class="op" id="4994988">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994991">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4995007">sync</span><span class="op" id="4995011">.</span><span class="ident" id="4995012">Mutex</span>&nbsp;<span class="comment" id="4995018">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995063">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4995079">net</span><span class="op" id="4995082">.</span><span class="ident" id="4995083">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995089">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4995105">*</span><span class="ident" id="4995106">bufio</span><span class="op" id="4995111">.</span><span class="ident" id="4995112">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995120">re</span><span class="op" id="4995122">,</span>&nbsp;<span class="ident" id="4995124">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4995136">error</span>&nbsp;<span class="comment" id="4995142">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995164">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4995180">io</span><span class="op" id="4995182">.</span><span class="ident" id="4995183">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995195">nread</span><span class="op" id="4995200">,</span>&nbsp;<span class="ident" id="4995202">nwritten</span>&nbsp;<span class="builtintype" id="4995211">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995216">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4995232">map</span><span class="op" id="4995235">[</span><span class="op" id="4995236">*</span><span class="ident" id="4995237">http</span><span class="op" id="4995241">.</span><span class="ident" id="4995242">Request</span><span class="op" id="4995249">]</span><span class="builtintype" id="4995250">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995257">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4995266">textproto</span><span class="op" id="4995275">.</span><span class="ident" id="4995276">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995286">writeReq</span>&nbsp;<span class="keyword" id="4995295">func</span><span class="op" id="4995299">(</span><span class="op" id="4995300">*</span><span class="ident" id="4995301">http</span><span class="op" id="4995305">.</span><span class="ident" id="4995306">Request</span><span class="op" id="4995313">,</span>&nbsp;<span class="ident" id="4995315">io</span><span class="op" id="4995317">.</span><span class="ident" id="4995318">Writer</span><span class="op" id="4995324">)</span>&nbsp;<span class="builtintype" id="4995326">error</span><br>
<span class="lineno">240</span><span class="op" id="4995332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4995335">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="4995413">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="4995461">//</span><br>
<span class="lineno">245</span><span class="comment" id="4995464">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4995534">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4995572">func</span>&nbsp;<span class="ident" id="4995577">NewClientConn</span><span class="op" id="4995590">(</span><span class="ident" id="4995591">c</span>&nbsp;<span class="ident" id="4995593">net</span><span class="op" id="4995596">.</span><span class="ident" id="4995597">Conn</span><span class="op" id="4995601">,</span>&nbsp;<span class="ident" id="4995603">r</span>&nbsp;<span class="op" id="4995605">*</span><span class="ident" id="4995606">bufio</span><span class="op" id="4995611">.</span><span class="ident" id="4995612">Reader</span><span class="op" id="4995618">)</span>&nbsp;<span class="op" id="4995620">*</span><span class="ident" id="4995621">ClientConn</span>&nbsp;<span class="op" id="4995632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995635">if</span>&nbsp;<span class="ident" id="4995638">r</span>&nbsp;<span class="op" id="4995640">==</span>&nbsp;<span class="ident" id="4995643">nil</span>&nbsp;<span class="op" id="4995647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995651">r</span>&nbsp;<span class="op" id="4995653">=</span>&nbsp;<span class="ident" id="4995655">bufio</span><span class="op" id="4995660">.</span><span class="ident" id="4995661">NewReader</span><span class="op" id="4995670">(</span><span class="ident" id="4995671">c</span><span class="op" id="4995672">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995678">return</span>&nbsp;<span class="op" id="4995685">&amp;</span><span class="ident" id="4995686">ClientConn</span><span class="op" id="4995696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995700">c</span><span class="op" id="4995701">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4995710">c</span><span class="op" id="4995711">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995715">r</span><span class="op" id="4995716">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4995725">r</span><span class="op" id="4995726">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995730">pipereq</span><span class="op" id="4995737">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="4995740">make</span><span class="op" id="4995744">(</span><span class="keyword" id="4995745">map</span><span class="op" id="4995748">[</span><span class="op" id="4995749">*</span><span class="ident" id="4995750">http</span><span class="op" id="4995754">.</span><span class="ident" id="4995755">Request</span><span class="op" id="4995762">]</span><span class="builtintype" id="4995763">uint</span><span class="op" id="4995767">)</span><span class="op" id="4995768">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995772">writeReq</span><span class="op" id="4995780">:</span>&nbsp;<span class="op" id="4995782">(</span><span class="op" id="4995783">*</span><span class="ident" id="4995784">http</span><span class="op" id="4995788">.</span><span class="ident" id="4995789">Request</span><span class="op" id="4995796">)</span><span class="op" id="4995797">.</span><span class="ident" id="4995798">Write</span><span class="op" id="4995803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995806">}</span><br>
<span class="lineno"></span><span class="op" id="4995808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4995811">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="4995878">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="4995916">//</span><br>
<span class="lineno"></span><span class="comment" id="4995919">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4995980">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="4996026">func</span>&nbsp;<span class="ident" id="4996031">NewProxyClientConn</span><span class="op" id="4996049">(</span><span class="ident" id="4996050">c</span>&nbsp;<span class="ident" id="4996052">net</span><span class="op" id="4996055">.</span><span class="ident" id="4996056">Conn</span><span class="op" id="4996060">,</span>&nbsp;<span class="ident" id="4996062">r</span>&nbsp;<span class="op" id="4996064">*</span><span class="ident" id="4996065">bufio</span><span class="op" id="4996070">.</span><span class="ident" id="4996071">Reader</span><span class="op" id="4996077">)</span>&nbsp;<span class="op" id="4996079">*</span><span class="ident" id="4996080">ClientConn</span>&nbsp;<span class="op" id="4996091">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996094">cc</span>&nbsp;<span class="op" id="4996097">:=</span>&nbsp;<span class="ident" id="4996100">NewClientConn</span><span class="op" id="4996113">(</span><span class="ident" id="4996114">c</span><span class="op" id="4996115">,</span>&nbsp;<span class="ident" id="4996117">r</span><span class="op" id="4996118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996121">cc</span><span class="op" id="4996123">.</span><span class="ident" id="4996124">writeReq</span>&nbsp;<span class="op" id="4996133">=</span>&nbsp;<span class="op" id="4996135">(</span><span class="op" id="4996136">*</span><span class="ident" id="4996137">http</span><span class="op" id="4996141">.</span><span class="ident" id="4996142">Request</span><span class="op" id="4996149">)</span><span class="op" id="4996150">.</span><span class="ident" id="4996151">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996163">return</span>&nbsp;<span class="ident" id="4996170">cc</span><br>
<span class="lineno"></span><span class="op" id="4996173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="4996176">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="4996256">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4996332">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="4996406">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="4996484">func</span>&nbsp;<span class="op" id="4996489">(</span><span class="ident" id="4996490">cc</span>&nbsp;<span class="op" id="4996493">*</span><span class="ident" id="4996494">ClientConn</span><span class="op" id="4996504">)</span>&nbsp;<span class="ident" id="4996506">Hijack</span><span class="op" id="4996512">(</span><span class="op" id="4996513">)</span>&nbsp;<span class="op" id="4996515">(</span><span class="ident" id="4996516">c</span>&nbsp;<span class="ident" id="4996518">net</span><span class="op" id="4996521">.</span><span class="ident" id="4996522">Conn</span><span class="op" id="4996526">,</span>&nbsp;<span class="ident" id="4996528">r</span>&nbsp;<span class="op" id="4996530">*</span><span class="ident" id="4996531">bufio</span><span class="op" id="4996536">.</span><span class="ident" id="4996537">Reader</span><span class="op" id="4996543">)</span>&nbsp;<span class="op" id="4996545">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996548">cc</span><span class="op" id="4996550">.</span><span class="ident" id="4996551">lk</span><span class="op" id="4996553">.</span><span class="ident" id="4996554">Lock</span><span class="op" id="4996558">(</span><span class="op" id="4996559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996562">defer</span>&nbsp;<span class="ident" id="4996568">cc</span><span class="op" id="4996570">.</span><span class="ident" id="4996571">lk</span><span class="op" id="4996573">.</span><span class="ident" id="4996574">Unlock</span><span class="op" id="4996580">(</span><span class="op" id="4996581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996584">c</span>&nbsp;<span class="op" id="4996586">=</span>&nbsp;<span class="ident" id="4996588">cc</span><span class="op" id="4996590">.</span><span class="ident" id="4996591">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996594">r</span>&nbsp;<span class="op" id="4996596">=</span>&nbsp;<span class="ident" id="4996598">cc</span><span class="op" id="4996600">.</span><span class="ident" id="4996601">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996604">cc</span><span class="op" id="4996606">.</span><span class="ident" id="4996607">c</span>&nbsp;<span class="op" id="4996609">=</span>&nbsp;<span class="ident" id="4996611">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996616">cc</span><span class="op" id="4996618">.</span><span class="ident" id="4996619">r</span>&nbsp;<span class="op" id="4996621">=</span>&nbsp;<span class="ident" id="4996623">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996628">return</span><br>
<span class="lineno"></span><span class="op" id="4996635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4996638">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="4996707">func</span>&nbsp;<span class="op" id="4996712">(</span><span class="ident" id="4996713">cc</span>&nbsp;<span class="op" id="4996716">*</span><span class="ident" id="4996717">ClientConn</span><span class="op" id="4996727">)</span>&nbsp;<span class="ident" id="4996729">Close</span><span class="op" id="4996734">(</span><span class="op" id="4996735">)</span>&nbsp;<span class="builtintype" id="4996737">error</span>&nbsp;<span class="op" id="4996743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996746">c</span><span class="op" id="4996747">,</span>&nbsp;<span class="ident" id="4996749">_</span>&nbsp;<span class="op" id="4996751">:=</span>&nbsp;<span class="ident" id="4996754">cc</span><span class="op" id="4996756">.</span><span class="ident" id="4996757">Hijack</span><span class="op" id="4996763">(</span><span class="op" id="4996764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996767">if</span>&nbsp;<span class="ident" id="4996770">c</span>&nbsp;<span class="op" id="4996772">!=</span>&nbsp;<span class="ident" id="4996775">nil</span>&nbsp;<span class="op" id="4996779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996783">return</span>&nbsp;<span class="ident" id="4996790">c</span><span class="op" id="4996791">.</span><span class="ident" id="4996792">Close</span><span class="op" id="4996797">(</span><span class="op" id="4996798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996801">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996804">return</span>&nbsp;<span class="ident" id="4996811">nil</span><br>
<span class="lineno"></span><span class="op" id="4996815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4996818">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="4996898">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="4996975">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="4997055">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4997130">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="4997207">func</span>&nbsp;<span class="op" id="4997212">(</span><span class="ident" id="4997213">cc</span>&nbsp;<span class="op" id="4997216">*</span><span class="ident" id="4997217">ClientConn</span><span class="op" id="4997227">)</span>&nbsp;<span class="ident" id="4997229">Write</span><span class="op" id="4997234">(</span><span class="ident" id="4997235">req</span>&nbsp;<span class="op" id="4997239">*</span><span class="ident" id="4997240">http</span><span class="op" id="4997244">.</span><span class="ident" id="4997245">Request</span><span class="op" id="4997252">)</span>&nbsp;<span class="op" id="4997254">(</span><span class="ident" id="4997255">err</span>&nbsp;<span class="builtintype" id="4997259">error</span><span class="op" id="4997264">)</span>&nbsp;<span class="op" id="4997266">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997270">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997309">id</span>&nbsp;<span class="op" id="4997312">:=</span>&nbsp;<span class="ident" id="4997315">cc</span><span class="op" id="4997317">.</span><span class="ident" id="4997318">pipe</span><span class="op" id="4997322">.</span><span class="ident" id="4997323">Next</span><span class="op" id="4997327">(</span><span class="op" id="4997328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997331">cc</span><span class="op" id="4997333">.</span><span class="ident" id="4997334">pipe</span><span class="op" id="4997338">.</span><span class="ident" id="4997339">StartRequest</span><span class="op" id="4997351">(</span><span class="ident" id="4997352">id</span><span class="op" id="4997354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997357">defer</span>&nbsp;<span class="keyword" id="4997363">func</span><span class="op" id="4997367">(</span><span class="op" id="4997368">)</span>&nbsp;<span class="op" id="4997370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997374">cc</span><span class="op" id="4997376">.</span><span class="ident" id="4997377">pipe</span><span class="op" id="4997381">.</span><span class="ident" id="4997382">EndRequest</span><span class="op" id="4997392">(</span><span class="ident" id="4997393">id</span><span class="op" id="4997395">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997399">if</span>&nbsp;<span class="ident" id="4997402">err</span>&nbsp;<span class="op" id="4997406">!=</span>&nbsp;<span class="ident" id="4997409">nil</span>&nbsp;<span class="op" id="4997413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997418">cc</span><span class="op" id="4997420">.</span><span class="ident" id="4997421">pipe</span><span class="op" id="4997425">.</span><span class="ident" id="4997426">StartResponse</span><span class="op" id="4997439">(</span><span class="ident" id="4997440">id</span><span class="op" id="4997442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997447">cc</span><span class="op" id="4997449">.</span><span class="ident" id="4997450">pipe</span><span class="op" id="4997454">.</span><span class="ident" id="4997455">EndResponse</span><span class="op" id="4997466">(</span><span class="ident" id="4997467">id</span><span class="op" id="4997469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997473">}</span>&nbsp;<span class="keyword" id="4997475">else</span>&nbsp;<span class="op" id="4997480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997485">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997532">cc</span><span class="op" id="4997534">.</span><span class="ident" id="4997535">lk</span><span class="op" id="4997537">.</span><span class="ident" id="4997538">Lock</span><span class="op" id="4997542">(</span><span class="op" id="4997543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997548">cc</span><span class="op" id="4997550">.</span><span class="ident" id="4997551">pipereq</span><span class="op" id="4997558">[</span><span class="ident" id="4997559">req</span><span class="op" id="4997562">]</span>&nbsp;<span class="op" id="4997564">=</span>&nbsp;<span class="ident" id="4997566">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997572">cc</span><span class="op" id="4997574">.</span><span class="ident" id="4997575">lk</span><span class="op" id="4997577">.</span><span class="ident" id="4997578">Unlock</span><span class="op" id="4997584">(</span><span class="op" id="4997585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997592">}</span><span class="op" id="4997593">(</span><span class="op" id="4997594">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997598">cc</span><span class="op" id="4997600">.</span><span class="ident" id="4997601">lk</span><span class="op" id="4997603">.</span><span class="ident" id="4997604">Lock</span><span class="op" id="4997608">(</span><span class="op" id="4997609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997612">if</span>&nbsp;<span class="ident" id="4997615">cc</span><span class="op" id="4997617">.</span><span class="ident" id="4997618">re</span>&nbsp;<span class="op" id="4997621">!=</span>&nbsp;<span class="ident" id="4997624">nil</span>&nbsp;<span class="op" id="4997628">{</span>&nbsp;<span class="comment" id="4997630">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997682">defer</span>&nbsp;<span class="ident" id="4997688">cc</span><span class="op" id="4997690">.</span><span class="ident" id="4997691">lk</span><span class="op" id="4997693">.</span><span class="ident" id="4997694">Unlock</span><span class="op" id="4997700">(</span><span class="op" id="4997701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997705">return</span>&nbsp;<span class="ident" id="4997712">cc</span><span class="op" id="4997714">.</span><span class="ident" id="4997715">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997722">if</span>&nbsp;<span class="ident" id="4997725">cc</span><span class="op" id="4997727">.</span><span class="ident" id="4997728">we</span>&nbsp;<span class="op" id="4997731">!=</span>&nbsp;<span class="ident" id="4997734">nil</span>&nbsp;<span class="op" id="4997738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997742">defer</span>&nbsp;<span class="ident" id="4997748">cc</span><span class="op" id="4997750">.</span><span class="ident" id="4997751">lk</span><span class="op" id="4997753">.</span><span class="ident" id="4997754">Unlock</span><span class="op" id="4997760">(</span><span class="op" id="4997761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997765">return</span>&nbsp;<span class="ident" id="4997772">cc</span><span class="op" id="4997774">.</span><span class="ident" id="4997775">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997779">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997782">if</span>&nbsp;<span class="ident" id="4997785">cc</span><span class="op" id="4997787">.</span><span class="ident" id="4997788">c</span>&nbsp;<span class="op" id="4997790">==</span>&nbsp;<span class="ident" id="4997793">nil</span>&nbsp;<span class="op" id="4997797">{</span>&nbsp;<span class="comment" id="4997799">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997846">defer</span>&nbsp;<span class="ident" id="4997852">cc</span><span class="op" id="4997854">.</span><span class="ident" id="4997855">lk</span><span class="op" id="4997857">.</span><span class="ident" id="4997858">Unlock</span><span class="op" id="4997864">(</span><span class="op" id="4997865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997869">return</span>&nbsp;<span class="ident" id="4997876">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997890">c</span>&nbsp;<span class="op" id="4997892">:=</span>&nbsp;<span class="ident" id="4997895">cc</span><span class="op" id="4997897">.</span><span class="ident" id="4997898">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997901">if</span>&nbsp;<span class="ident" id="4997904">req</span><span class="op" id="4997907">.</span><span class="ident" id="4997908">Close</span>&nbsp;<span class="op" id="4997914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997918">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997979">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998020">cc</span><span class="op" id="4998022">.</span><span class="ident" id="4998023">we</span>&nbsp;<span class="op" id="4998026">=</span>&nbsp;<span class="ident" id="4998028">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998043">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998046">cc</span><span class="op" id="4998048">.</span><span class="ident" id="4998049">lk</span><span class="op" id="4998051">.</span><span class="ident" id="4998052">Unlock</span><span class="op" id="4998058">(</span><span class="op" id="4998059">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998063">err</span>&nbsp;<span class="op" id="4998067">=</span>&nbsp;<span class="ident" id="4998069">cc</span><span class="op" id="4998071">.</span><span class="ident" id="4998072">writeReq</span><span class="op" id="4998080">(</span><span class="ident" id="4998081">req</span><span class="op" id="4998084">,</span>&nbsp;<span class="ident" id="4998086">c</span><span class="op" id="4998087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998090">cc</span><span class="op" id="4998092">.</span><span class="ident" id="4998093">lk</span><span class="op" id="4998095">.</span><span class="ident" id="4998096">Lock</span><span class="op" id="4998100">(</span><span class="op" id="4998101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998104">defer</span>&nbsp;<span class="ident" id="4998110">cc</span><span class="op" id="4998112">.</span><span class="ident" id="4998113">lk</span><span class="op" id="4998115">.</span><span class="ident" id="4998116">Unlock</span><span class="op" id="4998122">(</span><span class="op" id="4998123">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998126">if</span>&nbsp;<span class="ident" id="4998129">err</span>&nbsp;<span class="op" id="4998133">!=</span>&nbsp;<span class="ident" id="4998136">nil</span>&nbsp;<span class="op" id="4998140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998144">cc</span><span class="op" id="4998146">.</span><span class="ident" id="4998147">we</span>&nbsp;<span class="op" id="4998150">=</span>&nbsp;<span class="ident" id="4998152">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998158">return</span>&nbsp;<span class="ident" id="4998165">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998173">cc</span><span class="op" id="4998175">.</span><span class="ident" id="4998176">nwritten</span><span class="op" id="4998184">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998189">return</span>&nbsp;<span class="ident" id="4998196">nil</span><br>
<span class="lineno"></span><span class="op" id="4998200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4998203">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="4998256">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4998298">func</span>&nbsp;<span class="op" id="4998303">(</span><span class="ident" id="4998304">cc</span>&nbsp;<span class="op" id="4998307">*</span><span class="ident" id="4998308">ClientConn</span><span class="op" id="4998318">)</span>&nbsp;<span class="ident" id="4998320">Pending</span><span class="op" id="4998327">(</span><span class="op" id="4998328">)</span>&nbsp;<span class="builtintype" id="4998330">int</span>&nbsp;<span class="op" id="4998334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998337">cc</span><span class="op" id="4998339">.</span><span class="ident" id="4998340">lk</span><span class="op" id="4998342">.</span><span class="ident" id="4998343">Lock</span><span class="op" id="4998347">(</span><span class="op" id="4998348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998351">defer</span>&nbsp;<span class="ident" id="4998357">cc</span><span class="op" id="4998359">.</span><span class="ident" id="4998360">lk</span><span class="op" id="4998362">.</span><span class="ident" id="4998363">Unlock</span><span class="op" id="4998369">(</span><span class="op" id="4998370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998373">return</span>&nbsp;<span class="ident" id="4998380">cc</span><span class="op" id="4998382">.</span><span class="ident" id="4998383">nwritten</span>&nbsp;<span class="op" id="4998392">-</span>&nbsp;<span class="ident" id="4998394">cc</span><span class="op" id="4998396">.</span><span class="ident" id="4998397">nread</span><br>
<span class="lineno">355</span><span class="op" id="4998403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4998406">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4998479">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="4998551">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="4998623">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="4998678">func</span>&nbsp;<span class="op" id="4998683">(</span><span class="ident" id="4998684">cc</span>&nbsp;<span class="op" id="4998687">*</span><span class="ident" id="4998688">ClientConn</span><span class="op" id="4998698">)</span>&nbsp;<span class="ident" id="4998700">Read</span><span class="op" id="4998704">(</span><span class="ident" id="4998705">req</span>&nbsp;<span class="op" id="4998709">*</span><span class="ident" id="4998710">http</span><span class="op" id="4998714">.</span><span class="ident" id="4998715">Request</span><span class="op" id="4998722">)</span>&nbsp;<span class="op" id="4998724">(</span><span class="ident" id="4998725">resp</span>&nbsp;<span class="op" id="4998730">*</span><span class="ident" id="4998731">http</span><span class="op" id="4998735">.</span><span class="ident" id="4998736">Response</span><span class="op" id="4998744">,</span>&nbsp;<span class="ident" id="4998746">err</span>&nbsp;<span class="builtintype" id="4998750">error</span><span class="op" id="4998755">)</span>&nbsp;<span class="op" id="4998757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4998760">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998819">cc</span><span class="op" id="4998821">.</span><span class="ident" id="4998822">lk</span><span class="op" id="4998824">.</span><span class="ident" id="4998825">Lock</span><span class="op" id="4998829">(</span><span class="op" id="4998830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998833">id</span><span class="op" id="4998835">,</span>&nbsp;<span class="ident" id="4998837">ok</span>&nbsp;<span class="op" id="4998840">:=</span>&nbsp;<span class="ident" id="4998843">cc</span><span class="op" id="4998845">.</span><span class="ident" id="4998846">pipereq</span><span class="op" id="4998853">[</span><span class="ident" id="4998854">req</span><span class="op" id="4998857">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4998860">delete</span><span class="op" id="4998866">(</span><span class="ident" id="4998867">cc</span><span class="op" id="4998869">.</span><span class="ident" id="4998870">pipereq</span><span class="op" id="4998877">,</span>&nbsp;<span class="ident" id="4998879">req</span><span class="op" id="4998882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998885">if</span>&nbsp;<span class="op" id="4998888">!</span><span class="ident" id="4998889">ok</span>&nbsp;<span class="op" id="4998892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998896">cc</span><span class="op" id="4998898">.</span><span class="ident" id="4998899">lk</span><span class="op" id="4998901">.</span><span class="ident" id="4998902">Unlock</span><span class="op" id="4998908">(</span><span class="op" id="4998909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998913">return</span>&nbsp;<span class="ident" id="4998920">nil</span><span class="op" id="4998923">,</span>&nbsp;<span class="ident" id="4998925">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998938">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998941">cc</span><span class="op" id="4998943">.</span><span class="ident" id="4998944">lk</span><span class="op" id="4998946">.</span><span class="ident" id="4998947">Unlock</span><span class="op" id="4998953">(</span><span class="op" id="4998954">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4998958">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998984">cc</span><span class="op" id="4998986">.</span><span class="ident" id="4998987">pipe</span><span class="op" id="4998991">.</span><span class="ident" id="4998992">StartResponse</span><span class="op" id="4999005">(</span><span class="ident" id="4999006">id</span><span class="op" id="4999008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999011">defer</span>&nbsp;<span class="ident" id="4999017">cc</span><span class="op" id="4999019">.</span><span class="ident" id="4999020">pipe</span><span class="op" id="4999024">.</span><span class="ident" id="4999025">EndResponse</span><span class="op" id="4999036">(</span><span class="ident" id="4999037">id</span><span class="op" id="4999039">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999043">cc</span><span class="op" id="4999045">.</span><span class="ident" id="4999046">lk</span><span class="op" id="4999048">.</span><span class="ident" id="4999049">Lock</span><span class="op" id="4999053">(</span><span class="op" id="4999054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999057">if</span>&nbsp;<span class="ident" id="4999060">cc</span><span class="op" id="4999062">.</span><span class="ident" id="4999063">re</span>&nbsp;<span class="op" id="4999066">!=</span>&nbsp;<span class="ident" id="4999069">nil</span>&nbsp;<span class="op" id="4999073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999077">defer</span>&nbsp;<span class="ident" id="4999083">cc</span><span class="op" id="4999085">.</span><span class="ident" id="4999086">lk</span><span class="op" id="4999088">.</span><span class="ident" id="4999089">Unlock</span><span class="op" id="4999095">(</span><span class="op" id="4999096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999100">return</span>&nbsp;<span class="ident" id="4999107">nil</span><span class="op" id="4999110">,</span>&nbsp;<span class="ident" id="4999112">cc</span><span class="op" id="4999114">.</span><span class="ident" id="4999115">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999122">if</span>&nbsp;<span class="ident" id="4999125">cc</span><span class="op" id="4999127">.</span><span class="ident" id="4999128">r</span>&nbsp;<span class="op" id="4999130">==</span>&nbsp;<span class="ident" id="4999133">nil</span>&nbsp;<span class="op" id="4999137">{</span>&nbsp;<span class="comment" id="4999139">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999186">defer</span>&nbsp;<span class="ident" id="4999192">cc</span><span class="op" id="4999194">.</span><span class="ident" id="4999195">lk</span><span class="op" id="4999197">.</span><span class="ident" id="4999198">Unlock</span><span class="op" id="4999204">(</span><span class="op" id="4999205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999209">return</span>&nbsp;<span class="ident" id="4999216">nil</span><span class="op" id="4999219">,</span>&nbsp;<span class="ident" id="4999221">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999232">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999235">r</span>&nbsp;<span class="op" id="4999237">:=</span>&nbsp;<span class="ident" id="4999240">cc</span><span class="op" id="4999242">.</span><span class="ident" id="4999243">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999246">lastbody</span>&nbsp;<span class="op" id="4999255">:=</span>&nbsp;<span class="ident" id="4999258">cc</span><span class="op" id="4999260">.</span><span class="ident" id="4999261">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999271">cc</span><span class="op" id="4999273">.</span><span class="ident" id="4999274">lastbody</span>&nbsp;<span class="op" id="4999283">=</span>&nbsp;<span class="ident" id="4999285">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999290">cc</span><span class="op" id="4999292">.</span><span class="ident" id="4999293">lk</span><span class="op" id="4999295">.</span><span class="ident" id="4999296">Unlock</span><span class="op" id="4999302">(</span><span class="op" id="4999303">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999307">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999383">if</span>&nbsp;<span class="ident" id="4999386">lastbody</span>&nbsp;<span class="op" id="4999395">!=</span>&nbsp;<span class="ident" id="4999398">nil</span>&nbsp;<span class="op" id="4999402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999406">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999472">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999530">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999545">err</span>&nbsp;<span class="op" id="4999549">=</span>&nbsp;<span class="ident" id="4999551">lastbody</span><span class="op" id="4999559">.</span><span class="ident" id="4999560">Close</span><span class="op" id="4999565">(</span><span class="op" id="4999566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999570">if</span>&nbsp;<span class="ident" id="4999573">err</span>&nbsp;<span class="op" id="4999577">!=</span>&nbsp;<span class="ident" id="4999580">nil</span>&nbsp;<span class="op" id="4999584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999589">cc</span><span class="op" id="4999591">.</span><span class="ident" id="4999592">lk</span><span class="op" id="4999594">.</span><span class="ident" id="4999595">Lock</span><span class="op" id="4999599">(</span><span class="op" id="4999600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999605">defer</span>&nbsp;<span class="ident" id="4999611">cc</span><span class="op" id="4999613">.</span><span class="ident" id="4999614">lk</span><span class="op" id="4999616">.</span><span class="ident" id="4999617">Unlock</span><span class="op" id="4999623">(</span><span class="op" id="4999624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999629">cc</span><span class="op" id="4999631">.</span><span class="ident" id="4999632">re</span>&nbsp;<span class="op" id="4999635">=</span>&nbsp;<span class="ident" id="4999637">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999644">return</span>&nbsp;<span class="ident" id="4999651">nil</span><span class="op" id="4999654">,</span>&nbsp;<span class="ident" id="4999656">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999669">resp</span><span class="op" id="4999673">,</span>&nbsp;<span class="ident" id="4999675">err</span>&nbsp;<span class="op" id="4999679">=</span>&nbsp;<span class="ident" id="4999681">http</span><span class="op" id="4999685">.</span><span class="ident" id="4999686">ReadResponse</span><span class="op" id="4999698">(</span><span class="ident" id="4999699">r</span><span class="op" id="4999700">,</span>&nbsp;<span class="ident" id="4999702">req</span><span class="op" id="4999705">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999708">cc</span><span class="op" id="4999710">.</span><span class="ident" id="4999711">lk</span><span class="op" id="4999713">.</span><span class="ident" id="4999714">Lock</span><span class="op" id="4999718">(</span><span class="op" id="4999719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999722">defer</span>&nbsp;<span class="ident" id="4999728">cc</span><span class="op" id="4999730">.</span><span class="ident" id="4999731">lk</span><span class="op" id="4999733">.</span><span class="ident" id="4999734">Unlock</span><span class="op" id="4999740">(</span><span class="op" id="4999741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999744">if</span>&nbsp;<span class="ident" id="4999747">err</span>&nbsp;<span class="op" id="4999751">!=</span>&nbsp;<span class="ident" id="4999754">nil</span>&nbsp;<span class="op" id="4999758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999762">cc</span><span class="op" id="4999764">.</span><span class="ident" id="4999765">re</span>&nbsp;<span class="op" id="4999768">=</span>&nbsp;<span class="ident" id="4999770">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999776">return</span>&nbsp;<span class="ident" id="4999783">resp</span><span class="op" id="4999787">,</span>&nbsp;<span class="ident" id="4999789">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999797">cc</span><span class="op" id="4999799">.</span><span class="ident" id="4999800">lastbody</span>&nbsp;<span class="op" id="4999809">=</span>&nbsp;<span class="ident" id="4999811">resp</span><span class="op" id="4999815">.</span><span class="ident" id="4999816">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999823">cc</span><span class="op" id="4999825">.</span><span class="ident" id="4999826">nread</span><span class="op" id="4999831">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999836">if</span>&nbsp;<span class="ident" id="4999839">resp</span><span class="op" id="4999843">.</span><span class="ident" id="4999844">Close</span>&nbsp;<span class="op" id="4999850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999854">cc</span><span class="op" id="4999856">.</span><span class="ident" id="4999857">re</span>&nbsp;<span class="op" id="4999860">=</span>&nbsp;<span class="ident" id="4999862">ErrPersistEOF</span>&nbsp;<span class="comment" id="4999876">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999910">return</span>&nbsp;<span class="ident" id="4999917">resp</span><span class="op" id="4999921">,</span>&nbsp;<span class="ident" id="4999923">cc</span><span class="op" id="4999925">.</span><span class="ident" id="4999926">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999933">return</span>&nbsp;<span class="ident" id="4999940">resp</span><span class="op" id="4999944">,</span>&nbsp;<span class="ident" id="4999946">err</span><br>
<span class="lineno">420</span><span class="op" id="4999950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4999953">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="5000025">func</span>&nbsp;<span class="op" id="5000030">(</span><span class="ident" id="5000031">cc</span>&nbsp;<span class="op" id="5000034">*</span><span class="ident" id="5000035">ClientConn</span><span class="op" id="5000045">)</span>&nbsp;<span class="ident" id="5000047">Do</span><span class="op" id="5000049">(</span><span class="ident" id="5000050">req</span>&nbsp;<span class="op" id="5000054">*</span><span class="ident" id="5000055">http</span><span class="op" id="5000059">.</span><span class="ident" id="5000060">Request</span><span class="op" id="5000067">)</span>&nbsp;<span class="op" id="5000069">(</span><span class="ident" id="5000070">resp</span>&nbsp;<span class="op" id="5000075">*</span><span class="ident" id="5000076">http</span><span class="op" id="5000080">.</span><span class="ident" id="5000081">Response</span><span class="op" id="5000089">,</span>&nbsp;<span class="ident" id="5000091">err</span>&nbsp;<span class="builtintype" id="5000095">error</span><span class="op" id="5000100">)</span>&nbsp;<span class="op" id="5000102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000105">err</span>&nbsp;<span class="op" id="5000109">=</span>&nbsp;<span class="ident" id="5000111">cc</span><span class="op" id="5000113">.</span><span class="ident" id="5000114">Write</span><span class="op" id="5000119">(</span><span class="ident" id="5000120">req</span><span class="op" id="5000123">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000126">if</span>&nbsp;<span class="ident" id="5000129">err</span>&nbsp;<span class="op" id="5000133">!=</span>&nbsp;<span class="ident" id="5000136">nil</span>&nbsp;<span class="op" id="5000140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000144">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000155">return</span>&nbsp;<span class="ident" id="5000162">cc</span><span class="op" id="5000164">.</span><span class="ident" id="5000165">Read</span><span class="op" id="5000169">(</span><span class="ident" id="5000170">req</span><span class="op" id="5000173">)</span><br>
<span class="lineno"></span><span class="op" id="5000175">}</span>
</div>
</body>
</html>
