<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html" class="current">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6181098">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6181153">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6181207">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6181258">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="6181307">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="6181358">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="6181435">package</span>&nbsp;<span class="ident" id="6181443">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6181449">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6181528">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6181542">import</span>&nbsp;<span class="op" id="6181549">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6181552">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6181561">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6181570">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6181589">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6181599">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6181605">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6181612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6181615">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6181658">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="6181713">type</span>&nbsp;<span class="ident" id="6181718">recType</span>&nbsp;<span class="builtintype" id="6181726">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6181733">const</span>&nbsp;<span class="op" id="6181739">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181742">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181762">recType</span>&nbsp;<span class="op" id="6181770">=</span>&nbsp;<span class="num" id="6181772">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181775">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181795">recType</span>&nbsp;<span class="op" id="6181803">=</span>&nbsp;<span class="num" id="6181805">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181808">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181828">recType</span>&nbsp;<span class="op" id="6181836">=</span>&nbsp;<span class="num" id="6181838">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181841">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181861">recType</span>&nbsp;<span class="op" id="6181869">=</span>&nbsp;<span class="num" id="6181871">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181874">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181894">recType</span>&nbsp;<span class="op" id="6181902">=</span>&nbsp;<span class="num" id="6181904">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181907">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181927">recType</span>&nbsp;<span class="op" id="6181935">=</span>&nbsp;<span class="num" id="6181937">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181940">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181960">recType</span>&nbsp;<span class="op" id="6181968">=</span>&nbsp;<span class="num" id="6181970">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181973">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181993">recType</span>&nbsp;<span class="op" id="6182001">=</span>&nbsp;<span class="num" id="6182003">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182006">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182026">recType</span>&nbsp;<span class="op" id="6182034">=</span>&nbsp;<span class="num" id="6182036">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182039">typeGetValuesResult</span>&nbsp;<span class="ident" id="6182059">recType</span>&nbsp;<span class="op" id="6182067">=</span>&nbsp;<span class="num" id="6182069">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182073">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182093">recType</span>&nbsp;<span class="op" id="6182101">=</span>&nbsp;<span class="num" id="6182103">11</span><br>
<span class="lineno"></span><span class="op" id="6182106">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="6182109">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="6182184">const</span>&nbsp;<span class="ident" id="6182190">flagKeepConn</span>&nbsp;<span class="op" id="6182203">=</span>&nbsp;<span class="num" id="6182205">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6182208">const</span>&nbsp;<span class="op" id="6182214">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182217">maxWrite</span>&nbsp;<span class="op" id="6182226">=</span>&nbsp;<span class="num" id="6182228">65535</span>&nbsp;<span class="comment" id="6182234">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182258">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6182267">=</span>&nbsp;<span class="num" id="6182269">255</span><br>
<span class="lineno"></span><span class="op" id="6182273">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6182276">const</span>&nbsp;<span class="op" id="6182282">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182285">roleResponder</span>&nbsp;<span class="op" id="6182299">=</span>&nbsp;<span class="ident" id="6182301">iota</span>&nbsp;<span class="op" id="6182306">+</span>&nbsp;<span class="num" id="6182308">1</span>&nbsp;<span class="comment" id="6182310">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182347">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182363">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="6182374">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6182377">const</span>&nbsp;<span class="op" id="6182383">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182386">statusRequestComplete</span>&nbsp;<span class="op" id="6182408">=</span>&nbsp;<span class="ident" id="6182410">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182416">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182437">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182455">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="6182473">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6182476">const</span>&nbsp;<span class="ident" id="6182482">headerLen</span>&nbsp;<span class="op" id="6182492">=</span>&nbsp;<span class="num" id="6182494">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6182497">type</span>&nbsp;<span class="ident" id="6182502">header</span>&nbsp;<span class="keyword" id="6182509">struct</span>&nbsp;<span class="op" id="6182516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182519">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6182533">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182540">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182554">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182563">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6182577">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182585">ContentLength</span>&nbsp;<span class="builtintype" id="6182599">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182607">PaddingLength</span>&nbsp;<span class="builtintype" id="6182621">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182628">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6182642">uint8</span><br>
<span class="lineno">70</span><span class="op" id="6182648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6182651">type</span>&nbsp;<span class="ident" id="6182656">beginRequest</span>&nbsp;<span class="keyword" id="6182669">struct</span>&nbsp;<span class="op" id="6182676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182679">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6182688">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182696">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6182705">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182712">reserved</span>&nbsp;<span class="op" id="6182721">[</span><span class="num" id="6182722">5</span><span class="op" id="6182723">]</span><span class="builtintype" id="6182724">uint8</span><br>
<span class="lineno"></span><span class="op" id="6182730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6182733">func</span>&nbsp;<span class="op" id="6182738">(</span><span class="ident" id="6182739">br</span>&nbsp;<span class="op" id="6182742">*</span><span class="ident" id="6182743">beginRequest</span><span class="op" id="6182755">)</span>&nbsp;<span class="ident" id="6182757">read</span><span class="op" id="6182761">(</span><span class="ident" id="6182762">content</span>&nbsp;<span class="op" id="6182770">[</span><span class="op" id="6182771">]</span><span class="builtintype" id="6182772">byte</span><span class="op" id="6182776">)</span>&nbsp;<span class="builtintype" id="6182778">error</span>&nbsp;<span class="op" id="6182784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182787">if</span>&nbsp;<span class="builtinfunc" id="6182790">len</span><span class="op" id="6182793">(</span><span class="ident" id="6182794">content</span><span class="op" id="6182801">)</span>&nbsp;<span class="op" id="6182803">!=</span>&nbsp;<span class="num" id="6182806">8</span>&nbsp;<span class="op" id="6182808">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182812">return</span>&nbsp;<span class="ident" id="6182819">errors</span><span class="op" id="6182825">.</span><span class="ident" id="6182826">New</span><span class="op" id="6182829">(</span><span class="string" id="6182830">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="6182866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6182869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182872">br</span><span class="op" id="6182874">.</span><span class="ident" id="6182875">role</span>&nbsp;<span class="op" id="6182880">=</span>&nbsp;<span class="ident" id="6182882">binary</span><span class="op" id="6182888">.</span><span class="ident" id="6182889">BigEndian</span><span class="op" id="6182898">.</span><span class="ident" id="6182899">Uint16</span><span class="op" id="6182905">(</span><span class="ident" id="6182906">content</span><span class="op" id="6182913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182916">br</span><span class="op" id="6182918">.</span><span class="ident" id="6182919">flags</span>&nbsp;<span class="op" id="6182925">=</span>&nbsp;<span class="ident" id="6182927">content</span><span class="op" id="6182934">[</span><span class="num" id="6182935">2</span><span class="op" id="6182936">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182939">return</span>&nbsp;<span class="ident" id="6182946">nil</span><br>
<span class="lineno">85</span><span class="op" id="6182950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6182953">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="6183010">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="6183074">var</span>&nbsp;<span class="ident" id="6183078">pad</span>&nbsp;<span class="op" id="6183082">[</span><span class="ident" id="6183083">maxPad</span><span class="op" id="6183089">]</span><span class="builtintype" id="6183090">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="6183096">func</span>&nbsp;<span class="op" id="6183101">(</span><span class="ident" id="6183102">h</span>&nbsp;<span class="op" id="6183104">*</span><span class="ident" id="6183105">header</span><span class="op" id="6183111">)</span>&nbsp;<span class="ident" id="6183113">init</span><span class="op" id="6183117">(</span><span class="ident" id="6183118">recType</span>&nbsp;<span class="ident" id="6183126">recType</span><span class="op" id="6183133">,</span>&nbsp;<span class="ident" id="6183135">reqId</span>&nbsp;<span class="builtintype" id="6183141">uint16</span><span class="op" id="6183147">,</span>&nbsp;<span class="ident" id="6183149">contentLength</span>&nbsp;<span class="builtintype" id="6183163">int</span><span class="op" id="6183166">)</span>&nbsp;<span class="op" id="6183168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183171">h</span><span class="op" id="6183172">.</span><span class="ident" id="6183173">Version</span>&nbsp;<span class="op" id="6183181">=</span>&nbsp;<span class="num" id="6183183">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183186">h</span><span class="op" id="6183187">.</span><span class="ident" id="6183188">Type</span>&nbsp;<span class="op" id="6183193">=</span>&nbsp;<span class="ident" id="6183195">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183204">h</span><span class="op" id="6183205">.</span><span class="ident" id="6183206">Id</span>&nbsp;<span class="op" id="6183209">=</span>&nbsp;<span class="ident" id="6183211">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183218">h</span><span class="op" id="6183219">.</span><span class="ident" id="6183220">ContentLength</span>&nbsp;<span class="op" id="6183234">=</span>&nbsp;<span class="builtintype" id="6183236">uint16</span><span class="op" id="6183242">(</span><span class="ident" id="6183243">contentLength</span><span class="op" id="6183256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183259">h</span><span class="op" id="6183260">.</span><span class="ident" id="6183261">PaddingLength</span>&nbsp;<span class="op" id="6183275">=</span>&nbsp;<span class="builtintype" id="6183277">uint8</span><span class="op" id="6183282">(</span><span class="op" id="6183283">-</span><span class="ident" id="6183284">contentLength</span>&nbsp;<span class="op" id="6183298">&amp;</span>&nbsp;<span class="num" id="6183300">7</span><span class="op" id="6183301">)</span><br>
<span class="lineno"></span><span class="op" id="6183303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6183306">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="6183337">type</span>&nbsp;<span class="ident" id="6183342">conn</span>&nbsp;<span class="keyword" id="6183347">struct</span>&nbsp;<span class="op" id="6183354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183357">mutex</span>&nbsp;<span class="ident" id="6183363">sync</span><span class="op" id="6183367">.</span><span class="ident" id="6183368">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183375">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6183381">io</span><span class="op" id="6183383">.</span><span class="ident" id="6183384">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6183402">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183427">buf</span>&nbsp;<span class="ident" id="6183431">bytes</span><span class="op" id="6183436">.</span><span class="ident" id="6183437">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183445">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6183449">header</span><br>
<span class="lineno"></span><span class="op" id="6183456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6183459">func</span>&nbsp;<span class="ident" id="6183464">newConn</span><span class="op" id="6183471">(</span><span class="ident" id="6183472">rwc</span>&nbsp;<span class="ident" id="6183476">io</span><span class="op" id="6183478">.</span><span class="ident" id="6183479">ReadWriteCloser</span><span class="op" id="6183494">)</span>&nbsp;<span class="op" id="6183496">*</span><span class="ident" id="6183497">conn</span>&nbsp;<span class="op" id="6183502">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6183505">return</span>&nbsp;<span class="op" id="6183512">&amp;</span><span class="ident" id="6183513">conn</span><span class="op" id="6183517">{</span><span class="ident" id="6183518">rwc</span><span class="op" id="6183521">:</span>&nbsp;<span class="ident" id="6183523">rwc</span><span class="op" id="6183526">}</span><br>
<span class="lineno"></span><span class="op" id="6183528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6183531">func</span>&nbsp;<span class="op" id="6183536">(</span><span class="ident" id="6183537">c</span>&nbsp;<span class="op" id="6183539">*</span><span class="ident" id="6183540">conn</span><span class="op" id="6183544">)</span>&nbsp;<span class="ident" id="6183546">Close</span><span class="op" id="6183551">(</span><span class="op" id="6183552">)</span>&nbsp;<span class="builtintype" id="6183554">error</span>&nbsp;<span class="op" id="6183560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183563">c</span><span class="op" id="6183564">.</span><span class="ident" id="6183565">mutex</span><span class="op" id="6183570">.</span><span class="ident" id="6183571">Lock</span><span class="op" id="6183575">(</span><span class="op" id="6183576">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6183579">defer</span>&nbsp;<span class="ident" id="6183585">c</span><span class="op" id="6183586">.</span><span class="ident" id="6183587">mutex</span><span class="op" id="6183592">.</span><span class="ident" id="6183593">Unlock</span><span class="op" id="6183599">(</span><span class="op" id="6183600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6183603">return</span>&nbsp;<span class="ident" id="6183610">c</span><span class="op" id="6183611">.</span><span class="ident" id="6183612">rwc</span><span class="op" id="6183615">.</span><span class="ident" id="6183616">Close</span><span class="op" id="6183621">(</span><span class="op" id="6183622">)</span><br>
<span class="lineno"></span><span class="op" id="6183624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6183627">type</span>&nbsp;<span class="ident" id="6183632">record</span>&nbsp;<span class="keyword" id="6183639">struct</span>&nbsp;<span class="op" id="6183646">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183649">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6183653">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183661">buf</span>&nbsp;<span class="op" id="6183665">[</span><span class="ident" id="6183666">maxWrite</span>&nbsp;<span class="op" id="6183675">+</span>&nbsp;<span class="ident" id="6183677">maxPad</span><span class="op" id="6183683">]</span><span class="builtintype" id="6183684">byte</span><br>
<span class="lineno"></span><span class="op" id="6183689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6183692">func</span>&nbsp;<span class="op" id="6183697">(</span><span class="ident" id="6183698">rec</span>&nbsp;<span class="op" id="6183702">*</span><span class="ident" id="6183703">record</span><span class="op" id="6183709">)</span>&nbsp;<span class="ident" id="6183711">read</span><span class="op" id="6183715">(</span><span class="ident" id="6183716">r</span>&nbsp;<span class="ident" id="6183718">io</span><span class="op" id="6183720">.</span><span class="ident" id="6183721">Reader</span><span class="op" id="6183727">)</span>&nbsp;<span class="op" id="6183729">(</span><span class="ident" id="6183730">err</span>&nbsp;<span class="builtintype" id="6183734">error</span><span class="op" id="6183739">)</span>&nbsp;<span class="op" id="6183741">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6183744">if</span>&nbsp;<span class="ident" id="6183747">err</span>&nbsp;<span class="op" id="6183751">=</span>&nbsp;<span class="ident" id="6183753">binary</span><span class="op" id="6183759">.</span><span class="ident" id="6183760">Read</span><span class="op" id="6183764">(</span><span class="ident" id="6183765">r</span><span class="op" id="6183766">,</span>&nbsp;<span class="ident" id="6183768">binary</span><span class="op" id="6183774">.</span><span class="ident" id="6183775">BigEndian</span><span class="op" id="6183784">,</span>&nbsp;<span class="op" id="6183786">&amp;</span><span class="ident" id="6183787">rec</span><span class="op" id="6183790">.</span><span class="ident" id="6183791">h</span><span class="op" id="6183792">)</span><span class="op" id="6183793">;</span>&nbsp;<span class="ident" id="6183795">err</span>&nbsp;<span class="op" id="6183799">!=</span>&nbsp;<span class="ident" id="6183802">nil</span>&nbsp;<span class="op" id="6183806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6183810">return</span>&nbsp;<span class="ident" id="6183817">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6183822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6183825">if</span>&nbsp;<span class="ident" id="6183828">rec</span><span class="op" id="6183831">.</span><span class="ident" id="6183832">h</span><span class="op" id="6183833">.</span><span class="ident" id="6183834">Version</span>&nbsp;<span class="op" id="6183842">!=</span>&nbsp;<span class="num" id="6183845">1</span>&nbsp;<span class="op" id="6183847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6183851">return</span>&nbsp;<span class="ident" id="6183858">errors</span><span class="op" id="6183864">.</span><span class="ident" id="6183865">New</span><span class="op" id="6183868">(</span><span class="string" id="6183869">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="6183899">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6183902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6183905">n</span>&nbsp;<span class="op" id="6183907">:=</span>&nbsp;<span class="builtintype" id="6183910">int</span><span class="op" id="6183913">(</span><span class="ident" id="6183914">rec</span><span class="op" id="6183917">.</span><span class="ident" id="6183918">h</span><span class="op" id="6183919">.</span><span class="ident" id="6183920">ContentLength</span><span class="op" id="6183933">)</span>&nbsp;<span class="op" id="6183935">+</span>&nbsp;<span class="builtintype" id="6183937">int</span><span class="op" id="6183940">(</span><span class="ident" id="6183941">rec</span><span class="op" id="6183944">.</span><span class="ident" id="6183945">h</span><span class="op" id="6183946">.</span><span class="ident" id="6183947">PaddingLength</span><span class="op" id="6183960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6183963">if</span>&nbsp;<span class="ident" id="6183966">_</span><span class="op" id="6183967">,</span>&nbsp;<span class="ident" id="6183969">err</span>&nbsp;<span class="op" id="6183973">=</span>&nbsp;<span class="ident" id="6183975">io</span><span class="op" id="6183977">.</span><span class="ident" id="6183978">ReadFull</span><span class="op" id="6183986">(</span><span class="ident" id="6183987">r</span><span class="op" id="6183988">,</span>&nbsp;<span class="ident" id="6183990">rec</span><span class="op" id="6183993">.</span><span class="ident" id="6183994">buf</span><span class="op" id="6183997">[</span><span class="op" id="6183998">:</span><span class="ident" id="6183999">n</span><span class="op" id="6184000">]</span><span class="op" id="6184001">)</span><span class="op" id="6184002">;</span>&nbsp;<span class="ident" id="6184004">err</span>&nbsp;<span class="op" id="6184008">!=</span>&nbsp;<span class="ident" id="6184011">nil</span>&nbsp;<span class="op" id="6184015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184019">return</span>&nbsp;<span class="ident" id="6184026">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6184031">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184034">return</span>&nbsp;<span class="ident" id="6184041">nil</span><br>
<span class="lineno"></span><span class="op" id="6184045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6184048">func</span>&nbsp;<span class="op" id="6184053">(</span><span class="ident" id="6184054">r</span>&nbsp;<span class="op" id="6184056">*</span><span class="ident" id="6184057">record</span><span class="op" id="6184063">)</span>&nbsp;<span class="ident" id="6184065">content</span><span class="op" id="6184072">(</span><span class="op" id="6184073">)</span>&nbsp;<span class="op" id="6184075">[</span><span class="op" id="6184076">]</span><span class="builtintype" id="6184077">byte</span>&nbsp;<span class="op" id="6184082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184085">return</span>&nbsp;<span class="ident" id="6184092">r</span><span class="op" id="6184093">.</span><span class="ident" id="6184094">buf</span><span class="op" id="6184097">[</span><span class="op" id="6184098">:</span><span class="ident" id="6184099">r</span><span class="op" id="6184100">.</span><span class="ident" id="6184101">h</span><span class="op" id="6184102">.</span><span class="ident" id="6184103">ContentLength</span><span class="op" id="6184116">]</span><br>
<span class="lineno">140</span><span class="op" id="6184118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6184121">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="6184170">func</span>&nbsp;<span class="op" id="6184175">(</span><span class="ident" id="6184176">c</span>&nbsp;<span class="op" id="6184178">*</span><span class="ident" id="6184179">conn</span><span class="op" id="6184183">)</span>&nbsp;<span class="ident" id="6184185">writeRecord</span><span class="op" id="6184196">(</span><span class="ident" id="6184197">recType</span>&nbsp;<span class="ident" id="6184205">recType</span><span class="op" id="6184212">,</span>&nbsp;<span class="ident" id="6184214">reqId</span>&nbsp;<span class="builtintype" id="6184220">uint16</span><span class="op" id="6184226">,</span>&nbsp;<span class="ident" id="6184228">b</span>&nbsp;<span class="op" id="6184230">[</span><span class="op" id="6184231">]</span><span class="builtintype" id="6184232">byte</span><span class="op" id="6184236">)</span>&nbsp;<span class="builtintype" id="6184238">error</span>&nbsp;<span class="op" id="6184244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6184247">c</span><span class="op" id="6184248">.</span><span class="ident" id="6184249">mutex</span><span class="op" id="6184254">.</span><span class="ident" id="6184255">Lock</span><span class="op" id="6184259">(</span><span class="op" id="6184260">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184263">defer</span>&nbsp;<span class="ident" id="6184269">c</span><span class="op" id="6184270">.</span><span class="ident" id="6184271">mutex</span><span class="op" id="6184276">.</span><span class="ident" id="6184277">Unlock</span><span class="op" id="6184283">(</span><span class="op" id="6184284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6184287">c</span><span class="op" id="6184288">.</span><span class="ident" id="6184289">buf</span><span class="op" id="6184292">.</span><span class="ident" id="6184293">Reset</span><span class="op" id="6184298">(</span><span class="op" id="6184299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6184302">c</span><span class="op" id="6184303">.</span><span class="ident" id="6184304">h</span><span class="op" id="6184305">.</span><span class="ident" id="6184306">init</span><span class="op" id="6184310">(</span><span class="ident" id="6184311">recType</span><span class="op" id="6184318">,</span>&nbsp;<span class="ident" id="6184320">reqId</span><span class="op" id="6184325">,</span>&nbsp;<span class="builtinfunc" id="6184327">len</span><span class="op" id="6184330">(</span><span class="ident" id="6184331">b</span><span class="op" id="6184332">)</span><span class="op" id="6184333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184336">if</span>&nbsp;<span class="ident" id="6184339">err</span>&nbsp;<span class="op" id="6184343">:=</span>&nbsp;<span class="ident" id="6184346">binary</span><span class="op" id="6184352">.</span><span class="ident" id="6184353">Write</span><span class="op" id="6184358">(</span><span class="op" id="6184359">&amp;</span><span class="ident" id="6184360">c</span><span class="op" id="6184361">.</span><span class="ident" id="6184362">buf</span><span class="op" id="6184365">,</span>&nbsp;<span class="ident" id="6184367">binary</span><span class="op" id="6184373">.</span><span class="ident" id="6184374">BigEndian</span><span class="op" id="6184383">,</span>&nbsp;<span class="ident" id="6184385">c</span><span class="op" id="6184386">.</span><span class="ident" id="6184387">h</span><span class="op" id="6184388">)</span><span class="op" id="6184389">;</span>&nbsp;<span class="ident" id="6184391">err</span>&nbsp;<span class="op" id="6184395">!=</span>&nbsp;<span class="ident" id="6184398">nil</span>&nbsp;<span class="op" id="6184402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184406">return</span>&nbsp;<span class="ident" id="6184413">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6184418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184421">if</span>&nbsp;<span class="ident" id="6184424">_</span><span class="op" id="6184425">,</span>&nbsp;<span class="ident" id="6184427">err</span>&nbsp;<span class="op" id="6184431">:=</span>&nbsp;<span class="ident" id="6184434">c</span><span class="op" id="6184435">.</span><span class="ident" id="6184436">buf</span><span class="op" id="6184439">.</span><span class="ident" id="6184440">Write</span><span class="op" id="6184445">(</span><span class="ident" id="6184446">b</span><span class="op" id="6184447">)</span><span class="op" id="6184448">;</span>&nbsp;<span class="ident" id="6184450">err</span>&nbsp;<span class="op" id="6184454">!=</span>&nbsp;<span class="ident" id="6184457">nil</span>&nbsp;<span class="op" id="6184461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184465">return</span>&nbsp;<span class="ident" id="6184472">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6184477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184480">if</span>&nbsp;<span class="ident" id="6184483">_</span><span class="op" id="6184484">,</span>&nbsp;<span class="ident" id="6184486">err</span>&nbsp;<span class="op" id="6184490">:=</span>&nbsp;<span class="ident" id="6184493">c</span><span class="op" id="6184494">.</span><span class="ident" id="6184495">buf</span><span class="op" id="6184498">.</span><span class="ident" id="6184499">Write</span><span class="op" id="6184504">(</span><span class="ident" id="6184505">pad</span><span class="op" id="6184508">[</span><span class="op" id="6184509">:</span><span class="ident" id="6184510">c</span><span class="op" id="6184511">.</span><span class="ident" id="6184512">h</span><span class="op" id="6184513">.</span><span class="ident" id="6184514">PaddingLength</span><span class="op" id="6184527">]</span><span class="op" id="6184528">)</span><span class="op" id="6184529">;</span>&nbsp;<span class="ident" id="6184531">err</span>&nbsp;<span class="op" id="6184535">!=</span>&nbsp;<span class="ident" id="6184538">nil</span>&nbsp;<span class="op" id="6184542">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184546">return</span>&nbsp;<span class="ident" id="6184553">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6184558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6184561">_</span><span class="op" id="6184562">,</span>&nbsp;<span class="ident" id="6184564">err</span>&nbsp;<span class="op" id="6184568">:=</span>&nbsp;<span class="ident" id="6184571">c</span><span class="op" id="6184572">.</span><span class="ident" id="6184573">rwc</span><span class="op" id="6184576">.</span><span class="ident" id="6184577">Write</span><span class="op" id="6184582">(</span><span class="ident" id="6184583">c</span><span class="op" id="6184584">.</span><span class="ident" id="6184585">buf</span><span class="op" id="6184588">.</span><span class="ident" id="6184589">Bytes</span><span class="op" id="6184594">(</span><span class="op" id="6184595">)</span><span class="op" id="6184596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184599">return</span>&nbsp;<span class="ident" id="6184606">err</span><br>
<span class="lineno"></span><span class="op" id="6184610">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="6184613">func</span>&nbsp;<span class="op" id="6184618">(</span><span class="ident" id="6184619">c</span>&nbsp;<span class="op" id="6184621">*</span><span class="ident" id="6184622">conn</span><span class="op" id="6184626">)</span>&nbsp;<span class="ident" id="6184628">writeBeginRequest</span><span class="op" id="6184645">(</span><span class="ident" id="6184646">reqId</span>&nbsp;<span class="builtintype" id="6184652">uint16</span><span class="op" id="6184658">,</span>&nbsp;<span class="ident" id="6184660">role</span>&nbsp;<span class="builtintype" id="6184665">uint16</span><span class="op" id="6184671">,</span>&nbsp;<span class="ident" id="6184673">flags</span>&nbsp;<span class="builtintype" id="6184679">uint8</span><span class="op" id="6184684">)</span>&nbsp;<span class="builtintype" id="6184686">error</span>&nbsp;<span class="op" id="6184692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6184695">b</span>&nbsp;<span class="op" id="6184697">:=</span>&nbsp;<span class="op" id="6184700">[</span><span class="num" id="6184701">8</span><span class="op" id="6184702">]</span><span class="builtintype" id="6184703">byte</span><span class="op" id="6184707">{</span><span class="builtintype" id="6184708">byte</span><span class="op" id="6184712">(</span><span class="ident" id="6184713">role</span>&nbsp;<span class="op" id="6184718">&gt;&gt;</span>&nbsp;<span class="num" id="6184721">8</span><span class="op" id="6184722">)</span><span class="op" id="6184723">,</span>&nbsp;<span class="builtintype" id="6184725">byte</span><span class="op" id="6184729">(</span><span class="ident" id="6184730">role</span><span class="op" id="6184734">)</span><span class="op" id="6184735">,</span>&nbsp;<span class="ident" id="6184737">flags</span><span class="op" id="6184742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184745">return</span>&nbsp;<span class="ident" id="6184752">c</span><span class="op" id="6184753">.</span><span class="ident" id="6184754">writeRecord</span><span class="op" id="6184765">(</span><span class="ident" id="6184766">typeBeginRequest</span><span class="op" id="6184782">,</span>&nbsp;<span class="ident" id="6184784">reqId</span><span class="op" id="6184789">,</span>&nbsp;<span class="ident" id="6184791">b</span><span class="op" id="6184792">[</span><span class="op" id="6184793">:</span><span class="op" id="6184794">]</span><span class="op" id="6184795">)</span><br>
<span class="lineno"></span><span class="op" id="6184797">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="6184800">func</span>&nbsp;<span class="op" id="6184805">(</span><span class="ident" id="6184806">c</span>&nbsp;<span class="op" id="6184808">*</span><span class="ident" id="6184809">conn</span><span class="op" id="6184813">)</span>&nbsp;<span class="ident" id="6184815">writeEndRequest</span><span class="op" id="6184830">(</span><span class="ident" id="6184831">reqId</span>&nbsp;<span class="builtintype" id="6184837">uint16</span><span class="op" id="6184843">,</span>&nbsp;<span class="ident" id="6184845">appStatus</span>&nbsp;<span class="builtintype" id="6184855">int</span><span class="op" id="6184858">,</span>&nbsp;<span class="ident" id="6184860">protocolStatus</span>&nbsp;<span class="builtintype" id="6184875">uint8</span><span class="op" id="6184880">)</span>&nbsp;<span class="builtintype" id="6184882">error</span>&nbsp;<span class="op" id="6184888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6184891">b</span>&nbsp;<span class="op" id="6184893">:=</span>&nbsp;<span class="builtinfunc" id="6184896">make</span><span class="op" id="6184900">(</span><span class="op" id="6184901">[</span><span class="op" id="6184902">]</span><span class="builtintype" id="6184903">byte</span><span class="op" id="6184907">,</span>&nbsp;<span class="num" id="6184909">8</span><span class="op" id="6184910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6184913">binary</span><span class="op" id="6184919">.</span><span class="ident" id="6184920">BigEndian</span><span class="op" id="6184929">.</span><span class="ident" id="6184930">PutUint32</span><span class="op" id="6184939">(</span><span class="ident" id="6184940">b</span><span class="op" id="6184941">,</span>&nbsp;<span class="builtintype" id="6184943">uint32</span><span class="op" id="6184949">(</span><span class="ident" id="6184950">appStatus</span><span class="op" id="6184959">)</span><span class="op" id="6184960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6184963">b</span><span class="op" id="6184964">[</span><span class="num" id="6184965">4</span><span class="op" id="6184966">]</span>&nbsp;<span class="op" id="6184968">=</span>&nbsp;<span class="ident" id="6184970">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6184986">return</span>&nbsp;<span class="ident" id="6184993">c</span><span class="op" id="6184994">.</span><span class="ident" id="6184995">writeRecord</span><span class="op" id="6185006">(</span><span class="ident" id="6185007">typeEndRequest</span><span class="op" id="6185021">,</span>&nbsp;<span class="ident" id="6185023">reqId</span><span class="op" id="6185028">,</span>&nbsp;<span class="ident" id="6185030">b</span><span class="op" id="6185031">)</span><br>
<span class="lineno"></span><span class="op" id="6185033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6185036">func</span>&nbsp;<span class="op" id="6185041">(</span><span class="ident" id="6185042">c</span>&nbsp;<span class="op" id="6185044">*</span><span class="ident" id="6185045">conn</span><span class="op" id="6185049">)</span>&nbsp;<span class="ident" id="6185051">writePairs</span><span class="op" id="6185061">(</span><span class="ident" id="6185062">recType</span>&nbsp;<span class="ident" id="6185070">recType</span><span class="op" id="6185077">,</span>&nbsp;<span class="ident" id="6185079">reqId</span>&nbsp;<span class="builtintype" id="6185085">uint16</span><span class="op" id="6185091">,</span>&nbsp;<span class="ident" id="6185093">pairs</span>&nbsp;<span class="keyword" id="6185099">map</span><span class="op" id="6185102">[</span><span class="builtintype" id="6185103">string</span><span class="op" id="6185109">]</span><span class="builtintype" id="6185110">string</span><span class="op" id="6185116">)</span>&nbsp;<span class="builtintype" id="6185118">error</span>&nbsp;<span class="op" id="6185124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6185127">w</span>&nbsp;<span class="op" id="6185129">:=</span>&nbsp;<span class="ident" id="6185132">newWriter</span><span class="op" id="6185141">(</span><span class="ident" id="6185142">c</span><span class="op" id="6185143">,</span>&nbsp;<span class="ident" id="6185145">recType</span><span class="op" id="6185152">,</span>&nbsp;<span class="ident" id="6185154">reqId</span><span class="op" id="6185159">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6185162">b</span>&nbsp;<span class="op" id="6185164">:=</span>&nbsp;<span class="builtinfunc" id="6185167">make</span><span class="op" id="6185171">(</span><span class="op" id="6185172">[</span><span class="op" id="6185173">]</span><span class="builtintype" id="6185174">byte</span><span class="op" id="6185178">,</span>&nbsp;<span class="num" id="6185180">8</span><span class="op" id="6185181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185184">for</span>&nbsp;<span class="ident" id="6185188">k</span><span class="op" id="6185189">,</span>&nbsp;<span class="ident" id="6185191">v</span>&nbsp;<span class="op" id="6185193">:=</span>&nbsp;<span class="keyword" id="6185196">range</span>&nbsp;<span class="ident" id="6185202">pairs</span>&nbsp;<span class="op" id="6185208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6185212">n</span>&nbsp;<span class="op" id="6185214">:=</span>&nbsp;<span class="ident" id="6185217">encodeSize</span><span class="op" id="6185227">(</span><span class="ident" id="6185228">b</span><span class="op" id="6185229">,</span>&nbsp;<span class="builtintype" id="6185231">uint32</span><span class="op" id="6185237">(</span><span class="builtinfunc" id="6185238">len</span><span class="op" id="6185241">(</span><span class="ident" id="6185242">k</span><span class="op" id="6185243">)</span><span class="op" id="6185244">)</span><span class="op" id="6185245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6185249">n</span>&nbsp;<span class="op" id="6185251">+=</span>&nbsp;<span class="ident" id="6185254">encodeSize</span><span class="op" id="6185264">(</span><span class="ident" id="6185265">b</span><span class="op" id="6185266">[</span><span class="ident" id="6185267">n</span><span class="op" id="6185268">:</span><span class="op" id="6185269">]</span><span class="op" id="6185270">,</span>&nbsp;<span class="builtintype" id="6185272">uint32</span><span class="op" id="6185278">(</span><span class="builtinfunc" id="6185279">len</span><span class="op" id="6185282">(</span><span class="ident" id="6185283">v</span><span class="op" id="6185284">)</span><span class="op" id="6185285">)</span><span class="op" id="6185286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185290">if</span>&nbsp;<span class="ident" id="6185293">_</span><span class="op" id="6185294">,</span>&nbsp;<span class="ident" id="6185296">err</span>&nbsp;<span class="op" id="6185300">:=</span>&nbsp;<span class="ident" id="6185303">w</span><span class="op" id="6185304">.</span><span class="ident" id="6185305">Write</span><span class="op" id="6185310">(</span><span class="ident" id="6185311">b</span><span class="op" id="6185312">[</span><span class="op" id="6185313">:</span><span class="ident" id="6185314">n</span><span class="op" id="6185315">]</span><span class="op" id="6185316">)</span><span class="op" id="6185317">;</span>&nbsp;<span class="ident" id="6185319">err</span>&nbsp;<span class="op" id="6185323">!=</span>&nbsp;<span class="ident" id="6185326">nil</span>&nbsp;<span class="op" id="6185330">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185335">return</span>&nbsp;<span class="ident" id="6185342">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6185348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185352">if</span>&nbsp;<span class="ident" id="6185355">_</span><span class="op" id="6185356">,</span>&nbsp;<span class="ident" id="6185358">err</span>&nbsp;<span class="op" id="6185362">:=</span>&nbsp;<span class="ident" id="6185365">w</span><span class="op" id="6185366">.</span><span class="ident" id="6185367">WriteString</span><span class="op" id="6185378">(</span><span class="ident" id="6185379">k</span><span class="op" id="6185380">)</span><span class="op" id="6185381">;</span>&nbsp;<span class="ident" id="6185383">err</span>&nbsp;<span class="op" id="6185387">!=</span>&nbsp;<span class="ident" id="6185390">nil</span>&nbsp;<span class="op" id="6185394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185399">return</span>&nbsp;<span class="ident" id="6185406">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6185412">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185416">if</span>&nbsp;<span class="ident" id="6185419">_</span><span class="op" id="6185420">,</span>&nbsp;<span class="ident" id="6185422">err</span>&nbsp;<span class="op" id="6185426">:=</span>&nbsp;<span class="ident" id="6185429">w</span><span class="op" id="6185430">.</span><span class="ident" id="6185431">WriteString</span><span class="op" id="6185442">(</span><span class="ident" id="6185443">v</span><span class="op" id="6185444">)</span><span class="op" id="6185445">;</span>&nbsp;<span class="ident" id="6185447">err</span>&nbsp;<span class="op" id="6185451">!=</span>&nbsp;<span class="ident" id="6185454">nil</span>&nbsp;<span class="op" id="6185458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185463">return</span>&nbsp;<span class="ident" id="6185470">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6185476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6185479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6185482">w</span><span class="op" id="6185483">.</span><span class="ident" id="6185484">Close</span><span class="op" id="6185489">(</span><span class="op" id="6185490">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185493">return</span>&nbsp;<span class="ident" id="6185500">nil</span><br>
<span class="lineno"></span><span class="op" id="6185504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6185507">func</span>&nbsp;<span class="ident" id="6185512">readSize</span><span class="op" id="6185520">(</span><span class="ident" id="6185521">s</span>&nbsp;<span class="op" id="6185523">[</span><span class="op" id="6185524">]</span><span class="builtintype" id="6185525">byte</span><span class="op" id="6185529">)</span>&nbsp;<span class="op" id="6185531">(</span><span class="builtintype" id="6185532">uint32</span><span class="op" id="6185538">,</span>&nbsp;<span class="builtintype" id="6185540">int</span><span class="op" id="6185543">)</span>&nbsp;<span class="op" id="6185545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185548">if</span>&nbsp;<span class="builtinfunc" id="6185551">len</span><span class="op" id="6185554">(</span><span class="ident" id="6185555">s</span><span class="op" id="6185556">)</span>&nbsp;<span class="op" id="6185558">==</span>&nbsp;<span class="num" id="6185561">0</span>&nbsp;<span class="op" id="6185563">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185567">return</span>&nbsp;<span class="num" id="6185574">0</span><span class="op" id="6185575">,</span>&nbsp;<span class="num" id="6185577">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6185580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6185583">size</span><span class="op" id="6185587">,</span>&nbsp;<span class="ident" id="6185589">n</span>&nbsp;<span class="op" id="6185591">:=</span>&nbsp;<span class="builtintype" id="6185594">uint32</span><span class="op" id="6185600">(</span><span class="ident" id="6185601">s</span><span class="op" id="6185602">[</span><span class="num" id="6185603">0</span><span class="op" id="6185604">]</span><span class="op" id="6185605">)</span><span class="op" id="6185606">,</span>&nbsp;<span class="num" id="6185608">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185611">if</span>&nbsp;<span class="ident" id="6185614">size</span><span class="op" id="6185618">&amp;</span><span class="op" id="6185619">(</span><span class="num" id="6185620">1</span><span class="op" id="6185621">&lt;&lt;</span><span class="num" id="6185623">7</span><span class="op" id="6185624">)</span>&nbsp;<span class="op" id="6185626">!=</span>&nbsp;<span class="num" id="6185629">0</span>&nbsp;<span class="op" id="6185631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185635">if</span>&nbsp;<span class="builtinfunc" id="6185638">len</span><span class="op" id="6185641">(</span><span class="ident" id="6185642">s</span><span class="op" id="6185643">)</span>&nbsp;<span class="op" id="6185645">&lt;</span>&nbsp;<span class="num" id="6185647">4</span>&nbsp;<span class="op" id="6185649">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185654">return</span>&nbsp;<span class="num" id="6185661">0</span><span class="op" id="6185662">,</span>&nbsp;<span class="num" id="6185664">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6185668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6185672">n</span>&nbsp;<span class="op" id="6185674">=</span>&nbsp;<span class="num" id="6185676">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6185680">size</span>&nbsp;<span class="op" id="6185685">=</span>&nbsp;<span class="ident" id="6185687">binary</span><span class="op" id="6185693">.</span><span class="ident" id="6185694">BigEndian</span><span class="op" id="6185703">.</span><span class="ident" id="6185704">Uint32</span><span class="op" id="6185710">(</span><span class="ident" id="6185711">s</span><span class="op" id="6185712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6185716">size</span>&nbsp;<span class="op" id="6185721">&amp;^=</span>&nbsp;<span class="num" id="6185725">1</span>&nbsp;<span class="op" id="6185727">&lt;&lt;</span>&nbsp;<span class="num" id="6185730">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6185734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185737">return</span>&nbsp;<span class="ident" id="6185744">size</span><span class="op" id="6185748">,</span>&nbsp;<span class="ident" id="6185750">n</span><br>
<span class="lineno"></span><span class="op" id="6185752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6185755">func</span>&nbsp;<span class="ident" id="6185760">readString</span><span class="op" id="6185770">(</span><span class="ident" id="6185771">s</span>&nbsp;<span class="op" id="6185773">[</span><span class="op" id="6185774">]</span><span class="builtintype" id="6185775">byte</span><span class="op" id="6185779">,</span>&nbsp;<span class="ident" id="6185781">size</span>&nbsp;<span class="builtintype" id="6185786">uint32</span><span class="op" id="6185792">)</span>&nbsp;<span class="builtintype" id="6185794">string</span>&nbsp;<span class="op" id="6185801">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185804">if</span>&nbsp;<span class="ident" id="6185807">size</span>&nbsp;<span class="op" id="6185812">&gt;</span>&nbsp;<span class="builtintype" id="6185814">uint32</span><span class="op" id="6185820">(</span><span class="builtinfunc" id="6185821">len</span><span class="op" id="6185824">(</span><span class="ident" id="6185825">s</span><span class="op" id="6185826">)</span><span class="op" id="6185827">)</span>&nbsp;<span class="op" id="6185829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185833">return</span>&nbsp;<span class="string" id="6185840">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6185844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185847">return</span>&nbsp;<span class="builtintype" id="6185854">string</span><span class="op" id="6185860">(</span><span class="ident" id="6185861">s</span><span class="op" id="6185862">[</span><span class="op" id="6185863">:</span><span class="ident" id="6185864">size</span><span class="op" id="6185868">]</span><span class="op" id="6185869">)</span><br>
<span class="lineno"></span><span class="op" id="6185871">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6185874">func</span>&nbsp;<span class="ident" id="6185879">encodeSize</span><span class="op" id="6185889">(</span><span class="ident" id="6185890">b</span>&nbsp;<span class="op" id="6185892">[</span><span class="op" id="6185893">]</span><span class="builtintype" id="6185894">byte</span><span class="op" id="6185898">,</span>&nbsp;<span class="ident" id="6185900">size</span>&nbsp;<span class="builtintype" id="6185905">uint32</span><span class="op" id="6185911">)</span>&nbsp;<span class="builtintype" id="6185913">int</span>&nbsp;<span class="op" id="6185917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185920">if</span>&nbsp;<span class="ident" id="6185923">size</span>&nbsp;<span class="op" id="6185928">&gt;</span>&nbsp;<span class="num" id="6185930">127</span>&nbsp;<span class="op" id="6185934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6185938">size</span>&nbsp;<span class="op" id="6185943">|=</span>&nbsp;<span class="num" id="6185946">1</span>&nbsp;<span class="op" id="6185948">&lt;&lt;</span>&nbsp;<span class="num" id="6185951">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6185956">binary</span><span class="op" id="6185962">.</span><span class="ident" id="6185963">BigEndian</span><span class="op" id="6185972">.</span><span class="ident" id="6185973">PutUint32</span><span class="op" id="6185982">(</span><span class="ident" id="6185983">b</span><span class="op" id="6185984">,</span>&nbsp;<span class="ident" id="6185986">size</span><span class="op" id="6185990">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6185994">return</span>&nbsp;<span class="num" id="6186001">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6186004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186007">b</span><span class="op" id="6186008">[</span><span class="num" id="6186009">0</span><span class="op" id="6186010">]</span>&nbsp;<span class="op" id="6186012">=</span>&nbsp;<span class="builtintype" id="6186014">byte</span><span class="op" id="6186018">(</span><span class="ident" id="6186019">size</span><span class="op" id="6186023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6186026">return</span>&nbsp;<span class="num" id="6186033">1</span><br>
<span class="lineno"></span><span class="op" id="6186035">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="6186038">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6186120">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6186131">type</span>&nbsp;<span class="ident" id="6186136">bufWriter</span>&nbsp;<span class="keyword" id="6186146">struct</span>&nbsp;<span class="op" id="6186153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186156">closer</span>&nbsp;<span class="ident" id="6186163">io</span><span class="op" id="6186165">.</span><span class="ident" id="6186166">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6186174">*</span><span class="ident" id="6186175">bufio</span><span class="op" id="6186180">.</span><span class="ident" id="6186181">Writer</span><br>
<span class="lineno"></span><span class="op" id="6186188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6186191">func</span>&nbsp;<span class="op" id="6186196">(</span><span class="ident" id="6186197">w</span>&nbsp;<span class="op" id="6186199">*</span><span class="ident" id="6186200">bufWriter</span><span class="op" id="6186209">)</span>&nbsp;<span class="ident" id="6186211">Close</span><span class="op" id="6186216">(</span><span class="op" id="6186217">)</span>&nbsp;<span class="builtintype" id="6186219">error</span>&nbsp;<span class="op" id="6186225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6186228">if</span>&nbsp;<span class="ident" id="6186231">err</span>&nbsp;<span class="op" id="6186235">:=</span>&nbsp;<span class="ident" id="6186238">w</span><span class="op" id="6186239">.</span><span class="ident" id="6186240">Writer</span><span class="op" id="6186246">.</span><span class="ident" id="6186247">Flush</span><span class="op" id="6186252">(</span><span class="op" id="6186253">)</span><span class="op" id="6186254">;</span>&nbsp;<span class="ident" id="6186256">err</span>&nbsp;<span class="op" id="6186260">!=</span>&nbsp;<span class="ident" id="6186263">nil</span>&nbsp;<span class="op" id="6186267">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186271">w</span><span class="op" id="6186272">.</span><span class="ident" id="6186273">closer</span><span class="op" id="6186279">.</span><span class="ident" id="6186280">Close</span><span class="op" id="6186285">(</span><span class="op" id="6186286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6186290">return</span>&nbsp;<span class="ident" id="6186297">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6186302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6186305">return</span>&nbsp;<span class="ident" id="6186312">w</span><span class="op" id="6186313">.</span><span class="ident" id="6186314">closer</span><span class="op" id="6186320">.</span><span class="ident" id="6186321">Close</span><span class="op" id="6186326">(</span><span class="op" id="6186327">)</span><br>
<span class="lineno"></span><span class="op" id="6186329">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="6186332">func</span>&nbsp;<span class="ident" id="6186337">newWriter</span><span class="op" id="6186346">(</span><span class="ident" id="6186347">c</span>&nbsp;<span class="op" id="6186349">*</span><span class="ident" id="6186350">conn</span><span class="op" id="6186354">,</span>&nbsp;<span class="ident" id="6186356">recType</span>&nbsp;<span class="ident" id="6186364">recType</span><span class="op" id="6186371">,</span>&nbsp;<span class="ident" id="6186373">reqId</span>&nbsp;<span class="builtintype" id="6186379">uint16</span><span class="op" id="6186385">)</span>&nbsp;<span class="op" id="6186387">*</span><span class="ident" id="6186388">bufWriter</span>&nbsp;<span class="op" id="6186398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186401">s</span>&nbsp;<span class="op" id="6186403">:=</span>&nbsp;<span class="op" id="6186406">&amp;</span><span class="ident" id="6186407">streamWriter</span><span class="op" id="6186419">{</span><span class="ident" id="6186420">c</span><span class="op" id="6186421">:</span>&nbsp;<span class="ident" id="6186423">c</span><span class="op" id="6186424">,</span>&nbsp;<span class="ident" id="6186426">recType</span><span class="op" id="6186433">:</span>&nbsp;<span class="ident" id="6186435">recType</span><span class="op" id="6186442">,</span>&nbsp;<span class="ident" id="6186444">reqId</span><span class="op" id="6186449">:</span>&nbsp;<span class="ident" id="6186451">reqId</span><span class="op" id="6186456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186459">w</span>&nbsp;<span class="op" id="6186461">:=</span>&nbsp;<span class="ident" id="6186464">bufio</span><span class="op" id="6186469">.</span><span class="ident" id="6186470">NewWriterSize</span><span class="op" id="6186483">(</span><span class="ident" id="6186484">s</span><span class="op" id="6186485">,</span>&nbsp;<span class="ident" id="6186487">maxWrite</span><span class="op" id="6186495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6186498">return</span>&nbsp;<span class="op" id="6186505">&amp;</span><span class="ident" id="6186506">bufWriter</span><span class="op" id="6186515">{</span><span class="ident" id="6186516">s</span><span class="op" id="6186517">,</span>&nbsp;<span class="ident" id="6186519">w</span><span class="op" id="6186520">}</span><br>
<span class="lineno">245</span><span class="op" id="6186522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6186525">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="6186605">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="6186649">type</span>&nbsp;<span class="ident" id="6186654">streamWriter</span>&nbsp;<span class="keyword" id="6186667">struct</span>&nbsp;<span class="op" id="6186674">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186677">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6186685">*</span><span class="ident" id="6186686">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186692">recType</span>&nbsp;<span class="ident" id="6186700">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186709">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6186717">uint16</span><br>
<span class="lineno"></span><span class="op" id="6186724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6186727">func</span>&nbsp;<span class="op" id="6186732">(</span><span class="ident" id="6186733">w</span>&nbsp;<span class="op" id="6186735">*</span><span class="ident" id="6186736">streamWriter</span><span class="op" id="6186748">)</span>&nbsp;<span class="ident" id="6186750">Write</span><span class="op" id="6186755">(</span><span class="ident" id="6186756">p</span>&nbsp;<span class="op" id="6186758">[</span><span class="op" id="6186759">]</span><span class="builtintype" id="6186760">byte</span><span class="op" id="6186764">)</span>&nbsp;<span class="op" id="6186766">(</span><span class="builtintype" id="6186767">int</span><span class="op" id="6186770">,</span>&nbsp;<span class="builtintype" id="6186772">error</span><span class="op" id="6186777">)</span>&nbsp;<span class="op" id="6186779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186782">nn</span>&nbsp;<span class="op" id="6186785">:=</span>&nbsp;<span class="num" id="6186788">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6186791">for</span>&nbsp;<span class="builtinfunc" id="6186795">len</span><span class="op" id="6186798">(</span><span class="ident" id="6186799">p</span><span class="op" id="6186800">)</span>&nbsp;<span class="op" id="6186802">&gt;</span>&nbsp;<span class="num" id="6186804">0</span>&nbsp;<span class="op" id="6186806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186810">n</span>&nbsp;<span class="op" id="6186812">:=</span>&nbsp;<span class="builtinfunc" id="6186815">len</span><span class="op" id="6186818">(</span><span class="ident" id="6186819">p</span><span class="op" id="6186820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6186824">if</span>&nbsp;<span class="ident" id="6186827">n</span>&nbsp;<span class="op" id="6186829">&gt;</span>&nbsp;<span class="ident" id="6186831">maxWrite</span>&nbsp;<span class="op" id="6186840">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186845">n</span>&nbsp;<span class="op" id="6186847">=</span>&nbsp;<span class="ident" id="6186849">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6186860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6186864">if</span>&nbsp;<span class="ident" id="6186867">err</span>&nbsp;<span class="op" id="6186871">:=</span>&nbsp;<span class="ident" id="6186874">w</span><span class="op" id="6186875">.</span><span class="ident" id="6186876">c</span><span class="op" id="6186877">.</span><span class="ident" id="6186878">writeRecord</span><span class="op" id="6186889">(</span><span class="ident" id="6186890">w</span><span class="op" id="6186891">.</span><span class="ident" id="6186892">recType</span><span class="op" id="6186899">,</span>&nbsp;<span class="ident" id="6186901">w</span><span class="op" id="6186902">.</span><span class="ident" id="6186903">reqId</span><span class="op" id="6186908">,</span>&nbsp;<span class="ident" id="6186910">p</span><span class="op" id="6186911">[</span><span class="op" id="6186912">:</span><span class="ident" id="6186913">n</span><span class="op" id="6186914">]</span><span class="op" id="6186915">)</span><span class="op" id="6186916">;</span>&nbsp;<span class="ident" id="6186918">err</span>&nbsp;<span class="op" id="6186922">!=</span>&nbsp;<span class="ident" id="6186925">nil</span>&nbsp;<span class="op" id="6186929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6186934">return</span>&nbsp;<span class="ident" id="6186941">nn</span><span class="op" id="6186943">,</span>&nbsp;<span class="ident" id="6186945">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6186951">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186955">nn</span>&nbsp;<span class="op" id="6186958">+=</span>&nbsp;<span class="ident" id="6186961">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6186965">p</span>&nbsp;<span class="op" id="6186967">=</span>&nbsp;<span class="ident" id="6186969">p</span><span class="op" id="6186970">[</span><span class="ident" id="6186971">n</span><span class="op" id="6186972">:</span><span class="op" id="6186973">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6186976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6186979">return</span>&nbsp;<span class="ident" id="6186986">nn</span><span class="op" id="6186988">,</span>&nbsp;<span class="ident" id="6186990">nil</span><br>
<span class="lineno"></span><span class="op" id="6186994">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6186997">func</span>&nbsp;<span class="op" id="6187002">(</span><span class="ident" id="6187003">w</span>&nbsp;<span class="op" id="6187005">*</span><span class="ident" id="6187006">streamWriter</span><span class="op" id="6187018">)</span>&nbsp;<span class="ident" id="6187020">Close</span><span class="op" id="6187025">(</span><span class="op" id="6187026">)</span>&nbsp;<span class="builtintype" id="6187028">error</span>&nbsp;<span class="op" id="6187034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6187037">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6187079">return</span>&nbsp;<span class="ident" id="6187086">w</span><span class="op" id="6187087">.</span><span class="ident" id="6187088">c</span><span class="op" id="6187089">.</span><span class="ident" id="6187090">writeRecord</span><span class="op" id="6187101">(</span><span class="ident" id="6187102">w</span><span class="op" id="6187103">.</span><span class="ident" id="6187104">recType</span><span class="op" id="6187111">,</span>&nbsp;<span class="ident" id="6187113">w</span><span class="op" id="6187114">.</span><span class="ident" id="6187115">reqId</span><span class="op" id="6187120">,</span>&nbsp;<span class="ident" id="6187122">nil</span><span class="op" id="6187125">)</span><br>
<span class="lineno"></span><span class="op" id="6187127">}</span>
</div>
</body>
</html>
