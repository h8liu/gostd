<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html" class="current">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3071647">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3071703">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3071757">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3071808">package</span>&nbsp;<span class="ident" id="3071816">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3071822">import</span>&nbsp;<span class="op" id="3071829">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3071832">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3071842">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3071848">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3071859">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3071862">//&nbsp;smallPrimes&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;small,&nbsp;prime&nbsp;numbers&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;rapidly</span><br>
<span class="lineno"></span><span class="comment" id="3071937">//&nbsp;exclude&nbsp;some&nbsp;fraction&nbsp;of&nbsp;composite&nbsp;candidates&nbsp;when&nbsp;searching&nbsp;for&nbsp;a&nbsp;random</span><br>
<span class="lineno">15</span><span class="comment" id="3072014">//&nbsp;prime.&nbsp;This&nbsp;list&nbsp;is&nbsp;truncated&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;smallPrimesProduct&nbsp;exceeds</span><br>
<span class="lineno"></span><span class="comment" id="3072093">//&nbsp;a&nbsp;uint64.&nbsp;It&nbsp;does&nbsp;not&nbsp;include&nbsp;two&nbsp;because&nbsp;we&nbsp;ensure&nbsp;that&nbsp;the&nbsp;candidates&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3072172">//&nbsp;odd&nbsp;by&nbsp;construction.</span><br>
<span class="lineno"></span><span class="keyword" id="3072196">var</span>&nbsp;<span class="ident" id="3072200">smallPrimes</span>&nbsp;<span class="op" id="3072212">=</span>&nbsp;<span class="op" id="3072214">[</span><span class="op" id="3072215">]</span><span class="builtintype" id="3072216">uint8</span><span class="op" id="3072221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="3072224">3</span><span class="op" id="3072225">,</span>&nbsp;<span class="num" id="3072227">5</span><span class="op" id="3072228">,</span>&nbsp;<span class="num" id="3072230">7</span><span class="op" id="3072231">,</span>&nbsp;<span class="num" id="3072233">11</span><span class="op" id="3072235">,</span>&nbsp;<span class="num" id="3072237">13</span><span class="op" id="3072239">,</span>&nbsp;<span class="num" id="3072241">17</span><span class="op" id="3072243">,</span>&nbsp;<span class="num" id="3072245">19</span><span class="op" id="3072247">,</span>&nbsp;<span class="num" id="3072249">23</span><span class="op" id="3072251">,</span>&nbsp;<span class="num" id="3072253">29</span><span class="op" id="3072255">,</span>&nbsp;<span class="num" id="3072257">31</span><span class="op" id="3072259">,</span>&nbsp;<span class="num" id="3072261">37</span><span class="op" id="3072263">,</span>&nbsp;<span class="num" id="3072265">41</span><span class="op" id="3072267">,</span>&nbsp;<span class="num" id="3072269">43</span><span class="op" id="3072271">,</span>&nbsp;<span class="num" id="3072273">47</span><span class="op" id="3072275">,</span>&nbsp;<span class="num" id="3072277">53</span><span class="op" id="3072279">,</span><br>
<span class="lineno">20</span><span class="op" id="3072281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3072284">//&nbsp;smallPrimesProduct&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;the&nbsp;values&nbsp;in&nbsp;smallPrimes&nbsp;and&nbsp;allows&nbsp;us</span><br>
<span class="lineno"></span><span class="comment" id="3072364">//&nbsp;to&nbsp;reduce&nbsp;a&nbsp;candidate&nbsp;prime&nbsp;by&nbsp;this&nbsp;number&nbsp;and&nbsp;then&nbsp;determine&nbsp;whether&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3072442">//&nbsp;coprime&nbsp;to&nbsp;all&nbsp;the&nbsp;elements&nbsp;of&nbsp;smallPrimes&nbsp;without&nbsp;further&nbsp;big.Int</span><br>
<span class="lineno">25</span><span class="comment" id="3072512">//&nbsp;operations.</span><br>
<span class="lineno"></span><span class="keyword" id="3072527">var</span>&nbsp;<span class="ident" id="3072531">smallPrimesProduct</span>&nbsp;<span class="op" id="3072550">=</span>&nbsp;<span class="builtinfunc" id="3072552">new</span><span class="op" id="3072555">(</span><span class="ident" id="3072556">big</span><span class="op" id="3072559">.</span><span class="ident" id="3072560">Int</span><span class="op" id="3072563">)</span><span class="op" id="3072564">.</span><span class="ident" id="3072565">SetUint64</span><span class="op" id="3072574">(</span><span class="num" id="3072575">16294579238595022365</span><span class="op" id="3072595">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3072598">//&nbsp;Prime&nbsp;returns&nbsp;a&nbsp;number,&nbsp;p,&nbsp;of&nbsp;the&nbsp;given&nbsp;size,&nbsp;such&nbsp;that&nbsp;p&nbsp;is&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment" id="3072668">//&nbsp;with&nbsp;high&nbsp;probability.</span><br>
<span class="lineno">30</span><span class="comment" id="3072694">//&nbsp;Prime&nbsp;will&nbsp;return&nbsp;error&nbsp;for&nbsp;any&nbsp;error&nbsp;returned&nbsp;by&nbsp;rand.Read&nbsp;or&nbsp;if&nbsp;bits&nbsp;&lt;&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="3072773">func</span>&nbsp;<span class="ident" id="3072778">Prime</span><span class="op" id="3072783">(</span><span class="ident" id="3072784">rand</span>&nbsp;<span class="ident" id="3072789">io</span><span class="op" id="3072791">.</span><span class="ident" id="3072792">Reader</span><span class="op" id="3072798">,</span>&nbsp;<span class="ident" id="3072800">bits</span>&nbsp;<span class="builtintype" id="3072805">int</span><span class="op" id="3072808">)</span>&nbsp;<span class="op" id="3072810">(</span><span class="ident" id="3072811">p</span>&nbsp;<span class="op" id="3072813">*</span><span class="ident" id="3072814">big</span><span class="op" id="3072817">.</span><span class="ident" id="3072818">Int</span><span class="op" id="3072821">,</span>&nbsp;<span class="ident" id="3072823">err</span>&nbsp;<span class="builtintype" id="3072827">error</span><span class="op" id="3072832">)</span>&nbsp;<span class="op" id="3072834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072837">if</span>&nbsp;<span class="ident" id="3072840">bits</span>&nbsp;<span class="op" id="3072845">&lt;</span>&nbsp;<span class="num" id="3072847">2</span>&nbsp;<span class="op" id="3072849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072853">err</span>&nbsp;<span class="op" id="3072857">=</span>&nbsp;<span class="ident" id="3072859">errors</span><span class="op" id="3072865">.</span><span class="ident" id="3072866">New</span><span class="op" id="3072869">(</span><span class="string" id="3072870">&#34;crypto/rand:&nbsp;prime&nbsp;size&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;2-bit&#34;</span><span class="op" id="3072918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072922">return</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072934">b</span>&nbsp;<span class="op" id="3072936">:=</span>&nbsp;<span class="builtintype" id="3072939">uint</span><span class="op" id="3072943">(</span><span class="ident" id="3072944">bits</span>&nbsp;<span class="op" id="3072949">%</span>&nbsp;<span class="num" id="3072951">8</span><span class="op" id="3072952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072955">if</span>&nbsp;<span class="ident" id="3072958">b</span>&nbsp;<span class="op" id="3072960">==</span>&nbsp;<span class="num" id="3072963">0</span>&nbsp;<span class="op" id="3072965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072969">b</span>&nbsp;<span class="op" id="3072971">=</span>&nbsp;<span class="num" id="3072973">8</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072980">bytes</span>&nbsp;<span class="op" id="3072986">:=</span>&nbsp;<span class="builtinfunc" id="3072989">make</span><span class="op" id="3072993">(</span><span class="op" id="3072994">[</span><span class="op" id="3072995">]</span><span class="builtintype" id="3072996">byte</span><span class="op" id="3073000">,</span>&nbsp;<span class="op" id="3073002">(</span><span class="ident" id="3073003">bits</span><span class="op" id="3073007">+</span><span class="num" id="3073008">7</span><span class="op" id="3073009">)</span><span class="op" id="3073010">/</span><span class="num" id="3073011">8</span><span class="op" id="3073012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073015">p</span>&nbsp;<span class="op" id="3073017">=</span>&nbsp;<span class="builtinfunc" id="3073019">new</span><span class="op" id="3073022">(</span><span class="ident" id="3073023">big</span><span class="op" id="3073026">.</span><span class="ident" id="3073027">Int</span><span class="op" id="3073030">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073034">bigMod</span>&nbsp;<span class="op" id="3073041">:=</span>&nbsp;<span class="builtinfunc" id="3073044">new</span><span class="op" id="3073047">(</span><span class="ident" id="3073048">big</span><span class="op" id="3073051">.</span><span class="ident" id="3073052">Int</span><span class="op" id="3073055">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073059">for</span>&nbsp;<span class="op" id="3073063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073067">_</span><span class="op" id="3073068">,</span>&nbsp;<span class="ident" id="3073070">err</span>&nbsp;<span class="op" id="3073074">=</span>&nbsp;<span class="ident" id="3073076">io</span><span class="op" id="3073078">.</span><span class="ident" id="3073079">ReadFull</span><span class="op" id="3073087">(</span><span class="ident" id="3073088">rand</span><span class="op" id="3073092">,</span>&nbsp;<span class="ident" id="3073094">bytes</span><span class="op" id="3073099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073103">if</span>&nbsp;<span class="ident" id="3073106">err</span>&nbsp;<span class="op" id="3073110">!=</span>&nbsp;<span class="builtintype" id="3073113">nil</span>&nbsp;<span class="op" id="3073117">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073122">return</span>&nbsp;<span class="builtintype" id="3073129">nil</span><span class="op" id="3073132">,</span>&nbsp;<span class="ident" id="3073134">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073145">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;candidate&nbsp;has&nbsp;a&nbsp;size&nbsp;&lt;=&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073226">bytes</span><span class="op" id="3073231">[</span><span class="num" id="3073232">0</span><span class="op" id="3073233">]</span>&nbsp;<span class="op" id="3073235">&amp;=</span>&nbsp;<span class="builtintype" id="3073238">uint8</span><span class="op" id="3073243">(</span><span class="builtintype" id="3073244">int</span><span class="op" id="3073247">(</span><span class="num" id="3073248">1</span><span class="op" id="3073249">&lt;&lt;</span><span class="ident" id="3073251">b</span><span class="op" id="3073252">)</span>&nbsp;<span class="op" id="3073254">-</span>&nbsp;<span class="num" id="3073256">1</span><span class="op" id="3073257">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073261">//&nbsp;Don&#39;t&nbsp;let&nbsp;the&nbsp;value&nbsp;be&nbsp;too&nbsp;small,&nbsp;i.e,&nbsp;set&nbsp;the&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073340">//&nbsp;Setting&nbsp;the&nbsp;top&nbsp;two&nbsp;bits,&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;top&nbsp;bit,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073401">//&nbsp;means&nbsp;that&nbsp;when&nbsp;two&nbsp;of&nbsp;these&nbsp;values&nbsp;are&nbsp;multiplied&nbsp;together,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073467">//&nbsp;the&nbsp;result&nbsp;isn&#39;t&nbsp;ever&nbsp;one&nbsp;bit&nbsp;short.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073509">if</span>&nbsp;<span class="ident" id="3073512">b</span>&nbsp;<span class="op" id="3073514">&gt;=</span>&nbsp;<span class="num" id="3073517">2</span>&nbsp;<span class="op" id="3073519">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073524">bytes</span><span class="op" id="3073529">[</span><span class="num" id="3073530">0</span><span class="op" id="3073531">]</span>&nbsp;<span class="op" id="3073533">|=</span>&nbsp;<span class="num" id="3073536">3</span>&nbsp;<span class="op" id="3073538">&lt;&lt;</span>&nbsp;<span class="op" id="3073541">(</span><span class="ident" id="3073542">b</span>&nbsp;<span class="op" id="3073544">-</span>&nbsp;<span class="num" id="3073546">2</span><span class="op" id="3073547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073551">}</span>&nbsp;<span class="keyword" id="3073553">else</span>&nbsp;<span class="op" id="3073558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073563">//&nbsp;Here&nbsp;b==1,&nbsp;because&nbsp;b&nbsp;cannot&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073606">bytes</span><span class="op" id="3073611">[</span><span class="num" id="3073612">0</span><span class="op" id="3073613">]</span>&nbsp;<span class="op" id="3073615">|=</span>&nbsp;<span class="num" id="3073618">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073623">if</span>&nbsp;<span class="builtinfunc" id="3073626">len</span><span class="op" id="3073629">(</span><span class="ident" id="3073630">bytes</span><span class="op" id="3073635">)</span>&nbsp;<span class="op" id="3073637">&gt;</span>&nbsp;<span class="num" id="3073639">1</span>&nbsp;<span class="op" id="3073641">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073647">bytes</span><span class="op" id="3073652">[</span><span class="num" id="3073653">1</span><span class="op" id="3073654">]</span>&nbsp;<span class="op" id="3073656">|=</span>&nbsp;<span class="num" id="3073659">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073675">//&nbsp;Make&nbsp;the&nbsp;value&nbsp;odd&nbsp;since&nbsp;an&nbsp;even&nbsp;number&nbsp;this&nbsp;large&nbsp;certainly&nbsp;isn&#39;t&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073754">bytes</span><span class="op" id="3073759">[</span><span class="builtinfunc" id="3073760">len</span><span class="op" id="3073763">(</span><span class="ident" id="3073764">bytes</span><span class="op" id="3073769">)</span><span class="op" id="3073770">-</span><span class="num" id="3073771">1</span><span class="op" id="3073772">]</span>&nbsp;<span class="op" id="3073774">|=</span>&nbsp;<span class="num" id="3073777">1</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073782">p</span><span class="op" id="3073783">.</span><span class="ident" id="3073784">SetBytes</span><span class="op" id="3073792">(</span><span class="ident" id="3073793">bytes</span><span class="op" id="3073798">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073803">//&nbsp;Calculate&nbsp;the&nbsp;value&nbsp;mod&nbsp;the&nbsp;product&nbsp;of&nbsp;smallPrimes.&nbsp;&nbsp;If&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073869">//&nbsp;a&nbsp;multiple&nbsp;of&nbsp;any&nbsp;of&nbsp;these&nbsp;primes&nbsp;we&nbsp;add&nbsp;two&nbsp;until&nbsp;it&nbsp;isn&#39;t.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073935">//&nbsp;The&nbsp;probability&nbsp;of&nbsp;overflowing&nbsp;is&nbsp;minimal&nbsp;and&nbsp;can&nbsp;be&nbsp;ignored</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3074001">//&nbsp;because&nbsp;we&nbsp;still&nbsp;perform&nbsp;Miller-Rabin&nbsp;tests&nbsp;on&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074065">bigMod</span><span class="op" id="3074071">.</span><span class="ident" id="3074072">Mod</span><span class="op" id="3074075">(</span><span class="ident" id="3074076">p</span><span class="op" id="3074077">,</span>&nbsp;<span class="ident" id="3074079">smallPrimesProduct</span><span class="op" id="3074097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074101">mod</span>&nbsp;<span class="op" id="3074105">:=</span>&nbsp;<span class="ident" id="3074108">bigMod</span><span class="op" id="3074114">.</span><span class="ident" id="3074115">Uint64</span><span class="op" id="3074121">(</span><span class="op" id="3074122">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074126">NextDelta</span><span class="op" id="3074135">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074139">for</span>&nbsp;<span class="ident" id="3074143">delta</span>&nbsp;<span class="op" id="3074149">:=</span>&nbsp;<span class="ident" id="3074152">uint64</span><span class="op" id="3074158">(</span><span class="num" id="3074159">0</span><span class="op" id="3074160">)</span><span class="op" id="3074161">;</span>&nbsp;<span class="ident" id="3074163">delta</span>&nbsp;<span class="op" id="3074169">&lt;</span>&nbsp;<span class="num" id="3074171">1</span><span class="op" id="3074172">&lt;&lt;</span><span class="num" id="3074174">20</span><span class="op" id="3074176">;</span>&nbsp;<span class="ident" id="3074178">delta</span>&nbsp;<span class="op" id="3074184">+=</span>&nbsp;<span class="num" id="3074187">2</span>&nbsp;<span class="op" id="3074189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074194">m</span>&nbsp;<span class="op" id="3074196">:=</span>&nbsp;<span class="ident" id="3074199">mod</span>&nbsp;<span class="op" id="3074203">+</span>&nbsp;<span class="ident" id="3074205">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074214">for</span>&nbsp;<span class="ident" id="3074218">_</span><span class="op" id="3074219">,</span>&nbsp;<span class="ident" id="3074221">prime</span>&nbsp;<span class="op" id="3074227">:=</span>&nbsp;<span class="keyword" id="3074230">range</span>&nbsp;<span class="ident" id="3074236">smallPrimes</span>&nbsp;<span class="op" id="3074248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074254">if</span>&nbsp;<span class="ident" id="3074257">m</span><span class="op" id="3074258">%</span><span class="ident" id="3074259">uint64</span><span class="op" id="3074265">(</span><span class="ident" id="3074266">prime</span><span class="op" id="3074271">)</span>&nbsp;<span class="op" id="3074273">==</span>&nbsp;<span class="num" id="3074276">0</span>&nbsp;<span class="op" id="3074278">&amp;&amp;</span>&nbsp;<span class="op" id="3074281">(</span><span class="ident" id="3074282">bits</span>&nbsp;<span class="op" id="3074287">&gt;</span>&nbsp;<span class="num" id="3074289">6</span>&nbsp;<span class="op" id="3074291">||</span>&nbsp;<span class="ident" id="3074294">m</span>&nbsp;<span class="op" id="3074296">!=</span>&nbsp;<span class="ident" id="3074299">uint64</span><span class="op" id="3074305">(</span><span class="ident" id="3074306">prime</span><span class="op" id="3074311">)</span><span class="op" id="3074312">)</span>&nbsp;<span class="op" id="3074314">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074321">continue</span>&nbsp;<span class="ident" id="3074330">NextDelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074355">if</span>&nbsp;<span class="ident" id="3074358">delta</span>&nbsp;<span class="op" id="3074364">&gt;</span>&nbsp;<span class="num" id="3074366">0</span>&nbsp;<span class="op" id="3074368">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074374">bigMod</span><span class="op" id="3074380">.</span><span class="ident" id="3074381">SetUint64</span><span class="op" id="3074390">(</span><span class="ident" id="3074391">delta</span><span class="op" id="3074396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074402">p</span><span class="op" id="3074403">.</span><span class="ident" id="3074404">Add</span><span class="op" id="3074407">(</span><span class="ident" id="3074408">p</span><span class="op" id="3074409">,</span>&nbsp;<span class="ident" id="3074411">bigMod</span><span class="op" id="3074417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074427">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074435">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3074440">//&nbsp;There&nbsp;is&nbsp;a&nbsp;tiny&nbsp;possibility&nbsp;that,&nbsp;by&nbsp;adding&nbsp;delta,&nbsp;we&nbsp;caused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3074506">//&nbsp;the&nbsp;number&nbsp;to&nbsp;be&nbsp;one&nbsp;bit&nbsp;too&nbsp;long.&nbsp;Thus&nbsp;we&nbsp;check&nbsp;BitLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3074567">//&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074578">if</span>&nbsp;<span class="ident" id="3074581">p</span><span class="op" id="3074582">.</span><span class="ident" id="3074583">ProbablyPrime</span><span class="op" id="3074596">(</span><span class="num" id="3074597">20</span><span class="op" id="3074599">)</span>&nbsp;<span class="op" id="3074601">&amp;&amp;</span>&nbsp;<span class="ident" id="3074604">p</span><span class="op" id="3074605">.</span><span class="ident" id="3074606">BitLen</span><span class="op" id="3074612">(</span><span class="op" id="3074613">)</span>&nbsp;<span class="op" id="3074615">==</span>&nbsp;<span class="ident" id="3074618">bits</span>&nbsp;<span class="op" id="3074623">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074628">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074640">}</span><br>
<span class="lineno"></span><span class="op" id="3074642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3074645">//&nbsp;Int&nbsp;returns&nbsp;a&nbsp;uniform&nbsp;random&nbsp;value&nbsp;in&nbsp;[0,&nbsp;max).&nbsp;It&nbsp;panics&nbsp;if&nbsp;max&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3074719">func</span>&nbsp;<span class="ident" id="3074724">Int</span><span class="op" id="3074727">(</span><span class="ident" id="3074728">rand</span>&nbsp;<span class="ident" id="3074733">io</span><span class="op" id="3074735">.</span><span class="ident" id="3074736">Reader</span><span class="op" id="3074742">,</span>&nbsp;<span class="ident" id="3074744">max</span>&nbsp;<span class="op" id="3074748">*</span><span class="ident" id="3074749">big</span><span class="op" id="3074752">.</span><span class="ident" id="3074753">Int</span><span class="op" id="3074756">)</span>&nbsp;<span class="op" id="3074758">(</span><span class="ident" id="3074759">n</span>&nbsp;<span class="op" id="3074761">*</span><span class="ident" id="3074762">big</span><span class="op" id="3074765">.</span><span class="ident" id="3074766">Int</span><span class="op" id="3074769">,</span>&nbsp;<span class="ident" id="3074771">err</span>&nbsp;<span class="builtintype" id="3074775">error</span><span class="op" id="3074780">)</span>&nbsp;<span class="op" id="3074782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074785">if</span>&nbsp;<span class="ident" id="3074788">max</span><span class="op" id="3074791">.</span><span class="ident" id="3074792">Sign</span><span class="op" id="3074796">(</span><span class="op" id="3074797">)</span>&nbsp;<span class="op" id="3074799">&lt;=</span>&nbsp;<span class="num" id="3074802">0</span>&nbsp;<span class="op" id="3074804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3074808">panic</span><span class="op" id="3074813">(</span><span class="string" id="3074814">&#34;crypto/rand:&nbsp;argument&nbsp;to&nbsp;Int&nbsp;is&nbsp;&lt;=&nbsp;0&#34;</span><span class="op" id="3074852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074855">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074858">k</span>&nbsp;<span class="op" id="3074860">:=</span>&nbsp;<span class="op" id="3074863">(</span><span class="ident" id="3074864">max</span><span class="op" id="3074867">.</span><span class="ident" id="3074868">BitLen</span><span class="op" id="3074874">(</span><span class="op" id="3074875">)</span>&nbsp;<span class="op" id="3074877">+</span>&nbsp;<span class="num" id="3074879">7</span><span class="op" id="3074880">)</span>&nbsp;<span class="op" id="3074882">/</span>&nbsp;<span class="num" id="3074884">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3074888">//&nbsp;b&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;the&nbsp;most&nbsp;significant&nbsp;byte&nbsp;of&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074953">b</span>&nbsp;<span class="op" id="3074955">:=</span>&nbsp;<span class="builtintype" id="3074958">uint</span><span class="op" id="3074962">(</span><span class="ident" id="3074963">max</span><span class="op" id="3074966">.</span><span class="ident" id="3074967">BitLen</span><span class="op" id="3074973">(</span><span class="op" id="3074974">)</span>&nbsp;<span class="op" id="3074976">%</span>&nbsp;<span class="num" id="3074978">8</span><span class="op" id="3074979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074982">if</span>&nbsp;<span class="ident" id="3074985">b</span>&nbsp;<span class="op" id="3074987">==</span>&nbsp;<span class="num" id="3074990">0</span>&nbsp;<span class="op" id="3074992">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074996">b</span>&nbsp;<span class="op" id="3074998">=</span>&nbsp;<span class="num" id="3075000">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3075003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3075007">bytes</span>&nbsp;<span class="op" id="3075013">:=</span>&nbsp;<span class="builtinfunc" id="3075016">make</span><span class="op" id="3075020">(</span><span class="op" id="3075021">[</span><span class="op" id="3075022">]</span><span class="builtintype" id="3075023">byte</span><span class="op" id="3075027">,</span>&nbsp;<span class="ident" id="3075029">k</span><span class="op" id="3075030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3075033">n</span>&nbsp;<span class="op" id="3075035">=</span>&nbsp;<span class="builtinfunc" id="3075037">new</span><span class="op" id="3075040">(</span><span class="ident" id="3075041">big</span><span class="op" id="3075044">.</span><span class="ident" id="3075045">Int</span><span class="op" id="3075048">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3075052">for</span>&nbsp;<span class="op" id="3075056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3075060">_</span><span class="op" id="3075061">,</span>&nbsp;<span class="ident" id="3075063">err</span>&nbsp;<span class="op" id="3075067">=</span>&nbsp;<span class="ident" id="3075069">io</span><span class="op" id="3075071">.</span><span class="ident" id="3075072">ReadFull</span><span class="op" id="3075080">(</span><span class="ident" id="3075081">rand</span><span class="op" id="3075085">,</span>&nbsp;<span class="ident" id="3075087">bytes</span><span class="op" id="3075092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3075096">if</span>&nbsp;<span class="ident" id="3075099">err</span>&nbsp;<span class="op" id="3075103">!=</span>&nbsp;<span class="builtintype" id="3075106">nil</span>&nbsp;<span class="op" id="3075110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3075115">return</span>&nbsp;<span class="builtintype" id="3075122">nil</span><span class="op" id="3075125">,</span>&nbsp;<span class="ident" id="3075127">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3075133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3075138">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;increase&nbsp;the&nbsp;probability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3075200">//&nbsp;that&nbsp;the&nbsp;candidate&nbsp;is&nbsp;&lt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3075234">bytes</span><span class="op" id="3075239">[</span><span class="num" id="3075240">0</span><span class="op" id="3075241">]</span>&nbsp;<span class="op" id="3075243">&amp;=</span>&nbsp;<span class="builtintype" id="3075246">uint8</span><span class="op" id="3075251">(</span><span class="builtintype" id="3075252">int</span><span class="op" id="3075255">(</span><span class="num" id="3075256">1</span><span class="op" id="3075257">&lt;&lt;</span><span class="ident" id="3075259">b</span><span class="op" id="3075260">)</span>&nbsp;<span class="op" id="3075262">-</span>&nbsp;<span class="num" id="3075264">1</span><span class="op" id="3075265">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3075270">n</span><span class="op" id="3075271">.</span><span class="ident" id="3075272">SetBytes</span><span class="op" id="3075280">(</span><span class="ident" id="3075281">bytes</span><span class="op" id="3075286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3075290">if</span>&nbsp;<span class="ident" id="3075293">n</span><span class="op" id="3075294">.</span><span class="ident" id="3075295">Cmp</span><span class="op" id="3075298">(</span><span class="ident" id="3075299">max</span><span class="op" id="3075302">)</span>&nbsp;<span class="op" id="3075304">&lt;</span>&nbsp;<span class="num" id="3075306">0</span>&nbsp;<span class="op" id="3075308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3075313">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3075322">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3075325">}</span><br>
<span class="lineno"></span><span class="op" id="3075327">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
