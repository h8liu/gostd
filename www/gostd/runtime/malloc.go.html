<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html" class="current">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1548008">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1548063">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1548117">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1548168">package</span>&nbsp;<span class="ident" id="1548176">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1548185">import</span>&nbsp;<span class="op" id="1548192">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1548195">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1548204">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1548207">const</span>&nbsp;<span class="op" id="1548213">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548216">debugMalloc</span>&nbsp;<span class="op" id="1548228">=</span>&nbsp;<span class="builtintype" id="1548230">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548238">flagNoScan</span>&nbsp;<span class="op" id="1548249">=</span>&nbsp;<span class="ident" id="1548251">_FlagNoScan</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548264">flagNoZero</span>&nbsp;<span class="op" id="1548275">=</span>&nbsp;<span class="ident" id="1548277">_FlagNoZero</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548291">maxTinySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1548305">=</span>&nbsp;<span class="ident" id="1548307">_TinySize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548318">tinySizeClass</span>&nbsp;<span class="op" id="1548332">=</span>&nbsp;<span class="ident" id="1548334">_TinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548350">maxSmallSize</span>&nbsp;&nbsp;<span class="op" id="1548364">=</span>&nbsp;<span class="ident" id="1548366">_MaxSmallSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548382">pageShift</span>&nbsp;<span class="op" id="1548392">=</span>&nbsp;<span class="ident" id="1548394">_PageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548406">pageSize</span>&nbsp;&nbsp;<span class="op" id="1548416">=</span>&nbsp;<span class="ident" id="1548418">_PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548429">pageMask</span>&nbsp;&nbsp;<span class="op" id="1548439">=</span>&nbsp;<span class="ident" id="1548441">_PageMask</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548453">bitsPerPointer</span>&nbsp;&nbsp;<span class="op" id="1548469">=</span>&nbsp;<span class="ident" id="1548471">_BitsPerPointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548488">bitsMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548504">=</span>&nbsp;<span class="ident" id="1548506">_BitsMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548517">pointersPerByte</span>&nbsp;<span class="op" id="1548533">=</span>&nbsp;<span class="ident" id="1548535">_PointersPerByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548553">maxGCMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548569">=</span>&nbsp;<span class="ident" id="1548571">_MaxGCMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548583">bitsDead</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548599">=</span>&nbsp;<span class="ident" id="1548601">_BitsDead</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548612">bitsPointer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548628">=</span>&nbsp;<span class="ident" id="1548630">_BitsPointer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548645">mSpanInUse</span>&nbsp;<span class="op" id="1548656">=</span>&nbsp;<span class="ident" id="1548658">_MSpanInUse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548672">concurrentSweep</span>&nbsp;<span class="op" id="1548688">=</span>&nbsp;<span class="ident" id="1548690">_ConcurrentSweep</span>&nbsp;<span class="op" id="1548707">!=</span>&nbsp;<span class="num" id="1548710">0</span><br>
<span class="lineno">35</span><span class="op" id="1548712">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1548715">//&nbsp;Page&nbsp;number&nbsp;(address&gt;&gt;pageShift)</span><br>
<span class="lineno"></span><span class="keyword" id="1548751">type</span>&nbsp;<span class="ident" id="1548756">pageID</span>&nbsp;<span class="builtintype" id="1548763">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1548772">//&nbsp;base&nbsp;address&nbsp;for&nbsp;all&nbsp;0-byte&nbsp;allocations</span><br>
<span class="lineno"></span><span class="keyword" id="1548815">var</span>&nbsp;<span class="ident" id="1548819">zerobase</span>&nbsp;<span class="builtintype" id="1548828">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1548837">//&nbsp;Allocate&nbsp;an&nbsp;object&nbsp;of&nbsp;size&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1548874">//&nbsp;Small&nbsp;objects&nbsp;are&nbsp;allocated&nbsp;from&nbsp;the&nbsp;per-P&nbsp;cache&#39;s&nbsp;free&nbsp;lists.</span><br>
<span class="lineno">45</span><span class="comment" id="1548940">//&nbsp;Large&nbsp;objects&nbsp;(&gt;&nbsp;32&nbsp;kB)&nbsp;are&nbsp;allocated&nbsp;straight&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="1549005">func</span>&nbsp;<span class="ident" id="1549010">mallocgc</span><span class="op" id="1549018">(</span><span class="ident" id="1549019">size</span>&nbsp;<span class="builtintype" id="1549024">uintptr</span><span class="op" id="1549031">,</span>&nbsp;<span class="ident" id="1549033">typ</span>&nbsp;<span class="op" id="1549037">*</span><span class="ident" id="1549038">_type</span><span class="op" id="1549043">,</span>&nbsp;<span class="ident" id="1549045">flags</span>&nbsp;<span class="builtintype" id="1549051">uint32</span><span class="op" id="1549057">)</span>&nbsp;<span class="ident" id="1549059">unsafe</span><span class="op" id="1549065">.</span><span class="ident" id="1549066">Pointer</span>&nbsp;<span class="op" id="1549074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1549077">if</span>&nbsp;<span class="ident" id="1549080">size</span>&nbsp;<span class="op" id="1549085">==</span>&nbsp;<span class="num" id="1549088">0</span>&nbsp;<span class="op" id="1549090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1549094">return</span>&nbsp;<span class="ident" id="1549101">unsafe</span><span class="op" id="1549107">.</span><span class="ident" id="1549108">Pointer</span><span class="op" id="1549115">(</span><span class="op" id="1549116">&amp;</span><span class="ident" id="1549117">zerobase</span><span class="op" id="1549125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1549128">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549131">size0</span>&nbsp;<span class="op" id="1549137">:=</span>&nbsp;<span class="ident" id="1549140">size</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1549147">if</span>&nbsp;<span class="ident" id="1549150">flags</span><span class="op" id="1549155">&amp;</span><span class="ident" id="1549156">flagNoScan</span>&nbsp;<span class="op" id="1549167">==</span>&nbsp;<span class="num" id="1549170">0</span>&nbsp;<span class="op" id="1549172">&amp;&amp;</span>&nbsp;<span class="ident" id="1549175">typ</span>&nbsp;<span class="op" id="1549179">==</span>&nbsp;<span class="builtintype" id="1549182">nil</span>&nbsp;<span class="op" id="1549186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549190">gothrow</span><span class="op" id="1549197">(</span><span class="string" id="1549198">&#34;malloc&nbsp;missing&nbsp;type&#34;</span><span class="op" id="1549219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1549222">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1549226">//&nbsp;This&nbsp;function&nbsp;must&nbsp;be&nbsp;atomic&nbsp;wrt&nbsp;GC,&nbsp;but&nbsp;for&nbsp;performance&nbsp;reasons</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1549295">//&nbsp;we&nbsp;don&#39;t&nbsp;acquirem/releasem&nbsp;on&nbsp;fast&nbsp;path.&nbsp;The&nbsp;code&nbsp;below&nbsp;does&nbsp;not&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1549369">//&nbsp;split&nbsp;stack&nbsp;checks,&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;preempted&nbsp;by&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1549425">//&nbsp;Functions&nbsp;like&nbsp;roundup/add&nbsp;are&nbsp;inlined.&nbsp;And&nbsp;onM/racemalloc&nbsp;are&nbsp;nosplit.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1549501">//&nbsp;If&nbsp;debugMalloc&nbsp;=&nbsp;true,&nbsp;these&nbsp;assumptions&nbsp;are&nbsp;checked&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1549565">if</span>&nbsp;<span class="ident" id="1549568">debugMalloc</span>&nbsp;<span class="op" id="1549580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549584">mp</span>&nbsp;<span class="op" id="1549587">:=</span>&nbsp;<span class="ident" id="1549590">acquirem</span><span class="op" id="1549598">(</span><span class="op" id="1549599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1549603">if</span>&nbsp;<span class="ident" id="1549606">mp</span><span class="op" id="1549608">.</span><span class="ident" id="1549609">mallocing</span>&nbsp;<span class="op" id="1549619">!=</span>&nbsp;<span class="num" id="1549622">0</span>&nbsp;<span class="op" id="1549624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549629">gothrow</span><span class="op" id="1549636">(</span><span class="string" id="1549637">&#34;malloc&nbsp;deadlock&#34;</span><span class="op" id="1549654">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1549658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549662">mp</span><span class="op" id="1549664">.</span><span class="ident" id="1549665">mallocing</span>&nbsp;<span class="op" id="1549675">=</span>&nbsp;<span class="num" id="1549677">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1549681">if</span>&nbsp;<span class="ident" id="1549684">mp</span><span class="op" id="1549686">.</span><span class="ident" id="1549687">curg</span>&nbsp;<span class="op" id="1549692">!=</span>&nbsp;<span class="builtintype" id="1549695">nil</span>&nbsp;<span class="op" id="1549699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549704">mp</span><span class="op" id="1549706">.</span><span class="ident" id="1549707">curg</span><span class="op" id="1549711">.</span><span class="ident" id="1549712">stackguard0</span>&nbsp;<span class="op" id="1549724">=</span>&nbsp;<span class="op" id="1549726">^</span><span class="builtintype" id="1549727">uintptr</span><span class="op" id="1549734">(</span><span class="num" id="1549735">0xfff</span><span class="op" id="1549740">)</span>&nbsp;<span class="op" id="1549742">|</span>&nbsp;<span class="num" id="1549744">0xbad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1549752">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1549755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549759">c</span>&nbsp;<span class="op" id="1549761">:=</span>&nbsp;<span class="ident" id="1549764">gomcache</span><span class="op" id="1549772">(</span><span class="op" id="1549773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1549776">var</span>&nbsp;<span class="ident" id="1549780">s</span>&nbsp;<span class="op" id="1549782">*</span><span class="ident" id="1549783">mspan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1549790">var</span>&nbsp;<span class="ident" id="1549794">x</span>&nbsp;<span class="ident" id="1549796">unsafe</span><span class="op" id="1549802">.</span><span class="ident" id="1549803">Pointer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1549812">if</span>&nbsp;<span class="ident" id="1549815">size</span>&nbsp;<span class="op" id="1549820">&lt;=</span>&nbsp;<span class="ident" id="1549823">maxSmallSize</span>&nbsp;<span class="op" id="1549836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1549840">if</span>&nbsp;<span class="ident" id="1549843">flags</span><span class="op" id="1549848">&amp;</span><span class="ident" id="1549849">flagNoScan</span>&nbsp;<span class="op" id="1549860">!=</span>&nbsp;<span class="num" id="1549863">0</span>&nbsp;<span class="op" id="1549865">&amp;&amp;</span>&nbsp;<span class="ident" id="1549868">size</span>&nbsp;<span class="op" id="1549873">&lt;</span>&nbsp;<span class="ident" id="1549875">maxTinySize</span>&nbsp;<span class="op" id="1549887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1549892">//&nbsp;Tiny&nbsp;allocator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1549914">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1549920">//&nbsp;Tiny&nbsp;allocator&nbsp;combines&nbsp;several&nbsp;tiny&nbsp;allocation&nbsp;requests</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1549983">//&nbsp;into&nbsp;a&nbsp;single&nbsp;memory&nbsp;block.&nbsp;The&nbsp;resulting&nbsp;memory&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550044">//&nbsp;is&nbsp;freed&nbsp;when&nbsp;all&nbsp;subobjects&nbsp;are&nbsp;unreachable.&nbsp;The&nbsp;subobjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550111">//&nbsp;must&nbsp;be&nbsp;FlagNoScan&nbsp;(don&#39;t&nbsp;have&nbsp;pointers),&nbsp;this&nbsp;ensures&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550177">//&nbsp;the&nbsp;amount&nbsp;of&nbsp;potentially&nbsp;wasted&nbsp;memory&nbsp;is&nbsp;bounded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550235">//</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550241">//&nbsp;Size&nbsp;of&nbsp;the&nbsp;memory&nbsp;block&nbsp;used&nbsp;for&nbsp;combining&nbsp;(maxTinySize)&nbsp;is&nbsp;tunable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550317">//&nbsp;Current&nbsp;setting&nbsp;is&nbsp;16&nbsp;bytes,&nbsp;which&nbsp;relates&nbsp;to&nbsp;2x&nbsp;worst&nbsp;case&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550390">//&nbsp;wastage&nbsp;(when&nbsp;all&nbsp;but&nbsp;one&nbsp;subobjects&nbsp;are&nbsp;unreachable).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550451">//&nbsp;8&nbsp;bytes&nbsp;would&nbsp;result&nbsp;in&nbsp;no&nbsp;wastage&nbsp;at&nbsp;all,&nbsp;but&nbsp;provides&nbsp;less</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550518">//&nbsp;opportunities&nbsp;for&nbsp;combining.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550553">//&nbsp;32&nbsp;bytes&nbsp;provides&nbsp;more&nbsp;opportunities&nbsp;for&nbsp;combining,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550611">//&nbsp;but&nbsp;can&nbsp;lead&nbsp;to&nbsp;4x&nbsp;worst&nbsp;case&nbsp;wastage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550656">//&nbsp;The&nbsp;best&nbsp;case&nbsp;winning&nbsp;is&nbsp;8x&nbsp;regardless&nbsp;of&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550716">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550722">//&nbsp;Objects&nbsp;obtained&nbsp;from&nbsp;tiny&nbsp;allocator&nbsp;must&nbsp;not&nbsp;be&nbsp;freed&nbsp;explicitly.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550795">//&nbsp;So&nbsp;when&nbsp;an&nbsp;object&nbsp;will&nbsp;be&nbsp;freed&nbsp;explicitly,&nbsp;we&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550860">//&nbsp;its&nbsp;size&nbsp;&gt;=&nbsp;maxTinySize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550891">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550897">//&nbsp;SetFinalizer&nbsp;has&nbsp;a&nbsp;special&nbsp;case&nbsp;for&nbsp;objects&nbsp;potentially&nbsp;coming</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550966">//&nbsp;from&nbsp;tiny&nbsp;allocator,&nbsp;it&nbsp;such&nbsp;case&nbsp;it&nbsp;allows&nbsp;to&nbsp;set&nbsp;finalizers</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551034">//&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte&nbsp;of&nbsp;a&nbsp;memory&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551077">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551083">//&nbsp;The&nbsp;main&nbsp;targets&nbsp;of&nbsp;tiny&nbsp;allocator&nbsp;are&nbsp;small&nbsp;strings&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551146">//&nbsp;standalone&nbsp;escaping&nbsp;variables.&nbsp;On&nbsp;a&nbsp;json&nbsp;benchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551203">//&nbsp;the&nbsp;allocator&nbsp;reduces&nbsp;number&nbsp;of&nbsp;allocations&nbsp;by&nbsp;~12%&nbsp;and</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551265">//&nbsp;reduces&nbsp;heap&nbsp;size&nbsp;by&nbsp;~20%.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551298">tinysize</span>&nbsp;<span class="op" id="1551307">:=</span>&nbsp;<span class="builtintype" id="1551310">uintptr</span><span class="op" id="1551317">(</span><span class="ident" id="1551318">c</span><span class="op" id="1551319">.</span><span class="ident" id="1551320">tinysize</span><span class="op" id="1551328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551333">if</span>&nbsp;<span class="ident" id="1551336">size</span>&nbsp;<span class="op" id="1551341">&lt;=</span>&nbsp;<span class="ident" id="1551344">tinysize</span>&nbsp;<span class="op" id="1551353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551359">tiny</span>&nbsp;<span class="op" id="1551364">:=</span>&nbsp;<span class="ident" id="1551367">unsafe</span><span class="op" id="1551373">.</span><span class="ident" id="1551374">Pointer</span><span class="op" id="1551381">(</span><span class="ident" id="1551382">c</span><span class="op" id="1551383">.</span><span class="ident" id="1551384">tiny</span><span class="op" id="1551388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551394">//&nbsp;Align&nbsp;tiny&nbsp;pointer&nbsp;for&nbsp;required&nbsp;(conservative)&nbsp;alignment.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551459">if</span>&nbsp;<span class="ident" id="1551462">size</span><span class="op" id="1551466">&amp;</span><span class="num" id="1551467">7</span>&nbsp;<span class="op" id="1551469">==</span>&nbsp;<span class="num" id="1551472">0</span>&nbsp;<span class="op" id="1551474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551481">tiny</span>&nbsp;<span class="op" id="1551486">=</span>&nbsp;<span class="ident" id="1551488">roundup</span><span class="op" id="1551495">(</span><span class="ident" id="1551496">tiny</span><span class="op" id="1551500">,</span>&nbsp;<span class="num" id="1551502">8</span><span class="op" id="1551503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551509">}</span>&nbsp;<span class="keyword" id="1551511">else</span>&nbsp;<span class="keyword" id="1551516">if</span>&nbsp;<span class="ident" id="1551519">size</span><span class="op" id="1551523">&amp;</span><span class="num" id="1551524">3</span>&nbsp;<span class="op" id="1551526">==</span>&nbsp;<span class="num" id="1551529">0</span>&nbsp;<span class="op" id="1551531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551538">tiny</span>&nbsp;<span class="op" id="1551543">=</span>&nbsp;<span class="ident" id="1551545">roundup</span><span class="op" id="1551552">(</span><span class="ident" id="1551553">tiny</span><span class="op" id="1551557">,</span>&nbsp;<span class="num" id="1551559">4</span><span class="op" id="1551560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551566">}</span>&nbsp;<span class="keyword" id="1551568">else</span>&nbsp;<span class="keyword" id="1551573">if</span>&nbsp;<span class="ident" id="1551576">size</span><span class="op" id="1551580">&amp;</span><span class="num" id="1551581">1</span>&nbsp;<span class="op" id="1551583">==</span>&nbsp;<span class="num" id="1551586">0</span>&nbsp;<span class="op" id="1551588">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551595">tiny</span>&nbsp;<span class="op" id="1551600">=</span>&nbsp;<span class="ident" id="1551602">roundup</span><span class="op" id="1551609">(</span><span class="ident" id="1551610">tiny</span><span class="op" id="1551614">,</span>&nbsp;<span class="num" id="1551616">2</span><span class="op" id="1551617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551629">size1</span>&nbsp;<span class="op" id="1551635">:=</span>&nbsp;<span class="ident" id="1551638">size</span>&nbsp;<span class="op" id="1551643">+</span>&nbsp;<span class="op" id="1551645">(</span><span class="builtintype" id="1551646">uintptr</span><span class="op" id="1551653">(</span><span class="ident" id="1551654">tiny</span><span class="op" id="1551658">)</span>&nbsp;<span class="op" id="1551660">-</span>&nbsp;<span class="builtintype" id="1551662">uintptr</span><span class="op" id="1551669">(</span><span class="ident" id="1551670">unsafe</span><span class="op" id="1551676">.</span><span class="ident" id="1551677">Pointer</span><span class="op" id="1551684">(</span><span class="ident" id="1551685">c</span><span class="op" id="1551686">.</span><span class="ident" id="1551687">tiny</span><span class="op" id="1551691">)</span><span class="op" id="1551692">)</span><span class="op" id="1551693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551699">if</span>&nbsp;<span class="ident" id="1551702">size1</span>&nbsp;<span class="op" id="1551708">&lt;=</span>&nbsp;<span class="ident" id="1551711">tinysize</span>&nbsp;<span class="op" id="1551720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551727">//&nbsp;The&nbsp;object&nbsp;fits&nbsp;into&nbsp;existing&nbsp;tiny&nbsp;block.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551777">x</span>&nbsp;<span class="op" id="1551779">=</span>&nbsp;<span class="ident" id="1551781">tiny</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551791">c</span><span class="op" id="1551792">.</span><span class="ident" id="1551793">tiny</span>&nbsp;<span class="op" id="1551798">=</span>&nbsp;<span class="op" id="1551800">(</span><span class="op" id="1551801">*</span><span class="builtintype" id="1551802">byte</span><span class="op" id="1551806">)</span><span class="op" id="1551807">(</span><span class="ident" id="1551808">add</span><span class="op" id="1551811">(</span><span class="ident" id="1551812">x</span><span class="op" id="1551813">,</span>&nbsp;<span class="ident" id="1551815">size</span><span class="op" id="1551819">)</span><span class="op" id="1551820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551827">c</span><span class="op" id="1551828">.</span><span class="ident" id="1551829">tinysize</span>&nbsp;<span class="op" id="1551838">-=</span>&nbsp;<span class="builtintype" id="1551841">uintptr</span><span class="op" id="1551848">(</span><span class="ident" id="1551849">size1</span><span class="op" id="1551854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551861">c</span><span class="op" id="1551862">.</span><span class="ident" id="1551863">local_tinyallocs</span><span class="op" id="1551879">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551887">if</span>&nbsp;<span class="ident" id="1551890">debugMalloc</span>&nbsp;<span class="op" id="1551902">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551910">mp</span>&nbsp;<span class="op" id="1551913">:=</span>&nbsp;<span class="ident" id="1551916">acquirem</span><span class="op" id="1551924">(</span><span class="op" id="1551925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551933">if</span>&nbsp;<span class="ident" id="1551936">mp</span><span class="op" id="1551938">.</span><span class="ident" id="1551939">mallocing</span>&nbsp;<span class="op" id="1551949">==</span>&nbsp;<span class="num" id="1551952">0</span>&nbsp;<span class="op" id="1551954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551963">gothrow</span><span class="op" id="1551970">(</span><span class="string" id="1551971">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1551983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551999">mp</span><span class="op" id="1552001">.</span><span class="ident" id="1552002">mallocing</span>&nbsp;<span class="op" id="1552012">=</span>&nbsp;<span class="num" id="1552014">0</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552022">if</span>&nbsp;<span class="ident" id="1552025">mp</span><span class="op" id="1552027">.</span><span class="ident" id="1552028">curg</span>&nbsp;<span class="op" id="1552033">!=</span>&nbsp;<span class="builtintype" id="1552036">nil</span>&nbsp;<span class="op" id="1552040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552049">mp</span><span class="op" id="1552051">.</span><span class="ident" id="1552052">curg</span><span class="op" id="1552056">.</span><span class="ident" id="1552057">stackguard0</span>&nbsp;<span class="op" id="1552069">=</span>&nbsp;<span class="ident" id="1552071">mp</span><span class="op" id="1552073">.</span><span class="ident" id="1552074">curg</span><span class="op" id="1552078">.</span><span class="ident" id="1552079">stack</span><span class="op" id="1552084">.</span><span class="ident" id="1552085">lo</span>&nbsp;<span class="op" id="1552088">+</span>&nbsp;<span class="ident" id="1552090">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552116">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552173">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552229">releasem</span><span class="op" id="1552237">(</span><span class="ident" id="1552238">mp</span><span class="op" id="1552240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552248">releasem</span><span class="op" id="1552256">(</span><span class="ident" id="1552257">mp</span><span class="op" id="1552259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552273">return</span>&nbsp;<span class="ident" id="1552280">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552286">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552296">//&nbsp;Allocate&nbsp;a&nbsp;new&nbsp;maxTinySize&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552336">s</span>&nbsp;<span class="op" id="1552338">=</span>&nbsp;<span class="ident" id="1552340">c</span><span class="op" id="1552341">.</span><span class="ident" id="1552342">alloc</span><span class="op" id="1552347">[</span><span class="ident" id="1552348">tinySizeClass</span><span class="op" id="1552361">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552366">v</span>&nbsp;<span class="op" id="1552368">:=</span>&nbsp;<span class="ident" id="1552371">s</span><span class="op" id="1552372">.</span><span class="ident" id="1552373">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552385">if</span>&nbsp;<span class="ident" id="1552388">v</span>&nbsp;<span class="op" id="1552390">==</span>&nbsp;<span class="builtintype" id="1552393">nil</span>&nbsp;<span class="op" id="1552397">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552403">mp</span>&nbsp;<span class="op" id="1552406">:=</span>&nbsp;<span class="ident" id="1552409">acquirem</span><span class="op" id="1552417">(</span><span class="op" id="1552418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552424">mp</span><span class="op" id="1552426">.</span><span class="ident" id="1552427">scalararg</span><span class="op" id="1552436">[</span><span class="num" id="1552437">0</span><span class="op" id="1552438">]</span>&nbsp;<span class="op" id="1552440">=</span>&nbsp;<span class="ident" id="1552442">tinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552460">onM</span><span class="op" id="1552463">(</span><span class="ident" id="1552464">mcacheRefill_m</span><span class="op" id="1552478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552484">releasem</span><span class="op" id="1552492">(</span><span class="ident" id="1552493">mp</span><span class="op" id="1552495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552501">s</span>&nbsp;<span class="op" id="1552503">=</span>&nbsp;<span class="ident" id="1552505">c</span><span class="op" id="1552506">.</span><span class="ident" id="1552507">alloc</span><span class="op" id="1552512">[</span><span class="ident" id="1552513">tinySizeClass</span><span class="op" id="1552526">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552532">v</span>&nbsp;<span class="op" id="1552534">=</span>&nbsp;<span class="ident" id="1552536">s</span><span class="op" id="1552537">.</span><span class="ident" id="1552538">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552555">s</span><span class="op" id="1552556">.</span><span class="ident" id="1552557">freelist</span>&nbsp;<span class="op" id="1552566">=</span>&nbsp;<span class="ident" id="1552568">v</span><span class="op" id="1552569">.</span><span class="ident" id="1552570">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552578">s</span><span class="op" id="1552579">.</span><span class="ident" id="1552580">ref</span><span class="op" id="1552583">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552589">//TODO:&nbsp;prefetch&nbsp;v.next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552616">x</span>&nbsp;<span class="op" id="1552618">=</span>&nbsp;<span class="ident" id="1552620">unsafe</span><span class="op" id="1552626">.</span><span class="ident" id="1552627">Pointer</span><span class="op" id="1552634">(</span><span class="ident" id="1552635">v</span><span class="op" id="1552636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552641">(</span><span class="op" id="1552642">*</span><span class="op" id="1552643">[</span><span class="num" id="1552644">2</span><span class="op" id="1552645">]</span><span class="ident" id="1552646">uint64</span><span class="op" id="1552652">)</span><span class="op" id="1552653">(</span><span class="ident" id="1552654">x</span><span class="op" id="1552655">)</span><span class="op" id="1552656">[</span><span class="num" id="1552657">0</span><span class="op" id="1552658">]</span>&nbsp;<span class="op" id="1552660">=</span>&nbsp;<span class="num" id="1552662">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552667">(</span><span class="op" id="1552668">*</span><span class="op" id="1552669">[</span><span class="num" id="1552670">2</span><span class="op" id="1552671">]</span><span class="ident" id="1552672">uint64</span><span class="op" id="1552678">)</span><span class="op" id="1552679">(</span><span class="ident" id="1552680">x</span><span class="op" id="1552681">)</span><span class="op" id="1552682">[</span><span class="num" id="1552683">1</span><span class="op" id="1552684">]</span>&nbsp;<span class="op" id="1552686">=</span>&nbsp;<span class="num" id="1552688">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552693">//&nbsp;See&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;replace&nbsp;the&nbsp;existing&nbsp;tiny&nbsp;block&nbsp;with&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552766">//&nbsp;based&nbsp;on&nbsp;amount&nbsp;of&nbsp;remaining&nbsp;free&nbsp;space.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552813">if</span>&nbsp;<span class="ident" id="1552816">maxTinySize</span><span class="op" id="1552827">-</span><span class="ident" id="1552828">size</span>&nbsp;<span class="op" id="1552833">&gt;</span>&nbsp;<span class="ident" id="1552835">tinysize</span>&nbsp;<span class="op" id="1552844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552850">c</span><span class="op" id="1552851">.</span><span class="ident" id="1552852">tiny</span>&nbsp;<span class="op" id="1552857">=</span>&nbsp;<span class="op" id="1552859">(</span><span class="op" id="1552860">*</span><span class="builtintype" id="1552861">byte</span><span class="op" id="1552865">)</span><span class="op" id="1552866">(</span><span class="ident" id="1552867">add</span><span class="op" id="1552870">(</span><span class="ident" id="1552871">x</span><span class="op" id="1552872">,</span>&nbsp;<span class="ident" id="1552874">size</span><span class="op" id="1552878">)</span><span class="op" id="1552879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552885">c</span><span class="op" id="1552886">.</span><span class="ident" id="1552887">tinysize</span>&nbsp;<span class="op" id="1552896">=</span>&nbsp;<span class="builtintype" id="1552898">uintptr</span><span class="op" id="1552905">(</span><span class="ident" id="1552906">maxTinySize</span>&nbsp;<span class="op" id="1552918">-</span>&nbsp;<span class="ident" id="1552920">size</span><span class="op" id="1552924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552934">size</span>&nbsp;<span class="op" id="1552939">=</span>&nbsp;<span class="ident" id="1552941">maxTinySize</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552955">}</span>&nbsp;<span class="keyword" id="1552957">else</span>&nbsp;<span class="op" id="1552962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552967">var</span>&nbsp;<span class="ident" id="1552971">sizeclass</span>&nbsp;<span class="builtintype" id="1552981">int8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552989">if</span>&nbsp;<span class="ident" id="1552992">size</span>&nbsp;<span class="op" id="1552997">&lt;=</span>&nbsp;<span class="num" id="1553000">1024</span><span class="op" id="1553004">-</span><span class="num" id="1553005">8</span>&nbsp;<span class="op" id="1553007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553013">sizeclass</span>&nbsp;<span class="op" id="1553023">=</span>&nbsp;<span class="ident" id="1553025">size_to_class8</span><span class="op" id="1553039">[</span><span class="op" id="1553040">(</span><span class="ident" id="1553041">size</span><span class="op" id="1553045">+</span><span class="num" id="1553046">7</span><span class="op" id="1553047">)</span><span class="op" id="1553048">&gt;&gt;</span><span class="num" id="1553050">3</span><span class="op" id="1553051">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553056">}</span>&nbsp;<span class="keyword" id="1553058">else</span>&nbsp;<span class="op" id="1553063">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553069">sizeclass</span>&nbsp;<span class="op" id="1553079">=</span>&nbsp;<span class="ident" id="1553081">size_to_class128</span><span class="op" id="1553097">[</span><span class="op" id="1553098">(</span><span class="ident" id="1553099">size</span><span class="op" id="1553103">-</span><span class="num" id="1553104">1024</span><span class="op" id="1553108">+</span><span class="num" id="1553109">127</span><span class="op" id="1553112">)</span><span class="op" id="1553113">&gt;&gt;</span><span class="num" id="1553115">7</span><span class="op" id="1553116">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553126">size</span>&nbsp;<span class="op" id="1553131">=</span>&nbsp;<span class="builtintype" id="1553133">uintptr</span><span class="op" id="1553140">(</span><span class="ident" id="1553141">class_to_size</span><span class="op" id="1553154">[</span><span class="ident" id="1553155">sizeclass</span><span class="op" id="1553164">]</span><span class="op" id="1553165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553170">s</span>&nbsp;<span class="op" id="1553172">=</span>&nbsp;<span class="ident" id="1553174">c</span><span class="op" id="1553175">.</span><span class="ident" id="1553176">alloc</span><span class="op" id="1553181">[</span><span class="ident" id="1553182">sizeclass</span><span class="op" id="1553191">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553196">v</span>&nbsp;<span class="op" id="1553198">:=</span>&nbsp;<span class="ident" id="1553201">s</span><span class="op" id="1553202">.</span><span class="ident" id="1553203">freelist</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553215">if</span>&nbsp;<span class="ident" id="1553218">v</span>&nbsp;<span class="op" id="1553220">==</span>&nbsp;<span class="builtintype" id="1553223">nil</span>&nbsp;<span class="op" id="1553227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553233">mp</span>&nbsp;<span class="op" id="1553236">:=</span>&nbsp;<span class="ident" id="1553239">acquirem</span><span class="op" id="1553247">(</span><span class="op" id="1553248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553254">mp</span><span class="op" id="1553256">.</span><span class="ident" id="1553257">scalararg</span><span class="op" id="1553266">[</span><span class="num" id="1553267">0</span><span class="op" id="1553268">]</span>&nbsp;<span class="op" id="1553270">=</span>&nbsp;<span class="builtintype" id="1553272">uintptr</span><span class="op" id="1553279">(</span><span class="ident" id="1553280">sizeclass</span><span class="op" id="1553289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553295">onM</span><span class="op" id="1553298">(</span><span class="ident" id="1553299">mcacheRefill_m</span><span class="op" id="1553313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553319">releasem</span><span class="op" id="1553327">(</span><span class="ident" id="1553328">mp</span><span class="op" id="1553330">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553336">s</span>&nbsp;<span class="op" id="1553338">=</span>&nbsp;<span class="ident" id="1553340">c</span><span class="op" id="1553341">.</span><span class="ident" id="1553342">alloc</span><span class="op" id="1553347">[</span><span class="ident" id="1553348">sizeclass</span><span class="op" id="1553357">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553363">v</span>&nbsp;<span class="op" id="1553365">=</span>&nbsp;<span class="ident" id="1553367">s</span><span class="op" id="1553368">.</span><span class="ident" id="1553369">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553386">s</span><span class="op" id="1553387">.</span><span class="ident" id="1553388">freelist</span>&nbsp;<span class="op" id="1553397">=</span>&nbsp;<span class="ident" id="1553399">v</span><span class="op" id="1553400">.</span><span class="ident" id="1553401">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553409">s</span><span class="op" id="1553410">.</span><span class="ident" id="1553411">ref</span><span class="op" id="1553414">++</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1553420">//TODO:&nbsp;prefetch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553440">x</span>&nbsp;<span class="op" id="1553442">=</span>&nbsp;<span class="ident" id="1553444">unsafe</span><span class="op" id="1553450">.</span><span class="ident" id="1553451">Pointer</span><span class="op" id="1553458">(</span><span class="ident" id="1553459">v</span><span class="op" id="1553460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553465">if</span>&nbsp;<span class="ident" id="1553468">flags</span><span class="op" id="1553473">&amp;</span><span class="ident" id="1553474">flagNoZero</span>&nbsp;<span class="op" id="1553485">==</span>&nbsp;<span class="num" id="1553488">0</span>&nbsp;<span class="op" id="1553490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553496">v</span><span class="op" id="1553497">.</span><span class="ident" id="1553498">next</span>&nbsp;<span class="op" id="1553503">=</span>&nbsp;<span class="builtintype" id="1553505">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553513">if</span>&nbsp;<span class="ident" id="1553516">size</span>&nbsp;<span class="op" id="1553521">&gt;</span>&nbsp;<span class="num" id="1553523">2</span><span class="op" id="1553524">*</span><span class="ident" id="1553525">ptrSize</span>&nbsp;<span class="op" id="1553533">&amp;&amp;</span>&nbsp;<span class="op" id="1553536">(</span><span class="op" id="1553537">(</span><span class="op" id="1553538">*</span><span class="op" id="1553539">[</span><span class="num" id="1553540">2</span><span class="op" id="1553541">]</span><span class="builtintype" id="1553542">uintptr</span><span class="op" id="1553549">)</span><span class="op" id="1553550">(</span><span class="ident" id="1553551">x</span><span class="op" id="1553552">)</span><span class="op" id="1553553">)</span><span class="op" id="1553554">[</span><span class="num" id="1553555">1</span><span class="op" id="1553556">]</span>&nbsp;<span class="op" id="1553558">!=</span>&nbsp;<span class="num" id="1553561">0</span>&nbsp;<span class="op" id="1553563">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553570">memclr</span><span class="op" id="1553576">(</span><span class="ident" id="1553577">unsafe</span><span class="op" id="1553583">.</span><span class="ident" id="1553584">Pointer</span><span class="op" id="1553591">(</span><span class="ident" id="1553592">v</span><span class="op" id="1553593">)</span><span class="op" id="1553594">,</span>&nbsp;<span class="ident" id="1553596">size</span><span class="op" id="1553600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553619">c</span><span class="op" id="1553620">.</span><span class="ident" id="1553621">local_cachealloc</span>&nbsp;<span class="op" id="1553638">+=</span>&nbsp;<span class="ident" id="1553641">intptr</span><span class="op" id="1553647">(</span><span class="ident" id="1553648">size</span><span class="op" id="1553652">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553655">}</span>&nbsp;<span class="keyword" id="1553657">else</span>&nbsp;<span class="op" id="1553662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553666">mp</span>&nbsp;<span class="op" id="1553669">:=</span>&nbsp;<span class="ident" id="1553672">acquirem</span><span class="op" id="1553680">(</span><span class="op" id="1553681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553685">mp</span><span class="op" id="1553687">.</span><span class="ident" id="1553688">scalararg</span><span class="op" id="1553697">[</span><span class="num" id="1553698">0</span><span class="op" id="1553699">]</span>&nbsp;<span class="op" id="1553701">=</span>&nbsp;<span class="builtintype" id="1553703">uintptr</span><span class="op" id="1553710">(</span><span class="ident" id="1553711">size</span><span class="op" id="1553715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553719">mp</span><span class="op" id="1553721">.</span><span class="ident" id="1553722">scalararg</span><span class="op" id="1553731">[</span><span class="num" id="1553732">1</span><span class="op" id="1553733">]</span>&nbsp;<span class="op" id="1553735">=</span>&nbsp;<span class="builtintype" id="1553737">uintptr</span><span class="op" id="1553744">(</span><span class="ident" id="1553745">flags</span><span class="op" id="1553750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553754">onM</span><span class="op" id="1553757">(</span><span class="ident" id="1553758">largeAlloc_m</span><span class="op" id="1553770">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553774">s</span>&nbsp;<span class="op" id="1553776">=</span>&nbsp;<span class="op" id="1553778">(</span><span class="op" id="1553779">*</span><span class="ident" id="1553780">mspan</span><span class="op" id="1553785">)</span><span class="op" id="1553786">(</span><span class="ident" id="1553787">mp</span><span class="op" id="1553789">.</span><span class="ident" id="1553790">ptrarg</span><span class="op" id="1553796">[</span><span class="num" id="1553797">0</span><span class="op" id="1553798">]</span><span class="op" id="1553799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553803">mp</span><span class="op" id="1553805">.</span><span class="ident" id="1553806">ptrarg</span><span class="op" id="1553812">[</span><span class="num" id="1553813">0</span><span class="op" id="1553814">]</span>&nbsp;<span class="op" id="1553816">=</span>&nbsp;<span class="builtintype" id="1553818">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553824">releasem</span><span class="op" id="1553832">(</span><span class="ident" id="1553833">mp</span><span class="op" id="1553835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553839">x</span>&nbsp;<span class="op" id="1553841">=</span>&nbsp;<span class="ident" id="1553843">unsafe</span><span class="op" id="1553849">.</span><span class="ident" id="1553850">Pointer</span><span class="op" id="1553857">(</span><span class="builtintype" id="1553858">uintptr</span><span class="op" id="1553865">(</span><span class="ident" id="1553866">s</span><span class="op" id="1553867">.</span><span class="ident" id="1553868">start</span>&nbsp;<span class="op" id="1553874">&lt;&lt;</span>&nbsp;<span class="ident" id="1553877">pageShift</span><span class="op" id="1553886">)</span><span class="op" id="1553887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553891">size</span>&nbsp;<span class="op" id="1553896">=</span>&nbsp;<span class="builtintype" id="1553898">uintptr</span><span class="op" id="1553905">(</span><span class="ident" id="1553906">s</span><span class="op" id="1553907">.</span><span class="ident" id="1553908">elemsize</span><span class="op" id="1553916">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553923">if</span>&nbsp;<span class="ident" id="1553926">flags</span><span class="op" id="1553931">&amp;</span><span class="ident" id="1553932">flagNoScan</span>&nbsp;<span class="op" id="1553943">!=</span>&nbsp;<span class="num" id="1553946">0</span>&nbsp;<span class="op" id="1553948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1553952">//&nbsp;All&nbsp;objects&nbsp;are&nbsp;pre-marked&nbsp;as&nbsp;noscan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553995">goto</span>&nbsp;<span class="ident" id="1554000">marked</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554012">//&nbsp;If&nbsp;allocating&nbsp;a&nbsp;defer+arg&nbsp;block,&nbsp;now&nbsp;that&nbsp;we&#39;ve&nbsp;picked&nbsp;a&nbsp;malloc&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554085">//&nbsp;large&nbsp;enough&nbsp;to&nbsp;hold&nbsp;everything,&nbsp;cut&nbsp;the&nbsp;&#34;asked&nbsp;for&#34;&nbsp;size&nbsp;down&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554155">//&nbsp;just&nbsp;the&nbsp;defer&nbsp;header,&nbsp;so&nbsp;that&nbsp;the&nbsp;GC&nbsp;bitmap&nbsp;will&nbsp;record&nbsp;the&nbsp;arg&nbsp;block</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554230">//&nbsp;as&nbsp;containing&nbsp;nothing&nbsp;at&nbsp;all&nbsp;(as&nbsp;if&nbsp;it&nbsp;were&nbsp;unused&nbsp;space&nbsp;at&nbsp;the&nbsp;end&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554305">//&nbsp;a&nbsp;malloc&nbsp;block&nbsp;caused&nbsp;by&nbsp;size&nbsp;rounding).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554350">//&nbsp;The&nbsp;defer&nbsp;arg&nbsp;areas&nbsp;are&nbsp;scanned&nbsp;as&nbsp;part&nbsp;of&nbsp;scanstack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554408">if</span>&nbsp;<span class="ident" id="1554411">typ</span>&nbsp;<span class="op" id="1554415">==</span>&nbsp;<span class="ident" id="1554418">deferType</span>&nbsp;<span class="op" id="1554428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554432">size0</span>&nbsp;<span class="op" id="1554438">=</span>&nbsp;<span class="ident" id="1554440">unsafe</span><span class="op" id="1554446">.</span><span class="ident" id="1554447">Sizeof</span><span class="op" id="1554453">(</span><span class="ident" id="1554454">_defer</span><span class="op" id="1554460">{</span><span class="op" id="1554461">}</span><span class="op" id="1554462">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554469">//&nbsp;From&nbsp;here&nbsp;till&nbsp;marked&nbsp;label&nbsp;marking&nbsp;the&nbsp;object&nbsp;as&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554533">//&nbsp;and&nbsp;storing&nbsp;type&nbsp;info&nbsp;in&nbsp;the&nbsp;GC&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554577">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554581">arena_start</span>&nbsp;<span class="op" id="1554593">:=</span>&nbsp;<span class="builtintype" id="1554596">uintptr</span><span class="op" id="1554603">(</span><span class="ident" id="1554604">unsafe</span><span class="op" id="1554610">.</span><span class="ident" id="1554611">Pointer</span><span class="op" id="1554618">(</span><span class="ident" id="1554619">mheap_</span><span class="op" id="1554625">.</span><span class="ident" id="1554626">arena_start</span><span class="op" id="1554637">)</span><span class="op" id="1554638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554642">off</span>&nbsp;<span class="op" id="1554646">:=</span>&nbsp;<span class="op" id="1554649">(</span><span class="builtintype" id="1554650">uintptr</span><span class="op" id="1554657">(</span><span class="ident" id="1554658">x</span><span class="op" id="1554659">)</span>&nbsp;<span class="op" id="1554661">-</span>&nbsp;<span class="ident" id="1554663">arena_start</span><span class="op" id="1554674">)</span>&nbsp;<span class="op" id="1554676">/</span>&nbsp;<span class="ident" id="1554678">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554688">xbits</span>&nbsp;<span class="op" id="1554694">:=</span>&nbsp;<span class="op" id="1554697">(</span><span class="op" id="1554698">*</span><span class="builtintype" id="1554699">uint8</span><span class="op" id="1554704">)</span><span class="op" id="1554705">(</span><span class="ident" id="1554706">unsafe</span><span class="op" id="1554712">.</span><span class="ident" id="1554713">Pointer</span><span class="op" id="1554720">(</span><span class="ident" id="1554721">arena_start</span>&nbsp;<span class="op" id="1554733">-</span>&nbsp;<span class="ident" id="1554735">off</span><span class="op" id="1554738">/</span><span class="ident" id="1554739">wordsPerBitmapByte</span>&nbsp;<span class="op" id="1554758">-</span>&nbsp;<span class="num" id="1554760">1</span><span class="op" id="1554761">)</span><span class="op" id="1554762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554766">shift</span>&nbsp;<span class="op" id="1554772">:=</span>&nbsp;<span class="op" id="1554775">(</span><span class="ident" id="1554776">off</span>&nbsp;<span class="op" id="1554780">%</span>&nbsp;<span class="ident" id="1554782">wordsPerBitmapByte</span><span class="op" id="1554800">)</span>&nbsp;<span class="op" id="1554802">*</span>&nbsp;<span class="ident" id="1554804">gcBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554813">if</span>&nbsp;<span class="ident" id="1554816">debugMalloc</span>&nbsp;<span class="op" id="1554828">&amp;&amp;</span>&nbsp;<span class="op" id="1554831">(</span><span class="op" id="1554832">(</span><span class="op" id="1554833">*</span><span class="ident" id="1554834">xbits</span><span class="op" id="1554839">&gt;&gt;</span><span class="ident" id="1554841">shift</span><span class="op" id="1554846">)</span><span class="op" id="1554847">&amp;</span><span class="op" id="1554848">(</span><span class="ident" id="1554849">bitMask</span><span class="op" id="1554856">|</span><span class="ident" id="1554857">bitPtrMask</span><span class="op" id="1554867">)</span><span class="op" id="1554868">)</span>&nbsp;<span class="op" id="1554870">!=</span>&nbsp;<span class="ident" id="1554873">bitBoundary</span>&nbsp;<span class="op" id="1554885">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1554890">println</span><span class="op" id="1554897">(</span><span class="string" id="1554898">&#34;runtime:&nbsp;bits&nbsp;=&#34;</span><span class="op" id="1554915">,</span>&nbsp;<span class="op" id="1554917">(</span><span class="op" id="1554918">*</span><span class="ident" id="1554919">xbits</span><span class="op" id="1554924">&gt;&gt;</span><span class="ident" id="1554926">shift</span><span class="op" id="1554931">)</span><span class="op" id="1554932">&amp;</span><span class="op" id="1554933">(</span><span class="ident" id="1554934">bitMask</span><span class="op" id="1554941">|</span><span class="ident" id="1554942">bitPtrMask</span><span class="op" id="1554952">)</span><span class="op" id="1554953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554958">gothrow</span><span class="op" id="1554965">(</span><span class="string" id="1554966">&#34;bad&nbsp;bits&nbsp;in&nbsp;markallocated&#34;</span><span class="op" id="1554993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555002">var</span>&nbsp;<span class="ident" id="1555006">ti</span><span class="op" id="1555008">,</span>&nbsp;<span class="ident" id="1555010">te</span>&nbsp;<span class="builtintype" id="1555013">uintptr</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555023">var</span>&nbsp;<span class="ident" id="1555027">ptrmask</span>&nbsp;<span class="op" id="1555035">*</span><span class="builtintype" id="1555036">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555044">if</span>&nbsp;<span class="ident" id="1555047">size</span>&nbsp;<span class="op" id="1555052">==</span>&nbsp;<span class="ident" id="1555055">ptrSize</span>&nbsp;<span class="op" id="1555063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555068">//&nbsp;It&#39;s&nbsp;one&nbsp;word&nbsp;and&nbsp;it&nbsp;has&nbsp;pointers,&nbsp;it&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555131">*</span><span class="ident" id="1555132">xbits</span>&nbsp;<span class="op" id="1555138">|=</span>&nbsp;<span class="op" id="1555141">(</span><span class="ident" id="1555142">bitsPointer</span>&nbsp;<span class="op" id="1555154">&lt;&lt;</span>&nbsp;<span class="num" id="1555157">2</span><span class="op" id="1555158">)</span>&nbsp;<span class="op" id="1555160">&lt;&lt;</span>&nbsp;<span class="ident" id="1555163">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555172">goto</span>&nbsp;<span class="ident" id="1555177">marked</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555190">if</span>&nbsp;<span class="ident" id="1555193">typ</span><span class="op" id="1555196">.</span><span class="ident" id="1555197">kind</span><span class="op" id="1555201">&amp;</span><span class="ident" id="1555202">kindGCProg</span>&nbsp;<span class="op" id="1555213">!=</span>&nbsp;<span class="num" id="1555216">0</span>&nbsp;<span class="op" id="1555218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555223">nptr</span>&nbsp;<span class="op" id="1555228">:=</span>&nbsp;<span class="op" id="1555231">(</span><span class="builtintype" id="1555232">uintptr</span><span class="op" id="1555239">(</span><span class="ident" id="1555240">typ</span><span class="op" id="1555243">.</span><span class="ident" id="1555244">size</span><span class="op" id="1555248">)</span>&nbsp;<span class="op" id="1555250">+</span>&nbsp;<span class="ident" id="1555252">ptrSize</span>&nbsp;<span class="op" id="1555260">-</span>&nbsp;<span class="num" id="1555262">1</span><span class="op" id="1555263">)</span>&nbsp;<span class="op" id="1555265">/</span>&nbsp;<span class="ident" id="1555267">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555278">masksize</span>&nbsp;<span class="op" id="1555287">:=</span>&nbsp;<span class="ident" id="1555290">nptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555298">if</span>&nbsp;<span class="ident" id="1555301">masksize</span><span class="op" id="1555309">%</span><span class="num" id="1555310">2</span>&nbsp;<span class="op" id="1555312">!=</span>&nbsp;<span class="num" id="1555315">0</span>&nbsp;<span class="op" id="1555317">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555323">masksize</span>&nbsp;<span class="op" id="1555332">*=</span>&nbsp;<span class="num" id="1555335">2</span>&nbsp;<span class="comment" id="1555337">//&nbsp;repeated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555357">masksize</span>&nbsp;<span class="op" id="1555366">=</span>&nbsp;<span class="ident" id="1555368">masksize</span>&nbsp;<span class="op" id="1555377">*</span>&nbsp;<span class="ident" id="1555379">pointersPerByte</span>&nbsp;<span class="op" id="1555395">/</span>&nbsp;<span class="num" id="1555397">8</span>&nbsp;<span class="comment" id="1555399">//&nbsp;4&nbsp;bits&nbsp;per&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555421">masksize</span><span class="op" id="1555429">++</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555463">//&nbsp;unroll&nbsp;flag&nbsp;in&nbsp;the&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555498">if</span>&nbsp;<span class="ident" id="1555501">masksize</span>&nbsp;<span class="op" id="1555510">&gt;</span>&nbsp;<span class="ident" id="1555512">maxGCMask</span>&nbsp;<span class="op" id="1555522">&amp;&amp;</span>&nbsp;<span class="ident" id="1555525">typ</span><span class="op" id="1555528">.</span><span class="ident" id="1555529">gc</span><span class="op" id="1555531">[</span><span class="num" id="1555532">1</span><span class="op" id="1555533">]</span>&nbsp;<span class="op" id="1555535">!=</span>&nbsp;<span class="num" id="1555538">0</span>&nbsp;<span class="op" id="1555540">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555546">//&nbsp;If&nbsp;the&nbsp;mask&nbsp;is&nbsp;too&nbsp;large,&nbsp;unroll&nbsp;the&nbsp;program&nbsp;directly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555607">//&nbsp;into&nbsp;the&nbsp;GC&nbsp;bitmap.&nbsp;It&#39;s&nbsp;7&nbsp;times&nbsp;slower&nbsp;than&nbsp;copying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555667">//&nbsp;from&nbsp;the&nbsp;pre-unrolled&nbsp;mask,&nbsp;but&nbsp;saves&nbsp;1/16&nbsp;of&nbsp;type&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555730">//&nbsp;memory&nbsp;for&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555758">mp</span>&nbsp;<span class="op" id="1555761">:=</span>&nbsp;<span class="ident" id="1555764">acquirem</span><span class="op" id="1555772">(</span><span class="op" id="1555773">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555779">mp</span><span class="op" id="1555781">.</span><span class="ident" id="1555782">ptrarg</span><span class="op" id="1555788">[</span><span class="num" id="1555789">0</span><span class="op" id="1555790">]</span>&nbsp;<span class="op" id="1555792">=</span>&nbsp;<span class="ident" id="1555794">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555800">mp</span><span class="op" id="1555802">.</span><span class="ident" id="1555803">ptrarg</span><span class="op" id="1555809">[</span><span class="num" id="1555810">1</span><span class="op" id="1555811">]</span>&nbsp;<span class="op" id="1555813">=</span>&nbsp;<span class="ident" id="1555815">unsafe</span><span class="op" id="1555821">.</span><span class="ident" id="1555822">Pointer</span><span class="op" id="1555829">(</span><span class="ident" id="1555830">typ</span><span class="op" id="1555833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555839">mp</span><span class="op" id="1555841">.</span><span class="ident" id="1555842">scalararg</span><span class="op" id="1555851">[</span><span class="num" id="1555852">0</span><span class="op" id="1555853">]</span>&nbsp;<span class="op" id="1555855">=</span>&nbsp;<span class="builtintype" id="1555857">uintptr</span><span class="op" id="1555864">(</span><span class="ident" id="1555865">size</span><span class="op" id="1555869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555875">mp</span><span class="op" id="1555877">.</span><span class="ident" id="1555878">scalararg</span><span class="op" id="1555887">[</span><span class="num" id="1555888">1</span><span class="op" id="1555889">]</span>&nbsp;<span class="op" id="1555891">=</span>&nbsp;<span class="builtintype" id="1555893">uintptr</span><span class="op" id="1555900">(</span><span class="ident" id="1555901">size0</span><span class="op" id="1555906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555912">onM</span><span class="op" id="1555915">(</span><span class="ident" id="1555916">unrollgcproginplace_m</span><span class="op" id="1555937">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555943">releasem</span><span class="op" id="1555951">(</span><span class="ident" id="1555952">mp</span><span class="op" id="1555954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555960">goto</span>&nbsp;<span class="ident" id="1555965">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555980">ptrmask</span>&nbsp;<span class="op" id="1555988">=</span>&nbsp;<span class="op" id="1555990">(</span><span class="op" id="1555991">*</span><span class="builtintype" id="1555992">uint8</span><span class="op" id="1555997">)</span><span class="op" id="1555998">(</span><span class="ident" id="1555999">unsafe</span><span class="op" id="1556005">.</span><span class="ident" id="1556006">Pointer</span><span class="op" id="1556013">(</span><span class="builtintype" id="1556014">uintptr</span><span class="op" id="1556021">(</span><span class="ident" id="1556022">typ</span><span class="op" id="1556025">.</span><span class="ident" id="1556026">gc</span><span class="op" id="1556028">[</span><span class="num" id="1556029">0</span><span class="op" id="1556030">]</span><span class="op" id="1556031">)</span><span class="op" id="1556032">)</span><span class="op" id="1556033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556038">//&nbsp;Check&nbsp;whether&nbsp;the&nbsp;program&nbsp;is&nbsp;already&nbsp;unrolled.</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556091">if</span>&nbsp;<span class="builtintype" id="1556094">uintptr</span><span class="op" id="1556101">(</span><span class="ident" id="1556102">atomicloadp</span><span class="op" id="1556113">(</span><span class="ident" id="1556114">unsafe</span><span class="op" id="1556120">.</span><span class="ident" id="1556121">Pointer</span><span class="op" id="1556128">(</span><span class="ident" id="1556129">ptrmask</span><span class="op" id="1556136">)</span><span class="op" id="1556137">)</span><span class="op" id="1556138">)</span><span class="op" id="1556139">&amp;</span><span class="num" id="1556140">0xff</span>&nbsp;<span class="op" id="1556145">==</span>&nbsp;<span class="num" id="1556148">0</span>&nbsp;<span class="op" id="1556150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556156">mp</span>&nbsp;<span class="op" id="1556159">:=</span>&nbsp;<span class="ident" id="1556162">acquirem</span><span class="op" id="1556170">(</span><span class="op" id="1556171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556177">mp</span><span class="op" id="1556179">.</span><span class="ident" id="1556180">ptrarg</span><span class="op" id="1556186">[</span><span class="num" id="1556187">0</span><span class="op" id="1556188">]</span>&nbsp;<span class="op" id="1556190">=</span>&nbsp;<span class="ident" id="1556192">unsafe</span><span class="op" id="1556198">.</span><span class="ident" id="1556199">Pointer</span><span class="op" id="1556206">(</span><span class="ident" id="1556207">typ</span><span class="op" id="1556210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556216">onM</span><span class="op" id="1556219">(</span><span class="ident" id="1556220">unrollgcprog_m</span><span class="op" id="1556234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556240">releasem</span><span class="op" id="1556248">(</span><span class="ident" id="1556249">mp</span><span class="op" id="1556251">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556261">ptrmask</span>&nbsp;<span class="op" id="1556269">=</span>&nbsp;<span class="op" id="1556271">(</span><span class="op" id="1556272">*</span><span class="builtintype" id="1556273">uint8</span><span class="op" id="1556278">)</span><span class="op" id="1556279">(</span><span class="ident" id="1556280">add</span><span class="op" id="1556283">(</span><span class="ident" id="1556284">unsafe</span><span class="op" id="1556290">.</span><span class="ident" id="1556291">Pointer</span><span class="op" id="1556298">(</span><span class="ident" id="1556299">ptrmask</span><span class="op" id="1556306">)</span><span class="op" id="1556307">,</span>&nbsp;<span class="num" id="1556309">1</span><span class="op" id="1556310">)</span><span class="op" id="1556311">)</span>&nbsp;<span class="comment" id="1556313">//&nbsp;skip&nbsp;the&nbsp;unroll&nbsp;flag&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556344">}</span>&nbsp;<span class="keyword" id="1556346">else</span>&nbsp;<span class="op" id="1556351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556356">ptrmask</span>&nbsp;<span class="op" id="1556364">=</span>&nbsp;<span class="op" id="1556366">(</span><span class="op" id="1556367">*</span><span class="builtintype" id="1556368">uint8</span><span class="op" id="1556373">)</span><span class="op" id="1556374">(</span><span class="ident" id="1556375">unsafe</span><span class="op" id="1556381">.</span><span class="ident" id="1556382">Pointer</span><span class="op" id="1556389">(</span><span class="ident" id="1556390">typ</span><span class="op" id="1556393">.</span><span class="ident" id="1556394">gc</span><span class="op" id="1556396">[</span><span class="num" id="1556397">0</span><span class="op" id="1556398">]</span><span class="op" id="1556399">)</span><span class="op" id="1556400">)</span>&nbsp;<span class="comment" id="1556402">//&nbsp;pointer&nbsp;to&nbsp;unrolled&nbsp;mask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556432">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556436">if</span>&nbsp;<span class="ident" id="1556439">size</span>&nbsp;<span class="op" id="1556444">==</span>&nbsp;<span class="num" id="1556447">2</span><span class="op" id="1556448">*</span><span class="ident" id="1556449">ptrSize</span>&nbsp;<span class="op" id="1556457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556462">*</span><span class="ident" id="1556463">xbits</span>&nbsp;<span class="op" id="1556469">=</span>&nbsp;<span class="op" id="1556471">*</span><span class="ident" id="1556472">ptrmask</span>&nbsp;<span class="op" id="1556480">|</span>&nbsp;<span class="ident" id="1556482">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556497">goto</span>&nbsp;<span class="ident" id="1556502">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556515">te</span>&nbsp;<span class="op" id="1556518">=</span>&nbsp;<span class="builtintype" id="1556520">uintptr</span><span class="op" id="1556527">(</span><span class="ident" id="1556528">typ</span><span class="op" id="1556531">.</span><span class="ident" id="1556532">size</span><span class="op" id="1556536">)</span>&nbsp;<span class="op" id="1556538">/</span>&nbsp;<span class="ident" id="1556540">ptrSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556550">//&nbsp;If&nbsp;the&nbsp;type&nbsp;occupies&nbsp;odd&nbsp;number&nbsp;of&nbsp;words,&nbsp;its&nbsp;mask&nbsp;is&nbsp;repeated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556619">if</span>&nbsp;<span class="ident" id="1556622">te</span><span class="op" id="1556624">%</span><span class="num" id="1556625">2</span>&nbsp;<span class="op" id="1556627">==</span>&nbsp;<span class="num" id="1556630">0</span>&nbsp;<span class="op" id="1556632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556637">te</span>&nbsp;<span class="op" id="1556640">/=</span>&nbsp;<span class="num" id="1556643">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556651">//&nbsp;Copy&nbsp;pointer&nbsp;bitmask&nbsp;into&nbsp;the&nbsp;bitmap.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556694">for</span>&nbsp;<span class="ident" id="1556698">i</span>&nbsp;<span class="op" id="1556700">:=</span>&nbsp;<span class="builtintype" id="1556703">uintptr</span><span class="op" id="1556710">(</span><span class="num" id="1556711">0</span><span class="op" id="1556712">)</span><span class="op" id="1556713">;</span>&nbsp;<span class="ident" id="1556715">i</span>&nbsp;<span class="op" id="1556717">&lt;</span>&nbsp;<span class="ident" id="1556719">size0</span><span class="op" id="1556724">;</span>&nbsp;<span class="ident" id="1556726">i</span>&nbsp;<span class="op" id="1556728">+=</span>&nbsp;<span class="num" id="1556731">2</span>&nbsp;<span class="op" id="1556733">*</span>&nbsp;<span class="ident" id="1556735">ptrSize</span>&nbsp;<span class="op" id="1556743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556748">v</span>&nbsp;<span class="op" id="1556750">:=</span>&nbsp;<span class="op" id="1556753">*</span><span class="op" id="1556754">(</span><span class="op" id="1556755">*</span><span class="builtintype" id="1556756">uint8</span><span class="op" id="1556761">)</span><span class="op" id="1556762">(</span><span class="ident" id="1556763">add</span><span class="op" id="1556766">(</span><span class="ident" id="1556767">unsafe</span><span class="op" id="1556773">.</span><span class="ident" id="1556774">Pointer</span><span class="op" id="1556781">(</span><span class="ident" id="1556782">ptrmask</span><span class="op" id="1556789">)</span><span class="op" id="1556790">,</span>&nbsp;<span class="ident" id="1556792">ti</span><span class="op" id="1556794">)</span><span class="op" id="1556795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556800">ti</span><span class="op" id="1556802">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556808">if</span>&nbsp;<span class="ident" id="1556811">ti</span>&nbsp;<span class="op" id="1556814">==</span>&nbsp;<span class="ident" id="1556817">te</span>&nbsp;<span class="op" id="1556820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556826">ti</span>&nbsp;<span class="op" id="1556829">=</span>&nbsp;<span class="num" id="1556831">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556841">if</span>&nbsp;<span class="ident" id="1556844">i</span>&nbsp;<span class="op" id="1556846">==</span>&nbsp;<span class="num" id="1556849">0</span>&nbsp;<span class="op" id="1556851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556857">v</span>&nbsp;<span class="op" id="1556859">|=</span>&nbsp;<span class="ident" id="1556862">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556882">if</span>&nbsp;<span class="ident" id="1556885">i</span><span class="op" id="1556886">+</span><span class="ident" id="1556887">ptrSize</span>&nbsp;<span class="op" id="1556895">==</span>&nbsp;<span class="ident" id="1556898">size0</span>&nbsp;<span class="op" id="1556904">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556910">v</span>&nbsp;<span class="op" id="1556912">&amp;^=</span>&nbsp;<span class="builtintype" id="1556916">uint8</span><span class="op" id="1556921">(</span><span class="ident" id="1556922">bitPtrMask</span>&nbsp;<span class="op" id="1556933">&lt;&lt;</span>&nbsp;<span class="num" id="1556936">4</span><span class="op" id="1556937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556948">*</span><span class="ident" id="1556949">xbits</span>&nbsp;<span class="op" id="1556955">=</span>&nbsp;<span class="ident" id="1556957">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556962">xbits</span>&nbsp;<span class="op" id="1556968">=</span>&nbsp;<span class="op" id="1556970">(</span><span class="op" id="1556971">*</span><span class="builtintype" id="1556972">byte</span><span class="op" id="1556976">)</span><span class="op" id="1556977">(</span><span class="ident" id="1556978">add</span><span class="op" id="1556981">(</span><span class="ident" id="1556982">unsafe</span><span class="op" id="1556988">.</span><span class="ident" id="1556989">Pointer</span><span class="op" id="1556996">(</span><span class="ident" id="1556997">xbits</span><span class="op" id="1557002">)</span><span class="op" id="1557003">,</span>&nbsp;<span class="op" id="1557005">^</span><span class="builtintype" id="1557006">uintptr</span><span class="op" id="1557013">(</span><span class="num" id="1557014">0</span><span class="op" id="1557015">)</span><span class="op" id="1557016">)</span><span class="op" id="1557017">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557025">if</span>&nbsp;<span class="ident" id="1557028">size0</span><span class="op" id="1557033">%</span><span class="op" id="1557034">(</span><span class="num" id="1557035">2</span><span class="op" id="1557036">*</span><span class="ident" id="1557037">ptrSize</span><span class="op" id="1557044">)</span>&nbsp;<span class="op" id="1557046">==</span>&nbsp;<span class="num" id="1557049">0</span>&nbsp;<span class="op" id="1557051">&amp;&amp;</span>&nbsp;<span class="ident" id="1557054">size0</span>&nbsp;<span class="op" id="1557060">&lt;</span>&nbsp;<span class="ident" id="1557062">size</span>&nbsp;<span class="op" id="1557067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557072">//&nbsp;Mark&nbsp;the&nbsp;word&nbsp;after&nbsp;last&nbsp;object&#39;s&nbsp;word&nbsp;as&nbsp;bitsDead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557130">*</span><span class="ident" id="1557131">xbits</span>&nbsp;<span class="op" id="1557137">=</span>&nbsp;<span class="ident" id="1557139">bitsDead</span>&nbsp;<span class="op" id="1557148">&lt;&lt;</span>&nbsp;<span class="num" id="1557151">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557155">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557158">}</span><br>
<span class="lineno"></span><span class="ident" id="1557160">marked</span><span class="op" id="1557166">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557169">if</span>&nbsp;<span class="ident" id="1557172">raceenabled</span>&nbsp;<span class="op" id="1557184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557188">racemalloc</span><span class="op" id="1557198">(</span><span class="ident" id="1557199">x</span><span class="op" id="1557200">,</span>&nbsp;<span class="ident" id="1557202">size</span><span class="op" id="1557206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557209">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557213">if</span>&nbsp;<span class="ident" id="1557216">debugMalloc</span>&nbsp;<span class="op" id="1557228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557232">mp</span>&nbsp;<span class="op" id="1557235">:=</span>&nbsp;<span class="ident" id="1557238">acquirem</span><span class="op" id="1557246">(</span><span class="op" id="1557247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557251">if</span>&nbsp;<span class="ident" id="1557254">mp</span><span class="op" id="1557256">.</span><span class="ident" id="1557257">mallocing</span>&nbsp;<span class="op" id="1557267">==</span>&nbsp;<span class="num" id="1557270">0</span>&nbsp;<span class="op" id="1557272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557277">gothrow</span><span class="op" id="1557284">(</span><span class="string" id="1557285">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1557297">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557305">mp</span><span class="op" id="1557307">.</span><span class="ident" id="1557308">mallocing</span>&nbsp;<span class="op" id="1557318">=</span>&nbsp;<span class="num" id="1557320">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557324">if</span>&nbsp;<span class="ident" id="1557327">mp</span><span class="op" id="1557329">.</span><span class="ident" id="1557330">curg</span>&nbsp;<span class="op" id="1557335">!=</span>&nbsp;<span class="builtintype" id="1557338">nil</span>&nbsp;<span class="op" id="1557342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557347">mp</span><span class="op" id="1557349">.</span><span class="ident" id="1557350">curg</span><span class="op" id="1557354">.</span><span class="ident" id="1557355">stackguard0</span>&nbsp;<span class="op" id="1557367">=</span>&nbsp;<span class="ident" id="1557369">mp</span><span class="op" id="1557371">.</span><span class="ident" id="1557372">curg</span><span class="op" id="1557376">.</span><span class="ident" id="1557377">stack</span><span class="op" id="1557382">.</span><span class="ident" id="1557383">lo</span>&nbsp;<span class="op" id="1557386">+</span>&nbsp;<span class="ident" id="1557388">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557402">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557406">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557459">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557511">releasem</span><span class="op" id="1557519">(</span><span class="ident" id="1557520">mp</span><span class="op" id="1557522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557526">releasem</span><span class="op" id="1557534">(</span><span class="ident" id="1557535">mp</span><span class="op" id="1557537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557540">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557544">if</span>&nbsp;<span class="ident" id="1557547">debug</span><span class="op" id="1557552">.</span><span class="ident" id="1557553">allocfreetrace</span>&nbsp;<span class="op" id="1557568">!=</span>&nbsp;<span class="num" id="1557571">0</span>&nbsp;<span class="op" id="1557573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557577">tracealloc</span><span class="op" id="1557587">(</span><span class="ident" id="1557588">x</span><span class="op" id="1557589">,</span>&nbsp;<span class="ident" id="1557591">size</span><span class="op" id="1557595">,</span>&nbsp;<span class="ident" id="1557597">typ</span><span class="op" id="1557600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557607">if</span>&nbsp;<span class="ident" id="1557610">rate</span>&nbsp;<span class="op" id="1557615">:=</span>&nbsp;<span class="ident" id="1557618">MemProfileRate</span><span class="op" id="1557632">;</span>&nbsp;<span class="ident" id="1557634">rate</span>&nbsp;<span class="op" id="1557639">&gt;</span>&nbsp;<span class="num" id="1557641">0</span>&nbsp;<span class="op" id="1557643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557647">if</span>&nbsp;<span class="ident" id="1557650">size</span>&nbsp;<span class="op" id="1557655">&lt;</span>&nbsp;<span class="builtintype" id="1557657">uintptr</span><span class="op" id="1557664">(</span><span class="ident" id="1557665">rate</span><span class="op" id="1557669">)</span>&nbsp;<span class="op" id="1557671">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1557674">int32</span><span class="op" id="1557679">(</span><span class="ident" id="1557680">size</span><span class="op" id="1557684">)</span>&nbsp;<span class="op" id="1557686">&lt;</span>&nbsp;<span class="ident" id="1557688">c</span><span class="op" id="1557689">.</span><span class="ident" id="1557690">next_sample</span>&nbsp;<span class="op" id="1557702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557707">c</span><span class="op" id="1557708">.</span><span class="ident" id="1557709">next_sample</span>&nbsp;<span class="op" id="1557721">-=</span>&nbsp;<span class="builtintype" id="1557724">int32</span><span class="op" id="1557729">(</span><span class="ident" id="1557730">size</span><span class="op" id="1557734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557738">}</span>&nbsp;<span class="keyword" id="1557740">else</span>&nbsp;<span class="op" id="1557745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557750">mp</span>&nbsp;<span class="op" id="1557753">:=</span>&nbsp;<span class="ident" id="1557756">acquirem</span><span class="op" id="1557764">(</span><span class="op" id="1557765">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557770">profilealloc</span><span class="op" id="1557782">(</span><span class="ident" id="1557783">mp</span><span class="op" id="1557785">,</span>&nbsp;<span class="ident" id="1557787">x</span><span class="op" id="1557788">,</span>&nbsp;<span class="ident" id="1557790">size</span><span class="op" id="1557794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557799">releasem</span><span class="op" id="1557807">(</span><span class="ident" id="1557808">mp</span><span class="op" id="1557810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557821">if</span>&nbsp;<span class="ident" id="1557824">memstats</span><span class="op" id="1557832">.</span><span class="ident" id="1557833">heap_alloc</span>&nbsp;<span class="op" id="1557844">&gt;=</span>&nbsp;<span class="ident" id="1557847">memstats</span><span class="op" id="1557855">.</span><span class="ident" id="1557856">next_gc</span>&nbsp;<span class="op" id="1557864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557868">gogc</span><span class="op" id="1557872">(</span><span class="num" id="1557873">0</span><span class="op" id="1557874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557881">return</span>&nbsp;<span class="ident" id="1557888">x</span><br>
<span class="lineno">345</span><span class="op" id="1557890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1557893">//&nbsp;implementation&nbsp;of&nbsp;new&nbsp;builtin</span><br>
<span class="lineno"></span><span class="keyword" id="1557926">func</span>&nbsp;<span class="ident" id="1557931">newobject</span><span class="op" id="1557940">(</span><span class="ident" id="1557941">typ</span>&nbsp;<span class="op" id="1557945">*</span><span class="ident" id="1557946">_type</span><span class="op" id="1557951">)</span>&nbsp;<span class="ident" id="1557953">unsafe</span><span class="op" id="1557959">.</span><span class="ident" id="1557960">Pointer</span>&nbsp;<span class="op" id="1557968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557971">flags</span>&nbsp;<span class="op" id="1557977">:=</span>&nbsp;<span class="builtintype" id="1557980">uint32</span><span class="op" id="1557986">(</span><span class="num" id="1557987">0</span><span class="op" id="1557988">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557991">if</span>&nbsp;<span class="ident" id="1557994">typ</span><span class="op" id="1557997">.</span><span class="ident" id="1557998">kind</span><span class="op" id="1558002">&amp;</span><span class="ident" id="1558003">kindNoPointers</span>&nbsp;<span class="op" id="1558018">!=</span>&nbsp;<span class="num" id="1558021">0</span>&nbsp;<span class="op" id="1558023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558027">flags</span>&nbsp;<span class="op" id="1558033">|=</span>&nbsp;<span class="ident" id="1558036">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558051">return</span>&nbsp;<span class="ident" id="1558058">mallocgc</span><span class="op" id="1558066">(</span><span class="builtintype" id="1558067">uintptr</span><span class="op" id="1558074">(</span><span class="ident" id="1558075">typ</span><span class="op" id="1558078">.</span><span class="ident" id="1558079">size</span><span class="op" id="1558083">)</span><span class="op" id="1558084">,</span>&nbsp;<span class="ident" id="1558086">typ</span><span class="op" id="1558089">,</span>&nbsp;<span class="ident" id="1558091">flags</span><span class="op" id="1558096">)</span><br>
<span class="lineno"></span><span class="op" id="1558098">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="1558101">//&nbsp;implementation&nbsp;of&nbsp;make&nbsp;builtin&nbsp;for&nbsp;slices</span><br>
<span class="lineno"></span><span class="keyword" id="1558146">func</span>&nbsp;<span class="ident" id="1558151">newarray</span><span class="op" id="1558159">(</span><span class="ident" id="1558160">typ</span>&nbsp;<span class="op" id="1558164">*</span><span class="ident" id="1558165">_type</span><span class="op" id="1558170">,</span>&nbsp;<span class="ident" id="1558172">n</span>&nbsp;<span class="builtintype" id="1558174">uintptr</span><span class="op" id="1558181">)</span>&nbsp;<span class="ident" id="1558183">unsafe</span><span class="op" id="1558189">.</span><span class="ident" id="1558190">Pointer</span>&nbsp;<span class="op" id="1558198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558201">flags</span>&nbsp;<span class="op" id="1558207">:=</span>&nbsp;<span class="builtintype" id="1558210">uint32</span><span class="op" id="1558216">(</span><span class="num" id="1558217">0</span><span class="op" id="1558218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558221">if</span>&nbsp;<span class="ident" id="1558224">typ</span><span class="op" id="1558227">.</span><span class="ident" id="1558228">kind</span><span class="op" id="1558232">&amp;</span><span class="ident" id="1558233">kindNoPointers</span>&nbsp;<span class="op" id="1558248">!=</span>&nbsp;<span class="num" id="1558251">0</span>&nbsp;<span class="op" id="1558253">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558257">flags</span>&nbsp;<span class="op" id="1558263">|=</span>&nbsp;<span class="ident" id="1558266">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558281">if</span>&nbsp;<span class="builtintype" id="1558284">int</span><span class="op" id="1558287">(</span><span class="ident" id="1558288">n</span><span class="op" id="1558289">)</span>&nbsp;<span class="op" id="1558291">&lt;</span>&nbsp;<span class="num" id="1558293">0</span>&nbsp;<span class="op" id="1558295">||</span>&nbsp;<span class="op" id="1558298">(</span><span class="ident" id="1558299">typ</span><span class="op" id="1558302">.</span><span class="ident" id="1558303">size</span>&nbsp;<span class="op" id="1558308">&gt;</span>&nbsp;<span class="num" id="1558310">0</span>&nbsp;<span class="op" id="1558312">&amp;&amp;</span>&nbsp;<span class="ident" id="1558315">n</span>&nbsp;<span class="op" id="1558317">&gt;</span>&nbsp;<span class="ident" id="1558319">maxmem</span><span class="op" id="1558325">/</span><span class="builtintype" id="1558326">uintptr</span><span class="op" id="1558333">(</span><span class="ident" id="1558334">typ</span><span class="op" id="1558337">.</span><span class="ident" id="1558338">size</span><span class="op" id="1558342">)</span><span class="op" id="1558343">)</span>&nbsp;<span class="op" id="1558345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1558349">panic</span><span class="op" id="1558354">(</span><span class="string" id="1558355">&#34;runtime:&nbsp;allocation&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1558394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558397">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558400">return</span>&nbsp;<span class="ident" id="1558407">mallocgc</span><span class="op" id="1558415">(</span><span class="builtintype" id="1558416">uintptr</span><span class="op" id="1558423">(</span><span class="ident" id="1558424">typ</span><span class="op" id="1558427">.</span><span class="ident" id="1558428">size</span><span class="op" id="1558432">)</span><span class="op" id="1558433">*</span><span class="ident" id="1558434">n</span><span class="op" id="1558435">,</span>&nbsp;<span class="ident" id="1558437">typ</span><span class="op" id="1558440">,</span>&nbsp;<span class="ident" id="1558442">flags</span><span class="op" id="1558447">)</span><br>
<span class="lineno"></span><span class="op" id="1558449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1558452">//&nbsp;rawmem&nbsp;returns&nbsp;a&nbsp;chunk&nbsp;of&nbsp;pointerless&nbsp;memory.&nbsp;&nbsp;It&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1558508">//&nbsp;not&nbsp;zeroed.</span><br>
<span class="lineno">370</span><span class="keyword" id="1558523">func</span>&nbsp;<span class="ident" id="1558528">rawmem</span><span class="op" id="1558534">(</span><span class="ident" id="1558535">size</span>&nbsp;<span class="builtintype" id="1558540">uintptr</span><span class="op" id="1558547">)</span>&nbsp;<span class="ident" id="1558549">unsafe</span><span class="op" id="1558555">.</span><span class="ident" id="1558556">Pointer</span>&nbsp;<span class="op" id="1558564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558567">return</span>&nbsp;<span class="ident" id="1558574">mallocgc</span><span class="op" id="1558582">(</span><span class="ident" id="1558583">size</span><span class="op" id="1558587">,</span>&nbsp;<span class="builtintype" id="1558589">nil</span><span class="op" id="1558592">,</span>&nbsp;<span class="ident" id="1558594">flagNoScan</span><span class="op" id="1558604">|</span><span class="ident" id="1558605">flagNoZero</span><span class="op" id="1558615">)</span><br>
<span class="lineno"></span><span class="op" id="1558617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1558620">//&nbsp;round&nbsp;size&nbsp;up&nbsp;to&nbsp;next&nbsp;size&nbsp;class</span><br>
<span class="lineno">375</span><span class="keyword" id="1558656">func</span>&nbsp;<span class="ident" id="1558661">goroundupsize</span><span class="op" id="1558674">(</span><span class="ident" id="1558675">size</span>&nbsp;<span class="builtintype" id="1558680">uintptr</span><span class="op" id="1558687">)</span>&nbsp;<span class="builtintype" id="1558689">uintptr</span>&nbsp;<span class="op" id="1558697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558700">if</span>&nbsp;<span class="ident" id="1558703">size</span>&nbsp;<span class="op" id="1558708">&lt;</span>&nbsp;<span class="ident" id="1558710">maxSmallSize</span>&nbsp;<span class="op" id="1558723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558727">if</span>&nbsp;<span class="ident" id="1558730">size</span>&nbsp;<span class="op" id="1558735">&lt;=</span>&nbsp;<span class="num" id="1558738">1024</span><span class="op" id="1558742">-</span><span class="num" id="1558743">8</span>&nbsp;<span class="op" id="1558745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558750">return</span>&nbsp;<span class="builtintype" id="1558757">uintptr</span><span class="op" id="1558764">(</span><span class="ident" id="1558765">class_to_size</span><span class="op" id="1558778">[</span><span class="ident" id="1558779">size_to_class8</span><span class="op" id="1558793">[</span><span class="op" id="1558794">(</span><span class="ident" id="1558795">size</span><span class="op" id="1558799">+</span><span class="num" id="1558800">7</span><span class="op" id="1558801">)</span><span class="op" id="1558802">&gt;&gt;</span><span class="num" id="1558804">3</span><span class="op" id="1558805">]</span><span class="op" id="1558806">]</span><span class="op" id="1558807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558811">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558815">return</span>&nbsp;<span class="builtintype" id="1558822">uintptr</span><span class="op" id="1558829">(</span><span class="ident" id="1558830">class_to_size</span><span class="op" id="1558843">[</span><span class="ident" id="1558844">size_to_class128</span><span class="op" id="1558860">[</span><span class="op" id="1558861">(</span><span class="ident" id="1558862">size</span><span class="op" id="1558866">-</span><span class="num" id="1558867">1024</span><span class="op" id="1558871">+</span><span class="num" id="1558872">127</span><span class="op" id="1558875">)</span><span class="op" id="1558876">&gt;&gt;</span><span class="num" id="1558878">7</span><span class="op" id="1558879">]</span><span class="op" id="1558880">]</span><span class="op" id="1558881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558887">if</span>&nbsp;<span class="ident" id="1558890">size</span><span class="op" id="1558894">+</span><span class="ident" id="1558895">pageSize</span>&nbsp;<span class="op" id="1558904">&lt;</span>&nbsp;<span class="ident" id="1558906">size</span>&nbsp;<span class="op" id="1558911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558915">return</span>&nbsp;<span class="ident" id="1558922">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558928">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558931">return</span>&nbsp;<span class="op" id="1558938">(</span><span class="ident" id="1558939">size</span>&nbsp;<span class="op" id="1558944">+</span>&nbsp;<span class="ident" id="1558946">pageSize</span>&nbsp;<span class="op" id="1558955">-</span>&nbsp;<span class="num" id="1558957">1</span><span class="op" id="1558958">)</span>&nbsp;<span class="op" id="1558960">&amp;^</span>&nbsp;<span class="ident" id="1558963">pageMask</span><br>
<span class="lineno"></span><span class="op" id="1558972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1558975">func</span>&nbsp;<span class="ident" id="1558980">profilealloc</span><span class="op" id="1558992">(</span><span class="ident" id="1558993">mp</span>&nbsp;<span class="op" id="1558996">*</span><span class="ident" id="1558997">m</span><span class="op" id="1558998">,</span>&nbsp;<span class="ident" id="1559000">x</span>&nbsp;<span class="ident" id="1559002">unsafe</span><span class="op" id="1559008">.</span><span class="ident" id="1559009">Pointer</span><span class="op" id="1559016">,</span>&nbsp;<span class="ident" id="1559018">size</span>&nbsp;<span class="builtintype" id="1559023">uintptr</span><span class="op" id="1559030">)</span>&nbsp;<span class="op" id="1559032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559035">c</span>&nbsp;<span class="op" id="1559037">:=</span>&nbsp;<span class="ident" id="1559040">mp</span><span class="op" id="1559042">.</span><span class="ident" id="1559043">mcache</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559051">rate</span>&nbsp;<span class="op" id="1559056">:=</span>&nbsp;<span class="ident" id="1559059">MemProfileRate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559075">if</span>&nbsp;<span class="ident" id="1559078">size</span>&nbsp;<span class="op" id="1559083">&lt;</span>&nbsp;<span class="builtintype" id="1559085">uintptr</span><span class="op" id="1559092">(</span><span class="ident" id="1559093">rate</span><span class="op" id="1559097">)</span>&nbsp;<span class="op" id="1559099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559103">//&nbsp;pick&nbsp;next&nbsp;profile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559131">//&nbsp;If&nbsp;you&nbsp;change&nbsp;this,&nbsp;also&nbsp;change&nbsp;allocmcache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559181">if</span>&nbsp;<span class="ident" id="1559184">rate</span>&nbsp;<span class="op" id="1559189">&gt;</span>&nbsp;<span class="num" id="1559191">0x3fffffff</span>&nbsp;<span class="op" id="1559202">{</span>&nbsp;<span class="comment" id="1559204">//&nbsp;make&nbsp;2*rate&nbsp;not&nbsp;overflow</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559235">rate</span>&nbsp;<span class="op" id="1559240">=</span>&nbsp;<span class="num" id="1559242">0x3fffffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559259">next</span>&nbsp;<span class="op" id="1559264">:=</span>&nbsp;<span class="builtintype" id="1559267">int32</span><span class="op" id="1559272">(</span><span class="ident" id="1559273">fastrand1</span><span class="op" id="1559282">(</span><span class="op" id="1559283">)</span><span class="op" id="1559284">)</span>&nbsp;<span class="op" id="1559286">%</span>&nbsp;<span class="op" id="1559288">(</span><span class="num" id="1559289">2</span>&nbsp;<span class="op" id="1559291">*</span>&nbsp;<span class="builtintype" id="1559293">int32</span><span class="op" id="1559298">(</span><span class="ident" id="1559299">rate</span><span class="op" id="1559303">)</span><span class="op" id="1559304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559308">//&nbsp;Subtract&nbsp;the&nbsp;&#34;remainder&#34;&nbsp;of&nbsp;the&nbsp;current&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559365">//&nbsp;Otherwise&nbsp;objects&nbsp;that&nbsp;are&nbsp;close&nbsp;in&nbsp;size&nbsp;to&nbsp;sampling&nbsp;rate</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559428">//&nbsp;will&nbsp;be&nbsp;under-sampled,&nbsp;because&nbsp;we&nbsp;consistently&nbsp;discard&nbsp;this&nbsp;remainder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559504">next</span>&nbsp;<span class="op" id="1559509">-=</span>&nbsp;<span class="op" id="1559512">(</span><span class="builtintype" id="1559513">int32</span><span class="op" id="1559518">(</span><span class="ident" id="1559519">size</span><span class="op" id="1559523">)</span>&nbsp;<span class="op" id="1559525">-</span>&nbsp;<span class="ident" id="1559527">c</span><span class="op" id="1559528">.</span><span class="ident" id="1559529">next_sample</span><span class="op" id="1559540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559544">if</span>&nbsp;<span class="ident" id="1559547">next</span>&nbsp;<span class="op" id="1559552">&lt;</span>&nbsp;<span class="num" id="1559554">0</span>&nbsp;<span class="op" id="1559556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559561">next</span>&nbsp;<span class="op" id="1559566">=</span>&nbsp;<span class="num" id="1559568">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559572">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559576">c</span><span class="op" id="1559577">.</span><span class="ident" id="1559578">next_sample</span>&nbsp;<span class="op" id="1559590">=</span>&nbsp;<span class="ident" id="1559592">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559602">mProf_Malloc</span><span class="op" id="1559614">(</span><span class="ident" id="1559615">x</span><span class="op" id="1559616">,</span>&nbsp;<span class="ident" id="1559618">size</span><span class="op" id="1559622">)</span><br>
<span class="lineno"></span><span class="op" id="1559624">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="1559627">//&nbsp;force&nbsp;=&nbsp;1&nbsp;-&nbsp;do&nbsp;GC&nbsp;regardless&nbsp;of&nbsp;current&nbsp;heap&nbsp;usage</span><br>
<span class="lineno"></span><span class="comment" id="1559681">//&nbsp;force&nbsp;=&nbsp;2&nbsp;-&nbsp;go&nbsp;GC&nbsp;and&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span><span class="keyword" id="1559718">func</span>&nbsp;<span class="ident" id="1559723">gogc</span><span class="op" id="1559727">(</span><span class="ident" id="1559728">force</span>&nbsp;<span class="builtintype" id="1559734">int32</span><span class="op" id="1559739">)</span>&nbsp;<span class="op" id="1559741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559744">//&nbsp;The&nbsp;gc&nbsp;is&nbsp;turned&nbsp;off&nbsp;(via&nbsp;enablegc)&nbsp;until&nbsp;the&nbsp;bootstrap&nbsp;has&nbsp;completed.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559819">//&nbsp;Also,&nbsp;malloc&nbsp;gets&nbsp;called&nbsp;in&nbsp;the&nbsp;guts&nbsp;of&nbsp;a&nbsp;number&nbsp;of&nbsp;libraries&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559899">//&nbsp;holding&nbsp;locks.&nbsp;To&nbsp;avoid&nbsp;deadlocks&nbsp;during&nbsp;stoptheworld,&nbsp;don&#39;t&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559971">//&nbsp;trying&nbsp;to&nbsp;run&nbsp;gc&nbsp;while&nbsp;holding&nbsp;a&nbsp;lock.&nbsp;The&nbsp;next&nbsp;mallocgc&nbsp;without&nbsp;a&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560047">//&nbsp;will&nbsp;do&nbsp;the&nbsp;gc&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560075">mp</span>&nbsp;<span class="op" id="1560078">:=</span>&nbsp;<span class="ident" id="1560081">acquirem</span><span class="op" id="1560089">(</span><span class="op" id="1560090">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560093">if</span>&nbsp;<span class="ident" id="1560096">gp</span>&nbsp;<span class="op" id="1560099">:=</span>&nbsp;<span class="ident" id="1560102">getg</span><span class="op" id="1560106">(</span><span class="op" id="1560107">)</span><span class="op" id="1560108">;</span>&nbsp;<span class="ident" id="1560110">gp</span>&nbsp;<span class="op" id="1560113">==</span>&nbsp;<span class="ident" id="1560116">mp</span><span class="op" id="1560118">.</span><span class="ident" id="1560119">g0</span>&nbsp;<span class="op" id="1560122">||</span>&nbsp;<span class="ident" id="1560125">mp</span><span class="op" id="1560127">.</span><span class="ident" id="1560128">locks</span>&nbsp;<span class="op" id="1560134">&gt;</span>&nbsp;<span class="num" id="1560136">1</span>&nbsp;<span class="op" id="1560138">||</span>&nbsp;<span class="op" id="1560141">!</span><span class="ident" id="1560142">memstats</span><span class="op" id="1560150">.</span><span class="ident" id="1560151">enablegc</span>&nbsp;<span class="op" id="1560160">||</span>&nbsp;<span class="ident" id="1560163">panicking</span>&nbsp;<span class="op" id="1560173">!=</span>&nbsp;<span class="num" id="1560176">0</span>&nbsp;<span class="op" id="1560178">||</span>&nbsp;<span class="ident" id="1560181">gcpercent</span>&nbsp;<span class="op" id="1560191">&lt;</span>&nbsp;<span class="num" id="1560193">0</span>&nbsp;<span class="op" id="1560195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560199">releasem</span><span class="op" id="1560207">(</span><span class="ident" id="1560208">mp</span><span class="op" id="1560210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560214">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1560222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560225">releasem</span><span class="op" id="1560233">(</span><span class="ident" id="1560234">mp</span><span class="op" id="1560236">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560239">mp</span>&nbsp;<span class="op" id="1560242">=</span>&nbsp;<span class="builtintype" id="1560244">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560250">semacquire</span><span class="op" id="1560260">(</span><span class="op" id="1560261">&amp;</span><span class="ident" id="1560262">worldsema</span><span class="op" id="1560271">,</span>&nbsp;<span class="builtintype" id="1560273">false</span><span class="op" id="1560278">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560282">if</span>&nbsp;<span class="ident" id="1560285">force</span>&nbsp;<span class="op" id="1560291">==</span>&nbsp;<span class="num" id="1560294">0</span>&nbsp;<span class="op" id="1560296">&amp;&amp;</span>&nbsp;<span class="ident" id="1560299">memstats</span><span class="op" id="1560307">.</span><span class="ident" id="1560308">heap_alloc</span>&nbsp;<span class="op" id="1560319">&lt;</span>&nbsp;<span class="ident" id="1560321">memstats</span><span class="op" id="1560329">.</span><span class="ident" id="1560330">next_gc</span>&nbsp;<span class="op" id="1560338">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560342">//&nbsp;typically&nbsp;threads&nbsp;which&nbsp;lost&nbsp;the&nbsp;race&nbsp;to&nbsp;grab</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560393">//&nbsp;worldsema&nbsp;exit&nbsp;here&nbsp;when&nbsp;gc&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560435">semrelease</span><span class="op" id="1560445">(</span><span class="op" id="1560446">&amp;</span><span class="ident" id="1560447">worldsema</span><span class="op" id="1560456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560460">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1560468">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560472">//&nbsp;Ok,&nbsp;we&#39;re&nbsp;doing&nbsp;it!&nbsp;&nbsp;Stop&nbsp;everybody&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560517">startTime</span>&nbsp;<span class="op" id="1560527">:=</span>&nbsp;<span class="ident" id="1560530">nanotime</span><span class="op" id="1560538">(</span><span class="op" id="1560539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560542">mp</span>&nbsp;<span class="op" id="1560545">=</span>&nbsp;<span class="ident" id="1560547">acquirem</span><span class="op" id="1560555">(</span><span class="op" id="1560556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560559">mp</span><span class="op" id="1560561">.</span><span class="ident" id="1560562">gcing</span>&nbsp;<span class="op" id="1560568">=</span>&nbsp;<span class="num" id="1560570">1</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560573">releasem</span><span class="op" id="1560581">(</span><span class="ident" id="1560582">mp</span><span class="op" id="1560584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560587">onM</span><span class="op" id="1560590">(</span><span class="ident" id="1560591">stoptheworld</span><span class="op" id="1560603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560606">if</span>&nbsp;<span class="ident" id="1560609">mp</span>&nbsp;<span class="op" id="1560612">!=</span>&nbsp;<span class="ident" id="1560615">acquirem</span><span class="op" id="1560623">(</span><span class="op" id="1560624">)</span>&nbsp;<span class="op" id="1560626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560630">gothrow</span><span class="op" id="1560637">(</span><span class="string" id="1560638">&#34;gogc:&nbsp;rescheduled&#34;</span><span class="op" id="1560657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1560660">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560664">clearpools</span><span class="op" id="1560674">(</span><span class="op" id="1560675">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560679">//&nbsp;Run&nbsp;gc&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;so&nbsp;that&nbsp;the&nbsp;g&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560739">//&nbsp;we&#39;re&nbsp;currently&nbsp;running&nbsp;on&nbsp;will&nbsp;no&nbsp;longer&nbsp;change.&nbsp;&nbsp;Cuts</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560799">//&nbsp;the&nbsp;root&nbsp;set&nbsp;down&nbsp;a&nbsp;bit&nbsp;(g0&nbsp;stacks&nbsp;are&nbsp;not&nbsp;scanned,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560859">//&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;scan&nbsp;gc&#39;s&nbsp;internal&nbsp;state).&nbsp;&nbsp;We&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560916">//&nbsp;need&nbsp;to&nbsp;switch&nbsp;to&nbsp;g0&nbsp;so&nbsp;we&nbsp;can&nbsp;shrink&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560969">n</span>&nbsp;<span class="op" id="1560971">:=</span>&nbsp;<span class="num" id="1560974">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560977">if</span>&nbsp;<span class="ident" id="1560980">debug</span><span class="op" id="1560985">.</span><span class="ident" id="1560986">gctrace</span>&nbsp;<span class="op" id="1560994">&gt;</span>&nbsp;<span class="num" id="1560996">1</span>&nbsp;<span class="op" id="1560998">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561002">n</span>&nbsp;<span class="op" id="1561004">=</span>&nbsp;<span class="num" id="1561006">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1561009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1561012">for</span>&nbsp;<span class="ident" id="1561016">i</span>&nbsp;<span class="op" id="1561018">:=</span>&nbsp;<span class="num" id="1561021">0</span><span class="op" id="1561022">;</span>&nbsp;<span class="ident" id="1561024">i</span>&nbsp;<span class="op" id="1561026">&lt;</span>&nbsp;<span class="ident" id="1561028">n</span><span class="op" id="1561029">;</span>&nbsp;<span class="ident" id="1561031">i</span><span class="op" id="1561032">++</span>&nbsp;<span class="op" id="1561035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1561039">if</span>&nbsp;<span class="ident" id="1561042">i</span>&nbsp;<span class="op" id="1561044">&gt;</span>&nbsp;<span class="num" id="1561046">0</span>&nbsp;<span class="op" id="1561048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561053">startTime</span>&nbsp;<span class="op" id="1561063">=</span>&nbsp;<span class="ident" id="1561065">nanotime</span><span class="op" id="1561073">(</span><span class="op" id="1561074">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1561078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561082">//&nbsp;switch&nbsp;to&nbsp;g0,&nbsp;call&nbsp;gc,&nbsp;then&nbsp;switch&nbsp;back</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561127">mp</span><span class="op" id="1561129">.</span><span class="ident" id="1561130">scalararg</span><span class="op" id="1561139">[</span><span class="num" id="1561140">0</span><span class="op" id="1561141">]</span>&nbsp;<span class="op" id="1561143">=</span>&nbsp;<span class="builtintype" id="1561145">uintptr</span><span class="op" id="1561152">(</span><span class="builtintype" id="1561153">uint32</span><span class="op" id="1561159">(</span><span class="ident" id="1561160">startTime</span><span class="op" id="1561169">)</span><span class="op" id="1561170">)</span>&nbsp;<span class="comment" id="1561172">//&nbsp;low&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561189">mp</span><span class="op" id="1561191">.</span><span class="ident" id="1561192">scalararg</span><span class="op" id="1561201">[</span><span class="num" id="1561202">1</span><span class="op" id="1561203">]</span>&nbsp;<span class="op" id="1561205">=</span>&nbsp;<span class="builtintype" id="1561207">uintptr</span><span class="op" id="1561214">(</span><span class="ident" id="1561215">startTime</span>&nbsp;<span class="op" id="1561225">&gt;&gt;</span>&nbsp;<span class="num" id="1561228">32</span><span class="op" id="1561230">)</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1561234">//&nbsp;high&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1561252">if</span>&nbsp;<span class="ident" id="1561255">force</span>&nbsp;<span class="op" id="1561261">&gt;=</span>&nbsp;<span class="num" id="1561264">2</span>&nbsp;<span class="op" id="1561266">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561271">mp</span><span class="op" id="1561273">.</span><span class="ident" id="1561274">scalararg</span><span class="op" id="1561283">[</span><span class="num" id="1561284">2</span><span class="op" id="1561285">]</span>&nbsp;<span class="op" id="1561287">=</span>&nbsp;<span class="num" id="1561289">1</span>&nbsp;<span class="comment" id="1561291">//&nbsp;eagersweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1561307">}</span>&nbsp;<span class="keyword" id="1561309">else</span>&nbsp;<span class="op" id="1561314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561319">mp</span><span class="op" id="1561321">.</span><span class="ident" id="1561322">scalararg</span><span class="op" id="1561331">[</span><span class="num" id="1561332">2</span><span class="op" id="1561333">]</span>&nbsp;<span class="op" id="1561335">=</span>&nbsp;<span class="num" id="1561337">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1561341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561345">onM</span><span class="op" id="1561348">(</span><span class="ident" id="1561349">gc_m</span><span class="op" id="1561353">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1561356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561360">//&nbsp;all&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561373">mp</span><span class="op" id="1561375">.</span><span class="ident" id="1561376">gcing</span>&nbsp;<span class="op" id="1561382">=</span>&nbsp;<span class="num" id="1561384">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561387">semrelease</span><span class="op" id="1561397">(</span><span class="op" id="1561398">&amp;</span><span class="ident" id="1561399">worldsema</span><span class="op" id="1561408">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561411">onM</span><span class="op" id="1561414">(</span><span class="ident" id="1561415">starttheworld</span><span class="op" id="1561428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561431">releasem</span><span class="op" id="1561439">(</span><span class="ident" id="1561440">mp</span><span class="op" id="1561442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561445">mp</span>&nbsp;<span class="op" id="1561448">=</span>&nbsp;<span class="builtintype" id="1561450">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561456">//&nbsp;now&nbsp;that&nbsp;gc&nbsp;is&nbsp;done,&nbsp;kick&nbsp;off&nbsp;finalizer&nbsp;thread&nbsp;if&nbsp;needed</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1561517">if</span>&nbsp;<span class="op" id="1561520">!</span><span class="ident" id="1561521">concurrentSweep</span>&nbsp;<span class="op" id="1561537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561541">//&nbsp;give&nbsp;the&nbsp;queued&nbsp;finalizers,&nbsp;if&nbsp;any,&nbsp;a&nbsp;chance&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561598">Gosched</span><span class="op" id="1561605">(</span><span class="op" id="1561606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1561609">}</span><br>
<span class="lineno"></span><span class="op" id="1561611">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="1561614">//&nbsp;GC&nbsp;runs&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span><span class="keyword" id="1561647">func</span>&nbsp;<span class="ident" id="1561652">GC</span><span class="op" id="1561654">(</span><span class="op" id="1561655">)</span>&nbsp;<span class="op" id="1561657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561660">gogc</span><span class="op" id="1561664">(</span><span class="num" id="1561665">2</span><span class="op" id="1561666">)</span><br>
<span class="lineno"></span><span class="op" id="1561668">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="comment" id="1561671">//&nbsp;linker-provided</span><br>
<span class="lineno"></span><span class="keyword" id="1561690">var</span>&nbsp;<span class="ident" id="1561694">noptrdata</span>&nbsp;<span class="keyword" id="1561704">struct</span><span class="op" id="1561710">{</span><span class="op" id="1561711">}</span><br>
<span class="lineno"></span><span class="keyword" id="1561713">var</span>&nbsp;<span class="ident" id="1561717">enoptrdata</span>&nbsp;<span class="keyword" id="1561728">struct</span><span class="op" id="1561734">{</span><span class="op" id="1561735">}</span><br>
<span class="lineno"></span><span class="keyword" id="1561737">var</span>&nbsp;<span class="ident" id="1561741">noptrbss</span>&nbsp;<span class="keyword" id="1561750">struct</span><span class="op" id="1561756">{</span><span class="op" id="1561757">}</span><br>
<span class="lineno">495</span><span class="keyword" id="1561759">var</span>&nbsp;<span class="ident" id="1561763">enoptrbss</span>&nbsp;<span class="keyword" id="1561773">struct</span><span class="op" id="1561779">{</span><span class="op" id="1561780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1561783">//&nbsp;SetFinalizer&nbsp;sets&nbsp;the&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1561842">//&nbsp;When&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;finds&nbsp;an&nbsp;unreachable&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="1561899">//&nbsp;with&nbsp;an&nbsp;associated&nbsp;finalizer,&nbsp;it&nbsp;clears&nbsp;the&nbsp;association&nbsp;and&nbsp;runs</span><br>
<span class="lineno">500</span><span class="comment" id="1561967">//&nbsp;f(x)&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine.&nbsp;&nbsp;This&nbsp;makes&nbsp;x&nbsp;reachable&nbsp;again,&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="1562035">//&nbsp;now&nbsp;without&nbsp;an&nbsp;associated&nbsp;finalizer.&nbsp;&nbsp;Assuming&nbsp;that&nbsp;SetFinalizer</span><br>
<span class="lineno"></span><span class="comment" id="1562103">//&nbsp;is&nbsp;not&nbsp;called&nbsp;again,&nbsp;the&nbsp;next&nbsp;time&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;sees</span><br>
<span class="lineno"></span><span class="comment" id="1562168">//&nbsp;that&nbsp;x&nbsp;is&nbsp;unreachable,&nbsp;it&nbsp;will&nbsp;free&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1562210">//</span><br>
<span class="lineno">505</span><span class="comment" id="1562213">//&nbsp;SetFinalizer(x,&nbsp;nil)&nbsp;clears&nbsp;any&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1562277">//</span><br>
<span class="lineno"></span><span class="comment" id="1562280">//&nbsp;The&nbsp;argument&nbsp;x&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;object&nbsp;allocated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1562342">//&nbsp;calling&nbsp;new&nbsp;or&nbsp;by&nbsp;taking&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;composite&nbsp;literal.</span><br>
<span class="lineno"></span><span class="comment" id="1562406">//&nbsp;The&nbsp;argument&nbsp;f&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;that&nbsp;takes&nbsp;a&nbsp;single&nbsp;argument</span><br>
<span class="lineno">510</span><span class="comment" id="1562472">//&nbsp;to&nbsp;which&nbsp;x&#39;s&nbsp;type&nbsp;can&nbsp;be&nbsp;assigned,&nbsp;and&nbsp;can&nbsp;have&nbsp;arbitrary&nbsp;ignored&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="1562548">//&nbsp;values.&nbsp;If&nbsp;either&nbsp;of&nbsp;these&nbsp;is&nbsp;not&nbsp;true,&nbsp;SetFinalizer&nbsp;aborts&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1562615">//&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1562627">//</span><br>
<span class="lineno"></span><span class="comment" id="1562630">//&nbsp;Finalizers&nbsp;are&nbsp;run&nbsp;in&nbsp;dependency&nbsp;order:&nbsp;if&nbsp;A&nbsp;points&nbsp;at&nbsp;B,&nbsp;both&nbsp;have</span><br>
<span class="lineno">515</span><span class="comment" id="1562701">//&nbsp;finalizers,&nbsp;and&nbsp;they&nbsp;are&nbsp;otherwise&nbsp;unreachable,&nbsp;only&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1562771">//&nbsp;for&nbsp;A&nbsp;runs;&nbsp;once&nbsp;A&nbsp;is&nbsp;freed,&nbsp;the&nbsp;finalizer&nbsp;for&nbsp;B&nbsp;can&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="1562832">//&nbsp;If&nbsp;a&nbsp;cyclic&nbsp;structure&nbsp;includes&nbsp;a&nbsp;block&nbsp;with&nbsp;a&nbsp;finalizer,&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1562897">//&nbsp;cycle&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;and&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1562966">//&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;run,&nbsp;because&nbsp;there&nbsp;is&nbsp;no&nbsp;ordering&nbsp;that</span><br>
<span class="lineno">520</span><span class="comment" id="1563029">//&nbsp;respects&nbsp;the&nbsp;dependencies.</span><br>
<span class="lineno"></span><span class="comment" id="1563059">//</span><br>
<span class="lineno"></span><span class="comment" id="1563062">//&nbsp;The&nbsp;finalizer&nbsp;for&nbsp;x&nbsp;is&nbsp;scheduled&nbsp;to&nbsp;run&nbsp;at&nbsp;some&nbsp;arbitrary&nbsp;time&nbsp;after</span><br>
<span class="lineno"></span><span class="comment" id="1563134">//&nbsp;x&nbsp;becomes&nbsp;unreachable.</span><br>
<span class="lineno"></span><span class="comment" id="1563160">//&nbsp;There&nbsp;is&nbsp;no&nbsp;guarantee&nbsp;that&nbsp;finalizers&nbsp;will&nbsp;run&nbsp;before&nbsp;a&nbsp;program&nbsp;exits,</span><br>
<span class="lineno">525</span><span class="comment" id="1563234">//&nbsp;so&nbsp;typically&nbsp;they&nbsp;are&nbsp;useful&nbsp;only&nbsp;for&nbsp;releasing&nbsp;non-memory&nbsp;resources</span><br>
<span class="lineno"></span><span class="comment" id="1563306">//&nbsp;associated&nbsp;with&nbsp;an&nbsp;object&nbsp;during&nbsp;a&nbsp;long-running&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1563366">//&nbsp;For&nbsp;example,&nbsp;an&nbsp;os.File&nbsp;object&nbsp;could&nbsp;use&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;close&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1563435">//&nbsp;associated&nbsp;operating&nbsp;system&nbsp;file&nbsp;descriptor&nbsp;when&nbsp;a&nbsp;program&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="1563506">//&nbsp;an&nbsp;os.File&nbsp;without&nbsp;calling&nbsp;Close,&nbsp;but&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;mistake</span><br>
<span class="lineno">530</span><span class="comment" id="1563569">//&nbsp;to&nbsp;depend&nbsp;on&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;flush&nbsp;an&nbsp;in-memory&nbsp;I/O&nbsp;buffer&nbsp;such&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1563640">//&nbsp;bufio.Writer,&nbsp;because&nbsp;the&nbsp;buffer&nbsp;would&nbsp;not&nbsp;be&nbsp;flushed&nbsp;at&nbsp;program&nbsp;exit.</span><br>
<span class="lineno"></span><span class="comment" id="1563714">//</span><br>
<span class="lineno"></span><span class="comment" id="1563717">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;*x&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1563788">//&nbsp;zero&nbsp;bytes.</span><br>
<span class="lineno">535</span><span class="comment" id="1563803">//</span><br>
<span class="lineno"></span><span class="comment" id="1563806">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;for&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1563878">//&nbsp;in&nbsp;initializers&nbsp;for&nbsp;package-level&nbsp;variables.&nbsp;Such&nbsp;objects&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1563946">//&nbsp;linker-allocated,&nbsp;not&nbsp;heap-allocated.</span><br>
<span class="lineno"></span><span class="comment" id="1563987">//</span><br>
<span class="lineno">540</span><span class="comment" id="1563990">//&nbsp;A&nbsp;single&nbsp;goroutine&nbsp;runs&nbsp;all&nbsp;finalizers&nbsp;for&nbsp;a&nbsp;program,&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="comment" id="1564061">//&nbsp;If&nbsp;a&nbsp;finalizer&nbsp;must&nbsp;run&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;should&nbsp;do&nbsp;so&nbsp;by&nbsp;starting</span><br>
<span class="lineno"></span><span class="comment" id="1564133">//&nbsp;a&nbsp;new&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1564153">func</span>&nbsp;<span class="ident" id="1564158">SetFinalizer</span><span class="op" id="1564170">(</span><span class="ident" id="1564171">obj</span>&nbsp;<span class="keyword" id="1564175">interface</span><span class="op" id="1564184">{</span><span class="op" id="1564185">}</span><span class="op" id="1564186">,</span>&nbsp;<span class="ident" id="1564188">finalizer</span>&nbsp;<span class="keyword" id="1564198">interface</span><span class="op" id="1564207">{</span><span class="op" id="1564208">}</span><span class="op" id="1564209">)</span>&nbsp;<span class="op" id="1564211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1564214">e</span>&nbsp;<span class="op" id="1564216">:=</span>&nbsp;<span class="op" id="1564219">(</span><span class="op" id="1564220">*</span><span class="ident" id="1564221">eface</span><span class="op" id="1564226">)</span><span class="op" id="1564227">(</span><span class="ident" id="1564228">unsafe</span><span class="op" id="1564234">.</span><span class="ident" id="1564235">Pointer</span><span class="op" id="1564242">(</span><span class="op" id="1564243">&amp;</span><span class="ident" id="1564244">obj</span><span class="op" id="1564247">)</span><span class="op" id="1564248">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1564251">etyp</span>&nbsp;<span class="op" id="1564256">:=</span>&nbsp;<span class="ident" id="1564259">e</span><span class="op" id="1564260">.</span><span class="ident" id="1564261">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564268">if</span>&nbsp;<span class="ident" id="1564271">etyp</span>&nbsp;<span class="op" id="1564276">==</span>&nbsp;<span class="builtintype" id="1564279">nil</span>&nbsp;<span class="op" id="1564283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1564287">gothrow</span><span class="op" id="1564294">(</span><span class="string" id="1564295">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;nil&#34;</span><span class="op" id="1564340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1564343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564346">if</span>&nbsp;<span class="ident" id="1564349">etyp</span><span class="op" id="1564353">.</span><span class="ident" id="1564354">kind</span><span class="op" id="1564358">&amp;</span><span class="ident" id="1564359">kindMask</span>&nbsp;<span class="op" id="1564368">!=</span>&nbsp;<span class="ident" id="1564371">kindPtr</span>&nbsp;<span class="op" id="1564379">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1564383">gothrow</span><span class="op" id="1564390">(</span><span class="string" id="1564391">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1564434">+</span>&nbsp;<span class="op" id="1564436">*</span><span class="ident" id="1564437">etyp</span><span class="op" id="1564441">.</span><span class="ident" id="1564442">_string</span>&nbsp;<span class="op" id="1564450">+</span>&nbsp;<span class="string" id="1564452">&#34;,&nbsp;not&nbsp;pointer&#34;</span><span class="op" id="1564467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1564470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1564473">ot</span>&nbsp;<span class="op" id="1564476">:=</span>&nbsp;<span class="op" id="1564479">(</span><span class="op" id="1564480">*</span><span class="ident" id="1564481">ptrtype</span><span class="op" id="1564488">)</span><span class="op" id="1564489">(</span><span class="ident" id="1564490">unsafe</span><span class="op" id="1564496">.</span><span class="ident" id="1564497">Pointer</span><span class="op" id="1564504">(</span><span class="ident" id="1564505">etyp</span><span class="op" id="1564509">)</span><span class="op" id="1564510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564513">if</span>&nbsp;<span class="ident" id="1564516">ot</span><span class="op" id="1564518">.</span><span class="ident" id="1564519">elem</span>&nbsp;<span class="op" id="1564524">==</span>&nbsp;<span class="builtintype" id="1564527">nil</span>&nbsp;<span class="op" id="1564531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1564535">gothrow</span><span class="op" id="1564542">(</span><span class="string" id="1564543">&#34;nil&nbsp;elem&nbsp;type!&#34;</span><span class="op" id="1564559">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1564562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1564566">//&nbsp;find&nbsp;the&nbsp;containing&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1564597">_</span><span class="op" id="1564598">,</span>&nbsp;<span class="ident" id="1564600">base</span><span class="op" id="1564604">,</span>&nbsp;<span class="ident" id="1564606">_</span>&nbsp;<span class="op" id="1564608">:=</span>&nbsp;<span class="ident" id="1564611">findObject</span><span class="op" id="1564621">(</span><span class="ident" id="1564622">e</span><span class="op" id="1564623">.</span><span class="ident" id="1564624">data</span><span class="op" id="1564628">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564632">if</span>&nbsp;<span class="ident" id="1564635">base</span>&nbsp;<span class="op" id="1564640">==</span>&nbsp;<span class="builtintype" id="1564643">nil</span>&nbsp;<span class="op" id="1564647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1564651">//&nbsp;0-length&nbsp;objects&nbsp;are&nbsp;okay.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564683">if</span>&nbsp;<span class="ident" id="1564686">e</span><span class="op" id="1564687">.</span><span class="ident" id="1564688">data</span>&nbsp;<span class="op" id="1564693">==</span>&nbsp;<span class="ident" id="1564696">unsafe</span><span class="op" id="1564702">.</span><span class="ident" id="1564703">Pointer</span><span class="op" id="1564710">(</span><span class="op" id="1564711">&amp;</span><span class="ident" id="1564712">zerobase</span><span class="op" id="1564720">)</span>&nbsp;<span class="op" id="1564722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1564727">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1564736">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1564741">//&nbsp;Global&nbsp;initializers&nbsp;might&nbsp;be&nbsp;linker-allocated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1564793">//&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;Foo&nbsp;=&nbsp;&amp;Object{}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1564818">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1564837">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtime.SetFinalizer(Foo,&nbsp;nil)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1564874">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1564881">//&nbsp;The&nbsp;relevant&nbsp;segments&nbsp;are:&nbsp;noptrdata,&nbsp;data,&nbsp;bss,&nbsp;noptrbss.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1564945">//&nbsp;We&nbsp;cannot&nbsp;assume&nbsp;they&nbsp;are&nbsp;in&nbsp;any&nbsp;order&nbsp;or&nbsp;even&nbsp;contiguous,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1565009">//&nbsp;due&nbsp;to&nbsp;external&nbsp;linking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1565039">if</span>&nbsp;<span class="builtintype" id="1565042">uintptr</span><span class="op" id="1565049">(</span><span class="ident" id="1565050">unsafe</span><span class="op" id="1565056">.</span><span class="ident" id="1565057">Pointer</span><span class="op" id="1565064">(</span><span class="op" id="1565065">&amp;</span><span class="ident" id="1565066">noptrdata</span><span class="op" id="1565075">)</span><span class="op" id="1565076">)</span>&nbsp;<span class="op" id="1565078">&lt;=</span>&nbsp;<span class="builtintype" id="1565081">uintptr</span><span class="op" id="1565088">(</span><span class="ident" id="1565089">e</span><span class="op" id="1565090">.</span><span class="ident" id="1565091">data</span><span class="op" id="1565095">)</span>&nbsp;<span class="op" id="1565097">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1565100">uintptr</span><span class="op" id="1565107">(</span><span class="ident" id="1565108">e</span><span class="op" id="1565109">.</span><span class="ident" id="1565110">data</span><span class="op" id="1565114">)</span>&nbsp;<span class="op" id="1565116">&lt;</span>&nbsp;<span class="builtintype" id="1565118">uintptr</span><span class="op" id="1565125">(</span><span class="ident" id="1565126">unsafe</span><span class="op" id="1565132">.</span><span class="ident" id="1565133">Pointer</span><span class="op" id="1565140">(</span><span class="op" id="1565141">&amp;</span><span class="ident" id="1565142">enoptrdata</span><span class="op" id="1565152">)</span><span class="op" id="1565153">)</span>&nbsp;<span class="op" id="1565155">||</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1565161">uintptr</span><span class="op" id="1565168">(</span><span class="ident" id="1565169">unsafe</span><span class="op" id="1565175">.</span><span class="ident" id="1565176">Pointer</span><span class="op" id="1565183">(</span><span class="op" id="1565184">&amp;</span><span class="ident" id="1565185">data</span><span class="op" id="1565189">)</span><span class="op" id="1565190">)</span>&nbsp;<span class="op" id="1565192">&lt;=</span>&nbsp;<span class="builtintype" id="1565195">uintptr</span><span class="op" id="1565202">(</span><span class="ident" id="1565203">e</span><span class="op" id="1565204">.</span><span class="ident" id="1565205">data</span><span class="op" id="1565209">)</span>&nbsp;<span class="op" id="1565211">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1565214">uintptr</span><span class="op" id="1565221">(</span><span class="ident" id="1565222">e</span><span class="op" id="1565223">.</span><span class="ident" id="1565224">data</span><span class="op" id="1565228">)</span>&nbsp;<span class="op" id="1565230">&lt;</span>&nbsp;<span class="builtintype" id="1565232">uintptr</span><span class="op" id="1565239">(</span><span class="ident" id="1565240">unsafe</span><span class="op" id="1565246">.</span><span class="ident" id="1565247">Pointer</span><span class="op" id="1565254">(</span><span class="op" id="1565255">&amp;</span><span class="ident" id="1565256">edata</span><span class="op" id="1565261">)</span><span class="op" id="1565262">)</span>&nbsp;<span class="op" id="1565264">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1565270">uintptr</span><span class="op" id="1565277">(</span><span class="ident" id="1565278">unsafe</span><span class="op" id="1565284">.</span><span class="ident" id="1565285">Pointer</span><span class="op" id="1565292">(</span><span class="op" id="1565293">&amp;</span><span class="ident" id="1565294">bss</span><span class="op" id="1565297">)</span><span class="op" id="1565298">)</span>&nbsp;<span class="op" id="1565300">&lt;=</span>&nbsp;<span class="builtintype" id="1565303">uintptr</span><span class="op" id="1565310">(</span><span class="ident" id="1565311">e</span><span class="op" id="1565312">.</span><span class="ident" id="1565313">data</span><span class="op" id="1565317">)</span>&nbsp;<span class="op" id="1565319">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1565322">uintptr</span><span class="op" id="1565329">(</span><span class="ident" id="1565330">e</span><span class="op" id="1565331">.</span><span class="ident" id="1565332">data</span><span class="op" id="1565336">)</span>&nbsp;<span class="op" id="1565338">&lt;</span>&nbsp;<span class="builtintype" id="1565340">uintptr</span><span class="op" id="1565347">(</span><span class="ident" id="1565348">unsafe</span><span class="op" id="1565354">.</span><span class="ident" id="1565355">Pointer</span><span class="op" id="1565362">(</span><span class="op" id="1565363">&amp;</span><span class="ident" id="1565364">ebss</span><span class="op" id="1565368">)</span><span class="op" id="1565369">)</span>&nbsp;<span class="op" id="1565371">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1565377">uintptr</span><span class="op" id="1565384">(</span><span class="ident" id="1565385">unsafe</span><span class="op" id="1565391">.</span><span class="ident" id="1565392">Pointer</span><span class="op" id="1565399">(</span><span class="op" id="1565400">&amp;</span><span class="ident" id="1565401">noptrbss</span><span class="op" id="1565409">)</span><span class="op" id="1565410">)</span>&nbsp;<span class="op" id="1565412">&lt;=</span>&nbsp;<span class="builtintype" id="1565415">uintptr</span><span class="op" id="1565422">(</span><span class="ident" id="1565423">e</span><span class="op" id="1565424">.</span><span class="ident" id="1565425">data</span><span class="op" id="1565429">)</span>&nbsp;<span class="op" id="1565431">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1565434">uintptr</span><span class="op" id="1565441">(</span><span class="ident" id="1565442">e</span><span class="op" id="1565443">.</span><span class="ident" id="1565444">data</span><span class="op" id="1565448">)</span>&nbsp;<span class="op" id="1565450">&lt;</span>&nbsp;<span class="builtintype" id="1565452">uintptr</span><span class="op" id="1565459">(</span><span class="ident" id="1565460">unsafe</span><span class="op" id="1565466">.</span><span class="ident" id="1565467">Pointer</span><span class="op" id="1565474">(</span><span class="op" id="1565475">&amp;</span><span class="ident" id="1565476">enoptrbss</span><span class="op" id="1565485">)</span><span class="op" id="1565486">)</span>&nbsp;<span class="op" id="1565488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1565493">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1565502">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565506">gothrow</span><span class="op" id="1565513">(</span><span class="string" id="1565514">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;in&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1565568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1565571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1565575">if</span>&nbsp;<span class="ident" id="1565578">e</span><span class="op" id="1565579">.</span><span class="ident" id="1565580">data</span>&nbsp;<span class="op" id="1565585">!=</span>&nbsp;<span class="ident" id="1565588">base</span>&nbsp;<span class="op" id="1565593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1565597">//&nbsp;As&nbsp;an&nbsp;implementation&nbsp;detail&nbsp;we&nbsp;allow&nbsp;to&nbsp;set&nbsp;finalizers&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1565675">//&nbsp;of&nbsp;an&nbsp;object&nbsp;if&nbsp;it&nbsp;could&nbsp;come&nbsp;from&nbsp;tiny&nbsp;alloc&nbsp;(see&nbsp;mallocgc&nbsp;for&nbsp;details).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1565754">if</span>&nbsp;<span class="ident" id="1565757">ot</span><span class="op" id="1565759">.</span><span class="ident" id="1565760">elem</span>&nbsp;<span class="op" id="1565765">==</span>&nbsp;<span class="builtintype" id="1565768">nil</span>&nbsp;<span class="op" id="1565772">||</span>&nbsp;<span class="ident" id="1565775">ot</span><span class="op" id="1565777">.</span><span class="ident" id="1565778">elem</span><span class="op" id="1565782">.</span><span class="ident" id="1565783">kind</span><span class="op" id="1565787">&amp;</span><span class="ident" id="1565788">kindNoPointers</span>&nbsp;<span class="op" id="1565803">==</span>&nbsp;<span class="num" id="1565806">0</span>&nbsp;<span class="op" id="1565808">||</span>&nbsp;<span class="ident" id="1565811">ot</span><span class="op" id="1565813">.</span><span class="ident" id="1565814">elem</span><span class="op" id="1565818">.</span><span class="ident" id="1565819">size</span>&nbsp;<span class="op" id="1565824">&gt;=</span>&nbsp;<span class="ident" id="1565827">maxTinySize</span>&nbsp;<span class="op" id="1565839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565844">gothrow</span><span class="op" id="1565851">(</span><span class="string" id="1565852">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;at&nbsp;beginning&nbsp;of&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1565919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1565923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1565926">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565930">f</span>&nbsp;<span class="op" id="1565932">:=</span>&nbsp;<span class="op" id="1565935">(</span><span class="op" id="1565936">*</span><span class="ident" id="1565937">eface</span><span class="op" id="1565942">)</span><span class="op" id="1565943">(</span><span class="ident" id="1565944">unsafe</span><span class="op" id="1565950">.</span><span class="ident" id="1565951">Pointer</span><span class="op" id="1565958">(</span><span class="op" id="1565959">&amp;</span><span class="ident" id="1565960">finalizer</span><span class="op" id="1565969">)</span><span class="op" id="1565970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565973">ftyp</span>&nbsp;<span class="op" id="1565978">:=</span>&nbsp;<span class="ident" id="1565981">f</span><span class="op" id="1565982">.</span><span class="ident" id="1565983">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1565990">if</span>&nbsp;<span class="ident" id="1565993">ftyp</span>&nbsp;<span class="op" id="1565998">==</span>&nbsp;<span class="builtintype" id="1566001">nil</span>&nbsp;<span class="op" id="1566005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566009">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;and&nbsp;remove&nbsp;finalizer</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566053">mp</span>&nbsp;<span class="op" id="1566056">:=</span>&nbsp;<span class="ident" id="1566059">acquirem</span><span class="op" id="1566067">(</span><span class="op" id="1566068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566072">mp</span><span class="op" id="1566074">.</span><span class="ident" id="1566075">ptrarg</span><span class="op" id="1566081">[</span><span class="num" id="1566082">0</span><span class="op" id="1566083">]</span>&nbsp;<span class="op" id="1566085">=</span>&nbsp;<span class="ident" id="1566087">e</span><span class="op" id="1566088">.</span><span class="ident" id="1566089">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566096">onM</span><span class="op" id="1566099">(</span><span class="ident" id="1566100">removeFinalizer_m</span><span class="op" id="1566117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566121">releasem</span><span class="op" id="1566129">(</span><span class="ident" id="1566130">mp</span><span class="op" id="1566132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566136">return</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1566144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566148">if</span>&nbsp;<span class="ident" id="1566151">ftyp</span><span class="op" id="1566155">.</span><span class="ident" id="1566156">kind</span><span class="op" id="1566160">&amp;</span><span class="ident" id="1566161">kindMask</span>&nbsp;<span class="op" id="1566170">!=</span>&nbsp;<span class="ident" id="1566173">kindFunc</span>&nbsp;<span class="op" id="1566182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566186">gothrow</span><span class="op" id="1566193">(</span><span class="string" id="1566194">&#34;runtime.SetFinalizer:&nbsp;second&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1566238">+</span>&nbsp;<span class="op" id="1566240">*</span><span class="ident" id="1566241">ftyp</span><span class="op" id="1566245">.</span><span class="ident" id="1566246">_string</span>&nbsp;<span class="op" id="1566254">+</span>&nbsp;<span class="string" id="1566256">&#34;,&nbsp;not&nbsp;a&nbsp;function&#34;</span><span class="op" id="1566274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1566277">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566280">ft</span>&nbsp;<span class="op" id="1566283">:=</span>&nbsp;<span class="op" id="1566286">(</span><span class="op" id="1566287">*</span><span class="ident" id="1566288">functype</span><span class="op" id="1566296">)</span><span class="op" id="1566297">(</span><span class="ident" id="1566298">unsafe</span><span class="op" id="1566304">.</span><span class="ident" id="1566305">Pointer</span><span class="op" id="1566312">(</span><span class="ident" id="1566313">ftyp</span><span class="op" id="1566317">)</span><span class="op" id="1566318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566321">ins</span>&nbsp;<span class="op" id="1566325">:=</span>&nbsp;<span class="op" id="1566328">*</span><span class="op" id="1566329">(</span><span class="op" id="1566330">*</span><span class="op" id="1566331">[</span><span class="op" id="1566332">]</span><span class="op" id="1566333">*</span><span class="ident" id="1566334">_type</span><span class="op" id="1566339">)</span><span class="op" id="1566340">(</span><span class="ident" id="1566341">unsafe</span><span class="op" id="1566347">.</span><span class="ident" id="1566348">Pointer</span><span class="op" id="1566355">(</span><span class="op" id="1566356">&amp;</span><span class="ident" id="1566357">ft</span><span class="op" id="1566359">.</span><span class="ident" id="1566360">in</span><span class="op" id="1566362">)</span><span class="op" id="1566363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566366">if</span>&nbsp;<span class="ident" id="1566369">ft</span><span class="op" id="1566371">.</span><span class="ident" id="1566372">dotdotdot</span>&nbsp;<span class="op" id="1566382">||</span>&nbsp;<span class="builtinfunc" id="1566385">len</span><span class="op" id="1566388">(</span><span class="ident" id="1566389">ins</span><span class="op" id="1566392">)</span>&nbsp;<span class="op" id="1566394">!=</span>&nbsp;<span class="num" id="1566397">1</span>&nbsp;<span class="op" id="1566399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566403">gothrow</span><span class="op" id="1566410">(</span><span class="string" id="1566411">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1566448">+</span>&nbsp;<span class="op" id="1566450">*</span><span class="ident" id="1566451">etyp</span><span class="op" id="1566455">.</span><span class="ident" id="1566456">_string</span>&nbsp;<span class="op" id="1566464">+</span>&nbsp;<span class="string" id="1566466">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1566483">+</span>&nbsp;<span class="op" id="1566485">*</span><span class="ident" id="1566486">ftyp</span><span class="op" id="1566490">.</span><span class="ident" id="1566491">_string</span><span class="op" id="1566498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1566501">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566504">fint</span>&nbsp;<span class="op" id="1566509">:=</span>&nbsp;<span class="ident" id="1566512">ins</span><span class="op" id="1566515">[</span><span class="num" id="1566516">0</span><span class="op" id="1566517">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566520">switch</span>&nbsp;<span class="op" id="1566527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566530">case</span>&nbsp;<span class="ident" id="1566535">fint</span>&nbsp;<span class="op" id="1566540">==</span>&nbsp;<span class="ident" id="1566543">etyp</span><span class="op" id="1566547">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566551">//&nbsp;ok&nbsp;-&nbsp;same&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566571">goto</span>&nbsp;<span class="ident" id="1566576">okarg</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566583">case</span>&nbsp;<span class="ident" id="1566588">fint</span><span class="op" id="1566592">.</span><span class="ident" id="1566593">kind</span><span class="op" id="1566597">&amp;</span><span class="ident" id="1566598">kindMask</span>&nbsp;<span class="op" id="1566607">==</span>&nbsp;<span class="ident" id="1566610">kindPtr</span><span class="op" id="1566617">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566621">if</span>&nbsp;<span class="op" id="1566624">(</span><span class="ident" id="1566625">fint</span><span class="op" id="1566629">.</span><span class="ident" id="1566630">x</span>&nbsp;<span class="op" id="1566632">==</span>&nbsp;<span class="builtintype" id="1566635">nil</span>&nbsp;<span class="op" id="1566639">||</span>&nbsp;<span class="ident" id="1566642">fint</span><span class="op" id="1566646">.</span><span class="ident" id="1566647">x</span><span class="op" id="1566648">.</span><span class="ident" id="1566649">name</span>&nbsp;<span class="op" id="1566654">==</span>&nbsp;<span class="builtintype" id="1566657">nil</span>&nbsp;<span class="op" id="1566661">||</span>&nbsp;<span class="ident" id="1566664">etyp</span><span class="op" id="1566668">.</span><span class="ident" id="1566669">x</span>&nbsp;<span class="op" id="1566671">==</span>&nbsp;<span class="builtintype" id="1566674">nil</span>&nbsp;<span class="op" id="1566678">||</span>&nbsp;<span class="ident" id="1566681">etyp</span><span class="op" id="1566685">.</span><span class="ident" id="1566686">x</span><span class="op" id="1566687">.</span><span class="ident" id="1566688">name</span>&nbsp;<span class="op" id="1566693">==</span>&nbsp;<span class="builtintype" id="1566696">nil</span><span class="op" id="1566699">)</span>&nbsp;<span class="op" id="1566701">&amp;&amp;</span>&nbsp;<span class="op" id="1566704">(</span><span class="op" id="1566705">*</span><span class="ident" id="1566706">ptrtype</span><span class="op" id="1566713">)</span><span class="op" id="1566714">(</span><span class="ident" id="1566715">unsafe</span><span class="op" id="1566721">.</span><span class="ident" id="1566722">Pointer</span><span class="op" id="1566729">(</span><span class="ident" id="1566730">fint</span><span class="op" id="1566734">)</span><span class="op" id="1566735">)</span><span class="op" id="1566736">.</span><span class="ident" id="1566737">elem</span>&nbsp;<span class="op" id="1566742">==</span>&nbsp;<span class="ident" id="1566745">ot</span><span class="op" id="1566747">.</span><span class="ident" id="1566748">elem</span>&nbsp;<span class="op" id="1566753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566758">//&nbsp;ok&nbsp;-&nbsp;not&nbsp;same&nbsp;type,&nbsp;but&nbsp;both&nbsp;pointers,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566803">//&nbsp;one&nbsp;or&nbsp;the&nbsp;other&nbsp;is&nbsp;unnamed,&nbsp;and&nbsp;same&nbsp;element&nbsp;type,&nbsp;so&nbsp;assignable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566876">goto</span>&nbsp;<span class="ident" id="1566881">okarg</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1566889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566892">case</span>&nbsp;<span class="ident" id="1566897">fint</span><span class="op" id="1566901">.</span><span class="ident" id="1566902">kind</span><span class="op" id="1566906">&amp;</span><span class="ident" id="1566907">kindMask</span>&nbsp;<span class="op" id="1566916">==</span>&nbsp;<span class="ident" id="1566919">kindInterface</span><span class="op" id="1566932">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566936">ityp</span>&nbsp;<span class="op" id="1566941">:=</span>&nbsp;<span class="op" id="1566944">(</span><span class="op" id="1566945">*</span><span class="ident" id="1566946">interfacetype</span><span class="op" id="1566959">)</span><span class="op" id="1566960">(</span><span class="ident" id="1566961">unsafe</span><span class="op" id="1566967">.</span><span class="ident" id="1566968">Pointer</span><span class="op" id="1566975">(</span><span class="ident" id="1566976">fint</span><span class="op" id="1566980">)</span><span class="op" id="1566981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1566985">if</span>&nbsp;<span class="builtinfunc" id="1566988">len</span><span class="op" id="1566991">(</span><span class="ident" id="1566992">ityp</span><span class="op" id="1566996">.</span><span class="ident" id="1566997">mhdr</span><span class="op" id="1567001">)</span>&nbsp;<span class="op" id="1567003">==</span>&nbsp;<span class="num" id="1567006">0</span>&nbsp;<span class="op" id="1567008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567013">//&nbsp;ok&nbsp;-&nbsp;satisfies&nbsp;empty&nbsp;interface</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1567050">goto</span>&nbsp;<span class="ident" id="1567055">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1567063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1567067">if</span>&nbsp;<span class="ident" id="1567070">_</span><span class="op" id="1567071">,</span>&nbsp;<span class="ident" id="1567073">ok</span>&nbsp;<span class="op" id="1567076">:=</span>&nbsp;<span class="ident" id="1567079">assertE2I2</span><span class="op" id="1567089">(</span><span class="ident" id="1567090">ityp</span><span class="op" id="1567094">,</span>&nbsp;<span class="ident" id="1567096">obj</span><span class="op" id="1567099">)</span><span class="op" id="1567100">;</span>&nbsp;<span class="ident" id="1567102">ok</span>&nbsp;<span class="op" id="1567105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1567110">goto</span>&nbsp;<span class="ident" id="1567115">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1567123">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1567126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567129">gothrow</span><span class="op" id="1567136">(</span><span class="string" id="1567137">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1567174">+</span>&nbsp;<span class="op" id="1567176">*</span><span class="ident" id="1567177">etyp</span><span class="op" id="1567181">.</span><span class="ident" id="1567182">_string</span>&nbsp;<span class="op" id="1567190">+</span>&nbsp;<span class="string" id="1567192">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1567209">+</span>&nbsp;<span class="op" id="1567211">*</span><span class="ident" id="1567212">ftyp</span><span class="op" id="1567216">.</span><span class="ident" id="1567217">_string</span><span class="op" id="1567224">)</span><br>
<span class="lineno"></span><span class="ident" id="1567226">okarg</span><span class="op" id="1567231">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567234">//&nbsp;compute&nbsp;size&nbsp;needed&nbsp;for&nbsp;return&nbsp;parameters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567280">nret</span>&nbsp;<span class="op" id="1567285">:=</span>&nbsp;<span class="builtintype" id="1567288">uintptr</span><span class="op" id="1567295">(</span><span class="num" id="1567296">0</span><span class="op" id="1567297">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1567300">for</span>&nbsp;<span class="ident" id="1567304">_</span><span class="op" id="1567305">,</span>&nbsp;<span class="ident" id="1567307">t</span>&nbsp;<span class="op" id="1567309">:=</span>&nbsp;<span class="keyword" id="1567312">range</span>&nbsp;<span class="op" id="1567318">*</span><span class="op" id="1567319">(</span><span class="op" id="1567320">*</span><span class="op" id="1567321">[</span><span class="op" id="1567322">]</span><span class="op" id="1567323">*</span><span class="ident" id="1567324">_type</span><span class="op" id="1567329">)</span><span class="op" id="1567330">(</span><span class="ident" id="1567331">unsafe</span><span class="op" id="1567337">.</span><span class="ident" id="1567338">Pointer</span><span class="op" id="1567345">(</span><span class="op" id="1567346">&amp;</span><span class="ident" id="1567347">ft</span><span class="op" id="1567349">.</span><span class="ident" id="1567350">out</span><span class="op" id="1567353">)</span><span class="op" id="1567354">)</span>&nbsp;<span class="op" id="1567356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567360">nret</span>&nbsp;<span class="op" id="1567365">=</span>&nbsp;<span class="ident" id="1567367">round</span><span class="op" id="1567372">(</span><span class="ident" id="1567373">nret</span><span class="op" id="1567377">,</span>&nbsp;<span class="builtintype" id="1567379">uintptr</span><span class="op" id="1567386">(</span><span class="ident" id="1567387">t</span><span class="op" id="1567388">.</span><span class="ident" id="1567389">align</span><span class="op" id="1567394">)</span><span class="op" id="1567395">)</span>&nbsp;<span class="op" id="1567397">+</span>&nbsp;<span class="builtintype" id="1567399">uintptr</span><span class="op" id="1567406">(</span><span class="ident" id="1567407">t</span><span class="op" id="1567408">.</span><span class="ident" id="1567409">size</span><span class="op" id="1567413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1567416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567419">nret</span>&nbsp;<span class="op" id="1567424">=</span>&nbsp;<span class="ident" id="1567426">round</span><span class="op" id="1567431">(</span><span class="ident" id="1567432">nret</span><span class="op" id="1567436">,</span>&nbsp;<span class="ident" id="1567438">ptrSize</span><span class="op" id="1567445">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567449">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;have&nbsp;a&nbsp;finalizer&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567493">createfing</span><span class="op" id="1567503">(</span><span class="op" id="1567504">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567508">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;to&nbsp;add&nbsp;finalizer&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567554">mp</span>&nbsp;<span class="op" id="1567557">:=</span>&nbsp;<span class="ident" id="1567560">acquirem</span><span class="op" id="1567568">(</span><span class="op" id="1567569">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567572">mp</span><span class="op" id="1567574">.</span><span class="ident" id="1567575">ptrarg</span><span class="op" id="1567581">[</span><span class="num" id="1567582">0</span><span class="op" id="1567583">]</span>&nbsp;<span class="op" id="1567585">=</span>&nbsp;<span class="ident" id="1567587">f</span><span class="op" id="1567588">.</span><span class="ident" id="1567589">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567595">mp</span><span class="op" id="1567597">.</span><span class="ident" id="1567598">ptrarg</span><span class="op" id="1567604">[</span><span class="num" id="1567605">1</span><span class="op" id="1567606">]</span>&nbsp;<span class="op" id="1567608">=</span>&nbsp;<span class="ident" id="1567610">e</span><span class="op" id="1567611">.</span><span class="ident" id="1567612">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567618">mp</span><span class="op" id="1567620">.</span><span class="ident" id="1567621">scalararg</span><span class="op" id="1567630">[</span><span class="num" id="1567631">0</span><span class="op" id="1567632">]</span>&nbsp;<span class="op" id="1567634">=</span>&nbsp;<span class="ident" id="1567636">nret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567642">mp</span><span class="op" id="1567644">.</span><span class="ident" id="1567645">ptrarg</span><span class="op" id="1567651">[</span><span class="num" id="1567652">2</span><span class="op" id="1567653">]</span>&nbsp;<span class="op" id="1567655">=</span>&nbsp;<span class="ident" id="1567657">unsafe</span><span class="op" id="1567663">.</span><span class="ident" id="1567664">Pointer</span><span class="op" id="1567671">(</span><span class="ident" id="1567672">fint</span><span class="op" id="1567676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567679">mp</span><span class="op" id="1567681">.</span><span class="ident" id="1567682">ptrarg</span><span class="op" id="1567688">[</span><span class="num" id="1567689">3</span><span class="op" id="1567690">]</span>&nbsp;<span class="op" id="1567692">=</span>&nbsp;<span class="ident" id="1567694">unsafe</span><span class="op" id="1567700">.</span><span class="ident" id="1567701">Pointer</span><span class="op" id="1567708">(</span><span class="ident" id="1567709">ot</span><span class="op" id="1567711">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567714">onM</span><span class="op" id="1567717">(</span><span class="ident" id="1567718">setFinalizer_m</span><span class="op" id="1567732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1567735">if</span>&nbsp;<span class="ident" id="1567738">mp</span><span class="op" id="1567740">.</span><span class="ident" id="1567741">scalararg</span><span class="op" id="1567750">[</span><span class="num" id="1567751">0</span><span class="op" id="1567752">]</span>&nbsp;<span class="op" id="1567754">!=</span>&nbsp;<span class="num" id="1567757">1</span>&nbsp;<span class="op" id="1567759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567763">gothrow</span><span class="op" id="1567770">(</span><span class="string" id="1567771">&#34;runtime.SetFinalizer:&nbsp;finalizer&nbsp;already&nbsp;set&#34;</span><span class="op" id="1567816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1567819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567822">releasem</span><span class="op" id="1567830">(</span><span class="ident" id="1567831">mp</span><span class="op" id="1567833">)</span><br>
<span class="lineno">655</span><span class="op" id="1567835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1567838">//&nbsp;round&nbsp;n&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;a.&nbsp;&nbsp;a&nbsp;must&nbsp;be&nbsp;a&nbsp;power&nbsp;of&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="1567897">func</span>&nbsp;<span class="ident" id="1567902">round</span><span class="op" id="1567907">(</span><span class="ident" id="1567908">n</span><span class="op" id="1567909">,</span>&nbsp;<span class="ident" id="1567911">a</span>&nbsp;<span class="builtintype" id="1567913">uintptr</span><span class="op" id="1567920">)</span>&nbsp;<span class="builtintype" id="1567922">uintptr</span>&nbsp;<span class="op" id="1567930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1567933">return</span>&nbsp;<span class="op" id="1567940">(</span><span class="ident" id="1567941">n</span>&nbsp;<span class="op" id="1567943">+</span>&nbsp;<span class="ident" id="1567945">a</span>&nbsp;<span class="op" id="1567947">-</span>&nbsp;<span class="num" id="1567949">1</span><span class="op" id="1567950">)</span>&nbsp;<span class="op" id="1567952">&amp;^</span>&nbsp;<span class="op" id="1567955">(</span><span class="ident" id="1567956">a</span>&nbsp;<span class="op" id="1567958">-</span>&nbsp;<span class="num" id="1567960">1</span><span class="op" id="1567961">)</span><br>
<span class="lineno">660</span><span class="op" id="1567963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1567966">//&nbsp;Look&nbsp;up&nbsp;pointer&nbsp;v&nbsp;in&nbsp;heap.&nbsp;&nbsp;Return&nbsp;the&nbsp;span&nbsp;containing&nbsp;the&nbsp;object,</span><br>
<span class="lineno"></span><span class="comment" id="1568036">//&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;object,&nbsp;and&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;If&nbsp;the&nbsp;object</span><br>
<span class="lineno"></span><span class="comment" id="1568107">//&nbsp;does&nbsp;not&nbsp;exist,&nbsp;return&nbsp;nil,&nbsp;nil,&nbsp;0.</span><br>
<span class="lineno">665</span><span class="keyword" id="1568146">func</span>&nbsp;<span class="ident" id="1568151">findObject</span><span class="op" id="1568161">(</span><span class="ident" id="1568162">v</span>&nbsp;<span class="ident" id="1568164">unsafe</span><span class="op" id="1568170">.</span><span class="ident" id="1568171">Pointer</span><span class="op" id="1568178">)</span>&nbsp;<span class="op" id="1568180">(</span><span class="ident" id="1568181">s</span>&nbsp;<span class="op" id="1568183">*</span><span class="ident" id="1568184">mspan</span><span class="op" id="1568189">,</span>&nbsp;<span class="ident" id="1568191">x</span>&nbsp;<span class="ident" id="1568193">unsafe</span><span class="op" id="1568199">.</span><span class="ident" id="1568200">Pointer</span><span class="op" id="1568207">,</span>&nbsp;<span class="ident" id="1568209">n</span>&nbsp;<span class="builtintype" id="1568211">uintptr</span><span class="op" id="1568218">)</span>&nbsp;<span class="op" id="1568220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568223">c</span>&nbsp;<span class="op" id="1568225">:=</span>&nbsp;<span class="ident" id="1568228">gomcache</span><span class="op" id="1568236">(</span><span class="op" id="1568237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568240">c</span><span class="op" id="1568241">.</span><span class="ident" id="1568242">local_nlookup</span><span class="op" id="1568255">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1568259">if</span>&nbsp;<span class="ident" id="1568262">ptrSize</span>&nbsp;<span class="op" id="1568270">==</span>&nbsp;<span class="num" id="1568273">4</span>&nbsp;<span class="op" id="1568275">&amp;&amp;</span>&nbsp;<span class="ident" id="1568278">c</span><span class="op" id="1568279">.</span><span class="ident" id="1568280">local_nlookup</span>&nbsp;<span class="op" id="1568294">&gt;=</span>&nbsp;<span class="num" id="1568297">1</span><span class="op" id="1568298">&lt;&lt;</span><span class="num" id="1568300">30</span>&nbsp;<span class="op" id="1568303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1568307">//&nbsp;purge&nbsp;cache&nbsp;stats&nbsp;to&nbsp;prevent&nbsp;overflow</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568350">lock</span><span class="op" id="1568354">(</span><span class="op" id="1568355">&amp;</span><span class="ident" id="1568356">mheap_</span><span class="op" id="1568362">.</span><span class="ident" id="1568363">lock</span><span class="op" id="1568367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568371">purgecachedstats</span><span class="op" id="1568387">(</span><span class="ident" id="1568388">c</span><span class="op" id="1568389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568393">unlock</span><span class="op" id="1568399">(</span><span class="op" id="1568400">&amp;</span><span class="ident" id="1568401">mheap_</span><span class="op" id="1568407">.</span><span class="ident" id="1568408">lock</span><span class="op" id="1568412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1568415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1568419">//&nbsp;find&nbsp;span</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568433">arena_start</span>&nbsp;<span class="op" id="1568445">:=</span>&nbsp;<span class="builtintype" id="1568448">uintptr</span><span class="op" id="1568455">(</span><span class="ident" id="1568456">unsafe</span><span class="op" id="1568462">.</span><span class="ident" id="1568463">Pointer</span><span class="op" id="1568470">(</span><span class="ident" id="1568471">mheap_</span><span class="op" id="1568477">.</span><span class="ident" id="1568478">arena_start</span><span class="op" id="1568489">)</span><span class="op" id="1568490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568493">arena_used</span>&nbsp;<span class="op" id="1568504">:=</span>&nbsp;<span class="builtintype" id="1568507">uintptr</span><span class="op" id="1568514">(</span><span class="ident" id="1568515">unsafe</span><span class="op" id="1568521">.</span><span class="ident" id="1568522">Pointer</span><span class="op" id="1568529">(</span><span class="ident" id="1568530">mheap_</span><span class="op" id="1568536">.</span><span class="ident" id="1568537">arena_used</span><span class="op" id="1568547">)</span><span class="op" id="1568548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1568551">if</span>&nbsp;<span class="builtintype" id="1568554">uintptr</span><span class="op" id="1568561">(</span><span class="ident" id="1568562">v</span><span class="op" id="1568563">)</span>&nbsp;<span class="op" id="1568565">&lt;</span>&nbsp;<span class="ident" id="1568567">arena_start</span>&nbsp;<span class="op" id="1568579">||</span>&nbsp;<span class="builtintype" id="1568582">uintptr</span><span class="op" id="1568589">(</span><span class="ident" id="1568590">v</span><span class="op" id="1568591">)</span>&nbsp;<span class="op" id="1568593">&gt;=</span>&nbsp;<span class="ident" id="1568596">arena_used</span>&nbsp;<span class="op" id="1568607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1568611">return</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1568619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568622">p</span>&nbsp;<span class="op" id="1568624">:=</span>&nbsp;<span class="builtintype" id="1568627">uintptr</span><span class="op" id="1568634">(</span><span class="ident" id="1568635">v</span><span class="op" id="1568636">)</span>&nbsp;<span class="op" id="1568638">&gt;&gt;</span>&nbsp;<span class="ident" id="1568641">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568652">q</span>&nbsp;<span class="op" id="1568654">:=</span>&nbsp;<span class="ident" id="1568657">p</span>&nbsp;<span class="op" id="1568659">-</span>&nbsp;<span class="ident" id="1568661">arena_start</span><span class="op" id="1568672">&gt;&gt;</span><span class="ident" id="1568674">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568685">s</span>&nbsp;<span class="op" id="1568687">=</span>&nbsp;<span class="op" id="1568689">*</span><span class="op" id="1568690">(</span><span class="op" id="1568691">*</span><span class="op" id="1568692">*</span><span class="ident" id="1568693">mspan</span><span class="op" id="1568698">)</span><span class="op" id="1568699">(</span><span class="ident" id="1568700">add</span><span class="op" id="1568703">(</span><span class="ident" id="1568704">unsafe</span><span class="op" id="1568710">.</span><span class="ident" id="1568711">Pointer</span><span class="op" id="1568718">(</span><span class="ident" id="1568719">mheap_</span><span class="op" id="1568725">.</span><span class="ident" id="1568726">spans</span><span class="op" id="1568731">)</span><span class="op" id="1568732">,</span>&nbsp;<span class="ident" id="1568734">q</span><span class="op" id="1568735">*</span><span class="ident" id="1568736">ptrSize</span><span class="op" id="1568743">)</span><span class="op" id="1568744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1568747">if</span>&nbsp;<span class="ident" id="1568750">s</span>&nbsp;<span class="op" id="1568752">==</span>&nbsp;<span class="builtintype" id="1568755">nil</span>&nbsp;<span class="op" id="1568759">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1568763">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1568771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568774">x</span>&nbsp;<span class="op" id="1568776">=</span>&nbsp;<span class="ident" id="1568778">unsafe</span><span class="op" id="1568784">.</span><span class="ident" id="1568785">Pointer</span><span class="op" id="1568792">(</span><span class="builtintype" id="1568793">uintptr</span><span class="op" id="1568800">(</span><span class="ident" id="1568801">s</span><span class="op" id="1568802">.</span><span class="ident" id="1568803">start</span><span class="op" id="1568808">)</span>&nbsp;<span class="op" id="1568810">&lt;&lt;</span>&nbsp;<span class="ident" id="1568813">pageShift</span><span class="op" id="1568822">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1568826">if</span>&nbsp;<span class="builtintype" id="1568829">uintptr</span><span class="op" id="1568836">(</span><span class="ident" id="1568837">v</span><span class="op" id="1568838">)</span>&nbsp;<span class="op" id="1568840">&lt;</span>&nbsp;<span class="builtintype" id="1568842">uintptr</span><span class="op" id="1568849">(</span><span class="ident" id="1568850">x</span><span class="op" id="1568851">)</span>&nbsp;<span class="op" id="1568853">||</span>&nbsp;<span class="builtintype" id="1568856">uintptr</span><span class="op" id="1568863">(</span><span class="ident" id="1568864">v</span><span class="op" id="1568865">)</span>&nbsp;<span class="op" id="1568867">&gt;=</span>&nbsp;<span class="builtintype" id="1568870">uintptr</span><span class="op" id="1568877">(</span><span class="ident" id="1568878">unsafe</span><span class="op" id="1568884">.</span><span class="ident" id="1568885">Pointer</span><span class="op" id="1568892">(</span><span class="ident" id="1568893">s</span><span class="op" id="1568894">.</span><span class="ident" id="1568895">limit</span><span class="op" id="1568900">)</span><span class="op" id="1568901">)</span>&nbsp;<span class="op" id="1568903">||</span>&nbsp;<span class="ident" id="1568906">s</span><span class="op" id="1568907">.</span><span class="ident" id="1568908">state</span>&nbsp;<span class="op" id="1568914">!=</span>&nbsp;<span class="ident" id="1568917">mSpanInUse</span>&nbsp;<span class="op" id="1568928">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568932">s</span>&nbsp;<span class="op" id="1568934">=</span>&nbsp;<span class="builtintype" id="1568936">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568942">x</span>&nbsp;<span class="op" id="1568944">=</span>&nbsp;<span class="builtintype" id="1568946">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1568952">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1568960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568964">n</span>&nbsp;<span class="op" id="1568966">=</span>&nbsp;<span class="builtintype" id="1568968">uintptr</span><span class="op" id="1568975">(</span><span class="ident" id="1568976">s</span><span class="op" id="1568977">.</span><span class="ident" id="1568978">elemsize</span><span class="op" id="1568986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1568989">if</span>&nbsp;<span class="ident" id="1568992">s</span><span class="op" id="1568993">.</span><span class="ident" id="1568994">sizeclass</span>&nbsp;<span class="op" id="1569004">!=</span>&nbsp;<span class="num" id="1569007">0</span>&nbsp;<span class="op" id="1569009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569013">x</span>&nbsp;<span class="op" id="1569015">=</span>&nbsp;<span class="ident" id="1569017">add</span><span class="op" id="1569020">(</span><span class="ident" id="1569021">x</span><span class="op" id="1569022">,</span>&nbsp;<span class="op" id="1569024">(</span><span class="builtintype" id="1569025">uintptr</span><span class="op" id="1569032">(</span><span class="ident" id="1569033">v</span><span class="op" id="1569034">)</span><span class="op" id="1569035">-</span><span class="builtintype" id="1569036">uintptr</span><span class="op" id="1569043">(</span><span class="ident" id="1569044">x</span><span class="op" id="1569045">)</span><span class="op" id="1569046">)</span><span class="op" id="1569047">/</span><span class="ident" id="1569048">n</span><span class="op" id="1569049">*</span><span class="ident" id="1569050">n</span><span class="op" id="1569051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1569054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569057">return</span><br>
<span class="lineno">700</span><span class="op" id="1569064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1569067">var</span>&nbsp;<span class="ident" id="1569071">fingCreate</span>&nbsp;<span class="builtintype" id="1569082">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1569090">func</span>&nbsp;<span class="ident" id="1569095">createfing</span><span class="op" id="1569105">(</span><span class="op" id="1569106">)</span>&nbsp;<span class="op" id="1569108">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1569111">//&nbsp;start&nbsp;the&nbsp;finalizer&nbsp;goroutine&nbsp;exactly&nbsp;once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569158">if</span>&nbsp;<span class="ident" id="1569161">fingCreate</span>&nbsp;<span class="op" id="1569172">==</span>&nbsp;<span class="num" id="1569175">0</span>&nbsp;<span class="op" id="1569177">&amp;&amp;</span>&nbsp;<span class="ident" id="1569180">cas</span><span class="op" id="1569183">(</span><span class="op" id="1569184">&amp;</span><span class="ident" id="1569185">fingCreate</span><span class="op" id="1569195">,</span>&nbsp;<span class="num" id="1569197">0</span><span class="op" id="1569198">,</span>&nbsp;<span class="num" id="1569200">1</span><span class="op" id="1569201">)</span>&nbsp;<span class="op" id="1569203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569207">go</span>&nbsp;<span class="ident" id="1569210">runfinq</span><span class="op" id="1569217">(</span><span class="op" id="1569218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1569221">}</span><br>
<span class="lineno"></span><span class="op" id="1569223">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="1569226">//&nbsp;This&nbsp;is&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;runs&nbsp;all&nbsp;of&nbsp;the&nbsp;finalizers</span><br>
<span class="lineno"></span><span class="keyword" id="1569283">func</span>&nbsp;<span class="ident" id="1569288">runfinq</span><span class="op" id="1569295">(</span><span class="op" id="1569296">)</span>&nbsp;<span class="op" id="1569298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569301">var</span>&nbsp;<span class="op" id="1569305">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569309">frame</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569318">unsafe</span><span class="op" id="1569324">.</span><span class="ident" id="1569325">Pointer</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569335">framecap</span>&nbsp;<span class="builtintype" id="1569344">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1569353">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569357">for</span>&nbsp;<span class="op" id="1569361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569365">lock</span><span class="op" id="1569369">(</span><span class="op" id="1569370">&amp;</span><span class="ident" id="1569371">finlock</span><span class="op" id="1569378">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569382">fb</span>&nbsp;<span class="op" id="1569385">:=</span>&nbsp;<span class="ident" id="1569388">finq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569395">finq</span>&nbsp;<span class="op" id="1569400">=</span>&nbsp;<span class="builtintype" id="1569402">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569408">if</span>&nbsp;<span class="ident" id="1569411">fb</span>&nbsp;<span class="op" id="1569414">==</span>&nbsp;<span class="builtintype" id="1569417">nil</span>&nbsp;<span class="op" id="1569421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569426">gp</span>&nbsp;<span class="op" id="1569429">:=</span>&nbsp;<span class="ident" id="1569432">getg</span><span class="op" id="1569436">(</span><span class="op" id="1569437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569442">fing</span>&nbsp;<span class="op" id="1569447">=</span>&nbsp;<span class="ident" id="1569449">gp</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569455">fingwait</span>&nbsp;<span class="op" id="1569464">=</span>&nbsp;<span class="builtintype" id="1569466">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569474">gp</span><span class="op" id="1569476">.</span><span class="ident" id="1569477">issystem</span>&nbsp;<span class="op" id="1569486">=</span>&nbsp;<span class="builtintype" id="1569488">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569496">goparkunlock</span><span class="op" id="1569508">(</span><span class="op" id="1569509">&amp;</span><span class="ident" id="1569510">finlock</span><span class="op" id="1569517">,</span>&nbsp;<span class="string" id="1569519">&#34;finalizer&nbsp;wait&#34;</span><span class="op" id="1569535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569540">gp</span><span class="op" id="1569542">.</span><span class="ident" id="1569543">issystem</span>&nbsp;<span class="op" id="1569552">=</span>&nbsp;<span class="builtintype" id="1569554">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569563">continue</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1569574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569578">unlock</span><span class="op" id="1569584">(</span><span class="op" id="1569585">&amp;</span><span class="ident" id="1569586">finlock</span><span class="op" id="1569593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569597">if</span>&nbsp;<span class="ident" id="1569600">raceenabled</span>&nbsp;<span class="op" id="1569612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569617">racefingo</span><span class="op" id="1569626">(</span><span class="op" id="1569627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1569631">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569635">for</span>&nbsp;<span class="ident" id="1569639">fb</span>&nbsp;<span class="op" id="1569642">!=</span>&nbsp;<span class="builtintype" id="1569645">nil</span>&nbsp;<span class="op" id="1569649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569654">for</span>&nbsp;<span class="ident" id="1569658">i</span>&nbsp;<span class="op" id="1569660">:=</span>&nbsp;<span class="builtintype" id="1569663">int32</span><span class="op" id="1569668">(</span><span class="num" id="1569669">0</span><span class="op" id="1569670">)</span><span class="op" id="1569671">;</span>&nbsp;<span class="ident" id="1569673">i</span>&nbsp;<span class="op" id="1569675">&lt;</span>&nbsp;<span class="ident" id="1569677">fb</span><span class="op" id="1569679">.</span><span class="ident" id="1569680">cnt</span><span class="op" id="1569683">;</span>&nbsp;<span class="ident" id="1569685">i</span><span class="op" id="1569686">++</span>&nbsp;<span class="op" id="1569689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569695">f</span>&nbsp;<span class="op" id="1569697">:=</span>&nbsp;<span class="op" id="1569700">(</span><span class="op" id="1569701">*</span><span class="ident" id="1569702">finalizer</span><span class="op" id="1569711">)</span><span class="op" id="1569712">(</span><span class="ident" id="1569713">add</span><span class="op" id="1569716">(</span><span class="ident" id="1569717">unsafe</span><span class="op" id="1569723">.</span><span class="ident" id="1569724">Pointer</span><span class="op" id="1569731">(</span><span class="op" id="1569732">&amp;</span><span class="ident" id="1569733">fb</span><span class="op" id="1569735">.</span><span class="ident" id="1569736">fin</span><span class="op" id="1569739">)</span><span class="op" id="1569740">,</span>&nbsp;<span class="builtintype" id="1569742">uintptr</span><span class="op" id="1569749">(</span><span class="ident" id="1569750">i</span><span class="op" id="1569751">)</span><span class="op" id="1569752">*</span><span class="ident" id="1569753">unsafe</span><span class="op" id="1569759">.</span><span class="ident" id="1569760">Sizeof</span><span class="op" id="1569766">(</span><span class="ident" id="1569767">finalizer</span><span class="op" id="1569776">{</span><span class="op" id="1569777">}</span><span class="op" id="1569778">)</span><span class="op" id="1569779">)</span><span class="op" id="1569780">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569787">framesz</span>&nbsp;<span class="op" id="1569795">:=</span>&nbsp;<span class="ident" id="1569798">unsafe</span><span class="op" id="1569804">.</span><span class="ident" id="1569805">Sizeof</span><span class="op" id="1569811">(</span><span class="op" id="1569812">(</span><span class="keyword" id="1569813">interface</span><span class="op" id="1569822">{</span><span class="op" id="1569823">}</span><span class="op" id="1569824">)</span><span class="op" id="1569825">(</span><span class="builtintype" id="1569826">nil</span><span class="op" id="1569829">)</span><span class="op" id="1569830">)</span>&nbsp;<span class="op" id="1569832">+</span>&nbsp;<span class="builtintype" id="1569834">uintptr</span><span class="op" id="1569841">(</span><span class="ident" id="1569842">f</span><span class="op" id="1569843">.</span><span class="ident" id="1569844">nret</span><span class="op" id="1569848">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569854">if</span>&nbsp;<span class="ident" id="1569857">framecap</span>&nbsp;<span class="op" id="1569866">&lt;</span>&nbsp;<span class="ident" id="1569868">framesz</span>&nbsp;<span class="op" id="1569876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1569883">//&nbsp;The&nbsp;frame&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1569947">//&nbsp;all&nbsp;not&nbsp;yet&nbsp;finalized&nbsp;objects&nbsp;are&nbsp;stored&nbsp;in&nbsp;finq.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570005">//&nbsp;If&nbsp;we&nbsp;do&nbsp;not&nbsp;mark&nbsp;it&nbsp;as&nbsp;FlagNoScan,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570049">//&nbsp;the&nbsp;last&nbsp;finalized&nbsp;object&nbsp;is&nbsp;not&nbsp;collected.</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570101">frame</span>&nbsp;<span class="op" id="1570107">=</span>&nbsp;<span class="ident" id="1570109">mallocgc</span><span class="op" id="1570117">(</span><span class="ident" id="1570118">framesz</span><span class="op" id="1570125">,</span>&nbsp;<span class="builtintype" id="1570127">nil</span><span class="op" id="1570130">,</span>&nbsp;<span class="ident" id="1570132">flagNoScan</span><span class="op" id="1570142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570149">framecap</span>&nbsp;<span class="op" id="1570158">=</span>&nbsp;<span class="ident" id="1570160">framesz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570179">if</span>&nbsp;<span class="ident" id="1570182">f</span><span class="op" id="1570183">.</span><span class="ident" id="1570184">fint</span>&nbsp;<span class="op" id="1570189">==</span>&nbsp;<span class="builtintype" id="1570192">nil</span>&nbsp;<span class="op" id="1570196">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570203">gothrow</span><span class="op" id="1570210">(</span><span class="string" id="1570211">&#34;missing&nbsp;type&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1570236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570248">switch</span>&nbsp;<span class="ident" id="1570255">f</span><span class="op" id="1570256">.</span><span class="ident" id="1570257">fint</span><span class="op" id="1570261">.</span><span class="ident" id="1570262">kind</span>&nbsp;<span class="op" id="1570267">&amp;</span>&nbsp;<span class="ident" id="1570269">kindMask</span>&nbsp;<span class="op" id="1570278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570284">case</span>&nbsp;<span class="ident" id="1570289">kindPtr</span><span class="op" id="1570296">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570303">//&nbsp;direct&nbsp;use&nbsp;of&nbsp;pointer</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570333">*</span><span class="op" id="1570334">(</span><span class="op" id="1570335">*</span><span class="ident" id="1570336">unsafe</span><span class="op" id="1570342">.</span><span class="ident" id="1570343">Pointer</span><span class="op" id="1570350">)</span><span class="op" id="1570351">(</span><span class="ident" id="1570352">frame</span><span class="op" id="1570357">)</span>&nbsp;<span class="op" id="1570359">=</span>&nbsp;<span class="ident" id="1570361">f</span><span class="op" id="1570362">.</span><span class="ident" id="1570363">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570371">case</span>&nbsp;<span class="ident" id="1570376">kindInterface</span><span class="op" id="1570389">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570396">ityp</span>&nbsp;<span class="op" id="1570401">:=</span>&nbsp;<span class="op" id="1570404">(</span><span class="op" id="1570405">*</span><span class="ident" id="1570406">interfacetype</span><span class="op" id="1570419">)</span><span class="op" id="1570420">(</span><span class="ident" id="1570421">unsafe</span><span class="op" id="1570427">.</span><span class="ident" id="1570428">Pointer</span><span class="op" id="1570435">(</span><span class="ident" id="1570436">f</span><span class="op" id="1570437">.</span><span class="ident" id="1570438">fint</span><span class="op" id="1570442">)</span><span class="op" id="1570443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570450">//&nbsp;set&nbsp;up&nbsp;with&nbsp;empty&nbsp;interface</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570486">(</span><span class="op" id="1570487">*</span><span class="ident" id="1570488">eface</span><span class="op" id="1570493">)</span><span class="op" id="1570494">(</span><span class="ident" id="1570495">frame</span><span class="op" id="1570500">)</span><span class="op" id="1570501">.</span><span class="ident" id="1570502">_type</span>&nbsp;<span class="op" id="1570508">=</span>&nbsp;<span class="op" id="1570510">&amp;</span><span class="ident" id="1570511">f</span><span class="op" id="1570512">.</span><span class="ident" id="1570513">ot</span><span class="op" id="1570515">.</span><span class="ident" id="1570516">typ</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570525">(</span><span class="op" id="1570526">*</span><span class="ident" id="1570527">eface</span><span class="op" id="1570532">)</span><span class="op" id="1570533">(</span><span class="ident" id="1570534">frame</span><span class="op" id="1570539">)</span><span class="op" id="1570540">.</span><span class="ident" id="1570541">data</span>&nbsp;<span class="op" id="1570546">=</span>&nbsp;<span class="ident" id="1570548">f</span><span class="op" id="1570549">.</span><span class="ident" id="1570550">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570559">if</span>&nbsp;<span class="builtinfunc" id="1570562">len</span><span class="op" id="1570565">(</span><span class="ident" id="1570566">ityp</span><span class="op" id="1570570">.</span><span class="ident" id="1570571">mhdr</span><span class="op" id="1570575">)</span>&nbsp;<span class="op" id="1570577">!=</span>&nbsp;<span class="num" id="1570580">0</span>&nbsp;<span class="op" id="1570582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570590">//&nbsp;convert&nbsp;to&nbsp;interface&nbsp;with&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570633">//&nbsp;this&nbsp;conversion&nbsp;is&nbsp;guaranteed&nbsp;to&nbsp;succeed&nbsp;-&nbsp;we&nbsp;checked&nbsp;in&nbsp;SetFinalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570712">*</span><span class="op" id="1570713">(</span><span class="op" id="1570714">*</span><span class="ident" id="1570715">fInterface</span><span class="op" id="1570725">)</span><span class="op" id="1570726">(</span><span class="ident" id="1570727">frame</span><span class="op" id="1570732">)</span>&nbsp;<span class="op" id="1570734">=</span>&nbsp;<span class="ident" id="1570736">assertE2I</span><span class="op" id="1570745">(</span><span class="ident" id="1570746">ityp</span><span class="op" id="1570750">,</span>&nbsp;<span class="op" id="1570752">*</span><span class="op" id="1570753">(</span><span class="op" id="1570754">*</span><span class="keyword" id="1570755">interface</span><span class="op" id="1570764">{</span><span class="op" id="1570765">}</span><span class="op" id="1570766">)</span><span class="op" id="1570767">(</span><span class="ident" id="1570768">frame</span><span class="op" id="1570773">)</span><span class="op" id="1570774">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570787">default</span><span class="op" id="1570794">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570801">gothrow</span><span class="op" id="1570808">(</span><span class="string" id="1570809">&#34;bad&nbsp;kind&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1570830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570842">reflectcall</span><span class="op" id="1570853">(</span><span class="ident" id="1570854">unsafe</span><span class="op" id="1570860">.</span><span class="ident" id="1570861">Pointer</span><span class="op" id="1570868">(</span><span class="ident" id="1570869">f</span><span class="op" id="1570870">.</span><span class="ident" id="1570871">fn</span><span class="op" id="1570873">)</span><span class="op" id="1570874">,</span>&nbsp;<span class="ident" id="1570876">frame</span><span class="op" id="1570881">,</span>&nbsp;<span class="builtintype" id="1570883">uint32</span><span class="op" id="1570889">(</span><span class="ident" id="1570890">framesz</span><span class="op" id="1570897">)</span><span class="op" id="1570898">,</span>&nbsp;<span class="builtintype" id="1570900">uint32</span><span class="op" id="1570906">(</span><span class="ident" id="1570907">framesz</span><span class="op" id="1570914">)</span><span class="op" id="1570915">)</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570922">//&nbsp;drop&nbsp;finalizer&nbsp;queue&nbsp;references&nbsp;to&nbsp;finalized&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570981">f</span><span class="op" id="1570982">.</span><span class="ident" id="1570983">fn</span>&nbsp;<span class="op" id="1570986">=</span>&nbsp;<span class="builtintype" id="1570988">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570996">f</span><span class="op" id="1570997">.</span><span class="ident" id="1570998">arg</span>&nbsp;<span class="op" id="1571002">=</span>&nbsp;<span class="builtintype" id="1571004">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571012">f</span><span class="op" id="1571013">.</span><span class="ident" id="1571014">ot</span>&nbsp;<span class="op" id="1571017">=</span>&nbsp;<span class="builtintype" id="1571019">nil</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571031">fb</span><span class="op" id="1571033">.</span><span class="ident" id="1571034">cnt</span>&nbsp;<span class="op" id="1571038">=</span>&nbsp;<span class="num" id="1571040">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571045">next</span>&nbsp;<span class="op" id="1571050">:=</span>&nbsp;<span class="ident" id="1571053">fb</span><span class="op" id="1571055">.</span><span class="ident" id="1571056">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571064">lock</span><span class="op" id="1571068">(</span><span class="op" id="1571069">&amp;</span><span class="ident" id="1571070">finlock</span><span class="op" id="1571077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571082">fb</span><span class="op" id="1571084">.</span><span class="ident" id="1571085">next</span>&nbsp;<span class="op" id="1571090">=</span>&nbsp;<span class="ident" id="1571092">finc</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571100">finc</span>&nbsp;<span class="op" id="1571105">=</span>&nbsp;<span class="ident" id="1571107">fb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571113">unlock</span><span class="op" id="1571119">(</span><span class="op" id="1571120">&amp;</span><span class="ident" id="1571121">finlock</span><span class="op" id="1571128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571133">fb</span>&nbsp;<span class="op" id="1571136">=</span>&nbsp;<span class="ident" id="1571138">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571148">}</span><br>
<span class="lineno">785</span><span class="op" id="1571150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1571153">var</span>&nbsp;<span class="ident" id="1571157">persistent</span>&nbsp;<span class="keyword" id="1571168">struct</span>&nbsp;<span class="op" id="1571175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571178">lock</span>&nbsp;<span class="ident" id="1571183">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571190">pos</span>&nbsp;&nbsp;<span class="ident" id="1571195">unsafe</span><span class="op" id="1571201">.</span><span class="ident" id="1571202">Pointer</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571211">end</span>&nbsp;&nbsp;<span class="ident" id="1571216">unsafe</span><span class="op" id="1571222">.</span><span class="ident" id="1571223">Pointer</span><br>
<span class="lineno"></span><span class="op" id="1571231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1571234">//&nbsp;Wrapper&nbsp;around&nbsp;sysAlloc&nbsp;that&nbsp;can&nbsp;allocate&nbsp;small&nbsp;chunks.</span><br>
<span class="lineno"></span><span class="comment" id="1571293">//&nbsp;There&nbsp;is&nbsp;no&nbsp;associated&nbsp;free&nbsp;operation.</span><br>
<span class="lineno">795</span><span class="comment" id="1571335">//&nbsp;Intended&nbsp;for&nbsp;things&nbsp;like&nbsp;function/type/debug-related&nbsp;persistent&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1571408">//&nbsp;If&nbsp;align&nbsp;is&nbsp;0,&nbsp;uses&nbsp;default&nbsp;align&nbsp;(currently&nbsp;8).</span><br>
<span class="lineno"></span><span class="keyword" id="1571460">func</span>&nbsp;<span class="ident" id="1571465">persistentalloc</span><span class="op" id="1571480">(</span><span class="ident" id="1571481">size</span><span class="op" id="1571485">,</span>&nbsp;<span class="ident" id="1571487">align</span>&nbsp;<span class="builtintype" id="1571493">uintptr</span><span class="op" id="1571500">,</span>&nbsp;<span class="ident" id="1571502">stat</span>&nbsp;<span class="op" id="1571507">*</span><span class="ident" id="1571508">uint64</span><span class="op" id="1571514">)</span>&nbsp;<span class="ident" id="1571516">unsafe</span><span class="op" id="1571522">.</span><span class="ident" id="1571523">Pointer</span>&nbsp;<span class="op" id="1571531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571534">const</span>&nbsp;<span class="op" id="1571540">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571544">chunk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571553">=</span>&nbsp;<span class="num" id="1571555">256</span>&nbsp;<span class="op" id="1571559">&lt;&lt;</span>&nbsp;<span class="num" id="1571562">10</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571567">maxBlock</span>&nbsp;<span class="op" id="1571576">=</span>&nbsp;<span class="num" id="1571578">64</span>&nbsp;<span class="op" id="1571581">&lt;&lt;</span>&nbsp;<span class="num" id="1571584">10</span>&nbsp;<span class="comment" id="1571587">//&nbsp;VM&nbsp;reservation&nbsp;granularity&nbsp;is&nbsp;64K&nbsp;on&nbsp;windows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571636">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571640">if</span>&nbsp;<span class="ident" id="1571643">align</span>&nbsp;<span class="op" id="1571649">!=</span>&nbsp;<span class="num" id="1571652">0</span>&nbsp;<span class="op" id="1571654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571658">if</span>&nbsp;<span class="ident" id="1571661">align</span><span class="op" id="1571666">&amp;</span><span class="op" id="1571667">(</span><span class="ident" id="1571668">align</span><span class="op" id="1571673">-</span><span class="num" id="1571674">1</span><span class="op" id="1571675">)</span>&nbsp;<span class="op" id="1571677">!=</span>&nbsp;<span class="num" id="1571680">0</span>&nbsp;<span class="op" id="1571682">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571687">gothrow</span><span class="op" id="1571694">(</span><span class="string" id="1571695">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;not&nbsp;a&nbsp;power&nbsp;of&nbsp;2&#34;</span><span class="op" id="1571739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571747">if</span>&nbsp;<span class="ident" id="1571750">align</span>&nbsp;<span class="op" id="1571756">&gt;</span>&nbsp;<span class="ident" id="1571758">_PageSize</span>&nbsp;<span class="op" id="1571768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571773">gothrow</span><span class="op" id="1571780">(</span><span class="string" id="1571781">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;too&nbsp;large&#34;</span><span class="op" id="1571818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571822">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571825">}</span>&nbsp;<span class="keyword" id="1571827">else</span>&nbsp;<span class="op" id="1571832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571836">align</span>&nbsp;<span class="op" id="1571842">=</span>&nbsp;<span class="num" id="1571844">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571851">if</span>&nbsp;<span class="ident" id="1571854">size</span>&nbsp;<span class="op" id="1571859">&gt;=</span>&nbsp;<span class="ident" id="1571862">maxBlock</span>&nbsp;<span class="op" id="1571871">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571875">return</span>&nbsp;<span class="ident" id="1571882">sysAlloc</span><span class="op" id="1571890">(</span><span class="ident" id="1571891">size</span><span class="op" id="1571895">,</span>&nbsp;<span class="ident" id="1571897">stat</span><span class="op" id="1571901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571908">lock</span><span class="op" id="1571912">(</span><span class="op" id="1571913">&amp;</span><span class="ident" id="1571914">persistent</span><span class="op" id="1571924">.</span><span class="ident" id="1571925">lock</span><span class="op" id="1571929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571932">persistent</span><span class="op" id="1571942">.</span><span class="ident" id="1571943">pos</span>&nbsp;<span class="op" id="1571947">=</span>&nbsp;<span class="ident" id="1571949">roundup</span><span class="op" id="1571956">(</span><span class="ident" id="1571957">persistent</span><span class="op" id="1571967">.</span><span class="ident" id="1571968">pos</span><span class="op" id="1571971">,</span>&nbsp;<span class="ident" id="1571973">align</span><span class="op" id="1571978">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571981">if</span>&nbsp;<span class="builtintype" id="1571984">uintptr</span><span class="op" id="1571991">(</span><span class="ident" id="1571992">persistent</span><span class="op" id="1572002">.</span><span class="ident" id="1572003">pos</span><span class="op" id="1572006">)</span><span class="op" id="1572007">+</span><span class="ident" id="1572008">size</span>&nbsp;<span class="op" id="1572013">&gt;</span>&nbsp;<span class="builtintype" id="1572015">uintptr</span><span class="op" id="1572022">(</span><span class="ident" id="1572023">persistent</span><span class="op" id="1572033">.</span><span class="ident" id="1572034">end</span><span class="op" id="1572037">)</span>&nbsp;<span class="op" id="1572039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572043">persistent</span><span class="op" id="1572053">.</span><span class="ident" id="1572054">pos</span>&nbsp;<span class="op" id="1572058">=</span>&nbsp;<span class="ident" id="1572060">sysAlloc</span><span class="op" id="1572068">(</span><span class="ident" id="1572069">chunk</span><span class="op" id="1572074">,</span>&nbsp;<span class="op" id="1572076">&amp;</span><span class="ident" id="1572077">memstats</span><span class="op" id="1572085">.</span><span class="ident" id="1572086">other_sys</span><span class="op" id="1572095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572099">if</span>&nbsp;<span class="ident" id="1572102">persistent</span><span class="op" id="1572112">.</span><span class="ident" id="1572113">pos</span>&nbsp;<span class="op" id="1572117">==</span>&nbsp;<span class="builtintype" id="1572120">nil</span>&nbsp;<span class="op" id="1572124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572129">unlock</span><span class="op" id="1572135">(</span><span class="op" id="1572136">&amp;</span><span class="ident" id="1572137">persistent</span><span class="op" id="1572147">.</span><span class="ident" id="1572148">lock</span><span class="op" id="1572152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572157">gothrow</span><span class="op" id="1572164">(</span><span class="string" id="1572165">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1572198">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572206">persistent</span><span class="op" id="1572216">.</span><span class="ident" id="1572217">end</span>&nbsp;<span class="op" id="1572221">=</span>&nbsp;<span class="ident" id="1572223">add</span><span class="op" id="1572226">(</span><span class="ident" id="1572227">persistent</span><span class="op" id="1572237">.</span><span class="ident" id="1572238">pos</span><span class="op" id="1572241">,</span>&nbsp;<span class="ident" id="1572243">chunk</span><span class="op" id="1572248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572254">p</span>&nbsp;<span class="op" id="1572256">:=</span>&nbsp;<span class="ident" id="1572259">persistent</span><span class="op" id="1572269">.</span><span class="ident" id="1572270">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572275">persistent</span><span class="op" id="1572285">.</span><span class="ident" id="1572286">pos</span>&nbsp;<span class="op" id="1572290">=</span>&nbsp;<span class="ident" id="1572292">add</span><span class="op" id="1572295">(</span><span class="ident" id="1572296">persistent</span><span class="op" id="1572306">.</span><span class="ident" id="1572307">pos</span><span class="op" id="1572310">,</span>&nbsp;<span class="ident" id="1572312">size</span><span class="op" id="1572316">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572319">unlock</span><span class="op" id="1572325">(</span><span class="op" id="1572326">&amp;</span><span class="ident" id="1572327">persistent</span><span class="op" id="1572337">.</span><span class="ident" id="1572338">lock</span><span class="op" id="1572342">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572346">if</span>&nbsp;<span class="ident" id="1572349">stat</span>&nbsp;<span class="op" id="1572354">!=</span>&nbsp;<span class="op" id="1572357">&amp;</span><span class="ident" id="1572358">memstats</span><span class="op" id="1572366">.</span><span class="ident" id="1572367">other_sys</span>&nbsp;<span class="op" id="1572377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572381">xadd64</span><span class="op" id="1572387">(</span><span class="ident" id="1572388">stat</span><span class="op" id="1572392">,</span>&nbsp;<span class="ident" id="1572394">int64</span><span class="op" id="1572399">(</span><span class="ident" id="1572400">size</span><span class="op" id="1572404">)</span><span class="op" id="1572405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572409">xadd64</span><span class="op" id="1572415">(</span><span class="op" id="1572416">&amp;</span><span class="ident" id="1572417">memstats</span><span class="op" id="1572425">.</span><span class="ident" id="1572426">other_sys</span><span class="op" id="1572435">,</span>&nbsp;<span class="op" id="1572437">-</span><span class="ident" id="1572438">int64</span><span class="op" id="1572443">(</span><span class="ident" id="1572444">size</span><span class="op" id="1572448">)</span><span class="op" id="1572449">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572455">return</span>&nbsp;<span class="ident" id="1572462">p</span><br>
<span class="lineno"></span><span class="op" id="1572464">}</span>
</div>
</body>
</html>
