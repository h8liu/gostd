<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html" class="current">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6331951">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6332006">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6332060">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6332111">package</span>&nbsp;<span class="ident" id="6332119">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6332129">import</span>&nbsp;<span class="op" id="6332136">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6332139">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6332148">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6332157">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6332167">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6332174">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6332180">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6332193">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6332200">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6332212">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6332223">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6332234">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6332241">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="6332244">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="6332317">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="6332396">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6332473">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="6332492">func</span>&nbsp;<span class="ident" id="6332497">drainBody</span><span class="op" id="6332506">(</span><span class="ident" id="6332507">b</span>&nbsp;<span class="ident" id="6332509">io</span><span class="op" id="6332511">.</span><span class="ident" id="6332512">ReadCloser</span><span class="op" id="6332522">)</span>&nbsp;<span class="op" id="6332524">(</span><span class="ident" id="6332525">r1</span><span class="op" id="6332527">,</span>&nbsp;<span class="ident" id="6332529">r2</span>&nbsp;<span class="ident" id="6332532">io</span><span class="op" id="6332534">.</span><span class="ident" id="6332535">ReadCloser</span><span class="op" id="6332545">,</span>&nbsp;<span class="ident" id="6332547">err</span>&nbsp;<span class="builtintype" id="6332551">error</span><span class="op" id="6332556">)</span>&nbsp;<span class="op" id="6332558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332561">var</span>&nbsp;<span class="ident" id="6332565">buf</span>&nbsp;<span class="ident" id="6332569">bytes</span><span class="op" id="6332574">.</span><span class="ident" id="6332575">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332583">if</span>&nbsp;<span class="ident" id="6332586">_</span><span class="op" id="6332587">,</span>&nbsp;<span class="ident" id="6332589">err</span>&nbsp;<span class="op" id="6332593">=</span>&nbsp;<span class="ident" id="6332595">buf</span><span class="op" id="6332598">.</span><span class="ident" id="6332599">ReadFrom</span><span class="op" id="6332607">(</span><span class="ident" id="6332608">b</span><span class="op" id="6332609">)</span><span class="op" id="6332610">;</span>&nbsp;<span class="ident" id="6332612">err</span>&nbsp;<span class="op" id="6332616">!=</span>&nbsp;<span class="ident" id="6332619">nil</span>&nbsp;<span class="op" id="6332623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332627">return</span>&nbsp;<span class="ident" id="6332634">nil</span><span class="op" id="6332637">,</span>&nbsp;<span class="ident" id="6332639">nil</span><span class="op" id="6332642">,</span>&nbsp;<span class="ident" id="6332644">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6332649">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332652">if</span>&nbsp;<span class="ident" id="6332655">err</span>&nbsp;<span class="op" id="6332659">=</span>&nbsp;<span class="ident" id="6332661">b</span><span class="op" id="6332662">.</span><span class="ident" id="6332663">Close</span><span class="op" id="6332668">(</span><span class="op" id="6332669">)</span><span class="op" id="6332670">;</span>&nbsp;<span class="ident" id="6332672">err</span>&nbsp;<span class="op" id="6332676">!=</span>&nbsp;<span class="ident" id="6332679">nil</span>&nbsp;<span class="op" id="6332683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332687">return</span>&nbsp;<span class="ident" id="6332694">nil</span><span class="op" id="6332697">,</span>&nbsp;<span class="ident" id="6332699">nil</span><span class="op" id="6332702">,</span>&nbsp;<span class="ident" id="6332704">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6332709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6332712">return</span>&nbsp;<span class="ident" id="6332719">ioutil</span><span class="op" id="6332725">.</span><span class="ident" id="6332726">NopCloser</span><span class="op" id="6332735">(</span><span class="op" id="6332736">&amp;</span><span class="ident" id="6332737">buf</span><span class="op" id="6332740">)</span><span class="op" id="6332741">,</span>&nbsp;<span class="ident" id="6332743">ioutil</span><span class="op" id="6332749">.</span><span class="ident" id="6332750">NopCloser</span><span class="op" id="6332759">(</span><span class="ident" id="6332760">bytes</span><span class="op" id="6332765">.</span><span class="ident" id="6332766">NewReader</span><span class="op" id="6332775">(</span><span class="ident" id="6332776">buf</span><span class="op" id="6332779">.</span><span class="ident" id="6332780">Bytes</span><span class="op" id="6332785">(</span><span class="op" id="6332786">)</span><span class="op" id="6332787">)</span><span class="op" id="6332788">)</span><span class="op" id="6332789">,</span>&nbsp;<span class="ident" id="6332791">nil</span><br>
<span class="lineno"></span><span class="op" id="6332795">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="6332798">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="6332869">type</span>&nbsp;<span class="ident" id="6332874">dumpConn</span>&nbsp;<span class="keyword" id="6332883">struct</span>&nbsp;<span class="op" id="6332890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332893">io</span><span class="op" id="6332895">.</span><span class="ident" id="6332896">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332904">io</span><span class="op" id="6332906">.</span><span class="ident" id="6332907">Reader</span><br>
<span class="lineno">40</span><span class="op" id="6332914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6332917">func</span>&nbsp;<span class="op" id="6332922">(</span><span class="ident" id="6332923">c</span>&nbsp;<span class="op" id="6332925">*</span><span class="ident" id="6332926">dumpConn</span><span class="op" id="6332934">)</span>&nbsp;<span class="ident" id="6332936">Close</span><span class="op" id="6332941">(</span><span class="op" id="6332942">)</span>&nbsp;<span class="builtintype" id="6332944">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6332972">{</span>&nbsp;<span class="keyword" id="6332974">return</span>&nbsp;<span class="ident" id="6332981">nil</span>&nbsp;<span class="op" id="6332985">}</span><br>
<span class="lineno"></span><span class="keyword" id="6332987">func</span>&nbsp;<span class="op" id="6332992">(</span><span class="ident" id="6332993">c</span>&nbsp;<span class="op" id="6332995">*</span><span class="ident" id="6332996">dumpConn</span><span class="op" id="6333004">)</span>&nbsp;<span class="ident" id="6333006">LocalAddr</span><span class="op" id="6333015">(</span><span class="op" id="6333016">)</span>&nbsp;<span class="ident" id="6333018">net</span><span class="op" id="6333021">.</span><span class="ident" id="6333022">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333042">{</span>&nbsp;<span class="keyword" id="6333044">return</span>&nbsp;<span class="ident" id="6333051">nil</span>&nbsp;<span class="op" id="6333055">}</span><br>
<span class="lineno"></span><span class="keyword" id="6333057">func</span>&nbsp;<span class="op" id="6333062">(</span><span class="ident" id="6333063">c</span>&nbsp;<span class="op" id="6333065">*</span><span class="ident" id="6333066">dumpConn</span><span class="op" id="6333074">)</span>&nbsp;<span class="ident" id="6333076">RemoteAddr</span><span class="op" id="6333086">(</span><span class="op" id="6333087">)</span>&nbsp;<span class="ident" id="6333089">net</span><span class="op" id="6333092">.</span><span class="ident" id="6333093">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333112">{</span>&nbsp;<span class="keyword" id="6333114">return</span>&nbsp;<span class="ident" id="6333121">nil</span>&nbsp;<span class="op" id="6333125">}</span><br>
<span class="lineno">45</span><span class="keyword" id="6333127">func</span>&nbsp;<span class="op" id="6333132">(</span><span class="ident" id="6333133">c</span>&nbsp;<span class="op" id="6333135">*</span><span class="ident" id="6333136">dumpConn</span><span class="op" id="6333144">)</span>&nbsp;<span class="ident" id="6333146">SetDeadline</span><span class="op" id="6333157">(</span><span class="ident" id="6333158">t</span>&nbsp;<span class="ident" id="6333160">time</span><span class="op" id="6333164">.</span><span class="ident" id="6333165">Time</span><span class="op" id="6333169">)</span>&nbsp;<span class="builtintype" id="6333171">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333182">{</span>&nbsp;<span class="keyword" id="6333184">return</span>&nbsp;<span class="ident" id="6333191">nil</span>&nbsp;<span class="op" id="6333195">}</span><br>
<span class="lineno"></span><span class="keyword" id="6333197">func</span>&nbsp;<span class="op" id="6333202">(</span><span class="ident" id="6333203">c</span>&nbsp;<span class="op" id="6333205">*</span><span class="ident" id="6333206">dumpConn</span><span class="op" id="6333214">)</span>&nbsp;<span class="ident" id="6333216">SetReadDeadline</span><span class="op" id="6333231">(</span><span class="ident" id="6333232">t</span>&nbsp;<span class="ident" id="6333234">time</span><span class="op" id="6333238">.</span><span class="ident" id="6333239">Time</span><span class="op" id="6333243">)</span>&nbsp;<span class="builtintype" id="6333245">error</span>&nbsp;&nbsp;<span class="op" id="6333252">{</span>&nbsp;<span class="keyword" id="6333254">return</span>&nbsp;<span class="ident" id="6333261">nil</span>&nbsp;<span class="op" id="6333265">}</span><br>
<span class="lineno"></span><span class="keyword" id="6333267">func</span>&nbsp;<span class="op" id="6333272">(</span><span class="ident" id="6333273">c</span>&nbsp;<span class="op" id="6333275">*</span><span class="ident" id="6333276">dumpConn</span><span class="op" id="6333284">)</span>&nbsp;<span class="ident" id="6333286">SetWriteDeadline</span><span class="op" id="6333302">(</span><span class="ident" id="6333303">t</span>&nbsp;<span class="ident" id="6333305">time</span><span class="op" id="6333309">.</span><span class="ident" id="6333310">Time</span><span class="op" id="6333314">)</span>&nbsp;<span class="builtintype" id="6333316">error</span>&nbsp;<span class="op" id="6333322">{</span>&nbsp;<span class="keyword" id="6333324">return</span>&nbsp;<span class="ident" id="6333331">nil</span>&nbsp;<span class="op" id="6333335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6333338">type</span>&nbsp;<span class="ident" id="6333343">neverEnding</span>&nbsp;<span class="builtintype" id="6333355">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6333361">func</span>&nbsp;<span class="op" id="6333366">(</span><span class="ident" id="6333367">b</span>&nbsp;<span class="ident" id="6333369">neverEnding</span><span class="op" id="6333380">)</span>&nbsp;<span class="ident" id="6333382">Read</span><span class="op" id="6333386">(</span><span class="ident" id="6333387">p</span>&nbsp;<span class="op" id="6333389">[</span><span class="op" id="6333390">]</span><span class="builtintype" id="6333391">byte</span><span class="op" id="6333395">)</span>&nbsp;<span class="op" id="6333397">(</span><span class="ident" id="6333398">n</span>&nbsp;<span class="builtintype" id="6333400">int</span><span class="op" id="6333403">,</span>&nbsp;<span class="ident" id="6333405">err</span>&nbsp;<span class="builtintype" id="6333409">error</span><span class="op" id="6333414">)</span>&nbsp;<span class="op" id="6333416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333419">for</span>&nbsp;<span class="ident" id="6333423">i</span>&nbsp;<span class="op" id="6333425">:=</span>&nbsp;<span class="keyword" id="6333428">range</span>&nbsp;<span class="ident" id="6333434">p</span>&nbsp;<span class="op" id="6333436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333440">p</span><span class="op" id="6333441">[</span><span class="ident" id="6333442">i</span><span class="op" id="6333443">]</span>&nbsp;<span class="op" id="6333445">=</span>&nbsp;<span class="builtintype" id="6333447">byte</span><span class="op" id="6333451">(</span><span class="ident" id="6333452">b</span><span class="op" id="6333453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333456">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333459">return</span>&nbsp;<span class="builtinfunc" id="6333466">len</span><span class="op" id="6333469">(</span><span class="ident" id="6333470">p</span><span class="op" id="6333471">)</span><span class="op" id="6333472">,</span>&nbsp;<span class="ident" id="6333474">nil</span><br>
<span class="lineno"></span><span class="op" id="6333478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6333481">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="6333532">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="6333582">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="6333605">func</span>&nbsp;<span class="ident" id="6333610">DumpRequestOut</span><span class="op" id="6333624">(</span><span class="ident" id="6333625">req</span>&nbsp;<span class="op" id="6333629">*</span><span class="ident" id="6333630">http</span><span class="op" id="6333634">.</span><span class="ident" id="6333635">Request</span><span class="op" id="6333642">,</span>&nbsp;<span class="ident" id="6333644">body</span>&nbsp;<span class="builtintype" id="6333649">bool</span><span class="op" id="6333653">)</span>&nbsp;<span class="op" id="6333655">(</span><span class="op" id="6333656">[</span><span class="op" id="6333657">]</span><span class="builtintype" id="6333658">byte</span><span class="op" id="6333662">,</span>&nbsp;<span class="builtintype" id="6333664">error</span><span class="op" id="6333669">)</span>&nbsp;<span class="op" id="6333671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333674">save</span>&nbsp;<span class="op" id="6333679">:=</span>&nbsp;<span class="ident" id="6333682">req</span><span class="op" id="6333685">.</span><span class="ident" id="6333686">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333692">dummyBody</span>&nbsp;<span class="op" id="6333702">:=</span>&nbsp;<span class="builtintype" id="6333705">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333712">if</span>&nbsp;<span class="op" id="6333715">!</span><span class="ident" id="6333716">body</span>&nbsp;<span class="op" id="6333721">||</span>&nbsp;<span class="ident" id="6333724">req</span><span class="op" id="6333727">.</span><span class="ident" id="6333728">Body</span>&nbsp;<span class="op" id="6333733">==</span>&nbsp;<span class="ident" id="6333736">nil</span>&nbsp;<span class="op" id="6333740">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333744">req</span><span class="op" id="6333747">.</span><span class="ident" id="6333748">Body</span>&nbsp;<span class="op" id="6333753">=</span>&nbsp;<span class="ident" id="6333755">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333761">if</span>&nbsp;<span class="ident" id="6333764">req</span><span class="op" id="6333767">.</span><span class="ident" id="6333768">ContentLength</span>&nbsp;<span class="op" id="6333782">!=</span>&nbsp;<span class="num" id="6333785">0</span>&nbsp;<span class="op" id="6333787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333792">req</span><span class="op" id="6333795">.</span><span class="ident" id="6333796">Body</span>&nbsp;<span class="op" id="6333801">=</span>&nbsp;<span class="ident" id="6333803">ioutil</span><span class="op" id="6333809">.</span><span class="ident" id="6333810">NopCloser</span><span class="op" id="6333819">(</span><span class="ident" id="6333820">io</span><span class="op" id="6333822">.</span><span class="ident" id="6333823">LimitReader</span><span class="op" id="6333834">(</span><span class="ident" id="6333835">neverEnding</span><span class="op" id="6333846">(</span><span class="string" id="6333847">&#39;x&#39;</span><span class="op" id="6333850">)</span><span class="op" id="6333851">,</span>&nbsp;<span class="ident" id="6333853">req</span><span class="op" id="6333856">.</span><span class="ident" id="6333857">ContentLength</span><span class="op" id="6333870">)</span><span class="op" id="6333871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333876">dummyBody</span>&nbsp;<span class="op" id="6333886">=</span>&nbsp;<span class="builtintype" id="6333888">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333895">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6333898">}</span>&nbsp;<span class="keyword" id="6333900">else</span>&nbsp;<span class="op" id="6333905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333909">var</span>&nbsp;<span class="ident" id="6333913">err</span>&nbsp;<span class="builtintype" id="6333917">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333925">save</span><span class="op" id="6333929">,</span>&nbsp;<span class="ident" id="6333931">req</span><span class="op" id="6333934">.</span><span class="ident" id="6333935">Body</span><span class="op" id="6333939">,</span>&nbsp;<span class="ident" id="6333941">err</span>&nbsp;<span class="op" id="6333945">=</span>&nbsp;<span class="ident" id="6333947">drainBody</span><span class="op" id="6333956">(</span><span class="ident" id="6333957">req</span><span class="op" id="6333960">.</span><span class="ident" id="6333961">Body</span><span class="op" id="6333965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333969">if</span>&nbsp;<span class="ident" id="6333972">err</span>&nbsp;<span class="op" id="6333976">!=</span>&nbsp;<span class="ident" id="6333979">nil</span>&nbsp;<span class="op" id="6333983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6333988">return</span>&nbsp;<span class="ident" id="6333995">nil</span><span class="op" id="6333998">,</span>&nbsp;<span class="ident" id="6334000">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6334013">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6334083">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6334144">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6334207">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334268">reqSend</span>&nbsp;<span class="op" id="6334276">:=</span>&nbsp;<span class="ident" id="6334279">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334284">if</span>&nbsp;<span class="ident" id="6334287">req</span><span class="op" id="6334290">.</span><span class="ident" id="6334291">URL</span><span class="op" id="6334294">.</span><span class="ident" id="6334295">Scheme</span>&nbsp;<span class="op" id="6334302">==</span>&nbsp;<span class="string" id="6334305">&#34;https&#34;</span>&nbsp;<span class="op" id="6334313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334317">reqSend</span>&nbsp;<span class="op" id="6334325">=</span>&nbsp;<span class="builtinfunc" id="6334327">new</span><span class="op" id="6334330">(</span><span class="ident" id="6334331">http</span><span class="op" id="6334335">.</span><span class="ident" id="6334336">Request</span><span class="op" id="6334343">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334347">*</span><span class="ident" id="6334348">reqSend</span>&nbsp;<span class="op" id="6334356">=</span>&nbsp;<span class="op" id="6334358">*</span><span class="ident" id="6334359">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334365">reqSend</span><span class="op" id="6334372">.</span><span class="ident" id="6334373">URL</span>&nbsp;<span class="op" id="6334377">=</span>&nbsp;<span class="builtinfunc" id="6334379">new</span><span class="op" id="6334382">(</span><span class="ident" id="6334383">url</span><span class="op" id="6334386">.</span><span class="ident" id="6334387">URL</span><span class="op" id="6334390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334394">*</span><span class="ident" id="6334395">reqSend</span><span class="op" id="6334402">.</span><span class="ident" id="6334403">URL</span>&nbsp;<span class="op" id="6334407">=</span>&nbsp;<span class="op" id="6334409">*</span><span class="ident" id="6334410">req</span><span class="op" id="6334413">.</span><span class="ident" id="6334414">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334420">reqSend</span><span class="op" id="6334427">.</span><span class="ident" id="6334428">URL</span><span class="op" id="6334431">.</span><span class="ident" id="6334432">Scheme</span>&nbsp;<span class="op" id="6334439">=</span>&nbsp;<span class="string" id="6334441">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6334449">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6334453">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6334516">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6334576">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6334634">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6334695">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334722">var</span>&nbsp;<span class="ident" id="6334726">buf</span>&nbsp;<span class="ident" id="6334730">bytes</span><span class="op" id="6334735">.</span><span class="ident" id="6334736">Buffer</span>&nbsp;<span class="comment" id="6334743">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334766">pr</span><span class="op" id="6334768">,</span>&nbsp;<span class="ident" id="6334770">pw</span>&nbsp;<span class="op" id="6334773">:=</span>&nbsp;<span class="ident" id="6334776">io</span><span class="op" id="6334778">.</span><span class="ident" id="6334779">Pipe</span><span class="op" id="6334783">(</span><span class="op" id="6334784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334787">defer</span>&nbsp;<span class="ident" id="6334793">pr</span><span class="op" id="6334795">.</span><span class="ident" id="6334796">Close</span><span class="op" id="6334801">(</span><span class="op" id="6334802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334805">defer</span>&nbsp;<span class="ident" id="6334811">pw</span><span class="op" id="6334813">.</span><span class="ident" id="6334814">Close</span><span class="op" id="6334819">(</span><span class="op" id="6334820">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334823">dr</span>&nbsp;<span class="op" id="6334826">:=</span>&nbsp;<span class="op" id="6334829">&amp;</span><span class="ident" id="6334830">delegateReader</span><span class="op" id="6334844">{</span><span class="ident" id="6334845">c</span><span class="op" id="6334846">:</span>&nbsp;<span class="builtinfunc" id="6334848">make</span><span class="op" id="6334852">(</span><span class="keyword" id="6334853">chan</span>&nbsp;<span class="ident" id="6334858">io</span><span class="op" id="6334860">.</span><span class="ident" id="6334861">Reader</span><span class="op" id="6334867">)</span><span class="op" id="6334868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6334871">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6334935">go</span>&nbsp;<span class="keyword" id="6334938">func</span><span class="op" id="6334942">(</span><span class="op" id="6334943">)</span>&nbsp;<span class="op" id="6334945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6334949">req</span><span class="op" id="6334952">,</span>&nbsp;<span class="ident" id="6334954">err</span>&nbsp;<span class="op" id="6334958">:=</span>&nbsp;<span class="ident" id="6334961">http</span><span class="op" id="6334965">.</span><span class="ident" id="6334966">ReadRequest</span><span class="op" id="6334977">(</span><span class="ident" id="6334978">bufio</span><span class="op" id="6334983">.</span><span class="ident" id="6334984">NewReader</span><span class="op" id="6334993">(</span><span class="ident" id="6334994">pr</span><span class="op" id="6334996">)</span><span class="op" id="6334997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335001">if</span>&nbsp;<span class="ident" id="6335004">err</span>&nbsp;<span class="op" id="6335008">==</span>&nbsp;<span class="ident" id="6335011">nil</span>&nbsp;<span class="op" id="6335015">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6335020">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6335065">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335097">io</span><span class="op" id="6335099">.</span><span class="ident" id="6335100">Copy</span><span class="op" id="6335104">(</span><span class="ident" id="6335105">ioutil</span><span class="op" id="6335111">.</span><span class="ident" id="6335112">Discard</span><span class="op" id="6335119">,</span>&nbsp;<span class="ident" id="6335121">req</span><span class="op" id="6335124">.</span><span class="ident" id="6335125">Body</span><span class="op" id="6335129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335134">req</span><span class="op" id="6335137">.</span><span class="ident" id="6335138">Body</span><span class="op" id="6335142">.</span><span class="ident" id="6335143">Close</span><span class="op" id="6335148">(</span><span class="op" id="6335149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335153">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335157">dr</span><span class="op" id="6335159">.</span><span class="ident" id="6335160">c</span>&nbsp;<span class="op" id="6335162">&lt;-</span>&nbsp;<span class="ident" id="6335165">strings</span><span class="op" id="6335172">.</span><span class="ident" id="6335173">NewReader</span><span class="op" id="6335182">(</span><span class="string" id="6335183">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="6335216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335219">}</span><span class="op" id="6335220">(</span><span class="op" id="6335221">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335225">t</span>&nbsp;<span class="op" id="6335227">:=</span>&nbsp;<span class="op" id="6335230">&amp;</span><span class="ident" id="6335231">http</span><span class="op" id="6335235">.</span><span class="ident" id="6335236">Transport</span><span class="op" id="6335245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335249">DisableKeepAlives</span><span class="op" id="6335266">:</span>&nbsp;<span class="builtintype" id="6335268">true</span><span class="op" id="6335272">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335276">Dial</span><span class="op" id="6335280">:</span>&nbsp;<span class="keyword" id="6335282">func</span><span class="op" id="6335286">(</span><span class="ident" id="6335287">net</span><span class="op" id="6335290">,</span>&nbsp;<span class="ident" id="6335292">addr</span>&nbsp;<span class="builtintype" id="6335297">string</span><span class="op" id="6335303">)</span>&nbsp;<span class="op" id="6335305">(</span><span class="ident" id="6335306">net</span><span class="op" id="6335309">.</span><span class="ident" id="6335310">Conn</span><span class="op" id="6335314">,</span>&nbsp;<span class="builtintype" id="6335316">error</span><span class="op" id="6335321">)</span>&nbsp;<span class="op" id="6335323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335328">return</span>&nbsp;<span class="op" id="6335335">&amp;</span><span class="ident" id="6335336">dumpConn</span><span class="op" id="6335344">{</span><span class="ident" id="6335345">io</span><span class="op" id="6335347">.</span><span class="ident" id="6335348">MultiWriter</span><span class="op" id="6335359">(</span><span class="op" id="6335360">&amp;</span><span class="ident" id="6335361">buf</span><span class="op" id="6335364">,</span>&nbsp;<span class="ident" id="6335366">pw</span><span class="op" id="6335368">)</span><span class="op" id="6335369">,</span>&nbsp;<span class="ident" id="6335371">dr</span><span class="op" id="6335373">}</span><span class="op" id="6335374">,</span>&nbsp;<span class="ident" id="6335376">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335382">}</span><span class="op" id="6335383">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335390">_</span><span class="op" id="6335391">,</span>&nbsp;<span class="ident" id="6335393">err</span>&nbsp;<span class="op" id="6335397">:=</span>&nbsp;<span class="ident" id="6335400">t</span><span class="op" id="6335401">.</span><span class="ident" id="6335402">RoundTrip</span><span class="op" id="6335411">(</span><span class="ident" id="6335412">reqSend</span><span class="op" id="6335419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335423">req</span><span class="op" id="6335426">.</span><span class="ident" id="6335427">Body</span>&nbsp;<span class="op" id="6335432">=</span>&nbsp;<span class="ident" id="6335434">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335440">if</span>&nbsp;<span class="ident" id="6335443">err</span>&nbsp;<span class="op" id="6335447">!=</span>&nbsp;<span class="ident" id="6335450">nil</span>&nbsp;<span class="op" id="6335454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335458">return</span>&nbsp;<span class="ident" id="6335465">nil</span><span class="op" id="6335468">,</span>&nbsp;<span class="ident" id="6335470">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335478">dump</span>&nbsp;<span class="op" id="6335483">:=</span>&nbsp;<span class="ident" id="6335486">buf</span><span class="op" id="6335489">.</span><span class="ident" id="6335490">Bytes</span><span class="op" id="6335495">(</span><span class="op" id="6335496">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6335500">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6335550">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6335614">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6335677">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6335739">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335785">if</span>&nbsp;<span class="ident" id="6335788">dummyBody</span>&nbsp;<span class="op" id="6335798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335802">if</span>&nbsp;<span class="ident" id="6335805">i</span>&nbsp;<span class="op" id="6335807">:=</span>&nbsp;<span class="ident" id="6335810">bytes</span><span class="op" id="6335815">.</span><span class="ident" id="6335816">Index</span><span class="op" id="6335821">(</span><span class="ident" id="6335822">dump</span><span class="op" id="6335826">,</span>&nbsp;<span class="op" id="6335828">[</span><span class="op" id="6335829">]</span><span class="builtintype" id="6335830">byte</span><span class="op" id="6335834">(</span><span class="string" id="6335835">&#34;\r\n\r\n&#34;</span><span class="op" id="6335845">)</span><span class="op" id="6335846">)</span><span class="op" id="6335847">;</span>&nbsp;<span class="ident" id="6335849">i</span>&nbsp;<span class="op" id="6335851">&gt;=</span>&nbsp;<span class="num" id="6335854">0</span>&nbsp;<span class="op" id="6335856">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6335861">dump</span>&nbsp;<span class="op" id="6335866">=</span>&nbsp;<span class="ident" id="6335868">dump</span><span class="op" id="6335872">[</span><span class="op" id="6335873">:</span><span class="ident" id="6335874">i</span><span class="op" id="6335875">+</span><span class="num" id="6335876">4</span><span class="op" id="6335877">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6335884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6335887">return</span>&nbsp;<span class="ident" id="6335894">dump</span><span class="op" id="6335898">,</span>&nbsp;<span class="ident" id="6335900">nil</span><br>
<span class="lineno"></span><span class="op" id="6335904">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="6335907">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="6335971">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="6336004">type</span>&nbsp;<span class="ident" id="6336009">delegateReader</span>&nbsp;<span class="keyword" id="6336024">struct</span>&nbsp;<span class="op" id="6336031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336034">c</span>&nbsp;<span class="keyword" id="6336036">chan</span>&nbsp;<span class="ident" id="6336041">io</span><span class="op" id="6336043">.</span><span class="ident" id="6336044">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336052">r</span>&nbsp;<span class="ident" id="6336054">io</span><span class="op" id="6336056">.</span><span class="ident" id="6336057">Reader</span>&nbsp;<span class="comment" id="6336064">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="6336093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6336096">func</span>&nbsp;<span class="op" id="6336101">(</span><span class="ident" id="6336102">r</span>&nbsp;<span class="op" id="6336104">*</span><span class="ident" id="6336105">delegateReader</span><span class="op" id="6336119">)</span>&nbsp;<span class="ident" id="6336121">Read</span><span class="op" id="6336125">(</span><span class="ident" id="6336126">p</span>&nbsp;<span class="op" id="6336128">[</span><span class="op" id="6336129">]</span><span class="builtintype" id="6336130">byte</span><span class="op" id="6336134">)</span>&nbsp;<span class="op" id="6336136">(</span><span class="builtintype" id="6336137">int</span><span class="op" id="6336140">,</span>&nbsp;<span class="builtintype" id="6336142">error</span><span class="op" id="6336147">)</span>&nbsp;<span class="op" id="6336149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336152">if</span>&nbsp;<span class="ident" id="6336155">r</span><span class="op" id="6336156">.</span><span class="ident" id="6336157">r</span>&nbsp;<span class="op" id="6336159">==</span>&nbsp;<span class="ident" id="6336162">nil</span>&nbsp;<span class="op" id="6336166">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6336170">r</span><span class="op" id="6336171">.</span><span class="ident" id="6336172">r</span>&nbsp;<span class="op" id="6336174">=</span>&nbsp;<span class="op" id="6336176">&lt;-</span><span class="ident" id="6336178">r</span><span class="op" id="6336179">.</span><span class="ident" id="6336180">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6336183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336186">return</span>&nbsp;<span class="ident" id="6336193">r</span><span class="op" id="6336194">.</span><span class="ident" id="6336195">r</span><span class="op" id="6336196">.</span><span class="ident" id="6336197">Read</span><span class="op" id="6336201">(</span><span class="ident" id="6336202">p</span><span class="op" id="6336203">)</span><br>
<span class="lineno"></span><span class="op" id="6336205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="6336208">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="6336252">func</span>&nbsp;<span class="ident" id="6336257">valueOrDefault</span><span class="op" id="6336271">(</span><span class="ident" id="6336272">value</span><span class="op" id="6336277">,</span>&nbsp;<span class="ident" id="6336279">def</span>&nbsp;<span class="builtintype" id="6336283">string</span><span class="op" id="6336289">)</span>&nbsp;<span class="builtintype" id="6336291">string</span>&nbsp;<span class="op" id="6336298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336301">if</span>&nbsp;<span class="ident" id="6336304">value</span>&nbsp;<span class="op" id="6336310">!=</span>&nbsp;<span class="string" id="6336313">&#34;&#34;</span>&nbsp;<span class="op" id="6336316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336320">return</span>&nbsp;<span class="ident" id="6336327">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6336334">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336337">return</span>&nbsp;<span class="ident" id="6336344">def</span><br>
<span class="lineno"></span><span class="op" id="6336348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6336351">var</span>&nbsp;<span class="ident" id="6336355">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="6336381">=</span>&nbsp;<span class="keyword" id="6336383">map</span><span class="op" id="6336386">[</span><span class="builtintype" id="6336387">string</span><span class="op" id="6336393">]</span><span class="builtintype" id="6336394">bool</span><span class="op" id="6336398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6336401">&#34;Host&#34;</span><span class="op" id="6336407">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6336422">true</span><span class="op" id="6336426">,</span>&nbsp;<span class="comment" id="6336428">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6336457">&#34;Content-Length&#34;</span><span class="op" id="6336473">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6336478">true</span><span class="op" id="6336482">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6336485">&#34;Transfer-Encoding&#34;</span><span class="op" id="6336504">:</span>&nbsp;<span class="builtintype" id="6336506">true</span><span class="op" id="6336510">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6336513">&#34;Trailer&#34;</span><span class="op" id="6336522">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6336534">true</span><span class="op" id="6336538">,</span><br>
<span class="lineno"></span><span class="op" id="6336540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="6336543">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6336612">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="6336683">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="6336699">func</span>&nbsp;<span class="ident" id="6336704">dumpAsReceived</span><span class="op" id="6336718">(</span><span class="ident" id="6336719">req</span>&nbsp;<span class="op" id="6336723">*</span><span class="ident" id="6336724">http</span><span class="op" id="6336728">.</span><span class="ident" id="6336729">Request</span><span class="op" id="6336736">,</span>&nbsp;<span class="ident" id="6336738">w</span>&nbsp;<span class="ident" id="6336740">io</span><span class="op" id="6336742">.</span><span class="ident" id="6336743">Writer</span><span class="op" id="6336749">)</span>&nbsp;<span class="builtintype" id="6336751">error</span>&nbsp;<span class="op" id="6336757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6336760">return</span>&nbsp;<span class="ident" id="6336767">nil</span><br>
<span class="lineno">175</span><span class="op" id="6336771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6336774">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="6336841">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="6336898">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="6336954">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6337011">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="6337063">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="6337128">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="6337148">func</span>&nbsp;<span class="ident" id="6337153">DumpRequest</span><span class="op" id="6337164">(</span><span class="ident" id="6337165">req</span>&nbsp;<span class="op" id="6337169">*</span><span class="ident" id="6337170">http</span><span class="op" id="6337174">.</span><span class="ident" id="6337175">Request</span><span class="op" id="6337182">,</span>&nbsp;<span class="ident" id="6337184">body</span>&nbsp;<span class="builtintype" id="6337189">bool</span><span class="op" id="6337193">)</span>&nbsp;<span class="op" id="6337195">(</span><span class="ident" id="6337196">dump</span>&nbsp;<span class="op" id="6337201">[</span><span class="op" id="6337202">]</span><span class="builtintype" id="6337203">byte</span><span class="op" id="6337207">,</span>&nbsp;<span class="ident" id="6337209">err</span>&nbsp;<span class="builtintype" id="6337213">error</span><span class="op" id="6337218">)</span>&nbsp;<span class="op" id="6337220">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337223">save</span>&nbsp;<span class="op" id="6337228">:=</span>&nbsp;<span class="ident" id="6337231">req</span><span class="op" id="6337234">.</span><span class="ident" id="6337235">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337241">if</span>&nbsp;<span class="op" id="6337244">!</span><span class="ident" id="6337245">body</span>&nbsp;<span class="op" id="6337250">||</span>&nbsp;<span class="ident" id="6337253">req</span><span class="op" id="6337256">.</span><span class="ident" id="6337257">Body</span>&nbsp;<span class="op" id="6337262">==</span>&nbsp;<span class="ident" id="6337265">nil</span>&nbsp;<span class="op" id="6337269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337273">req</span><span class="op" id="6337276">.</span><span class="ident" id="6337277">Body</span>&nbsp;<span class="op" id="6337282">=</span>&nbsp;<span class="ident" id="6337284">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6337289">}</span>&nbsp;<span class="keyword" id="6337291">else</span>&nbsp;<span class="op" id="6337296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337300">save</span><span class="op" id="6337304">,</span>&nbsp;<span class="ident" id="6337306">req</span><span class="op" id="6337309">.</span><span class="ident" id="6337310">Body</span><span class="op" id="6337314">,</span>&nbsp;<span class="ident" id="6337316">err</span>&nbsp;<span class="op" id="6337320">=</span>&nbsp;<span class="ident" id="6337322">drainBody</span><span class="op" id="6337331">(</span><span class="ident" id="6337332">req</span><span class="op" id="6337335">.</span><span class="ident" id="6337336">Body</span><span class="op" id="6337340">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337344">if</span>&nbsp;<span class="ident" id="6337347">err</span>&nbsp;<span class="op" id="6337351">!=</span>&nbsp;<span class="ident" id="6337354">nil</span>&nbsp;<span class="op" id="6337358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337363">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6337372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6337375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337379">var</span>&nbsp;<span class="ident" id="6337383">b</span>&nbsp;<span class="ident" id="6337385">bytes</span><span class="op" id="6337390">.</span><span class="ident" id="6337391">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337400">fmt</span><span class="op" id="6337403">.</span><span class="ident" id="6337404">Fprintf</span><span class="op" id="6337411">(</span><span class="op" id="6337412">&amp;</span><span class="ident" id="6337413">b</span><span class="op" id="6337414">,</span>&nbsp;<span class="string" id="6337416">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="6337438">,</span>&nbsp;<span class="ident" id="6337440">valueOrDefault</span><span class="op" id="6337454">(</span><span class="ident" id="6337455">req</span><span class="op" id="6337458">.</span><span class="ident" id="6337459">Method</span><span class="op" id="6337465">,</span>&nbsp;<span class="string" id="6337467">&#34;GET&#34;</span><span class="op" id="6337472">)</span><span class="op" id="6337473">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337477">req</span><span class="op" id="6337480">.</span><span class="ident" id="6337481">URL</span><span class="op" id="6337484">.</span><span class="ident" id="6337485">RequestURI</span><span class="op" id="6337495">(</span><span class="op" id="6337496">)</span><span class="op" id="6337497">,</span>&nbsp;<span class="ident" id="6337499">req</span><span class="op" id="6337502">.</span><span class="ident" id="6337503">ProtoMajor</span><span class="op" id="6337513">,</span>&nbsp;<span class="ident" id="6337515">req</span><span class="op" id="6337518">.</span><span class="ident" id="6337519">ProtoMinor</span><span class="op" id="6337529">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337533">host</span>&nbsp;<span class="op" id="6337538">:=</span>&nbsp;<span class="ident" id="6337541">req</span><span class="op" id="6337544">.</span><span class="ident" id="6337545">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337551">if</span>&nbsp;<span class="ident" id="6337554">host</span>&nbsp;<span class="op" id="6337559">==</span>&nbsp;<span class="string" id="6337562">&#34;&#34;</span>&nbsp;<span class="op" id="6337565">&amp;&amp;</span>&nbsp;<span class="ident" id="6337568">req</span><span class="op" id="6337571">.</span><span class="ident" id="6337572">URL</span>&nbsp;<span class="op" id="6337576">!=</span>&nbsp;<span class="ident" id="6337579">nil</span>&nbsp;<span class="op" id="6337583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337587">host</span>&nbsp;<span class="op" id="6337592">=</span>&nbsp;<span class="ident" id="6337594">req</span><span class="op" id="6337597">.</span><span class="ident" id="6337598">URL</span><span class="op" id="6337601">.</span><span class="ident" id="6337602">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6337608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337611">if</span>&nbsp;<span class="ident" id="6337614">host</span>&nbsp;<span class="op" id="6337619">!=</span>&nbsp;<span class="string" id="6337622">&#34;&#34;</span>&nbsp;<span class="op" id="6337625">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337629">fmt</span><span class="op" id="6337632">.</span><span class="ident" id="6337633">Fprintf</span><span class="op" id="6337640">(</span><span class="op" id="6337641">&amp;</span><span class="ident" id="6337642">b</span><span class="op" id="6337643">,</span>&nbsp;<span class="string" id="6337645">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="6337659">,</span>&nbsp;<span class="ident" id="6337661">host</span><span class="op" id="6337665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6337668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337672">chunked</span>&nbsp;<span class="op" id="6337680">:=</span>&nbsp;<span class="builtinfunc" id="6337683">len</span><span class="op" id="6337686">(</span><span class="ident" id="6337687">req</span><span class="op" id="6337690">.</span><span class="ident" id="6337691">TransferEncoding</span><span class="op" id="6337707">)</span>&nbsp;<span class="op" id="6337709">&gt;</span>&nbsp;<span class="num" id="6337711">0</span>&nbsp;<span class="op" id="6337713">&amp;&amp;</span>&nbsp;<span class="ident" id="6337716">req</span><span class="op" id="6337719">.</span><span class="ident" id="6337720">TransferEncoding</span><span class="op" id="6337736">[</span><span class="num" id="6337737">0</span><span class="op" id="6337738">]</span>&nbsp;<span class="op" id="6337740">==</span>&nbsp;<span class="string" id="6337743">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337754">if</span>&nbsp;<span class="builtinfunc" id="6337757">len</span><span class="op" id="6337760">(</span><span class="ident" id="6337761">req</span><span class="op" id="6337764">.</span><span class="ident" id="6337765">TransferEncoding</span><span class="op" id="6337781">)</span>&nbsp;<span class="op" id="6337783">&gt;</span>&nbsp;<span class="num" id="6337785">0</span>&nbsp;<span class="op" id="6337787">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337791">fmt</span><span class="op" id="6337794">.</span><span class="ident" id="6337795">Fprintf</span><span class="op" id="6337802">(</span><span class="op" id="6337803">&amp;</span><span class="ident" id="6337804">b</span><span class="op" id="6337805">,</span>&nbsp;<span class="string" id="6337807">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="6337834">,</span>&nbsp;<span class="ident" id="6337836">strings</span><span class="op" id="6337843">.</span><span class="ident" id="6337844">Join</span><span class="op" id="6337848">(</span><span class="ident" id="6337849">req</span><span class="op" id="6337852">.</span><span class="ident" id="6337853">TransferEncoding</span><span class="op" id="6337869">,</span>&nbsp;<span class="string" id="6337871">&#34;,&#34;</span><span class="op" id="6337874">)</span><span class="op" id="6337875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6337878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6337881">if</span>&nbsp;<span class="ident" id="6337884">req</span><span class="op" id="6337887">.</span><span class="ident" id="6337888">Close</span>&nbsp;<span class="op" id="6337894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337898">fmt</span><span class="op" id="6337901">.</span><span class="ident" id="6337902">Fprintf</span><span class="op" id="6337909">(</span><span class="op" id="6337910">&amp;</span><span class="ident" id="6337911">b</span><span class="op" id="6337912">,</span>&nbsp;<span class="string" id="6337914">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="6337937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6337940">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6337944">err</span>&nbsp;<span class="op" id="6337948">=</span>&nbsp;<span class="ident" id="6337950">req</span><span class="op" id="6337953">.</span><span class="ident" id="6337954">Header</span><span class="op" id="6337960">.</span><span class="ident" id="6337961">WriteSubset</span><span class="op" id="6337972">(</span><span class="op" id="6337973">&amp;</span><span class="ident" id="6337974">b</span><span class="op" id="6337975">,</span>&nbsp;<span class="ident" id="6337977">reqWriteExcludeHeaderDump</span><span class="op" id="6338002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338005">if</span>&nbsp;<span class="ident" id="6338008">err</span>&nbsp;<span class="op" id="6338012">!=</span>&nbsp;<span class="ident" id="6338015">nil</span>&nbsp;<span class="op" id="6338019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338023">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6338031">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338035">io</span><span class="op" id="6338037">.</span><span class="ident" id="6338038">WriteString</span><span class="op" id="6338049">(</span><span class="op" id="6338050">&amp;</span><span class="ident" id="6338051">b</span><span class="op" id="6338052">,</span>&nbsp;<span class="string" id="6338054">&#34;\r\n&#34;</span><span class="op" id="6338060">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338064">if</span>&nbsp;<span class="ident" id="6338067">req</span><span class="op" id="6338070">.</span><span class="ident" id="6338071">Body</span>&nbsp;<span class="op" id="6338076">!=</span>&nbsp;<span class="ident" id="6338079">nil</span>&nbsp;<span class="op" id="6338083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338087">var</span>&nbsp;<span class="ident" id="6338091">dest</span>&nbsp;<span class="ident" id="6338096">io</span><span class="op" id="6338098">.</span><span class="ident" id="6338099">Writer</span>&nbsp;<span class="op" id="6338106">=</span>&nbsp;<span class="op" id="6338108">&amp;</span><span class="ident" id="6338109">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338113">if</span>&nbsp;<span class="ident" id="6338116">chunked</span>&nbsp;<span class="op" id="6338124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338129">dest</span>&nbsp;<span class="op" id="6338134">=</span>&nbsp;<span class="ident" id="6338136">NewChunkedWriter</span><span class="op" id="6338152">(</span><span class="ident" id="6338153">dest</span><span class="op" id="6338157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6338161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338165">_</span><span class="op" id="6338166">,</span>&nbsp;<span class="ident" id="6338168">err</span>&nbsp;<span class="op" id="6338172">=</span>&nbsp;<span class="ident" id="6338174">io</span><span class="op" id="6338176">.</span><span class="ident" id="6338177">Copy</span><span class="op" id="6338181">(</span><span class="ident" id="6338182">dest</span><span class="op" id="6338186">,</span>&nbsp;<span class="ident" id="6338188">req</span><span class="op" id="6338191">.</span><span class="ident" id="6338192">Body</span><span class="op" id="6338196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338200">if</span>&nbsp;<span class="ident" id="6338203">chunked</span>&nbsp;<span class="op" id="6338211">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338216">dest</span><span class="op" id="6338220">.</span><span class="op" id="6338221">(</span><span class="ident" id="6338222">io</span><span class="op" id="6338224">.</span><span class="ident" id="6338225">Closer</span><span class="op" id="6338231">)</span><span class="op" id="6338232">.</span><span class="ident" id="6338233">Close</span><span class="op" id="6338238">(</span><span class="op" id="6338239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338244">io</span><span class="op" id="6338246">.</span><span class="ident" id="6338247">WriteString</span><span class="op" id="6338258">(</span><span class="op" id="6338259">&amp;</span><span class="ident" id="6338260">b</span><span class="op" id="6338261">,</span>&nbsp;<span class="string" id="6338263">&#34;\r\n&#34;</span><span class="op" id="6338269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6338273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6338276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338280">req</span><span class="op" id="6338283">.</span><span class="ident" id="6338284">Body</span>&nbsp;<span class="op" id="6338289">=</span>&nbsp;<span class="ident" id="6338291">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338297">if</span>&nbsp;<span class="ident" id="6338300">err</span>&nbsp;<span class="op" id="6338304">!=</span>&nbsp;<span class="ident" id="6338307">nil</span>&nbsp;<span class="op" id="6338311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338315">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6338323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6338326">dump</span>&nbsp;<span class="op" id="6338331">=</span>&nbsp;<span class="ident" id="6338333">b</span><span class="op" id="6338334">.</span><span class="ident" id="6338335">Bytes</span><span class="op" id="6338340">(</span><span class="op" id="6338341">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6338344">return</span><br>
<span class="lineno"></span><span class="op" id="6338351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6338354">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="6338436">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="6338478">var</span>&nbsp;<span class="ident" id="6338482">errNoBody</span>&nbsp;<span class="op" id="6338492">=</span>&nbsp;<span class="ident" id="6338494">errors</span><span class="op" id="6338500">.</span><span class="ident" id="6338501">New</span><span class="op" id="6338504">(</span><span class="string" id="6338505">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="6338527">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6338530">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6338601">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6338670">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="6338737">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="6338769">type</span>&nbsp;<span class="ident" id="6338774">failureToReadBody</span>&nbsp;<span class="keyword" id="6338792">struct</span><span class="op" id="6338798">{</span><span class="op" id="6338799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6338802">func</span>&nbsp;<span class="op" id="6338807">(</span><span class="ident" id="6338808">failureToReadBody</span><span class="op" id="6338825">)</span>&nbsp;<span class="ident" id="6338827">Read</span><span class="op" id="6338831">(</span><span class="op" id="6338832">[</span><span class="op" id="6338833">]</span><span class="builtintype" id="6338834">byte</span><span class="op" id="6338838">)</span>&nbsp;<span class="op" id="6338840">(</span><span class="builtintype" id="6338841">int</span><span class="op" id="6338844">,</span>&nbsp;<span class="builtintype" id="6338846">error</span><span class="op" id="6338851">)</span>&nbsp;<span class="op" id="6338853">{</span>&nbsp;<span class="keyword" id="6338855">return</span>&nbsp;<span class="num" id="6338862">0</span><span class="op" id="6338863">,</span>&nbsp;<span class="ident" id="6338865">errNoBody</span>&nbsp;<span class="op" id="6338875">}</span><br>
<span class="lineno"></span><span class="keyword" id="6338877">func</span>&nbsp;<span class="op" id="6338882">(</span><span class="ident" id="6338883">failureToReadBody</span><span class="op" id="6338900">)</span>&nbsp;<span class="ident" id="6338902">Close</span><span class="op" id="6338907">(</span><span class="op" id="6338908">)</span>&nbsp;<span class="builtintype" id="6338910">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6338928">{</span>&nbsp;<span class="keyword" id="6338930">return</span>&nbsp;<span class="ident" id="6338937">nil</span>&nbsp;<span class="op" id="6338941">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6338944">var</span>&nbsp;<span class="ident" id="6338948">emptyBody</span>&nbsp;<span class="op" id="6338958">=</span>&nbsp;<span class="ident" id="6338960">ioutil</span><span class="op" id="6338966">.</span><span class="ident" id="6338967">NopCloser</span><span class="op" id="6338976">(</span><span class="ident" id="6338977">strings</span><span class="op" id="6338984">.</span><span class="ident" id="6338985">NewReader</span><span class="op" id="6338994">(</span><span class="string" id="6338995">&#34;&#34;</span><span class="op" id="6338997">)</span><span class="op" id="6338998">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6339001">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6339059">func</span>&nbsp;<span class="ident" id="6339064">DumpResponse</span><span class="op" id="6339076">(</span><span class="ident" id="6339077">resp</span>&nbsp;<span class="op" id="6339082">*</span><span class="ident" id="6339083">http</span><span class="op" id="6339087">.</span><span class="ident" id="6339088">Response</span><span class="op" id="6339096">,</span>&nbsp;<span class="ident" id="6339098">body</span>&nbsp;<span class="builtintype" id="6339103">bool</span><span class="op" id="6339107">)</span>&nbsp;<span class="op" id="6339109">(</span><span class="ident" id="6339110">dump</span>&nbsp;<span class="op" id="6339115">[</span><span class="op" id="6339116">]</span><span class="builtintype" id="6339117">byte</span><span class="op" id="6339121">,</span>&nbsp;<span class="ident" id="6339123">err</span>&nbsp;<span class="builtintype" id="6339127">error</span><span class="op" id="6339132">)</span>&nbsp;<span class="op" id="6339134">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6339137">var</span>&nbsp;<span class="ident" id="6339141">b</span>&nbsp;<span class="ident" id="6339143">bytes</span><span class="op" id="6339148">.</span><span class="ident" id="6339149">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339157">save</span>&nbsp;<span class="op" id="6339162">:=</span>&nbsp;<span class="ident" id="6339165">resp</span><span class="op" id="6339169">.</span><span class="ident" id="6339170">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339176">savecl</span>&nbsp;<span class="op" id="6339183">:=</span>&nbsp;<span class="ident" id="6339186">resp</span><span class="op" id="6339190">.</span><span class="ident" id="6339191">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6339207">if</span>&nbsp;<span class="op" id="6339210">!</span><span class="ident" id="6339211">body</span>&nbsp;<span class="op" id="6339216">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339220">resp</span><span class="op" id="6339224">.</span><span class="ident" id="6339225">Body</span>&nbsp;<span class="op" id="6339230">=</span>&nbsp;<span class="ident" id="6339232">failureToReadBody</span><span class="op" id="6339249">{</span><span class="op" id="6339250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6339253">}</span>&nbsp;<span class="keyword" id="6339255">else</span>&nbsp;<span class="keyword" id="6339260">if</span>&nbsp;<span class="ident" id="6339263">resp</span><span class="op" id="6339267">.</span><span class="ident" id="6339268">Body</span>&nbsp;<span class="op" id="6339273">==</span>&nbsp;<span class="ident" id="6339276">nil</span>&nbsp;<span class="op" id="6339280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339284">resp</span><span class="op" id="6339288">.</span><span class="ident" id="6339289">Body</span>&nbsp;<span class="op" id="6339294">=</span>&nbsp;<span class="ident" id="6339296">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6339307">}</span>&nbsp;<span class="keyword" id="6339309">else</span>&nbsp;<span class="op" id="6339314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339318">save</span><span class="op" id="6339322">,</span>&nbsp;<span class="ident" id="6339324">resp</span><span class="op" id="6339328">.</span><span class="ident" id="6339329">Body</span><span class="op" id="6339333">,</span>&nbsp;<span class="ident" id="6339335">err</span>&nbsp;<span class="op" id="6339339">=</span>&nbsp;<span class="ident" id="6339341">drainBody</span><span class="op" id="6339350">(</span><span class="ident" id="6339351">resp</span><span class="op" id="6339355">.</span><span class="ident" id="6339356">Body</span><span class="op" id="6339360">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6339364">if</span>&nbsp;<span class="ident" id="6339367">err</span>&nbsp;<span class="op" id="6339371">!=</span>&nbsp;<span class="ident" id="6339374">nil</span>&nbsp;<span class="op" id="6339378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6339383">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6339392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6339395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339398">err</span>&nbsp;<span class="op" id="6339402">=</span>&nbsp;<span class="ident" id="6339404">resp</span><span class="op" id="6339408">.</span><span class="ident" id="6339409">Write</span><span class="op" id="6339414">(</span><span class="op" id="6339415">&amp;</span><span class="ident" id="6339416">b</span><span class="op" id="6339417">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6339420">if</span>&nbsp;<span class="ident" id="6339423">err</span>&nbsp;<span class="op" id="6339427">==</span>&nbsp;<span class="ident" id="6339430">errNoBody</span>&nbsp;<span class="op" id="6339440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339444">err</span>&nbsp;<span class="op" id="6339448">=</span>&nbsp;<span class="ident" id="6339450">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6339455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339458">resp</span><span class="op" id="6339462">.</span><span class="ident" id="6339463">Body</span>&nbsp;<span class="op" id="6339468">=</span>&nbsp;<span class="ident" id="6339470">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6339476">resp</span><span class="op" id="6339480">.</span><span class="ident" id="6339481">ContentLength</span>&nbsp;<span class="op" id="6339495">=</span>&nbsp;<span class="ident" id="6339497">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6339505">if</span>&nbsp;<span class="ident" id="6339508">err</span>&nbsp;<span class="op" id="6339512">!=</span>&nbsp;<span class="ident" id="6339515">nil</span>&nbsp;<span class="op" id="6339519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6339523">return</span>&nbsp;<span class="ident" id="6339530">nil</span><span class="op" id="6339533">,</span>&nbsp;<span class="ident" id="6339535">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6339540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6339543">return</span>&nbsp;<span class="ident" id="6339550">b</span><span class="op" id="6339551">.</span><span class="ident" id="6339552">Bytes</span><span class="op" id="6339557">(</span><span class="op" id="6339558">)</span><span class="op" id="6339559">,</span>&nbsp;<span class="ident" id="6339561">nil</span><br>
<span class="lineno"></span><span class="op" id="6339565">}</span>
</div>
</body>
</html>
