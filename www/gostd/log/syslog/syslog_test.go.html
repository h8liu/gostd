<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7630868">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7630923">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7630977">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7631028">//&nbsp;+build&nbsp;!windows,!nacl,!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7631061">package</span>&nbsp;<span class="ident" id="7631069">syslog</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7631077">import</span>&nbsp;<span class="op" id="7631084">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7631087">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7631096">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7631103">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7631109">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7631122">&#34;log&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7631129">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7631136">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7631142">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7631150">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7631161">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="7631168">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7631171">func</span>&nbsp;<span class="ident" id="7631176">runPktSyslog</span><span class="op" id="7631188">(</span><span class="ident" id="7631189">c</span>&nbsp;<span class="ident" id="7631191">net</span><span class="op" id="7631194">.</span><span class="ident" id="7631195">PacketConn</span><span class="op" id="7631205">,</span>&nbsp;<span class="ident" id="7631207">done</span>&nbsp;<span class="keyword" id="7631212">chan</span><span class="op" id="7631216">&lt;-</span>&nbsp;<span class="builtintype" id="7631219">string</span><span class="op" id="7631225">)</span>&nbsp;<span class="op" id="7631227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631230">var</span>&nbsp;<span class="ident" id="7631234">buf</span>&nbsp;<span class="op" id="7631238">[</span><span class="num" id="7631239">4096</span><span class="op" id="7631243">]</span><span class="builtintype" id="7631244">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631250">var</span>&nbsp;<span class="ident" id="7631254">rcvd</span>&nbsp;<span class="builtintype" id="7631259">string</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631267">ct</span>&nbsp;<span class="op" id="7631270">:=</span>&nbsp;<span class="num" id="7631273">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631276">for</span>&nbsp;<span class="op" id="7631280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631284">var</span>&nbsp;<span class="ident" id="7631288">n</span>&nbsp;<span class="builtintype" id="7631290">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631296">var</span>&nbsp;<span class="ident" id="7631300">err</span>&nbsp;<span class="builtintype" id="7631304">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631313">c</span><span class="op" id="7631314">.</span><span class="ident" id="7631315">SetReadDeadline</span><span class="op" id="7631330">(</span><span class="ident" id="7631331">time</span><span class="op" id="7631335">.</span><span class="ident" id="7631336">Now</span><span class="op" id="7631339">(</span><span class="op" id="7631340">)</span><span class="op" id="7631341">.</span><span class="ident" id="7631342">Add</span><span class="op" id="7631345">(</span><span class="num" id="7631346">100</span>&nbsp;<span class="op" id="7631350">*</span>&nbsp;<span class="ident" id="7631352">time</span><span class="op" id="7631356">.</span><span class="ident" id="7631357">Millisecond</span><span class="op" id="7631368">)</span><span class="op" id="7631369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631373">n</span><span class="op" id="7631374">,</span>&nbsp;<span class="ident" id="7631376">_</span><span class="op" id="7631377">,</span>&nbsp;<span class="ident" id="7631379">err</span>&nbsp;<span class="op" id="7631383">=</span>&nbsp;<span class="ident" id="7631385">c</span><span class="op" id="7631386">.</span><span class="ident" id="7631387">ReadFrom</span><span class="op" id="7631395">(</span><span class="ident" id="7631396">buf</span><span class="op" id="7631399">[</span><span class="op" id="7631400">:</span><span class="op" id="7631401">]</span><span class="op" id="7631402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631406">rcvd</span>&nbsp;<span class="op" id="7631411">+=</span>&nbsp;<span class="builtintype" id="7631414">string</span><span class="op" id="7631420">(</span><span class="ident" id="7631421">buf</span><span class="op" id="7631424">[</span><span class="op" id="7631425">:</span><span class="ident" id="7631426">n</span><span class="op" id="7631427">]</span><span class="op" id="7631428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631432">if</span>&nbsp;<span class="ident" id="7631435">err</span>&nbsp;<span class="op" id="7631439">!=</span>&nbsp;<span class="ident" id="7631442">nil</span>&nbsp;<span class="op" id="7631446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631451">if</span>&nbsp;<span class="ident" id="7631454">oe</span><span class="op" id="7631456">,</span>&nbsp;<span class="ident" id="7631458">ok</span>&nbsp;<span class="op" id="7631461">:=</span>&nbsp;<span class="ident" id="7631464">err</span><span class="op" id="7631467">.</span><span class="op" id="7631468">(</span><span class="op" id="7631469">*</span><span class="ident" id="7631470">net</span><span class="op" id="7631473">.</span><span class="ident" id="7631474">OpError</span><span class="op" id="7631481">)</span><span class="op" id="7631482">;</span>&nbsp;<span class="ident" id="7631484">ok</span>&nbsp;<span class="op" id="7631487">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631493">if</span>&nbsp;<span class="ident" id="7631496">ct</span>&nbsp;<span class="op" id="7631499">&lt;</span>&nbsp;<span class="num" id="7631501">3</span>&nbsp;<span class="op" id="7631503">&amp;&amp;</span>&nbsp;<span class="ident" id="7631506">oe</span><span class="op" id="7631508">.</span><span class="ident" id="7631509">Temporary</span><span class="op" id="7631518">(</span><span class="op" id="7631519">)</span>&nbsp;<span class="op" id="7631521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631528">ct</span><span class="op" id="7631530">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631538">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631556">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631561">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631575">c</span><span class="op" id="7631576">.</span><span class="ident" id="7631577">Close</span><span class="op" id="7631582">(</span><span class="op" id="7631583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631586">done</span>&nbsp;<span class="op" id="7631591">&lt;-</span>&nbsp;<span class="ident" id="7631594">rcvd</span><br>
<span class="lineno">45</span><span class="op" id="7631599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7631602">var</span>&nbsp;<span class="ident" id="7631606">crashy</span>&nbsp;<span class="op" id="7631613">=</span>&nbsp;<span class="builtintype" id="7631615">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7631622">func</span>&nbsp;<span class="ident" id="7631627">runStreamSyslog</span><span class="op" id="7631642">(</span><span class="ident" id="7631643">l</span>&nbsp;<span class="ident" id="7631645">net</span><span class="op" id="7631648">.</span><span class="ident" id="7631649">Listener</span><span class="op" id="7631657">,</span>&nbsp;<span class="ident" id="7631659">done</span>&nbsp;<span class="keyword" id="7631664">chan</span><span class="op" id="7631668">&lt;-</span>&nbsp;<span class="builtintype" id="7631671">string</span><span class="op" id="7631677">,</span>&nbsp;<span class="ident" id="7631679">wg</span>&nbsp;<span class="op" id="7631682">*</span><span class="ident" id="7631683">sync</span><span class="op" id="7631687">.</span><span class="ident" id="7631688">WaitGroup</span><span class="op" id="7631697">)</span>&nbsp;<span class="op" id="7631699">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631702">for</span>&nbsp;<span class="op" id="7631706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631710">var</span>&nbsp;<span class="ident" id="7631714">c</span>&nbsp;<span class="ident" id="7631716">net</span><span class="op" id="7631719">.</span><span class="ident" id="7631720">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631727">var</span>&nbsp;<span class="ident" id="7631731">err</span>&nbsp;<span class="builtintype" id="7631735">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631743">if</span>&nbsp;<span class="ident" id="7631746">c</span><span class="op" id="7631747">,</span>&nbsp;<span class="ident" id="7631749">err</span>&nbsp;<span class="op" id="7631753">=</span>&nbsp;<span class="ident" id="7631755">l</span><span class="op" id="7631756">.</span><span class="ident" id="7631757">Accept</span><span class="op" id="7631763">(</span><span class="op" id="7631764">)</span><span class="op" id="7631765">;</span>&nbsp;<span class="ident" id="7631767">err</span>&nbsp;<span class="op" id="7631771">!=</span>&nbsp;<span class="ident" id="7631774">nil</span>&nbsp;<span class="op" id="7631778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631783">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631796">wg</span><span class="op" id="7631798">.</span><span class="ident" id="7631799">Add</span><span class="op" id="7631802">(</span><span class="num" id="7631803">1</span><span class="op" id="7631804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631808">go</span>&nbsp;<span class="keyword" id="7631811">func</span><span class="op" id="7631815">(</span><span class="ident" id="7631816">c</span>&nbsp;<span class="ident" id="7631818">net</span><span class="op" id="7631821">.</span><span class="ident" id="7631822">Conn</span><span class="op" id="7631826">)</span>&nbsp;<span class="op" id="7631828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631833">defer</span>&nbsp;<span class="ident" id="7631839">wg</span><span class="op" id="7631841">.</span><span class="ident" id="7631842">Done</span><span class="op" id="7631846">(</span><span class="op" id="7631847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631852">c</span><span class="op" id="7631853">.</span><span class="ident" id="7631854">SetReadDeadline</span><span class="op" id="7631869">(</span><span class="ident" id="7631870">time</span><span class="op" id="7631874">.</span><span class="ident" id="7631875">Now</span><span class="op" id="7631878">(</span><span class="op" id="7631879">)</span><span class="op" id="7631880">.</span><span class="ident" id="7631881">Add</span><span class="op" id="7631884">(</span><span class="num" id="7631885">5</span>&nbsp;<span class="op" id="7631887">*</span>&nbsp;<span class="ident" id="7631889">time</span><span class="op" id="7631893">.</span><span class="ident" id="7631894">Second</span><span class="op" id="7631900">)</span><span class="op" id="7631901">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631906">b</span>&nbsp;<span class="op" id="7631908">:=</span>&nbsp;<span class="ident" id="7631911">bufio</span><span class="op" id="7631916">.</span><span class="ident" id="7631917">NewReader</span><span class="op" id="7631926">(</span><span class="ident" id="7631927">c</span><span class="op" id="7631928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631933">for</span>&nbsp;<span class="ident" id="7631937">ct</span>&nbsp;<span class="op" id="7631940">:=</span>&nbsp;<span class="num" id="7631943">1</span><span class="op" id="7631944">;</span>&nbsp;<span class="op" id="7631946">!</span><span class="ident" id="7631947">crashy</span>&nbsp;<span class="op" id="7631954">||</span>&nbsp;<span class="ident" id="7631957">ct</span><span class="op" id="7631959">&amp;</span><span class="num" id="7631960">7</span>&nbsp;<span class="op" id="7631962">!=</span>&nbsp;<span class="num" id="7631965">0</span><span class="op" id="7631966">;</span>&nbsp;<span class="ident" id="7631968">ct</span><span class="op" id="7631970">++</span>&nbsp;<span class="op" id="7631973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631979">s</span><span class="op" id="7631980">,</span>&nbsp;<span class="ident" id="7631982">err</span>&nbsp;<span class="op" id="7631986">:=</span>&nbsp;<span class="ident" id="7631989">b</span><span class="op" id="7631990">.</span><span class="ident" id="7631991">ReadString</span><span class="op" id="7632001">(</span><span class="string" id="7632002">&#39;\n&#39;</span><span class="op" id="7632006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632012">if</span>&nbsp;<span class="ident" id="7632015">err</span>&nbsp;<span class="op" id="7632019">!=</span>&nbsp;<span class="ident" id="7632022">nil</span>&nbsp;<span class="op" id="7632026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632033">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632049">done</span>&nbsp;<span class="op" id="7632054">&lt;-</span>&nbsp;<span class="ident" id="7632057">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632067">c</span><span class="op" id="7632068">.</span><span class="ident" id="7632069">Close</span><span class="op" id="7632074">(</span><span class="op" id="7632075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632079">}</span><span class="op" id="7632080">(</span><span class="ident" id="7632081">c</span><span class="op" id="7632082">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632085">}</span><br>
<span class="lineno"></span><span class="op" id="7632087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7632090">func</span>&nbsp;<span class="ident" id="7632095">startServer</span><span class="op" id="7632106">(</span><span class="ident" id="7632107">n</span><span class="op" id="7632108">,</span>&nbsp;<span class="ident" id="7632110">la</span>&nbsp;<span class="builtintype" id="7632113">string</span><span class="op" id="7632119">,</span>&nbsp;<span class="ident" id="7632121">done</span>&nbsp;<span class="keyword" id="7632126">chan</span><span class="op" id="7632130">&lt;-</span>&nbsp;<span class="builtintype" id="7632133">string</span><span class="op" id="7632139">)</span>&nbsp;<span class="op" id="7632141">(</span><span class="ident" id="7632142">addr</span>&nbsp;<span class="builtintype" id="7632147">string</span><span class="op" id="7632153">,</span>&nbsp;<span class="ident" id="7632155">sock</span>&nbsp;<span class="ident" id="7632160">io</span><span class="op" id="7632162">.</span><span class="ident" id="7632163">Closer</span><span class="op" id="7632169">,</span>&nbsp;<span class="ident" id="7632171">wg</span>&nbsp;<span class="op" id="7632174">*</span><span class="ident" id="7632175">sync</span><span class="op" id="7632179">.</span><span class="ident" id="7632180">WaitGroup</span><span class="op" id="7632189">)</span>&nbsp;<span class="op" id="7632191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632194">if</span>&nbsp;<span class="ident" id="7632197">n</span>&nbsp;<span class="op" id="7632199">==</span>&nbsp;<span class="string" id="7632202">&#34;udp&#34;</span>&nbsp;<span class="op" id="7632208">||</span>&nbsp;<span class="ident" id="7632211">n</span>&nbsp;<span class="op" id="7632213">==</span>&nbsp;<span class="string" id="7632216">&#34;tcp&#34;</span>&nbsp;<span class="op" id="7632222">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632226">la</span>&nbsp;<span class="op" id="7632229">=</span>&nbsp;<span class="string" id="7632231">&#34;127.0.0.1:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632246">}</span>&nbsp;<span class="keyword" id="7632248">else</span>&nbsp;<span class="op" id="7632253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7632257">//&nbsp;unix&nbsp;and&nbsp;unixgram:&nbsp;choose&nbsp;an&nbsp;address&nbsp;if&nbsp;none&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632313">if</span>&nbsp;<span class="ident" id="7632316">la</span>&nbsp;<span class="op" id="7632319">==</span>&nbsp;<span class="string" id="7632322">&#34;&#34;</span>&nbsp;<span class="op" id="7632325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7632330">//&nbsp;use&nbsp;ioutil.TempFile&nbsp;to&nbsp;get&nbsp;a&nbsp;name&nbsp;that&nbsp;is&nbsp;unique</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632385">f</span><span class="op" id="7632386">,</span>&nbsp;<span class="ident" id="7632388">err</span>&nbsp;<span class="op" id="7632392">:=</span>&nbsp;<span class="ident" id="7632395">ioutil</span><span class="op" id="7632401">.</span><span class="ident" id="7632402">TempFile</span><span class="op" id="7632410">(</span><span class="string" id="7632411">&#34;&#34;</span><span class="op" id="7632413">,</span>&nbsp;<span class="string" id="7632415">&#34;syslogtest&#34;</span><span class="op" id="7632427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632432">if</span>&nbsp;<span class="ident" id="7632435">err</span>&nbsp;<span class="op" id="7632439">!=</span>&nbsp;<span class="ident" id="7632442">nil</span>&nbsp;<span class="op" id="7632446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632452">log</span><span class="op" id="7632455">.</span><span class="ident" id="7632456">Fatal</span><span class="op" id="7632461">(</span><span class="string" id="7632462">&#34;TempFile:&nbsp;&#34;</span><span class="op" id="7632474">,</span>&nbsp;<span class="ident" id="7632476">err</span><span class="op" id="7632479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632489">f</span><span class="op" id="7632490">.</span><span class="ident" id="7632491">Close</span><span class="op" id="7632496">(</span><span class="op" id="7632497">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632502">la</span>&nbsp;<span class="op" id="7632505">=</span>&nbsp;<span class="ident" id="7632507">f</span><span class="op" id="7632508">.</span><span class="ident" id="7632509">Name</span><span class="op" id="7632513">(</span><span class="op" id="7632514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632522">os</span><span class="op" id="7632524">.</span><span class="ident" id="7632525">Remove</span><span class="op" id="7632531">(</span><span class="ident" id="7632532">la</span><span class="op" id="7632534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632541">wg</span>&nbsp;<span class="op" id="7632544">=</span>&nbsp;<span class="builtinfunc" id="7632546">new</span><span class="op" id="7632549">(</span><span class="ident" id="7632550">sync</span><span class="op" id="7632554">.</span><span class="ident" id="7632555">WaitGroup</span><span class="op" id="7632564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632567">if</span>&nbsp;<span class="ident" id="7632570">n</span>&nbsp;<span class="op" id="7632572">==</span>&nbsp;<span class="string" id="7632575">&#34;udp&#34;</span>&nbsp;<span class="op" id="7632581">||</span>&nbsp;<span class="ident" id="7632584">n</span>&nbsp;<span class="op" id="7632586">==</span>&nbsp;<span class="string" id="7632589">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7632600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632604">l</span><span class="op" id="7632605">,</span>&nbsp;<span class="ident" id="7632607">e</span>&nbsp;<span class="op" id="7632609">:=</span>&nbsp;<span class="ident" id="7632612">net</span><span class="op" id="7632615">.</span><span class="ident" id="7632616">ListenPacket</span><span class="op" id="7632628">(</span><span class="ident" id="7632629">n</span><span class="op" id="7632630">,</span>&nbsp;<span class="ident" id="7632632">la</span><span class="op" id="7632634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632638">if</span>&nbsp;<span class="ident" id="7632641">e</span>&nbsp;<span class="op" id="7632643">!=</span>&nbsp;<span class="ident" id="7632646">nil</span>&nbsp;<span class="op" id="7632650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632655">log</span><span class="op" id="7632658">.</span><span class="ident" id="7632659">Fatalf</span><span class="op" id="7632665">(</span><span class="string" id="7632666">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7632690">,</span>&nbsp;<span class="ident" id="7632692">e</span><span class="op" id="7632693">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632701">addr</span>&nbsp;<span class="op" id="7632706">=</span>&nbsp;<span class="ident" id="7632708">l</span><span class="op" id="7632709">.</span><span class="ident" id="7632710">LocalAddr</span><span class="op" id="7632719">(</span><span class="op" id="7632720">)</span><span class="op" id="7632721">.</span><span class="ident" id="7632722">String</span><span class="op" id="7632728">(</span><span class="op" id="7632729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632733">sock</span>&nbsp;<span class="op" id="7632738">=</span>&nbsp;<span class="ident" id="7632740">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632744">wg</span><span class="op" id="7632746">.</span><span class="ident" id="7632747">Add</span><span class="op" id="7632750">(</span><span class="num" id="7632751">1</span><span class="op" id="7632752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632756">go</span>&nbsp;<span class="keyword" id="7632759">func</span><span class="op" id="7632763">(</span><span class="op" id="7632764">)</span>&nbsp;<span class="op" id="7632766">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632771">defer</span>&nbsp;<span class="ident" id="7632777">wg</span><span class="op" id="7632779">.</span><span class="ident" id="7632780">Done</span><span class="op" id="7632784">(</span><span class="op" id="7632785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632790">runPktSyslog</span><span class="op" id="7632802">(</span><span class="ident" id="7632803">l</span><span class="op" id="7632804">,</span>&nbsp;<span class="ident" id="7632806">done</span><span class="op" id="7632810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632814">}</span><span class="op" id="7632815">(</span><span class="op" id="7632816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632819">}</span>&nbsp;<span class="keyword" id="7632821">else</span>&nbsp;<span class="op" id="7632826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632830">l</span><span class="op" id="7632831">,</span>&nbsp;<span class="ident" id="7632833">e</span>&nbsp;<span class="op" id="7632835">:=</span>&nbsp;<span class="ident" id="7632838">net</span><span class="op" id="7632841">.</span><span class="ident" id="7632842">Listen</span><span class="op" id="7632848">(</span><span class="ident" id="7632849">n</span><span class="op" id="7632850">,</span>&nbsp;<span class="ident" id="7632852">la</span><span class="op" id="7632854">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632858">if</span>&nbsp;<span class="ident" id="7632861">e</span>&nbsp;<span class="op" id="7632863">!=</span>&nbsp;<span class="ident" id="7632866">nil</span>&nbsp;<span class="op" id="7632870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632875">log</span><span class="op" id="7632878">.</span><span class="ident" id="7632879">Fatalf</span><span class="op" id="7632885">(</span><span class="string" id="7632886">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7632910">,</span>&nbsp;<span class="ident" id="7632912">e</span><span class="op" id="7632913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632921">addr</span>&nbsp;<span class="op" id="7632926">=</span>&nbsp;<span class="ident" id="7632928">l</span><span class="op" id="7632929">.</span><span class="ident" id="7632930">Addr</span><span class="op" id="7632934">(</span><span class="op" id="7632935">)</span><span class="op" id="7632936">.</span><span class="ident" id="7632937">String</span><span class="op" id="7632943">(</span><span class="op" id="7632944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632948">sock</span>&nbsp;<span class="op" id="7632953">=</span>&nbsp;<span class="ident" id="7632955">l</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632959">wg</span><span class="op" id="7632961">.</span><span class="ident" id="7632962">Add</span><span class="op" id="7632965">(</span><span class="num" id="7632966">1</span><span class="op" id="7632967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632971">go</span>&nbsp;<span class="keyword" id="7632974">func</span><span class="op" id="7632978">(</span><span class="op" id="7632979">)</span>&nbsp;<span class="op" id="7632981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632986">defer</span>&nbsp;<span class="ident" id="7632992">wg</span><span class="op" id="7632994">.</span><span class="ident" id="7632995">Done</span><span class="op" id="7632999">(</span><span class="op" id="7633000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633005">runStreamSyslog</span><span class="op" id="7633020">(</span><span class="ident" id="7633021">l</span><span class="op" id="7633022">,</span>&nbsp;<span class="ident" id="7633024">done</span><span class="op" id="7633028">,</span>&nbsp;<span class="ident" id="7633030">wg</span><span class="op" id="7633032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633036">}</span><span class="op" id="7633037">(</span><span class="op" id="7633038">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633044">return</span><br>
<span class="lineno"></span><span class="op" id="7633051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7633054">func</span>&nbsp;<span class="ident" id="7633059">TestWithSimulated</span><span class="op" id="7633076">(</span><span class="ident" id="7633077">t</span>&nbsp;<span class="op" id="7633079">*</span><span class="ident" id="7633080">testing</span><span class="op" id="7633087">.</span><span class="ident" id="7633088">T</span><span class="op" id="7633089">)</span>&nbsp;<span class="op" id="7633091">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633094">msg</span>&nbsp;<span class="op" id="7633098">:=</span>&nbsp;<span class="string" id="7633101">&#34;Test&nbsp;123&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633113">transport</span>&nbsp;<span class="op" id="7633123">:=</span>&nbsp;<span class="op" id="7633126">[</span><span class="op" id="7633127">]</span><span class="builtintype" id="7633128">string</span><span class="op" id="7633134">{</span><span class="string" id="7633135">&#34;unix&#34;</span><span class="op" id="7633141">,</span>&nbsp;<span class="string" id="7633143">&#34;unixgram&#34;</span><span class="op" id="7633153">,</span>&nbsp;<span class="string" id="7633155">&#34;udp&#34;</span><span class="op" id="7633160">,</span>&nbsp;<span class="string" id="7633162">&#34;tcp&#34;</span><span class="op" id="7633167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633171">for</span>&nbsp;<span class="ident" id="7633175">_</span><span class="op" id="7633176">,</span>&nbsp;<span class="ident" id="7633178">tr</span>&nbsp;<span class="op" id="7633181">:=</span>&nbsp;<span class="keyword" id="7633184">range</span>&nbsp;<span class="ident" id="7633190">transport</span>&nbsp;<span class="op" id="7633200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633204">done</span>&nbsp;<span class="op" id="7633209">:=</span>&nbsp;<span class="builtinfunc" id="7633212">make</span><span class="op" id="7633216">(</span><span class="keyword" id="7633217">chan</span>&nbsp;<span class="builtintype" id="7633222">string</span><span class="op" id="7633228">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633232">addr</span><span class="op" id="7633236">,</span>&nbsp;<span class="ident" id="7633238">sock</span><span class="op" id="7633242">,</span>&nbsp;<span class="ident" id="7633244">srvWG</span>&nbsp;<span class="op" id="7633250">:=</span>&nbsp;<span class="ident" id="7633253">startServer</span><span class="op" id="7633264">(</span><span class="ident" id="7633265">tr</span><span class="op" id="7633267">,</span>&nbsp;<span class="string" id="7633269">&#34;&#34;</span><span class="op" id="7633271">,</span>&nbsp;<span class="ident" id="7633273">done</span><span class="op" id="7633277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633281">defer</span>&nbsp;<span class="ident" id="7633287">srvWG</span><span class="op" id="7633292">.</span><span class="ident" id="7633293">Wait</span><span class="op" id="7633297">(</span><span class="op" id="7633298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633302">defer</span>&nbsp;<span class="ident" id="7633308">sock</span><span class="op" id="7633312">.</span><span class="ident" id="7633313">Close</span><span class="op" id="7633318">(</span><span class="op" id="7633319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633323">if</span>&nbsp;<span class="ident" id="7633326">tr</span>&nbsp;<span class="op" id="7633329">==</span>&nbsp;<span class="string" id="7633332">&#34;unix&#34;</span>&nbsp;<span class="op" id="7633339">||</span>&nbsp;<span class="ident" id="7633342">tr</span>&nbsp;<span class="op" id="7633345">==</span>&nbsp;<span class="string" id="7633348">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7633359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633364">defer</span>&nbsp;<span class="ident" id="7633370">os</span><span class="op" id="7633372">.</span><span class="ident" id="7633373">Remove</span><span class="op" id="7633379">(</span><span class="ident" id="7633380">addr</span><span class="op" id="7633384">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633392">s</span><span class="op" id="7633393">,</span>&nbsp;<span class="ident" id="7633395">err</span>&nbsp;<span class="op" id="7633399">:=</span>&nbsp;<span class="ident" id="7633402">Dial</span><span class="op" id="7633406">(</span><span class="ident" id="7633407">tr</span><span class="op" id="7633409">,</span>&nbsp;<span class="ident" id="7633411">addr</span><span class="op" id="7633415">,</span>&nbsp;<span class="ident" id="7633417">LOG_INFO</span><span class="op" id="7633425">|</span><span class="ident" id="7633426">LOG_USER</span><span class="op" id="7633434">,</span>&nbsp;<span class="string" id="7633436">&#34;syslog_test&#34;</span><span class="op" id="7633449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633453">if</span>&nbsp;<span class="ident" id="7633456">err</span>&nbsp;<span class="op" id="7633460">!=</span>&nbsp;<span class="ident" id="7633463">nil</span>&nbsp;<span class="op" id="7633467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633472">t</span><span class="op" id="7633473">.</span><span class="ident" id="7633474">Fatalf</span><span class="op" id="7633480">(</span><span class="string" id="7633481">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7633500">,</span>&nbsp;<span class="ident" id="7633502">err</span><span class="op" id="7633505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633509">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633513">err</span>&nbsp;<span class="op" id="7633517">=</span>&nbsp;<span class="ident" id="7633519">s</span><span class="op" id="7633520">.</span><span class="ident" id="7633521">Info</span><span class="op" id="7633525">(</span><span class="ident" id="7633526">msg</span><span class="op" id="7633529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633533">if</span>&nbsp;<span class="ident" id="7633536">err</span>&nbsp;<span class="op" id="7633540">!=</span>&nbsp;<span class="ident" id="7633543">nil</span>&nbsp;<span class="op" id="7633547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633552">t</span><span class="op" id="7633553">.</span><span class="ident" id="7633554">Fatalf</span><span class="op" id="7633560">(</span><span class="string" id="7633561">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7633577">,</span>&nbsp;<span class="ident" id="7633579">err</span><span class="op" id="7633582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633590">check</span><span class="op" id="7633595">(</span><span class="ident" id="7633596">t</span><span class="op" id="7633597">,</span>&nbsp;<span class="ident" id="7633599">msg</span><span class="op" id="7633602">,</span>&nbsp;<span class="op" id="7633604">&lt;-</span><span class="ident" id="7633606">done</span><span class="op" id="7633610">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633614">s</span><span class="op" id="7633615">.</span><span class="ident" id="7633616">Close</span><span class="op" id="7633621">(</span><span class="op" id="7633622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633625">}</span><br>
<span class="lineno"></span><span class="op" id="7633627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7633630">func</span>&nbsp;<span class="ident" id="7633635">TestFlap</span><span class="op" id="7633643">(</span><span class="ident" id="7633644">t</span>&nbsp;<span class="op" id="7633646">*</span><span class="ident" id="7633647">testing</span><span class="op" id="7633654">.</span><span class="ident" id="7633655">T</span><span class="op" id="7633656">)</span>&nbsp;<span class="op" id="7633658">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633661">net</span>&nbsp;<span class="op" id="7633665">:=</span>&nbsp;<span class="string" id="7633668">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633676">done</span>&nbsp;<span class="op" id="7633681">:=</span>&nbsp;<span class="builtinfunc" id="7633684">make</span><span class="op" id="7633688">(</span><span class="keyword" id="7633689">chan</span>&nbsp;<span class="builtintype" id="7633694">string</span><span class="op" id="7633700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633703">addr</span><span class="op" id="7633707">,</span>&nbsp;<span class="ident" id="7633709">sock</span><span class="op" id="7633713">,</span>&nbsp;<span class="ident" id="7633715">srvWG</span>&nbsp;<span class="op" id="7633721">:=</span>&nbsp;<span class="ident" id="7633724">startServer</span><span class="op" id="7633735">(</span><span class="ident" id="7633736">net</span><span class="op" id="7633739">,</span>&nbsp;<span class="string" id="7633741">&#34;&#34;</span><span class="op" id="7633743">,</span>&nbsp;<span class="ident" id="7633745">done</span><span class="op" id="7633749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633752">defer</span>&nbsp;<span class="ident" id="7633758">srvWG</span><span class="op" id="7633763">.</span><span class="ident" id="7633764">Wait</span><span class="op" id="7633768">(</span><span class="op" id="7633769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633772">defer</span>&nbsp;<span class="ident" id="7633778">os</span><span class="op" id="7633780">.</span><span class="ident" id="7633781">Remove</span><span class="op" id="7633787">(</span><span class="ident" id="7633788">addr</span><span class="op" id="7633792">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633795">defer</span>&nbsp;<span class="ident" id="7633801">sock</span><span class="op" id="7633805">.</span><span class="ident" id="7633806">Close</span><span class="op" id="7633811">(</span><span class="op" id="7633812">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633816">s</span><span class="op" id="7633817">,</span>&nbsp;<span class="ident" id="7633819">err</span>&nbsp;<span class="op" id="7633823">:=</span>&nbsp;<span class="ident" id="7633826">Dial</span><span class="op" id="7633830">(</span><span class="ident" id="7633831">net</span><span class="op" id="7633834">,</span>&nbsp;<span class="ident" id="7633836">addr</span><span class="op" id="7633840">,</span>&nbsp;<span class="ident" id="7633842">LOG_INFO</span><span class="op" id="7633850">|</span><span class="ident" id="7633851">LOG_USER</span><span class="op" id="7633859">,</span>&nbsp;<span class="string" id="7633861">&#34;syslog_test&#34;</span><span class="op" id="7633874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633877">if</span>&nbsp;<span class="ident" id="7633880">err</span>&nbsp;<span class="op" id="7633884">!=</span>&nbsp;<span class="ident" id="7633887">nil</span>&nbsp;<span class="op" id="7633891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633895">t</span><span class="op" id="7633896">.</span><span class="ident" id="7633897">Fatalf</span><span class="op" id="7633903">(</span><span class="string" id="7633904">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7633923">,</span>&nbsp;<span class="ident" id="7633925">err</span><span class="op" id="7633928">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633934">msg</span>&nbsp;<span class="op" id="7633938">:=</span>&nbsp;<span class="string" id="7633941">&#34;Moo&nbsp;2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633950">err</span>&nbsp;<span class="op" id="7633954">=</span>&nbsp;<span class="ident" id="7633956">s</span><span class="op" id="7633957">.</span><span class="ident" id="7633958">Info</span><span class="op" id="7633962">(</span><span class="ident" id="7633963">msg</span><span class="op" id="7633966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633969">if</span>&nbsp;<span class="ident" id="7633972">err</span>&nbsp;<span class="op" id="7633976">!=</span>&nbsp;<span class="ident" id="7633979">nil</span>&nbsp;<span class="op" id="7633983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633987">t</span><span class="op" id="7633988">.</span><span class="ident" id="7633989">Fatalf</span><span class="op" id="7633995">(</span><span class="string" id="7633996">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7634012">,</span>&nbsp;<span class="ident" id="7634014">err</span><span class="op" id="7634017">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634023">check</span><span class="op" id="7634028">(</span><span class="ident" id="7634029">t</span><span class="op" id="7634030">,</span>&nbsp;<span class="ident" id="7634032">msg</span><span class="op" id="7634035">,</span>&nbsp;<span class="op" id="7634037">&lt;-</span><span class="ident" id="7634039">done</span><span class="op" id="7634043">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7634047">//&nbsp;restart&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634070">_</span><span class="op" id="7634071">,</span>&nbsp;<span class="ident" id="7634073">sock2</span><span class="op" id="7634078">,</span>&nbsp;<span class="ident" id="7634080">srvWG2</span>&nbsp;<span class="op" id="7634087">:=</span>&nbsp;<span class="ident" id="7634090">startServer</span><span class="op" id="7634101">(</span><span class="ident" id="7634102">net</span><span class="op" id="7634105">,</span>&nbsp;<span class="ident" id="7634107">addr</span><span class="op" id="7634111">,</span>&nbsp;<span class="ident" id="7634113">done</span><span class="op" id="7634117">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634120">defer</span>&nbsp;<span class="ident" id="7634126">srvWG2</span><span class="op" id="7634132">.</span><span class="ident" id="7634133">Wait</span><span class="op" id="7634137">(</span><span class="op" id="7634138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634141">defer</span>&nbsp;<span class="ident" id="7634147">sock2</span><span class="op" id="7634152">.</span><span class="ident" id="7634153">Close</span><span class="op" id="7634158">(</span><span class="op" id="7634159">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7634163">//&nbsp;and&nbsp;try&nbsp;retransmitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634190">msg</span>&nbsp;<span class="op" id="7634194">=</span>&nbsp;<span class="string" id="7634196">&#34;Moo&nbsp;3&#34;</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634205">err</span>&nbsp;<span class="op" id="7634209">=</span>&nbsp;<span class="ident" id="7634211">s</span><span class="op" id="7634212">.</span><span class="ident" id="7634213">Info</span><span class="op" id="7634217">(</span><span class="ident" id="7634218">msg</span><span class="op" id="7634221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634224">if</span>&nbsp;<span class="ident" id="7634227">err</span>&nbsp;<span class="op" id="7634231">!=</span>&nbsp;<span class="ident" id="7634234">nil</span>&nbsp;<span class="op" id="7634238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634242">t</span><span class="op" id="7634243">.</span><span class="ident" id="7634244">Fatalf</span><span class="op" id="7634250">(</span><span class="string" id="7634251">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7634267">,</span>&nbsp;<span class="ident" id="7634269">err</span><span class="op" id="7634272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634278">check</span><span class="op" id="7634283">(</span><span class="ident" id="7634284">t</span><span class="op" id="7634285">,</span>&nbsp;<span class="ident" id="7634287">msg</span><span class="op" id="7634290">,</span>&nbsp;<span class="op" id="7634292">&lt;-</span><span class="ident" id="7634294">done</span><span class="op" id="7634298">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634302">s</span><span class="op" id="7634303">.</span><span class="ident" id="7634304">Close</span><span class="op" id="7634309">(</span><span class="op" id="7634310">)</span><br>
<span class="lineno"></span><span class="op" id="7634312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7634315">func</span>&nbsp;<span class="ident" id="7634320">TestNew</span><span class="op" id="7634327">(</span><span class="ident" id="7634328">t</span>&nbsp;<span class="op" id="7634330">*</span><span class="ident" id="7634331">testing</span><span class="op" id="7634338">.</span><span class="ident" id="7634339">T</span><span class="op" id="7634340">)</span>&nbsp;<span class="op" id="7634342">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634345">if</span>&nbsp;<span class="ident" id="7634348">LOG_LOCAL7</span>&nbsp;<span class="op" id="7634359">!=</span>&nbsp;<span class="num" id="7634362">23</span><span class="op" id="7634364">&lt;&lt;</span><span class="num" id="7634366">3</span>&nbsp;<span class="op" id="7634368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634372">t</span><span class="op" id="7634373">.</span><span class="ident" id="7634374">Fatalf</span><span class="op" id="7634380">(</span><span class="string" id="7634381">&#34;LOG_LOCAL7&nbsp;has&nbsp;wrong&nbsp;value&#34;</span><span class="op" id="7634409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634415">if</span>&nbsp;<span class="ident" id="7634418">testing</span><span class="op" id="7634425">.</span><span class="ident" id="7634426">Short</span><span class="op" id="7634431">(</span><span class="op" id="7634432">)</span>&nbsp;<span class="op" id="7634434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7634438">//&nbsp;Depends&nbsp;on&nbsp;syslog&nbsp;daemon&nbsp;running,&nbsp;and&nbsp;sometimes&nbsp;it&#39;s&nbsp;not.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634501">t</span><span class="op" id="7634502">.</span><span class="ident" id="7634503">Skip</span><span class="op" id="7634507">(</span><span class="string" id="7634508">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7634544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634551">s</span><span class="op" id="7634552">,</span>&nbsp;<span class="ident" id="7634554">err</span>&nbsp;<span class="op" id="7634558">:=</span>&nbsp;<span class="ident" id="7634561">New</span><span class="op" id="7634564">(</span><span class="ident" id="7634565">LOG_INFO</span><span class="op" id="7634573">|</span><span class="ident" id="7634574">LOG_USER</span><span class="op" id="7634582">,</span>&nbsp;<span class="string" id="7634584">&#34;the_tag&#34;</span><span class="op" id="7634593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634596">if</span>&nbsp;<span class="ident" id="7634599">err</span>&nbsp;<span class="op" id="7634603">!=</span>&nbsp;<span class="ident" id="7634606">nil</span>&nbsp;<span class="op" id="7634610">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634614">t</span><span class="op" id="7634615">.</span><span class="ident" id="7634616">Fatalf</span><span class="op" id="7634622">(</span><span class="string" id="7634623">&#34;New()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7634641">,</span>&nbsp;<span class="ident" id="7634643">err</span><span class="op" id="7634646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7634652">//&nbsp;Don&#39;t&nbsp;send&nbsp;any&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634681">s</span><span class="op" id="7634682">.</span><span class="ident" id="7634683">Close</span><span class="op" id="7634688">(</span><span class="op" id="7634689">)</span><br>
<span class="lineno"></span><span class="op" id="7634691">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="7634694">func</span>&nbsp;<span class="ident" id="7634699">TestNewLogger</span><span class="op" id="7634712">(</span><span class="ident" id="7634713">t</span>&nbsp;<span class="op" id="7634715">*</span><span class="ident" id="7634716">testing</span><span class="op" id="7634723">.</span><span class="ident" id="7634724">T</span><span class="op" id="7634725">)</span>&nbsp;<span class="op" id="7634727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634730">if</span>&nbsp;<span class="ident" id="7634733">testing</span><span class="op" id="7634740">.</span><span class="ident" id="7634741">Short</span><span class="op" id="7634746">(</span><span class="op" id="7634747">)</span>&nbsp;<span class="op" id="7634749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634753">t</span><span class="op" id="7634754">.</span><span class="ident" id="7634755">Skip</span><span class="op" id="7634759">(</span><span class="string" id="7634760">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7634796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634799">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634802">f</span><span class="op" id="7634803">,</span>&nbsp;<span class="ident" id="7634805">err</span>&nbsp;<span class="op" id="7634809">:=</span>&nbsp;<span class="ident" id="7634812">NewLogger</span><span class="op" id="7634821">(</span><span class="ident" id="7634822">LOG_USER</span><span class="op" id="7634830">|</span><span class="ident" id="7634831">LOG_INFO</span><span class="op" id="7634839">,</span>&nbsp;<span class="num" id="7634841">0</span><span class="op" id="7634842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634845">if</span>&nbsp;<span class="ident" id="7634848">f</span>&nbsp;<span class="op" id="7634850">==</span>&nbsp;<span class="ident" id="7634853">nil</span>&nbsp;<span class="op" id="7634857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634861">t</span><span class="op" id="7634862">.</span><span class="ident" id="7634863">Error</span><span class="op" id="7634868">(</span><span class="ident" id="7634869">err</span><span class="op" id="7634872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634875">}</span><br>
<span class="lineno"></span><span class="op" id="7634877">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="7634880">func</span>&nbsp;<span class="ident" id="7634885">TestDial</span><span class="op" id="7634893">(</span><span class="ident" id="7634894">t</span>&nbsp;<span class="op" id="7634896">*</span><span class="ident" id="7634897">testing</span><span class="op" id="7634904">.</span><span class="ident" id="7634905">T</span><span class="op" id="7634906">)</span>&nbsp;<span class="op" id="7634908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634911">if</span>&nbsp;<span class="ident" id="7634914">testing</span><span class="op" id="7634921">.</span><span class="ident" id="7634922">Short</span><span class="op" id="7634927">(</span><span class="op" id="7634928">)</span>&nbsp;<span class="op" id="7634930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634934">t</span><span class="op" id="7634935">.</span><span class="ident" id="7634936">Skip</span><span class="op" id="7634940">(</span><span class="string" id="7634941">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7634977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634980">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634983">f</span><span class="op" id="7634984">,</span>&nbsp;<span class="ident" id="7634986">err</span>&nbsp;<span class="op" id="7634990">:=</span>&nbsp;<span class="ident" id="7634993">Dial</span><span class="op" id="7634997">(</span><span class="string" id="7634998">&#34;&#34;</span><span class="op" id="7635000">,</span>&nbsp;<span class="string" id="7635002">&#34;&#34;</span><span class="op" id="7635004">,</span>&nbsp;<span class="op" id="7635006">(</span><span class="ident" id="7635007">LOG_LOCAL7</span><span class="op" id="7635017">|</span><span class="ident" id="7635018">LOG_DEBUG</span><span class="op" id="7635027">)</span><span class="op" id="7635028">+</span><span class="num" id="7635029">1</span><span class="op" id="7635030">,</span>&nbsp;<span class="string" id="7635032">&#34;syslog_test&#34;</span><span class="op" id="7635045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635048">if</span>&nbsp;<span class="ident" id="7635051">f</span>&nbsp;<span class="op" id="7635053">!=</span>&nbsp;<span class="ident" id="7635056">nil</span>&nbsp;<span class="op" id="7635060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635064">t</span><span class="op" id="7635065">.</span><span class="ident" id="7635066">Fatalf</span><span class="op" id="7635072">(</span><span class="string" id="7635073">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7635107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635113">f</span><span class="op" id="7635114">,</span>&nbsp;<span class="ident" id="7635116">err</span>&nbsp;<span class="op" id="7635120">=</span>&nbsp;<span class="ident" id="7635122">Dial</span><span class="op" id="7635126">(</span><span class="string" id="7635127">&#34;&#34;</span><span class="op" id="7635129">,</span>&nbsp;<span class="string" id="7635131">&#34;&#34;</span><span class="op" id="7635133">,</span>&nbsp;<span class="op" id="7635135">-</span><span class="num" id="7635136">1</span><span class="op" id="7635137">,</span>&nbsp;<span class="string" id="7635139">&#34;syslog_test&#34;</span><span class="op" id="7635152">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635155">if</span>&nbsp;<span class="ident" id="7635158">f</span>&nbsp;<span class="op" id="7635160">!=</span>&nbsp;<span class="ident" id="7635163">nil</span>&nbsp;<span class="op" id="7635167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635171">t</span><span class="op" id="7635172">.</span><span class="ident" id="7635173">Fatalf</span><span class="op" id="7635179">(</span><span class="string" id="7635180">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7635214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635220">l</span><span class="op" id="7635221">,</span>&nbsp;<span class="ident" id="7635223">err</span>&nbsp;<span class="op" id="7635227">:=</span>&nbsp;<span class="ident" id="7635230">Dial</span><span class="op" id="7635234">(</span><span class="string" id="7635235">&#34;&#34;</span><span class="op" id="7635237">,</span>&nbsp;<span class="string" id="7635239">&#34;&#34;</span><span class="op" id="7635241">,</span>&nbsp;<span class="ident" id="7635243">LOG_USER</span><span class="op" id="7635251">|</span><span class="ident" id="7635252">LOG_ERR</span><span class="op" id="7635259">,</span>&nbsp;<span class="string" id="7635261">&#34;syslog_test&#34;</span><span class="op" id="7635274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635277">if</span>&nbsp;<span class="ident" id="7635280">err</span>&nbsp;<span class="op" id="7635284">!=</span>&nbsp;<span class="ident" id="7635287">nil</span>&nbsp;<span class="op" id="7635291">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635295">t</span><span class="op" id="7635296">.</span><span class="ident" id="7635297">Fatalf</span><span class="op" id="7635303">(</span><span class="string" id="7635304">&#34;Dial()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7635323">,</span>&nbsp;<span class="ident" id="7635325">err</span><span class="op" id="7635328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635334">l</span><span class="op" id="7635335">.</span><span class="ident" id="7635336">Close</span><span class="op" id="7635341">(</span><span class="op" id="7635342">)</span><br>
<span class="lineno"></span><span class="op" id="7635344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="7635347">func</span>&nbsp;<span class="ident" id="7635352">check</span><span class="op" id="7635357">(</span><span class="ident" id="7635358">t</span>&nbsp;<span class="op" id="7635360">*</span><span class="ident" id="7635361">testing</span><span class="op" id="7635368">.</span><span class="ident" id="7635369">T</span><span class="op" id="7635370">,</span>&nbsp;<span class="ident" id="7635372">in</span><span class="op" id="7635374">,</span>&nbsp;<span class="ident" id="7635376">out</span>&nbsp;<span class="builtintype" id="7635380">string</span><span class="op" id="7635386">)</span>&nbsp;<span class="op" id="7635388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635391">tmpl</span>&nbsp;<span class="op" id="7635396">:=</span>&nbsp;<span class="ident" id="7635399">fmt</span><span class="op" id="7635402">.</span><span class="ident" id="7635403">Sprintf</span><span class="op" id="7635410">(</span><span class="string" id="7635411">&#34;&lt;%d&gt;%%s&nbsp;%%s&nbsp;syslog_test[%%d]:&nbsp;%s\n&#34;</span><span class="op" id="7635447">,</span>&nbsp;<span class="ident" id="7635449">LOG_USER</span><span class="op" id="7635457">+</span><span class="ident" id="7635458">LOG_INFO</span><span class="op" id="7635466">,</span>&nbsp;<span class="ident" id="7635468">in</span><span class="op" id="7635470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635473">if</span>&nbsp;<span class="ident" id="7635476">hostname</span><span class="op" id="7635484">,</span>&nbsp;<span class="ident" id="7635486">err</span>&nbsp;<span class="op" id="7635490">:=</span>&nbsp;<span class="ident" id="7635493">os</span><span class="op" id="7635495">.</span><span class="ident" id="7635496">Hostname</span><span class="op" id="7635504">(</span><span class="op" id="7635505">)</span><span class="op" id="7635506">;</span>&nbsp;<span class="ident" id="7635508">err</span>&nbsp;<span class="op" id="7635512">!=</span>&nbsp;<span class="ident" id="7635515">nil</span>&nbsp;<span class="op" id="7635519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635523">t</span><span class="op" id="7635524">.</span><span class="ident" id="7635525">Error</span><span class="op" id="7635530">(</span><span class="string" id="7635531">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7635558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635561">}</span>&nbsp;<span class="keyword" id="7635563">else</span>&nbsp;<span class="op" id="7635568">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635572">var</span>&nbsp;<span class="ident" id="7635576">parsedHostname</span><span class="op" id="7635590">,</span>&nbsp;<span class="ident" id="7635592">timestamp</span>&nbsp;<span class="builtintype" id="7635602">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635611">var</span>&nbsp;<span class="ident" id="7635615">pid</span>&nbsp;<span class="builtintype" id="7635619">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635625">if</span>&nbsp;<span class="ident" id="7635628">n</span><span class="op" id="7635629">,</span>&nbsp;<span class="ident" id="7635631">err</span>&nbsp;<span class="op" id="7635635">:=</span>&nbsp;<span class="ident" id="7635638">fmt</span><span class="op" id="7635641">.</span><span class="ident" id="7635642">Sscanf</span><span class="op" id="7635648">(</span><span class="ident" id="7635649">out</span><span class="op" id="7635652">,</span>&nbsp;<span class="ident" id="7635654">tmpl</span><span class="op" id="7635658">,</span>&nbsp;<span class="op" id="7635660">&amp;</span><span class="ident" id="7635661">timestamp</span><span class="op" id="7635670">,</span>&nbsp;<span class="op" id="7635672">&amp;</span><span class="ident" id="7635673">parsedHostname</span><span class="op" id="7635687">,</span>&nbsp;<span class="op" id="7635689">&amp;</span><span class="ident" id="7635690">pid</span><span class="op" id="7635693">)</span><span class="op" id="7635694">;</span>&nbsp;<span class="ident" id="7635696">n</span>&nbsp;<span class="op" id="7635698">!=</span>&nbsp;<span class="num" id="7635701">3</span>&nbsp;<span class="op" id="7635703">||</span>&nbsp;<span class="ident" id="7635706">err</span>&nbsp;<span class="op" id="7635710">!=</span>&nbsp;<span class="ident" id="7635713">nil</span>&nbsp;<span class="op" id="7635717">||</span>&nbsp;<span class="ident" id="7635720">hostname</span>&nbsp;<span class="op" id="7635729">!=</span>&nbsp;<span class="ident" id="7635732">parsedHostname</span>&nbsp;<span class="op" id="7635747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635752">t</span><span class="op" id="7635753">.</span><span class="ident" id="7635754">Errorf</span><span class="op" id="7635760">(</span><span class="string" id="7635761">&#34;Got&nbsp;%q,&nbsp;does&nbsp;not&nbsp;match&nbsp;template&nbsp;%q&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7635805">,</span>&nbsp;<span class="ident" id="7635807">out</span><span class="op" id="7635810">,</span>&nbsp;<span class="ident" id="7635812">tmpl</span><span class="op" id="7635816">,</span>&nbsp;<span class="ident" id="7635818">n</span><span class="op" id="7635819">,</span>&nbsp;<span class="ident" id="7635821">err</span><span class="op" id="7635824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635828">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635831">}</span><br>
<span class="lineno"></span><span class="op" id="7635833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7635836">func</span>&nbsp;<span class="ident" id="7635841">TestWrite</span><span class="op" id="7635850">(</span><span class="ident" id="7635851">t</span>&nbsp;<span class="op" id="7635853">*</span><span class="ident" id="7635854">testing</span><span class="op" id="7635861">.</span><span class="ident" id="7635862">T</span><span class="op" id="7635863">)</span>&nbsp;<span class="op" id="7635865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635868">tests</span>&nbsp;<span class="op" id="7635874">:=</span>&nbsp;<span class="op" id="7635877">[</span><span class="op" id="7635878">]</span><span class="keyword" id="7635879">struct</span>&nbsp;<span class="op" id="7635886">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635890">pri</span>&nbsp;<span class="ident" id="7635894">Priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635905">pre</span>&nbsp;<span class="builtintype" id="7635909">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635918">msg</span>&nbsp;<span class="builtintype" id="7635922">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635931">exp</span>&nbsp;<span class="builtintype" id="7635935">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635943">}</span><span class="op" id="7635944">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635948">{</span><span class="ident" id="7635949">LOG_USER</span>&nbsp;<span class="op" id="7635958">|</span>&nbsp;<span class="ident" id="7635960">LOG_ERR</span><span class="op" id="7635967">,</span>&nbsp;<span class="string" id="7635969">&#34;syslog_test&#34;</span><span class="op" id="7635982">,</span>&nbsp;<span class="string" id="7635984">&#34;&#34;</span><span class="op" id="7635986">,</span>&nbsp;<span class="string" id="7635988">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;\n&#34;</span><span class="op" id="7636015">}</span><span class="op" id="7636016">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636020">{</span><span class="ident" id="7636021">LOG_USER</span>&nbsp;<span class="op" id="7636030">|</span>&nbsp;<span class="ident" id="7636032">LOG_ERR</span><span class="op" id="7636039">,</span>&nbsp;<span class="string" id="7636041">&#34;syslog_test&#34;</span><span class="op" id="7636054">,</span>&nbsp;<span class="string" id="7636056">&#34;write&nbsp;test&#34;</span><span class="op" id="7636068">,</span>&nbsp;<span class="string" id="7636070">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test\n&#34;</span><span class="op" id="7636107">}</span><span class="op" id="7636108">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7636112">//&nbsp;Write&nbsp;should&nbsp;not&nbsp;add&nbsp;\n&nbsp;if&nbsp;there&nbsp;already&nbsp;is&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636165">{</span><span class="ident" id="7636166">LOG_USER</span>&nbsp;<span class="op" id="7636175">|</span>&nbsp;<span class="ident" id="7636177">LOG_ERR</span><span class="op" id="7636184">,</span>&nbsp;<span class="string" id="7636186">&#34;syslog_test&#34;</span><span class="op" id="7636199">,</span>&nbsp;<span class="string" id="7636201">&#34;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7636217">,</span>&nbsp;<span class="string" id="7636219">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7636258">}</span><span class="op" id="7636259">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636262">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636266">if</span>&nbsp;<span class="ident" id="7636269">hostname</span><span class="op" id="7636277">,</span>&nbsp;<span class="ident" id="7636279">err</span>&nbsp;<span class="op" id="7636283">:=</span>&nbsp;<span class="ident" id="7636286">os</span><span class="op" id="7636288">.</span><span class="ident" id="7636289">Hostname</span><span class="op" id="7636297">(</span><span class="op" id="7636298">)</span><span class="op" id="7636299">;</span>&nbsp;<span class="ident" id="7636301">err</span>&nbsp;<span class="op" id="7636305">!=</span>&nbsp;<span class="ident" id="7636308">nil</span>&nbsp;<span class="op" id="7636312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636316">t</span><span class="op" id="7636317">.</span><span class="ident" id="7636318">Fatalf</span><span class="op" id="7636324">(</span><span class="string" id="7636325">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7636352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636355">}</span>&nbsp;<span class="keyword" id="7636357">else</span>&nbsp;<span class="op" id="7636362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636366">for</span>&nbsp;<span class="ident" id="7636370">_</span><span class="op" id="7636371">,</span>&nbsp;<span class="ident" id="7636373">test</span>&nbsp;<span class="op" id="7636378">:=</span>&nbsp;<span class="keyword" id="7636381">range</span>&nbsp;<span class="ident" id="7636387">tests</span>&nbsp;<span class="op" id="7636393">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636398">done</span>&nbsp;<span class="op" id="7636403">:=</span>&nbsp;<span class="builtinfunc" id="7636406">make</span><span class="op" id="7636410">(</span><span class="keyword" id="7636411">chan</span>&nbsp;<span class="builtintype" id="7636416">string</span><span class="op" id="7636422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636427">addr</span><span class="op" id="7636431">,</span>&nbsp;<span class="ident" id="7636433">sock</span><span class="op" id="7636437">,</span>&nbsp;<span class="ident" id="7636439">srvWG</span>&nbsp;<span class="op" id="7636445">:=</span>&nbsp;<span class="ident" id="7636448">startServer</span><span class="op" id="7636459">(</span><span class="string" id="7636460">&#34;udp&#34;</span><span class="op" id="7636465">,</span>&nbsp;<span class="string" id="7636467">&#34;&#34;</span><span class="op" id="7636469">,</span>&nbsp;<span class="ident" id="7636471">done</span><span class="op" id="7636475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636480">defer</span>&nbsp;<span class="ident" id="7636486">srvWG</span><span class="op" id="7636491">.</span><span class="ident" id="7636492">Wait</span><span class="op" id="7636496">(</span><span class="op" id="7636497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636502">defer</span>&nbsp;<span class="ident" id="7636508">sock</span><span class="op" id="7636512">.</span><span class="ident" id="7636513">Close</span><span class="op" id="7636518">(</span><span class="op" id="7636519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636524">l</span><span class="op" id="7636525">,</span>&nbsp;<span class="ident" id="7636527">err</span>&nbsp;<span class="op" id="7636531">:=</span>&nbsp;<span class="ident" id="7636534">Dial</span><span class="op" id="7636538">(</span><span class="string" id="7636539">&#34;udp&#34;</span><span class="op" id="7636544">,</span>&nbsp;<span class="ident" id="7636546">addr</span><span class="op" id="7636550">,</span>&nbsp;<span class="ident" id="7636552">test</span><span class="op" id="7636556">.</span><span class="ident" id="7636557">pri</span><span class="op" id="7636560">,</span>&nbsp;<span class="ident" id="7636562">test</span><span class="op" id="7636566">.</span><span class="ident" id="7636567">pre</span><span class="op" id="7636570">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636575">if</span>&nbsp;<span class="ident" id="7636578">err</span>&nbsp;<span class="op" id="7636582">!=</span>&nbsp;<span class="ident" id="7636585">nil</span>&nbsp;<span class="op" id="7636589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636595">t</span><span class="op" id="7636596">.</span><span class="ident" id="7636597">Fatalf</span><span class="op" id="7636603">(</span><span class="string" id="7636604">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7636630">,</span>&nbsp;<span class="ident" id="7636632">err</span><span class="op" id="7636635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636645">defer</span>&nbsp;<span class="ident" id="7636651">l</span><span class="op" id="7636652">.</span><span class="ident" id="7636653">Close</span><span class="op" id="7636658">(</span><span class="op" id="7636659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636664">_</span><span class="op" id="7636665">,</span>&nbsp;<span class="ident" id="7636667">err</span>&nbsp;<span class="op" id="7636671">=</span>&nbsp;<span class="ident" id="7636673">io</span><span class="op" id="7636675">.</span><span class="ident" id="7636676">WriteString</span><span class="op" id="7636687">(</span><span class="ident" id="7636688">l</span><span class="op" id="7636689">,</span>&nbsp;<span class="ident" id="7636691">test</span><span class="op" id="7636695">.</span><span class="ident" id="7636696">msg</span><span class="op" id="7636699">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636704">if</span>&nbsp;<span class="ident" id="7636707">err</span>&nbsp;<span class="op" id="7636711">!=</span>&nbsp;<span class="ident" id="7636714">nil</span>&nbsp;<span class="op" id="7636718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636724">t</span><span class="op" id="7636725">.</span><span class="ident" id="7636726">Fatalf</span><span class="op" id="7636732">(</span><span class="string" id="7636733">&#34;WriteString()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7636759">,</span>&nbsp;<span class="ident" id="7636761">err</span><span class="op" id="7636764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636774">rcvd</span>&nbsp;<span class="op" id="7636779">:=</span>&nbsp;<span class="op" id="7636782">&lt;-</span><span class="ident" id="7636784">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636792">test</span><span class="op" id="7636796">.</span><span class="ident" id="7636797">exp</span>&nbsp;<span class="op" id="7636801">=</span>&nbsp;<span class="ident" id="7636803">fmt</span><span class="op" id="7636806">.</span><span class="ident" id="7636807">Sprintf</span><span class="op" id="7636814">(</span><span class="string" id="7636815">&#34;&lt;%d&gt;&#34;</span><span class="op" id="7636821">,</span>&nbsp;<span class="ident" id="7636823">test</span><span class="op" id="7636827">.</span><span class="ident" id="7636828">pri</span><span class="op" id="7636831">)</span>&nbsp;<span class="op" id="7636833">+</span>&nbsp;<span class="ident" id="7636835">test</span><span class="op" id="7636839">.</span><span class="ident" id="7636840">exp</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636847">var</span>&nbsp;<span class="ident" id="7636851">parsedHostname</span><span class="op" id="7636865">,</span>&nbsp;<span class="ident" id="7636867">timestamp</span>&nbsp;<span class="builtintype" id="7636877">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636887">var</span>&nbsp;<span class="ident" id="7636891">pid</span>&nbsp;<span class="builtintype" id="7636895">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636902">if</span>&nbsp;<span class="ident" id="7636905">n</span><span class="op" id="7636906">,</span>&nbsp;<span class="ident" id="7636908">err</span>&nbsp;<span class="op" id="7636912">:=</span>&nbsp;<span class="ident" id="7636915">fmt</span><span class="op" id="7636918">.</span><span class="ident" id="7636919">Sscanf</span><span class="op" id="7636925">(</span><span class="ident" id="7636926">rcvd</span><span class="op" id="7636930">,</span>&nbsp;<span class="ident" id="7636932">test</span><span class="op" id="7636936">.</span><span class="ident" id="7636937">exp</span><span class="op" id="7636940">,</span>&nbsp;<span class="op" id="7636942">&amp;</span><span class="ident" id="7636943">timestamp</span><span class="op" id="7636952">,</span>&nbsp;<span class="op" id="7636954">&amp;</span><span class="ident" id="7636955">parsedHostname</span><span class="op" id="7636969">,</span>&nbsp;<span class="op" id="7636971">&amp;</span><span class="ident" id="7636972">pid</span><span class="op" id="7636975">)</span><span class="op" id="7636976">;</span>&nbsp;<span class="ident" id="7636978">n</span>&nbsp;<span class="op" id="7636980">!=</span>&nbsp;<span class="num" id="7636983">3</span>&nbsp;<span class="op" id="7636985">||</span>&nbsp;<span class="ident" id="7636988">err</span>&nbsp;<span class="op" id="7636992">!=</span>&nbsp;<span class="ident" id="7636995">nil</span>&nbsp;<span class="op" id="7636999">||</span>&nbsp;<span class="ident" id="7637002">hostname</span>&nbsp;<span class="op" id="7637011">!=</span>&nbsp;<span class="ident" id="7637014">parsedHostname</span>&nbsp;<span class="op" id="7637029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637035">t</span><span class="op" id="7637036">.</span><span class="ident" id="7637037">Errorf</span><span class="op" id="7637043">(</span><span class="string" id="7637044">&#34;s.Info()&nbsp;=&nbsp;&#39;%q&#39;,&nbsp;didn&#39;t&nbsp;match&nbsp;&#39;%q&#39;&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7637088">,</span>&nbsp;<span class="ident" id="7637090">rcvd</span><span class="op" id="7637094">,</span>&nbsp;<span class="ident" id="7637096">test</span><span class="op" id="7637100">.</span><span class="ident" id="7637101">exp</span><span class="op" id="7637104">,</span>&nbsp;<span class="ident" id="7637106">n</span><span class="op" id="7637107">,</span>&nbsp;<span class="ident" id="7637109">err</span><span class="op" id="7637112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637117">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637124">}</span><br>
<span class="lineno"></span><span class="op" id="7637126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7637129">func</span>&nbsp;<span class="ident" id="7637134">TestConcurrentWrite</span><span class="op" id="7637153">(</span><span class="ident" id="7637154">t</span>&nbsp;<span class="op" id="7637156">*</span><span class="ident" id="7637157">testing</span><span class="op" id="7637164">.</span><span class="ident" id="7637165">T</span><span class="op" id="7637166">)</span>&nbsp;<span class="op" id="7637168">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637171">addr</span><span class="op" id="7637175">,</span>&nbsp;<span class="ident" id="7637177">sock</span><span class="op" id="7637181">,</span>&nbsp;<span class="ident" id="7637183">srvWG</span>&nbsp;<span class="op" id="7637189">:=</span>&nbsp;<span class="ident" id="7637192">startServer</span><span class="op" id="7637203">(</span><span class="string" id="7637204">&#34;udp&#34;</span><span class="op" id="7637209">,</span>&nbsp;<span class="string" id="7637211">&#34;&#34;</span><span class="op" id="7637213">,</span>&nbsp;<span class="builtinfunc" id="7637215">make</span><span class="op" id="7637219">(</span><span class="keyword" id="7637220">chan</span>&nbsp;<span class="builtintype" id="7637225">string</span><span class="op" id="7637231">,</span>&nbsp;<span class="num" id="7637233">1</span><span class="op" id="7637234">)</span><span class="op" id="7637235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637238">defer</span>&nbsp;<span class="ident" id="7637244">srvWG</span><span class="op" id="7637249">.</span><span class="ident" id="7637250">Wait</span><span class="op" id="7637254">(</span><span class="op" id="7637255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637258">defer</span>&nbsp;<span class="ident" id="7637264">sock</span><span class="op" id="7637268">.</span><span class="ident" id="7637269">Close</span><span class="op" id="7637274">(</span><span class="op" id="7637275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637278">w</span><span class="op" id="7637279">,</span>&nbsp;<span class="ident" id="7637281">err</span>&nbsp;<span class="op" id="7637285">:=</span>&nbsp;<span class="ident" id="7637288">Dial</span><span class="op" id="7637292">(</span><span class="string" id="7637293">&#34;udp&#34;</span><span class="op" id="7637298">,</span>&nbsp;<span class="ident" id="7637300">addr</span><span class="op" id="7637304">,</span>&nbsp;<span class="ident" id="7637306">LOG_USER</span><span class="op" id="7637314">|</span><span class="ident" id="7637315">LOG_ERR</span><span class="op" id="7637322">,</span>&nbsp;<span class="string" id="7637324">&#34;how&#39;s&nbsp;it&nbsp;going?&#34;</span><span class="op" id="7637341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637344">if</span>&nbsp;<span class="ident" id="7637347">err</span>&nbsp;<span class="op" id="7637351">!=</span>&nbsp;<span class="ident" id="7637354">nil</span>&nbsp;<span class="op" id="7637358">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637362">t</span><span class="op" id="7637363">.</span><span class="ident" id="7637364">Fatalf</span><span class="op" id="7637370">(</span><span class="string" id="7637371">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7637397">,</span>&nbsp;<span class="ident" id="7637399">err</span><span class="op" id="7637402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637408">var</span>&nbsp;<span class="ident" id="7637412">wg</span>&nbsp;<span class="ident" id="7637415">sync</span><span class="op" id="7637419">.</span><span class="ident" id="7637420">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637431">for</span>&nbsp;<span class="ident" id="7637435">i</span>&nbsp;<span class="op" id="7637437">:=</span>&nbsp;<span class="num" id="7637440">0</span><span class="op" id="7637441">;</span>&nbsp;<span class="ident" id="7637443">i</span>&nbsp;<span class="op" id="7637445">&lt;</span>&nbsp;<span class="num" id="7637447">10</span><span class="op" id="7637449">;</span>&nbsp;<span class="ident" id="7637451">i</span><span class="op" id="7637452">++</span>&nbsp;<span class="op" id="7637455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637459">wg</span><span class="op" id="7637461">.</span><span class="ident" id="7637462">Add</span><span class="op" id="7637465">(</span><span class="num" id="7637466">1</span><span class="op" id="7637467">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637471">go</span>&nbsp;<span class="keyword" id="7637474">func</span><span class="op" id="7637478">(</span><span class="op" id="7637479">)</span>&nbsp;<span class="op" id="7637481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637486">defer</span>&nbsp;<span class="ident" id="7637492">wg</span><span class="op" id="7637494">.</span><span class="ident" id="7637495">Done</span><span class="op" id="7637499">(</span><span class="op" id="7637500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637505">err</span>&nbsp;<span class="op" id="7637509">:=</span>&nbsp;<span class="ident" id="7637512">w</span><span class="op" id="7637513">.</span><span class="ident" id="7637514">Info</span><span class="op" id="7637518">(</span><span class="string" id="7637519">&#34;test&#34;</span><span class="op" id="7637525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637530">if</span>&nbsp;<span class="ident" id="7637533">err</span>&nbsp;<span class="op" id="7637537">!=</span>&nbsp;<span class="ident" id="7637540">nil</span>&nbsp;<span class="op" id="7637544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637550">t</span><span class="op" id="7637551">.</span><span class="ident" id="7637552">Errorf</span><span class="op" id="7637558">(</span><span class="string" id="7637559">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7637578">,</span>&nbsp;<span class="ident" id="7637580">err</span><span class="op" id="7637583">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637589">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637603">}</span><span class="op" id="7637604">(</span><span class="op" id="7637605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637611">wg</span><span class="op" id="7637613">.</span><span class="ident" id="7637614">Wait</span><span class="op" id="7637618">(</span><span class="op" id="7637619">)</span><br>
<span class="lineno">300</span><span class="op" id="7637621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7637624">func</span>&nbsp;<span class="ident" id="7637629">TestConcurrentReconnect</span><span class="op" id="7637652">(</span><span class="ident" id="7637653">t</span>&nbsp;<span class="op" id="7637655">*</span><span class="ident" id="7637656">testing</span><span class="op" id="7637663">.</span><span class="ident" id="7637664">T</span><span class="op" id="7637665">)</span>&nbsp;<span class="op" id="7637667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637670">crashy</span>&nbsp;<span class="op" id="7637677">=</span>&nbsp;<span class="builtintype" id="7637679">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637685">defer</span>&nbsp;<span class="keyword" id="7637691">func</span><span class="op" id="7637695">(</span><span class="op" id="7637696">)</span>&nbsp;<span class="op" id="7637698">{</span>&nbsp;<span class="ident" id="7637700">crashy</span>&nbsp;<span class="op" id="7637707">=</span>&nbsp;<span class="builtintype" id="7637709">false</span>&nbsp;<span class="op" id="7637715">}</span><span class="op" id="7637716">(</span><span class="op" id="7637717">)</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637721">const</span>&nbsp;<span class="ident" id="7637727">N</span>&nbsp;<span class="op" id="7637729">=</span>&nbsp;<span class="num" id="7637731">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637735">const</span>&nbsp;<span class="ident" id="7637741">M</span>&nbsp;<span class="op" id="7637743">=</span>&nbsp;<span class="num" id="7637745">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637750">net</span>&nbsp;<span class="op" id="7637754">:=</span>&nbsp;<span class="string" id="7637757">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637765">done</span>&nbsp;<span class="op" id="7637770">:=</span>&nbsp;<span class="builtinfunc" id="7637773">make</span><span class="op" id="7637777">(</span><span class="keyword" id="7637778">chan</span>&nbsp;<span class="builtintype" id="7637783">string</span><span class="op" id="7637789">,</span>&nbsp;<span class="ident" id="7637791">N</span><span class="op" id="7637792">*</span><span class="ident" id="7637793">M</span><span class="op" id="7637794">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637797">addr</span><span class="op" id="7637801">,</span>&nbsp;<span class="ident" id="7637803">sock</span><span class="op" id="7637807">,</span>&nbsp;<span class="ident" id="7637809">srvWG</span>&nbsp;<span class="op" id="7637815">:=</span>&nbsp;<span class="ident" id="7637818">startServer</span><span class="op" id="7637829">(</span><span class="ident" id="7637830">net</span><span class="op" id="7637833">,</span>&nbsp;<span class="string" id="7637835">&#34;&#34;</span><span class="op" id="7637837">,</span>&nbsp;<span class="ident" id="7637839">done</span><span class="op" id="7637843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637846">defer</span>&nbsp;<span class="ident" id="7637852">os</span><span class="op" id="7637854">.</span><span class="ident" id="7637855">Remove</span><span class="op" id="7637861">(</span><span class="ident" id="7637862">addr</span><span class="op" id="7637866">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7637870">//&nbsp;count&nbsp;all&nbsp;the&nbsp;messages&nbsp;arriving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637906">count</span>&nbsp;<span class="op" id="7637912">:=</span>&nbsp;<span class="builtinfunc" id="7637915">make</span><span class="op" id="7637919">(</span><span class="keyword" id="7637920">chan</span>&nbsp;<span class="builtintype" id="7637925">int</span><span class="op" id="7637928">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637931">go</span>&nbsp;<span class="keyword" id="7637934">func</span><span class="op" id="7637938">(</span><span class="op" id="7637939">)</span>&nbsp;<span class="op" id="7637941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637945">ct</span>&nbsp;<span class="op" id="7637948">:=</span>&nbsp;<span class="num" id="7637951">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637955">for</span>&nbsp;<span class="keyword" id="7637959">range</span>&nbsp;<span class="ident" id="7637965">done</span>&nbsp;<span class="op" id="7637970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637975">ct</span><span class="op" id="7637977">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7637983">//&nbsp;we&nbsp;are&nbsp;looking&nbsp;for&nbsp;500&nbsp;out&nbsp;of&nbsp;1000&nbsp;events</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7638031">//&nbsp;here&nbsp;because&nbsp;lots&nbsp;of&nbsp;log&nbsp;messages&nbsp;are&nbsp;lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7638080">//&nbsp;in&nbsp;buffers&nbsp;(kernel&nbsp;and/or&nbsp;bufio)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638119">if</span>&nbsp;<span class="ident" id="7638122">ct</span>&nbsp;<span class="op" id="7638125">&gt;</span>&nbsp;<span class="ident" id="7638127">N</span><span class="op" id="7638128">*</span><span class="ident" id="7638129">M</span><span class="op" id="7638130">/</span><span class="num" id="7638131">2</span>&nbsp;<span class="op" id="7638133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638139">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638148">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638156">count</span>&nbsp;<span class="op" id="7638162">&lt;-</span>&nbsp;<span class="ident" id="7638165">ct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638169">}</span><span class="op" id="7638170">(</span><span class="op" id="7638171">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638175">var</span>&nbsp;<span class="ident" id="7638179">wg</span>&nbsp;<span class="ident" id="7638182">sync</span><span class="op" id="7638186">.</span><span class="ident" id="7638187">WaitGroup</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638198">wg</span><span class="op" id="7638200">.</span><span class="ident" id="7638201">Add</span><span class="op" id="7638204">(</span><span class="ident" id="7638205">N</span><span class="op" id="7638206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638209">for</span>&nbsp;<span class="ident" id="7638213">i</span>&nbsp;<span class="op" id="7638215">:=</span>&nbsp;<span class="num" id="7638218">0</span><span class="op" id="7638219">;</span>&nbsp;<span class="ident" id="7638221">i</span>&nbsp;<span class="op" id="7638223">&lt;</span>&nbsp;<span class="ident" id="7638225">N</span><span class="op" id="7638226">;</span>&nbsp;<span class="ident" id="7638228">i</span><span class="op" id="7638229">++</span>&nbsp;<span class="op" id="7638232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638236">go</span>&nbsp;<span class="keyword" id="7638239">func</span><span class="op" id="7638243">(</span><span class="op" id="7638244">)</span>&nbsp;<span class="op" id="7638246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638251">defer</span>&nbsp;<span class="ident" id="7638257">wg</span><span class="op" id="7638259">.</span><span class="ident" id="7638260">Done</span><span class="op" id="7638264">(</span><span class="op" id="7638265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638270">w</span><span class="op" id="7638271">,</span>&nbsp;<span class="ident" id="7638273">err</span>&nbsp;<span class="op" id="7638277">:=</span>&nbsp;<span class="ident" id="7638280">Dial</span><span class="op" id="7638284">(</span><span class="ident" id="7638285">net</span><span class="op" id="7638288">,</span>&nbsp;<span class="ident" id="7638290">addr</span><span class="op" id="7638294">,</span>&nbsp;<span class="ident" id="7638296">LOG_USER</span><span class="op" id="7638304">|</span><span class="ident" id="7638305">LOG_ERR</span><span class="op" id="7638312">,</span>&nbsp;<span class="string" id="7638314">&#34;tag&#34;</span><span class="op" id="7638319">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638324">if</span>&nbsp;<span class="ident" id="7638327">err</span>&nbsp;<span class="op" id="7638331">!=</span>&nbsp;<span class="ident" id="7638334">nil</span>&nbsp;<span class="op" id="7638338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638344">t</span><span class="op" id="7638345">.</span><span class="ident" id="7638346">Fatalf</span><span class="op" id="7638352">(</span><span class="string" id="7638353">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7638379">,</span>&nbsp;<span class="ident" id="7638381">err</span><span class="op" id="7638384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638394">defer</span>&nbsp;<span class="ident" id="7638400">w</span><span class="op" id="7638401">.</span><span class="ident" id="7638402">Close</span><span class="op" id="7638407">(</span><span class="op" id="7638408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638413">for</span>&nbsp;<span class="ident" id="7638417">i</span>&nbsp;<span class="op" id="7638419">:=</span>&nbsp;<span class="num" id="7638422">0</span><span class="op" id="7638423">;</span>&nbsp;<span class="ident" id="7638425">i</span>&nbsp;<span class="op" id="7638427">&lt;</span>&nbsp;<span class="ident" id="7638429">M</span><span class="op" id="7638430">;</span>&nbsp;<span class="ident" id="7638432">i</span><span class="op" id="7638433">++</span>&nbsp;<span class="op" id="7638436">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638442">err</span>&nbsp;<span class="op" id="7638446">:=</span>&nbsp;<span class="ident" id="7638449">w</span><span class="op" id="7638450">.</span><span class="ident" id="7638451">Info</span><span class="op" id="7638455">(</span><span class="string" id="7638456">&#34;test&#34;</span><span class="op" id="7638462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638468">if</span>&nbsp;<span class="ident" id="7638471">err</span>&nbsp;<span class="op" id="7638475">!=</span>&nbsp;<span class="ident" id="7638478">nil</span>&nbsp;<span class="op" id="7638482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638489">t</span><span class="op" id="7638490">.</span><span class="ident" id="7638491">Errorf</span><span class="op" id="7638497">(</span><span class="string" id="7638498">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7638517">,</span>&nbsp;<span class="ident" id="7638519">err</span><span class="op" id="7638522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638529">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638540">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638549">}</span><span class="op" id="7638550">(</span><span class="op" id="7638551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638557">wg</span><span class="op" id="7638559">.</span><span class="ident" id="7638560">Wait</span><span class="op" id="7638564">(</span><span class="op" id="7638565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638568">sock</span><span class="op" id="7638572">.</span><span class="ident" id="7638573">Close</span><span class="op" id="7638578">(</span><span class="op" id="7638579">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638582">srvWG</span><span class="op" id="7638587">.</span><span class="ident" id="7638588">Wait</span><span class="op" id="7638592">(</span><span class="op" id="7638593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7638596">close</span><span class="op" id="7638601">(</span><span class="ident" id="7638602">done</span><span class="op" id="7638606">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638610">select</span>&nbsp;<span class="op" id="7638617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638620">case</span>&nbsp;<span class="op" id="7638625">&lt;-</span><span class="ident" id="7638627">count</span><span class="op" id="7638632">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638635">case</span>&nbsp;<span class="op" id="7638640">&lt;-</span><span class="ident" id="7638642">time</span><span class="op" id="7638646">.</span><span class="ident" id="7638647">After</span><span class="op" id="7638652">(</span><span class="num" id="7638653">100</span>&nbsp;<span class="op" id="7638657">*</span>&nbsp;<span class="ident" id="7638659">time</span><span class="op" id="7638663">.</span><span class="ident" id="7638664">Millisecond</span><span class="op" id="7638675">)</span><span class="op" id="7638676">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638680">t</span><span class="op" id="7638681">.</span><span class="ident" id="7638682">Error</span><span class="op" id="7638687">(</span><span class="string" id="7638688">&#34;timeout&nbsp;in&nbsp;concurrent&nbsp;reconnect&#34;</span><span class="op" id="7638721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638724">}</span><br>
<span class="lineno"></span><span class="op" id="7638726">}</span>
</div>
</body>
</html>
