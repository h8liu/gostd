<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/x509</h2>
<ul>
<li><a href="/gostd/crypto/x509/cert_pool.go.html">cert_pool.go</a></li>
<li><a href="/gostd/crypto/x509/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/x509/pem_decrypt.go.html">pem_decrypt.go</a></li>
<li><a href="/gostd/crypto/x509/pem_decrypt_test.go.html">pem_decrypt_test.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs1.go.html">pkcs1.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs8.go.html">pkcs8.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs8_test.go.html">pkcs8_test.go</a></li>
<li><a href="/gostd/crypto/x509/root.go.html">root.go</a></li>
<li><a href="/gostd/crypto/x509/root_unix.go.html">root_unix.go</a></li>
<li><a href="/gostd/crypto/x509/sec1.go.html">sec1.go</a></li>
<li><a href="/gostd/crypto/x509/sec1_test.go.html">sec1_test.go</a></li>
<li><a href="/gostd/crypto/x509/verify.go.html" class="current">verify.go</a></li>
<li><a href="/gostd/crypto/x509/verify_test.go.html">verify_test.go</a></li>
<li><a href="/gostd/crypto/x509/x509.go.html">x509.go</a></li>
<li><a href="/gostd/crypto/x509/x509_test.go.html">x509_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4365844">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4365899">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4365953">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4366004">package</span>&nbsp;<span class="ident" id="4366012">x509</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4366018">import</span>&nbsp;<span class="op" id="4366025">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4366028">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4366035">&#34;net&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4366042">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4366053">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4366064">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4366072">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="4366087">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="4366090">type</span>&nbsp;<span class="ident" id="4366095">InvalidReason</span>&nbsp;<span class="builtintype" id="4366109">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4366114">const</span>&nbsp;<span class="op" id="4366120">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366123">//&nbsp;NotAuthorizedToSign&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;another</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366195">//&nbsp;which&nbsp;isn&#39;t&nbsp;marked&nbsp;as&nbsp;a&nbsp;CA&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366239">NotAuthorizedToSign</span>&nbsp;<span class="ident" id="4366259">InvalidReason</span>&nbsp;<span class="op" id="4366273">=</span>&nbsp;<span class="ident" id="4366275">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366281">//&nbsp;Expired&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;has&nbsp;expired,&nbsp;based&nbsp;on&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366351">//&nbsp;given&nbsp;in&nbsp;the&nbsp;VerifyOptions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366383">Expired</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366392">//&nbsp;CANotAuthorizedForThisName&nbsp;results&nbsp;when&nbsp;an&nbsp;intermediate&nbsp;or&nbsp;root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366460">//&nbsp;certificate&nbsp;has&nbsp;a&nbsp;name&nbsp;constraint&nbsp;which&nbsp;doesn&#39;t&nbsp;include&nbsp;the&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366529">//&nbsp;being&nbsp;checked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366548">CANotAuthorizedForThisName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366576">//&nbsp;TooManyIntermediates&nbsp;results&nbsp;when&nbsp;a&nbsp;path&nbsp;length&nbsp;constraint&nbsp;is</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366642">//&nbsp;violated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366656">TooManyIntermediates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366678">//&nbsp;IncompatibleUsage&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&#39;s&nbsp;key&nbsp;usage&nbsp;indicates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366751">//&nbsp;that&nbsp;it&nbsp;may&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;a&nbsp;different&nbsp;purpose.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366805">IncompatibleUsage</span><br>
<span class="lineno">35</span><span class="op" id="4366823">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4366826">//&nbsp;CertificateInvalidError&nbsp;results&nbsp;when&nbsp;an&nbsp;odd&nbsp;error&nbsp;occurs.&nbsp;Users&nbsp;of&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="4366901">//&nbsp;library&nbsp;probably&nbsp;want&nbsp;to&nbsp;handle&nbsp;all&nbsp;these&nbsp;errors&nbsp;uniformly.</span><br>
<span class="lineno"></span><span class="keyword" id="4366964">type</span>&nbsp;<span class="ident" id="4366969">CertificateInvalidError</span>&nbsp;<span class="keyword" id="4366993">struct</span>&nbsp;<span class="op" id="4367000">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367003">Cert</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4367010">*</span><span class="ident" id="4367011">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367024">Reason</span>&nbsp;<span class="ident" id="4367031">InvalidReason</span><br>
<span class="lineno"></span><span class="op" id="4367045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4367048">func</span>&nbsp;<span class="op" id="4367053">(</span><span class="ident" id="4367054">e</span>&nbsp;<span class="ident" id="4367056">CertificateInvalidError</span><span class="op" id="4367079">)</span>&nbsp;<span class="ident" id="4367081">Error</span><span class="op" id="4367086">(</span><span class="op" id="4367087">)</span>&nbsp;<span class="builtintype" id="4367089">string</span>&nbsp;<span class="op" id="4367096">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367099">switch</span>&nbsp;<span class="ident" id="4367106">e</span><span class="op" id="4367107">.</span><span class="ident" id="4367108">Reason</span>&nbsp;<span class="op" id="4367115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367118">case</span>&nbsp;<span class="ident" id="4367123">NotAuthorizedToSign</span><span class="op" id="4367142">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367146">return</span>&nbsp;<span class="string" id="4367153">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;other&nbsp;certificates&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367219">case</span>&nbsp;<span class="ident" id="4367224">Expired</span><span class="op" id="4367231">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367235">return</span>&nbsp;<span class="string" id="4367242">&#34;x509:&nbsp;certificate&nbsp;has&nbsp;expired&nbsp;or&nbsp;is&nbsp;not&nbsp;yet&nbsp;valid&#34;</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367295">case</span>&nbsp;<span class="ident" id="4367300">CANotAuthorizedForThisName</span><span class="op" id="4367326">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367330">return</span>&nbsp;<span class="string" id="4367337">&#34;x509:&nbsp;a&nbsp;root&nbsp;or&nbsp;intermediate&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;in&nbsp;this&nbsp;domain&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367422">case</span>&nbsp;<span class="ident" id="4367427">TooManyIntermediates</span><span class="op" id="4367447">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367451">return</span>&nbsp;<span class="string" id="4367458">&#34;x509:&nbsp;too&nbsp;many&nbsp;intermediates&nbsp;for&nbsp;path&nbsp;length&nbsp;constraint&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367517">case</span>&nbsp;<span class="ident" id="4367522">IncompatibleUsage</span><span class="op" id="4367539">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367543">return</span>&nbsp;<span class="string" id="4367550">&#34;x509:&nbsp;certificate&nbsp;specifies&nbsp;an&nbsp;incompatible&nbsp;key&nbsp;usage&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4367607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367610">return</span>&nbsp;<span class="string" id="4367617">&#34;x509:&nbsp;unknown&nbsp;error&#34;</span><br>
<span class="lineno"></span><span class="op" id="4367639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="4367642">//&nbsp;HostnameError&nbsp;results&nbsp;when&nbsp;the&nbsp;set&nbsp;of&nbsp;authorized&nbsp;names&nbsp;doesn&#39;t&nbsp;match&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4367718">//&nbsp;requested&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="4367737">type</span>&nbsp;<span class="ident" id="4367742">HostnameError</span>&nbsp;<span class="keyword" id="4367756">struct</span>&nbsp;<span class="op" id="4367763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367766">Certificate</span>&nbsp;<span class="op" id="4367778">*</span><span class="ident" id="4367779">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367792">Host</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4367804">string</span><br>
<span class="lineno">65</span><span class="op" id="4367811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4367814">func</span>&nbsp;<span class="op" id="4367819">(</span><span class="ident" id="4367820">h</span>&nbsp;<span class="ident" id="4367822">HostnameError</span><span class="op" id="4367835">)</span>&nbsp;<span class="ident" id="4367837">Error</span><span class="op" id="4367842">(</span><span class="op" id="4367843">)</span>&nbsp;<span class="builtintype" id="4367845">string</span>&nbsp;<span class="op" id="4367852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4367855">c</span>&nbsp;<span class="op" id="4367857">:=</span>&nbsp;<span class="ident" id="4367860">h</span><span class="op" id="4367861">.</span><span class="ident" id="4367862">Certificate</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367876">var</span>&nbsp;<span class="ident" id="4367880">valid</span>&nbsp;<span class="builtintype" id="4367886">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367894">if</span>&nbsp;<span class="ident" id="4367897">ip</span>&nbsp;<span class="op" id="4367900">:=</span>&nbsp;<span class="ident" id="4367903">net</span><span class="op" id="4367906">.</span><span class="ident" id="4367907">ParseIP</span><span class="op" id="4367914">(</span><span class="ident" id="4367915">h</span><span class="op" id="4367916">.</span><span class="ident" id="4367917">Host</span><span class="op" id="4367921">)</span><span class="op" id="4367922">;</span>&nbsp;<span class="ident" id="4367924">ip</span>&nbsp;<span class="op" id="4367927">!=</span>&nbsp;<span class="builtintype" id="4367930">nil</span>&nbsp;<span class="op" id="4367934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4367938">//&nbsp;Trying&nbsp;to&nbsp;validate&nbsp;an&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4367968">if</span>&nbsp;<span class="builtinfunc" id="4367971">len</span><span class="op" id="4367974">(</span><span class="ident" id="4367975">c</span><span class="op" id="4367976">.</span><span class="ident" id="4367977">IPAddresses</span><span class="op" id="4367988">)</span>&nbsp;<span class="op" id="4367990">==</span>&nbsp;<span class="num" id="4367993">0</span>&nbsp;<span class="op" id="4367995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368000">return</span>&nbsp;<span class="string" id="4368007">&#34;x509:&nbsp;cannot&nbsp;validate&nbsp;certificate&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="4368048">+</span>&nbsp;<span class="ident" id="4368050">h</span><span class="op" id="4368051">.</span><span class="ident" id="4368052">Host</span>&nbsp;<span class="op" id="4368057">+</span>&nbsp;<span class="string" id="4368059">&#34;&nbsp;because&nbsp;it&nbsp;doesn&#39;t&nbsp;contain&nbsp;any&nbsp;IP&nbsp;SANs&#34;</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4368103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368107">for</span>&nbsp;<span class="ident" id="4368111">_</span><span class="op" id="4368112">,</span>&nbsp;<span class="ident" id="4368114">san</span>&nbsp;<span class="op" id="4368118">:=</span>&nbsp;<span class="keyword" id="4368121">range</span>&nbsp;<span class="ident" id="4368127">c</span><span class="op" id="4368128">.</span><span class="ident" id="4368129">IPAddresses</span>&nbsp;<span class="op" id="4368141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368146">if</span>&nbsp;<span class="builtinfunc" id="4368149">len</span><span class="op" id="4368152">(</span><span class="ident" id="4368153">valid</span><span class="op" id="4368158">)</span>&nbsp;<span class="op" id="4368160">&gt;</span>&nbsp;<span class="num" id="4368162">0</span>&nbsp;<span class="op" id="4368164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4368170">valid</span>&nbsp;<span class="op" id="4368176">+=</span>&nbsp;<span class="string" id="4368179">&#34;,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4368187">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4368192">valid</span>&nbsp;<span class="op" id="4368198">+=</span>&nbsp;<span class="ident" id="4368201">san</span><span class="op" id="4368204">.</span><span class="ident" id="4368205">String</span><span class="op" id="4368211">(</span><span class="op" id="4368212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4368216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4368219">}</span>&nbsp;<span class="keyword" id="4368221">else</span>&nbsp;<span class="op" id="4368226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368230">if</span>&nbsp;<span class="builtinfunc" id="4368233">len</span><span class="op" id="4368236">(</span><span class="ident" id="4368237">c</span><span class="op" id="4368238">.</span><span class="ident" id="4368239">DNSNames</span><span class="op" id="4368247">)</span>&nbsp;<span class="op" id="4368249">&gt;</span>&nbsp;<span class="num" id="4368251">0</span>&nbsp;<span class="op" id="4368253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4368258">valid</span>&nbsp;<span class="op" id="4368264">=</span>&nbsp;<span class="ident" id="4368266">strings</span><span class="op" id="4368273">.</span><span class="ident" id="4368274">Join</span><span class="op" id="4368278">(</span><span class="ident" id="4368279">c</span><span class="op" id="4368280">.</span><span class="ident" id="4368281">DNSNames</span><span class="op" id="4368289">,</span>&nbsp;<span class="string" id="4368291">&#34;,&nbsp;&#34;</span><span class="op" id="4368295">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4368299">}</span>&nbsp;<span class="keyword" id="4368301">else</span>&nbsp;<span class="op" id="4368306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4368311">valid</span>&nbsp;<span class="op" id="4368317">=</span>&nbsp;<span class="ident" id="4368319">c</span><span class="op" id="4368320">.</span><span class="ident" id="4368321">Subject</span><span class="op" id="4368328">.</span><span class="ident" id="4368329">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4368342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4368345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368348">return</span>&nbsp;<span class="string" id="4368355">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;valid&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="4368389">+</span>&nbsp;<span class="ident" id="4368391">valid</span>&nbsp;<span class="op" id="4368397">+</span>&nbsp;<span class="string" id="4368399">&#34;,&nbsp;not&nbsp;&#34;</span>&nbsp;<span class="op" id="4368408">+</span>&nbsp;<span class="ident" id="4368410">h</span><span class="op" id="4368411">.</span><span class="ident" id="4368412">Host</span><br>
<span class="lineno">90</span><span class="op" id="4368417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4368420">//&nbsp;UnknownAuthorityError&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&nbsp;issuer&nbsp;is&nbsp;unknown</span><br>
<span class="lineno"></span><span class="keyword" id="4368492">type</span>&nbsp;<span class="ident" id="4368497">UnknownAuthorityError</span>&nbsp;<span class="keyword" id="4368519">struct</span>&nbsp;<span class="op" id="4368526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4368529">cert</span>&nbsp;<span class="op" id="4368534">*</span><span class="ident" id="4368535">Certificate</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4368548">//&nbsp;hintErr&nbsp;contains&nbsp;an&nbsp;error&nbsp;that&nbsp;may&nbsp;be&nbsp;helpful&nbsp;in&nbsp;determining&nbsp;why&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4368620">//&nbsp;authority&nbsp;wasn&#39;t&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4368648">hintErr</span>&nbsp;<span class="builtintype" id="4368656">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4368663">//&nbsp;hintCert&nbsp;contains&nbsp;a&nbsp;possible&nbsp;authority&nbsp;certificate&nbsp;that&nbsp;was&nbsp;rejected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4368736">//&nbsp;because&nbsp;of&nbsp;the&nbsp;error&nbsp;in&nbsp;hintErr.</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4368773">hintCert</span>&nbsp;<span class="op" id="4368782">*</span><span class="ident" id="4368783">Certificate</span><br>
<span class="lineno"></span><span class="op" id="4368795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4368798">func</span>&nbsp;<span class="op" id="4368803">(</span><span class="ident" id="4368804">e</span>&nbsp;<span class="ident" id="4368806">UnknownAuthorityError</span><span class="op" id="4368827">)</span>&nbsp;<span class="ident" id="4368829">Error</span><span class="op" id="4368834">(</span><span class="op" id="4368835">)</span>&nbsp;<span class="builtintype" id="4368837">string</span>&nbsp;<span class="op" id="4368844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4368847">s</span>&nbsp;<span class="op" id="4368849">:=</span>&nbsp;<span class="string" id="4368852">&#34;x509:&nbsp;certificate&nbsp;signed&nbsp;by&nbsp;unknown&nbsp;authority&#34;</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368901">if</span>&nbsp;<span class="ident" id="4368904">e</span><span class="op" id="4368905">.</span><span class="ident" id="4368906">hintErr</span>&nbsp;<span class="op" id="4368914">!=</span>&nbsp;<span class="builtintype" id="4368917">nil</span>&nbsp;<span class="op" id="4368921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4368925">certName</span>&nbsp;<span class="op" id="4368934">:=</span>&nbsp;<span class="ident" id="4368937">e</span><span class="op" id="4368938">.</span><span class="ident" id="4368939">hintCert</span><span class="op" id="4368947">.</span><span class="ident" id="4368948">Subject</span><span class="op" id="4368955">.</span><span class="ident" id="4368956">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368969">if</span>&nbsp;<span class="builtinfunc" id="4368972">len</span><span class="op" id="4368975">(</span><span class="ident" id="4368976">certName</span><span class="op" id="4368984">)</span>&nbsp;<span class="op" id="4368986">==</span>&nbsp;<span class="num" id="4368989">0</span>&nbsp;<span class="op" id="4368991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4368996">if</span>&nbsp;<span class="builtinfunc" id="4368999">len</span><span class="op" id="4369002">(</span><span class="ident" id="4369003">e</span><span class="op" id="4369004">.</span><span class="ident" id="4369005">hintCert</span><span class="op" id="4369013">.</span><span class="ident" id="4369014">Subject</span><span class="op" id="4369021">.</span><span class="ident" id="4369022">Organization</span><span class="op" id="4369034">)</span>&nbsp;<span class="op" id="4369036">&gt;</span>&nbsp;<span class="num" id="4369038">0</span>&nbsp;<span class="op" id="4369040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4369046">certName</span>&nbsp;<span class="op" id="4369055">=</span>&nbsp;<span class="ident" id="4369057">e</span><span class="op" id="4369058">.</span><span class="ident" id="4369059">hintCert</span><span class="op" id="4369067">.</span><span class="ident" id="4369068">Subject</span><span class="op" id="4369075">.</span><span class="ident" id="4369076">Organization</span><span class="op" id="4369088">[</span><span class="num" id="4369089">0</span><span class="op" id="4369090">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4369095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4369100">certName</span>&nbsp;<span class="op" id="4369109">=</span>&nbsp;<span class="string" id="4369111">&#34;serial:&#34;</span>&nbsp;<span class="op" id="4369121">+</span>&nbsp;<span class="ident" id="4369123">e</span><span class="op" id="4369124">.</span><span class="ident" id="4369125">hintCert</span><span class="op" id="4369133">.</span><span class="ident" id="4369134">SerialNumber</span><span class="op" id="4369146">.</span><span class="ident" id="4369147">String</span><span class="op" id="4369153">(</span><span class="op" id="4369154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4369158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4369162">s</span>&nbsp;<span class="op" id="4369164">+=</span>&nbsp;<span class="ident" id="4369167">fmt</span><span class="op" id="4369170">.</span><span class="ident" id="4369171">Sprintf</span><span class="op" id="4369178">(</span><span class="string" id="4369179">&#34;&nbsp;(possibly&nbsp;because&nbsp;of&nbsp;%q&nbsp;while&nbsp;trying&nbsp;to&nbsp;verify&nbsp;candidate&nbsp;authority&nbsp;certificate&nbsp;%q)&#34;</span><span class="op" id="4369264">,</span>&nbsp;<span class="ident" id="4369266">e</span><span class="op" id="4369267">.</span><span class="ident" id="4369268">hintErr</span><span class="op" id="4369275">,</span>&nbsp;<span class="ident" id="4369277">certName</span><span class="op" id="4369285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4369288">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369291">return</span>&nbsp;<span class="ident" id="4369298">s</span><br>
<span class="lineno"></span><span class="op" id="4369300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4369303">//&nbsp;SystemRootsError&nbsp;results&nbsp;when&nbsp;we&nbsp;fail&nbsp;to&nbsp;load&nbsp;the&nbsp;system&nbsp;root&nbsp;certificates.</span><br>
<span class="lineno"></span><span class="keyword" id="4369382">type</span>&nbsp;<span class="ident" id="4369387">SystemRootsError</span>&nbsp;<span class="keyword" id="4369404">struct</span><span class="op" id="4369410">{</span><span class="op" id="4369411">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="4369414">func</span>&nbsp;<span class="op" id="4369419">(</span><span class="ident" id="4369420">SystemRootsError</span><span class="op" id="4369436">)</span>&nbsp;<span class="ident" id="4369438">Error</span><span class="op" id="4369443">(</span><span class="op" id="4369444">)</span>&nbsp;<span class="builtintype" id="4369446">string</span>&nbsp;<span class="op" id="4369453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4369456">return</span>&nbsp;<span class="string" id="4369463">&#34;x509:&nbsp;failed&nbsp;to&nbsp;load&nbsp;system&nbsp;roots&nbsp;and&nbsp;no&nbsp;roots&nbsp;provided&#34;</span><br>
<span class="lineno"></span><span class="op" id="4369521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="4369524">//&nbsp;VerifyOptions&nbsp;contains&nbsp;parameters&nbsp;for&nbsp;Certificate.Verify.&nbsp;It&#39;s&nbsp;a&nbsp;structure</span><br>
<span class="lineno"></span><span class="comment" id="4369602">//&nbsp;because&nbsp;other&nbsp;PKIX&nbsp;verification&nbsp;APIs&nbsp;have&nbsp;ended&nbsp;up&nbsp;needing&nbsp;many&nbsp;options.</span><br>
<span class="lineno"></span><span class="keyword" id="4369678">type</span>&nbsp;<span class="ident" id="4369683">VerifyOptions</span>&nbsp;<span class="keyword" id="4369697">struct</span>&nbsp;<span class="op" id="4369704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4369707">DNSName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4369721">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4369729">Intermediates</span>&nbsp;<span class="op" id="4369743">*</span><span class="ident" id="4369744">CertPool</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4369754">Roots</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4369768">*</span><span class="ident" id="4369769">CertPool</span>&nbsp;<span class="comment" id="4369778">//&nbsp;if&nbsp;nil,&nbsp;the&nbsp;system&nbsp;roots&nbsp;are&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4369816">CurrentTime</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4369830">time</span><span class="op" id="4369834">.</span><span class="ident" id="4369835">Time</span>&nbsp;<span class="comment" id="4369840">//&nbsp;if&nbsp;zero,&nbsp;the&nbsp;current&nbsp;time&nbsp;is&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4369878">//&nbsp;KeyUsage&nbsp;specifies&nbsp;which&nbsp;Extended&nbsp;Key&nbsp;Usage&nbsp;values&nbsp;are&nbsp;acceptable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4369949">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;means&nbsp;ExtKeyUsageServerAuth.&nbsp;Key&nbsp;usage&nbsp;is&nbsp;considered&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370022">//&nbsp;constraint&nbsp;down&nbsp;the&nbsp;chain&nbsp;which&nbsp;mirrors&nbsp;Windows&nbsp;CryptoAPI&nbsp;behaviour,</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370095">//&nbsp;but&nbsp;not&nbsp;the&nbsp;spec.&nbsp;To&nbsp;accept&nbsp;any&nbsp;key&nbsp;usage,&nbsp;include&nbsp;ExtKeyUsageAny.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370166">KeyUsages</span>&nbsp;<span class="op" id="4370176">[</span><span class="op" id="4370177">]</span><span class="ident" id="4370178">ExtKeyUsage</span><br>
<span class="lineno"></span><span class="op" id="4370190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4370193">const</span>&nbsp;<span class="op" id="4370199">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370202">leafCertificate</span>&nbsp;<span class="op" id="4370218">=</span>&nbsp;<span class="ident" id="4370220">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370226">intermediateCertificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370251">rootCertificate</span><br>
<span class="lineno"></span><span class="op" id="4370267">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="4370270">//&nbsp;isValid&nbsp;performs&nbsp;validity&nbsp;checks&nbsp;on&nbsp;the&nbsp;c.</span><br>
<span class="lineno"></span><span class="keyword" id="4370316">func</span>&nbsp;<span class="op" id="4370321">(</span><span class="ident" id="4370322">c</span>&nbsp;<span class="op" id="4370324">*</span><span class="ident" id="4370325">Certificate</span><span class="op" id="4370336">)</span>&nbsp;<span class="ident" id="4370338">isValid</span><span class="op" id="4370345">(</span><span class="ident" id="4370346">certType</span>&nbsp;<span class="builtintype" id="4370355">int</span><span class="op" id="4370358">,</span>&nbsp;<span class="ident" id="4370360">currentChain</span>&nbsp;<span class="op" id="4370373">[</span><span class="op" id="4370374">]</span><span class="op" id="4370375">*</span><span class="ident" id="4370376">Certificate</span><span class="op" id="4370387">,</span>&nbsp;<span class="ident" id="4370389">opts</span>&nbsp;<span class="op" id="4370394">*</span><span class="ident" id="4370395">VerifyOptions</span><span class="op" id="4370408">)</span>&nbsp;<span class="builtintype" id="4370410">error</span>&nbsp;<span class="op" id="4370416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370419">now</span>&nbsp;<span class="op" id="4370423">:=</span>&nbsp;<span class="ident" id="4370426">opts</span><span class="op" id="4370430">.</span><span class="ident" id="4370431">CurrentTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370444">if</span>&nbsp;<span class="ident" id="4370447">now</span><span class="op" id="4370450">.</span><span class="ident" id="4370451">IsZero</span><span class="op" id="4370457">(</span><span class="op" id="4370458">)</span>&nbsp;<span class="op" id="4370460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370464">now</span>&nbsp;<span class="op" id="4370468">=</span>&nbsp;<span class="ident" id="4370470">time</span><span class="op" id="4370474">.</span><span class="ident" id="4370475">Now</span><span class="op" id="4370478">(</span><span class="op" id="4370479">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4370482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370485">if</span>&nbsp;<span class="ident" id="4370488">now</span><span class="op" id="4370491">.</span><span class="ident" id="4370492">Before</span><span class="op" id="4370498">(</span><span class="ident" id="4370499">c</span><span class="op" id="4370500">.</span><span class="ident" id="4370501">NotBefore</span><span class="op" id="4370510">)</span>&nbsp;<span class="op" id="4370512">||</span>&nbsp;<span class="ident" id="4370515">now</span><span class="op" id="4370518">.</span><span class="ident" id="4370519">After</span><span class="op" id="4370524">(</span><span class="ident" id="4370525">c</span><span class="op" id="4370526">.</span><span class="ident" id="4370527">NotAfter</span><span class="op" id="4370535">)</span>&nbsp;<span class="op" id="4370537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370541">return</span>&nbsp;<span class="ident" id="4370548">CertificateInvalidError</span><span class="op" id="4370571">{</span><span class="ident" id="4370572">c</span><span class="op" id="4370573">,</span>&nbsp;<span class="ident" id="4370575">Expired</span><span class="op" id="4370582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4370585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370589">if</span>&nbsp;<span class="builtinfunc" id="4370592">len</span><span class="op" id="4370595">(</span><span class="ident" id="4370596">c</span><span class="op" id="4370597">.</span><span class="ident" id="4370598">PermittedDNSDomains</span><span class="op" id="4370617">)</span>&nbsp;<span class="op" id="4370619">&gt;</span>&nbsp;<span class="num" id="4370621">0</span>&nbsp;<span class="op" id="4370623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370627">ok</span>&nbsp;<span class="op" id="4370630">:=</span>&nbsp;<span class="builtintype" id="4370633">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370641">for</span>&nbsp;<span class="ident" id="4370645">_</span><span class="op" id="4370646">,</span>&nbsp;<span class="ident" id="4370648">domain</span>&nbsp;<span class="op" id="4370655">:=</span>&nbsp;<span class="keyword" id="4370658">range</span>&nbsp;<span class="ident" id="4370664">c</span><span class="op" id="4370665">.</span><span class="ident" id="4370666">PermittedDNSDomains</span>&nbsp;<span class="op" id="4370686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370691">if</span>&nbsp;<span class="ident" id="4370694">opts</span><span class="op" id="4370698">.</span><span class="ident" id="4370699">DNSName</span>&nbsp;<span class="op" id="4370707">==</span>&nbsp;<span class="ident" id="4370710">domain</span>&nbsp;<span class="op" id="4370717">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4370724">(</span><span class="ident" id="4370725">strings</span><span class="op" id="4370732">.</span><span class="ident" id="4370733">HasSuffix</span><span class="op" id="4370742">(</span><span class="ident" id="4370743">opts</span><span class="op" id="4370747">.</span><span class="ident" id="4370748">DNSName</span><span class="op" id="4370755">,</span>&nbsp;<span class="ident" id="4370757">domain</span><span class="op" id="4370763">)</span>&nbsp;<span class="op" id="4370765">&amp;&amp;</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4370773">len</span><span class="op" id="4370776">(</span><span class="ident" id="4370777">opts</span><span class="op" id="4370781">.</span><span class="ident" id="4370782">DNSName</span><span class="op" id="4370789">)</span>&nbsp;<span class="op" id="4370791">&gt;=</span>&nbsp;<span class="num" id="4370794">1</span><span class="op" id="4370795">+</span><span class="builtinfunc" id="4370796">len</span><span class="op" id="4370799">(</span><span class="ident" id="4370800">domain</span><span class="op" id="4370806">)</span>&nbsp;<span class="op" id="4370808">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370816">opts</span><span class="op" id="4370820">.</span><span class="ident" id="4370821">DNSName</span><span class="op" id="4370828">[</span><span class="builtinfunc" id="4370829">len</span><span class="op" id="4370832">(</span><span class="ident" id="4370833">opts</span><span class="op" id="4370837">.</span><span class="ident" id="4370838">DNSName</span><span class="op" id="4370845">)</span><span class="op" id="4370846">-</span><span class="builtinfunc" id="4370847">len</span><span class="op" id="4370850">(</span><span class="ident" id="4370851">domain</span><span class="op" id="4370857">)</span><span class="op" id="4370858">-</span><span class="num" id="4370859">1</span><span class="op" id="4370860">]</span>&nbsp;<span class="op" id="4370862">==</span>&nbsp;<span class="string" id="4370865">&#39;.&#39;</span><span class="op" id="4370868">)</span>&nbsp;<span class="op" id="4370870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4370876">ok</span>&nbsp;<span class="op" id="4370879">=</span>&nbsp;<span class="builtintype" id="4370881">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370890">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4370899">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4370903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370908">if</span>&nbsp;<span class="op" id="4370911">!</span><span class="ident" id="4370912">ok</span>&nbsp;<span class="op" id="4370915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4370920">return</span>&nbsp;<span class="ident" id="4370927">CertificateInvalidError</span><span class="op" id="4370950">{</span><span class="ident" id="4370951">c</span><span class="op" id="4370952">,</span>&nbsp;<span class="ident" id="4370954">CANotAuthorizedForThisName</span><span class="op" id="4370980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4370984">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4370987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4370991">//&nbsp;KeyUsage&nbsp;status&nbsp;flags&nbsp;are&nbsp;ignored.&nbsp;From&nbsp;Engineering&nbsp;Security,&nbsp;Peter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371063">//&nbsp;Gutmann:&nbsp;A&nbsp;European&nbsp;government&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signing&nbsp;certificates&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371136">//&nbsp;being&nbsp;valid&nbsp;for&nbsp;encryption&nbsp;only,&nbsp;but&nbsp;no-one&nbsp;noticed.&nbsp;Another</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371201">//&nbsp;European&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signature&nbsp;keys&nbsp;as&nbsp;not&nbsp;being&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371266">//&nbsp;signatures.&nbsp;A&nbsp;different&nbsp;CA&nbsp;marked&nbsp;its&nbsp;own&nbsp;trusted&nbsp;root&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371337">//&nbsp;as&nbsp;being&nbsp;invalid&nbsp;for&nbsp;certificate&nbsp;signing.&nbsp;&nbsp;Another&nbsp;national&nbsp;CA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371404">//&nbsp;distributed&nbsp;a&nbsp;certificate&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;data&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371469">//&nbsp;country’s&nbsp;tax&nbsp;authority&nbsp;that&nbsp;was&nbsp;marked&nbsp;as&nbsp;only&nbsp;being&nbsp;usable&nbsp;for</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371540">//&nbsp;digital&nbsp;signatures&nbsp;but&nbsp;not&nbsp;for&nbsp;encryption.&nbsp;Yet&nbsp;another&nbsp;CA&nbsp;reversed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371611">//&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bit&nbsp;flags&nbsp;in&nbsp;the&nbsp;keyUsage&nbsp;due&nbsp;to&nbsp;confusion&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371680">//&nbsp;encoding&nbsp;endianness,&nbsp;essentially&nbsp;setting&nbsp;a&nbsp;random&nbsp;keyUsage&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371746">//&nbsp;certificates&nbsp;that&nbsp;it&nbsp;issued.&nbsp;Another&nbsp;CA&nbsp;created&nbsp;a&nbsp;self-invalidating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371818">//&nbsp;certificate&nbsp;by&nbsp;adding&nbsp;a&nbsp;certificate&nbsp;policy&nbsp;statement&nbsp;stipulating</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371887">//&nbsp;that&nbsp;the&nbsp;certificate&nbsp;had&nbsp;to&nbsp;be&nbsp;used&nbsp;strictly&nbsp;as&nbsp;specified&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4371956">//&nbsp;keyUsage,&nbsp;and&nbsp;a&nbsp;keyUsage&nbsp;containing&nbsp;a&nbsp;flag&nbsp;indicating&nbsp;that&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4372027">//&nbsp;encryption&nbsp;key&nbsp;could&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;Diffie-Hellman&nbsp;key&nbsp;agreement.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372100">if</span>&nbsp;<span class="ident" id="4372103">certType</span>&nbsp;<span class="op" id="4372112">==</span>&nbsp;<span class="ident" id="4372115">intermediateCertificate</span>&nbsp;<span class="op" id="4372139">&amp;&amp;</span>&nbsp;<span class="op" id="4372142">(</span><span class="op" id="4372143">!</span><span class="ident" id="4372144">c</span><span class="op" id="4372145">.</span><span class="ident" id="4372146">BasicConstraintsValid</span>&nbsp;<span class="op" id="4372168">||</span>&nbsp;<span class="op" id="4372171">!</span><span class="ident" id="4372172">c</span><span class="op" id="4372173">.</span><span class="ident" id="4372174">IsCA</span><span class="op" id="4372178">)</span>&nbsp;<span class="op" id="4372180">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372184">return</span>&nbsp;<span class="ident" id="4372191">CertificateInvalidError</span><span class="op" id="4372214">{</span><span class="ident" id="4372215">c</span><span class="op" id="4372216">,</span>&nbsp;<span class="ident" id="4372218">NotAuthorizedToSign</span><span class="op" id="4372237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4372240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372244">if</span>&nbsp;<span class="ident" id="4372247">c</span><span class="op" id="4372248">.</span><span class="ident" id="4372249">BasicConstraintsValid</span>&nbsp;<span class="op" id="4372271">&amp;&amp;</span>&nbsp;<span class="ident" id="4372274">c</span><span class="op" id="4372275">.</span><span class="ident" id="4372276">MaxPathLen</span>&nbsp;<span class="op" id="4372287">&gt;=</span>&nbsp;<span class="num" id="4372290">0</span>&nbsp;<span class="op" id="4372292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4372296">numIntermediates</span>&nbsp;<span class="op" id="4372313">:=</span>&nbsp;<span class="builtinfunc" id="4372316">len</span><span class="op" id="4372319">(</span><span class="ident" id="4372320">currentChain</span><span class="op" id="4372332">)</span>&nbsp;<span class="op" id="4372334">-</span>&nbsp;<span class="num" id="4372336">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372340">if</span>&nbsp;<span class="ident" id="4372343">numIntermediates</span>&nbsp;<span class="op" id="4372360">&gt;</span>&nbsp;<span class="ident" id="4372362">c</span><span class="op" id="4372363">.</span><span class="ident" id="4372364">MaxPathLen</span>&nbsp;<span class="op" id="4372375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372380">return</span>&nbsp;<span class="ident" id="4372387">CertificateInvalidError</span><span class="op" id="4372410">{</span><span class="ident" id="4372411">c</span><span class="op" id="4372412">,</span>&nbsp;<span class="ident" id="4372414">TooManyIntermediates</span><span class="op" id="4372434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4372438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4372441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4372445">return</span>&nbsp;<span class="builtintype" id="4372452">nil</span><br>
<span class="lineno"></span><span class="op" id="4372456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4372459">//&nbsp;Verify&nbsp;attempts&nbsp;to&nbsp;verify&nbsp;c&nbsp;by&nbsp;building&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;from&nbsp;c&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4372533">//&nbsp;certificate&nbsp;in&nbsp;opts.Roots,&nbsp;using&nbsp;certificates&nbsp;in&nbsp;opts.Intermediates&nbsp;if</span><br>
<span class="lineno">205</span><span class="comment" id="4372607">//&nbsp;needed.&nbsp;If&nbsp;successful,&nbsp;it&nbsp;returns&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;where&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="4372679">//&nbsp;element&nbsp;of&nbsp;the&nbsp;chain&nbsp;is&nbsp;c&nbsp;and&nbsp;the&nbsp;last&nbsp;element&nbsp;is&nbsp;from&nbsp;opts.Roots.</span><br>
<span class="lineno"></span><span class="comment" id="4372749">//</span><br>
<span class="lineno"></span><span class="comment" id="4372752">//&nbsp;If&nbsp;opts.Roots&nbsp;is&nbsp;nil&nbsp;and&nbsp;system&nbsp;roots&nbsp;are&nbsp;unavailable&nbsp;the&nbsp;returned&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4372828">//&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;SystemRootsError.</span><br>
<span class="lineno">210</span><span class="comment" id="4372865">//</span><br>
<span class="lineno"></span><span class="comment" id="4372868">//&nbsp;WARNING:&nbsp;this&nbsp;doesn&#39;t&nbsp;do&nbsp;any&nbsp;revocation&nbsp;checking.</span><br>
<span class="lineno"></span><span class="keyword" id="4372921">func</span>&nbsp;<span class="op" id="4372926">(</span><span class="ident" id="4372927">c</span>&nbsp;<span class="op" id="4372929">*</span><span class="ident" id="4372930">Certificate</span><span class="op" id="4372941">)</span>&nbsp;<span class="ident" id="4372943">Verify</span><span class="op" id="4372949">(</span><span class="ident" id="4372950">opts</span>&nbsp;<span class="ident" id="4372955">VerifyOptions</span><span class="op" id="4372968">)</span>&nbsp;<span class="op" id="4372970">(</span><span class="ident" id="4372971">chains</span>&nbsp;<span class="op" id="4372978">[</span><span class="op" id="4372979">]</span><span class="op" id="4372980">[</span><span class="op" id="4372981">]</span><span class="op" id="4372982">*</span><span class="ident" id="4372983">Certificate</span><span class="op" id="4372994">,</span>&nbsp;<span class="ident" id="4372996">err</span>&nbsp;<span class="builtintype" id="4373000">error</span><span class="op" id="4373005">)</span>&nbsp;<span class="op" id="4373007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4373010">//&nbsp;Use&nbsp;Windows&#39;s&nbsp;own&nbsp;verification&nbsp;and&nbsp;chain&nbsp;building.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373065">if</span>&nbsp;<span class="ident" id="4373068">opts</span><span class="op" id="4373072">.</span><span class="ident" id="4373073">Roots</span>&nbsp;<span class="op" id="4373079">==</span>&nbsp;<span class="builtintype" id="4373082">nil</span>&nbsp;<span class="op" id="4373086">&amp;&amp;</span>&nbsp;<span class="ident" id="4373089">runtime</span><span class="op" id="4373096">.</span><span class="ident" id="4373097">GOOS</span>&nbsp;<span class="op" id="4373102">==</span>&nbsp;<span class="string" id="4373105">&#34;windows&#34;</span>&nbsp;<span class="op" id="4373115">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373119">return</span>&nbsp;<span class="ident" id="4373126">c</span><span class="op" id="4373127">.</span><span class="ident" id="4373128">systemVerify</span><span class="op" id="4373140">(</span><span class="op" id="4373141">&amp;</span><span class="ident" id="4373142">opts</span><span class="op" id="4373146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373153">if</span>&nbsp;<span class="ident" id="4373156">opts</span><span class="op" id="4373160">.</span><span class="ident" id="4373161">Roots</span>&nbsp;<span class="op" id="4373167">==</span>&nbsp;<span class="builtintype" id="4373170">nil</span>&nbsp;<span class="op" id="4373174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373178">opts</span><span class="op" id="4373182">.</span><span class="ident" id="4373183">Roots</span>&nbsp;<span class="op" id="4373189">=</span>&nbsp;<span class="ident" id="4373191">systemRootsPool</span><span class="op" id="4373206">(</span><span class="op" id="4373207">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373211">if</span>&nbsp;<span class="ident" id="4373214">opts</span><span class="op" id="4373218">.</span><span class="ident" id="4373219">Roots</span>&nbsp;<span class="op" id="4373225">==</span>&nbsp;<span class="builtintype" id="4373228">nil</span>&nbsp;<span class="op" id="4373232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373237">return</span>&nbsp;<span class="builtintype" id="4373244">nil</span><span class="op" id="4373247">,</span>&nbsp;<span class="ident" id="4373249">SystemRootsError</span><span class="op" id="4373265">{</span><span class="op" id="4373266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373277">err</span>&nbsp;<span class="op" id="4373281">=</span>&nbsp;<span class="ident" id="4373283">c</span><span class="op" id="4373284">.</span><span class="ident" id="4373285">isValid</span><span class="op" id="4373292">(</span><span class="ident" id="4373293">leafCertificate</span><span class="op" id="4373308">,</span>&nbsp;<span class="builtintype" id="4373310">nil</span><span class="op" id="4373313">,</span>&nbsp;<span class="op" id="4373315">&amp;</span><span class="ident" id="4373316">opts</span><span class="op" id="4373320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373323">if</span>&nbsp;<span class="ident" id="4373326">err</span>&nbsp;<span class="op" id="4373330">!=</span>&nbsp;<span class="builtintype" id="4373333">nil</span>&nbsp;<span class="op" id="4373337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373341">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373353">if</span>&nbsp;<span class="builtinfunc" id="4373356">len</span><span class="op" id="4373359">(</span><span class="ident" id="4373360">opts</span><span class="op" id="4373364">.</span><span class="ident" id="4373365">DNSName</span><span class="op" id="4373372">)</span>&nbsp;<span class="op" id="4373374">&gt;</span>&nbsp;<span class="num" id="4373376">0</span>&nbsp;<span class="op" id="4373378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373382">err</span>&nbsp;<span class="op" id="4373386">=</span>&nbsp;<span class="ident" id="4373388">c</span><span class="op" id="4373389">.</span><span class="ident" id="4373390">VerifyHostname</span><span class="op" id="4373404">(</span><span class="ident" id="4373405">opts</span><span class="op" id="4373409">.</span><span class="ident" id="4373410">DNSName</span><span class="op" id="4373417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373421">if</span>&nbsp;<span class="ident" id="4373424">err</span>&nbsp;<span class="op" id="4373428">!=</span>&nbsp;<span class="builtintype" id="4373431">nil</span>&nbsp;<span class="op" id="4373435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373440">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373449">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373456">candidateChains</span><span class="op" id="4373471">,</span>&nbsp;<span class="ident" id="4373473">err</span>&nbsp;<span class="op" id="4373477">:=</span>&nbsp;<span class="ident" id="4373480">c</span><span class="op" id="4373481">.</span><span class="ident" id="4373482">buildChains</span><span class="op" id="4373493">(</span><span class="builtinfunc" id="4373494">make</span><span class="op" id="4373498">(</span><span class="keyword" id="4373499">map</span><span class="op" id="4373502">[</span><span class="builtintype" id="4373503">int</span><span class="op" id="4373506">]</span><span class="op" id="4373507">[</span><span class="op" id="4373508">]</span><span class="op" id="4373509">[</span><span class="op" id="4373510">]</span><span class="op" id="4373511">*</span><span class="ident" id="4373512">Certificate</span><span class="op" id="4373523">)</span><span class="op" id="4373524">,</span>&nbsp;<span class="op" id="4373526">[</span><span class="op" id="4373527">]</span><span class="op" id="4373528">*</span><span class="ident" id="4373529">Certificate</span><span class="op" id="4373540">{</span><span class="ident" id="4373541">c</span><span class="op" id="4373542">}</span><span class="op" id="4373543">,</span>&nbsp;<span class="op" id="4373545">&amp;</span><span class="ident" id="4373546">opts</span><span class="op" id="4373550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373553">if</span>&nbsp;<span class="ident" id="4373556">err</span>&nbsp;<span class="op" id="4373560">!=</span>&nbsp;<span class="builtintype" id="4373563">nil</span>&nbsp;<span class="op" id="4373567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373571">return</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373583">keyUsages</span>&nbsp;<span class="op" id="4373593">:=</span>&nbsp;<span class="ident" id="4373596">opts</span><span class="op" id="4373600">.</span><span class="ident" id="4373601">KeyUsages</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373612">if</span>&nbsp;<span class="builtinfunc" id="4373615">len</span><span class="op" id="4373618">(</span><span class="ident" id="4373619">keyUsages</span><span class="op" id="4373628">)</span>&nbsp;<span class="op" id="4373630">==</span>&nbsp;<span class="num" id="4373633">0</span>&nbsp;<span class="op" id="4373635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373639">keyUsages</span>&nbsp;<span class="op" id="4373649">=</span>&nbsp;<span class="op" id="4373651">[</span><span class="op" id="4373652">]</span><span class="ident" id="4373653">ExtKeyUsage</span><span class="op" id="4373664">{</span><span class="ident" id="4373665">ExtKeyUsageServerAuth</span><span class="op" id="4373686">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4373693">//&nbsp;If&nbsp;any&nbsp;key&nbsp;usage&nbsp;is&nbsp;acceptable&nbsp;then&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373745">for</span>&nbsp;<span class="ident" id="4373749">_</span><span class="op" id="4373750">,</span>&nbsp;<span class="ident" id="4373752">usage</span>&nbsp;<span class="op" id="4373758">:=</span>&nbsp;<span class="keyword" id="4373761">range</span>&nbsp;<span class="ident" id="4373767">keyUsages</span>&nbsp;<span class="op" id="4373777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373781">if</span>&nbsp;<span class="ident" id="4373784">usage</span>&nbsp;<span class="op" id="4373790">==</span>&nbsp;<span class="ident" id="4373793">ExtKeyUsageAny</span>&nbsp;<span class="op" id="4373808">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373813">chains</span>&nbsp;<span class="op" id="4373820">=</span>&nbsp;<span class="ident" id="4373822">candidateChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373841">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373857">for</span>&nbsp;<span class="ident" id="4373861">_</span><span class="op" id="4373862">,</span>&nbsp;<span class="ident" id="4373864">candidate</span>&nbsp;<span class="op" id="4373874">:=</span>&nbsp;<span class="keyword" id="4373877">range</span>&nbsp;<span class="ident" id="4373883">candidateChains</span>&nbsp;<span class="op" id="4373899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373903">if</span>&nbsp;<span class="ident" id="4373906">checkChainForKeyUsage</span><span class="op" id="4373927">(</span><span class="ident" id="4373928">candidate</span><span class="op" id="4373937">,</span>&nbsp;<span class="ident" id="4373939">keyUsages</span><span class="op" id="4373948">)</span>&nbsp;<span class="op" id="4373950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373955">chains</span>&nbsp;<span class="op" id="4373962">=</span>&nbsp;<span class="builtinfunc" id="4373964">append</span><span class="op" id="4373970">(</span><span class="ident" id="4373971">chains</span><span class="op" id="4373977">,</span>&nbsp;<span class="ident" id="4373979">candidate</span><span class="op" id="4373988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373995">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373999">if</span>&nbsp;<span class="builtinfunc" id="4374002">len</span><span class="op" id="4374005">(</span><span class="ident" id="4374006">chains</span><span class="op" id="4374012">)</span>&nbsp;<span class="op" id="4374014">==</span>&nbsp;<span class="num" id="4374017">0</span>&nbsp;<span class="op" id="4374019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374023">err</span>&nbsp;<span class="op" id="4374027">=</span>&nbsp;<span class="ident" id="4374029">CertificateInvalidError</span><span class="op" id="4374052">{</span><span class="ident" id="4374053">c</span><span class="op" id="4374054">,</span>&nbsp;<span class="ident" id="4374056">IncompatibleUsage</span><span class="op" id="4374073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4374076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374080">return</span><br>
<span class="lineno"></span><span class="op" id="4374087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4374090">func</span>&nbsp;<span class="ident" id="4374095">appendToFreshChain</span><span class="op" id="4374113">(</span><span class="ident" id="4374114">chain</span>&nbsp;<span class="op" id="4374120">[</span><span class="op" id="4374121">]</span><span class="op" id="4374122">*</span><span class="ident" id="4374123">Certificate</span><span class="op" id="4374134">,</span>&nbsp;<span class="ident" id="4374136">cert</span>&nbsp;<span class="op" id="4374141">*</span><span class="ident" id="4374142">Certificate</span><span class="op" id="4374153">)</span>&nbsp;<span class="op" id="4374155">[</span><span class="op" id="4374156">]</span><span class="op" id="4374157">*</span><span class="ident" id="4374158">Certificate</span>&nbsp;<span class="op" id="4374170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374173">n</span>&nbsp;<span class="op" id="4374175">:=</span>&nbsp;<span class="builtinfunc" id="4374178">make</span><span class="op" id="4374182">(</span><span class="op" id="4374183">[</span><span class="op" id="4374184">]</span><span class="op" id="4374185">*</span><span class="ident" id="4374186">Certificate</span><span class="op" id="4374197">,</span>&nbsp;<span class="builtinfunc" id="4374199">len</span><span class="op" id="4374202">(</span><span class="ident" id="4374203">chain</span><span class="op" id="4374208">)</span><span class="op" id="4374209">+</span><span class="num" id="4374210">1</span><span class="op" id="4374211">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4374214">copy</span><span class="op" id="4374218">(</span><span class="ident" id="4374219">n</span><span class="op" id="4374220">,</span>&nbsp;<span class="ident" id="4374222">chain</span><span class="op" id="4374227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374230">n</span><span class="op" id="4374231">[</span><span class="builtinfunc" id="4374232">len</span><span class="op" id="4374235">(</span><span class="ident" id="4374236">chain</span><span class="op" id="4374241">)</span><span class="op" id="4374242">]</span>&nbsp;<span class="op" id="4374244">=</span>&nbsp;<span class="ident" id="4374246">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374252">return</span>&nbsp;<span class="ident" id="4374259">n</span><br>
<span class="lineno"></span><span class="op" id="4374261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="4374264">func</span>&nbsp;<span class="op" id="4374269">(</span><span class="ident" id="4374270">c</span>&nbsp;<span class="op" id="4374272">*</span><span class="ident" id="4374273">Certificate</span><span class="op" id="4374284">)</span>&nbsp;<span class="ident" id="4374286">buildChains</span><span class="op" id="4374297">(</span><span class="ident" id="4374298">cache</span>&nbsp;<span class="keyword" id="4374304">map</span><span class="op" id="4374307">[</span><span class="builtintype" id="4374308">int</span><span class="op" id="4374311">]</span><span class="op" id="4374312">[</span><span class="op" id="4374313">]</span><span class="op" id="4374314">[</span><span class="op" id="4374315">]</span><span class="op" id="4374316">*</span><span class="ident" id="4374317">Certificate</span><span class="op" id="4374328">,</span>&nbsp;<span class="ident" id="4374330">currentChain</span>&nbsp;<span class="op" id="4374343">[</span><span class="op" id="4374344">]</span><span class="op" id="4374345">*</span><span class="ident" id="4374346">Certificate</span><span class="op" id="4374357">,</span>&nbsp;<span class="ident" id="4374359">opts</span>&nbsp;<span class="op" id="4374364">*</span><span class="ident" id="4374365">VerifyOptions</span><span class="op" id="4374378">)</span>&nbsp;<span class="op" id="4374380">(</span><span class="ident" id="4374381">chains</span>&nbsp;<span class="op" id="4374388">[</span><span class="op" id="4374389">]</span><span class="op" id="4374390">[</span><span class="op" id="4374391">]</span><span class="op" id="4374392">*</span><span class="ident" id="4374393">Certificate</span><span class="op" id="4374404">,</span>&nbsp;<span class="ident" id="4374406">err</span>&nbsp;<span class="builtintype" id="4374410">error</span><span class="op" id="4374415">)</span>&nbsp;<span class="op" id="4374417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374420">possibleRoots</span><span class="op" id="4374433">,</span>&nbsp;<span class="ident" id="4374435">failedRoot</span><span class="op" id="4374445">,</span>&nbsp;<span class="ident" id="4374447">rootErr</span>&nbsp;<span class="op" id="4374455">:=</span>&nbsp;<span class="ident" id="4374458">opts</span><span class="op" id="4374462">.</span><span class="ident" id="4374463">Roots</span><span class="op" id="4374468">.</span><span class="ident" id="4374469">findVerifiedParents</span><span class="op" id="4374488">(</span><span class="ident" id="4374489">c</span><span class="op" id="4374490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374493">for</span>&nbsp;<span class="ident" id="4374497">_</span><span class="op" id="4374498">,</span>&nbsp;<span class="ident" id="4374500">rootNum</span>&nbsp;<span class="op" id="4374508">:=</span>&nbsp;<span class="keyword" id="4374511">range</span>&nbsp;<span class="ident" id="4374517">possibleRoots</span>&nbsp;<span class="op" id="4374531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374535">root</span>&nbsp;<span class="op" id="4374540">:=</span>&nbsp;<span class="ident" id="4374543">opts</span><span class="op" id="4374547">.</span><span class="ident" id="4374548">Roots</span><span class="op" id="4374553">.</span><span class="ident" id="4374554">certs</span><span class="op" id="4374559">[</span><span class="ident" id="4374560">rootNum</span><span class="op" id="4374567">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374571">err</span>&nbsp;<span class="op" id="4374575">=</span>&nbsp;<span class="ident" id="4374577">root</span><span class="op" id="4374581">.</span><span class="ident" id="4374582">isValid</span><span class="op" id="4374589">(</span><span class="ident" id="4374590">rootCertificate</span><span class="op" id="4374605">,</span>&nbsp;<span class="ident" id="4374607">currentChain</span><span class="op" id="4374619">,</span>&nbsp;<span class="ident" id="4374621">opts</span><span class="op" id="4374625">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374629">if</span>&nbsp;<span class="ident" id="4374632">err</span>&nbsp;<span class="op" id="4374636">!=</span>&nbsp;<span class="builtintype" id="4374639">nil</span>&nbsp;<span class="op" id="4374643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374648">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4374659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374663">chains</span>&nbsp;<span class="op" id="4374670">=</span>&nbsp;<span class="builtinfunc" id="4374672">append</span><span class="op" id="4374678">(</span><span class="ident" id="4374679">chains</span><span class="op" id="4374685">,</span>&nbsp;<span class="ident" id="4374687">appendToFreshChain</span><span class="op" id="4374705">(</span><span class="ident" id="4374706">currentChain</span><span class="op" id="4374718">,</span>&nbsp;<span class="ident" id="4374720">root</span><span class="op" id="4374724">)</span><span class="op" id="4374725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4374728">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374732">possibleIntermediates</span><span class="op" id="4374753">,</span>&nbsp;<span class="ident" id="4374755">failedIntermediate</span><span class="op" id="4374773">,</span>&nbsp;<span class="ident" id="4374775">intermediateErr</span>&nbsp;<span class="op" id="4374791">:=</span>&nbsp;<span class="ident" id="4374794">opts</span><span class="op" id="4374798">.</span><span class="ident" id="4374799">Intermediates</span><span class="op" id="4374812">.</span><span class="ident" id="4374813">findVerifiedParents</span><span class="op" id="4374832">(</span><span class="ident" id="4374833">c</span><span class="op" id="4374834">)</span><br>
<span class="lineno"></span><span class="ident" id="4374836">nextIntermediate</span><span class="op" id="4374852">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374855">for</span>&nbsp;<span class="ident" id="4374859">_</span><span class="op" id="4374860">,</span>&nbsp;<span class="ident" id="4374862">intermediateNum</span>&nbsp;<span class="op" id="4374878">:=</span>&nbsp;<span class="keyword" id="4374881">range</span>&nbsp;<span class="ident" id="4374887">possibleIntermediates</span>&nbsp;<span class="op" id="4374909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374913">intermediate</span>&nbsp;<span class="op" id="4374926">:=</span>&nbsp;<span class="ident" id="4374929">opts</span><span class="op" id="4374933">.</span><span class="ident" id="4374934">Intermediates</span><span class="op" id="4374947">.</span><span class="ident" id="4374948">certs</span><span class="op" id="4374953">[</span><span class="ident" id="4374954">intermediateNum</span><span class="op" id="4374969">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374973">for</span>&nbsp;<span class="ident" id="4374977">_</span><span class="op" id="4374978">,</span>&nbsp;<span class="ident" id="4374980">cert</span>&nbsp;<span class="op" id="4374985">:=</span>&nbsp;<span class="keyword" id="4374988">range</span>&nbsp;<span class="ident" id="4374994">currentChain</span>&nbsp;<span class="op" id="4375007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375012">if</span>&nbsp;<span class="ident" id="4375015">cert</span>&nbsp;<span class="op" id="4375020">==</span>&nbsp;<span class="ident" id="4375023">intermediate</span>&nbsp;<span class="op" id="4375036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375042">continue</span>&nbsp;<span class="ident" id="4375051">nextIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375075">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375079">err</span>&nbsp;<span class="op" id="4375083">=</span>&nbsp;<span class="ident" id="4375085">intermediate</span><span class="op" id="4375097">.</span><span class="ident" id="4375098">isValid</span><span class="op" id="4375105">(</span><span class="ident" id="4375106">intermediateCertificate</span><span class="op" id="4375129">,</span>&nbsp;<span class="ident" id="4375131">currentChain</span><span class="op" id="4375143">,</span>&nbsp;<span class="ident" id="4375145">opts</span><span class="op" id="4375149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375153">if</span>&nbsp;<span class="ident" id="4375156">err</span>&nbsp;<span class="op" id="4375160">!=</span>&nbsp;<span class="builtintype" id="4375163">nil</span>&nbsp;<span class="op" id="4375167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375172">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375187">var</span>&nbsp;<span class="ident" id="4375191">childChains</span>&nbsp;<span class="op" id="4375203">[</span><span class="op" id="4375204">]</span><span class="op" id="4375205">[</span><span class="op" id="4375206">]</span><span class="op" id="4375207">*</span><span class="ident" id="4375208">Certificate</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375222">childChains</span><span class="op" id="4375233">,</span>&nbsp;<span class="ident" id="4375235">ok</span>&nbsp;<span class="op" id="4375238">:=</span>&nbsp;<span class="ident" id="4375241">cache</span><span class="op" id="4375246">[</span><span class="ident" id="4375247">intermediateNum</span><span class="op" id="4375262">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375266">if</span>&nbsp;<span class="op" id="4375269">!</span><span class="ident" id="4375270">ok</span>&nbsp;<span class="op" id="4375273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375278">childChains</span><span class="op" id="4375289">,</span>&nbsp;<span class="ident" id="4375291">err</span>&nbsp;<span class="op" id="4375295">=</span>&nbsp;<span class="ident" id="4375297">intermediate</span><span class="op" id="4375309">.</span><span class="ident" id="4375310">buildChains</span><span class="op" id="4375321">(</span><span class="ident" id="4375322">cache</span><span class="op" id="4375327">,</span>&nbsp;<span class="ident" id="4375329">appendToFreshChain</span><span class="op" id="4375347">(</span><span class="ident" id="4375348">currentChain</span><span class="op" id="4375360">,</span>&nbsp;<span class="ident" id="4375362">intermediate</span><span class="op" id="4375374">)</span><span class="op" id="4375375">,</span>&nbsp;<span class="ident" id="4375377">opts</span><span class="op" id="4375381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375386">cache</span><span class="op" id="4375391">[</span><span class="ident" id="4375392">intermediateNum</span><span class="op" id="4375407">]</span>&nbsp;<span class="op" id="4375409">=</span>&nbsp;<span class="ident" id="4375411">childChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375425">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375429">chains</span>&nbsp;<span class="op" id="4375436">=</span>&nbsp;<span class="builtinfunc" id="4375438">append</span><span class="op" id="4375444">(</span><span class="ident" id="4375445">chains</span><span class="op" id="4375451">,</span>&nbsp;<span class="ident" id="4375453">childChains</span><span class="op" id="4375464">...</span><span class="op" id="4375467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375474">if</span>&nbsp;<span class="builtinfunc" id="4375477">len</span><span class="op" id="4375480">(</span><span class="ident" id="4375481">chains</span><span class="op" id="4375487">)</span>&nbsp;<span class="op" id="4375489">&gt;</span>&nbsp;<span class="num" id="4375491">0</span>&nbsp;<span class="op" id="4375493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375497">err</span>&nbsp;<span class="op" id="4375501">=</span>&nbsp;<span class="builtintype" id="4375503">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375512">if</span>&nbsp;<span class="builtinfunc" id="4375515">len</span><span class="op" id="4375518">(</span><span class="ident" id="4375519">chains</span><span class="op" id="4375525">)</span>&nbsp;<span class="op" id="4375527">==</span>&nbsp;<span class="num" id="4375530">0</span>&nbsp;<span class="op" id="4375532">&amp;&amp;</span>&nbsp;<span class="ident" id="4375535">err</span>&nbsp;<span class="op" id="4375539">==</span>&nbsp;<span class="builtintype" id="4375542">nil</span>&nbsp;<span class="op" id="4375546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375550">hintErr</span>&nbsp;<span class="op" id="4375558">:=</span>&nbsp;<span class="ident" id="4375561">rootErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375571">hintCert</span>&nbsp;<span class="op" id="4375580">:=</span>&nbsp;<span class="ident" id="4375583">failedRoot</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375596">if</span>&nbsp;<span class="ident" id="4375599">hintErr</span>&nbsp;<span class="op" id="4375607">==</span>&nbsp;<span class="builtintype" id="4375610">nil</span>&nbsp;<span class="op" id="4375614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375619">hintErr</span>&nbsp;<span class="op" id="4375627">=</span>&nbsp;<span class="ident" id="4375629">intermediateErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375648">hintCert</span>&nbsp;<span class="op" id="4375657">=</span>&nbsp;<span class="ident" id="4375659">failedIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375684">err</span>&nbsp;<span class="op" id="4375688">=</span>&nbsp;<span class="ident" id="4375690">UnknownAuthorityError</span><span class="op" id="4375711">{</span><span class="ident" id="4375712">c</span><span class="op" id="4375713">,</span>&nbsp;<span class="ident" id="4375715">hintErr</span><span class="op" id="4375722">,</span>&nbsp;<span class="ident" id="4375724">hintCert</span><span class="op" id="4375732">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375739">return</span><br>
<span class="lineno"></span><span class="op" id="4375746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="keyword" id="4375749">func</span>&nbsp;<span class="ident" id="4375754">matchHostnames</span><span class="op" id="4375768">(</span><span class="ident" id="4375769">pattern</span><span class="op" id="4375776">,</span>&nbsp;<span class="ident" id="4375778">host</span>&nbsp;<span class="builtintype" id="4375783">string</span><span class="op" id="4375789">)</span>&nbsp;<span class="builtintype" id="4375791">bool</span>&nbsp;<span class="op" id="4375796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375799">if</span>&nbsp;<span class="builtinfunc" id="4375802">len</span><span class="op" id="4375805">(</span><span class="ident" id="4375806">pattern</span><span class="op" id="4375813">)</span>&nbsp;<span class="op" id="4375815">==</span>&nbsp;<span class="num" id="4375818">0</span>&nbsp;<span class="op" id="4375820">||</span>&nbsp;<span class="builtinfunc" id="4375823">len</span><span class="op" id="4375826">(</span><span class="ident" id="4375827">host</span><span class="op" id="4375831">)</span>&nbsp;<span class="op" id="4375833">==</span>&nbsp;<span class="num" id="4375836">0</span>&nbsp;<span class="op" id="4375838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375842">return</span>&nbsp;<span class="builtintype" id="4375849">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375860">patternParts</span>&nbsp;<span class="op" id="4375873">:=</span>&nbsp;<span class="ident" id="4375876">strings</span><span class="op" id="4375883">.</span><span class="ident" id="4375884">Split</span><span class="op" id="4375889">(</span><span class="ident" id="4375890">pattern</span><span class="op" id="4375897">,</span>&nbsp;<span class="string" id="4375899">&#34;.&#34;</span><span class="op" id="4375902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375905">hostParts</span>&nbsp;<span class="op" id="4375915">:=</span>&nbsp;<span class="ident" id="4375918">strings</span><span class="op" id="4375925">.</span><span class="ident" id="4375926">Split</span><span class="op" id="4375931">(</span><span class="ident" id="4375932">host</span><span class="op" id="4375936">,</span>&nbsp;<span class="string" id="4375938">&#34;.&#34;</span><span class="op" id="4375941">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375945">if</span>&nbsp;<span class="builtinfunc" id="4375948">len</span><span class="op" id="4375951">(</span><span class="ident" id="4375952">patternParts</span><span class="op" id="4375964">)</span>&nbsp;<span class="op" id="4375966">!=</span>&nbsp;<span class="builtinfunc" id="4375969">len</span><span class="op" id="4375972">(</span><span class="ident" id="4375973">hostParts</span><span class="op" id="4375982">)</span>&nbsp;<span class="op" id="4375984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375988">return</span>&nbsp;<span class="builtintype" id="4375995">false</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376006">for</span>&nbsp;<span class="ident" id="4376010">i</span><span class="op" id="4376011">,</span>&nbsp;<span class="ident" id="4376013">patternPart</span>&nbsp;<span class="op" id="4376025">:=</span>&nbsp;<span class="keyword" id="4376028">range</span>&nbsp;<span class="ident" id="4376034">patternParts</span>&nbsp;<span class="op" id="4376047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376051">if</span>&nbsp;<span class="ident" id="4376054">patternPart</span>&nbsp;<span class="op" id="4376066">==</span>&nbsp;<span class="string" id="4376069">&#34;*&#34;</span>&nbsp;<span class="op" id="4376073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376078">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376093">if</span>&nbsp;<span class="ident" id="4376096">patternPart</span>&nbsp;<span class="op" id="4376108">!=</span>&nbsp;<span class="ident" id="4376111">hostParts</span><span class="op" id="4376120">[</span><span class="ident" id="4376121">i</span><span class="op" id="4376122">]</span>&nbsp;<span class="op" id="4376124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376129">return</span>&nbsp;<span class="builtintype" id="4376136">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376147">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376151">return</span>&nbsp;<span class="builtintype" id="4376158">true</span><br>
<span class="lineno"></span><span class="op" id="4376163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4376166">//&nbsp;toLowerCaseASCII&nbsp;returns&nbsp;a&nbsp;lower-case&nbsp;version&nbsp;of&nbsp;in.&nbsp;See&nbsp;RFC&nbsp;6125&nbsp;6.4.1.&nbsp;We&nbsp;use</span><br>
<span class="lineno">350</span><span class="comment" id="4376249">//&nbsp;an&nbsp;explicitly&nbsp;ASCII&nbsp;function&nbsp;to&nbsp;avoid&nbsp;any&nbsp;sharp&nbsp;corners&nbsp;resulting&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4376323">//&nbsp;performing&nbsp;Unicode&nbsp;operations&nbsp;on&nbsp;DNS&nbsp;labels.</span><br>
<span class="lineno"></span><span class="keyword" id="4376371">func</span>&nbsp;<span class="ident" id="4376376">toLowerCaseASCII</span><span class="op" id="4376392">(</span><span class="ident" id="4376393">in</span>&nbsp;<span class="builtintype" id="4376396">string</span><span class="op" id="4376402">)</span>&nbsp;<span class="builtintype" id="4376404">string</span>&nbsp;<span class="op" id="4376411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4376414">//&nbsp;If&nbsp;the&nbsp;string&nbsp;is&nbsp;already&nbsp;lower-case&nbsp;then&nbsp;there&#39;s&nbsp;nothing&nbsp;to&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376482">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4376501">:=</span>&nbsp;<span class="builtintype" id="4376504">true</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376510">for</span>&nbsp;<span class="ident" id="4376514">_</span><span class="op" id="4376515">,</span>&nbsp;<span class="ident" id="4376517">c</span>&nbsp;<span class="op" id="4376519">:=</span>&nbsp;<span class="keyword" id="4376522">range</span>&nbsp;<span class="ident" id="4376528">in</span>&nbsp;<span class="op" id="4376531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376535">if</span>&nbsp;<span class="ident" id="4376538">c</span>&nbsp;<span class="op" id="4376540">==</span>&nbsp;<span class="ident" id="4376543">utf8</span><span class="op" id="4376547">.</span><span class="ident" id="4376548">RuneError</span>&nbsp;<span class="op" id="4376558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4376563">//&nbsp;If&nbsp;we&nbsp;get&nbsp;a&nbsp;UTF-8&nbsp;error&nbsp;then&nbsp;there&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4376613">//&nbsp;upper-case&nbsp;ASCII&nbsp;bytes&nbsp;in&nbsp;the&nbsp;invalid&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376667">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4376686">=</span>&nbsp;<span class="builtintype" id="4376688">false</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376697">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376709">if</span>&nbsp;<span class="string" id="4376712">&#39;A&#39;</span>&nbsp;<span class="op" id="4376716">&lt;=</span>&nbsp;<span class="ident" id="4376719">c</span>&nbsp;<span class="op" id="4376721">&amp;&amp;</span>&nbsp;<span class="ident" id="4376724">c</span>&nbsp;<span class="op" id="4376726">&lt;=</span>&nbsp;<span class="string" id="4376729">&#39;Z&#39;</span>&nbsp;<span class="op" id="4376733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376738">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4376757">=</span>&nbsp;<span class="builtintype" id="4376759">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376768">break</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376783">if</span>&nbsp;<span class="ident" id="4376786">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4376805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376809">return</span>&nbsp;<span class="ident" id="4376816">in</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376824">out</span>&nbsp;<span class="op" id="4376828">:=</span>&nbsp;<span class="op" id="4376831">[</span><span class="op" id="4376832">]</span><span class="builtintype" id="4376833">byte</span><span class="op" id="4376837">(</span><span class="ident" id="4376838">in</span><span class="op" id="4376840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376843">for</span>&nbsp;<span class="ident" id="4376847">i</span><span class="op" id="4376848">,</span>&nbsp;<span class="ident" id="4376850">c</span>&nbsp;<span class="op" id="4376852">:=</span>&nbsp;<span class="keyword" id="4376855">range</span>&nbsp;<span class="ident" id="4376861">out</span>&nbsp;<span class="op" id="4376865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376869">if</span>&nbsp;<span class="string" id="4376872">&#39;A&#39;</span>&nbsp;<span class="op" id="4376876">&lt;=</span>&nbsp;<span class="ident" id="4376879">c</span>&nbsp;<span class="op" id="4376881">&amp;&amp;</span>&nbsp;<span class="ident" id="4376884">c</span>&nbsp;<span class="op" id="4376886">&lt;=</span>&nbsp;<span class="string" id="4376889">&#39;Z&#39;</span>&nbsp;<span class="op" id="4376893">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376898">out</span><span class="op" id="4376901">[</span><span class="ident" id="4376902">i</span><span class="op" id="4376903">]</span>&nbsp;<span class="op" id="4376905">+=</span>&nbsp;<span class="string" id="4376908">&#39;a&#39;</span>&nbsp;<span class="op" id="4376912">-</span>&nbsp;<span class="string" id="4376914">&#39;A&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376926">return</span>&nbsp;<span class="builtintype" id="4376933">string</span><span class="op" id="4376939">(</span><span class="ident" id="4376940">out</span><span class="op" id="4376943">)</span><br>
<span class="lineno"></span><span class="op" id="4376945">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="4376948">//&nbsp;VerifyHostname&nbsp;returns&nbsp;nil&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;valid&nbsp;certificate&nbsp;for&nbsp;the&nbsp;named&nbsp;host.</span><br>
<span class="lineno"></span><span class="comment" id="4377026">//&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error&nbsp;describing&nbsp;the&nbsp;mismatch.</span><br>
<span class="lineno"></span><span class="keyword" id="4377084">func</span>&nbsp;<span class="op" id="4377089">(</span><span class="ident" id="4377090">c</span>&nbsp;<span class="op" id="4377092">*</span><span class="ident" id="4377093">Certificate</span><span class="op" id="4377104">)</span>&nbsp;<span class="ident" id="4377106">VerifyHostname</span><span class="op" id="4377120">(</span><span class="ident" id="4377121">h</span>&nbsp;<span class="builtintype" id="4377123">string</span><span class="op" id="4377129">)</span>&nbsp;<span class="builtintype" id="4377131">error</span>&nbsp;<span class="op" id="4377137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4377140">//&nbsp;IP&nbsp;addresses&nbsp;may&nbsp;be&nbsp;written&nbsp;in&nbsp;[&nbsp;].</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377180">candidateIP</span>&nbsp;<span class="op" id="4377192">:=</span>&nbsp;<span class="ident" id="4377195">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377198">if</span>&nbsp;<span class="builtinfunc" id="4377201">len</span><span class="op" id="4377204">(</span><span class="ident" id="4377205">h</span><span class="op" id="4377206">)</span>&nbsp;<span class="op" id="4377208">&gt;=</span>&nbsp;<span class="num" id="4377211">3</span>&nbsp;<span class="op" id="4377213">&amp;&amp;</span>&nbsp;<span class="ident" id="4377216">h</span><span class="op" id="4377217">[</span><span class="num" id="4377218">0</span><span class="op" id="4377219">]</span>&nbsp;<span class="op" id="4377221">==</span>&nbsp;<span class="string" id="4377224">&#39;[&#39;</span>&nbsp;<span class="op" id="4377228">&amp;&amp;</span>&nbsp;<span class="ident" id="4377231">h</span><span class="op" id="4377232">[</span><span class="builtinfunc" id="4377233">len</span><span class="op" id="4377236">(</span><span class="ident" id="4377237">h</span><span class="op" id="4377238">)</span><span class="op" id="4377239">-</span><span class="num" id="4377240">1</span><span class="op" id="4377241">]</span>&nbsp;<span class="op" id="4377243">==</span>&nbsp;<span class="string" id="4377246">&#39;]&#39;</span>&nbsp;<span class="op" id="4377250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377254">candidateIP</span>&nbsp;<span class="op" id="4377266">=</span>&nbsp;<span class="ident" id="4377268">h</span><span class="op" id="4377269">[</span><span class="num" id="4377270">1</span>&nbsp;<span class="op" id="4377272">:</span>&nbsp;<span class="builtinfunc" id="4377274">len</span><span class="op" id="4377277">(</span><span class="ident" id="4377278">h</span><span class="op" id="4377279">)</span><span class="op" id="4377280">-</span><span class="num" id="4377281">1</span><span class="op" id="4377282">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377288">if</span>&nbsp;<span class="ident" id="4377291">ip</span>&nbsp;<span class="op" id="4377294">:=</span>&nbsp;<span class="ident" id="4377297">net</span><span class="op" id="4377300">.</span><span class="ident" id="4377301">ParseIP</span><span class="op" id="4377308">(</span><span class="ident" id="4377309">candidateIP</span><span class="op" id="4377320">)</span><span class="op" id="4377321">;</span>&nbsp;<span class="ident" id="4377323">ip</span>&nbsp;<span class="op" id="4377326">!=</span>&nbsp;<span class="builtintype" id="4377329">nil</span>&nbsp;<span class="op" id="4377333">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4377337">//&nbsp;We&nbsp;only&nbsp;match&nbsp;IP&nbsp;addresses&nbsp;against&nbsp;IP&nbsp;SANs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4377386">//&nbsp;https://tools.ietf.org/html/rfc6125#appendix-B.2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377440">for</span>&nbsp;<span class="ident" id="4377444">_</span><span class="op" id="4377445">,</span>&nbsp;<span class="ident" id="4377447">candidate</span>&nbsp;<span class="op" id="4377457">:=</span>&nbsp;<span class="keyword" id="4377460">range</span>&nbsp;<span class="ident" id="4377466">c</span><span class="op" id="4377467">.</span><span class="ident" id="4377468">IPAddresses</span>&nbsp;<span class="op" id="4377480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377485">if</span>&nbsp;<span class="ident" id="4377488">ip</span><span class="op" id="4377490">.</span><span class="ident" id="4377491">Equal</span><span class="op" id="4377496">(</span><span class="ident" id="4377497">candidate</span><span class="op" id="4377506">)</span>&nbsp;<span class="op" id="4377508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377514">return</span>&nbsp;<span class="builtintype" id="4377521">nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377536">return</span>&nbsp;<span class="ident" id="4377543">HostnameError</span><span class="op" id="4377556">{</span><span class="ident" id="4377557">c</span><span class="op" id="4377558">,</span>&nbsp;<span class="ident" id="4377560">candidateIP</span><span class="op" id="4377571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377578">lowered</span>&nbsp;<span class="op" id="4377586">:=</span>&nbsp;<span class="ident" id="4377589">toLowerCaseASCII</span><span class="op" id="4377605">(</span><span class="ident" id="4377606">h</span><span class="op" id="4377607">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377611">if</span>&nbsp;<span class="builtinfunc" id="4377614">len</span><span class="op" id="4377617">(</span><span class="ident" id="4377618">c</span><span class="op" id="4377619">.</span><span class="ident" id="4377620">DNSNames</span><span class="op" id="4377628">)</span>&nbsp;<span class="op" id="4377630">&gt;</span>&nbsp;<span class="num" id="4377632">0</span>&nbsp;<span class="op" id="4377634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377638">for</span>&nbsp;<span class="ident" id="4377642">_</span><span class="op" id="4377643">,</span>&nbsp;<span class="ident" id="4377645">match</span>&nbsp;<span class="op" id="4377651">:=</span>&nbsp;<span class="keyword" id="4377654">range</span>&nbsp;<span class="ident" id="4377660">c</span><span class="op" id="4377661">.</span><span class="ident" id="4377662">DNSNames</span>&nbsp;<span class="op" id="4377671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377676">if</span>&nbsp;<span class="ident" id="4377679">matchHostnames</span><span class="op" id="4377693">(</span><span class="ident" id="4377694">toLowerCaseASCII</span><span class="op" id="4377710">(</span><span class="ident" id="4377711">match</span><span class="op" id="4377716">)</span><span class="op" id="4377717">,</span>&nbsp;<span class="ident" id="4377719">lowered</span><span class="op" id="4377726">)</span>&nbsp;<span class="op" id="4377728">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377734">return</span>&nbsp;<span class="builtintype" id="4377741">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4377756">//&nbsp;If&nbsp;Subject&nbsp;Alt&nbsp;Name&nbsp;is&nbsp;given,&nbsp;we&nbsp;ignore&nbsp;the&nbsp;common&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377817">}</span>&nbsp;<span class="keyword" id="4377819">else</span>&nbsp;<span class="keyword" id="4377824">if</span>&nbsp;<span class="ident" id="4377827">matchHostnames</span><span class="op" id="4377841">(</span><span class="ident" id="4377842">toLowerCaseASCII</span><span class="op" id="4377858">(</span><span class="ident" id="4377859">c</span><span class="op" id="4377860">.</span><span class="ident" id="4377861">Subject</span><span class="op" id="4377868">.</span><span class="ident" id="4377869">CommonName</span><span class="op" id="4377879">)</span><span class="op" id="4377880">,</span>&nbsp;<span class="ident" id="4377882">lowered</span><span class="op" id="4377889">)</span>&nbsp;<span class="op" id="4377891">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377895">return</span>&nbsp;<span class="builtintype" id="4377902">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377911">return</span>&nbsp;<span class="ident" id="4377918">HostnameError</span><span class="op" id="4377931">{</span><span class="ident" id="4377932">c</span><span class="op" id="4377933">,</span>&nbsp;<span class="ident" id="4377935">h</span><span class="op" id="4377936">}</span><br>
<span class="lineno"></span><span class="op" id="4377938">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span><span class="keyword" id="4377941">func</span>&nbsp;<span class="ident" id="4377946">checkChainForKeyUsage</span><span class="op" id="4377967">(</span><span class="ident" id="4377968">chain</span>&nbsp;<span class="op" id="4377974">[</span><span class="op" id="4377975">]</span><span class="op" id="4377976">*</span><span class="ident" id="4377977">Certificate</span><span class="op" id="4377988">,</span>&nbsp;<span class="ident" id="4377990">keyUsages</span>&nbsp;<span class="op" id="4378000">[</span><span class="op" id="4378001">]</span><span class="ident" id="4378002">ExtKeyUsage</span><span class="op" id="4378013">)</span>&nbsp;<span class="builtintype" id="4378015">bool</span>&nbsp;<span class="op" id="4378020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4378023">usages</span>&nbsp;<span class="op" id="4378030">:=</span>&nbsp;<span class="builtinfunc" id="4378033">make</span><span class="op" id="4378037">(</span><span class="op" id="4378038">[</span><span class="op" id="4378039">]</span><span class="ident" id="4378040">ExtKeyUsage</span><span class="op" id="4378051">,</span>&nbsp;<span class="builtinfunc" id="4378053">len</span><span class="op" id="4378056">(</span><span class="ident" id="4378057">keyUsages</span><span class="op" id="4378066">)</span><span class="op" id="4378067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4378070">copy</span><span class="op" id="4378074">(</span><span class="ident" id="4378075">usages</span><span class="op" id="4378081">,</span>&nbsp;<span class="ident" id="4378083">keyUsages</span><span class="op" id="4378092">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378096">if</span>&nbsp;<span class="builtinfunc" id="4378099">len</span><span class="op" id="4378102">(</span><span class="ident" id="4378103">chain</span><span class="op" id="4378108">)</span>&nbsp;<span class="op" id="4378110">==</span>&nbsp;<span class="num" id="4378113">0</span>&nbsp;<span class="op" id="4378115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378119">return</span>&nbsp;<span class="builtintype" id="4378126">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4378137">usagesRemaining</span>&nbsp;<span class="op" id="4378153">:=</span>&nbsp;<span class="builtinfunc" id="4378156">len</span><span class="op" id="4378159">(</span><span class="ident" id="4378160">usages</span><span class="op" id="4378166">)</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4378170">//&nbsp;We&nbsp;walk&nbsp;down&nbsp;the&nbsp;list&nbsp;and&nbsp;cross&nbsp;out&nbsp;any&nbsp;usages&nbsp;that&nbsp;aren&#39;t&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4378243">//&nbsp;by&nbsp;each&nbsp;certificate.&nbsp;If&nbsp;we&nbsp;cross&nbsp;out&nbsp;all&nbsp;the&nbsp;usages,&nbsp;then&nbsp;the&nbsp;chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4378315">//&nbsp;is&nbsp;unacceptable.</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="ident" id="4378336">NextCert</span><span class="op" id="4378344">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378347">for</span>&nbsp;<span class="ident" id="4378351">i</span>&nbsp;<span class="op" id="4378353">:=</span>&nbsp;<span class="builtinfunc" id="4378356">len</span><span class="op" id="4378359">(</span><span class="ident" id="4378360">chain</span><span class="op" id="4378365">)</span>&nbsp;<span class="op" id="4378367">-</span>&nbsp;<span class="num" id="4378369">1</span><span class="op" id="4378370">;</span>&nbsp;<span class="ident" id="4378372">i</span>&nbsp;<span class="op" id="4378374">&gt;=</span>&nbsp;<span class="num" id="4378377">0</span><span class="op" id="4378378">;</span>&nbsp;<span class="ident" id="4378380">i</span><span class="op" id="4378381">--</span>&nbsp;<span class="op" id="4378384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4378388">cert</span>&nbsp;<span class="op" id="4378393">:=</span>&nbsp;<span class="ident" id="4378396">chain</span><span class="op" id="4378401">[</span><span class="ident" id="4378402">i</span><span class="op" id="4378403">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378407">if</span>&nbsp;<span class="builtinfunc" id="4378410">len</span><span class="op" id="4378413">(</span><span class="ident" id="4378414">cert</span><span class="op" id="4378418">.</span><span class="ident" id="4378419">ExtKeyUsage</span><span class="op" id="4378430">)</span>&nbsp;<span class="op" id="4378432">==</span>&nbsp;<span class="num" id="4378435">0</span>&nbsp;<span class="op" id="4378437">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4378440">len</span><span class="op" id="4378443">(</span><span class="ident" id="4378444">cert</span><span class="op" id="4378448">.</span><span class="ident" id="4378449">UnknownExtKeyUsage</span><span class="op" id="4378467">)</span>&nbsp;<span class="op" id="4378469">==</span>&nbsp;<span class="num" id="4378472">0</span>&nbsp;<span class="op" id="4378474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4378479">//&nbsp;The&nbsp;certificate&nbsp;doesn&#39;t&nbsp;have&nbsp;any&nbsp;extended&nbsp;key&nbsp;usage&nbsp;specified.</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378548">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378564">for</span>&nbsp;<span class="ident" id="4378568">_</span><span class="op" id="4378569">,</span>&nbsp;<span class="ident" id="4378571">usage</span>&nbsp;<span class="op" id="4378577">:=</span>&nbsp;<span class="keyword" id="4378580">range</span>&nbsp;<span class="ident" id="4378586">cert</span><span class="op" id="4378590">.</span><span class="ident" id="4378591">ExtKeyUsage</span>&nbsp;<span class="op" id="4378603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378608">if</span>&nbsp;<span class="ident" id="4378611">usage</span>&nbsp;<span class="op" id="4378617">==</span>&nbsp;<span class="ident" id="4378620">ExtKeyUsageAny</span>&nbsp;<span class="op" id="4378635">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4378641">//&nbsp;The&nbsp;certificate&nbsp;is&nbsp;explicitly&nbsp;good&nbsp;for&nbsp;any&nbsp;usage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378698">continue</span>&nbsp;<span class="ident" id="4378707">NextCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378728">const</span>&nbsp;<span class="ident" id="4378734">invalidUsage</span>&nbsp;<span class="ident" id="4378747">ExtKeyUsage</span>&nbsp;<span class="op" id="4378759">=</span>&nbsp;<span class="op" id="4378761">-</span><span class="num" id="4378762">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4378766">NextRequestedUsage</span><span class="op" id="4378784">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378788">for</span>&nbsp;<span class="ident" id="4378792">i</span><span class="op" id="4378793">,</span>&nbsp;<span class="ident" id="4378795">requestedUsage</span>&nbsp;<span class="op" id="4378810">:=</span>&nbsp;<span class="keyword" id="4378813">range</span>&nbsp;<span class="ident" id="4378819">usages</span>&nbsp;<span class="op" id="4378826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378831">if</span>&nbsp;<span class="ident" id="4378834">requestedUsage</span>&nbsp;<span class="op" id="4378849">==</span>&nbsp;<span class="ident" id="4378852">invalidUsage</span>&nbsp;<span class="op" id="4378865">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378871">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378889">for</span>&nbsp;<span class="ident" id="4378893">_</span><span class="op" id="4378894">,</span>&nbsp;<span class="ident" id="4378896">usage</span>&nbsp;<span class="op" id="4378902">:=</span>&nbsp;<span class="keyword" id="4378905">range</span>&nbsp;<span class="ident" id="4378911">cert</span><span class="op" id="4378915">.</span><span class="ident" id="4378916">ExtKeyUsage</span>&nbsp;<span class="op" id="4378928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378934">if</span>&nbsp;<span class="ident" id="4378937">requestedUsage</span>&nbsp;<span class="op" id="4378952">==</span>&nbsp;<span class="ident" id="4378955">usage</span>&nbsp;<span class="op" id="4378961">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378968">continue</span>&nbsp;<span class="ident" id="4378977">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379000">}</span>&nbsp;<span class="keyword" id="4379002">else</span>&nbsp;<span class="keyword" id="4379007">if</span>&nbsp;<span class="ident" id="4379010">requestedUsage</span>&nbsp;<span class="op" id="4379025">==</span>&nbsp;<span class="ident" id="4379028">ExtKeyUsageServerAuth</span>&nbsp;<span class="op" id="4379050">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379058">(</span><span class="ident" id="4379059">usage</span>&nbsp;<span class="op" id="4379065">==</span>&nbsp;<span class="ident" id="4379068">ExtKeyUsageNetscapeServerGatedCrypto</span>&nbsp;<span class="op" id="4379105">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379114">usage</span>&nbsp;<span class="op" id="4379120">==</span>&nbsp;<span class="ident" id="4379123">ExtKeyUsageMicrosoftServerGatedCrypto</span><span class="op" id="4379160">)</span>&nbsp;<span class="op" id="4379162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4379169">//&nbsp;In&nbsp;order&nbsp;to&nbsp;support&nbsp;COMODO</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4379204">//&nbsp;certificate&nbsp;chains,&nbsp;we&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4379243">//&nbsp;accept&nbsp;Netscape&nbsp;or&nbsp;Microsoft&nbsp;SGC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4379284">//&nbsp;usages&nbsp;as&nbsp;equal&nbsp;to&nbsp;ServerAuth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379323">continue</span>&nbsp;<span class="ident" id="4379332">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379355">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379366">usages</span><span class="op" id="4379372">[</span><span class="ident" id="4379373">i</span><span class="op" id="4379374">]</span>&nbsp;<span class="op" id="4379376">=</span>&nbsp;<span class="ident" id="4379378">invalidUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379394">usagesRemaining</span><span class="op" id="4379409">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379415">if</span>&nbsp;<span class="ident" id="4379418">usagesRemaining</span>&nbsp;<span class="op" id="4379434">==</span>&nbsp;<span class="num" id="4379437">0</span>&nbsp;<span class="op" id="4379439">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379445">return</span>&nbsp;<span class="builtintype" id="4379452">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379472">return</span>&nbsp;<span class="builtintype" id="4379479">true</span><br>
<span class="lineno"></span><span class="op" id="4379484">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
