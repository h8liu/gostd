<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6320036">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6320091">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6320145">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6320196">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="6320245">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="6320296">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="6320373">package</span>&nbsp;<span class="ident" id="6320381">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6320387">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6320466">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6320480">import</span>&nbsp;<span class="op" id="6320487">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6320490">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6320499">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6320508">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6320527">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6320537">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6320543">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6320550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6320553">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6320596">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="6320651">type</span>&nbsp;<span class="ident" id="6320656">recType</span>&nbsp;<span class="builtintype" id="6320664">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6320671">const</span>&nbsp;<span class="op" id="6320677">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320680">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320700">recType</span>&nbsp;<span class="op" id="6320708">=</span>&nbsp;<span class="num" id="6320710">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320713">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320733">recType</span>&nbsp;<span class="op" id="6320741">=</span>&nbsp;<span class="num" id="6320743">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320746">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320766">recType</span>&nbsp;<span class="op" id="6320774">=</span>&nbsp;<span class="num" id="6320776">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320779">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320799">recType</span>&nbsp;<span class="op" id="6320807">=</span>&nbsp;<span class="num" id="6320809">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320812">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320832">recType</span>&nbsp;<span class="op" id="6320840">=</span>&nbsp;<span class="num" id="6320842">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320845">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320865">recType</span>&nbsp;<span class="op" id="6320873">=</span>&nbsp;<span class="num" id="6320875">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320878">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320898">recType</span>&nbsp;<span class="op" id="6320906">=</span>&nbsp;<span class="num" id="6320908">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320911">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320931">recType</span>&nbsp;<span class="op" id="6320939">=</span>&nbsp;<span class="num" id="6320941">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320944">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6320964">recType</span>&nbsp;<span class="op" id="6320972">=</span>&nbsp;<span class="num" id="6320974">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320977">typeGetValuesResult</span>&nbsp;<span class="ident" id="6320997">recType</span>&nbsp;<span class="op" id="6321005">=</span>&nbsp;<span class="num" id="6321007">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321011">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321031">recType</span>&nbsp;<span class="op" id="6321039">=</span>&nbsp;<span class="num" id="6321041">11</span><br>
<span class="lineno"></span><span class="op" id="6321044">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="6321047">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="6321122">const</span>&nbsp;<span class="ident" id="6321128">flagKeepConn</span>&nbsp;<span class="op" id="6321141">=</span>&nbsp;<span class="num" id="6321143">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6321146">const</span>&nbsp;<span class="op" id="6321152">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321155">maxWrite</span>&nbsp;<span class="op" id="6321164">=</span>&nbsp;<span class="num" id="6321166">65535</span>&nbsp;<span class="comment" id="6321172">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321196">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6321205">=</span>&nbsp;<span class="num" id="6321207">255</span><br>
<span class="lineno"></span><span class="op" id="6321211">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6321214">const</span>&nbsp;<span class="op" id="6321220">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321223">roleResponder</span>&nbsp;<span class="op" id="6321237">=</span>&nbsp;<span class="ident" id="6321239">iota</span>&nbsp;<span class="op" id="6321244">+</span>&nbsp;<span class="num" id="6321246">1</span>&nbsp;<span class="comment" id="6321248">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321285">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321301">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="6321312">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6321315">const</span>&nbsp;<span class="op" id="6321321">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321324">statusRequestComplete</span>&nbsp;<span class="op" id="6321346">=</span>&nbsp;<span class="ident" id="6321348">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321354">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321375">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321393">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="6321411">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6321414">const</span>&nbsp;<span class="ident" id="6321420">headerLen</span>&nbsp;<span class="op" id="6321430">=</span>&nbsp;<span class="num" id="6321432">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6321435">type</span>&nbsp;<span class="ident" id="6321440">header</span>&nbsp;<span class="keyword" id="6321447">struct</span>&nbsp;<span class="op" id="6321454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321457">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6321471">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321478">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6321492">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321501">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6321515">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321523">ContentLength</span>&nbsp;<span class="builtintype" id="6321537">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321545">PaddingLength</span>&nbsp;<span class="builtintype" id="6321559">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321566">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6321580">uint8</span><br>
<span class="lineno">70</span><span class="op" id="6321586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6321589">type</span>&nbsp;<span class="ident" id="6321594">beginRequest</span>&nbsp;<span class="keyword" id="6321607">struct</span>&nbsp;<span class="op" id="6321614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321617">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6321626">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321634">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6321643">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321650">reserved</span>&nbsp;<span class="op" id="6321659">[</span><span class="num" id="6321660">5</span><span class="op" id="6321661">]</span><span class="builtintype" id="6321662">uint8</span><br>
<span class="lineno"></span><span class="op" id="6321668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6321671">func</span>&nbsp;<span class="op" id="6321676">(</span><span class="ident" id="6321677">br</span>&nbsp;<span class="op" id="6321680">*</span><span class="ident" id="6321681">beginRequest</span><span class="op" id="6321693">)</span>&nbsp;<span class="ident" id="6321695">read</span><span class="op" id="6321699">(</span><span class="ident" id="6321700">content</span>&nbsp;<span class="op" id="6321708">[</span><span class="op" id="6321709">]</span><span class="builtintype" id="6321710">byte</span><span class="op" id="6321714">)</span>&nbsp;<span class="builtintype" id="6321716">error</span>&nbsp;<span class="op" id="6321722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6321725">if</span>&nbsp;<span class="builtinfunc" id="6321728">len</span><span class="op" id="6321731">(</span><span class="ident" id="6321732">content</span><span class="op" id="6321739">)</span>&nbsp;<span class="op" id="6321741">!=</span>&nbsp;<span class="num" id="6321744">8</span>&nbsp;<span class="op" id="6321746">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6321750">return</span>&nbsp;<span class="ident" id="6321757">errors</span><span class="op" id="6321763">.</span><span class="ident" id="6321764">New</span><span class="op" id="6321767">(</span><span class="string" id="6321768">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="6321804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6321807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321810">br</span><span class="op" id="6321812">.</span><span class="ident" id="6321813">role</span>&nbsp;<span class="op" id="6321818">=</span>&nbsp;<span class="ident" id="6321820">binary</span><span class="op" id="6321826">.</span><span class="ident" id="6321827">BigEndian</span><span class="op" id="6321836">.</span><span class="ident" id="6321837">Uint16</span><span class="op" id="6321843">(</span><span class="ident" id="6321844">content</span><span class="op" id="6321851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6321854">br</span><span class="op" id="6321856">.</span><span class="ident" id="6321857">flags</span>&nbsp;<span class="op" id="6321863">=</span>&nbsp;<span class="ident" id="6321865">content</span><span class="op" id="6321872">[</span><span class="num" id="6321873">2</span><span class="op" id="6321874">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6321877">return</span>&nbsp;<span class="ident" id="6321884">nil</span><br>
<span class="lineno">85</span><span class="op" id="6321888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6321891">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="6321948">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="6322012">var</span>&nbsp;<span class="ident" id="6322016">pad</span>&nbsp;<span class="op" id="6322020">[</span><span class="ident" id="6322021">maxPad</span><span class="op" id="6322027">]</span><span class="builtintype" id="6322028">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="6322034">func</span>&nbsp;<span class="op" id="6322039">(</span><span class="ident" id="6322040">h</span>&nbsp;<span class="op" id="6322042">*</span><span class="ident" id="6322043">header</span><span class="op" id="6322049">)</span>&nbsp;<span class="ident" id="6322051">init</span><span class="op" id="6322055">(</span><span class="ident" id="6322056">recType</span>&nbsp;<span class="ident" id="6322064">recType</span><span class="op" id="6322071">,</span>&nbsp;<span class="ident" id="6322073">reqId</span>&nbsp;<span class="builtintype" id="6322079">uint16</span><span class="op" id="6322085">,</span>&nbsp;<span class="ident" id="6322087">contentLength</span>&nbsp;<span class="builtintype" id="6322101">int</span><span class="op" id="6322104">)</span>&nbsp;<span class="op" id="6322106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322109">h</span><span class="op" id="6322110">.</span><span class="ident" id="6322111">Version</span>&nbsp;<span class="op" id="6322119">=</span>&nbsp;<span class="num" id="6322121">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322124">h</span><span class="op" id="6322125">.</span><span class="ident" id="6322126">Type</span>&nbsp;<span class="op" id="6322131">=</span>&nbsp;<span class="ident" id="6322133">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322142">h</span><span class="op" id="6322143">.</span><span class="ident" id="6322144">Id</span>&nbsp;<span class="op" id="6322147">=</span>&nbsp;<span class="ident" id="6322149">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322156">h</span><span class="op" id="6322157">.</span><span class="ident" id="6322158">ContentLength</span>&nbsp;<span class="op" id="6322172">=</span>&nbsp;<span class="builtintype" id="6322174">uint16</span><span class="op" id="6322180">(</span><span class="ident" id="6322181">contentLength</span><span class="op" id="6322194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322197">h</span><span class="op" id="6322198">.</span><span class="ident" id="6322199">PaddingLength</span>&nbsp;<span class="op" id="6322213">=</span>&nbsp;<span class="builtintype" id="6322215">uint8</span><span class="op" id="6322220">(</span><span class="op" id="6322221">-</span><span class="ident" id="6322222">contentLength</span>&nbsp;<span class="op" id="6322236">&amp;</span>&nbsp;<span class="num" id="6322238">7</span><span class="op" id="6322239">)</span><br>
<span class="lineno"></span><span class="op" id="6322241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6322244">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="6322275">type</span>&nbsp;<span class="ident" id="6322280">conn</span>&nbsp;<span class="keyword" id="6322285">struct</span>&nbsp;<span class="op" id="6322292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322295">mutex</span>&nbsp;<span class="ident" id="6322301">sync</span><span class="op" id="6322305">.</span><span class="ident" id="6322306">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322313">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6322319">io</span><span class="op" id="6322321">.</span><span class="ident" id="6322322">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6322340">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322365">buf</span>&nbsp;<span class="ident" id="6322369">bytes</span><span class="op" id="6322374">.</span><span class="ident" id="6322375">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322383">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6322387">header</span><br>
<span class="lineno"></span><span class="op" id="6322394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6322397">func</span>&nbsp;<span class="ident" id="6322402">newConn</span><span class="op" id="6322409">(</span><span class="ident" id="6322410">rwc</span>&nbsp;<span class="ident" id="6322414">io</span><span class="op" id="6322416">.</span><span class="ident" id="6322417">ReadWriteCloser</span><span class="op" id="6322432">)</span>&nbsp;<span class="op" id="6322434">*</span><span class="ident" id="6322435">conn</span>&nbsp;<span class="op" id="6322440">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6322443">return</span>&nbsp;<span class="op" id="6322450">&amp;</span><span class="ident" id="6322451">conn</span><span class="op" id="6322455">{</span><span class="ident" id="6322456">rwc</span><span class="op" id="6322459">:</span>&nbsp;<span class="ident" id="6322461">rwc</span><span class="op" id="6322464">}</span><br>
<span class="lineno"></span><span class="op" id="6322466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6322469">func</span>&nbsp;<span class="op" id="6322474">(</span><span class="ident" id="6322475">c</span>&nbsp;<span class="op" id="6322477">*</span><span class="ident" id="6322478">conn</span><span class="op" id="6322482">)</span>&nbsp;<span class="ident" id="6322484">Close</span><span class="op" id="6322489">(</span><span class="op" id="6322490">)</span>&nbsp;<span class="builtintype" id="6322492">error</span>&nbsp;<span class="op" id="6322498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322501">c</span><span class="op" id="6322502">.</span><span class="ident" id="6322503">mutex</span><span class="op" id="6322508">.</span><span class="ident" id="6322509">Lock</span><span class="op" id="6322513">(</span><span class="op" id="6322514">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6322517">defer</span>&nbsp;<span class="ident" id="6322523">c</span><span class="op" id="6322524">.</span><span class="ident" id="6322525">mutex</span><span class="op" id="6322530">.</span><span class="ident" id="6322531">Unlock</span><span class="op" id="6322537">(</span><span class="op" id="6322538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6322541">return</span>&nbsp;<span class="ident" id="6322548">c</span><span class="op" id="6322549">.</span><span class="ident" id="6322550">rwc</span><span class="op" id="6322553">.</span><span class="ident" id="6322554">Close</span><span class="op" id="6322559">(</span><span class="op" id="6322560">)</span><br>
<span class="lineno"></span><span class="op" id="6322562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6322565">type</span>&nbsp;<span class="ident" id="6322570">record</span>&nbsp;<span class="keyword" id="6322577">struct</span>&nbsp;<span class="op" id="6322584">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322587">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6322591">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322599">buf</span>&nbsp;<span class="op" id="6322603">[</span><span class="ident" id="6322604">maxWrite</span>&nbsp;<span class="op" id="6322613">+</span>&nbsp;<span class="ident" id="6322615">maxPad</span><span class="op" id="6322621">]</span><span class="builtintype" id="6322622">byte</span><br>
<span class="lineno"></span><span class="op" id="6322627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6322630">func</span>&nbsp;<span class="op" id="6322635">(</span><span class="ident" id="6322636">rec</span>&nbsp;<span class="op" id="6322640">*</span><span class="ident" id="6322641">record</span><span class="op" id="6322647">)</span>&nbsp;<span class="ident" id="6322649">read</span><span class="op" id="6322653">(</span><span class="ident" id="6322654">r</span>&nbsp;<span class="ident" id="6322656">io</span><span class="op" id="6322658">.</span><span class="ident" id="6322659">Reader</span><span class="op" id="6322665">)</span>&nbsp;<span class="op" id="6322667">(</span><span class="ident" id="6322668">err</span>&nbsp;<span class="builtintype" id="6322672">error</span><span class="op" id="6322677">)</span>&nbsp;<span class="op" id="6322679">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6322682">if</span>&nbsp;<span class="ident" id="6322685">err</span>&nbsp;<span class="op" id="6322689">=</span>&nbsp;<span class="ident" id="6322691">binary</span><span class="op" id="6322697">.</span><span class="ident" id="6322698">Read</span><span class="op" id="6322702">(</span><span class="ident" id="6322703">r</span><span class="op" id="6322704">,</span>&nbsp;<span class="ident" id="6322706">binary</span><span class="op" id="6322712">.</span><span class="ident" id="6322713">BigEndian</span><span class="op" id="6322722">,</span>&nbsp;<span class="op" id="6322724">&amp;</span><span class="ident" id="6322725">rec</span><span class="op" id="6322728">.</span><span class="ident" id="6322729">h</span><span class="op" id="6322730">)</span><span class="op" id="6322731">;</span>&nbsp;<span class="ident" id="6322733">err</span>&nbsp;<span class="op" id="6322737">!=</span>&nbsp;<span class="ident" id="6322740">nil</span>&nbsp;<span class="op" id="6322744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6322748">return</span>&nbsp;<span class="ident" id="6322755">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6322760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6322763">if</span>&nbsp;<span class="ident" id="6322766">rec</span><span class="op" id="6322769">.</span><span class="ident" id="6322770">h</span><span class="op" id="6322771">.</span><span class="ident" id="6322772">Version</span>&nbsp;<span class="op" id="6322780">!=</span>&nbsp;<span class="num" id="6322783">1</span>&nbsp;<span class="op" id="6322785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6322789">return</span>&nbsp;<span class="ident" id="6322796">errors</span><span class="op" id="6322802">.</span><span class="ident" id="6322803">New</span><span class="op" id="6322806">(</span><span class="string" id="6322807">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="6322837">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6322840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322843">n</span>&nbsp;<span class="op" id="6322845">:=</span>&nbsp;<span class="builtintype" id="6322848">int</span><span class="op" id="6322851">(</span><span class="ident" id="6322852">rec</span><span class="op" id="6322855">.</span><span class="ident" id="6322856">h</span><span class="op" id="6322857">.</span><span class="ident" id="6322858">ContentLength</span><span class="op" id="6322871">)</span>&nbsp;<span class="op" id="6322873">+</span>&nbsp;<span class="builtintype" id="6322875">int</span><span class="op" id="6322878">(</span><span class="ident" id="6322879">rec</span><span class="op" id="6322882">.</span><span class="ident" id="6322883">h</span><span class="op" id="6322884">.</span><span class="ident" id="6322885">PaddingLength</span><span class="op" id="6322898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6322901">if</span>&nbsp;<span class="ident" id="6322904">_</span><span class="op" id="6322905">,</span>&nbsp;<span class="ident" id="6322907">err</span>&nbsp;<span class="op" id="6322911">=</span>&nbsp;<span class="ident" id="6322913">io</span><span class="op" id="6322915">.</span><span class="ident" id="6322916">ReadFull</span><span class="op" id="6322924">(</span><span class="ident" id="6322925">r</span><span class="op" id="6322926">,</span>&nbsp;<span class="ident" id="6322928">rec</span><span class="op" id="6322931">.</span><span class="ident" id="6322932">buf</span><span class="op" id="6322935">[</span><span class="op" id="6322936">:</span><span class="ident" id="6322937">n</span><span class="op" id="6322938">]</span><span class="op" id="6322939">)</span><span class="op" id="6322940">;</span>&nbsp;<span class="ident" id="6322942">err</span>&nbsp;<span class="op" id="6322946">!=</span>&nbsp;<span class="ident" id="6322949">nil</span>&nbsp;<span class="op" id="6322953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6322957">return</span>&nbsp;<span class="ident" id="6322964">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6322969">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6322972">return</span>&nbsp;<span class="ident" id="6322979">nil</span><br>
<span class="lineno"></span><span class="op" id="6322983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6322986">func</span>&nbsp;<span class="op" id="6322991">(</span><span class="ident" id="6322992">r</span>&nbsp;<span class="op" id="6322994">*</span><span class="ident" id="6322995">record</span><span class="op" id="6323001">)</span>&nbsp;<span class="ident" id="6323003">content</span><span class="op" id="6323010">(</span><span class="op" id="6323011">)</span>&nbsp;<span class="op" id="6323013">[</span><span class="op" id="6323014">]</span><span class="builtintype" id="6323015">byte</span>&nbsp;<span class="op" id="6323020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6323023">return</span>&nbsp;<span class="ident" id="6323030">r</span><span class="op" id="6323031">.</span><span class="ident" id="6323032">buf</span><span class="op" id="6323035">[</span><span class="op" id="6323036">:</span><span class="ident" id="6323037">r</span><span class="op" id="6323038">.</span><span class="ident" id="6323039">h</span><span class="op" id="6323040">.</span><span class="ident" id="6323041">ContentLength</span><span class="op" id="6323054">]</span><br>
<span class="lineno">140</span><span class="op" id="6323056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6323059">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="6323108">func</span>&nbsp;<span class="op" id="6323113">(</span><span class="ident" id="6323114">c</span>&nbsp;<span class="op" id="6323116">*</span><span class="ident" id="6323117">conn</span><span class="op" id="6323121">)</span>&nbsp;<span class="ident" id="6323123">writeRecord</span><span class="op" id="6323134">(</span><span class="ident" id="6323135">recType</span>&nbsp;<span class="ident" id="6323143">recType</span><span class="op" id="6323150">,</span>&nbsp;<span class="ident" id="6323152">reqId</span>&nbsp;<span class="builtintype" id="6323158">uint16</span><span class="op" id="6323164">,</span>&nbsp;<span class="ident" id="6323166">b</span>&nbsp;<span class="op" id="6323168">[</span><span class="op" id="6323169">]</span><span class="builtintype" id="6323170">byte</span><span class="op" id="6323174">)</span>&nbsp;<span class="builtintype" id="6323176">error</span>&nbsp;<span class="op" id="6323182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323185">c</span><span class="op" id="6323186">.</span><span class="ident" id="6323187">mutex</span><span class="op" id="6323192">.</span><span class="ident" id="6323193">Lock</span><span class="op" id="6323197">(</span><span class="op" id="6323198">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6323201">defer</span>&nbsp;<span class="ident" id="6323207">c</span><span class="op" id="6323208">.</span><span class="ident" id="6323209">mutex</span><span class="op" id="6323214">.</span><span class="ident" id="6323215">Unlock</span><span class="op" id="6323221">(</span><span class="op" id="6323222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323225">c</span><span class="op" id="6323226">.</span><span class="ident" id="6323227">buf</span><span class="op" id="6323230">.</span><span class="ident" id="6323231">Reset</span><span class="op" id="6323236">(</span><span class="op" id="6323237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323240">c</span><span class="op" id="6323241">.</span><span class="ident" id="6323242">h</span><span class="op" id="6323243">.</span><span class="ident" id="6323244">init</span><span class="op" id="6323248">(</span><span class="ident" id="6323249">recType</span><span class="op" id="6323256">,</span>&nbsp;<span class="ident" id="6323258">reqId</span><span class="op" id="6323263">,</span>&nbsp;<span class="builtinfunc" id="6323265">len</span><span class="op" id="6323268">(</span><span class="ident" id="6323269">b</span><span class="op" id="6323270">)</span><span class="op" id="6323271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6323274">if</span>&nbsp;<span class="ident" id="6323277">err</span>&nbsp;<span class="op" id="6323281">:=</span>&nbsp;<span class="ident" id="6323284">binary</span><span class="op" id="6323290">.</span><span class="ident" id="6323291">Write</span><span class="op" id="6323296">(</span><span class="op" id="6323297">&amp;</span><span class="ident" id="6323298">c</span><span class="op" id="6323299">.</span><span class="ident" id="6323300">buf</span><span class="op" id="6323303">,</span>&nbsp;<span class="ident" id="6323305">binary</span><span class="op" id="6323311">.</span><span class="ident" id="6323312">BigEndian</span><span class="op" id="6323321">,</span>&nbsp;<span class="ident" id="6323323">c</span><span class="op" id="6323324">.</span><span class="ident" id="6323325">h</span><span class="op" id="6323326">)</span><span class="op" id="6323327">;</span>&nbsp;<span class="ident" id="6323329">err</span>&nbsp;<span class="op" id="6323333">!=</span>&nbsp;<span class="ident" id="6323336">nil</span>&nbsp;<span class="op" id="6323340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6323344">return</span>&nbsp;<span class="ident" id="6323351">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6323356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6323359">if</span>&nbsp;<span class="ident" id="6323362">_</span><span class="op" id="6323363">,</span>&nbsp;<span class="ident" id="6323365">err</span>&nbsp;<span class="op" id="6323369">:=</span>&nbsp;<span class="ident" id="6323372">c</span><span class="op" id="6323373">.</span><span class="ident" id="6323374">buf</span><span class="op" id="6323377">.</span><span class="ident" id="6323378">Write</span><span class="op" id="6323383">(</span><span class="ident" id="6323384">b</span><span class="op" id="6323385">)</span><span class="op" id="6323386">;</span>&nbsp;<span class="ident" id="6323388">err</span>&nbsp;<span class="op" id="6323392">!=</span>&nbsp;<span class="ident" id="6323395">nil</span>&nbsp;<span class="op" id="6323399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6323403">return</span>&nbsp;<span class="ident" id="6323410">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6323415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6323418">if</span>&nbsp;<span class="ident" id="6323421">_</span><span class="op" id="6323422">,</span>&nbsp;<span class="ident" id="6323424">err</span>&nbsp;<span class="op" id="6323428">:=</span>&nbsp;<span class="ident" id="6323431">c</span><span class="op" id="6323432">.</span><span class="ident" id="6323433">buf</span><span class="op" id="6323436">.</span><span class="ident" id="6323437">Write</span><span class="op" id="6323442">(</span><span class="ident" id="6323443">pad</span><span class="op" id="6323446">[</span><span class="op" id="6323447">:</span><span class="ident" id="6323448">c</span><span class="op" id="6323449">.</span><span class="ident" id="6323450">h</span><span class="op" id="6323451">.</span><span class="ident" id="6323452">PaddingLength</span><span class="op" id="6323465">]</span><span class="op" id="6323466">)</span><span class="op" id="6323467">;</span>&nbsp;<span class="ident" id="6323469">err</span>&nbsp;<span class="op" id="6323473">!=</span>&nbsp;<span class="ident" id="6323476">nil</span>&nbsp;<span class="op" id="6323480">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6323484">return</span>&nbsp;<span class="ident" id="6323491">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6323496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323499">_</span><span class="op" id="6323500">,</span>&nbsp;<span class="ident" id="6323502">err</span>&nbsp;<span class="op" id="6323506">:=</span>&nbsp;<span class="ident" id="6323509">c</span><span class="op" id="6323510">.</span><span class="ident" id="6323511">rwc</span><span class="op" id="6323514">.</span><span class="ident" id="6323515">Write</span><span class="op" id="6323520">(</span><span class="ident" id="6323521">c</span><span class="op" id="6323522">.</span><span class="ident" id="6323523">buf</span><span class="op" id="6323526">.</span><span class="ident" id="6323527">Bytes</span><span class="op" id="6323532">(</span><span class="op" id="6323533">)</span><span class="op" id="6323534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6323537">return</span>&nbsp;<span class="ident" id="6323544">err</span><br>
<span class="lineno"></span><span class="op" id="6323548">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="6323551">func</span>&nbsp;<span class="op" id="6323556">(</span><span class="ident" id="6323557">c</span>&nbsp;<span class="op" id="6323559">*</span><span class="ident" id="6323560">conn</span><span class="op" id="6323564">)</span>&nbsp;<span class="ident" id="6323566">writeBeginRequest</span><span class="op" id="6323583">(</span><span class="ident" id="6323584">reqId</span>&nbsp;<span class="builtintype" id="6323590">uint16</span><span class="op" id="6323596">,</span>&nbsp;<span class="ident" id="6323598">role</span>&nbsp;<span class="builtintype" id="6323603">uint16</span><span class="op" id="6323609">,</span>&nbsp;<span class="ident" id="6323611">flags</span>&nbsp;<span class="builtintype" id="6323617">uint8</span><span class="op" id="6323622">)</span>&nbsp;<span class="builtintype" id="6323624">error</span>&nbsp;<span class="op" id="6323630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323633">b</span>&nbsp;<span class="op" id="6323635">:=</span>&nbsp;<span class="op" id="6323638">[</span><span class="num" id="6323639">8</span><span class="op" id="6323640">]</span><span class="builtintype" id="6323641">byte</span><span class="op" id="6323645">{</span><span class="builtintype" id="6323646">byte</span><span class="op" id="6323650">(</span><span class="ident" id="6323651">role</span>&nbsp;<span class="op" id="6323656">&gt;&gt;</span>&nbsp;<span class="num" id="6323659">8</span><span class="op" id="6323660">)</span><span class="op" id="6323661">,</span>&nbsp;<span class="builtintype" id="6323663">byte</span><span class="op" id="6323667">(</span><span class="ident" id="6323668">role</span><span class="op" id="6323672">)</span><span class="op" id="6323673">,</span>&nbsp;<span class="ident" id="6323675">flags</span><span class="op" id="6323680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6323683">return</span>&nbsp;<span class="ident" id="6323690">c</span><span class="op" id="6323691">.</span><span class="ident" id="6323692">writeRecord</span><span class="op" id="6323703">(</span><span class="ident" id="6323704">typeBeginRequest</span><span class="op" id="6323720">,</span>&nbsp;<span class="ident" id="6323722">reqId</span><span class="op" id="6323727">,</span>&nbsp;<span class="ident" id="6323729">b</span><span class="op" id="6323730">[</span><span class="op" id="6323731">:</span><span class="op" id="6323732">]</span><span class="op" id="6323733">)</span><br>
<span class="lineno"></span><span class="op" id="6323735">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="6323738">func</span>&nbsp;<span class="op" id="6323743">(</span><span class="ident" id="6323744">c</span>&nbsp;<span class="op" id="6323746">*</span><span class="ident" id="6323747">conn</span><span class="op" id="6323751">)</span>&nbsp;<span class="ident" id="6323753">writeEndRequest</span><span class="op" id="6323768">(</span><span class="ident" id="6323769">reqId</span>&nbsp;<span class="builtintype" id="6323775">uint16</span><span class="op" id="6323781">,</span>&nbsp;<span class="ident" id="6323783">appStatus</span>&nbsp;<span class="builtintype" id="6323793">int</span><span class="op" id="6323796">,</span>&nbsp;<span class="ident" id="6323798">protocolStatus</span>&nbsp;<span class="builtintype" id="6323813">uint8</span><span class="op" id="6323818">)</span>&nbsp;<span class="builtintype" id="6323820">error</span>&nbsp;<span class="op" id="6323826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323829">b</span>&nbsp;<span class="op" id="6323831">:=</span>&nbsp;<span class="builtinfunc" id="6323834">make</span><span class="op" id="6323838">(</span><span class="op" id="6323839">[</span><span class="op" id="6323840">]</span><span class="builtintype" id="6323841">byte</span><span class="op" id="6323845">,</span>&nbsp;<span class="num" id="6323847">8</span><span class="op" id="6323848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323851">binary</span><span class="op" id="6323857">.</span><span class="ident" id="6323858">BigEndian</span><span class="op" id="6323867">.</span><span class="ident" id="6323868">PutUint32</span><span class="op" id="6323877">(</span><span class="ident" id="6323878">b</span><span class="op" id="6323879">,</span>&nbsp;<span class="builtintype" id="6323881">uint32</span><span class="op" id="6323887">(</span><span class="ident" id="6323888">appStatus</span><span class="op" id="6323897">)</span><span class="op" id="6323898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323901">b</span><span class="op" id="6323902">[</span><span class="num" id="6323903">4</span><span class="op" id="6323904">]</span>&nbsp;<span class="op" id="6323906">=</span>&nbsp;<span class="ident" id="6323908">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6323924">return</span>&nbsp;<span class="ident" id="6323931">c</span><span class="op" id="6323932">.</span><span class="ident" id="6323933">writeRecord</span><span class="op" id="6323944">(</span><span class="ident" id="6323945">typeEndRequest</span><span class="op" id="6323959">,</span>&nbsp;<span class="ident" id="6323961">reqId</span><span class="op" id="6323966">,</span>&nbsp;<span class="ident" id="6323968">b</span><span class="op" id="6323969">)</span><br>
<span class="lineno"></span><span class="op" id="6323971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6323974">func</span>&nbsp;<span class="op" id="6323979">(</span><span class="ident" id="6323980">c</span>&nbsp;<span class="op" id="6323982">*</span><span class="ident" id="6323983">conn</span><span class="op" id="6323987">)</span>&nbsp;<span class="ident" id="6323989">writePairs</span><span class="op" id="6323999">(</span><span class="ident" id="6324000">recType</span>&nbsp;<span class="ident" id="6324008">recType</span><span class="op" id="6324015">,</span>&nbsp;<span class="ident" id="6324017">reqId</span>&nbsp;<span class="builtintype" id="6324023">uint16</span><span class="op" id="6324029">,</span>&nbsp;<span class="ident" id="6324031">pairs</span>&nbsp;<span class="keyword" id="6324037">map</span><span class="op" id="6324040">[</span><span class="builtintype" id="6324041">string</span><span class="op" id="6324047">]</span><span class="builtintype" id="6324048">string</span><span class="op" id="6324054">)</span>&nbsp;<span class="builtintype" id="6324056">error</span>&nbsp;<span class="op" id="6324062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324065">w</span>&nbsp;<span class="op" id="6324067">:=</span>&nbsp;<span class="ident" id="6324070">newWriter</span><span class="op" id="6324079">(</span><span class="ident" id="6324080">c</span><span class="op" id="6324081">,</span>&nbsp;<span class="ident" id="6324083">recType</span><span class="op" id="6324090">,</span>&nbsp;<span class="ident" id="6324092">reqId</span><span class="op" id="6324097">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324100">b</span>&nbsp;<span class="op" id="6324102">:=</span>&nbsp;<span class="builtinfunc" id="6324105">make</span><span class="op" id="6324109">(</span><span class="op" id="6324110">[</span><span class="op" id="6324111">]</span><span class="builtintype" id="6324112">byte</span><span class="op" id="6324116">,</span>&nbsp;<span class="num" id="6324118">8</span><span class="op" id="6324119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324122">for</span>&nbsp;<span class="ident" id="6324126">k</span><span class="op" id="6324127">,</span>&nbsp;<span class="ident" id="6324129">v</span>&nbsp;<span class="op" id="6324131">:=</span>&nbsp;<span class="keyword" id="6324134">range</span>&nbsp;<span class="ident" id="6324140">pairs</span>&nbsp;<span class="op" id="6324146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324150">n</span>&nbsp;<span class="op" id="6324152">:=</span>&nbsp;<span class="ident" id="6324155">encodeSize</span><span class="op" id="6324165">(</span><span class="ident" id="6324166">b</span><span class="op" id="6324167">,</span>&nbsp;<span class="builtintype" id="6324169">uint32</span><span class="op" id="6324175">(</span><span class="builtinfunc" id="6324176">len</span><span class="op" id="6324179">(</span><span class="ident" id="6324180">k</span><span class="op" id="6324181">)</span><span class="op" id="6324182">)</span><span class="op" id="6324183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324187">n</span>&nbsp;<span class="op" id="6324189">+=</span>&nbsp;<span class="ident" id="6324192">encodeSize</span><span class="op" id="6324202">(</span><span class="ident" id="6324203">b</span><span class="op" id="6324204">[</span><span class="ident" id="6324205">n</span><span class="op" id="6324206">:</span><span class="op" id="6324207">]</span><span class="op" id="6324208">,</span>&nbsp;<span class="builtintype" id="6324210">uint32</span><span class="op" id="6324216">(</span><span class="builtinfunc" id="6324217">len</span><span class="op" id="6324220">(</span><span class="ident" id="6324221">v</span><span class="op" id="6324222">)</span><span class="op" id="6324223">)</span><span class="op" id="6324224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324228">if</span>&nbsp;<span class="ident" id="6324231">_</span><span class="op" id="6324232">,</span>&nbsp;<span class="ident" id="6324234">err</span>&nbsp;<span class="op" id="6324238">:=</span>&nbsp;<span class="ident" id="6324241">w</span><span class="op" id="6324242">.</span><span class="ident" id="6324243">Write</span><span class="op" id="6324248">(</span><span class="ident" id="6324249">b</span><span class="op" id="6324250">[</span><span class="op" id="6324251">:</span><span class="ident" id="6324252">n</span><span class="op" id="6324253">]</span><span class="op" id="6324254">)</span><span class="op" id="6324255">;</span>&nbsp;<span class="ident" id="6324257">err</span>&nbsp;<span class="op" id="6324261">!=</span>&nbsp;<span class="ident" id="6324264">nil</span>&nbsp;<span class="op" id="6324268">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324273">return</span>&nbsp;<span class="ident" id="6324280">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324290">if</span>&nbsp;<span class="ident" id="6324293">_</span><span class="op" id="6324294">,</span>&nbsp;<span class="ident" id="6324296">err</span>&nbsp;<span class="op" id="6324300">:=</span>&nbsp;<span class="ident" id="6324303">w</span><span class="op" id="6324304">.</span><span class="ident" id="6324305">WriteString</span><span class="op" id="6324316">(</span><span class="ident" id="6324317">k</span><span class="op" id="6324318">)</span><span class="op" id="6324319">;</span>&nbsp;<span class="ident" id="6324321">err</span>&nbsp;<span class="op" id="6324325">!=</span>&nbsp;<span class="ident" id="6324328">nil</span>&nbsp;<span class="op" id="6324332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324337">return</span>&nbsp;<span class="ident" id="6324344">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324350">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324354">if</span>&nbsp;<span class="ident" id="6324357">_</span><span class="op" id="6324358">,</span>&nbsp;<span class="ident" id="6324360">err</span>&nbsp;<span class="op" id="6324364">:=</span>&nbsp;<span class="ident" id="6324367">w</span><span class="op" id="6324368">.</span><span class="ident" id="6324369">WriteString</span><span class="op" id="6324380">(</span><span class="ident" id="6324381">v</span><span class="op" id="6324382">)</span><span class="op" id="6324383">;</span>&nbsp;<span class="ident" id="6324385">err</span>&nbsp;<span class="op" id="6324389">!=</span>&nbsp;<span class="ident" id="6324392">nil</span>&nbsp;<span class="op" id="6324396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324401">return</span>&nbsp;<span class="ident" id="6324408">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324420">w</span><span class="op" id="6324421">.</span><span class="ident" id="6324422">Close</span><span class="op" id="6324427">(</span><span class="op" id="6324428">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324431">return</span>&nbsp;<span class="ident" id="6324438">nil</span><br>
<span class="lineno"></span><span class="op" id="6324442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6324445">func</span>&nbsp;<span class="ident" id="6324450">readSize</span><span class="op" id="6324458">(</span><span class="ident" id="6324459">s</span>&nbsp;<span class="op" id="6324461">[</span><span class="op" id="6324462">]</span><span class="builtintype" id="6324463">byte</span><span class="op" id="6324467">)</span>&nbsp;<span class="op" id="6324469">(</span><span class="builtintype" id="6324470">uint32</span><span class="op" id="6324476">,</span>&nbsp;<span class="builtintype" id="6324478">int</span><span class="op" id="6324481">)</span>&nbsp;<span class="op" id="6324483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324486">if</span>&nbsp;<span class="builtinfunc" id="6324489">len</span><span class="op" id="6324492">(</span><span class="ident" id="6324493">s</span><span class="op" id="6324494">)</span>&nbsp;<span class="op" id="6324496">==</span>&nbsp;<span class="num" id="6324499">0</span>&nbsp;<span class="op" id="6324501">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324505">return</span>&nbsp;<span class="num" id="6324512">0</span><span class="op" id="6324513">,</span>&nbsp;<span class="num" id="6324515">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324521">size</span><span class="op" id="6324525">,</span>&nbsp;<span class="ident" id="6324527">n</span>&nbsp;<span class="op" id="6324529">:=</span>&nbsp;<span class="builtintype" id="6324532">uint32</span><span class="op" id="6324538">(</span><span class="ident" id="6324539">s</span><span class="op" id="6324540">[</span><span class="num" id="6324541">0</span><span class="op" id="6324542">]</span><span class="op" id="6324543">)</span><span class="op" id="6324544">,</span>&nbsp;<span class="num" id="6324546">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324549">if</span>&nbsp;<span class="ident" id="6324552">size</span><span class="op" id="6324556">&amp;</span><span class="op" id="6324557">(</span><span class="num" id="6324558">1</span><span class="op" id="6324559">&lt;&lt;</span><span class="num" id="6324561">7</span><span class="op" id="6324562">)</span>&nbsp;<span class="op" id="6324564">!=</span>&nbsp;<span class="num" id="6324567">0</span>&nbsp;<span class="op" id="6324569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324573">if</span>&nbsp;<span class="builtinfunc" id="6324576">len</span><span class="op" id="6324579">(</span><span class="ident" id="6324580">s</span><span class="op" id="6324581">)</span>&nbsp;<span class="op" id="6324583">&lt;</span>&nbsp;<span class="num" id="6324585">4</span>&nbsp;<span class="op" id="6324587">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324592">return</span>&nbsp;<span class="num" id="6324599">0</span><span class="op" id="6324600">,</span>&nbsp;<span class="num" id="6324602">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324610">n</span>&nbsp;<span class="op" id="6324612">=</span>&nbsp;<span class="num" id="6324614">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324618">size</span>&nbsp;<span class="op" id="6324623">=</span>&nbsp;<span class="ident" id="6324625">binary</span><span class="op" id="6324631">.</span><span class="ident" id="6324632">BigEndian</span><span class="op" id="6324641">.</span><span class="ident" id="6324642">Uint32</span><span class="op" id="6324648">(</span><span class="ident" id="6324649">s</span><span class="op" id="6324650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324654">size</span>&nbsp;<span class="op" id="6324659">&amp;^=</span>&nbsp;<span class="num" id="6324663">1</span>&nbsp;<span class="op" id="6324665">&lt;&lt;</span>&nbsp;<span class="num" id="6324668">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324675">return</span>&nbsp;<span class="ident" id="6324682">size</span><span class="op" id="6324686">,</span>&nbsp;<span class="ident" id="6324688">n</span><br>
<span class="lineno"></span><span class="op" id="6324690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6324693">func</span>&nbsp;<span class="ident" id="6324698">readString</span><span class="op" id="6324708">(</span><span class="ident" id="6324709">s</span>&nbsp;<span class="op" id="6324711">[</span><span class="op" id="6324712">]</span><span class="builtintype" id="6324713">byte</span><span class="op" id="6324717">,</span>&nbsp;<span class="ident" id="6324719">size</span>&nbsp;<span class="builtintype" id="6324724">uint32</span><span class="op" id="6324730">)</span>&nbsp;<span class="builtintype" id="6324732">string</span>&nbsp;<span class="op" id="6324739">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324742">if</span>&nbsp;<span class="ident" id="6324745">size</span>&nbsp;<span class="op" id="6324750">&gt;</span>&nbsp;<span class="builtintype" id="6324752">uint32</span><span class="op" id="6324758">(</span><span class="builtinfunc" id="6324759">len</span><span class="op" id="6324762">(</span><span class="ident" id="6324763">s</span><span class="op" id="6324764">)</span><span class="op" id="6324765">)</span>&nbsp;<span class="op" id="6324767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324771">return</span>&nbsp;<span class="string" id="6324778">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324785">return</span>&nbsp;<span class="builtintype" id="6324792">string</span><span class="op" id="6324798">(</span><span class="ident" id="6324799">s</span><span class="op" id="6324800">[</span><span class="op" id="6324801">:</span><span class="ident" id="6324802">size</span><span class="op" id="6324806">]</span><span class="op" id="6324807">)</span><br>
<span class="lineno"></span><span class="op" id="6324809">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6324812">func</span>&nbsp;<span class="ident" id="6324817">encodeSize</span><span class="op" id="6324827">(</span><span class="ident" id="6324828">b</span>&nbsp;<span class="op" id="6324830">[</span><span class="op" id="6324831">]</span><span class="builtintype" id="6324832">byte</span><span class="op" id="6324836">,</span>&nbsp;<span class="ident" id="6324838">size</span>&nbsp;<span class="builtintype" id="6324843">uint32</span><span class="op" id="6324849">)</span>&nbsp;<span class="builtintype" id="6324851">int</span>&nbsp;<span class="op" id="6324855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324858">if</span>&nbsp;<span class="ident" id="6324861">size</span>&nbsp;<span class="op" id="6324866">&gt;</span>&nbsp;<span class="num" id="6324868">127</span>&nbsp;<span class="op" id="6324872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324876">size</span>&nbsp;<span class="op" id="6324881">|=</span>&nbsp;<span class="num" id="6324884">1</span>&nbsp;<span class="op" id="6324886">&lt;&lt;</span>&nbsp;<span class="num" id="6324889">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324894">binary</span><span class="op" id="6324900">.</span><span class="ident" id="6324901">BigEndian</span><span class="op" id="6324910">.</span><span class="ident" id="6324911">PutUint32</span><span class="op" id="6324920">(</span><span class="ident" id="6324921">b</span><span class="op" id="6324922">,</span>&nbsp;<span class="ident" id="6324924">size</span><span class="op" id="6324928">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324932">return</span>&nbsp;<span class="num" id="6324939">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324945">b</span><span class="op" id="6324946">[</span><span class="num" id="6324947">0</span><span class="op" id="6324948">]</span>&nbsp;<span class="op" id="6324950">=</span>&nbsp;<span class="builtintype" id="6324952">byte</span><span class="op" id="6324956">(</span><span class="ident" id="6324957">size</span><span class="op" id="6324961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324964">return</span>&nbsp;<span class="num" id="6324971">1</span><br>
<span class="lineno"></span><span class="op" id="6324973">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="6324976">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6325058">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6325069">type</span>&nbsp;<span class="ident" id="6325074">bufWriter</span>&nbsp;<span class="keyword" id="6325084">struct</span>&nbsp;<span class="op" id="6325091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325094">closer</span>&nbsp;<span class="ident" id="6325101">io</span><span class="op" id="6325103">.</span><span class="ident" id="6325104">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325112">*</span><span class="ident" id="6325113">bufio</span><span class="op" id="6325118">.</span><span class="ident" id="6325119">Writer</span><br>
<span class="lineno"></span><span class="op" id="6325126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6325129">func</span>&nbsp;<span class="op" id="6325134">(</span><span class="ident" id="6325135">w</span>&nbsp;<span class="op" id="6325137">*</span><span class="ident" id="6325138">bufWriter</span><span class="op" id="6325147">)</span>&nbsp;<span class="ident" id="6325149">Close</span><span class="op" id="6325154">(</span><span class="op" id="6325155">)</span>&nbsp;<span class="builtintype" id="6325157">error</span>&nbsp;<span class="op" id="6325163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325166">if</span>&nbsp;<span class="ident" id="6325169">err</span>&nbsp;<span class="op" id="6325173">:=</span>&nbsp;<span class="ident" id="6325176">w</span><span class="op" id="6325177">.</span><span class="ident" id="6325178">Writer</span><span class="op" id="6325184">.</span><span class="ident" id="6325185">Flush</span><span class="op" id="6325190">(</span><span class="op" id="6325191">)</span><span class="op" id="6325192">;</span>&nbsp;<span class="ident" id="6325194">err</span>&nbsp;<span class="op" id="6325198">!=</span>&nbsp;<span class="ident" id="6325201">nil</span>&nbsp;<span class="op" id="6325205">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325209">w</span><span class="op" id="6325210">.</span><span class="ident" id="6325211">closer</span><span class="op" id="6325217">.</span><span class="ident" id="6325218">Close</span><span class="op" id="6325223">(</span><span class="op" id="6325224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325228">return</span>&nbsp;<span class="ident" id="6325235">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325243">return</span>&nbsp;<span class="ident" id="6325250">w</span><span class="op" id="6325251">.</span><span class="ident" id="6325252">closer</span><span class="op" id="6325258">.</span><span class="ident" id="6325259">Close</span><span class="op" id="6325264">(</span><span class="op" id="6325265">)</span><br>
<span class="lineno"></span><span class="op" id="6325267">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="6325270">func</span>&nbsp;<span class="ident" id="6325275">newWriter</span><span class="op" id="6325284">(</span><span class="ident" id="6325285">c</span>&nbsp;<span class="op" id="6325287">*</span><span class="ident" id="6325288">conn</span><span class="op" id="6325292">,</span>&nbsp;<span class="ident" id="6325294">recType</span>&nbsp;<span class="ident" id="6325302">recType</span><span class="op" id="6325309">,</span>&nbsp;<span class="ident" id="6325311">reqId</span>&nbsp;<span class="builtintype" id="6325317">uint16</span><span class="op" id="6325323">)</span>&nbsp;<span class="op" id="6325325">*</span><span class="ident" id="6325326">bufWriter</span>&nbsp;<span class="op" id="6325336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325339">s</span>&nbsp;<span class="op" id="6325341">:=</span>&nbsp;<span class="op" id="6325344">&amp;</span><span class="ident" id="6325345">streamWriter</span><span class="op" id="6325357">{</span><span class="ident" id="6325358">c</span><span class="op" id="6325359">:</span>&nbsp;<span class="ident" id="6325361">c</span><span class="op" id="6325362">,</span>&nbsp;<span class="ident" id="6325364">recType</span><span class="op" id="6325371">:</span>&nbsp;<span class="ident" id="6325373">recType</span><span class="op" id="6325380">,</span>&nbsp;<span class="ident" id="6325382">reqId</span><span class="op" id="6325387">:</span>&nbsp;<span class="ident" id="6325389">reqId</span><span class="op" id="6325394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325397">w</span>&nbsp;<span class="op" id="6325399">:=</span>&nbsp;<span class="ident" id="6325402">bufio</span><span class="op" id="6325407">.</span><span class="ident" id="6325408">NewWriterSize</span><span class="op" id="6325421">(</span><span class="ident" id="6325422">s</span><span class="op" id="6325423">,</span>&nbsp;<span class="ident" id="6325425">maxWrite</span><span class="op" id="6325433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325436">return</span>&nbsp;<span class="op" id="6325443">&amp;</span><span class="ident" id="6325444">bufWriter</span><span class="op" id="6325453">{</span><span class="ident" id="6325454">s</span><span class="op" id="6325455">,</span>&nbsp;<span class="ident" id="6325457">w</span><span class="op" id="6325458">}</span><br>
<span class="lineno">245</span><span class="op" id="6325460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6325463">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="6325543">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="6325587">type</span>&nbsp;<span class="ident" id="6325592">streamWriter</span>&nbsp;<span class="keyword" id="6325605">struct</span>&nbsp;<span class="op" id="6325612">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325615">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325623">*</span><span class="ident" id="6325624">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325630">recType</span>&nbsp;<span class="ident" id="6325638">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325647">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6325655">uint16</span><br>
<span class="lineno"></span><span class="op" id="6325662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6325665">func</span>&nbsp;<span class="op" id="6325670">(</span><span class="ident" id="6325671">w</span>&nbsp;<span class="op" id="6325673">*</span><span class="ident" id="6325674">streamWriter</span><span class="op" id="6325686">)</span>&nbsp;<span class="ident" id="6325688">Write</span><span class="op" id="6325693">(</span><span class="ident" id="6325694">p</span>&nbsp;<span class="op" id="6325696">[</span><span class="op" id="6325697">]</span><span class="builtintype" id="6325698">byte</span><span class="op" id="6325702">)</span>&nbsp;<span class="op" id="6325704">(</span><span class="builtintype" id="6325705">int</span><span class="op" id="6325708">,</span>&nbsp;<span class="builtintype" id="6325710">error</span><span class="op" id="6325715">)</span>&nbsp;<span class="op" id="6325717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325720">nn</span>&nbsp;<span class="op" id="6325723">:=</span>&nbsp;<span class="num" id="6325726">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325729">for</span>&nbsp;<span class="builtinfunc" id="6325733">len</span><span class="op" id="6325736">(</span><span class="ident" id="6325737">p</span><span class="op" id="6325738">)</span>&nbsp;<span class="op" id="6325740">&gt;</span>&nbsp;<span class="num" id="6325742">0</span>&nbsp;<span class="op" id="6325744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325748">n</span>&nbsp;<span class="op" id="6325750">:=</span>&nbsp;<span class="builtinfunc" id="6325753">len</span><span class="op" id="6325756">(</span><span class="ident" id="6325757">p</span><span class="op" id="6325758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325762">if</span>&nbsp;<span class="ident" id="6325765">n</span>&nbsp;<span class="op" id="6325767">&gt;</span>&nbsp;<span class="ident" id="6325769">maxWrite</span>&nbsp;<span class="op" id="6325778">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325783">n</span>&nbsp;<span class="op" id="6325785">=</span>&nbsp;<span class="ident" id="6325787">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325802">if</span>&nbsp;<span class="ident" id="6325805">err</span>&nbsp;<span class="op" id="6325809">:=</span>&nbsp;<span class="ident" id="6325812">w</span><span class="op" id="6325813">.</span><span class="ident" id="6325814">c</span><span class="op" id="6325815">.</span><span class="ident" id="6325816">writeRecord</span><span class="op" id="6325827">(</span><span class="ident" id="6325828">w</span><span class="op" id="6325829">.</span><span class="ident" id="6325830">recType</span><span class="op" id="6325837">,</span>&nbsp;<span class="ident" id="6325839">w</span><span class="op" id="6325840">.</span><span class="ident" id="6325841">reqId</span><span class="op" id="6325846">,</span>&nbsp;<span class="ident" id="6325848">p</span><span class="op" id="6325849">[</span><span class="op" id="6325850">:</span><span class="ident" id="6325851">n</span><span class="op" id="6325852">]</span><span class="op" id="6325853">)</span><span class="op" id="6325854">;</span>&nbsp;<span class="ident" id="6325856">err</span>&nbsp;<span class="op" id="6325860">!=</span>&nbsp;<span class="ident" id="6325863">nil</span>&nbsp;<span class="op" id="6325867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325872">return</span>&nbsp;<span class="ident" id="6325879">nn</span><span class="op" id="6325881">,</span>&nbsp;<span class="ident" id="6325883">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325889">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325893">nn</span>&nbsp;<span class="op" id="6325896">+=</span>&nbsp;<span class="ident" id="6325899">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325903">p</span>&nbsp;<span class="op" id="6325905">=</span>&nbsp;<span class="ident" id="6325907">p</span><span class="op" id="6325908">[</span><span class="ident" id="6325909">n</span><span class="op" id="6325910">:</span><span class="op" id="6325911">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325917">return</span>&nbsp;<span class="ident" id="6325924">nn</span><span class="op" id="6325926">,</span>&nbsp;<span class="ident" id="6325928">nil</span><br>
<span class="lineno"></span><span class="op" id="6325932">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6325935">func</span>&nbsp;<span class="op" id="6325940">(</span><span class="ident" id="6325941">w</span>&nbsp;<span class="op" id="6325943">*</span><span class="ident" id="6325944">streamWriter</span><span class="op" id="6325956">)</span>&nbsp;<span class="ident" id="6325958">Close</span><span class="op" id="6325963">(</span><span class="op" id="6325964">)</span>&nbsp;<span class="builtintype" id="6325966">error</span>&nbsp;<span class="op" id="6325972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6325975">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326017">return</span>&nbsp;<span class="ident" id="6326024">w</span><span class="op" id="6326025">.</span><span class="ident" id="6326026">c</span><span class="op" id="6326027">.</span><span class="ident" id="6326028">writeRecord</span><span class="op" id="6326039">(</span><span class="ident" id="6326040">w</span><span class="op" id="6326041">.</span><span class="ident" id="6326042">recType</span><span class="op" id="6326049">,</span>&nbsp;<span class="ident" id="6326051">w</span><span class="op" id="6326052">.</span><span class="ident" id="6326053">reqId</span><span class="op" id="6326058">,</span>&nbsp;<span class="ident" id="6326060">nil</span><span class="op" id="6326063">)</span><br>
<span class="lineno"></span><span class="op" id="6326065">}</span>
</div>
</body>
</html>
