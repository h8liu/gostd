<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2233581">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2233636">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2233690">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2233741">package</span>&nbsp;<span class="ident" id="2233749">os</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2233753">import</span>&nbsp;<span class="op" id="2233760">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2233763">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2233774">&#34;sync&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2233782">&#34;syscall&#34;</span><br>
<span class="lineno"></span><span class="op" id="2233792">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2233795">var</span>&nbsp;<span class="ident" id="2233799">getwdCache</span>&nbsp;<span class="keyword" id="2233810">struct</span>&nbsp;<span class="op" id="2233817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2233820">sync</span><span class="op" id="2233824">.</span><span class="ident" id="2233825">Mutex</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2233832">dir</span>&nbsp;<span class="builtintype" id="2233836">string</span><br>
<span class="lineno"></span><span class="op" id="2233843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2233846">//&nbsp;useSyscallwd&nbsp;determines&nbsp;whether&nbsp;to&nbsp;use&nbsp;the&nbsp;return&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2233908">//&nbsp;syscall.Getwd&nbsp;based&nbsp;on&nbsp;its&nbsp;error.</span><br>
<span class="lineno">20</span><span class="keyword" id="2233945">var</span>&nbsp;<span class="ident" id="2233949">useSyscallwd</span>&nbsp;<span class="op" id="2233962">=</span>&nbsp;<span class="keyword" id="2233964">func</span><span class="op" id="2233968">(</span><span class="builtintype" id="2233969">error</span><span class="op" id="2233974">)</span>&nbsp;<span class="builtintype" id="2233976">bool</span>&nbsp;<span class="op" id="2233981">{</span>&nbsp;<span class="keyword" id="2233983">return</span>&nbsp;<span class="ident" id="2233990">true</span>&nbsp;<span class="op" id="2233995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2233998">//&nbsp;Getwd&nbsp;returns&nbsp;a&nbsp;rooted&nbsp;path&nbsp;name&nbsp;corresponding&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2234055">//&nbsp;current&nbsp;directory.&nbsp;&nbsp;If&nbsp;the&nbsp;current&nbsp;directory&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="2234110">//&nbsp;reached&nbsp;via&nbsp;multiple&nbsp;paths&nbsp;(due&nbsp;to&nbsp;symbolic&nbsp;links),</span><br>
<span class="lineno">25</span><span class="comment" id="2234165">//&nbsp;Getwd&nbsp;may&nbsp;return&nbsp;any&nbsp;one&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="2234202">func</span>&nbsp;<span class="ident" id="2234207">Getwd</span><span class="op" id="2234212">(</span><span class="op" id="2234213">)</span>&nbsp;<span class="op" id="2234215">(</span><span class="ident" id="2234216">dir</span>&nbsp;<span class="builtintype" id="2234220">string</span><span class="op" id="2234226">,</span>&nbsp;<span class="ident" id="2234228">err</span>&nbsp;<span class="builtintype" id="2234232">error</span><span class="op" id="2234237">)</span>&nbsp;<span class="op" id="2234239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2234242">if</span>&nbsp;<span class="ident" id="2234245">runtime</span><span class="op" id="2234252">.</span><span class="ident" id="2234253">GOOS</span>&nbsp;<span class="op" id="2234258">==</span>&nbsp;<span class="string" id="2234261">&#34;windows&#34;</span>&nbsp;<span class="op" id="2234271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2234275">return</span>&nbsp;<span class="ident" id="2234282">syscall</span><span class="op" id="2234289">.</span><span class="ident" id="2234290">Getwd</span><span class="op" id="2234295">(</span><span class="op" id="2234296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2234299">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2234303">//&nbsp;Clumsy&nbsp;but&nbsp;widespread&nbsp;kludge:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2234337">//&nbsp;if&nbsp;$PWD&nbsp;is&nbsp;set&nbsp;and&nbsp;matches&nbsp;&#34;.&#34;,&nbsp;use&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2234381">dot</span><span class="op" id="2234384">,</span>&nbsp;<span class="ident" id="2234386">err</span>&nbsp;<span class="op" id="2234390">:=</span>&nbsp;<span class="ident" id="2234393">Stat</span><span class="op" id="2234397">(</span><span class="string" id="2234398">&#34;.&#34;</span><span class="op" id="2234401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2234404">if</span>&nbsp;<span class="ident" id="2234407">err</span>&nbsp;<span class="op" id="2234411">!=</span>&nbsp;<span class="ident" id="2234414">nil</span>&nbsp;<span class="op" id="2234418">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2234422">return</span>&nbsp;<span class="string" id="2234429">&#34;&#34;</span><span class="op" id="2234431">,</span>&nbsp;<span class="ident" id="2234433">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2234438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2234441">dir</span>&nbsp;<span class="op" id="2234445">=</span>&nbsp;<span class="ident" id="2234447">Getenv</span><span class="op" id="2234453">(</span><span class="string" id="2234454">&#34;PWD&#34;</span><span class="op" id="2234459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2234462">if</span>&nbsp;<span class="builtinfunc" id="2234465">len</span><span class="op" id="2234468">(</span><span class="ident" id="2234469">dir</span><span class="op" id="2234472">)</span>&nbsp;<span class="op" id="2234474">&gt;</span>&nbsp;<span class="num" id="2234476">0</span>&nbsp;<span class="op" id="2234478">&amp;&amp;</span>&nbsp;<span class="ident" id="2234481">dir</span><span class="op" id="2234484">[</span><span class="num" id="2234485">0</span><span class="op" id="2234486">]</span>&nbsp;<span class="op" id="2234488">==</span>&nbsp;<span class="string" id="2234491">&#39;/&#39;</span>&nbsp;<span class="op" id="2234495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2234499">d</span><span class="op" id="2234500">,</span>&nbsp;<span class="ident" id="2234502">err</span>&nbsp;<span class="op" id="2234506">:=</span>&nbsp;<span class="ident" id="2234509">Stat</span><span class="op" id="2234513">(</span><span class="ident" id="2234514">dir</span><span class="op" id="2234517">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2234521">if</span>&nbsp;<span class="ident" id="2234524">err</span>&nbsp;<span class="op" id="2234528">==</span>&nbsp;<span class="ident" id="2234531">nil</span>&nbsp;<span class="op" id="2234535">&amp;&amp;</span>&nbsp;<span class="ident" id="2234538">SameFile</span><span class="op" id="2234546">(</span><span class="ident" id="2234547">dot</span><span class="op" id="2234550">,</span>&nbsp;<span class="ident" id="2234552">d</span><span class="op" id="2234553">)</span>&nbsp;<span class="op" id="2234555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2234560">return</span>&nbsp;<span class="ident" id="2234567">dir</span><span class="op" id="2234570">,</span>&nbsp;<span class="ident" id="2234572">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2234578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2234581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2234585">//&nbsp;If&nbsp;the&nbsp;operating&nbsp;system&nbsp;provides&nbsp;a&nbsp;Getwd&nbsp;call,&nbsp;use&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2234644">//&nbsp;Otherwise,&nbsp;we&#39;re&nbsp;trying&nbsp;to&nbsp;find&nbsp;our&nbsp;way&nbsp;back&nbsp;to&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2234701">if</span>&nbsp;<span class="ident" id="2234704">syscall</span><span class="op" id="2234711">.</span><span class="ident" id="2234712">ImplementsGetwd</span>&nbsp;<span class="op" id="2234728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2234732">s</span><span class="op" id="2234733">,</span>&nbsp;<span class="ident" id="2234735">e</span>&nbsp;<span class="op" id="2234737">:=</span>&nbsp;<span class="ident" id="2234740">syscall</span><span class="op" id="2234747">.</span><span class="ident" id="2234748">Getwd</span><span class="op" id="2234753">(</span><span class="op" id="2234754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2234758">if</span>&nbsp;<span class="ident" id="2234761">useSyscallwd</span><span class="op" id="2234773">(</span><span class="ident" id="2234774">e</span><span class="op" id="2234775">)</span>&nbsp;<span class="op" id="2234777">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2234782">return</span>&nbsp;<span class="ident" id="2234789">s</span><span class="op" id="2234790">,</span>&nbsp;<span class="ident" id="2234792">NewSyscallError</span><span class="op" id="2234807">(</span><span class="string" id="2234808">&#34;getwd&#34;</span><span class="op" id="2234815">,</span>&nbsp;<span class="ident" id="2234817">e</span><span class="op" id="2234818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2234822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2234825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2234829">//&nbsp;Apply&nbsp;same&nbsp;kludge&nbsp;but&nbsp;to&nbsp;cached&nbsp;dir&nbsp;instead&nbsp;of&nbsp;$PWD.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2234886">getwdCache</span><span class="op" id="2234896">.</span><span class="ident" id="2234897">Lock</span><span class="op" id="2234901">(</span><span class="op" id="2234902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2234905">dir</span>&nbsp;<span class="op" id="2234909">=</span>&nbsp;<span class="ident" id="2234911">getwdCache</span><span class="op" id="2234921">.</span><span class="ident" id="2234922">dir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2234927">getwdCache</span><span class="op" id="2234937">.</span><span class="ident" id="2234938">Unlock</span><span class="op" id="2234944">(</span><span class="op" id="2234945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2234948">if</span>&nbsp;<span class="builtinfunc" id="2234951">len</span><span class="op" id="2234954">(</span><span class="ident" id="2234955">dir</span><span class="op" id="2234958">)</span>&nbsp;<span class="op" id="2234960">&gt;</span>&nbsp;<span class="num" id="2234962">0</span>&nbsp;<span class="op" id="2234964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2234968">d</span><span class="op" id="2234969">,</span>&nbsp;<span class="ident" id="2234971">err</span>&nbsp;<span class="op" id="2234975">:=</span>&nbsp;<span class="ident" id="2234978">Stat</span><span class="op" id="2234982">(</span><span class="ident" id="2234983">dir</span><span class="op" id="2234986">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2234990">if</span>&nbsp;<span class="ident" id="2234993">err</span>&nbsp;<span class="op" id="2234997">==</span>&nbsp;<span class="ident" id="2235000">nil</span>&nbsp;<span class="op" id="2235004">&amp;&amp;</span>&nbsp;<span class="ident" id="2235007">SameFile</span><span class="op" id="2235015">(</span><span class="ident" id="2235016">dot</span><span class="op" id="2235019">,</span>&nbsp;<span class="ident" id="2235021">d</span><span class="op" id="2235022">)</span>&nbsp;<span class="op" id="2235024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235029">return</span>&nbsp;<span class="ident" id="2235036">dir</span><span class="op" id="2235039">,</span>&nbsp;<span class="ident" id="2235041">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2235047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2235050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2235054">//&nbsp;Root&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;because&nbsp;it&nbsp;has&nbsp;no&nbsp;parent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2235106">//&nbsp;and&nbsp;ends&nbsp;in&nbsp;a&nbsp;slash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2235131">root</span><span class="op" id="2235135">,</span>&nbsp;<span class="ident" id="2235137">err</span>&nbsp;<span class="op" id="2235141">:=</span>&nbsp;<span class="ident" id="2235144">Stat</span><span class="op" id="2235148">(</span><span class="string" id="2235149">&#34;/&#34;</span><span class="op" id="2235152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235155">if</span>&nbsp;<span class="ident" id="2235158">err</span>&nbsp;<span class="op" id="2235162">!=</span>&nbsp;<span class="ident" id="2235165">nil</span>&nbsp;<span class="op" id="2235169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2235173">//&nbsp;Can&#39;t&nbsp;stat&nbsp;root&nbsp;-&nbsp;no&nbsp;hope.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235205">return</span>&nbsp;<span class="string" id="2235212">&#34;&#34;</span><span class="op" id="2235214">,</span>&nbsp;<span class="ident" id="2235216">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2235221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235224">if</span>&nbsp;<span class="ident" id="2235227">SameFile</span><span class="op" id="2235235">(</span><span class="ident" id="2235236">root</span><span class="op" id="2235240">,</span>&nbsp;<span class="ident" id="2235242">dot</span><span class="op" id="2235245">)</span>&nbsp;<span class="op" id="2235247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235251">return</span>&nbsp;<span class="string" id="2235258">&#34;/&#34;</span><span class="op" id="2235261">,</span>&nbsp;<span class="ident" id="2235263">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2235268">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2235272">//&nbsp;General&nbsp;algorithm:&nbsp;find&nbsp;name&nbsp;in&nbsp;parent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2235315">//&nbsp;and&nbsp;then&nbsp;find&nbsp;name&nbsp;of&nbsp;parent.&nbsp;&nbsp;Each&nbsp;iteration</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2235365">//&nbsp;adds&nbsp;/name&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;dir.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2235405">dir</span>&nbsp;<span class="op" id="2235409">=</span>&nbsp;<span class="string" id="2235411">&#34;&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235415">for</span>&nbsp;<span class="ident" id="2235419">parent</span>&nbsp;<span class="op" id="2235426">:=</span>&nbsp;<span class="string" id="2235429">&#34;..&#34;</span><span class="op" id="2235433">;</span>&nbsp;<span class="op" id="2235435">;</span>&nbsp;<span class="ident" id="2235437">parent</span>&nbsp;<span class="op" id="2235444">=</span>&nbsp;<span class="string" id="2235446">&#34;../&#34;</span>&nbsp;<span class="op" id="2235452">+</span>&nbsp;<span class="ident" id="2235454">parent</span>&nbsp;<span class="op" id="2235461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235465">if</span>&nbsp;<span class="builtinfunc" id="2235468">len</span><span class="op" id="2235471">(</span><span class="ident" id="2235472">parent</span><span class="op" id="2235478">)</span>&nbsp;<span class="op" id="2235480">&gt;=</span>&nbsp;<span class="num" id="2235483">1024</span>&nbsp;<span class="op" id="2235488">{</span>&nbsp;<span class="comment" id="2235490">//&nbsp;Sanity&nbsp;check</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235509">return</span>&nbsp;<span class="string" id="2235516">&#34;&#34;</span><span class="op" id="2235518">,</span>&nbsp;<span class="ident" id="2235520">syscall</span><span class="op" id="2235527">.</span><span class="ident" id="2235528">ENAMETOOLONG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2235543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2235547">fd</span><span class="op" id="2235549">,</span>&nbsp;<span class="ident" id="2235551">err</span>&nbsp;<span class="op" id="2235555">:=</span>&nbsp;<span class="ident" id="2235558">Open</span><span class="op" id="2235562">(</span><span class="ident" id="2235563">parent</span><span class="op" id="2235569">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235573">if</span>&nbsp;<span class="ident" id="2235576">err</span>&nbsp;<span class="op" id="2235580">!=</span>&nbsp;<span class="ident" id="2235583">nil</span>&nbsp;<span class="op" id="2235587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235592">return</span>&nbsp;<span class="string" id="2235599">&#34;&#34;</span><span class="op" id="2235601">,</span>&nbsp;<span class="ident" id="2235603">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2235609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235614">for</span>&nbsp;<span class="op" id="2235618">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2235623">names</span><span class="op" id="2235628">,</span>&nbsp;<span class="ident" id="2235630">err</span>&nbsp;<span class="op" id="2235634">:=</span>&nbsp;<span class="ident" id="2235637">fd</span><span class="op" id="2235639">.</span><span class="ident" id="2235640">Readdirnames</span><span class="op" id="2235652">(</span><span class="num" id="2235653">100</span><span class="op" id="2235656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235661">if</span>&nbsp;<span class="ident" id="2235664">err</span>&nbsp;<span class="op" id="2235668">!=</span>&nbsp;<span class="ident" id="2235671">nil</span>&nbsp;<span class="op" id="2235675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2235681">fd</span><span class="op" id="2235683">.</span><span class="ident" id="2235684">Close</span><span class="op" id="2235689">(</span><span class="op" id="2235690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235696">return</span>&nbsp;<span class="string" id="2235703">&#34;&#34;</span><span class="op" id="2235705">,</span>&nbsp;<span class="ident" id="2235707">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2235714">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235719">for</span>&nbsp;<span class="ident" id="2235723">_</span><span class="op" id="2235724">,</span>&nbsp;<span class="ident" id="2235726">name</span>&nbsp;<span class="op" id="2235731">:=</span>&nbsp;<span class="keyword" id="2235734">range</span>&nbsp;<span class="ident" id="2235740">names</span>&nbsp;<span class="op" id="2235746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2235752">d</span><span class="op" id="2235753">,</span>&nbsp;<span class="ident" id="2235755">_</span>&nbsp;<span class="op" id="2235757">:=</span>&nbsp;<span class="ident" id="2235760">Lstat</span><span class="op" id="2235765">(</span><span class="ident" id="2235766">parent</span>&nbsp;<span class="op" id="2235773">+</span>&nbsp;<span class="string" id="2235775">&#34;/&#34;</span>&nbsp;<span class="op" id="2235779">+</span>&nbsp;<span class="ident" id="2235781">name</span><span class="op" id="2235785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235791">if</span>&nbsp;<span class="ident" id="2235794">SameFile</span><span class="op" id="2235802">(</span><span class="ident" id="2235803">d</span><span class="op" id="2235804">,</span>&nbsp;<span class="ident" id="2235806">dot</span><span class="op" id="2235809">)</span>&nbsp;<span class="op" id="2235811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2235818">dir</span>&nbsp;<span class="op" id="2235822">=</span>&nbsp;<span class="string" id="2235824">&#34;/&#34;</span>&nbsp;<span class="op" id="2235828">+</span>&nbsp;<span class="ident" id="2235830">name</span>&nbsp;<span class="op" id="2235835">+</span>&nbsp;<span class="ident" id="2235837">dir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235846">goto</span>&nbsp;<span class="ident" id="2235851">Found</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2235861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2235866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2235870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2235874">Found</span><span class="op" id="2235879">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2235883">pd</span><span class="op" id="2235885">,</span>&nbsp;<span class="ident" id="2235887">err</span>&nbsp;<span class="op" id="2235891">:=</span>&nbsp;<span class="ident" id="2235894">fd</span><span class="op" id="2235896">.</span><span class="ident" id="2235897">Stat</span><span class="op" id="2235901">(</span><span class="op" id="2235902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235906">if</span>&nbsp;<span class="ident" id="2235909">err</span>&nbsp;<span class="op" id="2235913">!=</span>&nbsp;<span class="ident" id="2235916">nil</span>&nbsp;<span class="op" id="2235920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235925">return</span>&nbsp;<span class="string" id="2235932">&#34;&#34;</span><span class="op" id="2235934">,</span>&nbsp;<span class="ident" id="2235936">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2235942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2235946">fd</span><span class="op" id="2235948">.</span><span class="ident" id="2235949">Close</span><span class="op" id="2235954">(</span><span class="op" id="2235955">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235959">if</span>&nbsp;<span class="ident" id="2235962">SameFile</span><span class="op" id="2235970">(</span><span class="ident" id="2235971">pd</span><span class="op" id="2235973">,</span>&nbsp;<span class="ident" id="2235975">root</span><span class="op" id="2235979">)</span>&nbsp;<span class="op" id="2235981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2235986">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2235994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2235998">//&nbsp;Set&nbsp;up&nbsp;for&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2236026">dot</span>&nbsp;<span class="op" id="2236030">=</span>&nbsp;<span class="ident" id="2236032">pd</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2236036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2236040">//&nbsp;Save&nbsp;answer&nbsp;as&nbsp;hint&nbsp;to&nbsp;avoid&nbsp;the&nbsp;expensive&nbsp;path&nbsp;next&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2236103">getwdCache</span><span class="op" id="2236113">.</span><span class="ident" id="2236114">Lock</span><span class="op" id="2236118">(</span><span class="op" id="2236119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2236122">getwdCache</span><span class="op" id="2236132">.</span><span class="ident" id="2236133">dir</span>&nbsp;<span class="op" id="2236137">=</span>&nbsp;<span class="ident" id="2236139">dir</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2236144">getwdCache</span><span class="op" id="2236154">.</span><span class="ident" id="2236155">Unlock</span><span class="op" id="2236161">(</span><span class="op" id="2236162">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2236166">return</span>&nbsp;<span class="ident" id="2236173">dir</span><span class="op" id="2236176">,</span>&nbsp;<span class="ident" id="2236178">nil</span><br>
<span class="lineno"></span><span class="op" id="2236182">}</span>
</div>
</body>
</html>
