<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html" class="current">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6980934">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6980989">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6981043">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6981094">package</span>&nbsp;<span class="ident" id="6981102">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6981107">import</span>&nbsp;<span class="op" id="6981114">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6981117">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6981140">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6981150">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6981157">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6981163">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6981170">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6981178">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6981189">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6981200">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6981208">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6981219">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6981226">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6981229">var</span>&nbsp;<span class="ident" id="6981233">_</span>&nbsp;<span class="op" id="6981235">=</span>&nbsp;<span class="ident" id="6981237">log</span><span class="op" id="6981240">.</span><span class="ident" id="6981241">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6981249">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="6981317">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="6981349">//</span><br>
<span class="lineno"></span><span class="comment" id="6981352">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="6981417">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="6981484">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="6981496">//</span><br>
<span class="lineno">30</span><span class="comment" id="6981499">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="6981509">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="6981563">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="6981624">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="6981673">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="6981746">//</span><br>
<span class="lineno"></span><span class="comment" id="6981749">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="6981814">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="6981873">type</span>&nbsp;<span class="ident" id="6981878">fakeDriver</span>&nbsp;<span class="keyword" id="6981889">struct</span>&nbsp;<span class="op" id="6981896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6981899">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6981910">sync</span><span class="op" id="6981914">.</span><span class="ident" id="6981915">Mutex</span>&nbsp;<span class="comment" id="6981921">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6981951">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="6981962">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6981973">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6981988">closeCount</span>&nbsp;<span class="builtintype" id="6981999">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6982010">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982026">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6982037">chan</span>&nbsp;<span class="keyword" id="6982042">struct</span><span class="op" id="6982048">{</span><span class="op" id="6982049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982052">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="6982063">chan</span>&nbsp;<span class="keyword" id="6982068">struct</span><span class="op" id="6982074">{</span><span class="op" id="6982075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982078">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6982089">map</span><span class="op" id="6982092">[</span><span class="builtintype" id="6982093">string</span><span class="op" id="6982099">]</span><span class="op" id="6982100">*</span><span class="ident" id="6982101">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="6982108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6982111">type</span>&nbsp;<span class="ident" id="6982116">fakeDB</span>&nbsp;<span class="keyword" id="6982123">struct</span>&nbsp;<span class="op" id="6982130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982133">name</span>&nbsp;<span class="builtintype" id="6982138">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982147">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6982155">sync</span><span class="op" id="6982159">.</span><span class="ident" id="6982160">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982167">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6982175">[</span><span class="op" id="6982176">]</span><span class="op" id="6982177">*</span><span class="ident" id="6982178">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982188">tables</span>&nbsp;&nbsp;<span class="keyword" id="6982196">map</span><span class="op" id="6982199">[</span><span class="builtintype" id="6982200">string</span><span class="op" id="6982206">]</span><span class="op" id="6982207">*</span><span class="ident" id="6982208">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982215">badConn</span>&nbsp;<span class="builtintype" id="6982223">bool</span><br>
<span class="lineno"></span><span class="op" id="6982228">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="6982231">type</span>&nbsp;<span class="ident" id="6982236">table</span>&nbsp;<span class="keyword" id="6982242">struct</span>&nbsp;<span class="op" id="6982249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982252">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6982260">sync</span><span class="op" id="6982264">.</span><span class="ident" id="6982265">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982272">colname</span>&nbsp;<span class="op" id="6982280">[</span><span class="op" id="6982281">]</span><span class="builtintype" id="6982282">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982290">coltype</span>&nbsp;<span class="op" id="6982298">[</span><span class="op" id="6982299">]</span><span class="builtintype" id="6982300">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982308">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6982316">[</span><span class="op" id="6982317">]</span><span class="op" id="6982318">*</span><span class="ident" id="6982319">row</span><br>
<span class="lineno"></span><span class="op" id="6982323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6982326">func</span>&nbsp;<span class="op" id="6982331">(</span><span class="ident" id="6982332">t</span>&nbsp;<span class="op" id="6982334">*</span><span class="ident" id="6982335">table</span><span class="op" id="6982340">)</span>&nbsp;<span class="ident" id="6982342">columnIndex</span><span class="op" id="6982353">(</span><span class="ident" id="6982354">name</span>&nbsp;<span class="builtintype" id="6982359">string</span><span class="op" id="6982365">)</span>&nbsp;<span class="builtintype" id="6982367">int</span>&nbsp;<span class="op" id="6982371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6982374">for</span>&nbsp;<span class="ident" id="6982378">n</span><span class="op" id="6982379">,</span>&nbsp;<span class="ident" id="6982381">nname</span>&nbsp;<span class="op" id="6982387">:=</span>&nbsp;<span class="keyword" id="6982390">range</span>&nbsp;<span class="ident" id="6982396">t</span><span class="op" id="6982397">.</span><span class="ident" id="6982398">colname</span>&nbsp;<span class="op" id="6982406">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6982410">if</span>&nbsp;<span class="ident" id="6982413">name</span>&nbsp;<span class="op" id="6982418">==</span>&nbsp;<span class="ident" id="6982421">nname</span>&nbsp;<span class="op" id="6982427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6982432">return</span>&nbsp;<span class="ident" id="6982439">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6982443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6982446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6982449">return</span>&nbsp;<span class="op" id="6982456">-</span><span class="num" id="6982457">1</span><br>
<span class="lineno">70</span><span class="op" id="6982459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6982462">type</span>&nbsp;<span class="ident" id="6982467">row</span>&nbsp;<span class="keyword" id="6982471">struct</span>&nbsp;<span class="op" id="6982478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982481">cols</span>&nbsp;<span class="op" id="6982486">[</span><span class="op" id="6982487">]</span><span class="keyword" id="6982488">interface</span><span class="op" id="6982497">{</span><span class="op" id="6982498">}</span>&nbsp;<span class="comment" id="6982500">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="6982552">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="6982555">func</span>&nbsp;<span class="op" id="6982560">(</span><span class="ident" id="6982561">r</span>&nbsp;<span class="op" id="6982563">*</span><span class="ident" id="6982564">row</span><span class="op" id="6982567">)</span>&nbsp;<span class="ident" id="6982569">clone</span><span class="op" id="6982574">(</span><span class="op" id="6982575">)</span>&nbsp;<span class="op" id="6982577">*</span><span class="ident" id="6982578">row</span>&nbsp;<span class="op" id="6982582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982585">nrow</span>&nbsp;<span class="op" id="6982590">:=</span>&nbsp;<span class="op" id="6982593">&amp;</span><span class="ident" id="6982594">row</span><span class="op" id="6982597">{</span><span class="ident" id="6982598">cols</span><span class="op" id="6982602">:</span>&nbsp;<span class="builtinfunc" id="6982604">make</span><span class="op" id="6982608">(</span><span class="op" id="6982609">[</span><span class="op" id="6982610">]</span><span class="keyword" id="6982611">interface</span><span class="op" id="6982620">{</span><span class="op" id="6982621">}</span><span class="op" id="6982622">,</span>&nbsp;<span class="builtinfunc" id="6982624">len</span><span class="op" id="6982627">(</span><span class="ident" id="6982628">r</span><span class="op" id="6982629">.</span><span class="ident" id="6982630">cols</span><span class="op" id="6982634">)</span><span class="op" id="6982635">)</span><span class="op" id="6982636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6982639">copy</span><span class="op" id="6982643">(</span><span class="ident" id="6982644">nrow</span><span class="op" id="6982648">.</span><span class="ident" id="6982649">cols</span><span class="op" id="6982653">,</span>&nbsp;<span class="ident" id="6982655">r</span><span class="op" id="6982656">.</span><span class="ident" id="6982657">cols</span><span class="op" id="6982661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6982664">return</span>&nbsp;<span class="ident" id="6982671">nrow</span><br>
<span class="lineno">80</span><span class="op" id="6982676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6982679">type</span>&nbsp;<span class="ident" id="6982684">fakeConn</span>&nbsp;<span class="keyword" id="6982693">struct</span>&nbsp;<span class="op" id="6982700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982703">db</span>&nbsp;<span class="op" id="6982706">*</span><span class="ident" id="6982707">fakeDB</span>&nbsp;<span class="comment" id="6982714">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982748">currTx</span>&nbsp;<span class="op" id="6982755">*</span><span class="ident" id="6982756">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6982765">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982786">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6982798">sync</span><span class="op" id="6982802">.</span><span class="ident" id="6982803">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982810">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6982822">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982827">stmtsClosed</span>&nbsp;<span class="builtintype" id="6982839">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982844">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="6982856">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982861">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6982873">bool</span><br>
<span class="lineno"></span><span class="op" id="6982878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6982881">func</span>&nbsp;<span class="op" id="6982886">(</span><span class="ident" id="6982887">c</span>&nbsp;<span class="op" id="6982889">*</span><span class="ident" id="6982890">fakeConn</span><span class="op" id="6982898">)</span>&nbsp;<span class="ident" id="6982900">incrStat</span><span class="op" id="6982908">(</span><span class="ident" id="6982909">v</span>&nbsp;<span class="op" id="6982911">*</span><span class="builtintype" id="6982912">int</span><span class="op" id="6982915">)</span>&nbsp;<span class="op" id="6982917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982920">c</span><span class="op" id="6982921">.</span><span class="ident" id="6982922">mu</span><span class="op" id="6982924">.</span><span class="ident" id="6982925">Lock</span><span class="op" id="6982929">(</span><span class="op" id="6982930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6982933">*</span><span class="ident" id="6982934">v</span><span class="op" id="6982935">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982939">c</span><span class="op" id="6982940">.</span><span class="ident" id="6982941">mu</span><span class="op" id="6982943">.</span><span class="ident" id="6982944">Unlock</span><span class="op" id="6982950">(</span><span class="op" id="6982951">)</span><br>
<span class="lineno"></span><span class="op" id="6982953">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="6982956">type</span>&nbsp;<span class="ident" id="6982961">fakeTx</span>&nbsp;<span class="keyword" id="6982968">struct</span>&nbsp;<span class="op" id="6982975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6982978">c</span>&nbsp;<span class="op" id="6982980">*</span><span class="ident" id="6982981">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="6982990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="6982993">type</span>&nbsp;<span class="ident" id="6982998">fakeStmt</span>&nbsp;<span class="keyword" id="6983007">struct</span>&nbsp;<span class="op" id="6983014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983017">c</span>&nbsp;<span class="op" id="6983019">*</span><span class="ident" id="6983020">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983030">q</span>&nbsp;<span class="builtintype" id="6983032">string</span>&nbsp;<span class="comment" id="6983039">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983063">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6983069">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983077">table</span>&nbsp;<span class="builtintype" id="6983083">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983092">closed</span>&nbsp;<span class="builtintype" id="6983099">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983106">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6983119">[</span><span class="op" id="6983120">]</span><span class="builtintype" id="6983121">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6983133">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983187">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6983200">[</span><span class="op" id="6983201">]</span><span class="builtintype" id="6983202">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6983214">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983233">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6983246">[</span><span class="op" id="6983247">]</span><span class="keyword" id="6983248">interface</span><span class="op" id="6983257">{</span><span class="op" id="6983258">}</span>&nbsp;<span class="comment" id="6983260">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983321">placeholders</span>&nbsp;<span class="builtintype" id="6983334">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6983348">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983395">whereCol</span>&nbsp;<span class="op" id="6983404">[</span><span class="op" id="6983405">]</span><span class="builtintype" id="6983406">string</span>&nbsp;<span class="comment" id="6983413">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983452">placeholderConverter</span>&nbsp;<span class="op" id="6983473">[</span><span class="op" id="6983474">]</span><span class="ident" id="6983475">driver</span><span class="op" id="6983481">.</span><span class="ident" id="6983482">ValueConverter</span>&nbsp;<span class="comment" id="6983497">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="6983515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6983518">var</span>&nbsp;<span class="ident" id="6983522">fdriver</span>&nbsp;<span class="ident" id="6983530">driver</span><span class="op" id="6983536">.</span><span class="ident" id="6983537">Driver</span>&nbsp;<span class="op" id="6983544">=</span>&nbsp;<span class="op" id="6983546">&amp;</span><span class="ident" id="6983547">fakeDriver</span><span class="op" id="6983557">{</span><span class="op" id="6983558">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="6983561">func</span>&nbsp;<span class="ident" id="6983566">init</span><span class="op" id="6983570">(</span><span class="op" id="6983571">)</span>&nbsp;<span class="op" id="6983573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983576">Register</span><span class="op" id="6983584">(</span><span class="string" id="6983585">&#34;test&#34;</span><span class="op" id="6983591">,</span>&nbsp;<span class="ident" id="6983593">fdriver</span><span class="op" id="6983600">)</span><br>
<span class="lineno"></span><span class="op" id="6983602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="6983605">func</span>&nbsp;<span class="ident" id="6983610">contains</span><span class="op" id="6983618">(</span><span class="ident" id="6983619">list</span>&nbsp;<span class="op" id="6983624">[</span><span class="op" id="6983625">]</span><span class="builtintype" id="6983626">string</span><span class="op" id="6983632">,</span>&nbsp;<span class="ident" id="6983634">y</span>&nbsp;<span class="builtintype" id="6983636">string</span><span class="op" id="6983642">)</span>&nbsp;<span class="builtintype" id="6983644">bool</span>&nbsp;<span class="op" id="6983649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6983652">for</span>&nbsp;<span class="ident" id="6983656">_</span><span class="op" id="6983657">,</span>&nbsp;<span class="ident" id="6983659">x</span>&nbsp;<span class="op" id="6983661">:=</span>&nbsp;<span class="keyword" id="6983664">range</span>&nbsp;<span class="ident" id="6983670">list</span>&nbsp;<span class="op" id="6983675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6983679">if</span>&nbsp;<span class="ident" id="6983682">x</span>&nbsp;<span class="op" id="6983684">==</span>&nbsp;<span class="ident" id="6983687">y</span>&nbsp;<span class="op" id="6983689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6983694">return</span>&nbsp;<span class="builtintype" id="6983701">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6983708">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6983711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6983714">return</span>&nbsp;<span class="builtintype" id="6983721">false</span><br>
<span class="lineno"></span><span class="op" id="6983727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6983730">type</span>&nbsp;<span class="ident" id="6983735">Dummy</span>&nbsp;<span class="keyword" id="6983741">struct</span>&nbsp;<span class="op" id="6983748">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983751">driver</span><span class="op" id="6983757">.</span><span class="ident" id="6983758">Driver</span><br>
<span class="lineno"></span><span class="op" id="6983765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6983768">func</span>&nbsp;<span class="ident" id="6983773">TestDrivers</span><span class="op" id="6983784">(</span><span class="ident" id="6983785">t</span>&nbsp;<span class="op" id="6983787">*</span><span class="ident" id="6983788">testing</span><span class="op" id="6983795">.</span><span class="ident" id="6983796">T</span><span class="op" id="6983797">)</span>&nbsp;<span class="op" id="6983799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983802">unregisterAllDrivers</span><span class="op" id="6983822">(</span><span class="op" id="6983823">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983826">Register</span><span class="op" id="6983834">(</span><span class="string" id="6983835">&#34;test&#34;</span><span class="op" id="6983841">,</span>&nbsp;<span class="ident" id="6983843">fdriver</span><span class="op" id="6983850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983853">Register</span><span class="op" id="6983861">(</span><span class="string" id="6983862">&#34;invalid&#34;</span><span class="op" id="6983871">,</span>&nbsp;<span class="ident" id="6983873">Dummy</span><span class="op" id="6983878">{</span><span class="op" id="6983879">}</span><span class="op" id="6983880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6983883">all</span>&nbsp;<span class="op" id="6983887">:=</span>&nbsp;<span class="ident" id="6983890">Drivers</span><span class="op" id="6983897">(</span><span class="op" id="6983898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6983901">if</span>&nbsp;<span class="builtinfunc" id="6983904">len</span><span class="op" id="6983907">(</span><span class="ident" id="6983908">all</span><span class="op" id="6983911">)</span>&nbsp;<span class="op" id="6983913">&lt;</span>&nbsp;<span class="num" id="6983915">2</span>&nbsp;<span class="op" id="6983917">||</span>&nbsp;<span class="op" id="6983920">!</span><span class="ident" id="6983921">sort</span><span class="op" id="6983925">.</span><span class="ident" id="6983926">StringsAreSorted</span><span class="op" id="6983942">(</span><span class="ident" id="6983943">all</span><span class="op" id="6983946">)</span>&nbsp;<span class="op" id="6983948">||</span>&nbsp;<span class="op" id="6983951">!</span><span class="ident" id="6983952">contains</span><span class="op" id="6983960">(</span><span class="ident" id="6983961">all</span><span class="op" id="6983964">,</span>&nbsp;<span class="string" id="6983966">&#34;test&#34;</span><span class="op" id="6983972">)</span>&nbsp;<span class="op" id="6983974">||</span>&nbsp;<span class="op" id="6983977">!</span><span class="ident" id="6983978">contains</span><span class="op" id="6983986">(</span><span class="ident" id="6983987">all</span><span class="op" id="6983990">,</span>&nbsp;<span class="string" id="6983992">&#34;invalid&#34;</span><span class="op" id="6984001">)</span>&nbsp;<span class="op" id="6984003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984007">t</span><span class="op" id="6984008">.</span><span class="ident" id="6984009">Fatalf</span><span class="op" id="6984015">(</span><span class="string" id="6984016">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="6984078">,</span>&nbsp;<span class="ident" id="6984080">all</span><span class="op" id="6984083">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6984086">}</span><br>
<span class="lineno"></span><span class="op" id="6984088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6984091">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="6984114">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="6984129">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="6984199">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6984272">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="6984322">func</span>&nbsp;<span class="op" id="6984327">(</span><span class="ident" id="6984328">d</span>&nbsp;<span class="op" id="6984330">*</span><span class="ident" id="6984331">fakeDriver</span><span class="op" id="6984341">)</span>&nbsp;<span class="ident" id="6984343">Open</span><span class="op" id="6984347">(</span><span class="ident" id="6984348">dsn</span>&nbsp;<span class="builtintype" id="6984352">string</span><span class="op" id="6984358">)</span>&nbsp;<span class="op" id="6984360">(</span><span class="ident" id="6984361">driver</span><span class="op" id="6984367">.</span><span class="ident" id="6984368">Conn</span><span class="op" id="6984372">,</span>&nbsp;<span class="builtintype" id="6984374">error</span><span class="op" id="6984379">)</span>&nbsp;<span class="op" id="6984381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984384">parts</span>&nbsp;<span class="op" id="6984390">:=</span>&nbsp;<span class="ident" id="6984393">strings</span><span class="op" id="6984400">.</span><span class="ident" id="6984401">Split</span><span class="op" id="6984406">(</span><span class="ident" id="6984407">dsn</span><span class="op" id="6984410">,</span>&nbsp;<span class="string" id="6984412">&#34;;&#34;</span><span class="op" id="6984415">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6984418">if</span>&nbsp;<span class="builtinfunc" id="6984421">len</span><span class="op" id="6984424">(</span><span class="ident" id="6984425">parts</span><span class="op" id="6984430">)</span>&nbsp;<span class="op" id="6984432">&lt;</span>&nbsp;<span class="num" id="6984434">1</span>&nbsp;<span class="op" id="6984436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6984440">return</span>&nbsp;<span class="ident" id="6984447">nil</span><span class="op" id="6984450">,</span>&nbsp;<span class="ident" id="6984452">errors</span><span class="op" id="6984458">.</span><span class="ident" id="6984459">New</span><span class="op" id="6984462">(</span><span class="string" id="6984463">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="6984489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6984492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984495">name</span>&nbsp;<span class="op" id="6984500">:=</span>&nbsp;<span class="ident" id="6984503">parts</span><span class="op" id="6984508">[</span><span class="num" id="6984509">0</span><span class="op" id="6984510">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984514">db</span>&nbsp;<span class="op" id="6984517">:=</span>&nbsp;<span class="ident" id="6984520">d</span><span class="op" id="6984521">.</span><span class="ident" id="6984522">getDB</span><span class="op" id="6984527">(</span><span class="ident" id="6984528">name</span><span class="op" id="6984532">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984536">d</span><span class="op" id="6984537">.</span><span class="ident" id="6984538">mu</span><span class="op" id="6984540">.</span><span class="ident" id="6984541">Lock</span><span class="op" id="6984545">(</span><span class="op" id="6984546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984549">d</span><span class="op" id="6984550">.</span><span class="ident" id="6984551">openCount</span><span class="op" id="6984560">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984564">d</span><span class="op" id="6984565">.</span><span class="ident" id="6984566">mu</span><span class="op" id="6984568">.</span><span class="ident" id="6984569">Unlock</span><span class="op" id="6984575">(</span><span class="op" id="6984576">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984579">conn</span>&nbsp;<span class="op" id="6984584">:=</span>&nbsp;<span class="op" id="6984587">&amp;</span><span class="ident" id="6984588">fakeConn</span><span class="op" id="6984596">{</span><span class="ident" id="6984597">db</span><span class="op" id="6984599">:</span>&nbsp;<span class="ident" id="6984601">db</span><span class="op" id="6984603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6984607">if</span>&nbsp;<span class="builtinfunc" id="6984610">len</span><span class="op" id="6984613">(</span><span class="ident" id="6984614">parts</span><span class="op" id="6984619">)</span>&nbsp;<span class="op" id="6984621">&gt;=</span>&nbsp;<span class="num" id="6984624">2</span>&nbsp;<span class="op" id="6984626">&amp;&amp;</span>&nbsp;<span class="ident" id="6984629">parts</span><span class="op" id="6984634">[</span><span class="num" id="6984635">1</span><span class="op" id="6984636">]</span>&nbsp;<span class="op" id="6984638">==</span>&nbsp;<span class="string" id="6984641">&#34;badConn&#34;</span>&nbsp;<span class="op" id="6984651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984655">conn</span><span class="op" id="6984659">.</span><span class="ident" id="6984660">bad</span>&nbsp;<span class="op" id="6984664">=</span>&nbsp;<span class="builtintype" id="6984666">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6984672">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6984675">if</span>&nbsp;<span class="ident" id="6984678">d</span><span class="op" id="6984679">.</span><span class="ident" id="6984680">waitCh</span>&nbsp;<span class="op" id="6984687">!=</span>&nbsp;<span class="ident" id="6984690">nil</span>&nbsp;<span class="op" id="6984694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984698">d</span><span class="op" id="6984699">.</span><span class="ident" id="6984700">waitingCh</span>&nbsp;<span class="op" id="6984710">&lt;-</span>&nbsp;<span class="keyword" id="6984713">struct</span><span class="op" id="6984719">{</span><span class="op" id="6984720">}</span><span class="op" id="6984721">{</span><span class="op" id="6984722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6984726">&lt;-</span><span class="ident" id="6984728">d</span><span class="op" id="6984729">.</span><span class="ident" id="6984730">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984739">d</span><span class="op" id="6984740">.</span><span class="ident" id="6984741">waitCh</span>&nbsp;<span class="op" id="6984748">=</span>&nbsp;<span class="ident" id="6984750">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984756">d</span><span class="op" id="6984757">.</span><span class="ident" id="6984758">waitingCh</span>&nbsp;<span class="op" id="6984768">=</span>&nbsp;<span class="ident" id="6984770">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6984775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6984778">return</span>&nbsp;<span class="ident" id="6984785">conn</span><span class="op" id="6984789">,</span>&nbsp;<span class="ident" id="6984791">nil</span><br>
<span class="lineno"></span><span class="op" id="6984795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6984798">func</span>&nbsp;<span class="op" id="6984803">(</span><span class="ident" id="6984804">d</span>&nbsp;<span class="op" id="6984806">*</span><span class="ident" id="6984807">fakeDriver</span><span class="op" id="6984817">)</span>&nbsp;<span class="ident" id="6984819">getDB</span><span class="op" id="6984824">(</span><span class="ident" id="6984825">name</span>&nbsp;<span class="builtintype" id="6984830">string</span><span class="op" id="6984836">)</span>&nbsp;<span class="op" id="6984838">*</span><span class="ident" id="6984839">fakeDB</span>&nbsp;<span class="op" id="6984846">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984849">d</span><span class="op" id="6984850">.</span><span class="ident" id="6984851">mu</span><span class="op" id="6984853">.</span><span class="ident" id="6984854">Lock</span><span class="op" id="6984858">(</span><span class="op" id="6984859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6984862">defer</span>&nbsp;<span class="ident" id="6984868">d</span><span class="op" id="6984869">.</span><span class="ident" id="6984870">mu</span><span class="op" id="6984872">.</span><span class="ident" id="6984873">Unlock</span><span class="op" id="6984879">(</span><span class="op" id="6984880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6984883">if</span>&nbsp;<span class="ident" id="6984886">d</span><span class="op" id="6984887">.</span><span class="ident" id="6984888">dbs</span>&nbsp;<span class="op" id="6984892">==</span>&nbsp;<span class="ident" id="6984895">nil</span>&nbsp;<span class="op" id="6984899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984903">d</span><span class="op" id="6984904">.</span><span class="ident" id="6984905">dbs</span>&nbsp;<span class="op" id="6984909">=</span>&nbsp;<span class="builtinfunc" id="6984911">make</span><span class="op" id="6984915">(</span><span class="keyword" id="6984916">map</span><span class="op" id="6984919">[</span><span class="builtintype" id="6984920">string</span><span class="op" id="6984926">]</span><span class="op" id="6984927">*</span><span class="ident" id="6984928">fakeDB</span><span class="op" id="6984934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6984937">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984940">db</span><span class="op" id="6984942">,</span>&nbsp;<span class="ident" id="6984944">ok</span>&nbsp;<span class="op" id="6984947">:=</span>&nbsp;<span class="ident" id="6984950">d</span><span class="op" id="6984951">.</span><span class="ident" id="6984952">dbs</span><span class="op" id="6984955">[</span><span class="ident" id="6984956">name</span><span class="op" id="6984960">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6984963">if</span>&nbsp;<span class="op" id="6984966">!</span><span class="ident" id="6984967">ok</span>&nbsp;<span class="op" id="6984970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6984974">db</span>&nbsp;<span class="op" id="6984977">=</span>&nbsp;<span class="op" id="6984979">&amp;</span><span class="ident" id="6984980">fakeDB</span><span class="op" id="6984986">{</span><span class="ident" id="6984987">name</span><span class="op" id="6984991">:</span>&nbsp;<span class="ident" id="6984993">name</span><span class="op" id="6984997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6985001">d</span><span class="op" id="6985002">.</span><span class="ident" id="6985003">dbs</span><span class="op" id="6985006">[</span><span class="ident" id="6985007">name</span><span class="op" id="6985011">]</span>&nbsp;<span class="op" id="6985013">=</span>&nbsp;<span class="ident" id="6985015">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6985019">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985022">return</span>&nbsp;<span class="ident" id="6985029">db</span><br>
<span class="lineno"></span><span class="op" id="6985032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6985035">func</span>&nbsp;<span class="op" id="6985040">(</span><span class="ident" id="6985041">db</span>&nbsp;<span class="op" id="6985044">*</span><span class="ident" id="6985045">fakeDB</span><span class="op" id="6985051">)</span>&nbsp;<span class="ident" id="6985053">wipe</span><span class="op" id="6985057">(</span><span class="op" id="6985058">)</span>&nbsp;<span class="op" id="6985060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6985063">db</span><span class="op" id="6985065">.</span><span class="ident" id="6985066">mu</span><span class="op" id="6985068">.</span><span class="ident" id="6985069">Lock</span><span class="op" id="6985073">(</span><span class="op" id="6985074">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985077">defer</span>&nbsp;<span class="ident" id="6985083">db</span><span class="op" id="6985085">.</span><span class="ident" id="6985086">mu</span><span class="op" id="6985088">.</span><span class="ident" id="6985089">Unlock</span><span class="op" id="6985095">(</span><span class="op" id="6985096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6985099">db</span><span class="op" id="6985101">.</span><span class="ident" id="6985102">tables</span>&nbsp;<span class="op" id="6985109">=</span>&nbsp;<span class="ident" id="6985111">nil</span><br>
<span class="lineno"></span><span class="op" id="6985115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6985118">func</span>&nbsp;<span class="op" id="6985123">(</span><span class="ident" id="6985124">db</span>&nbsp;<span class="op" id="6985127">*</span><span class="ident" id="6985128">fakeDB</span><span class="op" id="6985134">)</span>&nbsp;<span class="ident" id="6985136">createTable</span><span class="op" id="6985147">(</span><span class="ident" id="6985148">name</span>&nbsp;<span class="builtintype" id="6985153">string</span><span class="op" id="6985159">,</span>&nbsp;<span class="ident" id="6985161">columnNames</span><span class="op" id="6985172">,</span>&nbsp;<span class="ident" id="6985174">columnTypes</span>&nbsp;<span class="op" id="6985186">[</span><span class="op" id="6985187">]</span><span class="builtintype" id="6985188">string</span><span class="op" id="6985194">)</span>&nbsp;<span class="builtintype" id="6985196">error</span>&nbsp;<span class="op" id="6985202">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6985205">db</span><span class="op" id="6985207">.</span><span class="ident" id="6985208">mu</span><span class="op" id="6985210">.</span><span class="ident" id="6985211">Lock</span><span class="op" id="6985215">(</span><span class="op" id="6985216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985219">defer</span>&nbsp;<span class="ident" id="6985225">db</span><span class="op" id="6985227">.</span><span class="ident" id="6985228">mu</span><span class="op" id="6985230">.</span><span class="ident" id="6985231">Unlock</span><span class="op" id="6985237">(</span><span class="op" id="6985238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985241">if</span>&nbsp;<span class="ident" id="6985244">db</span><span class="op" id="6985246">.</span><span class="ident" id="6985247">tables</span>&nbsp;<span class="op" id="6985254">==</span>&nbsp;<span class="ident" id="6985257">nil</span>&nbsp;<span class="op" id="6985261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6985265">db</span><span class="op" id="6985267">.</span><span class="ident" id="6985268">tables</span>&nbsp;<span class="op" id="6985275">=</span>&nbsp;<span class="builtinfunc" id="6985277">make</span><span class="op" id="6985281">(</span><span class="keyword" id="6985282">map</span><span class="op" id="6985285">[</span><span class="builtintype" id="6985286">string</span><span class="op" id="6985292">]</span><span class="op" id="6985293">*</span><span class="ident" id="6985294">table</span><span class="op" id="6985299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6985302">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985305">if</span>&nbsp;<span class="ident" id="6985308">_</span><span class="op" id="6985309">,</span>&nbsp;<span class="ident" id="6985311">exist</span>&nbsp;<span class="op" id="6985317">:=</span>&nbsp;<span class="ident" id="6985320">db</span><span class="op" id="6985322">.</span><span class="ident" id="6985323">tables</span><span class="op" id="6985329">[</span><span class="ident" id="6985330">name</span><span class="op" id="6985334">]</span><span class="op" id="6985335">;</span>&nbsp;<span class="ident" id="6985337">exist</span>&nbsp;<span class="op" id="6985343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985347">return</span>&nbsp;<span class="ident" id="6985354">fmt</span><span class="op" id="6985357">.</span><span class="ident" id="6985358">Errorf</span><span class="op" id="6985364">(</span><span class="string" id="6985365">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="6985390">,</span>&nbsp;<span class="ident" id="6985392">name</span><span class="op" id="6985396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6985399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985402">if</span>&nbsp;<span class="builtinfunc" id="6985405">len</span><span class="op" id="6985408">(</span><span class="ident" id="6985409">columnNames</span><span class="op" id="6985420">)</span>&nbsp;<span class="op" id="6985422">!=</span>&nbsp;<span class="builtinfunc" id="6985425">len</span><span class="op" id="6985428">(</span><span class="ident" id="6985429">columnTypes</span><span class="op" id="6985440">)</span>&nbsp;<span class="op" id="6985442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985446">return</span>&nbsp;<span class="ident" id="6985453">fmt</span><span class="op" id="6985456">.</span><span class="ident" id="6985457">Errorf</span><span class="op" id="6985463">(</span><span class="string" id="6985464">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="6985519">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6985524">name</span><span class="op" id="6985528">,</span>&nbsp;<span class="builtinfunc" id="6985530">len</span><span class="op" id="6985533">(</span><span class="ident" id="6985534">columnNames</span><span class="op" id="6985545">)</span><span class="op" id="6985546">,</span>&nbsp;<span class="builtinfunc" id="6985548">len</span><span class="op" id="6985551">(</span><span class="ident" id="6985552">columnTypes</span><span class="op" id="6985563">)</span><span class="op" id="6985564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6985567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6985570">db</span><span class="op" id="6985572">.</span><span class="ident" id="6985573">tables</span><span class="op" id="6985579">[</span><span class="ident" id="6985580">name</span><span class="op" id="6985584">]</span>&nbsp;<span class="op" id="6985586">=</span>&nbsp;<span class="op" id="6985588">&amp;</span><span class="ident" id="6985589">table</span><span class="op" id="6985594">{</span><span class="ident" id="6985595">colname</span><span class="op" id="6985602">:</span>&nbsp;<span class="ident" id="6985604">columnNames</span><span class="op" id="6985615">,</span>&nbsp;<span class="ident" id="6985617">coltype</span><span class="op" id="6985624">:</span>&nbsp;<span class="ident" id="6985626">columnTypes</span><span class="op" id="6985637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985640">return</span>&nbsp;<span class="ident" id="6985647">nil</span><br>
<span class="lineno"></span><span class="op" id="6985651">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="6985654">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="6985693">func</span>&nbsp;<span class="op" id="6985698">(</span><span class="ident" id="6985699">db</span>&nbsp;<span class="op" id="6985702">*</span><span class="ident" id="6985703">fakeDB</span><span class="op" id="6985709">)</span>&nbsp;<span class="ident" id="6985711">table</span><span class="op" id="6985716">(</span><span class="ident" id="6985717">table</span>&nbsp;<span class="builtintype" id="6985723">string</span><span class="op" id="6985729">)</span>&nbsp;<span class="op" id="6985731">(</span><span class="op" id="6985732">*</span><span class="ident" id="6985733">table</span><span class="op" id="6985738">,</span>&nbsp;<span class="builtintype" id="6985740">bool</span><span class="op" id="6985744">)</span>&nbsp;<span class="op" id="6985746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985749">if</span>&nbsp;<span class="ident" id="6985752">db</span><span class="op" id="6985754">.</span><span class="ident" id="6985755">tables</span>&nbsp;<span class="op" id="6985762">==</span>&nbsp;<span class="ident" id="6985765">nil</span>&nbsp;<span class="op" id="6985769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985773">return</span>&nbsp;<span class="ident" id="6985780">nil</span><span class="op" id="6985783">,</span>&nbsp;<span class="builtintype" id="6985785">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6985792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6985795">t</span><span class="op" id="6985796">,</span>&nbsp;<span class="ident" id="6985798">ok</span>&nbsp;<span class="op" id="6985801">:=</span>&nbsp;<span class="ident" id="6985804">db</span><span class="op" id="6985806">.</span><span class="ident" id="6985807">tables</span><span class="op" id="6985813">[</span><span class="ident" id="6985814">table</span><span class="op" id="6985819">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985822">return</span>&nbsp;<span class="ident" id="6985829">t</span><span class="op" id="6985830">,</span>&nbsp;<span class="ident" id="6985832">ok</span><br>
<span class="lineno"></span><span class="op" id="6985835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="6985838">func</span>&nbsp;<span class="op" id="6985843">(</span><span class="ident" id="6985844">db</span>&nbsp;<span class="op" id="6985847">*</span><span class="ident" id="6985848">fakeDB</span><span class="op" id="6985854">)</span>&nbsp;<span class="ident" id="6985856">columnType</span><span class="op" id="6985866">(</span><span class="ident" id="6985867">table</span><span class="op" id="6985872">,</span>&nbsp;<span class="ident" id="6985874">column</span>&nbsp;<span class="builtintype" id="6985881">string</span><span class="op" id="6985887">)</span>&nbsp;<span class="op" id="6985889">(</span><span class="ident" id="6985890">typ</span>&nbsp;<span class="builtintype" id="6985894">string</span><span class="op" id="6985900">,</span>&nbsp;<span class="ident" id="6985902">ok</span>&nbsp;<span class="builtintype" id="6985905">bool</span><span class="op" id="6985909">)</span>&nbsp;<span class="op" id="6985911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6985914">db</span><span class="op" id="6985916">.</span><span class="ident" id="6985917">mu</span><span class="op" id="6985919">.</span><span class="ident" id="6985920">Lock</span><span class="op" id="6985924">(</span><span class="op" id="6985925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985928">defer</span>&nbsp;<span class="ident" id="6985934">db</span><span class="op" id="6985936">.</span><span class="ident" id="6985937">mu</span><span class="op" id="6985939">.</span><span class="ident" id="6985940">Unlock</span><span class="op" id="6985946">(</span><span class="op" id="6985947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6985950">t</span><span class="op" id="6985951">,</span>&nbsp;<span class="ident" id="6985953">ok</span>&nbsp;<span class="op" id="6985956">:=</span>&nbsp;<span class="ident" id="6985959">db</span><span class="op" id="6985961">.</span><span class="ident" id="6985962">table</span><span class="op" id="6985967">(</span><span class="ident" id="6985968">table</span><span class="op" id="6985973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985976">if</span>&nbsp;<span class="op" id="6985979">!</span><span class="ident" id="6985980">ok</span>&nbsp;<span class="op" id="6985983">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985987">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6985995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6985998">for</span>&nbsp;<span class="ident" id="6986002">n</span><span class="op" id="6986003">,</span>&nbsp;<span class="ident" id="6986005">cname</span>&nbsp;<span class="op" id="6986011">:=</span>&nbsp;<span class="keyword" id="6986014">range</span>&nbsp;<span class="ident" id="6986020">t</span><span class="op" id="6986021">.</span><span class="ident" id="6986022">colname</span>&nbsp;<span class="op" id="6986030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6986034">if</span>&nbsp;<span class="ident" id="6986037">cname</span>&nbsp;<span class="op" id="6986043">==</span>&nbsp;<span class="ident" id="6986046">column</span>&nbsp;<span class="op" id="6986053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6986058">return</span>&nbsp;<span class="ident" id="6986065">t</span><span class="op" id="6986066">.</span><span class="ident" id="6986067">coltype</span><span class="op" id="6986074">[</span><span class="ident" id="6986075">n</span><span class="op" id="6986076">]</span><span class="op" id="6986077">,</span>&nbsp;<span class="builtintype" id="6986079">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6986086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6986089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6986092">return</span>&nbsp;<span class="string" id="6986099">&#34;&#34;</span><span class="op" id="6986101">,</span>&nbsp;<span class="builtintype" id="6986103">false</span><br>
<span class="lineno"></span><span class="op" id="6986109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="6986112">func</span>&nbsp;<span class="op" id="6986117">(</span><span class="ident" id="6986118">c</span>&nbsp;<span class="op" id="6986120">*</span><span class="ident" id="6986121">fakeConn</span><span class="op" id="6986129">)</span>&nbsp;<span class="ident" id="6986131">isBad</span><span class="op" id="6986136">(</span><span class="op" id="6986137">)</span>&nbsp;<span class="builtintype" id="6986139">bool</span>&nbsp;<span class="op" id="6986144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6986147">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6986190">if</span>&nbsp;<span class="op" id="6986193">!</span><span class="ident" id="6986194">c</span><span class="op" id="6986195">.</span><span class="ident" id="6986196">bad</span>&nbsp;<span class="op" id="6986200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6986204">return</span>&nbsp;<span class="builtintype" id="6986211">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6986218">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6986221">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6986269">c</span><span class="op" id="6986270">.</span><span class="ident" id="6986271">db</span><span class="op" id="6986273">.</span><span class="ident" id="6986274">badConn</span>&nbsp;<span class="op" id="6986282">=</span>&nbsp;<span class="op" id="6986284">!</span><span class="ident" id="6986285">c</span><span class="op" id="6986286">.</span><span class="ident" id="6986287">db</span><span class="op" id="6986289">.</span><span class="ident" id="6986290">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6986299">return</span>&nbsp;<span class="ident" id="6986306">c</span><span class="op" id="6986307">.</span><span class="ident" id="6986308">db</span><span class="op" id="6986310">.</span><span class="ident" id="6986311">badConn</span><br>
<span class="lineno"></span><span class="op" id="6986319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6986322">func</span>&nbsp;<span class="op" id="6986327">(</span><span class="ident" id="6986328">c</span>&nbsp;<span class="op" id="6986330">*</span><span class="ident" id="6986331">fakeConn</span><span class="op" id="6986339">)</span>&nbsp;<span class="ident" id="6986341">Begin</span><span class="op" id="6986346">(</span><span class="op" id="6986347">)</span>&nbsp;<span class="op" id="6986349">(</span><span class="ident" id="6986350">driver</span><span class="op" id="6986356">.</span><span class="ident" id="6986357">Tx</span><span class="op" id="6986359">,</span>&nbsp;<span class="builtintype" id="6986361">error</span><span class="op" id="6986366">)</span>&nbsp;<span class="op" id="6986368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6986371">if</span>&nbsp;<span class="ident" id="6986374">c</span><span class="op" id="6986375">.</span><span class="ident" id="6986376">isBad</span><span class="op" id="6986381">(</span><span class="op" id="6986382">)</span>&nbsp;<span class="op" id="6986384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6986388">return</span>&nbsp;<span class="ident" id="6986395">nil</span><span class="op" id="6986398">,</span>&nbsp;<span class="ident" id="6986400">driver</span><span class="op" id="6986406">.</span><span class="ident" id="6986407">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6986419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6986422">if</span>&nbsp;<span class="ident" id="6986425">c</span><span class="op" id="6986426">.</span><span class="ident" id="6986427">currTx</span>&nbsp;<span class="op" id="6986434">!=</span>&nbsp;<span class="ident" id="6986437">nil</span>&nbsp;<span class="op" id="6986441">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6986445">return</span>&nbsp;<span class="ident" id="6986452">nil</span><span class="op" id="6986455">,</span>&nbsp;<span class="ident" id="6986457">errors</span><span class="op" id="6986463">.</span><span class="ident" id="6986464">New</span><span class="op" id="6986467">(</span><span class="string" id="6986468">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="6986494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6986497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6986500">c</span><span class="op" id="6986501">.</span><span class="ident" id="6986502">currTx</span>&nbsp;<span class="op" id="6986509">=</span>&nbsp;<span class="op" id="6986511">&amp;</span><span class="ident" id="6986512">fakeTx</span><span class="op" id="6986518">{</span><span class="ident" id="6986519">c</span><span class="op" id="6986520">:</span>&nbsp;<span class="ident" id="6986522">c</span><span class="op" id="6986523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6986526">return</span>&nbsp;<span class="ident" id="6986533">c</span><span class="op" id="6986534">.</span><span class="ident" id="6986535">currTx</span><span class="op" id="6986541">,</span>&nbsp;<span class="ident" id="6986543">nil</span><br>
<span class="lineno"></span><span class="op" id="6986547">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="6986550">var</span>&nbsp;<span class="ident" id="6986554">hookPostCloseConn</span>&nbsp;<span class="keyword" id="6986572">struct</span>&nbsp;<span class="op" id="6986579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6986582">sync</span><span class="op" id="6986586">.</span><span class="ident" id="6986587">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6986594">fn</span>&nbsp;<span class="keyword" id="6986597">func</span><span class="op" id="6986601">(</span><span class="op" id="6986602">*</span><span class="ident" id="6986603">fakeConn</span><span class="op" id="6986611">,</span>&nbsp;<span class="builtintype" id="6986613">error</span><span class="op" id="6986618">)</span><br>
<span class="lineno"></span><span class="op" id="6986620">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6986623">func</span>&nbsp;<span class="ident" id="6986628">setHookpostCloseConn</span><span class="op" id="6986648">(</span><span class="ident" id="6986649">fn</span>&nbsp;<span class="keyword" id="6986652">func</span><span class="op" id="6986656">(</span><span class="op" id="6986657">*</span><span class="ident" id="6986658">fakeConn</span><span class="op" id="6986666">,</span>&nbsp;<span class="builtintype" id="6986668">error</span><span class="op" id="6986673">)</span><span class="op" id="6986674">)</span>&nbsp;<span class="op" id="6986676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6986679">hookPostCloseConn</span><span class="op" id="6986696">.</span><span class="ident" id="6986697">Lock</span><span class="op" id="6986701">(</span><span class="op" id="6986702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6986705">defer</span>&nbsp;<span class="ident" id="6986711">hookPostCloseConn</span><span class="op" id="6986728">.</span><span class="ident" id="6986729">Unlock</span><span class="op" id="6986735">(</span><span class="op" id="6986736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6986739">hookPostCloseConn</span><span class="op" id="6986756">.</span><span class="ident" id="6986757">fn</span>&nbsp;<span class="op" id="6986760">=</span>&nbsp;<span class="ident" id="6986762">fn</span><br>
<span class="lineno">275</span><span class="op" id="6986765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6986768">var</span>&nbsp;<span class="ident" id="6986772">testStrictClose</span>&nbsp;<span class="op" id="6986788">*</span><span class="ident" id="6986789">testing</span><span class="op" id="6986796">.</span><span class="ident" id="6986797">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6986800">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="6986870">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="6986920">func</span>&nbsp;<span class="ident" id="6986925">setStrictFakeConnClose</span><span class="op" id="6986947">(</span><span class="ident" id="6986948">t</span>&nbsp;<span class="op" id="6986950">*</span><span class="ident" id="6986951">testing</span><span class="op" id="6986958">.</span><span class="ident" id="6986959">T</span><span class="op" id="6986960">)</span>&nbsp;<span class="op" id="6986962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6986965">testStrictClose</span>&nbsp;<span class="op" id="6986981">=</span>&nbsp;<span class="ident" id="6986983">t</span><br>
<span class="lineno"></span><span class="op" id="6986985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="6986988">func</span>&nbsp;<span class="op" id="6986993">(</span><span class="ident" id="6986994">c</span>&nbsp;<span class="op" id="6986996">*</span><span class="ident" id="6986997">fakeConn</span><span class="op" id="6987005">)</span>&nbsp;<span class="ident" id="6987007">Close</span><span class="op" id="6987012">(</span><span class="op" id="6987013">)</span>&nbsp;<span class="op" id="6987015">(</span><span class="ident" id="6987016">err</span>&nbsp;<span class="builtintype" id="6987020">error</span><span class="op" id="6987025">)</span>&nbsp;<span class="op" id="6987027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6987030">drv</span>&nbsp;<span class="op" id="6987034">:=</span>&nbsp;<span class="ident" id="6987037">fdriver</span><span class="op" id="6987044">.</span><span class="op" id="6987045">(</span><span class="op" id="6987046">*</span><span class="ident" id="6987047">fakeDriver</span><span class="op" id="6987057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987060">defer</span>&nbsp;<span class="keyword" id="6987066">func</span><span class="op" id="6987070">(</span><span class="op" id="6987071">)</span>&nbsp;<span class="op" id="6987073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987077">if</span>&nbsp;<span class="ident" id="6987080">err</span>&nbsp;<span class="op" id="6987084">!=</span>&nbsp;<span class="ident" id="6987087">nil</span>&nbsp;<span class="op" id="6987091">&amp;&amp;</span>&nbsp;<span class="ident" id="6987094">testStrictClose</span>&nbsp;<span class="op" id="6987110">!=</span>&nbsp;<span class="ident" id="6987113">nil</span>&nbsp;<span class="op" id="6987117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6987122">testStrictClose</span><span class="op" id="6987137">.</span><span class="ident" id="6987138">Errorf</span><span class="op" id="6987144">(</span><span class="string" id="6987145">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6987182">,</span>&nbsp;<span class="ident" id="6987184">err</span><span class="op" id="6987187">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6987191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6987195">hookPostCloseConn</span><span class="op" id="6987212">.</span><span class="ident" id="6987213">Lock</span><span class="op" id="6987217">(</span><span class="op" id="6987218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6987222">fn</span>&nbsp;<span class="op" id="6987225">:=</span>&nbsp;<span class="ident" id="6987228">hookPostCloseConn</span><span class="op" id="6987245">.</span><span class="ident" id="6987246">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6987251">hookPostCloseConn</span><span class="op" id="6987268">.</span><span class="ident" id="6987269">Unlock</span><span class="op" id="6987275">(</span><span class="op" id="6987276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987280">if</span>&nbsp;<span class="ident" id="6987283">fn</span>&nbsp;<span class="op" id="6987286">!=</span>&nbsp;<span class="ident" id="6987289">nil</span>&nbsp;<span class="op" id="6987293">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6987298">fn</span><span class="op" id="6987300">(</span><span class="ident" id="6987301">c</span><span class="op" id="6987302">,</span>&nbsp;<span class="ident" id="6987304">err</span><span class="op" id="6987307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6987311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987315">if</span>&nbsp;<span class="ident" id="6987318">err</span>&nbsp;<span class="op" id="6987322">==</span>&nbsp;<span class="ident" id="6987325">nil</span>&nbsp;<span class="op" id="6987329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6987334">drv</span><span class="op" id="6987337">.</span><span class="ident" id="6987338">mu</span><span class="op" id="6987340">.</span><span class="ident" id="6987341">Lock</span><span class="op" id="6987345">(</span><span class="op" id="6987346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6987351">drv</span><span class="op" id="6987354">.</span><span class="ident" id="6987355">closeCount</span><span class="op" id="6987365">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6987371">drv</span><span class="op" id="6987374">.</span><span class="ident" id="6987375">mu</span><span class="op" id="6987377">.</span><span class="ident" id="6987378">Unlock</span><span class="op" id="6987384">(</span><span class="op" id="6987385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6987389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6987392">}</span><span class="op" id="6987393">(</span><span class="op" id="6987394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987397">if</span>&nbsp;<span class="ident" id="6987400">c</span><span class="op" id="6987401">.</span><span class="ident" id="6987402">currTx</span>&nbsp;<span class="op" id="6987409">!=</span>&nbsp;<span class="ident" id="6987412">nil</span>&nbsp;<span class="op" id="6987416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987420">return</span>&nbsp;<span class="ident" id="6987427">errors</span><span class="op" id="6987433">.</span><span class="ident" id="6987434">New</span><span class="op" id="6987437">(</span><span class="string" id="6987438">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="6987478">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6987481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987484">if</span>&nbsp;<span class="ident" id="6987487">c</span><span class="op" id="6987488">.</span><span class="ident" id="6987489">db</span>&nbsp;<span class="op" id="6987492">==</span>&nbsp;<span class="ident" id="6987495">nil</span>&nbsp;<span class="op" id="6987499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987503">return</span>&nbsp;<span class="ident" id="6987510">errors</span><span class="op" id="6987516">.</span><span class="ident" id="6987517">New</span><span class="op" id="6987520">(</span><span class="string" id="6987521">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="6987559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6987562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987565">if</span>&nbsp;<span class="ident" id="6987568">c</span><span class="op" id="6987569">.</span><span class="ident" id="6987570">stmtsMade</span>&nbsp;<span class="op" id="6987580">&gt;</span>&nbsp;<span class="ident" id="6987582">c</span><span class="op" id="6987583">.</span><span class="ident" id="6987584">stmtsClosed</span>&nbsp;<span class="op" id="6987596">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987600">return</span>&nbsp;<span class="ident" id="6987607">errors</span><span class="op" id="6987613">.</span><span class="ident" id="6987614">New</span><span class="op" id="6987617">(</span><span class="string" id="6987618">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="6987654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6987657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6987660">c</span><span class="op" id="6987661">.</span><span class="ident" id="6987662">db</span>&nbsp;<span class="op" id="6987665">=</span>&nbsp;<span class="ident" id="6987667">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987672">return</span>&nbsp;<span class="ident" id="6987679">nil</span><br>
<span class="lineno"></span><span class="op" id="6987683">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="6987686">func</span>&nbsp;<span class="ident" id="6987691">checkSubsetTypes</span><span class="op" id="6987707">(</span><span class="ident" id="6987708">args</span>&nbsp;<span class="op" id="6987713">[</span><span class="op" id="6987714">]</span><span class="ident" id="6987715">driver</span><span class="op" id="6987721">.</span><span class="ident" id="6987722">Value</span><span class="op" id="6987727">)</span>&nbsp;<span class="builtintype" id="6987729">error</span>&nbsp;<span class="op" id="6987735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987738">for</span>&nbsp;<span class="ident" id="6987742">n</span><span class="op" id="6987743">,</span>&nbsp;<span class="ident" id="6987745">arg</span>&nbsp;<span class="op" id="6987749">:=</span>&nbsp;<span class="keyword" id="6987752">range</span>&nbsp;<span class="ident" id="6987758">args</span>&nbsp;<span class="op" id="6987763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987767">switch</span>&nbsp;<span class="ident" id="6987774">arg</span><span class="op" id="6987777">.</span><span class="op" id="6987778">(</span><span class="keyword" id="6987779">type</span><span class="op" id="6987783">)</span>&nbsp;<span class="op" id="6987785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987789">case</span>&nbsp;<span class="ident" id="6987794">int64</span><span class="op" id="6987799">,</span>&nbsp;<span class="builtintype" id="6987801">float64</span><span class="op" id="6987808">,</span>&nbsp;<span class="builtintype" id="6987810">bool</span><span class="op" id="6987814">,</span>&nbsp;<span class="ident" id="6987816">nil</span><span class="op" id="6987819">,</span>&nbsp;<span class="op" id="6987821">[</span><span class="op" id="6987822">]</span><span class="builtintype" id="6987823">byte</span><span class="op" id="6987827">,</span>&nbsp;<span class="builtintype" id="6987829">string</span><span class="op" id="6987835">,</span>&nbsp;<span class="ident" id="6987837">time</span><span class="op" id="6987841">.</span><span class="ident" id="6987842">Time</span><span class="op" id="6987846">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987850">default</span><span class="op" id="6987857">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987862">return</span>&nbsp;<span class="ident" id="6987869">fmt</span><span class="op" id="6987872">.</span><span class="ident" id="6987873">Errorf</span><span class="op" id="6987879">(</span><span class="string" id="6987880">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="6987928">,</span>&nbsp;<span class="ident" id="6987930">n</span><span class="op" id="6987931">+</span><span class="num" id="6987932">1</span><span class="op" id="6987933">,</span>&nbsp;<span class="ident" id="6987935">arg</span><span class="op" id="6987938">,</span>&nbsp;<span class="ident" id="6987940">arg</span><span class="op" id="6987943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6987947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6987950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6987953">return</span>&nbsp;<span class="ident" id="6987960">nil</span><br>
<span class="lineno">325</span><span class="op" id="6987964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6987967">func</span>&nbsp;<span class="op" id="6987972">(</span><span class="ident" id="6987973">c</span>&nbsp;<span class="op" id="6987975">*</span><span class="ident" id="6987976">fakeConn</span><span class="op" id="6987984">)</span>&nbsp;<span class="ident" id="6987986">Exec</span><span class="op" id="6987990">(</span><span class="ident" id="6987991">query</span>&nbsp;<span class="builtintype" id="6987997">string</span><span class="op" id="6988003">,</span>&nbsp;<span class="ident" id="6988005">args</span>&nbsp;<span class="op" id="6988010">[</span><span class="op" id="6988011">]</span><span class="ident" id="6988012">driver</span><span class="op" id="6988018">.</span><span class="ident" id="6988019">Value</span><span class="op" id="6988024">)</span>&nbsp;<span class="op" id="6988026">(</span><span class="ident" id="6988027">driver</span><span class="op" id="6988033">.</span><span class="ident" id="6988034">Result</span><span class="op" id="6988040">,</span>&nbsp;<span class="builtintype" id="6988042">error</span><span class="op" id="6988047">)</span>&nbsp;<span class="op" id="6988049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6988052">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6988113">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6988174">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6988233">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6988260">err</span>&nbsp;<span class="op" id="6988264">:=</span>&nbsp;<span class="ident" id="6988267">checkSubsetTypes</span><span class="op" id="6988283">(</span><span class="ident" id="6988284">args</span><span class="op" id="6988288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6988291">if</span>&nbsp;<span class="ident" id="6988294">err</span>&nbsp;<span class="op" id="6988298">!=</span>&nbsp;<span class="ident" id="6988301">nil</span>&nbsp;<span class="op" id="6988305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6988309">return</span>&nbsp;<span class="ident" id="6988316">nil</span><span class="op" id="6988319">,</span>&nbsp;<span class="ident" id="6988321">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6988326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6988329">return</span>&nbsp;<span class="ident" id="6988336">nil</span><span class="op" id="6988339">,</span>&nbsp;<span class="ident" id="6988341">driver</span><span class="op" id="6988347">.</span><span class="ident" id="6988348">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="6988356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6988359">func</span>&nbsp;<span class="op" id="6988364">(</span><span class="ident" id="6988365">c</span>&nbsp;<span class="op" id="6988367">*</span><span class="ident" id="6988368">fakeConn</span><span class="op" id="6988376">)</span>&nbsp;<span class="ident" id="6988378">Query</span><span class="op" id="6988383">(</span><span class="ident" id="6988384">query</span>&nbsp;<span class="builtintype" id="6988390">string</span><span class="op" id="6988396">,</span>&nbsp;<span class="ident" id="6988398">args</span>&nbsp;<span class="op" id="6988403">[</span><span class="op" id="6988404">]</span><span class="ident" id="6988405">driver</span><span class="op" id="6988411">.</span><span class="ident" id="6988412">Value</span><span class="op" id="6988417">)</span>&nbsp;<span class="op" id="6988419">(</span><span class="ident" id="6988420">driver</span><span class="op" id="6988426">.</span><span class="ident" id="6988427">Rows</span><span class="op" id="6988431">,</span>&nbsp;<span class="builtintype" id="6988433">error</span><span class="op" id="6988438">)</span>&nbsp;<span class="op" id="6988440">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6988443">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6988504">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6988565">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6988624">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6988651">err</span>&nbsp;<span class="op" id="6988655">:=</span>&nbsp;<span class="ident" id="6988658">checkSubsetTypes</span><span class="op" id="6988674">(</span><span class="ident" id="6988675">args</span><span class="op" id="6988679">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6988682">if</span>&nbsp;<span class="ident" id="6988685">err</span>&nbsp;<span class="op" id="6988689">!=</span>&nbsp;<span class="ident" id="6988692">nil</span>&nbsp;<span class="op" id="6988696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6988700">return</span>&nbsp;<span class="ident" id="6988707">nil</span><span class="op" id="6988710">,</span>&nbsp;<span class="ident" id="6988712">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6988717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6988720">return</span>&nbsp;<span class="ident" id="6988727">nil</span><span class="op" id="6988730">,</span>&nbsp;<span class="ident" id="6988732">driver</span><span class="op" id="6988738">.</span><span class="ident" id="6988739">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="6988747">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="6988750">func</span>&nbsp;<span class="ident" id="6988755">errf</span><span class="op" id="6988759">(</span><span class="ident" id="6988760">msg</span>&nbsp;<span class="builtintype" id="6988764">string</span><span class="op" id="6988770">,</span>&nbsp;<span class="ident" id="6988772">args</span>&nbsp;<span class="op" id="6988777">...</span><span class="keyword" id="6988780">interface</span><span class="op" id="6988789">{</span><span class="op" id="6988790">}</span><span class="op" id="6988791">)</span>&nbsp;<span class="builtintype" id="6988793">error</span>&nbsp;<span class="op" id="6988799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6988802">return</span>&nbsp;<span class="ident" id="6988809">errors</span><span class="op" id="6988815">.</span><span class="ident" id="6988816">New</span><span class="op" id="6988819">(</span><span class="string" id="6988820">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="6988831">+</span>&nbsp;<span class="ident" id="6988833">fmt</span><span class="op" id="6988836">.</span><span class="ident" id="6988837">Sprintf</span><span class="op" id="6988844">(</span><span class="ident" id="6988845">msg</span><span class="op" id="6988848">,</span>&nbsp;<span class="ident" id="6988850">args</span><span class="op" id="6988854">...</span><span class="op" id="6988857">)</span><span class="op" id="6988858">)</span><br>
<span class="lineno"></span><span class="op" id="6988860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="6988863">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="6988927">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="6988984">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="6989018">func</span>&nbsp;<span class="op" id="6989023">(</span><span class="ident" id="6989024">c</span>&nbsp;<span class="op" id="6989026">*</span><span class="ident" id="6989027">fakeConn</span><span class="op" id="6989035">)</span>&nbsp;<span class="ident" id="6989037">prepareSelect</span><span class="op" id="6989050">(</span><span class="ident" id="6989051">stmt</span>&nbsp;<span class="op" id="6989056">*</span><span class="ident" id="6989057">fakeStmt</span><span class="op" id="6989065">,</span>&nbsp;<span class="ident" id="6989067">parts</span>&nbsp;<span class="op" id="6989073">[</span><span class="op" id="6989074">]</span><span class="builtintype" id="6989075">string</span><span class="op" id="6989081">)</span>&nbsp;<span class="op" id="6989083">(</span><span class="ident" id="6989084">driver</span><span class="op" id="6989090">.</span><span class="ident" id="6989091">Stmt</span><span class="op" id="6989095">,</span>&nbsp;<span class="builtintype" id="6989097">error</span><span class="op" id="6989102">)</span>&nbsp;<span class="op" id="6989104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6989107">if</span>&nbsp;<span class="builtinfunc" id="6989110">len</span><span class="op" id="6989113">(</span><span class="ident" id="6989114">parts</span><span class="op" id="6989119">)</span>&nbsp;<span class="op" id="6989121">!=</span>&nbsp;<span class="num" id="6989124">3</span>&nbsp;<span class="op" id="6989126">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6989130">stmt</span><span class="op" id="6989134">.</span><span class="ident" id="6989135">Close</span><span class="op" id="6989140">(</span><span class="op" id="6989141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6989145">return</span>&nbsp;<span class="ident" id="6989152">nil</span><span class="op" id="6989155">,</span>&nbsp;<span class="ident" id="6989157">errf</span><span class="op" id="6989161">(</span><span class="string" id="6989162">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="6989207">,</span>&nbsp;<span class="builtinfunc" id="6989209">len</span><span class="op" id="6989212">(</span><span class="ident" id="6989213">parts</span><span class="op" id="6989218">)</span><span class="op" id="6989219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6989222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6989225">stmt</span><span class="op" id="6989229">.</span><span class="ident" id="6989230">table</span>&nbsp;<span class="op" id="6989236">=</span>&nbsp;<span class="ident" id="6989238">parts</span><span class="op" id="6989243">[</span><span class="num" id="6989244">0</span><span class="op" id="6989245">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6989248">stmt</span><span class="op" id="6989252">.</span><span class="ident" id="6989253">colName</span>&nbsp;<span class="op" id="6989261">=</span>&nbsp;<span class="ident" id="6989263">strings</span><span class="op" id="6989270">.</span><span class="ident" id="6989271">Split</span><span class="op" id="6989276">(</span><span class="ident" id="6989277">parts</span><span class="op" id="6989282">[</span><span class="num" id="6989283">1</span><span class="op" id="6989284">]</span><span class="op" id="6989285">,</span>&nbsp;<span class="string" id="6989287">&#34;,&#34;</span><span class="op" id="6989290">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6989293">for</span>&nbsp;<span class="ident" id="6989297">n</span><span class="op" id="6989298">,</span>&nbsp;<span class="ident" id="6989300">colspec</span>&nbsp;<span class="op" id="6989308">:=</span>&nbsp;<span class="keyword" id="6989311">range</span>&nbsp;<span class="ident" id="6989317">strings</span><span class="op" id="6989324">.</span><span class="ident" id="6989325">Split</span><span class="op" id="6989330">(</span><span class="ident" id="6989331">parts</span><span class="op" id="6989336">[</span><span class="num" id="6989337">2</span><span class="op" id="6989338">]</span><span class="op" id="6989339">,</span>&nbsp;<span class="string" id="6989341">&#34;,&#34;</span><span class="op" id="6989344">)</span>&nbsp;<span class="op" id="6989346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6989350">if</span>&nbsp;<span class="ident" id="6989353">colspec</span>&nbsp;<span class="op" id="6989361">==</span>&nbsp;<span class="string" id="6989364">&#34;&#34;</span>&nbsp;<span class="op" id="6989367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6989372">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6989383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6989387">nameVal</span>&nbsp;<span class="op" id="6989395">:=</span>&nbsp;<span class="ident" id="6989398">strings</span><span class="op" id="6989405">.</span><span class="ident" id="6989406">Split</span><span class="op" id="6989411">(</span><span class="ident" id="6989412">colspec</span><span class="op" id="6989419">,</span>&nbsp;<span class="string" id="6989421">&#34;=&#34;</span><span class="op" id="6989424">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6989428">if</span>&nbsp;<span class="builtinfunc" id="6989431">len</span><span class="op" id="6989434">(</span><span class="ident" id="6989435">nameVal</span><span class="op" id="6989442">)</span>&nbsp;<span class="op" id="6989444">!=</span>&nbsp;<span class="num" id="6989447">2</span>&nbsp;<span class="op" id="6989449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6989454">stmt</span><span class="op" id="6989458">.</span><span class="ident" id="6989459">Close</span><span class="op" id="6989464">(</span><span class="op" id="6989465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6989470">return</span>&nbsp;<span class="ident" id="6989477">nil</span><span class="op" id="6989480">,</span>&nbsp;<span class="ident" id="6989482">errf</span><span class="op" id="6989486">(</span><span class="string" id="6989487">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="6989548">,</span>&nbsp;<span class="ident" id="6989550">stmt</span><span class="op" id="6989554">.</span><span class="ident" id="6989555">table</span><span class="op" id="6989560">,</span>&nbsp;<span class="ident" id="6989562">colspec</span><span class="op" id="6989569">,</span>&nbsp;<span class="ident" id="6989571">n</span><span class="op" id="6989572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6989576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6989580">column</span><span class="op" id="6989586">,</span>&nbsp;<span class="ident" id="6989588">value</span>&nbsp;<span class="op" id="6989594">:=</span>&nbsp;<span class="ident" id="6989597">nameVal</span><span class="op" id="6989604">[</span><span class="num" id="6989605">0</span><span class="op" id="6989606">]</span><span class="op" id="6989607">,</span>&nbsp;<span class="ident" id="6989609">nameVal</span><span class="op" id="6989616">[</span><span class="num" id="6989617">1</span><span class="op" id="6989618">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6989622">_</span><span class="op" id="6989623">,</span>&nbsp;<span class="ident" id="6989625">ok</span>&nbsp;<span class="op" id="6989628">:=</span>&nbsp;<span class="ident" id="6989631">c</span><span class="op" id="6989632">.</span><span class="ident" id="6989633">db</span><span class="op" id="6989635">.</span><span class="ident" id="6989636">columnType</span><span class="op" id="6989646">(</span><span class="ident" id="6989647">stmt</span><span class="op" id="6989651">.</span><span class="ident" id="6989652">table</span><span class="op" id="6989657">,</span>&nbsp;<span class="ident" id="6989659">column</span><span class="op" id="6989665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6989669">if</span>&nbsp;<span class="op" id="6989672">!</span><span class="ident" id="6989673">ok</span>&nbsp;<span class="op" id="6989676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6989681">stmt</span><span class="op" id="6989685">.</span><span class="ident" id="6989686">Close</span><span class="op" id="6989691">(</span><span class="op" id="6989692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6989697">return</span>&nbsp;<span class="ident" id="6989704">nil</span><span class="op" id="6989707">,</span>&nbsp;<span class="ident" id="6989709">errf</span><span class="op" id="6989713">(</span><span class="string" id="6989714">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="6989768">,</span>&nbsp;<span class="ident" id="6989770">stmt</span><span class="op" id="6989774">.</span><span class="ident" id="6989775">table</span><span class="op" id="6989780">,</span>&nbsp;<span class="ident" id="6989782">column</span><span class="op" id="6989788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6989792">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6989796">if</span>&nbsp;<span class="ident" id="6989799">value</span>&nbsp;<span class="op" id="6989805">!=</span>&nbsp;<span class="string" id="6989808">&#34;?&#34;</span>&nbsp;<span class="op" id="6989812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6989817">stmt</span><span class="op" id="6989821">.</span><span class="ident" id="6989822">Close</span><span class="op" id="6989827">(</span><span class="op" id="6989828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6989833">return</span>&nbsp;<span class="ident" id="6989840">nil</span><span class="op" id="6989843">,</span>&nbsp;<span class="ident" id="6989845">errf</span><span class="op" id="6989849">(</span><span class="string" id="6989850">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="6989932">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6989938">stmt</span><span class="op" id="6989942">.</span><span class="ident" id="6989943">table</span><span class="op" id="6989948">,</span>&nbsp;<span class="ident" id="6989950">column</span><span class="op" id="6989956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6989960">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6989964">stmt</span><span class="op" id="6989968">.</span><span class="ident" id="6989969">whereCol</span>&nbsp;<span class="op" id="6989978">=</span>&nbsp;<span class="builtinfunc" id="6989980">append</span><span class="op" id="6989986">(</span><span class="ident" id="6989987">stmt</span><span class="op" id="6989991">.</span><span class="ident" id="6989992">whereCol</span><span class="op" id="6990000">,</span>&nbsp;<span class="ident" id="6990002">column</span><span class="op" id="6990008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6990012">stmt</span><span class="op" id="6990016">.</span><span class="ident" id="6990017">placeholders</span><span class="op" id="6990029">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6990033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6990036">return</span>&nbsp;<span class="ident" id="6990043">stmt</span><span class="op" id="6990047">,</span>&nbsp;<span class="ident" id="6990049">nil</span><br>
<span class="lineno"></span><span class="op" id="6990053">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="6990056">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="6990095">func</span>&nbsp;<span class="op" id="6990100">(</span><span class="ident" id="6990101">c</span>&nbsp;<span class="op" id="6990103">*</span><span class="ident" id="6990104">fakeConn</span><span class="op" id="6990112">)</span>&nbsp;<span class="ident" id="6990114">prepareCreate</span><span class="op" id="6990127">(</span><span class="ident" id="6990128">stmt</span>&nbsp;<span class="op" id="6990133">*</span><span class="ident" id="6990134">fakeStmt</span><span class="op" id="6990142">,</span>&nbsp;<span class="ident" id="6990144">parts</span>&nbsp;<span class="op" id="6990150">[</span><span class="op" id="6990151">]</span><span class="builtintype" id="6990152">string</span><span class="op" id="6990158">)</span>&nbsp;<span class="op" id="6990160">(</span><span class="ident" id="6990161">driver</span><span class="op" id="6990167">.</span><span class="ident" id="6990168">Stmt</span><span class="op" id="6990172">,</span>&nbsp;<span class="builtintype" id="6990174">error</span><span class="op" id="6990179">)</span>&nbsp;<span class="op" id="6990181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6990184">if</span>&nbsp;<span class="builtinfunc" id="6990187">len</span><span class="op" id="6990190">(</span><span class="ident" id="6990191">parts</span><span class="op" id="6990196">)</span>&nbsp;<span class="op" id="6990198">!=</span>&nbsp;<span class="num" id="6990201">2</span>&nbsp;<span class="op" id="6990203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6990207">stmt</span><span class="op" id="6990211">.</span><span class="ident" id="6990212">Close</span><span class="op" id="6990217">(</span><span class="op" id="6990218">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6990222">return</span>&nbsp;<span class="ident" id="6990229">nil</span><span class="op" id="6990232">,</span>&nbsp;<span class="ident" id="6990234">errf</span><span class="op" id="6990238">(</span><span class="string" id="6990239">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="6990284">,</span>&nbsp;<span class="builtinfunc" id="6990286">len</span><span class="op" id="6990289">(</span><span class="ident" id="6990290">parts</span><span class="op" id="6990295">)</span><span class="op" id="6990296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6990299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6990302">stmt</span><span class="op" id="6990306">.</span><span class="ident" id="6990307">table</span>&nbsp;<span class="op" id="6990313">=</span>&nbsp;<span class="ident" id="6990315">parts</span><span class="op" id="6990320">[</span><span class="num" id="6990321">0</span><span class="op" id="6990322">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6990325">for</span>&nbsp;<span class="ident" id="6990329">n</span><span class="op" id="6990330">,</span>&nbsp;<span class="ident" id="6990332">colspec</span>&nbsp;<span class="op" id="6990340">:=</span>&nbsp;<span class="keyword" id="6990343">range</span>&nbsp;<span class="ident" id="6990349">strings</span><span class="op" id="6990356">.</span><span class="ident" id="6990357">Split</span><span class="op" id="6990362">(</span><span class="ident" id="6990363">parts</span><span class="op" id="6990368">[</span><span class="num" id="6990369">1</span><span class="op" id="6990370">]</span><span class="op" id="6990371">,</span>&nbsp;<span class="string" id="6990373">&#34;,&#34;</span><span class="op" id="6990376">)</span>&nbsp;<span class="op" id="6990378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6990382">nameType</span>&nbsp;<span class="op" id="6990391">:=</span>&nbsp;<span class="ident" id="6990394">strings</span><span class="op" id="6990401">.</span><span class="ident" id="6990402">Split</span><span class="op" id="6990407">(</span><span class="ident" id="6990408">colspec</span><span class="op" id="6990415">,</span>&nbsp;<span class="string" id="6990417">&#34;=&#34;</span><span class="op" id="6990420">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6990424">if</span>&nbsp;<span class="builtinfunc" id="6990427">len</span><span class="op" id="6990430">(</span><span class="ident" id="6990431">nameType</span><span class="op" id="6990439">)</span>&nbsp;<span class="op" id="6990441">!=</span>&nbsp;<span class="num" id="6990444">2</span>&nbsp;<span class="op" id="6990446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6990451">stmt</span><span class="op" id="6990455">.</span><span class="ident" id="6990456">Close</span><span class="op" id="6990461">(</span><span class="op" id="6990462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6990467">return</span>&nbsp;<span class="ident" id="6990474">nil</span><span class="op" id="6990477">,</span>&nbsp;<span class="ident" id="6990479">errf</span><span class="op" id="6990483">(</span><span class="string" id="6990484">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="6990542">,</span>&nbsp;<span class="ident" id="6990544">stmt</span><span class="op" id="6990548">.</span><span class="ident" id="6990549">table</span><span class="op" id="6990554">,</span>&nbsp;<span class="ident" id="6990556">colspec</span><span class="op" id="6990563">,</span>&nbsp;<span class="ident" id="6990565">n</span><span class="op" id="6990566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6990570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6990574">stmt</span><span class="op" id="6990578">.</span><span class="ident" id="6990579">colName</span>&nbsp;<span class="op" id="6990587">=</span>&nbsp;<span class="builtinfunc" id="6990589">append</span><span class="op" id="6990595">(</span><span class="ident" id="6990596">stmt</span><span class="op" id="6990600">.</span><span class="ident" id="6990601">colName</span><span class="op" id="6990608">,</span>&nbsp;<span class="ident" id="6990610">nameType</span><span class="op" id="6990618">[</span><span class="num" id="6990619">0</span><span class="op" id="6990620">]</span><span class="op" id="6990621">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6990625">stmt</span><span class="op" id="6990629">.</span><span class="ident" id="6990630">colType</span>&nbsp;<span class="op" id="6990638">=</span>&nbsp;<span class="builtinfunc" id="6990640">append</span><span class="op" id="6990646">(</span><span class="ident" id="6990647">stmt</span><span class="op" id="6990651">.</span><span class="ident" id="6990652">colType</span><span class="op" id="6990659">,</span>&nbsp;<span class="ident" id="6990661">nameType</span><span class="op" id="6990669">[</span><span class="num" id="6990670">1</span><span class="op" id="6990671">]</span><span class="op" id="6990672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6990675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6990678">return</span>&nbsp;<span class="ident" id="6990685">stmt</span><span class="op" id="6990689">,</span>&nbsp;<span class="ident" id="6990691">nil</span><br>
<span class="lineno"></span><span class="op" id="6990695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="6990698">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="6990732">func</span>&nbsp;<span class="op" id="6990737">(</span><span class="ident" id="6990738">c</span>&nbsp;<span class="op" id="6990740">*</span><span class="ident" id="6990741">fakeConn</span><span class="op" id="6990749">)</span>&nbsp;<span class="ident" id="6990751">prepareInsert</span><span class="op" id="6990764">(</span><span class="ident" id="6990765">stmt</span>&nbsp;<span class="op" id="6990770">*</span><span class="ident" id="6990771">fakeStmt</span><span class="op" id="6990779">,</span>&nbsp;<span class="ident" id="6990781">parts</span>&nbsp;<span class="op" id="6990787">[</span><span class="op" id="6990788">]</span><span class="builtintype" id="6990789">string</span><span class="op" id="6990795">)</span>&nbsp;<span class="op" id="6990797">(</span><span class="ident" id="6990798">driver</span><span class="op" id="6990804">.</span><span class="ident" id="6990805">Stmt</span><span class="op" id="6990809">,</span>&nbsp;<span class="builtintype" id="6990811">error</span><span class="op" id="6990816">)</span>&nbsp;<span class="op" id="6990818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6990821">if</span>&nbsp;<span class="builtinfunc" id="6990824">len</span><span class="op" id="6990827">(</span><span class="ident" id="6990828">parts</span><span class="op" id="6990833">)</span>&nbsp;<span class="op" id="6990835">!=</span>&nbsp;<span class="num" id="6990838">2</span>&nbsp;<span class="op" id="6990840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6990844">stmt</span><span class="op" id="6990848">.</span><span class="ident" id="6990849">Close</span><span class="op" id="6990854">(</span><span class="op" id="6990855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6990859">return</span>&nbsp;<span class="ident" id="6990866">nil</span><span class="op" id="6990869">,</span>&nbsp;<span class="ident" id="6990871">errf</span><span class="op" id="6990875">(</span><span class="string" id="6990876">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="6990921">,</span>&nbsp;<span class="builtinfunc" id="6990923">len</span><span class="op" id="6990926">(</span><span class="ident" id="6990927">parts</span><span class="op" id="6990932">)</span><span class="op" id="6990933">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6990936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6990939">stmt</span><span class="op" id="6990943">.</span><span class="ident" id="6990944">table</span>&nbsp;<span class="op" id="6990950">=</span>&nbsp;<span class="ident" id="6990952">parts</span><span class="op" id="6990957">[</span><span class="num" id="6990958">0</span><span class="op" id="6990959">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6990962">for</span>&nbsp;<span class="ident" id="6990966">n</span><span class="op" id="6990967">,</span>&nbsp;<span class="ident" id="6990969">colspec</span>&nbsp;<span class="op" id="6990977">:=</span>&nbsp;<span class="keyword" id="6990980">range</span>&nbsp;<span class="ident" id="6990986">strings</span><span class="op" id="6990993">.</span><span class="ident" id="6990994">Split</span><span class="op" id="6990999">(</span><span class="ident" id="6991000">parts</span><span class="op" id="6991005">[</span><span class="num" id="6991006">1</span><span class="op" id="6991007">]</span><span class="op" id="6991008">,</span>&nbsp;<span class="string" id="6991010">&#34;,&#34;</span><span class="op" id="6991013">)</span>&nbsp;<span class="op" id="6991015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6991019">nameVal</span>&nbsp;<span class="op" id="6991027">:=</span>&nbsp;<span class="ident" id="6991030">strings</span><span class="op" id="6991037">.</span><span class="ident" id="6991038">Split</span><span class="op" id="6991043">(</span><span class="ident" id="6991044">colspec</span><span class="op" id="6991051">,</span>&nbsp;<span class="string" id="6991053">&#34;=&#34;</span><span class="op" id="6991056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991060">if</span>&nbsp;<span class="builtinfunc" id="6991063">len</span><span class="op" id="6991066">(</span><span class="ident" id="6991067">nameVal</span><span class="op" id="6991074">)</span>&nbsp;<span class="op" id="6991076">!=</span>&nbsp;<span class="num" id="6991079">2</span>&nbsp;<span class="op" id="6991081">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6991086">stmt</span><span class="op" id="6991090">.</span><span class="ident" id="6991091">Close</span><span class="op" id="6991096">(</span><span class="op" id="6991097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991102">return</span>&nbsp;<span class="ident" id="6991109">nil</span><span class="op" id="6991112">,</span>&nbsp;<span class="ident" id="6991114">errf</span><span class="op" id="6991118">(</span><span class="string" id="6991119">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="6991177">,</span>&nbsp;<span class="ident" id="6991179">stmt</span><span class="op" id="6991183">.</span><span class="ident" id="6991184">table</span><span class="op" id="6991189">,</span>&nbsp;<span class="ident" id="6991191">colspec</span><span class="op" id="6991198">,</span>&nbsp;<span class="ident" id="6991200">n</span><span class="op" id="6991201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6991205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6991209">column</span><span class="op" id="6991215">,</span>&nbsp;<span class="ident" id="6991217">value</span>&nbsp;<span class="op" id="6991223">:=</span>&nbsp;<span class="ident" id="6991226">nameVal</span><span class="op" id="6991233">[</span><span class="num" id="6991234">0</span><span class="op" id="6991235">]</span><span class="op" id="6991236">,</span>&nbsp;<span class="ident" id="6991238">nameVal</span><span class="op" id="6991245">[</span><span class="num" id="6991246">1</span><span class="op" id="6991247">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6991251">ctype</span><span class="op" id="6991256">,</span>&nbsp;<span class="ident" id="6991258">ok</span>&nbsp;<span class="op" id="6991261">:=</span>&nbsp;<span class="ident" id="6991264">c</span><span class="op" id="6991265">.</span><span class="ident" id="6991266">db</span><span class="op" id="6991268">.</span><span class="ident" id="6991269">columnType</span><span class="op" id="6991279">(</span><span class="ident" id="6991280">stmt</span><span class="op" id="6991284">.</span><span class="ident" id="6991285">table</span><span class="op" id="6991290">,</span>&nbsp;<span class="ident" id="6991292">column</span><span class="op" id="6991298">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991302">if</span>&nbsp;<span class="op" id="6991305">!</span><span class="ident" id="6991306">ok</span>&nbsp;<span class="op" id="6991309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6991314">stmt</span><span class="op" id="6991318">.</span><span class="ident" id="6991319">Close</span><span class="op" id="6991324">(</span><span class="op" id="6991325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991330">return</span>&nbsp;<span class="ident" id="6991337">nil</span><span class="op" id="6991340">,</span>&nbsp;<span class="ident" id="6991342">errf</span><span class="op" id="6991346">(</span><span class="string" id="6991347">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="6991398">,</span>&nbsp;<span class="ident" id="6991400">stmt</span><span class="op" id="6991404">.</span><span class="ident" id="6991405">table</span><span class="op" id="6991410">,</span>&nbsp;<span class="ident" id="6991412">column</span><span class="op" id="6991418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6991422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6991426">stmt</span><span class="op" id="6991430">.</span><span class="ident" id="6991431">colName</span>&nbsp;<span class="op" id="6991439">=</span>&nbsp;<span class="builtinfunc" id="6991441">append</span><span class="op" id="6991447">(</span><span class="ident" id="6991448">stmt</span><span class="op" id="6991452">.</span><span class="ident" id="6991453">colName</span><span class="op" id="6991460">,</span>&nbsp;<span class="ident" id="6991462">column</span><span class="op" id="6991468">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991473">if</span>&nbsp;<span class="ident" id="6991476">value</span>&nbsp;<span class="op" id="6991482">!=</span>&nbsp;<span class="string" id="6991485">&#34;?&#34;</span>&nbsp;<span class="op" id="6991489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991494">var</span>&nbsp;<span class="ident" id="6991498">subsetVal</span>&nbsp;<span class="keyword" id="6991508">interface</span><span class="op" id="6991517">{</span><span class="op" id="6991518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6991523">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991559">switch</span>&nbsp;<span class="ident" id="6991566">ctype</span>&nbsp;<span class="op" id="6991572">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991577">case</span>&nbsp;<span class="string" id="6991582">&#34;string&#34;</span><span class="op" id="6991590">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6991596">subsetVal</span>&nbsp;<span class="op" id="6991606">=</span>&nbsp;<span class="op" id="6991608">[</span><span class="op" id="6991609">]</span><span class="builtintype" id="6991610">byte</span><span class="op" id="6991614">(</span><span class="ident" id="6991615">value</span><span class="op" id="6991620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991625">case</span>&nbsp;<span class="string" id="6991630">&#34;blob&#34;</span><span class="op" id="6991636">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6991642">subsetVal</span>&nbsp;<span class="op" id="6991652">=</span>&nbsp;<span class="op" id="6991654">[</span><span class="op" id="6991655">]</span><span class="builtintype" id="6991656">byte</span><span class="op" id="6991660">(</span><span class="ident" id="6991661">value</span><span class="op" id="6991666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991671">case</span>&nbsp;<span class="string" id="6991676">&#34;int32&#34;</span><span class="op" id="6991683">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6991689">i</span><span class="op" id="6991690">,</span>&nbsp;<span class="ident" id="6991692">err</span>&nbsp;<span class="op" id="6991696">:=</span>&nbsp;<span class="ident" id="6991699">strconv</span><span class="op" id="6991706">.</span><span class="ident" id="6991707">Atoi</span><span class="op" id="6991711">(</span><span class="ident" id="6991712">value</span><span class="op" id="6991717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991723">if</span>&nbsp;<span class="ident" id="6991726">err</span>&nbsp;<span class="op" id="6991730">!=</span>&nbsp;<span class="ident" id="6991733">nil</span>&nbsp;<span class="op" id="6991737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6991744">stmt</span><span class="op" id="6991748">.</span><span class="ident" id="6991749">Close</span><span class="op" id="6991754">(</span><span class="op" id="6991755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991762">return</span>&nbsp;<span class="ident" id="6991769">nil</span><span class="op" id="6991772">,</span>&nbsp;<span class="ident" id="6991774">errf</span><span class="op" id="6991778">(</span><span class="string" id="6991779">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="6991816">,</span>&nbsp;<span class="ident" id="6991818">value</span><span class="op" id="6991823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6991829">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6991835">subsetVal</span>&nbsp;<span class="op" id="6991845">=</span>&nbsp;<span class="ident" id="6991847">int64</span><span class="op" id="6991852">(</span><span class="ident" id="6991853">i</span><span class="op" id="6991854">)</span>&nbsp;<span class="comment" id="6991856">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991900">default</span><span class="op" id="6991907">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6991913">stmt</span><span class="op" id="6991917">.</span><span class="ident" id="6991918">Close</span><span class="op" id="6991923">(</span><span class="op" id="6991924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6991930">return</span>&nbsp;<span class="ident" id="6991937">nil</span><span class="op" id="6991940">,</span>&nbsp;<span class="ident" id="6991942">errf</span><span class="op" id="6991946">(</span><span class="string" id="6991947">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="6992009">,</span>&nbsp;<span class="ident" id="6992011">value</span><span class="op" id="6992016">,</span>&nbsp;<span class="ident" id="6992018">ctype</span><span class="op" id="6992023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6992028">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6992033">stmt</span><span class="op" id="6992037">.</span><span class="ident" id="6992038">colValue</span>&nbsp;<span class="op" id="6992047">=</span>&nbsp;<span class="builtinfunc" id="6992049">append</span><span class="op" id="6992055">(</span><span class="ident" id="6992056">stmt</span><span class="op" id="6992060">.</span><span class="ident" id="6992061">colValue</span><span class="op" id="6992069">,</span>&nbsp;<span class="ident" id="6992071">subsetVal</span><span class="op" id="6992080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6992084">}</span>&nbsp;<span class="keyword" id="6992086">else</span>&nbsp;<span class="op" id="6992091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6992096">stmt</span><span class="op" id="6992100">.</span><span class="ident" id="6992101">placeholders</span><span class="op" id="6992113">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6992119">stmt</span><span class="op" id="6992123">.</span><span class="ident" id="6992124">placeholderConverter</span>&nbsp;<span class="op" id="6992145">=</span>&nbsp;<span class="builtinfunc" id="6992147">append</span><span class="op" id="6992153">(</span><span class="ident" id="6992154">stmt</span><span class="op" id="6992158">.</span><span class="ident" id="6992159">placeholderConverter</span><span class="op" id="6992179">,</span>&nbsp;<span class="ident" id="6992181">converterForType</span><span class="op" id="6992197">(</span><span class="ident" id="6992198">ctype</span><span class="op" id="6992203">)</span><span class="op" id="6992204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6992209">stmt</span><span class="op" id="6992213">.</span><span class="ident" id="6992214">colValue</span>&nbsp;<span class="op" id="6992223">=</span>&nbsp;<span class="builtinfunc" id="6992225">append</span><span class="op" id="6992231">(</span><span class="ident" id="6992232">stmt</span><span class="op" id="6992236">.</span><span class="ident" id="6992237">colValue</span><span class="op" id="6992245">,</span>&nbsp;<span class="string" id="6992247">&#34;?&#34;</span><span class="op" id="6992250">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6992254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6992257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992260">return</span>&nbsp;<span class="ident" id="6992267">stmt</span><span class="op" id="6992271">,</span>&nbsp;<span class="ident" id="6992273">nil</span><br>
<span class="lineno"></span><span class="op" id="6992277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="6992280">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="6992319">var</span>&nbsp;<span class="ident" id="6992323">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="6992342">func</span><span class="op" id="6992346">(</span><span class="op" id="6992347">)</span>&nbsp;<span class="builtintype" id="6992349">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6992355">func</span>&nbsp;<span class="op" id="6992360">(</span><span class="ident" id="6992361">c</span>&nbsp;<span class="op" id="6992363">*</span><span class="ident" id="6992364">fakeConn</span><span class="op" id="6992372">)</span>&nbsp;<span class="ident" id="6992374">Prepare</span><span class="op" id="6992381">(</span><span class="ident" id="6992382">query</span>&nbsp;<span class="builtintype" id="6992388">string</span><span class="op" id="6992394">)</span>&nbsp;<span class="op" id="6992396">(</span><span class="ident" id="6992397">driver</span><span class="op" id="6992403">.</span><span class="ident" id="6992404">Stmt</span><span class="op" id="6992408">,</span>&nbsp;<span class="builtintype" id="6992410">error</span><span class="op" id="6992415">)</span>&nbsp;<span class="op" id="6992417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6992420">c</span><span class="op" id="6992421">.</span><span class="ident" id="6992422">numPrepare</span><span class="op" id="6992432">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992436">if</span>&nbsp;<span class="ident" id="6992439">c</span><span class="op" id="6992440">.</span><span class="ident" id="6992441">db</span>&nbsp;<span class="op" id="6992444">==</span>&nbsp;<span class="ident" id="6992447">nil</span>&nbsp;<span class="op" id="6992451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6992455">panic</span><span class="op" id="6992460">(</span><span class="string" id="6992461">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="6992481">+</span>&nbsp;<span class="ident" id="6992483">fmt</span><span class="op" id="6992486">.</span><span class="ident" id="6992487">Sprintf</span><span class="op" id="6992494">(</span><span class="string" id="6992495">&#34;%#v&#34;</span><span class="op" id="6992500">,</span>&nbsp;<span class="ident" id="6992502">c</span><span class="op" id="6992503">)</span><span class="op" id="6992504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6992507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992511">if</span>&nbsp;<span class="ident" id="6992514">hookPrepareBadConn</span>&nbsp;<span class="op" id="6992533">!=</span>&nbsp;<span class="ident" id="6992536">nil</span>&nbsp;<span class="op" id="6992540">&amp;&amp;</span>&nbsp;<span class="ident" id="6992543">hookPrepareBadConn</span><span class="op" id="6992561">(</span><span class="op" id="6992562">)</span>&nbsp;<span class="op" id="6992564">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992568">return</span>&nbsp;<span class="ident" id="6992575">nil</span><span class="op" id="6992578">,</span>&nbsp;<span class="ident" id="6992580">driver</span><span class="op" id="6992586">.</span><span class="ident" id="6992587">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6992599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6992603">parts</span>&nbsp;<span class="op" id="6992609">:=</span>&nbsp;<span class="ident" id="6992612">strings</span><span class="op" id="6992619">.</span><span class="ident" id="6992620">Split</span><span class="op" id="6992625">(</span><span class="ident" id="6992626">query</span><span class="op" id="6992631">,</span>&nbsp;<span class="string" id="6992633">&#34;|&#34;</span><span class="op" id="6992636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992639">if</span>&nbsp;<span class="builtinfunc" id="6992642">len</span><span class="op" id="6992645">(</span><span class="ident" id="6992646">parts</span><span class="op" id="6992651">)</span>&nbsp;<span class="op" id="6992653">&lt;</span>&nbsp;<span class="num" id="6992655">1</span>&nbsp;<span class="op" id="6992657">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992661">return</span>&nbsp;<span class="ident" id="6992668">nil</span><span class="op" id="6992671">,</span>&nbsp;<span class="ident" id="6992673">errf</span><span class="op" id="6992677">(</span><span class="string" id="6992678">&#34;empty&nbsp;query&#34;</span><span class="op" id="6992691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6992694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6992697">cmd</span>&nbsp;<span class="op" id="6992701">:=</span>&nbsp;<span class="ident" id="6992704">parts</span><span class="op" id="6992709">[</span><span class="num" id="6992710">0</span><span class="op" id="6992711">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6992714">parts</span>&nbsp;<span class="op" id="6992720">=</span>&nbsp;<span class="ident" id="6992722">parts</span><span class="op" id="6992727">[</span><span class="num" id="6992728">1</span><span class="op" id="6992729">:</span><span class="op" id="6992730">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6992733">stmt</span>&nbsp;<span class="op" id="6992738">:=</span>&nbsp;<span class="op" id="6992741">&amp;</span><span class="ident" id="6992742">fakeStmt</span><span class="op" id="6992750">{</span><span class="ident" id="6992751">q</span><span class="op" id="6992752">:</span>&nbsp;<span class="ident" id="6992754">query</span><span class="op" id="6992759">,</span>&nbsp;<span class="ident" id="6992761">c</span><span class="op" id="6992762">:</span>&nbsp;<span class="ident" id="6992764">c</span><span class="op" id="6992765">,</span>&nbsp;<span class="ident" id="6992767">cmd</span><span class="op" id="6992770">:</span>&nbsp;<span class="ident" id="6992772">cmd</span><span class="op" id="6992775">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6992778">c</span><span class="op" id="6992779">.</span><span class="ident" id="6992780">incrStat</span><span class="op" id="6992788">(</span><span class="op" id="6992789">&amp;</span><span class="ident" id="6992790">c</span><span class="op" id="6992791">.</span><span class="ident" id="6992792">stmtsMade</span><span class="op" id="6992801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992804">switch</span>&nbsp;<span class="ident" id="6992811">cmd</span>&nbsp;<span class="op" id="6992815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992818">case</span>&nbsp;<span class="string" id="6992823">&#34;WIPE&#34;</span><span class="op" id="6992829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6992833">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992845">case</span>&nbsp;<span class="string" id="6992850">&#34;SELECT&#34;</span><span class="op" id="6992858">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992862">return</span>&nbsp;<span class="ident" id="6992869">c</span><span class="op" id="6992870">.</span><span class="ident" id="6992871">prepareSelect</span><span class="op" id="6992884">(</span><span class="ident" id="6992885">stmt</span><span class="op" id="6992889">,</span>&nbsp;<span class="ident" id="6992891">parts</span><span class="op" id="6992896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992899">case</span>&nbsp;<span class="string" id="6992904">&#34;CREATE&#34;</span><span class="op" id="6992912">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992916">return</span>&nbsp;<span class="ident" id="6992923">c</span><span class="op" id="6992924">.</span><span class="ident" id="6992925">prepareCreate</span><span class="op" id="6992938">(</span><span class="ident" id="6992939">stmt</span><span class="op" id="6992943">,</span>&nbsp;<span class="ident" id="6992945">parts</span><span class="op" id="6992950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992953">case</span>&nbsp;<span class="string" id="6992958">&#34;INSERT&#34;</span><span class="op" id="6992966">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6992970">return</span>&nbsp;<span class="ident" id="6992977">c</span><span class="op" id="6992978">.</span><span class="ident" id="6992979">prepareInsert</span><span class="op" id="6992992">(</span><span class="ident" id="6992993">stmt</span><span class="op" id="6992997">,</span>&nbsp;<span class="ident" id="6992999">parts</span><span class="op" id="6993004">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993007">case</span>&nbsp;<span class="string" id="6993012">&#34;NOSERT&#34;</span><span class="op" id="6993020">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6993024">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6993104">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993148">return</span>&nbsp;<span class="ident" id="6993155">c</span><span class="op" id="6993156">.</span><span class="ident" id="6993157">prepareInsert</span><span class="op" id="6993170">(</span><span class="ident" id="6993171">stmt</span><span class="op" id="6993175">,</span>&nbsp;<span class="ident" id="6993177">parts</span><span class="op" id="6993182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993185">default</span><span class="op" id="6993192">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6993196">stmt</span><span class="op" id="6993200">.</span><span class="ident" id="6993201">Close</span><span class="op" id="6993206">(</span><span class="op" id="6993207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993211">return</span>&nbsp;<span class="ident" id="6993218">nil</span><span class="op" id="6993221">,</span>&nbsp;<span class="ident" id="6993223">errf</span><span class="op" id="6993227">(</span><span class="string" id="6993228">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="6993257">,</span>&nbsp;<span class="ident" id="6993259">cmd</span><span class="op" id="6993262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6993265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993268">return</span>&nbsp;<span class="ident" id="6993275">stmt</span><span class="op" id="6993279">,</span>&nbsp;<span class="ident" id="6993281">nil</span><br>
<span class="lineno"></span><span class="op" id="6993285">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="6993288">func</span>&nbsp;<span class="op" id="6993293">(</span><span class="ident" id="6993294">s</span>&nbsp;<span class="op" id="6993296">*</span><span class="ident" id="6993297">fakeStmt</span><span class="op" id="6993305">)</span>&nbsp;<span class="ident" id="6993307">ColumnConverter</span><span class="op" id="6993322">(</span><span class="ident" id="6993323">idx</span>&nbsp;<span class="builtintype" id="6993327">int</span><span class="op" id="6993330">)</span>&nbsp;<span class="ident" id="6993332">driver</span><span class="op" id="6993338">.</span><span class="ident" id="6993339">ValueConverter</span>&nbsp;<span class="op" id="6993354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993357">if</span>&nbsp;<span class="builtinfunc" id="6993360">len</span><span class="op" id="6993363">(</span><span class="ident" id="6993364">s</span><span class="op" id="6993365">.</span><span class="ident" id="6993366">placeholderConverter</span><span class="op" id="6993386">)</span>&nbsp;<span class="op" id="6993388">==</span>&nbsp;<span class="num" id="6993391">0</span>&nbsp;<span class="op" id="6993393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993397">return</span>&nbsp;<span class="ident" id="6993404">driver</span><span class="op" id="6993410">.</span><span class="ident" id="6993411">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6993438">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993441">return</span>&nbsp;<span class="ident" id="6993448">s</span><span class="op" id="6993449">.</span><span class="ident" id="6993450">placeholderConverter</span><span class="op" id="6993470">[</span><span class="ident" id="6993471">idx</span><span class="op" id="6993474">]</span><br>
<span class="lineno"></span><span class="op" id="6993476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6993479">func</span>&nbsp;<span class="op" id="6993484">(</span><span class="ident" id="6993485">s</span>&nbsp;<span class="op" id="6993487">*</span><span class="ident" id="6993488">fakeStmt</span><span class="op" id="6993496">)</span>&nbsp;<span class="ident" id="6993498">Close</span><span class="op" id="6993503">(</span><span class="op" id="6993504">)</span>&nbsp;<span class="builtintype" id="6993506">error</span>&nbsp;<span class="op" id="6993512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993515">if</span>&nbsp;<span class="ident" id="6993518">s</span><span class="op" id="6993519">.</span><span class="ident" id="6993520">c</span>&nbsp;<span class="op" id="6993522">==</span>&nbsp;<span class="ident" id="6993525">nil</span>&nbsp;<span class="op" id="6993529">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6993533">panic</span><span class="op" id="6993538">(</span><span class="string" id="6993539">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="6993567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6993570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993573">if</span>&nbsp;<span class="ident" id="6993576">s</span><span class="op" id="6993577">.</span><span class="ident" id="6993578">c</span><span class="op" id="6993579">.</span><span class="ident" id="6993580">db</span>&nbsp;<span class="op" id="6993583">==</span>&nbsp;<span class="ident" id="6993586">nil</span>&nbsp;<span class="op" id="6993590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6993594">panic</span><span class="op" id="6993599">(</span><span class="string" id="6993600">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="6993654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6993657">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993660">if</span>&nbsp;<span class="op" id="6993663">!</span><span class="ident" id="6993664">s</span><span class="op" id="6993665">.</span><span class="ident" id="6993666">closed</span>&nbsp;<span class="op" id="6993673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6993677">s</span><span class="op" id="6993678">.</span><span class="ident" id="6993679">c</span><span class="op" id="6993680">.</span><span class="ident" id="6993681">incrStat</span><span class="op" id="6993689">(</span><span class="op" id="6993690">&amp;</span><span class="ident" id="6993691">s</span><span class="op" id="6993692">.</span><span class="ident" id="6993693">c</span><span class="op" id="6993694">.</span><span class="ident" id="6993695">stmtsClosed</span><span class="op" id="6993706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6993710">s</span><span class="op" id="6993711">.</span><span class="ident" id="6993712">closed</span>&nbsp;<span class="op" id="6993719">=</span>&nbsp;<span class="builtintype" id="6993721">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6993727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993730">return</span>&nbsp;<span class="ident" id="6993737">nil</span><br>
<span class="lineno">520</span><span class="op" id="6993741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6993744">var</span>&nbsp;<span class="ident" id="6993748">errClosed</span>&nbsp;<span class="op" id="6993758">=</span>&nbsp;<span class="ident" id="6993760">errors</span><span class="op" id="6993766">.</span><span class="ident" id="6993767">New</span><span class="op" id="6993770">(</span><span class="string" id="6993771">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="6993806">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6993809">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="6993848">var</span>&nbsp;<span class="ident" id="6993852">hookExecBadConn</span>&nbsp;<span class="keyword" id="6993868">func</span><span class="op" id="6993872">(</span><span class="op" id="6993873">)</span>&nbsp;<span class="builtintype" id="6993875">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6993881">func</span>&nbsp;<span class="op" id="6993886">(</span><span class="ident" id="6993887">s</span>&nbsp;<span class="op" id="6993889">*</span><span class="ident" id="6993890">fakeStmt</span><span class="op" id="6993898">)</span>&nbsp;<span class="ident" id="6993900">Exec</span><span class="op" id="6993904">(</span><span class="ident" id="6993905">args</span>&nbsp;<span class="op" id="6993910">[</span><span class="op" id="6993911">]</span><span class="ident" id="6993912">driver</span><span class="op" id="6993918">.</span><span class="ident" id="6993919">Value</span><span class="op" id="6993924">)</span>&nbsp;<span class="op" id="6993926">(</span><span class="ident" id="6993927">driver</span><span class="op" id="6993933">.</span><span class="ident" id="6993934">Result</span><span class="op" id="6993940">,</span>&nbsp;<span class="builtintype" id="6993942">error</span><span class="op" id="6993947">)</span>&nbsp;<span class="op" id="6993949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993952">if</span>&nbsp;<span class="ident" id="6993955">s</span><span class="op" id="6993956">.</span><span class="ident" id="6993957">closed</span>&nbsp;<span class="op" id="6993964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993968">return</span>&nbsp;<span class="ident" id="6993975">nil</span><span class="op" id="6993978">,</span>&nbsp;<span class="ident" id="6993980">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6993991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6993995">if</span>&nbsp;<span class="ident" id="6993998">hookExecBadConn</span>&nbsp;<span class="op" id="6994014">!=</span>&nbsp;<span class="ident" id="6994017">nil</span>&nbsp;<span class="op" id="6994021">&amp;&amp;</span>&nbsp;<span class="ident" id="6994024">hookExecBadConn</span><span class="op" id="6994039">(</span><span class="op" id="6994040">)</span>&nbsp;<span class="op" id="6994042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994046">return</span>&nbsp;<span class="ident" id="6994053">nil</span><span class="op" id="6994056">,</span>&nbsp;<span class="ident" id="6994058">driver</span><span class="op" id="6994064">.</span><span class="ident" id="6994065">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6994077">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6994081">err</span>&nbsp;<span class="op" id="6994085">:=</span>&nbsp;<span class="ident" id="6994088">checkSubsetTypes</span><span class="op" id="6994104">(</span><span class="ident" id="6994105">args</span><span class="op" id="6994109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994112">if</span>&nbsp;<span class="ident" id="6994115">err</span>&nbsp;<span class="op" id="6994119">!=</span>&nbsp;<span class="ident" id="6994122">nil</span>&nbsp;<span class="op" id="6994126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994130">return</span>&nbsp;<span class="ident" id="6994137">nil</span><span class="op" id="6994140">,</span>&nbsp;<span class="ident" id="6994142">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6994147">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6994151">db</span>&nbsp;<span class="op" id="6994154">:=</span>&nbsp;<span class="ident" id="6994157">s</span><span class="op" id="6994158">.</span><span class="ident" id="6994159">c</span><span class="op" id="6994160">.</span><span class="ident" id="6994161">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994165">switch</span>&nbsp;<span class="ident" id="6994172">s</span><span class="op" id="6994173">.</span><span class="ident" id="6994174">cmd</span>&nbsp;<span class="op" id="6994178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994181">case</span>&nbsp;<span class="string" id="6994186">&#34;WIPE&#34;</span><span class="op" id="6994192">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6994196">db</span><span class="op" id="6994198">.</span><span class="ident" id="6994199">wipe</span><span class="op" id="6994203">(</span><span class="op" id="6994204">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994208">return</span>&nbsp;<span class="ident" id="6994215">driver</span><span class="op" id="6994221">.</span><span class="ident" id="6994222">ResultNoRows</span><span class="op" id="6994234">,</span>&nbsp;<span class="ident" id="6994236">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994241">case</span>&nbsp;<span class="string" id="6994246">&#34;CREATE&#34;</span><span class="op" id="6994254">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994258">if</span>&nbsp;<span class="ident" id="6994261">err</span>&nbsp;<span class="op" id="6994265">:=</span>&nbsp;<span class="ident" id="6994268">db</span><span class="op" id="6994270">.</span><span class="ident" id="6994271">createTable</span><span class="op" id="6994282">(</span><span class="ident" id="6994283">s</span><span class="op" id="6994284">.</span><span class="ident" id="6994285">table</span><span class="op" id="6994290">,</span>&nbsp;<span class="ident" id="6994292">s</span><span class="op" id="6994293">.</span><span class="ident" id="6994294">colName</span><span class="op" id="6994301">,</span>&nbsp;<span class="ident" id="6994303">s</span><span class="op" id="6994304">.</span><span class="ident" id="6994305">colType</span><span class="op" id="6994312">)</span><span class="op" id="6994313">;</span>&nbsp;<span class="ident" id="6994315">err</span>&nbsp;<span class="op" id="6994319">!=</span>&nbsp;<span class="ident" id="6994322">nil</span>&nbsp;<span class="op" id="6994326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994331">return</span>&nbsp;<span class="ident" id="6994338">nil</span><span class="op" id="6994341">,</span>&nbsp;<span class="ident" id="6994343">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6994349">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994353">return</span>&nbsp;<span class="ident" id="6994360">driver</span><span class="op" id="6994366">.</span><span class="ident" id="6994367">ResultNoRows</span><span class="op" id="6994379">,</span>&nbsp;<span class="ident" id="6994381">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994386">case</span>&nbsp;<span class="string" id="6994391">&#34;INSERT&#34;</span><span class="op" id="6994399">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994403">return</span>&nbsp;<span class="ident" id="6994410">s</span><span class="op" id="6994411">.</span><span class="ident" id="6994412">execInsert</span><span class="op" id="6994422">(</span><span class="ident" id="6994423">args</span><span class="op" id="6994427">,</span>&nbsp;<span class="builtintype" id="6994429">true</span><span class="op" id="6994433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994436">case</span>&nbsp;<span class="string" id="6994441">&#34;NOSERT&#34;</span><span class="op" id="6994449">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6994453">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6994533">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994577">return</span>&nbsp;<span class="ident" id="6994584">s</span><span class="op" id="6994585">.</span><span class="ident" id="6994586">execInsert</span><span class="op" id="6994596">(</span><span class="ident" id="6994597">args</span><span class="op" id="6994601">,</span>&nbsp;<span class="builtintype" id="6994603">false</span><span class="op" id="6994608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6994611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6994614">fmt</span><span class="op" id="6994617">.</span><span class="ident" id="6994618">Printf</span><span class="op" id="6994624">(</span><span class="string" id="6994625">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="6994656">,</span>&nbsp;<span class="ident" id="6994658">s</span><span class="op" id="6994659">.</span><span class="ident" id="6994660">cmd</span><span class="op" id="6994663">,</span>&nbsp;<span class="ident" id="6994665">s</span><span class="op" id="6994666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6994669">return</span>&nbsp;<span class="ident" id="6994676">nil</span><span class="op" id="6994679">,</span>&nbsp;<span class="ident" id="6994681">fmt</span><span class="op" id="6994684">.</span><span class="ident" id="6994685">Errorf</span><span class="op" id="6994691">(</span><span class="string" id="6994692">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="6994741">,</span>&nbsp;<span class="ident" id="6994743">s</span><span class="op" id="6994744">.</span><span class="ident" id="6994745">cmd</span><span class="op" id="6994748">)</span><br>
<span class="lineno">560</span><span class="op" id="6994750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6994753">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="6994805">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="6994874">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="6994912">func</span>&nbsp;<span class="op" id="6994917">(</span><span class="ident" id="6994918">s</span>&nbsp;<span class="op" id="6994920">*</span><span class="ident" id="6994921">fakeStmt</span><span class="op" id="6994929">)</span>&nbsp;<span class="ident" id="6994931">execInsert</span><span class="op" id="6994941">(</span><span class="ident" id="6994942">args</span>&nbsp;<span class="op" id="6994947">[</span><span class="op" id="6994948">]</span><span class="ident" id="6994949">driver</span><span class="op" id="6994955">.</span><span class="ident" id="6994956">Value</span><span class="op" id="6994961">,</span>&nbsp;<span class="ident" id="6994963">doInsert</span>&nbsp;<span class="builtintype" id="6994972">bool</span><span class="op" id="6994976">)</span>&nbsp;<span class="op" id="6994978">(</span><span class="ident" id="6994979">driver</span><span class="op" id="6994985">.</span><span class="ident" id="6994986">Result</span><span class="op" id="6994992">,</span>&nbsp;<span class="builtintype" id="6994994">error</span><span class="op" id="6994999">)</span>&nbsp;<span class="op" id="6995001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995004">db</span>&nbsp;<span class="op" id="6995007">:=</span>&nbsp;<span class="ident" id="6995010">s</span><span class="op" id="6995011">.</span><span class="ident" id="6995012">c</span><span class="op" id="6995013">.</span><span class="ident" id="6995014">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995018">if</span>&nbsp;<span class="builtinfunc" id="6995021">len</span><span class="op" id="6995024">(</span><span class="ident" id="6995025">args</span><span class="op" id="6995029">)</span>&nbsp;<span class="op" id="6995031">!=</span>&nbsp;<span class="ident" id="6995034">s</span><span class="op" id="6995035">.</span><span class="ident" id="6995036">placeholders</span>&nbsp;<span class="op" id="6995049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6995053">panic</span><span class="op" id="6995058">(</span><span class="string" id="6995059">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="6995117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6995120">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995123">db</span><span class="op" id="6995125">.</span><span class="ident" id="6995126">mu</span><span class="op" id="6995128">.</span><span class="ident" id="6995129">Lock</span><span class="op" id="6995133">(</span><span class="op" id="6995134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995137">t</span><span class="op" id="6995138">,</span>&nbsp;<span class="ident" id="6995140">ok</span>&nbsp;<span class="op" id="6995143">:=</span>&nbsp;<span class="ident" id="6995146">db</span><span class="op" id="6995148">.</span><span class="ident" id="6995149">table</span><span class="op" id="6995154">(</span><span class="ident" id="6995155">s</span><span class="op" id="6995156">.</span><span class="ident" id="6995157">table</span><span class="op" id="6995162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995165">db</span><span class="op" id="6995167">.</span><span class="ident" id="6995168">mu</span><span class="op" id="6995170">.</span><span class="ident" id="6995171">Unlock</span><span class="op" id="6995177">(</span><span class="op" id="6995178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995181">if</span>&nbsp;<span class="op" id="6995184">!</span><span class="ident" id="6995185">ok</span>&nbsp;<span class="op" id="6995188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995192">return</span>&nbsp;<span class="ident" id="6995199">nil</span><span class="op" id="6995202">,</span>&nbsp;<span class="ident" id="6995204">fmt</span><span class="op" id="6995207">.</span><span class="ident" id="6995208">Errorf</span><span class="op" id="6995214">(</span><span class="string" id="6995215">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="6995247">,</span>&nbsp;<span class="ident" id="6995249">s</span><span class="op" id="6995250">.</span><span class="ident" id="6995251">table</span><span class="op" id="6995256">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6995259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995263">t</span><span class="op" id="6995264">.</span><span class="ident" id="6995265">mu</span><span class="op" id="6995267">.</span><span class="ident" id="6995268">Lock</span><span class="op" id="6995272">(</span><span class="op" id="6995273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995276">defer</span>&nbsp;<span class="ident" id="6995282">t</span><span class="op" id="6995283">.</span><span class="ident" id="6995284">mu</span><span class="op" id="6995286">.</span><span class="ident" id="6995287">Unlock</span><span class="op" id="6995293">(</span><span class="op" id="6995294">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995298">var</span>&nbsp;<span class="ident" id="6995302">cols</span>&nbsp;<span class="op" id="6995307">[</span><span class="op" id="6995308">]</span><span class="keyword" id="6995309">interface</span><span class="op" id="6995318">{</span><span class="op" id="6995319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995322">if</span>&nbsp;<span class="ident" id="6995325">doInsert</span>&nbsp;<span class="op" id="6995334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995338">cols</span>&nbsp;<span class="op" id="6995343">=</span>&nbsp;<span class="builtinfunc" id="6995345">make</span><span class="op" id="6995349">(</span><span class="op" id="6995350">[</span><span class="op" id="6995351">]</span><span class="keyword" id="6995352">interface</span><span class="op" id="6995361">{</span><span class="op" id="6995362">}</span><span class="op" id="6995363">,</span>&nbsp;<span class="builtinfunc" id="6995365">len</span><span class="op" id="6995368">(</span><span class="ident" id="6995369">t</span><span class="op" id="6995370">.</span><span class="ident" id="6995371">colname</span><span class="op" id="6995378">)</span><span class="op" id="6995379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6995382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995385">argPos</span>&nbsp;<span class="op" id="6995392">:=</span>&nbsp;<span class="num" id="6995395">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995398">for</span>&nbsp;<span class="ident" id="6995402">n</span><span class="op" id="6995403">,</span>&nbsp;<span class="ident" id="6995405">colname</span>&nbsp;<span class="op" id="6995413">:=</span>&nbsp;<span class="keyword" id="6995416">range</span>&nbsp;<span class="ident" id="6995422">s</span><span class="op" id="6995423">.</span><span class="ident" id="6995424">colName</span>&nbsp;<span class="op" id="6995432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995436">colidx</span>&nbsp;<span class="op" id="6995443">:=</span>&nbsp;<span class="ident" id="6995446">t</span><span class="op" id="6995447">.</span><span class="ident" id="6995448">columnIndex</span><span class="op" id="6995459">(</span><span class="ident" id="6995460">colname</span><span class="op" id="6995467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995471">if</span>&nbsp;<span class="ident" id="6995474">colidx</span>&nbsp;<span class="op" id="6995481">==</span>&nbsp;<span class="op" id="6995484">-</span><span class="num" id="6995485">1</span>&nbsp;<span class="op" id="6995487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995492">return</span>&nbsp;<span class="ident" id="6995499">nil</span><span class="op" id="6995502">,</span>&nbsp;<span class="ident" id="6995504">fmt</span><span class="op" id="6995507">.</span><span class="ident" id="6995508">Errorf</span><span class="op" id="6995514">(</span><span class="string" id="6995515">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="6995596">,</span>&nbsp;<span class="ident" id="6995598">colname</span><span class="op" id="6995605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6995609">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995613">var</span>&nbsp;<span class="ident" id="6995617">val</span>&nbsp;<span class="keyword" id="6995621">interface</span><span class="op" id="6995630">{</span><span class="op" id="6995631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995635">if</span>&nbsp;<span class="ident" id="6995638">strvalue</span><span class="op" id="6995646">,</span>&nbsp;<span class="ident" id="6995648">ok</span>&nbsp;<span class="op" id="6995651">:=</span>&nbsp;<span class="ident" id="6995654">s</span><span class="op" id="6995655">.</span><span class="ident" id="6995656">colValue</span><span class="op" id="6995664">[</span><span class="ident" id="6995665">n</span><span class="op" id="6995666">]</span><span class="op" id="6995667">.</span><span class="op" id="6995668">(</span><span class="builtintype" id="6995669">string</span><span class="op" id="6995675">)</span><span class="op" id="6995676">;</span>&nbsp;<span class="ident" id="6995678">ok</span>&nbsp;<span class="op" id="6995681">&amp;&amp;</span>&nbsp;<span class="ident" id="6995684">strvalue</span>&nbsp;<span class="op" id="6995693">==</span>&nbsp;<span class="string" id="6995696">&#34;?&#34;</span>&nbsp;<span class="op" id="6995700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995705">val</span>&nbsp;<span class="op" id="6995709">=</span>&nbsp;<span class="ident" id="6995711">args</span><span class="op" id="6995715">[</span><span class="ident" id="6995716">argPos</span><span class="op" id="6995722">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995727">argPos</span><span class="op" id="6995733">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6995738">}</span>&nbsp;<span class="keyword" id="6995740">else</span>&nbsp;<span class="op" id="6995745">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995750">val</span>&nbsp;<span class="op" id="6995754">=</span>&nbsp;<span class="ident" id="6995756">s</span><span class="op" id="6995757">.</span><span class="ident" id="6995758">colValue</span><span class="op" id="6995766">[</span><span class="ident" id="6995767">n</span><span class="op" id="6995768">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6995772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995776">if</span>&nbsp;<span class="ident" id="6995779">doInsert</span>&nbsp;<span class="op" id="6995788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995793">cols</span><span class="op" id="6995797">[</span><span class="ident" id="6995798">colidx</span><span class="op" id="6995804">]</span>&nbsp;<span class="op" id="6995806">=</span>&nbsp;<span class="ident" id="6995808">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6995814">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6995817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995821">if</span>&nbsp;<span class="ident" id="6995824">doInsert</span>&nbsp;<span class="op" id="6995833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6995837">t</span><span class="op" id="6995838">.</span><span class="ident" id="6995839">rows</span>&nbsp;<span class="op" id="6995844">=</span>&nbsp;<span class="builtinfunc" id="6995846">append</span><span class="op" id="6995852">(</span><span class="ident" id="6995853">t</span><span class="op" id="6995854">.</span><span class="ident" id="6995855">rows</span><span class="op" id="6995859">,</span>&nbsp;<span class="op" id="6995861">&amp;</span><span class="ident" id="6995862">row</span><span class="op" id="6995865">{</span><span class="ident" id="6995866">cols</span><span class="op" id="6995870">:</span>&nbsp;<span class="ident" id="6995872">cols</span><span class="op" id="6995876">}</span><span class="op" id="6995877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6995880">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6995883">return</span>&nbsp;<span class="ident" id="6995890">driver</span><span class="op" id="6995896">.</span><span class="ident" id="6995897">RowsAffected</span><span class="op" id="6995909">(</span><span class="num" id="6995910">1</span><span class="op" id="6995911">)</span><span class="op" id="6995912">,</span>&nbsp;<span class="ident" id="6995914">nil</span><br>
<span class="lineno"></span><span class="op" id="6995918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6995921">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="6995960">var</span>&nbsp;<span class="ident" id="6995964">hookQueryBadConn</span>&nbsp;<span class="keyword" id="6995981">func</span><span class="op" id="6995985">(</span><span class="op" id="6995986">)</span>&nbsp;<span class="builtintype" id="6995988">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="6995994">func</span>&nbsp;<span class="op" id="6995999">(</span><span class="ident" id="6996000">s</span>&nbsp;<span class="op" id="6996002">*</span><span class="ident" id="6996003">fakeStmt</span><span class="op" id="6996011">)</span>&nbsp;<span class="ident" id="6996013">Query</span><span class="op" id="6996018">(</span><span class="ident" id="6996019">args</span>&nbsp;<span class="op" id="6996024">[</span><span class="op" id="6996025">]</span><span class="ident" id="6996026">driver</span><span class="op" id="6996032">.</span><span class="ident" id="6996033">Value</span><span class="op" id="6996038">)</span>&nbsp;<span class="op" id="6996040">(</span><span class="ident" id="6996041">driver</span><span class="op" id="6996047">.</span><span class="ident" id="6996048">Rows</span><span class="op" id="6996052">,</span>&nbsp;<span class="builtintype" id="6996054">error</span><span class="op" id="6996059">)</span>&nbsp;<span class="op" id="6996061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996064">if</span>&nbsp;<span class="ident" id="6996067">s</span><span class="op" id="6996068">.</span><span class="ident" id="6996069">closed</span>&nbsp;<span class="op" id="6996076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996080">return</span>&nbsp;<span class="ident" id="6996087">nil</span><span class="op" id="6996090">,</span>&nbsp;<span class="ident" id="6996092">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996103">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996107">if</span>&nbsp;<span class="ident" id="6996110">hookQueryBadConn</span>&nbsp;<span class="op" id="6996127">!=</span>&nbsp;<span class="ident" id="6996130">nil</span>&nbsp;<span class="op" id="6996134">&amp;&amp;</span>&nbsp;<span class="ident" id="6996137">hookQueryBadConn</span><span class="op" id="6996153">(</span><span class="op" id="6996154">)</span>&nbsp;<span class="op" id="6996156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996160">return</span>&nbsp;<span class="ident" id="6996167">nil</span><span class="op" id="6996170">,</span>&nbsp;<span class="ident" id="6996172">driver</span><span class="op" id="6996178">.</span><span class="ident" id="6996179">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996195">err</span>&nbsp;<span class="op" id="6996199">:=</span>&nbsp;<span class="ident" id="6996202">checkSubsetTypes</span><span class="op" id="6996218">(</span><span class="ident" id="6996219">args</span><span class="op" id="6996223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996226">if</span>&nbsp;<span class="ident" id="6996229">err</span>&nbsp;<span class="op" id="6996233">!=</span>&nbsp;<span class="ident" id="6996236">nil</span>&nbsp;<span class="op" id="6996240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996244">return</span>&nbsp;<span class="ident" id="6996251">nil</span><span class="op" id="6996254">,</span>&nbsp;<span class="ident" id="6996256">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996265">db</span>&nbsp;<span class="op" id="6996268">:=</span>&nbsp;<span class="ident" id="6996271">s</span><span class="op" id="6996272">.</span><span class="ident" id="6996273">c</span><span class="op" id="6996274">.</span><span class="ident" id="6996275">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996279">if</span>&nbsp;<span class="builtinfunc" id="6996282">len</span><span class="op" id="6996285">(</span><span class="ident" id="6996286">args</span><span class="op" id="6996290">)</span>&nbsp;<span class="op" id="6996292">!=</span>&nbsp;<span class="ident" id="6996295">s</span><span class="op" id="6996296">.</span><span class="ident" id="6996297">placeholders</span>&nbsp;<span class="op" id="6996310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6996314">panic</span><span class="op" id="6996319">(</span><span class="string" id="6996320">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="6996378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996385">db</span><span class="op" id="6996387">.</span><span class="ident" id="6996388">mu</span><span class="op" id="6996390">.</span><span class="ident" id="6996391">Lock</span><span class="op" id="6996395">(</span><span class="op" id="6996396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996399">t</span><span class="op" id="6996400">,</span>&nbsp;<span class="ident" id="6996402">ok</span>&nbsp;<span class="op" id="6996405">:=</span>&nbsp;<span class="ident" id="6996408">db</span><span class="op" id="6996410">.</span><span class="ident" id="6996411">table</span><span class="op" id="6996416">(</span><span class="ident" id="6996417">s</span><span class="op" id="6996418">.</span><span class="ident" id="6996419">table</span><span class="op" id="6996424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996427">db</span><span class="op" id="6996429">.</span><span class="ident" id="6996430">mu</span><span class="op" id="6996432">.</span><span class="ident" id="6996433">Unlock</span><span class="op" id="6996439">(</span><span class="op" id="6996440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996443">if</span>&nbsp;<span class="op" id="6996446">!</span><span class="ident" id="6996447">ok</span>&nbsp;<span class="op" id="6996450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996454">return</span>&nbsp;<span class="ident" id="6996461">nil</span><span class="op" id="6996464">,</span>&nbsp;<span class="ident" id="6996466">fmt</span><span class="op" id="6996469">.</span><span class="ident" id="6996470">Errorf</span><span class="op" id="6996476">(</span><span class="string" id="6996477">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="6996509">,</span>&nbsp;<span class="ident" id="6996511">s</span><span class="op" id="6996512">.</span><span class="ident" id="6996513">table</span><span class="op" id="6996518">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996525">if</span>&nbsp;<span class="ident" id="6996528">s</span><span class="op" id="6996529">.</span><span class="ident" id="6996530">table</span>&nbsp;<span class="op" id="6996536">==</span>&nbsp;<span class="string" id="6996539">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="6996552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996556">if</span>&nbsp;<span class="builtinfunc" id="6996559">len</span><span class="op" id="6996562">(</span><span class="ident" id="6996563">s</span><span class="op" id="6996564">.</span><span class="ident" id="6996565">whereCol</span><span class="op" id="6996573">)</span>&nbsp;<span class="op" id="6996575">==</span>&nbsp;<span class="num" id="6996578">2</span>&nbsp;<span class="op" id="6996580">&amp;&amp;</span>&nbsp;<span class="ident" id="6996583">s</span><span class="op" id="6996584">.</span><span class="ident" id="6996585">whereCol</span><span class="op" id="6996593">[</span><span class="num" id="6996594">0</span><span class="op" id="6996595">]</span>&nbsp;<span class="op" id="6996597">==</span>&nbsp;<span class="string" id="6996600">&#34;op&#34;</span>&nbsp;<span class="op" id="6996605">&amp;&amp;</span>&nbsp;<span class="ident" id="6996608">s</span><span class="op" id="6996609">.</span><span class="ident" id="6996610">whereCol</span><span class="op" id="6996618">[</span><span class="num" id="6996619">1</span><span class="op" id="6996620">]</span>&nbsp;<span class="op" id="6996622">==</span>&nbsp;<span class="string" id="6996625">&#34;millis&#34;</span>&nbsp;<span class="op" id="6996634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996639">if</span>&nbsp;<span class="ident" id="6996642">args</span><span class="op" id="6996646">[</span><span class="num" id="6996647">0</span><span class="op" id="6996648">]</span>&nbsp;<span class="op" id="6996650">==</span>&nbsp;<span class="string" id="6996653">&#34;sleep&#34;</span>&nbsp;<span class="op" id="6996661">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996667">time</span><span class="op" id="6996671">.</span><span class="ident" id="6996672">Sleep</span><span class="op" id="6996677">(</span><span class="ident" id="6996678">time</span><span class="op" id="6996682">.</span><span class="ident" id="6996683">Duration</span><span class="op" id="6996691">(</span><span class="ident" id="6996692">args</span><span class="op" id="6996696">[</span><span class="num" id="6996697">1</span><span class="op" id="6996698">]</span><span class="op" id="6996699">.</span><span class="op" id="6996700">(</span><span class="ident" id="6996701">int64</span><span class="op" id="6996706">)</span><span class="op" id="6996707">)</span>&nbsp;<span class="op" id="6996709">*</span>&nbsp;<span class="ident" id="6996711">time</span><span class="op" id="6996715">.</span><span class="ident" id="6996716">Millisecond</span><span class="op" id="6996727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6996739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996743">t</span><span class="op" id="6996744">.</span><span class="ident" id="6996745">mu</span><span class="op" id="6996747">.</span><span class="ident" id="6996748">Lock</span><span class="op" id="6996752">(</span><span class="op" id="6996753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996756">defer</span>&nbsp;<span class="ident" id="6996762">t</span><span class="op" id="6996763">.</span><span class="ident" id="6996764">mu</span><span class="op" id="6996766">.</span><span class="ident" id="6996767">Unlock</span><span class="op" id="6996773">(</span><span class="op" id="6996774">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996778">colIdx</span>&nbsp;<span class="op" id="6996785">:=</span>&nbsp;<span class="builtinfunc" id="6996788">make</span><span class="op" id="6996792">(</span><span class="keyword" id="6996793">map</span><span class="op" id="6996796">[</span><span class="builtintype" id="6996797">string</span><span class="op" id="6996803">]</span><span class="builtintype" id="6996804">int</span><span class="op" id="6996807">)</span>&nbsp;<span class="comment" id="6996809">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996857">for</span>&nbsp;<span class="ident" id="6996861">_</span><span class="op" id="6996862">,</span>&nbsp;<span class="ident" id="6996864">name</span>&nbsp;<span class="op" id="6996869">:=</span>&nbsp;<span class="keyword" id="6996872">range</span>&nbsp;<span class="ident" id="6996878">s</span><span class="op" id="6996879">.</span><span class="ident" id="6996880">colName</span>&nbsp;<span class="op" id="6996888">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6996892">idx</span>&nbsp;<span class="op" id="6996896">:=</span>&nbsp;<span class="ident" id="6996899">t</span><span class="op" id="6996900">.</span><span class="ident" id="6996901">columnIndex</span><span class="op" id="6996912">(</span><span class="ident" id="6996913">name</span><span class="op" id="6996917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996921">if</span>&nbsp;<span class="ident" id="6996924">idx</span>&nbsp;<span class="op" id="6996928">==</span>&nbsp;<span class="op" id="6996931">-</span><span class="num" id="6996932">1</span>&nbsp;<span class="op" id="6996934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6996939">return</span>&nbsp;<span class="ident" id="6996946">nil</span><span class="op" id="6996949">,</span>&nbsp;<span class="ident" id="6996951">fmt</span><span class="op" id="6996954">.</span><span class="ident" id="6996955">Errorf</span><span class="op" id="6996961">(</span><span class="string" id="6996962">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="6996994">,</span>&nbsp;<span class="ident" id="6996996">name</span><span class="op" id="6997000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6997004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997008">colIdx</span><span class="op" id="6997014">[</span><span class="ident" id="6997015">name</span><span class="op" id="6997019">]</span>&nbsp;<span class="op" id="6997021">=</span>&nbsp;<span class="ident" id="6997023">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6997028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997032">mrows</span>&nbsp;<span class="op" id="6997038">:=</span>&nbsp;<span class="op" id="6997041">[</span><span class="op" id="6997042">]</span><span class="op" id="6997043">*</span><span class="ident" id="6997044">row</span><span class="op" id="6997047">{</span><span class="op" id="6997048">}</span><br>
<span class="lineno"></span><span class="ident" id="6997050">rows</span><span class="op" id="6997054">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997057">for</span>&nbsp;<span class="ident" id="6997061">_</span><span class="op" id="6997062">,</span>&nbsp;<span class="ident" id="6997064">trow</span>&nbsp;<span class="op" id="6997069">:=</span>&nbsp;<span class="keyword" id="6997072">range</span>&nbsp;<span class="ident" id="6997078">t</span><span class="op" id="6997079">.</span><span class="ident" id="6997080">rows</span>&nbsp;<span class="op" id="6997085">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6997089">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6997158">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6997226">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997246">for</span>&nbsp;<span class="ident" id="6997250">widx</span><span class="op" id="6997254">,</span>&nbsp;<span class="ident" id="6997256">wcol</span>&nbsp;<span class="op" id="6997261">:=</span>&nbsp;<span class="keyword" id="6997264">range</span>&nbsp;<span class="ident" id="6997270">s</span><span class="op" id="6997271">.</span><span class="ident" id="6997272">whereCol</span>&nbsp;<span class="op" id="6997281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997286">idx</span>&nbsp;<span class="op" id="6997290">:=</span>&nbsp;<span class="ident" id="6997293">t</span><span class="op" id="6997294">.</span><span class="ident" id="6997295">columnIndex</span><span class="op" id="6997306">(</span><span class="ident" id="6997307">wcol</span><span class="op" id="6997311">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997316">if</span>&nbsp;<span class="ident" id="6997319">idx</span>&nbsp;<span class="op" id="6997323">==</span>&nbsp;<span class="op" id="6997326">-</span><span class="num" id="6997327">1</span>&nbsp;<span class="op" id="6997329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997335">return</span>&nbsp;<span class="ident" id="6997342">nil</span><span class="op" id="6997345">,</span>&nbsp;<span class="ident" id="6997347">fmt</span><span class="op" id="6997350">.</span><span class="ident" id="6997351">Errorf</span><span class="op" id="6997357">(</span><span class="string" id="6997358">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="6997394">,</span>&nbsp;<span class="ident" id="6997396">wcol</span><span class="op" id="6997400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6997405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997410">tcol</span>&nbsp;<span class="op" id="6997415">:=</span>&nbsp;<span class="ident" id="6997418">trow</span><span class="op" id="6997422">.</span><span class="ident" id="6997423">cols</span><span class="op" id="6997427">[</span><span class="ident" id="6997428">idx</span><span class="op" id="6997431">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997436">if</span>&nbsp;<span class="ident" id="6997439">bs</span><span class="op" id="6997441">,</span>&nbsp;<span class="ident" id="6997443">ok</span>&nbsp;<span class="op" id="6997446">:=</span>&nbsp;<span class="ident" id="6997449">tcol</span><span class="op" id="6997453">.</span><span class="op" id="6997454">(</span><span class="op" id="6997455">[</span><span class="op" id="6997456">]</span><span class="builtintype" id="6997457">byte</span><span class="op" id="6997461">)</span><span class="op" id="6997462">;</span>&nbsp;<span class="ident" id="6997464">ok</span>&nbsp;<span class="op" id="6997467">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6997473">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997522">tcol</span>&nbsp;<span class="op" id="6997527">=</span>&nbsp;<span class="builtintype" id="6997529">string</span><span class="op" id="6997535">(</span><span class="ident" id="6997536">bs</span><span class="op" id="6997538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6997543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997548">if</span>&nbsp;<span class="ident" id="6997551">fmt</span><span class="op" id="6997554">.</span><span class="ident" id="6997555">Sprintf</span><span class="op" id="6997562">(</span><span class="string" id="6997563">&#34;%v&#34;</span><span class="op" id="6997567">,</span>&nbsp;<span class="ident" id="6997569">tcol</span><span class="op" id="6997573">)</span>&nbsp;<span class="op" id="6997575">!=</span>&nbsp;<span class="ident" id="6997578">fmt</span><span class="op" id="6997581">.</span><span class="ident" id="6997582">Sprintf</span><span class="op" id="6997589">(</span><span class="string" id="6997590">&#34;%v&#34;</span><span class="op" id="6997594">,</span>&nbsp;<span class="ident" id="6997596">args</span><span class="op" id="6997600">[</span><span class="ident" id="6997601">widx</span><span class="op" id="6997605">]</span><span class="op" id="6997606">)</span>&nbsp;<span class="op" id="6997608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997614">continue</span>&nbsp;<span class="ident" id="6997623">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6997631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6997635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997639">mrow</span>&nbsp;<span class="op" id="6997644">:=</span>&nbsp;<span class="op" id="6997647">&amp;</span><span class="ident" id="6997648">row</span><span class="op" id="6997651">{</span><span class="ident" id="6997652">cols</span><span class="op" id="6997656">:</span>&nbsp;<span class="builtinfunc" id="6997658">make</span><span class="op" id="6997662">(</span><span class="op" id="6997663">[</span><span class="op" id="6997664">]</span><span class="keyword" id="6997665">interface</span><span class="op" id="6997674">{</span><span class="op" id="6997675">}</span><span class="op" id="6997676">,</span>&nbsp;<span class="builtinfunc" id="6997678">len</span><span class="op" id="6997681">(</span><span class="ident" id="6997682">s</span><span class="op" id="6997683">.</span><span class="ident" id="6997684">colName</span><span class="op" id="6997691">)</span><span class="op" id="6997692">)</span><span class="op" id="6997693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997697">for</span>&nbsp;<span class="ident" id="6997701">seli</span><span class="op" id="6997705">,</span>&nbsp;<span class="ident" id="6997707">name</span>&nbsp;<span class="op" id="6997712">:=</span>&nbsp;<span class="keyword" id="6997715">range</span>&nbsp;<span class="ident" id="6997721">s</span><span class="op" id="6997722">.</span><span class="ident" id="6997723">colName</span>&nbsp;<span class="op" id="6997731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997736">mrow</span><span class="op" id="6997740">.</span><span class="ident" id="6997741">cols</span><span class="op" id="6997745">[</span><span class="ident" id="6997746">seli</span><span class="op" id="6997750">]</span>&nbsp;<span class="op" id="6997752">=</span>&nbsp;<span class="ident" id="6997754">trow</span><span class="op" id="6997758">.</span><span class="ident" id="6997759">cols</span><span class="op" id="6997763">[</span><span class="ident" id="6997764">colIdx</span><span class="op" id="6997770">[</span><span class="ident" id="6997771">name</span><span class="op" id="6997775">]</span><span class="op" id="6997776">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6997780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997784">mrows</span>&nbsp;<span class="op" id="6997790">=</span>&nbsp;<span class="builtinfunc" id="6997792">append</span><span class="op" id="6997798">(</span><span class="ident" id="6997799">mrows</span><span class="op" id="6997804">,</span>&nbsp;<span class="ident" id="6997806">mrow</span><span class="op" id="6997810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6997813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997817">cursor</span>&nbsp;<span class="op" id="6997824">:=</span>&nbsp;<span class="op" id="6997827">&amp;</span><span class="ident" id="6997828">rowsCursor</span><span class="op" id="6997838">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997842">pos</span><span class="op" id="6997845">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6997850">-</span><span class="num" id="6997851">1</span><span class="op" id="6997852">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997856">rows</span><span class="op" id="6997860">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6997864">mrows</span><span class="op" id="6997869">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997873">cols</span><span class="op" id="6997877">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6997881">s</span><span class="op" id="6997882">.</span><span class="ident" id="6997883">colName</span><span class="op" id="6997890">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6997894">errPos</span><span class="op" id="6997900">:</span>&nbsp;<span class="op" id="6997902">-</span><span class="num" id="6997903">1</span><span class="op" id="6997904">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6997907">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997910">return</span>&nbsp;<span class="ident" id="6997917">cursor</span><span class="op" id="6997923">,</span>&nbsp;<span class="ident" id="6997925">nil</span><br>
<span class="lineno"></span><span class="op" id="6997929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6997932">func</span>&nbsp;<span class="op" id="6997937">(</span><span class="ident" id="6997938">s</span>&nbsp;<span class="op" id="6997940">*</span><span class="ident" id="6997941">fakeStmt</span><span class="op" id="6997949">)</span>&nbsp;<span class="ident" id="6997951">NumInput</span><span class="op" id="6997959">(</span><span class="op" id="6997960">)</span>&nbsp;<span class="builtintype" id="6997962">int</span>&nbsp;<span class="op" id="6997966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6997969">return</span>&nbsp;<span class="ident" id="6997976">s</span><span class="op" id="6997977">.</span><span class="ident" id="6997978">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="6997991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6997994">func</span>&nbsp;<span class="op" id="6997999">(</span><span class="ident" id="6998000">tx</span>&nbsp;<span class="op" id="6998003">*</span><span class="ident" id="6998004">fakeTx</span><span class="op" id="6998010">)</span>&nbsp;<span class="ident" id="6998012">Commit</span><span class="op" id="6998018">(</span><span class="op" id="6998019">)</span>&nbsp;<span class="builtintype" id="6998021">error</span>&nbsp;<span class="op" id="6998027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998030">tx</span><span class="op" id="6998032">.</span><span class="ident" id="6998033">c</span><span class="op" id="6998034">.</span><span class="ident" id="6998035">currTx</span>&nbsp;<span class="op" id="6998042">=</span>&nbsp;<span class="ident" id="6998044">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6998049">return</span>&nbsp;<span class="ident" id="6998056">nil</span><br>
<span class="lineno">700</span><span class="op" id="6998060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6998063">func</span>&nbsp;<span class="op" id="6998068">(</span><span class="ident" id="6998069">tx</span>&nbsp;<span class="op" id="6998072">*</span><span class="ident" id="6998073">fakeTx</span><span class="op" id="6998079">)</span>&nbsp;<span class="ident" id="6998081">Rollback</span><span class="op" id="6998089">(</span><span class="op" id="6998090">)</span>&nbsp;<span class="builtintype" id="6998092">error</span>&nbsp;<span class="op" id="6998098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998101">tx</span><span class="op" id="6998103">.</span><span class="ident" id="6998104">c</span><span class="op" id="6998105">.</span><span class="ident" id="6998106">currTx</span>&nbsp;<span class="op" id="6998113">=</span>&nbsp;<span class="ident" id="6998115">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6998120">return</span>&nbsp;<span class="ident" id="6998127">nil</span><br>
<span class="lineno">705</span><span class="op" id="6998131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6998134">type</span>&nbsp;<span class="ident" id="6998139">rowsCursor</span>&nbsp;<span class="keyword" id="6998150">struct</span>&nbsp;<span class="op" id="6998157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998160">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6998167">[</span><span class="op" id="6998168">]</span><span class="builtintype" id="6998169">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998177">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6998184">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998189">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6998196">[</span><span class="op" id="6998197">]</span><span class="op" id="6998198">*</span><span class="ident" id="6998199">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998204">closed</span>&nbsp;<span class="builtintype" id="6998211">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6998218">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998282">errPos</span>&nbsp;<span class="builtintype" id="6998289">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998294">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6998301">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6998309">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6998370">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6998430">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998479">bytesClone</span>&nbsp;<span class="keyword" id="6998490">map</span><span class="op" id="6998493">[</span><span class="op" id="6998494">*</span><span class="builtintype" id="6998495">byte</span><span class="op" id="6998499">]</span><span class="op" id="6998500">[</span><span class="op" id="6998501">]</span><span class="builtintype" id="6998502">byte</span><br>
<span class="lineno"></span><span class="op" id="6998507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6998510">func</span>&nbsp;<span class="op" id="6998515">(</span><span class="ident" id="6998516">rc</span>&nbsp;<span class="op" id="6998519">*</span><span class="ident" id="6998520">rowsCursor</span><span class="op" id="6998530">)</span>&nbsp;<span class="ident" id="6998532">Close</span><span class="op" id="6998537">(</span><span class="op" id="6998538">)</span>&nbsp;<span class="builtintype" id="6998540">error</span>&nbsp;<span class="op" id="6998546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6998549">if</span>&nbsp;<span class="op" id="6998552">!</span><span class="ident" id="6998553">rc</span><span class="op" id="6998555">.</span><span class="ident" id="6998556">closed</span>&nbsp;<span class="op" id="6998563">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6998567">for</span>&nbsp;<span class="ident" id="6998571">_</span><span class="op" id="6998572">,</span>&nbsp;<span class="ident" id="6998574">bs</span>&nbsp;<span class="op" id="6998577">:=</span>&nbsp;<span class="keyword" id="6998580">range</span>&nbsp;<span class="ident" id="6998586">rc</span><span class="op" id="6998588">.</span><span class="ident" id="6998589">bytesClone</span>&nbsp;<span class="op" id="6998600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998605">bs</span><span class="op" id="6998607">[</span><span class="num" id="6998608">0</span><span class="op" id="6998609">]</span>&nbsp;<span class="op" id="6998611">=</span>&nbsp;<span class="num" id="6998613">255</span>&nbsp;<span class="comment" id="6998617">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6998643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6998646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998649">rc</span><span class="op" id="6998651">.</span><span class="ident" id="6998652">closed</span>&nbsp;<span class="op" id="6998659">=</span>&nbsp;<span class="builtintype" id="6998661">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6998667">return</span>&nbsp;<span class="ident" id="6998674">nil</span><br>
<span class="lineno"></span><span class="op" id="6998678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6998681">func</span>&nbsp;<span class="op" id="6998686">(</span><span class="ident" id="6998687">rc</span>&nbsp;<span class="op" id="6998690">*</span><span class="ident" id="6998691">rowsCursor</span><span class="op" id="6998701">)</span>&nbsp;<span class="ident" id="6998703">Columns</span><span class="op" id="6998710">(</span><span class="op" id="6998711">)</span>&nbsp;<span class="op" id="6998713">[</span><span class="op" id="6998714">]</span><span class="builtintype" id="6998715">string</span>&nbsp;<span class="op" id="6998722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6998725">return</span>&nbsp;<span class="ident" id="6998732">rc</span><span class="op" id="6998734">.</span><span class="ident" id="6998735">cols</span><br>
<span class="lineno">735</span><span class="op" id="6998740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6998743">var</span>&nbsp;<span class="ident" id="6998747">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="6998766">func</span><span class="op" id="6998770">(</span><span class="ident" id="6998771">dest</span>&nbsp;<span class="op" id="6998776">[</span><span class="op" id="6998777">]</span><span class="ident" id="6998778">driver</span><span class="op" id="6998784">.</span><span class="ident" id="6998785">Value</span><span class="op" id="6998790">)</span>&nbsp;<span class="builtintype" id="6998792">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6998799">func</span>&nbsp;<span class="op" id="6998804">(</span><span class="ident" id="6998805">rc</span>&nbsp;<span class="op" id="6998808">*</span><span class="ident" id="6998809">rowsCursor</span><span class="op" id="6998819">)</span>&nbsp;<span class="ident" id="6998821">Next</span><span class="op" id="6998825">(</span><span class="ident" id="6998826">dest</span>&nbsp;<span class="op" id="6998831">[</span><span class="op" id="6998832">]</span><span class="ident" id="6998833">driver</span><span class="op" id="6998839">.</span><span class="ident" id="6998840">Value</span><span class="op" id="6998845">)</span>&nbsp;<span class="builtintype" id="6998847">error</span>&nbsp;<span class="op" id="6998853">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6998856">if</span>&nbsp;<span class="ident" id="6998859">rowsCursorNextHook</span>&nbsp;<span class="op" id="6998878">!=</span>&nbsp;<span class="ident" id="6998881">nil</span>&nbsp;<span class="op" id="6998885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6998889">return</span>&nbsp;<span class="ident" id="6998896">rowsCursorNextHook</span><span class="op" id="6998914">(</span><span class="ident" id="6998915">dest</span><span class="op" id="6998919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6998922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6998926">if</span>&nbsp;<span class="ident" id="6998929">rc</span><span class="op" id="6998931">.</span><span class="ident" id="6998932">closed</span>&nbsp;<span class="op" id="6998939">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6998943">return</span>&nbsp;<span class="ident" id="6998950">errors</span><span class="op" id="6998956">.</span><span class="ident" id="6998957">New</span><span class="op" id="6998960">(</span><span class="string" id="6998961">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6998987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6998990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6998993">rc</span><span class="op" id="6998995">.</span><span class="ident" id="6998996">pos</span><span class="op" id="6998999">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6999003">if</span>&nbsp;<span class="ident" id="6999006">rc</span><span class="op" id="6999008">.</span><span class="ident" id="6999009">pos</span>&nbsp;<span class="op" id="6999013">==</span>&nbsp;<span class="ident" id="6999016">rc</span><span class="op" id="6999018">.</span><span class="ident" id="6999019">errPos</span>&nbsp;<span class="op" id="6999026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6999030">return</span>&nbsp;<span class="ident" id="6999037">rc</span><span class="op" id="6999039">.</span><span class="ident" id="6999040">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6999045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6999048">if</span>&nbsp;<span class="ident" id="6999051">rc</span><span class="op" id="6999053">.</span><span class="ident" id="6999054">pos</span>&nbsp;<span class="op" id="6999058">&gt;=</span>&nbsp;<span class="builtinfunc" id="6999061">len</span><span class="op" id="6999064">(</span><span class="ident" id="6999065">rc</span><span class="op" id="6999067">.</span><span class="ident" id="6999068">rows</span><span class="op" id="6999072">)</span>&nbsp;<span class="op" id="6999074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6999078">return</span>&nbsp;<span class="ident" id="6999085">io</span><span class="op" id="6999087">.</span><span class="ident" id="6999088">EOF</span>&nbsp;<span class="comment" id="6999092">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6999115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6999118">for</span>&nbsp;<span class="ident" id="6999122">i</span><span class="op" id="6999123">,</span>&nbsp;<span class="ident" id="6999125">v</span>&nbsp;<span class="op" id="6999127">:=</span>&nbsp;<span class="keyword" id="6999130">range</span>&nbsp;<span class="ident" id="6999136">rc</span><span class="op" id="6999138">.</span><span class="ident" id="6999139">rows</span><span class="op" id="6999143">[</span><span class="ident" id="6999144">rc</span><span class="op" id="6999146">.</span><span class="ident" id="6999147">pos</span><span class="op" id="6999150">]</span><span class="op" id="6999151">.</span><span class="ident" id="6999152">cols</span>&nbsp;<span class="op" id="6999157">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6999161">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6999215">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6999267">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6999325">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6999380">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6999434">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999489">dest</span><span class="op" id="6999493">[</span><span class="ident" id="6999494">i</span><span class="op" id="6999495">]</span>&nbsp;<span class="op" id="6999497">=</span>&nbsp;<span class="ident" id="6999499">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6999504">if</span>&nbsp;<span class="ident" id="6999507">bs</span><span class="op" id="6999509">,</span>&nbsp;<span class="ident" id="6999511">ok</span>&nbsp;<span class="op" id="6999514">:=</span>&nbsp;<span class="ident" id="6999517">v</span><span class="op" id="6999518">.</span><span class="op" id="6999519">(</span><span class="op" id="6999520">[</span><span class="op" id="6999521">]</span><span class="builtintype" id="6999522">byte</span><span class="op" id="6999526">)</span><span class="op" id="6999527">;</span>&nbsp;<span class="ident" id="6999529">ok</span>&nbsp;<span class="op" id="6999532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6999537">if</span>&nbsp;<span class="ident" id="6999540">rc</span><span class="op" id="6999542">.</span><span class="ident" id="6999543">bytesClone</span>&nbsp;<span class="op" id="6999554">==</span>&nbsp;<span class="ident" id="6999557">nil</span>&nbsp;<span class="op" id="6999561">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999567">rc</span><span class="op" id="6999569">.</span><span class="ident" id="6999570">bytesClone</span>&nbsp;<span class="op" id="6999581">=</span>&nbsp;<span class="builtinfunc" id="6999583">make</span><span class="op" id="6999587">(</span><span class="keyword" id="6999588">map</span><span class="op" id="6999591">[</span><span class="op" id="6999592">*</span><span class="builtintype" id="6999593">byte</span><span class="op" id="6999597">]</span><span class="op" id="6999598">[</span><span class="op" id="6999599">]</span><span class="builtintype" id="6999600">byte</span><span class="op" id="6999604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6999609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999614">clone</span><span class="op" id="6999619">,</span>&nbsp;<span class="ident" id="6999621">ok</span>&nbsp;<span class="op" id="6999624">:=</span>&nbsp;<span class="ident" id="6999627">rc</span><span class="op" id="6999629">.</span><span class="ident" id="6999630">bytesClone</span><span class="op" id="6999640">[</span><span class="op" id="6999641">&amp;</span><span class="ident" id="6999642">bs</span><span class="op" id="6999644">[</span><span class="num" id="6999645">0</span><span class="op" id="6999646">]</span><span class="op" id="6999647">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6999652">if</span>&nbsp;<span class="op" id="6999655">!</span><span class="ident" id="6999656">ok</span>&nbsp;<span class="op" id="6999659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999665">clone</span>&nbsp;<span class="op" id="6999671">=</span>&nbsp;<span class="builtinfunc" id="6999673">make</span><span class="op" id="6999677">(</span><span class="op" id="6999678">[</span><span class="op" id="6999679">]</span><span class="builtintype" id="6999680">byte</span><span class="op" id="6999684">,</span>&nbsp;<span class="builtinfunc" id="6999686">len</span><span class="op" id="6999689">(</span><span class="ident" id="6999690">bs</span><span class="op" id="6999692">)</span><span class="op" id="6999693">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6999699">copy</span><span class="op" id="6999703">(</span><span class="ident" id="6999704">clone</span><span class="op" id="6999709">,</span>&nbsp;<span class="ident" id="6999711">bs</span><span class="op" id="6999713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999719">rc</span><span class="op" id="6999721">.</span><span class="ident" id="6999722">bytesClone</span><span class="op" id="6999732">[</span><span class="op" id="6999733">&amp;</span><span class="ident" id="6999734">bs</span><span class="op" id="6999736">[</span><span class="num" id="6999737">0</span><span class="op" id="6999738">]</span><span class="op" id="6999739">]</span>&nbsp;<span class="op" id="6999741">=</span>&nbsp;<span class="ident" id="6999743">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6999752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6999757">dest</span><span class="op" id="6999761">[</span><span class="ident" id="6999762">i</span><span class="op" id="6999763">]</span>&nbsp;<span class="op" id="6999765">=</span>&nbsp;<span class="ident" id="6999767">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6999775">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6999778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6999781">return</span>&nbsp;<span class="ident" id="6999788">nil</span><br>
<span class="lineno"></span><span class="op" id="6999792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6999795">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="6999866">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="6999892">//</span><br>
<span class="lineno"></span><span class="comment" id="6999895">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6999958">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7000023">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="7000057">//</span><br>
<span class="lineno"></span><span class="keyword" id="7000060">type</span>&nbsp;<span class="ident" id="7000065">fakeDriverString</span>&nbsp;<span class="keyword" id="7000082">struct</span><span class="op" id="7000088">{</span><span class="op" id="7000089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7000092">func</span>&nbsp;<span class="op" id="7000097">(</span><span class="ident" id="7000098">fakeDriverString</span><span class="op" id="7000114">)</span>&nbsp;<span class="ident" id="7000116">ConvertValue</span><span class="op" id="7000128">(</span><span class="ident" id="7000129">v</span>&nbsp;<span class="keyword" id="7000131">interface</span><span class="op" id="7000140">{</span><span class="op" id="7000141">}</span><span class="op" id="7000142">)</span>&nbsp;<span class="op" id="7000144">(</span><span class="ident" id="7000145">driver</span><span class="op" id="7000151">.</span><span class="ident" id="7000152">Value</span><span class="op" id="7000157">,</span>&nbsp;<span class="builtintype" id="7000159">error</span><span class="op" id="7000164">)</span>&nbsp;<span class="op" id="7000166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000169">switch</span>&nbsp;<span class="ident" id="7000176">c</span>&nbsp;<span class="op" id="7000178">:=</span>&nbsp;<span class="ident" id="7000181">v</span><span class="op" id="7000182">.</span><span class="op" id="7000183">(</span><span class="keyword" id="7000184">type</span><span class="op" id="7000188">)</span>&nbsp;<span class="op" id="7000190">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000193">case</span>&nbsp;<span class="builtintype" id="7000198">string</span><span class="op" id="7000204">,</span>&nbsp;<span class="op" id="7000206">[</span><span class="op" id="7000207">]</span><span class="builtintype" id="7000208">byte</span><span class="op" id="7000212">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000216">return</span>&nbsp;<span class="ident" id="7000223">v</span><span class="op" id="7000224">,</span>&nbsp;<span class="ident" id="7000226">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000231">case</span>&nbsp;<span class="op" id="7000236">*</span><span class="builtintype" id="7000237">string</span><span class="op" id="7000243">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000247">if</span>&nbsp;<span class="ident" id="7000250">c</span>&nbsp;<span class="op" id="7000252">==</span>&nbsp;<span class="ident" id="7000255">nil</span>&nbsp;<span class="op" id="7000259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000264">return</span>&nbsp;<span class="ident" id="7000271">nil</span><span class="op" id="7000274">,</span>&nbsp;<span class="ident" id="7000276">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7000282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000286">return</span>&nbsp;<span class="op" id="7000293">*</span><span class="ident" id="7000294">c</span><span class="op" id="7000295">,</span>&nbsp;<span class="ident" id="7000297">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7000302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000305">return</span>&nbsp;<span class="ident" id="7000312">fmt</span><span class="op" id="7000315">.</span><span class="ident" id="7000316">Sprintf</span><span class="op" id="7000323">(</span><span class="string" id="7000324">&#34;%v&#34;</span><span class="op" id="7000328">,</span>&nbsp;<span class="ident" id="7000330">v</span><span class="op" id="7000331">)</span><span class="op" id="7000332">,</span>&nbsp;<span class="ident" id="7000334">nil</span><br>
<span class="lineno"></span><span class="op" id="7000338">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="7000341">func</span>&nbsp;<span class="ident" id="7000346">converterForType</span><span class="op" id="7000362">(</span><span class="ident" id="7000363">typ</span>&nbsp;<span class="builtintype" id="7000367">string</span><span class="op" id="7000373">)</span>&nbsp;<span class="ident" id="7000375">driver</span><span class="op" id="7000381">.</span><span class="ident" id="7000382">ValueConverter</span>&nbsp;<span class="op" id="7000397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000400">switch</span>&nbsp;<span class="ident" id="7000407">typ</span>&nbsp;<span class="op" id="7000411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000414">case</span>&nbsp;<span class="string" id="7000419">&#34;bool&#34;</span><span class="op" id="7000425">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000429">return</span>&nbsp;<span class="ident" id="7000436">driver</span><span class="op" id="7000442">.</span><span class="ident" id="7000443">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000449">case</span>&nbsp;<span class="string" id="7000454">&#34;nullbool&#34;</span><span class="op" id="7000464">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000468">return</span>&nbsp;<span class="ident" id="7000475">driver</span><span class="op" id="7000481">.</span><span class="ident" id="7000482">Null</span><span class="op" id="7000486">{</span><span class="ident" id="7000487">Converter</span><span class="op" id="7000496">:</span>&nbsp;<span class="ident" id="7000498">driver</span><span class="op" id="7000504">.</span><span class="ident" id="7000505">Bool</span><span class="op" id="7000509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000512">case</span>&nbsp;<span class="string" id="7000517">&#34;int32&#34;</span><span class="op" id="7000524">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000528">return</span>&nbsp;<span class="ident" id="7000535">driver</span><span class="op" id="7000541">.</span><span class="ident" id="7000542">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000549">case</span>&nbsp;<span class="string" id="7000554">&#34;string&#34;</span><span class="op" id="7000562">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000566">return</span>&nbsp;<span class="ident" id="7000573">driver</span><span class="op" id="7000579">.</span><span class="ident" id="7000580">NotNull</span><span class="op" id="7000587">{</span><span class="ident" id="7000588">Converter</span><span class="op" id="7000597">:</span>&nbsp;<span class="ident" id="7000599">fakeDriverString</span><span class="op" id="7000615">{</span><span class="op" id="7000616">}</span><span class="op" id="7000617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000620">case</span>&nbsp;<span class="string" id="7000625">&#34;nullstring&#34;</span><span class="op" id="7000637">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000641">return</span>&nbsp;<span class="ident" id="7000648">driver</span><span class="op" id="7000654">.</span><span class="ident" id="7000655">Null</span><span class="op" id="7000659">{</span><span class="ident" id="7000660">Converter</span><span class="op" id="7000669">:</span>&nbsp;<span class="ident" id="7000671">fakeDriverString</span><span class="op" id="7000687">{</span><span class="op" id="7000688">}</span><span class="op" id="7000689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000692">case</span>&nbsp;<span class="string" id="7000697">&#34;int64&#34;</span><span class="op" id="7000704">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7000708">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000760">return</span>&nbsp;<span class="ident" id="7000767">driver</span><span class="op" id="7000773">.</span><span class="ident" id="7000774">NotNull</span><span class="op" id="7000781">{</span><span class="ident" id="7000782">Converter</span><span class="op" id="7000791">:</span>&nbsp;<span class="ident" id="7000793">driver</span><span class="op" id="7000799">.</span><span class="ident" id="7000800">DefaultParameterConverter</span><span class="op" id="7000825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000828">case</span>&nbsp;<span class="string" id="7000833">&#34;nullint64&#34;</span><span class="op" id="7000844">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7000848">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000900">return</span>&nbsp;<span class="ident" id="7000907">driver</span><span class="op" id="7000913">.</span><span class="ident" id="7000914">Null</span><span class="op" id="7000918">{</span><span class="ident" id="7000919">Converter</span><span class="op" id="7000928">:</span>&nbsp;<span class="ident" id="7000930">driver</span><span class="op" id="7000936">.</span><span class="ident" id="7000937">DefaultParameterConverter</span><span class="op" id="7000962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7000965">case</span>&nbsp;<span class="string" id="7000970">&#34;float64&#34;</span><span class="op" id="7000979">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7000983">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001035">return</span>&nbsp;<span class="ident" id="7001042">driver</span><span class="op" id="7001048">.</span><span class="ident" id="7001049">NotNull</span><span class="op" id="7001056">{</span><span class="ident" id="7001057">Converter</span><span class="op" id="7001066">:</span>&nbsp;<span class="ident" id="7001068">driver</span><span class="op" id="7001074">.</span><span class="ident" id="7001075">DefaultParameterConverter</span><span class="op" id="7001100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001103">case</span>&nbsp;<span class="string" id="7001108">&#34;nullfloat64&#34;</span><span class="op" id="7001121">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7001125">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001177">return</span>&nbsp;<span class="ident" id="7001184">driver</span><span class="op" id="7001190">.</span><span class="ident" id="7001191">Null</span><span class="op" id="7001195">{</span><span class="ident" id="7001196">Converter</span><span class="op" id="7001205">:</span>&nbsp;<span class="ident" id="7001207">driver</span><span class="op" id="7001213">.</span><span class="ident" id="7001214">DefaultParameterConverter</span><span class="op" id="7001239">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001242">case</span>&nbsp;<span class="string" id="7001247">&#34;datetime&#34;</span><span class="op" id="7001257">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001261">return</span>&nbsp;<span class="ident" id="7001268">driver</span><span class="op" id="7001274">.</span><span class="ident" id="7001275">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7001302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7001305">panic</span><span class="op" id="7001310">(</span><span class="string" id="7001311">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="7001344">+</span>&nbsp;<span class="ident" id="7001346">typ</span><span class="op" id="7001349">)</span><br>
<span class="lineno"></span><span class="op" id="7001351">}</span>
</div>
</body>
</html>
