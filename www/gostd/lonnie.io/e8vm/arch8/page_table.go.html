<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="keyword" id="5066775">package</span>&nbsp;<span class="ident" id="5066783">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5066790">//&nbsp;PageTable&nbsp;describes&nbsp;a&nbsp;page&nbsp;table&nbsp;in&nbsp;a&nbsp;physical&nbsp;memory.</span><br>
<span class="lineno"></span><span class="comment" id="5066848">//&nbsp;It&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;translate&nbsp;a&nbsp;virtual&nbsp;memory&nbsp;address&nbsp;into&nbsp;a&nbsp;physical</span><br>
<span class="lineno">5</span><span class="comment" id="5066920">//&nbsp;memory&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="5066939">type</span>&nbsp;<span class="ident" id="5066944">pageTable</span>&nbsp;<span class="keyword" id="5066954">struct</span>&nbsp;<span class="op" id="5066961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066964">mem</span>&nbsp;&nbsp;<span class="op" id="5066969">*</span><span class="ident" id="5066970">phyMemory</span>&nbsp;<span class="comment" id="5066980">//&nbsp;the&nbsp;physical&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067004">root</span>&nbsp;<span class="builtintype" id="5067009">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5067020">//&nbsp;root&nbsp;address</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067038">//&nbsp;last&nbsp;translation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067059">pte1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5067068">ptEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067077">pte2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5067086">ptEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067095">pte1Addr</span>&nbsp;<span class="builtintype" id="5067104">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067112">pte2Addr</span>&nbsp;<span class="builtintype" id="5067121">uint32</span><br>
<span class="lineno">15</span><span class="op" id="5067128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5067131">//&nbsp;NewPageTable&nbsp;creates&nbsp;a&nbsp;new&nbsp;page&nbsp;table&nbsp;pointer.</span><br>
<span class="lineno"></span><span class="comment" id="5067181">//&nbsp;The&nbsp;page&nbsp;table&nbsp;is&nbsp;saved&nbsp;at&nbsp;addr.</span><br>
<span class="lineno"></span><span class="comment" id="5067217">//&nbsp;If&nbsp;addr&nbsp;is&nbsp;not&nbsp;page&nbsp;size&nbsp;aligned,&nbsp;it&nbsp;is&nbsp;aligned&nbsp;down.</span><br>
<span class="lineno">20</span><span class="keyword" id="5067274">func</span>&nbsp;<span class="ident" id="5067279">newPageTable</span><span class="op" id="5067291">(</span><span class="ident" id="5067292">m</span>&nbsp;<span class="op" id="5067294">*</span><span class="ident" id="5067295">phyMemory</span><span class="op" id="5067304">,</span>&nbsp;<span class="ident" id="5067306">addr</span>&nbsp;<span class="builtintype" id="5067311">uint32</span><span class="op" id="5067317">)</span>&nbsp;<span class="op" id="5067319">*</span><span class="ident" id="5067320">pageTable</span>&nbsp;<span class="op" id="5067330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067333">addr</span>&nbsp;<span class="op" id="5067338">-=</span>&nbsp;<span class="ident" id="5067341">addr</span>&nbsp;<span class="op" id="5067346">%</span>&nbsp;<span class="ident" id="5067348">PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067358">ret</span>&nbsp;<span class="op" id="5067362">:=</span>&nbsp;<span class="builtinfunc" id="5067365">new</span><span class="op" id="5067368">(</span><span class="ident" id="5067369">pageTable</span><span class="op" id="5067378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067381">ret</span><span class="op" id="5067384">.</span><span class="ident" id="5067385">mem</span>&nbsp;<span class="op" id="5067389">=</span>&nbsp;<span class="ident" id="5067391">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067394">ret</span><span class="op" id="5067397">.</span><span class="ident" id="5067398">root</span>&nbsp;<span class="op" id="5067403">=</span>&nbsp;<span class="ident" id="5067405">addr</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067412">return</span>&nbsp;<span class="ident" id="5067419">ret</span><br>
<span class="lineno"></span><span class="op" id="5067423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5067426">//&nbsp;bit&nbsp;[31:12]&nbsp;-&gt;&nbsp;a&nbsp;page&nbsp;pointer</span><br>
<span class="lineno">30</span><span class="comment" id="5067459">//</span><br>
<span class="lineno"></span><span class="comment" id="5067462">//&nbsp;bit&nbsp;3:&nbsp;dirty&nbsp;bit</span><br>
<span class="lineno"></span><span class="comment" id="5067482">//&nbsp;bit&nbsp;2:&nbsp;use&nbsp;bit</span><br>
<span class="lineno"></span><span class="comment" id="5067500">//&nbsp;bit&nbsp;1:&nbsp;readonly&nbsp;bit</span><br>
<span class="lineno"></span><span class="comment" id="5067523">//&nbsp;bit&nbsp;0:&nbsp;valid&nbsp;bit</span><br>
<span class="lineno">35</span><span class="keyword" id="5067543">type</span>&nbsp;<span class="ident" id="5067548">ptEntry</span>&nbsp;<span class="builtintype" id="5067556">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5067564">const</span>&nbsp;<span class="op" id="5067570">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067573">pteValid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5067585">=</span>&nbsp;<span class="num" id="5067587">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067590">pteReadonly</span>&nbsp;<span class="op" id="5067602">=</span>&nbsp;<span class="num" id="5067604">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067607">pteUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5067619">=</span>&nbsp;<span class="num" id="5067621">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067624">pteDirty</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5067636">=</span>&nbsp;<span class="num" id="5067638">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067641">pteUser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5067653">=</span>&nbsp;<span class="num" id="5067655">4</span><br>
<span class="lineno"></span><span class="op" id="5067657">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="5067660">const</span>&nbsp;<span class="ident" id="5067666">u32one</span>&nbsp;<span class="builtintype" id="5067673">uint32</span>&nbsp;<span class="op" id="5067680">=</span>&nbsp;<span class="num" id="5067682">0x1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5067687">func</span>&nbsp;<span class="op" id="5067692">(</span><span class="ident" id="5067693">pte</span>&nbsp;<span class="ident" id="5067697">ptEntry</span><span class="op" id="5067704">)</span>&nbsp;<span class="ident" id="5067706">testBit</span><span class="op" id="5067713">(</span><span class="ident" id="5067714">n</span>&nbsp;<span class="builtintype" id="5067716">uint</span><span class="op" id="5067720">)</span>&nbsp;<span class="builtintype" id="5067722">bool</span>&nbsp;<span class="op" id="5067727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067730">return</span>&nbsp;<span class="op" id="5067737">(</span><span class="builtintype" id="5067738">uint32</span><span class="op" id="5067744">(</span><span class="ident" id="5067745">pte</span><span class="op" id="5067748">)</span>&nbsp;<span class="op" id="5067750">&amp;</span>&nbsp;<span class="op" id="5067752">(</span><span class="ident" id="5067753">u32one</span>&nbsp;<span class="op" id="5067760">&lt;&lt;</span>&nbsp;<span class="ident" id="5067763">n</span><span class="op" id="5067764">)</span><span class="op" id="5067765">)</span>&nbsp;<span class="op" id="5067767">!=</span>&nbsp;<span class="num" id="5067770">0</span><br>
<span class="lineno"></span><span class="op" id="5067772">}</span><br>
<span class="lineno">50</span><span class="keyword" id="5067774">func</span>&nbsp;<span class="op" id="5067779">(</span><span class="ident" id="5067780">pte</span>&nbsp;<span class="op" id="5067784">*</span><span class="ident" id="5067785">ptEntry</span><span class="op" id="5067792">)</span>&nbsp;<span class="ident" id="5067794">setBit</span><span class="op" id="5067800">(</span><span class="ident" id="5067801">n</span>&nbsp;<span class="builtintype" id="5067803">uint</span><span class="op" id="5067807">)</span>&nbsp;<span class="op" id="5067809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5067812">*</span><span class="ident" id="5067813">pte</span>&nbsp;<span class="op" id="5067817">=</span>&nbsp;<span class="ident" id="5067819">ptEntry</span><span class="op" id="5067826">(</span><span class="builtintype" id="5067827">uint32</span><span class="op" id="5067833">(</span><span class="op" id="5067834">*</span><span class="ident" id="5067835">pte</span><span class="op" id="5067838">)</span>&nbsp;<span class="op" id="5067840">|</span>&nbsp;<span class="op" id="5067842">(</span><span class="ident" id="5067843">u32one</span>&nbsp;<span class="op" id="5067850">&lt;&lt;</span>&nbsp;<span class="ident" id="5067853">n</span><span class="op" id="5067854">)</span><span class="op" id="5067855">)</span><br>
<span class="lineno"></span><span class="op" id="5067857">}</span><br>
<span class="lineno"></span><span class="keyword" id="5067859">func</span>&nbsp;<span class="op" id="5067864">(</span><span class="ident" id="5067865">pte</span>&nbsp;<span class="ident" id="5067869">ptEntry</span><span class="op" id="5067876">)</span>&nbsp;<span class="ident" id="5067878">pn</span><span class="op" id="5067880">(</span><span class="op" id="5067881">)</span>&nbsp;<span class="builtintype" id="5067883">uint32</span>&nbsp;<span class="op" id="5067890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067893">return</span>&nbsp;<span class="builtintype" id="5067900">uint32</span><span class="op" id="5067906">(</span><span class="ident" id="5067907">pte</span>&nbsp;<span class="op" id="5067911">/</span>&nbsp;<span class="ident" id="5067913">PageSize</span><span class="op" id="5067921">)</span><br>
<span class="lineno">55</span><span class="op" id="5067923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5067926">func</span>&nbsp;<span class="op" id="5067931">(</span><span class="ident" id="5067932">pte</span>&nbsp;<span class="ident" id="5067936">ptEntry</span><span class="op" id="5067943">)</span>&nbsp;<span class="ident" id="5067945">test</span><span class="op" id="5067949">(</span><span class="ident" id="5067950">addr</span>&nbsp;<span class="builtintype" id="5067955">uint32</span><span class="op" id="5067961">,</span>&nbsp;<span class="ident" id="5067963">ring</span>&nbsp;<span class="builtintype" id="5067968">byte</span><span class="op" id="5067972">)</span>&nbsp;<span class="op" id="5067974">*</span><span class="ident" id="5067975">Excep</span>&nbsp;<span class="op" id="5067981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067984">if</span>&nbsp;<span class="op" id="5067987">!</span><span class="ident" id="5067988">pte</span><span class="op" id="5067991">.</span><span class="ident" id="5067992">testBit</span><span class="op" id="5067999">(</span><span class="ident" id="5068000">pteValid</span><span class="op" id="5068008">)</span>&nbsp;<span class="op" id="5068010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068014">return</span>&nbsp;<span class="ident" id="5068021">newPageFault</span><span class="op" id="5068033">(</span><span class="ident" id="5068034">addr</span><span class="op" id="5068038">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068044">if</span>&nbsp;<span class="ident" id="5068047">ring</span>&nbsp;<span class="op" id="5068052">&gt;</span>&nbsp;<span class="num" id="5068054">0</span>&nbsp;<span class="op" id="5068056">&amp;&amp;</span>&nbsp;<span class="op" id="5068059">!</span><span class="ident" id="5068060">pte</span><span class="op" id="5068063">.</span><span class="ident" id="5068064">testBit</span><span class="op" id="5068071">(</span><span class="ident" id="5068072">pteUser</span><span class="op" id="5068079">)</span>&nbsp;<span class="op" id="5068081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068085">return</span>&nbsp;<span class="ident" id="5068092">newPageFault</span><span class="op" id="5068104">(</span><span class="ident" id="5068105">addr</span><span class="op" id="5068109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068115">return</span>&nbsp;<span class="ident" id="5068122">nil</span><br>
<span class="lineno">65</span><span class="op" id="5068126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5068129">//&nbsp;Translate&nbsp;transalate&nbsp;a&nbsp;virutal&nbsp;address&nbsp;into&nbsp;physical&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="5068194">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;translation&nbsp;fails</span><br>
<span class="lineno"></span><span class="keyword" id="5068242">func</span>&nbsp;<span class="op" id="5068247">(</span><span class="ident" id="5068248">pt</span>&nbsp;<span class="op" id="5068251">*</span><span class="ident" id="5068252">pageTable</span><span class="op" id="5068261">)</span>&nbsp;<span class="ident" id="5068263">Translate</span><span class="op" id="5068272">(</span><span class="ident" id="5068273">addr</span>&nbsp;<span class="builtintype" id="5068278">uint32</span><span class="op" id="5068284">,</span>&nbsp;<span class="ident" id="5068286">ring</span>&nbsp;<span class="builtintype" id="5068291">byte</span><span class="op" id="5068295">)</span>&nbsp;<span class="op" id="5068297">(</span><span class="builtintype" id="5068298">uint32</span><span class="op" id="5068304">,</span>&nbsp;<span class="op" id="5068306">*</span><span class="ident" id="5068307">Excep</span><span class="op" id="5068312">)</span>&nbsp;<span class="op" id="5068314">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068317">vpn</span>&nbsp;<span class="op" id="5068321">:=</span>&nbsp;<span class="ident" id="5068324">addr</span>&nbsp;<span class="op" id="5068329">/</span>&nbsp;<span class="ident" id="5068331">PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068341">off</span>&nbsp;<span class="op" id="5068345">:=</span>&nbsp;<span class="ident" id="5068348">addr</span>&nbsp;<span class="op" id="5068353">%</span>&nbsp;<span class="ident" id="5068355">PageSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068366">index1</span>&nbsp;<span class="op" id="5068373">:=</span>&nbsp;<span class="ident" id="5068376">vpn</span>&nbsp;<span class="op" id="5068380">/</span>&nbsp;<span class="num" id="5068382">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068388">index2</span>&nbsp;<span class="op" id="5068395">:=</span>&nbsp;<span class="ident" id="5068398">vpn</span>&nbsp;<span class="op" id="5068402">%</span>&nbsp;<span class="num" id="5068404">1024</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068411">//&nbsp;first&nbsp;level&nbsp;page&nbsp;table&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068444">pt</span><span class="op" id="5068446">.</span><span class="ident" id="5068447">pte1Addr</span>&nbsp;<span class="op" id="5068456">=</span>&nbsp;<span class="ident" id="5068458">pt</span><span class="op" id="5068460">.</span><span class="ident" id="5068461">root</span>&nbsp;<span class="op" id="5068466">+</span>&nbsp;<span class="ident" id="5068468">index1</span><span class="op" id="5068474">*</span><span class="num" id="5068475">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068478">w</span><span class="op" id="5068479">,</span>&nbsp;<span class="ident" id="5068481">e</span>&nbsp;<span class="op" id="5068483">:=</span>&nbsp;<span class="ident" id="5068486">pt</span><span class="op" id="5068488">.</span><span class="ident" id="5068489">mem</span><span class="op" id="5068492">.</span><span class="ident" id="5068493">ReadWord</span><span class="op" id="5068501">(</span><span class="ident" id="5068502">pt</span><span class="op" id="5068504">.</span><span class="ident" id="5068505">pte1Addr</span><span class="op" id="5068513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068516">if</span>&nbsp;<span class="ident" id="5068519">e</span>&nbsp;<span class="op" id="5068521">!=</span>&nbsp;<span class="ident" id="5068524">nil</span>&nbsp;<span class="op" id="5068528">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068532">return</span>&nbsp;<span class="num" id="5068539">0</span><span class="op" id="5068540">,</span>&nbsp;<span class="ident" id="5068542">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068548">pt</span><span class="op" id="5068550">.</span><span class="ident" id="5068551">pte1</span>&nbsp;<span class="op" id="5068556">=</span>&nbsp;<span class="ident" id="5068558">ptEntry</span><span class="op" id="5068565">(</span><span class="ident" id="5068566">w</span><span class="op" id="5068567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068570">e</span>&nbsp;<span class="op" id="5068572">=</span>&nbsp;<span class="ident" id="5068574">pt</span><span class="op" id="5068576">.</span><span class="ident" id="5068577">pte1</span><span class="op" id="5068581">.</span><span class="ident" id="5068582">test</span><span class="op" id="5068586">(</span><span class="ident" id="5068587">addr</span><span class="op" id="5068591">,</span>&nbsp;<span class="ident" id="5068593">ring</span><span class="op" id="5068597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068600">if</span>&nbsp;<span class="ident" id="5068603">e</span>&nbsp;<span class="op" id="5068605">!=</span>&nbsp;<span class="ident" id="5068608">nil</span>&nbsp;<span class="op" id="5068612">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068616">return</span>&nbsp;<span class="num" id="5068623">0</span><span class="op" id="5068624">,</span>&nbsp;<span class="ident" id="5068626">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068633">pn1</span>&nbsp;<span class="op" id="5068637">:=</span>&nbsp;<span class="ident" id="5068640">pt</span><span class="op" id="5068642">.</span><span class="ident" id="5068643">pte1</span><span class="op" id="5068647">.</span><span class="ident" id="5068648">pn</span><span class="op" id="5068650">(</span><span class="op" id="5068651">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068655">pt</span><span class="op" id="5068657">.</span><span class="ident" id="5068658">pte2Addr</span>&nbsp;<span class="op" id="5068667">=</span>&nbsp;<span class="ident" id="5068669">pn1</span><span class="op" id="5068672">*</span><span class="ident" id="5068673">PageSize</span>&nbsp;<span class="op" id="5068682">+</span>&nbsp;<span class="ident" id="5068684">index2</span><span class="op" id="5068690">*</span><span class="num" id="5068691">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068694">w</span><span class="op" id="5068695">,</span>&nbsp;<span class="ident" id="5068697">e</span>&nbsp;<span class="op" id="5068699">=</span>&nbsp;<span class="ident" id="5068701">pt</span><span class="op" id="5068703">.</span><span class="ident" id="5068704">mem</span><span class="op" id="5068707">.</span><span class="ident" id="5068708">ReadWord</span><span class="op" id="5068716">(</span><span class="ident" id="5068717">pt</span><span class="op" id="5068719">.</span><span class="ident" id="5068720">pte2Addr</span><span class="op" id="5068728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068731">if</span>&nbsp;<span class="ident" id="5068734">e</span>&nbsp;<span class="op" id="5068736">!=</span>&nbsp;<span class="ident" id="5068739">nil</span>&nbsp;<span class="op" id="5068743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068747">return</span>&nbsp;<span class="num" id="5068754">0</span><span class="op" id="5068755">,</span>&nbsp;<span class="ident" id="5068757">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068760">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068763">pt</span><span class="op" id="5068765">.</span><span class="ident" id="5068766">pte2</span>&nbsp;<span class="op" id="5068771">=</span>&nbsp;<span class="ident" id="5068773">ptEntry</span><span class="op" id="5068780">(</span><span class="ident" id="5068781">w</span><span class="op" id="5068782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068785">e</span>&nbsp;<span class="op" id="5068787">=</span>&nbsp;<span class="ident" id="5068789">pt</span><span class="op" id="5068791">.</span><span class="ident" id="5068792">pte2</span><span class="op" id="5068796">.</span><span class="ident" id="5068797">test</span><span class="op" id="5068801">(</span><span class="ident" id="5068802">addr</span><span class="op" id="5068806">,</span>&nbsp;<span class="ident" id="5068808">ring</span><span class="op" id="5068812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068815">if</span>&nbsp;<span class="ident" id="5068818">e</span>&nbsp;<span class="op" id="5068820">!=</span>&nbsp;<span class="ident" id="5068823">nil</span>&nbsp;<span class="op" id="5068827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068831">return</span>&nbsp;<span class="num" id="5068838">0</span><span class="op" id="5068839">,</span>&nbsp;<span class="ident" id="5068841">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068844">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068848">ppn</span>&nbsp;<span class="op" id="5068852">:=</span>&nbsp;<span class="ident" id="5068855">pt</span><span class="op" id="5068857">.</span><span class="ident" id="5068858">pte2</span><span class="op" id="5068862">.</span><span class="ident" id="5068863">pn</span><span class="op" id="5068865">(</span><span class="op" id="5068866">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068870">return</span>&nbsp;<span class="ident" id="5068877">ppn</span><span class="op" id="5068880">*</span><span class="ident" id="5068881">PageSize</span>&nbsp;<span class="op" id="5068890">+</span>&nbsp;<span class="ident" id="5068892">off</span><span class="op" id="5068895">,</span>&nbsp;<span class="ident" id="5068897">nil</span><br>
<span class="lineno"></span><span class="op" id="5068901">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="5068904">func</span>&nbsp;<span class="op" id="5068909">(</span><span class="ident" id="5068910">pt</span>&nbsp;<span class="op" id="5068913">*</span><span class="ident" id="5068914">pageTable</span><span class="op" id="5068923">)</span>&nbsp;<span class="ident" id="5068925">updatePte</span><span class="op" id="5068934">(</span><span class="op" id="5068935">)</span>&nbsp;<span class="op" id="5068937">*</span><span class="ident" id="5068938">Excep</span>&nbsp;<span class="op" id="5068944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068947">e</span>&nbsp;<span class="op" id="5068949">:=</span>&nbsp;<span class="ident" id="5068952">pt</span><span class="op" id="5068954">.</span><span class="ident" id="5068955">mem</span><span class="op" id="5068958">.</span><span class="ident" id="5068959">WriteWord</span><span class="op" id="5068968">(</span><span class="ident" id="5068969">pt</span><span class="op" id="5068971">.</span><span class="ident" id="5068972">pte1Addr</span><span class="op" id="5068980">,</span>&nbsp;<span class="builtintype" id="5068982">uint32</span><span class="op" id="5068988">(</span><span class="ident" id="5068989">pt</span><span class="op" id="5068991">.</span><span class="ident" id="5068992">pte1</span><span class="op" id="5068996">)</span><span class="op" id="5068997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069000">if</span>&nbsp;<span class="ident" id="5069003">e</span>&nbsp;<span class="op" id="5069005">!=</span>&nbsp;<span class="ident" id="5069008">nil</span>&nbsp;<span class="op" id="5069012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069016">return</span>&nbsp;<span class="ident" id="5069023">e</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069030">e</span>&nbsp;<span class="op" id="5069032">=</span>&nbsp;<span class="ident" id="5069034">pt</span><span class="op" id="5069036">.</span><span class="ident" id="5069037">mem</span><span class="op" id="5069040">.</span><span class="ident" id="5069041">WriteWord</span><span class="op" id="5069050">(</span><span class="ident" id="5069051">pt</span><span class="op" id="5069053">.</span><span class="ident" id="5069054">pte2Addr</span><span class="op" id="5069062">,</span>&nbsp;<span class="builtintype" id="5069064">uint32</span><span class="op" id="5069070">(</span><span class="ident" id="5069071">pt</span><span class="op" id="5069073">.</span><span class="ident" id="5069074">pte2</span><span class="op" id="5069078">)</span><span class="op" id="5069079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069082">if</span>&nbsp;<span class="ident" id="5069085">e</span>&nbsp;<span class="op" id="5069087">!=</span>&nbsp;<span class="ident" id="5069090">nil</span>&nbsp;<span class="op" id="5069094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069098">return</span>&nbsp;<span class="ident" id="5069105">e</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069112">return</span>&nbsp;<span class="ident" id="5069119">nil</span><br>
<span class="lineno"></span><span class="op" id="5069123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="5069126">//&nbsp;TranslateRead&nbsp;translates&nbsp;the&nbsp;address&nbsp;and&nbsp;sets&nbsp;the&nbsp;use&nbsp;bit.</span><br>
<span class="lineno"></span><span class="keyword" id="5069188">func</span>&nbsp;<span class="op" id="5069193">(</span><span class="ident" id="5069194">pt</span>&nbsp;<span class="op" id="5069197">*</span><span class="ident" id="5069198">pageTable</span><span class="op" id="5069207">)</span>&nbsp;<span class="ident" id="5069209">TranslateRead</span><span class="op" id="5069222">(</span><span class="ident" id="5069223">addr</span>&nbsp;<span class="builtintype" id="5069228">uint32</span><span class="op" id="5069234">,</span>&nbsp;<span class="ident" id="5069236">ring</span>&nbsp;<span class="builtintype" id="5069241">byte</span><span class="op" id="5069245">)</span>&nbsp;<span class="op" id="5069247">(</span><span class="builtintype" id="5069248">uint32</span><span class="op" id="5069254">,</span>&nbsp;<span class="op" id="5069256">*</span><span class="ident" id="5069257">Excep</span><span class="op" id="5069262">)</span>&nbsp;<span class="op" id="5069264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069267">ret</span><span class="op" id="5069270">,</span>&nbsp;<span class="ident" id="5069272">e</span>&nbsp;<span class="op" id="5069274">:=</span>&nbsp;<span class="ident" id="5069277">pt</span><span class="op" id="5069279">.</span><span class="ident" id="5069280">Translate</span><span class="op" id="5069289">(</span><span class="ident" id="5069290">addr</span><span class="op" id="5069294">,</span>&nbsp;<span class="ident" id="5069296">ring</span><span class="op" id="5069300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069303">if</span>&nbsp;<span class="ident" id="5069306">e</span>&nbsp;<span class="op" id="5069308">!=</span>&nbsp;<span class="ident" id="5069311">nil</span>&nbsp;<span class="op" id="5069315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069319">return</span>&nbsp;<span class="num" id="5069326">0</span><span class="op" id="5069327">,</span>&nbsp;<span class="ident" id="5069329">e</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069336">pt</span><span class="op" id="5069338">.</span><span class="ident" id="5069339">pte1</span><span class="op" id="5069343">.</span><span class="ident" id="5069344">setBit</span><span class="op" id="5069350">(</span><span class="ident" id="5069351">pteUse</span><span class="op" id="5069357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069360">pt</span><span class="op" id="5069362">.</span><span class="ident" id="5069363">pte2</span><span class="op" id="5069367">.</span><span class="ident" id="5069368">setBit</span><span class="op" id="5069374">(</span><span class="ident" id="5069375">pteUse</span><span class="op" id="5069381">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069385">e</span>&nbsp;<span class="op" id="5069387">=</span>&nbsp;<span class="ident" id="5069389">pt</span><span class="op" id="5069391">.</span><span class="ident" id="5069392">updatePte</span><span class="op" id="5069401">(</span><span class="op" id="5069402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069405">if</span>&nbsp;<span class="ident" id="5069408">e</span>&nbsp;<span class="op" id="5069410">!=</span>&nbsp;<span class="ident" id="5069413">nil</span>&nbsp;<span class="op" id="5069417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069421">return</span>&nbsp;<span class="num" id="5069428">0</span><span class="op" id="5069429">,</span>&nbsp;<span class="ident" id="5069431">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069438">return</span>&nbsp;<span class="ident" id="5069445">ret</span><span class="op" id="5069448">,</span>&nbsp;<span class="ident" id="5069450">nil</span><br>
<span class="lineno"></span><span class="op" id="5069454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5069457">//&nbsp;TranslateWrite&nbsp;translates&nbsp;the&nbsp;address&nbsp;and&nbsp;sets&nbsp;the&nbsp;use&nbsp;and&nbsp;dirty&nbsp;bit</span><br>
<span class="lineno"></span><span class="keyword" id="5069529">func</span>&nbsp;<span class="op" id="5069534">(</span><span class="ident" id="5069535">pt</span>&nbsp;<span class="op" id="5069538">*</span><span class="ident" id="5069539">pageTable</span><span class="op" id="5069548">)</span>&nbsp;<span class="ident" id="5069550">TranslateWrite</span><span class="op" id="5069564">(</span><span class="ident" id="5069565">addr</span>&nbsp;<span class="builtintype" id="5069570">uint32</span><span class="op" id="5069576">,</span>&nbsp;<span class="ident" id="5069578">ring</span>&nbsp;<span class="builtintype" id="5069583">byte</span><span class="op" id="5069587">)</span>&nbsp;<span class="op" id="5069589">(</span><span class="builtintype" id="5069590">uint32</span><span class="op" id="5069596">,</span>&nbsp;<span class="op" id="5069598">*</span><span class="ident" id="5069599">Excep</span><span class="op" id="5069604">)</span>&nbsp;<span class="op" id="5069606">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069609">ret</span><span class="op" id="5069612">,</span>&nbsp;<span class="ident" id="5069614">e</span>&nbsp;<span class="op" id="5069616">:=</span>&nbsp;<span class="ident" id="5069619">pt</span><span class="op" id="5069621">.</span><span class="ident" id="5069622">Translate</span><span class="op" id="5069631">(</span><span class="ident" id="5069632">addr</span><span class="op" id="5069636">,</span>&nbsp;<span class="ident" id="5069638">ring</span><span class="op" id="5069642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069645">if</span>&nbsp;<span class="ident" id="5069648">e</span>&nbsp;<span class="op" id="5069650">!=</span>&nbsp;<span class="ident" id="5069653">nil</span>&nbsp;<span class="op" id="5069657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069661">return</span>&nbsp;<span class="num" id="5069668">0</span><span class="op" id="5069669">,</span>&nbsp;<span class="ident" id="5069671">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069678">if</span>&nbsp;<span class="ident" id="5069681">pt</span><span class="op" id="5069683">.</span><span class="ident" id="5069684">pte1</span><span class="op" id="5069688">.</span><span class="ident" id="5069689">testBit</span><span class="op" id="5069696">(</span><span class="ident" id="5069697">pteReadonly</span><span class="op" id="5069708">)</span>&nbsp;<span class="op" id="5069710">||</span>&nbsp;<span class="ident" id="5069713">pt</span><span class="op" id="5069715">.</span><span class="ident" id="5069716">pte2</span><span class="op" id="5069720">.</span><span class="ident" id="5069721">testBit</span><span class="op" id="5069728">(</span><span class="ident" id="5069729">pteReadonly</span><span class="op" id="5069740">)</span>&nbsp;<span class="op" id="5069742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069746">return</span>&nbsp;<span class="num" id="5069753">0</span><span class="op" id="5069754">,</span>&nbsp;<span class="ident" id="5069756">newPageReadonly</span><span class="op" id="5069771">(</span><span class="ident" id="5069772">addr</span><span class="op" id="5069776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069783">pt</span><span class="op" id="5069785">.</span><span class="ident" id="5069786">pte1</span><span class="op" id="5069790">.</span><span class="ident" id="5069791">setBit</span><span class="op" id="5069797">(</span><span class="ident" id="5069798">pteUse</span><span class="op" id="5069804">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069807">pt</span><span class="op" id="5069809">.</span><span class="ident" id="5069810">pte1</span><span class="op" id="5069814">.</span><span class="ident" id="5069815">setBit</span><span class="op" id="5069821">(</span><span class="ident" id="5069822">pteDirty</span><span class="op" id="5069830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069833">pt</span><span class="op" id="5069835">.</span><span class="ident" id="5069836">pte2</span><span class="op" id="5069840">.</span><span class="ident" id="5069841">setBit</span><span class="op" id="5069847">(</span><span class="ident" id="5069848">pteUse</span><span class="op" id="5069854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069857">pt</span><span class="op" id="5069859">.</span><span class="ident" id="5069860">pte2</span><span class="op" id="5069864">.</span><span class="ident" id="5069865">setBit</span><span class="op" id="5069871">(</span><span class="ident" id="5069872">pteDirty</span><span class="op" id="5069880">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069884">e</span>&nbsp;<span class="op" id="5069886">=</span>&nbsp;<span class="ident" id="5069888">pt</span><span class="op" id="5069890">.</span><span class="ident" id="5069891">updatePte</span><span class="op" id="5069900">(</span><span class="op" id="5069901">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069904">if</span>&nbsp;<span class="ident" id="5069907">e</span>&nbsp;<span class="op" id="5069909">!=</span>&nbsp;<span class="ident" id="5069912">nil</span>&nbsp;<span class="op" id="5069916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069920">return</span>&nbsp;<span class="num" id="5069927">0</span><span class="op" id="5069928">,</span>&nbsp;<span class="ident" id="5069930">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069937">return</span>&nbsp;<span class="ident" id="5069944">ret</span><span class="op" id="5069947">,</span>&nbsp;<span class="ident" id="5069949">nil</span><br>
<span class="lineno">160</span><span class="op" id="5069953">}</span>
</div>
</body>
</html>
