<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1139670">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1139725">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1139779">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1139830">package</span>&nbsp;<span class="ident" id="1139838">sync_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1139849">import</span>&nbsp;<span class="op" id="1139856">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1139859">.</span>&nbsp;<span class="string" id="1139861">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1139869">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1139884">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="1139894">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1139897">func</span>&nbsp;<span class="ident" id="1139902">testWaitGroup</span><span class="op" id="1139915">(</span><span class="ident" id="1139916">t</span>&nbsp;<span class="op" id="1139918">*</span><span class="ident" id="1139919">testing</span><span class="op" id="1139926">.</span><span class="ident" id="1139927">T</span><span class="op" id="1139928">,</span>&nbsp;<span class="ident" id="1139930">wg1</span>&nbsp;<span class="op" id="1139934">*</span><span class="ident" id="1139935">WaitGroup</span><span class="op" id="1139944">,</span>&nbsp;<span class="ident" id="1139946">wg2</span>&nbsp;<span class="op" id="1139950">*</span><span class="ident" id="1139951">WaitGroup</span><span class="op" id="1139960">)</span>&nbsp;<span class="op" id="1139962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1139965">n</span>&nbsp;<span class="op" id="1139967">:=</span>&nbsp;<span class="num" id="1139970">16</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1139974">wg1</span><span class="op" id="1139977">.</span><span class="ident" id="1139978">Add</span><span class="op" id="1139981">(</span><span class="ident" id="1139982">n</span><span class="op" id="1139983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1139986">wg2</span><span class="op" id="1139989">.</span><span class="ident" id="1139990">Add</span><span class="op" id="1139993">(</span><span class="ident" id="1139994">n</span><span class="op" id="1139995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1139998">exited</span>&nbsp;<span class="op" id="1140005">:=</span>&nbsp;<span class="builtinfunc" id="1140008">make</span><span class="op" id="1140012">(</span><span class="keyword" id="1140013">chan</span>&nbsp;<span class="builtintype" id="1140018">bool</span><span class="op" id="1140022">,</span>&nbsp;<span class="ident" id="1140024">n</span><span class="op" id="1140025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1140028">for</span>&nbsp;<span class="ident" id="1140032">i</span>&nbsp;<span class="op" id="1140034">:=</span>&nbsp;<span class="num" id="1140037">0</span><span class="op" id="1140038">;</span>&nbsp;<span class="ident" id="1140040">i</span>&nbsp;<span class="op" id="1140042">!=</span>&nbsp;<span class="ident" id="1140045">n</span><span class="op" id="1140046">;</span>&nbsp;<span class="ident" id="1140048">i</span><span class="op" id="1140049">++</span>&nbsp;<span class="op" id="1140052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1140056">go</span>&nbsp;<span class="keyword" id="1140059">func</span><span class="op" id="1140063">(</span><span class="ident" id="1140064">i</span>&nbsp;<span class="builtintype" id="1140066">int</span><span class="op" id="1140069">)</span>&nbsp;<span class="op" id="1140071">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140076">wg1</span><span class="op" id="1140079">.</span><span class="ident" id="1140080">Done</span><span class="op" id="1140084">(</span><span class="op" id="1140085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140090">wg2</span><span class="op" id="1140093">.</span><span class="ident" id="1140094">Wait</span><span class="op" id="1140098">(</span><span class="op" id="1140099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140104">exited</span>&nbsp;<span class="op" id="1140111">&lt;-</span>&nbsp;<span class="builtintype" id="1140114">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1140121">}</span><span class="op" id="1140122">(</span><span class="ident" id="1140123">i</span><span class="op" id="1140124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1140127">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140130">wg1</span><span class="op" id="1140133">.</span><span class="ident" id="1140134">Wait</span><span class="op" id="1140138">(</span><span class="op" id="1140139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1140142">for</span>&nbsp;<span class="ident" id="1140146">i</span>&nbsp;<span class="op" id="1140148">:=</span>&nbsp;<span class="num" id="1140151">0</span><span class="op" id="1140152">;</span>&nbsp;<span class="ident" id="1140154">i</span>&nbsp;<span class="op" id="1140156">!=</span>&nbsp;<span class="ident" id="1140159">n</span><span class="op" id="1140160">;</span>&nbsp;<span class="ident" id="1140162">i</span><span class="op" id="1140163">++</span>&nbsp;<span class="op" id="1140166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1140170">select</span>&nbsp;<span class="op" id="1140177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1140181">case</span>&nbsp;<span class="op" id="1140186">&lt;-</span><span class="ident" id="1140188">exited</span><span class="op" id="1140194">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140199">t</span><span class="op" id="1140200">.</span><span class="ident" id="1140201">Fatal</span><span class="op" id="1140206">(</span><span class="string" id="1140207">&#34;WaitGroup&nbsp;released&nbsp;group&nbsp;too&nbsp;soon&#34;</span><span class="op" id="1140242">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1140246">default</span><span class="op" id="1140253">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1140257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140261">wg2</span><span class="op" id="1140264">.</span><span class="ident" id="1140265">Done</span><span class="op" id="1140269">(</span><span class="op" id="1140270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1140273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1140276">for</span>&nbsp;<span class="ident" id="1140280">i</span>&nbsp;<span class="op" id="1140282">:=</span>&nbsp;<span class="num" id="1140285">0</span><span class="op" id="1140286">;</span>&nbsp;<span class="ident" id="1140288">i</span>&nbsp;<span class="op" id="1140290">!=</span>&nbsp;<span class="ident" id="1140293">n</span><span class="op" id="1140294">;</span>&nbsp;<span class="ident" id="1140296">i</span><span class="op" id="1140297">++</span>&nbsp;<span class="op" id="1140300">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1140304">&lt;-</span><span class="ident" id="1140306">exited</span>&nbsp;<span class="comment" id="1140313">//&nbsp;Will&nbsp;block&nbsp;if&nbsp;barrier&nbsp;fails&nbsp;to&nbsp;unlock&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1140364">}</span><br>
<span class="lineno"></span><span class="op" id="1140366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1140369">func</span>&nbsp;<span class="ident" id="1140374">TestWaitGroup</span><span class="op" id="1140387">(</span><span class="ident" id="1140388">t</span>&nbsp;<span class="op" id="1140390">*</span><span class="ident" id="1140391">testing</span><span class="op" id="1140398">.</span><span class="ident" id="1140399">T</span><span class="op" id="1140400">)</span>&nbsp;<span class="op" id="1140402">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140405">wg1</span>&nbsp;<span class="op" id="1140409">:=</span>&nbsp;<span class="op" id="1140412">&amp;</span><span class="ident" id="1140413">WaitGroup</span><span class="op" id="1140422">{</span><span class="op" id="1140423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140426">wg2</span>&nbsp;<span class="op" id="1140430">:=</span>&nbsp;<span class="op" id="1140433">&amp;</span><span class="ident" id="1140434">WaitGroup</span><span class="op" id="1140443">{</span><span class="op" id="1140444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1140448">//&nbsp;Run&nbsp;the&nbsp;same&nbsp;test&nbsp;a&nbsp;few&nbsp;times&nbsp;to&nbsp;ensure&nbsp;barrier&nbsp;is&nbsp;in&nbsp;a&nbsp;proper&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1140522">for</span>&nbsp;<span class="ident" id="1140526">i</span>&nbsp;<span class="op" id="1140528">:=</span>&nbsp;<span class="num" id="1140531">0</span><span class="op" id="1140532">;</span>&nbsp;<span class="ident" id="1140534">i</span>&nbsp;<span class="op" id="1140536">!=</span>&nbsp;<span class="num" id="1140539">8</span><span class="op" id="1140540">;</span>&nbsp;<span class="ident" id="1140542">i</span><span class="op" id="1140543">++</span>&nbsp;<span class="op" id="1140546">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140550">testWaitGroup</span><span class="op" id="1140563">(</span><span class="ident" id="1140564">t</span><span class="op" id="1140565">,</span>&nbsp;<span class="ident" id="1140567">wg1</span><span class="op" id="1140570">,</span>&nbsp;<span class="ident" id="1140572">wg2</span><span class="op" id="1140575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1140578">}</span><br>
<span class="lineno"></span><span class="op" id="1140580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1140583">func</span>&nbsp;<span class="ident" id="1140588">TestWaitGroupMisuse</span><span class="op" id="1140607">(</span><span class="ident" id="1140608">t</span>&nbsp;<span class="op" id="1140610">*</span><span class="ident" id="1140611">testing</span><span class="op" id="1140618">.</span><span class="ident" id="1140619">T</span><span class="op" id="1140620">)</span>&nbsp;<span class="op" id="1140622">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1140625">defer</span>&nbsp;<span class="keyword" id="1140631">func</span><span class="op" id="1140635">(</span><span class="op" id="1140636">)</span>&nbsp;<span class="op" id="1140638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140642">err</span>&nbsp;<span class="op" id="1140646">:=</span>&nbsp;<span class="builtinfunc" id="1140649">recover</span><span class="op" id="1140656">(</span><span class="op" id="1140657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1140661">if</span>&nbsp;<span class="ident" id="1140664">err</span>&nbsp;<span class="op" id="1140668">!=</span>&nbsp;<span class="string" id="1140671">&#34;sync:&nbsp;negative&nbsp;WaitGroup&nbsp;counter&#34;</span>&nbsp;<span class="op" id="1140706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140711">t</span><span class="op" id="1140712">.</span><span class="ident" id="1140713">Fatalf</span><span class="op" id="1140719">(</span><span class="string" id="1140720">&#34;Unexpected&nbsp;panic:&nbsp;%#v&#34;</span><span class="op" id="1140743">,</span>&nbsp;<span class="ident" id="1140745">err</span><span class="op" id="1140748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1140752">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1140755">}</span><span class="op" id="1140756">(</span><span class="op" id="1140757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140760">wg</span>&nbsp;<span class="op" id="1140763">:=</span>&nbsp;<span class="op" id="1140766">&amp;</span><span class="ident" id="1140767">WaitGroup</span><span class="op" id="1140776">{</span><span class="op" id="1140777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140780">wg</span><span class="op" id="1140782">.</span><span class="ident" id="1140783">Add</span><span class="op" id="1140786">(</span><span class="num" id="1140787">1</span><span class="op" id="1140788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140791">wg</span><span class="op" id="1140793">.</span><span class="ident" id="1140794">Done</span><span class="op" id="1140798">(</span><span class="op" id="1140799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140802">wg</span><span class="op" id="1140804">.</span><span class="ident" id="1140805">Done</span><span class="op" id="1140809">(</span><span class="op" id="1140810">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140813">t</span><span class="op" id="1140814">.</span><span class="ident" id="1140815">Fatal</span><span class="op" id="1140820">(</span><span class="string" id="1140821">&#34;Should&nbsp;panic&#34;</span><span class="op" id="1140835">)</span><br>
<span class="lineno"></span><span class="op" id="1140837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1140840">func</span>&nbsp;<span class="ident" id="1140845">TestWaitGroupRace</span><span class="op" id="1140862">(</span><span class="ident" id="1140863">t</span>&nbsp;<span class="op" id="1140865">*</span><span class="ident" id="1140866">testing</span><span class="op" id="1140873">.</span><span class="ident" id="1140874">T</span><span class="op" id="1140875">)</span>&nbsp;<span class="op" id="1140877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1140880">//&nbsp;Run&nbsp;this&nbsp;test&nbsp;for&nbsp;about&nbsp;1ms.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1140913">for</span>&nbsp;<span class="ident" id="1140917">i</span>&nbsp;<span class="op" id="1140919">:=</span>&nbsp;<span class="num" id="1140922">0</span><span class="op" id="1140923">;</span>&nbsp;<span class="ident" id="1140925">i</span>&nbsp;<span class="op" id="1140927">&lt;</span>&nbsp;<span class="num" id="1140929">1000</span><span class="op" id="1140933">;</span>&nbsp;<span class="ident" id="1140935">i</span><span class="op" id="1140936">++</span>&nbsp;<span class="op" id="1140939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140943">wg</span>&nbsp;<span class="op" id="1140946">:=</span>&nbsp;<span class="op" id="1140949">&amp;</span><span class="ident" id="1140950">WaitGroup</span><span class="op" id="1140959">{</span><span class="op" id="1140960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1140964">n</span>&nbsp;<span class="op" id="1140966">:=</span>&nbsp;<span class="builtinfunc" id="1140969">new</span><span class="op" id="1140972">(</span><span class="builtintype" id="1140973">int32</span><span class="op" id="1140978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1140982">//&nbsp;spawn&nbsp;goroutine&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141005">wg</span><span class="op" id="1141007">.</span><span class="ident" id="1141008">Add</span><span class="op" id="1141011">(</span><span class="num" id="1141012">1</span><span class="op" id="1141013">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1141017">go</span>&nbsp;<span class="keyword" id="1141020">func</span><span class="op" id="1141024">(</span><span class="op" id="1141025">)</span>&nbsp;<span class="op" id="1141027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141032">atomic</span><span class="op" id="1141038">.</span><span class="ident" id="1141039">AddInt32</span><span class="op" id="1141047">(</span><span class="ident" id="1141048">n</span><span class="op" id="1141049">,</span>&nbsp;<span class="num" id="1141051">1</span><span class="op" id="1141052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141057">wg</span><span class="op" id="1141059">.</span><span class="ident" id="1141060">Done</span><span class="op" id="1141064">(</span><span class="op" id="1141065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1141069">}</span><span class="op" id="1141070">(</span><span class="op" id="1141071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1141075">//&nbsp;spawn&nbsp;goroutine&nbsp;2</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141098">wg</span><span class="op" id="1141100">.</span><span class="ident" id="1141101">Add</span><span class="op" id="1141104">(</span><span class="num" id="1141105">1</span><span class="op" id="1141106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1141110">go</span>&nbsp;<span class="keyword" id="1141113">func</span><span class="op" id="1141117">(</span><span class="op" id="1141118">)</span>&nbsp;<span class="op" id="1141120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141125">atomic</span><span class="op" id="1141131">.</span><span class="ident" id="1141132">AddInt32</span><span class="op" id="1141140">(</span><span class="ident" id="1141141">n</span><span class="op" id="1141142">,</span>&nbsp;<span class="num" id="1141144">1</span><span class="op" id="1141145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141150">wg</span><span class="op" id="1141152">.</span><span class="ident" id="1141153">Done</span><span class="op" id="1141157">(</span><span class="op" id="1141158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1141162">}</span><span class="op" id="1141163">(</span><span class="op" id="1141164">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1141168">//&nbsp;Wait&nbsp;for&nbsp;goroutine&nbsp;1&nbsp;and&nbsp;2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141200">wg</span><span class="op" id="1141202">.</span><span class="ident" id="1141203">Wait</span><span class="op" id="1141207">(</span><span class="op" id="1141208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1141212">if</span>&nbsp;<span class="ident" id="1141215">atomic</span><span class="op" id="1141221">.</span><span class="ident" id="1141222">LoadInt32</span><span class="op" id="1141231">(</span><span class="ident" id="1141232">n</span><span class="op" id="1141233">)</span>&nbsp;<span class="op" id="1141235">!=</span>&nbsp;<span class="num" id="1141238">2</span>&nbsp;<span class="op" id="1141240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141245">t</span><span class="op" id="1141246">.</span><span class="ident" id="1141247">Fatal</span><span class="op" id="1141252">(</span><span class="string" id="1141253">&#34;Spurious&nbsp;wakeup&nbsp;from&nbsp;Wait&#34;</span><span class="op" id="1141280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1141284">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1141287">}</span><br>
<span class="lineno"></span><span class="op" id="1141289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1141292">func</span>&nbsp;<span class="ident" id="1141297">BenchmarkWaitGroupUncontended</span><span class="op" id="1141326">(</span><span class="ident" id="1141327">b</span>&nbsp;<span class="op" id="1141329">*</span><span class="ident" id="1141330">testing</span><span class="op" id="1141337">.</span><span class="ident" id="1141338">B</span><span class="op" id="1141339">)</span>&nbsp;<span class="op" id="1141341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1141344">type</span>&nbsp;<span class="ident" id="1141349">PaddedWaitGroup</span>&nbsp;<span class="keyword" id="1141365">struct</span>&nbsp;<span class="op" id="1141372">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141376">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141388">pad</span>&nbsp;<span class="op" id="1141392">[</span><span class="num" id="1141393">128</span><span class="op" id="1141396">]</span><span class="builtintype" id="1141397">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1141404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141407">b</span><span class="op" id="1141408">.</span><span class="ident" id="1141409">RunParallel</span><span class="op" id="1141420">(</span><span class="keyword" id="1141421">func</span><span class="op" id="1141425">(</span><span class="ident" id="1141426">pb</span>&nbsp;<span class="op" id="1141429">*</span><span class="ident" id="1141430">testing</span><span class="op" id="1141437">.</span><span class="ident" id="1141438">PB</span><span class="op" id="1141440">)</span>&nbsp;<span class="op" id="1141442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1141446">var</span>&nbsp;<span class="ident" id="1141450">wg</span>&nbsp;<span class="ident" id="1141453">PaddedWaitGroup</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1141471">for</span>&nbsp;<span class="ident" id="1141475">pb</span><span class="op" id="1141477">.</span><span class="ident" id="1141478">Next</span><span class="op" id="1141482">(</span><span class="op" id="1141483">)</span>&nbsp;<span class="op" id="1141485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141490">wg</span><span class="op" id="1141492">.</span><span class="ident" id="1141493">Add</span><span class="op" id="1141496">(</span><span class="num" id="1141497">1</span><span class="op" id="1141498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141503">wg</span><span class="op" id="1141505">.</span><span class="ident" id="1141506">Done</span><span class="op" id="1141510">(</span><span class="op" id="1141511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141516">wg</span><span class="op" id="1141518">.</span><span class="ident" id="1141519">Wait</span><span class="op" id="1141523">(</span><span class="op" id="1141524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1141528">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1141531">}</span><span class="op" id="1141532">)</span><br>
<span class="lineno"></span><span class="op" id="1141534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1141537">func</span>&nbsp;<span class="ident" id="1141542">benchmarkWaitGroupAddDone</span><span class="op" id="1141567">(</span><span class="ident" id="1141568">b</span>&nbsp;<span class="op" id="1141570">*</span><span class="ident" id="1141571">testing</span><span class="op" id="1141578">.</span><span class="ident" id="1141579">B</span><span class="op" id="1141580">,</span>&nbsp;<span class="ident" id="1141582">localWork</span>&nbsp;<span class="builtintype" id="1141592">int</span><span class="op" id="1141595">)</span>&nbsp;<span class="op" id="1141597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1141600">var</span>&nbsp;<span class="ident" id="1141604">wg</span>&nbsp;<span class="ident" id="1141607">WaitGroup</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141618">b</span><span class="op" id="1141619">.</span><span class="ident" id="1141620">RunParallel</span><span class="op" id="1141631">(</span><span class="keyword" id="1141632">func</span><span class="op" id="1141636">(</span><span class="ident" id="1141637">pb</span>&nbsp;<span class="op" id="1141640">*</span><span class="ident" id="1141641">testing</span><span class="op" id="1141648">.</span><span class="ident" id="1141649">PB</span><span class="op" id="1141651">)</span>&nbsp;<span class="op" id="1141653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141657">foo</span>&nbsp;<span class="op" id="1141661">:=</span>&nbsp;<span class="num" id="1141664">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1141668">for</span>&nbsp;<span class="ident" id="1141672">pb</span><span class="op" id="1141674">.</span><span class="ident" id="1141675">Next</span><span class="op" id="1141679">(</span><span class="op" id="1141680">)</span>&nbsp;<span class="op" id="1141682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141687">wg</span><span class="op" id="1141689">.</span><span class="ident" id="1141690">Add</span><span class="op" id="1141693">(</span><span class="num" id="1141694">1</span><span class="op" id="1141695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1141700">for</span>&nbsp;<span class="ident" id="1141704">i</span>&nbsp;<span class="op" id="1141706">:=</span>&nbsp;<span class="num" id="1141709">0</span><span class="op" id="1141710">;</span>&nbsp;<span class="ident" id="1141712">i</span>&nbsp;<span class="op" id="1141714">&lt;</span>&nbsp;<span class="ident" id="1141716">localWork</span><span class="op" id="1141725">;</span>&nbsp;<span class="ident" id="1141727">i</span><span class="op" id="1141728">++</span>&nbsp;<span class="op" id="1141731">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141737">foo</span>&nbsp;<span class="op" id="1141741">*=</span>&nbsp;<span class="num" id="1141744">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141750">foo</span>&nbsp;<span class="op" id="1141754">/=</span>&nbsp;<span class="num" id="1141757">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1141762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141767">wg</span><span class="op" id="1141769">.</span><span class="ident" id="1141770">Done</span><span class="op" id="1141774">(</span><span class="op" id="1141775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1141779">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141783">_</span>&nbsp;<span class="op" id="1141785">=</span>&nbsp;<span class="ident" id="1141787">foo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1141792">}</span><span class="op" id="1141793">)</span><br>
<span class="lineno"></span><span class="op" id="1141795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1141798">func</span>&nbsp;<span class="ident" id="1141803">BenchmarkWaitGroupAddDone</span><span class="op" id="1141828">(</span><span class="ident" id="1141829">b</span>&nbsp;<span class="op" id="1141831">*</span><span class="ident" id="1141832">testing</span><span class="op" id="1141839">.</span><span class="ident" id="1141840">B</span><span class="op" id="1141841">)</span>&nbsp;<span class="op" id="1141843">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141846">benchmarkWaitGroupAddDone</span><span class="op" id="1141871">(</span><span class="ident" id="1141872">b</span><span class="op" id="1141873">,</span>&nbsp;<span class="num" id="1141875">0</span><span class="op" id="1141876">)</span><br>
<span class="lineno"></span><span class="op" id="1141878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1141881">func</span>&nbsp;<span class="ident" id="1141886">BenchmarkWaitGroupAddDoneWork</span><span class="op" id="1141915">(</span><span class="ident" id="1141916">b</span>&nbsp;<span class="op" id="1141918">*</span><span class="ident" id="1141919">testing</span><span class="op" id="1141926">.</span><span class="ident" id="1141927">B</span><span class="op" id="1141928">)</span>&nbsp;<span class="op" id="1141930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1141933">benchmarkWaitGroupAddDone</span><span class="op" id="1141958">(</span><span class="ident" id="1141959">b</span><span class="op" id="1141960">,</span>&nbsp;<span class="num" id="1141962">100</span><span class="op" id="1141965">)</span><br>
<span class="lineno">125</span><span class="op" id="1141967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1141970">func</span>&nbsp;<span class="ident" id="1141975">benchmarkWaitGroupWait</span><span class="op" id="1141997">(</span><span class="ident" id="1141998">b</span>&nbsp;<span class="op" id="1142000">*</span><span class="ident" id="1142001">testing</span><span class="op" id="1142008">.</span><span class="ident" id="1142009">B</span><span class="op" id="1142010">,</span>&nbsp;<span class="ident" id="1142012">localWork</span>&nbsp;<span class="builtintype" id="1142022">int</span><span class="op" id="1142025">)</span>&nbsp;<span class="op" id="1142027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1142030">var</span>&nbsp;<span class="ident" id="1142034">wg</span>&nbsp;<span class="ident" id="1142037">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1142048">b</span><span class="op" id="1142049">.</span><span class="ident" id="1142050">RunParallel</span><span class="op" id="1142061">(</span><span class="keyword" id="1142062">func</span><span class="op" id="1142066">(</span><span class="ident" id="1142067">pb</span>&nbsp;<span class="op" id="1142070">*</span><span class="ident" id="1142071">testing</span><span class="op" id="1142078">.</span><span class="ident" id="1142079">PB</span><span class="op" id="1142081">)</span>&nbsp;<span class="op" id="1142083">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1142087">foo</span>&nbsp;<span class="op" id="1142091">:=</span>&nbsp;<span class="num" id="1142094">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1142098">for</span>&nbsp;<span class="ident" id="1142102">pb</span><span class="op" id="1142104">.</span><span class="ident" id="1142105">Next</span><span class="op" id="1142109">(</span><span class="op" id="1142110">)</span>&nbsp;<span class="op" id="1142112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1142117">wg</span><span class="op" id="1142119">.</span><span class="ident" id="1142120">Wait</span><span class="op" id="1142124">(</span><span class="op" id="1142125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1142130">for</span>&nbsp;<span class="ident" id="1142134">i</span>&nbsp;<span class="op" id="1142136">:=</span>&nbsp;<span class="num" id="1142139">0</span><span class="op" id="1142140">;</span>&nbsp;<span class="ident" id="1142142">i</span>&nbsp;<span class="op" id="1142144">&lt;</span>&nbsp;<span class="ident" id="1142146">localWork</span><span class="op" id="1142155">;</span>&nbsp;<span class="ident" id="1142157">i</span><span class="op" id="1142158">++</span>&nbsp;<span class="op" id="1142161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1142167">foo</span>&nbsp;<span class="op" id="1142171">*=</span>&nbsp;<span class="num" id="1142174">2</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1142180">foo</span>&nbsp;<span class="op" id="1142184">/=</span>&nbsp;<span class="num" id="1142187">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1142192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1142196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1142200">_</span>&nbsp;<span class="op" id="1142202">=</span>&nbsp;<span class="ident" id="1142204">foo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1142209">}</span><span class="op" id="1142210">)</span><br>
<span class="lineno">140</span><span class="op" id="1142212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1142215">func</span>&nbsp;<span class="ident" id="1142220">BenchmarkWaitGroupWait</span><span class="op" id="1142242">(</span><span class="ident" id="1142243">b</span>&nbsp;<span class="op" id="1142245">*</span><span class="ident" id="1142246">testing</span><span class="op" id="1142253">.</span><span class="ident" id="1142254">B</span><span class="op" id="1142255">)</span>&nbsp;<span class="op" id="1142257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1142260">benchmarkWaitGroupWait</span><span class="op" id="1142282">(</span><span class="ident" id="1142283">b</span><span class="op" id="1142284">,</span>&nbsp;<span class="num" id="1142286">0</span><span class="op" id="1142287">)</span><br>
<span class="lineno"></span><span class="op" id="1142289">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="1142292">func</span>&nbsp;<span class="ident" id="1142297">BenchmarkWaitGroupWaitWork</span><span class="op" id="1142323">(</span><span class="ident" id="1142324">b</span>&nbsp;<span class="op" id="1142326">*</span><span class="ident" id="1142327">testing</span><span class="op" id="1142334">.</span><span class="ident" id="1142335">B</span><span class="op" id="1142336">)</span>&nbsp;<span class="op" id="1142338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1142341">benchmarkWaitGroupWait</span><span class="op" id="1142363">(</span><span class="ident" id="1142364">b</span><span class="op" id="1142365">,</span>&nbsp;<span class="num" id="1142367">100</span><span class="op" id="1142370">)</span><br>
<span class="lineno"></span><span class="op" id="1142372">}</span>
</div>
</body>
</html>
