<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/pem</h2>
<ul>
<li><a href="/gostd/encoding/pem/pem.go.html">pem.go</a></li>
<li><a href="/gostd/encoding/pem/pem_test.go.html">pem_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4325536">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4325591">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4325645">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4325696">//&nbsp;Package&nbsp;pem&nbsp;implements&nbsp;the&nbsp;PEM&nbsp;data&nbsp;encoding,&nbsp;which&nbsp;originated&nbsp;in&nbsp;Privacy</span><br>
<span class="lineno"></span><span class="comment" id="4325773">//&nbsp;Enhanced&nbsp;Mail.&nbsp;The&nbsp;most&nbsp;common&nbsp;use&nbsp;of&nbsp;PEM&nbsp;encoding&nbsp;today&nbsp;is&nbsp;in&nbsp;TLS&nbsp;keys&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4325852">//&nbsp;certificates.&nbsp;See&nbsp;RFC&nbsp;1421.</span><br>
<span class="lineno"></span><span class="keyword" id="4325883">package</span>&nbsp;<span class="ident" id="4325891">pem</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="4325896">import</span>&nbsp;<span class="op" id="4325903">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4325906">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4325915">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4325934">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4325940">&#34;sort&#34;</span><br>
<span class="lineno">15</span><span class="op" id="4325947">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4325950">//&nbsp;A&nbsp;Block&nbsp;represents&nbsp;a&nbsp;PEM&nbsp;encoded&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="4325997">//</span><br>
<span class="lineno"></span><span class="comment" id="4326000">//&nbsp;The&nbsp;encoded&nbsp;form&nbsp;is:</span><br>
<span class="lineno">20</span><span class="comment" id="4326024">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;Type-----</span><br>
<span class="lineno"></span><span class="comment" id="4326051">//&nbsp;&nbsp;&nbsp;&nbsp;Headers</span><br>
<span class="lineno"></span><span class="comment" id="4326065">//&nbsp;&nbsp;&nbsp;&nbsp;base64-encoded&nbsp;Bytes</span><br>
<span class="lineno"></span><span class="comment" id="4326092">//&nbsp;&nbsp;&nbsp;&nbsp;-----END&nbsp;Type-----</span><br>
<span class="lineno"></span><span class="comment" id="4326117">//&nbsp;where&nbsp;Headers&nbsp;is&nbsp;a&nbsp;possibly&nbsp;empty&nbsp;sequence&nbsp;of&nbsp;Key:&nbsp;Value&nbsp;lines.</span><br>
<span class="lineno">25</span><span class="keyword" id="4326184">type</span>&nbsp;<span class="ident" id="4326189">Block</span>&nbsp;<span class="keyword" id="4326195">struct</span>&nbsp;<span class="op" id="4326202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4326205">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4326213">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4326231">//&nbsp;The&nbsp;type,&nbsp;taken&nbsp;from&nbsp;the&nbsp;preamble&nbsp;(i.e.&nbsp;&#34;RSA&nbsp;PRIVATE&nbsp;KEY&#34;).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4326295">Headers</span>&nbsp;<span class="keyword" id="4326303">map</span><span class="op" id="4326306">[</span><span class="builtintype" id="4326307">string</span><span class="op" id="4326313">]</span><span class="builtintype" id="4326314">string</span>&nbsp;<span class="comment" id="4326321">//&nbsp;Optional&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4326343">Bytes</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4326351">[</span><span class="op" id="4326352">]</span><span class="builtintype" id="4326353">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4326369">//&nbsp;The&nbsp;decoded&nbsp;bytes&nbsp;of&nbsp;the&nbsp;contents.&nbsp;Typically&nbsp;a&nbsp;DER&nbsp;encoded&nbsp;ASN.1&nbsp;structure.</span><br>
<span class="lineno"></span><span class="op" id="4326448">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="4326451">//&nbsp;getLine&nbsp;results&nbsp;the&nbsp;first&nbsp;\r\n&nbsp;or&nbsp;\n&nbsp;delineated&nbsp;line&nbsp;from&nbsp;the&nbsp;given&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="4326527">//&nbsp;array.&nbsp;The&nbsp;line&nbsp;does&nbsp;not&nbsp;include&nbsp;trailing&nbsp;whitespace&nbsp;or&nbsp;the&nbsp;trailing&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4326603">//&nbsp;line&nbsp;bytes.&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;byte&nbsp;array&nbsp;(also&nbsp;not&nbsp;including&nbsp;the&nbsp;new&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="4326683">//&nbsp;bytes)&nbsp;is&nbsp;also&nbsp;returned&nbsp;and&nbsp;this&nbsp;will&nbsp;always&nbsp;be&nbsp;smaller&nbsp;than&nbsp;the&nbsp;original</span><br>
<span class="lineno">35</span><span class="comment" id="4326760">//&nbsp;argument.</span><br>
<span class="lineno"></span><span class="keyword" id="4326773">func</span>&nbsp;<span class="ident" id="4326778">getLine</span><span class="op" id="4326785">(</span><span class="ident" id="4326786">data</span>&nbsp;<span class="op" id="4326791">[</span><span class="op" id="4326792">]</span><span class="builtintype" id="4326793">byte</span><span class="op" id="4326797">)</span>&nbsp;<span class="op" id="4326799">(</span><span class="ident" id="4326800">line</span><span class="op" id="4326804">,</span>&nbsp;<span class="ident" id="4326806">rest</span>&nbsp;<span class="op" id="4326811">[</span><span class="op" id="4326812">]</span><span class="builtintype" id="4326813">byte</span><span class="op" id="4326817">)</span>&nbsp;<span class="op" id="4326819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4326822">i</span>&nbsp;<span class="op" id="4326824">:=</span>&nbsp;<span class="ident" id="4326827">bytes</span><span class="op" id="4326832">.</span><span class="ident" id="4326833">Index</span><span class="op" id="4326838">(</span><span class="ident" id="4326839">data</span><span class="op" id="4326843">,</span>&nbsp;<span class="op" id="4326845">[</span><span class="op" id="4326846">]</span><span class="builtintype" id="4326847">byte</span><span class="op" id="4326851">{</span><span class="string" id="4326852">&#39;\n&#39;</span><span class="op" id="4326856">}</span><span class="op" id="4326857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4326860">var</span>&nbsp;<span class="ident" id="4326864">j</span>&nbsp;<span class="builtintype" id="4326866">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4326871">if</span>&nbsp;<span class="ident" id="4326874">i</span>&nbsp;<span class="op" id="4326876">&lt;</span>&nbsp;<span class="num" id="4326878">0</span>&nbsp;<span class="op" id="4326880">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4326884">i</span>&nbsp;<span class="op" id="4326886">=</span>&nbsp;<span class="builtinfunc" id="4326888">len</span><span class="op" id="4326891">(</span><span class="ident" id="4326892">data</span><span class="op" id="4326896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4326900">j</span>&nbsp;<span class="op" id="4326902">=</span>&nbsp;<span class="ident" id="4326904">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4326907">}</span>&nbsp;<span class="keyword" id="4326909">else</span>&nbsp;<span class="op" id="4326914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4326918">j</span>&nbsp;<span class="op" id="4326920">=</span>&nbsp;<span class="ident" id="4326922">i</span>&nbsp;<span class="op" id="4326924">+</span>&nbsp;<span class="num" id="4326926">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4326930">if</span>&nbsp;<span class="ident" id="4326933">i</span>&nbsp;<span class="op" id="4326935">&gt;</span>&nbsp;<span class="num" id="4326937">0</span>&nbsp;<span class="op" id="4326939">&amp;&amp;</span>&nbsp;<span class="ident" id="4326942">data</span><span class="op" id="4326946">[</span><span class="ident" id="4326947">i</span><span class="op" id="4326948">-</span><span class="num" id="4326949">1</span><span class="op" id="4326950">]</span>&nbsp;<span class="op" id="4326952">==</span>&nbsp;<span class="string" id="4326955">&#39;\r&#39;</span>&nbsp;<span class="op" id="4326960">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4326965">i</span><span class="op" id="4326966">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4326971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4326974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4326977">return</span>&nbsp;<span class="ident" id="4326984">bytes</span><span class="op" id="4326989">.</span><span class="ident" id="4326990">TrimRight</span><span class="op" id="4326999">(</span><span class="ident" id="4327000">data</span><span class="op" id="4327004">[</span><span class="num" id="4327005">0</span><span class="op" id="4327006">:</span><span class="ident" id="4327007">i</span><span class="op" id="4327008">]</span><span class="op" id="4327009">,</span>&nbsp;<span class="string" id="4327011">&#34;&nbsp;\t&#34;</span><span class="op" id="4327016">)</span><span class="op" id="4327017">,</span>&nbsp;<span class="ident" id="4327019">data</span><span class="op" id="4327023">[</span><span class="ident" id="4327024">j</span><span class="op" id="4327025">:</span><span class="op" id="4327026">]</span><br>
<span class="lineno"></span><span class="op" id="4327028">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="4327031">//&nbsp;removeWhitespace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;its&nbsp;input&nbsp;with&nbsp;all&nbsp;spaces,&nbsp;tab&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4327104">//&nbsp;newline&nbsp;characters&nbsp;removed.</span><br>
<span class="lineno"></span><span class="keyword" id="4327135">func</span>&nbsp;<span class="ident" id="4327140">removeWhitespace</span><span class="op" id="4327156">(</span><span class="ident" id="4327157">data</span>&nbsp;<span class="op" id="4327162">[</span><span class="op" id="4327163">]</span><span class="builtintype" id="4327164">byte</span><span class="op" id="4327168">)</span>&nbsp;<span class="op" id="4327170">[</span><span class="op" id="4327171">]</span><span class="builtintype" id="4327172">byte</span>&nbsp;<span class="op" id="4327177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327180">result</span>&nbsp;<span class="op" id="4327187">:=</span>&nbsp;<span class="builtinfunc" id="4327190">make</span><span class="op" id="4327194">(</span><span class="op" id="4327195">[</span><span class="op" id="4327196">]</span><span class="builtintype" id="4327197">byte</span><span class="op" id="4327201">,</span>&nbsp;<span class="builtinfunc" id="4327203">len</span><span class="op" id="4327206">(</span><span class="ident" id="4327207">data</span><span class="op" id="4327211">)</span><span class="op" id="4327212">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327215">n</span>&nbsp;<span class="op" id="4327217">:=</span>&nbsp;<span class="num" id="4327220">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327224">for</span>&nbsp;<span class="ident" id="4327228">_</span><span class="op" id="4327229">,</span>&nbsp;<span class="ident" id="4327231">b</span>&nbsp;<span class="op" id="4327233">:=</span>&nbsp;<span class="keyword" id="4327236">range</span>&nbsp;<span class="ident" id="4327242">data</span>&nbsp;<span class="op" id="4327247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327251">if</span>&nbsp;<span class="ident" id="4327254">b</span>&nbsp;<span class="op" id="4327256">==</span>&nbsp;<span class="string" id="4327259">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4327263">||</span>&nbsp;<span class="ident" id="4327266">b</span>&nbsp;<span class="op" id="4327268">==</span>&nbsp;<span class="string" id="4327271">&#39;\t&#39;</span>&nbsp;<span class="op" id="4327276">||</span>&nbsp;<span class="ident" id="4327279">b</span>&nbsp;<span class="op" id="4327281">==</span>&nbsp;<span class="string" id="4327284">&#39;\r&#39;</span>&nbsp;<span class="op" id="4327289">||</span>&nbsp;<span class="ident" id="4327292">b</span>&nbsp;<span class="op" id="4327294">==</span>&nbsp;<span class="string" id="4327297">&#39;\n&#39;</span>&nbsp;<span class="op" id="4327302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327307">continue</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327322">result</span><span class="op" id="4327328">[</span><span class="ident" id="4327329">n</span><span class="op" id="4327330">]</span>&nbsp;<span class="op" id="4327332">=</span>&nbsp;<span class="ident" id="4327334">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327338">n</span><span class="op" id="4327339">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327347">return</span>&nbsp;<span class="ident" id="4327354">result</span><span class="op" id="4327360">[</span><span class="num" id="4327361">0</span><span class="op" id="4327362">:</span><span class="ident" id="4327363">n</span><span class="op" id="4327364">]</span><br>
<span class="lineno"></span><span class="op" id="4327366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4327369">var</span>&nbsp;<span class="ident" id="4327373">pemStart</span>&nbsp;<span class="op" id="4327382">=</span>&nbsp;<span class="op" id="4327384">[</span><span class="op" id="4327385">]</span><span class="builtintype" id="4327386">byte</span><span class="op" id="4327390">(</span><span class="string" id="4327391">&#34;\n-----BEGIN&nbsp;&#34;</span><span class="op" id="4327406">)</span><br>
<span class="lineno"></span><span class="keyword" id="4327408">var</span>&nbsp;<span class="ident" id="4327412">pemEnd</span>&nbsp;<span class="op" id="4327419">=</span>&nbsp;<span class="op" id="4327421">[</span><span class="op" id="4327422">]</span><span class="builtintype" id="4327423">byte</span><span class="op" id="4327427">(</span><span class="string" id="4327428">&#34;\n-----END&nbsp;&#34;</span><span class="op" id="4327441">)</span><br>
<span class="lineno">70</span><span class="keyword" id="4327443">var</span>&nbsp;<span class="ident" id="4327447">pemEndOfLine</span>&nbsp;<span class="op" id="4327460">=</span>&nbsp;<span class="op" id="4327462">[</span><span class="op" id="4327463">]</span><span class="builtintype" id="4327464">byte</span><span class="op" id="4327468">(</span><span class="string" id="4327469">&#34;-----&#34;</span><span class="op" id="4327476">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4327479">//&nbsp;Decode&nbsp;will&nbsp;find&nbsp;the&nbsp;next&nbsp;PEM&nbsp;formatted&nbsp;block&nbsp;(certificate,&nbsp;private&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="4327554">//&nbsp;etc)&nbsp;in&nbsp;the&nbsp;input.&nbsp;It&nbsp;returns&nbsp;that&nbsp;block&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;input.&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="4327633">//&nbsp;no&nbsp;PEM&nbsp;data&nbsp;is&nbsp;found,&nbsp;p&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;whole&nbsp;of&nbsp;the&nbsp;input&nbsp;is&nbsp;returned&nbsp;in</span><br>
<span class="lineno">75</span><span class="comment" id="4327709">//&nbsp;rest.</span><br>
<span class="lineno"></span><span class="keyword" id="4327718">func</span>&nbsp;<span class="ident" id="4327723">Decode</span><span class="op" id="4327729">(</span><span class="ident" id="4327730">data</span>&nbsp;<span class="op" id="4327735">[</span><span class="op" id="4327736">]</span><span class="builtintype" id="4327737">byte</span><span class="op" id="4327741">)</span>&nbsp;<span class="op" id="4327743">(</span><span class="ident" id="4327744">p</span>&nbsp;<span class="op" id="4327746">*</span><span class="ident" id="4327747">Block</span><span class="op" id="4327752">,</span>&nbsp;<span class="ident" id="4327754">rest</span>&nbsp;<span class="op" id="4327759">[</span><span class="op" id="4327760">]</span><span class="builtintype" id="4327761">byte</span><span class="op" id="4327765">)</span>&nbsp;<span class="op" id="4327767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4327770">//&nbsp;pemStart&nbsp;begins&nbsp;with&nbsp;a&nbsp;newline.&nbsp;However,&nbsp;at&nbsp;the&nbsp;very&nbsp;beginning&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4327840">//&nbsp;the&nbsp;byte&nbsp;array,&nbsp;we&#39;ll&nbsp;accept&nbsp;the&nbsp;start&nbsp;string&nbsp;without&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327902">rest</span>&nbsp;<span class="op" id="4327907">=</span>&nbsp;<span class="ident" id="4327909">data</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327915">if</span>&nbsp;<span class="ident" id="4327918">bytes</span><span class="op" id="4327923">.</span><span class="ident" id="4327924">HasPrefix</span><span class="op" id="4327933">(</span><span class="ident" id="4327934">data</span><span class="op" id="4327938">,</span>&nbsp;<span class="ident" id="4327940">pemStart</span><span class="op" id="4327948">[</span><span class="num" id="4327949">1</span><span class="op" id="4327950">:</span><span class="op" id="4327951">]</span><span class="op" id="4327952">)</span>&nbsp;<span class="op" id="4327954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327958">rest</span>&nbsp;<span class="op" id="4327963">=</span>&nbsp;<span class="ident" id="4327965">rest</span><span class="op" id="4327969">[</span><span class="builtinfunc" id="4327970">len</span><span class="op" id="4327973">(</span><span class="ident" id="4327974">pemStart</span><span class="op" id="4327982">)</span><span class="op" id="4327983">-</span><span class="num" id="4327984">1</span>&nbsp;<span class="op" id="4327986">:</span>&nbsp;<span class="builtinfunc" id="4327988">len</span><span class="op" id="4327991">(</span><span class="ident" id="4327992">data</span><span class="op" id="4327996">)</span><span class="op" id="4327997">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328000">}</span>&nbsp;<span class="keyword" id="4328002">else</span>&nbsp;<span class="keyword" id="4328007">if</span>&nbsp;<span class="ident" id="4328010">i</span>&nbsp;<span class="op" id="4328012">:=</span>&nbsp;<span class="ident" id="4328015">bytes</span><span class="op" id="4328020">.</span><span class="ident" id="4328021">Index</span><span class="op" id="4328026">(</span><span class="ident" id="4328027">data</span><span class="op" id="4328031">,</span>&nbsp;<span class="ident" id="4328033">pemStart</span><span class="op" id="4328041">)</span><span class="op" id="4328042">;</span>&nbsp;<span class="ident" id="4328044">i</span>&nbsp;<span class="op" id="4328046">&gt;=</span>&nbsp;<span class="num" id="4328049">0</span>&nbsp;<span class="op" id="4328051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328055">rest</span>&nbsp;<span class="op" id="4328060">=</span>&nbsp;<span class="ident" id="4328062">rest</span><span class="op" id="4328066">[</span><span class="ident" id="4328067">i</span><span class="op" id="4328068">+</span><span class="builtinfunc" id="4328069">len</span><span class="op" id="4328072">(</span><span class="ident" id="4328073">pemStart</span><span class="op" id="4328081">)</span>&nbsp;<span class="op" id="4328083">:</span>&nbsp;<span class="builtinfunc" id="4328085">len</span><span class="op" id="4328088">(</span><span class="ident" id="4328089">data</span><span class="op" id="4328093">)</span><span class="op" id="4328094">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328097">}</span>&nbsp;<span class="keyword" id="4328099">else</span>&nbsp;<span class="op" id="4328104">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328108">return</span>&nbsp;<span class="ident" id="4328115">nil</span><span class="op" id="4328118">,</span>&nbsp;<span class="ident" id="4328120">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328130">typeLine</span><span class="op" id="4328138">,</span>&nbsp;<span class="ident" id="4328140">rest</span>&nbsp;<span class="op" id="4328145">:=</span>&nbsp;<span class="ident" id="4328148">getLine</span><span class="op" id="4328155">(</span><span class="ident" id="4328156">rest</span><span class="op" id="4328160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328163">if</span>&nbsp;<span class="op" id="4328166">!</span><span class="ident" id="4328167">bytes</span><span class="op" id="4328172">.</span><span class="ident" id="4328173">HasSuffix</span><span class="op" id="4328182">(</span><span class="ident" id="4328183">typeLine</span><span class="op" id="4328191">,</span>&nbsp;<span class="ident" id="4328193">pemEndOfLine</span><span class="op" id="4328205">)</span>&nbsp;<span class="op" id="4328207">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328211">return</span>&nbsp;<span class="ident" id="4328218">decodeError</span><span class="op" id="4328229">(</span><span class="ident" id="4328230">data</span><span class="op" id="4328234">,</span>&nbsp;<span class="ident" id="4328236">rest</span><span class="op" id="4328240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328246">typeLine</span>&nbsp;<span class="op" id="4328255">=</span>&nbsp;<span class="ident" id="4328257">typeLine</span><span class="op" id="4328265">[</span><span class="num" id="4328266">0</span>&nbsp;<span class="op" id="4328268">:</span>&nbsp;<span class="builtinfunc" id="4328270">len</span><span class="op" id="4328273">(</span><span class="ident" id="4328274">typeLine</span><span class="op" id="4328282">)</span><span class="op" id="4328283">-</span><span class="builtinfunc" id="4328284">len</span><span class="op" id="4328287">(</span><span class="ident" id="4328288">pemEndOfLine</span><span class="op" id="4328300">)</span><span class="op" id="4328301">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328305">p</span>&nbsp;<span class="op" id="4328307">=</span>&nbsp;<span class="op" id="4328309">&amp;</span><span class="ident" id="4328310">Block</span><span class="op" id="4328315">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328319">Headers</span><span class="op" id="4328326">:</span>&nbsp;<span class="builtinfunc" id="4328328">make</span><span class="op" id="4328332">(</span><span class="keyword" id="4328333">map</span><span class="op" id="4328336">[</span><span class="builtintype" id="4328337">string</span><span class="op" id="4328343">]</span><span class="builtintype" id="4328344">string</span><span class="op" id="4328350">)</span><span class="op" id="4328351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328355">Type</span><span class="op" id="4328359">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4328364">string</span><span class="op" id="4328370">(</span><span class="ident" id="4328371">typeLine</span><span class="op" id="4328379">)</span><span class="op" id="4328380">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328387">for</span>&nbsp;<span class="op" id="4328391">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4328395">//&nbsp;This&nbsp;loop&nbsp;terminates&nbsp;because&nbsp;getLine&#39;s&nbsp;second&nbsp;result&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4328456">//&nbsp;always&nbsp;smaller&nbsp;than&nbsp;its&nbsp;argument.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328495">if</span>&nbsp;<span class="builtinfunc" id="4328498">len</span><span class="op" id="4328501">(</span><span class="ident" id="4328502">rest</span><span class="op" id="4328506">)</span>&nbsp;<span class="op" id="4328508">==</span>&nbsp;<span class="num" id="4328511">0</span>&nbsp;<span class="op" id="4328513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328518">return</span>&nbsp;<span class="ident" id="4328525">nil</span><span class="op" id="4328528">,</span>&nbsp;<span class="ident" id="4328530">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328537">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328541">line</span><span class="op" id="4328545">,</span>&nbsp;<span class="ident" id="4328547">next</span>&nbsp;<span class="op" id="4328552">:=</span>&nbsp;<span class="ident" id="4328555">getLine</span><span class="op" id="4328562">(</span><span class="ident" id="4328563">rest</span><span class="op" id="4328567">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328572">i</span>&nbsp;<span class="op" id="4328574">:=</span>&nbsp;<span class="ident" id="4328577">bytes</span><span class="op" id="4328582">.</span><span class="ident" id="4328583">Index</span><span class="op" id="4328588">(</span><span class="ident" id="4328589">line</span><span class="op" id="4328593">,</span>&nbsp;<span class="op" id="4328595">[</span><span class="op" id="4328596">]</span><span class="builtintype" id="4328597">byte</span><span class="op" id="4328601">{</span><span class="string" id="4328602">&#39;:&#39;</span><span class="op" id="4328605">}</span><span class="op" id="4328606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328610">if</span>&nbsp;<span class="ident" id="4328613">i</span>&nbsp;<span class="op" id="4328615">==</span>&nbsp;<span class="op" id="4328618">-</span><span class="num" id="4328619">1</span>&nbsp;<span class="op" id="4328621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328626">break</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4328639">//&nbsp;TODO(agl):&nbsp;need&nbsp;to&nbsp;cope&nbsp;with&nbsp;values&nbsp;that&nbsp;spread&nbsp;across&nbsp;lines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328706">key</span><span class="op" id="4328709">,</span>&nbsp;<span class="ident" id="4328711">val</span>&nbsp;<span class="op" id="4328715">:=</span>&nbsp;<span class="ident" id="4328718">line</span><span class="op" id="4328722">[</span><span class="num" id="4328723">0</span><span class="op" id="4328724">:</span><span class="ident" id="4328725">i</span><span class="op" id="4328726">]</span><span class="op" id="4328727">,</span>&nbsp;<span class="ident" id="4328729">line</span><span class="op" id="4328733">[</span><span class="ident" id="4328734">i</span><span class="op" id="4328735">+</span><span class="num" id="4328736">1</span><span class="op" id="4328737">:</span><span class="op" id="4328738">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328742">key</span>&nbsp;<span class="op" id="4328746">=</span>&nbsp;<span class="ident" id="4328748">bytes</span><span class="op" id="4328753">.</span><span class="ident" id="4328754">TrimSpace</span><span class="op" id="4328763">(</span><span class="ident" id="4328764">key</span><span class="op" id="4328767">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328771">val</span>&nbsp;<span class="op" id="4328775">=</span>&nbsp;<span class="ident" id="4328777">bytes</span><span class="op" id="4328782">.</span><span class="ident" id="4328783">TrimSpace</span><span class="op" id="4328792">(</span><span class="ident" id="4328793">val</span><span class="op" id="4328796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328800">p</span><span class="op" id="4328801">.</span><span class="ident" id="4328802">Headers</span><span class="op" id="4328809">[</span><span class="builtintype" id="4328810">string</span><span class="op" id="4328816">(</span><span class="ident" id="4328817">key</span><span class="op" id="4328820">)</span><span class="op" id="4328821">]</span>&nbsp;<span class="op" id="4328823">=</span>&nbsp;<span class="builtintype" id="4328825">string</span><span class="op" id="4328831">(</span><span class="ident" id="4328832">val</span><span class="op" id="4328835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328839">rest</span>&nbsp;<span class="op" id="4328844">=</span>&nbsp;<span class="ident" id="4328846">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328856">i</span>&nbsp;<span class="op" id="4328858">:=</span>&nbsp;<span class="ident" id="4328861">bytes</span><span class="op" id="4328866">.</span><span class="ident" id="4328867">Index</span><span class="op" id="4328872">(</span><span class="ident" id="4328873">rest</span><span class="op" id="4328877">,</span>&nbsp;<span class="ident" id="4328879">pemEnd</span><span class="op" id="4328885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328888">if</span>&nbsp;<span class="ident" id="4328891">i</span>&nbsp;<span class="op" id="4328893">&lt;</span>&nbsp;<span class="num" id="4328895">0</span>&nbsp;<span class="op" id="4328897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328901">return</span>&nbsp;<span class="ident" id="4328908">decodeError</span><span class="op" id="4328919">(</span><span class="ident" id="4328920">data</span><span class="op" id="4328924">,</span>&nbsp;<span class="ident" id="4328926">rest</span><span class="op" id="4328930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328936">base64Data</span>&nbsp;<span class="op" id="4328947">:=</span>&nbsp;<span class="ident" id="4328950">removeWhitespace</span><span class="op" id="4328966">(</span><span class="ident" id="4328967">rest</span><span class="op" id="4328971">[</span><span class="num" id="4328972">0</span><span class="op" id="4328973">:</span><span class="ident" id="4328974">i</span><span class="op" id="4328975">]</span><span class="op" id="4328976">)</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328980">p</span><span class="op" id="4328981">.</span><span class="ident" id="4328982">Bytes</span>&nbsp;<span class="op" id="4328988">=</span>&nbsp;<span class="builtinfunc" id="4328990">make</span><span class="op" id="4328994">(</span><span class="op" id="4328995">[</span><span class="op" id="4328996">]</span><span class="builtintype" id="4328997">byte</span><span class="op" id="4329001">,</span>&nbsp;<span class="ident" id="4329003">base64</span><span class="op" id="4329009">.</span><span class="ident" id="4329010">StdEncoding</span><span class="op" id="4329021">.</span><span class="ident" id="4329022">DecodedLen</span><span class="op" id="4329032">(</span><span class="builtinfunc" id="4329033">len</span><span class="op" id="4329036">(</span><span class="ident" id="4329037">base64Data</span><span class="op" id="4329047">)</span><span class="op" id="4329048">)</span><span class="op" id="4329049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329052">n</span><span class="op" id="4329053">,</span>&nbsp;<span class="ident" id="4329055">err</span>&nbsp;<span class="op" id="4329059">:=</span>&nbsp;<span class="ident" id="4329062">base64</span><span class="op" id="4329068">.</span><span class="ident" id="4329069">StdEncoding</span><span class="op" id="4329080">.</span><span class="ident" id="4329081">Decode</span><span class="op" id="4329087">(</span><span class="ident" id="4329088">p</span><span class="op" id="4329089">.</span><span class="ident" id="4329090">Bytes</span><span class="op" id="4329095">,</span>&nbsp;<span class="ident" id="4329097">base64Data</span><span class="op" id="4329107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329110">if</span>&nbsp;<span class="ident" id="4329113">err</span>&nbsp;<span class="op" id="4329117">!=</span>&nbsp;<span class="ident" id="4329120">nil</span>&nbsp;<span class="op" id="4329124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329128">return</span>&nbsp;<span class="ident" id="4329135">decodeError</span><span class="op" id="4329146">(</span><span class="ident" id="4329147">data</span><span class="op" id="4329151">,</span>&nbsp;<span class="ident" id="4329153">rest</span><span class="op" id="4329157">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4329160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329163">p</span><span class="op" id="4329164">.</span><span class="ident" id="4329165">Bytes</span>&nbsp;<span class="op" id="4329171">=</span>&nbsp;<span class="ident" id="4329173">p</span><span class="op" id="4329174">.</span><span class="ident" id="4329175">Bytes</span><span class="op" id="4329180">[</span><span class="num" id="4329181">0</span><span class="op" id="4329182">:</span><span class="ident" id="4329183">n</span><span class="op" id="4329184">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329188">_</span><span class="op" id="4329189">,</span>&nbsp;<span class="ident" id="4329191">rest</span>&nbsp;<span class="op" id="4329196">=</span>&nbsp;<span class="ident" id="4329198">getLine</span><span class="op" id="4329205">(</span><span class="ident" id="4329206">rest</span><span class="op" id="4329210">[</span><span class="ident" id="4329211">i</span><span class="op" id="4329212">+</span><span class="builtinfunc" id="4329213">len</span><span class="op" id="4329216">(</span><span class="ident" id="4329217">pemEnd</span><span class="op" id="4329223">)</span><span class="op" id="4329224">:</span><span class="op" id="4329225">]</span><span class="op" id="4329226">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329230">return</span><br>
<span class="lineno"></span><span class="op" id="4329237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4329240">func</span>&nbsp;<span class="ident" id="4329245">decodeError</span><span class="op" id="4329256">(</span><span class="ident" id="4329257">data</span><span class="op" id="4329261">,</span>&nbsp;<span class="ident" id="4329263">rest</span>&nbsp;<span class="op" id="4329268">[</span><span class="op" id="4329269">]</span><span class="builtintype" id="4329270">byte</span><span class="op" id="4329274">)</span>&nbsp;<span class="op" id="4329276">(</span><span class="op" id="4329277">*</span><span class="ident" id="4329278">Block</span><span class="op" id="4329283">,</span>&nbsp;<span class="op" id="4329285">[</span><span class="op" id="4329286">]</span><span class="builtintype" id="4329287">byte</span><span class="op" id="4329291">)</span>&nbsp;<span class="op" id="4329293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329296">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here&nbsp;then&nbsp;we&nbsp;have&nbsp;rejected&nbsp;a&nbsp;likely&nbsp;looking,&nbsp;but</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329359">//&nbsp;ultimately&nbsp;invalid&nbsp;PEM&nbsp;block.&nbsp;We&nbsp;need&nbsp;to&nbsp;start&nbsp;over&nbsp;from&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329426">//&nbsp;position.&nbsp;&nbsp;We&nbsp;have&nbsp;consumed&nbsp;the&nbsp;preamble&nbsp;line&nbsp;and&nbsp;will&nbsp;have&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329499">//&nbsp;any&nbsp;lines&nbsp;which&nbsp;could&nbsp;be&nbsp;header&nbsp;lines.&nbsp;However,&nbsp;a&nbsp;valid&nbsp;preamble</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329568">//&nbsp;line&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;header&nbsp;line,&nbsp;therefore&nbsp;we&nbsp;cannot&nbsp;have&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329639">//&nbsp;the&nbsp;preamble&nbsp;line&nbsp;for&nbsp;the&nbsp;any&nbsp;subsequent&nbsp;block.&nbsp;Thus,&nbsp;we&nbsp;will&nbsp;always</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329712">//&nbsp;find&nbsp;any&nbsp;valid&nbsp;block,&nbsp;no&nbsp;matter&nbsp;what&nbsp;bytes&nbsp;precede&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329771">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329775">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;the&nbsp;input&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329808">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329812">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;MALFORMED&nbsp;BLOCK-----</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329851">//&nbsp;&nbsp;&nbsp;&nbsp;junk&nbsp;that&nbsp;may&nbsp;look&nbsp;like&nbsp;header&nbsp;lines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329895">//&nbsp;&nbsp;&nbsp;or&nbsp;data&nbsp;lines,&nbsp;but&nbsp;no&nbsp;END&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329932">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329936">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;ACTUAL&nbsp;BLOCK-----</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329972">//&nbsp;&nbsp;&nbsp;&nbsp;realdata</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4329988">//&nbsp;&nbsp;&nbsp;&nbsp;-----END&nbsp;ACTUAL&nbsp;BLOCK-----</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4330022">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4330026">//&nbsp;we&#39;ve&nbsp;failed&nbsp;to&nbsp;parse&nbsp;using&nbsp;the&nbsp;first&nbsp;BEGIN&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4330079">//&nbsp;and&nbsp;now&nbsp;will&nbsp;try&nbsp;again,&nbsp;using&nbsp;the&nbsp;second&nbsp;BEGIN&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330136">p</span><span class="op" id="4330137">,</span>&nbsp;<span class="ident" id="4330139">rest</span>&nbsp;<span class="op" id="4330144">:=</span>&nbsp;<span class="ident" id="4330147">Decode</span><span class="op" id="4330153">(</span><span class="ident" id="4330154">rest</span><span class="op" id="4330158">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330161">if</span>&nbsp;<span class="ident" id="4330164">p</span>&nbsp;<span class="op" id="4330166">==</span>&nbsp;<span class="ident" id="4330169">nil</span>&nbsp;<span class="op" id="4330173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330177">rest</span>&nbsp;<span class="op" id="4330182">=</span>&nbsp;<span class="ident" id="4330184">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330193">return</span>&nbsp;<span class="ident" id="4330200">p</span><span class="op" id="4330201">,</span>&nbsp;<span class="ident" id="4330203">rest</span><br>
<span class="lineno"></span><span class="op" id="4330208">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="4330211">const</span>&nbsp;<span class="ident" id="4330217">pemLineLength</span>&nbsp;<span class="op" id="4330231">=</span>&nbsp;<span class="num" id="4330233">64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4330237">type</span>&nbsp;<span class="ident" id="4330242">lineBreaker</span>&nbsp;<span class="keyword" id="4330254">struct</span>&nbsp;<span class="op" id="4330261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330264">line</span>&nbsp;<span class="op" id="4330269">[</span><span class="ident" id="4330270">pemLineLength</span><span class="op" id="4330283">]</span><span class="builtintype" id="4330284">byte</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330290">used</span>&nbsp;<span class="builtintype" id="4330295">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330300">out</span>&nbsp;&nbsp;<span class="ident" id="4330305">io</span><span class="op" id="4330307">.</span><span class="ident" id="4330308">Writer</span><br>
<span class="lineno"></span><span class="op" id="4330315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4330318">func</span>&nbsp;<span class="op" id="4330323">(</span><span class="ident" id="4330324">l</span>&nbsp;<span class="op" id="4330326">*</span><span class="ident" id="4330327">lineBreaker</span><span class="op" id="4330338">)</span>&nbsp;<span class="ident" id="4330340">Write</span><span class="op" id="4330345">(</span><span class="ident" id="4330346">b</span>&nbsp;<span class="op" id="4330348">[</span><span class="op" id="4330349">]</span><span class="builtintype" id="4330350">byte</span><span class="op" id="4330354">)</span>&nbsp;<span class="op" id="4330356">(</span><span class="ident" id="4330357">n</span>&nbsp;<span class="builtintype" id="4330359">int</span><span class="op" id="4330362">,</span>&nbsp;<span class="ident" id="4330364">err</span>&nbsp;<span class="builtintype" id="4330368">error</span><span class="op" id="4330373">)</span>&nbsp;<span class="op" id="4330375">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330378">if</span>&nbsp;<span class="ident" id="4330381">l</span><span class="op" id="4330382">.</span><span class="ident" id="4330383">used</span><span class="op" id="4330387">+</span><span class="builtinfunc" id="4330388">len</span><span class="op" id="4330391">(</span><span class="ident" id="4330392">b</span><span class="op" id="4330393">)</span>&nbsp;<span class="op" id="4330395">&lt;</span>&nbsp;<span class="ident" id="4330397">pemLineLength</span>&nbsp;<span class="op" id="4330411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4330415">copy</span><span class="op" id="4330419">(</span><span class="ident" id="4330420">l</span><span class="op" id="4330421">.</span><span class="ident" id="4330422">line</span><span class="op" id="4330426">[</span><span class="ident" id="4330427">l</span><span class="op" id="4330428">.</span><span class="ident" id="4330429">used</span><span class="op" id="4330433">:</span><span class="op" id="4330434">]</span><span class="op" id="4330435">,</span>&nbsp;<span class="ident" id="4330437">b</span><span class="op" id="4330438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330442">l</span><span class="op" id="4330443">.</span><span class="ident" id="4330444">used</span>&nbsp;<span class="op" id="4330449">+=</span>&nbsp;<span class="builtinfunc" id="4330452">len</span><span class="op" id="4330455">(</span><span class="ident" id="4330456">b</span><span class="op" id="4330457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330461">return</span>&nbsp;<span class="builtinfunc" id="4330468">len</span><span class="op" id="4330471">(</span><span class="ident" id="4330472">b</span><span class="op" id="4330473">)</span><span class="op" id="4330474">,</span>&nbsp;<span class="ident" id="4330476">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330481">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330485">n</span><span class="op" id="4330486">,</span>&nbsp;<span class="ident" id="4330488">err</span>&nbsp;<span class="op" id="4330492">=</span>&nbsp;<span class="ident" id="4330494">l</span><span class="op" id="4330495">.</span><span class="ident" id="4330496">out</span><span class="op" id="4330499">.</span><span class="ident" id="4330500">Write</span><span class="op" id="4330505">(</span><span class="ident" id="4330506">l</span><span class="op" id="4330507">.</span><span class="ident" id="4330508">line</span><span class="op" id="4330512">[</span><span class="num" id="4330513">0</span><span class="op" id="4330514">:</span><span class="ident" id="4330515">l</span><span class="op" id="4330516">.</span><span class="ident" id="4330517">used</span><span class="op" id="4330521">]</span><span class="op" id="4330522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330525">if</span>&nbsp;<span class="ident" id="4330528">err</span>&nbsp;<span class="op" id="4330532">!=</span>&nbsp;<span class="ident" id="4330535">nil</span>&nbsp;<span class="op" id="4330539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330543">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330551">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330554">excess</span>&nbsp;<span class="op" id="4330561">:=</span>&nbsp;<span class="ident" id="4330564">pemLineLength</span>&nbsp;<span class="op" id="4330578">-</span>&nbsp;<span class="ident" id="4330580">l</span><span class="op" id="4330581">.</span><span class="ident" id="4330582">used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330588">l</span><span class="op" id="4330589">.</span><span class="ident" id="4330590">used</span>&nbsp;<span class="op" id="4330595">=</span>&nbsp;<span class="num" id="4330597">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330601">n</span><span class="op" id="4330602">,</span>&nbsp;<span class="ident" id="4330604">err</span>&nbsp;<span class="op" id="4330608">=</span>&nbsp;<span class="ident" id="4330610">l</span><span class="op" id="4330611">.</span><span class="ident" id="4330612">out</span><span class="op" id="4330615">.</span><span class="ident" id="4330616">Write</span><span class="op" id="4330621">(</span><span class="ident" id="4330622">b</span><span class="op" id="4330623">[</span><span class="num" id="4330624">0</span><span class="op" id="4330625">:</span><span class="ident" id="4330626">excess</span><span class="op" id="4330632">]</span><span class="op" id="4330633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330636">if</span>&nbsp;<span class="ident" id="4330639">err</span>&nbsp;<span class="op" id="4330643">!=</span>&nbsp;<span class="ident" id="4330646">nil</span>&nbsp;<span class="op" id="4330650">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330654">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330666">n</span><span class="op" id="4330667">,</span>&nbsp;<span class="ident" id="4330669">err</span>&nbsp;<span class="op" id="4330673">=</span>&nbsp;<span class="ident" id="4330675">l</span><span class="op" id="4330676">.</span><span class="ident" id="4330677">out</span><span class="op" id="4330680">.</span><span class="ident" id="4330681">Write</span><span class="op" id="4330686">(</span><span class="op" id="4330687">[</span><span class="op" id="4330688">]</span><span class="builtintype" id="4330689">byte</span><span class="op" id="4330693">{</span><span class="string" id="4330694">&#39;\n&#39;</span><span class="op" id="4330698">}</span><span class="op" id="4330699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330702">if</span>&nbsp;<span class="ident" id="4330705">err</span>&nbsp;<span class="op" id="4330709">!=</span>&nbsp;<span class="ident" id="4330712">nil</span>&nbsp;<span class="op" id="4330716">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330720">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330732">return</span>&nbsp;<span class="ident" id="4330739">l</span><span class="op" id="4330740">.</span><span class="ident" id="4330741">Write</span><span class="op" id="4330746">(</span><span class="ident" id="4330747">b</span><span class="op" id="4330748">[</span><span class="ident" id="4330749">excess</span><span class="op" id="4330755">:</span><span class="op" id="4330756">]</span><span class="op" id="4330757">)</span><br>
<span class="lineno"></span><span class="op" id="4330759">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="4330762">func</span>&nbsp;<span class="op" id="4330767">(</span><span class="ident" id="4330768">l</span>&nbsp;<span class="op" id="4330770">*</span><span class="ident" id="4330771">lineBreaker</span><span class="op" id="4330782">)</span>&nbsp;<span class="ident" id="4330784">Close</span><span class="op" id="4330789">(</span><span class="op" id="4330790">)</span>&nbsp;<span class="op" id="4330792">(</span><span class="ident" id="4330793">err</span>&nbsp;<span class="builtintype" id="4330797">error</span><span class="op" id="4330802">)</span>&nbsp;<span class="op" id="4330804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330807">if</span>&nbsp;<span class="ident" id="4330810">l</span><span class="op" id="4330811">.</span><span class="ident" id="4330812">used</span>&nbsp;<span class="op" id="4330817">&gt;</span>&nbsp;<span class="num" id="4330819">0</span>&nbsp;<span class="op" id="4330821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330825">_</span><span class="op" id="4330826">,</span>&nbsp;<span class="ident" id="4330828">err</span>&nbsp;<span class="op" id="4330832">=</span>&nbsp;<span class="ident" id="4330834">l</span><span class="op" id="4330835">.</span><span class="ident" id="4330836">out</span><span class="op" id="4330839">.</span><span class="ident" id="4330840">Write</span><span class="op" id="4330845">(</span><span class="ident" id="4330846">l</span><span class="op" id="4330847">.</span><span class="ident" id="4330848">line</span><span class="op" id="4330852">[</span><span class="num" id="4330853">0</span><span class="op" id="4330854">:</span><span class="ident" id="4330855">l</span><span class="op" id="4330856">.</span><span class="ident" id="4330857">used</span><span class="op" id="4330861">]</span><span class="op" id="4330862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330866">if</span>&nbsp;<span class="ident" id="4330869">err</span>&nbsp;<span class="op" id="4330873">!=</span>&nbsp;<span class="ident" id="4330876">nil</span>&nbsp;<span class="op" id="4330880">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330885">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330898">_</span><span class="op" id="4330899">,</span>&nbsp;<span class="ident" id="4330901">err</span>&nbsp;<span class="op" id="4330905">=</span>&nbsp;<span class="ident" id="4330907">l</span><span class="op" id="4330908">.</span><span class="ident" id="4330909">out</span><span class="op" id="4330912">.</span><span class="ident" id="4330913">Write</span><span class="op" id="4330918">(</span><span class="op" id="4330919">[</span><span class="op" id="4330920">]</span><span class="builtintype" id="4330921">byte</span><span class="op" id="4330925">{</span><span class="string" id="4330926">&#39;\n&#39;</span><span class="op" id="4330930">}</span><span class="op" id="4330931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330938">return</span><br>
<span class="lineno"></span><span class="op" id="4330945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4330948">func</span>&nbsp;<span class="ident" id="4330953">writeHeader</span><span class="op" id="4330964">(</span><span class="ident" id="4330965">out</span>&nbsp;<span class="ident" id="4330969">io</span><span class="op" id="4330971">.</span><span class="ident" id="4330972">Writer</span><span class="op" id="4330978">,</span>&nbsp;<span class="ident" id="4330980">k</span><span class="op" id="4330981">,</span>&nbsp;<span class="ident" id="4330983">v</span>&nbsp;<span class="builtintype" id="4330985">string</span><span class="op" id="4330991">)</span>&nbsp;<span class="builtintype" id="4330993">error</span>&nbsp;<span class="op" id="4330999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4331002">_</span><span class="op" id="4331003">,</span>&nbsp;<span class="ident" id="4331005">err</span>&nbsp;<span class="op" id="4331009">:=</span>&nbsp;<span class="ident" id="4331012">out</span><span class="op" id="4331015">.</span><span class="ident" id="4331016">Write</span><span class="op" id="4331021">(</span><span class="op" id="4331022">[</span><span class="op" id="4331023">]</span><span class="builtintype" id="4331024">byte</span><span class="op" id="4331028">(</span><span class="ident" id="4331029">k</span>&nbsp;<span class="op" id="4331031">+</span>&nbsp;<span class="string" id="4331033">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="4331038">+</span>&nbsp;<span class="ident" id="4331040">v</span>&nbsp;<span class="op" id="4331042">+</span>&nbsp;<span class="string" id="4331044">&#34;\n&#34;</span><span class="op" id="4331048">)</span><span class="op" id="4331049">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331052">return</span>&nbsp;<span class="ident" id="4331059">err</span><br>
<span class="lineno"></span><span class="op" id="4331063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4331066">func</span>&nbsp;<span class="ident" id="4331071">Encode</span><span class="op" id="4331077">(</span><span class="ident" id="4331078">out</span>&nbsp;<span class="ident" id="4331082">io</span><span class="op" id="4331084">.</span><span class="ident" id="4331085">Writer</span><span class="op" id="4331091">,</span>&nbsp;<span class="ident" id="4331093">b</span>&nbsp;<span class="op" id="4331095">*</span><span class="ident" id="4331096">Block</span><span class="op" id="4331101">)</span>&nbsp;<span class="builtintype" id="4331103">error</span>&nbsp;<span class="op" id="4331109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331112">if</span>&nbsp;<span class="ident" id="4331115">_</span><span class="op" id="4331116">,</span>&nbsp;<span class="ident" id="4331118">err</span>&nbsp;<span class="op" id="4331122">:=</span>&nbsp;<span class="ident" id="4331125">out</span><span class="op" id="4331128">.</span><span class="ident" id="4331129">Write</span><span class="op" id="4331134">(</span><span class="ident" id="4331135">pemStart</span><span class="op" id="4331143">[</span><span class="num" id="4331144">1</span><span class="op" id="4331145">:</span><span class="op" id="4331146">]</span><span class="op" id="4331147">)</span><span class="op" id="4331148">;</span>&nbsp;<span class="ident" id="4331150">err</span>&nbsp;<span class="op" id="4331154">!=</span>&nbsp;<span class="ident" id="4331157">nil</span>&nbsp;<span class="op" id="4331161">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331165">return</span>&nbsp;<span class="ident" id="4331172">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331180">if</span>&nbsp;<span class="ident" id="4331183">_</span><span class="op" id="4331184">,</span>&nbsp;<span class="ident" id="4331186">err</span>&nbsp;<span class="op" id="4331190">:=</span>&nbsp;<span class="ident" id="4331193">out</span><span class="op" id="4331196">.</span><span class="ident" id="4331197">Write</span><span class="op" id="4331202">(</span><span class="op" id="4331203">[</span><span class="op" id="4331204">]</span><span class="builtintype" id="4331205">byte</span><span class="op" id="4331209">(</span><span class="ident" id="4331210">b</span><span class="op" id="4331211">.</span><span class="ident" id="4331212">Type</span>&nbsp;<span class="op" id="4331217">+</span>&nbsp;<span class="string" id="4331219">&#34;-----\n&#34;</span><span class="op" id="4331228">)</span><span class="op" id="4331229">)</span><span class="op" id="4331230">;</span>&nbsp;<span class="ident" id="4331232">err</span>&nbsp;<span class="op" id="4331236">!=</span>&nbsp;<span class="ident" id="4331239">nil</span>&nbsp;<span class="op" id="4331243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331247">return</span>&nbsp;<span class="ident" id="4331254">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331259">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331263">if</span>&nbsp;<span class="builtinfunc" id="4331266">len</span><span class="op" id="4331269">(</span><span class="ident" id="4331270">b</span><span class="op" id="4331271">.</span><span class="ident" id="4331272">Headers</span><span class="op" id="4331279">)</span>&nbsp;<span class="op" id="4331281">&gt;</span>&nbsp;<span class="num" id="4331283">0</span>&nbsp;<span class="op" id="4331285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331289">const</span>&nbsp;<span class="ident" id="4331295">procType</span>&nbsp;<span class="op" id="4331304">=</span>&nbsp;<span class="string" id="4331306">&#34;Proc-Type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4331320">h</span>&nbsp;<span class="op" id="4331322">:=</span>&nbsp;<span class="builtinfunc" id="4331325">make</span><span class="op" id="4331329">(</span><span class="op" id="4331330">[</span><span class="op" id="4331331">]</span><span class="builtintype" id="4331332">string</span><span class="op" id="4331338">,</span>&nbsp;<span class="num" id="4331340">0</span><span class="op" id="4331341">,</span>&nbsp;<span class="builtinfunc" id="4331343">len</span><span class="op" id="4331346">(</span><span class="ident" id="4331347">b</span><span class="op" id="4331348">.</span><span class="ident" id="4331349">Headers</span><span class="op" id="4331356">)</span><span class="op" id="4331357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4331361">hasProcType</span>&nbsp;<span class="op" id="4331373">:=</span>&nbsp;<span class="builtintype" id="4331376">false</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331384">for</span>&nbsp;<span class="ident" id="4331388">k</span>&nbsp;<span class="op" id="4331390">:=</span>&nbsp;<span class="keyword" id="4331393">range</span>&nbsp;<span class="ident" id="4331399">b</span><span class="op" id="4331400">.</span><span class="ident" id="4331401">Headers</span>&nbsp;<span class="op" id="4331409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331414">if</span>&nbsp;<span class="ident" id="4331417">k</span>&nbsp;<span class="op" id="4331419">==</span>&nbsp;<span class="ident" id="4331422">procType</span>&nbsp;<span class="op" id="4331431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4331437">hasProcType</span>&nbsp;<span class="op" id="4331449">=</span>&nbsp;<span class="builtintype" id="4331451">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331460">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331472">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4331477">h</span>&nbsp;<span class="op" id="4331479">=</span>&nbsp;<span class="builtinfunc" id="4331481">append</span><span class="op" id="4331487">(</span><span class="ident" id="4331488">h</span><span class="op" id="4331489">,</span>&nbsp;<span class="ident" id="4331491">k</span><span class="op" id="4331492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4331500">//&nbsp;The&nbsp;Proc-Type&nbsp;header&nbsp;must&nbsp;be&nbsp;written&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4331549">//&nbsp;See&nbsp;RFC&nbsp;1421,&nbsp;section&nbsp;4.6.1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331584">if</span>&nbsp;<span class="ident" id="4331587">hasProcType</span>&nbsp;<span class="op" id="4331599">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331604">if</span>&nbsp;<span class="ident" id="4331607">err</span>&nbsp;<span class="op" id="4331611">:=</span>&nbsp;<span class="ident" id="4331614">writeHeader</span><span class="op" id="4331625">(</span><span class="ident" id="4331626">out</span><span class="op" id="4331629">,</span>&nbsp;<span class="ident" id="4331631">procType</span><span class="op" id="4331639">,</span>&nbsp;<span class="ident" id="4331641">b</span><span class="op" id="4331642">.</span><span class="ident" id="4331643">Headers</span><span class="op" id="4331650">[</span><span class="ident" id="4331651">procType</span><span class="op" id="4331659">]</span><span class="op" id="4331660">)</span><span class="op" id="4331661">;</span>&nbsp;<span class="ident" id="4331663">err</span>&nbsp;<span class="op" id="4331667">!=</span>&nbsp;<span class="ident" id="4331670">nil</span>&nbsp;<span class="op" id="4331674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331680">return</span>&nbsp;<span class="ident" id="4331687">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4331702">//&nbsp;For&nbsp;consistency&nbsp;of&nbsp;output,&nbsp;write&nbsp;other&nbsp;headers&nbsp;sorted&nbsp;by&nbsp;key.</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4331769">sort</span><span class="op" id="4331773">.</span><span class="ident" id="4331774">Strings</span><span class="op" id="4331781">(</span><span class="ident" id="4331782">h</span><span class="op" id="4331783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331787">for</span>&nbsp;<span class="ident" id="4331791">_</span><span class="op" id="4331792">,</span>&nbsp;<span class="ident" id="4331794">k</span>&nbsp;<span class="op" id="4331796">:=</span>&nbsp;<span class="keyword" id="4331799">range</span>&nbsp;<span class="ident" id="4331805">h</span>&nbsp;<span class="op" id="4331807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331812">if</span>&nbsp;<span class="ident" id="4331815">err</span>&nbsp;<span class="op" id="4331819">:=</span>&nbsp;<span class="ident" id="4331822">writeHeader</span><span class="op" id="4331833">(</span><span class="ident" id="4331834">out</span><span class="op" id="4331837">,</span>&nbsp;<span class="ident" id="4331839">k</span><span class="op" id="4331840">,</span>&nbsp;<span class="ident" id="4331842">b</span><span class="op" id="4331843">.</span><span class="ident" id="4331844">Headers</span><span class="op" id="4331851">[</span><span class="ident" id="4331852">k</span><span class="op" id="4331853">]</span><span class="op" id="4331854">)</span><span class="op" id="4331855">;</span>&nbsp;<span class="ident" id="4331857">err</span>&nbsp;<span class="op" id="4331861">!=</span>&nbsp;<span class="ident" id="4331864">nil</span>&nbsp;<span class="op" id="4331868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331874">return</span>&nbsp;<span class="ident" id="4331881">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331888">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331896">if</span>&nbsp;<span class="ident" id="4331899">_</span><span class="op" id="4331900">,</span>&nbsp;<span class="ident" id="4331902">err</span>&nbsp;<span class="op" id="4331906">:=</span>&nbsp;<span class="ident" id="4331909">out</span><span class="op" id="4331912">.</span><span class="ident" id="4331913">Write</span><span class="op" id="4331918">(</span><span class="op" id="4331919">[</span><span class="op" id="4331920">]</span><span class="builtintype" id="4331921">byte</span><span class="op" id="4331925">{</span><span class="string" id="4331926">&#39;\n&#39;</span><span class="op" id="4331930">}</span><span class="op" id="4331931">)</span><span class="op" id="4331932">;</span>&nbsp;<span class="ident" id="4331934">err</span>&nbsp;<span class="op" id="4331938">!=</span>&nbsp;<span class="ident" id="4331941">nil</span>&nbsp;<span class="op" id="4331945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331950">return</span>&nbsp;<span class="ident" id="4331957">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331966">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331970">var</span>&nbsp;<span class="ident" id="4331974">breaker</span>&nbsp;<span class="ident" id="4331982">lineBreaker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4331995">breaker</span><span class="op" id="4332002">.</span><span class="ident" id="4332003">out</span>&nbsp;<span class="op" id="4332007">=</span>&nbsp;<span class="ident" id="4332009">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4332015">b64</span>&nbsp;<span class="op" id="4332019">:=</span>&nbsp;<span class="ident" id="4332022">base64</span><span class="op" id="4332028">.</span><span class="ident" id="4332029">NewEncoder</span><span class="op" id="4332039">(</span><span class="ident" id="4332040">base64</span><span class="op" id="4332046">.</span><span class="ident" id="4332047">StdEncoding</span><span class="op" id="4332058">,</span>&nbsp;<span class="op" id="4332060">&amp;</span><span class="ident" id="4332061">breaker</span><span class="op" id="4332068">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332071">if</span>&nbsp;<span class="ident" id="4332074">_</span><span class="op" id="4332075">,</span>&nbsp;<span class="ident" id="4332077">err</span>&nbsp;<span class="op" id="4332081">:=</span>&nbsp;<span class="ident" id="4332084">b64</span><span class="op" id="4332087">.</span><span class="ident" id="4332088">Write</span><span class="op" id="4332093">(</span><span class="ident" id="4332094">b</span><span class="op" id="4332095">.</span><span class="ident" id="4332096">Bytes</span><span class="op" id="4332101">)</span><span class="op" id="4332102">;</span>&nbsp;<span class="ident" id="4332104">err</span>&nbsp;<span class="op" id="4332108">!=</span>&nbsp;<span class="ident" id="4332111">nil</span>&nbsp;<span class="op" id="4332115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332119">return</span>&nbsp;<span class="ident" id="4332126">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4332131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4332134">b64</span><span class="op" id="4332137">.</span><span class="ident" id="4332138">Close</span><span class="op" id="4332143">(</span><span class="op" id="4332144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4332147">breaker</span><span class="op" id="4332154">.</span><span class="ident" id="4332155">Close</span><span class="op" id="4332160">(</span><span class="op" id="4332161">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332165">if</span>&nbsp;<span class="ident" id="4332168">_</span><span class="op" id="4332169">,</span>&nbsp;<span class="ident" id="4332171">err</span>&nbsp;<span class="op" id="4332175">:=</span>&nbsp;<span class="ident" id="4332178">out</span><span class="op" id="4332181">.</span><span class="ident" id="4332182">Write</span><span class="op" id="4332187">(</span><span class="ident" id="4332188">pemEnd</span><span class="op" id="4332194">[</span><span class="num" id="4332195">1</span><span class="op" id="4332196">:</span><span class="op" id="4332197">]</span><span class="op" id="4332198">)</span><span class="op" id="4332199">;</span>&nbsp;<span class="ident" id="4332201">err</span>&nbsp;<span class="op" id="4332205">!=</span>&nbsp;<span class="ident" id="4332208">nil</span>&nbsp;<span class="op" id="4332212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332216">return</span>&nbsp;<span class="ident" id="4332223">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4332228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4332231">_</span><span class="op" id="4332232">,</span>&nbsp;<span class="ident" id="4332234">err</span>&nbsp;<span class="op" id="4332238">:=</span>&nbsp;<span class="ident" id="4332241">out</span><span class="op" id="4332244">.</span><span class="ident" id="4332245">Write</span><span class="op" id="4332250">(</span><span class="op" id="4332251">[</span><span class="op" id="4332252">]</span><span class="builtintype" id="4332253">byte</span><span class="op" id="4332257">(</span><span class="ident" id="4332258">b</span><span class="op" id="4332259">.</span><span class="ident" id="4332260">Type</span>&nbsp;<span class="op" id="4332265">+</span>&nbsp;<span class="string" id="4332267">&#34;-----\n&#34;</span><span class="op" id="4332276">)</span><span class="op" id="4332277">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332280">return</span>&nbsp;<span class="ident" id="4332287">err</span><br>
<span class="lineno"></span><span class="op" id="4332291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4332294">func</span>&nbsp;<span class="ident" id="4332299">EncodeToMemory</span><span class="op" id="4332313">(</span><span class="ident" id="4332314">b</span>&nbsp;<span class="op" id="4332316">*</span><span class="ident" id="4332317">Block</span><span class="op" id="4332322">)</span>&nbsp;<span class="op" id="4332324">[</span><span class="op" id="4332325">]</span><span class="builtintype" id="4332326">byte</span>&nbsp;<span class="op" id="4332331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332334">var</span>&nbsp;<span class="ident" id="4332338">buf</span>&nbsp;<span class="ident" id="4332342">bytes</span><span class="op" id="4332347">.</span><span class="ident" id="4332348">Buffer</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4332356">Encode</span><span class="op" id="4332362">(</span><span class="op" id="4332363">&amp;</span><span class="ident" id="4332364">buf</span><span class="op" id="4332367">,</span>&nbsp;<span class="ident" id="4332369">b</span><span class="op" id="4332370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332373">return</span>&nbsp;<span class="ident" id="4332380">buf</span><span class="op" id="4332383">.</span><span class="ident" id="4332384">Bytes</span><span class="op" id="4332389">(</span><span class="op" id="4332390">)</span><br>
<span class="lineno"></span><span class="op" id="4332392">}</span>
</div>
</body>
</html>
