<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5089046">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5089101">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5089155">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5089206">package</span>&nbsp;<span class="ident" id="5089214">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5089219">import</span>&nbsp;<span class="op" id="5089226">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5089229">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5089235">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5089246">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5089253">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5089256">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5089331">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="5089362">type</span>&nbsp;<span class="ident" id="5089367">Encoder</span>&nbsp;<span class="keyword" id="5089375">struct</span>&nbsp;<span class="op" id="5089382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089385">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5089396">sync</span><span class="op" id="5089400">.</span><span class="ident" id="5089401">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5089420">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089458">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5089469">[</span><span class="op" id="5089470">]</span><span class="ident" id="5089471">io</span><span class="op" id="5089473">.</span><span class="ident" id="5089474">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5089493">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089520">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5089531">map</span><span class="op" id="5089534">[</span><span class="ident" id="5089535">reflect</span><span class="op" id="5089542">.</span><span class="ident" id="5089543">Type</span><span class="op" id="5089547">]</span><span class="ident" id="5089548">typeId</span>&nbsp;<span class="comment" id="5089555">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089590">countState</span>&nbsp;<span class="op" id="5089601">*</span><span class="ident" id="5089602">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5089625">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089654">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5089665">*</span><span class="ident" id="5089666">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5089689">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089741">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5089752">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5089776">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089814">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5089825">error</span><br>
<span class="lineno"></span><span class="op" id="5089831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5089834">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5089901">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5089968">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="5090030">const</span>&nbsp;<span class="ident" id="5090036">maxLength</span>&nbsp;<span class="op" id="5090046">=</span>&nbsp;<span class="num" id="5090048">9</span>&nbsp;<span class="comment" id="5090050">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="5090088">var</span>&nbsp;<span class="ident" id="5090092">spaceForLength</span>&nbsp;<span class="op" id="5090107">=</span>&nbsp;<span class="builtinfunc" id="5090109">make</span><span class="op" id="5090113">(</span><span class="op" id="5090114">[</span><span class="op" id="5090115">]</span><span class="builtintype" id="5090116">byte</span><span class="op" id="5090120">,</span>&nbsp;<span class="ident" id="5090122">maxLength</span><span class="op" id="5090131">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="5090134">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5090207">func</span>&nbsp;<span class="ident" id="5090212">NewEncoder</span><span class="op" id="5090222">(</span><span class="ident" id="5090223">w</span>&nbsp;<span class="ident" id="5090225">io</span><span class="op" id="5090227">.</span><span class="ident" id="5090228">Writer</span><span class="op" id="5090234">)</span>&nbsp;<span class="op" id="5090236">*</span><span class="ident" id="5090237">Encoder</span>&nbsp;<span class="op" id="5090245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090248">enc</span>&nbsp;<span class="op" id="5090252">:=</span>&nbsp;<span class="builtinfunc" id="5090255">new</span><span class="op" id="5090258">(</span><span class="ident" id="5090259">Encoder</span><span class="op" id="5090266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090269">enc</span><span class="op" id="5090272">.</span><span class="ident" id="5090273">w</span>&nbsp;<span class="op" id="5090275">=</span>&nbsp;<span class="op" id="5090277">[</span><span class="op" id="5090278">]</span><span class="ident" id="5090279">io</span><span class="op" id="5090281">.</span><span class="ident" id="5090282">Writer</span><span class="op" id="5090288">{</span><span class="ident" id="5090289">w</span><span class="op" id="5090290">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090293">enc</span><span class="op" id="5090296">.</span><span class="ident" id="5090297">sent</span>&nbsp;<span class="op" id="5090302">=</span>&nbsp;<span class="builtinfunc" id="5090304">make</span><span class="op" id="5090308">(</span><span class="keyword" id="5090309">map</span><span class="op" id="5090312">[</span><span class="ident" id="5090313">reflect</span><span class="op" id="5090320">.</span><span class="ident" id="5090321">Type</span><span class="op" id="5090325">]</span><span class="ident" id="5090326">typeId</span><span class="op" id="5090332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090335">enc</span><span class="op" id="5090338">.</span><span class="ident" id="5090339">countState</span>&nbsp;<span class="op" id="5090350">=</span>&nbsp;<span class="ident" id="5090352">enc</span><span class="op" id="5090355">.</span><span class="ident" id="5090356">newEncoderState</span><span class="op" id="5090371">(</span><span class="builtinfunc" id="5090372">new</span><span class="op" id="5090375">(</span><span class="ident" id="5090376">encBuffer</span><span class="op" id="5090385">)</span><span class="op" id="5090386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5090389">return</span>&nbsp;<span class="ident" id="5090396">enc</span><br>
<span class="lineno"></span><span class="op" id="5090400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="5090403">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="5090465">func</span>&nbsp;<span class="op" id="5090470">(</span><span class="ident" id="5090471">enc</span>&nbsp;<span class="op" id="5090475">*</span><span class="ident" id="5090476">Encoder</span><span class="op" id="5090483">)</span>&nbsp;<span class="ident" id="5090485">writer</span><span class="op" id="5090491">(</span><span class="op" id="5090492">)</span>&nbsp;<span class="ident" id="5090494">io</span><span class="op" id="5090496">.</span><span class="ident" id="5090497">Writer</span>&nbsp;<span class="op" id="5090504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5090507">return</span>&nbsp;<span class="ident" id="5090514">enc</span><span class="op" id="5090517">.</span><span class="ident" id="5090518">w</span><span class="op" id="5090519">[</span><span class="builtinfunc" id="5090520">len</span><span class="op" id="5090523">(</span><span class="ident" id="5090524">enc</span><span class="op" id="5090527">.</span><span class="ident" id="5090528">w</span><span class="op" id="5090529">)</span><span class="op" id="5090530">-</span><span class="num" id="5090531">1</span><span class="op" id="5090532">]</span><br>
<span class="lineno"></span><span class="op" id="5090534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5090537">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="5090581">func</span>&nbsp;<span class="op" id="5090586">(</span><span class="ident" id="5090587">enc</span>&nbsp;<span class="op" id="5090591">*</span><span class="ident" id="5090592">Encoder</span><span class="op" id="5090599">)</span>&nbsp;<span class="ident" id="5090601">pushWriter</span><span class="op" id="5090611">(</span><span class="ident" id="5090612">w</span>&nbsp;<span class="ident" id="5090614">io</span><span class="op" id="5090616">.</span><span class="ident" id="5090617">Writer</span><span class="op" id="5090623">)</span>&nbsp;<span class="op" id="5090625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090628">enc</span><span class="op" id="5090631">.</span><span class="ident" id="5090632">w</span>&nbsp;<span class="op" id="5090634">=</span>&nbsp;<span class="builtinfunc" id="5090636">append</span><span class="op" id="5090642">(</span><span class="ident" id="5090643">enc</span><span class="op" id="5090646">.</span><span class="ident" id="5090647">w</span><span class="op" id="5090648">,</span>&nbsp;<span class="ident" id="5090650">w</span><span class="op" id="5090651">)</span><br>
<span class="lineno"></span><span class="op" id="5090653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5090656">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5090696">func</span>&nbsp;<span class="op" id="5090701">(</span><span class="ident" id="5090702">enc</span>&nbsp;<span class="op" id="5090706">*</span><span class="ident" id="5090707">Encoder</span><span class="op" id="5090714">)</span>&nbsp;<span class="ident" id="5090716">popWriter</span><span class="op" id="5090725">(</span><span class="op" id="5090726">)</span>&nbsp;<span class="op" id="5090728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090731">enc</span><span class="op" id="5090734">.</span><span class="ident" id="5090735">w</span>&nbsp;<span class="op" id="5090737">=</span>&nbsp;<span class="ident" id="5090739">enc</span><span class="op" id="5090742">.</span><span class="ident" id="5090743">w</span><span class="op" id="5090744">[</span><span class="num" id="5090745">0</span>&nbsp;<span class="op" id="5090747">:</span>&nbsp;<span class="builtinfunc" id="5090749">len</span><span class="op" id="5090752">(</span><span class="ident" id="5090753">enc</span><span class="op" id="5090756">.</span><span class="ident" id="5090757">w</span><span class="op" id="5090758">)</span><span class="op" id="5090759">-</span><span class="num" id="5090760">1</span><span class="op" id="5090761">]</span><br>
<span class="lineno"></span><span class="op" id="5090763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5090766">func</span>&nbsp;<span class="op" id="5090771">(</span><span class="ident" id="5090772">enc</span>&nbsp;<span class="op" id="5090776">*</span><span class="ident" id="5090777">Encoder</span><span class="op" id="5090784">)</span>&nbsp;<span class="ident" id="5090786">setError</span><span class="op" id="5090794">(</span><span class="ident" id="5090795">err</span>&nbsp;<span class="builtintype" id="5090799">error</span><span class="op" id="5090804">)</span>&nbsp;<span class="op" id="5090806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5090809">if</span>&nbsp;<span class="ident" id="5090812">enc</span><span class="op" id="5090815">.</span><span class="ident" id="5090816">err</span>&nbsp;<span class="op" id="5090820">==</span>&nbsp;<span class="ident" id="5090823">nil</span>&nbsp;<span class="op" id="5090827">{</span>&nbsp;<span class="comment" id="5090829">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090854">enc</span><span class="op" id="5090857">.</span><span class="ident" id="5090858">err</span>&nbsp;<span class="op" id="5090862">=</span>&nbsp;<span class="ident" id="5090864">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5090869">}</span><br>
<span class="lineno"></span><span class="op" id="5090871">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="5090874">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="5090954">func</span>&nbsp;<span class="op" id="5090959">(</span><span class="ident" id="5090960">enc</span>&nbsp;<span class="op" id="5090964">*</span><span class="ident" id="5090965">Encoder</span><span class="op" id="5090972">)</span>&nbsp;<span class="ident" id="5090974">writeMessage</span><span class="op" id="5090986">(</span><span class="ident" id="5090987">w</span>&nbsp;<span class="ident" id="5090989">io</span><span class="op" id="5090991">.</span><span class="ident" id="5090992">Writer</span><span class="op" id="5090998">,</span>&nbsp;<span class="ident" id="5091000">b</span>&nbsp;<span class="op" id="5091002">*</span><span class="ident" id="5091003">encBuffer</span><span class="op" id="5091012">)</span>&nbsp;<span class="op" id="5091014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5091017">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5091088">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5091168">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091184">message</span>&nbsp;<span class="op" id="5091192">:=</span>&nbsp;<span class="ident" id="5091195">b</span><span class="op" id="5091196">.</span><span class="ident" id="5091197">Bytes</span><span class="op" id="5091202">(</span><span class="op" id="5091203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091206">messageLen</span>&nbsp;<span class="op" id="5091217">:=</span>&nbsp;<span class="builtinfunc" id="5091220">len</span><span class="op" id="5091223">(</span><span class="ident" id="5091224">message</span><span class="op" id="5091231">)</span>&nbsp;<span class="op" id="5091233">-</span>&nbsp;<span class="ident" id="5091235">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5091246">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091269">enc</span><span class="op" id="5091272">.</span><span class="ident" id="5091273">countState</span><span class="op" id="5091283">.</span><span class="ident" id="5091284">b</span><span class="op" id="5091285">.</span><span class="ident" id="5091286">Reset</span><span class="op" id="5091291">(</span><span class="op" id="5091292">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091295">enc</span><span class="op" id="5091298">.</span><span class="ident" id="5091299">countState</span><span class="op" id="5091309">.</span><span class="ident" id="5091310">encodeUint</span><span class="op" id="5091320">(</span><span class="ident" id="5091321">uint64</span><span class="op" id="5091327">(</span><span class="ident" id="5091328">messageLen</span><span class="op" id="5091338">)</span><span class="op" id="5091339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5091342">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091393">offset</span>&nbsp;<span class="op" id="5091400">:=</span>&nbsp;<span class="ident" id="5091403">maxLength</span>&nbsp;<span class="op" id="5091413">-</span>&nbsp;<span class="ident" id="5091415">enc</span><span class="op" id="5091418">.</span><span class="ident" id="5091419">countState</span><span class="op" id="5091429">.</span><span class="ident" id="5091430">b</span><span class="op" id="5091431">.</span><span class="ident" id="5091432">Len</span><span class="op" id="5091435">(</span><span class="op" id="5091436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5091439">copy</span><span class="op" id="5091443">(</span><span class="ident" id="5091444">message</span><span class="op" id="5091451">[</span><span class="ident" id="5091452">offset</span><span class="op" id="5091458">:</span><span class="op" id="5091459">]</span><span class="op" id="5091460">,</span>&nbsp;<span class="ident" id="5091462">enc</span><span class="op" id="5091465">.</span><span class="ident" id="5091466">countState</span><span class="op" id="5091476">.</span><span class="ident" id="5091477">b</span><span class="op" id="5091478">.</span><span class="ident" id="5091479">Bytes</span><span class="op" id="5091484">(</span><span class="op" id="5091485">)</span><span class="op" id="5091486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5091489">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091509">_</span><span class="op" id="5091510">,</span>&nbsp;<span class="ident" id="5091512">err</span>&nbsp;<span class="op" id="5091516">:=</span>&nbsp;<span class="ident" id="5091519">w</span><span class="op" id="5091520">.</span><span class="ident" id="5091521">Write</span><span class="op" id="5091526">(</span><span class="ident" id="5091527">message</span><span class="op" id="5091534">[</span><span class="ident" id="5091535">offset</span><span class="op" id="5091541">:</span><span class="op" id="5091542">]</span><span class="op" id="5091543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5091546">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091637">b</span><span class="op" id="5091638">.</span><span class="ident" id="5091639">Reset</span><span class="op" id="5091644">(</span><span class="op" id="5091645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091648">b</span><span class="op" id="5091649">.</span><span class="ident" id="5091650">Write</span><span class="op" id="5091655">(</span><span class="ident" id="5091656">spaceForLength</span><span class="op" id="5091670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5091673">if</span>&nbsp;<span class="ident" id="5091676">err</span>&nbsp;<span class="op" id="5091680">!=</span>&nbsp;<span class="ident" id="5091683">nil</span>&nbsp;<span class="op" id="5091687">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091691">enc</span><span class="op" id="5091694">.</span><span class="ident" id="5091695">setError</span><span class="op" id="5091703">(</span><span class="ident" id="5091704">err</span><span class="op" id="5091707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5091710">}</span><br>
<span class="lineno"></span><span class="op" id="5091712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5091715">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="5091797">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="5091823">func</span>&nbsp;<span class="op" id="5091828">(</span><span class="ident" id="5091829">enc</span>&nbsp;<span class="op" id="5091833">*</span><span class="ident" id="5091834">Encoder</span><span class="op" id="5091841">)</span>&nbsp;<span class="ident" id="5091843">sendActualType</span><span class="op" id="5091857">(</span><span class="ident" id="5091858">w</span>&nbsp;<span class="ident" id="5091860">io</span><span class="op" id="5091862">.</span><span class="ident" id="5091863">Writer</span><span class="op" id="5091869">,</span>&nbsp;<span class="ident" id="5091871">state</span>&nbsp;<span class="op" id="5091877">*</span><span class="ident" id="5091878">encoderState</span><span class="op" id="5091890">,</span>&nbsp;<span class="ident" id="5091892">ut</span>&nbsp;<span class="op" id="5091895">*</span><span class="ident" id="5091896">userTypeInfo</span><span class="op" id="5091908">,</span>&nbsp;<span class="ident" id="5091910">actual</span>&nbsp;<span class="ident" id="5091917">reflect</span><span class="op" id="5091924">.</span><span class="ident" id="5091925">Type</span><span class="op" id="5091929">)</span>&nbsp;<span class="op" id="5091931">(</span><span class="ident" id="5091932">sent</span>&nbsp;<span class="builtintype" id="5091937">bool</span><span class="op" id="5091941">)</span>&nbsp;<span class="op" id="5091943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5091946">if</span>&nbsp;<span class="ident" id="5091949">_</span><span class="op" id="5091950">,</span>&nbsp;<span class="ident" id="5091952">alreadySent</span>&nbsp;<span class="op" id="5091964">:=</span>&nbsp;<span class="ident" id="5091967">enc</span><span class="op" id="5091970">.</span><span class="ident" id="5091971">sent</span><span class="op" id="5091975">[</span><span class="ident" id="5091976">actual</span><span class="op" id="5091982">]</span><span class="op" id="5091983">;</span>&nbsp;<span class="ident" id="5091985">alreadySent</span>&nbsp;<span class="op" id="5091997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092001">return</span>&nbsp;<span class="builtintype" id="5092008">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5092015">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092018">info</span><span class="op" id="5092022">,</span>&nbsp;<span class="ident" id="5092024">err</span>&nbsp;<span class="op" id="5092028">:=</span>&nbsp;<span class="ident" id="5092031">getTypeInfo</span><span class="op" id="5092042">(</span><span class="ident" id="5092043">ut</span><span class="op" id="5092045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092048">if</span>&nbsp;<span class="ident" id="5092051">err</span>&nbsp;<span class="op" id="5092055">!=</span>&nbsp;<span class="ident" id="5092058">nil</span>&nbsp;<span class="op" id="5092062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092066">enc</span><span class="op" id="5092069">.</span><span class="ident" id="5092070">setError</span><span class="op" id="5092078">(</span><span class="ident" id="5092079">err</span><span class="op" id="5092082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092086">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5092094">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5092097">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5092127">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092135">state</span><span class="op" id="5092140">.</span><span class="ident" id="5092141">encodeInt</span><span class="op" id="5092150">(</span><span class="op" id="5092151">-</span><span class="ident" id="5092152">int64</span><span class="op" id="5092157">(</span><span class="ident" id="5092158">info</span><span class="op" id="5092162">.</span><span class="ident" id="5092163">id</span><span class="op" id="5092165">)</span><span class="op" id="5092166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5092169">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092179">enc</span><span class="op" id="5092182">.</span><span class="ident" id="5092183">encode</span><span class="op" id="5092189">(</span><span class="ident" id="5092190">state</span><span class="op" id="5092195">.</span><span class="ident" id="5092196">b</span><span class="op" id="5092197">,</span>&nbsp;<span class="ident" id="5092199">reflect</span><span class="op" id="5092206">.</span><span class="ident" id="5092207">ValueOf</span><span class="op" id="5092214">(</span><span class="ident" id="5092215">info</span><span class="op" id="5092219">.</span><span class="ident" id="5092220">wire</span><span class="op" id="5092224">)</span><span class="op" id="5092225">,</span>&nbsp;<span class="ident" id="5092227">wireTypeUserInfo</span><span class="op" id="5092243">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092246">enc</span><span class="op" id="5092249">.</span><span class="ident" id="5092250">writeMessage</span><span class="op" id="5092262">(</span><span class="ident" id="5092263">w</span><span class="op" id="5092264">,</span>&nbsp;<span class="ident" id="5092266">state</span><span class="op" id="5092271">.</span><span class="ident" id="5092272">b</span><span class="op" id="5092273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092276">if</span>&nbsp;<span class="ident" id="5092279">enc</span><span class="op" id="5092282">.</span><span class="ident" id="5092283">err</span>&nbsp;<span class="op" id="5092287">!=</span>&nbsp;<span class="ident" id="5092290">nil</span>&nbsp;<span class="op" id="5092294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092298">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5092306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5092310">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092391">enc</span><span class="op" id="5092394">.</span><span class="ident" id="5092395">sent</span><span class="op" id="5092399">[</span><span class="ident" id="5092400">ut</span><span class="op" id="5092402">.</span><span class="ident" id="5092403">base</span><span class="op" id="5092407">]</span>&nbsp;<span class="op" id="5092409">=</span>&nbsp;<span class="ident" id="5092411">info</span><span class="op" id="5092415">.</span><span class="ident" id="5092416">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092420">if</span>&nbsp;<span class="ident" id="5092423">ut</span><span class="op" id="5092425">.</span><span class="ident" id="5092426">user</span>&nbsp;<span class="op" id="5092431">!=</span>&nbsp;<span class="ident" id="5092434">ut</span><span class="op" id="5092436">.</span><span class="ident" id="5092437">base</span>&nbsp;<span class="op" id="5092442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092446">enc</span><span class="op" id="5092449">.</span><span class="ident" id="5092450">sent</span><span class="op" id="5092454">[</span><span class="ident" id="5092455">ut</span><span class="op" id="5092457">.</span><span class="ident" id="5092458">user</span><span class="op" id="5092462">]</span>&nbsp;<span class="op" id="5092464">=</span>&nbsp;<span class="ident" id="5092466">info</span><span class="op" id="5092470">.</span><span class="ident" id="5092471">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5092475">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5092478">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092507">switch</span>&nbsp;<span class="ident" id="5092514">st</span>&nbsp;<span class="op" id="5092517">:=</span>&nbsp;<span class="ident" id="5092520">actual</span><span class="op" id="5092526">;</span>&nbsp;<span class="ident" id="5092528">st</span><span class="op" id="5092530">.</span><span class="ident" id="5092531">Kind</span><span class="op" id="5092535">(</span><span class="op" id="5092536">)</span>&nbsp;<span class="op" id="5092538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092541">case</span>&nbsp;<span class="ident" id="5092546">reflect</span><span class="op" id="5092553">.</span><span class="ident" id="5092554">Struct</span><span class="op" id="5092560">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092564">for</span>&nbsp;<span class="ident" id="5092568">i</span>&nbsp;<span class="op" id="5092570">:=</span>&nbsp;<span class="num" id="5092573">0</span><span class="op" id="5092574">;</span>&nbsp;<span class="ident" id="5092576">i</span>&nbsp;<span class="op" id="5092578">&lt;</span>&nbsp;<span class="ident" id="5092580">st</span><span class="op" id="5092582">.</span><span class="ident" id="5092583">NumField</span><span class="op" id="5092591">(</span><span class="op" id="5092592">)</span><span class="op" id="5092593">;</span>&nbsp;<span class="ident" id="5092595">i</span><span class="op" id="5092596">++</span>&nbsp;<span class="op" id="5092599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092604">if</span>&nbsp;<span class="ident" id="5092607">isExported</span><span class="op" id="5092617">(</span><span class="ident" id="5092618">st</span><span class="op" id="5092620">.</span><span class="ident" id="5092621">Field</span><span class="op" id="5092626">(</span><span class="ident" id="5092627">i</span><span class="op" id="5092628">)</span><span class="op" id="5092629">.</span><span class="ident" id="5092630">Name</span><span class="op" id="5092634">)</span>&nbsp;<span class="op" id="5092636">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092642">enc</span><span class="op" id="5092645">.</span><span class="ident" id="5092646">sendType</span><span class="op" id="5092654">(</span><span class="ident" id="5092655">w</span><span class="op" id="5092656">,</span>&nbsp;<span class="ident" id="5092658">state</span><span class="op" id="5092663">,</span>&nbsp;<span class="ident" id="5092665">st</span><span class="op" id="5092667">.</span><span class="ident" id="5092668">Field</span><span class="op" id="5092673">(</span><span class="ident" id="5092674">i</span><span class="op" id="5092675">)</span><span class="op" id="5092676">.</span><span class="ident" id="5092677">Type</span><span class="op" id="5092681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5092686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5092690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092693">case</span>&nbsp;<span class="ident" id="5092698">reflect</span><span class="op" id="5092705">.</span><span class="ident" id="5092706">Array</span><span class="op" id="5092711">,</span>&nbsp;<span class="ident" id="5092713">reflect</span><span class="op" id="5092720">.</span><span class="ident" id="5092721">Slice</span><span class="op" id="5092726">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092730">enc</span><span class="op" id="5092733">.</span><span class="ident" id="5092734">sendType</span><span class="op" id="5092742">(</span><span class="ident" id="5092743">w</span><span class="op" id="5092744">,</span>&nbsp;<span class="ident" id="5092746">state</span><span class="op" id="5092751">,</span>&nbsp;<span class="ident" id="5092753">st</span><span class="op" id="5092755">.</span><span class="ident" id="5092756">Elem</span><span class="op" id="5092760">(</span><span class="op" id="5092761">)</span><span class="op" id="5092762">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092765">case</span>&nbsp;<span class="ident" id="5092770">reflect</span><span class="op" id="5092777">.</span><span class="ident" id="5092778">Map</span><span class="op" id="5092781">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092785">enc</span><span class="op" id="5092788">.</span><span class="ident" id="5092789">sendType</span><span class="op" id="5092797">(</span><span class="ident" id="5092798">w</span><span class="op" id="5092799">,</span>&nbsp;<span class="ident" id="5092801">state</span><span class="op" id="5092806">,</span>&nbsp;<span class="ident" id="5092808">st</span><span class="op" id="5092810">.</span><span class="ident" id="5092811">Key</span><span class="op" id="5092814">(</span><span class="op" id="5092815">)</span><span class="op" id="5092816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092820">enc</span><span class="op" id="5092823">.</span><span class="ident" id="5092824">sendType</span><span class="op" id="5092832">(</span><span class="ident" id="5092833">w</span><span class="op" id="5092834">,</span>&nbsp;<span class="ident" id="5092836">state</span><span class="op" id="5092841">,</span>&nbsp;<span class="ident" id="5092843">st</span><span class="op" id="5092845">.</span><span class="ident" id="5092846">Elem</span><span class="op" id="5092850">(</span><span class="op" id="5092851">)</span><span class="op" id="5092852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5092855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092858">return</span>&nbsp;<span class="builtintype" id="5092865">true</span><br>
<span class="lineno">125</span><span class="op" id="5092870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5092873">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5092938">func</span>&nbsp;<span class="op" id="5092943">(</span><span class="ident" id="5092944">enc</span>&nbsp;<span class="op" id="5092948">*</span><span class="ident" id="5092949">Encoder</span><span class="op" id="5092956">)</span>&nbsp;<span class="ident" id="5092958">sendType</span><span class="op" id="5092966">(</span><span class="ident" id="5092967">w</span>&nbsp;<span class="ident" id="5092969">io</span><span class="op" id="5092971">.</span><span class="ident" id="5092972">Writer</span><span class="op" id="5092978">,</span>&nbsp;<span class="ident" id="5092980">state</span>&nbsp;<span class="op" id="5092986">*</span><span class="ident" id="5092987">encoderState</span><span class="op" id="5092999">,</span>&nbsp;<span class="ident" id="5093001">origt</span>&nbsp;<span class="ident" id="5093007">reflect</span><span class="op" id="5093014">.</span><span class="ident" id="5093015">Type</span><span class="op" id="5093019">)</span>&nbsp;<span class="op" id="5093021">(</span><span class="ident" id="5093022">sent</span>&nbsp;<span class="builtintype" id="5093027">bool</span><span class="op" id="5093031">)</span>&nbsp;<span class="op" id="5093033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093036">ut</span>&nbsp;<span class="op" id="5093039">:=</span>&nbsp;<span class="ident" id="5093042">userType</span><span class="op" id="5093050">(</span><span class="ident" id="5093051">origt</span><span class="op" id="5093056">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093059">if</span>&nbsp;<span class="ident" id="5093062">ut</span><span class="op" id="5093064">.</span><span class="ident" id="5093065">externalEnc</span>&nbsp;<span class="op" id="5093077">!=</span>&nbsp;<span class="num" id="5093080">0</span>&nbsp;<span class="op" id="5093082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5093086">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5093168">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093240">return</span>&nbsp;<span class="ident" id="5093247">enc</span><span class="op" id="5093250">.</span><span class="ident" id="5093251">sendActualType</span><span class="op" id="5093265">(</span><span class="ident" id="5093266">w</span><span class="op" id="5093267">,</span>&nbsp;<span class="ident" id="5093269">state</span><span class="op" id="5093274">,</span>&nbsp;<span class="ident" id="5093276">ut</span><span class="op" id="5093278">,</span>&nbsp;<span class="ident" id="5093280">ut</span><span class="op" id="5093282">.</span><span class="ident" id="5093283">base</span><span class="op" id="5093287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5093290">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5093294">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093353">switch</span>&nbsp;<span class="ident" id="5093360">rt</span>&nbsp;<span class="op" id="5093363">:=</span>&nbsp;<span class="ident" id="5093366">ut</span><span class="op" id="5093368">.</span><span class="ident" id="5093369">base</span><span class="op" id="5093373">;</span>&nbsp;<span class="ident" id="5093375">rt</span><span class="op" id="5093377">.</span><span class="ident" id="5093378">Kind</span><span class="op" id="5093382">(</span><span class="op" id="5093383">)</span>&nbsp;<span class="op" id="5093385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093388">default</span><span class="op" id="5093395">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5093399">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093460">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093468">case</span>&nbsp;<span class="ident" id="5093473">reflect</span><span class="op" id="5093480">.</span><span class="ident" id="5093481">Slice</span><span class="op" id="5093486">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5093490">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093547">if</span>&nbsp;<span class="ident" id="5093550">rt</span><span class="op" id="5093552">.</span><span class="ident" id="5093553">Elem</span><span class="op" id="5093557">(</span><span class="op" id="5093558">)</span><span class="op" id="5093559">.</span><span class="ident" id="5093560">Kind</span><span class="op" id="5093564">(</span><span class="op" id="5093565">)</span>&nbsp;<span class="op" id="5093567">==</span>&nbsp;<span class="ident" id="5093570">reflect</span><span class="op" id="5093577">.</span><span class="ident" id="5093578">Uint8</span>&nbsp;<span class="op" id="5093584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093589">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5093598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5093602">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093629">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093636">case</span>&nbsp;<span class="ident" id="5093641">reflect</span><span class="op" id="5093648">.</span><span class="ident" id="5093649">Array</span><span class="op" id="5093654">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5093658">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093727">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093734">case</span>&nbsp;<span class="ident" id="5093739">reflect</span><span class="op" id="5093746">.</span><span class="ident" id="5093747">Map</span><span class="op" id="5093750">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5093754">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093823">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093830">case</span>&nbsp;<span class="ident" id="5093835">reflect</span><span class="op" id="5093842">.</span><span class="ident" id="5093843">Struct</span><span class="op" id="5093849">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5093853">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093904">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093911">case</span>&nbsp;<span class="ident" id="5093916">reflect</span><span class="op" id="5093923">.</span><span class="ident" id="5093924">Chan</span><span class="op" id="5093928">,</span>&nbsp;<span class="ident" id="5093930">reflect</span><span class="op" id="5093937">.</span><span class="ident" id="5093938">Func</span><span class="op" id="5093942">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5093946">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094004">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5094012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094016">return</span>&nbsp;<span class="ident" id="5094023">enc</span><span class="op" id="5094026">.</span><span class="ident" id="5094027">sendActualType</span><span class="op" id="5094041">(</span><span class="ident" id="5094042">w</span><span class="op" id="5094043">,</span>&nbsp;<span class="ident" id="5094045">state</span><span class="op" id="5094050">,</span>&nbsp;<span class="ident" id="5094052">ut</span><span class="op" id="5094054">,</span>&nbsp;<span class="ident" id="5094056">ut</span><span class="op" id="5094058">.</span><span class="ident" id="5094059">base</span><span class="op" id="5094063">)</span><br>
<span class="lineno"></span><span class="op" id="5094065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="5094068">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="5094144">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="5094224">func</span>&nbsp;<span class="op" id="5094229">(</span><span class="ident" id="5094230">enc</span>&nbsp;<span class="op" id="5094234">*</span><span class="ident" id="5094235">Encoder</span><span class="op" id="5094242">)</span>&nbsp;<span class="ident" id="5094244">Encode</span><span class="op" id="5094250">(</span><span class="ident" id="5094251">e</span>&nbsp;<span class="keyword" id="5094253">interface</span><span class="op" id="5094262">{</span><span class="op" id="5094263">}</span><span class="op" id="5094264">)</span>&nbsp;<span class="builtintype" id="5094266">error</span>&nbsp;<span class="op" id="5094272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094275">return</span>&nbsp;<span class="ident" id="5094282">enc</span><span class="op" id="5094285">.</span><span class="ident" id="5094286">EncodeValue</span><span class="op" id="5094297">(</span><span class="ident" id="5094298">reflect</span><span class="op" id="5094305">.</span><span class="ident" id="5094306">ValueOf</span><span class="op" id="5094313">(</span><span class="ident" id="5094314">e</span><span class="op" id="5094315">)</span><span class="op" id="5094316">)</span><br>
<span class="lineno"></span><span class="op" id="5094318">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="5094321">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5094393">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="5094466">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="5094475">func</span>&nbsp;<span class="op" id="5094480">(</span><span class="ident" id="5094481">enc</span>&nbsp;<span class="op" id="5094485">*</span><span class="ident" id="5094486">Encoder</span><span class="op" id="5094493">)</span>&nbsp;<span class="ident" id="5094495">sendTypeDescriptor</span><span class="op" id="5094513">(</span><span class="ident" id="5094514">w</span>&nbsp;<span class="ident" id="5094516">io</span><span class="op" id="5094518">.</span><span class="ident" id="5094519">Writer</span><span class="op" id="5094525">,</span>&nbsp;<span class="ident" id="5094527">state</span>&nbsp;<span class="op" id="5094533">*</span><span class="ident" id="5094534">encoderState</span><span class="op" id="5094546">,</span>&nbsp;<span class="ident" id="5094548">ut</span>&nbsp;<span class="op" id="5094551">*</span><span class="ident" id="5094552">userTypeInfo</span><span class="op" id="5094564">)</span>&nbsp;<span class="op" id="5094566">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5094569">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5094620">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094663">rt</span>&nbsp;<span class="op" id="5094666">:=</span>&nbsp;<span class="ident" id="5094669">ut</span><span class="op" id="5094671">.</span><span class="ident" id="5094672">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094678">if</span>&nbsp;<span class="ident" id="5094681">ut</span><span class="op" id="5094683">.</span><span class="ident" id="5094684">externalEnc</span>&nbsp;<span class="op" id="5094696">!=</span>&nbsp;<span class="num" id="5094699">0</span>&nbsp;<span class="op" id="5094701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094705">rt</span>&nbsp;<span class="op" id="5094708">=</span>&nbsp;<span class="ident" id="5094710">ut</span><span class="op" id="5094712">.</span><span class="ident" id="5094713">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5094719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094722">if</span>&nbsp;<span class="ident" id="5094725">_</span><span class="op" id="5094726">,</span>&nbsp;<span class="ident" id="5094728">alreadySent</span>&nbsp;<span class="op" id="5094740">:=</span>&nbsp;<span class="ident" id="5094743">enc</span><span class="op" id="5094746">.</span><span class="ident" id="5094747">sent</span><span class="op" id="5094751">[</span><span class="ident" id="5094752">rt</span><span class="op" id="5094754">]</span><span class="op" id="5094755">;</span>&nbsp;<span class="op" id="5094757">!</span><span class="ident" id="5094758">alreadySent</span>&nbsp;<span class="op" id="5094770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5094774">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094795">sent</span>&nbsp;<span class="op" id="5094800">:=</span>&nbsp;<span class="ident" id="5094803">enc</span><span class="op" id="5094806">.</span><span class="ident" id="5094807">sendType</span><span class="op" id="5094815">(</span><span class="ident" id="5094816">w</span><span class="op" id="5094817">,</span>&nbsp;<span class="ident" id="5094819">state</span><span class="op" id="5094824">,</span>&nbsp;<span class="ident" id="5094826">rt</span><span class="op" id="5094828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094832">if</span>&nbsp;<span class="ident" id="5094835">enc</span><span class="op" id="5094838">.</span><span class="ident" id="5094839">err</span>&nbsp;<span class="op" id="5094843">!=</span>&nbsp;<span class="ident" id="5094846">nil</span>&nbsp;<span class="op" id="5094850">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094855">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5094864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5094868">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5094939">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5095010">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5095077">if</span>&nbsp;<span class="op" id="5095080">!</span><span class="ident" id="5095081">sent</span>&nbsp;<span class="op" id="5095086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095091">info</span><span class="op" id="5095095">,</span>&nbsp;<span class="ident" id="5095097">err</span>&nbsp;<span class="op" id="5095101">:=</span>&nbsp;<span class="ident" id="5095104">getTypeInfo</span><span class="op" id="5095115">(</span><span class="ident" id="5095116">ut</span><span class="op" id="5095118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5095123">if</span>&nbsp;<span class="ident" id="5095126">err</span>&nbsp;<span class="op" id="5095130">!=</span>&nbsp;<span class="ident" id="5095133">nil</span>&nbsp;<span class="op" id="5095137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095143">enc</span><span class="op" id="5095146">.</span><span class="ident" id="5095147">setError</span><span class="op" id="5095155">(</span><span class="ident" id="5095156">err</span><span class="op" id="5095159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5095165">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5095175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095180">enc</span><span class="op" id="5095183">.</span><span class="ident" id="5095184">sent</span><span class="op" id="5095188">[</span><span class="ident" id="5095189">rt</span><span class="op" id="5095191">]</span>&nbsp;<span class="op" id="5095193">=</span>&nbsp;<span class="ident" id="5095195">info</span><span class="op" id="5095199">.</span><span class="ident" id="5095200">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5095205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5095208">}</span><br>
<span class="lineno"></span><span class="op" id="5095210">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5095213">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="5095279">func</span>&nbsp;<span class="op" id="5095284">(</span><span class="ident" id="5095285">enc</span>&nbsp;<span class="op" id="5095289">*</span><span class="ident" id="5095290">Encoder</span><span class="op" id="5095297">)</span>&nbsp;<span class="ident" id="5095299">sendTypeId</span><span class="op" id="5095309">(</span><span class="ident" id="5095310">state</span>&nbsp;<span class="op" id="5095316">*</span><span class="ident" id="5095317">encoderState</span><span class="op" id="5095329">,</span>&nbsp;<span class="ident" id="5095331">ut</span>&nbsp;<span class="op" id="5095334">*</span><span class="ident" id="5095335">userTypeInfo</span><span class="op" id="5095347">)</span>&nbsp;<span class="op" id="5095349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5095352">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095399">state</span><span class="op" id="5095404">.</span><span class="ident" id="5095405">encodeInt</span><span class="op" id="5095414">(</span><span class="ident" id="5095415">int64</span><span class="op" id="5095420">(</span><span class="ident" id="5095421">enc</span><span class="op" id="5095424">.</span><span class="ident" id="5095425">sent</span><span class="op" id="5095429">[</span><span class="ident" id="5095430">ut</span><span class="op" id="5095432">.</span><span class="ident" id="5095433">base</span><span class="op" id="5095437">]</span><span class="op" id="5095438">)</span><span class="op" id="5095439">)</span><br>
<span class="lineno">205</span><span class="op" id="5095441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5095444">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="5095520">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="5095600">func</span>&nbsp;<span class="op" id="5095605">(</span><span class="ident" id="5095606">enc</span>&nbsp;<span class="op" id="5095610">*</span><span class="ident" id="5095611">Encoder</span><span class="op" id="5095618">)</span>&nbsp;<span class="ident" id="5095620">EncodeValue</span><span class="op" id="5095631">(</span><span class="ident" id="5095632">value</span>&nbsp;<span class="ident" id="5095638">reflect</span><span class="op" id="5095645">.</span><span class="ident" id="5095646">Value</span><span class="op" id="5095651">)</span>&nbsp;<span class="builtintype" id="5095653">error</span>&nbsp;<span class="op" id="5095659">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5095662">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5095729">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5095758">if</span>&nbsp;<span class="ident" id="5095761">value</span><span class="op" id="5095766">.</span><span class="ident" id="5095767">Kind</span><span class="op" id="5095771">(</span><span class="op" id="5095772">)</span>&nbsp;<span class="op" id="5095774">==</span>&nbsp;<span class="ident" id="5095777">reflect</span><span class="op" id="5095784">.</span><span class="ident" id="5095785">Ptr</span>&nbsp;<span class="op" id="5095789">&amp;&amp;</span>&nbsp;<span class="ident" id="5095792">value</span><span class="op" id="5095797">.</span><span class="ident" id="5095798">IsNil</span><span class="op" id="5095803">(</span><span class="op" id="5095804">)</span>&nbsp;<span class="op" id="5095806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5095810">panic</span><span class="op" id="5095815">(</span><span class="string" id="5095816">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5095858">+</span>&nbsp;<span class="ident" id="5095860">value</span><span class="op" id="5095865">.</span><span class="ident" id="5095866">Type</span><span class="op" id="5095870">(</span><span class="op" id="5095871">)</span><span class="op" id="5095872">.</span><span class="ident" id="5095873">String</span><span class="op" id="5095879">(</span><span class="op" id="5095880">)</span><span class="op" id="5095881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5095884">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5095888">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5095950">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095987">enc</span><span class="op" id="5095990">.</span><span class="ident" id="5095991">mutex</span><span class="op" id="5095996">.</span><span class="ident" id="5095997">Lock</span><span class="op" id="5096001">(</span><span class="op" id="5096002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096005">defer</span>&nbsp;<span class="ident" id="5096011">enc</span><span class="op" id="5096014">.</span><span class="ident" id="5096015">mutex</span><span class="op" id="5096020">.</span><span class="ident" id="5096021">Unlock</span><span class="op" id="5096027">(</span><span class="op" id="5096028">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096032">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096096">enc</span><span class="op" id="5096099">.</span><span class="ident" id="5096100">w</span>&nbsp;<span class="op" id="5096102">=</span>&nbsp;<span class="ident" id="5096104">enc</span><span class="op" id="5096107">.</span><span class="ident" id="5096108">w</span><span class="op" id="5096109">[</span><span class="num" id="5096110">0</span><span class="op" id="5096111">:</span><span class="num" id="5096112">1</span><span class="op" id="5096113">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096117">ut</span><span class="op" id="5096119">,</span>&nbsp;<span class="ident" id="5096121">err</span>&nbsp;<span class="op" id="5096125">:=</span>&nbsp;<span class="ident" id="5096128">validUserType</span><span class="op" id="5096141">(</span><span class="ident" id="5096142">value</span><span class="op" id="5096147">.</span><span class="ident" id="5096148">Type</span><span class="op" id="5096152">(</span><span class="op" id="5096153">)</span><span class="op" id="5096154">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096157">if</span>&nbsp;<span class="ident" id="5096160">err</span>&nbsp;<span class="op" id="5096164">!=</span>&nbsp;<span class="ident" id="5096167">nil</span>&nbsp;<span class="op" id="5096171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096175">return</span>&nbsp;<span class="ident" id="5096182">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5096187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096191">enc</span><span class="op" id="5096194">.</span><span class="ident" id="5096195">err</span>&nbsp;<span class="op" id="5096199">=</span>&nbsp;<span class="ident" id="5096201">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096206">enc</span><span class="op" id="5096209">.</span><span class="ident" id="5096210">byteBuf</span><span class="op" id="5096217">.</span><span class="ident" id="5096218">Reset</span><span class="op" id="5096223">(</span><span class="op" id="5096224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096227">enc</span><span class="op" id="5096230">.</span><span class="ident" id="5096231">byteBuf</span><span class="op" id="5096238">.</span><span class="ident" id="5096239">Write</span><span class="op" id="5096244">(</span><span class="ident" id="5096245">spaceForLength</span><span class="op" id="5096259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096262">state</span>&nbsp;<span class="op" id="5096268">:=</span>&nbsp;<span class="ident" id="5096271">enc</span><span class="op" id="5096274">.</span><span class="ident" id="5096275">newEncoderState</span><span class="op" id="5096290">(</span><span class="op" id="5096291">&amp;</span><span class="ident" id="5096292">enc</span><span class="op" id="5096295">.</span><span class="ident" id="5096296">byteBuf</span><span class="op" id="5096303">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096307">enc</span><span class="op" id="5096310">.</span><span class="ident" id="5096311">sendTypeDescriptor</span><span class="op" id="5096329">(</span><span class="ident" id="5096330">enc</span><span class="op" id="5096333">.</span><span class="ident" id="5096334">writer</span><span class="op" id="5096340">(</span><span class="op" id="5096341">)</span><span class="op" id="5096342">,</span>&nbsp;<span class="ident" id="5096344">state</span><span class="op" id="5096349">,</span>&nbsp;<span class="ident" id="5096351">ut</span><span class="op" id="5096353">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096356">enc</span><span class="op" id="5096359">.</span><span class="ident" id="5096360">sendTypeId</span><span class="op" id="5096370">(</span><span class="ident" id="5096371">state</span><span class="op" id="5096376">,</span>&nbsp;<span class="ident" id="5096378">ut</span><span class="op" id="5096380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096383">if</span>&nbsp;<span class="ident" id="5096386">enc</span><span class="op" id="5096389">.</span><span class="ident" id="5096390">err</span>&nbsp;<span class="op" id="5096394">!=</span>&nbsp;<span class="ident" id="5096397">nil</span>&nbsp;<span class="op" id="5096401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096405">return</span>&nbsp;<span class="ident" id="5096412">enc</span><span class="op" id="5096415">.</span><span class="ident" id="5096416">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5096421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096425">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096448">enc</span><span class="op" id="5096451">.</span><span class="ident" id="5096452">encode</span><span class="op" id="5096458">(</span><span class="ident" id="5096459">state</span><span class="op" id="5096464">.</span><span class="ident" id="5096465">b</span><span class="op" id="5096466">,</span>&nbsp;<span class="ident" id="5096468">value</span><span class="op" id="5096473">,</span>&nbsp;<span class="ident" id="5096475">ut</span><span class="op" id="5096477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096480">if</span>&nbsp;<span class="ident" id="5096483">enc</span><span class="op" id="5096486">.</span><span class="ident" id="5096487">err</span>&nbsp;<span class="op" id="5096491">==</span>&nbsp;<span class="ident" id="5096494">nil</span>&nbsp;<span class="op" id="5096498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096502">enc</span><span class="op" id="5096505">.</span><span class="ident" id="5096506">writeMessage</span><span class="op" id="5096518">(</span><span class="ident" id="5096519">enc</span><span class="op" id="5096522">.</span><span class="ident" id="5096523">writer</span><span class="op" id="5096529">(</span><span class="op" id="5096530">)</span><span class="op" id="5096531">,</span>&nbsp;<span class="ident" id="5096533">state</span><span class="op" id="5096538">.</span><span class="ident" id="5096539">b</span><span class="op" id="5096540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5096543">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096547">enc</span><span class="op" id="5096550">.</span><span class="ident" id="5096551">freeEncoderState</span><span class="op" id="5096567">(</span><span class="ident" id="5096568">state</span><span class="op" id="5096573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096576">return</span>&nbsp;<span class="ident" id="5096583">enc</span><span class="op" id="5096586">.</span><span class="ident" id="5096587">err</span><br>
<span class="lineno"></span><span class="op" id="5096591">}</span>
</div>
</body>
</html>
