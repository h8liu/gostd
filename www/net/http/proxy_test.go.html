<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;os&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;TODO(mattn):</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsptest&nbsp;ProxyAuth</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">UseProxyTests</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">host</span>&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">match</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span><span class="op">}</span><span class="op">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Never&nbsp;proxy&nbsp;localhost:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;localhost:80&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;127.0.0.2&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;[::2]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="comment">//&nbsp;not&nbsp;a&nbsp;loopback&nbsp;address</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;barbaz.net&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">}</span><span class="op">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;match&nbsp;as&nbsp;.barbaz.net</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;foobar.com&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">}</span><span class="op">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;have&nbsp;a&nbsp;port&nbsp;but&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;foofoobar.com&#34;</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;not&nbsp;match&nbsp;as&nbsp;a&nbsp;part&nbsp;of&nbsp;foobar.com</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;baz.com&#34;</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;not&nbsp;match&nbsp;as&nbsp;a&nbsp;part&nbsp;of&nbsp;barbaz.com</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;localhost.net&#34;</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;not&nbsp;match&nbsp;as&nbsp;suffix&nbsp;of&nbsp;address</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;local.localhost&#34;</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="comment">//&nbsp;not&nbsp;match&nbsp;as&nbsp;prefix&nbsp;as&nbsp;address</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;barbarbaz.net&#34;</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;not&nbsp;match&nbsp;because&nbsp;NO_PROXY&nbsp;have&nbsp;a&nbsp;&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;www.foobar.com&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="comment">//&nbsp;match&nbsp;because&nbsp;NO_PROXY&nbsp;includes&nbsp;&#34;foobar.com&#34;</span><br>
<span class="lineno">35</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestUseProxy</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ResetProxyEnv</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Setenv</span><span class="op">(</span><span class="string">&#34;NO_PROXY&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;foobar.com,&nbsp;.barbaz.net&#34;</span><span class="op">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">test</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">UseProxyTests</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">useProxy</span><span class="op">(</span><span class="ident">test</span><span class="op">.</span><span class="ident">host</span><span class="op">+</span><span class="string">&#34;:80&#34;</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">match</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;useProxy(%v)&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">host</span><span class="op">,</span>&nbsp;<span class="op">!</span><span class="ident">test</span><span class="op">.</span><span class="ident">match</span><span class="op">,</span>&nbsp;<span class="ident">test</span><span class="op">.</span><span class="ident">match</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">45</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">cacheKeysTests</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">proxy</span>&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">scheme</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">addr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">key</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span><span class="op">}</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;http&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;foo.com&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;|http|foo.com&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;https&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;foo.com&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;|https|foo.com&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;http://foo.com&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;http&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;foo.com&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;http://foo.com|http|&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;http://foo.com&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;https&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;foo.com&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;http://foo.com|https|foo.com&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestCacheKeys</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">tt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">cacheKeysTests</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">proxy</span>&nbsp;<span class="op">*</span><span class="ident">url</span><span class="op">.</span><span class="ident">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">proxy</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">url</span><span class="op">.</span><span class="ident">Parse</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">proxy</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatal</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">proxy</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cm</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">connectMethod</span><span class="op">{</span><span class="ident">proxy</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">scheme</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">addr</span><span class="op">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">got</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">cm</span><span class="op">.</span><span class="ident">key</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">got</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">key</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;{%q,&nbsp;%q,&nbsp;%q}&nbsp;cache&nbsp;key&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">proxy</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">scheme</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">addr</span><span class="op">,</span>&nbsp;<span class="ident">got</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">key</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">ResetProxyEnv</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;HTTP_PROXY&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;http_proxy&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;NO_PROXY&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;no_proxy&#34;</span><span class="op">}</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Setenv</span><span class="op">(</span><span class="ident">v</span><span class="op">,</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ResetCachedEnvironment</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
