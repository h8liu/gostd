<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html" class="current">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5924299">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5924354">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5924408">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5924459">package</span>&nbsp;<span class="ident" id="5924467">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5924472">import</span>&nbsp;<span class="op" id="5924479">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5924482">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5924488">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5924499">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5924506">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5924509">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5924584">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="5924615">type</span>&nbsp;<span class="ident" id="5924620">Encoder</span>&nbsp;<span class="keyword" id="5924628">struct</span>&nbsp;<span class="op" id="5924635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5924638">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5924649">sync</span><span class="op" id="5924653">.</span><span class="ident" id="5924654">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5924673">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5924711">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5924722">[</span><span class="op" id="5924723">]</span><span class="ident" id="5924724">io</span><span class="op" id="5924726">.</span><span class="ident" id="5924727">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5924746">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5924773">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5924784">map</span><span class="op" id="5924787">[</span><span class="ident" id="5924788">reflect</span><span class="op" id="5924795">.</span><span class="ident" id="5924796">Type</span><span class="op" id="5924800">]</span><span class="ident" id="5924801">typeId</span>&nbsp;<span class="comment" id="5924808">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5924843">countState</span>&nbsp;<span class="op" id="5924854">*</span><span class="ident" id="5924855">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5924878">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5924907">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5924918">*</span><span class="ident" id="5924919">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5924942">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5924994">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5925005">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5925029">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5925067">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5925078">error</span><br>
<span class="lineno"></span><span class="op" id="5925084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5925087">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5925154">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5925221">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="5925283">const</span>&nbsp;<span class="ident" id="5925289">maxLength</span>&nbsp;<span class="op" id="5925299">=</span>&nbsp;<span class="num" id="5925301">9</span>&nbsp;<span class="comment" id="5925303">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="5925341">var</span>&nbsp;<span class="ident" id="5925345">spaceForLength</span>&nbsp;<span class="op" id="5925360">=</span>&nbsp;<span class="builtinfunc" id="5925362">make</span><span class="op" id="5925366">(</span><span class="op" id="5925367">[</span><span class="op" id="5925368">]</span><span class="builtintype" id="5925369">byte</span><span class="op" id="5925373">,</span>&nbsp;<span class="ident" id="5925375">maxLength</span><span class="op" id="5925384">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="5925387">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5925460">func</span>&nbsp;<span class="ident" id="5925465">NewEncoder</span><span class="op" id="5925475">(</span><span class="ident" id="5925476">w</span>&nbsp;<span class="ident" id="5925478">io</span><span class="op" id="5925480">.</span><span class="ident" id="5925481">Writer</span><span class="op" id="5925487">)</span>&nbsp;<span class="op" id="5925489">*</span><span class="ident" id="5925490">Encoder</span>&nbsp;<span class="op" id="5925498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5925501">enc</span>&nbsp;<span class="op" id="5925505">:=</span>&nbsp;<span class="builtinfunc" id="5925508">new</span><span class="op" id="5925511">(</span><span class="ident" id="5925512">Encoder</span><span class="op" id="5925519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5925522">enc</span><span class="op" id="5925525">.</span><span class="ident" id="5925526">w</span>&nbsp;<span class="op" id="5925528">=</span>&nbsp;<span class="op" id="5925530">[</span><span class="op" id="5925531">]</span><span class="ident" id="5925532">io</span><span class="op" id="5925534">.</span><span class="ident" id="5925535">Writer</span><span class="op" id="5925541">{</span><span class="ident" id="5925542">w</span><span class="op" id="5925543">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5925546">enc</span><span class="op" id="5925549">.</span><span class="ident" id="5925550">sent</span>&nbsp;<span class="op" id="5925555">=</span>&nbsp;<span class="builtinfunc" id="5925557">make</span><span class="op" id="5925561">(</span><span class="keyword" id="5925562">map</span><span class="op" id="5925565">[</span><span class="ident" id="5925566">reflect</span><span class="op" id="5925573">.</span><span class="ident" id="5925574">Type</span><span class="op" id="5925578">]</span><span class="ident" id="5925579">typeId</span><span class="op" id="5925585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5925588">enc</span><span class="op" id="5925591">.</span><span class="ident" id="5925592">countState</span>&nbsp;<span class="op" id="5925603">=</span>&nbsp;<span class="ident" id="5925605">enc</span><span class="op" id="5925608">.</span><span class="ident" id="5925609">newEncoderState</span><span class="op" id="5925624">(</span><span class="builtinfunc" id="5925625">new</span><span class="op" id="5925628">(</span><span class="ident" id="5925629">encBuffer</span><span class="op" id="5925638">)</span><span class="op" id="5925639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5925642">return</span>&nbsp;<span class="ident" id="5925649">enc</span><br>
<span class="lineno"></span><span class="op" id="5925653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="5925656">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="5925718">func</span>&nbsp;<span class="op" id="5925723">(</span><span class="ident" id="5925724">enc</span>&nbsp;<span class="op" id="5925728">*</span><span class="ident" id="5925729">Encoder</span><span class="op" id="5925736">)</span>&nbsp;<span class="ident" id="5925738">writer</span><span class="op" id="5925744">(</span><span class="op" id="5925745">)</span>&nbsp;<span class="ident" id="5925747">io</span><span class="op" id="5925749">.</span><span class="ident" id="5925750">Writer</span>&nbsp;<span class="op" id="5925757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5925760">return</span>&nbsp;<span class="ident" id="5925767">enc</span><span class="op" id="5925770">.</span><span class="ident" id="5925771">w</span><span class="op" id="5925772">[</span><span class="builtinfunc" id="5925773">len</span><span class="op" id="5925776">(</span><span class="ident" id="5925777">enc</span><span class="op" id="5925780">.</span><span class="ident" id="5925781">w</span><span class="op" id="5925782">)</span><span class="op" id="5925783">-</span><span class="num" id="5925784">1</span><span class="op" id="5925785">]</span><br>
<span class="lineno"></span><span class="op" id="5925787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5925790">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="5925834">func</span>&nbsp;<span class="op" id="5925839">(</span><span class="ident" id="5925840">enc</span>&nbsp;<span class="op" id="5925844">*</span><span class="ident" id="5925845">Encoder</span><span class="op" id="5925852">)</span>&nbsp;<span class="ident" id="5925854">pushWriter</span><span class="op" id="5925864">(</span><span class="ident" id="5925865">w</span>&nbsp;<span class="ident" id="5925867">io</span><span class="op" id="5925869">.</span><span class="ident" id="5925870">Writer</span><span class="op" id="5925876">)</span>&nbsp;<span class="op" id="5925878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5925881">enc</span><span class="op" id="5925884">.</span><span class="ident" id="5925885">w</span>&nbsp;<span class="op" id="5925887">=</span>&nbsp;<span class="builtinfunc" id="5925889">append</span><span class="op" id="5925895">(</span><span class="ident" id="5925896">enc</span><span class="op" id="5925899">.</span><span class="ident" id="5925900">w</span><span class="op" id="5925901">,</span>&nbsp;<span class="ident" id="5925903">w</span><span class="op" id="5925904">)</span><br>
<span class="lineno"></span><span class="op" id="5925906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5925909">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5925949">func</span>&nbsp;<span class="op" id="5925954">(</span><span class="ident" id="5925955">enc</span>&nbsp;<span class="op" id="5925959">*</span><span class="ident" id="5925960">Encoder</span><span class="op" id="5925967">)</span>&nbsp;<span class="ident" id="5925969">popWriter</span><span class="op" id="5925978">(</span><span class="op" id="5925979">)</span>&nbsp;<span class="op" id="5925981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5925984">enc</span><span class="op" id="5925987">.</span><span class="ident" id="5925988">w</span>&nbsp;<span class="op" id="5925990">=</span>&nbsp;<span class="ident" id="5925992">enc</span><span class="op" id="5925995">.</span><span class="ident" id="5925996">w</span><span class="op" id="5925997">[</span><span class="num" id="5925998">0</span>&nbsp;<span class="op" id="5926000">:</span>&nbsp;<span class="builtinfunc" id="5926002">len</span><span class="op" id="5926005">(</span><span class="ident" id="5926006">enc</span><span class="op" id="5926009">.</span><span class="ident" id="5926010">w</span><span class="op" id="5926011">)</span><span class="op" id="5926012">-</span><span class="num" id="5926013">1</span><span class="op" id="5926014">]</span><br>
<span class="lineno"></span><span class="op" id="5926016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5926019">func</span>&nbsp;<span class="op" id="5926024">(</span><span class="ident" id="5926025">enc</span>&nbsp;<span class="op" id="5926029">*</span><span class="ident" id="5926030">Encoder</span><span class="op" id="5926037">)</span>&nbsp;<span class="ident" id="5926039">setError</span><span class="op" id="5926047">(</span><span class="ident" id="5926048">err</span>&nbsp;<span class="builtintype" id="5926052">error</span><span class="op" id="5926057">)</span>&nbsp;<span class="op" id="5926059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5926062">if</span>&nbsp;<span class="ident" id="5926065">enc</span><span class="op" id="5926068">.</span><span class="ident" id="5926069">err</span>&nbsp;<span class="op" id="5926073">==</span>&nbsp;<span class="builtintype" id="5926076">nil</span>&nbsp;<span class="op" id="5926080">{</span>&nbsp;<span class="comment" id="5926082">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5926107">enc</span><span class="op" id="5926110">.</span><span class="ident" id="5926111">err</span>&nbsp;<span class="op" id="5926115">=</span>&nbsp;<span class="ident" id="5926117">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5926122">}</span><br>
<span class="lineno"></span><span class="op" id="5926124">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="5926127">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="5926207">func</span>&nbsp;<span class="op" id="5926212">(</span><span class="ident" id="5926213">enc</span>&nbsp;<span class="op" id="5926217">*</span><span class="ident" id="5926218">Encoder</span><span class="op" id="5926225">)</span>&nbsp;<span class="ident" id="5926227">writeMessage</span><span class="op" id="5926239">(</span><span class="ident" id="5926240">w</span>&nbsp;<span class="ident" id="5926242">io</span><span class="op" id="5926244">.</span><span class="ident" id="5926245">Writer</span><span class="op" id="5926251">,</span>&nbsp;<span class="ident" id="5926253">b</span>&nbsp;<span class="op" id="5926255">*</span><span class="ident" id="5926256">encBuffer</span><span class="op" id="5926265">)</span>&nbsp;<span class="op" id="5926267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5926270">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5926341">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5926421">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5926437">message</span>&nbsp;<span class="op" id="5926445">:=</span>&nbsp;<span class="ident" id="5926448">b</span><span class="op" id="5926449">.</span><span class="ident" id="5926450">Bytes</span><span class="op" id="5926455">(</span><span class="op" id="5926456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5926459">messageLen</span>&nbsp;<span class="op" id="5926470">:=</span>&nbsp;<span class="builtinfunc" id="5926473">len</span><span class="op" id="5926476">(</span><span class="ident" id="5926477">message</span><span class="op" id="5926484">)</span>&nbsp;<span class="op" id="5926486">-</span>&nbsp;<span class="ident" id="5926488">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5926499">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5926522">enc</span><span class="op" id="5926525">.</span><span class="ident" id="5926526">countState</span><span class="op" id="5926536">.</span><span class="ident" id="5926537">b</span><span class="op" id="5926538">.</span><span class="ident" id="5926539">Reset</span><span class="op" id="5926544">(</span><span class="op" id="5926545">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5926548">enc</span><span class="op" id="5926551">.</span><span class="ident" id="5926552">countState</span><span class="op" id="5926562">.</span><span class="ident" id="5926563">encodeUint</span><span class="op" id="5926573">(</span><span class="ident" id="5926574">uint64</span><span class="op" id="5926580">(</span><span class="ident" id="5926581">messageLen</span><span class="op" id="5926591">)</span><span class="op" id="5926592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5926595">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5926646">offset</span>&nbsp;<span class="op" id="5926653">:=</span>&nbsp;<span class="ident" id="5926656">maxLength</span>&nbsp;<span class="op" id="5926666">-</span>&nbsp;<span class="ident" id="5926668">enc</span><span class="op" id="5926671">.</span><span class="ident" id="5926672">countState</span><span class="op" id="5926682">.</span><span class="ident" id="5926683">b</span><span class="op" id="5926684">.</span><span class="ident" id="5926685">Len</span><span class="op" id="5926688">(</span><span class="op" id="5926689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5926692">copy</span><span class="op" id="5926696">(</span><span class="ident" id="5926697">message</span><span class="op" id="5926704">[</span><span class="ident" id="5926705">offset</span><span class="op" id="5926711">:</span><span class="op" id="5926712">]</span><span class="op" id="5926713">,</span>&nbsp;<span class="ident" id="5926715">enc</span><span class="op" id="5926718">.</span><span class="ident" id="5926719">countState</span><span class="op" id="5926729">.</span><span class="ident" id="5926730">b</span><span class="op" id="5926731">.</span><span class="ident" id="5926732">Bytes</span><span class="op" id="5926737">(</span><span class="op" id="5926738">)</span><span class="op" id="5926739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5926742">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5926762">_</span><span class="op" id="5926763">,</span>&nbsp;<span class="ident" id="5926765">err</span>&nbsp;<span class="op" id="5926769">:=</span>&nbsp;<span class="ident" id="5926772">w</span><span class="op" id="5926773">.</span><span class="ident" id="5926774">Write</span><span class="op" id="5926779">(</span><span class="ident" id="5926780">message</span><span class="op" id="5926787">[</span><span class="ident" id="5926788">offset</span><span class="op" id="5926794">:</span><span class="op" id="5926795">]</span><span class="op" id="5926796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5926799">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5926890">b</span><span class="op" id="5926891">.</span><span class="ident" id="5926892">Reset</span><span class="op" id="5926897">(</span><span class="op" id="5926898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5926901">b</span><span class="op" id="5926902">.</span><span class="ident" id="5926903">Write</span><span class="op" id="5926908">(</span><span class="ident" id="5926909">spaceForLength</span><span class="op" id="5926923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5926926">if</span>&nbsp;<span class="ident" id="5926929">err</span>&nbsp;<span class="op" id="5926933">!=</span>&nbsp;<span class="builtintype" id="5926936">nil</span>&nbsp;<span class="op" id="5926940">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5926944">enc</span><span class="op" id="5926947">.</span><span class="ident" id="5926948">setError</span><span class="op" id="5926956">(</span><span class="ident" id="5926957">err</span><span class="op" id="5926960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5926963">}</span><br>
<span class="lineno"></span><span class="op" id="5926965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5926968">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="5927050">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="5927076">func</span>&nbsp;<span class="op" id="5927081">(</span><span class="ident" id="5927082">enc</span>&nbsp;<span class="op" id="5927086">*</span><span class="ident" id="5927087">Encoder</span><span class="op" id="5927094">)</span>&nbsp;<span class="ident" id="5927096">sendActualType</span><span class="op" id="5927110">(</span><span class="ident" id="5927111">w</span>&nbsp;<span class="ident" id="5927113">io</span><span class="op" id="5927115">.</span><span class="ident" id="5927116">Writer</span><span class="op" id="5927122">,</span>&nbsp;<span class="ident" id="5927124">state</span>&nbsp;<span class="op" id="5927130">*</span><span class="ident" id="5927131">encoderState</span><span class="op" id="5927143">,</span>&nbsp;<span class="ident" id="5927145">ut</span>&nbsp;<span class="op" id="5927148">*</span><span class="ident" id="5927149">userTypeInfo</span><span class="op" id="5927161">,</span>&nbsp;<span class="ident" id="5927163">actual</span>&nbsp;<span class="ident" id="5927170">reflect</span><span class="op" id="5927177">.</span><span class="ident" id="5927178">Type</span><span class="op" id="5927182">)</span>&nbsp;<span class="op" id="5927184">(</span><span class="ident" id="5927185">sent</span>&nbsp;<span class="builtintype" id="5927190">bool</span><span class="op" id="5927194">)</span>&nbsp;<span class="op" id="5927196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5927199">if</span>&nbsp;<span class="ident" id="5927202">_</span><span class="op" id="5927203">,</span>&nbsp;<span class="ident" id="5927205">alreadySent</span>&nbsp;<span class="op" id="5927217">:=</span>&nbsp;<span class="ident" id="5927220">enc</span><span class="op" id="5927223">.</span><span class="ident" id="5927224">sent</span><span class="op" id="5927228">[</span><span class="ident" id="5927229">actual</span><span class="op" id="5927235">]</span><span class="op" id="5927236">;</span>&nbsp;<span class="ident" id="5927238">alreadySent</span>&nbsp;<span class="op" id="5927250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5927254">return</span>&nbsp;<span class="builtintype" id="5927261">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5927268">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5927271">info</span><span class="op" id="5927275">,</span>&nbsp;<span class="ident" id="5927277">err</span>&nbsp;<span class="op" id="5927281">:=</span>&nbsp;<span class="ident" id="5927284">getTypeInfo</span><span class="op" id="5927295">(</span><span class="ident" id="5927296">ut</span><span class="op" id="5927298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5927301">if</span>&nbsp;<span class="ident" id="5927304">err</span>&nbsp;<span class="op" id="5927308">!=</span>&nbsp;<span class="builtintype" id="5927311">nil</span>&nbsp;<span class="op" id="5927315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5927319">enc</span><span class="op" id="5927322">.</span><span class="ident" id="5927323">setError</span><span class="op" id="5927331">(</span><span class="ident" id="5927332">err</span><span class="op" id="5927335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5927339">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5927347">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5927350">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5927380">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5927388">state</span><span class="op" id="5927393">.</span><span class="ident" id="5927394">encodeInt</span><span class="op" id="5927403">(</span><span class="op" id="5927404">-</span><span class="ident" id="5927405">int64</span><span class="op" id="5927410">(</span><span class="ident" id="5927411">info</span><span class="op" id="5927415">.</span><span class="ident" id="5927416">id</span><span class="op" id="5927418">)</span><span class="op" id="5927419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5927422">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5927432">enc</span><span class="op" id="5927435">.</span><span class="ident" id="5927436">encode</span><span class="op" id="5927442">(</span><span class="ident" id="5927443">state</span><span class="op" id="5927448">.</span><span class="ident" id="5927449">b</span><span class="op" id="5927450">,</span>&nbsp;<span class="ident" id="5927452">reflect</span><span class="op" id="5927459">.</span><span class="ident" id="5927460">ValueOf</span><span class="op" id="5927467">(</span><span class="ident" id="5927468">info</span><span class="op" id="5927472">.</span><span class="ident" id="5927473">wire</span><span class="op" id="5927477">)</span><span class="op" id="5927478">,</span>&nbsp;<span class="ident" id="5927480">wireTypeUserInfo</span><span class="op" id="5927496">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5927499">enc</span><span class="op" id="5927502">.</span><span class="ident" id="5927503">writeMessage</span><span class="op" id="5927515">(</span><span class="ident" id="5927516">w</span><span class="op" id="5927517">,</span>&nbsp;<span class="ident" id="5927519">state</span><span class="op" id="5927524">.</span><span class="ident" id="5927525">b</span><span class="op" id="5927526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5927529">if</span>&nbsp;<span class="ident" id="5927532">enc</span><span class="op" id="5927535">.</span><span class="ident" id="5927536">err</span>&nbsp;<span class="op" id="5927540">!=</span>&nbsp;<span class="builtintype" id="5927543">nil</span>&nbsp;<span class="op" id="5927547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5927551">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5927559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5927563">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5927644">enc</span><span class="op" id="5927647">.</span><span class="ident" id="5927648">sent</span><span class="op" id="5927652">[</span><span class="ident" id="5927653">ut</span><span class="op" id="5927655">.</span><span class="ident" id="5927656">base</span><span class="op" id="5927660">]</span>&nbsp;<span class="op" id="5927662">=</span>&nbsp;<span class="ident" id="5927664">info</span><span class="op" id="5927668">.</span><span class="ident" id="5927669">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5927673">if</span>&nbsp;<span class="ident" id="5927676">ut</span><span class="op" id="5927678">.</span><span class="ident" id="5927679">user</span>&nbsp;<span class="op" id="5927684">!=</span>&nbsp;<span class="ident" id="5927687">ut</span><span class="op" id="5927689">.</span><span class="ident" id="5927690">base</span>&nbsp;<span class="op" id="5927695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5927699">enc</span><span class="op" id="5927702">.</span><span class="ident" id="5927703">sent</span><span class="op" id="5927707">[</span><span class="ident" id="5927708">ut</span><span class="op" id="5927710">.</span><span class="ident" id="5927711">user</span><span class="op" id="5927715">]</span>&nbsp;<span class="op" id="5927717">=</span>&nbsp;<span class="ident" id="5927719">info</span><span class="op" id="5927723">.</span><span class="ident" id="5927724">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5927728">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5927731">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5927760">switch</span>&nbsp;<span class="ident" id="5927767">st</span>&nbsp;<span class="op" id="5927770">:=</span>&nbsp;<span class="ident" id="5927773">actual</span><span class="op" id="5927779">;</span>&nbsp;<span class="ident" id="5927781">st</span><span class="op" id="5927783">.</span><span class="ident" id="5927784">Kind</span><span class="op" id="5927788">(</span><span class="op" id="5927789">)</span>&nbsp;<span class="op" id="5927791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5927794">case</span>&nbsp;<span class="ident" id="5927799">reflect</span><span class="op" id="5927806">.</span><span class="ident" id="5927807">Struct</span><span class="op" id="5927813">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5927817">for</span>&nbsp;<span class="ident" id="5927821">i</span>&nbsp;<span class="op" id="5927823">:=</span>&nbsp;<span class="num" id="5927826">0</span><span class="op" id="5927827">;</span>&nbsp;<span class="ident" id="5927829">i</span>&nbsp;<span class="op" id="5927831">&lt;</span>&nbsp;<span class="ident" id="5927833">st</span><span class="op" id="5927835">.</span><span class="ident" id="5927836">NumField</span><span class="op" id="5927844">(</span><span class="op" id="5927845">)</span><span class="op" id="5927846">;</span>&nbsp;<span class="ident" id="5927848">i</span><span class="op" id="5927849">++</span>&nbsp;<span class="op" id="5927852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5927857">if</span>&nbsp;<span class="ident" id="5927860">isExported</span><span class="op" id="5927870">(</span><span class="ident" id="5927871">st</span><span class="op" id="5927873">.</span><span class="ident" id="5927874">Field</span><span class="op" id="5927879">(</span><span class="ident" id="5927880">i</span><span class="op" id="5927881">)</span><span class="op" id="5927882">.</span><span class="ident" id="5927883">Name</span><span class="op" id="5927887">)</span>&nbsp;<span class="op" id="5927889">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5927895">enc</span><span class="op" id="5927898">.</span><span class="ident" id="5927899">sendType</span><span class="op" id="5927907">(</span><span class="ident" id="5927908">w</span><span class="op" id="5927909">,</span>&nbsp;<span class="ident" id="5927911">state</span><span class="op" id="5927916">,</span>&nbsp;<span class="ident" id="5927918">st</span><span class="op" id="5927920">.</span><span class="ident" id="5927921">Field</span><span class="op" id="5927926">(</span><span class="ident" id="5927927">i</span><span class="op" id="5927928">)</span><span class="op" id="5927929">.</span><span class="ident" id="5927930">Type</span><span class="op" id="5927934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5927939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5927943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5927946">case</span>&nbsp;<span class="ident" id="5927951">reflect</span><span class="op" id="5927958">.</span><span class="ident" id="5927959">Array</span><span class="op" id="5927964">,</span>&nbsp;<span class="ident" id="5927966">reflect</span><span class="op" id="5927973">.</span><span class="ident" id="5927974">Slice</span><span class="op" id="5927979">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5927983">enc</span><span class="op" id="5927986">.</span><span class="ident" id="5927987">sendType</span><span class="op" id="5927995">(</span><span class="ident" id="5927996">w</span><span class="op" id="5927997">,</span>&nbsp;<span class="ident" id="5927999">state</span><span class="op" id="5928004">,</span>&nbsp;<span class="ident" id="5928006">st</span><span class="op" id="5928008">.</span><span class="ident" id="5928009">Elem</span><span class="op" id="5928013">(</span><span class="op" id="5928014">)</span><span class="op" id="5928015">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928018">case</span>&nbsp;<span class="ident" id="5928023">reflect</span><span class="op" id="5928030">.</span><span class="ident" id="5928031">Map</span><span class="op" id="5928034">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5928038">enc</span><span class="op" id="5928041">.</span><span class="ident" id="5928042">sendType</span><span class="op" id="5928050">(</span><span class="ident" id="5928051">w</span><span class="op" id="5928052">,</span>&nbsp;<span class="ident" id="5928054">state</span><span class="op" id="5928059">,</span>&nbsp;<span class="ident" id="5928061">st</span><span class="op" id="5928063">.</span><span class="ident" id="5928064">Key</span><span class="op" id="5928067">(</span><span class="op" id="5928068">)</span><span class="op" id="5928069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5928073">enc</span><span class="op" id="5928076">.</span><span class="ident" id="5928077">sendType</span><span class="op" id="5928085">(</span><span class="ident" id="5928086">w</span><span class="op" id="5928087">,</span>&nbsp;<span class="ident" id="5928089">state</span><span class="op" id="5928094">,</span>&nbsp;<span class="ident" id="5928096">st</span><span class="op" id="5928098">.</span><span class="ident" id="5928099">Elem</span><span class="op" id="5928103">(</span><span class="op" id="5928104">)</span><span class="op" id="5928105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5928108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928111">return</span>&nbsp;<span class="builtintype" id="5928118">true</span><br>
<span class="lineno">125</span><span class="op" id="5928123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5928126">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5928191">func</span>&nbsp;<span class="op" id="5928196">(</span><span class="ident" id="5928197">enc</span>&nbsp;<span class="op" id="5928201">*</span><span class="ident" id="5928202">Encoder</span><span class="op" id="5928209">)</span>&nbsp;<span class="ident" id="5928211">sendType</span><span class="op" id="5928219">(</span><span class="ident" id="5928220">w</span>&nbsp;<span class="ident" id="5928222">io</span><span class="op" id="5928224">.</span><span class="ident" id="5928225">Writer</span><span class="op" id="5928231">,</span>&nbsp;<span class="ident" id="5928233">state</span>&nbsp;<span class="op" id="5928239">*</span><span class="ident" id="5928240">encoderState</span><span class="op" id="5928252">,</span>&nbsp;<span class="ident" id="5928254">origt</span>&nbsp;<span class="ident" id="5928260">reflect</span><span class="op" id="5928267">.</span><span class="ident" id="5928268">Type</span><span class="op" id="5928272">)</span>&nbsp;<span class="op" id="5928274">(</span><span class="ident" id="5928275">sent</span>&nbsp;<span class="builtintype" id="5928280">bool</span><span class="op" id="5928284">)</span>&nbsp;<span class="op" id="5928286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5928289">ut</span>&nbsp;<span class="op" id="5928292">:=</span>&nbsp;<span class="ident" id="5928295">userType</span><span class="op" id="5928303">(</span><span class="ident" id="5928304">origt</span><span class="op" id="5928309">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928312">if</span>&nbsp;<span class="ident" id="5928315">ut</span><span class="op" id="5928317">.</span><span class="ident" id="5928318">externalEnc</span>&nbsp;<span class="op" id="5928330">!=</span>&nbsp;<span class="num" id="5928333">0</span>&nbsp;<span class="op" id="5928335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5928339">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5928421">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928493">return</span>&nbsp;<span class="ident" id="5928500">enc</span><span class="op" id="5928503">.</span><span class="ident" id="5928504">sendActualType</span><span class="op" id="5928518">(</span><span class="ident" id="5928519">w</span><span class="op" id="5928520">,</span>&nbsp;<span class="ident" id="5928522">state</span><span class="op" id="5928527">,</span>&nbsp;<span class="ident" id="5928529">ut</span><span class="op" id="5928531">,</span>&nbsp;<span class="ident" id="5928533">ut</span><span class="op" id="5928535">.</span><span class="ident" id="5928536">base</span><span class="op" id="5928540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5928543">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5928547">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928606">switch</span>&nbsp;<span class="ident" id="5928613">rt</span>&nbsp;<span class="op" id="5928616">:=</span>&nbsp;<span class="ident" id="5928619">ut</span><span class="op" id="5928621">.</span><span class="ident" id="5928622">base</span><span class="op" id="5928626">;</span>&nbsp;<span class="ident" id="5928628">rt</span><span class="op" id="5928630">.</span><span class="ident" id="5928631">Kind</span><span class="op" id="5928635">(</span><span class="op" id="5928636">)</span>&nbsp;<span class="op" id="5928638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928641">default</span><span class="op" id="5928648">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5928652">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928713">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928721">case</span>&nbsp;<span class="ident" id="5928726">reflect</span><span class="op" id="5928733">.</span><span class="ident" id="5928734">Slice</span><span class="op" id="5928739">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5928743">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928800">if</span>&nbsp;<span class="ident" id="5928803">rt</span><span class="op" id="5928805">.</span><span class="ident" id="5928806">Elem</span><span class="op" id="5928810">(</span><span class="op" id="5928811">)</span><span class="op" id="5928812">.</span><span class="ident" id="5928813">Kind</span><span class="op" id="5928817">(</span><span class="op" id="5928818">)</span>&nbsp;<span class="op" id="5928820">==</span>&nbsp;<span class="ident" id="5928823">reflect</span><span class="op" id="5928830">.</span><span class="ident" id="5928831">Uint8</span>&nbsp;<span class="op" id="5928837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928842">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5928851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5928855">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928882">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928889">case</span>&nbsp;<span class="ident" id="5928894">reflect</span><span class="op" id="5928901">.</span><span class="ident" id="5928902">Array</span><span class="op" id="5928907">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5928911">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928980">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5928987">case</span>&nbsp;<span class="ident" id="5928992">reflect</span><span class="op" id="5928999">.</span><span class="ident" id="5929000">Map</span><span class="op" id="5929003">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5929007">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5929076">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5929083">case</span>&nbsp;<span class="ident" id="5929088">reflect</span><span class="op" id="5929095">.</span><span class="ident" id="5929096">Struct</span><span class="op" id="5929102">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5929106">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5929157">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5929164">case</span>&nbsp;<span class="ident" id="5929169">reflect</span><span class="op" id="5929176">.</span><span class="ident" id="5929177">Chan</span><span class="op" id="5929181">,</span>&nbsp;<span class="ident" id="5929183">reflect</span><span class="op" id="5929190">.</span><span class="ident" id="5929191">Func</span><span class="op" id="5929195">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5929199">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5929257">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5929265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5929269">return</span>&nbsp;<span class="ident" id="5929276">enc</span><span class="op" id="5929279">.</span><span class="ident" id="5929280">sendActualType</span><span class="op" id="5929294">(</span><span class="ident" id="5929295">w</span><span class="op" id="5929296">,</span>&nbsp;<span class="ident" id="5929298">state</span><span class="op" id="5929303">,</span>&nbsp;<span class="ident" id="5929305">ut</span><span class="op" id="5929307">,</span>&nbsp;<span class="ident" id="5929309">ut</span><span class="op" id="5929311">.</span><span class="ident" id="5929312">base</span><span class="op" id="5929316">)</span><br>
<span class="lineno"></span><span class="op" id="5929318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="5929321">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="5929397">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="5929477">func</span>&nbsp;<span class="op" id="5929482">(</span><span class="ident" id="5929483">enc</span>&nbsp;<span class="op" id="5929487">*</span><span class="ident" id="5929488">Encoder</span><span class="op" id="5929495">)</span>&nbsp;<span class="ident" id="5929497">Encode</span><span class="op" id="5929503">(</span><span class="ident" id="5929504">e</span>&nbsp;<span class="keyword" id="5929506">interface</span><span class="op" id="5929515">{</span><span class="op" id="5929516">}</span><span class="op" id="5929517">)</span>&nbsp;<span class="builtintype" id="5929519">error</span>&nbsp;<span class="op" id="5929525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5929528">return</span>&nbsp;<span class="ident" id="5929535">enc</span><span class="op" id="5929538">.</span><span class="ident" id="5929539">EncodeValue</span><span class="op" id="5929550">(</span><span class="ident" id="5929551">reflect</span><span class="op" id="5929558">.</span><span class="ident" id="5929559">ValueOf</span><span class="op" id="5929566">(</span><span class="ident" id="5929567">e</span><span class="op" id="5929568">)</span><span class="op" id="5929569">)</span><br>
<span class="lineno"></span><span class="op" id="5929571">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="5929574">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5929646">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="5929719">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="5929728">func</span>&nbsp;<span class="op" id="5929733">(</span><span class="ident" id="5929734">enc</span>&nbsp;<span class="op" id="5929738">*</span><span class="ident" id="5929739">Encoder</span><span class="op" id="5929746">)</span>&nbsp;<span class="ident" id="5929748">sendTypeDescriptor</span><span class="op" id="5929766">(</span><span class="ident" id="5929767">w</span>&nbsp;<span class="ident" id="5929769">io</span><span class="op" id="5929771">.</span><span class="ident" id="5929772">Writer</span><span class="op" id="5929778">,</span>&nbsp;<span class="ident" id="5929780">state</span>&nbsp;<span class="op" id="5929786">*</span><span class="ident" id="5929787">encoderState</span><span class="op" id="5929799">,</span>&nbsp;<span class="ident" id="5929801">ut</span>&nbsp;<span class="op" id="5929804">*</span><span class="ident" id="5929805">userTypeInfo</span><span class="op" id="5929817">)</span>&nbsp;<span class="op" id="5929819">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5929822">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5929873">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5929916">rt</span>&nbsp;<span class="op" id="5929919">:=</span>&nbsp;<span class="ident" id="5929922">ut</span><span class="op" id="5929924">.</span><span class="ident" id="5929925">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5929931">if</span>&nbsp;<span class="ident" id="5929934">ut</span><span class="op" id="5929936">.</span><span class="ident" id="5929937">externalEnc</span>&nbsp;<span class="op" id="5929949">!=</span>&nbsp;<span class="num" id="5929952">0</span>&nbsp;<span class="op" id="5929954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5929958">rt</span>&nbsp;<span class="op" id="5929961">=</span>&nbsp;<span class="ident" id="5929963">ut</span><span class="op" id="5929965">.</span><span class="ident" id="5929966">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5929972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5929975">if</span>&nbsp;<span class="ident" id="5929978">_</span><span class="op" id="5929979">,</span>&nbsp;<span class="ident" id="5929981">alreadySent</span>&nbsp;<span class="op" id="5929993">:=</span>&nbsp;<span class="ident" id="5929996">enc</span><span class="op" id="5929999">.</span><span class="ident" id="5930000">sent</span><span class="op" id="5930004">[</span><span class="ident" id="5930005">rt</span><span class="op" id="5930007">]</span><span class="op" id="5930008">;</span>&nbsp;<span class="op" id="5930010">!</span><span class="ident" id="5930011">alreadySent</span>&nbsp;<span class="op" id="5930023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5930027">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5930048">sent</span>&nbsp;<span class="op" id="5930053">:=</span>&nbsp;<span class="ident" id="5930056">enc</span><span class="op" id="5930059">.</span><span class="ident" id="5930060">sendType</span><span class="op" id="5930068">(</span><span class="ident" id="5930069">w</span><span class="op" id="5930070">,</span>&nbsp;<span class="ident" id="5930072">state</span><span class="op" id="5930077">,</span>&nbsp;<span class="ident" id="5930079">rt</span><span class="op" id="5930081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5930085">if</span>&nbsp;<span class="ident" id="5930088">enc</span><span class="op" id="5930091">.</span><span class="ident" id="5930092">err</span>&nbsp;<span class="op" id="5930096">!=</span>&nbsp;<span class="builtintype" id="5930099">nil</span>&nbsp;<span class="op" id="5930103">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5930108">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5930117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5930121">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5930192">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5930263">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5930330">if</span>&nbsp;<span class="op" id="5930333">!</span><span class="ident" id="5930334">sent</span>&nbsp;<span class="op" id="5930339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5930344">info</span><span class="op" id="5930348">,</span>&nbsp;<span class="ident" id="5930350">err</span>&nbsp;<span class="op" id="5930354">:=</span>&nbsp;<span class="ident" id="5930357">getTypeInfo</span><span class="op" id="5930368">(</span><span class="ident" id="5930369">ut</span><span class="op" id="5930371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5930376">if</span>&nbsp;<span class="ident" id="5930379">err</span>&nbsp;<span class="op" id="5930383">!=</span>&nbsp;<span class="builtintype" id="5930386">nil</span>&nbsp;<span class="op" id="5930390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5930396">enc</span><span class="op" id="5930399">.</span><span class="ident" id="5930400">setError</span><span class="op" id="5930408">(</span><span class="ident" id="5930409">err</span><span class="op" id="5930412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5930418">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5930428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5930433">enc</span><span class="op" id="5930436">.</span><span class="ident" id="5930437">sent</span><span class="op" id="5930441">[</span><span class="ident" id="5930442">rt</span><span class="op" id="5930444">]</span>&nbsp;<span class="op" id="5930446">=</span>&nbsp;<span class="ident" id="5930448">info</span><span class="op" id="5930452">.</span><span class="ident" id="5930453">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5930458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5930461">}</span><br>
<span class="lineno"></span><span class="op" id="5930463">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5930466">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="5930532">func</span>&nbsp;<span class="op" id="5930537">(</span><span class="ident" id="5930538">enc</span>&nbsp;<span class="op" id="5930542">*</span><span class="ident" id="5930543">Encoder</span><span class="op" id="5930550">)</span>&nbsp;<span class="ident" id="5930552">sendTypeId</span><span class="op" id="5930562">(</span><span class="ident" id="5930563">state</span>&nbsp;<span class="op" id="5930569">*</span><span class="ident" id="5930570">encoderState</span><span class="op" id="5930582">,</span>&nbsp;<span class="ident" id="5930584">ut</span>&nbsp;<span class="op" id="5930587">*</span><span class="ident" id="5930588">userTypeInfo</span><span class="op" id="5930600">)</span>&nbsp;<span class="op" id="5930602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5930605">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5930652">state</span><span class="op" id="5930657">.</span><span class="ident" id="5930658">encodeInt</span><span class="op" id="5930667">(</span><span class="ident" id="5930668">int64</span><span class="op" id="5930673">(</span><span class="ident" id="5930674">enc</span><span class="op" id="5930677">.</span><span class="ident" id="5930678">sent</span><span class="op" id="5930682">[</span><span class="ident" id="5930683">ut</span><span class="op" id="5930685">.</span><span class="ident" id="5930686">base</span><span class="op" id="5930690">]</span><span class="op" id="5930691">)</span><span class="op" id="5930692">)</span><br>
<span class="lineno">205</span><span class="op" id="5930694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5930697">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="5930773">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="5930853">func</span>&nbsp;<span class="op" id="5930858">(</span><span class="ident" id="5930859">enc</span>&nbsp;<span class="op" id="5930863">*</span><span class="ident" id="5930864">Encoder</span><span class="op" id="5930871">)</span>&nbsp;<span class="ident" id="5930873">EncodeValue</span><span class="op" id="5930884">(</span><span class="ident" id="5930885">value</span>&nbsp;<span class="ident" id="5930891">reflect</span><span class="op" id="5930898">.</span><span class="ident" id="5930899">Value</span><span class="op" id="5930904">)</span>&nbsp;<span class="builtintype" id="5930906">error</span>&nbsp;<span class="op" id="5930912">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5930915">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5930982">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5931011">if</span>&nbsp;<span class="ident" id="5931014">value</span><span class="op" id="5931019">.</span><span class="ident" id="5931020">Kind</span><span class="op" id="5931024">(</span><span class="op" id="5931025">)</span>&nbsp;<span class="op" id="5931027">==</span>&nbsp;<span class="ident" id="5931030">reflect</span><span class="op" id="5931037">.</span><span class="ident" id="5931038">Ptr</span>&nbsp;<span class="op" id="5931042">&amp;&amp;</span>&nbsp;<span class="ident" id="5931045">value</span><span class="op" id="5931050">.</span><span class="ident" id="5931051">IsNil</span><span class="op" id="5931056">(</span><span class="op" id="5931057">)</span>&nbsp;<span class="op" id="5931059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5931063">panic</span><span class="op" id="5931068">(</span><span class="string" id="5931069">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5931111">+</span>&nbsp;<span class="ident" id="5931113">value</span><span class="op" id="5931118">.</span><span class="ident" id="5931119">Type</span><span class="op" id="5931123">(</span><span class="op" id="5931124">)</span><span class="op" id="5931125">.</span><span class="ident" id="5931126">String</span><span class="op" id="5931132">(</span><span class="op" id="5931133">)</span><span class="op" id="5931134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5931137">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5931141">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5931203">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931240">enc</span><span class="op" id="5931243">.</span><span class="ident" id="5931244">mutex</span><span class="op" id="5931249">.</span><span class="ident" id="5931250">Lock</span><span class="op" id="5931254">(</span><span class="op" id="5931255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5931258">defer</span>&nbsp;<span class="ident" id="5931264">enc</span><span class="op" id="5931267">.</span><span class="ident" id="5931268">mutex</span><span class="op" id="5931273">.</span><span class="ident" id="5931274">Unlock</span><span class="op" id="5931280">(</span><span class="op" id="5931281">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5931285">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931349">enc</span><span class="op" id="5931352">.</span><span class="ident" id="5931353">w</span>&nbsp;<span class="op" id="5931355">=</span>&nbsp;<span class="ident" id="5931357">enc</span><span class="op" id="5931360">.</span><span class="ident" id="5931361">w</span><span class="op" id="5931362">[</span><span class="num" id="5931363">0</span><span class="op" id="5931364">:</span><span class="num" id="5931365">1</span><span class="op" id="5931366">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931370">ut</span><span class="op" id="5931372">,</span>&nbsp;<span class="ident" id="5931374">err</span>&nbsp;<span class="op" id="5931378">:=</span>&nbsp;<span class="ident" id="5931381">validUserType</span><span class="op" id="5931394">(</span><span class="ident" id="5931395">value</span><span class="op" id="5931400">.</span><span class="ident" id="5931401">Type</span><span class="op" id="5931405">(</span><span class="op" id="5931406">)</span><span class="op" id="5931407">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5931410">if</span>&nbsp;<span class="ident" id="5931413">err</span>&nbsp;<span class="op" id="5931417">!=</span>&nbsp;<span class="builtintype" id="5931420">nil</span>&nbsp;<span class="op" id="5931424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5931428">return</span>&nbsp;<span class="ident" id="5931435">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5931440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931444">enc</span><span class="op" id="5931447">.</span><span class="ident" id="5931448">err</span>&nbsp;<span class="op" id="5931452">=</span>&nbsp;<span class="builtintype" id="5931454">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931459">enc</span><span class="op" id="5931462">.</span><span class="ident" id="5931463">byteBuf</span><span class="op" id="5931470">.</span><span class="ident" id="5931471">Reset</span><span class="op" id="5931476">(</span><span class="op" id="5931477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931480">enc</span><span class="op" id="5931483">.</span><span class="ident" id="5931484">byteBuf</span><span class="op" id="5931491">.</span><span class="ident" id="5931492">Write</span><span class="op" id="5931497">(</span><span class="ident" id="5931498">spaceForLength</span><span class="op" id="5931512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931515">state</span>&nbsp;<span class="op" id="5931521">:=</span>&nbsp;<span class="ident" id="5931524">enc</span><span class="op" id="5931527">.</span><span class="ident" id="5931528">newEncoderState</span><span class="op" id="5931543">(</span><span class="op" id="5931544">&amp;</span><span class="ident" id="5931545">enc</span><span class="op" id="5931548">.</span><span class="ident" id="5931549">byteBuf</span><span class="op" id="5931556">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931560">enc</span><span class="op" id="5931563">.</span><span class="ident" id="5931564">sendTypeDescriptor</span><span class="op" id="5931582">(</span><span class="ident" id="5931583">enc</span><span class="op" id="5931586">.</span><span class="ident" id="5931587">writer</span><span class="op" id="5931593">(</span><span class="op" id="5931594">)</span><span class="op" id="5931595">,</span>&nbsp;<span class="ident" id="5931597">state</span><span class="op" id="5931602">,</span>&nbsp;<span class="ident" id="5931604">ut</span><span class="op" id="5931606">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931609">enc</span><span class="op" id="5931612">.</span><span class="ident" id="5931613">sendTypeId</span><span class="op" id="5931623">(</span><span class="ident" id="5931624">state</span><span class="op" id="5931629">,</span>&nbsp;<span class="ident" id="5931631">ut</span><span class="op" id="5931633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5931636">if</span>&nbsp;<span class="ident" id="5931639">enc</span><span class="op" id="5931642">.</span><span class="ident" id="5931643">err</span>&nbsp;<span class="op" id="5931647">!=</span>&nbsp;<span class="builtintype" id="5931650">nil</span>&nbsp;<span class="op" id="5931654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5931658">return</span>&nbsp;<span class="ident" id="5931665">enc</span><span class="op" id="5931668">.</span><span class="ident" id="5931669">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5931674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5931678">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931701">enc</span><span class="op" id="5931704">.</span><span class="ident" id="5931705">encode</span><span class="op" id="5931711">(</span><span class="ident" id="5931712">state</span><span class="op" id="5931717">.</span><span class="ident" id="5931718">b</span><span class="op" id="5931719">,</span>&nbsp;<span class="ident" id="5931721">value</span><span class="op" id="5931726">,</span>&nbsp;<span class="ident" id="5931728">ut</span><span class="op" id="5931730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5931733">if</span>&nbsp;<span class="ident" id="5931736">enc</span><span class="op" id="5931739">.</span><span class="ident" id="5931740">err</span>&nbsp;<span class="op" id="5931744">==</span>&nbsp;<span class="builtintype" id="5931747">nil</span>&nbsp;<span class="op" id="5931751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931755">enc</span><span class="op" id="5931758">.</span><span class="ident" id="5931759">writeMessage</span><span class="op" id="5931771">(</span><span class="ident" id="5931772">enc</span><span class="op" id="5931775">.</span><span class="ident" id="5931776">writer</span><span class="op" id="5931782">(</span><span class="op" id="5931783">)</span><span class="op" id="5931784">,</span>&nbsp;<span class="ident" id="5931786">state</span><span class="op" id="5931791">.</span><span class="ident" id="5931792">b</span><span class="op" id="5931793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5931796">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5931800">enc</span><span class="op" id="5931803">.</span><span class="ident" id="5931804">freeEncoderState</span><span class="op" id="5931820">(</span><span class="ident" id="5931821">state</span><span class="op" id="5931826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5931829">return</span>&nbsp;<span class="ident" id="5931836">enc</span><span class="op" id="5931839">.</span><span class="ident" id="5931840">err</span><br>
<span class="lineno"></span><span class="op" id="5931844">}</span>
</div>
</body>
</html>
