<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4088909">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4088964">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4089018">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4089069">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4089115">package</span>&nbsp;<span class="ident" id="4089123">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4089128">import</span>&nbsp;<span class="op" id="4089135">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4089138">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4089147">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4089164">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4089181">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4089196">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4089206">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4089213">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4089219">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4089226">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4089234">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4089241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4089244">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4089287">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="4089328">type</span>&nbsp;<span class="ident" id="4089333">Conn</span>&nbsp;<span class="keyword" id="4089338">struct</span>&nbsp;<span class="op" id="4089345">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4089348">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089361">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4089370">net</span><span class="op" id="4089373">.</span><span class="ident" id="4089374">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089380">isClient</span>&nbsp;<span class="builtintype" id="4089389">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4089396">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089454">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4089472">sync</span><span class="op" id="4089476">.</span><span class="ident" id="4089477">Mutex</span>&nbsp;<span class="comment" id="4089483">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089534">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4089552">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4089563">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089598">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4089616">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4089627">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089643">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4089661">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4089672">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089704">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4089722">*</span><span class="ident" id="4089723">Config</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4089733">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089773">handshakeComplete</span>&nbsp;<span class="builtintype" id="4089791">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089797">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4089815">bool</span>&nbsp;<span class="comment" id="4089820">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089873">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4089891">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089899">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4089917">[</span><span class="op" id="4089918">]</span><span class="builtintype" id="4089919">byte</span>&nbsp;<span class="comment" id="4089924">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4089950">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="4089968">[</span><span class="op" id="4089969">]</span><span class="op" id="4089970">*</span><span class="ident" id="4089971">x509</span><span class="op" id="4089975">.</span><span class="ident" id="4089976">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4089989">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4090058">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090107">verifiedChains</span>&nbsp;<span class="op" id="4090122">[</span><span class="op" id="4090123">]</span><span class="op" id="4090124">[</span><span class="op" id="4090125">]</span><span class="op" id="4090126">*</span><span class="ident" id="4090127">x509</span><span class="op" id="4090131">.</span><span class="ident" id="4090132">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4090145">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090218">serverName</span>&nbsp;<span class="builtintype" id="4090229">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4090237">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4090304">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090367">firstFinished</span>&nbsp;<span class="op" id="4090381">[</span><span class="num" id="4090382">12</span><span class="op" id="4090384">]</span><span class="builtintype" id="4090385">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090392">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4090415">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090423">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="4090446">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4090453">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090470">in</span><span class="op" id="4090472">,</span>&nbsp;<span class="ident" id="4090474">out</span>&nbsp;&nbsp;<span class="ident" id="4090479">halfConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4090492">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090517">rawInput</span>&nbsp;<span class="op" id="4090526">*</span><span class="ident" id="4090527">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4090539">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090573">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4090582">*</span><span class="ident" id="4090583">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4090595">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090635">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4090644">bytes</span><span class="op" id="4090649">.</span><span class="ident" id="4090650">Buffer</span>&nbsp;<span class="comment" id="4090657">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4090696">tmp</span>&nbsp;<span class="op" id="4090700">[</span><span class="num" id="4090701">16</span><span class="op" id="4090703">]</span><span class="builtintype" id="4090704">byte</span><br>
<span class="lineno"></span><span class="op" id="4090709">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4090712">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="4090743">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="4090792">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4090825">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4090873">func</span>&nbsp;<span class="op" id="4090878">(</span><span class="ident" id="4090879">c</span>&nbsp;<span class="op" id="4090881">*</span><span class="ident" id="4090882">Conn</span><span class="op" id="4090886">)</span>&nbsp;<span class="ident" id="4090888">LocalAddr</span><span class="op" id="4090897">(</span><span class="op" id="4090898">)</span>&nbsp;<span class="ident" id="4090900">net</span><span class="op" id="4090903">.</span><span class="ident" id="4090904">Addr</span>&nbsp;<span class="op" id="4090909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4090912">return</span>&nbsp;<span class="ident" id="4090919">c</span><span class="op" id="4090920">.</span><span class="ident" id="4090921">conn</span><span class="op" id="4090925">.</span><span class="ident" id="4090926">LocalAddr</span><span class="op" id="4090935">(</span><span class="op" id="4090936">)</span><br>
<span class="lineno"></span><span class="op" id="4090938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="4090941">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4090991">func</span>&nbsp;<span class="op" id="4090996">(</span><span class="ident" id="4090997">c</span>&nbsp;<span class="op" id="4090999">*</span><span class="ident" id="4091000">Conn</span><span class="op" id="4091004">)</span>&nbsp;<span class="ident" id="4091006">RemoteAddr</span><span class="op" id="4091016">(</span><span class="op" id="4091017">)</span>&nbsp;<span class="ident" id="4091019">net</span><span class="op" id="4091022">.</span><span class="ident" id="4091023">Addr</span>&nbsp;<span class="op" id="4091028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091031">return</span>&nbsp;<span class="ident" id="4091038">c</span><span class="op" id="4091039">.</span><span class="ident" id="4091040">conn</span><span class="op" id="4091044">.</span><span class="ident" id="4091045">RemoteAddr</span><span class="op" id="4091055">(</span><span class="op" id="4091056">)</span><br>
<span class="lineno"></span><span class="op" id="4091058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4091061">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4091142">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="4091204">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4091311">func</span>&nbsp;<span class="op" id="4091316">(</span><span class="ident" id="4091317">c</span>&nbsp;<span class="op" id="4091319">*</span><span class="ident" id="4091320">Conn</span><span class="op" id="4091324">)</span>&nbsp;<span class="ident" id="4091326">SetDeadline</span><span class="op" id="4091337">(</span><span class="ident" id="4091338">t</span>&nbsp;<span class="ident" id="4091340">time</span><span class="op" id="4091344">.</span><span class="ident" id="4091345">Time</span><span class="op" id="4091349">)</span>&nbsp;<span class="builtintype" id="4091351">error</span>&nbsp;<span class="op" id="4091357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091360">return</span>&nbsp;<span class="ident" id="4091367">c</span><span class="op" id="4091368">.</span><span class="ident" id="4091369">conn</span><span class="op" id="4091373">.</span><span class="ident" id="4091374">SetDeadline</span><span class="op" id="4091385">(</span><span class="ident" id="4091386">t</span><span class="op" id="4091387">)</span><br>
<span class="lineno">80</span><span class="op" id="4091389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4091392">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4091464">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4091516">func</span>&nbsp;<span class="op" id="4091521">(</span><span class="ident" id="4091522">c</span>&nbsp;<span class="op" id="4091524">*</span><span class="ident" id="4091525">Conn</span><span class="op" id="4091529">)</span>&nbsp;<span class="ident" id="4091531">SetReadDeadline</span><span class="op" id="4091546">(</span><span class="ident" id="4091547">t</span>&nbsp;<span class="ident" id="4091549">time</span><span class="op" id="4091553">.</span><span class="ident" id="4091554">Time</span><span class="op" id="4091558">)</span>&nbsp;<span class="builtintype" id="4091560">error</span>&nbsp;<span class="op" id="4091566">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091569">return</span>&nbsp;<span class="ident" id="4091576">c</span><span class="op" id="4091577">.</span><span class="ident" id="4091578">conn</span><span class="op" id="4091582">.</span><span class="ident" id="4091583">SetReadDeadline</span><span class="op" id="4091598">(</span><span class="ident" id="4091599">t</span><span class="op" id="4091600">)</span><br>
<span class="lineno"></span><span class="op" id="4091602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4091605">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4091679">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="4091732">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4091839">func</span>&nbsp;<span class="op" id="4091844">(</span><span class="ident" id="4091845">c</span>&nbsp;<span class="op" id="4091847">*</span><span class="ident" id="4091848">Conn</span><span class="op" id="4091852">)</span>&nbsp;<span class="ident" id="4091854">SetWriteDeadline</span><span class="op" id="4091870">(</span><span class="ident" id="4091871">t</span>&nbsp;<span class="ident" id="4091873">time</span><span class="op" id="4091877">.</span><span class="ident" id="4091878">Time</span><span class="op" id="4091882">)</span>&nbsp;<span class="builtintype" id="4091884">error</span>&nbsp;<span class="op" id="4091890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091893">return</span>&nbsp;<span class="ident" id="4091900">c</span><span class="op" id="4091901">.</span><span class="ident" id="4091902">conn</span><span class="op" id="4091906">.</span><span class="ident" id="4091907">SetWriteDeadline</span><span class="op" id="4091923">(</span><span class="ident" id="4091924">t</span><span class="op" id="4091925">)</span><br>
<span class="lineno"></span><span class="op" id="4091927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4091930">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="4091989">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="4092033">type</span>&nbsp;<span class="ident" id="4092038">halfConn</span>&nbsp;<span class="keyword" id="4092047">struct</span>&nbsp;<span class="op" id="4092054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092057">sync</span><span class="op" id="4092061">.</span><span class="ident" id="4092062">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092070">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4092078">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4092090">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092116">version</span>&nbsp;<span class="builtintype" id="4092124">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4092136">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092157">cipher</span>&nbsp;&nbsp;<span class="keyword" id="4092165">interface</span><span class="op" id="4092174">{</span><span class="op" id="4092175">}</span>&nbsp;<span class="comment" id="4092177">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092198">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4092206">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092219">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4092227">[</span><span class="num" id="4092228">8</span><span class="op" id="4092229">]</span><span class="builtintype" id="4092230">byte</span>&nbsp;<span class="comment" id="4092235">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092262">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4092270">*</span><span class="ident" id="4092271">block</span>&nbsp;&nbsp;<span class="comment" id="4092278">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092303">nextCipher</span>&nbsp;<span class="keyword" id="4092314">interface</span><span class="op" id="4092323">{</span><span class="op" id="4092324">}</span>&nbsp;<span class="comment" id="4092326">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092352">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4092363">macFunction</span>&nbsp;<span class="comment" id="4092375">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4092399">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092454">inDigestBuf</span><span class="op" id="4092465">,</span>&nbsp;<span class="ident" id="4092467">outDigestBuf</span>&nbsp;<span class="op" id="4092480">[</span><span class="op" id="4092481">]</span><span class="builtintype" id="4092482">byte</span><br>
<span class="lineno"></span><span class="op" id="4092487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4092490">func</span>&nbsp;<span class="op" id="4092495">(</span><span class="ident" id="4092496">hc</span>&nbsp;<span class="op" id="4092499">*</span><span class="ident" id="4092500">halfConn</span><span class="op" id="4092508">)</span>&nbsp;<span class="ident" id="4092510">setErrorLocked</span><span class="op" id="4092524">(</span><span class="ident" id="4092525">err</span>&nbsp;<span class="builtintype" id="4092529">error</span><span class="op" id="4092534">)</span>&nbsp;<span class="builtintype" id="4092536">error</span>&nbsp;<span class="op" id="4092542">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092545">hc</span><span class="op" id="4092547">.</span><span class="ident" id="4092548">err</span>&nbsp;<span class="op" id="4092552">=</span>&nbsp;<span class="ident" id="4092554">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092559">return</span>&nbsp;<span class="ident" id="4092566">err</span><br>
<span class="lineno"></span><span class="op" id="4092570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4092573">func</span>&nbsp;<span class="op" id="4092578">(</span><span class="ident" id="4092579">hc</span>&nbsp;<span class="op" id="4092582">*</span><span class="ident" id="4092583">halfConn</span><span class="op" id="4092591">)</span>&nbsp;<span class="builtintype" id="4092593">error</span><span class="op" id="4092598">(</span><span class="op" id="4092599">)</span>&nbsp;<span class="builtintype" id="4092601">error</span>&nbsp;<span class="op" id="4092607">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092610">hc</span><span class="op" id="4092612">.</span><span class="ident" id="4092613">Lock</span><span class="op" id="4092617">(</span><span class="op" id="4092618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092621">err</span>&nbsp;<span class="op" id="4092625">:=</span>&nbsp;<span class="ident" id="4092628">hc</span><span class="op" id="4092630">.</span><span class="ident" id="4092631">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092636">hc</span><span class="op" id="4092638">.</span><span class="ident" id="4092639">Unlock</span><span class="op" id="4092645">(</span><span class="op" id="4092646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092649">return</span>&nbsp;<span class="ident" id="4092656">err</span><br>
<span class="lineno"></span><span class="op" id="4092660">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="4092663">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="4092719">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4092767">func</span>&nbsp;<span class="op" id="4092772">(</span><span class="ident" id="4092773">hc</span>&nbsp;<span class="op" id="4092776">*</span><span class="ident" id="4092777">halfConn</span><span class="op" id="4092785">)</span>&nbsp;<span class="ident" id="4092787">prepareCipherSpec</span><span class="op" id="4092804">(</span><span class="ident" id="4092805">version</span>&nbsp;<span class="builtintype" id="4092813">uint16</span><span class="op" id="4092819">,</span>&nbsp;<span class="ident" id="4092821">cipher</span>&nbsp;<span class="keyword" id="4092828">interface</span><span class="op" id="4092837">{</span><span class="op" id="4092838">}</span><span class="op" id="4092839">,</span>&nbsp;<span class="ident" id="4092841">mac</span>&nbsp;<span class="ident" id="4092845">macFunction</span><span class="op" id="4092856">)</span>&nbsp;<span class="op" id="4092858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092861">hc</span><span class="op" id="4092863">.</span><span class="ident" id="4092864">version</span>&nbsp;<span class="op" id="4092872">=</span>&nbsp;<span class="ident" id="4092874">version</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092883">hc</span><span class="op" id="4092885">.</span><span class="ident" id="4092886">nextCipher</span>&nbsp;<span class="op" id="4092897">=</span>&nbsp;<span class="ident" id="4092899">cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092907">hc</span><span class="op" id="4092909">.</span><span class="ident" id="4092910">nextMac</span>&nbsp;<span class="op" id="4092918">=</span>&nbsp;<span class="ident" id="4092920">mac</span><br>
<span class="lineno"></span><span class="op" id="4092924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4092927">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="4092985">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="4093040">func</span>&nbsp;<span class="op" id="4093045">(</span><span class="ident" id="4093046">hc</span>&nbsp;<span class="op" id="4093049">*</span><span class="ident" id="4093050">halfConn</span><span class="op" id="4093058">)</span>&nbsp;<span class="ident" id="4093060">changeCipherSpec</span><span class="op" id="4093076">(</span><span class="op" id="4093077">)</span>&nbsp;<span class="builtintype" id="4093079">error</span>&nbsp;<span class="op" id="4093085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093088">if</span>&nbsp;<span class="ident" id="4093091">hc</span><span class="op" id="4093093">.</span><span class="ident" id="4093094">nextCipher</span>&nbsp;<span class="op" id="4093105">==</span>&nbsp;<span class="ident" id="4093108">nil</span>&nbsp;<span class="op" id="4093112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093116">return</span>&nbsp;<span class="ident" id="4093123">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4093143">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4093146">hc</span><span class="op" id="4093148">.</span><span class="ident" id="4093149">cipher</span>&nbsp;<span class="op" id="4093156">=</span>&nbsp;<span class="ident" id="4093158">hc</span><span class="op" id="4093160">.</span><span class="ident" id="4093161">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4093173">hc</span><span class="op" id="4093175">.</span><span class="ident" id="4093176">mac</span>&nbsp;<span class="op" id="4093180">=</span>&nbsp;<span class="ident" id="4093182">hc</span><span class="op" id="4093184">.</span><span class="ident" id="4093185">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4093194">hc</span><span class="op" id="4093196">.</span><span class="ident" id="4093197">nextCipher</span>&nbsp;<span class="op" id="4093208">=</span>&nbsp;<span class="ident" id="4093210">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4093215">hc</span><span class="op" id="4093217">.</span><span class="ident" id="4093218">nextMac</span>&nbsp;<span class="op" id="4093226">=</span>&nbsp;<span class="ident" id="4093228">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093233">for</span>&nbsp;<span class="ident" id="4093237">i</span>&nbsp;<span class="op" id="4093239">:=</span>&nbsp;<span class="keyword" id="4093242">range</span>&nbsp;<span class="ident" id="4093248">hc</span><span class="op" id="4093250">.</span><span class="ident" id="4093251">seq</span>&nbsp;<span class="op" id="4093255">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4093259">hc</span><span class="op" id="4093261">.</span><span class="ident" id="4093262">seq</span><span class="op" id="4093265">[</span><span class="ident" id="4093266">i</span><span class="op" id="4093267">]</span>&nbsp;<span class="op" id="4093269">=</span>&nbsp;<span class="num" id="4093271">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4093274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093277">return</span>&nbsp;<span class="ident" id="4093284">nil</span><br>
<span class="lineno"></span><span class="op" id="4093288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4093291">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="4093333">func</span>&nbsp;<span class="op" id="4093338">(</span><span class="ident" id="4093339">hc</span>&nbsp;<span class="op" id="4093342">*</span><span class="ident" id="4093343">halfConn</span><span class="op" id="4093351">)</span>&nbsp;<span class="ident" id="4093353">incSeq</span><span class="op" id="4093359">(</span><span class="op" id="4093360">)</span>&nbsp;<span class="op" id="4093362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093365">for</span>&nbsp;<span class="ident" id="4093369">i</span>&nbsp;<span class="op" id="4093371">:=</span>&nbsp;<span class="num" id="4093374">7</span><span class="op" id="4093375">;</span>&nbsp;<span class="ident" id="4093377">i</span>&nbsp;<span class="op" id="4093379">&gt;=</span>&nbsp;<span class="num" id="4093382">0</span><span class="op" id="4093383">;</span>&nbsp;<span class="ident" id="4093385">i</span><span class="op" id="4093386">--</span>&nbsp;<span class="op" id="4093389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4093393">hc</span><span class="op" id="4093395">.</span><span class="ident" id="4093396">seq</span><span class="op" id="4093399">[</span><span class="ident" id="4093400">i</span><span class="op" id="4093401">]</span><span class="op" id="4093402">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093407">if</span>&nbsp;<span class="ident" id="4093410">hc</span><span class="op" id="4093412">.</span><span class="ident" id="4093413">seq</span><span class="op" id="4093416">[</span><span class="ident" id="4093417">i</span><span class="op" id="4093418">]</span>&nbsp;<span class="op" id="4093420">!=</span>&nbsp;<span class="num" id="4093423">0</span>&nbsp;<span class="op" id="4093425">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093430">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4093439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4093442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4093446">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4093491">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4093537">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4093570">panic</span><span class="op" id="4093575">(</span><span class="string" id="4093576">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="4093609">)</span><br>
<span class="lineno"></span><span class="op" id="4093611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4093614">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="4093662">func</span>&nbsp;<span class="op" id="4093667">(</span><span class="ident" id="4093668">hc</span>&nbsp;<span class="op" id="4093671">*</span><span class="ident" id="4093672">halfConn</span><span class="op" id="4093680">)</span>&nbsp;<span class="ident" id="4093682">resetSeq</span><span class="op" id="4093690">(</span><span class="op" id="4093691">)</span>&nbsp;<span class="op" id="4093693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093696">for</span>&nbsp;<span class="ident" id="4093700">i</span>&nbsp;<span class="op" id="4093702">:=</span>&nbsp;<span class="keyword" id="4093705">range</span>&nbsp;<span class="ident" id="4093711">hc</span><span class="op" id="4093713">.</span><span class="ident" id="4093714">seq</span>&nbsp;<span class="op" id="4093718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4093722">hc</span><span class="op" id="4093724">.</span><span class="ident" id="4093725">seq</span><span class="op" id="4093728">[</span><span class="ident" id="4093729">i</span><span class="op" id="4093730">]</span>&nbsp;<span class="op" id="4093732">=</span>&nbsp;<span class="num" id="4093734">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4093737">}</span><br>
<span class="lineno">170</span><span class="op" id="4093739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4093742">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="4093822">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4093899">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="4093959">func</span>&nbsp;<span class="ident" id="4093964">removePadding</span><span class="op" id="4093977">(</span><span class="ident" id="4093978">payload</span>&nbsp;<span class="op" id="4093986">[</span><span class="op" id="4093987">]</span><span class="builtintype" id="4093988">byte</span><span class="op" id="4093992">)</span>&nbsp;<span class="op" id="4093994">(</span><span class="op" id="4093995">[</span><span class="op" id="4093996">]</span><span class="builtintype" id="4093997">byte</span><span class="op" id="4094001">,</span>&nbsp;<span class="builtintype" id="4094003">byte</span><span class="op" id="4094007">)</span>&nbsp;<span class="op" id="4094009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094012">if</span>&nbsp;<span class="builtinfunc" id="4094015">len</span><span class="op" id="4094018">(</span><span class="ident" id="4094019">payload</span><span class="op" id="4094026">)</span>&nbsp;<span class="op" id="4094028">&lt;</span>&nbsp;<span class="num" id="4094030">1</span>&nbsp;<span class="op" id="4094032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094036">return</span>&nbsp;<span class="ident" id="4094043">payload</span><span class="op" id="4094050">,</span>&nbsp;<span class="num" id="4094052">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4094055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094059">paddingLen</span>&nbsp;<span class="op" id="4094070">:=</span>&nbsp;<span class="ident" id="4094073">payload</span><span class="op" id="4094080">[</span><span class="builtinfunc" id="4094081">len</span><span class="op" id="4094084">(</span><span class="ident" id="4094085">payload</span><span class="op" id="4094092">)</span><span class="op" id="4094093">-</span><span class="num" id="4094094">1</span><span class="op" id="4094095">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094098">t</span>&nbsp;<span class="op" id="4094100">:=</span>&nbsp;<span class="builtintype" id="4094103">uint</span><span class="op" id="4094107">(</span><span class="builtinfunc" id="4094108">len</span><span class="op" id="4094111">(</span><span class="ident" id="4094112">payload</span><span class="op" id="4094119">)</span><span class="op" id="4094120">-</span><span class="num" id="4094121">1</span><span class="op" id="4094122">)</span>&nbsp;<span class="op" id="4094124">-</span>&nbsp;<span class="builtintype" id="4094126">uint</span><span class="op" id="4094130">(</span><span class="ident" id="4094131">paddingLen</span><span class="op" id="4094141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4094144">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094210">good</span>&nbsp;<span class="op" id="4094215">:=</span>&nbsp;<span class="builtintype" id="4094218">byte</span><span class="op" id="4094222">(</span><span class="builtintype" id="4094223">int32</span><span class="op" id="4094228">(</span><span class="op" id="4094229">^</span><span class="ident" id="4094230">t</span><span class="op" id="4094231">)</span>&nbsp;<span class="op" id="4094233">&gt;&gt;</span>&nbsp;<span class="num" id="4094236">31</span><span class="op" id="4094238">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094242">toCheck</span>&nbsp;<span class="op" id="4094250">:=</span>&nbsp;<span class="num" id="4094253">255</span>&nbsp;<span class="comment" id="4094257">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4094297">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094367">if</span>&nbsp;<span class="ident" id="4094370">toCheck</span><span class="op" id="4094377">+</span><span class="num" id="4094378">1</span>&nbsp;<span class="op" id="4094380">&gt;</span>&nbsp;<span class="builtinfunc" id="4094382">len</span><span class="op" id="4094385">(</span><span class="ident" id="4094386">payload</span><span class="op" id="4094393">)</span>&nbsp;<span class="op" id="4094395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094399">toCheck</span>&nbsp;<span class="op" id="4094407">=</span>&nbsp;<span class="builtinfunc" id="4094409">len</span><span class="op" id="4094412">(</span><span class="ident" id="4094413">payload</span><span class="op" id="4094420">)</span>&nbsp;<span class="op" id="4094422">-</span>&nbsp;<span class="num" id="4094424">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4094427">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094431">for</span>&nbsp;<span class="ident" id="4094435">i</span>&nbsp;<span class="op" id="4094437">:=</span>&nbsp;<span class="num" id="4094440">0</span><span class="op" id="4094441">;</span>&nbsp;<span class="ident" id="4094443">i</span>&nbsp;<span class="op" id="4094445">&lt;</span>&nbsp;<span class="ident" id="4094447">toCheck</span><span class="op" id="4094454">;</span>&nbsp;<span class="ident" id="4094456">i</span><span class="op" id="4094457">++</span>&nbsp;<span class="op" id="4094460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094464">t</span>&nbsp;<span class="op" id="4094466">:=</span>&nbsp;<span class="builtintype" id="4094469">uint</span><span class="op" id="4094473">(</span><span class="ident" id="4094474">paddingLen</span><span class="op" id="4094484">)</span>&nbsp;<span class="op" id="4094486">-</span>&nbsp;<span class="builtintype" id="4094488">uint</span><span class="op" id="4094492">(</span><span class="ident" id="4094493">i</span><span class="op" id="4094494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4094498">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094548">mask</span>&nbsp;<span class="op" id="4094553">:=</span>&nbsp;<span class="builtintype" id="4094556">byte</span><span class="op" id="4094560">(</span><span class="builtintype" id="4094561">int32</span><span class="op" id="4094566">(</span><span class="op" id="4094567">^</span><span class="ident" id="4094568">t</span><span class="op" id="4094569">)</span>&nbsp;<span class="op" id="4094571">&gt;&gt;</span>&nbsp;<span class="num" id="4094574">31</span><span class="op" id="4094576">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094580">b</span>&nbsp;<span class="op" id="4094582">:=</span>&nbsp;<span class="ident" id="4094585">payload</span><span class="op" id="4094592">[</span><span class="builtinfunc" id="4094593">len</span><span class="op" id="4094596">(</span><span class="ident" id="4094597">payload</span><span class="op" id="4094604">)</span><span class="op" id="4094605">-</span><span class="num" id="4094606">1</span><span class="op" id="4094607">-</span><span class="ident" id="4094608">i</span><span class="op" id="4094609">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094613">good</span>&nbsp;<span class="op" id="4094618">&amp;^=</span>&nbsp;<span class="ident" id="4094622">mask</span><span class="op" id="4094626">&amp;</span><span class="ident" id="4094627">paddingLen</span>&nbsp;<span class="op" id="4094638">^</span>&nbsp;<span class="ident" id="4094640">mask</span><span class="op" id="4094644">&amp;</span><span class="ident" id="4094645">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4094648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4094652">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4094721">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094739">good</span>&nbsp;<span class="op" id="4094744">&amp;=</span>&nbsp;<span class="ident" id="4094747">good</span>&nbsp;<span class="op" id="4094752">&lt;&lt;</span>&nbsp;<span class="num" id="4094755">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094758">good</span>&nbsp;<span class="op" id="4094763">&amp;=</span>&nbsp;<span class="ident" id="4094766">good</span>&nbsp;<span class="op" id="4094771">&lt;&lt;</span>&nbsp;<span class="num" id="4094774">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094777">good</span>&nbsp;<span class="op" id="4094782">&amp;=</span>&nbsp;<span class="ident" id="4094785">good</span>&nbsp;<span class="op" id="4094790">&lt;&lt;</span>&nbsp;<span class="num" id="4094793">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094796">good</span>&nbsp;<span class="op" id="4094801">=</span>&nbsp;<span class="builtintype" id="4094803">uint8</span><span class="op" id="4094808">(</span><span class="builtintype" id="4094809">int8</span><span class="op" id="4094813">(</span><span class="ident" id="4094814">good</span><span class="op" id="4094818">)</span>&nbsp;<span class="op" id="4094820">&gt;&gt;</span>&nbsp;<span class="num" id="4094823">7</span><span class="op" id="4094824">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094828">toRemove</span>&nbsp;<span class="op" id="4094837">:=</span>&nbsp;<span class="ident" id="4094840">good</span><span class="op" id="4094844">&amp;</span><span class="ident" id="4094845">paddingLen</span>&nbsp;<span class="op" id="4094856">+</span>&nbsp;<span class="num" id="4094858">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094861">return</span>&nbsp;<span class="ident" id="4094868">payload</span><span class="op" id="4094875">[</span><span class="op" id="4094876">:</span><span class="builtinfunc" id="4094877">len</span><span class="op" id="4094880">(</span><span class="ident" id="4094881">payload</span><span class="op" id="4094888">)</span><span class="op" id="4094889">-</span><span class="builtintype" id="4094890">int</span><span class="op" id="4094893">(</span><span class="ident" id="4094894">toRemove</span><span class="op" id="4094902">)</span><span class="op" id="4094903">]</span><span class="op" id="4094904">,</span>&nbsp;<span class="ident" id="4094906">good</span><br>
<span class="lineno"></span><span class="op" id="4094911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="4094914">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4094992">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4095067">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="4095104">func</span>&nbsp;<span class="ident" id="4095109">removePaddingSSL30</span><span class="op" id="4095127">(</span><span class="ident" id="4095128">payload</span>&nbsp;<span class="op" id="4095136">[</span><span class="op" id="4095137">]</span><span class="builtintype" id="4095138">byte</span><span class="op" id="4095142">)</span>&nbsp;<span class="op" id="4095144">(</span><span class="op" id="4095145">[</span><span class="op" id="4095146">]</span><span class="builtintype" id="4095147">byte</span><span class="op" id="4095151">,</span>&nbsp;<span class="builtintype" id="4095153">byte</span><span class="op" id="4095157">)</span>&nbsp;<span class="op" id="4095159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095162">if</span>&nbsp;<span class="builtinfunc" id="4095165">len</span><span class="op" id="4095168">(</span><span class="ident" id="4095169">payload</span><span class="op" id="4095176">)</span>&nbsp;<span class="op" id="4095178">&lt;</span>&nbsp;<span class="num" id="4095180">1</span>&nbsp;<span class="op" id="4095182">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095186">return</span>&nbsp;<span class="ident" id="4095193">payload</span><span class="op" id="4095200">,</span>&nbsp;<span class="num" id="4095202">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4095205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095209">paddingLen</span>&nbsp;<span class="op" id="4095220">:=</span>&nbsp;<span class="builtintype" id="4095223">int</span><span class="op" id="4095226">(</span><span class="ident" id="4095227">payload</span><span class="op" id="4095234">[</span><span class="builtinfunc" id="4095235">len</span><span class="op" id="4095238">(</span><span class="ident" id="4095239">payload</span><span class="op" id="4095246">)</span><span class="op" id="4095247">-</span><span class="num" id="4095248">1</span><span class="op" id="4095249">]</span><span class="op" id="4095250">)</span>&nbsp;<span class="op" id="4095252">+</span>&nbsp;<span class="num" id="4095254">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095257">if</span>&nbsp;<span class="ident" id="4095260">paddingLen</span>&nbsp;<span class="op" id="4095271">&gt;</span>&nbsp;<span class="builtinfunc" id="4095273">len</span><span class="op" id="4095276">(</span><span class="ident" id="4095277">payload</span><span class="op" id="4095284">)</span>&nbsp;<span class="op" id="4095286">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095290">return</span>&nbsp;<span class="ident" id="4095297">payload</span><span class="op" id="4095304">,</span>&nbsp;<span class="num" id="4095306">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4095309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095313">return</span>&nbsp;<span class="ident" id="4095320">payload</span><span class="op" id="4095327">[</span><span class="op" id="4095328">:</span><span class="builtinfunc" id="4095329">len</span><span class="op" id="4095332">(</span><span class="ident" id="4095333">payload</span><span class="op" id="4095340">)</span><span class="op" id="4095341">-</span><span class="ident" id="4095342">paddingLen</span><span class="op" id="4095352">]</span><span class="op" id="4095353">,</span>&nbsp;<span class="num" id="4095355">255</span><br>
<span class="lineno"></span><span class="op" id="4095359">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="4095362">func</span>&nbsp;<span class="ident" id="4095367">roundUp</span><span class="op" id="4095374">(</span><span class="ident" id="4095375">a</span><span class="op" id="4095376">,</span>&nbsp;<span class="ident" id="4095378">b</span>&nbsp;<span class="builtintype" id="4095380">int</span><span class="op" id="4095383">)</span>&nbsp;<span class="builtintype" id="4095385">int</span>&nbsp;<span class="op" id="4095389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095392">return</span>&nbsp;<span class="ident" id="4095399">a</span>&nbsp;<span class="op" id="4095401">+</span>&nbsp;<span class="op" id="4095403">(</span><span class="ident" id="4095404">b</span><span class="op" id="4095405">-</span><span class="ident" id="4095406">a</span><span class="op" id="4095407">%</span><span class="ident" id="4095408">b</span><span class="op" id="4095409">)</span><span class="op" id="4095410">%</span><span class="ident" id="4095411">b</span><br>
<span class="lineno"></span><span class="op" id="4095413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="4095416">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="4095490">type</span>&nbsp;<span class="ident" id="4095495">cbcMode</span>&nbsp;<span class="keyword" id="4095503">interface</span>&nbsp;<span class="op" id="4095513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095516">cipher</span><span class="op" id="4095522">.</span><span class="ident" id="4095523">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095534">SetIV</span><span class="op" id="4095539">(</span><span class="op" id="4095540">[</span><span class="op" id="4095541">]</span><span class="builtintype" id="4095542">byte</span><span class="op" id="4095546">)</span><br>
<span class="lineno"></span><span class="op" id="4095548">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4095551">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4095626">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4095706">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4095776">func</span>&nbsp;<span class="op" id="4095781">(</span><span class="ident" id="4095782">hc</span>&nbsp;<span class="op" id="4095785">*</span><span class="ident" id="4095786">halfConn</span><span class="op" id="4095794">)</span>&nbsp;<span class="ident" id="4095796">decrypt</span><span class="op" id="4095803">(</span><span class="ident" id="4095804">b</span>&nbsp;<span class="op" id="4095806">*</span><span class="ident" id="4095807">block</span><span class="op" id="4095812">)</span>&nbsp;<span class="op" id="4095814">(</span><span class="ident" id="4095815">ok</span>&nbsp;<span class="builtintype" id="4095818">bool</span><span class="op" id="4095822">,</span>&nbsp;<span class="ident" id="4095824">prefixLen</span>&nbsp;<span class="builtintype" id="4095834">int</span><span class="op" id="4095837">,</span>&nbsp;<span class="ident" id="4095839">alertValue</span>&nbsp;<span class="ident" id="4095850">alert</span><span class="op" id="4095855">)</span>&nbsp;<span class="op" id="4095857">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4095860">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095881">payload</span>&nbsp;<span class="op" id="4095889">:=</span>&nbsp;<span class="ident" id="4095892">b</span><span class="op" id="4095893">.</span><span class="ident" id="4095894">data</span><span class="op" id="4095898">[</span><span class="ident" id="4095899">recordHeaderLen</span><span class="op" id="4095914">:</span><span class="op" id="4095915">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095919">macSize</span>&nbsp;<span class="op" id="4095927">:=</span>&nbsp;<span class="num" id="4095930">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095933">if</span>&nbsp;<span class="ident" id="4095936">hc</span><span class="op" id="4095938">.</span><span class="ident" id="4095939">mac</span>&nbsp;<span class="op" id="4095943">!=</span>&nbsp;<span class="ident" id="4095946">nil</span>&nbsp;<span class="op" id="4095950">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095954">macSize</span>&nbsp;<span class="op" id="4095962">=</span>&nbsp;<span class="ident" id="4095964">hc</span><span class="op" id="4095966">.</span><span class="ident" id="4095967">mac</span><span class="op" id="4095970">.</span><span class="ident" id="4095971">Size</span><span class="op" id="4095975">(</span><span class="op" id="4095976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4095979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095983">paddingGood</span>&nbsp;<span class="op" id="4095995">:=</span>&nbsp;<span class="builtintype" id="4095998">byte</span><span class="op" id="4096002">(</span><span class="num" id="4096003">255</span><span class="op" id="4096006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096009">explicitIVLen</span>&nbsp;<span class="op" id="4096023">:=</span>&nbsp;<span class="num" id="4096026">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4096030">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096042">if</span>&nbsp;<span class="ident" id="4096045">hc</span><span class="op" id="4096047">.</span><span class="ident" id="4096048">cipher</span>&nbsp;<span class="op" id="4096055">!=</span>&nbsp;<span class="ident" id="4096058">nil</span>&nbsp;<span class="op" id="4096062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096066">switch</span>&nbsp;<span class="ident" id="4096073">c</span>&nbsp;<span class="op" id="4096075">:=</span>&nbsp;<span class="ident" id="4096078">hc</span><span class="op" id="4096080">.</span><span class="ident" id="4096081">cipher</span><span class="op" id="4096087">.</span><span class="op" id="4096088">(</span><span class="keyword" id="4096089">type</span><span class="op" id="4096093">)</span>&nbsp;<span class="op" id="4096095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096099">case</span>&nbsp;<span class="ident" id="4096104">cipher</span><span class="op" id="4096110">.</span><span class="ident" id="4096111">Stream</span><span class="op" id="4096117">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096122">c</span><span class="op" id="4096123">.</span><span class="ident" id="4096124">XORKeyStream</span><span class="op" id="4096136">(</span><span class="ident" id="4096137">payload</span><span class="op" id="4096144">,</span>&nbsp;<span class="ident" id="4096146">payload</span><span class="op" id="4096153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096157">case</span>&nbsp;<span class="ident" id="4096162">cipher</span><span class="op" id="4096168">.</span><span class="ident" id="4096169">AEAD</span><span class="op" id="4096173">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096178">explicitIVLen</span>&nbsp;<span class="op" id="4096192">=</span>&nbsp;<span class="num" id="4096194">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096199">if</span>&nbsp;<span class="builtinfunc" id="4096202">len</span><span class="op" id="4096205">(</span><span class="ident" id="4096206">payload</span><span class="op" id="4096213">)</span>&nbsp;<span class="op" id="4096215">&lt;</span>&nbsp;<span class="ident" id="4096217">explicitIVLen</span>&nbsp;<span class="op" id="4096231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096237">return</span>&nbsp;<span class="builtintype" id="4096244">false</span><span class="op" id="4096249">,</span>&nbsp;<span class="num" id="4096251">0</span><span class="op" id="4096252">,</span>&nbsp;<span class="ident" id="4096254">alertBadRecordMAC</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4096275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096280">nonce</span>&nbsp;<span class="op" id="4096286">:=</span>&nbsp;<span class="ident" id="4096289">payload</span><span class="op" id="4096296">[</span><span class="op" id="4096297">:</span><span class="num" id="4096298">8</span><span class="op" id="4096299">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096304">payload</span>&nbsp;<span class="op" id="4096312">=</span>&nbsp;<span class="ident" id="4096314">payload</span><span class="op" id="4096321">[</span><span class="num" id="4096322">8</span><span class="op" id="4096323">:</span><span class="op" id="4096324">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096330">var</span>&nbsp;<span class="ident" id="4096334">additionalData</span>&nbsp;<span class="op" id="4096349">[</span><span class="num" id="4096350">13</span><span class="op" id="4096352">]</span><span class="builtintype" id="4096353">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4096361">copy</span><span class="op" id="4096365">(</span><span class="ident" id="4096366">additionalData</span><span class="op" id="4096380">[</span><span class="op" id="4096381">:</span><span class="op" id="4096382">]</span><span class="op" id="4096383">,</span>&nbsp;<span class="ident" id="4096385">hc</span><span class="op" id="4096387">.</span><span class="ident" id="4096388">seq</span><span class="op" id="4096391">[</span><span class="op" id="4096392">:</span><span class="op" id="4096393">]</span><span class="op" id="4096394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4096399">copy</span><span class="op" id="4096403">(</span><span class="ident" id="4096404">additionalData</span><span class="op" id="4096418">[</span><span class="num" id="4096419">8</span><span class="op" id="4096420">:</span><span class="op" id="4096421">]</span><span class="op" id="4096422">,</span>&nbsp;<span class="ident" id="4096424">b</span><span class="op" id="4096425">.</span><span class="ident" id="4096426">data</span><span class="op" id="4096430">[</span><span class="op" id="4096431">:</span><span class="num" id="4096432">3</span><span class="op" id="4096433">]</span><span class="op" id="4096434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096439">n</span>&nbsp;<span class="op" id="4096441">:=</span>&nbsp;<span class="builtinfunc" id="4096444">len</span><span class="op" id="4096447">(</span><span class="ident" id="4096448">payload</span><span class="op" id="4096455">)</span>&nbsp;<span class="op" id="4096457">-</span>&nbsp;<span class="ident" id="4096459">c</span><span class="op" id="4096460">.</span><span class="ident" id="4096461">Overhead</span><span class="op" id="4096469">(</span><span class="op" id="4096470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096475">additionalData</span><span class="op" id="4096489">[</span><span class="num" id="4096490">11</span><span class="op" id="4096492">]</span>&nbsp;<span class="op" id="4096494">=</span>&nbsp;<span class="builtintype" id="4096496">byte</span><span class="op" id="4096500">(</span><span class="ident" id="4096501">n</span>&nbsp;<span class="op" id="4096503">&gt;&gt;</span>&nbsp;<span class="num" id="4096506">8</span><span class="op" id="4096507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096512">additionalData</span><span class="op" id="4096526">[</span><span class="num" id="4096527">12</span><span class="op" id="4096529">]</span>&nbsp;<span class="op" id="4096531">=</span>&nbsp;<span class="builtintype" id="4096533">byte</span><span class="op" id="4096537">(</span><span class="ident" id="4096538">n</span><span class="op" id="4096539">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096544">var</span>&nbsp;<span class="ident" id="4096548">err</span>&nbsp;<span class="builtintype" id="4096552">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096561">payload</span><span class="op" id="4096568">,</span>&nbsp;<span class="ident" id="4096570">err</span>&nbsp;<span class="op" id="4096574">=</span>&nbsp;<span class="ident" id="4096576">c</span><span class="op" id="4096577">.</span><span class="ident" id="4096578">Open</span><span class="op" id="4096582">(</span><span class="ident" id="4096583">payload</span><span class="op" id="4096590">[</span><span class="op" id="4096591">:</span><span class="num" id="4096592">0</span><span class="op" id="4096593">]</span><span class="op" id="4096594">,</span>&nbsp;<span class="ident" id="4096596">nonce</span><span class="op" id="4096601">,</span>&nbsp;<span class="ident" id="4096603">payload</span><span class="op" id="4096610">,</span>&nbsp;<span class="ident" id="4096612">additionalData</span><span class="op" id="4096626">[</span><span class="op" id="4096627">:</span><span class="op" id="4096628">]</span><span class="op" id="4096629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096634">if</span>&nbsp;<span class="ident" id="4096637">err</span>&nbsp;<span class="op" id="4096641">!=</span>&nbsp;<span class="ident" id="4096644">nil</span>&nbsp;<span class="op" id="4096648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096654">return</span>&nbsp;<span class="builtintype" id="4096661">false</span><span class="op" id="4096666">,</span>&nbsp;<span class="num" id="4096668">0</span><span class="op" id="4096669">,</span>&nbsp;<span class="ident" id="4096671">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4096692">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096697">b</span><span class="op" id="4096698">.</span><span class="ident" id="4096699">resize</span><span class="op" id="4096705">(</span><span class="ident" id="4096706">recordHeaderLen</span>&nbsp;<span class="op" id="4096722">+</span>&nbsp;<span class="ident" id="4096724">explicitIVLen</span>&nbsp;<span class="op" id="4096738">+</span>&nbsp;<span class="builtinfunc" id="4096740">len</span><span class="op" id="4096743">(</span><span class="ident" id="4096744">payload</span><span class="op" id="4096751">)</span><span class="op" id="4096752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096756">case</span>&nbsp;<span class="ident" id="4096761">cbcMode</span><span class="op" id="4096768">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096773">blockSize</span>&nbsp;<span class="op" id="4096783">:=</span>&nbsp;<span class="ident" id="4096786">c</span><span class="op" id="4096787">.</span><span class="ident" id="4096788">BlockSize</span><span class="op" id="4096797">(</span><span class="op" id="4096798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096803">if</span>&nbsp;<span class="ident" id="4096806">hc</span><span class="op" id="4096808">.</span><span class="ident" id="4096809">version</span>&nbsp;<span class="op" id="4096817">&gt;=</span>&nbsp;<span class="ident" id="4096820">VersionTLS11</span>&nbsp;<span class="op" id="4096833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096839">explicitIVLen</span>&nbsp;<span class="op" id="4096853">=</span>&nbsp;<span class="ident" id="4096855">blockSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4096868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096874">if</span>&nbsp;<span class="builtinfunc" id="4096877">len</span><span class="op" id="4096880">(</span><span class="ident" id="4096881">payload</span><span class="op" id="4096888">)</span><span class="op" id="4096889">%</span><span class="ident" id="4096890">blockSize</span>&nbsp;<span class="op" id="4096900">!=</span>&nbsp;<span class="num" id="4096903">0</span>&nbsp;<span class="op" id="4096905">||</span>&nbsp;<span class="builtinfunc" id="4096908">len</span><span class="op" id="4096911">(</span><span class="ident" id="4096912">payload</span><span class="op" id="4096919">)</span>&nbsp;<span class="op" id="4096921">&lt;</span>&nbsp;<span class="ident" id="4096923">roundUp</span><span class="op" id="4096930">(</span><span class="ident" id="4096931">explicitIVLen</span><span class="op" id="4096944">+</span><span class="ident" id="4096945">macSize</span><span class="op" id="4096952">+</span><span class="num" id="4096953">1</span><span class="op" id="4096954">,</span>&nbsp;<span class="ident" id="4096956">blockSize</span><span class="op" id="4096965">)</span>&nbsp;<span class="op" id="4096967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096973">return</span>&nbsp;<span class="builtintype" id="4096980">false</span><span class="op" id="4096985">,</span>&nbsp;<span class="num" id="4096987">0</span><span class="op" id="4096988">,</span>&nbsp;<span class="ident" id="4096990">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4097011">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097017">if</span>&nbsp;<span class="ident" id="4097020">explicitIVLen</span>&nbsp;<span class="op" id="4097034">&gt;</span>&nbsp;<span class="num" id="4097036">0</span>&nbsp;<span class="op" id="4097038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097044">c</span><span class="op" id="4097045">.</span><span class="ident" id="4097046">SetIV</span><span class="op" id="4097051">(</span><span class="ident" id="4097052">payload</span><span class="op" id="4097059">[</span><span class="op" id="4097060">:</span><span class="ident" id="4097061">explicitIVLen</span><span class="op" id="4097074">]</span><span class="op" id="4097075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097081">payload</span>&nbsp;<span class="op" id="4097089">=</span>&nbsp;<span class="ident" id="4097091">payload</span><span class="op" id="4097098">[</span><span class="ident" id="4097099">explicitIVLen</span><span class="op" id="4097112">:</span><span class="op" id="4097113">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4097118">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097123">c</span><span class="op" id="4097124">.</span><span class="ident" id="4097125">CryptBlocks</span><span class="op" id="4097136">(</span><span class="ident" id="4097137">payload</span><span class="op" id="4097144">,</span>&nbsp;<span class="ident" id="4097146">payload</span><span class="op" id="4097153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097158">if</span>&nbsp;<span class="ident" id="4097161">hc</span><span class="op" id="4097163">.</span><span class="ident" id="4097164">version</span>&nbsp;<span class="op" id="4097172">==</span>&nbsp;<span class="ident" id="4097175">VersionSSL30</span>&nbsp;<span class="op" id="4097188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097194">payload</span><span class="op" id="4097201">,</span>&nbsp;<span class="ident" id="4097203">paddingGood</span>&nbsp;<span class="op" id="4097215">=</span>&nbsp;<span class="ident" id="4097217">removePaddingSSL30</span><span class="op" id="4097235">(</span><span class="ident" id="4097236">payload</span><span class="op" id="4097243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4097248">}</span>&nbsp;<span class="keyword" id="4097250">else</span>&nbsp;<span class="op" id="4097255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097261">payload</span><span class="op" id="4097268">,</span>&nbsp;<span class="ident" id="4097270">paddingGood</span>&nbsp;<span class="op" id="4097282">=</span>&nbsp;<span class="ident" id="4097284">removePadding</span><span class="op" id="4097297">(</span><span class="ident" id="4097298">payload</span><span class="op" id="4097305">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4097310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097315">b</span><span class="op" id="4097316">.</span><span class="ident" id="4097317">resize</span><span class="op" id="4097323">(</span><span class="ident" id="4097324">recordHeaderLen</span>&nbsp;<span class="op" id="4097340">+</span>&nbsp;<span class="ident" id="4097342">explicitIVLen</span>&nbsp;<span class="op" id="4097356">+</span>&nbsp;<span class="builtinfunc" id="4097358">len</span><span class="op" id="4097361">(</span><span class="ident" id="4097362">payload</span><span class="op" id="4097369">)</span><span class="op" id="4097370">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4097376">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4097435">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4097492">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4097549">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4097605">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4097655">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4097713">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4097733">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4097739">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4097795">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097825">default</span><span class="op" id="4097832">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4097837">panic</span><span class="op" id="4097842">(</span><span class="string" id="4097843">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4097864">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4097868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4097871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4097875">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097896">if</span>&nbsp;<span class="ident" id="4097899">hc</span><span class="op" id="4097901">.</span><span class="ident" id="4097902">mac</span>&nbsp;<span class="op" id="4097906">!=</span>&nbsp;<span class="ident" id="4097909">nil</span>&nbsp;<span class="op" id="4097913">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097917">if</span>&nbsp;<span class="builtinfunc" id="4097920">len</span><span class="op" id="4097923">(</span><span class="ident" id="4097924">payload</span><span class="op" id="4097931">)</span>&nbsp;<span class="op" id="4097933">&lt;</span>&nbsp;<span class="ident" id="4097935">macSize</span>&nbsp;<span class="op" id="4097943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097948">return</span>&nbsp;<span class="builtintype" id="4097955">false</span><span class="op" id="4097960">,</span>&nbsp;<span class="num" id="4097962">0</span><span class="op" id="4097963">,</span>&nbsp;<span class="ident" id="4097965">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4097985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4097990">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098025">n</span>&nbsp;<span class="op" id="4098027">:=</span>&nbsp;<span class="builtinfunc" id="4098030">len</span><span class="op" id="4098033">(</span><span class="ident" id="4098034">payload</span><span class="op" id="4098041">)</span>&nbsp;<span class="op" id="4098043">-</span>&nbsp;<span class="ident" id="4098045">macSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098055">b</span><span class="op" id="4098056">.</span><span class="ident" id="4098057">data</span><span class="op" id="4098061">[</span><span class="num" id="4098062">3</span><span class="op" id="4098063">]</span>&nbsp;<span class="op" id="4098065">=</span>&nbsp;<span class="builtintype" id="4098067">byte</span><span class="op" id="4098071">(</span><span class="ident" id="4098072">n</span>&nbsp;<span class="op" id="4098074">&gt;&gt;</span>&nbsp;<span class="num" id="4098077">8</span><span class="op" id="4098078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098082">b</span><span class="op" id="4098083">.</span><span class="ident" id="4098084">data</span><span class="op" id="4098088">[</span><span class="num" id="4098089">4</span><span class="op" id="4098090">]</span>&nbsp;<span class="op" id="4098092">=</span>&nbsp;<span class="builtintype" id="4098094">byte</span><span class="op" id="4098098">(</span><span class="ident" id="4098099">n</span><span class="op" id="4098100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098104">b</span><span class="op" id="4098105">.</span><span class="ident" id="4098106">resize</span><span class="op" id="4098112">(</span><span class="ident" id="4098113">recordHeaderLen</span>&nbsp;<span class="op" id="4098129">+</span>&nbsp;<span class="ident" id="4098131">explicitIVLen</span>&nbsp;<span class="op" id="4098145">+</span>&nbsp;<span class="ident" id="4098147">n</span><span class="op" id="4098148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098152">remoteMAC</span>&nbsp;<span class="op" id="4098162">:=</span>&nbsp;<span class="ident" id="4098165">payload</span><span class="op" id="4098172">[</span><span class="ident" id="4098173">n</span><span class="op" id="4098174">:</span><span class="op" id="4098175">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098179">localMAC</span>&nbsp;<span class="op" id="4098188">:=</span>&nbsp;<span class="ident" id="4098191">hc</span><span class="op" id="4098193">.</span><span class="ident" id="4098194">mac</span><span class="op" id="4098197">.</span><span class="ident" id="4098198">MAC</span><span class="op" id="4098201">(</span><span class="ident" id="4098202">hc</span><span class="op" id="4098204">.</span><span class="ident" id="4098205">inDigestBuf</span><span class="op" id="4098216">,</span>&nbsp;<span class="ident" id="4098218">hc</span><span class="op" id="4098220">.</span><span class="ident" id="4098221">seq</span><span class="op" id="4098224">[</span><span class="num" id="4098225">0</span><span class="op" id="4098226">:</span><span class="op" id="4098227">]</span><span class="op" id="4098228">,</span>&nbsp;<span class="ident" id="4098230">b</span><span class="op" id="4098231">.</span><span class="ident" id="4098232">data</span><span class="op" id="4098236">[</span><span class="op" id="4098237">:</span><span class="ident" id="4098238">recordHeaderLen</span><span class="op" id="4098253">]</span><span class="op" id="4098254">,</span>&nbsp;<span class="ident" id="4098256">payload</span><span class="op" id="4098263">[</span><span class="op" id="4098264">:</span><span class="ident" id="4098265">n</span><span class="op" id="4098266">]</span><span class="op" id="4098267">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098272">if</span>&nbsp;<span class="ident" id="4098275">subtle</span><span class="op" id="4098281">.</span><span class="ident" id="4098282">ConstantTimeCompare</span><span class="op" id="4098301">(</span><span class="ident" id="4098302">localMAC</span><span class="op" id="4098310">,</span>&nbsp;<span class="ident" id="4098312">remoteMAC</span><span class="op" id="4098321">)</span>&nbsp;<span class="op" id="4098323">!=</span>&nbsp;<span class="num" id="4098326">1</span>&nbsp;<span class="op" id="4098328">||</span>&nbsp;<span class="ident" id="4098331">paddingGood</span>&nbsp;<span class="op" id="4098343">!=</span>&nbsp;<span class="num" id="4098346">255</span>&nbsp;<span class="op" id="4098350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098355">return</span>&nbsp;<span class="builtintype" id="4098362">false</span><span class="op" id="4098367">,</span>&nbsp;<span class="num" id="4098369">0</span><span class="op" id="4098370">,</span>&nbsp;<span class="ident" id="4098372">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4098392">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098396">hc</span><span class="op" id="4098398">.</span><span class="ident" id="4098399">inDigestBuf</span>&nbsp;<span class="op" id="4098411">=</span>&nbsp;<span class="ident" id="4098413">localMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4098423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098426">hc</span><span class="op" id="4098428">.</span><span class="ident" id="4098429">incSeq</span><span class="op" id="4098435">(</span><span class="op" id="4098436">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098440">return</span>&nbsp;<span class="builtintype" id="4098447">true</span><span class="op" id="4098451">,</span>&nbsp;<span class="ident" id="4098453">recordHeaderLen</span>&nbsp;<span class="op" id="4098469">+</span>&nbsp;<span class="ident" id="4098471">explicitIVLen</span><span class="op" id="4098484">,</span>&nbsp;<span class="num" id="4098486">0</span><br>
<span class="lineno">335</span><span class="op" id="4098488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4098491">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="4098569">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="4098644">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="4098724">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4098800">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="4098815">func</span>&nbsp;<span class="ident" id="4098820">padToBlockSize</span><span class="op" id="4098834">(</span><span class="ident" id="4098835">payload</span>&nbsp;<span class="op" id="4098843">[</span><span class="op" id="4098844">]</span><span class="builtintype" id="4098845">byte</span><span class="op" id="4098849">,</span>&nbsp;<span class="ident" id="4098851">blockSize</span>&nbsp;<span class="builtintype" id="4098861">int</span><span class="op" id="4098864">)</span>&nbsp;<span class="op" id="4098866">(</span><span class="ident" id="4098867">prefix</span><span class="op" id="4098873">,</span>&nbsp;<span class="ident" id="4098875">finalBlock</span>&nbsp;<span class="op" id="4098886">[</span><span class="op" id="4098887">]</span><span class="builtintype" id="4098888">byte</span><span class="op" id="4098892">)</span>&nbsp;<span class="op" id="4098894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098897">overrun</span>&nbsp;<span class="op" id="4098905">:=</span>&nbsp;<span class="builtinfunc" id="4098908">len</span><span class="op" id="4098911">(</span><span class="ident" id="4098912">payload</span><span class="op" id="4098919">)</span>&nbsp;<span class="op" id="4098921">%</span>&nbsp;<span class="ident" id="4098923">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098934">paddingLen</span>&nbsp;<span class="op" id="4098945">:=</span>&nbsp;<span class="ident" id="4098948">blockSize</span>&nbsp;<span class="op" id="4098958">-</span>&nbsp;<span class="ident" id="4098960">overrun</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098969">prefix</span>&nbsp;<span class="op" id="4098976">=</span>&nbsp;<span class="ident" id="4098978">payload</span><span class="op" id="4098985">[</span><span class="op" id="4098986">:</span><span class="builtinfunc" id="4098987">len</span><span class="op" id="4098990">(</span><span class="ident" id="4098991">payload</span><span class="op" id="4098998">)</span><span class="op" id="4098999">-</span><span class="ident" id="4099000">overrun</span><span class="op" id="4099007">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099010">finalBlock</span>&nbsp;<span class="op" id="4099021">=</span>&nbsp;<span class="builtinfunc" id="4099023">make</span><span class="op" id="4099027">(</span><span class="op" id="4099028">[</span><span class="op" id="4099029">]</span><span class="builtintype" id="4099030">byte</span><span class="op" id="4099034">,</span>&nbsp;<span class="ident" id="4099036">blockSize</span><span class="op" id="4099045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4099048">copy</span><span class="op" id="4099052">(</span><span class="ident" id="4099053">finalBlock</span><span class="op" id="4099063">,</span>&nbsp;<span class="ident" id="4099065">payload</span><span class="op" id="4099072">[</span><span class="builtinfunc" id="4099073">len</span><span class="op" id="4099076">(</span><span class="ident" id="4099077">payload</span><span class="op" id="4099084">)</span><span class="op" id="4099085">-</span><span class="ident" id="4099086">overrun</span><span class="op" id="4099093">:</span><span class="op" id="4099094">]</span><span class="op" id="4099095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099098">for</span>&nbsp;<span class="ident" id="4099102">i</span>&nbsp;<span class="op" id="4099104">:=</span>&nbsp;<span class="ident" id="4099107">overrun</span><span class="op" id="4099114">;</span>&nbsp;<span class="ident" id="4099116">i</span>&nbsp;<span class="op" id="4099118">&lt;</span>&nbsp;<span class="ident" id="4099120">blockSize</span><span class="op" id="4099129">;</span>&nbsp;<span class="ident" id="4099131">i</span><span class="op" id="4099132">++</span>&nbsp;<span class="op" id="4099135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099139">finalBlock</span><span class="op" id="4099149">[</span><span class="ident" id="4099150">i</span><span class="op" id="4099151">]</span>&nbsp;<span class="op" id="4099153">=</span>&nbsp;<span class="builtintype" id="4099155">byte</span><span class="op" id="4099159">(</span><span class="ident" id="4099160">paddingLen</span>&nbsp;<span class="op" id="4099171">-</span>&nbsp;<span class="num" id="4099173">1</span><span class="op" id="4099174">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4099177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099180">return</span><br>
<span class="lineno"></span><span class="op" id="4099187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4099190">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="4099234">func</span>&nbsp;<span class="op" id="4099239">(</span><span class="ident" id="4099240">hc</span>&nbsp;<span class="op" id="4099243">*</span><span class="ident" id="4099244">halfConn</span><span class="op" id="4099252">)</span>&nbsp;<span class="ident" id="4099254">encrypt</span><span class="op" id="4099261">(</span><span class="ident" id="4099262">b</span>&nbsp;<span class="op" id="4099264">*</span><span class="ident" id="4099265">block</span><span class="op" id="4099270">,</span>&nbsp;<span class="ident" id="4099272">explicitIVLen</span>&nbsp;<span class="builtintype" id="4099286">int</span><span class="op" id="4099289">)</span>&nbsp;<span class="op" id="4099291">(</span><span class="builtintype" id="4099292">bool</span><span class="op" id="4099296">,</span>&nbsp;<span class="ident" id="4099298">alert</span><span class="op" id="4099303">)</span>&nbsp;<span class="op" id="4099305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4099308">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099316">if</span>&nbsp;<span class="ident" id="4099319">hc</span><span class="op" id="4099321">.</span><span class="ident" id="4099322">mac</span>&nbsp;<span class="op" id="4099326">!=</span>&nbsp;<span class="ident" id="4099329">nil</span>&nbsp;<span class="op" id="4099333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099337">mac</span>&nbsp;<span class="op" id="4099341">:=</span>&nbsp;<span class="ident" id="4099344">hc</span><span class="op" id="4099346">.</span><span class="ident" id="4099347">mac</span><span class="op" id="4099350">.</span><span class="ident" id="4099351">MAC</span><span class="op" id="4099354">(</span><span class="ident" id="4099355">hc</span><span class="op" id="4099357">.</span><span class="ident" id="4099358">outDigestBuf</span><span class="op" id="4099370">,</span>&nbsp;<span class="ident" id="4099372">hc</span><span class="op" id="4099374">.</span><span class="ident" id="4099375">seq</span><span class="op" id="4099378">[</span><span class="num" id="4099379">0</span><span class="op" id="4099380">:</span><span class="op" id="4099381">]</span><span class="op" id="4099382">,</span>&nbsp;<span class="ident" id="4099384">b</span><span class="op" id="4099385">.</span><span class="ident" id="4099386">data</span><span class="op" id="4099390">[</span><span class="op" id="4099391">:</span><span class="ident" id="4099392">recordHeaderLen</span><span class="op" id="4099407">]</span><span class="op" id="4099408">,</span>&nbsp;<span class="ident" id="4099410">b</span><span class="op" id="4099411">.</span><span class="ident" id="4099412">data</span><span class="op" id="4099416">[</span><span class="ident" id="4099417">recordHeaderLen</span><span class="op" id="4099432">+</span><span class="ident" id="4099433">explicitIVLen</span><span class="op" id="4099446">:</span><span class="op" id="4099447">]</span><span class="op" id="4099448">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099453">n</span>&nbsp;<span class="op" id="4099455">:=</span>&nbsp;<span class="builtinfunc" id="4099458">len</span><span class="op" id="4099461">(</span><span class="ident" id="4099462">b</span><span class="op" id="4099463">.</span><span class="ident" id="4099464">data</span><span class="op" id="4099468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099472">b</span><span class="op" id="4099473">.</span><span class="ident" id="4099474">resize</span><span class="op" id="4099480">(</span><span class="ident" id="4099481">n</span>&nbsp;<span class="op" id="4099483">+</span>&nbsp;<span class="builtinfunc" id="4099485">len</span><span class="op" id="4099488">(</span><span class="ident" id="4099489">mac</span><span class="op" id="4099492">)</span><span class="op" id="4099493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4099497">copy</span><span class="op" id="4099501">(</span><span class="ident" id="4099502">b</span><span class="op" id="4099503">.</span><span class="ident" id="4099504">data</span><span class="op" id="4099508">[</span><span class="ident" id="4099509">n</span><span class="op" id="4099510">:</span><span class="op" id="4099511">]</span><span class="op" id="4099512">,</span>&nbsp;<span class="ident" id="4099514">mac</span><span class="op" id="4099517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099521">hc</span><span class="op" id="4099523">.</span><span class="ident" id="4099524">outDigestBuf</span>&nbsp;<span class="op" id="4099537">=</span>&nbsp;<span class="ident" id="4099539">mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4099544">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099548">payload</span>&nbsp;<span class="op" id="4099556">:=</span>&nbsp;<span class="ident" id="4099559">b</span><span class="op" id="4099560">.</span><span class="ident" id="4099561">data</span><span class="op" id="4099565">[</span><span class="ident" id="4099566">recordHeaderLen</span><span class="op" id="4099581">:</span><span class="op" id="4099582">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4099586">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099598">if</span>&nbsp;<span class="ident" id="4099601">hc</span><span class="op" id="4099603">.</span><span class="ident" id="4099604">cipher</span>&nbsp;<span class="op" id="4099611">!=</span>&nbsp;<span class="ident" id="4099614">nil</span>&nbsp;<span class="op" id="4099618">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099622">switch</span>&nbsp;<span class="ident" id="4099629">c</span>&nbsp;<span class="op" id="4099631">:=</span>&nbsp;<span class="ident" id="4099634">hc</span><span class="op" id="4099636">.</span><span class="ident" id="4099637">cipher</span><span class="op" id="4099643">.</span><span class="op" id="4099644">(</span><span class="keyword" id="4099645">type</span><span class="op" id="4099649">)</span>&nbsp;<span class="op" id="4099651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099655">case</span>&nbsp;<span class="ident" id="4099660">cipher</span><span class="op" id="4099666">.</span><span class="ident" id="4099667">Stream</span><span class="op" id="4099673">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099678">c</span><span class="op" id="4099679">.</span><span class="ident" id="4099680">XORKeyStream</span><span class="op" id="4099692">(</span><span class="ident" id="4099693">payload</span><span class="op" id="4099700">,</span>&nbsp;<span class="ident" id="4099702">payload</span><span class="op" id="4099709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099713">case</span>&nbsp;<span class="ident" id="4099718">cipher</span><span class="op" id="4099724">.</span><span class="ident" id="4099725">AEAD</span><span class="op" id="4099729">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099734">payloadLen</span>&nbsp;<span class="op" id="4099745">:=</span>&nbsp;<span class="builtinfunc" id="4099748">len</span><span class="op" id="4099751">(</span><span class="ident" id="4099752">b</span><span class="op" id="4099753">.</span><span class="ident" id="4099754">data</span><span class="op" id="4099758">)</span>&nbsp;<span class="op" id="4099760">-</span>&nbsp;<span class="ident" id="4099762">recordHeaderLen</span>&nbsp;<span class="op" id="4099778">-</span>&nbsp;<span class="ident" id="4099780">explicitIVLen</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099797">b</span><span class="op" id="4099798">.</span><span class="ident" id="4099799">resize</span><span class="op" id="4099805">(</span><span class="builtinfunc" id="4099806">len</span><span class="op" id="4099809">(</span><span class="ident" id="4099810">b</span><span class="op" id="4099811">.</span><span class="ident" id="4099812">data</span><span class="op" id="4099816">)</span>&nbsp;<span class="op" id="4099818">+</span>&nbsp;<span class="ident" id="4099820">c</span><span class="op" id="4099821">.</span><span class="ident" id="4099822">Overhead</span><span class="op" id="4099830">(</span><span class="op" id="4099831">)</span><span class="op" id="4099832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099837">nonce</span>&nbsp;<span class="op" id="4099843">:=</span>&nbsp;<span class="ident" id="4099846">b</span><span class="op" id="4099847">.</span><span class="ident" id="4099848">data</span><span class="op" id="4099852">[</span><span class="ident" id="4099853">recordHeaderLen</span>&nbsp;<span class="op" id="4099869">:</span>&nbsp;<span class="ident" id="4099871">recordHeaderLen</span><span class="op" id="4099886">+</span><span class="ident" id="4099887">explicitIVLen</span><span class="op" id="4099900">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099905">payload</span>&nbsp;<span class="op" id="4099913">:=</span>&nbsp;<span class="ident" id="4099916">b</span><span class="op" id="4099917">.</span><span class="ident" id="4099918">data</span><span class="op" id="4099922">[</span><span class="ident" id="4099923">recordHeaderLen</span><span class="op" id="4099938">+</span><span class="ident" id="4099939">explicitIVLen</span><span class="op" id="4099952">:</span><span class="op" id="4099953">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099958">payload</span>&nbsp;<span class="op" id="4099966">=</span>&nbsp;<span class="ident" id="4099968">payload</span><span class="op" id="4099975">[</span><span class="op" id="4099976">:</span><span class="ident" id="4099977">payloadLen</span><span class="op" id="4099987">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099993">var</span>&nbsp;<span class="ident" id="4099997">additionalData</span>&nbsp;<span class="op" id="4100012">[</span><span class="num" id="4100013">13</span><span class="op" id="4100015">]</span><span class="builtintype" id="4100016">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4100024">copy</span><span class="op" id="4100028">(</span><span class="ident" id="4100029">additionalData</span><span class="op" id="4100043">[</span><span class="op" id="4100044">:</span><span class="op" id="4100045">]</span><span class="op" id="4100046">,</span>&nbsp;<span class="ident" id="4100048">hc</span><span class="op" id="4100050">.</span><span class="ident" id="4100051">seq</span><span class="op" id="4100054">[</span><span class="op" id="4100055">:</span><span class="op" id="4100056">]</span><span class="op" id="4100057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4100062">copy</span><span class="op" id="4100066">(</span><span class="ident" id="4100067">additionalData</span><span class="op" id="4100081">[</span><span class="num" id="4100082">8</span><span class="op" id="4100083">:</span><span class="op" id="4100084">]</span><span class="op" id="4100085">,</span>&nbsp;<span class="ident" id="4100087">b</span><span class="op" id="4100088">.</span><span class="ident" id="4100089">data</span><span class="op" id="4100093">[</span><span class="op" id="4100094">:</span><span class="num" id="4100095">3</span><span class="op" id="4100096">]</span><span class="op" id="4100097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100102">additionalData</span><span class="op" id="4100116">[</span><span class="num" id="4100117">11</span><span class="op" id="4100119">]</span>&nbsp;<span class="op" id="4100121">=</span>&nbsp;<span class="builtintype" id="4100123">byte</span><span class="op" id="4100127">(</span><span class="ident" id="4100128">payloadLen</span>&nbsp;<span class="op" id="4100139">&gt;&gt;</span>&nbsp;<span class="num" id="4100142">8</span><span class="op" id="4100143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100148">additionalData</span><span class="op" id="4100162">[</span><span class="num" id="4100163">12</span><span class="op" id="4100165">]</span>&nbsp;<span class="op" id="4100167">=</span>&nbsp;<span class="builtintype" id="4100169">byte</span><span class="op" id="4100173">(</span><span class="ident" id="4100174">payloadLen</span><span class="op" id="4100184">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100190">c</span><span class="op" id="4100191">.</span><span class="ident" id="4100192">Seal</span><span class="op" id="4100196">(</span><span class="ident" id="4100197">payload</span><span class="op" id="4100204">[</span><span class="op" id="4100205">:</span><span class="num" id="4100206">0</span><span class="op" id="4100207">]</span><span class="op" id="4100208">,</span>&nbsp;<span class="ident" id="4100210">nonce</span><span class="op" id="4100215">,</span>&nbsp;<span class="ident" id="4100217">payload</span><span class="op" id="4100224">,</span>&nbsp;<span class="ident" id="4100226">additionalData</span><span class="op" id="4100240">[</span><span class="op" id="4100241">:</span><span class="op" id="4100242">]</span><span class="op" id="4100243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100247">case</span>&nbsp;<span class="ident" id="4100252">cbcMode</span><span class="op" id="4100259">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100264">blockSize</span>&nbsp;<span class="op" id="4100274">:=</span>&nbsp;<span class="ident" id="4100277">c</span><span class="op" id="4100278">.</span><span class="ident" id="4100279">BlockSize</span><span class="op" id="4100288">(</span><span class="op" id="4100289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100294">if</span>&nbsp;<span class="ident" id="4100297">explicitIVLen</span>&nbsp;<span class="op" id="4100311">&gt;</span>&nbsp;<span class="num" id="4100313">0</span>&nbsp;<span class="op" id="4100315">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100321">c</span><span class="op" id="4100322">.</span><span class="ident" id="4100323">SetIV</span><span class="op" id="4100328">(</span><span class="ident" id="4100329">payload</span><span class="op" id="4100336">[</span><span class="op" id="4100337">:</span><span class="ident" id="4100338">explicitIVLen</span><span class="op" id="4100351">]</span><span class="op" id="4100352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100358">payload</span>&nbsp;<span class="op" id="4100366">=</span>&nbsp;<span class="ident" id="4100368">payload</span><span class="op" id="4100375">[</span><span class="ident" id="4100376">explicitIVLen</span><span class="op" id="4100389">:</span><span class="op" id="4100390">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100400">prefix</span><span class="op" id="4100406">,</span>&nbsp;<span class="ident" id="4100408">finalBlock</span>&nbsp;<span class="op" id="4100419">:=</span>&nbsp;<span class="ident" id="4100422">padToBlockSize</span><span class="op" id="4100436">(</span><span class="ident" id="4100437">payload</span><span class="op" id="4100444">,</span>&nbsp;<span class="ident" id="4100446">blockSize</span><span class="op" id="4100455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100460">b</span><span class="op" id="4100461">.</span><span class="ident" id="4100462">resize</span><span class="op" id="4100468">(</span><span class="ident" id="4100469">recordHeaderLen</span>&nbsp;<span class="op" id="4100485">+</span>&nbsp;<span class="ident" id="4100487">explicitIVLen</span>&nbsp;<span class="op" id="4100501">+</span>&nbsp;<span class="builtinfunc" id="4100503">len</span><span class="op" id="4100506">(</span><span class="ident" id="4100507">prefix</span><span class="op" id="4100513">)</span>&nbsp;<span class="op" id="4100515">+</span>&nbsp;<span class="builtinfunc" id="4100517">len</span><span class="op" id="4100520">(</span><span class="ident" id="4100521">finalBlock</span><span class="op" id="4100531">)</span><span class="op" id="4100532">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100537">c</span><span class="op" id="4100538">.</span><span class="ident" id="4100539">CryptBlocks</span><span class="op" id="4100550">(</span><span class="ident" id="4100551">b</span><span class="op" id="4100552">.</span><span class="ident" id="4100553">data</span><span class="op" id="4100557">[</span><span class="ident" id="4100558">recordHeaderLen</span><span class="op" id="4100573">+</span><span class="ident" id="4100574">explicitIVLen</span><span class="op" id="4100587">:</span><span class="op" id="4100588">]</span><span class="op" id="4100589">,</span>&nbsp;<span class="ident" id="4100591">prefix</span><span class="op" id="4100597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100602">c</span><span class="op" id="4100603">.</span><span class="ident" id="4100604">CryptBlocks</span><span class="op" id="4100615">(</span><span class="ident" id="4100616">b</span><span class="op" id="4100617">.</span><span class="ident" id="4100618">data</span><span class="op" id="4100622">[</span><span class="ident" id="4100623">recordHeaderLen</span><span class="op" id="4100638">+</span><span class="ident" id="4100639">explicitIVLen</span><span class="op" id="4100652">+</span><span class="builtinfunc" id="4100653">len</span><span class="op" id="4100656">(</span><span class="ident" id="4100657">prefix</span><span class="op" id="4100663">)</span><span class="op" id="4100664">:</span><span class="op" id="4100665">]</span><span class="op" id="4100666">,</span>&nbsp;<span class="ident" id="4100668">finalBlock</span><span class="op" id="4100678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100682">default</span><span class="op" id="4100689">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4100694">panic</span><span class="op" id="4100699">(</span><span class="string" id="4100700">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4100721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100725">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4100732">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100795">n</span>&nbsp;<span class="op" id="4100797">:=</span>&nbsp;<span class="builtinfunc" id="4100800">len</span><span class="op" id="4100803">(</span><span class="ident" id="4100804">b</span><span class="op" id="4100805">.</span><span class="ident" id="4100806">data</span><span class="op" id="4100810">)</span>&nbsp;<span class="op" id="4100812">-</span>&nbsp;<span class="ident" id="4100814">recordHeaderLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100831">b</span><span class="op" id="4100832">.</span><span class="ident" id="4100833">data</span><span class="op" id="4100837">[</span><span class="num" id="4100838">3</span><span class="op" id="4100839">]</span>&nbsp;<span class="op" id="4100841">=</span>&nbsp;<span class="builtintype" id="4100843">byte</span><span class="op" id="4100847">(</span><span class="ident" id="4100848">n</span>&nbsp;<span class="op" id="4100850">&gt;&gt;</span>&nbsp;<span class="num" id="4100853">8</span><span class="op" id="4100854">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100857">b</span><span class="op" id="4100858">.</span><span class="ident" id="4100859">data</span><span class="op" id="4100863">[</span><span class="num" id="4100864">4</span><span class="op" id="4100865">]</span>&nbsp;<span class="op" id="4100867">=</span>&nbsp;<span class="builtintype" id="4100869">byte</span><span class="op" id="4100873">(</span><span class="ident" id="4100874">n</span><span class="op" id="4100875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100878">hc</span><span class="op" id="4100880">.</span><span class="ident" id="4100881">incSeq</span><span class="op" id="4100887">(</span><span class="op" id="4100888">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100892">return</span>&nbsp;<span class="builtintype" id="4100899">true</span><span class="op" id="4100903">,</span>&nbsp;<span class="num" id="4100905">0</span><br>
<span class="lineno"></span><span class="op" id="4100907">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="4100910">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4100946">type</span>&nbsp;<span class="ident" id="4100951">block</span>&nbsp;<span class="keyword" id="4100957">struct</span>&nbsp;<span class="op" id="4100964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100967">data</span>&nbsp;<span class="op" id="4100972">[</span><span class="op" id="4100973">]</span><span class="builtintype" id="4100974">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100980">off</span>&nbsp;&nbsp;<span class="builtintype" id="4100985">int</span>&nbsp;<span class="comment" id="4100989">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101008">link</span>&nbsp;<span class="op" id="4101013">*</span><span class="ident" id="4101014">block</span><br>
<span class="lineno"></span><span class="op" id="4101020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4101023">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4101084">func</span>&nbsp;<span class="op" id="4101089">(</span><span class="ident" id="4101090">b</span>&nbsp;<span class="op" id="4101092">*</span><span class="ident" id="4101093">block</span><span class="op" id="4101098">)</span>&nbsp;<span class="ident" id="4101100">resize</span><span class="op" id="4101106">(</span><span class="ident" id="4101107">n</span>&nbsp;<span class="builtintype" id="4101109">int</span><span class="op" id="4101112">)</span>&nbsp;<span class="op" id="4101114">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101117">if</span>&nbsp;<span class="ident" id="4101120">n</span>&nbsp;<span class="op" id="4101122">&gt;</span>&nbsp;<span class="builtinfunc" id="4101124">cap</span><span class="op" id="4101127">(</span><span class="ident" id="4101128">b</span><span class="op" id="4101129">.</span><span class="ident" id="4101130">data</span><span class="op" id="4101134">)</span>&nbsp;<span class="op" id="4101136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101140">b</span><span class="op" id="4101141">.</span><span class="ident" id="4101142">reserve</span><span class="op" id="4101149">(</span><span class="ident" id="4101150">n</span><span class="op" id="4101151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4101154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101157">b</span><span class="op" id="4101158">.</span><span class="ident" id="4101159">data</span>&nbsp;<span class="op" id="4101164">=</span>&nbsp;<span class="ident" id="4101166">b</span><span class="op" id="4101167">.</span><span class="ident" id="4101168">data</span><span class="op" id="4101172">[</span><span class="num" id="4101173">0</span><span class="op" id="4101174">:</span><span class="ident" id="4101175">n</span><span class="op" id="4101176">]</span><br>
<span class="lineno"></span><span class="op" id="4101178">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="4101181">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4101255">func</span>&nbsp;<span class="op" id="4101260">(</span><span class="ident" id="4101261">b</span>&nbsp;<span class="op" id="4101263">*</span><span class="ident" id="4101264">block</span><span class="op" id="4101269">)</span>&nbsp;<span class="ident" id="4101271">reserve</span><span class="op" id="4101278">(</span><span class="ident" id="4101279">n</span>&nbsp;<span class="builtintype" id="4101281">int</span><span class="op" id="4101284">)</span>&nbsp;<span class="op" id="4101286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101289">if</span>&nbsp;<span class="builtinfunc" id="4101292">cap</span><span class="op" id="4101295">(</span><span class="ident" id="4101296">b</span><span class="op" id="4101297">.</span><span class="ident" id="4101298">data</span><span class="op" id="4101302">)</span>&nbsp;<span class="op" id="4101304">&gt;=</span>&nbsp;<span class="ident" id="4101307">n</span>&nbsp;<span class="op" id="4101309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101313">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4101321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101324">m</span>&nbsp;<span class="op" id="4101326">:=</span>&nbsp;<span class="builtinfunc" id="4101329">cap</span><span class="op" id="4101332">(</span><span class="ident" id="4101333">b</span><span class="op" id="4101334">.</span><span class="ident" id="4101335">data</span><span class="op" id="4101339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101342">if</span>&nbsp;<span class="ident" id="4101345">m</span>&nbsp;<span class="op" id="4101347">==</span>&nbsp;<span class="num" id="4101350">0</span>&nbsp;<span class="op" id="4101352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101356">m</span>&nbsp;<span class="op" id="4101358">=</span>&nbsp;<span class="num" id="4101360">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4101366">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101369">for</span>&nbsp;<span class="ident" id="4101373">m</span>&nbsp;<span class="op" id="4101375">&lt;</span>&nbsp;<span class="ident" id="4101377">n</span>&nbsp;<span class="op" id="4101379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101383">m</span>&nbsp;<span class="op" id="4101385">*=</span>&nbsp;<span class="num" id="4101388">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4101391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101394">data</span>&nbsp;<span class="op" id="4101399">:=</span>&nbsp;<span class="builtinfunc" id="4101402">make</span><span class="op" id="4101406">(</span><span class="op" id="4101407">[</span><span class="op" id="4101408">]</span><span class="builtintype" id="4101409">byte</span><span class="op" id="4101413">,</span>&nbsp;<span class="builtinfunc" id="4101415">len</span><span class="op" id="4101418">(</span><span class="ident" id="4101419">b</span><span class="op" id="4101420">.</span><span class="ident" id="4101421">data</span><span class="op" id="4101425">)</span><span class="op" id="4101426">,</span>&nbsp;<span class="ident" id="4101428">m</span><span class="op" id="4101429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4101432">copy</span><span class="op" id="4101436">(</span><span class="ident" id="4101437">data</span><span class="op" id="4101441">,</span>&nbsp;<span class="ident" id="4101443">b</span><span class="op" id="4101444">.</span><span class="ident" id="4101445">data</span><span class="op" id="4101449">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101452">b</span><span class="op" id="4101453">.</span><span class="ident" id="4101454">data</span>&nbsp;<span class="op" id="4101459">=</span>&nbsp;<span class="ident" id="4101461">data</span><br>
<span class="lineno"></span><span class="op" id="4101466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4101469">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="4101540">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="4101569">func</span>&nbsp;<span class="op" id="4101574">(</span><span class="ident" id="4101575">b</span>&nbsp;<span class="op" id="4101577">*</span><span class="ident" id="4101578">block</span><span class="op" id="4101583">)</span>&nbsp;<span class="ident" id="4101585">readFromUntil</span><span class="op" id="4101598">(</span><span class="ident" id="4101599">r</span>&nbsp;<span class="ident" id="4101601">io</span><span class="op" id="4101603">.</span><span class="ident" id="4101604">Reader</span><span class="op" id="4101610">,</span>&nbsp;<span class="ident" id="4101612">n</span>&nbsp;<span class="builtintype" id="4101614">int</span><span class="op" id="4101617">)</span>&nbsp;<span class="builtintype" id="4101619">error</span>&nbsp;<span class="op" id="4101625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4101628">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101643">if</span>&nbsp;<span class="builtinfunc" id="4101646">len</span><span class="op" id="4101649">(</span><span class="ident" id="4101650">b</span><span class="op" id="4101651">.</span><span class="ident" id="4101652">data</span><span class="op" id="4101656">)</span>&nbsp;<span class="op" id="4101658">&gt;=</span>&nbsp;<span class="ident" id="4101661">n</span>&nbsp;<span class="op" id="4101663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101667">return</span>&nbsp;<span class="ident" id="4101674">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4101679">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4101683">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101711">b</span><span class="op" id="4101712">.</span><span class="ident" id="4101713">reserve</span><span class="op" id="4101720">(</span><span class="ident" id="4101721">n</span><span class="op" id="4101722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101725">for</span>&nbsp;<span class="op" id="4101729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101733">m</span><span class="op" id="4101734">,</span>&nbsp;<span class="ident" id="4101736">err</span>&nbsp;<span class="op" id="4101740">:=</span>&nbsp;<span class="ident" id="4101743">r</span><span class="op" id="4101744">.</span><span class="ident" id="4101745">Read</span><span class="op" id="4101749">(</span><span class="ident" id="4101750">b</span><span class="op" id="4101751">.</span><span class="ident" id="4101752">data</span><span class="op" id="4101756">[</span><span class="builtinfunc" id="4101757">len</span><span class="op" id="4101760">(</span><span class="ident" id="4101761">b</span><span class="op" id="4101762">.</span><span class="ident" id="4101763">data</span><span class="op" id="4101767">)</span><span class="op" id="4101768">:</span><span class="builtinfunc" id="4101769">cap</span><span class="op" id="4101772">(</span><span class="ident" id="4101773">b</span><span class="op" id="4101774">.</span><span class="ident" id="4101775">data</span><span class="op" id="4101779">)</span><span class="op" id="4101780">]</span><span class="op" id="4101781">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4101785">b</span><span class="op" id="4101786">.</span><span class="ident" id="4101787">data</span>&nbsp;<span class="op" id="4101792">=</span>&nbsp;<span class="ident" id="4101794">b</span><span class="op" id="4101795">.</span><span class="ident" id="4101796">data</span><span class="op" id="4101800">[</span><span class="num" id="4101801">0</span>&nbsp;<span class="op" id="4101803">:</span>&nbsp;<span class="builtinfunc" id="4101805">len</span><span class="op" id="4101808">(</span><span class="ident" id="4101809">b</span><span class="op" id="4101810">.</span><span class="ident" id="4101811">data</span><span class="op" id="4101815">)</span><span class="op" id="4101816">+</span><span class="ident" id="4101817">m</span><span class="op" id="4101818">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101822">if</span>&nbsp;<span class="builtinfunc" id="4101825">len</span><span class="op" id="4101828">(</span><span class="ident" id="4101829">b</span><span class="op" id="4101830">.</span><span class="ident" id="4101831">data</span><span class="op" id="4101835">)</span>&nbsp;<span class="op" id="4101837">&gt;=</span>&nbsp;<span class="ident" id="4101840">n</span>&nbsp;<span class="op" id="4101842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4101847">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4101893">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101943">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4101951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101955">if</span>&nbsp;<span class="ident" id="4101958">err</span>&nbsp;<span class="op" id="4101962">!=</span>&nbsp;<span class="ident" id="4101965">nil</span>&nbsp;<span class="op" id="4101969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101974">return</span>&nbsp;<span class="ident" id="4101981">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4101987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4101990">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4101993">return</span>&nbsp;<span class="ident" id="4102000">nil</span><br>
<span class="lineno"></span><span class="op" id="4102004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4102007">func</span>&nbsp;<span class="op" id="4102012">(</span><span class="ident" id="4102013">b</span>&nbsp;<span class="op" id="4102015">*</span><span class="ident" id="4102016">block</span><span class="op" id="4102021">)</span>&nbsp;<span class="ident" id="4102023">Read</span><span class="op" id="4102027">(</span><span class="ident" id="4102028">p</span>&nbsp;<span class="op" id="4102030">[</span><span class="op" id="4102031">]</span><span class="builtintype" id="4102032">byte</span><span class="op" id="4102036">)</span>&nbsp;<span class="op" id="4102038">(</span><span class="ident" id="4102039">n</span>&nbsp;<span class="builtintype" id="4102041">int</span><span class="op" id="4102044">,</span>&nbsp;<span class="ident" id="4102046">err</span>&nbsp;<span class="builtintype" id="4102050">error</span><span class="op" id="4102055">)</span>&nbsp;<span class="op" id="4102057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4102060">n</span>&nbsp;<span class="op" id="4102062">=</span>&nbsp;<span class="builtinfunc" id="4102064">copy</span><span class="op" id="4102068">(</span><span class="ident" id="4102069">p</span><span class="op" id="4102070">,</span>&nbsp;<span class="ident" id="4102072">b</span><span class="op" id="4102073">.</span><span class="ident" id="4102074">data</span><span class="op" id="4102078">[</span><span class="ident" id="4102079">b</span><span class="op" id="4102080">.</span><span class="ident" id="4102081">off</span><span class="op" id="4102084">:</span><span class="op" id="4102085">]</span><span class="op" id="4102086">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4102089">b</span><span class="op" id="4102090">.</span><span class="ident" id="4102091">off</span>&nbsp;<span class="op" id="4102095">+=</span>&nbsp;<span class="ident" id="4102098">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4102101">return</span><br>
<span class="lineno"></span><span class="op" id="4102108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4102111">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="4102179">func</span>&nbsp;<span class="op" id="4102184">(</span><span class="ident" id="4102185">hc</span>&nbsp;<span class="op" id="4102188">*</span><span class="ident" id="4102189">halfConn</span><span class="op" id="4102197">)</span>&nbsp;<span class="ident" id="4102199">newBlock</span><span class="op" id="4102207">(</span><span class="op" id="4102208">)</span>&nbsp;<span class="op" id="4102210">*</span><span class="ident" id="4102211">block</span>&nbsp;<span class="op" id="4102217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4102220">b</span>&nbsp;<span class="op" id="4102222">:=</span>&nbsp;<span class="ident" id="4102225">hc</span><span class="op" id="4102227">.</span><span class="ident" id="4102228">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4102235">if</span>&nbsp;<span class="ident" id="4102238">b</span>&nbsp;<span class="op" id="4102240">==</span>&nbsp;<span class="ident" id="4102243">nil</span>&nbsp;<span class="op" id="4102247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4102251">return</span>&nbsp;<span class="builtinfunc" id="4102258">new</span><span class="op" id="4102261">(</span><span class="ident" id="4102262">block</span><span class="op" id="4102267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4102270">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4102273">hc</span><span class="op" id="4102275">.</span><span class="ident" id="4102276">bfree</span>&nbsp;<span class="op" id="4102282">=</span>&nbsp;<span class="ident" id="4102284">b</span><span class="op" id="4102285">.</span><span class="ident" id="4102286">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4102292">b</span><span class="op" id="4102293">.</span><span class="ident" id="4102294">link</span>&nbsp;<span class="op" id="4102299">=</span>&nbsp;<span class="ident" id="4102301">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4102306">b</span><span class="op" id="4102307">.</span><span class="ident" id="4102308">resize</span><span class="op" id="4102314">(</span><span class="num" id="4102315">0</span><span class="op" id="4102316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4102319">return</span>&nbsp;<span class="ident" id="4102326">b</span><br>
<span class="lineno"></span><span class="op" id="4102328">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="4102331">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="4102379">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4102445">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="4102507">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="4102534">func</span>&nbsp;<span class="op" id="4102539">(</span><span class="ident" id="4102540">hc</span>&nbsp;<span class="op" id="4102543">*</span><span class="ident" id="4102544">halfConn</span><span class="op" id="4102552">)</span>&nbsp;<span class="ident" id="4102554">freeBlock</span><span class="op" id="4102563">(</span><span class="ident" id="4102564">b</span>&nbsp;<span class="op" id="4102566">*</span><span class="ident" id="4102567">block</span><span class="op" id="4102572">)</span>&nbsp;<span class="op" id="4102574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4102577">b</span><span class="op" id="4102578">.</span><span class="ident" id="4102579">link</span>&nbsp;<span class="op" id="4102584">=</span>&nbsp;<span class="ident" id="4102586">hc</span><span class="op" id="4102588">.</span><span class="ident" id="4102589">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4102596">hc</span><span class="op" id="4102598">.</span><span class="ident" id="4102599">bfree</span>&nbsp;<span class="op" id="4102605">=</span>&nbsp;<span class="ident" id="4102607">b</span><br>
<span class="lineno"></span><span class="op" id="4102609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="4102612">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="4102666">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4102712">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4102765">func</span>&nbsp;<span class="op" id="4102770">(</span><span class="ident" id="4102771">hc</span>&nbsp;<span class="op" id="4102774">*</span><span class="ident" id="4102775">halfConn</span><span class="op" id="4102783">)</span>&nbsp;<span class="ident" id="4102785">splitBlock</span><span class="op" id="4102795">(</span><span class="ident" id="4102796">b</span>&nbsp;<span class="op" id="4102798">*</span><span class="ident" id="4102799">block</span><span class="op" id="4102804">,</span>&nbsp;<span class="ident" id="4102806">n</span>&nbsp;<span class="builtintype" id="4102808">int</span><span class="op" id="4102811">)</span>&nbsp;<span class="op" id="4102813">(</span><span class="op" id="4102814">*</span><span class="ident" id="4102815">block</span><span class="op" id="4102820">,</span>&nbsp;<span class="op" id="4102822">*</span><span class="ident" id="4102823">block</span><span class="op" id="4102828">)</span>&nbsp;<span class="op" id="4102830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4102833">if</span>&nbsp;<span class="builtinfunc" id="4102836">len</span><span class="op" id="4102839">(</span><span class="ident" id="4102840">b</span><span class="op" id="4102841">.</span><span class="ident" id="4102842">data</span><span class="op" id="4102846">)</span>&nbsp;<span class="op" id="4102848">&lt;=</span>&nbsp;<span class="ident" id="4102851">n</span>&nbsp;<span class="op" id="4102853">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4102857">return</span>&nbsp;<span class="ident" id="4102864">b</span><span class="op" id="4102865">,</span>&nbsp;<span class="ident" id="4102867">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4102872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4102875">bb</span>&nbsp;<span class="op" id="4102878">:=</span>&nbsp;<span class="ident" id="4102881">hc</span><span class="op" id="4102883">.</span><span class="ident" id="4102884">newBlock</span><span class="op" id="4102892">(</span><span class="op" id="4102893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4102896">bb</span><span class="op" id="4102898">.</span><span class="ident" id="4102899">resize</span><span class="op" id="4102905">(</span><span class="builtinfunc" id="4102906">len</span><span class="op" id="4102909">(</span><span class="ident" id="4102910">b</span><span class="op" id="4102911">.</span><span class="ident" id="4102912">data</span><span class="op" id="4102916">)</span>&nbsp;<span class="op" id="4102918">-</span>&nbsp;<span class="ident" id="4102920">n</span><span class="op" id="4102921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4102924">copy</span><span class="op" id="4102928">(</span><span class="ident" id="4102929">bb</span><span class="op" id="4102931">.</span><span class="ident" id="4102932">data</span><span class="op" id="4102936">,</span>&nbsp;<span class="ident" id="4102938">b</span><span class="op" id="4102939">.</span><span class="ident" id="4102940">data</span><span class="op" id="4102944">[</span><span class="ident" id="4102945">n</span><span class="op" id="4102946">:</span><span class="op" id="4102947">]</span><span class="op" id="4102948">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4102951">b</span><span class="op" id="4102952">.</span><span class="ident" id="4102953">data</span>&nbsp;<span class="op" id="4102958">=</span>&nbsp;<span class="ident" id="4102960">b</span><span class="op" id="4102961">.</span><span class="ident" id="4102962">data</span><span class="op" id="4102966">[</span><span class="num" id="4102967">0</span><span class="op" id="4102968">:</span><span class="ident" id="4102969">n</span><span class="op" id="4102970">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4102973">return</span>&nbsp;<span class="ident" id="4102980">b</span><span class="op" id="4102981">,</span>&nbsp;<span class="ident" id="4102983">bb</span><br>
<span class="lineno"></span><span class="op" id="4102986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4102989">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="4103049">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4103088">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4103124">func</span>&nbsp;<span class="op" id="4103129">(</span><span class="ident" id="4103130">c</span>&nbsp;<span class="op" id="4103132">*</span><span class="ident" id="4103133">Conn</span><span class="op" id="4103137">)</span>&nbsp;<span class="ident" id="4103139">readRecord</span><span class="op" id="4103149">(</span><span class="ident" id="4103150">want</span>&nbsp;<span class="ident" id="4103155">recordType</span><span class="op" id="4103165">)</span>&nbsp;<span class="builtintype" id="4103167">error</span>&nbsp;<span class="op" id="4103173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4103176">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4103220">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4103271">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4103333">switch</span>&nbsp;<span class="ident" id="4103340">want</span>&nbsp;<span class="op" id="4103345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4103348">default</span><span class="op" id="4103355">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4103359">c</span><span class="op" id="4103360">.</span><span class="ident" id="4103361">sendAlert</span><span class="op" id="4103370">(</span><span class="ident" id="4103371">alertInternalError</span><span class="op" id="4103389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4103393">return</span>&nbsp;<span class="ident" id="4103400">c</span><span class="op" id="4103401">.</span><span class="ident" id="4103402">in</span><span class="op" id="4103404">.</span><span class="ident" id="4103405">setErrorLocked</span><span class="op" id="4103419">(</span><span class="ident" id="4103420">errors</span><span class="op" id="4103426">.</span><span class="ident" id="4103427">New</span><span class="op" id="4103430">(</span><span class="string" id="4103431">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="4103467">)</span><span class="op" id="4103468">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4103471">case</span>&nbsp;<span class="ident" id="4103476">recordTypeHandshake</span><span class="op" id="4103495">,</span>&nbsp;<span class="ident" id="4103497">recordTypeChangeCipherSpec</span><span class="op" id="4103523">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4103527">if</span>&nbsp;<span class="ident" id="4103530">c</span><span class="op" id="4103531">.</span><span class="ident" id="4103532">handshakeComplete</span>&nbsp;<span class="op" id="4103550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4103555">c</span><span class="op" id="4103556">.</span><span class="ident" id="4103557">sendAlert</span><span class="op" id="4103566">(</span><span class="ident" id="4103567">alertInternalError</span><span class="op" id="4103585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4103590">return</span>&nbsp;<span class="ident" id="4103597">c</span><span class="op" id="4103598">.</span><span class="ident" id="4103599">in</span><span class="op" id="4103601">.</span><span class="ident" id="4103602">setErrorLocked</span><span class="op" id="4103616">(</span><span class="ident" id="4103617">errors</span><span class="op" id="4103623">.</span><span class="ident" id="4103624">New</span><span class="op" id="4103627">(</span><span class="string" id="4103628">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4103699">)</span><span class="op" id="4103700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4103704">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4103707">case</span>&nbsp;<span class="ident" id="4103712">recordTypeApplicationData</span><span class="op" id="4103737">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4103741">if</span>&nbsp;<span class="op" id="4103744">!</span><span class="ident" id="4103745">c</span><span class="op" id="4103746">.</span><span class="ident" id="4103747">handshakeComplete</span>&nbsp;<span class="op" id="4103765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4103770">c</span><span class="op" id="4103771">.</span><span class="ident" id="4103772">sendAlert</span><span class="op" id="4103781">(</span><span class="ident" id="4103782">alertInternalError</span><span class="op" id="4103800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4103805">return</span>&nbsp;<span class="ident" id="4103812">c</span><span class="op" id="4103813">.</span><span class="ident" id="4103814">in</span><span class="op" id="4103816">.</span><span class="ident" id="4103817">setErrorLocked</span><span class="op" id="4103831">(</span><span class="ident" id="4103832">errors</span><span class="op" id="4103838">.</span><span class="ident" id="4103839">New</span><span class="op" id="4103842">(</span><span class="string" id="4103843">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4103909">)</span><span class="op" id="4103910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4103914">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4103917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4103920">Again</span><span class="op" id="4103925">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4103928">if</span>&nbsp;<span class="ident" id="4103931">c</span><span class="op" id="4103932">.</span><span class="ident" id="4103933">rawInput</span>&nbsp;<span class="op" id="4103942">==</span>&nbsp;<span class="ident" id="4103945">nil</span>&nbsp;<span class="op" id="4103949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4103953">c</span><span class="op" id="4103954">.</span><span class="ident" id="4103955">rawInput</span>&nbsp;<span class="op" id="4103964">=</span>&nbsp;<span class="ident" id="4103966">c</span><span class="op" id="4103967">.</span><span class="ident" id="4103968">in</span><span class="op" id="4103970">.</span><span class="ident" id="4103971">newBlock</span><span class="op" id="4103979">(</span><span class="op" id="4103980">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4103983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4103986">b</span>&nbsp;<span class="op" id="4103988">:=</span>&nbsp;<span class="ident" id="4103991">c</span><span class="op" id="4103992">.</span><span class="ident" id="4103993">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4104004">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4104030">if</span>&nbsp;<span class="ident" id="4104033">err</span>&nbsp;<span class="op" id="4104037">:=</span>&nbsp;<span class="ident" id="4104040">b</span><span class="op" id="4104041">.</span><span class="ident" id="4104042">readFromUntil</span><span class="op" id="4104055">(</span><span class="ident" id="4104056">c</span><span class="op" id="4104057">.</span><span class="ident" id="4104058">conn</span><span class="op" id="4104062">,</span>&nbsp;<span class="ident" id="4104064">recordHeaderLen</span><span class="op" id="4104079">)</span><span class="op" id="4104080">;</span>&nbsp;<span class="ident" id="4104082">err</span>&nbsp;<span class="op" id="4104086">!=</span>&nbsp;<span class="ident" id="4104089">nil</span>&nbsp;<span class="op" id="4104093">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4104097">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4104155">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4104209">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4104244">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4104268">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4104300">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4104307">if</span>&nbsp;<span class="ident" id="4104310">e</span><span class="op" id="4104311">,</span>&nbsp;<span class="ident" id="4104313">ok</span>&nbsp;<span class="op" id="4104316">:=</span>&nbsp;<span class="ident" id="4104319">err</span><span class="op" id="4104322">.</span><span class="op" id="4104323">(</span><span class="ident" id="4104324">net</span><span class="op" id="4104327">.</span><span class="ident" id="4104328">Error</span><span class="op" id="4104333">)</span><span class="op" id="4104334">;</span>&nbsp;<span class="op" id="4104336">!</span><span class="ident" id="4104337">ok</span>&nbsp;<span class="op" id="4104340">||</span>&nbsp;<span class="op" id="4104343">!</span><span class="ident" id="4104344">e</span><span class="op" id="4104345">.</span><span class="ident" id="4104346">Temporary</span><span class="op" id="4104355">(</span><span class="op" id="4104356">)</span>&nbsp;<span class="op" id="4104358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4104363">c</span><span class="op" id="4104364">.</span><span class="ident" id="4104365">in</span><span class="op" id="4104367">.</span><span class="ident" id="4104368">setErrorLocked</span><span class="op" id="4104382">(</span><span class="ident" id="4104383">err</span><span class="op" id="4104386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4104390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4104394">return</span>&nbsp;<span class="ident" id="4104401">err</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4104406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4104409">typ</span>&nbsp;<span class="op" id="4104413">:=</span>&nbsp;<span class="ident" id="4104416">recordType</span><span class="op" id="4104426">(</span><span class="ident" id="4104427">b</span><span class="op" id="4104428">.</span><span class="ident" id="4104429">data</span><span class="op" id="4104433">[</span><span class="num" id="4104434">0</span><span class="op" id="4104435">]</span><span class="op" id="4104436">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4104440">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4104509">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4104582">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4104654">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4104675">if</span>&nbsp;<span class="ident" id="4104678">want</span>&nbsp;<span class="op" id="4104683">==</span>&nbsp;<span class="ident" id="4104686">recordTypeHandshake</span>&nbsp;<span class="op" id="4104706">&amp;&amp;</span>&nbsp;<span class="ident" id="4104709">typ</span>&nbsp;<span class="op" id="4104713">==</span>&nbsp;<span class="num" id="4104716">0x80</span>&nbsp;<span class="op" id="4104721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4104725">c</span><span class="op" id="4104726">.</span><span class="ident" id="4104727">sendAlert</span><span class="op" id="4104736">(</span><span class="ident" id="4104737">alertProtocolVersion</span><span class="op" id="4104757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4104761">return</span>&nbsp;<span class="ident" id="4104768">c</span><span class="op" id="4104769">.</span><span class="ident" id="4104770">in</span><span class="op" id="4104772">.</span><span class="ident" id="4104773">setErrorLocked</span><span class="op" id="4104787">(</span><span class="ident" id="4104788">errors</span><span class="op" id="4104794">.</span><span class="ident" id="4104795">New</span><span class="op" id="4104798">(</span><span class="string" id="4104799">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="4104842">)</span><span class="op" id="4104843">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4104846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4104850">vers</span>&nbsp;<span class="op" id="4104855">:=</span>&nbsp;<span class="builtintype" id="4104858">uint16</span><span class="op" id="4104864">(</span><span class="ident" id="4104865">b</span><span class="op" id="4104866">.</span><span class="ident" id="4104867">data</span><span class="op" id="4104871">[</span><span class="num" id="4104872">1</span><span class="op" id="4104873">]</span><span class="op" id="4104874">)</span><span class="op" id="4104875">&lt;&lt;</span><span class="num" id="4104877">8</span>&nbsp;<span class="op" id="4104879">|</span>&nbsp;<span class="builtintype" id="4104881">uint16</span><span class="op" id="4104887">(</span><span class="ident" id="4104888">b</span><span class="op" id="4104889">.</span><span class="ident" id="4104890">data</span><span class="op" id="4104894">[</span><span class="num" id="4104895">2</span><span class="op" id="4104896">]</span><span class="op" id="4104897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4104900">n</span>&nbsp;<span class="op" id="4104902">:=</span>&nbsp;<span class="builtintype" id="4104905">int</span><span class="op" id="4104908">(</span><span class="ident" id="4104909">b</span><span class="op" id="4104910">.</span><span class="ident" id="4104911">data</span><span class="op" id="4104915">[</span><span class="num" id="4104916">3</span><span class="op" id="4104917">]</span><span class="op" id="4104918">)</span><span class="op" id="4104919">&lt;&lt;</span><span class="num" id="4104921">8</span>&nbsp;<span class="op" id="4104923">|</span>&nbsp;<span class="builtintype" id="4104925">int</span><span class="op" id="4104928">(</span><span class="ident" id="4104929">b</span><span class="op" id="4104930">.</span><span class="ident" id="4104931">data</span><span class="op" id="4104935">[</span><span class="num" id="4104936">4</span><span class="op" id="4104937">]</span><span class="op" id="4104938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4104941">if</span>&nbsp;<span class="ident" id="4104944">c</span><span class="op" id="4104945">.</span><span class="ident" id="4104946">haveVers</span>&nbsp;<span class="op" id="4104955">&amp;&amp;</span>&nbsp;<span class="ident" id="4104958">vers</span>&nbsp;<span class="op" id="4104963">!=</span>&nbsp;<span class="ident" id="4104966">c</span><span class="op" id="4104967">.</span><span class="ident" id="4104968">vers</span>&nbsp;<span class="op" id="4104973">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4104977">c</span><span class="op" id="4104978">.</span><span class="ident" id="4104979">sendAlert</span><span class="op" id="4104988">(</span><span class="ident" id="4104989">alertProtocolVersion</span><span class="op" id="4105009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4105013">return</span>&nbsp;<span class="ident" id="4105020">c</span><span class="op" id="4105021">.</span><span class="ident" id="4105022">in</span><span class="op" id="4105024">.</span><span class="ident" id="4105025">setErrorLocked</span><span class="op" id="4105039">(</span><span class="ident" id="4105040">fmt</span><span class="op" id="4105043">.</span><span class="ident" id="4105044">Errorf</span><span class="op" id="4105050">(</span><span class="string" id="4105051">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4105115">,</span>&nbsp;<span class="ident" id="4105117">vers</span><span class="op" id="4105121">,</span>&nbsp;<span class="ident" id="4105123">c</span><span class="op" id="4105124">.</span><span class="ident" id="4105125">vers</span><span class="op" id="4105129">)</span><span class="op" id="4105130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4105133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4105136">if</span>&nbsp;<span class="ident" id="4105139">n</span>&nbsp;<span class="op" id="4105141">&gt;</span>&nbsp;<span class="ident" id="4105143">maxCiphertext</span>&nbsp;<span class="op" id="4105157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4105161">c</span><span class="op" id="4105162">.</span><span class="ident" id="4105163">sendAlert</span><span class="op" id="4105172">(</span><span class="ident" id="4105173">alertRecordOverflow</span><span class="op" id="4105192">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4105196">return</span>&nbsp;<span class="ident" id="4105203">c</span><span class="op" id="4105204">.</span><span class="ident" id="4105205">in</span><span class="op" id="4105207">.</span><span class="ident" id="4105208">setErrorLocked</span><span class="op" id="4105222">(</span><span class="ident" id="4105223">fmt</span><span class="op" id="4105226">.</span><span class="ident" id="4105227">Errorf</span><span class="op" id="4105233">(</span><span class="string" id="4105234">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="4105281">,</span>&nbsp;<span class="ident" id="4105283">n</span><span class="op" id="4105284">)</span><span class="op" id="4105285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4105288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4105291">if</span>&nbsp;<span class="op" id="4105294">!</span><span class="ident" id="4105295">c</span><span class="op" id="4105296">.</span><span class="ident" id="4105297">haveVers</span>&nbsp;<span class="op" id="4105306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4105310">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4105351">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4105388">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4105445">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4105482">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4105538">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4105587">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4105643">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4105672">if</span>&nbsp;<span class="op" id="4105675">(</span><span class="ident" id="4105676">typ</span>&nbsp;<span class="op" id="4105680">!=</span>&nbsp;<span class="ident" id="4105683">recordTypeAlert</span>&nbsp;<span class="op" id="4105699">&amp;&amp;</span>&nbsp;<span class="ident" id="4105702">typ</span>&nbsp;<span class="op" id="4105706">!=</span>&nbsp;<span class="ident" id="4105709">want</span><span class="op" id="4105713">)</span>&nbsp;<span class="op" id="4105715">||</span>&nbsp;<span class="ident" id="4105718">vers</span>&nbsp;<span class="op" id="4105723">&gt;=</span>&nbsp;<span class="num" id="4105726">0x1000</span>&nbsp;<span class="op" id="4105733">||</span>&nbsp;<span class="ident" id="4105736">n</span>&nbsp;<span class="op" id="4105738">&gt;=</span>&nbsp;<span class="num" id="4105741">0x3000</span>&nbsp;<span class="op" id="4105748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4105753">c</span><span class="op" id="4105754">.</span><span class="ident" id="4105755">sendAlert</span><span class="op" id="4105764">(</span><span class="ident" id="4105765">alertUnexpectedMessage</span><span class="op" id="4105787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4105792">return</span>&nbsp;<span class="ident" id="4105799">c</span><span class="op" id="4105800">.</span><span class="ident" id="4105801">in</span><span class="op" id="4105803">.</span><span class="ident" id="4105804">setErrorLocked</span><span class="op" id="4105818">(</span><span class="ident" id="4105819">fmt</span><span class="op" id="4105822">.</span><span class="ident" id="4105823">Errorf</span><span class="op" id="4105829">(</span><span class="string" id="4105830">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="4105884">)</span><span class="op" id="4105885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4105889">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4105892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4105895">if</span>&nbsp;<span class="ident" id="4105898">err</span>&nbsp;<span class="op" id="4105902">:=</span>&nbsp;<span class="ident" id="4105905">b</span><span class="op" id="4105906">.</span><span class="ident" id="4105907">readFromUntil</span><span class="op" id="4105920">(</span><span class="ident" id="4105921">c</span><span class="op" id="4105922">.</span><span class="ident" id="4105923">conn</span><span class="op" id="4105927">,</span>&nbsp;<span class="ident" id="4105929">recordHeaderLen</span><span class="op" id="4105944">+</span><span class="ident" id="4105945">n</span><span class="op" id="4105946">)</span><span class="op" id="4105947">;</span>&nbsp;<span class="ident" id="4105949">err</span>&nbsp;<span class="op" id="4105953">!=</span>&nbsp;<span class="ident" id="4105956">nil</span>&nbsp;<span class="op" id="4105960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4105964">if</span>&nbsp;<span class="ident" id="4105967">err</span>&nbsp;<span class="op" id="4105971">==</span>&nbsp;<span class="ident" id="4105974">io</span><span class="op" id="4105976">.</span><span class="ident" id="4105977">EOF</span>&nbsp;<span class="op" id="4105981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4105986">err</span>&nbsp;<span class="op" id="4105990">=</span>&nbsp;<span class="ident" id="4105992">io</span><span class="op" id="4105994">.</span><span class="ident" id="4105995">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4106014">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106018">if</span>&nbsp;<span class="ident" id="4106021">e</span><span class="op" id="4106022">,</span>&nbsp;<span class="ident" id="4106024">ok</span>&nbsp;<span class="op" id="4106027">:=</span>&nbsp;<span class="ident" id="4106030">err</span><span class="op" id="4106033">.</span><span class="op" id="4106034">(</span><span class="ident" id="4106035">net</span><span class="op" id="4106038">.</span><span class="ident" id="4106039">Error</span><span class="op" id="4106044">)</span><span class="op" id="4106045">;</span>&nbsp;<span class="op" id="4106047">!</span><span class="ident" id="4106048">ok</span>&nbsp;<span class="op" id="4106051">||</span>&nbsp;<span class="op" id="4106054">!</span><span class="ident" id="4106055">e</span><span class="op" id="4106056">.</span><span class="ident" id="4106057">Temporary</span><span class="op" id="4106066">(</span><span class="op" id="4106067">)</span>&nbsp;<span class="op" id="4106069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106074">c</span><span class="op" id="4106075">.</span><span class="ident" id="4106076">in</span><span class="op" id="4106078">.</span><span class="ident" id="4106079">setErrorLocked</span><span class="op" id="4106093">(</span><span class="ident" id="4106094">err</span><span class="op" id="4106097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4106101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106105">return</span>&nbsp;<span class="ident" id="4106112">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4106117">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4106121">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106142">b</span><span class="op" id="4106143">,</span>&nbsp;<span class="ident" id="4106145">c</span><span class="op" id="4106146">.</span><span class="ident" id="4106147">rawInput</span>&nbsp;<span class="op" id="4106156">=</span>&nbsp;<span class="ident" id="4106158">c</span><span class="op" id="4106159">.</span><span class="ident" id="4106160">in</span><span class="op" id="4106162">.</span><span class="ident" id="4106163">splitBlock</span><span class="op" id="4106173">(</span><span class="ident" id="4106174">b</span><span class="op" id="4106175">,</span>&nbsp;<span class="ident" id="4106177">recordHeaderLen</span><span class="op" id="4106192">+</span><span class="ident" id="4106193">n</span><span class="op" id="4106194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106197">ok</span><span class="op" id="4106199">,</span>&nbsp;<span class="ident" id="4106201">off</span><span class="op" id="4106204">,</span>&nbsp;<span class="ident" id="4106206">err</span>&nbsp;<span class="op" id="4106210">:=</span>&nbsp;<span class="ident" id="4106213">c</span><span class="op" id="4106214">.</span><span class="ident" id="4106215">in</span><span class="op" id="4106217">.</span><span class="ident" id="4106218">decrypt</span><span class="op" id="4106225">(</span><span class="ident" id="4106226">b</span><span class="op" id="4106227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106230">if</span>&nbsp;<span class="op" id="4106233">!</span><span class="ident" id="4106234">ok</span>&nbsp;<span class="op" id="4106237">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106241">c</span><span class="op" id="4106242">.</span><span class="ident" id="4106243">in</span><span class="op" id="4106245">.</span><span class="ident" id="4106246">setErrorLocked</span><span class="op" id="4106260">(</span><span class="ident" id="4106261">c</span><span class="op" id="4106262">.</span><span class="ident" id="4106263">sendAlert</span><span class="op" id="4106272">(</span><span class="ident" id="4106273">err</span><span class="op" id="4106276">)</span><span class="op" id="4106277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4106280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106283">b</span><span class="op" id="4106284">.</span><span class="ident" id="4106285">off</span>&nbsp;<span class="op" id="4106289">=</span>&nbsp;<span class="ident" id="4106291">off</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106296">data</span>&nbsp;<span class="op" id="4106301">:=</span>&nbsp;<span class="ident" id="4106304">b</span><span class="op" id="4106305">.</span><span class="ident" id="4106306">data</span><span class="op" id="4106310">[</span><span class="ident" id="4106311">b</span><span class="op" id="4106312">.</span><span class="ident" id="4106313">off</span><span class="op" id="4106316">:</span><span class="op" id="4106317">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106320">if</span>&nbsp;<span class="builtinfunc" id="4106323">len</span><span class="op" id="4106326">(</span><span class="ident" id="4106327">data</span><span class="op" id="4106331">)</span>&nbsp;<span class="op" id="4106333">&gt;</span>&nbsp;<span class="ident" id="4106335">maxPlaintext</span>&nbsp;<span class="op" id="4106348">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106352">err</span>&nbsp;<span class="op" id="4106356">:=</span>&nbsp;<span class="ident" id="4106359">c</span><span class="op" id="4106360">.</span><span class="ident" id="4106361">sendAlert</span><span class="op" id="4106370">(</span><span class="ident" id="4106371">alertRecordOverflow</span><span class="op" id="4106390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106394">c</span><span class="op" id="4106395">.</span><span class="ident" id="4106396">in</span><span class="op" id="4106398">.</span><span class="ident" id="4106399">freeBlock</span><span class="op" id="4106408">(</span><span class="ident" id="4106409">b</span><span class="op" id="4106410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106414">return</span>&nbsp;<span class="ident" id="4106421">c</span><span class="op" id="4106422">.</span><span class="ident" id="4106423">in</span><span class="op" id="4106425">.</span><span class="ident" id="4106426">setErrorLocked</span><span class="op" id="4106440">(</span><span class="ident" id="4106441">err</span><span class="op" id="4106444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4106447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106451">switch</span>&nbsp;<span class="ident" id="4106458">typ</span>&nbsp;<span class="op" id="4106462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106465">default</span><span class="op" id="4106472">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106476">c</span><span class="op" id="4106477">.</span><span class="ident" id="4106478">in</span><span class="op" id="4106480">.</span><span class="ident" id="4106481">setErrorLocked</span><span class="op" id="4106495">(</span><span class="ident" id="4106496">c</span><span class="op" id="4106497">.</span><span class="ident" id="4106498">sendAlert</span><span class="op" id="4106507">(</span><span class="ident" id="4106508">alertUnexpectedMessage</span><span class="op" id="4106530">)</span><span class="op" id="4106531">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106535">case</span>&nbsp;<span class="ident" id="4106540">recordTypeAlert</span><span class="op" id="4106555">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106559">if</span>&nbsp;<span class="builtinfunc" id="4106562">len</span><span class="op" id="4106565">(</span><span class="ident" id="4106566">data</span><span class="op" id="4106570">)</span>&nbsp;<span class="op" id="4106572">!=</span>&nbsp;<span class="num" id="4106575">2</span>&nbsp;<span class="op" id="4106577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106582">c</span><span class="op" id="4106583">.</span><span class="ident" id="4106584">in</span><span class="op" id="4106586">.</span><span class="ident" id="4106587">setErrorLocked</span><span class="op" id="4106601">(</span><span class="ident" id="4106602">c</span><span class="op" id="4106603">.</span><span class="ident" id="4106604">sendAlert</span><span class="op" id="4106613">(</span><span class="ident" id="4106614">alertUnexpectedMessage</span><span class="op" id="4106636">)</span><span class="op" id="4106637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106642">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4106650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106654">if</span>&nbsp;<span class="ident" id="4106657">alert</span><span class="op" id="4106662">(</span><span class="ident" id="4106663">data</span><span class="op" id="4106667">[</span><span class="num" id="4106668">1</span><span class="op" id="4106669">]</span><span class="op" id="4106670">)</span>&nbsp;<span class="op" id="4106672">==</span>&nbsp;<span class="ident" id="4106675">alertCloseNotify</span>&nbsp;<span class="op" id="4106692">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106697">c</span><span class="op" id="4106698">.</span><span class="ident" id="4106699">in</span><span class="op" id="4106701">.</span><span class="ident" id="4106702">setErrorLocked</span><span class="op" id="4106716">(</span><span class="ident" id="4106717">io</span><span class="op" id="4106719">.</span><span class="ident" id="4106720">EOF</span><span class="op" id="4106723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106728">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4106736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106740">switch</span>&nbsp;<span class="ident" id="4106747">data</span><span class="op" id="4106751">[</span><span class="num" id="4106752">0</span><span class="op" id="4106753">]</span>&nbsp;<span class="op" id="4106755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106759">case</span>&nbsp;<span class="ident" id="4106764">alertLevelWarning</span><span class="op" id="4106781">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4106786">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106810">c</span><span class="op" id="4106811">.</span><span class="ident" id="4106812">in</span><span class="op" id="4106814">.</span><span class="ident" id="4106815">freeBlock</span><span class="op" id="4106824">(</span><span class="ident" id="4106825">b</span><span class="op" id="4106826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106831">goto</span>&nbsp;<span class="ident" id="4106836">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106844">case</span>&nbsp;<span class="ident" id="4106849">alertLevelError</span><span class="op" id="4106864">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106869">c</span><span class="op" id="4106870">.</span><span class="ident" id="4106871">in</span><span class="op" id="4106873">.</span><span class="ident" id="4106874">setErrorLocked</span><span class="op" id="4106888">(</span><span class="op" id="4106889">&amp;</span><span class="ident" id="4106890">net</span><span class="op" id="4106893">.</span><span class="ident" id="4106894">OpError</span><span class="op" id="4106901">{</span><span class="ident" id="4106902">Op</span><span class="op" id="4106904">:</span>&nbsp;<span class="string" id="4106906">&#34;remote&nbsp;error&#34;</span><span class="op" id="4106920">,</span>&nbsp;<span class="ident" id="4106922">Err</span><span class="op" id="4106925">:</span>&nbsp;<span class="ident" id="4106927">alert</span><span class="op" id="4106932">(</span><span class="ident" id="4106933">data</span><span class="op" id="4106937">[</span><span class="num" id="4106938">1</span><span class="op" id="4106939">]</span><span class="op" id="4106940">)</span><span class="op" id="4106941">}</span><span class="op" id="4106942">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106946">default</span><span class="op" id="4106953">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106958">c</span><span class="op" id="4106959">.</span><span class="ident" id="4106960">in</span><span class="op" id="4106962">.</span><span class="ident" id="4106963">setErrorLocked</span><span class="op" id="4106977">(</span><span class="ident" id="4106978">c</span><span class="op" id="4106979">.</span><span class="ident" id="4106980">sendAlert</span><span class="op" id="4106989">(</span><span class="ident" id="4106990">alertUnexpectedMessage</span><span class="op" id="4107012">)</span><span class="op" id="4107013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4107017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107021">case</span>&nbsp;<span class="ident" id="4107026">recordTypeChangeCipherSpec</span><span class="op" id="4107052">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107056">if</span>&nbsp;<span class="ident" id="4107059">typ</span>&nbsp;<span class="op" id="4107063">!=</span>&nbsp;<span class="ident" id="4107066">want</span>&nbsp;<span class="op" id="4107071">||</span>&nbsp;<span class="builtinfunc" id="4107074">len</span><span class="op" id="4107077">(</span><span class="ident" id="4107078">data</span><span class="op" id="4107082">)</span>&nbsp;<span class="op" id="4107084">!=</span>&nbsp;<span class="num" id="4107087">1</span>&nbsp;<span class="op" id="4107089">||</span>&nbsp;<span class="ident" id="4107092">data</span><span class="op" id="4107096">[</span><span class="num" id="4107097">0</span><span class="op" id="4107098">]</span>&nbsp;<span class="op" id="4107100">!=</span>&nbsp;<span class="num" id="4107103">1</span>&nbsp;<span class="op" id="4107105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107110">c</span><span class="op" id="4107111">.</span><span class="ident" id="4107112">in</span><span class="op" id="4107114">.</span><span class="ident" id="4107115">setErrorLocked</span><span class="op" id="4107129">(</span><span class="ident" id="4107130">c</span><span class="op" id="4107131">.</span><span class="ident" id="4107132">sendAlert</span><span class="op" id="4107141">(</span><span class="ident" id="4107142">alertUnexpectedMessage</span><span class="op" id="4107164">)</span><span class="op" id="4107165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107170">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4107178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107182">err</span>&nbsp;<span class="op" id="4107186">:=</span>&nbsp;<span class="ident" id="4107189">c</span><span class="op" id="4107190">.</span><span class="ident" id="4107191">in</span><span class="op" id="4107193">.</span><span class="ident" id="4107194">changeCipherSpec</span><span class="op" id="4107210">(</span><span class="op" id="4107211">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107215">if</span>&nbsp;<span class="ident" id="4107218">err</span>&nbsp;<span class="op" id="4107222">!=</span>&nbsp;<span class="ident" id="4107225">nil</span>&nbsp;<span class="op" id="4107229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107234">c</span><span class="op" id="4107235">.</span><span class="ident" id="4107236">in</span><span class="op" id="4107238">.</span><span class="ident" id="4107239">setErrorLocked</span><span class="op" id="4107253">(</span><span class="ident" id="4107254">c</span><span class="op" id="4107255">.</span><span class="ident" id="4107256">sendAlert</span><span class="op" id="4107265">(</span><span class="ident" id="4107266">err</span><span class="op" id="4107269">.</span><span class="op" id="4107270">(</span><span class="ident" id="4107271">alert</span><span class="op" id="4107276">)</span><span class="op" id="4107277">)</span><span class="op" id="4107278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4107282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107286">case</span>&nbsp;<span class="ident" id="4107291">recordTypeApplicationData</span><span class="op" id="4107316">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107320">if</span>&nbsp;<span class="ident" id="4107323">typ</span>&nbsp;<span class="op" id="4107327">!=</span>&nbsp;<span class="ident" id="4107330">want</span>&nbsp;<span class="op" id="4107335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107340">c</span><span class="op" id="4107341">.</span><span class="ident" id="4107342">in</span><span class="op" id="4107344">.</span><span class="ident" id="4107345">setErrorLocked</span><span class="op" id="4107359">(</span><span class="ident" id="4107360">c</span><span class="op" id="4107361">.</span><span class="ident" id="4107362">sendAlert</span><span class="op" id="4107371">(</span><span class="ident" id="4107372">alertUnexpectedMessage</span><span class="op" id="4107394">)</span><span class="op" id="4107395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107400">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4107408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107412">c</span><span class="op" id="4107413">.</span><span class="ident" id="4107414">input</span>&nbsp;<span class="op" id="4107420">=</span>&nbsp;<span class="ident" id="4107422">b</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107426">b</span>&nbsp;<span class="op" id="4107428">=</span>&nbsp;<span class="ident" id="4107430">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107436">case</span>&nbsp;<span class="ident" id="4107441">recordTypeHandshake</span><span class="op" id="4107460">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4107464">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107523">if</span>&nbsp;<span class="ident" id="4107526">typ</span>&nbsp;<span class="op" id="4107530">!=</span>&nbsp;<span class="ident" id="4107533">want</span>&nbsp;<span class="op" id="4107538">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107543">return</span>&nbsp;<span class="ident" id="4107550">c</span><span class="op" id="4107551">.</span><span class="ident" id="4107552">in</span><span class="op" id="4107554">.</span><span class="ident" id="4107555">setErrorLocked</span><span class="op" id="4107569">(</span><span class="ident" id="4107570">c</span><span class="op" id="4107571">.</span><span class="ident" id="4107572">sendAlert</span><span class="op" id="4107581">(</span><span class="ident" id="4107582">alertNoRenegotiation</span><span class="op" id="4107602">)</span><span class="op" id="4107603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4107607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107611">c</span><span class="op" id="4107612">.</span><span class="ident" id="4107613">hand</span><span class="op" id="4107617">.</span><span class="ident" id="4107618">Write</span><span class="op" id="4107623">(</span><span class="ident" id="4107624">data</span><span class="op" id="4107628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4107631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107635">if</span>&nbsp;<span class="ident" id="4107638">b</span>&nbsp;<span class="op" id="4107640">!=</span>&nbsp;<span class="ident" id="4107643">nil</span>&nbsp;<span class="op" id="4107647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107651">c</span><span class="op" id="4107652">.</span><span class="ident" id="4107653">in</span><span class="op" id="4107655">.</span><span class="ident" id="4107656">freeBlock</span><span class="op" id="4107665">(</span><span class="ident" id="4107666">b</span><span class="op" id="4107667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4107670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107673">return</span>&nbsp;<span class="ident" id="4107680">c</span><span class="op" id="4107681">.</span><span class="ident" id="4107682">in</span><span class="op" id="4107684">.</span><span class="ident" id="4107685">err</span><br>
<span class="lineno"></span><span class="op" id="4107689">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="4107692">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="4107732">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4107753">func</span>&nbsp;<span class="op" id="4107758">(</span><span class="ident" id="4107759">c</span>&nbsp;<span class="op" id="4107761">*</span><span class="ident" id="4107762">Conn</span><span class="op" id="4107766">)</span>&nbsp;<span class="ident" id="4107768">sendAlertLocked</span><span class="op" id="4107783">(</span><span class="ident" id="4107784">err</span>&nbsp;<span class="ident" id="4107788">alert</span><span class="op" id="4107793">)</span>&nbsp;<span class="builtintype" id="4107795">error</span>&nbsp;<span class="op" id="4107801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107804">switch</span>&nbsp;<span class="ident" id="4107811">err</span>&nbsp;<span class="op" id="4107815">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107818">case</span>&nbsp;<span class="ident" id="4107823">alertNoRenegotiation</span><span class="op" id="4107843">,</span>&nbsp;<span class="ident" id="4107845">alertCloseNotify</span><span class="op" id="4107861">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107865">c</span><span class="op" id="4107866">.</span><span class="ident" id="4107867">tmp</span><span class="op" id="4107870">[</span><span class="num" id="4107871">0</span><span class="op" id="4107872">]</span>&nbsp;<span class="op" id="4107874">=</span>&nbsp;<span class="ident" id="4107876">alertLevelWarning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107895">default</span><span class="op" id="4107902">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107906">c</span><span class="op" id="4107907">.</span><span class="ident" id="4107908">tmp</span><span class="op" id="4107911">[</span><span class="num" id="4107912">0</span><span class="op" id="4107913">]</span>&nbsp;<span class="op" id="4107915">=</span>&nbsp;<span class="ident" id="4107917">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4107934">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107937">c</span><span class="op" id="4107938">.</span><span class="ident" id="4107939">tmp</span><span class="op" id="4107942">[</span><span class="num" id="4107943">1</span><span class="op" id="4107944">]</span>&nbsp;<span class="op" id="4107946">=</span>&nbsp;<span class="builtintype" id="4107948">byte</span><span class="op" id="4107952">(</span><span class="ident" id="4107953">err</span><span class="op" id="4107956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107959">c</span><span class="op" id="4107960">.</span><span class="ident" id="4107961">writeRecord</span><span class="op" id="4107972">(</span><span class="ident" id="4107973">recordTypeAlert</span><span class="op" id="4107988">,</span>&nbsp;<span class="ident" id="4107990">c</span><span class="op" id="4107991">.</span><span class="ident" id="4107992">tmp</span><span class="op" id="4107995">[</span><span class="num" id="4107996">0</span><span class="op" id="4107997">:</span><span class="num" id="4107998">2</span><span class="op" id="4107999">]</span><span class="op" id="4108000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4108003">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108064">if</span>&nbsp;<span class="ident" id="4108067">err</span>&nbsp;<span class="op" id="4108071">!=</span>&nbsp;<span class="ident" id="4108074">alertCloseNotify</span>&nbsp;<span class="op" id="4108091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108095">return</span>&nbsp;<span class="ident" id="4108102">c</span><span class="op" id="4108103">.</span><span class="ident" id="4108104">out</span><span class="op" id="4108107">.</span><span class="ident" id="4108108">setErrorLocked</span><span class="op" id="4108122">(</span><span class="op" id="4108123">&amp;</span><span class="ident" id="4108124">net</span><span class="op" id="4108127">.</span><span class="ident" id="4108128">OpError</span><span class="op" id="4108135">{</span><span class="ident" id="4108136">Op</span><span class="op" id="4108138">:</span>&nbsp;<span class="string" id="4108140">&#34;local&nbsp;error&#34;</span><span class="op" id="4108153">,</span>&nbsp;<span class="ident" id="4108155">Err</span><span class="op" id="4108158">:</span>&nbsp;<span class="ident" id="4108160">err</span><span class="op" id="4108163">}</span><span class="op" id="4108164">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4108167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108170">return</span>&nbsp;<span class="ident" id="4108177">nil</span><br>
<span class="lineno"></span><span class="op" id="4108181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4108184">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="4108224">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="4108244">func</span>&nbsp;<span class="op" id="4108249">(</span><span class="ident" id="4108250">c</span>&nbsp;<span class="op" id="4108252">*</span><span class="ident" id="4108253">Conn</span><span class="op" id="4108257">)</span>&nbsp;<span class="ident" id="4108259">sendAlert</span><span class="op" id="4108268">(</span><span class="ident" id="4108269">err</span>&nbsp;<span class="ident" id="4108273">alert</span><span class="op" id="4108278">)</span>&nbsp;<span class="builtintype" id="4108280">error</span>&nbsp;<span class="op" id="4108286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4108289">c</span><span class="op" id="4108290">.</span><span class="ident" id="4108291">out</span><span class="op" id="4108294">.</span><span class="ident" id="4108295">Lock</span><span class="op" id="4108299">(</span><span class="op" id="4108300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108303">defer</span>&nbsp;<span class="ident" id="4108309">c</span><span class="op" id="4108310">.</span><span class="ident" id="4108311">out</span><span class="op" id="4108314">.</span><span class="ident" id="4108315">Unlock</span><span class="op" id="4108321">(</span><span class="op" id="4108322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108325">return</span>&nbsp;<span class="ident" id="4108332">c</span><span class="op" id="4108333">.</span><span class="ident" id="4108334">sendAlertLocked</span><span class="op" id="4108349">(</span><span class="ident" id="4108350">err</span><span class="op" id="4108353">)</span><br>
<span class="lineno">690</span><span class="op" id="4108355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4108358">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="4108425">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4108482">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="4108503">func</span>&nbsp;<span class="op" id="4108508">(</span><span class="ident" id="4108509">c</span>&nbsp;<span class="op" id="4108511">*</span><span class="ident" id="4108512">Conn</span><span class="op" id="4108516">)</span>&nbsp;<span class="ident" id="4108518">writeRecord</span><span class="op" id="4108529">(</span><span class="ident" id="4108530">typ</span>&nbsp;<span class="ident" id="4108534">recordType</span><span class="op" id="4108544">,</span>&nbsp;<span class="ident" id="4108546">data</span>&nbsp;<span class="op" id="4108551">[</span><span class="op" id="4108552">]</span><span class="builtintype" id="4108553">byte</span><span class="op" id="4108557">)</span>&nbsp;<span class="op" id="4108559">(</span><span class="ident" id="4108560">n</span>&nbsp;<span class="builtintype" id="4108562">int</span><span class="op" id="4108565">,</span>&nbsp;<span class="ident" id="4108567">err</span>&nbsp;<span class="builtintype" id="4108571">error</span><span class="op" id="4108576">)</span>&nbsp;<span class="op" id="4108578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4108581">b</span>&nbsp;<span class="op" id="4108583">:=</span>&nbsp;<span class="ident" id="4108586">c</span><span class="op" id="4108587">.</span><span class="ident" id="4108588">out</span><span class="op" id="4108591">.</span><span class="ident" id="4108592">newBlock</span><span class="op" id="4108600">(</span><span class="op" id="4108601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108604">for</span>&nbsp;<span class="builtinfunc" id="4108608">len</span><span class="op" id="4108611">(</span><span class="ident" id="4108612">data</span><span class="op" id="4108616">)</span>&nbsp;<span class="op" id="4108618">&gt;</span>&nbsp;<span class="num" id="4108620">0</span>&nbsp;<span class="op" id="4108622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4108626">m</span>&nbsp;<span class="op" id="4108628">:=</span>&nbsp;<span class="builtinfunc" id="4108631">len</span><span class="op" id="4108634">(</span><span class="ident" id="4108635">data</span><span class="op" id="4108639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108643">if</span>&nbsp;<span class="ident" id="4108646">m</span>&nbsp;<span class="op" id="4108648">&gt;</span>&nbsp;<span class="ident" id="4108650">maxPlaintext</span>&nbsp;<span class="op" id="4108663">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4108668">m</span>&nbsp;<span class="op" id="4108670">=</span>&nbsp;<span class="ident" id="4108672">maxPlaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4108687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4108691">explicitIVLen</span>&nbsp;<span class="op" id="4108705">:=</span>&nbsp;<span class="num" id="4108708">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4108712">explicitIVIsSeq</span>&nbsp;<span class="op" id="4108728">:=</span>&nbsp;<span class="builtintype" id="4108731">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108740">var</span>&nbsp;<span class="ident" id="4108744">cbc</span>&nbsp;<span class="ident" id="4108748">cbcMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108758">if</span>&nbsp;<span class="ident" id="4108761">c</span><span class="op" id="4108762">.</span><span class="ident" id="4108763">out</span><span class="op" id="4108766">.</span><span class="ident" id="4108767">version</span>&nbsp;<span class="op" id="4108775">&gt;=</span>&nbsp;<span class="ident" id="4108778">VersionTLS11</span>&nbsp;<span class="op" id="4108791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108796">var</span>&nbsp;<span class="ident" id="4108800">ok</span>&nbsp;<span class="builtintype" id="4108803">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108811">if</span>&nbsp;<span class="ident" id="4108814">cbc</span><span class="op" id="4108817">,</span>&nbsp;<span class="ident" id="4108819">ok</span>&nbsp;<span class="op" id="4108822">=</span>&nbsp;<span class="ident" id="4108824">c</span><span class="op" id="4108825">.</span><span class="ident" id="4108826">out</span><span class="op" id="4108829">.</span><span class="ident" id="4108830">cipher</span><span class="op" id="4108836">.</span><span class="op" id="4108837">(</span><span class="ident" id="4108838">cbcMode</span><span class="op" id="4108845">)</span><span class="op" id="4108846">;</span>&nbsp;<span class="ident" id="4108848">ok</span>&nbsp;<span class="op" id="4108851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4108857">explicitIVLen</span>&nbsp;<span class="op" id="4108871">=</span>&nbsp;<span class="ident" id="4108873">cbc</span><span class="op" id="4108876">.</span><span class="ident" id="4108877">BlockSize</span><span class="op" id="4108886">(</span><span class="op" id="4108887">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4108892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4108896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108900">if</span>&nbsp;<span class="ident" id="4108903">explicitIVLen</span>&nbsp;<span class="op" id="4108917">==</span>&nbsp;<span class="num" id="4108920">0</span>&nbsp;<span class="op" id="4108922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108927">if</span>&nbsp;<span class="ident" id="4108930">_</span><span class="op" id="4108931">,</span>&nbsp;<span class="ident" id="4108933">ok</span>&nbsp;<span class="op" id="4108936">:=</span>&nbsp;<span class="ident" id="4108939">c</span><span class="op" id="4108940">.</span><span class="ident" id="4108941">out</span><span class="op" id="4108944">.</span><span class="ident" id="4108945">cipher</span><span class="op" id="4108951">.</span><span class="op" id="4108952">(</span><span class="ident" id="4108953">cipher</span><span class="op" id="4108959">.</span><span class="ident" id="4108960">AEAD</span><span class="op" id="4108964">)</span><span class="op" id="4108965">;</span>&nbsp;<span class="ident" id="4108967">ok</span>&nbsp;<span class="op" id="4108970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4108976">explicitIVLen</span>&nbsp;<span class="op" id="4108990">=</span>&nbsp;<span class="num" id="4108992">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4108998">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4109044">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4109091">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4109141">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4109188">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4109239">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109260">explicitIVIsSeq</span>&nbsp;<span class="op" id="4109276">=</span>&nbsp;<span class="builtintype" id="4109278">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109294">b</span><span class="op" id="4109295">.</span><span class="ident" id="4109296">resize</span><span class="op" id="4109302">(</span><span class="ident" id="4109303">recordHeaderLen</span>&nbsp;<span class="op" id="4109319">+</span>&nbsp;<span class="ident" id="4109321">explicitIVLen</span>&nbsp;<span class="op" id="4109335">+</span>&nbsp;<span class="ident" id="4109337">m</span><span class="op" id="4109338">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109342">b</span><span class="op" id="4109343">.</span><span class="ident" id="4109344">data</span><span class="op" id="4109348">[</span><span class="num" id="4109349">0</span><span class="op" id="4109350">]</span>&nbsp;<span class="op" id="4109352">=</span>&nbsp;<span class="builtintype" id="4109354">byte</span><span class="op" id="4109358">(</span><span class="ident" id="4109359">typ</span><span class="op" id="4109362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109366">vers</span>&nbsp;<span class="op" id="4109371">:=</span>&nbsp;<span class="ident" id="4109374">c</span><span class="op" id="4109375">.</span><span class="ident" id="4109376">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109383">if</span>&nbsp;<span class="ident" id="4109386">vers</span>&nbsp;<span class="op" id="4109391">==</span>&nbsp;<span class="num" id="4109394">0</span>&nbsp;<span class="op" id="4109396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4109401">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4109454">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109510">vers</span>&nbsp;<span class="op" id="4109515">=</span>&nbsp;<span class="ident" id="4109517">VersionTLS10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109536">b</span><span class="op" id="4109537">.</span><span class="ident" id="4109538">data</span><span class="op" id="4109542">[</span><span class="num" id="4109543">1</span><span class="op" id="4109544">]</span>&nbsp;<span class="op" id="4109546">=</span>&nbsp;<span class="builtintype" id="4109548">byte</span><span class="op" id="4109552">(</span><span class="ident" id="4109553">vers</span>&nbsp;<span class="op" id="4109558">&gt;&gt;</span>&nbsp;<span class="num" id="4109561">8</span><span class="op" id="4109562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109566">b</span><span class="op" id="4109567">.</span><span class="ident" id="4109568">data</span><span class="op" id="4109572">[</span><span class="num" id="4109573">2</span><span class="op" id="4109574">]</span>&nbsp;<span class="op" id="4109576">=</span>&nbsp;<span class="builtintype" id="4109578">byte</span><span class="op" id="4109582">(</span><span class="ident" id="4109583">vers</span><span class="op" id="4109587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109591">b</span><span class="op" id="4109592">.</span><span class="ident" id="4109593">data</span><span class="op" id="4109597">[</span><span class="num" id="4109598">3</span><span class="op" id="4109599">]</span>&nbsp;<span class="op" id="4109601">=</span>&nbsp;<span class="builtintype" id="4109603">byte</span><span class="op" id="4109607">(</span><span class="ident" id="4109608">m</span>&nbsp;<span class="op" id="4109610">&gt;&gt;</span>&nbsp;<span class="num" id="4109613">8</span><span class="op" id="4109614">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109618">b</span><span class="op" id="4109619">.</span><span class="ident" id="4109620">data</span><span class="op" id="4109624">[</span><span class="num" id="4109625">4</span><span class="op" id="4109626">]</span>&nbsp;<span class="op" id="4109628">=</span>&nbsp;<span class="builtintype" id="4109630">byte</span><span class="op" id="4109634">(</span><span class="ident" id="4109635">m</span><span class="op" id="4109636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109640">if</span>&nbsp;<span class="ident" id="4109643">explicitIVLen</span>&nbsp;<span class="op" id="4109657">&gt;</span>&nbsp;<span class="num" id="4109659">0</span>&nbsp;<span class="op" id="4109661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109666">explicitIV</span>&nbsp;<span class="op" id="4109677">:=</span>&nbsp;<span class="ident" id="4109680">b</span><span class="op" id="4109681">.</span><span class="ident" id="4109682">data</span><span class="op" id="4109686">[</span><span class="ident" id="4109687">recordHeaderLen</span>&nbsp;<span class="op" id="4109703">:</span>&nbsp;<span class="ident" id="4109705">recordHeaderLen</span><span class="op" id="4109720">+</span><span class="ident" id="4109721">explicitIVLen</span><span class="op" id="4109734">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109739">if</span>&nbsp;<span class="ident" id="4109742">explicitIVIsSeq</span>&nbsp;<span class="op" id="4109758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4109764">copy</span><span class="op" id="4109768">(</span><span class="ident" id="4109769">explicitIV</span><span class="op" id="4109779">,</span>&nbsp;<span class="ident" id="4109781">c</span><span class="op" id="4109782">.</span><span class="ident" id="4109783">out</span><span class="op" id="4109786">.</span><span class="ident" id="4109787">seq</span><span class="op" id="4109790">[</span><span class="op" id="4109791">:</span><span class="op" id="4109792">]</span><span class="op" id="4109793">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109798">}</span>&nbsp;<span class="keyword" id="4109800">else</span>&nbsp;<span class="op" id="4109805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109811">if</span>&nbsp;<span class="ident" id="4109814">_</span><span class="op" id="4109815">,</span>&nbsp;<span class="ident" id="4109817">err</span>&nbsp;<span class="op" id="4109821">=</span>&nbsp;<span class="ident" id="4109823">io</span><span class="op" id="4109825">.</span><span class="ident" id="4109826">ReadFull</span><span class="op" id="4109834">(</span><span class="ident" id="4109835">c</span><span class="op" id="4109836">.</span><span class="ident" id="4109837">config</span><span class="op" id="4109843">.</span><span class="ident" id="4109844">rand</span><span class="op" id="4109848">(</span><span class="op" id="4109849">)</span><span class="op" id="4109850">,</span>&nbsp;<span class="ident" id="4109852">explicitIV</span><span class="op" id="4109862">)</span><span class="op" id="4109863">;</span>&nbsp;<span class="ident" id="4109865">err</span>&nbsp;<span class="op" id="4109869">!=</span>&nbsp;<span class="ident" id="4109872">nil</span>&nbsp;<span class="op" id="4109876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109883">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109898">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4109906">copy</span><span class="op" id="4109910">(</span><span class="ident" id="4109911">b</span><span class="op" id="4109912">.</span><span class="ident" id="4109913">data</span><span class="op" id="4109917">[</span><span class="ident" id="4109918">recordHeaderLen</span><span class="op" id="4109933">+</span><span class="ident" id="4109934">explicitIVLen</span><span class="op" id="4109947">:</span><span class="op" id="4109948">]</span><span class="op" id="4109949">,</span>&nbsp;<span class="ident" id="4109951">data</span><span class="op" id="4109955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109959">c</span><span class="op" id="4109960">.</span><span class="ident" id="4109961">out</span><span class="op" id="4109964">.</span><span class="ident" id="4109965">encrypt</span><span class="op" id="4109972">(</span><span class="ident" id="4109973">b</span><span class="op" id="4109974">,</span>&nbsp;<span class="ident" id="4109976">explicitIVLen</span><span class="op" id="4109989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109993">_</span><span class="op" id="4109994">,</span>&nbsp;<span class="ident" id="4109996">err</span>&nbsp;<span class="op" id="4110000">=</span>&nbsp;<span class="ident" id="4110002">c</span><span class="op" id="4110003">.</span><span class="ident" id="4110004">conn</span><span class="op" id="4110008">.</span><span class="ident" id="4110009">Write</span><span class="op" id="4110014">(</span><span class="ident" id="4110015">b</span><span class="op" id="4110016">.</span><span class="ident" id="4110017">data</span><span class="op" id="4110021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110025">if</span>&nbsp;<span class="ident" id="4110028">err</span>&nbsp;<span class="op" id="4110032">!=</span>&nbsp;<span class="ident" id="4110035">nil</span>&nbsp;<span class="op" id="4110039">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110044">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4110052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110056">n</span>&nbsp;<span class="op" id="4110058">+=</span>&nbsp;<span class="ident" id="4110061">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110065">data</span>&nbsp;<span class="op" id="4110070">=</span>&nbsp;<span class="ident" id="4110072">data</span><span class="op" id="4110076">[</span><span class="ident" id="4110077">m</span><span class="op" id="4110078">:</span><span class="op" id="4110079">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4110082">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110085">c</span><span class="op" id="4110086">.</span><span class="ident" id="4110087">out</span><span class="op" id="4110090">.</span><span class="ident" id="4110091">freeBlock</span><span class="op" id="4110100">(</span><span class="ident" id="4110101">b</span><span class="op" id="4110102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110106">if</span>&nbsp;<span class="ident" id="4110109">typ</span>&nbsp;<span class="op" id="4110113">==</span>&nbsp;<span class="ident" id="4110116">recordTypeChangeCipherSpec</span>&nbsp;<span class="op" id="4110143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110147">err</span>&nbsp;<span class="op" id="4110151">=</span>&nbsp;<span class="ident" id="4110153">c</span><span class="op" id="4110154">.</span><span class="ident" id="4110155">out</span><span class="op" id="4110158">.</span><span class="ident" id="4110159">changeCipherSpec</span><span class="op" id="4110175">(</span><span class="op" id="4110176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110180">if</span>&nbsp;<span class="ident" id="4110183">err</span>&nbsp;<span class="op" id="4110187">!=</span>&nbsp;<span class="ident" id="4110190">nil</span>&nbsp;<span class="op" id="4110194">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4110199">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4110237">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110280">c</span><span class="op" id="4110281">.</span><span class="ident" id="4110282">tmp</span><span class="op" id="4110285">[</span><span class="num" id="4110286">0</span><span class="op" id="4110287">]</span>&nbsp;<span class="op" id="4110289">=</span>&nbsp;<span class="ident" id="4110291">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110310">c</span><span class="op" id="4110311">.</span><span class="ident" id="4110312">tmp</span><span class="op" id="4110315">[</span><span class="num" id="4110316">1</span><span class="op" id="4110317">]</span>&nbsp;<span class="op" id="4110319">=</span>&nbsp;<span class="builtintype" id="4110321">byte</span><span class="op" id="4110325">(</span><span class="ident" id="4110326">err</span><span class="op" id="4110329">.</span><span class="op" id="4110330">(</span><span class="ident" id="4110331">alert</span><span class="op" id="4110336">)</span><span class="op" id="4110337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110342">c</span><span class="op" id="4110343">.</span><span class="ident" id="4110344">writeRecord</span><span class="op" id="4110355">(</span><span class="ident" id="4110356">recordTypeAlert</span><span class="op" id="4110371">,</span>&nbsp;<span class="ident" id="4110373">c</span><span class="op" id="4110374">.</span><span class="ident" id="4110375">tmp</span><span class="op" id="4110378">[</span><span class="num" id="4110379">0</span><span class="op" id="4110380">:</span><span class="num" id="4110381">2</span><span class="op" id="4110382">]</span><span class="op" id="4110383">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110388">return</span>&nbsp;<span class="ident" id="4110395">n</span><span class="op" id="4110396">,</span>&nbsp;<span class="ident" id="4110398">c</span><span class="op" id="4110399">.</span><span class="ident" id="4110400">out</span><span class="op" id="4110403">.</span><span class="ident" id="4110404">setErrorLocked</span><span class="op" id="4110418">(</span><span class="op" id="4110419">&amp;</span><span class="ident" id="4110420">net</span><span class="op" id="4110423">.</span><span class="ident" id="4110424">OpError</span><span class="op" id="4110431">{</span><span class="ident" id="4110432">Op</span><span class="op" id="4110434">:</span>&nbsp;<span class="string" id="4110436">&#34;local&nbsp;error&#34;</span><span class="op" id="4110449">,</span>&nbsp;<span class="ident" id="4110451">Err</span><span class="op" id="4110454">:</span>&nbsp;<span class="ident" id="4110456">err</span><span class="op" id="4110459">}</span><span class="op" id="4110460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4110464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4110467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110470">return</span><br>
<span class="lineno"></span><span class="op" id="4110477">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="4110480">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4110535">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="4110556">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4110592">func</span>&nbsp;<span class="op" id="4110597">(</span><span class="ident" id="4110598">c</span>&nbsp;<span class="op" id="4110600">*</span><span class="ident" id="4110601">Conn</span><span class="op" id="4110605">)</span>&nbsp;<span class="ident" id="4110607">readHandshake</span><span class="op" id="4110620">(</span><span class="op" id="4110621">)</span>&nbsp;<span class="op" id="4110623">(</span><span class="keyword" id="4110624">interface</span><span class="op" id="4110633">{</span><span class="op" id="4110634">}</span><span class="op" id="4110635">,</span>&nbsp;<span class="builtintype" id="4110637">error</span><span class="op" id="4110642">)</span>&nbsp;<span class="op" id="4110644">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110647">for</span>&nbsp;<span class="ident" id="4110651">c</span><span class="op" id="4110652">.</span><span class="ident" id="4110653">hand</span><span class="op" id="4110657">.</span><span class="ident" id="4110658">Len</span><span class="op" id="4110661">(</span><span class="op" id="4110662">)</span>&nbsp;<span class="op" id="4110664">&lt;</span>&nbsp;<span class="num" id="4110666">4</span>&nbsp;<span class="op" id="4110668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110672">if</span>&nbsp;<span class="ident" id="4110675">err</span>&nbsp;<span class="op" id="4110679">:=</span>&nbsp;<span class="ident" id="4110682">c</span><span class="op" id="4110683">.</span><span class="ident" id="4110684">in</span><span class="op" id="4110686">.</span><span class="ident" id="4110687">err</span><span class="op" id="4110690">;</span>&nbsp;<span class="ident" id="4110692">err</span>&nbsp;<span class="op" id="4110696">!=</span>&nbsp;<span class="ident" id="4110699">nil</span>&nbsp;<span class="op" id="4110703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110708">return</span>&nbsp;<span class="ident" id="4110715">nil</span><span class="op" id="4110718">,</span>&nbsp;<span class="ident" id="4110720">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4110726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110730">if</span>&nbsp;<span class="ident" id="4110733">err</span>&nbsp;<span class="op" id="4110737">:=</span>&nbsp;<span class="ident" id="4110740">c</span><span class="op" id="4110741">.</span><span class="ident" id="4110742">readRecord</span><span class="op" id="4110752">(</span><span class="ident" id="4110753">recordTypeHandshake</span><span class="op" id="4110772">)</span><span class="op" id="4110773">;</span>&nbsp;<span class="ident" id="4110775">err</span>&nbsp;<span class="op" id="4110779">!=</span>&nbsp;<span class="ident" id="4110782">nil</span>&nbsp;<span class="op" id="4110786">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110791">return</span>&nbsp;<span class="ident" id="4110798">nil</span><span class="op" id="4110801">,</span>&nbsp;<span class="ident" id="4110803">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4110809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4110812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110816">data</span>&nbsp;<span class="op" id="4110821">:=</span>&nbsp;<span class="ident" id="4110824">c</span><span class="op" id="4110825">.</span><span class="ident" id="4110826">hand</span><span class="op" id="4110830">.</span><span class="ident" id="4110831">Bytes</span><span class="op" id="4110836">(</span><span class="op" id="4110837">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110840">n</span>&nbsp;<span class="op" id="4110842">:=</span>&nbsp;<span class="builtintype" id="4110845">int</span><span class="op" id="4110848">(</span><span class="ident" id="4110849">data</span><span class="op" id="4110853">[</span><span class="num" id="4110854">1</span><span class="op" id="4110855">]</span><span class="op" id="4110856">)</span><span class="op" id="4110857">&lt;&lt;</span><span class="num" id="4110859">16</span>&nbsp;<span class="op" id="4110862">|</span>&nbsp;<span class="builtintype" id="4110864">int</span><span class="op" id="4110867">(</span><span class="ident" id="4110868">data</span><span class="op" id="4110872">[</span><span class="num" id="4110873">2</span><span class="op" id="4110874">]</span><span class="op" id="4110875">)</span><span class="op" id="4110876">&lt;&lt;</span><span class="num" id="4110878">8</span>&nbsp;<span class="op" id="4110880">|</span>&nbsp;<span class="builtintype" id="4110882">int</span><span class="op" id="4110885">(</span><span class="ident" id="4110886">data</span><span class="op" id="4110890">[</span><span class="num" id="4110891">3</span><span class="op" id="4110892">]</span><span class="op" id="4110893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110896">if</span>&nbsp;<span class="ident" id="4110899">n</span>&nbsp;<span class="op" id="4110901">&gt;</span>&nbsp;<span class="ident" id="4110903">maxHandshake</span>&nbsp;<span class="op" id="4110916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110920">return</span>&nbsp;<span class="ident" id="4110927">nil</span><span class="op" id="4110930">,</span>&nbsp;<span class="ident" id="4110932">c</span><span class="op" id="4110933">.</span><span class="ident" id="4110934">in</span><span class="op" id="4110936">.</span><span class="ident" id="4110937">setErrorLocked</span><span class="op" id="4110951">(</span><span class="ident" id="4110952">c</span><span class="op" id="4110953">.</span><span class="ident" id="4110954">sendAlert</span><span class="op" id="4110963">(</span><span class="ident" id="4110964">alertInternalError</span><span class="op" id="4110982">)</span><span class="op" id="4110983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4110986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110989">for</span>&nbsp;<span class="ident" id="4110993">c</span><span class="op" id="4110994">.</span><span class="ident" id="4110995">hand</span><span class="op" id="4110999">.</span><span class="ident" id="4111000">Len</span><span class="op" id="4111003">(</span><span class="op" id="4111004">)</span>&nbsp;<span class="op" id="4111006">&lt;</span>&nbsp;<span class="num" id="4111008">4</span><span class="op" id="4111009">+</span><span class="ident" id="4111010">n</span>&nbsp;<span class="op" id="4111012">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111016">if</span>&nbsp;<span class="ident" id="4111019">err</span>&nbsp;<span class="op" id="4111023">:=</span>&nbsp;<span class="ident" id="4111026">c</span><span class="op" id="4111027">.</span><span class="ident" id="4111028">in</span><span class="op" id="4111030">.</span><span class="ident" id="4111031">err</span><span class="op" id="4111034">;</span>&nbsp;<span class="ident" id="4111036">err</span>&nbsp;<span class="op" id="4111040">!=</span>&nbsp;<span class="ident" id="4111043">nil</span>&nbsp;<span class="op" id="4111047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111052">return</span>&nbsp;<span class="ident" id="4111059">nil</span><span class="op" id="4111062">,</span>&nbsp;<span class="ident" id="4111064">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111074">if</span>&nbsp;<span class="ident" id="4111077">err</span>&nbsp;<span class="op" id="4111081">:=</span>&nbsp;<span class="ident" id="4111084">c</span><span class="op" id="4111085">.</span><span class="ident" id="4111086">readRecord</span><span class="op" id="4111096">(</span><span class="ident" id="4111097">recordTypeHandshake</span><span class="op" id="4111116">)</span><span class="op" id="4111117">;</span>&nbsp;<span class="ident" id="4111119">err</span>&nbsp;<span class="op" id="4111123">!=</span>&nbsp;<span class="ident" id="4111126">nil</span>&nbsp;<span class="op" id="4111130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111135">return</span>&nbsp;<span class="ident" id="4111142">nil</span><span class="op" id="4111145">,</span>&nbsp;<span class="ident" id="4111147">err</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111159">data</span>&nbsp;<span class="op" id="4111164">=</span>&nbsp;<span class="ident" id="4111166">c</span><span class="op" id="4111167">.</span><span class="ident" id="4111168">hand</span><span class="op" id="4111172">.</span><span class="ident" id="4111173">Next</span><span class="op" id="4111177">(</span><span class="num" id="4111178">4</span>&nbsp;<span class="op" id="4111180">+</span>&nbsp;<span class="ident" id="4111182">n</span><span class="op" id="4111183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111186">var</span>&nbsp;<span class="ident" id="4111190">m</span>&nbsp;<span class="ident" id="4111192">handshakeMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111210">switch</span>&nbsp;<span class="ident" id="4111217">data</span><span class="op" id="4111221">[</span><span class="num" id="4111222">0</span><span class="op" id="4111223">]</span>&nbsp;<span class="op" id="4111225">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111228">case</span>&nbsp;<span class="ident" id="4111233">typeClientHello</span><span class="op" id="4111248">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111252">m</span>&nbsp;<span class="op" id="4111254">=</span>&nbsp;<span class="builtinfunc" id="4111256">new</span><span class="op" id="4111259">(</span><span class="ident" id="4111260">clientHelloMsg</span><span class="op" id="4111274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111277">case</span>&nbsp;<span class="ident" id="4111282">typeServerHello</span><span class="op" id="4111297">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111301">m</span>&nbsp;<span class="op" id="4111303">=</span>&nbsp;<span class="builtinfunc" id="4111305">new</span><span class="op" id="4111308">(</span><span class="ident" id="4111309">serverHelloMsg</span><span class="op" id="4111323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111326">case</span>&nbsp;<span class="ident" id="4111331">typeNewSessionTicket</span><span class="op" id="4111351">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111355">m</span>&nbsp;<span class="op" id="4111357">=</span>&nbsp;<span class="builtinfunc" id="4111359">new</span><span class="op" id="4111362">(</span><span class="ident" id="4111363">newSessionTicketMsg</span><span class="op" id="4111382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111385">case</span>&nbsp;<span class="ident" id="4111390">typeCertificate</span><span class="op" id="4111405">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111409">m</span>&nbsp;<span class="op" id="4111411">=</span>&nbsp;<span class="builtinfunc" id="4111413">new</span><span class="op" id="4111416">(</span><span class="ident" id="4111417">certificateMsg</span><span class="op" id="4111431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111434">case</span>&nbsp;<span class="ident" id="4111439">typeCertificateRequest</span><span class="op" id="4111461">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111465">m</span>&nbsp;<span class="op" id="4111467">=</span>&nbsp;<span class="op" id="4111469">&amp;</span><span class="ident" id="4111470">certificateRequestMsg</span><span class="op" id="4111491">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111496">hasSignatureAndHash</span><span class="op" id="4111515">:</span>&nbsp;<span class="ident" id="4111517">c</span><span class="op" id="4111518">.</span><span class="ident" id="4111519">vers</span>&nbsp;<span class="op" id="4111524">&gt;=</span>&nbsp;<span class="ident" id="4111527">VersionTLS12</span><span class="op" id="4111539">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111546">case</span>&nbsp;<span class="ident" id="4111551">typeCertificateStatus</span><span class="op" id="4111572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111576">m</span>&nbsp;<span class="op" id="4111578">=</span>&nbsp;<span class="builtinfunc" id="4111580">new</span><span class="op" id="4111583">(</span><span class="ident" id="4111584">certificateStatusMsg</span><span class="op" id="4111604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111607">case</span>&nbsp;<span class="ident" id="4111612">typeServerKeyExchange</span><span class="op" id="4111633">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111637">m</span>&nbsp;<span class="op" id="4111639">=</span>&nbsp;<span class="builtinfunc" id="4111641">new</span><span class="op" id="4111644">(</span><span class="ident" id="4111645">serverKeyExchangeMsg</span><span class="op" id="4111665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111668">case</span>&nbsp;<span class="ident" id="4111673">typeServerHelloDone</span><span class="op" id="4111692">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111696">m</span>&nbsp;<span class="op" id="4111698">=</span>&nbsp;<span class="builtinfunc" id="4111700">new</span><span class="op" id="4111703">(</span><span class="ident" id="4111704">serverHelloDoneMsg</span><span class="op" id="4111722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111725">case</span>&nbsp;<span class="ident" id="4111730">typeClientKeyExchange</span><span class="op" id="4111751">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111755">m</span>&nbsp;<span class="op" id="4111757">=</span>&nbsp;<span class="builtinfunc" id="4111759">new</span><span class="op" id="4111762">(</span><span class="ident" id="4111763">clientKeyExchangeMsg</span><span class="op" id="4111783">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111786">case</span>&nbsp;<span class="ident" id="4111791">typeCertificateVerify</span><span class="op" id="4111812">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111816">m</span>&nbsp;<span class="op" id="4111818">=</span>&nbsp;<span class="op" id="4111820">&amp;</span><span class="ident" id="4111821">certificateVerifyMsg</span><span class="op" id="4111841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111846">hasSignatureAndHash</span><span class="op" id="4111865">:</span>&nbsp;<span class="ident" id="4111867">c</span><span class="op" id="4111868">.</span><span class="ident" id="4111869">vers</span>&nbsp;<span class="op" id="4111874">&gt;=</span>&nbsp;<span class="ident" id="4111877">VersionTLS12</span><span class="op" id="4111889">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111896">case</span>&nbsp;<span class="ident" id="4111901">typeNextProtocol</span><span class="op" id="4111917">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111921">m</span>&nbsp;<span class="op" id="4111923">=</span>&nbsp;<span class="builtinfunc" id="4111925">new</span><span class="op" id="4111928">(</span><span class="ident" id="4111929">nextProtoMsg</span><span class="op" id="4111941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111944">case</span>&nbsp;<span class="ident" id="4111949">typeFinished</span><span class="op" id="4111961">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111965">m</span>&nbsp;<span class="op" id="4111967">=</span>&nbsp;<span class="builtinfunc" id="4111969">new</span><span class="op" id="4111972">(</span><span class="ident" id="4111973">finishedMsg</span><span class="op" id="4111984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111987">default</span><span class="op" id="4111994">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111998">return</span>&nbsp;<span class="ident" id="4112005">nil</span><span class="op" id="4112008">,</span>&nbsp;<span class="ident" id="4112010">c</span><span class="op" id="4112011">.</span><span class="ident" id="4112012">in</span><span class="op" id="4112014">.</span><span class="ident" id="4112015">setErrorLocked</span><span class="op" id="4112029">(</span><span class="ident" id="4112030">c</span><span class="op" id="4112031">.</span><span class="ident" id="4112032">sendAlert</span><span class="op" id="4112041">(</span><span class="ident" id="4112042">alertUnexpectedMessage</span><span class="op" id="4112064">)</span><span class="op" id="4112065">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4112068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112072">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112112">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112162">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112217">data</span>&nbsp;<span class="op" id="4112222">=</span>&nbsp;<span class="builtinfunc" id="4112224">append</span><span class="op" id="4112230">(</span><span class="op" id="4112231">[</span><span class="op" id="4112232">]</span><span class="builtintype" id="4112233">byte</span><span class="op" id="4112237">(</span><span class="ident" id="4112238">nil</span><span class="op" id="4112241">)</span><span class="op" id="4112242">,</span>&nbsp;<span class="ident" id="4112244">data</span><span class="op" id="4112248">...</span><span class="op" id="4112251">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112255">if</span>&nbsp;<span class="op" id="4112258">!</span><span class="ident" id="4112259">m</span><span class="op" id="4112260">.</span><span class="ident" id="4112261">unmarshal</span><span class="op" id="4112270">(</span><span class="ident" id="4112271">data</span><span class="op" id="4112275">)</span>&nbsp;<span class="op" id="4112277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112281">return</span>&nbsp;<span class="ident" id="4112288">nil</span><span class="op" id="4112291">,</span>&nbsp;<span class="ident" id="4112293">c</span><span class="op" id="4112294">.</span><span class="ident" id="4112295">in</span><span class="op" id="4112297">.</span><span class="ident" id="4112298">setErrorLocked</span><span class="op" id="4112312">(</span><span class="ident" id="4112313">c</span><span class="op" id="4112314">.</span><span class="ident" id="4112315">sendAlert</span><span class="op" id="4112324">(</span><span class="ident" id="4112325">alertUnexpectedMessage</span><span class="op" id="4112347">)</span><span class="op" id="4112348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4112351">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112354">return</span>&nbsp;<span class="ident" id="4112361">m</span><span class="op" id="4112362">,</span>&nbsp;<span class="ident" id="4112364">nil</span><br>
<span class="lineno"></span><span class="op" id="4112368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4112371">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4112411">func</span>&nbsp;<span class="op" id="4112416">(</span><span class="ident" id="4112417">c</span>&nbsp;<span class="op" id="4112419">*</span><span class="ident" id="4112420">Conn</span><span class="op" id="4112424">)</span>&nbsp;<span class="ident" id="4112426">Write</span><span class="op" id="4112431">(</span><span class="ident" id="4112432">b</span>&nbsp;<span class="op" id="4112434">[</span><span class="op" id="4112435">]</span><span class="builtintype" id="4112436">byte</span><span class="op" id="4112440">)</span>&nbsp;<span class="op" id="4112442">(</span><span class="builtintype" id="4112443">int</span><span class="op" id="4112446">,</span>&nbsp;<span class="builtintype" id="4112448">error</span><span class="op" id="4112453">)</span>&nbsp;<span class="op" id="4112455">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112458">if</span>&nbsp;<span class="ident" id="4112461">err</span>&nbsp;<span class="op" id="4112465">:=</span>&nbsp;<span class="ident" id="4112468">c</span><span class="op" id="4112469">.</span><span class="ident" id="4112470">Handshake</span><span class="op" id="4112479">(</span><span class="op" id="4112480">)</span><span class="op" id="4112481">;</span>&nbsp;<span class="ident" id="4112483">err</span>&nbsp;<span class="op" id="4112487">!=</span>&nbsp;<span class="ident" id="4112490">nil</span>&nbsp;<span class="op" id="4112494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112498">return</span>&nbsp;<span class="num" id="4112505">0</span><span class="op" id="4112506">,</span>&nbsp;<span class="ident" id="4112508">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4112513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112517">c</span><span class="op" id="4112518">.</span><span class="ident" id="4112519">out</span><span class="op" id="4112522">.</span><span class="ident" id="4112523">Lock</span><span class="op" id="4112527">(</span><span class="op" id="4112528">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112531">defer</span>&nbsp;<span class="ident" id="4112537">c</span><span class="op" id="4112538">.</span><span class="ident" id="4112539">out</span><span class="op" id="4112542">.</span><span class="ident" id="4112543">Unlock</span><span class="op" id="4112549">(</span><span class="op" id="4112550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112554">if</span>&nbsp;<span class="ident" id="4112557">err</span>&nbsp;<span class="op" id="4112561">:=</span>&nbsp;<span class="ident" id="4112564">c</span><span class="op" id="4112565">.</span><span class="ident" id="4112566">out</span><span class="op" id="4112569">.</span><span class="ident" id="4112570">err</span><span class="op" id="4112573">;</span>&nbsp;<span class="ident" id="4112575">err</span>&nbsp;<span class="op" id="4112579">!=</span>&nbsp;<span class="ident" id="4112582">nil</span>&nbsp;<span class="op" id="4112586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112590">return</span>&nbsp;<span class="num" id="4112597">0</span><span class="op" id="4112598">,</span>&nbsp;<span class="ident" id="4112600">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4112605">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112609">if</span>&nbsp;<span class="op" id="4112612">!</span><span class="ident" id="4112613">c</span><span class="op" id="4112614">.</span><span class="ident" id="4112615">handshakeComplete</span>&nbsp;<span class="op" id="4112633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112637">return</span>&nbsp;<span class="num" id="4112644">0</span><span class="op" id="4112645">,</span>&nbsp;<span class="ident" id="4112647">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4112667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112671">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112733">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112798">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112859">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112920">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112924">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4112969">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4113025">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113090">var</span>&nbsp;<span class="ident" id="4113094">m</span>&nbsp;<span class="builtintype" id="4113096">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113101">if</span>&nbsp;<span class="builtinfunc" id="4113104">len</span><span class="op" id="4113107">(</span><span class="ident" id="4113108">b</span><span class="op" id="4113109">)</span>&nbsp;<span class="op" id="4113111">&gt;</span>&nbsp;<span class="num" id="4113113">1</span>&nbsp;<span class="op" id="4113115">&amp;&amp;</span>&nbsp;<span class="ident" id="4113118">c</span><span class="op" id="4113119">.</span><span class="ident" id="4113120">vers</span>&nbsp;<span class="op" id="4113125">&lt;=</span>&nbsp;<span class="ident" id="4113128">VersionTLS10</span>&nbsp;<span class="op" id="4113141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113145">if</span>&nbsp;<span class="ident" id="4113148">_</span><span class="op" id="4113149">,</span>&nbsp;<span class="ident" id="4113151">ok</span>&nbsp;<span class="op" id="4113154">:=</span>&nbsp;<span class="ident" id="4113157">c</span><span class="op" id="4113158">.</span><span class="ident" id="4113159">out</span><span class="op" id="4113162">.</span><span class="ident" id="4113163">cipher</span><span class="op" id="4113169">.</span><span class="op" id="4113170">(</span><span class="ident" id="4113171">cipher</span><span class="op" id="4113177">.</span><span class="ident" id="4113178">BlockMode</span><span class="op" id="4113187">)</span><span class="op" id="4113188">;</span>&nbsp;<span class="ident" id="4113190">ok</span>&nbsp;<span class="op" id="4113193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113198">n</span><span class="op" id="4113199">,</span>&nbsp;<span class="ident" id="4113201">err</span>&nbsp;<span class="op" id="4113205">:=</span>&nbsp;<span class="ident" id="4113208">c</span><span class="op" id="4113209">.</span><span class="ident" id="4113210">writeRecord</span><span class="op" id="4113221">(</span><span class="ident" id="4113222">recordTypeApplicationData</span><span class="op" id="4113247">,</span>&nbsp;<span class="ident" id="4113249">b</span><span class="op" id="4113250">[</span><span class="op" id="4113251">:</span><span class="num" id="4113252">1</span><span class="op" id="4113253">]</span><span class="op" id="4113254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113259">if</span>&nbsp;<span class="ident" id="4113262">err</span>&nbsp;<span class="op" id="4113266">!=</span>&nbsp;<span class="ident" id="4113269">nil</span>&nbsp;<span class="op" id="4113273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113279">return</span>&nbsp;<span class="ident" id="4113286">n</span><span class="op" id="4113287">,</span>&nbsp;<span class="ident" id="4113289">c</span><span class="op" id="4113290">.</span><span class="ident" id="4113291">out</span><span class="op" id="4113294">.</span><span class="ident" id="4113295">setErrorLocked</span><span class="op" id="4113309">(</span><span class="ident" id="4113310">err</span><span class="op" id="4113313">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113323">m</span><span class="op" id="4113324">,</span>&nbsp;<span class="ident" id="4113326">b</span>&nbsp;<span class="op" id="4113328">=</span>&nbsp;<span class="num" id="4113330">1</span><span class="op" id="4113331">,</span>&nbsp;<span class="ident" id="4113333">b</span><span class="op" id="4113334">[</span><span class="num" id="4113335">1</span><span class="op" id="4113336">:</span><span class="op" id="4113337">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113348">n</span><span class="op" id="4113349">,</span>&nbsp;<span class="ident" id="4113351">err</span>&nbsp;<span class="op" id="4113355">:=</span>&nbsp;<span class="ident" id="4113358">c</span><span class="op" id="4113359">.</span><span class="ident" id="4113360">writeRecord</span><span class="op" id="4113371">(</span><span class="ident" id="4113372">recordTypeApplicationData</span><span class="op" id="4113397">,</span>&nbsp;<span class="ident" id="4113399">b</span><span class="op" id="4113400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113403">return</span>&nbsp;<span class="ident" id="4113410">n</span>&nbsp;<span class="op" id="4113412">+</span>&nbsp;<span class="ident" id="4113414">m</span><span class="op" id="4113415">,</span>&nbsp;<span class="ident" id="4113417">c</span><span class="op" id="4113418">.</span><span class="ident" id="4113419">out</span><span class="op" id="4113422">.</span><span class="ident" id="4113423">setErrorLocked</span><span class="op" id="4113437">(</span><span class="ident" id="4113438">err</span><span class="op" id="4113441">)</span><br>
<span class="lineno"></span><span class="op" id="4113443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4113446">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="4113524">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="4113590">func</span>&nbsp;<span class="op" id="4113595">(</span><span class="ident" id="4113596">c</span>&nbsp;<span class="op" id="4113598">*</span><span class="ident" id="4113599">Conn</span><span class="op" id="4113603">)</span>&nbsp;<span class="ident" id="4113605">Read</span><span class="op" id="4113609">(</span><span class="ident" id="4113610">b</span>&nbsp;<span class="op" id="4113612">[</span><span class="op" id="4113613">]</span><span class="builtintype" id="4113614">byte</span><span class="op" id="4113618">)</span>&nbsp;<span class="op" id="4113620">(</span><span class="ident" id="4113621">n</span>&nbsp;<span class="builtintype" id="4113623">int</span><span class="op" id="4113626">,</span>&nbsp;<span class="ident" id="4113628">err</span>&nbsp;<span class="builtintype" id="4113632">error</span><span class="op" id="4113637">)</span>&nbsp;<span class="op" id="4113639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113642">if</span>&nbsp;<span class="ident" id="4113645">err</span>&nbsp;<span class="op" id="4113649">=</span>&nbsp;<span class="ident" id="4113651">c</span><span class="op" id="4113652">.</span><span class="ident" id="4113653">Handshake</span><span class="op" id="4113662">(</span><span class="op" id="4113663">)</span><span class="op" id="4113664">;</span>&nbsp;<span class="ident" id="4113666">err</span>&nbsp;<span class="op" id="4113670">!=</span>&nbsp;<span class="ident" id="4113673">nil</span>&nbsp;<span class="op" id="4113677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113681">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113689">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113692">if</span>&nbsp;<span class="builtinfunc" id="4113695">len</span><span class="op" id="4113698">(</span><span class="ident" id="4113699">b</span><span class="op" id="4113700">)</span>&nbsp;<span class="op" id="4113702">==</span>&nbsp;<span class="num" id="4113705">0</span>&nbsp;<span class="op" id="4113707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4113711">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4113770">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113823">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4113831">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4113835">c</span><span class="op" id="4113836">.</span><span class="ident" id="4113837">in</span><span class="op" id="4113839">.</span><span class="ident" id="4113840">Lock</span><span class="op" id="4113844">(</span><span class="op" id="4113845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4113848">defer</span>&nbsp;<span class="ident" id="4113854">c</span><span class="op" id="4113855">.</span><span class="ident" id="4113856">in</span><span class="op" id="4113858">.</span><span class="ident" id="4113859">Unlock</span><span class="op" id="4113865">(</span><span class="op" id="4113866">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4113870">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4113940">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114008">const</span>&nbsp;<span class="ident" id="4114014">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="4114041">=</span>&nbsp;<span class="num" id="4114043">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114048">for</span>&nbsp;<span class="ident" id="4114052">emptyRecordCount</span>&nbsp;<span class="op" id="4114069">:=</span>&nbsp;<span class="num" id="4114072">0</span><span class="op" id="4114073">;</span>&nbsp;<span class="ident" id="4114075">emptyRecordCount</span>&nbsp;<span class="op" id="4114092">&lt;=</span>&nbsp;<span class="ident" id="4114095">maxConsecutiveEmptyRecords</span><span class="op" id="4114121">;</span>&nbsp;<span class="ident" id="4114123">emptyRecordCount</span><span class="op" id="4114139">++</span>&nbsp;<span class="op" id="4114142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114146">for</span>&nbsp;<span class="ident" id="4114150">c</span><span class="op" id="4114151">.</span><span class="ident" id="4114152">input</span>&nbsp;<span class="op" id="4114158">==</span>&nbsp;<span class="ident" id="4114161">nil</span>&nbsp;<span class="op" id="4114165">&amp;&amp;</span>&nbsp;<span class="ident" id="4114168">c</span><span class="op" id="4114169">.</span><span class="ident" id="4114170">in</span><span class="op" id="4114172">.</span><span class="ident" id="4114173">err</span>&nbsp;<span class="op" id="4114177">==</span>&nbsp;<span class="ident" id="4114180">nil</span>&nbsp;<span class="op" id="4114184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114189">if</span>&nbsp;<span class="ident" id="4114192">err</span>&nbsp;<span class="op" id="4114196">:=</span>&nbsp;<span class="ident" id="4114199">c</span><span class="op" id="4114200">.</span><span class="ident" id="4114201">readRecord</span><span class="op" id="4114211">(</span><span class="ident" id="4114212">recordTypeApplicationData</span><span class="op" id="4114237">)</span><span class="op" id="4114238">;</span>&nbsp;<span class="ident" id="4114240">err</span>&nbsp;<span class="op" id="4114244">!=</span>&nbsp;<span class="ident" id="4114247">nil</span>&nbsp;<span class="op" id="4114251">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114257">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114288">return</span>&nbsp;<span class="num" id="4114295">0</span><span class="op" id="4114296">,</span>&nbsp;<span class="ident" id="4114298">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4114305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4114309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114313">if</span>&nbsp;<span class="ident" id="4114316">err</span>&nbsp;<span class="op" id="4114320">:=</span>&nbsp;<span class="ident" id="4114323">c</span><span class="op" id="4114324">.</span><span class="ident" id="4114325">in</span><span class="op" id="4114327">.</span><span class="ident" id="4114328">err</span><span class="op" id="4114331">;</span>&nbsp;<span class="ident" id="4114333">err</span>&nbsp;<span class="op" id="4114337">!=</span>&nbsp;<span class="ident" id="4114340">nil</span>&nbsp;<span class="op" id="4114344">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114349">return</span>&nbsp;<span class="num" id="4114356">0</span><span class="op" id="4114357">,</span>&nbsp;<span class="ident" id="4114359">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4114365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114370">n</span><span class="op" id="4114371">,</span>&nbsp;<span class="ident" id="4114373">err</span>&nbsp;<span class="op" id="4114377">=</span>&nbsp;<span class="ident" id="4114379">c</span><span class="op" id="4114380">.</span><span class="ident" id="4114381">input</span><span class="op" id="4114386">.</span><span class="ident" id="4114387">Read</span><span class="op" id="4114391">(</span><span class="ident" id="4114392">b</span><span class="op" id="4114393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4114397">if</span>&nbsp;<span class="ident" id="4114400">c</span><span class="op" id="4114401">.</span><span class="ident" id="4114402">input</span><span class="op" id="4114407">.</span><span class="ident" id="4114408">off</span>&nbsp;<span class="op" id="4114412">&gt;=</span>&nbsp;<span class="builtinfunc" id="4114415">len</span><span class="op" id="4114418">(</span><span class="ident" id="4114419">c</span><span class="op" id="4114420">.</span><span class="ident" id="4114421">input</span><span class="op" id="4114426">.</span><span class="ident" id="4114427">data</span><span class="op" id="4114431">)</span>&nbsp;<span class="op" id="4114433">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114438">c</span><span class="op" id="4114439">.</span><span class="ident" id="4114440">in</span><span class="op" id="4114442">.</span><span class="ident" id="4114443">freeBlock</span><span class="op" id="4114452">(</span><span class="ident" id="4114453">c</span><span class="op" id="4114454">.</span><span class="ident" id="4114455">input</span><span class="op" id="4114460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4114465">c</span><span class="op" id="4114466">.</span><span class="ident" id="4114467">input</span>&nbsp;<span class="op" id="4114473">=</span>&nbsp;<span class="ident" id="4114475">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4114481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114486">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114543">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114602">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114655">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114709">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114762">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114818">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114875">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114925">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114939">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4114988">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115026">if</span>&nbsp;<span class="ident" id="4115029">ri</span>&nbsp;<span class="op" id="4115032">:=</span>&nbsp;<span class="ident" id="4115035">c</span><span class="op" id="4115036">.</span><span class="ident" id="4115037">rawInput</span><span class="op" id="4115045">;</span>&nbsp;<span class="ident" id="4115047">ri</span>&nbsp;<span class="op" id="4115050">!=</span>&nbsp;<span class="ident" id="4115053">nil</span>&nbsp;<span class="op" id="4115057">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115063">n</span>&nbsp;<span class="op" id="4115065">!=</span>&nbsp;<span class="num" id="4115068">0</span>&nbsp;<span class="op" id="4115070">&amp;&amp;</span>&nbsp;<span class="ident" id="4115073">err</span>&nbsp;<span class="op" id="4115077">==</span>&nbsp;<span class="ident" id="4115080">nil</span>&nbsp;<span class="op" id="4115084">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115090">c</span><span class="op" id="4115091">.</span><span class="ident" id="4115092">input</span>&nbsp;<span class="op" id="4115098">==</span>&nbsp;<span class="ident" id="4115101">nil</span>&nbsp;<span class="op" id="4115105">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4115108">len</span><span class="op" id="4115111">(</span><span class="ident" id="4115112">ri</span><span class="op" id="4115114">.</span><span class="ident" id="4115115">data</span><span class="op" id="4115119">)</span>&nbsp;<span class="op" id="4115121">&gt;</span>&nbsp;<span class="num" id="4115123">0</span>&nbsp;<span class="op" id="4115125">&amp;&amp;</span>&nbsp;<span class="ident" id="4115128">recordType</span><span class="op" id="4115138">(</span><span class="ident" id="4115139">ri</span><span class="op" id="4115141">.</span><span class="ident" id="4115142">data</span><span class="op" id="4115146">[</span><span class="num" id="4115147">0</span><span class="op" id="4115148">]</span><span class="op" id="4115149">)</span>&nbsp;<span class="op" id="4115151">==</span>&nbsp;<span class="ident" id="4115154">recordTypeAlert</span>&nbsp;<span class="op" id="4115170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115175">if</span>&nbsp;<span class="ident" id="4115178">recErr</span>&nbsp;<span class="op" id="4115185">:=</span>&nbsp;<span class="ident" id="4115188">c</span><span class="op" id="4115189">.</span><span class="ident" id="4115190">readRecord</span><span class="op" id="4115200">(</span><span class="ident" id="4115201">recordTypeApplicationData</span><span class="op" id="4115226">)</span><span class="op" id="4115227">;</span>&nbsp;<span class="ident" id="4115229">recErr</span>&nbsp;<span class="op" id="4115236">!=</span>&nbsp;<span class="ident" id="4115239">nil</span>&nbsp;<span class="op" id="4115243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115249">err</span>&nbsp;<span class="op" id="4115253">=</span>&nbsp;<span class="ident" id="4115255">recErr</span>&nbsp;<span class="comment" id="4115262">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115307">if</span>&nbsp;<span class="ident" id="4115310">n</span>&nbsp;<span class="op" id="4115312">!=</span>&nbsp;<span class="num" id="4115315">0</span>&nbsp;<span class="op" id="4115317">||</span>&nbsp;<span class="ident" id="4115320">err</span>&nbsp;<span class="op" id="4115324">!=</span>&nbsp;<span class="ident" id="4115327">nil</span>&nbsp;<span class="op" id="4115331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115336">return</span>&nbsp;<span class="ident" id="4115343">n</span><span class="op" id="4115344">,</span>&nbsp;<span class="ident" id="4115346">err</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115359">return</span>&nbsp;<span class="num" id="4115366">0</span><span class="op" id="4115367">,</span>&nbsp;<span class="ident" id="4115369">io</span><span class="op" id="4115371">.</span><span class="ident" id="4115372">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="4115386">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="4115389">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4115421">func</span>&nbsp;<span class="op" id="4115426">(</span><span class="ident" id="4115427">c</span>&nbsp;<span class="op" id="4115429">*</span><span class="ident" id="4115430">Conn</span><span class="op" id="4115434">)</span>&nbsp;<span class="ident" id="4115436">Close</span><span class="op" id="4115441">(</span><span class="op" id="4115442">)</span>&nbsp;<span class="builtintype" id="4115444">error</span>&nbsp;<span class="op" id="4115450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115453">var</span>&nbsp;<span class="ident" id="4115457">alertErr</span>&nbsp;<span class="builtintype" id="4115466">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115474">c</span><span class="op" id="4115475">.</span><span class="ident" id="4115476">handshakeMutex</span><span class="op" id="4115490">.</span><span class="ident" id="4115491">Lock</span><span class="op" id="4115495">(</span><span class="op" id="4115496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115499">defer</span>&nbsp;<span class="ident" id="4115505">c</span><span class="op" id="4115506">.</span><span class="ident" id="4115507">handshakeMutex</span><span class="op" id="4115521">.</span><span class="ident" id="4115522">Unlock</span><span class="op" id="4115528">(</span><span class="op" id="4115529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115532">if</span>&nbsp;<span class="ident" id="4115535">c</span><span class="op" id="4115536">.</span><span class="ident" id="4115537">handshakeComplete</span>&nbsp;<span class="op" id="4115555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115559">alertErr</span>&nbsp;<span class="op" id="4115568">=</span>&nbsp;<span class="ident" id="4115570">c</span><span class="op" id="4115571">.</span><span class="ident" id="4115572">sendAlert</span><span class="op" id="4115581">(</span><span class="ident" id="4115582">alertCloseNotify</span><span class="op" id="4115598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115601">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115605">if</span>&nbsp;<span class="ident" id="4115608">err</span>&nbsp;<span class="op" id="4115612">:=</span>&nbsp;<span class="ident" id="4115615">c</span><span class="op" id="4115616">.</span><span class="ident" id="4115617">conn</span><span class="op" id="4115621">.</span><span class="ident" id="4115622">Close</span><span class="op" id="4115627">(</span><span class="op" id="4115628">)</span><span class="op" id="4115629">;</span>&nbsp;<span class="ident" id="4115631">err</span>&nbsp;<span class="op" id="4115635">!=</span>&nbsp;<span class="ident" id="4115638">nil</span>&nbsp;<span class="op" id="4115642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115646">return</span>&nbsp;<span class="ident" id="4115653">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4115658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115661">return</span>&nbsp;<span class="ident" id="4115668">alertErr</span><br>
<span class="lineno">960</span><span class="op" id="4115677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4115680">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="4115729">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="4115769">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="4115822">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="4115889">func</span>&nbsp;<span class="op" id="4115894">(</span><span class="ident" id="4115895">c</span>&nbsp;<span class="op" id="4115897">*</span><span class="ident" id="4115898">Conn</span><span class="op" id="4115902">)</span>&nbsp;<span class="ident" id="4115904">Handshake</span><span class="op" id="4115913">(</span><span class="op" id="4115914">)</span>&nbsp;<span class="builtintype" id="4115916">error</span>&nbsp;<span class="op" id="4115922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4115925">c</span><span class="op" id="4115926">.</span><span class="ident" id="4115927">handshakeMutex</span><span class="op" id="4115941">.</span><span class="ident" id="4115942">Lock</span><span class="op" id="4115946">(</span><span class="op" id="4115947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115950">defer</span>&nbsp;<span class="ident" id="4115956">c</span><span class="op" id="4115957">.</span><span class="ident" id="4115958">handshakeMutex</span><span class="op" id="4115972">.</span><span class="ident" id="4115973">Unlock</span><span class="op" id="4115979">(</span><span class="op" id="4115980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4115983">if</span>&nbsp;<span class="ident" id="4115986">err</span>&nbsp;<span class="op" id="4115990">:=</span>&nbsp;<span class="ident" id="4115993">c</span><span class="op" id="4115994">.</span><span class="ident" id="4115995">handshakeErr</span><span class="op" id="4116007">;</span>&nbsp;<span class="ident" id="4116009">err</span>&nbsp;<span class="op" id="4116013">!=</span>&nbsp;<span class="ident" id="4116016">nil</span>&nbsp;<span class="op" id="4116020">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116024">return</span>&nbsp;<span class="ident" id="4116031">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116039">if</span>&nbsp;<span class="ident" id="4116042">c</span><span class="op" id="4116043">.</span><span class="ident" id="4116044">handshakeComplete</span>&nbsp;<span class="op" id="4116062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116066">return</span>&nbsp;<span class="ident" id="4116073">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116078">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116082">if</span>&nbsp;<span class="ident" id="4116085">c</span><span class="op" id="4116086">.</span><span class="ident" id="4116087">isClient</span>&nbsp;<span class="op" id="4116096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116100">c</span><span class="op" id="4116101">.</span><span class="ident" id="4116102">handshakeErr</span>&nbsp;<span class="op" id="4116115">=</span>&nbsp;<span class="ident" id="4116117">c</span><span class="op" id="4116118">.</span><span class="ident" id="4116119">clientHandshake</span><span class="op" id="4116134">(</span><span class="op" id="4116135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116138">}</span>&nbsp;<span class="keyword" id="4116140">else</span>&nbsp;<span class="op" id="4116145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116149">c</span><span class="op" id="4116150">.</span><span class="ident" id="4116151">handshakeErr</span>&nbsp;<span class="op" id="4116164">=</span>&nbsp;<span class="ident" id="4116166">c</span><span class="op" id="4116167">.</span><span class="ident" id="4116168">serverHandshake</span><span class="op" id="4116183">(</span><span class="op" id="4116184">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116190">return</span>&nbsp;<span class="ident" id="4116197">c</span><span class="op" id="4116198">.</span><span class="ident" id="4116199">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="4116212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4116215">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="4116282">func</span>&nbsp;<span class="op" id="4116287">(</span><span class="ident" id="4116288">c</span>&nbsp;<span class="op" id="4116290">*</span><span class="ident" id="4116291">Conn</span><span class="op" id="4116295">)</span>&nbsp;<span class="ident" id="4116297">ConnectionState</span><span class="op" id="4116312">(</span><span class="op" id="4116313">)</span>&nbsp;<span class="ident" id="4116315">ConnectionState</span>&nbsp;<span class="op" id="4116331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116334">c</span><span class="op" id="4116335">.</span><span class="ident" id="4116336">handshakeMutex</span><span class="op" id="4116350">.</span><span class="ident" id="4116351">Lock</span><span class="op" id="4116355">(</span><span class="op" id="4116356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116359">defer</span>&nbsp;<span class="ident" id="4116365">c</span><span class="op" id="4116366">.</span><span class="ident" id="4116367">handshakeMutex</span><span class="op" id="4116381">.</span><span class="ident" id="4116382">Unlock</span><span class="op" id="4116388">(</span><span class="op" id="4116389">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116393">var</span>&nbsp;<span class="ident" id="4116397">state</span>&nbsp;<span class="ident" id="4116403">ConnectionState</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116420">state</span><span class="op" id="4116425">.</span><span class="ident" id="4116426">HandshakeComplete</span>&nbsp;<span class="op" id="4116444">=</span>&nbsp;<span class="ident" id="4116446">c</span><span class="op" id="4116447">.</span><span class="ident" id="4116448">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116467">if</span>&nbsp;<span class="ident" id="4116470">c</span><span class="op" id="4116471">.</span><span class="ident" id="4116472">handshakeComplete</span>&nbsp;<span class="op" id="4116490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116494">state</span><span class="op" id="4116499">.</span><span class="ident" id="4116500">Version</span>&nbsp;<span class="op" id="4116508">=</span>&nbsp;<span class="ident" id="4116510">c</span><span class="op" id="4116511">.</span><span class="ident" id="4116512">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116519">state</span><span class="op" id="4116524">.</span><span class="ident" id="4116525">NegotiatedProtocol</span>&nbsp;<span class="op" id="4116544">=</span>&nbsp;<span class="ident" id="4116546">c</span><span class="op" id="4116547">.</span><span class="ident" id="4116548">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116565">state</span><span class="op" id="4116570">.</span><span class="ident" id="4116571">DidResume</span>&nbsp;<span class="op" id="4116581">=</span>&nbsp;<span class="ident" id="4116583">c</span><span class="op" id="4116584">.</span><span class="ident" id="4116585">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116597">state</span><span class="op" id="4116602">.</span><span class="ident" id="4116603">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="4116630">=</span>&nbsp;<span class="op" id="4116632">!</span><span class="ident" id="4116633">c</span><span class="op" id="4116634">.</span><span class="ident" id="4116635">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116660">state</span><span class="op" id="4116665">.</span><span class="ident" id="4116666">CipherSuite</span>&nbsp;<span class="op" id="4116678">=</span>&nbsp;<span class="ident" id="4116680">c</span><span class="op" id="4116681">.</span><span class="ident" id="4116682">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116696">state</span><span class="op" id="4116701">.</span><span class="ident" id="4116702">PeerCertificates</span>&nbsp;<span class="op" id="4116719">=</span>&nbsp;<span class="ident" id="4116721">c</span><span class="op" id="4116722">.</span><span class="ident" id="4116723">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116742">state</span><span class="op" id="4116747">.</span><span class="ident" id="4116748">VerifiedChains</span>&nbsp;<span class="op" id="4116763">=</span>&nbsp;<span class="ident" id="4116765">c</span><span class="op" id="4116766">.</span><span class="ident" id="4116767">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116784">state</span><span class="op" id="4116789">.</span><span class="ident" id="4116790">ServerName</span>&nbsp;<span class="op" id="4116801">=</span>&nbsp;<span class="ident" id="4116803">c</span><span class="op" id="4116804">.</span><span class="ident" id="4116805">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116818">if</span>&nbsp;<span class="op" id="4116821">!</span><span class="ident" id="4116822">c</span><span class="op" id="4116823">.</span><span class="ident" id="4116824">didResume</span>&nbsp;<span class="op" id="4116834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4116839">state</span><span class="op" id="4116844">.</span><span class="ident" id="4116845">TLSUnique</span>&nbsp;<span class="op" id="4116855">=</span>&nbsp;<span class="ident" id="4116857">c</span><span class="op" id="4116858">.</span><span class="ident" id="4116859">firstFinished</span><span class="op" id="4116872">[</span><span class="op" id="4116873">:</span><span class="op" id="4116874">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4116881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4116885">return</span>&nbsp;<span class="ident" id="4116892">state</span><br>
<span class="lineno"></span><span class="op" id="4116898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4116901">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4116975">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="4117020">func</span>&nbsp;<span class="op" id="4117025">(</span><span class="ident" id="4117026">c</span>&nbsp;<span class="op" id="4117028">*</span><span class="ident" id="4117029">Conn</span><span class="op" id="4117033">)</span>&nbsp;<span class="ident" id="4117035">OCSPResponse</span><span class="op" id="4117047">(</span><span class="op" id="4117048">)</span>&nbsp;<span class="op" id="4117050">[</span><span class="op" id="4117051">]</span><span class="builtintype" id="4117052">byte</span>&nbsp;<span class="op" id="4117057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117060">c</span><span class="op" id="4117061">.</span><span class="ident" id="4117062">handshakeMutex</span><span class="op" id="4117076">.</span><span class="ident" id="4117077">Lock</span><span class="op" id="4117081">(</span><span class="op" id="4117082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4117085">defer</span>&nbsp;<span class="ident" id="4117091">c</span><span class="op" id="4117092">.</span><span class="ident" id="4117093">handshakeMutex</span><span class="op" id="4117107">.</span><span class="ident" id="4117108">Unlock</span><span class="op" id="4117114">(</span><span class="op" id="4117115">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4117119">return</span>&nbsp;<span class="ident" id="4117126">c</span><span class="op" id="4117127">.</span><span class="ident" id="4117128">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="4117141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4117144">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4117214">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4117289">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="4117316">func</span>&nbsp;<span class="op" id="4117321">(</span><span class="ident" id="4117322">c</span>&nbsp;<span class="op" id="4117324">*</span><span class="ident" id="4117325">Conn</span><span class="op" id="4117329">)</span>&nbsp;<span class="ident" id="4117331">VerifyHostname</span><span class="op" id="4117345">(</span><span class="ident" id="4117346">host</span>&nbsp;<span class="builtintype" id="4117351">string</span><span class="op" id="4117357">)</span>&nbsp;<span class="builtintype" id="4117359">error</span>&nbsp;<span class="op" id="4117365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4117368">c</span><span class="op" id="4117369">.</span><span class="ident" id="4117370">handshakeMutex</span><span class="op" id="4117384">.</span><span class="ident" id="4117385">Lock</span><span class="op" id="4117389">(</span><span class="op" id="4117390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4117393">defer</span>&nbsp;<span class="ident" id="4117399">c</span><span class="op" id="4117400">.</span><span class="ident" id="4117401">handshakeMutex</span><span class="op" id="4117415">.</span><span class="ident" id="4117416">Unlock</span><span class="op" id="4117422">(</span><span class="op" id="4117423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4117426">if</span>&nbsp;<span class="op" id="4117429">!</span><span class="ident" id="4117430">c</span><span class="op" id="4117431">.</span><span class="ident" id="4117432">isClient</span>&nbsp;<span class="op" id="4117441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4117445">return</span>&nbsp;<span class="ident" id="4117452">errors</span><span class="op" id="4117458">.</span><span class="ident" id="4117459">New</span><span class="op" id="4117462">(</span><span class="string" id="4117463">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="4117516">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4117519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4117522">if</span>&nbsp;<span class="op" id="4117525">!</span><span class="ident" id="4117526">c</span><span class="op" id="4117527">.</span><span class="ident" id="4117528">handshakeComplete</span>&nbsp;<span class="op" id="4117546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4117550">return</span>&nbsp;<span class="ident" id="4117557">errors</span><span class="op" id="4117563">.</span><span class="ident" id="4117564">New</span><span class="op" id="4117567">(</span><span class="string" id="4117568">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="4117611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4117614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4117617">return</span>&nbsp;<span class="ident" id="4117624">c</span><span class="op" id="4117625">.</span><span class="ident" id="4117626">peerCertificates</span><span class="op" id="4117642">[</span><span class="num" id="4117643">0</span><span class="op" id="4117644">]</span><span class="op" id="4117645">.</span><span class="ident" id="4117646">VerifyHostname</span><span class="op" id="4117660">(</span><span class="ident" id="4117661">host</span><span class="op" id="4117665">)</span><br>
<span class="lineno">1030</span><span class="op" id="4117667">}</span>
</div>
</body>
</html>
