<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/gif</h2>
<ul>
<li><a href="/gostd/image/gif/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/gif/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/gif/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/gif/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5922917">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5922972">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5923026">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5923077">package</span>&nbsp;<span class="ident" id="5923085">gif</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5923090">import</span>&nbsp;<span class="op" id="5923097">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5923100">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5923109">&#34;compress/lzw&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5923125">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5923135">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5923144">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5923159">&#34;image/color/palette&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5923182">&#34;image/draw&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5923196">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5923201">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5923204">//&nbsp;Graphic&nbsp;control&nbsp;extension&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="5923241">const</span>&nbsp;<span class="op" id="5923247">(</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923250">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5923262">=</span>&nbsp;<span class="num" id="5923264">0xF9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923270">gcBlockSize</span>&nbsp;<span class="op" id="5923282">=</span>&nbsp;<span class="num" id="5923284">0x04</span><br>
<span class="lineno"></span><span class="op" id="5923289">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5923292">var</span>&nbsp;<span class="ident" id="5923296">log2Lookup</span>&nbsp;<span class="op" id="5923307">=</span>&nbsp;<span class="op" id="5923309">[</span><span class="num" id="5923310">8</span><span class="op" id="5923311">]</span><span class="builtintype" id="5923312">int</span><span class="op" id="5923315">{</span><span class="num" id="5923316">2</span><span class="op" id="5923317">,</span>&nbsp;<span class="num" id="5923319">4</span><span class="op" id="5923320">,</span>&nbsp;<span class="num" id="5923322">8</span><span class="op" id="5923323">,</span>&nbsp;<span class="num" id="5923325">16</span><span class="op" id="5923327">,</span>&nbsp;<span class="num" id="5923329">32</span><span class="op" id="5923331">,</span>&nbsp;<span class="num" id="5923333">64</span><span class="op" id="5923335">,</span>&nbsp;<span class="num" id="5923337">128</span><span class="op" id="5923340">,</span>&nbsp;<span class="num" id="5923342">256</span><span class="op" id="5923345">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="5923348">func</span>&nbsp;<span class="ident" id="5923353">log2</span><span class="op" id="5923357">(</span><span class="ident" id="5923358">x</span>&nbsp;<span class="builtintype" id="5923360">int</span><span class="op" id="5923363">)</span>&nbsp;<span class="builtintype" id="5923365">int</span>&nbsp;<span class="op" id="5923369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5923372">for</span>&nbsp;<span class="ident" id="5923376">i</span><span class="op" id="5923377">,</span>&nbsp;<span class="ident" id="5923379">v</span>&nbsp;<span class="op" id="5923381">:=</span>&nbsp;<span class="keyword" id="5923384">range</span>&nbsp;<span class="ident" id="5923390">log2Lookup</span>&nbsp;<span class="op" id="5923401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5923405">if</span>&nbsp;<span class="ident" id="5923408">x</span>&nbsp;<span class="op" id="5923410">&lt;=</span>&nbsp;<span class="ident" id="5923413">v</span>&nbsp;<span class="op" id="5923415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5923420">return</span>&nbsp;<span class="ident" id="5923427">i</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5923431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5923434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5923437">return</span>&nbsp;<span class="op" id="5923444">-</span><span class="num" id="5923445">1</span><br>
<span class="lineno"></span><span class="op" id="5923447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5923450">//&nbsp;Little-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="5923468">func</span>&nbsp;<span class="ident" id="5923473">writeUint16</span><span class="op" id="5923484">(</span><span class="ident" id="5923485">b</span>&nbsp;<span class="op" id="5923487">[</span><span class="op" id="5923488">]</span><span class="builtintype" id="5923489">uint8</span><span class="op" id="5923494">,</span>&nbsp;<span class="ident" id="5923496">u</span>&nbsp;<span class="builtintype" id="5923498">uint16</span><span class="op" id="5923504">)</span>&nbsp;<span class="op" id="5923506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923509">b</span><span class="op" id="5923510">[</span><span class="num" id="5923511">0</span><span class="op" id="5923512">]</span>&nbsp;<span class="op" id="5923514">=</span>&nbsp;<span class="builtintype" id="5923516">uint8</span><span class="op" id="5923521">(</span><span class="ident" id="5923522">u</span><span class="op" id="5923523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923526">b</span><span class="op" id="5923527">[</span><span class="num" id="5923528">1</span><span class="op" id="5923529">]</span>&nbsp;<span class="op" id="5923531">=</span>&nbsp;<span class="builtintype" id="5923533">uint8</span><span class="op" id="5923538">(</span><span class="ident" id="5923539">u</span>&nbsp;<span class="op" id="5923541">&gt;&gt;</span>&nbsp;<span class="num" id="5923544">8</span><span class="op" id="5923545">)</span><br>
<span class="lineno"></span><span class="op" id="5923547">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="5923550">//&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5923582">type</span>&nbsp;<span class="ident" id="5923587">writer</span>&nbsp;<span class="keyword" id="5923594">interface</span>&nbsp;<span class="op" id="5923604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923607">Flush</span><span class="op" id="5923612">(</span><span class="op" id="5923613">)</span>&nbsp;<span class="builtintype" id="5923615">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923622">io</span><span class="op" id="5923624">.</span><span class="ident" id="5923625">Writer</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923633">io</span><span class="op" id="5923635">.</span><span class="ident" id="5923636">ByteWriter</span><br>
<span class="lineno"></span><span class="op" id="5923647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5923650">//&nbsp;encoder&nbsp;encodes&nbsp;an&nbsp;image&nbsp;to&nbsp;the&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="5923697">type</span>&nbsp;<span class="ident" id="5923702">encoder</span>&nbsp;<span class="keyword" id="5923710">struct</span>&nbsp;<span class="op" id="5923717">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5923720">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;to&nbsp;write&nbsp;to.&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5923795">//&nbsp;writing.&nbsp;All&nbsp;attempted&nbsp;writes&nbsp;after&nbsp;the&nbsp;first&nbsp;error&nbsp;become&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923866">w</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5923870">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923878">err</span>&nbsp;<span class="builtintype" id="5923882">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5923889">//&nbsp;g&nbsp;is&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;data&nbsp;that&nbsp;is&nbsp;being&nbsp;encoded.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5923945">g</span>&nbsp;<span class="op" id="5923947">*</span><span class="ident" id="5923948">GIF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5923953">//&nbsp;buf&nbsp;is&nbsp;a&nbsp;scratch&nbsp;buffer.&nbsp;It&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;768&nbsp;so&nbsp;we&nbsp;can&nbsp;write&nbsp;the&nbsp;color&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5924037">buf</span>&nbsp;<span class="op" id="5924041">[</span><span class="num" id="5924042">1024</span><span class="op" id="5924046">]</span><span class="builtintype" id="5924047">byte</span><br>
<span class="lineno"></span><span class="op" id="5924052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5924055">//&nbsp;blockWriter&nbsp;writes&nbsp;the&nbsp;block&nbsp;structure&nbsp;of&nbsp;GIF&nbsp;image&nbsp;data,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="5924122">//&nbsp;comprises&nbsp;(n,&nbsp;(n&nbsp;bytes))&nbsp;blocks,&nbsp;with&nbsp;1&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;255.&nbsp;It&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5924188">//&nbsp;writer&nbsp;given&nbsp;to&nbsp;the&nbsp;LZW&nbsp;encoder,&nbsp;which&nbsp;is&nbsp;thus&nbsp;immune&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5924252">//&nbsp;blocking.</span><br>
<span class="lineno"></span><span class="keyword" id="5924265">type</span>&nbsp;<span class="ident" id="5924270">blockWriter</span>&nbsp;<span class="keyword" id="5924282">struct</span>&nbsp;<span class="op" id="5924289">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5924292">e</span>&nbsp;<span class="op" id="5924294">*</span><span class="ident" id="5924295">encoder</span><br>
<span class="lineno"></span><span class="op" id="5924303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5924306">func</span>&nbsp;<span class="op" id="5924311">(</span><span class="ident" id="5924312">b</span>&nbsp;<span class="ident" id="5924314">blockWriter</span><span class="op" id="5924325">)</span>&nbsp;<span class="ident" id="5924327">Write</span><span class="op" id="5924332">(</span><span class="ident" id="5924333">data</span>&nbsp;<span class="op" id="5924338">[</span><span class="op" id="5924339">]</span><span class="builtintype" id="5924340">byte</span><span class="op" id="5924344">)</span>&nbsp;<span class="op" id="5924346">(</span><span class="builtintype" id="5924347">int</span><span class="op" id="5924350">,</span>&nbsp;<span class="builtintype" id="5924352">error</span><span class="op" id="5924357">)</span>&nbsp;<span class="op" id="5924359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924362">if</span>&nbsp;<span class="ident" id="5924365">b</span><span class="op" id="5924366">.</span><span class="ident" id="5924367">e</span><span class="op" id="5924368">.</span><span class="ident" id="5924369">err</span>&nbsp;<span class="op" id="5924373">!=</span>&nbsp;<span class="ident" id="5924376">nil</span>&nbsp;<span class="op" id="5924380">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924384">return</span>&nbsp;<span class="num" id="5924391">0</span><span class="op" id="5924392">,</span>&nbsp;<span class="ident" id="5924394">b</span><span class="op" id="5924395">.</span><span class="ident" id="5924396">e</span><span class="op" id="5924397">.</span><span class="ident" id="5924398">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5924403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924406">if</span>&nbsp;<span class="builtinfunc" id="5924409">len</span><span class="op" id="5924412">(</span><span class="ident" id="5924413">data</span><span class="op" id="5924417">)</span>&nbsp;<span class="op" id="5924419">==</span>&nbsp;<span class="num" id="5924422">0</span>&nbsp;<span class="op" id="5924424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924428">return</span>&nbsp;<span class="num" id="5924435">0</span><span class="op" id="5924436">,</span>&nbsp;<span class="ident" id="5924438">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5924443">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5924446">total</span>&nbsp;<span class="op" id="5924452">:=</span>&nbsp;<span class="num" id="5924455">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924458">for</span>&nbsp;<span class="ident" id="5924462">total</span>&nbsp;<span class="op" id="5924468">&lt;</span>&nbsp;<span class="builtinfunc" id="5924470">len</span><span class="op" id="5924473">(</span><span class="ident" id="5924474">data</span><span class="op" id="5924478">)</span>&nbsp;<span class="op" id="5924480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5924484">n</span>&nbsp;<span class="op" id="5924486">:=</span>&nbsp;<span class="builtinfunc" id="5924489">copy</span><span class="op" id="5924493">(</span><span class="ident" id="5924494">b</span><span class="op" id="5924495">.</span><span class="ident" id="5924496">e</span><span class="op" id="5924497">.</span><span class="ident" id="5924498">buf</span><span class="op" id="5924501">[</span><span class="num" id="5924502">1</span><span class="op" id="5924503">:</span><span class="num" id="5924504">256</span><span class="op" id="5924507">]</span><span class="op" id="5924508">,</span>&nbsp;<span class="ident" id="5924510">data</span><span class="op" id="5924514">[</span><span class="ident" id="5924515">total</span><span class="op" id="5924520">:</span><span class="op" id="5924521">]</span><span class="op" id="5924522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5924526">total</span>&nbsp;<span class="op" id="5924532">+=</span>&nbsp;<span class="ident" id="5924535">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5924539">b</span><span class="op" id="5924540">.</span><span class="ident" id="5924541">e</span><span class="op" id="5924542">.</span><span class="ident" id="5924543">buf</span><span class="op" id="5924546">[</span><span class="num" id="5924547">0</span><span class="op" id="5924548">]</span>&nbsp;<span class="op" id="5924550">=</span>&nbsp;<span class="builtintype" id="5924552">uint8</span><span class="op" id="5924557">(</span><span class="ident" id="5924558">n</span><span class="op" id="5924559">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5924564">n</span><span class="op" id="5924565">,</span>&nbsp;<span class="ident" id="5924567">b</span><span class="op" id="5924568">.</span><span class="ident" id="5924569">e</span><span class="op" id="5924570">.</span><span class="ident" id="5924571">err</span>&nbsp;<span class="op" id="5924575">=</span>&nbsp;<span class="ident" id="5924577">b</span><span class="op" id="5924578">.</span><span class="ident" id="5924579">e</span><span class="op" id="5924580">.</span><span class="ident" id="5924581">w</span><span class="op" id="5924582">.</span><span class="ident" id="5924583">Write</span><span class="op" id="5924588">(</span><span class="ident" id="5924589">b</span><span class="op" id="5924590">.</span><span class="ident" id="5924591">e</span><span class="op" id="5924592">.</span><span class="ident" id="5924593">buf</span><span class="op" id="5924596">[</span><span class="op" id="5924597">:</span><span class="ident" id="5924598">n</span><span class="op" id="5924599">+</span><span class="num" id="5924600">1</span><span class="op" id="5924601">]</span><span class="op" id="5924602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924606">if</span>&nbsp;<span class="ident" id="5924609">b</span><span class="op" id="5924610">.</span><span class="ident" id="5924611">e</span><span class="op" id="5924612">.</span><span class="ident" id="5924613">err</span>&nbsp;<span class="op" id="5924617">!=</span>&nbsp;<span class="ident" id="5924620">nil</span>&nbsp;<span class="op" id="5924624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924629">return</span>&nbsp;<span class="num" id="5924636">0</span><span class="op" id="5924637">,</span>&nbsp;<span class="ident" id="5924639">b</span><span class="op" id="5924640">.</span><span class="ident" id="5924641">e</span><span class="op" id="5924642">.</span><span class="ident" id="5924643">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5924649">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5924652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924655">return</span>&nbsp;<span class="ident" id="5924662">total</span><span class="op" id="5924667">,</span>&nbsp;<span class="ident" id="5924669">b</span><span class="op" id="5924670">.</span><span class="ident" id="5924671">e</span><span class="op" id="5924672">.</span><span class="ident" id="5924673">err</span><br>
<span class="lineno"></span><span class="op" id="5924677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5924680">func</span>&nbsp;<span class="op" id="5924685">(</span><span class="ident" id="5924686">e</span>&nbsp;<span class="op" id="5924688">*</span><span class="ident" id="5924689">encoder</span><span class="op" id="5924696">)</span>&nbsp;<span class="ident" id="5924698">flush</span><span class="op" id="5924703">(</span><span class="op" id="5924704">)</span>&nbsp;<span class="op" id="5924706">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924709">if</span>&nbsp;<span class="ident" id="5924712">e</span><span class="op" id="5924713">.</span><span class="ident" id="5924714">err</span>&nbsp;<span class="op" id="5924718">!=</span>&nbsp;<span class="ident" id="5924721">nil</span>&nbsp;<span class="op" id="5924725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924729">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5924737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5924740">e</span><span class="op" id="5924741">.</span><span class="ident" id="5924742">err</span>&nbsp;<span class="op" id="5924746">=</span>&nbsp;<span class="ident" id="5924748">e</span><span class="op" id="5924749">.</span><span class="ident" id="5924750">w</span><span class="op" id="5924751">.</span><span class="ident" id="5924752">Flush</span><span class="op" id="5924757">(</span><span class="op" id="5924758">)</span><br>
<span class="lineno"></span><span class="op" id="5924760">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="5924763">func</span>&nbsp;<span class="op" id="5924768">(</span><span class="ident" id="5924769">e</span>&nbsp;<span class="op" id="5924771">*</span><span class="ident" id="5924772">encoder</span><span class="op" id="5924779">)</span>&nbsp;<span class="ident" id="5924781">write</span><span class="op" id="5924786">(</span><span class="ident" id="5924787">p</span>&nbsp;<span class="op" id="5924789">[</span><span class="op" id="5924790">]</span><span class="builtintype" id="5924791">byte</span><span class="op" id="5924795">)</span>&nbsp;<span class="op" id="5924797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924800">if</span>&nbsp;<span class="ident" id="5924803">e</span><span class="op" id="5924804">.</span><span class="ident" id="5924805">err</span>&nbsp;<span class="op" id="5924809">!=</span>&nbsp;<span class="ident" id="5924812">nil</span>&nbsp;<span class="op" id="5924816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924820">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5924828">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5924831">_</span><span class="op" id="5924832">,</span>&nbsp;<span class="ident" id="5924834">e</span><span class="op" id="5924835">.</span><span class="ident" id="5924836">err</span>&nbsp;<span class="op" id="5924840">=</span>&nbsp;<span class="ident" id="5924842">e</span><span class="op" id="5924843">.</span><span class="ident" id="5924844">w</span><span class="op" id="5924845">.</span><span class="ident" id="5924846">Write</span><span class="op" id="5924851">(</span><span class="ident" id="5924852">p</span><span class="op" id="5924853">)</span><br>
<span class="lineno"></span><span class="op" id="5924855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5924858">func</span>&nbsp;<span class="op" id="5924863">(</span><span class="ident" id="5924864">e</span>&nbsp;<span class="op" id="5924866">*</span><span class="ident" id="5924867">encoder</span><span class="op" id="5924874">)</span>&nbsp;<span class="ident" id="5924876">writeByte</span><span class="op" id="5924885">(</span><span class="ident" id="5924886">b</span>&nbsp;<span class="builtintype" id="5924888">byte</span><span class="op" id="5924892">)</span>&nbsp;<span class="op" id="5924894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924897">if</span>&nbsp;<span class="ident" id="5924900">e</span><span class="op" id="5924901">.</span><span class="ident" id="5924902">err</span>&nbsp;<span class="op" id="5924906">!=</span>&nbsp;<span class="ident" id="5924909">nil</span>&nbsp;<span class="op" id="5924913">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924917">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5924925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5924928">e</span><span class="op" id="5924929">.</span><span class="ident" id="5924930">err</span>&nbsp;<span class="op" id="5924934">=</span>&nbsp;<span class="ident" id="5924936">e</span><span class="op" id="5924937">.</span><span class="ident" id="5924938">w</span><span class="op" id="5924939">.</span><span class="ident" id="5924940">WriteByte</span><span class="op" id="5924949">(</span><span class="ident" id="5924950">b</span><span class="op" id="5924951">)</span><br>
<span class="lineno"></span><span class="op" id="5924953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="5924956">func</span>&nbsp;<span class="op" id="5924961">(</span><span class="ident" id="5924962">e</span>&nbsp;<span class="op" id="5924964">*</span><span class="ident" id="5924965">encoder</span><span class="op" id="5924972">)</span>&nbsp;<span class="ident" id="5924974">writeHeader</span><span class="op" id="5924985">(</span><span class="op" id="5924986">)</span>&nbsp;<span class="op" id="5924988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5924991">if</span>&nbsp;<span class="ident" id="5924994">e</span><span class="op" id="5924995">.</span><span class="ident" id="5924996">err</span>&nbsp;<span class="op" id="5925000">!=</span>&nbsp;<span class="ident" id="5925003">nil</span>&nbsp;<span class="op" id="5925007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5925011">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5925019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925022">_</span><span class="op" id="5925023">,</span>&nbsp;<span class="ident" id="5925025">e</span><span class="op" id="5925026">.</span><span class="ident" id="5925027">err</span>&nbsp;<span class="op" id="5925031">=</span>&nbsp;<span class="ident" id="5925033">io</span><span class="op" id="5925035">.</span><span class="ident" id="5925036">WriteString</span><span class="op" id="5925047">(</span><span class="ident" id="5925048">e</span><span class="op" id="5925049">.</span><span class="ident" id="5925050">w</span><span class="op" id="5925051">,</span>&nbsp;<span class="string" id="5925053">&#34;GIF89a&#34;</span><span class="op" id="5925061">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5925064">if</span>&nbsp;<span class="ident" id="5925067">e</span><span class="op" id="5925068">.</span><span class="ident" id="5925069">err</span>&nbsp;<span class="op" id="5925073">!=</span>&nbsp;<span class="ident" id="5925076">nil</span>&nbsp;<span class="op" id="5925080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5925084">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5925092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925096">pm</span>&nbsp;<span class="op" id="5925099">:=</span>&nbsp;<span class="ident" id="5925102">e</span><span class="op" id="5925103">.</span><span class="ident" id="5925104">g</span><span class="op" id="5925105">.</span><span class="ident" id="5925106">Image</span><span class="op" id="5925111">[</span><span class="num" id="5925112">0</span><span class="op" id="5925113">]</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5925116">//&nbsp;Logical&nbsp;screen&nbsp;width&nbsp;and&nbsp;height.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925153">writeUint16</span><span class="op" id="5925164">(</span><span class="ident" id="5925165">e</span><span class="op" id="5925166">.</span><span class="ident" id="5925167">buf</span><span class="op" id="5925170">[</span><span class="num" id="5925171">0</span><span class="op" id="5925172">:</span><span class="num" id="5925173">2</span><span class="op" id="5925174">]</span><span class="op" id="5925175">,</span>&nbsp;<span class="builtintype" id="5925177">uint16</span><span class="op" id="5925183">(</span><span class="ident" id="5925184">pm</span><span class="op" id="5925186">.</span><span class="ident" id="5925187">Bounds</span><span class="op" id="5925193">(</span><span class="op" id="5925194">)</span><span class="op" id="5925195">.</span><span class="ident" id="5925196">Dx</span><span class="op" id="5925198">(</span><span class="op" id="5925199">)</span><span class="op" id="5925200">)</span><span class="op" id="5925201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925204">writeUint16</span><span class="op" id="5925215">(</span><span class="ident" id="5925216">e</span><span class="op" id="5925217">.</span><span class="ident" id="5925218">buf</span><span class="op" id="5925221">[</span><span class="num" id="5925222">2</span><span class="op" id="5925223">:</span><span class="num" id="5925224">4</span><span class="op" id="5925225">]</span><span class="op" id="5925226">,</span>&nbsp;<span class="builtintype" id="5925228">uint16</span><span class="op" id="5925234">(</span><span class="ident" id="5925235">pm</span><span class="op" id="5925237">.</span><span class="ident" id="5925238">Bounds</span><span class="op" id="5925244">(</span><span class="op" id="5925245">)</span><span class="op" id="5925246">.</span><span class="ident" id="5925247">Dy</span><span class="op" id="5925249">(</span><span class="op" id="5925250">)</span><span class="op" id="5925251">)</span><span class="op" id="5925252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925255">e</span><span class="op" id="5925256">.</span><span class="ident" id="5925257">write</span><span class="op" id="5925262">(</span><span class="ident" id="5925263">e</span><span class="op" id="5925264">.</span><span class="ident" id="5925265">buf</span><span class="op" id="5925268">[</span><span class="op" id="5925269">:</span><span class="num" id="5925270">4</span><span class="op" id="5925271">]</span><span class="op" id="5925272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5925276">//&nbsp;All&nbsp;frames&nbsp;have&nbsp;a&nbsp;local&nbsp;color&nbsp;table,&nbsp;so&nbsp;a&nbsp;global&nbsp;color&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5925341">//&nbsp;is&nbsp;not&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925360">e</span><span class="op" id="5925361">.</span><span class="ident" id="5925362">buf</span><span class="op" id="5925365">[</span><span class="num" id="5925366">0</span><span class="op" id="5925367">]</span>&nbsp;<span class="op" id="5925369">=</span>&nbsp;<span class="num" id="5925371">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925377">e</span><span class="op" id="5925378">.</span><span class="ident" id="5925379">buf</span><span class="op" id="5925382">[</span><span class="num" id="5925383">1</span><span class="op" id="5925384">]</span>&nbsp;<span class="op" id="5925386">=</span>&nbsp;<span class="num" id="5925388">0x00</span>&nbsp;<span class="comment" id="5925393">//&nbsp;Background&nbsp;Color&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925421">e</span><span class="op" id="5925422">.</span><span class="ident" id="5925423">buf</span><span class="op" id="5925426">[</span><span class="num" id="5925427">2</span><span class="op" id="5925428">]</span>&nbsp;<span class="op" id="5925430">=</span>&nbsp;<span class="num" id="5925432">0x00</span>&nbsp;<span class="comment" id="5925437">//&nbsp;Pixel&nbsp;Aspect&nbsp;Ratio.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925461">e</span><span class="op" id="5925462">.</span><span class="ident" id="5925463">write</span><span class="op" id="5925468">(</span><span class="ident" id="5925469">e</span><span class="op" id="5925470">.</span><span class="ident" id="5925471">buf</span><span class="op" id="5925474">[</span><span class="op" id="5925475">:</span><span class="num" id="5925476">3</span><span class="op" id="5925477">]</span><span class="op" id="5925478">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5925482">//&nbsp;Add&nbsp;animation&nbsp;info&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5925519">if</span>&nbsp;<span class="builtinfunc" id="5925522">len</span><span class="op" id="5925525">(</span><span class="ident" id="5925526">e</span><span class="op" id="5925527">.</span><span class="ident" id="5925528">g</span><span class="op" id="5925529">.</span><span class="ident" id="5925530">Image</span><span class="op" id="5925535">)</span>&nbsp;<span class="op" id="5925537">&gt;</span>&nbsp;<span class="num" id="5925539">1</span>&nbsp;<span class="op" id="5925541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925545">e</span><span class="op" id="5925546">.</span><span class="ident" id="5925547">buf</span><span class="op" id="5925550">[</span><span class="num" id="5925551">0</span><span class="op" id="5925552">]</span>&nbsp;<span class="op" id="5925554">=</span>&nbsp;<span class="num" id="5925556">0x21</span>&nbsp;<span class="comment" id="5925561">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925588">e</span><span class="op" id="5925589">.</span><span class="ident" id="5925590">buf</span><span class="op" id="5925593">[</span><span class="num" id="5925594">1</span><span class="op" id="5925595">]</span>&nbsp;<span class="op" id="5925597">=</span>&nbsp;<span class="num" id="5925599">0xff</span>&nbsp;<span class="comment" id="5925604">//&nbsp;Application&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925628">e</span><span class="op" id="5925629">.</span><span class="ident" id="5925630">buf</span><span class="op" id="5925633">[</span><span class="num" id="5925634">2</span><span class="op" id="5925635">]</span>&nbsp;<span class="op" id="5925637">=</span>&nbsp;<span class="num" id="5925639">0x0b</span>&nbsp;<span class="comment" id="5925644">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925661">e</span><span class="op" id="5925662">.</span><span class="ident" id="5925663">write</span><span class="op" id="5925668">(</span><span class="ident" id="5925669">e</span><span class="op" id="5925670">.</span><span class="ident" id="5925671">buf</span><span class="op" id="5925674">[</span><span class="op" id="5925675">:</span><span class="num" id="5925676">3</span><span class="op" id="5925677">]</span><span class="op" id="5925678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925682">_</span><span class="op" id="5925683">,</span>&nbsp;<span class="ident" id="5925685">e</span><span class="op" id="5925686">.</span><span class="ident" id="5925687">err</span>&nbsp;<span class="op" id="5925691">=</span>&nbsp;<span class="ident" id="5925693">io</span><span class="op" id="5925695">.</span><span class="ident" id="5925696">WriteString</span><span class="op" id="5925707">(</span><span class="ident" id="5925708">e</span><span class="op" id="5925709">.</span><span class="ident" id="5925710">w</span><span class="op" id="5925711">,</span>&nbsp;<span class="string" id="5925713">&#34;NETSCAPE2.0&#34;</span><span class="op" id="5925726">)</span>&nbsp;<span class="comment" id="5925728">//&nbsp;Application&nbsp;Identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5925757">if</span>&nbsp;<span class="ident" id="5925760">e</span><span class="op" id="5925761">.</span><span class="ident" id="5925762">err</span>&nbsp;<span class="op" id="5925766">!=</span>&nbsp;<span class="ident" id="5925769">nil</span>&nbsp;<span class="op" id="5925773">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5925778">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5925787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925791">e</span><span class="op" id="5925792">.</span><span class="ident" id="5925793">buf</span><span class="op" id="5925796">[</span><span class="num" id="5925797">0</span><span class="op" id="5925798">]</span>&nbsp;<span class="op" id="5925800">=</span>&nbsp;<span class="num" id="5925802">0x03</span>&nbsp;<span class="comment" id="5925807">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925824">e</span><span class="op" id="5925825">.</span><span class="ident" id="5925826">buf</span><span class="op" id="5925829">[</span><span class="num" id="5925830">1</span><span class="op" id="5925831">]</span>&nbsp;<span class="op" id="5925833">=</span>&nbsp;<span class="num" id="5925835">0x01</span>&nbsp;<span class="comment" id="5925840">//&nbsp;Sub-block&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925862">writeUint16</span><span class="op" id="5925873">(</span><span class="ident" id="5925874">e</span><span class="op" id="5925875">.</span><span class="ident" id="5925876">buf</span><span class="op" id="5925879">[</span><span class="num" id="5925880">2</span><span class="op" id="5925881">:</span><span class="num" id="5925882">4</span><span class="op" id="5925883">]</span><span class="op" id="5925884">,</span>&nbsp;<span class="builtintype" id="5925886">uint16</span><span class="op" id="5925892">(</span><span class="ident" id="5925893">e</span><span class="op" id="5925894">.</span><span class="ident" id="5925895">g</span><span class="op" id="5925896">.</span><span class="ident" id="5925897">LoopCount</span><span class="op" id="5925906">)</span><span class="op" id="5925907">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925911">e</span><span class="op" id="5925912">.</span><span class="ident" id="5925913">buf</span><span class="op" id="5925916">[</span><span class="num" id="5925917">4</span><span class="op" id="5925918">]</span>&nbsp;<span class="op" id="5925920">=</span>&nbsp;<span class="num" id="5925922">0x00</span>&nbsp;<span class="comment" id="5925927">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5925950">e</span><span class="op" id="5925951">.</span><span class="ident" id="5925952">write</span><span class="op" id="5925957">(</span><span class="ident" id="5925958">e</span><span class="op" id="5925959">.</span><span class="ident" id="5925960">buf</span><span class="op" id="5925963">[</span><span class="op" id="5925964">:</span><span class="num" id="5925965">5</span><span class="op" id="5925966">]</span><span class="op" id="5925967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5925970">}</span><br>
<span class="lineno"></span><span class="op" id="5925972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="keyword" id="5925975">func</span>&nbsp;<span class="op" id="5925980">(</span><span class="ident" id="5925981">e</span>&nbsp;<span class="op" id="5925983">*</span><span class="ident" id="5925984">encoder</span><span class="op" id="5925991">)</span>&nbsp;<span class="ident" id="5925993">writeColorTable</span><span class="op" id="5926008">(</span><span class="ident" id="5926009">p</span>&nbsp;<span class="ident" id="5926011">color</span><span class="op" id="5926016">.</span><span class="ident" id="5926017">Palette</span><span class="op" id="5926024">,</span>&nbsp;<span class="ident" id="5926026">size</span>&nbsp;<span class="builtintype" id="5926031">int</span><span class="op" id="5926034">)</span>&nbsp;<span class="op" id="5926036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926039">if</span>&nbsp;<span class="ident" id="5926042">e</span><span class="op" id="5926043">.</span><span class="ident" id="5926044">err</span>&nbsp;<span class="op" id="5926048">!=</span>&nbsp;<span class="ident" id="5926051">nil</span>&nbsp;<span class="op" id="5926055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926059">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5926067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926071">for</span>&nbsp;<span class="ident" id="5926075">i</span>&nbsp;<span class="op" id="5926077">:=</span>&nbsp;<span class="num" id="5926080">0</span><span class="op" id="5926081">;</span>&nbsp;<span class="ident" id="5926083">i</span>&nbsp;<span class="op" id="5926085">&lt;</span>&nbsp;<span class="ident" id="5926087">log2Lookup</span><span class="op" id="5926097">[</span><span class="ident" id="5926098">size</span><span class="op" id="5926102">]</span><span class="op" id="5926103">;</span>&nbsp;<span class="ident" id="5926105">i</span><span class="op" id="5926106">++</span>&nbsp;<span class="op" id="5926109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926113">if</span>&nbsp;<span class="ident" id="5926116">i</span>&nbsp;<span class="op" id="5926118">&lt;</span>&nbsp;<span class="builtinfunc" id="5926120">len</span><span class="op" id="5926123">(</span><span class="ident" id="5926124">p</span><span class="op" id="5926125">)</span>&nbsp;<span class="op" id="5926127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926132">r</span><span class="op" id="5926133">,</span>&nbsp;<span class="ident" id="5926135">g</span><span class="op" id="5926136">,</span>&nbsp;<span class="ident" id="5926138">b</span><span class="op" id="5926139">,</span>&nbsp;<span class="ident" id="5926141">_</span>&nbsp;<span class="op" id="5926143">:=</span>&nbsp;<span class="ident" id="5926146">p</span><span class="op" id="5926147">[</span><span class="ident" id="5926148">i</span><span class="op" id="5926149">]</span><span class="op" id="5926150">.</span><span class="ident" id="5926151">RGBA</span><span class="op" id="5926155">(</span><span class="op" id="5926156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926161">e</span><span class="op" id="5926162">.</span><span class="ident" id="5926163">buf</span><span class="op" id="5926166">[</span><span class="num" id="5926167">3</span><span class="op" id="5926168">*</span><span class="ident" id="5926169">i</span><span class="op" id="5926170">+</span><span class="num" id="5926171">0</span><span class="op" id="5926172">]</span>&nbsp;<span class="op" id="5926174">=</span>&nbsp;<span class="builtintype" id="5926176">uint8</span><span class="op" id="5926181">(</span><span class="ident" id="5926182">r</span>&nbsp;<span class="op" id="5926184">&gt;&gt;</span>&nbsp;<span class="num" id="5926187">8</span><span class="op" id="5926188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926193">e</span><span class="op" id="5926194">.</span><span class="ident" id="5926195">buf</span><span class="op" id="5926198">[</span><span class="num" id="5926199">3</span><span class="op" id="5926200">*</span><span class="ident" id="5926201">i</span><span class="op" id="5926202">+</span><span class="num" id="5926203">1</span><span class="op" id="5926204">]</span>&nbsp;<span class="op" id="5926206">=</span>&nbsp;<span class="builtintype" id="5926208">uint8</span><span class="op" id="5926213">(</span><span class="ident" id="5926214">g</span>&nbsp;<span class="op" id="5926216">&gt;&gt;</span>&nbsp;<span class="num" id="5926219">8</span><span class="op" id="5926220">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926225">e</span><span class="op" id="5926226">.</span><span class="ident" id="5926227">buf</span><span class="op" id="5926230">[</span><span class="num" id="5926231">3</span><span class="op" id="5926232">*</span><span class="ident" id="5926233">i</span><span class="op" id="5926234">+</span><span class="num" id="5926235">2</span><span class="op" id="5926236">]</span>&nbsp;<span class="op" id="5926238">=</span>&nbsp;<span class="builtintype" id="5926240">uint8</span><span class="op" id="5926245">(</span><span class="ident" id="5926246">b</span>&nbsp;<span class="op" id="5926248">&gt;&gt;</span>&nbsp;<span class="num" id="5926251">8</span><span class="op" id="5926252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5926256">}</span>&nbsp;<span class="keyword" id="5926258">else</span>&nbsp;<span class="op" id="5926263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5926268">//&nbsp;Pad&nbsp;with&nbsp;black.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926290">e</span><span class="op" id="5926291">.</span><span class="ident" id="5926292">buf</span><span class="op" id="5926295">[</span><span class="num" id="5926296">3</span><span class="op" id="5926297">*</span><span class="ident" id="5926298">i</span><span class="op" id="5926299">+</span><span class="num" id="5926300">0</span><span class="op" id="5926301">]</span>&nbsp;<span class="op" id="5926303">=</span>&nbsp;<span class="num" id="5926305">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926313">e</span><span class="op" id="5926314">.</span><span class="ident" id="5926315">buf</span><span class="op" id="5926318">[</span><span class="num" id="5926319">3</span><span class="op" id="5926320">*</span><span class="ident" id="5926321">i</span><span class="op" id="5926322">+</span><span class="num" id="5926323">1</span><span class="op" id="5926324">]</span>&nbsp;<span class="op" id="5926326">=</span>&nbsp;<span class="num" id="5926328">0x00</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926336">e</span><span class="op" id="5926337">.</span><span class="ident" id="5926338">buf</span><span class="op" id="5926341">[</span><span class="num" id="5926342">3</span><span class="op" id="5926343">*</span><span class="ident" id="5926344">i</span><span class="op" id="5926345">+</span><span class="num" id="5926346">2</span><span class="op" id="5926347">]</span>&nbsp;<span class="op" id="5926349">=</span>&nbsp;<span class="num" id="5926351">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5926358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5926361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926364">e</span><span class="op" id="5926365">.</span><span class="ident" id="5926366">write</span><span class="op" id="5926371">(</span><span class="ident" id="5926372">e</span><span class="op" id="5926373">.</span><span class="ident" id="5926374">buf</span><span class="op" id="5926377">[</span><span class="op" id="5926378">:</span><span class="num" id="5926379">3</span><span class="op" id="5926380">*</span><span class="ident" id="5926381">log2Lookup</span><span class="op" id="5926391">[</span><span class="ident" id="5926392">size</span><span class="op" id="5926396">]</span><span class="op" id="5926397">]</span><span class="op" id="5926398">)</span><br>
<span class="lineno"></span><span class="op" id="5926400">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="5926403">func</span>&nbsp;<span class="op" id="5926408">(</span><span class="ident" id="5926409">e</span>&nbsp;<span class="op" id="5926411">*</span><span class="ident" id="5926412">encoder</span><span class="op" id="5926419">)</span>&nbsp;<span class="ident" id="5926421">writeImageBlock</span><span class="op" id="5926436">(</span><span class="ident" id="5926437">pm</span>&nbsp;<span class="op" id="5926440">*</span><span class="ident" id="5926441">image</span><span class="op" id="5926446">.</span><span class="ident" id="5926447">Paletted</span><span class="op" id="5926455">,</span>&nbsp;<span class="ident" id="5926457">delay</span>&nbsp;<span class="builtintype" id="5926463">int</span><span class="op" id="5926466">)</span>&nbsp;<span class="op" id="5926468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926471">if</span>&nbsp;<span class="ident" id="5926474">e</span><span class="op" id="5926475">.</span><span class="ident" id="5926476">err</span>&nbsp;<span class="op" id="5926480">!=</span>&nbsp;<span class="ident" id="5926483">nil</span>&nbsp;<span class="op" id="5926487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926491">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5926499">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926503">if</span>&nbsp;<span class="builtinfunc" id="5926506">len</span><span class="op" id="5926509">(</span><span class="ident" id="5926510">pm</span><span class="op" id="5926512">.</span><span class="ident" id="5926513">Palette</span><span class="op" id="5926520">)</span>&nbsp;<span class="op" id="5926522">==</span>&nbsp;<span class="num" id="5926525">0</span>&nbsp;<span class="op" id="5926527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926531">e</span><span class="op" id="5926532">.</span><span class="ident" id="5926533">err</span>&nbsp;<span class="op" id="5926537">=</span>&nbsp;<span class="ident" id="5926539">errors</span><span class="op" id="5926545">.</span><span class="ident" id="5926546">New</span><span class="op" id="5926549">(</span><span class="string" id="5926550">&#34;gif:&nbsp;cannot&nbsp;encode&nbsp;image&nbsp;block&nbsp;with&nbsp;empty&nbsp;palette&#34;</span><span class="op" id="5926601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926605">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5926613">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926617">b</span>&nbsp;<span class="op" id="5926619">:=</span>&nbsp;<span class="ident" id="5926622">pm</span><span class="op" id="5926624">.</span><span class="ident" id="5926625">Bounds</span><span class="op" id="5926631">(</span><span class="op" id="5926632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926635">if</span>&nbsp;<span class="ident" id="5926638">b</span><span class="op" id="5926639">.</span><span class="ident" id="5926640">Dx</span><span class="op" id="5926642">(</span><span class="op" id="5926643">)</span>&nbsp;<span class="op" id="5926645">&gt;=</span>&nbsp;<span class="num" id="5926648">1</span><span class="op" id="5926649">&lt;&lt;</span><span class="num" id="5926651">16</span>&nbsp;<span class="op" id="5926654">||</span>&nbsp;<span class="ident" id="5926657">b</span><span class="op" id="5926658">.</span><span class="ident" id="5926659">Dy</span><span class="op" id="5926661">(</span><span class="op" id="5926662">)</span>&nbsp;<span class="op" id="5926664">&gt;=</span>&nbsp;<span class="num" id="5926667">1</span><span class="op" id="5926668">&lt;&lt;</span><span class="num" id="5926670">16</span>&nbsp;<span class="op" id="5926673">||</span>&nbsp;<span class="ident" id="5926676">b</span><span class="op" id="5926677">.</span><span class="ident" id="5926678">Min</span><span class="op" id="5926681">.</span><span class="ident" id="5926682">X</span>&nbsp;<span class="op" id="5926684">&lt;</span>&nbsp;<span class="num" id="5926686">0</span>&nbsp;<span class="op" id="5926688">||</span>&nbsp;<span class="ident" id="5926691">b</span><span class="op" id="5926692">.</span><span class="ident" id="5926693">Min</span><span class="op" id="5926696">.</span><span class="ident" id="5926697">X</span>&nbsp;<span class="op" id="5926699">&gt;=</span>&nbsp;<span class="num" id="5926702">1</span><span class="op" id="5926703">&lt;&lt;</span><span class="num" id="5926705">16</span>&nbsp;<span class="op" id="5926708">||</span>&nbsp;<span class="ident" id="5926711">b</span><span class="op" id="5926712">.</span><span class="ident" id="5926713">Min</span><span class="op" id="5926716">.</span><span class="ident" id="5926717">Y</span>&nbsp;<span class="op" id="5926719">&lt;</span>&nbsp;<span class="num" id="5926721">0</span>&nbsp;<span class="op" id="5926723">||</span>&nbsp;<span class="ident" id="5926726">b</span><span class="op" id="5926727">.</span><span class="ident" id="5926728">Min</span><span class="op" id="5926731">.</span><span class="ident" id="5926732">Y</span>&nbsp;<span class="op" id="5926734">&gt;=</span>&nbsp;<span class="num" id="5926737">1</span><span class="op" id="5926738">&lt;&lt;</span><span class="num" id="5926740">16</span>&nbsp;<span class="op" id="5926743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926747">e</span><span class="op" id="5926748">.</span><span class="ident" id="5926749">err</span>&nbsp;<span class="op" id="5926753">=</span>&nbsp;<span class="ident" id="5926755">errors</span><span class="op" id="5926761">.</span><span class="ident" id="5926762">New</span><span class="op" id="5926765">(</span><span class="string" id="5926766">&#34;gif:&nbsp;image&nbsp;block&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="5926807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926811">return</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5926819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926823">transparentIndex</span>&nbsp;<span class="op" id="5926840">:=</span>&nbsp;<span class="op" id="5926843">-</span><span class="num" id="5926844">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926847">for</span>&nbsp;<span class="ident" id="5926851">i</span><span class="op" id="5926852">,</span>&nbsp;<span class="ident" id="5926854">c</span>&nbsp;<span class="op" id="5926856">:=</span>&nbsp;<span class="keyword" id="5926859">range</span>&nbsp;<span class="ident" id="5926865">pm</span><span class="op" id="5926867">.</span><span class="ident" id="5926868">Palette</span>&nbsp;<span class="op" id="5926876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926880">if</span>&nbsp;<span class="ident" id="5926883">_</span><span class="op" id="5926884">,</span>&nbsp;<span class="ident" id="5926886">_</span><span class="op" id="5926887">,</span>&nbsp;<span class="ident" id="5926889">_</span><span class="op" id="5926890">,</span>&nbsp;<span class="ident" id="5926892">a</span>&nbsp;<span class="op" id="5926894">:=</span>&nbsp;<span class="ident" id="5926897">c</span><span class="op" id="5926898">.</span><span class="ident" id="5926899">RGBA</span><span class="op" id="5926903">(</span><span class="op" id="5926904">)</span><span class="op" id="5926905">;</span>&nbsp;<span class="ident" id="5926907">a</span>&nbsp;<span class="op" id="5926909">==</span>&nbsp;<span class="num" id="5926912">0</span>&nbsp;<span class="op" id="5926914">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5926919">transparentIndex</span>&nbsp;<span class="op" id="5926936">=</span>&nbsp;<span class="ident" id="5926938">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926943">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5926951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5926954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5926958">if</span>&nbsp;<span class="ident" id="5926961">delay</span>&nbsp;<span class="op" id="5926967">&gt;</span>&nbsp;<span class="num" id="5926969">0</span>&nbsp;<span class="op" id="5926971">||</span>&nbsp;<span class="ident" id="5926974">transparentIndex</span>&nbsp;<span class="op" id="5926991">!=</span>&nbsp;<span class="op" id="5926994">-</span><span class="num" id="5926995">1</span>&nbsp;<span class="op" id="5926997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927001">e</span><span class="op" id="5927002">.</span><span class="ident" id="5927003">buf</span><span class="op" id="5927006">[</span><span class="num" id="5927007">0</span><span class="op" id="5927008">]</span>&nbsp;<span class="op" id="5927010">=</span>&nbsp;<span class="ident" id="5927012">sExtension</span>&nbsp;&nbsp;<span class="comment" id="5927024">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927051">e</span><span class="op" id="5927052">.</span><span class="ident" id="5927053">buf</span><span class="op" id="5927056">[</span><span class="num" id="5927057">1</span><span class="op" id="5927058">]</span>&nbsp;<span class="op" id="5927060">=</span>&nbsp;<span class="ident" id="5927062">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5927074">//&nbsp;Graphic&nbsp;Control&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927102">e</span><span class="op" id="5927103">.</span><span class="ident" id="5927104">buf</span><span class="op" id="5927107">[</span><span class="num" id="5927108">2</span><span class="op" id="5927109">]</span>&nbsp;<span class="op" id="5927111">=</span>&nbsp;<span class="ident" id="5927113">gcBlockSize</span>&nbsp;<span class="comment" id="5927125">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5927142">if</span>&nbsp;<span class="ident" id="5927145">transparentIndex</span>&nbsp;<span class="op" id="5927162">!=</span>&nbsp;<span class="op" id="5927165">-</span><span class="num" id="5927166">1</span>&nbsp;<span class="op" id="5927168">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927173">e</span><span class="op" id="5927174">.</span><span class="ident" id="5927175">buf</span><span class="op" id="5927178">[</span><span class="num" id="5927179">3</span><span class="op" id="5927180">]</span>&nbsp;<span class="op" id="5927182">=</span>&nbsp;<span class="num" id="5927184">0x01</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5927191">}</span>&nbsp;<span class="keyword" id="5927193">else</span>&nbsp;<span class="op" id="5927198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927203">e</span><span class="op" id="5927204">.</span><span class="ident" id="5927205">buf</span><span class="op" id="5927208">[</span><span class="num" id="5927209">3</span><span class="op" id="5927210">]</span>&nbsp;<span class="op" id="5927212">=</span>&nbsp;<span class="num" id="5927214">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5927221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927225">writeUint16</span><span class="op" id="5927236">(</span><span class="ident" id="5927237">e</span><span class="op" id="5927238">.</span><span class="ident" id="5927239">buf</span><span class="op" id="5927242">[</span><span class="num" id="5927243">4</span><span class="op" id="5927244">:</span><span class="num" id="5927245">6</span><span class="op" id="5927246">]</span><span class="op" id="5927247">,</span>&nbsp;<span class="builtintype" id="5927249">uint16</span><span class="op" id="5927255">(</span><span class="ident" id="5927256">delay</span><span class="op" id="5927261">)</span><span class="op" id="5927262">)</span>&nbsp;<span class="comment" id="5927264">//&nbsp;Delay&nbsp;Time&nbsp;(1/100ths&nbsp;of&nbsp;a&nbsp;second)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927304">//&nbsp;Transparent&nbsp;color&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5927334">if</span>&nbsp;<span class="ident" id="5927337">transparentIndex</span>&nbsp;<span class="op" id="5927354">!=</span>&nbsp;<span class="op" id="5927357">-</span><span class="num" id="5927358">1</span>&nbsp;<span class="op" id="5927360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927365">e</span><span class="op" id="5927366">.</span><span class="ident" id="5927367">buf</span><span class="op" id="5927370">[</span><span class="num" id="5927371">6</span><span class="op" id="5927372">]</span>&nbsp;<span class="op" id="5927374">=</span>&nbsp;<span class="builtintype" id="5927376">uint8</span><span class="op" id="5927381">(</span><span class="ident" id="5927382">transparentIndex</span><span class="op" id="5927398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5927402">}</span>&nbsp;<span class="keyword" id="5927404">else</span>&nbsp;<span class="op" id="5927409">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927414">e</span><span class="op" id="5927415">.</span><span class="ident" id="5927416">buf</span><span class="op" id="5927419">[</span><span class="num" id="5927420">6</span><span class="op" id="5927421">]</span>&nbsp;<span class="op" id="5927423">=</span>&nbsp;<span class="num" id="5927425">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5927432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927436">e</span><span class="op" id="5927437">.</span><span class="ident" id="5927438">buf</span><span class="op" id="5927441">[</span><span class="num" id="5927442">7</span><span class="op" id="5927443">]</span>&nbsp;<span class="op" id="5927445">=</span>&nbsp;<span class="num" id="5927447">0x00</span>&nbsp;<span class="comment" id="5927452">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927475">e</span><span class="op" id="5927476">.</span><span class="ident" id="5927477">write</span><span class="op" id="5927482">(</span><span class="ident" id="5927483">e</span><span class="op" id="5927484">.</span><span class="ident" id="5927485">buf</span><span class="op" id="5927488">[</span><span class="op" id="5927489">:</span><span class="num" id="5927490">8</span><span class="op" id="5927491">]</span><span class="op" id="5927492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5927495">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927498">e</span><span class="op" id="5927499">.</span><span class="ident" id="5927500">buf</span><span class="op" id="5927503">[</span><span class="num" id="5927504">0</span><span class="op" id="5927505">]</span>&nbsp;<span class="op" id="5927507">=</span>&nbsp;<span class="ident" id="5927509">sImageDescriptor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927527">writeUint16</span><span class="op" id="5927538">(</span><span class="ident" id="5927539">e</span><span class="op" id="5927540">.</span><span class="ident" id="5927541">buf</span><span class="op" id="5927544">[</span><span class="num" id="5927545">1</span><span class="op" id="5927546">:</span><span class="num" id="5927547">3</span><span class="op" id="5927548">]</span><span class="op" id="5927549">,</span>&nbsp;<span class="builtintype" id="5927551">uint16</span><span class="op" id="5927557">(</span><span class="ident" id="5927558">b</span><span class="op" id="5927559">.</span><span class="ident" id="5927560">Min</span><span class="op" id="5927563">.</span><span class="ident" id="5927564">X</span><span class="op" id="5927565">)</span><span class="op" id="5927566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927569">writeUint16</span><span class="op" id="5927580">(</span><span class="ident" id="5927581">e</span><span class="op" id="5927582">.</span><span class="ident" id="5927583">buf</span><span class="op" id="5927586">[</span><span class="num" id="5927587">3</span><span class="op" id="5927588">:</span><span class="num" id="5927589">5</span><span class="op" id="5927590">]</span><span class="op" id="5927591">,</span>&nbsp;<span class="builtintype" id="5927593">uint16</span><span class="op" id="5927599">(</span><span class="ident" id="5927600">b</span><span class="op" id="5927601">.</span><span class="ident" id="5927602">Min</span><span class="op" id="5927605">.</span><span class="ident" id="5927606">Y</span><span class="op" id="5927607">)</span><span class="op" id="5927608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927611">writeUint16</span><span class="op" id="5927622">(</span><span class="ident" id="5927623">e</span><span class="op" id="5927624">.</span><span class="ident" id="5927625">buf</span><span class="op" id="5927628">[</span><span class="num" id="5927629">5</span><span class="op" id="5927630">:</span><span class="num" id="5927631">7</span><span class="op" id="5927632">]</span><span class="op" id="5927633">,</span>&nbsp;<span class="builtintype" id="5927635">uint16</span><span class="op" id="5927641">(</span><span class="ident" id="5927642">b</span><span class="op" id="5927643">.</span><span class="ident" id="5927644">Dx</span><span class="op" id="5927646">(</span><span class="op" id="5927647">)</span><span class="op" id="5927648">)</span><span class="op" id="5927649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927652">writeUint16</span><span class="op" id="5927663">(</span><span class="ident" id="5927664">e</span><span class="op" id="5927665">.</span><span class="ident" id="5927666">buf</span><span class="op" id="5927669">[</span><span class="num" id="5927670">7</span><span class="op" id="5927671">:</span><span class="num" id="5927672">9</span><span class="op" id="5927673">]</span><span class="op" id="5927674">,</span>&nbsp;<span class="builtintype" id="5927676">uint16</span><span class="op" id="5927682">(</span><span class="ident" id="5927683">b</span><span class="op" id="5927684">.</span><span class="ident" id="5927685">Dy</span><span class="op" id="5927687">(</span><span class="op" id="5927688">)</span><span class="op" id="5927689">)</span><span class="op" id="5927690">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927693">e</span><span class="op" id="5927694">.</span><span class="ident" id="5927695">write</span><span class="op" id="5927700">(</span><span class="ident" id="5927701">e</span><span class="op" id="5927702">.</span><span class="ident" id="5927703">buf</span><span class="op" id="5927706">[</span><span class="op" id="5927707">:</span><span class="num" id="5927708">9</span><span class="op" id="5927709">]</span><span class="op" id="5927710">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927714">paddedSize</span>&nbsp;<span class="op" id="5927725">:=</span>&nbsp;<span class="ident" id="5927728">log2</span><span class="op" id="5927732">(</span><span class="builtinfunc" id="5927733">len</span><span class="op" id="5927736">(</span><span class="ident" id="5927737">pm</span><span class="op" id="5927739">.</span><span class="ident" id="5927740">Palette</span><span class="op" id="5927747">)</span><span class="op" id="5927748">)</span>&nbsp;<span class="comment" id="5927750">//&nbsp;Size&nbsp;of&nbsp;Local&nbsp;Color&nbsp;Table:&nbsp;2^(1+n).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927790">//&nbsp;Interlacing&nbsp;is&nbsp;not&nbsp;supported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927824">e</span><span class="op" id="5927825">.</span><span class="ident" id="5927826">writeByte</span><span class="op" id="5927835">(</span><span class="num" id="5927836">0x80</span>&nbsp;<span class="op" id="5927841">|</span>&nbsp;<span class="builtintype" id="5927843">uint8</span><span class="op" id="5927848">(</span><span class="ident" id="5927849">paddedSize</span><span class="op" id="5927859">)</span><span class="op" id="5927860">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927864">//&nbsp;Local&nbsp;Color&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927887">e</span><span class="op" id="5927888">.</span><span class="ident" id="5927889">writeColorTable</span><span class="op" id="5927904">(</span><span class="ident" id="5927905">pm</span><span class="op" id="5927907">.</span><span class="ident" id="5927908">Palette</span><span class="op" id="5927915">,</span>&nbsp;<span class="ident" id="5927917">paddedSize</span><span class="op" id="5927927">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927931">litWidth</span>&nbsp;<span class="op" id="5927940">:=</span>&nbsp;<span class="ident" id="5927943">paddedSize</span>&nbsp;<span class="op" id="5927954">+</span>&nbsp;<span class="num" id="5927956">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5927959">if</span>&nbsp;<span class="ident" id="5927962">litWidth</span>&nbsp;<span class="op" id="5927971">&lt;</span>&nbsp;<span class="num" id="5927973">2</span>&nbsp;<span class="op" id="5927975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927979">litWidth</span>&nbsp;<span class="op" id="5927988">=</span>&nbsp;<span class="num" id="5927990">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5927993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927996">e</span><span class="op" id="5927997">.</span><span class="ident" id="5927998">writeByte</span><span class="op" id="5928007">(</span><span class="builtintype" id="5928008">uint8</span><span class="op" id="5928013">(</span><span class="ident" id="5928014">litWidth</span><span class="op" id="5928022">)</span><span class="op" id="5928023">)</span>&nbsp;<span class="comment" id="5928025">//&nbsp;LZW&nbsp;Minimum&nbsp;Code&nbsp;Size.</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928053">lzww</span>&nbsp;<span class="op" id="5928058">:=</span>&nbsp;<span class="ident" id="5928061">lzw</span><span class="op" id="5928064">.</span><span class="ident" id="5928065">NewWriter</span><span class="op" id="5928074">(</span><span class="ident" id="5928075">blockWriter</span><span class="op" id="5928086">{</span><span class="ident" id="5928087">e</span><span class="op" id="5928088">:</span>&nbsp;<span class="ident" id="5928090">e</span><span class="op" id="5928091">}</span><span class="op" id="5928092">,</span>&nbsp;<span class="ident" id="5928094">lzw</span><span class="op" id="5928097">.</span><span class="ident" id="5928098">LSB</span><span class="op" id="5928101">,</span>&nbsp;<span class="ident" id="5928103">litWidth</span><span class="op" id="5928111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928114">if</span>&nbsp;<span class="ident" id="5928117">dx</span>&nbsp;<span class="op" id="5928120">:=</span>&nbsp;<span class="ident" id="5928123">b</span><span class="op" id="5928124">.</span><span class="ident" id="5928125">Dx</span><span class="op" id="5928127">(</span><span class="op" id="5928128">)</span><span class="op" id="5928129">;</span>&nbsp;<span class="ident" id="5928131">dx</span>&nbsp;<span class="op" id="5928134">==</span>&nbsp;<span class="ident" id="5928137">pm</span><span class="op" id="5928139">.</span><span class="ident" id="5928140">Stride</span>&nbsp;<span class="op" id="5928147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928151">_</span><span class="op" id="5928152">,</span>&nbsp;<span class="ident" id="5928154">e</span><span class="op" id="5928155">.</span><span class="ident" id="5928156">err</span>&nbsp;<span class="op" id="5928160">=</span>&nbsp;<span class="ident" id="5928162">lzww</span><span class="op" id="5928166">.</span><span class="ident" id="5928167">Write</span><span class="op" id="5928172">(</span><span class="ident" id="5928173">pm</span><span class="op" id="5928175">.</span><span class="ident" id="5928176">Pix</span><span class="op" id="5928179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928183">if</span>&nbsp;<span class="ident" id="5928186">e</span><span class="op" id="5928187">.</span><span class="ident" id="5928188">err</span>&nbsp;<span class="op" id="5928192">!=</span>&nbsp;<span class="ident" id="5928195">nil</span>&nbsp;<span class="op" id="5928199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928204">lzww</span><span class="op" id="5928208">.</span><span class="ident" id="5928209">Close</span><span class="op" id="5928214">(</span><span class="op" id="5928215">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928220">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928232">}</span>&nbsp;<span class="keyword" id="5928234">else</span>&nbsp;<span class="op" id="5928239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928243">for</span>&nbsp;<span class="ident" id="5928247">i</span><span class="op" id="5928248">,</span>&nbsp;<span class="ident" id="5928250">y</span>&nbsp;<span class="op" id="5928252">:=</span>&nbsp;<span class="num" id="5928255">0</span><span class="op" id="5928256">,</span>&nbsp;<span class="ident" id="5928258">b</span><span class="op" id="5928259">.</span><span class="ident" id="5928260">Min</span><span class="op" id="5928263">.</span><span class="ident" id="5928264">Y</span><span class="op" id="5928265">;</span>&nbsp;<span class="ident" id="5928267">y</span>&nbsp;<span class="op" id="5928269">&lt;</span>&nbsp;<span class="ident" id="5928271">b</span><span class="op" id="5928272">.</span><span class="ident" id="5928273">Max</span><span class="op" id="5928276">.</span><span class="ident" id="5928277">Y</span><span class="op" id="5928278">;</span>&nbsp;<span class="ident" id="5928280">i</span><span class="op" id="5928281">,</span>&nbsp;<span class="ident" id="5928283">y</span>&nbsp;<span class="op" id="5928285">=</span>&nbsp;<span class="ident" id="5928287">i</span><span class="op" id="5928288">+</span><span class="ident" id="5928289">pm</span><span class="op" id="5928291">.</span><span class="ident" id="5928292">Stride</span><span class="op" id="5928298">,</span>&nbsp;<span class="ident" id="5928300">y</span><span class="op" id="5928301">+</span><span class="num" id="5928302">1</span>&nbsp;<span class="op" id="5928304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928309">_</span><span class="op" id="5928310">,</span>&nbsp;<span class="ident" id="5928312">e</span><span class="op" id="5928313">.</span><span class="ident" id="5928314">err</span>&nbsp;<span class="op" id="5928318">=</span>&nbsp;<span class="ident" id="5928320">lzww</span><span class="op" id="5928324">.</span><span class="ident" id="5928325">Write</span><span class="op" id="5928330">(</span><span class="ident" id="5928331">pm</span><span class="op" id="5928333">.</span><span class="ident" id="5928334">Pix</span><span class="op" id="5928337">[</span><span class="ident" id="5928338">i</span>&nbsp;<span class="op" id="5928340">:</span>&nbsp;<span class="ident" id="5928342">i</span><span class="op" id="5928343">+</span><span class="ident" id="5928344">dx</span><span class="op" id="5928346">]</span><span class="op" id="5928347">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928352">if</span>&nbsp;<span class="ident" id="5928355">e</span><span class="op" id="5928356">.</span><span class="ident" id="5928357">err</span>&nbsp;<span class="op" id="5928361">!=</span>&nbsp;<span class="ident" id="5928364">nil</span>&nbsp;<span class="op" id="5928368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928374">lzww</span><span class="op" id="5928378">.</span><span class="ident" id="5928379">Close</span><span class="op" id="5928384">(</span><span class="op" id="5928385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928391">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928405">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928411">lzww</span><span class="op" id="5928415">.</span><span class="ident" id="5928416">Close</span><span class="op" id="5928421">(</span><span class="op" id="5928422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928425">e</span><span class="op" id="5928426">.</span><span class="ident" id="5928427">writeByte</span><span class="op" id="5928436">(</span><span class="num" id="5928437">0x00</span><span class="op" id="5928441">)</span>&nbsp;<span class="comment" id="5928443">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span><span class="op" id="5928464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="5928467">//&nbsp;Options&nbsp;are&nbsp;the&nbsp;encoding&nbsp;parameters.</span><br>
<span class="lineno"></span><span class="keyword" id="5928507">type</span>&nbsp;<span class="ident" id="5928512">Options</span>&nbsp;<span class="keyword" id="5928520">struct</span>&nbsp;<span class="op" id="5928527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5928530">//&nbsp;NumColors&nbsp;is&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;colors&nbsp;used&nbsp;in&nbsp;the&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5928595">//&nbsp;It&nbsp;ranges&nbsp;from&nbsp;1&nbsp;to&nbsp;256.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928624">NumColors</span>&nbsp;<span class="builtintype" id="5928634">int</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5928640">//&nbsp;Quantizer&nbsp;is&nbsp;used&nbsp;to&nbsp;produce&nbsp;a&nbsp;palette&nbsp;with&nbsp;size&nbsp;NumColors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5928704">//&nbsp;palette.Plan9&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Quantizer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928759">Quantizer</span>&nbsp;<span class="ident" id="5928769">draw</span><span class="op" id="5928773">.</span><span class="ident" id="5928774">Quantizer</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5928786">//&nbsp;Drawer&nbsp;is&nbsp;used&nbsp;to&nbsp;convert&nbsp;the&nbsp;source&nbsp;image&nbsp;to&nbsp;the&nbsp;desired&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5928857">//&nbsp;draw.FloydSteinberg&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Drawer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928915">Drawer</span>&nbsp;<span class="ident" id="5928922">draw</span><span class="op" id="5928926">.</span><span class="ident" id="5928927">Drawer</span><br>
<span class="lineno"></span><span class="op" id="5928934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="5928937">//&nbsp;EncodeAll&nbsp;writes&nbsp;the&nbsp;images&nbsp;in&nbsp;g&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5929001">//&nbsp;given&nbsp;loop&nbsp;count&nbsp;and&nbsp;delay&nbsp;between&nbsp;frames.</span><br>
<span class="lineno"></span><span class="keyword" id="5929047">func</span>&nbsp;<span class="ident" id="5929052">EncodeAll</span><span class="op" id="5929061">(</span><span class="ident" id="5929062">w</span>&nbsp;<span class="ident" id="5929064">io</span><span class="op" id="5929066">.</span><span class="ident" id="5929067">Writer</span><span class="op" id="5929073">,</span>&nbsp;<span class="ident" id="5929075">g</span>&nbsp;<span class="op" id="5929077">*</span><span class="ident" id="5929078">GIF</span><span class="op" id="5929081">)</span>&nbsp;<span class="builtintype" id="5929083">error</span>&nbsp;<span class="op" id="5929089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929092">if</span>&nbsp;<span class="builtinfunc" id="5929095">len</span><span class="op" id="5929098">(</span><span class="ident" id="5929099">g</span><span class="op" id="5929100">.</span><span class="ident" id="5929101">Image</span><span class="op" id="5929106">)</span>&nbsp;<span class="op" id="5929108">==</span>&nbsp;<span class="num" id="5929111">0</span>&nbsp;<span class="op" id="5929113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929117">return</span>&nbsp;<span class="ident" id="5929124">errors</span><span class="op" id="5929130">.</span><span class="ident" id="5929131">New</span><span class="op" id="5929134">(</span><span class="string" id="5929135">&#34;gif:&nbsp;must&nbsp;provide&nbsp;at&nbsp;least&nbsp;one&nbsp;image&#34;</span><span class="op" id="5929173">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929180">if</span>&nbsp;<span class="builtinfunc" id="5929183">len</span><span class="op" id="5929186">(</span><span class="ident" id="5929187">g</span><span class="op" id="5929188">.</span><span class="ident" id="5929189">Image</span><span class="op" id="5929194">)</span>&nbsp;<span class="op" id="5929196">!=</span>&nbsp;<span class="builtinfunc" id="5929199">len</span><span class="op" id="5929202">(</span><span class="ident" id="5929203">g</span><span class="op" id="5929204">.</span><span class="ident" id="5929205">Delay</span><span class="op" id="5929210">)</span>&nbsp;<span class="op" id="5929212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929216">return</span>&nbsp;<span class="ident" id="5929223">errors</span><span class="op" id="5929229">.</span><span class="ident" id="5929230">New</span><span class="op" id="5929233">(</span><span class="string" id="5929234">&#34;gif:&nbsp;mismatched&nbsp;image&nbsp;and&nbsp;delay&nbsp;lengths&#34;</span><span class="op" id="5929275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929278">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929281">if</span>&nbsp;<span class="ident" id="5929284">g</span><span class="op" id="5929285">.</span><span class="ident" id="5929286">LoopCount</span>&nbsp;<span class="op" id="5929296">&lt;</span>&nbsp;<span class="num" id="5929298">0</span>&nbsp;<span class="op" id="5929300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929304">g</span><span class="op" id="5929305">.</span><span class="ident" id="5929306">LoopCount</span>&nbsp;<span class="op" id="5929316">=</span>&nbsp;<span class="num" id="5929318">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929325">e</span>&nbsp;<span class="op" id="5929327">:=</span>&nbsp;<span class="ident" id="5929330">encoder</span><span class="op" id="5929337">{</span><span class="ident" id="5929338">g</span><span class="op" id="5929339">:</span>&nbsp;<span class="ident" id="5929341">g</span><span class="op" id="5929342">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929345">if</span>&nbsp;<span class="ident" id="5929348">ww</span><span class="op" id="5929350">,</span>&nbsp;<span class="ident" id="5929352">ok</span>&nbsp;<span class="op" id="5929355">:=</span>&nbsp;<span class="ident" id="5929358">w</span><span class="op" id="5929359">.</span><span class="op" id="5929360">(</span><span class="ident" id="5929361">writer</span><span class="op" id="5929367">)</span><span class="op" id="5929368">;</span>&nbsp;<span class="ident" id="5929370">ok</span>&nbsp;<span class="op" id="5929373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929377">e</span><span class="op" id="5929378">.</span><span class="ident" id="5929379">w</span>&nbsp;<span class="op" id="5929381">=</span>&nbsp;<span class="ident" id="5929383">ww</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929387">}</span>&nbsp;<span class="keyword" id="5929389">else</span>&nbsp;<span class="op" id="5929394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929398">e</span><span class="op" id="5929399">.</span><span class="ident" id="5929400">w</span>&nbsp;<span class="op" id="5929402">=</span>&nbsp;<span class="ident" id="5929404">bufio</span><span class="op" id="5929409">.</span><span class="ident" id="5929410">NewWriter</span><span class="op" id="5929419">(</span><span class="ident" id="5929420">w</span><span class="op" id="5929421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929424">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929428">e</span><span class="op" id="5929429">.</span><span class="ident" id="5929430">writeHeader</span><span class="op" id="5929441">(</span><span class="op" id="5929442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929445">for</span>&nbsp;<span class="ident" id="5929449">i</span><span class="op" id="5929450">,</span>&nbsp;<span class="ident" id="5929452">pm</span>&nbsp;<span class="op" id="5929455">:=</span>&nbsp;<span class="keyword" id="5929458">range</span>&nbsp;<span class="ident" id="5929464">g</span><span class="op" id="5929465">.</span><span class="ident" id="5929466">Image</span>&nbsp;<span class="op" id="5929472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929476">e</span><span class="op" id="5929477">.</span><span class="ident" id="5929478">writeImageBlock</span><span class="op" id="5929493">(</span><span class="ident" id="5929494">pm</span><span class="op" id="5929496">,</span>&nbsp;<span class="ident" id="5929498">g</span><span class="op" id="5929499">.</span><span class="ident" id="5929500">Delay</span><span class="op" id="5929505">[</span><span class="ident" id="5929506">i</span><span class="op" id="5929507">]</span><span class="op" id="5929508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929511">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929514">e</span><span class="op" id="5929515">.</span><span class="ident" id="5929516">writeByte</span><span class="op" id="5929525">(</span><span class="ident" id="5929526">sTrailer</span><span class="op" id="5929534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929537">e</span><span class="op" id="5929538">.</span><span class="ident" id="5929539">flush</span><span class="op" id="5929544">(</span><span class="op" id="5929545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929548">return</span>&nbsp;<span class="ident" id="5929555">e</span><span class="op" id="5929556">.</span><span class="ident" id="5929557">err</span><br>
<span class="lineno"></span><span class="op" id="5929561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="5929564">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="5929613">func</span>&nbsp;<span class="ident" id="5929618">Encode</span><span class="op" id="5929624">(</span><span class="ident" id="5929625">w</span>&nbsp;<span class="ident" id="5929627">io</span><span class="op" id="5929629">.</span><span class="ident" id="5929630">Writer</span><span class="op" id="5929636">,</span>&nbsp;<span class="ident" id="5929638">m</span>&nbsp;<span class="ident" id="5929640">image</span><span class="op" id="5929645">.</span><span class="ident" id="5929646">Image</span><span class="op" id="5929651">,</span>&nbsp;<span class="ident" id="5929653">o</span>&nbsp;<span class="op" id="5929655">*</span><span class="ident" id="5929656">Options</span><span class="op" id="5929663">)</span>&nbsp;<span class="builtintype" id="5929665">error</span>&nbsp;<span class="op" id="5929671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5929674">//&nbsp;Check&nbsp;for&nbsp;bounds&nbsp;and&nbsp;size&nbsp;restrictions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929718">b</span>&nbsp;<span class="op" id="5929720">:=</span>&nbsp;<span class="ident" id="5929723">m</span><span class="op" id="5929724">.</span><span class="ident" id="5929725">Bounds</span><span class="op" id="5929731">(</span><span class="op" id="5929732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929735">if</span>&nbsp;<span class="ident" id="5929738">b</span><span class="op" id="5929739">.</span><span class="ident" id="5929740">Dx</span><span class="op" id="5929742">(</span><span class="op" id="5929743">)</span>&nbsp;<span class="op" id="5929745">&gt;=</span>&nbsp;<span class="num" id="5929748">1</span><span class="op" id="5929749">&lt;&lt;</span><span class="num" id="5929751">16</span>&nbsp;<span class="op" id="5929754">||</span>&nbsp;<span class="ident" id="5929757">b</span><span class="op" id="5929758">.</span><span class="ident" id="5929759">Dy</span><span class="op" id="5929761">(</span><span class="op" id="5929762">)</span>&nbsp;<span class="op" id="5929764">&gt;=</span>&nbsp;<span class="num" id="5929767">1</span><span class="op" id="5929768">&lt;&lt;</span><span class="num" id="5929770">16</span>&nbsp;<span class="op" id="5929773">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929777">return</span>&nbsp;<span class="ident" id="5929784">errors</span><span class="op" id="5929790">.</span><span class="ident" id="5929791">New</span><span class="op" id="5929794">(</span><span class="string" id="5929795">&#34;gif:&nbsp;image&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="5929830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929837">opts</span>&nbsp;<span class="op" id="5929842">:=</span>&nbsp;<span class="ident" id="5929845">Options</span><span class="op" id="5929852">{</span><span class="op" id="5929853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929856">if</span>&nbsp;<span class="ident" id="5929859">o</span>&nbsp;<span class="op" id="5929861">!=</span>&nbsp;<span class="ident" id="5929864">nil</span>&nbsp;<span class="op" id="5929868">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929872">opts</span>&nbsp;<span class="op" id="5929877">=</span>&nbsp;<span class="op" id="5929879">*</span><span class="ident" id="5929880">o</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929886">if</span>&nbsp;<span class="ident" id="5929889">opts</span><span class="op" id="5929893">.</span><span class="ident" id="5929894">NumColors</span>&nbsp;<span class="op" id="5929904">&lt;</span>&nbsp;<span class="num" id="5929906">1</span>&nbsp;<span class="op" id="5929908">||</span>&nbsp;<span class="num" id="5929911">256</span>&nbsp;<span class="op" id="5929915">&lt;</span>&nbsp;<span class="ident" id="5929917">opts</span><span class="op" id="5929921">.</span><span class="ident" id="5929922">NumColors</span>&nbsp;<span class="op" id="5929932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929936">opts</span><span class="op" id="5929940">.</span><span class="ident" id="5929941">NumColors</span>&nbsp;<span class="op" id="5929951">=</span>&nbsp;<span class="num" id="5929953">256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929958">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929961">if</span>&nbsp;<span class="ident" id="5929964">opts</span><span class="op" id="5929968">.</span><span class="ident" id="5929969">Drawer</span>&nbsp;<span class="op" id="5929976">==</span>&nbsp;<span class="ident" id="5929979">nil</span>&nbsp;<span class="op" id="5929983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929987">opts</span><span class="op" id="5929991">.</span><span class="ident" id="5929992">Drawer</span>&nbsp;<span class="op" id="5929999">=</span>&nbsp;<span class="ident" id="5930001">draw</span><span class="op" id="5930005">.</span><span class="ident" id="5930006">FloydSteinberg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5930022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930026">pm</span><span class="op" id="5930028">,</span>&nbsp;<span class="ident" id="5930030">ok</span>&nbsp;<span class="op" id="5930033">:=</span>&nbsp;<span class="ident" id="5930036">m</span><span class="op" id="5930037">.</span><span class="op" id="5930038">(</span><span class="op" id="5930039">*</span><span class="ident" id="5930040">image</span><span class="op" id="5930045">.</span><span class="ident" id="5930046">Paletted</span><span class="op" id="5930054">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5930057">if</span>&nbsp;<span class="op" id="5930060">!</span><span class="ident" id="5930061">ok</span>&nbsp;<span class="op" id="5930064">||</span>&nbsp;<span class="builtinfunc" id="5930067">len</span><span class="op" id="5930070">(</span><span class="ident" id="5930071">pm</span><span class="op" id="5930073">.</span><span class="ident" id="5930074">Palette</span><span class="op" id="5930081">)</span>&nbsp;<span class="op" id="5930083">&gt;</span>&nbsp;<span class="ident" id="5930085">opts</span><span class="op" id="5930089">.</span><span class="ident" id="5930090">NumColors</span>&nbsp;<span class="op" id="5930100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5930104">//&nbsp;TODO:&nbsp;Pick&nbsp;a&nbsp;better&nbsp;sub-sample&nbsp;of&nbsp;the&nbsp;Plan&nbsp;9&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930163">pm</span>&nbsp;<span class="op" id="5930166">=</span>&nbsp;<span class="ident" id="5930168">image</span><span class="op" id="5930173">.</span><span class="ident" id="5930174">NewPaletted</span><span class="op" id="5930185">(</span><span class="ident" id="5930186">b</span><span class="op" id="5930187">,</span>&nbsp;<span class="ident" id="5930189">palette</span><span class="op" id="5930196">.</span><span class="ident" id="5930197">Plan9</span><span class="op" id="5930202">[</span><span class="op" id="5930203">:</span><span class="ident" id="5930204">opts</span><span class="op" id="5930208">.</span><span class="ident" id="5930209">NumColors</span><span class="op" id="5930218">]</span><span class="op" id="5930219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5930223">if</span>&nbsp;<span class="ident" id="5930226">opts</span><span class="op" id="5930230">.</span><span class="ident" id="5930231">Quantizer</span>&nbsp;<span class="op" id="5930241">!=</span>&nbsp;<span class="ident" id="5930244">nil</span>&nbsp;<span class="op" id="5930248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930253">pm</span><span class="op" id="5930255">.</span><span class="ident" id="5930256">Palette</span>&nbsp;<span class="op" id="5930264">=</span>&nbsp;<span class="ident" id="5930266">opts</span><span class="op" id="5930270">.</span><span class="ident" id="5930271">Quantizer</span><span class="op" id="5930280">.</span><span class="ident" id="5930281">Quantize</span><span class="op" id="5930289">(</span><span class="builtinfunc" id="5930290">make</span><span class="op" id="5930294">(</span><span class="ident" id="5930295">color</span><span class="op" id="5930300">.</span><span class="ident" id="5930301">Palette</span><span class="op" id="5930308">,</span>&nbsp;<span class="num" id="5930310">0</span><span class="op" id="5930311">,</span>&nbsp;<span class="ident" id="5930313">opts</span><span class="op" id="5930317">.</span><span class="ident" id="5930318">NumColors</span><span class="op" id="5930327">)</span><span class="op" id="5930328">,</span>&nbsp;<span class="ident" id="5930330">m</span><span class="op" id="5930331">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5930335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930339">opts</span><span class="op" id="5930343">.</span><span class="ident" id="5930344">Drawer</span><span class="op" id="5930350">.</span><span class="ident" id="5930351">Draw</span><span class="op" id="5930355">(</span><span class="ident" id="5930356">pm</span><span class="op" id="5930358">,</span>&nbsp;<span class="ident" id="5930360">b</span><span class="op" id="5930361">,</span>&nbsp;<span class="ident" id="5930363">m</span><span class="op" id="5930364">,</span>&nbsp;<span class="ident" id="5930366">image</span><span class="op" id="5930371">.</span><span class="ident" id="5930372">ZP</span><span class="op" id="5930374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5930377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5930381">return</span>&nbsp;<span class="ident" id="5930388">EncodeAll</span><span class="op" id="5930397">(</span><span class="ident" id="5930398">w</span><span class="op" id="5930399">,</span>&nbsp;<span class="op" id="5930401">&amp;</span><span class="ident" id="5930402">GIF</span><span class="op" id="5930405">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930409">Image</span><span class="op" id="5930414">:</span>&nbsp;<span class="op" id="5930416">[</span><span class="op" id="5930417">]</span><span class="op" id="5930418">*</span><span class="ident" id="5930419">image</span><span class="op" id="5930424">.</span><span class="ident" id="5930425">Paletted</span><span class="op" id="5930433">{</span><span class="ident" id="5930434">pm</span><span class="op" id="5930436">}</span><span class="op" id="5930437">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930441">Delay</span><span class="op" id="5930446">:</span>&nbsp;<span class="op" id="5930448">[</span><span class="op" id="5930449">]</span><span class="builtintype" id="5930450">int</span><span class="op" id="5930453">{</span><span class="num" id="5930454">0</span><span class="op" id="5930455">}</span><span class="op" id="5930456">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5930459">}</span><span class="op" id="5930460">)</span><br>
<span class="lineno"></span><span class="op" id="5930462">}</span>
</div>
</body>
</html>
