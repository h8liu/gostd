<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6412105">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6412160">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6412214">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6412265">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6412291">package</span>&nbsp;<span class="ident" id="6412299">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6412304">import</span>&nbsp;<span class="op" id="6412311">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412314">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412323">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412330">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412336">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412343">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412355">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412376">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412382">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412393">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412410">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412421">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412432">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412443">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6412454">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6412461">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6412464">func</span>&nbsp;<span class="ident" id="6412469">newRequest</span><span class="op" id="6412479">(</span><span class="ident" id="6412480">httpreq</span>&nbsp;<span class="builtintype" id="6412488">string</span><span class="op" id="6412494">)</span>&nbsp;<span class="op" id="6412496">*</span><span class="ident" id="6412497">http</span><span class="op" id="6412501">.</span><span class="ident" id="6412502">Request</span>&nbsp;<span class="op" id="6412510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412513">buf</span>&nbsp;<span class="op" id="6412517">:=</span>&nbsp;<span class="ident" id="6412520">bufio</span><span class="op" id="6412525">.</span><span class="ident" id="6412526">NewReader</span><span class="op" id="6412535">(</span><span class="ident" id="6412536">strings</span><span class="op" id="6412543">.</span><span class="ident" id="6412544">NewReader</span><span class="op" id="6412553">(</span><span class="ident" id="6412554">httpreq</span><span class="op" id="6412561">)</span><span class="op" id="6412562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412565">req</span><span class="op" id="6412568">,</span>&nbsp;<span class="ident" id="6412570">err</span>&nbsp;<span class="op" id="6412574">:=</span>&nbsp;<span class="ident" id="6412577">http</span><span class="op" id="6412581">.</span><span class="ident" id="6412582">ReadRequest</span><span class="op" id="6412593">(</span><span class="ident" id="6412594">buf</span><span class="op" id="6412597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412600">if</span>&nbsp;<span class="ident" id="6412603">err</span>&nbsp;<span class="op" id="6412607">!=</span>&nbsp;<span class="ident" id="6412610">nil</span>&nbsp;<span class="op" id="6412614">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6412618">panic</span><span class="op" id="6412623">(</span><span class="string" id="6412624">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="6412660">+</span>&nbsp;<span class="ident" id="6412662">httpreq</span><span class="op" id="6412669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6412672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412675">req</span><span class="op" id="6412678">.</span><span class="ident" id="6412679">RemoteAddr</span>&nbsp;<span class="op" id="6412690">=</span>&nbsp;<span class="string" id="6412692">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412703">return</span>&nbsp;<span class="ident" id="6412710">req</span><br>
<span class="lineno"></span><span class="op" id="6412714">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="6412717">func</span>&nbsp;<span class="ident" id="6412722">runCgiTest</span><span class="op" id="6412732">(</span><span class="ident" id="6412733">t</span>&nbsp;<span class="op" id="6412735">*</span><span class="ident" id="6412736">testing</span><span class="op" id="6412743">.</span><span class="ident" id="6412744">T</span><span class="op" id="6412745">,</span>&nbsp;<span class="ident" id="6412747">h</span>&nbsp;<span class="op" id="6412749">*</span><span class="ident" id="6412750">Handler</span><span class="op" id="6412757">,</span>&nbsp;<span class="ident" id="6412759">httpreq</span>&nbsp;<span class="builtintype" id="6412767">string</span><span class="op" id="6412773">,</span>&nbsp;<span class="ident" id="6412775">expectedMap</span>&nbsp;<span class="keyword" id="6412787">map</span><span class="op" id="6412790">[</span><span class="builtintype" id="6412791">string</span><span class="op" id="6412797">]</span><span class="builtintype" id="6412798">string</span><span class="op" id="6412804">)</span>&nbsp;<span class="op" id="6412806">*</span><span class="ident" id="6412807">httptest</span><span class="op" id="6412815">.</span><span class="ident" id="6412816">ResponseRecorder</span>&nbsp;<span class="op" id="6412833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412836">rw</span>&nbsp;<span class="op" id="6412839">:=</span>&nbsp;<span class="ident" id="6412842">httptest</span><span class="op" id="6412850">.</span><span class="ident" id="6412851">NewRecorder</span><span class="op" id="6412862">(</span><span class="op" id="6412863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412866">req</span>&nbsp;<span class="op" id="6412870">:=</span>&nbsp;<span class="ident" id="6412873">newRequest</span><span class="op" id="6412883">(</span><span class="ident" id="6412884">httpreq</span><span class="op" id="6412891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412894">h</span><span class="op" id="6412895">.</span><span class="ident" id="6412896">ServeHTTP</span><span class="op" id="6412905">(</span><span class="ident" id="6412906">rw</span><span class="op" id="6412908">,</span>&nbsp;<span class="ident" id="6412910">req</span><span class="op" id="6412913">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6412917">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412975">m</span>&nbsp;<span class="op" id="6412977">:=</span>&nbsp;<span class="builtinfunc" id="6412980">make</span><span class="op" id="6412984">(</span><span class="keyword" id="6412985">map</span><span class="op" id="6412988">[</span><span class="builtintype" id="6412989">string</span><span class="op" id="6412995">]</span><span class="builtintype" id="6412996">string</span><span class="op" id="6413002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413005">m</span><span class="op" id="6413006">[</span><span class="string" id="6413007">&#34;_body&#34;</span><span class="op" id="6413014">]</span>&nbsp;<span class="op" id="6413016">=</span>&nbsp;<span class="ident" id="6413018">rw</span><span class="op" id="6413020">.</span><span class="ident" id="6413021">Body</span><span class="op" id="6413025">.</span><span class="ident" id="6413026">String</span><span class="op" id="6413032">(</span><span class="op" id="6413033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413036">linesRead</span>&nbsp;<span class="op" id="6413046">:=</span>&nbsp;<span class="num" id="6413049">0</span><br>
<span class="lineno">45</span><span class="ident" id="6413051">readlines</span><span class="op" id="6413060">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413063">for</span>&nbsp;<span class="op" id="6413067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413071">line</span><span class="op" id="6413075">,</span>&nbsp;<span class="ident" id="6413077">err</span>&nbsp;<span class="op" id="6413081">:=</span>&nbsp;<span class="ident" id="6413084">rw</span><span class="op" id="6413086">.</span><span class="ident" id="6413087">Body</span><span class="op" id="6413091">.</span><span class="ident" id="6413092">ReadString</span><span class="op" id="6413102">(</span><span class="string" id="6413103">&#39;\n&#39;</span><span class="op" id="6413107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413111">switch</span>&nbsp;<span class="op" id="6413118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413122">case</span>&nbsp;<span class="ident" id="6413127">err</span>&nbsp;<span class="op" id="6413131">==</span>&nbsp;<span class="ident" id="6413134">io</span><span class="op" id="6413136">.</span><span class="ident" id="6413137">EOF</span><span class="op" id="6413140">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413145">break</span>&nbsp;<span class="ident" id="6413151">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413163">case</span>&nbsp;<span class="ident" id="6413168">err</span>&nbsp;<span class="op" id="6413172">!=</span>&nbsp;<span class="ident" id="6413175">nil</span><span class="op" id="6413178">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413183">t</span><span class="op" id="6413184">.</span><span class="ident" id="6413185">Fatalf</span><span class="op" id="6413191">(</span><span class="string" id="6413192">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="6413231">,</span>&nbsp;<span class="ident" id="6413233">err</span><span class="op" id="6413236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6413240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413244">linesRead</span><span class="op" id="6413253">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413258">trimmedLine</span>&nbsp;<span class="op" id="6413270">:=</span>&nbsp;<span class="ident" id="6413273">strings</span><span class="op" id="6413280">.</span><span class="ident" id="6413281">TrimRight</span><span class="op" id="6413290">(</span><span class="ident" id="6413291">line</span><span class="op" id="6413295">,</span>&nbsp;<span class="string" id="6413297">&#34;\r\n&#34;</span><span class="op" id="6413303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413307">split</span>&nbsp;<span class="op" id="6413313">:=</span>&nbsp;<span class="ident" id="6413316">strings</span><span class="op" id="6413323">.</span><span class="ident" id="6413324">SplitN</span><span class="op" id="6413330">(</span><span class="ident" id="6413331">trimmedLine</span><span class="op" id="6413342">,</span>&nbsp;<span class="string" id="6413344">&#34;=&#34;</span><span class="op" id="6413347">,</span>&nbsp;<span class="num" id="6413349">2</span><span class="op" id="6413350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413354">if</span>&nbsp;<span class="builtinfunc" id="6413357">len</span><span class="op" id="6413360">(</span><span class="ident" id="6413361">split</span><span class="op" id="6413366">)</span>&nbsp;<span class="op" id="6413368">!=</span>&nbsp;<span class="num" id="6413371">2</span>&nbsp;<span class="op" id="6413373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413378">t</span><span class="op" id="6413379">.</span><span class="ident" id="6413380">Fatalf</span><span class="op" id="6413386">(</span><span class="string" id="6413387">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="6413457">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6413463">len</span><span class="op" id="6413466">(</span><span class="ident" id="6413467">split</span><span class="op" id="6413472">)</span><span class="op" id="6413473">,</span>&nbsp;<span class="ident" id="6413475">linesRead</span><span class="op" id="6413484">,</span>&nbsp;<span class="ident" id="6413486">line</span><span class="op" id="6413490">,</span>&nbsp;<span class="ident" id="6413492">m</span><span class="op" id="6413493">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6413497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413501">m</span><span class="op" id="6413502">[</span><span class="ident" id="6413503">split</span><span class="op" id="6413508">[</span><span class="num" id="6413509">0</span><span class="op" id="6413510">]</span><span class="op" id="6413511">]</span>&nbsp;<span class="op" id="6413513">=</span>&nbsp;<span class="ident" id="6413515">split</span><span class="op" id="6413520">[</span><span class="num" id="6413521">1</span><span class="op" id="6413522">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6413525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413529">for</span>&nbsp;<span class="ident" id="6413533">key</span><span class="op" id="6413536">,</span>&nbsp;<span class="ident" id="6413538">expected</span>&nbsp;<span class="op" id="6413547">:=</span>&nbsp;<span class="keyword" id="6413550">range</span>&nbsp;<span class="ident" id="6413556">expectedMap</span>&nbsp;<span class="op" id="6413568">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413572">got</span>&nbsp;<span class="op" id="6413576">:=</span>&nbsp;<span class="ident" id="6413579">m</span><span class="op" id="6413580">[</span><span class="ident" id="6413581">key</span><span class="op" id="6413584">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413588">if</span>&nbsp;<span class="ident" id="6413591">key</span>&nbsp;<span class="op" id="6413595">==</span>&nbsp;<span class="string" id="6413598">&#34;cwd&#34;</span>&nbsp;<span class="op" id="6413604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6413609">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413651">fi1</span><span class="op" id="6413654">,</span>&nbsp;<span class="ident" id="6413656">_</span>&nbsp;<span class="op" id="6413658">:=</span>&nbsp;<span class="ident" id="6413661">os</span><span class="op" id="6413663">.</span><span class="ident" id="6413664">Stat</span><span class="op" id="6413668">(</span><span class="ident" id="6413669">got</span><span class="op" id="6413672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413677">fi2</span><span class="op" id="6413680">,</span>&nbsp;<span class="ident" id="6413682">_</span>&nbsp;<span class="op" id="6413684">:=</span>&nbsp;<span class="ident" id="6413687">os</span><span class="op" id="6413689">.</span><span class="ident" id="6413690">Stat</span><span class="op" id="6413694">(</span><span class="ident" id="6413695">expected</span><span class="op" id="6413703">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413708">if</span>&nbsp;<span class="ident" id="6413711">os</span><span class="op" id="6413713">.</span><span class="ident" id="6413714">SameFile</span><span class="op" id="6413722">(</span><span class="ident" id="6413723">fi1</span><span class="op" id="6413726">,</span>&nbsp;<span class="ident" id="6413728">fi2</span><span class="op" id="6413731">)</span>&nbsp;<span class="op" id="6413733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413739">got</span>&nbsp;<span class="op" id="6413743">=</span>&nbsp;<span class="ident" id="6413745">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6413757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6413761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413765">if</span>&nbsp;<span class="ident" id="6413768">got</span>&nbsp;<span class="op" id="6413772">!=</span>&nbsp;<span class="ident" id="6413775">expected</span>&nbsp;<span class="op" id="6413784">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413789">t</span><span class="op" id="6413790">.</span><span class="ident" id="6413791">Errorf</span><span class="op" id="6413797">(</span><span class="string" id="6413798">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6413830">,</span>&nbsp;<span class="ident" id="6413832">key</span><span class="op" id="6413835">,</span>&nbsp;<span class="ident" id="6413837">got</span><span class="op" id="6413840">,</span>&nbsp;<span class="ident" id="6413842">expected</span><span class="op" id="6413850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6413854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6413857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413860">return</span>&nbsp;<span class="ident" id="6413867">rw</span><br>
<span class="lineno"></span><span class="op" id="6413870">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="6413873">var</span>&nbsp;<span class="ident" id="6413877">cgiTested</span><span class="op" id="6413886">,</span>&nbsp;<span class="ident" id="6413888">cgiWorks</span>&nbsp;<span class="builtintype" id="6413897">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6413903">func</span>&nbsp;<span class="ident" id="6413908">check</span><span class="op" id="6413913">(</span><span class="ident" id="6413914">t</span>&nbsp;<span class="op" id="6413916">*</span><span class="ident" id="6413917">testing</span><span class="op" id="6413924">.</span><span class="ident" id="6413925">T</span><span class="op" id="6413926">)</span>&nbsp;<span class="op" id="6413928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413931">if</span>&nbsp;<span class="op" id="6413934">!</span><span class="ident" id="6413935">cgiTested</span>&nbsp;<span class="op" id="6413945">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413949">cgiTested</span>&nbsp;<span class="op" id="6413959">=</span>&nbsp;<span class="builtintype" id="6413961">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413968">cgiWorks</span>&nbsp;<span class="op" id="6413977">=</span>&nbsp;<span class="ident" id="6413979">exec</span><span class="op" id="6413983">.</span><span class="ident" id="6413984">Command</span><span class="op" id="6413991">(</span><span class="string" id="6413992">&#34;./testdata/test.cgi&#34;</span><span class="op" id="6414013">)</span><span class="op" id="6414014">.</span><span class="ident" id="6414015">Run</span><span class="op" id="6414018">(</span><span class="op" id="6414019">)</span>&nbsp;<span class="op" id="6414021">==</span>&nbsp;<span class="ident" id="6414024">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6414029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414032">if</span>&nbsp;<span class="op" id="6414035">!</span><span class="ident" id="6414036">cgiWorks</span>&nbsp;<span class="op" id="6414045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6414049">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6414093">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414144">t</span><span class="op" id="6414145">.</span><span class="ident" id="6414146">Skip</span><span class="op" id="6414150">(</span><span class="string" id="6414151">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="6414184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6414187">}</span><br>
<span class="lineno"></span><span class="op" id="6414189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6414192">func</span>&nbsp;<span class="ident" id="6414197">TestCGIBasicGet</span><span class="op" id="6414212">(</span><span class="ident" id="6414213">t</span>&nbsp;<span class="op" id="6414215">*</span><span class="ident" id="6414216">testing</span><span class="op" id="6414223">.</span><span class="ident" id="6414224">T</span><span class="op" id="6414225">)</span>&nbsp;<span class="op" id="6414227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414230">check</span><span class="op" id="6414235">(</span><span class="ident" id="6414236">t</span><span class="op" id="6414237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414240">h</span>&nbsp;<span class="op" id="6414242">:=</span>&nbsp;<span class="op" id="6414245">&amp;</span><span class="ident" id="6414246">Handler</span><span class="op" id="6414253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414257">Path</span><span class="op" id="6414261">:</span>&nbsp;<span class="string" id="6414263">&#34;testdata/test.cgi&#34;</span><span class="op" id="6414282">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414286">Root</span><span class="op" id="6414290">:</span>&nbsp;<span class="string" id="6414292">&#34;/test.cgi&#34;</span><span class="op" id="6414303">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6414306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414309">expectedMap</span>&nbsp;<span class="op" id="6414321">:=</span>&nbsp;<span class="keyword" id="6414324">map</span><span class="op" id="6414327">[</span><span class="builtintype" id="6414328">string</span><span class="op" id="6414334">]</span><span class="builtintype" id="6414335">string</span><span class="op" id="6414341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414345">&#34;test&#34;</span><span class="op" id="6414351">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414370">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="6414381">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414385">&#34;param-a&#34;</span><span class="op" id="6414394">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414410">&#34;b&#34;</span><span class="op" id="6414413">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414417">&#34;param-foo&#34;</span><span class="op" id="6414428">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414442">&#34;bar&#34;</span><span class="op" id="6414447">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414451">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="6414474">:</span>&nbsp;<span class="string" id="6414476">&#34;CGI/1.1&#34;</span><span class="op" id="6414485">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414489">&#34;env-HTTP_HOST&#34;</span><span class="op" id="6414504">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414514">&#34;example.com&#34;</span><span class="op" id="6414527">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414531">&#34;env-PATH_INFO&#34;</span><span class="op" id="6414546">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414556">&#34;&#34;</span><span class="op" id="6414558">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414562">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6414580">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414587">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="6414600">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414604">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="6414621">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414629">&#34;1.2.3.4&#34;</span><span class="op" id="6414638">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414642">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="6414659">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414667">&#34;1.2.3.4&#34;</span><span class="op" id="6414676">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414680">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6414700">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414705">&#34;GET&#34;</span><span class="op" id="6414710">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414714">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6414731">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414739">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="6414762">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414766">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6414787">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6414791">&#34;testdata/test.cgi&#34;</span><span class="op" id="6414810">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414814">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6414831">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414839">&#34;/test.cgi&#34;</span><span class="op" id="6414850">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414854">&#34;env-SERVER_NAME&#34;</span><span class="op" id="6414871">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414879">&#34;example.com&#34;</span><span class="op" id="6414892">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414896">&#34;env-SERVER_PORT&#34;</span><span class="op" id="6414913">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6414921">&#34;80&#34;</span><span class="op" id="6414925">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6414929">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="6414950">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6414954">&#34;go&#34;</span><span class="op" id="6414958">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6414961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414964">replay</span>&nbsp;<span class="op" id="6414971">:=</span>&nbsp;<span class="ident" id="6414974">runCgiTest</span><span class="op" id="6414984">(</span><span class="ident" id="6414985">t</span><span class="op" id="6414986">,</span>&nbsp;<span class="ident" id="6414988">h</span><span class="op" id="6414989">,</span>&nbsp;<span class="string" id="6414991">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6415050">,</span>&nbsp;<span class="ident" id="6415052">expectedMap</span><span class="op" id="6415063">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6415067">if</span>&nbsp;<span class="ident" id="6415070">expected</span><span class="op" id="6415078">,</span>&nbsp;<span class="ident" id="6415080">got</span>&nbsp;<span class="op" id="6415084">:=</span>&nbsp;<span class="string" id="6415087">&#34;text/html&#34;</span><span class="op" id="6415098">,</span>&nbsp;<span class="ident" id="6415100">replay</span><span class="op" id="6415106">.</span><span class="ident" id="6415107">Header</span><span class="op" id="6415113">(</span><span class="op" id="6415114">)</span><span class="op" id="6415115">.</span><span class="ident" id="6415116">Get</span><span class="op" id="6415119">(</span><span class="string" id="6415120">&#34;Content-Type&#34;</span><span class="op" id="6415134">)</span><span class="op" id="6415135">;</span>&nbsp;<span class="ident" id="6415137">got</span>&nbsp;<span class="op" id="6415141">!=</span>&nbsp;<span class="ident" id="6415144">expected</span>&nbsp;<span class="op" id="6415153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415157">t</span><span class="op" id="6415158">.</span><span class="ident" id="6415159">Errorf</span><span class="op" id="6415165">(</span><span class="string" id="6415166">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6415205">,</span>&nbsp;<span class="ident" id="6415207">got</span><span class="op" id="6415210">,</span>&nbsp;<span class="ident" id="6415212">expected</span><span class="op" id="6415220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6415223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6415226">if</span>&nbsp;<span class="ident" id="6415229">expected</span><span class="op" id="6415237">,</span>&nbsp;<span class="ident" id="6415239">got</span>&nbsp;<span class="op" id="6415243">:=</span>&nbsp;<span class="string" id="6415246">&#34;X-Test-Value&#34;</span><span class="op" id="6415260">,</span>&nbsp;<span class="ident" id="6415262">replay</span><span class="op" id="6415268">.</span><span class="ident" id="6415269">Header</span><span class="op" id="6415275">(</span><span class="op" id="6415276">)</span><span class="op" id="6415277">.</span><span class="ident" id="6415278">Get</span><span class="op" id="6415281">(</span><span class="string" id="6415282">&#34;X-Test-Header&#34;</span><span class="op" id="6415297">)</span><span class="op" id="6415298">;</span>&nbsp;<span class="ident" id="6415300">got</span>&nbsp;<span class="op" id="6415304">!=</span>&nbsp;<span class="ident" id="6415307">expected</span>&nbsp;<span class="op" id="6415316">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415320">t</span><span class="op" id="6415321">.</span><span class="ident" id="6415322">Errorf</span><span class="op" id="6415328">(</span><span class="string" id="6415329">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6415369">,</span>&nbsp;<span class="ident" id="6415371">got</span><span class="op" id="6415374">,</span>&nbsp;<span class="ident" id="6415376">expected</span><span class="op" id="6415384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6415387">}</span><br>
<span class="lineno"></span><span class="op" id="6415389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6415392">func</span>&nbsp;<span class="ident" id="6415397">TestCGIBasicGetAbsPath</span><span class="op" id="6415419">(</span><span class="ident" id="6415420">t</span>&nbsp;<span class="op" id="6415422">*</span><span class="ident" id="6415423">testing</span><span class="op" id="6415430">.</span><span class="ident" id="6415431">T</span><span class="op" id="6415432">)</span>&nbsp;<span class="op" id="6415434">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415437">check</span><span class="op" id="6415442">(</span><span class="ident" id="6415443">t</span><span class="op" id="6415444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415447">pwd</span><span class="op" id="6415450">,</span>&nbsp;<span class="ident" id="6415452">err</span>&nbsp;<span class="op" id="6415456">:=</span>&nbsp;<span class="ident" id="6415459">os</span><span class="op" id="6415461">.</span><span class="ident" id="6415462">Getwd</span><span class="op" id="6415467">(</span><span class="op" id="6415468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6415471">if</span>&nbsp;<span class="ident" id="6415474">err</span>&nbsp;<span class="op" id="6415478">!=</span>&nbsp;<span class="ident" id="6415481">nil</span>&nbsp;<span class="op" id="6415485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415489">t</span><span class="op" id="6415490">.</span><span class="ident" id="6415491">Fatalf</span><span class="op" id="6415497">(</span><span class="string" id="6415498">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6415515">,</span>&nbsp;<span class="ident" id="6415517">err</span><span class="op" id="6415520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6415523">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415526">h</span>&nbsp;<span class="op" id="6415528">:=</span>&nbsp;<span class="op" id="6415531">&amp;</span><span class="ident" id="6415532">Handler</span><span class="op" id="6415539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415543">Path</span><span class="op" id="6415547">:</span>&nbsp;<span class="ident" id="6415549">pwd</span>&nbsp;<span class="op" id="6415553">+</span>&nbsp;<span class="string" id="6415555">&#34;/testdata/test.cgi&#34;</span><span class="op" id="6415575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415579">Root</span><span class="op" id="6415583">:</span>&nbsp;<span class="string" id="6415585">&#34;/test.cgi&#34;</span><span class="op" id="6415596">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6415599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415602">expectedMap</span>&nbsp;<span class="op" id="6415614">:=</span>&nbsp;<span class="keyword" id="6415617">map</span><span class="op" id="6415620">[</span><span class="builtintype" id="6415621">string</span><span class="op" id="6415627">]</span><span class="builtintype" id="6415628">string</span><span class="op" id="6415634">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6415638">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6415655">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6415661">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="6415684">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6415688">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6415709">:</span>&nbsp;<span class="ident" id="6415711">pwd</span>&nbsp;<span class="op" id="6415715">+</span>&nbsp;<span class="string" id="6415717">&#34;/testdata/test.cgi&#34;</span><span class="op" id="6415737">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6415741">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6415758">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6415764">&#34;/test.cgi&#34;</span><span class="op" id="6415775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6415778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415781">runCgiTest</span><span class="op" id="6415791">(</span><span class="ident" id="6415792">t</span><span class="op" id="6415793">,</span>&nbsp;<span class="ident" id="6415795">h</span><span class="op" id="6415796">,</span>&nbsp;<span class="string" id="6415798">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6415857">,</span>&nbsp;<span class="ident" id="6415859">expectedMap</span><span class="op" id="6415870">)</span><br>
<span class="lineno">145</span><span class="op" id="6415872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6415875">func</span>&nbsp;<span class="ident" id="6415880">TestPathInfo</span><span class="op" id="6415892">(</span><span class="ident" id="6415893">t</span>&nbsp;<span class="op" id="6415895">*</span><span class="ident" id="6415896">testing</span><span class="op" id="6415903">.</span><span class="ident" id="6415904">T</span><span class="op" id="6415905">)</span>&nbsp;<span class="op" id="6415907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415910">check</span><span class="op" id="6415915">(</span><span class="ident" id="6415916">t</span><span class="op" id="6415917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415920">h</span>&nbsp;<span class="op" id="6415922">:=</span>&nbsp;<span class="op" id="6415925">&amp;</span><span class="ident" id="6415926">Handler</span><span class="op" id="6415933">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415937">Path</span><span class="op" id="6415941">:</span>&nbsp;<span class="string" id="6415943">&#34;testdata/test.cgi&#34;</span><span class="op" id="6415962">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415966">Root</span><span class="op" id="6415970">:</span>&nbsp;<span class="string" id="6415972">&#34;/test.cgi&#34;</span><span class="op" id="6415983">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6415986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415989">expectedMap</span>&nbsp;<span class="op" id="6416001">:=</span>&nbsp;<span class="keyword" id="6416004">map</span><span class="op" id="6416007">[</span><span class="builtintype" id="6416008">string</span><span class="op" id="6416014">]</span><span class="builtintype" id="6416015">string</span><span class="op" id="6416021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416025">&#34;param-a&#34;</span><span class="op" id="6416034">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6416048">&#34;b&#34;</span><span class="op" id="6416051">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416055">&#34;env-PATH_INFO&#34;</span><span class="op" id="6416070">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6416078">&#34;/extrapath&#34;</span><span class="op" id="6416090">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416094">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6416112">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6416117">&#34;a=b&#34;</span><span class="op" id="6416122">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416126">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6416143">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6416149">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="6416174">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416178">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6416199">:</span>&nbsp;<span class="string" id="6416201">&#34;testdata/test.cgi&#34;</span><span class="op" id="6416220">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416224">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6416241">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6416247">&#34;/test.cgi&#34;</span><span class="op" id="6416258">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6416261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416264">runCgiTest</span><span class="op" id="6416274">(</span><span class="ident" id="6416275">t</span><span class="op" id="6416276">,</span>&nbsp;<span class="ident" id="6416278">h</span><span class="op" id="6416279">,</span>&nbsp;<span class="string" id="6416281">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6416342">,</span>&nbsp;<span class="ident" id="6416344">expectedMap</span><span class="op" id="6416355">)</span><br>
<span class="lineno"></span><span class="op" id="6416357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6416360">func</span>&nbsp;<span class="ident" id="6416365">TestPathInfoDirRoot</span><span class="op" id="6416384">(</span><span class="ident" id="6416385">t</span>&nbsp;<span class="op" id="6416387">*</span><span class="ident" id="6416388">testing</span><span class="op" id="6416395">.</span><span class="ident" id="6416396">T</span><span class="op" id="6416397">)</span>&nbsp;<span class="op" id="6416399">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416402">check</span><span class="op" id="6416407">(</span><span class="ident" id="6416408">t</span><span class="op" id="6416409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416412">h</span>&nbsp;<span class="op" id="6416414">:=</span>&nbsp;<span class="op" id="6416417">&amp;</span><span class="ident" id="6416418">Handler</span><span class="op" id="6416425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416429">Path</span><span class="op" id="6416433">:</span>&nbsp;<span class="string" id="6416435">&#34;testdata/test.cgi&#34;</span><span class="op" id="6416454">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416458">Root</span><span class="op" id="6416462">:</span>&nbsp;<span class="string" id="6416464">&#34;/myscript/&#34;</span><span class="op" id="6416476">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6416479">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416482">expectedMap</span>&nbsp;<span class="op" id="6416494">:=</span>&nbsp;<span class="keyword" id="6416497">map</span><span class="op" id="6416500">[</span><span class="builtintype" id="6416501">string</span><span class="op" id="6416507">]</span><span class="builtintype" id="6416508">string</span><span class="op" id="6416514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416518">&#34;env-PATH_INFO&#34;</span><span class="op" id="6416533">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6416541">&#34;bar&#34;</span><span class="op" id="6416546">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416550">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6416568">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6416573">&#34;a=b&#34;</span><span class="op" id="6416578">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416582">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6416599">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6416605">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="6416624">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416628">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6416649">:</span>&nbsp;<span class="string" id="6416651">&#34;testdata/test.cgi&#34;</span><span class="op" id="6416670">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416674">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6416691">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6416697">&#34;/myscript/&#34;</span><span class="op" id="6416709">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6416712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416715">runCgiTest</span><span class="op" id="6416725">(</span><span class="ident" id="6416726">t</span><span class="op" id="6416727">,</span>&nbsp;<span class="ident" id="6416729">h</span><span class="op" id="6416730">,</span>&nbsp;<span class="string" id="6416732">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6416787">,</span>&nbsp;<span class="ident" id="6416789">expectedMap</span><span class="op" id="6416800">)</span><br>
<span class="lineno"></span><span class="op" id="6416802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6416805">func</span>&nbsp;<span class="ident" id="6416810">TestDupHeaders</span><span class="op" id="6416824">(</span><span class="ident" id="6416825">t</span>&nbsp;<span class="op" id="6416827">*</span><span class="ident" id="6416828">testing</span><span class="op" id="6416835">.</span><span class="ident" id="6416836">T</span><span class="op" id="6416837">)</span>&nbsp;<span class="op" id="6416839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416842">check</span><span class="op" id="6416847">(</span><span class="ident" id="6416848">t</span><span class="op" id="6416849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416852">h</span>&nbsp;<span class="op" id="6416854">:=</span>&nbsp;<span class="op" id="6416857">&amp;</span><span class="ident" id="6416858">Handler</span><span class="op" id="6416865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416869">Path</span><span class="op" id="6416873">:</span>&nbsp;<span class="string" id="6416875">&#34;testdata/test.cgi&#34;</span><span class="op" id="6416894">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6416897">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416900">expectedMap</span>&nbsp;<span class="op" id="6416912">:=</span>&nbsp;<span class="keyword" id="6416915">map</span><span class="op" id="6416918">[</span><span class="builtintype" id="6416919">string</span><span class="op" id="6416925">]</span><span class="builtintype" id="6416926">string</span><span class="op" id="6416932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416936">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6416953">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6416959">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="6416978">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6416982">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6417003">:</span>&nbsp;<span class="string" id="6417005">&#34;testdata/test.cgi&#34;</span><span class="op" id="6417024">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417028">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="6417045">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6417051">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="6417069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417073">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="6417089">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6417096">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="6417108">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6417111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417114">runCgiTest</span><span class="op" id="6417124">(</span><span class="ident" id="6417125">t</span><span class="op" id="6417126">,</span>&nbsp;<span class="ident" id="6417128">h</span><span class="op" id="6417129">,</span>&nbsp;<span class="string" id="6417131">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="6417165">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417169">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="6417188">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417192">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="6417211">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417215">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="6417230">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417234">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="6417249">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417253">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="6417276">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417280">expectedMap</span><span class="op" id="6417291">)</span><br>
<span class="lineno"></span><span class="op" id="6417293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="6417296">func</span>&nbsp;<span class="ident" id="6417301">TestPathInfoNoRoot</span><span class="op" id="6417319">(</span><span class="ident" id="6417320">t</span>&nbsp;<span class="op" id="6417322">*</span><span class="ident" id="6417323">testing</span><span class="op" id="6417330">.</span><span class="ident" id="6417331">T</span><span class="op" id="6417332">)</span>&nbsp;<span class="op" id="6417334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417337">check</span><span class="op" id="6417342">(</span><span class="ident" id="6417343">t</span><span class="op" id="6417344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417347">h</span>&nbsp;<span class="op" id="6417349">:=</span>&nbsp;<span class="op" id="6417352">&amp;</span><span class="ident" id="6417353">Handler</span><span class="op" id="6417360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417364">Path</span><span class="op" id="6417368">:</span>&nbsp;<span class="string" id="6417370">&#34;testdata/test.cgi&#34;</span><span class="op" id="6417389">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417393">Root</span><span class="op" id="6417397">:</span>&nbsp;<span class="string" id="6417399">&#34;&#34;</span><span class="op" id="6417401">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6417404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417407">expectedMap</span>&nbsp;<span class="op" id="6417419">:=</span>&nbsp;<span class="keyword" id="6417422">map</span><span class="op" id="6417425">[</span><span class="builtintype" id="6417426">string</span><span class="op" id="6417432">]</span><span class="builtintype" id="6417433">string</span><span class="op" id="6417439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417443">&#34;env-PATH_INFO&#34;</span><span class="op" id="6417458">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6417466">&#34;/bar&#34;</span><span class="op" id="6417472">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417476">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6417494">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6417499">&#34;a=b&#34;</span><span class="op" id="6417504">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417508">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6417525">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6417531">&#34;/bar?a=b&#34;</span><span class="op" id="6417541">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417545">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6417566">:</span>&nbsp;<span class="string" id="6417568">&#34;testdata/test.cgi&#34;</span><span class="op" id="6417587">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417591">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6417608">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6417614">&#34;/&#34;</span><span class="op" id="6417617">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6417620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417623">runCgiTest</span><span class="op" id="6417633">(</span><span class="ident" id="6417634">t</span><span class="op" id="6417635">,</span>&nbsp;<span class="ident" id="6417637">h</span><span class="op" id="6417638">,</span>&nbsp;<span class="string" id="6417640">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6417686">,</span>&nbsp;<span class="ident" id="6417688">expectedMap</span><span class="op" id="6417699">)</span><br>
<span class="lineno"></span><span class="op" id="6417701">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6417704">func</span>&nbsp;<span class="ident" id="6417709">TestCGIBasicPost</span><span class="op" id="6417725">(</span><span class="ident" id="6417726">t</span>&nbsp;<span class="op" id="6417728">*</span><span class="ident" id="6417729">testing</span><span class="op" id="6417736">.</span><span class="ident" id="6417737">T</span><span class="op" id="6417738">)</span>&nbsp;<span class="op" id="6417740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417743">check</span><span class="op" id="6417748">(</span><span class="ident" id="6417749">t</span><span class="op" id="6417750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417753">postReq</span>&nbsp;<span class="op" id="6417761">:=</span>&nbsp;<span class="string" id="6417764">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417897">h</span>&nbsp;<span class="op" id="6417899">:=</span>&nbsp;<span class="op" id="6417902">&amp;</span><span class="ident" id="6417903">Handler</span><span class="op" id="6417910">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417914">Path</span><span class="op" id="6417918">:</span>&nbsp;<span class="string" id="6417920">&#34;testdata/test.cgi&#34;</span><span class="op" id="6417939">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417943">Root</span><span class="op" id="6417947">:</span>&nbsp;<span class="string" id="6417949">&#34;/test.cgi&#34;</span><span class="op" id="6417960">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6417963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417966">expectedMap</span>&nbsp;<span class="op" id="6417978">:=</span>&nbsp;<span class="keyword" id="6417981">map</span><span class="op" id="6417984">[</span><span class="builtintype" id="6417985">string</span><span class="op" id="6417991">]</span><span class="builtintype" id="6417992">string</span><span class="op" id="6417998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6418002">&#34;test&#34;</span><span class="op" id="6418008">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6418024">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="6418035">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6418039">&#34;param-postfoo&#34;</span><span class="op" id="6418054">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6418061">&#34;postbar&#34;</span><span class="op" id="6418070">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6418074">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6418094">:</span>&nbsp;<span class="string" id="6418096">&#34;POST&#34;</span><span class="op" id="6418102">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6418106">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="6418126">:</span>&nbsp;<span class="string" id="6418128">&#34;15&#34;</span><span class="op" id="6418132">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6418136">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6418153">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6418158">&#34;/test.cgi?a=b&#34;</span><span class="op" id="6418173">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6418176">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418179">runCgiTest</span><span class="op" id="6418189">(</span><span class="ident" id="6418190">t</span><span class="op" id="6418191">,</span>&nbsp;<span class="ident" id="6418193">h</span><span class="op" id="6418194">,</span>&nbsp;<span class="ident" id="6418196">postReq</span><span class="op" id="6418203">,</span>&nbsp;<span class="ident" id="6418205">expectedMap</span><span class="op" id="6418216">)</span><br>
<span class="lineno"></span><span class="op" id="6418218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6418221">func</span>&nbsp;<span class="ident" id="6418226">chunk</span><span class="op" id="6418231">(</span><span class="ident" id="6418232">s</span>&nbsp;<span class="builtintype" id="6418234">string</span><span class="op" id="6418240">)</span>&nbsp;<span class="builtintype" id="6418242">string</span>&nbsp;<span class="op" id="6418249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6418252">return</span>&nbsp;<span class="ident" id="6418259">fmt</span><span class="op" id="6418262">.</span><span class="ident" id="6418263">Sprintf</span><span class="op" id="6418270">(</span><span class="string" id="6418271">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="6418285">,</span>&nbsp;<span class="builtinfunc" id="6418287">len</span><span class="op" id="6418290">(</span><span class="ident" id="6418291">s</span><span class="op" id="6418292">)</span><span class="op" id="6418293">,</span>&nbsp;<span class="ident" id="6418295">s</span><span class="op" id="6418296">)</span><br>
<span class="lineno">240</span><span class="op" id="6418298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6418301">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="6418349">func</span>&nbsp;<span class="ident" id="6418354">TestCGIPostChunked</span><span class="op" id="6418372">(</span><span class="ident" id="6418373">t</span>&nbsp;<span class="op" id="6418375">*</span><span class="ident" id="6418376">testing</span><span class="op" id="6418383">.</span><span class="ident" id="6418384">T</span><span class="op" id="6418385">)</span>&nbsp;<span class="op" id="6418387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418390">check</span><span class="op" id="6418395">(</span><span class="ident" id="6418396">t</span><span class="op" id="6418397">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418400">postReq</span>&nbsp;<span class="op" id="6418408">:=</span>&nbsp;<span class="string" id="6418411">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="6418536">+</span>&nbsp;<span class="ident" id="6418538">chunk</span><span class="op" id="6418543">(</span><span class="string" id="6418544">&#34;postfoo&#34;</span><span class="op" id="6418553">)</span>&nbsp;<span class="op" id="6418555">+</span>&nbsp;<span class="ident" id="6418557">chunk</span><span class="op" id="6418562">(</span><span class="string" id="6418563">&#34;=&#34;</span><span class="op" id="6418566">)</span>&nbsp;<span class="op" id="6418568">+</span>&nbsp;<span class="ident" id="6418570">chunk</span><span class="op" id="6418575">(</span><span class="string" id="6418576">&#34;postbar&#34;</span><span class="op" id="6418585">)</span>&nbsp;<span class="op" id="6418587">+</span>&nbsp;<span class="ident" id="6418589">chunk</span><span class="op" id="6418594">(</span><span class="string" id="6418595">&#34;&#34;</span><span class="op" id="6418597">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418601">h</span>&nbsp;<span class="op" id="6418603">:=</span>&nbsp;<span class="op" id="6418606">&amp;</span><span class="ident" id="6418607">Handler</span><span class="op" id="6418614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418618">Path</span><span class="op" id="6418622">:</span>&nbsp;<span class="string" id="6418624">&#34;testdata/test.cgi&#34;</span><span class="op" id="6418643">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418647">Root</span><span class="op" id="6418651">:</span>&nbsp;<span class="string" id="6418653">&#34;/test.cgi&#34;</span><span class="op" id="6418664">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6418667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418670">expectedMap</span>&nbsp;<span class="op" id="6418682">:=</span>&nbsp;<span class="keyword" id="6418685">map</span><span class="op" id="6418688">[</span><span class="builtintype" id="6418689">string</span><span class="op" id="6418695">]</span><span class="builtintype" id="6418696">string</span><span class="op" id="6418702">{</span><span class="op" id="6418703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418706">resp</span>&nbsp;<span class="op" id="6418711">:=</span>&nbsp;<span class="ident" id="6418714">runCgiTest</span><span class="op" id="6418724">(</span><span class="ident" id="6418725">t</span><span class="op" id="6418726">,</span>&nbsp;<span class="ident" id="6418728">h</span><span class="op" id="6418729">,</span>&nbsp;<span class="ident" id="6418731">postReq</span><span class="op" id="6418738">,</span>&nbsp;<span class="ident" id="6418740">expectedMap</span><span class="op" id="6418751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6418754">if</span>&nbsp;<span class="ident" id="6418757">got</span><span class="op" id="6418760">,</span>&nbsp;<span class="ident" id="6418762">expected</span>&nbsp;<span class="op" id="6418771">:=</span>&nbsp;<span class="ident" id="6418774">resp</span><span class="op" id="6418778">.</span><span class="ident" id="6418779">Code</span><span class="op" id="6418783">,</span>&nbsp;<span class="ident" id="6418785">http</span><span class="op" id="6418789">.</span><span class="ident" id="6418790">StatusBadRequest</span><span class="op" id="6418806">;</span>&nbsp;<span class="ident" id="6418808">got</span>&nbsp;<span class="op" id="6418812">!=</span>&nbsp;<span class="ident" id="6418815">expected</span>&nbsp;<span class="op" id="6418824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418828">t</span><span class="op" id="6418829">.</span><span class="ident" id="6418830">Fatalf</span><span class="op" id="6418836">(</span><span class="string" id="6418837">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6418898">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418903">expected</span><span class="op" id="6418911">,</span>&nbsp;<span class="ident" id="6418913">got</span><span class="op" id="6418916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6418919">}</span><br>
<span class="lineno"></span><span class="op" id="6418921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6418924">func</span>&nbsp;<span class="ident" id="6418929">TestRedirect</span><span class="op" id="6418941">(</span><span class="ident" id="6418942">t</span>&nbsp;<span class="op" id="6418944">*</span><span class="ident" id="6418945">testing</span><span class="op" id="6418952">.</span><span class="ident" id="6418953">T</span><span class="op" id="6418954">)</span>&nbsp;<span class="op" id="6418956">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418959">check</span><span class="op" id="6418964">(</span><span class="ident" id="6418965">t</span><span class="op" id="6418966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418969">h</span>&nbsp;<span class="op" id="6418971">:=</span>&nbsp;<span class="op" id="6418974">&amp;</span><span class="ident" id="6418975">Handler</span><span class="op" id="6418982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418986">Path</span><span class="op" id="6418990">:</span>&nbsp;<span class="string" id="6418992">&#34;testdata/test.cgi&#34;</span><span class="op" id="6419011">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419015">Root</span><span class="op" id="6419019">:</span>&nbsp;<span class="string" id="6419021">&#34;/test.cgi&#34;</span><span class="op" id="6419032">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419035">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419038">rec</span>&nbsp;<span class="op" id="6419042">:=</span>&nbsp;<span class="ident" id="6419045">runCgiTest</span><span class="op" id="6419055">(</span><span class="ident" id="6419056">t</span><span class="op" id="6419057">,</span>&nbsp;<span class="ident" id="6419059">h</span><span class="op" id="6419060">,</span>&nbsp;<span class="string" id="6419062">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6419129">,</span>&nbsp;<span class="ident" id="6419131">nil</span><span class="op" id="6419134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6419137">if</span>&nbsp;<span class="ident" id="6419140">e</span><span class="op" id="6419141">,</span>&nbsp;<span class="ident" id="6419143">g</span>&nbsp;<span class="op" id="6419145">:=</span>&nbsp;<span class="num" id="6419148">302</span><span class="op" id="6419151">,</span>&nbsp;<span class="ident" id="6419153">rec</span><span class="op" id="6419156">.</span><span class="ident" id="6419157">Code</span><span class="op" id="6419161">;</span>&nbsp;<span class="ident" id="6419163">e</span>&nbsp;<span class="op" id="6419165">!=</span>&nbsp;<span class="ident" id="6419168">g</span>&nbsp;<span class="op" id="6419170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419174">t</span><span class="op" id="6419175">.</span><span class="ident" id="6419176">Errorf</span><span class="op" id="6419182">(</span><span class="string" id="6419183">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6419216">,</span>&nbsp;<span class="ident" id="6419218">e</span><span class="op" id="6419219">,</span>&nbsp;<span class="ident" id="6419221">g</span><span class="op" id="6419222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6419228">if</span>&nbsp;<span class="ident" id="6419231">e</span><span class="op" id="6419232">,</span>&nbsp;<span class="ident" id="6419234">g</span>&nbsp;<span class="op" id="6419236">:=</span>&nbsp;<span class="string" id="6419239">&#34;http://foo.com/&#34;</span><span class="op" id="6419256">,</span>&nbsp;<span class="ident" id="6419258">rec</span><span class="op" id="6419261">.</span><span class="ident" id="6419262">Header</span><span class="op" id="6419268">(</span><span class="op" id="6419269">)</span><span class="op" id="6419270">.</span><span class="ident" id="6419271">Get</span><span class="op" id="6419274">(</span><span class="string" id="6419275">&#34;Location&#34;</span><span class="op" id="6419285">)</span><span class="op" id="6419286">;</span>&nbsp;<span class="ident" id="6419288">e</span>&nbsp;<span class="op" id="6419290">!=</span>&nbsp;<span class="ident" id="6419293">g</span>&nbsp;<span class="op" id="6419295">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419299">t</span><span class="op" id="6419300">.</span><span class="ident" id="6419301">Errorf</span><span class="op" id="6419307">(</span><span class="string" id="6419308">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6419348">,</span>&nbsp;<span class="ident" id="6419350">e</span><span class="op" id="6419351">,</span>&nbsp;<span class="ident" id="6419353">g</span><span class="op" id="6419354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419357">}</span><br>
<span class="lineno"></span><span class="op" id="6419359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6419362">func</span>&nbsp;<span class="ident" id="6419367">TestInternalRedirect</span><span class="op" id="6419387">(</span><span class="ident" id="6419388">t</span>&nbsp;<span class="op" id="6419390">*</span><span class="ident" id="6419391">testing</span><span class="op" id="6419398">.</span><span class="ident" id="6419399">T</span><span class="op" id="6419400">)</span>&nbsp;<span class="op" id="6419402">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419405">check</span><span class="op" id="6419410">(</span><span class="ident" id="6419411">t</span><span class="op" id="6419412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419415">baseHandler</span>&nbsp;<span class="op" id="6419427">:=</span>&nbsp;<span class="ident" id="6419430">http</span><span class="op" id="6419434">.</span><span class="ident" id="6419435">HandlerFunc</span><span class="op" id="6419446">(</span><span class="keyword" id="6419447">func</span><span class="op" id="6419451">(</span><span class="ident" id="6419452">rw</span>&nbsp;<span class="ident" id="6419455">http</span><span class="op" id="6419459">.</span><span class="ident" id="6419460">ResponseWriter</span><span class="op" id="6419474">,</span>&nbsp;<span class="ident" id="6419476">req</span>&nbsp;<span class="op" id="6419480">*</span><span class="ident" id="6419481">http</span><span class="op" id="6419485">.</span><span class="ident" id="6419486">Request</span><span class="op" id="6419493">)</span>&nbsp;<span class="op" id="6419495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419499">fmt</span><span class="op" id="6419502">.</span><span class="ident" id="6419503">Fprintf</span><span class="op" id="6419510">(</span><span class="ident" id="6419511">rw</span><span class="op" id="6419513">,</span>&nbsp;<span class="string" id="6419515">&#34;basepath=%s\n&#34;</span><span class="op" id="6419530">,</span>&nbsp;<span class="ident" id="6419532">req</span><span class="op" id="6419535">.</span><span class="ident" id="6419536">URL</span><span class="op" id="6419539">.</span><span class="ident" id="6419540">Path</span><span class="op" id="6419544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419548">fmt</span><span class="op" id="6419551">.</span><span class="ident" id="6419552">Fprintf</span><span class="op" id="6419559">(</span><span class="ident" id="6419560">rw</span><span class="op" id="6419562">,</span>&nbsp;<span class="string" id="6419564">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="6419581">,</span>&nbsp;<span class="ident" id="6419583">req</span><span class="op" id="6419586">.</span><span class="ident" id="6419587">RemoteAddr</span><span class="op" id="6419597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419600">}</span><span class="op" id="6419601">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419604">h</span>&nbsp;<span class="op" id="6419606">:=</span>&nbsp;<span class="op" id="6419609">&amp;</span><span class="ident" id="6419610">Handler</span><span class="op" id="6419617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419621">Path</span><span class="op" id="6419625">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6419642">&#34;testdata/test.cgi&#34;</span><span class="op" id="6419661">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419665">Root</span><span class="op" id="6419669">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6419686">&#34;/test.cgi&#34;</span><span class="op" id="6419697">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419701">PathLocationHandler</span><span class="op" id="6419720">:</span>&nbsp;<span class="ident" id="6419722">baseHandler</span><span class="op" id="6419733">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419736">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419739">expectedMap</span>&nbsp;<span class="op" id="6419751">:=</span>&nbsp;<span class="keyword" id="6419754">map</span><span class="op" id="6419757">[</span><span class="builtintype" id="6419758">string</span><span class="op" id="6419764">]</span><span class="builtintype" id="6419765">string</span><span class="op" id="6419771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6419775">&#34;basepath&#34;</span><span class="op" id="6419785">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6419789">&#34;/foo&#34;</span><span class="op" id="6419795">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6419799">&#34;remoteaddr&#34;</span><span class="op" id="6419811">:</span>&nbsp;<span class="string" id="6419813">&#34;1.2.3.4&#34;</span><span class="op" id="6419822">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419828">runCgiTest</span><span class="op" id="6419838">(</span><span class="ident" id="6419839">t</span><span class="op" id="6419840">,</span>&nbsp;<span class="ident" id="6419842">h</span><span class="op" id="6419843">,</span>&nbsp;<span class="string" id="6419845">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6419901">,</span>&nbsp;<span class="ident" id="6419903">expectedMap</span><span class="op" id="6419914">)</span><br>
<span class="lineno">295</span><span class="op" id="6419916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6419919">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="6419995">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="6420058">func</span>&nbsp;<span class="ident" id="6420063">TestCopyError</span><span class="op" id="6420076">(</span><span class="ident" id="6420077">t</span>&nbsp;<span class="op" id="6420079">*</span><span class="ident" id="6420080">testing</span><span class="op" id="6420087">.</span><span class="ident" id="6420088">T</span><span class="op" id="6420089">)</span>&nbsp;<span class="op" id="6420091">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420094">check</span><span class="op" id="6420099">(</span><span class="ident" id="6420100">t</span><span class="op" id="6420101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420104">if</span>&nbsp;<span class="ident" id="6420107">runtime</span><span class="op" id="6420114">.</span><span class="ident" id="6420115">GOOS</span>&nbsp;<span class="op" id="6420120">==</span>&nbsp;<span class="string" id="6420123">&#34;windows&#34;</span>&nbsp;<span class="op" id="6420133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420137">t</span><span class="op" id="6420138">.</span><span class="ident" id="6420139">Skipf</span><span class="op" id="6420144">(</span><span class="string" id="6420145">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6420166">,</span>&nbsp;<span class="ident" id="6420168">runtime</span><span class="op" id="6420175">.</span><span class="ident" id="6420176">GOOS</span><span class="op" id="6420180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6420183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420186">h</span>&nbsp;<span class="op" id="6420188">:=</span>&nbsp;<span class="op" id="6420191">&amp;</span><span class="ident" id="6420192">Handler</span><span class="op" id="6420199">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420203">Path</span><span class="op" id="6420207">:</span>&nbsp;<span class="string" id="6420209">&#34;testdata/test.cgi&#34;</span><span class="op" id="6420228">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420232">Root</span><span class="op" id="6420236">:</span>&nbsp;<span class="string" id="6420238">&#34;/test.cgi&#34;</span><span class="op" id="6420249">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6420252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420255">ts</span>&nbsp;<span class="op" id="6420258">:=</span>&nbsp;<span class="ident" id="6420261">httptest</span><span class="op" id="6420269">.</span><span class="ident" id="6420270">NewServer</span><span class="op" id="6420279">(</span><span class="ident" id="6420280">h</span><span class="op" id="6420281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420284">defer</span>&nbsp;<span class="ident" id="6420290">ts</span><span class="op" id="6420292">.</span><span class="ident" id="6420293">Close</span><span class="op" id="6420298">(</span><span class="op" id="6420299">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420303">conn</span><span class="op" id="6420307">,</span>&nbsp;<span class="ident" id="6420309">err</span>&nbsp;<span class="op" id="6420313">:=</span>&nbsp;<span class="ident" id="6420316">net</span><span class="op" id="6420319">.</span><span class="ident" id="6420320">Dial</span><span class="op" id="6420324">(</span><span class="string" id="6420325">&#34;tcp&#34;</span><span class="op" id="6420330">,</span>&nbsp;<span class="ident" id="6420332">ts</span><span class="op" id="6420334">.</span><span class="ident" id="6420335">Listener</span><span class="op" id="6420343">.</span><span class="ident" id="6420344">Addr</span><span class="op" id="6420348">(</span><span class="op" id="6420349">)</span><span class="op" id="6420350">.</span><span class="ident" id="6420351">String</span><span class="op" id="6420357">(</span><span class="op" id="6420358">)</span><span class="op" id="6420359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420362">if</span>&nbsp;<span class="ident" id="6420365">err</span>&nbsp;<span class="op" id="6420369">!=</span>&nbsp;<span class="ident" id="6420372">nil</span>&nbsp;<span class="op" id="6420376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420380">t</span><span class="op" id="6420381">.</span><span class="ident" id="6420382">Fatal</span><span class="op" id="6420387">(</span><span class="ident" id="6420388">err</span><span class="op" id="6420391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6420394">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420397">req</span><span class="op" id="6420400">,</span>&nbsp;<span class="ident" id="6420402">_</span>&nbsp;<span class="op" id="6420404">:=</span>&nbsp;<span class="ident" id="6420407">http</span><span class="op" id="6420411">.</span><span class="ident" id="6420412">NewRequest</span><span class="op" id="6420422">(</span><span class="string" id="6420423">&#34;GET&#34;</span><span class="op" id="6420428">,</span>&nbsp;<span class="string" id="6420430">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="6420473">,</span>&nbsp;<span class="ident" id="6420475">nil</span><span class="op" id="6420478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420481">err</span>&nbsp;<span class="op" id="6420485">=</span>&nbsp;<span class="ident" id="6420487">req</span><span class="op" id="6420490">.</span><span class="ident" id="6420491">Write</span><span class="op" id="6420496">(</span><span class="ident" id="6420497">conn</span><span class="op" id="6420501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420504">if</span>&nbsp;<span class="ident" id="6420507">err</span>&nbsp;<span class="op" id="6420511">!=</span>&nbsp;<span class="ident" id="6420514">nil</span>&nbsp;<span class="op" id="6420518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420522">t</span><span class="op" id="6420523">.</span><span class="ident" id="6420524">Fatalf</span><span class="op" id="6420530">(</span><span class="string" id="6420531">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="6420542">,</span>&nbsp;<span class="ident" id="6420544">err</span><span class="op" id="6420547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6420550">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420554">res</span><span class="op" id="6420557">,</span>&nbsp;<span class="ident" id="6420559">err</span>&nbsp;<span class="op" id="6420563">:=</span>&nbsp;<span class="ident" id="6420566">http</span><span class="op" id="6420570">.</span><span class="ident" id="6420571">ReadResponse</span><span class="op" id="6420583">(</span><span class="ident" id="6420584">bufio</span><span class="op" id="6420589">.</span><span class="ident" id="6420590">NewReader</span><span class="op" id="6420599">(</span><span class="ident" id="6420600">conn</span><span class="op" id="6420604">)</span><span class="op" id="6420605">,</span>&nbsp;<span class="ident" id="6420607">req</span><span class="op" id="6420610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420613">if</span>&nbsp;<span class="ident" id="6420616">err</span>&nbsp;<span class="op" id="6420620">!=</span>&nbsp;<span class="ident" id="6420623">nil</span>&nbsp;<span class="op" id="6420627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420631">t</span><span class="op" id="6420632">.</span><span class="ident" id="6420633">Fatalf</span><span class="op" id="6420639">(</span><span class="string" id="6420640">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="6420658">,</span>&nbsp;<span class="ident" id="6420660">err</span><span class="op" id="6420663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6420666">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420670">pidstr</span>&nbsp;<span class="op" id="6420677">:=</span>&nbsp;<span class="ident" id="6420680">res</span><span class="op" id="6420683">.</span><span class="ident" id="6420684">Header</span><span class="op" id="6420690">.</span><span class="ident" id="6420691">Get</span><span class="op" id="6420694">(</span><span class="string" id="6420695">&#34;X-CGI-Pid&#34;</span><span class="op" id="6420706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420709">if</span>&nbsp;<span class="ident" id="6420712">pidstr</span>&nbsp;<span class="op" id="6420719">==</span>&nbsp;<span class="string" id="6420722">&#34;&#34;</span>&nbsp;<span class="op" id="6420725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420729">t</span><span class="op" id="6420730">.</span><span class="ident" id="6420731">Fatalf</span><span class="op" id="6420737">(</span><span class="string" id="6420738">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="6420780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6420783">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420786">pid</span><span class="op" id="6420789">,</span>&nbsp;<span class="ident" id="6420791">err</span>&nbsp;<span class="op" id="6420795">:=</span>&nbsp;<span class="ident" id="6420798">strconv</span><span class="op" id="6420805">.</span><span class="ident" id="6420806">Atoi</span><span class="op" id="6420810">(</span><span class="ident" id="6420811">pidstr</span><span class="op" id="6420817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420820">if</span>&nbsp;<span class="ident" id="6420823">err</span>&nbsp;<span class="op" id="6420827">!=</span>&nbsp;<span class="ident" id="6420830">nil</span>&nbsp;<span class="op" id="6420834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420838">t</span><span class="op" id="6420839">.</span><span class="ident" id="6420840">Fatalf</span><span class="op" id="6420846">(</span><span class="string" id="6420847">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="6420872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6420875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420879">var</span>&nbsp;<span class="ident" id="6420883">buf</span>&nbsp;<span class="op" id="6420887">[</span><span class="num" id="6420888">5000</span><span class="op" id="6420892">]</span><span class="builtintype" id="6420893">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420899">n</span><span class="op" id="6420900">,</span>&nbsp;<span class="ident" id="6420902">err</span>&nbsp;<span class="op" id="6420906">:=</span>&nbsp;<span class="ident" id="6420909">io</span><span class="op" id="6420911">.</span><span class="ident" id="6420912">ReadFull</span><span class="op" id="6420920">(</span><span class="ident" id="6420921">res</span><span class="op" id="6420924">.</span><span class="ident" id="6420925">Body</span><span class="op" id="6420929">,</span>&nbsp;<span class="ident" id="6420931">buf</span><span class="op" id="6420934">[</span><span class="op" id="6420935">:</span><span class="op" id="6420936">]</span><span class="op" id="6420937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420940">if</span>&nbsp;<span class="ident" id="6420943">err</span>&nbsp;<span class="op" id="6420947">!=</span>&nbsp;<span class="ident" id="6420950">nil</span>&nbsp;<span class="op" id="6420954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420958">t</span><span class="op" id="6420959">.</span><span class="ident" id="6420960">Fatalf</span><span class="op" id="6420966">(</span><span class="string" id="6420967">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="6420991">,</span>&nbsp;<span class="ident" id="6420993">n</span><span class="op" id="6420994">,</span>&nbsp;<span class="ident" id="6420996">err</span><span class="op" id="6420999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6421002">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421006">childRunning</span>&nbsp;<span class="op" id="6421019">:=</span>&nbsp;<span class="keyword" id="6421022">func</span><span class="op" id="6421026">(</span><span class="op" id="6421027">)</span>&nbsp;<span class="builtintype" id="6421029">bool</span>&nbsp;<span class="op" id="6421034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6421038">return</span>&nbsp;<span class="ident" id="6421045">isProcessRunning</span><span class="op" id="6421061">(</span><span class="ident" id="6421062">t</span><span class="op" id="6421063">,</span>&nbsp;<span class="ident" id="6421065">pid</span><span class="op" id="6421068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6421071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6421075">if</span>&nbsp;<span class="op" id="6421078">!</span><span class="ident" id="6421079">childRunning</span><span class="op" id="6421091">(</span><span class="op" id="6421092">)</span>&nbsp;<span class="op" id="6421094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421098">t</span><span class="op" id="6421099">.</span><span class="ident" id="6421100">Fatalf</span><span class="op" id="6421106">(</span><span class="string" id="6421107">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="6421153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6421156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421159">conn</span><span class="op" id="6421163">.</span><span class="ident" id="6421164">Close</span><span class="op" id="6421169">(</span><span class="op" id="6421170">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421174">tries</span>&nbsp;<span class="op" id="6421180">:=</span>&nbsp;<span class="num" id="6421183">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6421186">for</span>&nbsp;<span class="ident" id="6421190">tries</span>&nbsp;<span class="op" id="6421196">&lt;</span>&nbsp;<span class="num" id="6421198">25</span>&nbsp;<span class="op" id="6421201">&amp;&amp;</span>&nbsp;<span class="ident" id="6421204">childRunning</span><span class="op" id="6421216">(</span><span class="op" id="6421217">)</span>&nbsp;<span class="op" id="6421219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421223">time</span><span class="op" id="6421227">.</span><span class="ident" id="6421228">Sleep</span><span class="op" id="6421233">(</span><span class="num" id="6421234">50</span>&nbsp;<span class="op" id="6421237">*</span>&nbsp;<span class="ident" id="6421239">time</span><span class="op" id="6421243">.</span><span class="ident" id="6421244">Millisecond</span>&nbsp;<span class="op" id="6421256">*</span>&nbsp;<span class="ident" id="6421258">time</span><span class="op" id="6421262">.</span><span class="ident" id="6421263">Duration</span><span class="op" id="6421271">(</span><span class="ident" id="6421272">tries</span><span class="op" id="6421277">)</span><span class="op" id="6421278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421282">tries</span><span class="op" id="6421287">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6421291">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6421294">if</span>&nbsp;<span class="ident" id="6421297">childRunning</span><span class="op" id="6421309">(</span><span class="op" id="6421310">)</span>&nbsp;<span class="op" id="6421312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421316">t</span><span class="op" id="6421317">.</span><span class="ident" id="6421318">Fatalf</span><span class="op" id="6421324">(</span><span class="string" id="6421325">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="6421369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6421372">}</span><br>
<span class="lineno"></span><span class="op" id="6421374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="6421377">func</span>&nbsp;<span class="ident" id="6421382">TestDirUnix</span><span class="op" id="6421393">(</span><span class="ident" id="6421394">t</span>&nbsp;<span class="op" id="6421396">*</span><span class="ident" id="6421397">testing</span><span class="op" id="6421404">.</span><span class="ident" id="6421405">T</span><span class="op" id="6421406">)</span>&nbsp;<span class="op" id="6421408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421411">check</span><span class="op" id="6421416">(</span><span class="ident" id="6421417">t</span><span class="op" id="6421418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6421421">if</span>&nbsp;<span class="ident" id="6421424">runtime</span><span class="op" id="6421431">.</span><span class="ident" id="6421432">GOOS</span>&nbsp;<span class="op" id="6421437">==</span>&nbsp;<span class="string" id="6421440">&#34;windows&#34;</span>&nbsp;<span class="op" id="6421450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421454">t</span><span class="op" id="6421455">.</span><span class="ident" id="6421456">Skipf</span><span class="op" id="6421461">(</span><span class="string" id="6421462">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6421483">,</span>&nbsp;<span class="ident" id="6421485">runtime</span><span class="op" id="6421492">.</span><span class="ident" id="6421493">GOOS</span><span class="op" id="6421497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6421500">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421503">cwd</span><span class="op" id="6421506">,</span>&nbsp;<span class="ident" id="6421508">_</span>&nbsp;<span class="op" id="6421510">:=</span>&nbsp;<span class="ident" id="6421513">os</span><span class="op" id="6421515">.</span><span class="ident" id="6421516">Getwd</span><span class="op" id="6421521">(</span><span class="op" id="6421522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421525">h</span>&nbsp;<span class="op" id="6421527">:=</span>&nbsp;<span class="op" id="6421530">&amp;</span><span class="ident" id="6421531">Handler</span><span class="op" id="6421538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421542">Path</span><span class="op" id="6421546">:</span>&nbsp;<span class="string" id="6421548">&#34;testdata/test.cgi&#34;</span><span class="op" id="6421567">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421571">Root</span><span class="op" id="6421575">:</span>&nbsp;<span class="string" id="6421577">&#34;/test.cgi&#34;</span><span class="op" id="6421588">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421592">Dir</span><span class="op" id="6421595">:</span>&nbsp;&nbsp;<span class="ident" id="6421598">cwd</span><span class="op" id="6421601">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6421604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421607">expectedMap</span>&nbsp;<span class="op" id="6421619">:=</span>&nbsp;<span class="keyword" id="6421622">map</span><span class="op" id="6421625">[</span><span class="builtintype" id="6421626">string</span><span class="op" id="6421632">]</span><span class="builtintype" id="6421633">string</span><span class="op" id="6421639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6421643">&#34;cwd&#34;</span><span class="op" id="6421648">:</span>&nbsp;<span class="ident" id="6421650">cwd</span><span class="op" id="6421653">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6421656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421659">runCgiTest</span><span class="op" id="6421669">(</span><span class="ident" id="6421670">t</span><span class="op" id="6421671">,</span>&nbsp;<span class="ident" id="6421673">h</span><span class="op" id="6421674">,</span>&nbsp;<span class="string" id="6421676">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6421723">,</span>&nbsp;<span class="ident" id="6421725">expectedMap</span><span class="op" id="6421736">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421740">cwd</span><span class="op" id="6421743">,</span>&nbsp;<span class="ident" id="6421745">_</span>&nbsp;<span class="op" id="6421747">=</span>&nbsp;<span class="ident" id="6421749">os</span><span class="op" id="6421751">.</span><span class="ident" id="6421752">Getwd</span><span class="op" id="6421757">(</span><span class="op" id="6421758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421761">cwd</span>&nbsp;<span class="op" id="6421765">=</span>&nbsp;<span class="ident" id="6421767">filepath</span><span class="op" id="6421775">.</span><span class="ident" id="6421776">Join</span><span class="op" id="6421780">(</span><span class="ident" id="6421781">cwd</span><span class="op" id="6421784">,</span>&nbsp;<span class="string" id="6421786">&#34;testdata&#34;</span><span class="op" id="6421796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421799">h</span>&nbsp;<span class="op" id="6421801">=</span>&nbsp;<span class="op" id="6421803">&amp;</span><span class="ident" id="6421804">Handler</span><span class="op" id="6421811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421815">Path</span><span class="op" id="6421819">:</span>&nbsp;<span class="string" id="6421821">&#34;testdata/test.cgi&#34;</span><span class="op" id="6421840">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421844">Root</span><span class="op" id="6421848">:</span>&nbsp;<span class="string" id="6421850">&#34;/test.cgi&#34;</span><span class="op" id="6421861">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6421864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421867">expectedMap</span>&nbsp;<span class="op" id="6421879">=</span>&nbsp;<span class="keyword" id="6421881">map</span><span class="op" id="6421884">[</span><span class="builtintype" id="6421885">string</span><span class="op" id="6421891">]</span><span class="builtintype" id="6421892">string</span><span class="op" id="6421898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6421902">&#34;cwd&#34;</span><span class="op" id="6421907">:</span>&nbsp;<span class="ident" id="6421909">cwd</span><span class="op" id="6421912">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6421915">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6421918">runCgiTest</span><span class="op" id="6421928">(</span><span class="ident" id="6421929">t</span><span class="op" id="6421930">,</span>&nbsp;<span class="ident" id="6421932">h</span><span class="op" id="6421933">,</span>&nbsp;<span class="string" id="6421935">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6421982">,</span>&nbsp;<span class="ident" id="6421984">expectedMap</span><span class="op" id="6421995">)</span><br>
<span class="lineno"></span><span class="op" id="6421997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6422000">func</span>&nbsp;<span class="ident" id="6422005">TestDirWindows</span><span class="op" id="6422019">(</span><span class="ident" id="6422020">t</span>&nbsp;<span class="op" id="6422022">*</span><span class="ident" id="6422023">testing</span><span class="op" id="6422030">.</span><span class="ident" id="6422031">T</span><span class="op" id="6422032">)</span>&nbsp;<span class="op" id="6422034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6422037">if</span>&nbsp;<span class="ident" id="6422040">runtime</span><span class="op" id="6422047">.</span><span class="ident" id="6422048">GOOS</span>&nbsp;<span class="op" id="6422053">!=</span>&nbsp;<span class="string" id="6422056">&#34;windows&#34;</span>&nbsp;<span class="op" id="6422066">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422070">t</span><span class="op" id="6422071">.</span><span class="ident" id="6422072">Skip</span><span class="op" id="6422076">(</span><span class="string" id="6422077">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="6422110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6422113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422117">cgifile</span><span class="op" id="6422124">,</span>&nbsp;<span class="ident" id="6422126">_</span>&nbsp;<span class="op" id="6422128">:=</span>&nbsp;<span class="ident" id="6422131">filepath</span><span class="op" id="6422139">.</span><span class="ident" id="6422140">Abs</span><span class="op" id="6422143">(</span><span class="string" id="6422144">&#34;testdata/test.cgi&#34;</span><span class="op" id="6422163">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6422167">var</span>&nbsp;<span class="ident" id="6422171">perl</span>&nbsp;<span class="builtintype" id="6422176">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6422184">var</span>&nbsp;<span class="ident" id="6422188">err</span>&nbsp;<span class="builtintype" id="6422192">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422199">perl</span><span class="op" id="6422203">,</span>&nbsp;<span class="ident" id="6422205">err</span>&nbsp;<span class="op" id="6422209">=</span>&nbsp;<span class="ident" id="6422211">exec</span><span class="op" id="6422215">.</span><span class="ident" id="6422216">LookPath</span><span class="op" id="6422224">(</span><span class="string" id="6422225">&#34;perl&#34;</span><span class="op" id="6422231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6422234">if</span>&nbsp;<span class="ident" id="6422237">err</span>&nbsp;<span class="op" id="6422241">!=</span>&nbsp;<span class="ident" id="6422244">nil</span>&nbsp;<span class="op" id="6422248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422252">t</span><span class="op" id="6422253">.</span><span class="ident" id="6422254">Skip</span><span class="op" id="6422258">(</span><span class="string" id="6422259">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="6422291">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6422294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422297">perl</span><span class="op" id="6422301">,</span>&nbsp;<span class="ident" id="6422303">_</span>&nbsp;<span class="op" id="6422305">=</span>&nbsp;<span class="ident" id="6422307">filepath</span><span class="op" id="6422315">.</span><span class="ident" id="6422316">Abs</span><span class="op" id="6422319">(</span><span class="ident" id="6422320">perl</span><span class="op" id="6422324">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422328">cwd</span><span class="op" id="6422331">,</span>&nbsp;<span class="ident" id="6422333">_</span>&nbsp;<span class="op" id="6422335">:=</span>&nbsp;<span class="ident" id="6422338">os</span><span class="op" id="6422340">.</span><span class="ident" id="6422341">Getwd</span><span class="op" id="6422346">(</span><span class="op" id="6422347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422350">h</span>&nbsp;<span class="op" id="6422352">:=</span>&nbsp;<span class="op" id="6422355">&amp;</span><span class="ident" id="6422356">Handler</span><span class="op" id="6422363">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422367">Path</span><span class="op" id="6422371">:</span>&nbsp;<span class="ident" id="6422373">perl</span><span class="op" id="6422377">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422381">Root</span><span class="op" id="6422385">:</span>&nbsp;<span class="string" id="6422387">&#34;/test.cgi&#34;</span><span class="op" id="6422398">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422402">Dir</span><span class="op" id="6422405">:</span>&nbsp;&nbsp;<span class="ident" id="6422408">cwd</span><span class="op" id="6422411">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422415">Args</span><span class="op" id="6422419">:</span>&nbsp;<span class="op" id="6422421">[</span><span class="op" id="6422422">]</span><span class="builtintype" id="6422423">string</span><span class="op" id="6422429">{</span><span class="ident" id="6422430">cgifile</span><span class="op" id="6422437">}</span><span class="op" id="6422438">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422442">Env</span><span class="op" id="6422445">:</span>&nbsp;&nbsp;<span class="op" id="6422448">[</span><span class="op" id="6422449">]</span><span class="builtintype" id="6422450">string</span><span class="op" id="6422456">{</span><span class="string" id="6422457">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="6422476">+</span>&nbsp;<span class="ident" id="6422478">cgifile</span><span class="op" id="6422485">}</span><span class="op" id="6422486">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6422489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422492">expectedMap</span>&nbsp;<span class="op" id="6422504">:=</span>&nbsp;<span class="keyword" id="6422507">map</span><span class="op" id="6422510">[</span><span class="builtintype" id="6422511">string</span><span class="op" id="6422517">]</span><span class="builtintype" id="6422518">string</span><span class="op" id="6422524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6422528">&#34;cwd&#34;</span><span class="op" id="6422533">:</span>&nbsp;<span class="ident" id="6422535">cwd</span><span class="op" id="6422538">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6422541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422544">runCgiTest</span><span class="op" id="6422554">(</span><span class="ident" id="6422555">t</span><span class="op" id="6422556">,</span>&nbsp;<span class="ident" id="6422558">h</span><span class="op" id="6422559">,</span>&nbsp;<span class="string" id="6422561">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6422608">,</span>&nbsp;<span class="ident" id="6422610">expectedMap</span><span class="op" id="6422621">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6422625">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6422688">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422716">cwd</span><span class="op" id="6422719">,</span>&nbsp;<span class="ident" id="6422721">_</span>&nbsp;<span class="op" id="6422723">=</span>&nbsp;<span class="ident" id="6422725">filepath</span><span class="op" id="6422733">.</span><span class="ident" id="6422734">Split</span><span class="op" id="6422739">(</span><span class="ident" id="6422740">perl</span><span class="op" id="6422744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6422747">if</span>&nbsp;<span class="ident" id="6422750">cwd</span>&nbsp;<span class="op" id="6422754">!=</span>&nbsp;<span class="string" id="6422757">&#34;&#34;</span>&nbsp;<span class="op" id="6422760">&amp;&amp;</span>&nbsp;<span class="ident" id="6422763">cwd</span><span class="op" id="6422766">[</span><span class="builtinfunc" id="6422767">len</span><span class="op" id="6422770">(</span><span class="ident" id="6422771">cwd</span><span class="op" id="6422774">)</span><span class="op" id="6422775">-</span><span class="num" id="6422776">1</span><span class="op" id="6422777">]</span>&nbsp;<span class="op" id="6422779">==</span>&nbsp;<span class="ident" id="6422782">filepath</span><span class="op" id="6422790">.</span><span class="ident" id="6422791">Separator</span>&nbsp;<span class="op" id="6422801">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422805">cwd</span>&nbsp;<span class="op" id="6422809">=</span>&nbsp;<span class="ident" id="6422811">cwd</span><span class="op" id="6422814">[</span><span class="op" id="6422815">:</span><span class="builtinfunc" id="6422816">len</span><span class="op" id="6422819">(</span><span class="ident" id="6422820">cwd</span><span class="op" id="6422823">)</span><span class="op" id="6422824">-</span><span class="num" id="6422825">1</span><span class="op" id="6422826">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6422829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422832">h</span>&nbsp;<span class="op" id="6422834">=</span>&nbsp;<span class="op" id="6422836">&amp;</span><span class="ident" id="6422837">Handler</span><span class="op" id="6422844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422848">Path</span><span class="op" id="6422852">:</span>&nbsp;<span class="ident" id="6422854">perl</span><span class="op" id="6422858">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422862">Root</span><span class="op" id="6422866">:</span>&nbsp;<span class="string" id="6422868">&#34;/test.cgi&#34;</span><span class="op" id="6422879">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422883">Args</span><span class="op" id="6422887">:</span>&nbsp;<span class="op" id="6422889">[</span><span class="op" id="6422890">]</span><span class="builtintype" id="6422891">string</span><span class="op" id="6422897">{</span><span class="ident" id="6422898">cgifile</span><span class="op" id="6422905">}</span><span class="op" id="6422906">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422910">Env</span><span class="op" id="6422913">:</span>&nbsp;&nbsp;<span class="op" id="6422916">[</span><span class="op" id="6422917">]</span><span class="builtintype" id="6422918">string</span><span class="op" id="6422924">{</span><span class="string" id="6422925">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="6422944">+</span>&nbsp;<span class="ident" id="6422946">cgifile</span><span class="op" id="6422953">}</span><span class="op" id="6422954">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6422957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6422960">expectedMap</span>&nbsp;<span class="op" id="6422972">=</span>&nbsp;<span class="keyword" id="6422974">map</span><span class="op" id="6422977">[</span><span class="builtintype" id="6422978">string</span><span class="op" id="6422984">]</span><span class="builtintype" id="6422985">string</span><span class="op" id="6422991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6422995">&#34;cwd&#34;</span><span class="op" id="6423000">:</span>&nbsp;<span class="ident" id="6423002">cwd</span><span class="op" id="6423005">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6423008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423011">runCgiTest</span><span class="op" id="6423021">(</span><span class="ident" id="6423022">t</span><span class="op" id="6423023">,</span>&nbsp;<span class="ident" id="6423025">h</span><span class="op" id="6423026">,</span>&nbsp;<span class="string" id="6423028">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6423075">,</span>&nbsp;<span class="ident" id="6423077">expectedMap</span><span class="op" id="6423088">)</span><br>
<span class="lineno"></span><span class="op" id="6423090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6423093">func</span>&nbsp;<span class="ident" id="6423098">TestEnvOverride</span><span class="op" id="6423113">(</span><span class="ident" id="6423114">t</span>&nbsp;<span class="op" id="6423116">*</span><span class="ident" id="6423117">testing</span><span class="op" id="6423124">.</span><span class="ident" id="6423125">T</span><span class="op" id="6423126">)</span>&nbsp;<span class="op" id="6423128">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423131">cgifile</span><span class="op" id="6423138">,</span>&nbsp;<span class="ident" id="6423140">_</span>&nbsp;<span class="op" id="6423142">:=</span>&nbsp;<span class="ident" id="6423145">filepath</span><span class="op" id="6423153">.</span><span class="ident" id="6423154">Abs</span><span class="op" id="6423157">(</span><span class="string" id="6423158">&#34;testdata/test.cgi&#34;</span><span class="op" id="6423177">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6423181">var</span>&nbsp;<span class="ident" id="6423185">perl</span>&nbsp;<span class="builtintype" id="6423190">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6423198">var</span>&nbsp;<span class="ident" id="6423202">err</span>&nbsp;<span class="builtintype" id="6423206">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423213">perl</span><span class="op" id="6423217">,</span>&nbsp;<span class="ident" id="6423219">err</span>&nbsp;<span class="op" id="6423223">=</span>&nbsp;<span class="ident" id="6423225">exec</span><span class="op" id="6423229">.</span><span class="ident" id="6423230">LookPath</span><span class="op" id="6423238">(</span><span class="string" id="6423239">&#34;perl&#34;</span><span class="op" id="6423245">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6423248">if</span>&nbsp;<span class="ident" id="6423251">err</span>&nbsp;<span class="op" id="6423255">!=</span>&nbsp;<span class="ident" id="6423258">nil</span>&nbsp;<span class="op" id="6423262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423266">t</span><span class="op" id="6423267">.</span><span class="ident" id="6423268">Skipf</span><span class="op" id="6423273">(</span><span class="string" id="6423274">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="6423306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6423309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423312">perl</span><span class="op" id="6423316">,</span>&nbsp;<span class="ident" id="6423318">_</span>&nbsp;<span class="op" id="6423320">=</span>&nbsp;<span class="ident" id="6423322">filepath</span><span class="op" id="6423330">.</span><span class="ident" id="6423331">Abs</span><span class="op" id="6423334">(</span><span class="ident" id="6423335">perl</span><span class="op" id="6423339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423343">cwd</span><span class="op" id="6423346">,</span>&nbsp;<span class="ident" id="6423348">_</span>&nbsp;<span class="op" id="6423350">:=</span>&nbsp;<span class="ident" id="6423353">os</span><span class="op" id="6423355">.</span><span class="ident" id="6423356">Getwd</span><span class="op" id="6423361">(</span><span class="op" id="6423362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423365">h</span>&nbsp;<span class="op" id="6423367">:=</span>&nbsp;<span class="op" id="6423370">&amp;</span><span class="ident" id="6423371">Handler</span><span class="op" id="6423378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423382">Path</span><span class="op" id="6423386">:</span>&nbsp;<span class="ident" id="6423388">perl</span><span class="op" id="6423392">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423396">Root</span><span class="op" id="6423400">:</span>&nbsp;<span class="string" id="6423402">&#34;/test.cgi&#34;</span><span class="op" id="6423413">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423417">Dir</span><span class="op" id="6423420">:</span>&nbsp;&nbsp;<span class="ident" id="6423423">cwd</span><span class="op" id="6423426">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423430">Args</span><span class="op" id="6423434">:</span>&nbsp;<span class="op" id="6423436">[</span><span class="op" id="6423437">]</span><span class="builtintype" id="6423438">string</span><span class="op" id="6423444">{</span><span class="ident" id="6423445">cgifile</span><span class="op" id="6423452">}</span><span class="op" id="6423453">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423457">Env</span><span class="op" id="6423460">:</span>&nbsp;<span class="op" id="6423462">[</span><span class="op" id="6423463">]</span><span class="builtintype" id="6423464">string</span><span class="op" id="6423470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6423475">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="6423494">+</span>&nbsp;<span class="ident" id="6423496">cgifile</span><span class="op" id="6423503">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6423508">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="6423530">}</span><span class="op" id="6423531">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6423534">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423537">expectedMap</span>&nbsp;<span class="op" id="6423549">:=</span>&nbsp;<span class="keyword" id="6423552">map</span><span class="op" id="6423555">[</span><span class="builtintype" id="6423556">string</span><span class="op" id="6423562">]</span><span class="builtintype" id="6423563">string</span><span class="op" id="6423569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6423573">&#34;cwd&#34;</span><span class="op" id="6423578">:</span>&nbsp;<span class="ident" id="6423580">cwd</span><span class="op" id="6423583">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6423587">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6423608">:</span>&nbsp;<span class="ident" id="6423610">cgifile</span><span class="op" id="6423617">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6423621">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6423638">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6423644">&#34;/foo/bar&#34;</span><span class="op" id="6423654">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6423657">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423660">runCgiTest</span><span class="op" id="6423670">(</span><span class="ident" id="6423671">t</span><span class="op" id="6423672">,</span>&nbsp;<span class="ident" id="6423674">h</span><span class="op" id="6423675">,</span>&nbsp;<span class="string" id="6423677">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6423724">,</span>&nbsp;<span class="ident" id="6423726">expectedMap</span><span class="op" id="6423737">)</span><br>
<span class="lineno"></span><span class="op" id="6423739">}</span>
</div>
</body>
</html>
