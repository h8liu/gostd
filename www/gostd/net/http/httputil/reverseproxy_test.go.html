<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7723706">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7723761">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7723815">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7723866">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7723891">package</span>&nbsp;<span class="ident" id="7723899">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7723909">import</span>&nbsp;<span class="op" id="7723916">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7723919">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7723932">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7723944">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7723965">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7723976">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7723987">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7723998">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7724005">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7724008">const</span>&nbsp;<span class="ident" id="7724014">fakeHopHeader</span>&nbsp;<span class="op" id="7724028">=</span>&nbsp;<span class="string" id="7724030">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7724060">func</span>&nbsp;<span class="ident" id="7724065">init</span><span class="op" id="7724069">(</span><span class="op" id="7724070">)</span>&nbsp;<span class="op" id="7724072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7724075">hopHeaders</span>&nbsp;<span class="op" id="7724086">=</span>&nbsp;<span class="builtinfunc" id="7724088">append</span><span class="op" id="7724094">(</span><span class="ident" id="7724095">hopHeaders</span><span class="op" id="7724105">,</span>&nbsp;<span class="ident" id="7724107">fakeHopHeader</span><span class="op" id="7724120">)</span><br>
<span class="lineno"></span><span class="op" id="7724122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7724125">func</span>&nbsp;<span class="ident" id="7724130">TestReverseProxy</span><span class="op" id="7724146">(</span><span class="ident" id="7724147">t</span>&nbsp;<span class="op" id="7724149">*</span><span class="ident" id="7724150">testing</span><span class="op" id="7724157">.</span><span class="ident" id="7724158">T</span><span class="op" id="7724159">)</span>&nbsp;<span class="op" id="7724161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7724164">const</span>&nbsp;<span class="ident" id="7724170">backendResponse</span>&nbsp;<span class="op" id="7724186">=</span>&nbsp;<span class="string" id="7724188">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7724208">const</span>&nbsp;<span class="ident" id="7724214">backendStatus</span>&nbsp;<span class="op" id="7724228">=</span>&nbsp;<span class="num" id="7724230">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7724235">backend</span>&nbsp;<span class="op" id="7724243">:=</span>&nbsp;<span class="ident" id="7724246">httptest</span><span class="op" id="7724254">.</span><span class="ident" id="7724255">NewServer</span><span class="op" id="7724264">(</span><span class="ident" id="7724265">http</span><span class="op" id="7724269">.</span><span class="ident" id="7724270">HandlerFunc</span><span class="op" id="7724281">(</span><span class="keyword" id="7724282">func</span><span class="op" id="7724286">(</span><span class="ident" id="7724287">w</span>&nbsp;<span class="ident" id="7724289">http</span><span class="op" id="7724293">.</span><span class="ident" id="7724294">ResponseWriter</span><span class="op" id="7724308">,</span>&nbsp;<span class="ident" id="7724310">r</span>&nbsp;<span class="op" id="7724312">*</span><span class="ident" id="7724313">http</span><span class="op" id="7724317">.</span><span class="ident" id="7724318">Request</span><span class="op" id="7724325">)</span>&nbsp;<span class="op" id="7724327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7724331">if</span>&nbsp;<span class="builtinfunc" id="7724334">len</span><span class="op" id="7724337">(</span><span class="ident" id="7724338">r</span><span class="op" id="7724339">.</span><span class="ident" id="7724340">TransferEncoding</span><span class="op" id="7724356">)</span>&nbsp;<span class="op" id="7724358">&gt;</span>&nbsp;<span class="num" id="7724360">0</span>&nbsp;<span class="op" id="7724362">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7724367">t</span><span class="op" id="7724368">.</span><span class="ident" id="7724369">Errorf</span><span class="op" id="7724375">(</span><span class="string" id="7724376">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="7724421">,</span>&nbsp;<span class="ident" id="7724423">r</span><span class="op" id="7724424">.</span><span class="ident" id="7724425">TransferEncoding</span><span class="op" id="7724441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7724445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7724449">if</span>&nbsp;<span class="ident" id="7724452">r</span><span class="op" id="7724453">.</span><span class="ident" id="7724454">Header</span><span class="op" id="7724460">.</span><span class="ident" id="7724461">Get</span><span class="op" id="7724464">(</span><span class="string" id="7724465">&#34;X-Forwarded-For&#34;</span><span class="op" id="7724482">)</span>&nbsp;<span class="op" id="7724484">==</span>&nbsp;<span class="string" id="7724487">&#34;&#34;</span>&nbsp;<span class="op" id="7724490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7724495">t</span><span class="op" id="7724496">.</span><span class="ident" id="7724497">Errorf</span><span class="op" id="7724503">(</span><span class="string" id="7724504">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7724539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7724543">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7724547">if</span>&nbsp;<span class="ident" id="7724550">c</span>&nbsp;<span class="op" id="7724552">:=</span>&nbsp;<span class="ident" id="7724555">r</span><span class="op" id="7724556">.</span><span class="ident" id="7724557">Header</span><span class="op" id="7724563">.</span><span class="ident" id="7724564">Get</span><span class="op" id="7724567">(</span><span class="string" id="7724568">&#34;Connection&#34;</span><span class="op" id="7724580">)</span><span class="op" id="7724581">;</span>&nbsp;<span class="ident" id="7724583">c</span>&nbsp;<span class="op" id="7724585">!=</span>&nbsp;<span class="string" id="7724588">&#34;&#34;</span>&nbsp;<span class="op" id="7724591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7724596">t</span><span class="op" id="7724597">.</span><span class="ident" id="7724598">Errorf</span><span class="op" id="7724604">(</span><span class="string" id="7724605">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7724645">,</span>&nbsp;<span class="ident" id="7724647">c</span><span class="op" id="7724648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7724652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7724656">if</span>&nbsp;<span class="ident" id="7724659">c</span>&nbsp;<span class="op" id="7724661">:=</span>&nbsp;<span class="ident" id="7724664">r</span><span class="op" id="7724665">.</span><span class="ident" id="7724666">Header</span><span class="op" id="7724672">.</span><span class="ident" id="7724673">Get</span><span class="op" id="7724676">(</span><span class="string" id="7724677">&#34;Upgrade&#34;</span><span class="op" id="7724686">)</span><span class="op" id="7724687">;</span>&nbsp;<span class="ident" id="7724689">c</span>&nbsp;<span class="op" id="7724691">!=</span>&nbsp;<span class="string" id="7724694">&#34;&#34;</span>&nbsp;<span class="op" id="7724697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7724702">t</span><span class="op" id="7724703">.</span><span class="ident" id="7724704">Errorf</span><span class="op" id="7724710">(</span><span class="string" id="7724711">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7724748">,</span>&nbsp;<span class="ident" id="7724750">c</span><span class="op" id="7724751">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7724755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7724759">if</span>&nbsp;<span class="ident" id="7724762">g</span><span class="op" id="7724763">,</span>&nbsp;<span class="ident" id="7724765">e</span>&nbsp;<span class="op" id="7724767">:=</span>&nbsp;<span class="ident" id="7724770">r</span><span class="op" id="7724771">.</span><span class="ident" id="7724772">Host</span><span class="op" id="7724776">,</span>&nbsp;<span class="string" id="7724778">&#34;some-name&#34;</span><span class="op" id="7724789">;</span>&nbsp;<span class="ident" id="7724791">g</span>&nbsp;<span class="op" id="7724793">!=</span>&nbsp;<span class="ident" id="7724796">e</span>&nbsp;<span class="op" id="7724798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7724803">t</span><span class="op" id="7724804">.</span><span class="ident" id="7724805">Errorf</span><span class="op" id="7724811">(</span><span class="string" id="7724812">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7724849">,</span>&nbsp;<span class="ident" id="7724851">g</span><span class="op" id="7724852">,</span>&nbsp;<span class="ident" id="7724854">e</span><span class="op" id="7724855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7724859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7724863">w</span><span class="op" id="7724864">.</span><span class="ident" id="7724865">Header</span><span class="op" id="7724871">(</span><span class="op" id="7724872">)</span><span class="op" id="7724873">.</span><span class="ident" id="7724874">Set</span><span class="op" id="7724877">(</span><span class="string" id="7724878">&#34;X-Foo&#34;</span><span class="op" id="7724885">,</span>&nbsp;<span class="string" id="7724887">&#34;bar&#34;</span><span class="op" id="7724892">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7724896">w</span><span class="op" id="7724897">.</span><span class="ident" id="7724898">Header</span><span class="op" id="7724904">(</span><span class="op" id="7724905">)</span><span class="op" id="7724906">.</span><span class="ident" id="7724907">Set</span><span class="op" id="7724910">(</span><span class="string" id="7724911">&#34;Upgrade&#34;</span><span class="op" id="7724920">,</span>&nbsp;<span class="string" id="7724922">&#34;foo&#34;</span><span class="op" id="7724927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7724931">w</span><span class="op" id="7724932">.</span><span class="ident" id="7724933">Header</span><span class="op" id="7724939">(</span><span class="op" id="7724940">)</span><span class="op" id="7724941">.</span><span class="ident" id="7724942">Set</span><span class="op" id="7724945">(</span><span class="ident" id="7724946">fakeHopHeader</span><span class="op" id="7724959">,</span>&nbsp;<span class="string" id="7724961">&#34;foo&#34;</span><span class="op" id="7724966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7724970">w</span><span class="op" id="7724971">.</span><span class="ident" id="7724972">Header</span><span class="op" id="7724978">(</span><span class="op" id="7724979">)</span><span class="op" id="7724980">.</span><span class="ident" id="7724981">Add</span><span class="op" id="7724984">(</span><span class="string" id="7724985">&#34;X-Multi-Value&#34;</span><span class="op" id="7725000">,</span>&nbsp;<span class="string" id="7725002">&#34;foo&#34;</span><span class="op" id="7725007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725011">w</span><span class="op" id="7725012">.</span><span class="ident" id="7725013">Header</span><span class="op" id="7725019">(</span><span class="op" id="7725020">)</span><span class="op" id="7725021">.</span><span class="ident" id="7725022">Add</span><span class="op" id="7725025">(</span><span class="string" id="7725026">&#34;X-Multi-Value&#34;</span><span class="op" id="7725041">,</span>&nbsp;<span class="string" id="7725043">&#34;bar&#34;</span><span class="op" id="7725048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725052">http</span><span class="op" id="7725056">.</span><span class="ident" id="7725057">SetCookie</span><span class="op" id="7725066">(</span><span class="ident" id="7725067">w</span><span class="op" id="7725068">,</span>&nbsp;<span class="op" id="7725070">&amp;</span><span class="ident" id="7725071">http</span><span class="op" id="7725075">.</span><span class="ident" id="7725076">Cookie</span><span class="op" id="7725082">{</span><span class="ident" id="7725083">Name</span><span class="op" id="7725087">:</span>&nbsp;<span class="string" id="7725089">&#34;flavor&#34;</span><span class="op" id="7725097">,</span>&nbsp;<span class="ident" id="7725099">Value</span><span class="op" id="7725104">:</span>&nbsp;<span class="string" id="7725106">&#34;chocolateChip&#34;</span><span class="op" id="7725121">}</span><span class="op" id="7725122">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725126">w</span><span class="op" id="7725127">.</span><span class="ident" id="7725128">WriteHeader</span><span class="op" id="7725139">(</span><span class="ident" id="7725140">backendStatus</span><span class="op" id="7725153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725157">w</span><span class="op" id="7725158">.</span><span class="ident" id="7725159">Write</span><span class="op" id="7725164">(</span><span class="op" id="7725165">[</span><span class="op" id="7725166">]</span><span class="builtintype" id="7725167">byte</span><span class="op" id="7725171">(</span><span class="ident" id="7725172">backendResponse</span><span class="op" id="7725187">)</span><span class="op" id="7725188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7725191">}</span><span class="op" id="7725192">)</span><span class="op" id="7725193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7725196">defer</span>&nbsp;<span class="ident" id="7725202">backend</span><span class="op" id="7725209">.</span><span class="ident" id="7725210">Close</span><span class="op" id="7725215">(</span><span class="op" id="7725216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725219">backendURL</span><span class="op" id="7725229">,</span>&nbsp;<span class="ident" id="7725231">err</span>&nbsp;<span class="op" id="7725235">:=</span>&nbsp;<span class="ident" id="7725238">url</span><span class="op" id="7725241">.</span><span class="ident" id="7725242">Parse</span><span class="op" id="7725247">(</span><span class="ident" id="7725248">backend</span><span class="op" id="7725255">.</span><span class="ident" id="7725256">URL</span><span class="op" id="7725259">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7725262">if</span>&nbsp;<span class="ident" id="7725265">err</span>&nbsp;<span class="op" id="7725269">!=</span>&nbsp;<span class="ident" id="7725272">nil</span>&nbsp;<span class="op" id="7725276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725280">t</span><span class="op" id="7725281">.</span><span class="ident" id="7725282">Fatal</span><span class="op" id="7725287">(</span><span class="ident" id="7725288">err</span><span class="op" id="7725291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7725294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725297">proxyHandler</span>&nbsp;<span class="op" id="7725310">:=</span>&nbsp;<span class="ident" id="7725313">NewSingleHostReverseProxy</span><span class="op" id="7725338">(</span><span class="ident" id="7725339">backendURL</span><span class="op" id="7725349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725352">frontend</span>&nbsp;<span class="op" id="7725361">:=</span>&nbsp;<span class="ident" id="7725364">httptest</span><span class="op" id="7725372">.</span><span class="ident" id="7725373">NewServer</span><span class="op" id="7725382">(</span><span class="ident" id="7725383">proxyHandler</span><span class="op" id="7725395">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7725398">defer</span>&nbsp;<span class="ident" id="7725404">frontend</span><span class="op" id="7725412">.</span><span class="ident" id="7725413">Close</span><span class="op" id="7725418">(</span><span class="op" id="7725419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725423">getReq</span><span class="op" id="7725429">,</span>&nbsp;<span class="ident" id="7725431">_</span>&nbsp;<span class="op" id="7725433">:=</span>&nbsp;<span class="ident" id="7725436">http</span><span class="op" id="7725440">.</span><span class="ident" id="7725441">NewRequest</span><span class="op" id="7725451">(</span><span class="string" id="7725452">&#34;GET&#34;</span><span class="op" id="7725457">,</span>&nbsp;<span class="ident" id="7725459">frontend</span><span class="op" id="7725467">.</span><span class="ident" id="7725468">URL</span><span class="op" id="7725471">,</span>&nbsp;<span class="ident" id="7725473">nil</span><span class="op" id="7725476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725479">getReq</span><span class="op" id="7725485">.</span><span class="ident" id="7725486">Host</span>&nbsp;<span class="op" id="7725491">=</span>&nbsp;<span class="string" id="7725493">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725506">getReq</span><span class="op" id="7725512">.</span><span class="ident" id="7725513">Header</span><span class="op" id="7725519">.</span><span class="ident" id="7725520">Set</span><span class="op" id="7725523">(</span><span class="string" id="7725524">&#34;Connection&#34;</span><span class="op" id="7725536">,</span>&nbsp;<span class="string" id="7725538">&#34;close&#34;</span><span class="op" id="7725545">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725548">getReq</span><span class="op" id="7725554">.</span><span class="ident" id="7725555">Header</span><span class="op" id="7725561">.</span><span class="ident" id="7725562">Set</span><span class="op" id="7725565">(</span><span class="string" id="7725566">&#34;Upgrade&#34;</span><span class="op" id="7725575">,</span>&nbsp;<span class="string" id="7725577">&#34;foo&#34;</span><span class="op" id="7725582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725585">getReq</span><span class="op" id="7725591">.</span><span class="ident" id="7725592">Close</span>&nbsp;<span class="op" id="7725598">=</span>&nbsp;<span class="builtintype" id="7725600">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725606">res</span><span class="op" id="7725609">,</span>&nbsp;<span class="ident" id="7725611">err</span>&nbsp;<span class="op" id="7725615">:=</span>&nbsp;<span class="ident" id="7725618">http</span><span class="op" id="7725622">.</span><span class="ident" id="7725623">DefaultClient</span><span class="op" id="7725636">.</span><span class="ident" id="7725637">Do</span><span class="op" id="7725639">(</span><span class="ident" id="7725640">getReq</span><span class="op" id="7725646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7725649">if</span>&nbsp;<span class="ident" id="7725652">err</span>&nbsp;<span class="op" id="7725656">!=</span>&nbsp;<span class="ident" id="7725659">nil</span>&nbsp;<span class="op" id="7725663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725667">t</span><span class="op" id="7725668">.</span><span class="ident" id="7725669">Fatalf</span><span class="op" id="7725675">(</span><span class="string" id="7725676">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7725685">,</span>&nbsp;<span class="ident" id="7725687">err</span><span class="op" id="7725690">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7725693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7725696">if</span>&nbsp;<span class="ident" id="7725699">g</span><span class="op" id="7725700">,</span>&nbsp;<span class="ident" id="7725702">e</span>&nbsp;<span class="op" id="7725704">:=</span>&nbsp;<span class="ident" id="7725707">res</span><span class="op" id="7725710">.</span><span class="ident" id="7725711">StatusCode</span><span class="op" id="7725721">,</span>&nbsp;<span class="ident" id="7725723">backendStatus</span><span class="op" id="7725736">;</span>&nbsp;<span class="ident" id="7725738">g</span>&nbsp;<span class="op" id="7725740">!=</span>&nbsp;<span class="ident" id="7725743">e</span>&nbsp;<span class="op" id="7725745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725749">t</span><span class="op" id="7725750">.</span><span class="ident" id="7725751">Errorf</span><span class="op" id="7725757">(</span><span class="string" id="7725758">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7725794">,</span>&nbsp;<span class="ident" id="7725796">g</span><span class="op" id="7725797">,</span>&nbsp;<span class="ident" id="7725799">e</span><span class="op" id="7725800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7725803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7725806">if</span>&nbsp;<span class="ident" id="7725809">g</span><span class="op" id="7725810">,</span>&nbsp;<span class="ident" id="7725812">e</span>&nbsp;<span class="op" id="7725814">:=</span>&nbsp;<span class="ident" id="7725817">res</span><span class="op" id="7725820">.</span><span class="ident" id="7725821">Header</span><span class="op" id="7725827">.</span><span class="ident" id="7725828">Get</span><span class="op" id="7725831">(</span><span class="string" id="7725832">&#34;X-Foo&#34;</span><span class="op" id="7725839">)</span><span class="op" id="7725840">,</span>&nbsp;<span class="string" id="7725842">&#34;bar&#34;</span><span class="op" id="7725847">;</span>&nbsp;<span class="ident" id="7725849">g</span>&nbsp;<span class="op" id="7725851">!=</span>&nbsp;<span class="ident" id="7725854">e</span>&nbsp;<span class="op" id="7725856">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725860">t</span><span class="op" id="7725861">.</span><span class="ident" id="7725862">Errorf</span><span class="op" id="7725868">(</span><span class="string" id="7725869">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7725896">,</span>&nbsp;<span class="ident" id="7725898">g</span><span class="op" id="7725899">,</span>&nbsp;<span class="ident" id="7725901">e</span><span class="op" id="7725902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7725905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7725908">if</span>&nbsp;<span class="ident" id="7725911">c</span>&nbsp;<span class="op" id="7725913">:=</span>&nbsp;<span class="ident" id="7725916">res</span><span class="op" id="7725919">.</span><span class="ident" id="7725920">Header</span><span class="op" id="7725926">.</span><span class="ident" id="7725927">Get</span><span class="op" id="7725930">(</span><span class="ident" id="7725931">fakeHopHeader</span><span class="op" id="7725944">)</span><span class="op" id="7725945">;</span>&nbsp;<span class="ident" id="7725947">c</span>&nbsp;<span class="op" id="7725949">!=</span>&nbsp;<span class="string" id="7725952">&#34;&#34;</span>&nbsp;<span class="op" id="7725955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7725959">t</span><span class="op" id="7725960">.</span><span class="ident" id="7725961">Errorf</span><span class="op" id="7725967">(</span><span class="string" id="7725968">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7725992">,</span>&nbsp;<span class="ident" id="7725994">fakeHopHeader</span><span class="op" id="7726007">,</span>&nbsp;<span class="ident" id="7726009">c</span><span class="op" id="7726010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7726013">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7726016">if</span>&nbsp;<span class="ident" id="7726019">g</span><span class="op" id="7726020">,</span>&nbsp;<span class="ident" id="7726022">e</span>&nbsp;<span class="op" id="7726024">:=</span>&nbsp;<span class="builtinfunc" id="7726027">len</span><span class="op" id="7726030">(</span><span class="ident" id="7726031">res</span><span class="op" id="7726034">.</span><span class="ident" id="7726035">Header</span><span class="op" id="7726041">[</span><span class="string" id="7726042">&#34;X-Multi-Value&#34;</span><span class="op" id="7726057">]</span><span class="op" id="7726058">)</span><span class="op" id="7726059">,</span>&nbsp;<span class="num" id="7726061">2</span><span class="op" id="7726062">;</span>&nbsp;<span class="ident" id="7726064">g</span>&nbsp;<span class="op" id="7726066">!=</span>&nbsp;<span class="ident" id="7726069">e</span>&nbsp;<span class="op" id="7726071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7726075">t</span><span class="op" id="7726076">.</span><span class="ident" id="7726077">Errorf</span><span class="op" id="7726083">(</span><span class="string" id="7726084">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7726133">,</span>&nbsp;<span class="ident" id="7726135">g</span><span class="op" id="7726136">,</span>&nbsp;<span class="ident" id="7726138">e</span><span class="op" id="7726139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7726142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7726145">if</span>&nbsp;<span class="ident" id="7726148">g</span><span class="op" id="7726149">,</span>&nbsp;<span class="ident" id="7726151">e</span>&nbsp;<span class="op" id="7726153">:=</span>&nbsp;<span class="builtinfunc" id="7726156">len</span><span class="op" id="7726159">(</span><span class="ident" id="7726160">res</span><span class="op" id="7726163">.</span><span class="ident" id="7726164">Header</span><span class="op" id="7726170">[</span><span class="string" id="7726171">&#34;Set-Cookie&#34;</span><span class="op" id="7726183">]</span><span class="op" id="7726184">)</span><span class="op" id="7726185">,</span>&nbsp;<span class="num" id="7726187">1</span><span class="op" id="7726188">;</span>&nbsp;<span class="ident" id="7726190">g</span>&nbsp;<span class="op" id="7726192">!=</span>&nbsp;<span class="ident" id="7726195">e</span>&nbsp;<span class="op" id="7726197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7726201">t</span><span class="op" id="7726202">.</span><span class="ident" id="7726203">Fatalf</span><span class="op" id="7726209">(</span><span class="string" id="7726210">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7726238">,</span>&nbsp;<span class="ident" id="7726240">g</span><span class="op" id="7726241">,</span>&nbsp;<span class="ident" id="7726243">e</span><span class="op" id="7726244">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7726247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7726250">if</span>&nbsp;<span class="ident" id="7726253">cookie</span>&nbsp;<span class="op" id="7726260">:=</span>&nbsp;<span class="ident" id="7726263">res</span><span class="op" id="7726266">.</span><span class="ident" id="7726267">Cookies</span><span class="op" id="7726274">(</span><span class="op" id="7726275">)</span><span class="op" id="7726276">[</span><span class="num" id="7726277">0</span><span class="op" id="7726278">]</span><span class="op" id="7726279">;</span>&nbsp;<span class="ident" id="7726281">cookie</span><span class="op" id="7726287">.</span><span class="ident" id="7726288">Name</span>&nbsp;<span class="op" id="7726293">!=</span>&nbsp;<span class="string" id="7726296">&#34;flavor&#34;</span>&nbsp;<span class="op" id="7726305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7726309">t</span><span class="op" id="7726310">.</span><span class="ident" id="7726311">Errorf</span><span class="op" id="7726317">(</span><span class="string" id="7726318">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="7726340">,</span>&nbsp;<span class="ident" id="7726342">cookie</span><span class="op" id="7726348">.</span><span class="ident" id="7726349">Name</span><span class="op" id="7726353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7726356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7726359">bodyBytes</span><span class="op" id="7726368">,</span>&nbsp;<span class="ident" id="7726370">_</span>&nbsp;<span class="op" id="7726372">:=</span>&nbsp;<span class="ident" id="7726375">ioutil</span><span class="op" id="7726381">.</span><span class="ident" id="7726382">ReadAll</span><span class="op" id="7726389">(</span><span class="ident" id="7726390">res</span><span class="op" id="7726393">.</span><span class="ident" id="7726394">Body</span><span class="op" id="7726398">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7726401">if</span>&nbsp;<span class="ident" id="7726404">g</span><span class="op" id="7726405">,</span>&nbsp;<span class="ident" id="7726407">e</span>&nbsp;<span class="op" id="7726409">:=</span>&nbsp;<span class="builtintype" id="7726412">string</span><span class="op" id="7726418">(</span><span class="ident" id="7726419">bodyBytes</span><span class="op" id="7726428">)</span><span class="op" id="7726429">,</span>&nbsp;<span class="ident" id="7726431">backendResponse</span><span class="op" id="7726446">;</span>&nbsp;<span class="ident" id="7726448">g</span>&nbsp;<span class="op" id="7726450">!=</span>&nbsp;<span class="ident" id="7726453">e</span>&nbsp;<span class="op" id="7726455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7726459">t</span><span class="op" id="7726460">.</span><span class="ident" id="7726461">Errorf</span><span class="op" id="7726467">(</span><span class="string" id="7726468">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7726494">,</span>&nbsp;<span class="ident" id="7726496">g</span><span class="op" id="7726497">,</span>&nbsp;<span class="ident" id="7726499">e</span><span class="op" id="7726500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7726503">}</span><br>
<span class="lineno"></span><span class="op" id="7726505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7726508">func</span>&nbsp;<span class="ident" id="7726513">TestXForwardedFor</span><span class="op" id="7726530">(</span><span class="ident" id="7726531">t</span>&nbsp;<span class="op" id="7726533">*</span><span class="ident" id="7726534">testing</span><span class="op" id="7726541">.</span><span class="ident" id="7726542">T</span><span class="op" id="7726543">)</span>&nbsp;<span class="op" id="7726545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7726548">const</span>&nbsp;<span class="ident" id="7726554">prevForwardedFor</span>&nbsp;<span class="op" id="7726571">=</span>&nbsp;<span class="string" id="7726573">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7726586">const</span>&nbsp;<span class="ident" id="7726592">backendResponse</span>&nbsp;<span class="op" id="7726608">=</span>&nbsp;<span class="string" id="7726610">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7726630">const</span>&nbsp;<span class="ident" id="7726636">backendStatus</span>&nbsp;<span class="op" id="7726650">=</span>&nbsp;<span class="num" id="7726652">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7726657">backend</span>&nbsp;<span class="op" id="7726665">:=</span>&nbsp;<span class="ident" id="7726668">httptest</span><span class="op" id="7726676">.</span><span class="ident" id="7726677">NewServer</span><span class="op" id="7726686">(</span><span class="ident" id="7726687">http</span><span class="op" id="7726691">.</span><span class="ident" id="7726692">HandlerFunc</span><span class="op" id="7726703">(</span><span class="keyword" id="7726704">func</span><span class="op" id="7726708">(</span><span class="ident" id="7726709">w</span>&nbsp;<span class="ident" id="7726711">http</span><span class="op" id="7726715">.</span><span class="ident" id="7726716">ResponseWriter</span><span class="op" id="7726730">,</span>&nbsp;<span class="ident" id="7726732">r</span>&nbsp;<span class="op" id="7726734">*</span><span class="ident" id="7726735">http</span><span class="op" id="7726739">.</span><span class="ident" id="7726740">Request</span><span class="op" id="7726747">)</span>&nbsp;<span class="op" id="7726749">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7726753">if</span>&nbsp;<span class="ident" id="7726756">r</span><span class="op" id="7726757">.</span><span class="ident" id="7726758">Header</span><span class="op" id="7726764">.</span><span class="ident" id="7726765">Get</span><span class="op" id="7726768">(</span><span class="string" id="7726769">&#34;X-Forwarded-For&#34;</span><span class="op" id="7726786">)</span>&nbsp;<span class="op" id="7726788">==</span>&nbsp;<span class="string" id="7726791">&#34;&#34;</span>&nbsp;<span class="op" id="7726794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7726799">t</span><span class="op" id="7726800">.</span><span class="ident" id="7726801">Errorf</span><span class="op" id="7726807">(</span><span class="string" id="7726808">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7726843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7726847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7726851">if</span>&nbsp;<span class="op" id="7726854">!</span><span class="ident" id="7726855">strings</span><span class="op" id="7726862">.</span><span class="ident" id="7726863">Contains</span><span class="op" id="7726871">(</span><span class="ident" id="7726872">r</span><span class="op" id="7726873">.</span><span class="ident" id="7726874">Header</span><span class="op" id="7726880">.</span><span class="ident" id="7726881">Get</span><span class="op" id="7726884">(</span><span class="string" id="7726885">&#34;X-Forwarded-For&#34;</span><span class="op" id="7726902">)</span><span class="op" id="7726903">,</span>&nbsp;<span class="ident" id="7726905">prevForwardedFor</span><span class="op" id="7726921">)</span>&nbsp;<span class="op" id="7726923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7726928">t</span><span class="op" id="7726929">.</span><span class="ident" id="7726930">Errorf</span><span class="op" id="7726936">(</span><span class="string" id="7726937">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="7726980">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7726984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7726988">w</span><span class="op" id="7726989">.</span><span class="ident" id="7726990">WriteHeader</span><span class="op" id="7727001">(</span><span class="ident" id="7727002">backendStatus</span><span class="op" id="7727015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727019">w</span><span class="op" id="7727020">.</span><span class="ident" id="7727021">Write</span><span class="op" id="7727026">(</span><span class="op" id="7727027">[</span><span class="op" id="7727028">]</span><span class="builtintype" id="7727029">byte</span><span class="op" id="7727033">(</span><span class="ident" id="7727034">backendResponse</span><span class="op" id="7727049">)</span><span class="op" id="7727050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7727053">}</span><span class="op" id="7727054">)</span><span class="op" id="7727055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7727058">defer</span>&nbsp;<span class="ident" id="7727064">backend</span><span class="op" id="7727071">.</span><span class="ident" id="7727072">Close</span><span class="op" id="7727077">(</span><span class="op" id="7727078">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727081">backendURL</span><span class="op" id="7727091">,</span>&nbsp;<span class="ident" id="7727093">err</span>&nbsp;<span class="op" id="7727097">:=</span>&nbsp;<span class="ident" id="7727100">url</span><span class="op" id="7727103">.</span><span class="ident" id="7727104">Parse</span><span class="op" id="7727109">(</span><span class="ident" id="7727110">backend</span><span class="op" id="7727117">.</span><span class="ident" id="7727118">URL</span><span class="op" id="7727121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7727124">if</span>&nbsp;<span class="ident" id="7727127">err</span>&nbsp;<span class="op" id="7727131">!=</span>&nbsp;<span class="ident" id="7727134">nil</span>&nbsp;<span class="op" id="7727138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727142">t</span><span class="op" id="7727143">.</span><span class="ident" id="7727144">Fatal</span><span class="op" id="7727149">(</span><span class="ident" id="7727150">err</span><span class="op" id="7727153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7727156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727159">proxyHandler</span>&nbsp;<span class="op" id="7727172">:=</span>&nbsp;<span class="ident" id="7727175">NewSingleHostReverseProxy</span><span class="op" id="7727200">(</span><span class="ident" id="7727201">backendURL</span><span class="op" id="7727211">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727214">frontend</span>&nbsp;<span class="op" id="7727223">:=</span>&nbsp;<span class="ident" id="7727226">httptest</span><span class="op" id="7727234">.</span><span class="ident" id="7727235">NewServer</span><span class="op" id="7727244">(</span><span class="ident" id="7727245">proxyHandler</span><span class="op" id="7727257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7727260">defer</span>&nbsp;<span class="ident" id="7727266">frontend</span><span class="op" id="7727274">.</span><span class="ident" id="7727275">Close</span><span class="op" id="7727280">(</span><span class="op" id="7727281">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727285">getReq</span><span class="op" id="7727291">,</span>&nbsp;<span class="ident" id="7727293">_</span>&nbsp;<span class="op" id="7727295">:=</span>&nbsp;<span class="ident" id="7727298">http</span><span class="op" id="7727302">.</span><span class="ident" id="7727303">NewRequest</span><span class="op" id="7727313">(</span><span class="string" id="7727314">&#34;GET&#34;</span><span class="op" id="7727319">,</span>&nbsp;<span class="ident" id="7727321">frontend</span><span class="op" id="7727329">.</span><span class="ident" id="7727330">URL</span><span class="op" id="7727333">,</span>&nbsp;<span class="ident" id="7727335">nil</span><span class="op" id="7727338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727341">getReq</span><span class="op" id="7727347">.</span><span class="ident" id="7727348">Host</span>&nbsp;<span class="op" id="7727353">=</span>&nbsp;<span class="string" id="7727355">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727368">getReq</span><span class="op" id="7727374">.</span><span class="ident" id="7727375">Header</span><span class="op" id="7727381">.</span><span class="ident" id="7727382">Set</span><span class="op" id="7727385">(</span><span class="string" id="7727386">&#34;Connection&#34;</span><span class="op" id="7727398">,</span>&nbsp;<span class="string" id="7727400">&#34;close&#34;</span><span class="op" id="7727407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727410">getReq</span><span class="op" id="7727416">.</span><span class="ident" id="7727417">Header</span><span class="op" id="7727423">.</span><span class="ident" id="7727424">Set</span><span class="op" id="7727427">(</span><span class="string" id="7727428">&#34;X-Forwarded-For&#34;</span><span class="op" id="7727445">,</span>&nbsp;<span class="ident" id="7727447">prevForwardedFor</span><span class="op" id="7727463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727466">getReq</span><span class="op" id="7727472">.</span><span class="ident" id="7727473">Close</span>&nbsp;<span class="op" id="7727479">=</span>&nbsp;<span class="builtintype" id="7727481">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727487">res</span><span class="op" id="7727490">,</span>&nbsp;<span class="ident" id="7727492">err</span>&nbsp;<span class="op" id="7727496">:=</span>&nbsp;<span class="ident" id="7727499">http</span><span class="op" id="7727503">.</span><span class="ident" id="7727504">DefaultClient</span><span class="op" id="7727517">.</span><span class="ident" id="7727518">Do</span><span class="op" id="7727520">(</span><span class="ident" id="7727521">getReq</span><span class="op" id="7727527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7727530">if</span>&nbsp;<span class="ident" id="7727533">err</span>&nbsp;<span class="op" id="7727537">!=</span>&nbsp;<span class="ident" id="7727540">nil</span>&nbsp;<span class="op" id="7727544">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727548">t</span><span class="op" id="7727549">.</span><span class="ident" id="7727550">Fatalf</span><span class="op" id="7727556">(</span><span class="string" id="7727557">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7727566">,</span>&nbsp;<span class="ident" id="7727568">err</span><span class="op" id="7727571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7727574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7727577">if</span>&nbsp;<span class="ident" id="7727580">g</span><span class="op" id="7727581">,</span>&nbsp;<span class="ident" id="7727583">e</span>&nbsp;<span class="op" id="7727585">:=</span>&nbsp;<span class="ident" id="7727588">res</span><span class="op" id="7727591">.</span><span class="ident" id="7727592">StatusCode</span><span class="op" id="7727602">,</span>&nbsp;<span class="ident" id="7727604">backendStatus</span><span class="op" id="7727617">;</span>&nbsp;<span class="ident" id="7727619">g</span>&nbsp;<span class="op" id="7727621">!=</span>&nbsp;<span class="ident" id="7727624">e</span>&nbsp;<span class="op" id="7727626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727630">t</span><span class="op" id="7727631">.</span><span class="ident" id="7727632">Errorf</span><span class="op" id="7727638">(</span><span class="string" id="7727639">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7727675">,</span>&nbsp;<span class="ident" id="7727677">g</span><span class="op" id="7727678">,</span>&nbsp;<span class="ident" id="7727680">e</span><span class="op" id="7727681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7727684">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727687">bodyBytes</span><span class="op" id="7727696">,</span>&nbsp;<span class="ident" id="7727698">_</span>&nbsp;<span class="op" id="7727700">:=</span>&nbsp;<span class="ident" id="7727703">ioutil</span><span class="op" id="7727709">.</span><span class="ident" id="7727710">ReadAll</span><span class="op" id="7727717">(</span><span class="ident" id="7727718">res</span><span class="op" id="7727721">.</span><span class="ident" id="7727722">Body</span><span class="op" id="7727726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7727729">if</span>&nbsp;<span class="ident" id="7727732">g</span><span class="op" id="7727733">,</span>&nbsp;<span class="ident" id="7727735">e</span>&nbsp;<span class="op" id="7727737">:=</span>&nbsp;<span class="builtintype" id="7727740">string</span><span class="op" id="7727746">(</span><span class="ident" id="7727747">bodyBytes</span><span class="op" id="7727756">)</span><span class="op" id="7727757">,</span>&nbsp;<span class="ident" id="7727759">backendResponse</span><span class="op" id="7727774">;</span>&nbsp;<span class="ident" id="7727776">g</span>&nbsp;<span class="op" id="7727778">!=</span>&nbsp;<span class="ident" id="7727781">e</span>&nbsp;<span class="op" id="7727783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727787">t</span><span class="op" id="7727788">.</span><span class="ident" id="7727789">Errorf</span><span class="op" id="7727795">(</span><span class="string" id="7727796">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7727822">,</span>&nbsp;<span class="ident" id="7727824">g</span><span class="op" id="7727825">,</span>&nbsp;<span class="ident" id="7727827">e</span><span class="op" id="7727828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7727831">}</span><br>
<span class="lineno"></span><span class="op" id="7727833">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="7727836">var</span>&nbsp;<span class="ident" id="7727840">proxyQueryTests</span>&nbsp;<span class="op" id="7727856">=</span>&nbsp;<span class="op" id="7727858">[</span><span class="op" id="7727859">]</span><span class="keyword" id="7727860">struct</span>&nbsp;<span class="op" id="7727867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727870">baseSuffix</span>&nbsp;<span class="builtintype" id="7727881">string</span>&nbsp;<span class="comment" id="7727888">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727921">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="7727932">string</span>&nbsp;<span class="comment" id="7727939">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7727983">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7727994">string</span>&nbsp;<span class="comment" id="7728001">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="7728062">}</span><span class="op" id="7728063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7728066">{</span><span class="string" id="7728067">&#34;&#34;</span><span class="op" id="7728069">,</span>&nbsp;<span class="string" id="7728071">&#34;&#34;</span><span class="op" id="7728073">,</span>&nbsp;<span class="string" id="7728075">&#34;&#34;</span><span class="op" id="7728077">}</span><span class="op" id="7728078">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7728081">{</span><span class="string" id="7728082">&#34;?sta=tic&#34;</span><span class="op" id="7728092">,</span>&nbsp;<span class="string" id="7728094">&#34;?us=er&#34;</span><span class="op" id="7728102">,</span>&nbsp;<span class="string" id="7728104">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="7728119">}</span><span class="op" id="7728120">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7728123">{</span><span class="string" id="7728124">&#34;&#34;</span><span class="op" id="7728126">,</span>&nbsp;<span class="string" id="7728128">&#34;?us=er&#34;</span><span class="op" id="7728136">,</span>&nbsp;<span class="string" id="7728138">&#34;us=er&#34;</span><span class="op" id="7728145">}</span><span class="op" id="7728146">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7728149">{</span><span class="string" id="7728150">&#34;?sta=tic&#34;</span><span class="op" id="7728160">,</span>&nbsp;<span class="string" id="7728162">&#34;&#34;</span><span class="op" id="7728164">,</span>&nbsp;<span class="string" id="7728166">&#34;sta=tic&#34;</span><span class="op" id="7728175">}</span><span class="op" id="7728176">,</span><br>
<span class="lineno">145</span><span class="op" id="7728178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7728181">func</span>&nbsp;<span class="ident" id="7728186">TestReverseProxyQuery</span><span class="op" id="7728207">(</span><span class="ident" id="7728208">t</span>&nbsp;<span class="op" id="7728210">*</span><span class="ident" id="7728211">testing</span><span class="op" id="7728218">.</span><span class="ident" id="7728219">T</span><span class="op" id="7728220">)</span>&nbsp;<span class="op" id="7728222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728225">backend</span>&nbsp;<span class="op" id="7728233">:=</span>&nbsp;<span class="ident" id="7728236">httptest</span><span class="op" id="7728244">.</span><span class="ident" id="7728245">NewServer</span><span class="op" id="7728254">(</span><span class="ident" id="7728255">http</span><span class="op" id="7728259">.</span><span class="ident" id="7728260">HandlerFunc</span><span class="op" id="7728271">(</span><span class="keyword" id="7728272">func</span><span class="op" id="7728276">(</span><span class="ident" id="7728277">w</span>&nbsp;<span class="ident" id="7728279">http</span><span class="op" id="7728283">.</span><span class="ident" id="7728284">ResponseWriter</span><span class="op" id="7728298">,</span>&nbsp;<span class="ident" id="7728300">r</span>&nbsp;<span class="op" id="7728302">*</span><span class="ident" id="7728303">http</span><span class="op" id="7728307">.</span><span class="ident" id="7728308">Request</span><span class="op" id="7728315">)</span>&nbsp;<span class="op" id="7728317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728321">w</span><span class="op" id="7728322">.</span><span class="ident" id="7728323">Header</span><span class="op" id="7728329">(</span><span class="op" id="7728330">)</span><span class="op" id="7728331">.</span><span class="ident" id="7728332">Set</span><span class="op" id="7728335">(</span><span class="string" id="7728336">&#34;X-Got-Query&#34;</span><span class="op" id="7728349">,</span>&nbsp;<span class="ident" id="7728351">r</span><span class="op" id="7728352">.</span><span class="ident" id="7728353">URL</span><span class="op" id="7728356">.</span><span class="ident" id="7728357">RawQuery</span><span class="op" id="7728365">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728369">w</span><span class="op" id="7728370">.</span><span class="ident" id="7728371">Write</span><span class="op" id="7728376">(</span><span class="op" id="7728377">[</span><span class="op" id="7728378">]</span><span class="builtintype" id="7728379">byte</span><span class="op" id="7728383">(</span><span class="string" id="7728384">&#34;hi&#34;</span><span class="op" id="7728388">)</span><span class="op" id="7728389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7728392">}</span><span class="op" id="7728393">)</span><span class="op" id="7728394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7728397">defer</span>&nbsp;<span class="ident" id="7728403">backend</span><span class="op" id="7728410">.</span><span class="ident" id="7728411">Close</span><span class="op" id="7728416">(</span><span class="op" id="7728417">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7728421">for</span>&nbsp;<span class="ident" id="7728425">i</span><span class="op" id="7728426">,</span>&nbsp;<span class="ident" id="7728428">tt</span>&nbsp;<span class="op" id="7728431">:=</span>&nbsp;<span class="keyword" id="7728434">range</span>&nbsp;<span class="ident" id="7728440">proxyQueryTests</span>&nbsp;<span class="op" id="7728456">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728460">backendURL</span><span class="op" id="7728470">,</span>&nbsp;<span class="ident" id="7728472">err</span>&nbsp;<span class="op" id="7728476">:=</span>&nbsp;<span class="ident" id="7728479">url</span><span class="op" id="7728482">.</span><span class="ident" id="7728483">Parse</span><span class="op" id="7728488">(</span><span class="ident" id="7728489">backend</span><span class="op" id="7728496">.</span><span class="ident" id="7728497">URL</span>&nbsp;<span class="op" id="7728501">+</span>&nbsp;<span class="ident" id="7728503">tt</span><span class="op" id="7728505">.</span><span class="ident" id="7728506">baseSuffix</span><span class="op" id="7728516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7728520">if</span>&nbsp;<span class="ident" id="7728523">err</span>&nbsp;<span class="op" id="7728527">!=</span>&nbsp;<span class="ident" id="7728530">nil</span>&nbsp;<span class="op" id="7728534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728539">t</span><span class="op" id="7728540">.</span><span class="ident" id="7728541">Fatal</span><span class="op" id="7728546">(</span><span class="ident" id="7728547">err</span><span class="op" id="7728550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7728554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728558">frontend</span>&nbsp;<span class="op" id="7728567">:=</span>&nbsp;<span class="ident" id="7728570">httptest</span><span class="op" id="7728578">.</span><span class="ident" id="7728579">NewServer</span><span class="op" id="7728588">(</span><span class="ident" id="7728589">NewSingleHostReverseProxy</span><span class="op" id="7728614">(</span><span class="ident" id="7728615">backendURL</span><span class="op" id="7728625">)</span><span class="op" id="7728626">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728630">req</span><span class="op" id="7728633">,</span>&nbsp;<span class="ident" id="7728635">_</span>&nbsp;<span class="op" id="7728637">:=</span>&nbsp;<span class="ident" id="7728640">http</span><span class="op" id="7728644">.</span><span class="ident" id="7728645">NewRequest</span><span class="op" id="7728655">(</span><span class="string" id="7728656">&#34;GET&#34;</span><span class="op" id="7728661">,</span>&nbsp;<span class="ident" id="7728663">frontend</span><span class="op" id="7728671">.</span><span class="ident" id="7728672">URL</span><span class="op" id="7728675">+</span><span class="ident" id="7728676">tt</span><span class="op" id="7728678">.</span><span class="ident" id="7728679">reqSuffix</span><span class="op" id="7728688">,</span>&nbsp;<span class="ident" id="7728690">nil</span><span class="op" id="7728693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728697">req</span><span class="op" id="7728700">.</span><span class="ident" id="7728701">Close</span>&nbsp;<span class="op" id="7728707">=</span>&nbsp;<span class="builtintype" id="7728709">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728716">res</span><span class="op" id="7728719">,</span>&nbsp;<span class="ident" id="7728721">err</span>&nbsp;<span class="op" id="7728725">:=</span>&nbsp;<span class="ident" id="7728728">http</span><span class="op" id="7728732">.</span><span class="ident" id="7728733">DefaultClient</span><span class="op" id="7728746">.</span><span class="ident" id="7728747">Do</span><span class="op" id="7728749">(</span><span class="ident" id="7728750">req</span><span class="op" id="7728753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7728757">if</span>&nbsp;<span class="ident" id="7728760">err</span>&nbsp;<span class="op" id="7728764">!=</span>&nbsp;<span class="ident" id="7728767">nil</span>&nbsp;<span class="op" id="7728771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728776">t</span><span class="op" id="7728777">.</span><span class="ident" id="7728778">Fatalf</span><span class="op" id="7728784">(</span><span class="string" id="7728785">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="7728798">,</span>&nbsp;<span class="ident" id="7728800">i</span><span class="op" id="7728801">,</span>&nbsp;<span class="ident" id="7728803">err</span><span class="op" id="7728806">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7728810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7728814">if</span>&nbsp;<span class="ident" id="7728817">g</span><span class="op" id="7728818">,</span>&nbsp;<span class="ident" id="7728820">e</span>&nbsp;<span class="op" id="7728822">:=</span>&nbsp;<span class="ident" id="7728825">res</span><span class="op" id="7728828">.</span><span class="ident" id="7728829">Header</span><span class="op" id="7728835">.</span><span class="ident" id="7728836">Get</span><span class="op" id="7728839">(</span><span class="string" id="7728840">&#34;X-Got-Query&#34;</span><span class="op" id="7728853">)</span><span class="op" id="7728854">,</span>&nbsp;<span class="ident" id="7728856">tt</span><span class="op" id="7728858">.</span><span class="ident" id="7728859">want</span><span class="op" id="7728863">;</span>&nbsp;<span class="ident" id="7728865">g</span>&nbsp;<span class="op" id="7728867">!=</span>&nbsp;<span class="ident" id="7728870">e</span>&nbsp;<span class="op" id="7728872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728877">t</span><span class="op" id="7728878">.</span><span class="ident" id="7728879">Errorf</span><span class="op" id="7728885">(</span><span class="string" id="7728886">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7728917">,</span>&nbsp;<span class="ident" id="7728919">i</span><span class="op" id="7728920">,</span>&nbsp;<span class="ident" id="7728922">g</span><span class="op" id="7728923">,</span>&nbsp;<span class="ident" id="7728925">e</span><span class="op" id="7728926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7728930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728934">res</span><span class="op" id="7728937">.</span><span class="ident" id="7728938">Body</span><span class="op" id="7728942">.</span><span class="ident" id="7728943">Close</span><span class="op" id="7728948">(</span><span class="op" id="7728949">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7728953">frontend</span><span class="op" id="7728961">.</span><span class="ident" id="7728962">Close</span><span class="op" id="7728967">(</span><span class="op" id="7728968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7728971">}</span><br>
<span class="lineno"></span><span class="op" id="7728973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7728976">func</span>&nbsp;<span class="ident" id="7728981">TestReverseProxyFlushInterval</span><span class="op" id="7729010">(</span><span class="ident" id="7729011">t</span>&nbsp;<span class="op" id="7729013">*</span><span class="ident" id="7729014">testing</span><span class="op" id="7729021">.</span><span class="ident" id="7729022">T</span><span class="op" id="7729023">)</span>&nbsp;<span class="op" id="7729025">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7729028">const</span>&nbsp;<span class="ident" id="7729034">expected</span>&nbsp;<span class="op" id="7729043">=</span>&nbsp;<span class="string" id="7729045">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729051">backend</span>&nbsp;<span class="op" id="7729059">:=</span>&nbsp;<span class="ident" id="7729062">httptest</span><span class="op" id="7729070">.</span><span class="ident" id="7729071">NewServer</span><span class="op" id="7729080">(</span><span class="ident" id="7729081">http</span><span class="op" id="7729085">.</span><span class="ident" id="7729086">HandlerFunc</span><span class="op" id="7729097">(</span><span class="keyword" id="7729098">func</span><span class="op" id="7729102">(</span><span class="ident" id="7729103">w</span>&nbsp;<span class="ident" id="7729105">http</span><span class="op" id="7729109">.</span><span class="ident" id="7729110">ResponseWriter</span><span class="op" id="7729124">,</span>&nbsp;<span class="ident" id="7729126">r</span>&nbsp;<span class="op" id="7729128">*</span><span class="ident" id="7729129">http</span><span class="op" id="7729133">.</span><span class="ident" id="7729134">Request</span><span class="op" id="7729141">)</span>&nbsp;<span class="op" id="7729143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729147">w</span><span class="op" id="7729148">.</span><span class="ident" id="7729149">Write</span><span class="op" id="7729154">(</span><span class="op" id="7729155">[</span><span class="op" id="7729156">]</span><span class="builtintype" id="7729157">byte</span><span class="op" id="7729161">(</span><span class="ident" id="7729162">expected</span><span class="op" id="7729170">)</span><span class="op" id="7729171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7729174">}</span><span class="op" id="7729175">)</span><span class="op" id="7729176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7729179">defer</span>&nbsp;<span class="ident" id="7729185">backend</span><span class="op" id="7729192">.</span><span class="ident" id="7729193">Close</span><span class="op" id="7729198">(</span><span class="op" id="7729199">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729203">backendURL</span><span class="op" id="7729213">,</span>&nbsp;<span class="ident" id="7729215">err</span>&nbsp;<span class="op" id="7729219">:=</span>&nbsp;<span class="ident" id="7729222">url</span><span class="op" id="7729225">.</span><span class="ident" id="7729226">Parse</span><span class="op" id="7729231">(</span><span class="ident" id="7729232">backend</span><span class="op" id="7729239">.</span><span class="ident" id="7729240">URL</span><span class="op" id="7729243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7729246">if</span>&nbsp;<span class="ident" id="7729249">err</span>&nbsp;<span class="op" id="7729253">!=</span>&nbsp;<span class="ident" id="7729256">nil</span>&nbsp;<span class="op" id="7729260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729264">t</span><span class="op" id="7729265">.</span><span class="ident" id="7729266">Fatal</span><span class="op" id="7729271">(</span><span class="ident" id="7729272">err</span><span class="op" id="7729275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7729278">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729282">proxyHandler</span>&nbsp;<span class="op" id="7729295">:=</span>&nbsp;<span class="ident" id="7729298">NewSingleHostReverseProxy</span><span class="op" id="7729323">(</span><span class="ident" id="7729324">backendURL</span><span class="op" id="7729334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729337">proxyHandler</span><span class="op" id="7729349">.</span><span class="ident" id="7729350">FlushInterval</span>&nbsp;<span class="op" id="7729364">=</span>&nbsp;<span class="ident" id="7729366">time</span><span class="op" id="7729370">.</span><span class="ident" id="7729371">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729385">done</span>&nbsp;<span class="op" id="7729390">:=</span>&nbsp;<span class="builtinfunc" id="7729393">make</span><span class="op" id="7729397">(</span><span class="keyword" id="7729398">chan</span>&nbsp;<span class="builtintype" id="7729403">bool</span><span class="op" id="7729407">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729410">onExitFlushLoop</span>&nbsp;<span class="op" id="7729426">=</span>&nbsp;<span class="keyword" id="7729428">func</span><span class="op" id="7729432">(</span><span class="op" id="7729433">)</span>&nbsp;<span class="op" id="7729435">{</span>&nbsp;<span class="ident" id="7729437">done</span>&nbsp;<span class="op" id="7729442">&lt;-</span>&nbsp;<span class="builtintype" id="7729445">true</span>&nbsp;<span class="op" id="7729450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7729453">defer</span>&nbsp;<span class="keyword" id="7729459">func</span><span class="op" id="7729463">(</span><span class="op" id="7729464">)</span>&nbsp;<span class="op" id="7729466">{</span>&nbsp;<span class="ident" id="7729468">onExitFlushLoop</span>&nbsp;<span class="op" id="7729484">=</span>&nbsp;<span class="ident" id="7729486">nil</span>&nbsp;<span class="op" id="7729490">}</span><span class="op" id="7729491">(</span><span class="op" id="7729492">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729496">frontend</span>&nbsp;<span class="op" id="7729505">:=</span>&nbsp;<span class="ident" id="7729508">httptest</span><span class="op" id="7729516">.</span><span class="ident" id="7729517">NewServer</span><span class="op" id="7729526">(</span><span class="ident" id="7729527">proxyHandler</span><span class="op" id="7729539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7729542">defer</span>&nbsp;<span class="ident" id="7729548">frontend</span><span class="op" id="7729556">.</span><span class="ident" id="7729557">Close</span><span class="op" id="7729562">(</span><span class="op" id="7729563">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729567">req</span><span class="op" id="7729570">,</span>&nbsp;<span class="ident" id="7729572">_</span>&nbsp;<span class="op" id="7729574">:=</span>&nbsp;<span class="ident" id="7729577">http</span><span class="op" id="7729581">.</span><span class="ident" id="7729582">NewRequest</span><span class="op" id="7729592">(</span><span class="string" id="7729593">&#34;GET&#34;</span><span class="op" id="7729598">,</span>&nbsp;<span class="ident" id="7729600">frontend</span><span class="op" id="7729608">.</span><span class="ident" id="7729609">URL</span><span class="op" id="7729612">,</span>&nbsp;<span class="ident" id="7729614">nil</span><span class="op" id="7729617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729620">req</span><span class="op" id="7729623">.</span><span class="ident" id="7729624">Close</span>&nbsp;<span class="op" id="7729630">=</span>&nbsp;<span class="builtintype" id="7729632">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729638">res</span><span class="op" id="7729641">,</span>&nbsp;<span class="ident" id="7729643">err</span>&nbsp;<span class="op" id="7729647">:=</span>&nbsp;<span class="ident" id="7729650">http</span><span class="op" id="7729654">.</span><span class="ident" id="7729655">DefaultClient</span><span class="op" id="7729668">.</span><span class="ident" id="7729669">Do</span><span class="op" id="7729671">(</span><span class="ident" id="7729672">req</span><span class="op" id="7729675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7729678">if</span>&nbsp;<span class="ident" id="7729681">err</span>&nbsp;<span class="op" id="7729685">!=</span>&nbsp;<span class="ident" id="7729688">nil</span>&nbsp;<span class="op" id="7729692">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729696">t</span><span class="op" id="7729697">.</span><span class="ident" id="7729698">Fatalf</span><span class="op" id="7729704">(</span><span class="string" id="7729705">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7729714">,</span>&nbsp;<span class="ident" id="7729716">err</span><span class="op" id="7729719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7729722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7729725">defer</span>&nbsp;<span class="ident" id="7729731">res</span><span class="op" id="7729734">.</span><span class="ident" id="7729735">Body</span><span class="op" id="7729739">.</span><span class="ident" id="7729740">Close</span><span class="op" id="7729745">(</span><span class="op" id="7729746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7729749">if</span>&nbsp;<span class="ident" id="7729752">bodyBytes</span><span class="op" id="7729761">,</span>&nbsp;<span class="ident" id="7729763">_</span>&nbsp;<span class="op" id="7729765">:=</span>&nbsp;<span class="ident" id="7729768">ioutil</span><span class="op" id="7729774">.</span><span class="ident" id="7729775">ReadAll</span><span class="op" id="7729782">(</span><span class="ident" id="7729783">res</span><span class="op" id="7729786">.</span><span class="ident" id="7729787">Body</span><span class="op" id="7729791">)</span><span class="op" id="7729792">;</span>&nbsp;<span class="builtintype" id="7729794">string</span><span class="op" id="7729800">(</span><span class="ident" id="7729801">bodyBytes</span><span class="op" id="7729810">)</span>&nbsp;<span class="op" id="7729812">!=</span>&nbsp;<span class="ident" id="7729815">expected</span>&nbsp;<span class="op" id="7729824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729828">t</span><span class="op" id="7729829">.</span><span class="ident" id="7729830">Errorf</span><span class="op" id="7729836">(</span><span class="string" id="7729837">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7729863">,</span>&nbsp;<span class="ident" id="7729865">bodyBytes</span><span class="op" id="7729874">,</span>&nbsp;<span class="ident" id="7729876">expected</span><span class="op" id="7729884">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7729887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7729891">select</span>&nbsp;<span class="op" id="7729898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7729901">case</span>&nbsp;<span class="op" id="7729906">&lt;-</span><span class="ident" id="7729908">done</span><span class="op" id="7729912">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7729916">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7729923">case</span>&nbsp;<span class="op" id="7729928">&lt;-</span><span class="ident" id="7729930">time</span><span class="op" id="7729934">.</span><span class="ident" id="7729935">After</span><span class="op" id="7729940">(</span><span class="num" id="7729941">5</span>&nbsp;<span class="op" id="7729943">*</span>&nbsp;<span class="ident" id="7729945">time</span><span class="op" id="7729949">.</span><span class="ident" id="7729950">Second</span><span class="op" id="7729956">)</span><span class="op" id="7729957">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7729961">t</span><span class="op" id="7729962">.</span><span class="ident" id="7729963">Error</span><span class="op" id="7729968">(</span><span class="string" id="7729969">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="7730012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7730015">}</span><br>
<span class="lineno"></span><span class="op" id="7730017">}</span>
</div>
</body>
</html>
