<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html" class="current">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7148265">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7148320">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7148374">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7148425">package</span>&nbsp;<span class="ident" id="7148433">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7148439">import</span>&nbsp;<span class="op" id="7148446">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148449">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148458">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148465">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148474">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148489">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148495">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148508">&#34;math/rand&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148521">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148527">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148538">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7148548">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="7148551">//&nbsp;TestDecodeProgressive&nbsp;tests&nbsp;that&nbsp;decoding&nbsp;the&nbsp;baseline&nbsp;and&nbsp;progressive</span><br>
<span class="lineno"></span><span class="comment" id="7148625">//&nbsp;versions&nbsp;of&nbsp;the&nbsp;same&nbsp;image&nbsp;result&nbsp;in&nbsp;exactly&nbsp;the&nbsp;same&nbsp;pixel&nbsp;data,&nbsp;in&nbsp;YCbCr</span><br>
<span class="lineno"></span><span class="comment" id="7148703">//&nbsp;space&nbsp;for&nbsp;color&nbsp;images,&nbsp;and&nbsp;Y&nbsp;space&nbsp;for&nbsp;grayscale&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="7148764">func</span>&nbsp;<span class="ident" id="7148769">TestDecodeProgressive</span><span class="op" id="7148790">(</span><span class="ident" id="7148791">t</span>&nbsp;<span class="op" id="7148793">*</span><span class="ident" id="7148794">testing</span><span class="op" id="7148801">.</span><span class="ident" id="7148802">T</span><span class="op" id="7148803">)</span>&nbsp;<span class="op" id="7148805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7148808">testCases</span>&nbsp;<span class="op" id="7148818">:=</span>&nbsp;<span class="op" id="7148821">[</span><span class="op" id="7148822">]</span><span class="builtintype" id="7148823">string</span><span class="op" id="7148829">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148833">&#34;../testdata/video-001&#34;</span><span class="op" id="7148856">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148860">&#34;../testdata/video-001.q50.420&#34;</span><span class="op" id="7148891">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148895">&#34;../testdata/video-001.q50.422&#34;</span><span class="op" id="7148926">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148930">&#34;../testdata/video-001.q50.440&#34;</span><span class="op" id="7148961">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7148965">&#34;../testdata/video-001.q50.444&#34;</span><span class="op" id="7148996">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7149000">&#34;../testdata/video-005.gray.q50&#34;</span><span class="op" id="7149032">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7149036">&#34;../testdata/video-005.gray.q50.2x2&#34;</span><span class="op" id="7149072">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7149076">&#34;../testdata/video-001.separate.dc.progression&#34;</span><span class="op" id="7149123">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7149126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149129">for</span>&nbsp;<span class="ident" id="7149133">_</span><span class="op" id="7149134">,</span>&nbsp;<span class="ident" id="7149136">tc</span>&nbsp;<span class="op" id="7149139">:=</span>&nbsp;<span class="keyword" id="7149142">range</span>&nbsp;<span class="ident" id="7149148">testCases</span>&nbsp;<span class="op" id="7149158">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7149162">m0</span><span class="op" id="7149164">,</span>&nbsp;<span class="ident" id="7149166">err</span>&nbsp;<span class="op" id="7149170">:=</span>&nbsp;<span class="ident" id="7149173">decodeFile</span><span class="op" id="7149183">(</span><span class="ident" id="7149184">tc</span>&nbsp;<span class="op" id="7149187">+</span>&nbsp;<span class="string" id="7149189">&#34;.jpeg&#34;</span><span class="op" id="7149196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149200">if</span>&nbsp;<span class="ident" id="7149203">err</span>&nbsp;<span class="op" id="7149207">!=</span>&nbsp;<span class="ident" id="7149210">nil</span>&nbsp;<span class="op" id="7149214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7149219">t</span><span class="op" id="7149220">.</span><span class="ident" id="7149221">Errorf</span><span class="op" id="7149227">(</span><span class="string" id="7149228">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7149236">,</span>&nbsp;<span class="ident" id="7149238">tc</span><span class="op" id="7149240">+</span><span class="string" id="7149241">&#34;.jpeg&#34;</span><span class="op" id="7149248">,</span>&nbsp;<span class="ident" id="7149250">err</span><span class="op" id="7149253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149258">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7149269">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7149273">m1</span><span class="op" id="7149275">,</span>&nbsp;<span class="ident" id="7149277">err</span>&nbsp;<span class="op" id="7149281">:=</span>&nbsp;<span class="ident" id="7149284">decodeFile</span><span class="op" id="7149294">(</span><span class="ident" id="7149295">tc</span>&nbsp;<span class="op" id="7149298">+</span>&nbsp;<span class="string" id="7149300">&#34;.progressive.jpeg&#34;</span><span class="op" id="7149319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149323">if</span>&nbsp;<span class="ident" id="7149326">err</span>&nbsp;<span class="op" id="7149330">!=</span>&nbsp;<span class="ident" id="7149333">nil</span>&nbsp;<span class="op" id="7149337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7149342">t</span><span class="op" id="7149343">.</span><span class="ident" id="7149344">Errorf</span><span class="op" id="7149350">(</span><span class="string" id="7149351">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7149359">,</span>&nbsp;<span class="ident" id="7149361">tc</span><span class="op" id="7149363">+</span><span class="string" id="7149364">&#34;.progressive.jpeg&#34;</span><span class="op" id="7149383">,</span>&nbsp;<span class="ident" id="7149385">err</span><span class="op" id="7149388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149393">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7149404">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149408">if</span>&nbsp;<span class="ident" id="7149411">m0</span><span class="op" id="7149413">.</span><span class="ident" id="7149414">Bounds</span><span class="op" id="7149420">(</span><span class="op" id="7149421">)</span>&nbsp;<span class="op" id="7149423">!=</span>&nbsp;<span class="ident" id="7149426">m1</span><span class="op" id="7149428">.</span><span class="ident" id="7149429">Bounds</span><span class="op" id="7149435">(</span><span class="op" id="7149436">)</span>&nbsp;<span class="op" id="7149438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7149443">t</span><span class="op" id="7149444">.</span><span class="ident" id="7149445">Errorf</span><span class="op" id="7149451">(</span><span class="string" id="7149452">&#34;%s:&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7149482">,</span>&nbsp;<span class="ident" id="7149484">tc</span><span class="op" id="7149486">,</span>&nbsp;<span class="ident" id="7149488">m0</span><span class="op" id="7149490">.</span><span class="ident" id="7149491">Bounds</span><span class="op" id="7149497">(</span><span class="op" id="7149498">)</span><span class="op" id="7149499">,</span>&nbsp;<span class="ident" id="7149501">m1</span><span class="op" id="7149503">.</span><span class="ident" id="7149504">Bounds</span><span class="op" id="7149510">(</span><span class="op" id="7149511">)</span><span class="op" id="7149512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149517">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7149528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7149532">//&nbsp;All&nbsp;of&nbsp;the&nbsp;video-*.jpeg&nbsp;files&nbsp;are&nbsp;150x103.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149580">if</span>&nbsp;<span class="ident" id="7149583">m0</span><span class="op" id="7149585">.</span><span class="ident" id="7149586">Bounds</span><span class="op" id="7149592">(</span><span class="op" id="7149593">)</span>&nbsp;<span class="op" id="7149595">!=</span>&nbsp;<span class="ident" id="7149598">image</span><span class="op" id="7149603">.</span><span class="ident" id="7149604">Rect</span><span class="op" id="7149608">(</span><span class="num" id="7149609">0</span><span class="op" id="7149610">,</span>&nbsp;<span class="num" id="7149612">0</span><span class="op" id="7149613">,</span>&nbsp;<span class="num" id="7149615">150</span><span class="op" id="7149618">,</span>&nbsp;<span class="num" id="7149620">103</span><span class="op" id="7149623">)</span>&nbsp;<span class="op" id="7149625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7149630">t</span><span class="op" id="7149631">.</span><span class="ident" id="7149632">Errorf</span><span class="op" id="7149638">(</span><span class="string" id="7149639">&#34;%s:&nbsp;bad&nbsp;bounds:&nbsp;%v&#34;</span><span class="op" id="7149659">,</span>&nbsp;<span class="ident" id="7149661">tc</span><span class="op" id="7149663">,</span>&nbsp;<span class="ident" id="7149665">m0</span><span class="op" id="7149667">.</span><span class="ident" id="7149668">Bounds</span><span class="op" id="7149674">(</span><span class="op" id="7149675">)</span><span class="op" id="7149676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149681">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7149692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149697">switch</span>&nbsp;<span class="ident" id="7149704">m0</span>&nbsp;<span class="op" id="7149707">:=</span>&nbsp;<span class="ident" id="7149710">m0</span><span class="op" id="7149712">.</span><span class="op" id="7149713">(</span><span class="keyword" id="7149714">type</span><span class="op" id="7149718">)</span>&nbsp;<span class="op" id="7149720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149724">case</span>&nbsp;<span class="op" id="7149729">*</span><span class="ident" id="7149730">image</span><span class="op" id="7149735">.</span><span class="ident" id="7149736">YCbCr</span><span class="op" id="7149741">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7149746">m1</span>&nbsp;<span class="op" id="7149749">:=</span>&nbsp;<span class="ident" id="7149752">m1</span><span class="op" id="7149754">.</span><span class="op" id="7149755">(</span><span class="op" id="7149756">*</span><span class="ident" id="7149757">image</span><span class="op" id="7149762">.</span><span class="ident" id="7149763">YCbCr</span><span class="op" id="7149768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149773">if</span>&nbsp;<span class="ident" id="7149776">err</span>&nbsp;<span class="op" id="7149780">:=</span>&nbsp;<span class="ident" id="7149783">check</span><span class="op" id="7149788">(</span><span class="ident" id="7149789">m0</span><span class="op" id="7149791">.</span><span class="ident" id="7149792">Bounds</span><span class="op" id="7149798">(</span><span class="op" id="7149799">)</span><span class="op" id="7149800">,</span>&nbsp;<span class="ident" id="7149802">m0</span><span class="op" id="7149804">.</span><span class="ident" id="7149805">Y</span><span class="op" id="7149806">,</span>&nbsp;<span class="ident" id="7149808">m1</span><span class="op" id="7149810">.</span><span class="ident" id="7149811">Y</span><span class="op" id="7149812">,</span>&nbsp;<span class="ident" id="7149814">m0</span><span class="op" id="7149816">.</span><span class="ident" id="7149817">YStride</span><span class="op" id="7149824">,</span>&nbsp;<span class="ident" id="7149826">m1</span><span class="op" id="7149828">.</span><span class="ident" id="7149829">YStride</span><span class="op" id="7149836">)</span><span class="op" id="7149837">;</span>&nbsp;<span class="ident" id="7149839">err</span>&nbsp;<span class="op" id="7149843">!=</span>&nbsp;<span class="ident" id="7149846">nil</span>&nbsp;<span class="op" id="7149850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7149856">t</span><span class="op" id="7149857">.</span><span class="ident" id="7149858">Errorf</span><span class="op" id="7149864">(</span><span class="string" id="7149865">&#34;%s&nbsp;(Y):&nbsp;%v&#34;</span><span class="op" id="7149877">,</span>&nbsp;<span class="ident" id="7149879">tc</span><span class="op" id="7149881">,</span>&nbsp;<span class="ident" id="7149883">err</span><span class="op" id="7149886">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149892">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7149904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7149909">if</span>&nbsp;<span class="ident" id="7149912">err</span>&nbsp;<span class="op" id="7149916">:=</span>&nbsp;<span class="ident" id="7149919">check</span><span class="op" id="7149924">(</span><span class="ident" id="7149925">m0</span><span class="op" id="7149927">.</span><span class="ident" id="7149928">Bounds</span><span class="op" id="7149934">(</span><span class="op" id="7149935">)</span><span class="op" id="7149936">,</span>&nbsp;<span class="ident" id="7149938">m0</span><span class="op" id="7149940">.</span><span class="ident" id="7149941">Cb</span><span class="op" id="7149943">,</span>&nbsp;<span class="ident" id="7149945">m1</span><span class="op" id="7149947">.</span><span class="ident" id="7149948">Cb</span><span class="op" id="7149950">,</span>&nbsp;<span class="ident" id="7149952">m0</span><span class="op" id="7149954">.</span><span class="ident" id="7149955">CStride</span><span class="op" id="7149962">,</span>&nbsp;<span class="ident" id="7149964">m1</span><span class="op" id="7149966">.</span><span class="ident" id="7149967">CStride</span><span class="op" id="7149974">)</span><span class="op" id="7149975">;</span>&nbsp;<span class="ident" id="7149977">err</span>&nbsp;<span class="op" id="7149981">!=</span>&nbsp;<span class="ident" id="7149984">nil</span>&nbsp;<span class="op" id="7149988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7149994">t</span><span class="op" id="7149995">.</span><span class="ident" id="7149996">Errorf</span><span class="op" id="7150002">(</span><span class="string" id="7150003">&#34;%s&nbsp;(Cb):&nbsp;%v&#34;</span><span class="op" id="7150016">,</span>&nbsp;<span class="ident" id="7150018">tc</span><span class="op" id="7150020">,</span>&nbsp;<span class="ident" id="7150022">err</span><span class="op" id="7150025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150031">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7150043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150048">if</span>&nbsp;<span class="ident" id="7150051">err</span>&nbsp;<span class="op" id="7150055">:=</span>&nbsp;<span class="ident" id="7150058">check</span><span class="op" id="7150063">(</span><span class="ident" id="7150064">m0</span><span class="op" id="7150066">.</span><span class="ident" id="7150067">Bounds</span><span class="op" id="7150073">(</span><span class="op" id="7150074">)</span><span class="op" id="7150075">,</span>&nbsp;<span class="ident" id="7150077">m0</span><span class="op" id="7150079">.</span><span class="ident" id="7150080">Cr</span><span class="op" id="7150082">,</span>&nbsp;<span class="ident" id="7150084">m1</span><span class="op" id="7150086">.</span><span class="ident" id="7150087">Cr</span><span class="op" id="7150089">,</span>&nbsp;<span class="ident" id="7150091">m0</span><span class="op" id="7150093">.</span><span class="ident" id="7150094">CStride</span><span class="op" id="7150101">,</span>&nbsp;<span class="ident" id="7150103">m1</span><span class="op" id="7150105">.</span><span class="ident" id="7150106">CStride</span><span class="op" id="7150113">)</span><span class="op" id="7150114">;</span>&nbsp;<span class="ident" id="7150116">err</span>&nbsp;<span class="op" id="7150120">!=</span>&nbsp;<span class="ident" id="7150123">nil</span>&nbsp;<span class="op" id="7150127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150133">t</span><span class="op" id="7150134">.</span><span class="ident" id="7150135">Errorf</span><span class="op" id="7150141">(</span><span class="string" id="7150142">&#34;%s&nbsp;(Cr):&nbsp;%v&#34;</span><span class="op" id="7150155">,</span>&nbsp;<span class="ident" id="7150157">tc</span><span class="op" id="7150159">,</span>&nbsp;<span class="ident" id="7150161">err</span><span class="op" id="7150164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150170">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7150182">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150186">case</span>&nbsp;<span class="op" id="7150191">*</span><span class="ident" id="7150192">image</span><span class="op" id="7150197">.</span><span class="ident" id="7150198">Gray</span><span class="op" id="7150202">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150207">m1</span>&nbsp;<span class="op" id="7150210">:=</span>&nbsp;<span class="ident" id="7150213">m1</span><span class="op" id="7150215">.</span><span class="op" id="7150216">(</span><span class="op" id="7150217">*</span><span class="ident" id="7150218">image</span><span class="op" id="7150223">.</span><span class="ident" id="7150224">Gray</span><span class="op" id="7150228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150233">if</span>&nbsp;<span class="ident" id="7150236">err</span>&nbsp;<span class="op" id="7150240">:=</span>&nbsp;<span class="ident" id="7150243">check</span><span class="op" id="7150248">(</span><span class="ident" id="7150249">m0</span><span class="op" id="7150251">.</span><span class="ident" id="7150252">Bounds</span><span class="op" id="7150258">(</span><span class="op" id="7150259">)</span><span class="op" id="7150260">,</span>&nbsp;<span class="ident" id="7150262">m0</span><span class="op" id="7150264">.</span><span class="ident" id="7150265">Pix</span><span class="op" id="7150268">,</span>&nbsp;<span class="ident" id="7150270">m1</span><span class="op" id="7150272">.</span><span class="ident" id="7150273">Pix</span><span class="op" id="7150276">,</span>&nbsp;<span class="ident" id="7150278">m0</span><span class="op" id="7150280">.</span><span class="ident" id="7150281">Stride</span><span class="op" id="7150287">,</span>&nbsp;<span class="ident" id="7150289">m1</span><span class="op" id="7150291">.</span><span class="ident" id="7150292">Stride</span><span class="op" id="7150298">)</span><span class="op" id="7150299">;</span>&nbsp;<span class="ident" id="7150301">err</span>&nbsp;<span class="op" id="7150305">!=</span>&nbsp;<span class="ident" id="7150308">nil</span>&nbsp;<span class="op" id="7150312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150318">t</span><span class="op" id="7150319">.</span><span class="ident" id="7150320">Errorf</span><span class="op" id="7150326">(</span><span class="string" id="7150327">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7150335">,</span>&nbsp;<span class="ident" id="7150337">tc</span><span class="op" id="7150339">,</span>&nbsp;<span class="ident" id="7150341">err</span><span class="op" id="7150344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150350">continue</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7150362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150366">default</span><span class="op" id="7150373">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150378">t</span><span class="op" id="7150379">.</span><span class="ident" id="7150380">Errorf</span><span class="op" id="7150386">(</span><span class="string" id="7150387">&#34;%s:&nbsp;unexpected&nbsp;image&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7150417">,</span>&nbsp;<span class="ident" id="7150419">tc</span><span class="op" id="7150421">,</span>&nbsp;<span class="ident" id="7150423">m0</span><span class="op" id="7150425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150430">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7150441">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7150444">}</span><br>
<span class="lineno"></span><span class="op" id="7150446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7150449">func</span>&nbsp;<span class="ident" id="7150454">decodeFile</span><span class="op" id="7150464">(</span><span class="ident" id="7150465">filename</span>&nbsp;<span class="builtintype" id="7150474">string</span><span class="op" id="7150480">)</span>&nbsp;<span class="op" id="7150482">(</span><span class="ident" id="7150483">image</span><span class="op" id="7150488">.</span><span class="ident" id="7150489">Image</span><span class="op" id="7150494">,</span>&nbsp;<span class="builtintype" id="7150496">error</span><span class="op" id="7150501">)</span>&nbsp;<span class="op" id="7150503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150506">f</span><span class="op" id="7150507">,</span>&nbsp;<span class="ident" id="7150509">err</span>&nbsp;<span class="op" id="7150513">:=</span>&nbsp;<span class="ident" id="7150516">os</span><span class="op" id="7150518">.</span><span class="ident" id="7150519">Open</span><span class="op" id="7150523">(</span><span class="ident" id="7150524">filename</span><span class="op" id="7150532">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150535">if</span>&nbsp;<span class="ident" id="7150538">err</span>&nbsp;<span class="op" id="7150542">!=</span>&nbsp;<span class="ident" id="7150545">nil</span>&nbsp;<span class="op" id="7150549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150553">return</span>&nbsp;<span class="ident" id="7150560">nil</span><span class="op" id="7150563">,</span>&nbsp;<span class="ident" id="7150565">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7150570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150573">defer</span>&nbsp;<span class="ident" id="7150579">f</span><span class="op" id="7150580">.</span><span class="ident" id="7150581">Close</span><span class="op" id="7150586">(</span><span class="op" id="7150587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150590">return</span>&nbsp;<span class="ident" id="7150597">Decode</span><span class="op" id="7150603">(</span><span class="ident" id="7150604">f</span><span class="op" id="7150605">)</span><br>
<span class="lineno">90</span><span class="op" id="7150607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7150610">type</span>&nbsp;<span class="ident" id="7150615">eofReader</span>&nbsp;<span class="keyword" id="7150625">struct</span>&nbsp;<span class="op" id="7150632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150635">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7150644">[</span><span class="op" id="7150645">]</span><span class="builtintype" id="7150646">byte</span>&nbsp;<span class="comment" id="7150651">//&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;without&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150685">dataEOF</span>&nbsp;&nbsp;<span class="op" id="7150694">[</span><span class="op" id="7150695">]</span><span class="builtintype" id="7150696">byte</span>&nbsp;<span class="comment" id="7150701">//&nbsp;then&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;with&nbsp;EOF&nbsp;on&nbsp;last&nbsp;chunk</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150751">lenAtEOF</span>&nbsp;<span class="builtintype" id="7150760">int</span><br>
<span class="lineno"></span><span class="op" id="7150764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7150767">func</span>&nbsp;<span class="op" id="7150772">(</span><span class="ident" id="7150773">r</span>&nbsp;<span class="op" id="7150775">*</span><span class="ident" id="7150776">eofReader</span><span class="op" id="7150785">)</span>&nbsp;<span class="ident" id="7150787">Read</span><span class="op" id="7150791">(</span><span class="ident" id="7150792">b</span>&nbsp;<span class="op" id="7150794">[</span><span class="op" id="7150795">]</span><span class="builtintype" id="7150796">byte</span><span class="op" id="7150800">)</span>&nbsp;<span class="op" id="7150802">(</span><span class="ident" id="7150803">n</span>&nbsp;<span class="builtintype" id="7150805">int</span><span class="op" id="7150808">,</span>&nbsp;<span class="ident" id="7150810">err</span>&nbsp;<span class="builtintype" id="7150814">error</span><span class="op" id="7150819">)</span>&nbsp;<span class="op" id="7150821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150824">if</span>&nbsp;<span class="builtinfunc" id="7150827">len</span><span class="op" id="7150830">(</span><span class="ident" id="7150831">r</span><span class="op" id="7150832">.</span><span class="ident" id="7150833">data</span><span class="op" id="7150837">)</span>&nbsp;<span class="op" id="7150839">&gt;</span>&nbsp;<span class="num" id="7150841">0</span>&nbsp;<span class="op" id="7150843">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150847">n</span>&nbsp;<span class="op" id="7150849">=</span>&nbsp;<span class="builtinfunc" id="7150851">copy</span><span class="op" id="7150855">(</span><span class="ident" id="7150856">b</span><span class="op" id="7150857">,</span>&nbsp;<span class="ident" id="7150859">r</span><span class="op" id="7150860">.</span><span class="ident" id="7150861">data</span><span class="op" id="7150865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150869">r</span><span class="op" id="7150870">.</span><span class="ident" id="7150871">data</span>&nbsp;<span class="op" id="7150876">=</span>&nbsp;<span class="ident" id="7150878">r</span><span class="op" id="7150879">.</span><span class="ident" id="7150880">data</span><span class="op" id="7150884">[</span><span class="ident" id="7150885">n</span><span class="op" id="7150886">:</span><span class="op" id="7150887">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7150890">}</span>&nbsp;<span class="keyword" id="7150892">else</span>&nbsp;<span class="op" id="7150897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150901">n</span>&nbsp;<span class="op" id="7150903">=</span>&nbsp;<span class="builtinfunc" id="7150905">copy</span><span class="op" id="7150909">(</span><span class="ident" id="7150910">b</span><span class="op" id="7150911">,</span>&nbsp;<span class="ident" id="7150913">r</span><span class="op" id="7150914">.</span><span class="ident" id="7150915">dataEOF</span><span class="op" id="7150922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150926">r</span><span class="op" id="7150927">.</span><span class="ident" id="7150928">dataEOF</span>&nbsp;<span class="op" id="7150936">=</span>&nbsp;<span class="ident" id="7150938">r</span><span class="op" id="7150939">.</span><span class="ident" id="7150940">dataEOF</span><span class="op" id="7150947">[</span><span class="ident" id="7150948">n</span><span class="op" id="7150949">:</span><span class="op" id="7150950">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150954">if</span>&nbsp;<span class="builtinfunc" id="7150957">len</span><span class="op" id="7150960">(</span><span class="ident" id="7150961">r</span><span class="op" id="7150962">.</span><span class="ident" id="7150963">dataEOF</span><span class="op" id="7150970">)</span>&nbsp;<span class="op" id="7150972">==</span>&nbsp;<span class="num" id="7150975">0</span>&nbsp;<span class="op" id="7150977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7150982">err</span>&nbsp;<span class="op" id="7150986">=</span>&nbsp;<span class="ident" id="7150988">io</span><span class="op" id="7150990">.</span><span class="ident" id="7150991">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7150998">if</span>&nbsp;<span class="ident" id="7151001">r</span><span class="op" id="7151002">.</span><span class="ident" id="7151003">lenAtEOF</span>&nbsp;<span class="op" id="7151012">==</span>&nbsp;<span class="op" id="7151015">-</span><span class="num" id="7151016">1</span>&nbsp;<span class="op" id="7151018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7151024">r</span><span class="op" id="7151025">.</span><span class="ident" id="7151026">lenAtEOF</span>&nbsp;<span class="op" id="7151035">=</span>&nbsp;<span class="ident" id="7151037">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7151042">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7151046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7151049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7151052">return</span><br>
<span class="lineno"></span><span class="op" id="7151059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7151062">func</span>&nbsp;<span class="ident" id="7151067">TestDecodeEOF</span><span class="op" id="7151080">(</span><span class="ident" id="7151081">t</span>&nbsp;<span class="op" id="7151083">*</span><span class="ident" id="7151084">testing</span><span class="op" id="7151091">.</span><span class="ident" id="7151092">T</span><span class="op" id="7151093">)</span>&nbsp;<span class="op" id="7151095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7151098">//&nbsp;Check&nbsp;that&nbsp;if&nbsp;reader&nbsp;returns&nbsp;final&nbsp;data&nbsp;and&nbsp;EOF&nbsp;at&nbsp;same&nbsp;time,&nbsp;jpeg&nbsp;handles&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7151181">data</span><span class="op" id="7151185">,</span>&nbsp;<span class="ident" id="7151187">err</span>&nbsp;<span class="op" id="7151191">:=</span>&nbsp;<span class="ident" id="7151194">ioutil</span><span class="op" id="7151200">.</span><span class="ident" id="7151201">ReadFile</span><span class="op" id="7151209">(</span><span class="string" id="7151210">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7151238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7151241">if</span>&nbsp;<span class="ident" id="7151244">err</span>&nbsp;<span class="op" id="7151248">!=</span>&nbsp;<span class="ident" id="7151251">nil</span>&nbsp;<span class="op" id="7151255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7151259">t</span><span class="op" id="7151260">.</span><span class="ident" id="7151261">Fatal</span><span class="op" id="7151266">(</span><span class="ident" id="7151267">err</span><span class="op" id="7151270">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7151273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7151277">n</span>&nbsp;<span class="op" id="7151279">:=</span>&nbsp;<span class="builtinfunc" id="7151282">len</span><span class="op" id="7151285">(</span><span class="ident" id="7151286">data</span><span class="op" id="7151290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7151293">for</span>&nbsp;<span class="ident" id="7151297">i</span>&nbsp;<span class="op" id="7151299">:=</span>&nbsp;<span class="num" id="7151302">0</span><span class="op" id="7151303">;</span>&nbsp;<span class="ident" id="7151305">i</span>&nbsp;<span class="op" id="7151307">&lt;</span>&nbsp;<span class="ident" id="7151309">n</span><span class="op" id="7151310">;</span>&nbsp;<span class="op" id="7151312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7151316">r</span>&nbsp;<span class="op" id="7151318">:=</span>&nbsp;<span class="op" id="7151321">&amp;</span><span class="ident" id="7151322">eofReader</span><span class="op" id="7151331">{</span><span class="ident" id="7151332">data</span><span class="op" id="7151336">[</span><span class="op" id="7151337">:</span><span class="ident" id="7151338">n</span><span class="op" id="7151339">-</span><span class="ident" id="7151340">i</span><span class="op" id="7151341">]</span><span class="op" id="7151342">,</span>&nbsp;<span class="ident" id="7151344">data</span><span class="op" id="7151348">[</span><span class="ident" id="7151349">n</span><span class="op" id="7151350">-</span><span class="ident" id="7151351">i</span><span class="op" id="7151352">:</span><span class="op" id="7151353">]</span><span class="op" id="7151354">,</span>&nbsp;<span class="op" id="7151356">-</span><span class="num" id="7151357">1</span><span class="op" id="7151358">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7151362">_</span><span class="op" id="7151363">,</span>&nbsp;<span class="ident" id="7151365">err</span>&nbsp;<span class="op" id="7151369">:=</span>&nbsp;<span class="ident" id="7151372">Decode</span><span class="op" id="7151378">(</span><span class="ident" id="7151379">r</span><span class="op" id="7151380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7151384">if</span>&nbsp;<span class="ident" id="7151387">err</span>&nbsp;<span class="op" id="7151391">!=</span>&nbsp;<span class="ident" id="7151394">nil</span>&nbsp;<span class="op" id="7151398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7151403">t</span><span class="op" id="7151404">.</span><span class="ident" id="7151405">Errorf</span><span class="op" id="7151411">(</span><span class="string" id="7151412">&#34;Decode&nbsp;with&nbsp;Read()&nbsp;=&nbsp;%d,&nbsp;EOF:&nbsp;%v&#34;</span><span class="op" id="7151446">,</span>&nbsp;<span class="ident" id="7151448">r</span><span class="op" id="7151449">.</span><span class="ident" id="7151450">lenAtEOF</span><span class="op" id="7151458">,</span>&nbsp;<span class="ident" id="7151460">err</span><span class="op" id="7151463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7151467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7151471">if</span>&nbsp;<span class="ident" id="7151474">i</span>&nbsp;<span class="op" id="7151476">==</span>&nbsp;<span class="num" id="7151479">0</span>&nbsp;<span class="op" id="7151481">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7151486">i</span>&nbsp;<span class="op" id="7151488">=</span>&nbsp;<span class="num" id="7151490">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7151494">}</span>&nbsp;<span class="keyword" id="7151496">else</span>&nbsp;<span class="op" id="7151501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7151506">i</span>&nbsp;<span class="op" id="7151508">*=</span>&nbsp;<span class="num" id="7151511">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7151515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7151518">}</span><br>
<span class="lineno">135</span><span class="op" id="7151520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7151523">//&nbsp;check&nbsp;checks&nbsp;that&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;are&nbsp;equal,&nbsp;within&nbsp;the&nbsp;given&nbsp;bounds.</span><br>
<span class="lineno"></span><span class="keyword" id="7151597">func</span>&nbsp;<span class="ident" id="7151602">check</span><span class="op" id="7151607">(</span><span class="ident" id="7151608">bounds</span>&nbsp;<span class="ident" id="7151615">image</span><span class="op" id="7151620">.</span><span class="ident" id="7151621">Rectangle</span><span class="op" id="7151630">,</span>&nbsp;<span class="ident" id="7151632">pix0</span><span class="op" id="7151636">,</span>&nbsp;<span class="ident" id="7151638">pix1</span>&nbsp;<span class="op" id="7151643">[</span><span class="op" id="7151644">]</span><span class="builtintype" id="7151645">byte</span><span class="op" id="7151649">,</span>&nbsp;<span class="ident" id="7151651">stride0</span><span class="op" id="7151658">,</span>&nbsp;<span class="ident" id="7151660">stride1</span>&nbsp;<span class="builtintype" id="7151668">int</span><span class="op" id="7151671">)</span>&nbsp;<span class="builtintype" id="7151673">error</span>&nbsp;<span class="op" id="7151679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7151682">if</span>&nbsp;<span class="ident" id="7151685">stride0</span>&nbsp;<span class="op" id="7151693">&lt;=</span>&nbsp;<span class="num" id="7151696">0</span>&nbsp;<span class="op" id="7151698">||</span>&nbsp;<span class="ident" id="7151701">stride0</span><span class="op" id="7151708">%</span><span class="num" id="7151709">8</span>&nbsp;<span class="op" id="7151711">!=</span>&nbsp;<span class="num" id="7151714">0</span>&nbsp;<span class="op" id="7151716">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7151720">return</span>&nbsp;<span class="ident" id="7151727">fmt</span><span class="op" id="7151730">.</span><span class="ident" id="7151731">Errorf</span><span class="op" id="7151737">(</span><span class="string" id="7151738">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7151753">,</span>&nbsp;<span class="ident" id="7151755">stride0</span><span class="op" id="7151762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7151765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7151768">if</span>&nbsp;<span class="ident" id="7151771">stride1</span>&nbsp;<span class="op" id="7151779">&lt;=</span>&nbsp;<span class="num" id="7151782">0</span>&nbsp;<span class="op" id="7151784">||</span>&nbsp;<span class="ident" id="7151787">stride1</span><span class="op" id="7151794">%</span><span class="num" id="7151795">8</span>&nbsp;<span class="op" id="7151797">!=</span>&nbsp;<span class="num" id="7151800">0</span>&nbsp;<span class="op" id="7151802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7151806">return</span>&nbsp;<span class="ident" id="7151813">fmt</span><span class="op" id="7151816">.</span><span class="ident" id="7151817">Errorf</span><span class="op" id="7151823">(</span><span class="string" id="7151824">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7151839">,</span>&nbsp;<span class="ident" id="7151841">stride1</span><span class="op" id="7151848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7151851">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7151854">//&nbsp;Compare&nbsp;the&nbsp;two&nbsp;pix&nbsp;data,&nbsp;one&nbsp;8x8&nbsp;block&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7151909">for</span>&nbsp;<span class="ident" id="7151913">y</span>&nbsp;<span class="op" id="7151915">:=</span>&nbsp;<span class="num" id="7151918">0</span><span class="op" id="7151919">;</span>&nbsp;<span class="ident" id="7151921">y</span>&nbsp;<span class="op" id="7151923">&lt;</span>&nbsp;<span class="builtinfunc" id="7151925">len</span><span class="op" id="7151928">(</span><span class="ident" id="7151929">pix0</span><span class="op" id="7151933">)</span><span class="op" id="7151934">/</span><span class="ident" id="7151935">stride0</span>&nbsp;<span class="op" id="7151943">&amp;&amp;</span>&nbsp;<span class="ident" id="7151946">y</span>&nbsp;<span class="op" id="7151948">&lt;</span>&nbsp;<span class="builtinfunc" id="7151950">len</span><span class="op" id="7151953">(</span><span class="ident" id="7151954">pix1</span><span class="op" id="7151958">)</span><span class="op" id="7151959">/</span><span class="ident" id="7151960">stride1</span><span class="op" id="7151967">;</span>&nbsp;<span class="ident" id="7151969">y</span>&nbsp;<span class="op" id="7151971">+=</span>&nbsp;<span class="num" id="7151974">8</span>&nbsp;<span class="op" id="7151976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7151980">for</span>&nbsp;<span class="ident" id="7151984">x</span>&nbsp;<span class="op" id="7151986">:=</span>&nbsp;<span class="num" id="7151989">0</span><span class="op" id="7151990">;</span>&nbsp;<span class="ident" id="7151992">x</span>&nbsp;<span class="op" id="7151994">&lt;</span>&nbsp;<span class="ident" id="7151996">stride0</span>&nbsp;<span class="op" id="7152004">&amp;&amp;</span>&nbsp;<span class="ident" id="7152007">x</span>&nbsp;<span class="op" id="7152009">&lt;</span>&nbsp;<span class="ident" id="7152011">stride1</span><span class="op" id="7152018">;</span>&nbsp;<span class="ident" id="7152020">x</span>&nbsp;<span class="op" id="7152022">+=</span>&nbsp;<span class="num" id="7152025">8</span>&nbsp;<span class="op" id="7152027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7152032">if</span>&nbsp;<span class="ident" id="7152035">x</span>&nbsp;<span class="op" id="7152037">&gt;=</span>&nbsp;<span class="ident" id="7152040">bounds</span><span class="op" id="7152046">.</span><span class="ident" id="7152047">Max</span><span class="op" id="7152050">.</span><span class="ident" id="7152051">X</span>&nbsp;<span class="op" id="7152053">||</span>&nbsp;<span class="ident" id="7152056">y</span>&nbsp;<span class="op" id="7152058">&gt;=</span>&nbsp;<span class="ident" id="7152061">bounds</span><span class="op" id="7152067">.</span><span class="ident" id="7152068">Max</span><span class="op" id="7152071">.</span><span class="ident" id="7152072">Y</span>&nbsp;<span class="op" id="7152074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7152080">//&nbsp;We&nbsp;don&#39;t&nbsp;care&nbsp;if&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;differ&nbsp;if&nbsp;the&nbsp;8x8&nbsp;block&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7152148">//&nbsp;entirely&nbsp;outside&nbsp;of&nbsp;the&nbsp;image&#39;s&nbsp;bounds.&nbsp;For&nbsp;example,&nbsp;this&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7152217">//&nbsp;occur&nbsp;with&nbsp;a&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling&nbsp;and&nbsp;a&nbsp;1x1&nbsp;image.&nbsp;Baseline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7152288">//&nbsp;decoding&nbsp;works&nbsp;on&nbsp;the&nbsp;one&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole;&nbsp;progressive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7152355">//&nbsp;decoding&#39;s&nbsp;first&nbsp;pass&nbsp;works&nbsp;on&nbsp;that&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7152423">//&nbsp;refinement&nbsp;passes&nbsp;only&nbsp;process&nbsp;one&nbsp;8x8&nbsp;block&nbsp;within&nbsp;the&nbsp;MCU.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7152491">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7152503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7152509">for</span>&nbsp;<span class="ident" id="7152513">j</span>&nbsp;<span class="op" id="7152515">:=</span>&nbsp;<span class="num" id="7152518">0</span><span class="op" id="7152519">;</span>&nbsp;<span class="ident" id="7152521">j</span>&nbsp;<span class="op" id="7152523">&lt;</span>&nbsp;<span class="num" id="7152525">8</span><span class="op" id="7152526">;</span>&nbsp;<span class="ident" id="7152528">j</span><span class="op" id="7152529">++</span>&nbsp;<span class="op" id="7152532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7152538">for</span>&nbsp;<span class="ident" id="7152542">i</span>&nbsp;<span class="op" id="7152544">:=</span>&nbsp;<span class="num" id="7152547">0</span><span class="op" id="7152548">;</span>&nbsp;<span class="ident" id="7152550">i</span>&nbsp;<span class="op" id="7152552">&lt;</span>&nbsp;<span class="num" id="7152554">8</span><span class="op" id="7152555">;</span>&nbsp;<span class="ident" id="7152557">i</span><span class="op" id="7152558">++</span>&nbsp;<span class="op" id="7152561">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7152568">index0</span>&nbsp;<span class="op" id="7152575">:=</span>&nbsp;<span class="op" id="7152578">(</span><span class="ident" id="7152579">y</span><span class="op" id="7152580">+</span><span class="ident" id="7152581">j</span><span class="op" id="7152582">)</span><span class="op" id="7152583">*</span><span class="ident" id="7152584">stride0</span>&nbsp;<span class="op" id="7152592">+</span>&nbsp;<span class="op" id="7152594">(</span><span class="ident" id="7152595">x</span>&nbsp;<span class="op" id="7152597">+</span>&nbsp;<span class="ident" id="7152599">i</span><span class="op" id="7152600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7152607">index1</span>&nbsp;<span class="op" id="7152614">:=</span>&nbsp;<span class="op" id="7152617">(</span><span class="ident" id="7152618">y</span><span class="op" id="7152619">+</span><span class="ident" id="7152620">j</span><span class="op" id="7152621">)</span><span class="op" id="7152622">*</span><span class="ident" id="7152623">stride1</span>&nbsp;<span class="op" id="7152631">+</span>&nbsp;<span class="op" id="7152633">(</span><span class="ident" id="7152634">x</span>&nbsp;<span class="op" id="7152636">+</span>&nbsp;<span class="ident" id="7152638">i</span><span class="op" id="7152639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7152646">if</span>&nbsp;<span class="ident" id="7152649">pix0</span><span class="op" id="7152653">[</span><span class="ident" id="7152654">index0</span><span class="op" id="7152660">]</span>&nbsp;<span class="op" id="7152662">!=</span>&nbsp;<span class="ident" id="7152665">pix1</span><span class="op" id="7152669">[</span><span class="ident" id="7152670">index1</span><span class="op" id="7152676">]</span>&nbsp;<span class="op" id="7152678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7152686">return</span>&nbsp;<span class="ident" id="7152693">fmt</span><span class="op" id="7152696">.</span><span class="ident" id="7152697">Errorf</span><span class="op" id="7152703">(</span><span class="string" id="7152704">&#34;blocks&nbsp;at&nbsp;(%d,&nbsp;%d)&nbsp;differ:\n%sand\n%s&#34;</span><span class="op" id="7152743">,</span>&nbsp;<span class="ident" id="7152745">x</span><span class="op" id="7152746">,</span>&nbsp;<span class="ident" id="7152748">y</span><span class="op" id="7152749">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7152758">pixString</span><span class="op" id="7152767">(</span><span class="ident" id="7152768">pix0</span><span class="op" id="7152772">,</span>&nbsp;<span class="ident" id="7152774">stride0</span><span class="op" id="7152781">,</span>&nbsp;<span class="ident" id="7152783">x</span><span class="op" id="7152784">,</span>&nbsp;<span class="ident" id="7152786">y</span><span class="op" id="7152787">)</span><span class="op" id="7152788">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7152797">pixString</span><span class="op" id="7152806">(</span><span class="ident" id="7152807">pix1</span><span class="op" id="7152811">,</span>&nbsp;<span class="ident" id="7152813">stride1</span><span class="op" id="7152820">,</span>&nbsp;<span class="ident" id="7152822">x</span><span class="op" id="7152823">,</span>&nbsp;<span class="ident" id="7152825">y</span><span class="op" id="7152826">)</span><span class="op" id="7152827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7152835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7152842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7152848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7152853">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7152857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7152860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7152863">return</span>&nbsp;<span class="ident" id="7152870">nil</span><br>
<span class="lineno"></span><span class="op" id="7152874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="7152877">func</span>&nbsp;<span class="ident" id="7152882">pixString</span><span class="op" id="7152891">(</span><span class="ident" id="7152892">pix</span>&nbsp;<span class="op" id="7152896">[</span><span class="op" id="7152897">]</span><span class="builtintype" id="7152898">byte</span><span class="op" id="7152902">,</span>&nbsp;<span class="ident" id="7152904">stride</span><span class="op" id="7152910">,</span>&nbsp;<span class="ident" id="7152912">x</span><span class="op" id="7152913">,</span>&nbsp;<span class="ident" id="7152915">y</span>&nbsp;<span class="builtintype" id="7152917">int</span><span class="op" id="7152920">)</span>&nbsp;<span class="builtintype" id="7152922">string</span>&nbsp;<span class="op" id="7152929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7152932">s</span>&nbsp;<span class="op" id="7152934">:=</span>&nbsp;<span class="ident" id="7152937">bytes</span><span class="op" id="7152942">.</span><span class="ident" id="7152943">NewBuffer</span><span class="op" id="7152952">(</span><span class="ident" id="7152953">nil</span><span class="op" id="7152956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7152959">for</span>&nbsp;<span class="ident" id="7152963">j</span>&nbsp;<span class="op" id="7152965">:=</span>&nbsp;<span class="num" id="7152968">0</span><span class="op" id="7152969">;</span>&nbsp;<span class="ident" id="7152971">j</span>&nbsp;<span class="op" id="7152973">&lt;</span>&nbsp;<span class="num" id="7152975">8</span><span class="op" id="7152976">;</span>&nbsp;<span class="ident" id="7152978">j</span><span class="op" id="7152979">++</span>&nbsp;<span class="op" id="7152982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7152986">fmt</span><span class="op" id="7152989">.</span><span class="ident" id="7152990">Fprintf</span><span class="op" id="7152997">(</span><span class="ident" id="7152998">s</span><span class="op" id="7152999">,</span>&nbsp;<span class="string" id="7153001">&#34;\t&#34;</span><span class="op" id="7153005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7153009">for</span>&nbsp;<span class="ident" id="7153013">i</span>&nbsp;<span class="op" id="7153015">:=</span>&nbsp;<span class="num" id="7153018">0</span><span class="op" id="7153019">;</span>&nbsp;<span class="ident" id="7153021">i</span>&nbsp;<span class="op" id="7153023">&lt;</span>&nbsp;<span class="num" id="7153025">8</span><span class="op" id="7153026">;</span>&nbsp;<span class="ident" id="7153028">i</span><span class="op" id="7153029">++</span>&nbsp;<span class="op" id="7153032">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7153037">fmt</span><span class="op" id="7153040">.</span><span class="ident" id="7153041">Fprintf</span><span class="op" id="7153048">(</span><span class="ident" id="7153049">s</span><span class="op" id="7153050">,</span>&nbsp;<span class="string" id="7153052">&#34;%02x&nbsp;&#34;</span><span class="op" id="7153059">,</span>&nbsp;<span class="ident" id="7153061">pix</span><span class="op" id="7153064">[</span><span class="op" id="7153065">(</span><span class="ident" id="7153066">y</span><span class="op" id="7153067">+</span><span class="ident" id="7153068">j</span><span class="op" id="7153069">)</span><span class="op" id="7153070">*</span><span class="ident" id="7153071">stride</span><span class="op" id="7153077">+</span><span class="op" id="7153078">(</span><span class="ident" id="7153079">x</span><span class="op" id="7153080">+</span><span class="ident" id="7153081">i</span><span class="op" id="7153082">)</span><span class="op" id="7153083">]</span><span class="op" id="7153084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7153088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7153092">fmt</span><span class="op" id="7153095">.</span><span class="ident" id="7153096">Fprintf</span><span class="op" id="7153103">(</span><span class="ident" id="7153104">s</span><span class="op" id="7153105">,</span>&nbsp;<span class="string" id="7153107">&#34;\n&#34;</span><span class="op" id="7153111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7153114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7153117">return</span>&nbsp;<span class="ident" id="7153124">s</span><span class="op" id="7153125">.</span><span class="ident" id="7153126">String</span><span class="op" id="7153132">(</span><span class="op" id="7153133">)</span><br>
<span class="lineno">185</span><span class="op" id="7153135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7153138">func</span>&nbsp;<span class="ident" id="7153143">TestExtraneousData</span><span class="op" id="7153161">(</span><span class="ident" id="7153162">t</span>&nbsp;<span class="op" id="7153164">*</span><span class="ident" id="7153165">testing</span><span class="op" id="7153172">.</span><span class="ident" id="7153173">T</span><span class="op" id="7153174">)</span>&nbsp;<span class="op" id="7153176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7153179">//&nbsp;Encode&nbsp;a&nbsp;1x1&nbsp;red&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7153207">src</span>&nbsp;<span class="op" id="7153211">:=</span>&nbsp;<span class="ident" id="7153214">image</span><span class="op" id="7153219">.</span><span class="ident" id="7153220">NewRGBA</span><span class="op" id="7153227">(</span><span class="ident" id="7153228">image</span><span class="op" id="7153233">.</span><span class="ident" id="7153234">Rect</span><span class="op" id="7153238">(</span><span class="num" id="7153239">0</span><span class="op" id="7153240">,</span>&nbsp;<span class="num" id="7153242">0</span><span class="op" id="7153243">,</span>&nbsp;<span class="num" id="7153245">1</span><span class="op" id="7153246">,</span>&nbsp;<span class="num" id="7153248">1</span><span class="op" id="7153249">)</span><span class="op" id="7153250">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7153253">src</span><span class="op" id="7153256">.</span><span class="ident" id="7153257">Set</span><span class="op" id="7153260">(</span><span class="num" id="7153261">0</span><span class="op" id="7153262">,</span>&nbsp;<span class="num" id="7153264">0</span><span class="op" id="7153265">,</span>&nbsp;<span class="ident" id="7153267">color</span><span class="op" id="7153272">.</span><span class="ident" id="7153273">RGBA</span><span class="op" id="7153277">{</span><span class="num" id="7153278">0xff</span><span class="op" id="7153282">,</span>&nbsp;<span class="num" id="7153284">0x00</span><span class="op" id="7153288">,</span>&nbsp;<span class="num" id="7153290">0x00</span><span class="op" id="7153294">,</span>&nbsp;<span class="num" id="7153296">0xff</span><span class="op" id="7153300">}</span><span class="op" id="7153301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7153304">buf</span>&nbsp;<span class="op" id="7153308">:=</span>&nbsp;<span class="builtinfunc" id="7153311">new</span><span class="op" id="7153314">(</span><span class="ident" id="7153315">bytes</span><span class="op" id="7153320">.</span><span class="ident" id="7153321">Buffer</span><span class="op" id="7153327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7153330">if</span>&nbsp;<span class="ident" id="7153333">err</span>&nbsp;<span class="op" id="7153337">:=</span>&nbsp;<span class="ident" id="7153340">Encode</span><span class="op" id="7153346">(</span><span class="ident" id="7153347">buf</span><span class="op" id="7153350">,</span>&nbsp;<span class="ident" id="7153352">src</span><span class="op" id="7153355">,</span>&nbsp;<span class="ident" id="7153357">nil</span><span class="op" id="7153360">)</span><span class="op" id="7153361">;</span>&nbsp;<span class="ident" id="7153363">err</span>&nbsp;<span class="op" id="7153367">!=</span>&nbsp;<span class="ident" id="7153370">nil</span>&nbsp;<span class="op" id="7153374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7153378">t</span><span class="op" id="7153379">.</span><span class="ident" id="7153380">Fatalf</span><span class="op" id="7153386">(</span><span class="string" id="7153387">&#34;encode:&nbsp;%v&#34;</span><span class="op" id="7153399">,</span>&nbsp;<span class="ident" id="7153401">err</span><span class="op" id="7153404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7153407">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7153410">enc</span>&nbsp;<span class="op" id="7153414">:=</span>&nbsp;<span class="ident" id="7153417">buf</span><span class="op" id="7153420">.</span><span class="ident" id="7153421">String</span><span class="op" id="7153427">(</span><span class="op" id="7153428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7153431">//&nbsp;Sanity&nbsp;check&nbsp;that&nbsp;the&nbsp;encoded&nbsp;JPEG&nbsp;is&nbsp;long&nbsp;enough,&nbsp;that&nbsp;it&nbsp;ends&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7153504">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker,&nbsp;and&nbsp;that&nbsp;it&nbsp;contains&nbsp;a&nbsp;&#34;\xff\xda&#34;&nbsp;SOS&nbsp;marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7153576">//&nbsp;somewhere&nbsp;in&nbsp;the&nbsp;final&nbsp;64&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7153613">if</span>&nbsp;<span class="builtinfunc" id="7153616">len</span><span class="op" id="7153619">(</span><span class="ident" id="7153620">enc</span><span class="op" id="7153623">)</span>&nbsp;<span class="op" id="7153625">&lt;</span>&nbsp;<span class="num" id="7153627">64</span>&nbsp;<span class="op" id="7153630">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7153634">t</span><span class="op" id="7153635">.</span><span class="ident" id="7153636">Fatalf</span><span class="op" id="7153642">(</span><span class="string" id="7153643">&#34;encoded&nbsp;JPEG&nbsp;is&nbsp;too&nbsp;short:&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="7153680">,</span>&nbsp;<span class="builtinfunc" id="7153682">len</span><span class="op" id="7153685">(</span><span class="ident" id="7153686">enc</span><span class="op" id="7153689">)</span><span class="op" id="7153690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7153693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7153696">if</span>&nbsp;<span class="ident" id="7153699">got</span><span class="op" id="7153702">,</span>&nbsp;<span class="ident" id="7153704">want</span>&nbsp;<span class="op" id="7153709">:=</span>&nbsp;<span class="ident" id="7153712">enc</span><span class="op" id="7153715">[</span><span class="builtinfunc" id="7153716">len</span><span class="op" id="7153719">(</span><span class="ident" id="7153720">enc</span><span class="op" id="7153723">)</span><span class="op" id="7153724">-</span><span class="num" id="7153725">2</span><span class="op" id="7153726">:</span><span class="op" id="7153727">]</span><span class="op" id="7153728">,</span>&nbsp;<span class="string" id="7153730">&#34;\xff\xd9&#34;</span><span class="op" id="7153740">;</span>&nbsp;<span class="ident" id="7153742">got</span>&nbsp;<span class="op" id="7153746">!=</span>&nbsp;<span class="ident" id="7153749">want</span>&nbsp;<span class="op" id="7153754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7153758">t</span><span class="op" id="7153759">.</span><span class="ident" id="7153760">Fatalf</span><span class="op" id="7153766">(</span><span class="string" id="7153767">&#34;encoded&nbsp;JPEG&nbsp;ends&nbsp;with&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7153803">,</span>&nbsp;<span class="ident" id="7153805">got</span><span class="op" id="7153808">,</span>&nbsp;<span class="ident" id="7153810">want</span><span class="op" id="7153814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7153817">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7153820">if</span>&nbsp;<span class="ident" id="7153823">s</span>&nbsp;<span class="op" id="7153825">:=</span>&nbsp;<span class="ident" id="7153828">enc</span><span class="op" id="7153831">[</span><span class="builtinfunc" id="7153832">len</span><span class="op" id="7153835">(</span><span class="ident" id="7153836">enc</span><span class="op" id="7153839">)</span><span class="op" id="7153840">-</span><span class="num" id="7153841">64</span><span class="op" id="7153843">:</span><span class="op" id="7153844">]</span><span class="op" id="7153845">;</span>&nbsp;<span class="op" id="7153847">!</span><span class="ident" id="7153848">strings</span><span class="op" id="7153855">.</span><span class="ident" id="7153856">Contains</span><span class="op" id="7153864">(</span><span class="ident" id="7153865">s</span><span class="op" id="7153866">,</span>&nbsp;<span class="string" id="7153868">&#34;\xff\xda&#34;</span><span class="op" id="7153878">)</span>&nbsp;<span class="op" id="7153880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7153884">t</span><span class="op" id="7153885">.</span><span class="ident" id="7153886">Fatalf</span><span class="op" id="7153892">(</span><span class="string" id="7153893">&#34;encoded&nbsp;JPEG&nbsp;does&nbsp;not&nbsp;contain&nbsp;a&nbsp;SOS&nbsp;marker&nbsp;(ff&nbsp;da)&nbsp;near&nbsp;the&nbsp;end:&nbsp;%&nbsp;x&#34;</span><span class="op" id="7153963">,</span>&nbsp;<span class="ident" id="7153965">s</span><span class="op" id="7153966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7153969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7153972">//&nbsp;Test&nbsp;that&nbsp;adding&nbsp;some&nbsp;random&nbsp;junk&nbsp;between&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7154041">//&nbsp;EOI&nbsp;marker&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;decoding.</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7154086">rnd</span>&nbsp;<span class="op" id="7154090">:=</span>&nbsp;<span class="ident" id="7154093">rand</span><span class="op" id="7154097">.</span><span class="ident" id="7154098">New</span><span class="op" id="7154101">(</span><span class="ident" id="7154102">rand</span><span class="op" id="7154106">.</span><span class="ident" id="7154107">NewSource</span><span class="op" id="7154116">(</span><span class="num" id="7154117">1</span><span class="op" id="7154118">)</span><span class="op" id="7154119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7154122">for</span>&nbsp;<span class="ident" id="7154126">i</span><span class="op" id="7154127">,</span>&nbsp;<span class="ident" id="7154129">nerr</span>&nbsp;<span class="op" id="7154134">:=</span>&nbsp;<span class="num" id="7154137">0</span><span class="op" id="7154138">,</span>&nbsp;<span class="num" id="7154140">0</span><span class="op" id="7154141">;</span>&nbsp;<span class="ident" id="7154143">i</span>&nbsp;<span class="op" id="7154145">&lt;</span>&nbsp;<span class="num" id="7154147">1000</span>&nbsp;<span class="op" id="7154152">&amp;&amp;</span>&nbsp;<span class="ident" id="7154155">nerr</span>&nbsp;<span class="op" id="7154160">&lt;</span>&nbsp;<span class="num" id="7154162">10</span><span class="op" id="7154164">;</span>&nbsp;<span class="ident" id="7154166">i</span><span class="op" id="7154167">++</span>&nbsp;<span class="op" id="7154170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7154174">buf</span><span class="op" id="7154177">.</span><span class="ident" id="7154178">Reset</span><span class="op" id="7154183">(</span><span class="op" id="7154184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7154188">//&nbsp;Write&nbsp;all&nbsp;but&nbsp;the&nbsp;trailing&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7154243">buf</span><span class="op" id="7154246">.</span><span class="ident" id="7154247">WriteString</span><span class="op" id="7154258">(</span><span class="ident" id="7154259">enc</span><span class="op" id="7154262">[</span><span class="op" id="7154263">:</span><span class="builtinfunc" id="7154264">len</span><span class="op" id="7154267">(</span><span class="ident" id="7154268">enc</span><span class="op" id="7154271">)</span><span class="op" id="7154272">-</span><span class="num" id="7154273">2</span><span class="op" id="7154274">]</span><span class="op" id="7154275">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7154279">//&nbsp;Write&nbsp;some&nbsp;random&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7154319">for</span>&nbsp;<span class="ident" id="7154323">n</span>&nbsp;<span class="op" id="7154325">:=</span>&nbsp;<span class="ident" id="7154328">rnd</span><span class="op" id="7154331">.</span><span class="ident" id="7154332">Intn</span><span class="op" id="7154336">(</span><span class="num" id="7154337">10</span><span class="op" id="7154339">)</span><span class="op" id="7154340">;</span>&nbsp;<span class="ident" id="7154342">n</span>&nbsp;<span class="op" id="7154344">&gt;</span>&nbsp;<span class="num" id="7154346">0</span><span class="op" id="7154347">;</span>&nbsp;<span class="ident" id="7154349">n</span><span class="op" id="7154350">--</span>&nbsp;<span class="op" id="7154353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7154358">if</span>&nbsp;<span class="ident" id="7154361">x</span>&nbsp;<span class="op" id="7154363">:=</span>&nbsp;<span class="builtintype" id="7154366">byte</span><span class="op" id="7154370">(</span><span class="ident" id="7154371">rnd</span><span class="op" id="7154374">.</span><span class="ident" id="7154375">Intn</span><span class="op" id="7154379">(</span><span class="num" id="7154380">256</span><span class="op" id="7154383">)</span><span class="op" id="7154384">)</span><span class="op" id="7154385">;</span>&nbsp;<span class="ident" id="7154387">x</span>&nbsp;<span class="op" id="7154389">!=</span>&nbsp;<span class="num" id="7154392">0xff</span>&nbsp;<span class="op" id="7154397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7154403">buf</span><span class="op" id="7154406">.</span><span class="ident" id="7154407">WriteByte</span><span class="op" id="7154416">(</span><span class="ident" id="7154417">x</span><span class="op" id="7154418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7154423">}</span>&nbsp;<span class="keyword" id="7154425">else</span>&nbsp;<span class="op" id="7154430">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7154436">//&nbsp;The&nbsp;JPEG&nbsp;format&nbsp;escapes&nbsp;a&nbsp;SOS&nbsp;0xff&nbsp;data&nbsp;byte&nbsp;as&nbsp;&#34;\xff\x00&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7154503">buf</span><span class="op" id="7154506">.</span><span class="ident" id="7154507">WriteString</span><span class="op" id="7154518">(</span><span class="string" id="7154519">&#34;\xff\x00&#34;</span><span class="op" id="7154529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7154534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7154538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7154542">//&nbsp;Write&nbsp;the&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7154580">buf</span><span class="op" id="7154583">.</span><span class="ident" id="7154584">WriteString</span><span class="op" id="7154595">(</span><span class="string" id="7154596">&#34;\xff\xd9&#34;</span><span class="op" id="7154606">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7154611">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;can&nbsp;still&nbsp;decode&nbsp;the&nbsp;resultant&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7154668">got</span><span class="op" id="7154671">,</span>&nbsp;<span class="ident" id="7154673">err</span>&nbsp;<span class="op" id="7154677">:=</span>&nbsp;<span class="ident" id="7154680">Decode</span><span class="op" id="7154686">(</span><span class="ident" id="7154687">buf</span><span class="op" id="7154690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7154694">if</span>&nbsp;<span class="ident" id="7154697">err</span>&nbsp;<span class="op" id="7154701">!=</span>&nbsp;<span class="ident" id="7154704">nil</span>&nbsp;<span class="op" id="7154708">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7154713">t</span><span class="op" id="7154714">.</span><span class="ident" id="7154715">Errorf</span><span class="op" id="7154721">(</span><span class="string" id="7154722">&#34;could&nbsp;not&nbsp;decode&nbsp;image&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="7154754">,</span>&nbsp;<span class="ident" id="7154756">i</span><span class="op" id="7154757">,</span>&nbsp;<span class="ident" id="7154759">err</span><span class="op" id="7154762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7154767">nerr</span><span class="op" id="7154771">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7154777">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7154788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7154792">if</span>&nbsp;<span class="ident" id="7154795">got</span><span class="op" id="7154798">.</span><span class="ident" id="7154799">Bounds</span><span class="op" id="7154805">(</span><span class="op" id="7154806">)</span>&nbsp;<span class="op" id="7154808">!=</span>&nbsp;<span class="ident" id="7154811">src</span><span class="op" id="7154814">.</span><span class="ident" id="7154815">Bounds</span><span class="op" id="7154821">(</span><span class="op" id="7154822">)</span>&nbsp;<span class="op" id="7154824">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7154829">t</span><span class="op" id="7154830">.</span><span class="ident" id="7154831">Errorf</span><span class="op" id="7154837">(</span><span class="string" id="7154838">&#34;image&nbsp;#%d,&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7154875">,</span>&nbsp;<span class="ident" id="7154877">i</span><span class="op" id="7154878">,</span>&nbsp;<span class="ident" id="7154880">got</span><span class="op" id="7154883">.</span><span class="ident" id="7154884">Bounds</span><span class="op" id="7154890">(</span><span class="op" id="7154891">)</span><span class="op" id="7154892">,</span>&nbsp;<span class="ident" id="7154894">src</span><span class="op" id="7154897">.</span><span class="ident" id="7154898">Bounds</span><span class="op" id="7154904">(</span><span class="op" id="7154905">)</span><span class="op" id="7154906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7154911">nerr</span><span class="op" id="7154915">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7154921">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7154932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7154936">if</span>&nbsp;<span class="ident" id="7154939">averageDelta</span><span class="op" id="7154951">(</span><span class="ident" id="7154952">got</span><span class="op" id="7154955">,</span>&nbsp;<span class="ident" id="7154957">src</span><span class="op" id="7154960">)</span>&nbsp;<span class="op" id="7154962">&gt;</span>&nbsp;<span class="num" id="7154964">2</span><span class="op" id="7154965">&lt;&lt;</span><span class="num" id="7154967">8</span>&nbsp;<span class="op" id="7154969">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7154974">t</span><span class="op" id="7154975">.</span><span class="ident" id="7154976">Errorf</span><span class="op" id="7154982">(</span><span class="string" id="7154983">&#34;image&nbsp;#%d&nbsp;changed&nbsp;too&nbsp;much&nbsp;after&nbsp;a&nbsp;round&nbsp;trip&#34;</span><span class="op" id="7155030">,</span>&nbsp;<span class="ident" id="7155032">i</span><span class="op" id="7155033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7155038">nerr</span><span class="op" id="7155042">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7155048">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7155059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7155062">}</span><br>
<span class="lineno">245</span><span class="op" id="7155064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7155067">func</span>&nbsp;<span class="ident" id="7155072">benchmarkDecode</span><span class="op" id="7155087">(</span><span class="ident" id="7155088">b</span>&nbsp;<span class="op" id="7155090">*</span><span class="ident" id="7155091">testing</span><span class="op" id="7155098">.</span><span class="ident" id="7155099">B</span><span class="op" id="7155100">,</span>&nbsp;<span class="ident" id="7155102">filename</span>&nbsp;<span class="builtintype" id="7155111">string</span><span class="op" id="7155117">)</span>&nbsp;<span class="op" id="7155119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7155122">b</span><span class="op" id="7155123">.</span><span class="ident" id="7155124">StopTimer</span><span class="op" id="7155133">(</span><span class="op" id="7155134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7155137">data</span><span class="op" id="7155141">,</span>&nbsp;<span class="ident" id="7155143">err</span>&nbsp;<span class="op" id="7155147">:=</span>&nbsp;<span class="ident" id="7155150">ioutil</span><span class="op" id="7155156">.</span><span class="ident" id="7155157">ReadFile</span><span class="op" id="7155165">(</span><span class="ident" id="7155166">filename</span><span class="op" id="7155174">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7155177">if</span>&nbsp;<span class="ident" id="7155180">err</span>&nbsp;<span class="op" id="7155184">!=</span>&nbsp;<span class="ident" id="7155187">nil</span>&nbsp;<span class="op" id="7155191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7155195">b</span><span class="op" id="7155196">.</span><span class="ident" id="7155197">Fatal</span><span class="op" id="7155202">(</span><span class="ident" id="7155203">err</span><span class="op" id="7155206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7155209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7155212">cfg</span><span class="op" id="7155215">,</span>&nbsp;<span class="ident" id="7155217">err</span>&nbsp;<span class="op" id="7155221">:=</span>&nbsp;<span class="ident" id="7155224">DecodeConfig</span><span class="op" id="7155236">(</span><span class="ident" id="7155237">bytes</span><span class="op" id="7155242">.</span><span class="ident" id="7155243">NewReader</span><span class="op" id="7155252">(</span><span class="ident" id="7155253">data</span><span class="op" id="7155257">)</span><span class="op" id="7155258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7155261">if</span>&nbsp;<span class="ident" id="7155264">err</span>&nbsp;<span class="op" id="7155268">!=</span>&nbsp;<span class="ident" id="7155271">nil</span>&nbsp;<span class="op" id="7155275">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7155279">b</span><span class="op" id="7155280">.</span><span class="ident" id="7155281">Fatal</span><span class="op" id="7155286">(</span><span class="ident" id="7155287">err</span><span class="op" id="7155290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7155293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7155296">b</span><span class="op" id="7155297">.</span><span class="ident" id="7155298">SetBytes</span><span class="op" id="7155306">(</span><span class="ident" id="7155307">int64</span><span class="op" id="7155312">(</span><span class="ident" id="7155313">cfg</span><span class="op" id="7155316">.</span><span class="ident" id="7155317">Width</span>&nbsp;<span class="op" id="7155323">*</span>&nbsp;<span class="ident" id="7155325">cfg</span><span class="op" id="7155328">.</span><span class="ident" id="7155329">Height</span>&nbsp;<span class="op" id="7155336">*</span>&nbsp;<span class="num" id="7155338">4</span><span class="op" id="7155339">)</span><span class="op" id="7155340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7155343">b</span><span class="op" id="7155344">.</span><span class="ident" id="7155345">StartTimer</span><span class="op" id="7155355">(</span><span class="op" id="7155356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7155359">for</span>&nbsp;<span class="ident" id="7155363">i</span>&nbsp;<span class="op" id="7155365">:=</span>&nbsp;<span class="num" id="7155368">0</span><span class="op" id="7155369">;</span>&nbsp;<span class="ident" id="7155371">i</span>&nbsp;<span class="op" id="7155373">&lt;</span>&nbsp;<span class="ident" id="7155375">b</span><span class="op" id="7155376">.</span><span class="ident" id="7155377">N</span><span class="op" id="7155378">;</span>&nbsp;<span class="ident" id="7155380">i</span><span class="op" id="7155381">++</span>&nbsp;<span class="op" id="7155384">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7155388">Decode</span><span class="op" id="7155394">(</span><span class="ident" id="7155395">bytes</span><span class="op" id="7155400">.</span><span class="ident" id="7155401">NewReader</span><span class="op" id="7155410">(</span><span class="ident" id="7155411">data</span><span class="op" id="7155415">)</span><span class="op" id="7155416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7155419">}</span><br>
<span class="lineno"></span><span class="op" id="7155421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7155424">func</span>&nbsp;<span class="ident" id="7155429">BenchmarkDecodeBaseline</span><span class="op" id="7155452">(</span><span class="ident" id="7155453">b</span>&nbsp;<span class="op" id="7155455">*</span><span class="ident" id="7155456">testing</span><span class="op" id="7155463">.</span><span class="ident" id="7155464">B</span><span class="op" id="7155465">)</span>&nbsp;<span class="op" id="7155467">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7155470">benchmarkDecode</span><span class="op" id="7155485">(</span><span class="ident" id="7155486">b</span><span class="op" id="7155487">,</span>&nbsp;<span class="string" id="7155489">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7155517">)</span><br>
<span class="lineno"></span><span class="op" id="7155519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7155522">func</span>&nbsp;<span class="ident" id="7155527">BenchmarkDecodeProgressive</span><span class="op" id="7155553">(</span><span class="ident" id="7155554">b</span>&nbsp;<span class="op" id="7155556">*</span><span class="ident" id="7155557">testing</span><span class="op" id="7155564">.</span><span class="ident" id="7155565">B</span><span class="op" id="7155566">)</span>&nbsp;<span class="op" id="7155568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7155571">benchmarkDecode</span><span class="op" id="7155586">(</span><span class="ident" id="7155587">b</span><span class="op" id="7155588">,</span>&nbsp;<span class="string" id="7155590">&#34;../testdata/video-001.progressive.jpeg&#34;</span><span class="op" id="7155630">)</span><br>
<span class="lineno">270</span><span class="op" id="7155632">}</span>
</div>
</body>
</html>
