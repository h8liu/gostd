<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html" class="current">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3952461">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3952517">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3952571">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3952622">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3952700">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3952747">package</span>&nbsp;<span class="ident" id="3952755">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3952760">import</span>&nbsp;<span class="op" id="3952767">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3952770">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3952781">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3952788">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3952791">func</span>&nbsp;<span class="ident" id="3952796">probeIPv4Stack</span><span class="op" id="3952810">(</span><span class="op" id="3952811">)</span>&nbsp;<span class="builtintype" id="3952813">bool</span>&nbsp;<span class="op" id="3952818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3952821">s</span><span class="op" id="3952822">,</span>&nbsp;<span class="ident" id="3952824">err</span>&nbsp;<span class="op" id="3952828">:=</span>&nbsp;<span class="ident" id="3952831">syscall</span><span class="op" id="3952838">.</span><span class="ident" id="3952839">Socket</span><span class="op" id="3952845">(</span><span class="ident" id="3952846">syscall</span><span class="op" id="3952853">.</span><span class="ident" id="3952854">AF_INET</span><span class="op" id="3952861">,</span>&nbsp;<span class="ident" id="3952863">syscall</span><span class="op" id="3952870">.</span><span class="ident" id="3952871">SOCK_STREAM</span><span class="op" id="3952882">,</span>&nbsp;<span class="ident" id="3952884">syscall</span><span class="op" id="3952891">.</span><span class="ident" id="3952892">IPPROTO_TCP</span><span class="op" id="3952903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3952906">switch</span>&nbsp;<span class="ident" id="3952913">err</span>&nbsp;<span class="op" id="3952917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3952920">case</span>&nbsp;<span class="ident" id="3952925">syscall</span><span class="op" id="3952932">.</span><span class="ident" id="3952933">EAFNOSUPPORT</span><span class="op" id="3952945">,</span>&nbsp;<span class="ident" id="3952947">syscall</span><span class="op" id="3952954">.</span><span class="ident" id="3952955">EPROTONOSUPPORT</span><span class="op" id="3952970">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3952974">return</span>&nbsp;<span class="builtintype" id="3952981">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3952988">case</span>&nbsp;<span class="builtintype" id="3952993">nil</span><span class="op" id="3952996">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3953000">closesocket</span><span class="op" id="3953011">(</span><span class="ident" id="3953012">s</span><span class="op" id="3953013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3953016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3953019">return</span>&nbsp;<span class="builtintype" id="3953026">true</span><br>
<span class="lineno">25</span><span class="op" id="3953031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3953034">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="3953093">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="3953156">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="3953222">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="3953283">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="3953346">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3953401">//</span><br>
<span class="lineno"></span><span class="comment" id="3953404">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="3953471">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="3953535">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3953589">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3953654">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="3953720">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="3953781">func</span>&nbsp;<span class="ident" id="3953786">probeIPv6Stack</span><span class="op" id="3953800">(</span><span class="op" id="3953801">)</span>&nbsp;<span class="op" id="3953803">(</span><span class="ident" id="3953804">supportsIPv6</span><span class="op" id="3953816">,</span>&nbsp;<span class="ident" id="3953818">supportsIPv4map</span>&nbsp;<span class="builtintype" id="3953834">bool</span><span class="op" id="3953838">)</span>&nbsp;<span class="op" id="3953840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3953843">var</span>&nbsp;<span class="ident" id="3953847">probes</span>&nbsp;<span class="op" id="3953854">=</span>&nbsp;<span class="op" id="3953856">[</span><span class="op" id="3953857">]</span><span class="keyword" id="3953858">struct</span>&nbsp;<span class="op" id="3953865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3953869">laddr</span>&nbsp;<span class="ident" id="3953875">TCPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3953885">value</span>&nbsp;<span class="builtintype" id="3953891">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3953897">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3953903">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3953909">}</span><span class="op" id="3953910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3953914">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3953949">{</span><span class="ident" id="3953950">laddr</span><span class="op" id="3953955">:</span>&nbsp;<span class="ident" id="3953957">TCPAddr</span><span class="op" id="3953964">{</span><span class="ident" id="3953965">IP</span><span class="op" id="3953967">:</span>&nbsp;<span class="ident" id="3953969">ParseIP</span><span class="op" id="3953976">(</span><span class="string" id="3953977">&#34;::1&#34;</span><span class="op" id="3953982">)</span><span class="op" id="3953983">}</span><span class="op" id="3953984">,</span>&nbsp;<span class="ident" id="3953986">value</span><span class="op" id="3953991">:</span>&nbsp;<span class="num" id="3953993">1</span><span class="op" id="3953994">}</span><span class="op" id="3953995">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3953999">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3954054">{</span><span class="ident" id="3954055">laddr</span><span class="op" id="3954060">:</span>&nbsp;<span class="ident" id="3954062">TCPAddr</span><span class="op" id="3954069">{</span><span class="ident" id="3954070">IP</span><span class="op" id="3954072">:</span>&nbsp;<span class="ident" id="3954074">IPv4</span><span class="op" id="3954078">(</span><span class="num" id="3954079">127</span><span class="op" id="3954082">,</span>&nbsp;<span class="num" id="3954084">0</span><span class="op" id="3954085">,</span>&nbsp;<span class="num" id="3954087">0</span><span class="op" id="3954088">,</span>&nbsp;<span class="num" id="3954090">1</span><span class="op" id="3954091">)</span><span class="op" id="3954092">}</span><span class="op" id="3954093">,</span>&nbsp;<span class="ident" id="3954095">value</span><span class="op" id="3954100">:</span>&nbsp;<span class="num" id="3954102">0</span><span class="op" id="3954103">}</span><span class="op" id="3954104">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3954107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3954111">for</span>&nbsp;<span class="ident" id="3954115">i</span>&nbsp;<span class="op" id="3954117">:=</span>&nbsp;<span class="keyword" id="3954120">range</span>&nbsp;<span class="ident" id="3954126">probes</span>&nbsp;<span class="op" id="3954133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3954137">s</span><span class="op" id="3954138">,</span>&nbsp;<span class="ident" id="3954140">err</span>&nbsp;<span class="op" id="3954144">:=</span>&nbsp;<span class="ident" id="3954147">syscall</span><span class="op" id="3954154">.</span><span class="ident" id="3954155">Socket</span><span class="op" id="3954161">(</span><span class="ident" id="3954162">syscall</span><span class="op" id="3954169">.</span><span class="ident" id="3954170">AF_INET6</span><span class="op" id="3954178">,</span>&nbsp;<span class="ident" id="3954180">syscall</span><span class="op" id="3954187">.</span><span class="ident" id="3954188">SOCK_STREAM</span><span class="op" id="3954199">,</span>&nbsp;<span class="ident" id="3954201">syscall</span><span class="op" id="3954208">.</span><span class="ident" id="3954209">IPPROTO_TCP</span><span class="op" id="3954220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3954224">if</span>&nbsp;<span class="ident" id="3954227">err</span>&nbsp;<span class="op" id="3954231">!=</span>&nbsp;<span class="builtintype" id="3954234">nil</span>&nbsp;<span class="op" id="3954238">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3954243">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3954254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3954258">defer</span>&nbsp;<span class="ident" id="3954264">closesocket</span><span class="op" id="3954275">(</span><span class="ident" id="3954276">s</span><span class="op" id="3954277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3954281">syscall</span><span class="op" id="3954288">.</span><span class="ident" id="3954289">SetsockoptInt</span><span class="op" id="3954302">(</span><span class="ident" id="3954303">s</span><span class="op" id="3954304">,</span>&nbsp;<span class="ident" id="3954306">syscall</span><span class="op" id="3954313">.</span><span class="ident" id="3954314">IPPROTO_IPV6</span><span class="op" id="3954326">,</span>&nbsp;<span class="ident" id="3954328">syscall</span><span class="op" id="3954335">.</span><span class="ident" id="3954336">IPV6_V6ONLY</span><span class="op" id="3954347">,</span>&nbsp;<span class="ident" id="3954349">probes</span><span class="op" id="3954355">[</span><span class="ident" id="3954356">i</span><span class="op" id="3954357">]</span><span class="op" id="3954358">.</span><span class="ident" id="3954359">value</span><span class="op" id="3954364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3954368">sa</span><span class="op" id="3954370">,</span>&nbsp;<span class="ident" id="3954372">err</span>&nbsp;<span class="op" id="3954376">:=</span>&nbsp;<span class="ident" id="3954379">probes</span><span class="op" id="3954385">[</span><span class="ident" id="3954386">i</span><span class="op" id="3954387">]</span><span class="op" id="3954388">.</span><span class="ident" id="3954389">laddr</span><span class="op" id="3954394">.</span><span class="ident" id="3954395">sockaddr</span><span class="op" id="3954403">(</span><span class="ident" id="3954404">syscall</span><span class="op" id="3954411">.</span><span class="ident" id="3954412">AF_INET6</span><span class="op" id="3954420">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3954424">if</span>&nbsp;<span class="ident" id="3954427">err</span>&nbsp;<span class="op" id="3954431">!=</span>&nbsp;<span class="builtintype" id="3954434">nil</span>&nbsp;<span class="op" id="3954438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3954443">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3954454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3954458">if</span>&nbsp;<span class="ident" id="3954461">err</span>&nbsp;<span class="op" id="3954465">:=</span>&nbsp;<span class="ident" id="3954468">syscall</span><span class="op" id="3954475">.</span><span class="ident" id="3954476">Bind</span><span class="op" id="3954480">(</span><span class="ident" id="3954481">s</span><span class="op" id="3954482">,</span>&nbsp;<span class="ident" id="3954484">sa</span><span class="op" id="3954486">)</span><span class="op" id="3954487">;</span>&nbsp;<span class="ident" id="3954489">err</span>&nbsp;<span class="op" id="3954493">!=</span>&nbsp;<span class="builtintype" id="3954496">nil</span>&nbsp;<span class="op" id="3954500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3954505">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3954516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3954520">probes</span><span class="op" id="3954526">[</span><span class="ident" id="3954527">i</span><span class="op" id="3954528">]</span><span class="op" id="3954529">.</span><span class="ident" id="3954530">ok</span>&nbsp;<span class="op" id="3954533">=</span>&nbsp;<span class="builtintype" id="3954535">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3954541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3954545">return</span>&nbsp;<span class="ident" id="3954552">probes</span><span class="op" id="3954558">[</span><span class="num" id="3954559">0</span><span class="op" id="3954560">]</span><span class="op" id="3954561">.</span><span class="ident" id="3954562">ok</span><span class="op" id="3954564">,</span>&nbsp;<span class="ident" id="3954566">probes</span><span class="op" id="3954572">[</span><span class="num" id="3954573">1</span><span class="op" id="3954574">]</span><span class="op" id="3954575">.</span><span class="ident" id="3954576">ok</span><br>
<span class="lineno">70</span><span class="op" id="3954579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3954582">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3954646">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="3954708">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="3954772">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3954834">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="3954900">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="3954964">//</span><br>
<span class="lineno"></span><span class="comment" id="3954967">//&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="3955004">//&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="3955064">//&nbsp;&nbsp;&nbsp;&nbsp;capabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3955123">//&nbsp;&nbsp;&nbsp;&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="3955179">//&nbsp;&nbsp;&nbsp;&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="3955238">//&nbsp;&nbsp;&nbsp;&nbsp;wildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="3955289">//</span><br>
<span class="lineno"></span><span class="comment" id="3955292">//&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3955340">//&nbsp;&nbsp;&nbsp;&nbsp;Same&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3955354">//</span><br>
<span class="lineno"></span><span class="comment" id="3955357">//&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="3955402">//&nbsp;&nbsp;&nbsp;&nbsp;Almost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="3955461">//&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3955519">//&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="3955579">//&nbsp;&nbsp;&nbsp;&nbsp;mapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="3955602">//</span><br>
<span class="lineno">95</span><span class="comment" id="3955605">//&nbsp;&nbsp;&nbsp;&nbsp;4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3955660">//&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3955713">//</span><br>
<span class="lineno"></span><span class="comment" id="3955716">//&nbsp;&nbsp;&nbsp;&nbsp;5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3955768">//&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="3955829">//&nbsp;&nbsp;&nbsp;&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3955840">//</span><br>
<span class="lineno"></span><span class="comment" id="3955843">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="3955911">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="3955978">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="3956012">//</span><br>
<span class="lineno"></span><span class="comment" id="3956015">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="3956083">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="3956144">func</span>&nbsp;<span class="ident" id="3956149">favoriteAddrFamily</span><span class="op" id="3956167">(</span><span class="ident" id="3956168">net</span>&nbsp;<span class="builtintype" id="3956172">string</span><span class="op" id="3956178">,</span>&nbsp;<span class="ident" id="3956180">laddr</span><span class="op" id="3956185">,</span>&nbsp;<span class="ident" id="3956187">raddr</span>&nbsp;<span class="ident" id="3956193">sockaddr</span><span class="op" id="3956201">,</span>&nbsp;<span class="ident" id="3956203">mode</span>&nbsp;<span class="builtintype" id="3956208">string</span><span class="op" id="3956214">)</span>&nbsp;<span class="op" id="3956216">(</span><span class="ident" id="3956217">family</span>&nbsp;<span class="builtintype" id="3956224">int</span><span class="op" id="3956227">,</span>&nbsp;<span class="ident" id="3956229">ipv6only</span>&nbsp;<span class="builtintype" id="3956238">bool</span><span class="op" id="3956242">)</span>&nbsp;<span class="op" id="3956244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956247">switch</span>&nbsp;<span class="ident" id="3956254">net</span><span class="op" id="3956257">[</span><span class="builtinfunc" id="3956258">len</span><span class="op" id="3956261">(</span><span class="ident" id="3956262">net</span><span class="op" id="3956265">)</span><span class="op" id="3956266">-</span><span class="num" id="3956267">1</span><span class="op" id="3956268">]</span>&nbsp;<span class="op" id="3956270">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956273">case</span>&nbsp;<span class="string" id="3956278">&#39;4&#39;</span><span class="op" id="3956281">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956285">return</span>&nbsp;<span class="ident" id="3956292">syscall</span><span class="op" id="3956299">.</span><span class="ident" id="3956300">AF_INET</span><span class="op" id="3956307">,</span>&nbsp;<span class="builtintype" id="3956309">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956316">case</span>&nbsp;<span class="string" id="3956321">&#39;6&#39;</span><span class="op" id="3956324">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956328">return</span>&nbsp;<span class="ident" id="3956335">syscall</span><span class="op" id="3956342">.</span><span class="ident" id="3956343">AF_INET6</span><span class="op" id="3956351">,</span>&nbsp;<span class="builtintype" id="3956353">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3956359">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956363">if</span>&nbsp;<span class="ident" id="3956366">mode</span>&nbsp;<span class="op" id="3956371">==</span>&nbsp;<span class="string" id="3956374">&#34;listen&#34;</span>&nbsp;<span class="op" id="3956383">&amp;&amp;</span>&nbsp;<span class="op" id="3956386">(</span><span class="ident" id="3956387">laddr</span>&nbsp;<span class="op" id="3956393">==</span>&nbsp;<span class="builtintype" id="3956396">nil</span>&nbsp;<span class="op" id="3956400">||</span>&nbsp;<span class="ident" id="3956403">laddr</span><span class="op" id="3956408">.</span><span class="ident" id="3956409">isWildcard</span><span class="op" id="3956419">(</span><span class="op" id="3956420">)</span><span class="op" id="3956421">)</span>&nbsp;<span class="op" id="3956423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956427">if</span>&nbsp;<span class="ident" id="3956430">supportsIPv4map</span>&nbsp;<span class="op" id="3956446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956451">return</span>&nbsp;<span class="ident" id="3956458">syscall</span><span class="op" id="3956465">.</span><span class="ident" id="3956466">AF_INET6</span><span class="op" id="3956474">,</span>&nbsp;<span class="builtintype" id="3956476">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3956484">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956488">if</span>&nbsp;<span class="ident" id="3956491">laddr</span>&nbsp;<span class="op" id="3956497">==</span>&nbsp;<span class="builtintype" id="3956500">nil</span>&nbsp;<span class="op" id="3956504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956509">return</span>&nbsp;<span class="ident" id="3956516">syscall</span><span class="op" id="3956523">.</span><span class="ident" id="3956524">AF_INET</span><span class="op" id="3956531">,</span>&nbsp;<span class="builtintype" id="3956533">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3956541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956545">return</span>&nbsp;<span class="ident" id="3956552">laddr</span><span class="op" id="3956557">.</span><span class="ident" id="3956558">family</span><span class="op" id="3956564">(</span><span class="op" id="3956565">)</span><span class="op" id="3956566">,</span>&nbsp;<span class="builtintype" id="3956568">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3956575">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956579">if</span>&nbsp;<span class="op" id="3956582">(</span><span class="ident" id="3956583">laddr</span>&nbsp;<span class="op" id="3956589">==</span>&nbsp;<span class="builtintype" id="3956592">nil</span>&nbsp;<span class="op" id="3956596">||</span>&nbsp;<span class="ident" id="3956599">laddr</span><span class="op" id="3956604">.</span><span class="ident" id="3956605">family</span><span class="op" id="3956611">(</span><span class="op" id="3956612">)</span>&nbsp;<span class="op" id="3956614">==</span>&nbsp;<span class="ident" id="3956617">syscall</span><span class="op" id="3956624">.</span><span class="ident" id="3956625">AF_INET</span><span class="op" id="3956632">)</span>&nbsp;<span class="op" id="3956634">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3956639">(</span><span class="ident" id="3956640">raddr</span>&nbsp;<span class="op" id="3956646">==</span>&nbsp;<span class="builtintype" id="3956649">nil</span>&nbsp;<span class="op" id="3956653">||</span>&nbsp;<span class="ident" id="3956656">raddr</span><span class="op" id="3956661">.</span><span class="ident" id="3956662">family</span><span class="op" id="3956668">(</span><span class="op" id="3956669">)</span>&nbsp;<span class="op" id="3956671">==</span>&nbsp;<span class="ident" id="3956674">syscall</span><span class="op" id="3956681">.</span><span class="ident" id="3956682">AF_INET</span><span class="op" id="3956689">)</span>&nbsp;<span class="op" id="3956691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956695">return</span>&nbsp;<span class="ident" id="3956702">syscall</span><span class="op" id="3956709">.</span><span class="ident" id="3956710">AF_INET</span><span class="op" id="3956717">,</span>&nbsp;<span class="builtintype" id="3956719">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3956726">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956729">return</span>&nbsp;<span class="ident" id="3956736">syscall</span><span class="op" id="3956743">.</span><span class="ident" id="3956744">AF_INET6</span><span class="op" id="3956752">,</span>&nbsp;<span class="builtintype" id="3956754">false</span><br>
<span class="lineno"></span><span class="op" id="3956760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3956763">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="3956799">func</span>&nbsp;<span class="ident" id="3956804">internetSocket</span><span class="op" id="3956818">(</span><span class="ident" id="3956819">net</span>&nbsp;<span class="builtintype" id="3956823">string</span><span class="op" id="3956829">,</span>&nbsp;<span class="ident" id="3956831">laddr</span><span class="op" id="3956836">,</span>&nbsp;<span class="ident" id="3956838">raddr</span>&nbsp;<span class="ident" id="3956844">sockaddr</span><span class="op" id="3956852">,</span>&nbsp;<span class="ident" id="3956854">deadline</span>&nbsp;<span class="ident" id="3956863">time</span><span class="op" id="3956867">.</span><span class="ident" id="3956868">Time</span><span class="op" id="3956872">,</span>&nbsp;<span class="ident" id="3956874">sotype</span><span class="op" id="3956880">,</span>&nbsp;<span class="ident" id="3956882">proto</span>&nbsp;<span class="builtintype" id="3956888">int</span><span class="op" id="3956891">,</span>&nbsp;<span class="ident" id="3956893">mode</span>&nbsp;<span class="builtintype" id="3956898">string</span><span class="op" id="3956904">)</span>&nbsp;<span class="op" id="3956906">(</span><span class="ident" id="3956907">fd</span>&nbsp;<span class="op" id="3956910">*</span><span class="ident" id="3956911">netFD</span><span class="op" id="3956916">,</span>&nbsp;<span class="ident" id="3956918">err</span>&nbsp;<span class="builtintype" id="3956922">error</span><span class="op" id="3956927">)</span>&nbsp;<span class="op" id="3956929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3956932">family</span><span class="op" id="3956938">,</span>&nbsp;<span class="ident" id="3956940">ipv6only</span>&nbsp;<span class="op" id="3956949">:=</span>&nbsp;<span class="ident" id="3956952">favoriteAddrFamily</span><span class="op" id="3956970">(</span><span class="ident" id="3956971">net</span><span class="op" id="3956974">,</span>&nbsp;<span class="ident" id="3956976">laddr</span><span class="op" id="3956981">,</span>&nbsp;<span class="ident" id="3956983">raddr</span><span class="op" id="3956988">,</span>&nbsp;<span class="ident" id="3956990">mode</span><span class="op" id="3956994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3956997">return</span>&nbsp;<span class="ident" id="3957004">socket</span><span class="op" id="3957010">(</span><span class="ident" id="3957011">net</span><span class="op" id="3957014">,</span>&nbsp;<span class="ident" id="3957016">family</span><span class="op" id="3957022">,</span>&nbsp;<span class="ident" id="3957024">sotype</span><span class="op" id="3957030">,</span>&nbsp;<span class="ident" id="3957032">proto</span><span class="op" id="3957037">,</span>&nbsp;<span class="ident" id="3957039">ipv6only</span><span class="op" id="3957047">,</span>&nbsp;<span class="ident" id="3957049">laddr</span><span class="op" id="3957054">,</span>&nbsp;<span class="ident" id="3957056">raddr</span><span class="op" id="3957061">,</span>&nbsp;<span class="ident" id="3957063">deadline</span><span class="op" id="3957071">)</span><br>
<span class="lineno"></span><span class="op" id="3957073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3957076">func</span>&nbsp;<span class="ident" id="3957081">ipToSockaddr</span><span class="op" id="3957093">(</span><span class="ident" id="3957094">family</span>&nbsp;<span class="builtintype" id="3957101">int</span><span class="op" id="3957104">,</span>&nbsp;<span class="ident" id="3957106">ip</span>&nbsp;<span class="ident" id="3957109">IP</span><span class="op" id="3957111">,</span>&nbsp;<span class="ident" id="3957113">port</span>&nbsp;<span class="builtintype" id="3957118">int</span><span class="op" id="3957121">,</span>&nbsp;<span class="ident" id="3957123">zone</span>&nbsp;<span class="builtintype" id="3957128">string</span><span class="op" id="3957134">)</span>&nbsp;<span class="op" id="3957136">(</span><span class="ident" id="3957137">syscall</span><span class="op" id="3957144">.</span><span class="ident" id="3957145">Sockaddr</span><span class="op" id="3957153">,</span>&nbsp;<span class="builtintype" id="3957155">error</span><span class="op" id="3957160">)</span>&nbsp;<span class="op" id="3957162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957165">switch</span>&nbsp;<span class="ident" id="3957172">family</span>&nbsp;<span class="op" id="3957179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957182">case</span>&nbsp;<span class="ident" id="3957187">syscall</span><span class="op" id="3957194">.</span><span class="ident" id="3957195">AF_INET</span><span class="op" id="3957202">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957206">if</span>&nbsp;<span class="builtinfunc" id="3957209">len</span><span class="op" id="3957212">(</span><span class="ident" id="3957213">ip</span><span class="op" id="3957215">)</span>&nbsp;<span class="op" id="3957217">==</span>&nbsp;<span class="num" id="3957220">0</span>&nbsp;<span class="op" id="3957222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3957227">ip</span>&nbsp;<span class="op" id="3957230">=</span>&nbsp;<span class="ident" id="3957232">IPv4zero</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3957243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957247">if</span>&nbsp;<span class="ident" id="3957250">ip</span>&nbsp;<span class="op" id="3957253">=</span>&nbsp;<span class="ident" id="3957255">ip</span><span class="op" id="3957257">.</span><span class="ident" id="3957258">To4</span><span class="op" id="3957261">(</span><span class="op" id="3957262">)</span><span class="op" id="3957263">;</span>&nbsp;<span class="ident" id="3957265">ip</span>&nbsp;<span class="op" id="3957268">==</span>&nbsp;<span class="builtintype" id="3957271">nil</span>&nbsp;<span class="op" id="3957275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957280">return</span>&nbsp;<span class="builtintype" id="3957287">nil</span><span class="op" id="3957290">,</span>&nbsp;<span class="ident" id="3957292">InvalidAddrError</span><span class="op" id="3957308">(</span><span class="string" id="3957309">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="3957327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3957331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3957335">sa</span>&nbsp;<span class="op" id="3957338">:=</span>&nbsp;<span class="builtinfunc" id="3957341">new</span><span class="op" id="3957344">(</span><span class="ident" id="3957345">syscall</span><span class="op" id="3957352">.</span><span class="ident" id="3957353">SockaddrInet4</span><span class="op" id="3957366">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957370">for</span>&nbsp;<span class="ident" id="3957374">i</span>&nbsp;<span class="op" id="3957376">:=</span>&nbsp;<span class="num" id="3957379">0</span><span class="op" id="3957380">;</span>&nbsp;<span class="ident" id="3957382">i</span>&nbsp;<span class="op" id="3957384">&lt;</span>&nbsp;<span class="ident" id="3957386">IPv4len</span><span class="op" id="3957393">;</span>&nbsp;<span class="ident" id="3957395">i</span><span class="op" id="3957396">++</span>&nbsp;<span class="op" id="3957399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3957404">sa</span><span class="op" id="3957406">.</span><span class="ident" id="3957407">Addr</span><span class="op" id="3957411">[</span><span class="ident" id="3957412">i</span><span class="op" id="3957413">]</span>&nbsp;<span class="op" id="3957415">=</span>&nbsp;<span class="ident" id="3957417">ip</span><span class="op" id="3957419">[</span><span class="ident" id="3957420">i</span><span class="op" id="3957421">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3957425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3957429">sa</span><span class="op" id="3957431">.</span><span class="ident" id="3957432">Port</span>&nbsp;<span class="op" id="3957437">=</span>&nbsp;<span class="ident" id="3957439">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957446">return</span>&nbsp;<span class="ident" id="3957453">sa</span><span class="op" id="3957455">,</span>&nbsp;<span class="builtintype" id="3957457">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957462">case</span>&nbsp;<span class="ident" id="3957467">syscall</span><span class="op" id="3957474">.</span><span class="ident" id="3957475">AF_INET6</span><span class="op" id="3957483">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957487">if</span>&nbsp;<span class="builtinfunc" id="3957490">len</span><span class="op" id="3957493">(</span><span class="ident" id="3957494">ip</span><span class="op" id="3957496">)</span>&nbsp;<span class="op" id="3957498">==</span>&nbsp;<span class="num" id="3957501">0</span>&nbsp;<span class="op" id="3957503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3957508">ip</span>&nbsp;<span class="op" id="3957511">=</span>&nbsp;<span class="ident" id="3957513">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3957524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3957528">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3957603">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3957674">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957745">if</span>&nbsp;<span class="ident" id="3957748">ip</span><span class="op" id="3957750">.</span><span class="ident" id="3957751">Equal</span><span class="op" id="3957756">(</span><span class="ident" id="3957757">IPv4zero</span><span class="op" id="3957765">)</span>&nbsp;<span class="op" id="3957767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3957772">ip</span>&nbsp;<span class="op" id="3957775">=</span>&nbsp;<span class="ident" id="3957777">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3957788">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957792">if</span>&nbsp;<span class="ident" id="3957795">ip</span>&nbsp;<span class="op" id="3957798">=</span>&nbsp;<span class="ident" id="3957800">ip</span><span class="op" id="3957802">.</span><span class="ident" id="3957803">To16</span><span class="op" id="3957807">(</span><span class="op" id="3957808">)</span><span class="op" id="3957809">;</span>&nbsp;<span class="ident" id="3957811">ip</span>&nbsp;<span class="op" id="3957814">==</span>&nbsp;<span class="builtintype" id="3957817">nil</span>&nbsp;<span class="op" id="3957821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957826">return</span>&nbsp;<span class="builtintype" id="3957833">nil</span><span class="op" id="3957836">,</span>&nbsp;<span class="ident" id="3957838">InvalidAddrError</span><span class="op" id="3957854">(</span><span class="string" id="3957855">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="3957873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3957877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3957881">sa</span>&nbsp;<span class="op" id="3957884">:=</span>&nbsp;<span class="builtinfunc" id="3957887">new</span><span class="op" id="3957890">(</span><span class="ident" id="3957891">syscall</span><span class="op" id="3957898">.</span><span class="ident" id="3957899">SockaddrInet6</span><span class="op" id="3957912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3957916">for</span>&nbsp;<span class="ident" id="3957920">i</span>&nbsp;<span class="op" id="3957922">:=</span>&nbsp;<span class="num" id="3957925">0</span><span class="op" id="3957926">;</span>&nbsp;<span class="ident" id="3957928">i</span>&nbsp;<span class="op" id="3957930">&lt;</span>&nbsp;<span class="ident" id="3957932">IPv6len</span><span class="op" id="3957939">;</span>&nbsp;<span class="ident" id="3957941">i</span><span class="op" id="3957942">++</span>&nbsp;<span class="op" id="3957945">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3957950">sa</span><span class="op" id="3957952">.</span><span class="ident" id="3957953">Addr</span><span class="op" id="3957957">[</span><span class="ident" id="3957958">i</span><span class="op" id="3957959">]</span>&nbsp;<span class="op" id="3957961">=</span>&nbsp;<span class="ident" id="3957963">ip</span><span class="op" id="3957965">[</span><span class="ident" id="3957966">i</span><span class="op" id="3957967">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3957971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3957975">sa</span><span class="op" id="3957977">.</span><span class="ident" id="3957978">Port</span>&nbsp;<span class="op" id="3957983">=</span>&nbsp;<span class="ident" id="3957985">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3957992">sa</span><span class="op" id="3957994">.</span><span class="ident" id="3957995">ZoneId</span>&nbsp;<span class="op" id="3958002">=</span>&nbsp;<span class="builtintype" id="3958004">uint32</span><span class="op" id="3958010">(</span><span class="ident" id="3958011">zoneToInt</span><span class="op" id="3958020">(</span><span class="ident" id="3958021">zone</span><span class="op" id="3958025">)</span><span class="op" id="3958026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3958030">return</span>&nbsp;<span class="ident" id="3958037">sa</span><span class="op" id="3958039">,</span>&nbsp;<span class="builtintype" id="3958041">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3958046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3958049">return</span>&nbsp;<span class="builtintype" id="3958056">nil</span><span class="op" id="3958059">,</span>&nbsp;<span class="ident" id="3958061">InvalidAddrError</span><span class="op" id="3958077">(</span><span class="string" id="3958078">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="3958104">)</span><br>
<span class="lineno"></span><span class="op" id="3958106">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
