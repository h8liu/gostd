<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html" class="current">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6184611">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6184666">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6184720">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6184771">package</span>&nbsp;<span class="ident" id="6184779">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6184789">import</span>&nbsp;<span class="op" id="6184796">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6184799">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6184808">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6184818">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6184824">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6184831">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6184843">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6184860">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6184867">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6184870">var</span>&nbsp;<span class="op" id="6184874">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184877">ErrPersistEOF</span>&nbsp;<span class="op" id="6184891">=</span>&nbsp;<span class="op" id="6184893">&amp;</span><span class="ident" id="6184894">http</span><span class="op" id="6184898">.</span><span class="ident" id="6184899">ProtocolError</span><span class="op" id="6184912">{</span><span class="ident" id="6184913">ErrorString</span><span class="op" id="6184924">:</span>&nbsp;<span class="string" id="6184926">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="6184956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6184959">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6184973">=</span>&nbsp;<span class="op" id="6184975">&amp;</span><span class="ident" id="6184976">http</span><span class="op" id="6184980">.</span><span class="ident" id="6184981">ProtocolError</span><span class="op" id="6184994">{</span><span class="ident" id="6184995">ErrorString</span><span class="op" id="6185006">:</span>&nbsp;<span class="string" id="6185008">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="6185035">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6185038">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6185052">=</span>&nbsp;<span class="op" id="6185054">&amp;</span><span class="ident" id="6185055">http</span><span class="op" id="6185059">.</span><span class="ident" id="6185060">ProtocolError</span><span class="op" id="6185073">{</span><span class="ident" id="6185074">ErrorString</span><span class="op" id="6185085">:</span>&nbsp;<span class="string" id="6185087">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="6185103">}</span><br>
<span class="lineno"></span><span class="op" id="6185105">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6185108">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="6185166">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="6185231">var</span>&nbsp;<span class="ident" id="6185235">errClosed</span>&nbsp;<span class="op" id="6185245">=</span>&nbsp;<span class="ident" id="6185247">errors</span><span class="op" id="6185253">.</span><span class="ident" id="6185254">New</span><span class="op" id="6185257">(</span><span class="string" id="6185258">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="6185294">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6185297">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6185367">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="6185441">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="6185510">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="6185585">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6185660">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="6185694">//</span><br>
<span class="lineno"></span><span class="comment" id="6185697">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="6185772">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6185800">type</span>&nbsp;<span class="ident" id="6185805">ServerConn</span>&nbsp;<span class="keyword" id="6185816">struct</span>&nbsp;<span class="op" id="6185823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6185826">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6185842">sync</span><span class="op" id="6185846">.</span><span class="ident" id="6185847">Mutex</span>&nbsp;<span class="comment" id="6185853">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6185898">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6185914">net</span><span class="op" id="6185917">.</span><span class="ident" id="6185918">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6185924">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6185940">*</span><span class="ident" id="6185941">bufio</span><span class="op" id="6185946">.</span><span class="ident" id="6185947">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6185955">re</span><span class="op" id="6185957">,</span>&nbsp;<span class="ident" id="6185959">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6185971">error</span>&nbsp;<span class="comment" id="6185977">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6185999">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6186015">io</span><span class="op" id="6186017">.</span><span class="ident" id="6186018">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6186030">nread</span><span class="op" id="6186035">,</span>&nbsp;<span class="ident" id="6186037">nwritten</span>&nbsp;<span class="builtintype" id="6186046">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6186051">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6186067">map</span><span class="op" id="6186070">[</span><span class="op" id="6186071">*</span><span class="ident" id="6186072">http</span><span class="op" id="6186076">.</span><span class="ident" id="6186077">Request</span><span class="op" id="6186084">]</span><span class="builtintype" id="6186085">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6186092">pipe</span>&nbsp;<span class="ident" id="6186097">textproto</span><span class="op" id="6186106">.</span><span class="ident" id="6186107">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="6186116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6186119">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6186196">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="6186244">//</span><br>
<span class="lineno"></span><span class="comment" id="6186247">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="6186322">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6186350">func</span>&nbsp;<span class="ident" id="6186355">NewServerConn</span><span class="op" id="6186368">(</span><span class="ident" id="6186369">c</span>&nbsp;<span class="ident" id="6186371">net</span><span class="op" id="6186374">.</span><span class="ident" id="6186375">Conn</span><span class="op" id="6186379">,</span>&nbsp;<span class="ident" id="6186381">r</span>&nbsp;<span class="op" id="6186383">*</span><span class="ident" id="6186384">bufio</span><span class="op" id="6186389">.</span><span class="ident" id="6186390">Reader</span><span class="op" id="6186396">)</span>&nbsp;<span class="op" id="6186398">*</span><span class="ident" id="6186399">ServerConn</span>&nbsp;<span class="op" id="6186410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6186413">if</span>&nbsp;<span class="ident" id="6186416">r</span>&nbsp;<span class="op" id="6186418">==</span>&nbsp;<span class="builtintype" id="6186421">nil</span>&nbsp;<span class="op" id="6186425">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6186429">r</span>&nbsp;<span class="op" id="6186431">=</span>&nbsp;<span class="ident" id="6186433">bufio</span><span class="op" id="6186438">.</span><span class="ident" id="6186439">NewReader</span><span class="op" id="6186448">(</span><span class="ident" id="6186449">c</span><span class="op" id="6186450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6186453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6186456">return</span>&nbsp;<span class="op" id="6186463">&amp;</span><span class="ident" id="6186464">ServerConn</span><span class="op" id="6186474">{</span><span class="ident" id="6186475">c</span><span class="op" id="6186476">:</span>&nbsp;<span class="ident" id="6186478">c</span><span class="op" id="6186479">,</span>&nbsp;<span class="ident" id="6186481">r</span><span class="op" id="6186482">:</span>&nbsp;<span class="ident" id="6186484">r</span><span class="op" id="6186485">,</span>&nbsp;<span class="ident" id="6186487">pipereq</span><span class="op" id="6186494">:</span>&nbsp;<span class="builtinfunc" id="6186496">make</span><span class="op" id="6186500">(</span><span class="keyword" id="6186501">map</span><span class="op" id="6186504">[</span><span class="op" id="6186505">*</span><span class="ident" id="6186506">http</span><span class="op" id="6186510">.</span><span class="ident" id="6186511">Request</span><span class="op" id="6186518">]</span><span class="builtintype" id="6186519">uint</span><span class="op" id="6186523">)</span><span class="op" id="6186524">}</span><br>
<span class="lineno"></span><span class="op" id="6186526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6186529">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6186609">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6186685">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="6186762">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6186824">func</span>&nbsp;<span class="op" id="6186829">(</span><span class="ident" id="6186830">sc</span>&nbsp;<span class="op" id="6186833">*</span><span class="ident" id="6186834">ServerConn</span><span class="op" id="6186844">)</span>&nbsp;<span class="ident" id="6186846">Hijack</span><span class="op" id="6186852">(</span><span class="op" id="6186853">)</span>&nbsp;<span class="op" id="6186855">(</span><span class="ident" id="6186856">c</span>&nbsp;<span class="ident" id="6186858">net</span><span class="op" id="6186861">.</span><span class="ident" id="6186862">Conn</span><span class="op" id="6186866">,</span>&nbsp;<span class="ident" id="6186868">r</span>&nbsp;<span class="op" id="6186870">*</span><span class="ident" id="6186871">bufio</span><span class="op" id="6186876">.</span><span class="ident" id="6186877">Reader</span><span class="op" id="6186883">)</span>&nbsp;<span class="op" id="6186885">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6186888">sc</span><span class="op" id="6186890">.</span><span class="ident" id="6186891">lk</span><span class="op" id="6186893">.</span><span class="ident" id="6186894">Lock</span><span class="op" id="6186898">(</span><span class="op" id="6186899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6186902">defer</span>&nbsp;<span class="ident" id="6186908">sc</span><span class="op" id="6186910">.</span><span class="ident" id="6186911">lk</span><span class="op" id="6186913">.</span><span class="ident" id="6186914">Unlock</span><span class="op" id="6186920">(</span><span class="op" id="6186921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6186924">c</span>&nbsp;<span class="op" id="6186926">=</span>&nbsp;<span class="ident" id="6186928">sc</span><span class="op" id="6186930">.</span><span class="ident" id="6186931">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6186934">r</span>&nbsp;<span class="op" id="6186936">=</span>&nbsp;<span class="ident" id="6186938">sc</span><span class="op" id="6186940">.</span><span class="ident" id="6186941">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6186944">sc</span><span class="op" id="6186946">.</span><span class="ident" id="6186947">c</span>&nbsp;<span class="op" id="6186949">=</span>&nbsp;<span class="builtintype" id="6186951">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6186956">sc</span><span class="op" id="6186958">.</span><span class="ident" id="6186959">r</span>&nbsp;<span class="op" id="6186961">=</span>&nbsp;<span class="builtintype" id="6186963">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6186968">return</span><br>
<span class="lineno"></span><span class="op" id="6186975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6186978">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="6187047">func</span>&nbsp;<span class="op" id="6187052">(</span><span class="ident" id="6187053">sc</span>&nbsp;<span class="op" id="6187056">*</span><span class="ident" id="6187057">ServerConn</span><span class="op" id="6187067">)</span>&nbsp;<span class="ident" id="6187069">Close</span><span class="op" id="6187074">(</span><span class="op" id="6187075">)</span>&nbsp;<span class="builtintype" id="6187077">error</span>&nbsp;<span class="op" id="6187083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6187086">c</span><span class="op" id="6187087">,</span>&nbsp;<span class="ident" id="6187089">_</span>&nbsp;<span class="op" id="6187091">:=</span>&nbsp;<span class="ident" id="6187094">sc</span><span class="op" id="6187096">.</span><span class="ident" id="6187097">Hijack</span><span class="op" id="6187103">(</span><span class="op" id="6187104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6187107">if</span>&nbsp;<span class="ident" id="6187110">c</span>&nbsp;<span class="op" id="6187112">!=</span>&nbsp;<span class="builtintype" id="6187115">nil</span>&nbsp;<span class="op" id="6187119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6187123">return</span>&nbsp;<span class="ident" id="6187130">c</span><span class="op" id="6187131">.</span><span class="ident" id="6187132">Close</span><span class="op" id="6187137">(</span><span class="op" id="6187138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6187141">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6187144">return</span>&nbsp;<span class="builtintype" id="6187151">nil</span><br>
<span class="lineno"></span><span class="op" id="6187155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6187158">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="6187236">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="6187315">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6187392">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="6187417">func</span>&nbsp;<span class="op" id="6187422">(</span><span class="ident" id="6187423">sc</span>&nbsp;<span class="op" id="6187426">*</span><span class="ident" id="6187427">ServerConn</span><span class="op" id="6187437">)</span>&nbsp;<span class="ident" id="6187439">Read</span><span class="op" id="6187443">(</span><span class="op" id="6187444">)</span>&nbsp;<span class="op" id="6187446">(</span><span class="ident" id="6187447">req</span>&nbsp;<span class="op" id="6187451">*</span><span class="ident" id="6187452">http</span><span class="op" id="6187456">.</span><span class="ident" id="6187457">Request</span><span class="op" id="6187464">,</span>&nbsp;<span class="ident" id="6187466">err</span>&nbsp;<span class="builtintype" id="6187470">error</span><span class="op" id="6187475">)</span>&nbsp;<span class="op" id="6187477">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6187481">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6187530">id</span>&nbsp;<span class="op" id="6187533">:=</span>&nbsp;<span class="ident" id="6187536">sc</span><span class="op" id="6187538">.</span><span class="ident" id="6187539">pipe</span><span class="op" id="6187543">.</span><span class="ident" id="6187544">Next</span><span class="op" id="6187548">(</span><span class="op" id="6187549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6187552">sc</span><span class="op" id="6187554">.</span><span class="ident" id="6187555">pipe</span><span class="op" id="6187559">.</span><span class="ident" id="6187560">StartRequest</span><span class="op" id="6187572">(</span><span class="ident" id="6187573">id</span><span class="op" id="6187575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6187578">defer</span>&nbsp;<span class="keyword" id="6187584">func</span><span class="op" id="6187588">(</span><span class="op" id="6187589">)</span>&nbsp;<span class="op" id="6187591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6187595">sc</span><span class="op" id="6187597">.</span><span class="ident" id="6187598">pipe</span><span class="op" id="6187602">.</span><span class="ident" id="6187603">EndRequest</span><span class="op" id="6187613">(</span><span class="ident" id="6187614">id</span><span class="op" id="6187616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6187620">if</span>&nbsp;<span class="ident" id="6187623">req</span>&nbsp;<span class="op" id="6187627">==</span>&nbsp;<span class="builtintype" id="6187630">nil</span>&nbsp;<span class="op" id="6187634">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6187639">sc</span><span class="op" id="6187641">.</span><span class="ident" id="6187642">pipe</span><span class="op" id="6187646">.</span><span class="ident" id="6187647">StartResponse</span><span class="op" id="6187660">(</span><span class="ident" id="6187661">id</span><span class="op" id="6187663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6187668">sc</span><span class="op" id="6187670">.</span><span class="ident" id="6187671">pipe</span><span class="op" id="6187675">.</span><span class="ident" id="6187676">EndResponse</span><span class="op" id="6187687">(</span><span class="ident" id="6187688">id</span><span class="op" id="6187690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6187694">}</span>&nbsp;<span class="keyword" id="6187696">else</span>&nbsp;<span class="op" id="6187701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6187706">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6187753">sc</span><span class="op" id="6187755">.</span><span class="ident" id="6187756">lk</span><span class="op" id="6187758">.</span><span class="ident" id="6187759">Lock</span><span class="op" id="6187763">(</span><span class="op" id="6187764">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6187769">sc</span><span class="op" id="6187771">.</span><span class="ident" id="6187772">pipereq</span><span class="op" id="6187779">[</span><span class="ident" id="6187780">req</span><span class="op" id="6187783">]</span>&nbsp;<span class="op" id="6187785">=</span>&nbsp;<span class="ident" id="6187787">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6187793">sc</span><span class="op" id="6187795">.</span><span class="ident" id="6187796">lk</span><span class="op" id="6187798">.</span><span class="ident" id="6187799">Unlock</span><span class="op" id="6187805">(</span><span class="op" id="6187806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6187810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6187813">}</span><span class="op" id="6187814">(</span><span class="op" id="6187815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6187819">sc</span><span class="op" id="6187821">.</span><span class="ident" id="6187822">lk</span><span class="op" id="6187824">.</span><span class="ident" id="6187825">Lock</span><span class="op" id="6187829">(</span><span class="op" id="6187830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6187833">if</span>&nbsp;<span class="ident" id="6187836">sc</span><span class="op" id="6187838">.</span><span class="ident" id="6187839">we</span>&nbsp;<span class="op" id="6187842">!=</span>&nbsp;<span class="builtintype" id="6187845">nil</span>&nbsp;<span class="op" id="6187849">{</span>&nbsp;<span class="comment" id="6187851">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6187906">defer</span>&nbsp;<span class="ident" id="6187912">sc</span><span class="op" id="6187914">.</span><span class="ident" id="6187915">lk</span><span class="op" id="6187917">.</span><span class="ident" id="6187918">Unlock</span><span class="op" id="6187924">(</span><span class="op" id="6187925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6187929">return</span>&nbsp;<span class="builtintype" id="6187936">nil</span><span class="op" id="6187939">,</span>&nbsp;<span class="ident" id="6187941">sc</span><span class="op" id="6187943">.</span><span class="ident" id="6187944">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6187948">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6187951">if</span>&nbsp;<span class="ident" id="6187954">sc</span><span class="op" id="6187956">.</span><span class="ident" id="6187957">re</span>&nbsp;<span class="op" id="6187960">!=</span>&nbsp;<span class="builtintype" id="6187963">nil</span>&nbsp;<span class="op" id="6187967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6187971">defer</span>&nbsp;<span class="ident" id="6187977">sc</span><span class="op" id="6187979">.</span><span class="ident" id="6187980">lk</span><span class="op" id="6187982">.</span><span class="ident" id="6187983">Unlock</span><span class="op" id="6187989">(</span><span class="op" id="6187990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6187994">return</span>&nbsp;<span class="builtintype" id="6188001">nil</span><span class="op" id="6188004">,</span>&nbsp;<span class="ident" id="6188006">sc</span><span class="op" id="6188008">.</span><span class="ident" id="6188009">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6188013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188016">if</span>&nbsp;<span class="ident" id="6188019">sc</span><span class="op" id="6188021">.</span><span class="ident" id="6188022">r</span>&nbsp;<span class="op" id="6188024">==</span>&nbsp;<span class="builtintype" id="6188027">nil</span>&nbsp;<span class="op" id="6188031">{</span>&nbsp;<span class="comment" id="6188033">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188080">defer</span>&nbsp;<span class="ident" id="6188086">sc</span><span class="op" id="6188088">.</span><span class="ident" id="6188089">lk</span><span class="op" id="6188091">.</span><span class="ident" id="6188092">Unlock</span><span class="op" id="6188098">(</span><span class="op" id="6188099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188103">return</span>&nbsp;<span class="builtintype" id="6188110">nil</span><span class="op" id="6188113">,</span>&nbsp;<span class="ident" id="6188115">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6188126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188129">r</span>&nbsp;<span class="op" id="6188131">:=</span>&nbsp;<span class="ident" id="6188134">sc</span><span class="op" id="6188136">.</span><span class="ident" id="6188137">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188140">lastbody</span>&nbsp;<span class="op" id="6188149">:=</span>&nbsp;<span class="ident" id="6188152">sc</span><span class="op" id="6188154">.</span><span class="ident" id="6188155">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188165">sc</span><span class="op" id="6188167">.</span><span class="ident" id="6188168">lastbody</span>&nbsp;<span class="op" id="6188177">=</span>&nbsp;<span class="builtintype" id="6188179">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188184">sc</span><span class="op" id="6188186">.</span><span class="ident" id="6188187">lk</span><span class="op" id="6188189">.</span><span class="ident" id="6188190">Unlock</span><span class="op" id="6188196">(</span><span class="op" id="6188197">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6188201">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188277">if</span>&nbsp;<span class="ident" id="6188280">lastbody</span>&nbsp;<span class="op" id="6188289">!=</span>&nbsp;<span class="builtintype" id="6188292">nil</span>&nbsp;<span class="op" id="6188296">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6188300">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6188366">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6188424">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188439">err</span>&nbsp;<span class="op" id="6188443">=</span>&nbsp;<span class="ident" id="6188445">lastbody</span><span class="op" id="6188453">.</span><span class="ident" id="6188454">Close</span><span class="op" id="6188459">(</span><span class="op" id="6188460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188464">if</span>&nbsp;<span class="ident" id="6188467">err</span>&nbsp;<span class="op" id="6188471">!=</span>&nbsp;<span class="builtintype" id="6188474">nil</span>&nbsp;<span class="op" id="6188478">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188483">sc</span><span class="op" id="6188485">.</span><span class="ident" id="6188486">lk</span><span class="op" id="6188488">.</span><span class="ident" id="6188489">Lock</span><span class="op" id="6188493">(</span><span class="op" id="6188494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188499">defer</span>&nbsp;<span class="ident" id="6188505">sc</span><span class="op" id="6188507">.</span><span class="ident" id="6188508">lk</span><span class="op" id="6188510">.</span><span class="ident" id="6188511">Unlock</span><span class="op" id="6188517">(</span><span class="op" id="6188518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188523">sc</span><span class="op" id="6188525">.</span><span class="ident" id="6188526">re</span>&nbsp;<span class="op" id="6188529">=</span>&nbsp;<span class="ident" id="6188531">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188538">return</span>&nbsp;<span class="builtintype" id="6188545">nil</span><span class="op" id="6188548">,</span>&nbsp;<span class="ident" id="6188550">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6188556">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6188559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188563">req</span><span class="op" id="6188566">,</span>&nbsp;<span class="ident" id="6188568">err</span>&nbsp;<span class="op" id="6188572">=</span>&nbsp;<span class="ident" id="6188574">http</span><span class="op" id="6188578">.</span><span class="ident" id="6188579">ReadRequest</span><span class="op" id="6188590">(</span><span class="ident" id="6188591">r</span><span class="op" id="6188592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188595">sc</span><span class="op" id="6188597">.</span><span class="ident" id="6188598">lk</span><span class="op" id="6188600">.</span><span class="ident" id="6188601">Lock</span><span class="op" id="6188605">(</span><span class="op" id="6188606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188609">defer</span>&nbsp;<span class="ident" id="6188615">sc</span><span class="op" id="6188617">.</span><span class="ident" id="6188618">lk</span><span class="op" id="6188620">.</span><span class="ident" id="6188621">Unlock</span><span class="op" id="6188627">(</span><span class="op" id="6188628">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188631">if</span>&nbsp;<span class="ident" id="6188634">err</span>&nbsp;<span class="op" id="6188638">!=</span>&nbsp;<span class="builtintype" id="6188641">nil</span>&nbsp;<span class="op" id="6188645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188649">if</span>&nbsp;<span class="ident" id="6188652">err</span>&nbsp;<span class="op" id="6188656">==</span>&nbsp;<span class="ident" id="6188659">io</span><span class="op" id="6188661">.</span><span class="ident" id="6188662">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="6188679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6188684">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6188739">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6188797">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188826">sc</span><span class="op" id="6188828">.</span><span class="ident" id="6188829">re</span>&nbsp;<span class="op" id="6188832">=</span>&nbsp;<span class="ident" id="6188834">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188851">return</span>&nbsp;<span class="builtintype" id="6188858">nil</span><span class="op" id="6188861">,</span>&nbsp;<span class="ident" id="6188863">sc</span><span class="op" id="6188865">.</span><span class="ident" id="6188866">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6188871">}</span>&nbsp;<span class="keyword" id="6188873">else</span>&nbsp;<span class="op" id="6188878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188883">sc</span><span class="op" id="6188885">.</span><span class="ident" id="6188886">re</span>&nbsp;<span class="op" id="6188889">=</span>&nbsp;<span class="ident" id="6188891">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188898">return</span>&nbsp;<span class="ident" id="6188905">req</span><span class="op" id="6188908">,</span>&nbsp;<span class="ident" id="6188910">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6188916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6188919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188922">sc</span><span class="op" id="6188924">.</span><span class="ident" id="6188925">lastbody</span>&nbsp;<span class="op" id="6188934">=</span>&nbsp;<span class="ident" id="6188936">req</span><span class="op" id="6188939">.</span><span class="ident" id="6188940">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188946">sc</span><span class="op" id="6188948">.</span><span class="ident" id="6188949">nread</span><span class="op" id="6188954">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188958">if</span>&nbsp;<span class="ident" id="6188961">req</span><span class="op" id="6188964">.</span><span class="ident" id="6188965">Close</span>&nbsp;<span class="op" id="6188971">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6188975">sc</span><span class="op" id="6188977">.</span><span class="ident" id="6188978">re</span>&nbsp;<span class="op" id="6188981">=</span>&nbsp;<span class="ident" id="6188983">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6188999">return</span>&nbsp;<span class="ident" id="6189006">req</span><span class="op" id="6189009">,</span>&nbsp;<span class="ident" id="6189011">sc</span><span class="op" id="6189013">.</span><span class="ident" id="6189014">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6189018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6189021">return</span>&nbsp;<span class="ident" id="6189028">req</span><span class="op" id="6189031">,</span>&nbsp;<span class="ident" id="6189033">err</span><br>
<span class="lineno"></span><span class="op" id="6189037">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="6189040">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="6189093">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6189139">func</span>&nbsp;<span class="op" id="6189144">(</span><span class="ident" id="6189145">sc</span>&nbsp;<span class="op" id="6189148">*</span><span class="ident" id="6189149">ServerConn</span><span class="op" id="6189159">)</span>&nbsp;<span class="ident" id="6189161">Pending</span><span class="op" id="6189168">(</span><span class="op" id="6189169">)</span>&nbsp;<span class="builtintype" id="6189171">int</span>&nbsp;<span class="op" id="6189175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6189178">sc</span><span class="op" id="6189180">.</span><span class="ident" id="6189181">lk</span><span class="op" id="6189183">.</span><span class="ident" id="6189184">Lock</span><span class="op" id="6189188">(</span><span class="op" id="6189189">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6189192">defer</span>&nbsp;<span class="ident" id="6189198">sc</span><span class="op" id="6189200">.</span><span class="ident" id="6189201">lk</span><span class="op" id="6189203">.</span><span class="ident" id="6189204">Unlock</span><span class="op" id="6189210">(</span><span class="op" id="6189211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6189214">return</span>&nbsp;<span class="ident" id="6189221">sc</span><span class="op" id="6189223">.</span><span class="ident" id="6189224">nread</span>&nbsp;<span class="op" id="6189230">-</span>&nbsp;<span class="ident" id="6189232">sc</span><span class="op" id="6189234">.</span><span class="ident" id="6189235">nwritten</span><br>
<span class="lineno"></span><span class="op" id="6189244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6189247">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="6189332">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="6189410">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="6189486">func</span>&nbsp;<span class="op" id="6189491">(</span><span class="ident" id="6189492">sc</span>&nbsp;<span class="op" id="6189495">*</span><span class="ident" id="6189496">ServerConn</span><span class="op" id="6189506">)</span>&nbsp;<span class="ident" id="6189508">Write</span><span class="op" id="6189513">(</span><span class="ident" id="6189514">req</span>&nbsp;<span class="op" id="6189518">*</span><span class="ident" id="6189519">http</span><span class="op" id="6189523">.</span><span class="ident" id="6189524">Request</span><span class="op" id="6189531">,</span>&nbsp;<span class="ident" id="6189533">resp</span>&nbsp;<span class="op" id="6189538">*</span><span class="ident" id="6189539">http</span><span class="op" id="6189543">.</span><span class="ident" id="6189544">Response</span><span class="op" id="6189552">)</span>&nbsp;<span class="builtintype" id="6189554">error</span>&nbsp;<span class="op" id="6189560">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6189564">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6189623">sc</span><span class="op" id="6189625">.</span><span class="ident" id="6189626">lk</span><span class="op" id="6189628">.</span><span class="ident" id="6189629">Lock</span><span class="op" id="6189633">(</span><span class="op" id="6189634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6189637">id</span><span class="op" id="6189639">,</span>&nbsp;<span class="ident" id="6189641">ok</span>&nbsp;<span class="op" id="6189644">:=</span>&nbsp;<span class="ident" id="6189647">sc</span><span class="op" id="6189649">.</span><span class="ident" id="6189650">pipereq</span><span class="op" id="6189657">[</span><span class="ident" id="6189658">req</span><span class="op" id="6189661">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6189664">delete</span><span class="op" id="6189670">(</span><span class="ident" id="6189671">sc</span><span class="op" id="6189673">.</span><span class="ident" id="6189674">pipereq</span><span class="op" id="6189681">,</span>&nbsp;<span class="ident" id="6189683">req</span><span class="op" id="6189686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6189689">if</span>&nbsp;<span class="op" id="6189692">!</span><span class="ident" id="6189693">ok</span>&nbsp;<span class="op" id="6189696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6189700">sc</span><span class="op" id="6189702">.</span><span class="ident" id="6189703">lk</span><span class="op" id="6189705">.</span><span class="ident" id="6189706">Unlock</span><span class="op" id="6189712">(</span><span class="op" id="6189713">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6189717">return</span>&nbsp;<span class="ident" id="6189724">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6189737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6189740">sc</span><span class="op" id="6189742">.</span><span class="ident" id="6189743">lk</span><span class="op" id="6189745">.</span><span class="ident" id="6189746">Unlock</span><span class="op" id="6189752">(</span><span class="op" id="6189753">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6189757">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6189783">sc</span><span class="op" id="6189785">.</span><span class="ident" id="6189786">pipe</span><span class="op" id="6189790">.</span><span class="ident" id="6189791">StartResponse</span><span class="op" id="6189804">(</span><span class="ident" id="6189805">id</span><span class="op" id="6189807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6189810">defer</span>&nbsp;<span class="ident" id="6189816">sc</span><span class="op" id="6189818">.</span><span class="ident" id="6189819">pipe</span><span class="op" id="6189823">.</span><span class="ident" id="6189824">EndResponse</span><span class="op" id="6189835">(</span><span class="ident" id="6189836">id</span><span class="op" id="6189838">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6189842">sc</span><span class="op" id="6189844">.</span><span class="ident" id="6189845">lk</span><span class="op" id="6189847">.</span><span class="ident" id="6189848">Lock</span><span class="op" id="6189852">(</span><span class="op" id="6189853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6189856">if</span>&nbsp;<span class="ident" id="6189859">sc</span><span class="op" id="6189861">.</span><span class="ident" id="6189862">we</span>&nbsp;<span class="op" id="6189865">!=</span>&nbsp;<span class="builtintype" id="6189868">nil</span>&nbsp;<span class="op" id="6189872">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6189876">defer</span>&nbsp;<span class="ident" id="6189882">sc</span><span class="op" id="6189884">.</span><span class="ident" id="6189885">lk</span><span class="op" id="6189887">.</span><span class="ident" id="6189888">Unlock</span><span class="op" id="6189894">(</span><span class="op" id="6189895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6189899">return</span>&nbsp;<span class="ident" id="6189906">sc</span><span class="op" id="6189908">.</span><span class="ident" id="6189909">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6189913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6189916">if</span>&nbsp;<span class="ident" id="6189919">sc</span><span class="op" id="6189921">.</span><span class="ident" id="6189922">c</span>&nbsp;<span class="op" id="6189924">==</span>&nbsp;<span class="builtintype" id="6189927">nil</span>&nbsp;<span class="op" id="6189931">{</span>&nbsp;<span class="comment" id="6189933">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6189980">defer</span>&nbsp;<span class="ident" id="6189986">sc</span><span class="op" id="6189988">.</span><span class="ident" id="6189989">lk</span><span class="op" id="6189991">.</span><span class="ident" id="6189992">Unlock</span><span class="op" id="6189998">(</span><span class="op" id="6189999">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6190003">return</span>&nbsp;<span class="ident" id="6190010">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6190021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6190024">c</span>&nbsp;<span class="op" id="6190026">:=</span>&nbsp;<span class="ident" id="6190029">sc</span><span class="op" id="6190031">.</span><span class="ident" id="6190032">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6190035">if</span>&nbsp;<span class="ident" id="6190038">sc</span><span class="op" id="6190040">.</span><span class="ident" id="6190041">nread</span>&nbsp;<span class="op" id="6190047">&lt;=</span>&nbsp;<span class="ident" id="6190050">sc</span><span class="op" id="6190052">.</span><span class="ident" id="6190053">nwritten</span>&nbsp;<span class="op" id="6190062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6190066">defer</span>&nbsp;<span class="ident" id="6190072">sc</span><span class="op" id="6190074">.</span><span class="ident" id="6190075">lk</span><span class="op" id="6190077">.</span><span class="ident" id="6190078">Unlock</span><span class="op" id="6190084">(</span><span class="op" id="6190085">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6190089">return</span>&nbsp;<span class="ident" id="6190096">errors</span><span class="op" id="6190102">.</span><span class="ident" id="6190103">New</span><span class="op" id="6190106">(</span><span class="string" id="6190107">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="6190134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6190137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6190140">if</span>&nbsp;<span class="ident" id="6190143">resp</span><span class="op" id="6190147">.</span><span class="ident" id="6190148">Close</span>&nbsp;<span class="op" id="6190154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6190158">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6190220">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6190283">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6190306">sc</span><span class="op" id="6190308">.</span><span class="ident" id="6190309">re</span>&nbsp;<span class="op" id="6190312">=</span>&nbsp;<span class="ident" id="6190314">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6190329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6190332">sc</span><span class="op" id="6190334">.</span><span class="ident" id="6190335">lk</span><span class="op" id="6190337">.</span><span class="ident" id="6190338">Unlock</span><span class="op" id="6190344">(</span><span class="op" id="6190345">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6190349">err</span>&nbsp;<span class="op" id="6190353">:=</span>&nbsp;<span class="ident" id="6190356">resp</span><span class="op" id="6190360">.</span><span class="ident" id="6190361">Write</span><span class="op" id="6190366">(</span><span class="ident" id="6190367">c</span><span class="op" id="6190368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6190371">sc</span><span class="op" id="6190373">.</span><span class="ident" id="6190374">lk</span><span class="op" id="6190376">.</span><span class="ident" id="6190377">Lock</span><span class="op" id="6190381">(</span><span class="op" id="6190382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6190385">defer</span>&nbsp;<span class="ident" id="6190391">sc</span><span class="op" id="6190393">.</span><span class="ident" id="6190394">lk</span><span class="op" id="6190396">.</span><span class="ident" id="6190397">Unlock</span><span class="op" id="6190403">(</span><span class="op" id="6190404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6190407">if</span>&nbsp;<span class="ident" id="6190410">err</span>&nbsp;<span class="op" id="6190414">!=</span>&nbsp;<span class="builtintype" id="6190417">nil</span>&nbsp;<span class="op" id="6190421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6190425">sc</span><span class="op" id="6190427">.</span><span class="ident" id="6190428">we</span>&nbsp;<span class="op" id="6190431">=</span>&nbsp;<span class="ident" id="6190433">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6190439">return</span>&nbsp;<span class="ident" id="6190446">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6190451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6190454">sc</span><span class="op" id="6190456">.</span><span class="ident" id="6190457">nwritten</span><span class="op" id="6190465">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6190470">return</span>&nbsp;<span class="builtintype" id="6190477">nil</span><br>
<span class="lineno">220</span><span class="op" id="6190481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6190484">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6190554">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="6190623">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="6190678">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="6190752">//</span><br>
<span class="lineno"></span><span class="comment" id="6190755">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="6190823">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6190871">type</span>&nbsp;<span class="ident" id="6190876">ClientConn</span>&nbsp;<span class="keyword" id="6190887">struct</span>&nbsp;<span class="op" id="6190894">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6190897">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6190913">sync</span><span class="op" id="6190917">.</span><span class="ident" id="6190918">Mutex</span>&nbsp;<span class="comment" id="6190924">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6190969">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6190985">net</span><span class="op" id="6190988">.</span><span class="ident" id="6190989">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6190995">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6191011">*</span><span class="ident" id="6191012">bufio</span><span class="op" id="6191017">.</span><span class="ident" id="6191018">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191026">re</span><span class="op" id="6191028">,</span>&nbsp;<span class="ident" id="6191030">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6191042">error</span>&nbsp;<span class="comment" id="6191048">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191070">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191086">io</span><span class="op" id="6191088">.</span><span class="ident" id="6191089">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191101">nread</span><span class="op" id="6191106">,</span>&nbsp;<span class="ident" id="6191108">nwritten</span>&nbsp;<span class="builtintype" id="6191117">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191122">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6191138">map</span><span class="op" id="6191141">[</span><span class="op" id="6191142">*</span><span class="ident" id="6191143">http</span><span class="op" id="6191147">.</span><span class="ident" id="6191148">Request</span><span class="op" id="6191155">]</span><span class="builtintype" id="6191156">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191163">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191172">textproto</span><span class="op" id="6191181">.</span><span class="ident" id="6191182">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191192">writeReq</span>&nbsp;<span class="keyword" id="6191201">func</span><span class="op" id="6191205">(</span><span class="op" id="6191206">*</span><span class="ident" id="6191207">http</span><span class="op" id="6191211">.</span><span class="ident" id="6191212">Request</span><span class="op" id="6191219">,</span>&nbsp;<span class="ident" id="6191221">io</span><span class="op" id="6191223">.</span><span class="ident" id="6191224">Writer</span><span class="op" id="6191230">)</span>&nbsp;<span class="builtintype" id="6191232">error</span><br>
<span class="lineno">240</span><span class="op" id="6191238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6191241">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6191319">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="6191367">//</span><br>
<span class="lineno">245</span><span class="comment" id="6191370">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6191440">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6191478">func</span>&nbsp;<span class="ident" id="6191483">NewClientConn</span><span class="op" id="6191496">(</span><span class="ident" id="6191497">c</span>&nbsp;<span class="ident" id="6191499">net</span><span class="op" id="6191502">.</span><span class="ident" id="6191503">Conn</span><span class="op" id="6191507">,</span>&nbsp;<span class="ident" id="6191509">r</span>&nbsp;<span class="op" id="6191511">*</span><span class="ident" id="6191512">bufio</span><span class="op" id="6191517">.</span><span class="ident" id="6191518">Reader</span><span class="op" id="6191524">)</span>&nbsp;<span class="op" id="6191526">*</span><span class="ident" id="6191527">ClientConn</span>&nbsp;<span class="op" id="6191538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6191541">if</span>&nbsp;<span class="ident" id="6191544">r</span>&nbsp;<span class="op" id="6191546">==</span>&nbsp;<span class="builtintype" id="6191549">nil</span>&nbsp;<span class="op" id="6191553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191557">r</span>&nbsp;<span class="op" id="6191559">=</span>&nbsp;<span class="ident" id="6191561">bufio</span><span class="op" id="6191566">.</span><span class="ident" id="6191567">NewReader</span><span class="op" id="6191576">(</span><span class="ident" id="6191577">c</span><span class="op" id="6191578">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6191581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6191584">return</span>&nbsp;<span class="op" id="6191591">&amp;</span><span class="ident" id="6191592">ClientConn</span><span class="op" id="6191602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191606">c</span><span class="op" id="6191607">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191616">c</span><span class="op" id="6191617">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191621">r</span><span class="op" id="6191622">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191631">r</span><span class="op" id="6191632">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191636">pipereq</span><span class="op" id="6191643">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6191646">make</span><span class="op" id="6191650">(</span><span class="keyword" id="6191651">map</span><span class="op" id="6191654">[</span><span class="op" id="6191655">*</span><span class="ident" id="6191656">http</span><span class="op" id="6191660">.</span><span class="ident" id="6191661">Request</span><span class="op" id="6191668">]</span><span class="builtintype" id="6191669">uint</span><span class="op" id="6191673">)</span><span class="op" id="6191674">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6191678">writeReq</span><span class="op" id="6191686">:</span>&nbsp;<span class="op" id="6191688">(</span><span class="op" id="6191689">*</span><span class="ident" id="6191690">http</span><span class="op" id="6191694">.</span><span class="ident" id="6191695">Request</span><span class="op" id="6191702">)</span><span class="op" id="6191703">.</span><span class="ident" id="6191704">Write</span><span class="op" id="6191709">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6191712">}</span><br>
<span class="lineno"></span><span class="op" id="6191714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6191717">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="6191784">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="6191822">//</span><br>
<span class="lineno"></span><span class="comment" id="6191825">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6191886">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="6191932">func</span>&nbsp;<span class="ident" id="6191937">NewProxyClientConn</span><span class="op" id="6191955">(</span><span class="ident" id="6191956">c</span>&nbsp;<span class="ident" id="6191958">net</span><span class="op" id="6191961">.</span><span class="ident" id="6191962">Conn</span><span class="op" id="6191966">,</span>&nbsp;<span class="ident" id="6191968">r</span>&nbsp;<span class="op" id="6191970">*</span><span class="ident" id="6191971">bufio</span><span class="op" id="6191976">.</span><span class="ident" id="6191977">Reader</span><span class="op" id="6191983">)</span>&nbsp;<span class="op" id="6191985">*</span><span class="ident" id="6191986">ClientConn</span>&nbsp;<span class="op" id="6191997">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6192000">cc</span>&nbsp;<span class="op" id="6192003">:=</span>&nbsp;<span class="ident" id="6192006">NewClientConn</span><span class="op" id="6192019">(</span><span class="ident" id="6192020">c</span><span class="op" id="6192021">,</span>&nbsp;<span class="ident" id="6192023">r</span><span class="op" id="6192024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6192027">cc</span><span class="op" id="6192029">.</span><span class="ident" id="6192030">writeReq</span>&nbsp;<span class="op" id="6192039">=</span>&nbsp;<span class="op" id="6192041">(</span><span class="op" id="6192042">*</span><span class="ident" id="6192043">http</span><span class="op" id="6192047">.</span><span class="ident" id="6192048">Request</span><span class="op" id="6192055">)</span><span class="op" id="6192056">.</span><span class="ident" id="6192057">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6192069">return</span>&nbsp;<span class="ident" id="6192076">cc</span><br>
<span class="lineno"></span><span class="op" id="6192079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6192082">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6192162">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6192238">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="6192312">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6192390">func</span>&nbsp;<span class="op" id="6192395">(</span><span class="ident" id="6192396">cc</span>&nbsp;<span class="op" id="6192399">*</span><span class="ident" id="6192400">ClientConn</span><span class="op" id="6192410">)</span>&nbsp;<span class="ident" id="6192412">Hijack</span><span class="op" id="6192418">(</span><span class="op" id="6192419">)</span>&nbsp;<span class="op" id="6192421">(</span><span class="ident" id="6192422">c</span>&nbsp;<span class="ident" id="6192424">net</span><span class="op" id="6192427">.</span><span class="ident" id="6192428">Conn</span><span class="op" id="6192432">,</span>&nbsp;<span class="ident" id="6192434">r</span>&nbsp;<span class="op" id="6192436">*</span><span class="ident" id="6192437">bufio</span><span class="op" id="6192442">.</span><span class="ident" id="6192443">Reader</span><span class="op" id="6192449">)</span>&nbsp;<span class="op" id="6192451">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6192454">cc</span><span class="op" id="6192456">.</span><span class="ident" id="6192457">lk</span><span class="op" id="6192459">.</span><span class="ident" id="6192460">Lock</span><span class="op" id="6192464">(</span><span class="op" id="6192465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6192468">defer</span>&nbsp;<span class="ident" id="6192474">cc</span><span class="op" id="6192476">.</span><span class="ident" id="6192477">lk</span><span class="op" id="6192479">.</span><span class="ident" id="6192480">Unlock</span><span class="op" id="6192486">(</span><span class="op" id="6192487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6192490">c</span>&nbsp;<span class="op" id="6192492">=</span>&nbsp;<span class="ident" id="6192494">cc</span><span class="op" id="6192496">.</span><span class="ident" id="6192497">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6192500">r</span>&nbsp;<span class="op" id="6192502">=</span>&nbsp;<span class="ident" id="6192504">cc</span><span class="op" id="6192506">.</span><span class="ident" id="6192507">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6192510">cc</span><span class="op" id="6192512">.</span><span class="ident" id="6192513">c</span>&nbsp;<span class="op" id="6192515">=</span>&nbsp;<span class="builtintype" id="6192517">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6192522">cc</span><span class="op" id="6192524">.</span><span class="ident" id="6192525">r</span>&nbsp;<span class="op" id="6192527">=</span>&nbsp;<span class="builtintype" id="6192529">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6192534">return</span><br>
<span class="lineno"></span><span class="op" id="6192541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6192544">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="6192613">func</span>&nbsp;<span class="op" id="6192618">(</span><span class="ident" id="6192619">cc</span>&nbsp;<span class="op" id="6192622">*</span><span class="ident" id="6192623">ClientConn</span><span class="op" id="6192633">)</span>&nbsp;<span class="ident" id="6192635">Close</span><span class="op" id="6192640">(</span><span class="op" id="6192641">)</span>&nbsp;<span class="builtintype" id="6192643">error</span>&nbsp;<span class="op" id="6192649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6192652">c</span><span class="op" id="6192653">,</span>&nbsp;<span class="ident" id="6192655">_</span>&nbsp;<span class="op" id="6192657">:=</span>&nbsp;<span class="ident" id="6192660">cc</span><span class="op" id="6192662">.</span><span class="ident" id="6192663">Hijack</span><span class="op" id="6192669">(</span><span class="op" id="6192670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6192673">if</span>&nbsp;<span class="ident" id="6192676">c</span>&nbsp;<span class="op" id="6192678">!=</span>&nbsp;<span class="builtintype" id="6192681">nil</span>&nbsp;<span class="op" id="6192685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6192689">return</span>&nbsp;<span class="ident" id="6192696">c</span><span class="op" id="6192697">.</span><span class="ident" id="6192698">Close</span><span class="op" id="6192703">(</span><span class="op" id="6192704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6192707">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6192710">return</span>&nbsp;<span class="builtintype" id="6192717">nil</span><br>
<span class="lineno"></span><span class="op" id="6192721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6192724">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6192804">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="6192881">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="6192961">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6193036">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="6193113">func</span>&nbsp;<span class="op" id="6193118">(</span><span class="ident" id="6193119">cc</span>&nbsp;<span class="op" id="6193122">*</span><span class="ident" id="6193123">ClientConn</span><span class="op" id="6193133">)</span>&nbsp;<span class="ident" id="6193135">Write</span><span class="op" id="6193140">(</span><span class="ident" id="6193141">req</span>&nbsp;<span class="op" id="6193145">*</span><span class="ident" id="6193146">http</span><span class="op" id="6193150">.</span><span class="ident" id="6193151">Request</span><span class="op" id="6193158">)</span>&nbsp;<span class="op" id="6193160">(</span><span class="ident" id="6193161">err</span>&nbsp;<span class="builtintype" id="6193165">error</span><span class="op" id="6193170">)</span>&nbsp;<span class="op" id="6193172">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6193176">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193215">id</span>&nbsp;<span class="op" id="6193218">:=</span>&nbsp;<span class="ident" id="6193221">cc</span><span class="op" id="6193223">.</span><span class="ident" id="6193224">pipe</span><span class="op" id="6193228">.</span><span class="ident" id="6193229">Next</span><span class="op" id="6193233">(</span><span class="op" id="6193234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193237">cc</span><span class="op" id="6193239">.</span><span class="ident" id="6193240">pipe</span><span class="op" id="6193244">.</span><span class="ident" id="6193245">StartRequest</span><span class="op" id="6193257">(</span><span class="ident" id="6193258">id</span><span class="op" id="6193260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6193263">defer</span>&nbsp;<span class="keyword" id="6193269">func</span><span class="op" id="6193273">(</span><span class="op" id="6193274">)</span>&nbsp;<span class="op" id="6193276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193280">cc</span><span class="op" id="6193282">.</span><span class="ident" id="6193283">pipe</span><span class="op" id="6193287">.</span><span class="ident" id="6193288">EndRequest</span><span class="op" id="6193298">(</span><span class="ident" id="6193299">id</span><span class="op" id="6193301">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6193305">if</span>&nbsp;<span class="ident" id="6193308">err</span>&nbsp;<span class="op" id="6193312">!=</span>&nbsp;<span class="builtintype" id="6193315">nil</span>&nbsp;<span class="op" id="6193319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193324">cc</span><span class="op" id="6193326">.</span><span class="ident" id="6193327">pipe</span><span class="op" id="6193331">.</span><span class="ident" id="6193332">StartResponse</span><span class="op" id="6193345">(</span><span class="ident" id="6193346">id</span><span class="op" id="6193348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193353">cc</span><span class="op" id="6193355">.</span><span class="ident" id="6193356">pipe</span><span class="op" id="6193360">.</span><span class="ident" id="6193361">EndResponse</span><span class="op" id="6193372">(</span><span class="ident" id="6193373">id</span><span class="op" id="6193375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6193379">}</span>&nbsp;<span class="keyword" id="6193381">else</span>&nbsp;<span class="op" id="6193386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6193391">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193438">cc</span><span class="op" id="6193440">.</span><span class="ident" id="6193441">lk</span><span class="op" id="6193443">.</span><span class="ident" id="6193444">Lock</span><span class="op" id="6193448">(</span><span class="op" id="6193449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193454">cc</span><span class="op" id="6193456">.</span><span class="ident" id="6193457">pipereq</span><span class="op" id="6193464">[</span><span class="ident" id="6193465">req</span><span class="op" id="6193468">]</span>&nbsp;<span class="op" id="6193470">=</span>&nbsp;<span class="ident" id="6193472">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193478">cc</span><span class="op" id="6193480">.</span><span class="ident" id="6193481">lk</span><span class="op" id="6193483">.</span><span class="ident" id="6193484">Unlock</span><span class="op" id="6193490">(</span><span class="op" id="6193491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6193495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6193498">}</span><span class="op" id="6193499">(</span><span class="op" id="6193500">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193504">cc</span><span class="op" id="6193506">.</span><span class="ident" id="6193507">lk</span><span class="op" id="6193509">.</span><span class="ident" id="6193510">Lock</span><span class="op" id="6193514">(</span><span class="op" id="6193515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6193518">if</span>&nbsp;<span class="ident" id="6193521">cc</span><span class="op" id="6193523">.</span><span class="ident" id="6193524">re</span>&nbsp;<span class="op" id="6193527">!=</span>&nbsp;<span class="builtintype" id="6193530">nil</span>&nbsp;<span class="op" id="6193534">{</span>&nbsp;<span class="comment" id="6193536">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6193588">defer</span>&nbsp;<span class="ident" id="6193594">cc</span><span class="op" id="6193596">.</span><span class="ident" id="6193597">lk</span><span class="op" id="6193599">.</span><span class="ident" id="6193600">Unlock</span><span class="op" id="6193606">(</span><span class="op" id="6193607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6193611">return</span>&nbsp;<span class="ident" id="6193618">cc</span><span class="op" id="6193620">.</span><span class="ident" id="6193621">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6193625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6193628">if</span>&nbsp;<span class="ident" id="6193631">cc</span><span class="op" id="6193633">.</span><span class="ident" id="6193634">we</span>&nbsp;<span class="op" id="6193637">!=</span>&nbsp;<span class="builtintype" id="6193640">nil</span>&nbsp;<span class="op" id="6193644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6193648">defer</span>&nbsp;<span class="ident" id="6193654">cc</span><span class="op" id="6193656">.</span><span class="ident" id="6193657">lk</span><span class="op" id="6193659">.</span><span class="ident" id="6193660">Unlock</span><span class="op" id="6193666">(</span><span class="op" id="6193667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6193671">return</span>&nbsp;<span class="ident" id="6193678">cc</span><span class="op" id="6193680">.</span><span class="ident" id="6193681">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6193685">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6193688">if</span>&nbsp;<span class="ident" id="6193691">cc</span><span class="op" id="6193693">.</span><span class="ident" id="6193694">c</span>&nbsp;<span class="op" id="6193696">==</span>&nbsp;<span class="builtintype" id="6193699">nil</span>&nbsp;<span class="op" id="6193703">{</span>&nbsp;<span class="comment" id="6193705">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6193752">defer</span>&nbsp;<span class="ident" id="6193758">cc</span><span class="op" id="6193760">.</span><span class="ident" id="6193761">lk</span><span class="op" id="6193763">.</span><span class="ident" id="6193764">Unlock</span><span class="op" id="6193770">(</span><span class="op" id="6193771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6193775">return</span>&nbsp;<span class="ident" id="6193782">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6193793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193796">c</span>&nbsp;<span class="op" id="6193798">:=</span>&nbsp;<span class="ident" id="6193801">cc</span><span class="op" id="6193803">.</span><span class="ident" id="6193804">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6193807">if</span>&nbsp;<span class="ident" id="6193810">req</span><span class="op" id="6193813">.</span><span class="ident" id="6193814">Close</span>&nbsp;<span class="op" id="6193820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6193824">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6193885">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193926">cc</span><span class="op" id="6193928">.</span><span class="ident" id="6193929">we</span>&nbsp;<span class="op" id="6193932">=</span>&nbsp;<span class="ident" id="6193934">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6193949">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193952">cc</span><span class="op" id="6193954">.</span><span class="ident" id="6193955">lk</span><span class="op" id="6193957">.</span><span class="ident" id="6193958">Unlock</span><span class="op" id="6193964">(</span><span class="op" id="6193965">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193969">err</span>&nbsp;<span class="op" id="6193973">=</span>&nbsp;<span class="ident" id="6193975">cc</span><span class="op" id="6193977">.</span><span class="ident" id="6193978">writeReq</span><span class="op" id="6193986">(</span><span class="ident" id="6193987">req</span><span class="op" id="6193990">,</span>&nbsp;<span class="ident" id="6193992">c</span><span class="op" id="6193993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6193996">cc</span><span class="op" id="6193998">.</span><span class="ident" id="6193999">lk</span><span class="op" id="6194001">.</span><span class="ident" id="6194002">Lock</span><span class="op" id="6194006">(</span><span class="op" id="6194007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6194010">defer</span>&nbsp;<span class="ident" id="6194016">cc</span><span class="op" id="6194018">.</span><span class="ident" id="6194019">lk</span><span class="op" id="6194021">.</span><span class="ident" id="6194022">Unlock</span><span class="op" id="6194028">(</span><span class="op" id="6194029">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6194032">if</span>&nbsp;<span class="ident" id="6194035">err</span>&nbsp;<span class="op" id="6194039">!=</span>&nbsp;<span class="builtintype" id="6194042">nil</span>&nbsp;<span class="op" id="6194046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6194050">cc</span><span class="op" id="6194052">.</span><span class="ident" id="6194053">we</span>&nbsp;<span class="op" id="6194056">=</span>&nbsp;<span class="ident" id="6194058">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6194064">return</span>&nbsp;<span class="ident" id="6194071">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6194076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6194079">cc</span><span class="op" id="6194081">.</span><span class="ident" id="6194082">nwritten</span><span class="op" id="6194090">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6194095">return</span>&nbsp;<span class="builtintype" id="6194102">nil</span><br>
<span class="lineno"></span><span class="op" id="6194106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6194109">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="6194162">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6194204">func</span>&nbsp;<span class="op" id="6194209">(</span><span class="ident" id="6194210">cc</span>&nbsp;<span class="op" id="6194213">*</span><span class="ident" id="6194214">ClientConn</span><span class="op" id="6194224">)</span>&nbsp;<span class="ident" id="6194226">Pending</span><span class="op" id="6194233">(</span><span class="op" id="6194234">)</span>&nbsp;<span class="builtintype" id="6194236">int</span>&nbsp;<span class="op" id="6194240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6194243">cc</span><span class="op" id="6194245">.</span><span class="ident" id="6194246">lk</span><span class="op" id="6194248">.</span><span class="ident" id="6194249">Lock</span><span class="op" id="6194253">(</span><span class="op" id="6194254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6194257">defer</span>&nbsp;<span class="ident" id="6194263">cc</span><span class="op" id="6194265">.</span><span class="ident" id="6194266">lk</span><span class="op" id="6194268">.</span><span class="ident" id="6194269">Unlock</span><span class="op" id="6194275">(</span><span class="op" id="6194276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6194279">return</span>&nbsp;<span class="ident" id="6194286">cc</span><span class="op" id="6194288">.</span><span class="ident" id="6194289">nwritten</span>&nbsp;<span class="op" id="6194298">-</span>&nbsp;<span class="ident" id="6194300">cc</span><span class="op" id="6194302">.</span><span class="ident" id="6194303">nread</span><br>
<span class="lineno">355</span><span class="op" id="6194309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6194312">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6194385">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="6194457">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="6194529">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="6194584">func</span>&nbsp;<span class="op" id="6194589">(</span><span class="ident" id="6194590">cc</span>&nbsp;<span class="op" id="6194593">*</span><span class="ident" id="6194594">ClientConn</span><span class="op" id="6194604">)</span>&nbsp;<span class="ident" id="6194606">Read</span><span class="op" id="6194610">(</span><span class="ident" id="6194611">req</span>&nbsp;<span class="op" id="6194615">*</span><span class="ident" id="6194616">http</span><span class="op" id="6194620">.</span><span class="ident" id="6194621">Request</span><span class="op" id="6194628">)</span>&nbsp;<span class="op" id="6194630">(</span><span class="ident" id="6194631">resp</span>&nbsp;<span class="op" id="6194636">*</span><span class="ident" id="6194637">http</span><span class="op" id="6194641">.</span><span class="ident" id="6194642">Response</span><span class="op" id="6194650">,</span>&nbsp;<span class="ident" id="6194652">err</span>&nbsp;<span class="builtintype" id="6194656">error</span><span class="op" id="6194661">)</span>&nbsp;<span class="op" id="6194663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6194666">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6194725">cc</span><span class="op" id="6194727">.</span><span class="ident" id="6194728">lk</span><span class="op" id="6194730">.</span><span class="ident" id="6194731">Lock</span><span class="op" id="6194735">(</span><span class="op" id="6194736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6194739">id</span><span class="op" id="6194741">,</span>&nbsp;<span class="ident" id="6194743">ok</span>&nbsp;<span class="op" id="6194746">:=</span>&nbsp;<span class="ident" id="6194749">cc</span><span class="op" id="6194751">.</span><span class="ident" id="6194752">pipereq</span><span class="op" id="6194759">[</span><span class="ident" id="6194760">req</span><span class="op" id="6194763">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6194766">delete</span><span class="op" id="6194772">(</span><span class="ident" id="6194773">cc</span><span class="op" id="6194775">.</span><span class="ident" id="6194776">pipereq</span><span class="op" id="6194783">,</span>&nbsp;<span class="ident" id="6194785">req</span><span class="op" id="6194788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6194791">if</span>&nbsp;<span class="op" id="6194794">!</span><span class="ident" id="6194795">ok</span>&nbsp;<span class="op" id="6194798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6194802">cc</span><span class="op" id="6194804">.</span><span class="ident" id="6194805">lk</span><span class="op" id="6194807">.</span><span class="ident" id="6194808">Unlock</span><span class="op" id="6194814">(</span><span class="op" id="6194815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6194819">return</span>&nbsp;<span class="builtintype" id="6194826">nil</span><span class="op" id="6194829">,</span>&nbsp;<span class="ident" id="6194831">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6194844">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6194847">cc</span><span class="op" id="6194849">.</span><span class="ident" id="6194850">lk</span><span class="op" id="6194852">.</span><span class="ident" id="6194853">Unlock</span><span class="op" id="6194859">(</span><span class="op" id="6194860">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6194864">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6194890">cc</span><span class="op" id="6194892">.</span><span class="ident" id="6194893">pipe</span><span class="op" id="6194897">.</span><span class="ident" id="6194898">StartResponse</span><span class="op" id="6194911">(</span><span class="ident" id="6194912">id</span><span class="op" id="6194914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6194917">defer</span>&nbsp;<span class="ident" id="6194923">cc</span><span class="op" id="6194925">.</span><span class="ident" id="6194926">pipe</span><span class="op" id="6194930">.</span><span class="ident" id="6194931">EndResponse</span><span class="op" id="6194942">(</span><span class="ident" id="6194943">id</span><span class="op" id="6194945">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6194949">cc</span><span class="op" id="6194951">.</span><span class="ident" id="6194952">lk</span><span class="op" id="6194954">.</span><span class="ident" id="6194955">Lock</span><span class="op" id="6194959">(</span><span class="op" id="6194960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6194963">if</span>&nbsp;<span class="ident" id="6194966">cc</span><span class="op" id="6194968">.</span><span class="ident" id="6194969">re</span>&nbsp;<span class="op" id="6194972">!=</span>&nbsp;<span class="builtintype" id="6194975">nil</span>&nbsp;<span class="op" id="6194979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6194983">defer</span>&nbsp;<span class="ident" id="6194989">cc</span><span class="op" id="6194991">.</span><span class="ident" id="6194992">lk</span><span class="op" id="6194994">.</span><span class="ident" id="6194995">Unlock</span><span class="op" id="6195001">(</span><span class="op" id="6195002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195006">return</span>&nbsp;<span class="builtintype" id="6195013">nil</span><span class="op" id="6195016">,</span>&nbsp;<span class="ident" id="6195018">cc</span><span class="op" id="6195020">.</span><span class="ident" id="6195021">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6195025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195028">if</span>&nbsp;<span class="ident" id="6195031">cc</span><span class="op" id="6195033">.</span><span class="ident" id="6195034">r</span>&nbsp;<span class="op" id="6195036">==</span>&nbsp;<span class="builtintype" id="6195039">nil</span>&nbsp;<span class="op" id="6195043">{</span>&nbsp;<span class="comment" id="6195045">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195092">defer</span>&nbsp;<span class="ident" id="6195098">cc</span><span class="op" id="6195100">.</span><span class="ident" id="6195101">lk</span><span class="op" id="6195103">.</span><span class="ident" id="6195104">Unlock</span><span class="op" id="6195110">(</span><span class="op" id="6195111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195115">return</span>&nbsp;<span class="builtintype" id="6195122">nil</span><span class="op" id="6195125">,</span>&nbsp;<span class="ident" id="6195127">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6195138">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195141">r</span>&nbsp;<span class="op" id="6195143">:=</span>&nbsp;<span class="ident" id="6195146">cc</span><span class="op" id="6195148">.</span><span class="ident" id="6195149">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195152">lastbody</span>&nbsp;<span class="op" id="6195161">:=</span>&nbsp;<span class="ident" id="6195164">cc</span><span class="op" id="6195166">.</span><span class="ident" id="6195167">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195177">cc</span><span class="op" id="6195179">.</span><span class="ident" id="6195180">lastbody</span>&nbsp;<span class="op" id="6195189">=</span>&nbsp;<span class="builtintype" id="6195191">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195196">cc</span><span class="op" id="6195198">.</span><span class="ident" id="6195199">lk</span><span class="op" id="6195201">.</span><span class="ident" id="6195202">Unlock</span><span class="op" id="6195208">(</span><span class="op" id="6195209">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6195213">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195289">if</span>&nbsp;<span class="ident" id="6195292">lastbody</span>&nbsp;<span class="op" id="6195301">!=</span>&nbsp;<span class="builtintype" id="6195304">nil</span>&nbsp;<span class="op" id="6195308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6195312">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6195378">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6195436">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195451">err</span>&nbsp;<span class="op" id="6195455">=</span>&nbsp;<span class="ident" id="6195457">lastbody</span><span class="op" id="6195465">.</span><span class="ident" id="6195466">Close</span><span class="op" id="6195471">(</span><span class="op" id="6195472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195476">if</span>&nbsp;<span class="ident" id="6195479">err</span>&nbsp;<span class="op" id="6195483">!=</span>&nbsp;<span class="builtintype" id="6195486">nil</span>&nbsp;<span class="op" id="6195490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195495">cc</span><span class="op" id="6195497">.</span><span class="ident" id="6195498">lk</span><span class="op" id="6195500">.</span><span class="ident" id="6195501">Lock</span><span class="op" id="6195505">(</span><span class="op" id="6195506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195511">defer</span>&nbsp;<span class="ident" id="6195517">cc</span><span class="op" id="6195519">.</span><span class="ident" id="6195520">lk</span><span class="op" id="6195522">.</span><span class="ident" id="6195523">Unlock</span><span class="op" id="6195529">(</span><span class="op" id="6195530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195535">cc</span><span class="op" id="6195537">.</span><span class="ident" id="6195538">re</span>&nbsp;<span class="op" id="6195541">=</span>&nbsp;<span class="ident" id="6195543">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195550">return</span>&nbsp;<span class="builtintype" id="6195557">nil</span><span class="op" id="6195560">,</span>&nbsp;<span class="ident" id="6195562">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6195568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6195571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195575">resp</span><span class="op" id="6195579">,</span>&nbsp;<span class="ident" id="6195581">err</span>&nbsp;<span class="op" id="6195585">=</span>&nbsp;<span class="ident" id="6195587">http</span><span class="op" id="6195591">.</span><span class="ident" id="6195592">ReadResponse</span><span class="op" id="6195604">(</span><span class="ident" id="6195605">r</span><span class="op" id="6195606">,</span>&nbsp;<span class="ident" id="6195608">req</span><span class="op" id="6195611">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195614">cc</span><span class="op" id="6195616">.</span><span class="ident" id="6195617">lk</span><span class="op" id="6195619">.</span><span class="ident" id="6195620">Lock</span><span class="op" id="6195624">(</span><span class="op" id="6195625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195628">defer</span>&nbsp;<span class="ident" id="6195634">cc</span><span class="op" id="6195636">.</span><span class="ident" id="6195637">lk</span><span class="op" id="6195639">.</span><span class="ident" id="6195640">Unlock</span><span class="op" id="6195646">(</span><span class="op" id="6195647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195650">if</span>&nbsp;<span class="ident" id="6195653">err</span>&nbsp;<span class="op" id="6195657">!=</span>&nbsp;<span class="builtintype" id="6195660">nil</span>&nbsp;<span class="op" id="6195664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195668">cc</span><span class="op" id="6195670">.</span><span class="ident" id="6195671">re</span>&nbsp;<span class="op" id="6195674">=</span>&nbsp;<span class="ident" id="6195676">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195682">return</span>&nbsp;<span class="ident" id="6195689">resp</span><span class="op" id="6195693">,</span>&nbsp;<span class="ident" id="6195695">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6195700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195703">cc</span><span class="op" id="6195705">.</span><span class="ident" id="6195706">lastbody</span>&nbsp;<span class="op" id="6195715">=</span>&nbsp;<span class="ident" id="6195717">resp</span><span class="op" id="6195721">.</span><span class="ident" id="6195722">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195729">cc</span><span class="op" id="6195731">.</span><span class="ident" id="6195732">nread</span><span class="op" id="6195737">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195742">if</span>&nbsp;<span class="ident" id="6195745">resp</span><span class="op" id="6195749">.</span><span class="ident" id="6195750">Close</span>&nbsp;<span class="op" id="6195756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6195760">cc</span><span class="op" id="6195762">.</span><span class="ident" id="6195763">re</span>&nbsp;<span class="op" id="6195766">=</span>&nbsp;<span class="ident" id="6195768">ErrPersistEOF</span>&nbsp;<span class="comment" id="6195782">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195816">return</span>&nbsp;<span class="ident" id="6195823">resp</span><span class="op" id="6195827">,</span>&nbsp;<span class="ident" id="6195829">cc</span><span class="op" id="6195831">.</span><span class="ident" id="6195832">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6195836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6195839">return</span>&nbsp;<span class="ident" id="6195846">resp</span><span class="op" id="6195850">,</span>&nbsp;<span class="ident" id="6195852">err</span><br>
<span class="lineno">420</span><span class="op" id="6195856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6195859">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6195931">func</span>&nbsp;<span class="op" id="6195936">(</span><span class="ident" id="6195937">cc</span>&nbsp;<span class="op" id="6195940">*</span><span class="ident" id="6195941">ClientConn</span><span class="op" id="6195951">)</span>&nbsp;<span class="ident" id="6195953">Do</span><span class="op" id="6195955">(</span><span class="ident" id="6195956">req</span>&nbsp;<span class="op" id="6195960">*</span><span class="ident" id="6195961">http</span><span class="op" id="6195965">.</span><span class="ident" id="6195966">Request</span><span class="op" id="6195973">)</span>&nbsp;<span class="op" id="6195975">(</span><span class="ident" id="6195976">resp</span>&nbsp;<span class="op" id="6195981">*</span><span class="ident" id="6195982">http</span><span class="op" id="6195986">.</span><span class="ident" id="6195987">Response</span><span class="op" id="6195995">,</span>&nbsp;<span class="ident" id="6195997">err</span>&nbsp;<span class="builtintype" id="6196001">error</span><span class="op" id="6196006">)</span>&nbsp;<span class="op" id="6196008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6196011">err</span>&nbsp;<span class="op" id="6196015">=</span>&nbsp;<span class="ident" id="6196017">cc</span><span class="op" id="6196019">.</span><span class="ident" id="6196020">Write</span><span class="op" id="6196025">(</span><span class="ident" id="6196026">req</span><span class="op" id="6196029">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6196032">if</span>&nbsp;<span class="ident" id="6196035">err</span>&nbsp;<span class="op" id="6196039">!=</span>&nbsp;<span class="builtintype" id="6196042">nil</span>&nbsp;<span class="op" id="6196046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6196050">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6196058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6196061">return</span>&nbsp;<span class="ident" id="6196068">cc</span><span class="op" id="6196070">.</span><span class="ident" id="6196071">Read</span><span class="op" id="6196075">(</span><span class="ident" id="6196076">req</span><span class="op" id="6196079">)</span><br>
<span class="lineno"></span><span class="op" id="6196081">}</span>
</div>
</body>
</html>
