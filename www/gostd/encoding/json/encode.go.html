<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4760342">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4760398">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4760452">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4760503">//&nbsp;Package&nbsp;json&nbsp;implements&nbsp;encoding&nbsp;and&nbsp;decoding&nbsp;of&nbsp;JSON&nbsp;objects&nbsp;as&nbsp;defined&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4760582">//&nbsp;RFC&nbsp;4627.&nbsp;The&nbsp;mapping&nbsp;between&nbsp;JSON&nbsp;objects&nbsp;and&nbsp;Go&nbsp;values&nbsp;is&nbsp;described</span><br>
<span class="lineno"></span><span class="comment" id="4760655">//&nbsp;in&nbsp;the&nbsp;documentation&nbsp;for&nbsp;the&nbsp;Marshal&nbsp;and&nbsp;Unmarshal&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="4760720">//</span><br>
<span class="lineno"></span><span class="comment" id="4760723">//&nbsp;See&nbsp;&#34;JSON&nbsp;and&nbsp;Go&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno">10</span><span class="comment" id="4760781">//&nbsp;http://golang.org/doc/articles/json_and_go.html</span><br>
<span class="lineno"></span><span class="keyword" id="4760832">package</span>&nbsp;<span class="ident" id="4760840">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4760846">import</span>&nbsp;<span class="op" id="4760853">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760856">&#34;bytes&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760865">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760877">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760896">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760904">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760915">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760926">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760934">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760945">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760956">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760964">&#34;unicode&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760975">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="4760990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4760993">//&nbsp;Marshal&nbsp;returns&nbsp;the&nbsp;JSON&nbsp;encoding&nbsp;of&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4761036">//</span><br>
<span class="lineno">30</span><span class="comment" id="4761039">//&nbsp;Marshal&nbsp;traverses&nbsp;the&nbsp;value&nbsp;v&nbsp;recursively.</span><br>
<span class="lineno"></span><span class="comment" id="4761085">//&nbsp;If&nbsp;an&nbsp;encountered&nbsp;value&nbsp;implements&nbsp;the&nbsp;Marshaler&nbsp;interface</span><br>
<span class="lineno"></span><span class="comment" id="4761147">//&nbsp;and&nbsp;is&nbsp;not&nbsp;a&nbsp;nil&nbsp;pointer,&nbsp;Marshal&nbsp;calls&nbsp;its&nbsp;MarshalJSON&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="4761213">//&nbsp;to&nbsp;produce&nbsp;JSON.&nbsp;&nbsp;The&nbsp;nil&nbsp;pointer&nbsp;exception&nbsp;is&nbsp;not&nbsp;strictly&nbsp;necessary</span><br>
<span class="lineno"></span><span class="comment" id="4761286">//&nbsp;but&nbsp;mimics&nbsp;a&nbsp;similar,&nbsp;necessary&nbsp;exception&nbsp;in&nbsp;the&nbsp;behavior&nbsp;of</span><br>
<span class="lineno">35</span><span class="comment" id="4761350">//&nbsp;UnmarshalJSON.</span><br>
<span class="lineno"></span><span class="comment" id="4761368">//</span><br>
<span class="lineno"></span><span class="comment" id="4761371">//&nbsp;Otherwise,&nbsp;Marshal&nbsp;uses&nbsp;the&nbsp;following&nbsp;type-dependent&nbsp;default&nbsp;encodings:</span><br>
<span class="lineno"></span><span class="comment" id="4761446">//</span><br>
<span class="lineno"></span><span class="comment" id="4761449">//&nbsp;Boolean&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;booleans.</span><br>
<span class="lineno">40</span><span class="comment" id="4761492">//</span><br>
<span class="lineno"></span><span class="comment" id="4761495">//&nbsp;Floating&nbsp;point,&nbsp;integer,&nbsp;and&nbsp;Number&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;numbers.</span><br>
<span class="lineno"></span><span class="comment" id="4761565">//</span><br>
<span class="lineno"></span><span class="comment" id="4761568">//&nbsp;String&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;strings&nbsp;coerced&nbsp;to&nbsp;valid&nbsp;UTF-8,</span><br>
<span class="lineno"></span><span class="comment" id="4761632">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune.</span><br>
<span class="lineno">45</span><span class="comment" id="4761694">//&nbsp;The&nbsp;angle&nbsp;brackets&nbsp;&#34;&lt;&#34;&nbsp;and&nbsp;&#34;&gt;&#34;&nbsp;are&nbsp;escaped&nbsp;to&nbsp;&#34;\u003c&#34;&nbsp;and&nbsp;&#34;\u003e&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4761765">//&nbsp;to&nbsp;keep&nbsp;some&nbsp;browsers&nbsp;from&nbsp;misinterpreting&nbsp;JSON&nbsp;output&nbsp;as&nbsp;HTML.</span><br>
<span class="lineno"></span><span class="comment" id="4761832">//&nbsp;Ampersand&nbsp;&#34;&amp;&#34;&nbsp;is&nbsp;also&nbsp;escaped&nbsp;to&nbsp;&#34;\u0026&#34;&nbsp;for&nbsp;the&nbsp;same&nbsp;reason.</span><br>
<span class="lineno"></span><span class="comment" id="4761898">//</span><br>
<span class="lineno"></span><span class="comment" id="4761901">//&nbsp;Array&nbsp;and&nbsp;slice&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;arrays,&nbsp;except&nbsp;that</span><br>
<span class="lineno">50</span><span class="comment" id="4761962">//&nbsp;[]byte&nbsp;encodes&nbsp;as&nbsp;a&nbsp;base64-encoded&nbsp;string,&nbsp;and&nbsp;a&nbsp;nil&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="4762024">//&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="4762060">//</span><br>
<span class="lineno"></span><span class="comment" id="4762063">//&nbsp;Struct&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.&nbsp;Each&nbsp;exported&nbsp;struct&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="4762131">//&nbsp;becomes&nbsp;a&nbsp;member&nbsp;of&nbsp;the&nbsp;object&nbsp;unless</span><br>
<span class="lineno">55</span><span class="comment" id="4762172">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&#39;s&nbsp;tag&nbsp;is&nbsp;&#34;-&#34;,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4762206">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&nbsp;is&nbsp;empty&nbsp;and&nbsp;its&nbsp;tag&nbsp;specifies&nbsp;the&nbsp;&#34;omitempty&#34;&nbsp;option.</span><br>
<span class="lineno"></span><span class="comment" id="4762278">//&nbsp;The&nbsp;empty&nbsp;values&nbsp;are&nbsp;false,&nbsp;0,&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="4762316">//&nbsp;nil&nbsp;pointer&nbsp;or&nbsp;interface&nbsp;value,&nbsp;and&nbsp;any&nbsp;array,&nbsp;slice,&nbsp;map,&nbsp;or&nbsp;string&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4762391">//&nbsp;length&nbsp;zero.&nbsp;The&nbsp;object&#39;s&nbsp;default&nbsp;key&nbsp;string&nbsp;is&nbsp;the&nbsp;struct&nbsp;field&nbsp;name</span><br>
<span class="lineno">60</span><span class="comment" id="4762464">//&nbsp;but&nbsp;can&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value.&nbsp;The&nbsp;&#34;json&#34;&nbsp;key&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4762539">//&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value&nbsp;is&nbsp;the&nbsp;key&nbsp;name,&nbsp;followed&nbsp;by&nbsp;an&nbsp;optional&nbsp;comma</span><br>
<span class="lineno"></span><span class="comment" id="4762618">//&nbsp;and&nbsp;options.&nbsp;Examples:</span><br>
<span class="lineno"></span><span class="comment" id="4762644">//</span><br>
<span class="lineno"></span><span class="comment" id="4762647">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;is&nbsp;ignored&nbsp;by&nbsp;this&nbsp;package.</span><br>
<span class="lineno">65</span><span class="comment" id="4762689">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;-&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="4762715">//</span><br>
<span class="lineno"></span><span class="comment" id="4762718">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4762765">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="4762796">//</span><br>
<span class="lineno">70</span><span class="comment" id="4762799">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4762849">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;omitted&nbsp;from&nbsp;the&nbsp;object&nbsp;if&nbsp;its&nbsp;value&nbsp;is&nbsp;empty,</span><br>
<span class="lineno"></span><span class="comment" id="4762917">//&nbsp;&nbsp;&nbsp;//&nbsp;as&nbsp;defined&nbsp;above.</span><br>
<span class="lineno"></span><span class="comment" id="4762943">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="4762984">//</span><br>
<span class="lineno">75</span><span class="comment" id="4762987">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;Field&#34;&nbsp;(the&nbsp;default),&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="4763051">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;skipped&nbsp;if&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="4763090">//&nbsp;&nbsp;&nbsp;//&nbsp;Note&nbsp;the&nbsp;leading&nbsp;comma.</span><br>
<span class="lineno"></span><span class="comment" id="4763122">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="4763157">//</span><br>
<span class="lineno">80</span><span class="comment" id="4763160">//&nbsp;The&nbsp;&#34;string&#34;&nbsp;option&nbsp;signals&nbsp;that&nbsp;a&nbsp;field&nbsp;is&nbsp;stored&nbsp;as&nbsp;JSON&nbsp;inside&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4763231">//&nbsp;JSON-encoded&nbsp;string.&nbsp;It&nbsp;applies&nbsp;only&nbsp;to&nbsp;fields&nbsp;of&nbsp;string,&nbsp;floating&nbsp;point,</span><br>
<span class="lineno"></span><span class="comment" id="4763308">//&nbsp;or&nbsp;integer&nbsp;types.&nbsp;This&nbsp;extra&nbsp;level&nbsp;of&nbsp;encoding&nbsp;is&nbsp;sometimes&nbsp;used&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="4763381">//&nbsp;communicating&nbsp;with&nbsp;JavaScript&nbsp;programs:</span><br>
<span class="lineno"></span><span class="comment" id="4763424">//</span><br>
<span class="lineno">85</span><span class="comment" id="4763427">//&nbsp;&nbsp;&nbsp;&nbsp;Int64String&nbsp;int64&nbsp;`json:&#34;,string&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="4763468">//</span><br>
<span class="lineno"></span><span class="comment" id="4763471">//&nbsp;The&nbsp;key&nbsp;name&nbsp;will&nbsp;be&nbsp;used&nbsp;if&nbsp;it&#39;s&nbsp;a&nbsp;non-empty&nbsp;string&nbsp;consisting&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4763541">//&nbsp;only&nbsp;Unicode&nbsp;letters,&nbsp;digits,&nbsp;dollar&nbsp;signs,&nbsp;percent&nbsp;signs,&nbsp;hyphens,</span><br>
<span class="lineno"></span><span class="comment" id="4763612">//&nbsp;underscores&nbsp;and&nbsp;slashes.</span><br>
<span class="lineno">90</span><span class="comment" id="4763640">//</span><br>
<span class="lineno"></span><span class="comment" id="4763643">//&nbsp;Anonymous&nbsp;struct&nbsp;fields&nbsp;are&nbsp;usually&nbsp;marshaled&nbsp;as&nbsp;if&nbsp;their&nbsp;inner&nbsp;exported&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="4763726">//&nbsp;were&nbsp;fields&nbsp;in&nbsp;the&nbsp;outer&nbsp;struct,&nbsp;subject&nbsp;to&nbsp;the&nbsp;usual&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;amended</span><br>
<span class="lineno"></span><span class="comment" id="4763811">//&nbsp;as&nbsp;described&nbsp;in&nbsp;the&nbsp;next&nbsp;paragraph.</span><br>
<span class="lineno"></span><span class="comment" id="4763850">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;with&nbsp;a&nbsp;name&nbsp;given&nbsp;in&nbsp;its&nbsp;JSON&nbsp;tag&nbsp;is&nbsp;treated&nbsp;as</span><br>
<span class="lineno">95</span><span class="comment" id="4763927">//&nbsp;having&nbsp;that&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="4763977">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;of&nbsp;interface&nbsp;type&nbsp;is&nbsp;treated&nbsp;the&nbsp;same&nbsp;as&nbsp;having</span><br>
<span class="lineno"></span><span class="comment" id="4764054">//&nbsp;that&nbsp;type&nbsp;as&nbsp;its&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="4764109">//</span><br>
<span class="lineno"></span><span class="comment" id="4764112">//&nbsp;The&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;for&nbsp;struct&nbsp;fields&nbsp;are&nbsp;amended&nbsp;for&nbsp;JSON&nbsp;when</span><br>
<span class="lineno">100</span><span class="comment" id="4764183">//&nbsp;deciding&nbsp;which&nbsp;field&nbsp;to&nbsp;marshal&nbsp;or&nbsp;unmarshal.&nbsp;If&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="4764245">//&nbsp;multiple&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level,&nbsp;and&nbsp;that&nbsp;level&nbsp;is&nbsp;the&nbsp;least</span><br>
<span class="lineno"></span><span class="comment" id="4764311">//&nbsp;nested&nbsp;(and&nbsp;would&nbsp;therefore&nbsp;be&nbsp;the&nbsp;nesting&nbsp;level&nbsp;selected&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4764379">//&nbsp;usual&nbsp;Go&nbsp;rules),&nbsp;the&nbsp;following&nbsp;extra&nbsp;rules&nbsp;apply:</span><br>
<span class="lineno"></span><span class="comment" id="4764432">//</span><br>
<span class="lineno">105</span><span class="comment" id="4764435">//&nbsp;1)&nbsp;Of&nbsp;those&nbsp;fields,&nbsp;if&nbsp;any&nbsp;are&nbsp;JSON-tagged,&nbsp;only&nbsp;tagged&nbsp;fields&nbsp;are&nbsp;considered,</span><br>
<span class="lineno"></span><span class="comment" id="4764517">//&nbsp;even&nbsp;if&nbsp;there&nbsp;are&nbsp;multiple&nbsp;untagged&nbsp;fields&nbsp;that&nbsp;would&nbsp;otherwise&nbsp;conflict.</span><br>
<span class="lineno"></span><span class="comment" id="4764594">//&nbsp;2)&nbsp;If&nbsp;there&nbsp;is&nbsp;exactly&nbsp;one&nbsp;field&nbsp;(tagged&nbsp;or&nbsp;not&nbsp;according&nbsp;to&nbsp;the&nbsp;first&nbsp;rule),&nbsp;that&nbsp;is&nbsp;selected.</span><br>
<span class="lineno"></span><span class="comment" id="4764693">//&nbsp;3)&nbsp;Otherwise&nbsp;there&nbsp;are&nbsp;multiple&nbsp;fields,&nbsp;and&nbsp;all&nbsp;are&nbsp;ignored;&nbsp;no&nbsp;error&nbsp;occurs.</span><br>
<span class="lineno"></span><span class="comment" id="4764774">//</span><br>
<span class="lineno">110</span><span class="comment" id="4764777">//&nbsp;Handling&nbsp;of&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;is&nbsp;new&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span><span class="comment" id="4764834">//&nbsp;Prior&nbsp;to&nbsp;Go&nbsp;1.1,&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;were&nbsp;ignored.&nbsp;To&nbsp;force&nbsp;ignoring&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4764913">//&nbsp;an&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;in&nbsp;both&nbsp;current&nbsp;and&nbsp;earlier&nbsp;versions,&nbsp;give&nbsp;the&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="4764995">//&nbsp;a&nbsp;JSON&nbsp;tag&nbsp;of&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4765017">//</span><br>
<span class="lineno">115</span><span class="comment" id="4765020">//&nbsp;Map&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.</span><br>
<span class="lineno"></span><span class="comment" id="4765058">//&nbsp;The&nbsp;map&#39;s&nbsp;key&nbsp;type&nbsp;must&nbsp;be&nbsp;string;&nbsp;the&nbsp;object&nbsp;keys&nbsp;are&nbsp;used&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="4765130">//&nbsp;as&nbsp;map&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="4765146">//</span><br>
<span class="lineno"></span><span class="comment" id="4765149">//&nbsp;Pointer&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;pointed&nbsp;to.</span><br>
<span class="lineno">120</span><span class="comment" id="4765199">//&nbsp;A&nbsp;nil&nbsp;pointer&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="4765249">//</span><br>
<span class="lineno"></span><span class="comment" id="4765252">//&nbsp;Interface&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;contained&nbsp;in&nbsp;the&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="4765320">//&nbsp;A&nbsp;nil&nbsp;interface&nbsp;value&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="4765378">//</span><br>
<span class="lineno">125</span><span class="comment" id="4765381">//&nbsp;Channel,&nbsp;complex,&nbsp;and&nbsp;function&nbsp;values&nbsp;cannot&nbsp;be&nbsp;encoded&nbsp;in&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="comment" id="4765449">//&nbsp;Attempting&nbsp;to&nbsp;encode&nbsp;such&nbsp;a&nbsp;value&nbsp;causes&nbsp;Marshal&nbsp;to&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="4765511">//&nbsp;an&nbsp;UnsupportedTypeError.</span><br>
<span class="lineno"></span><span class="comment" id="4765539">//</span><br>
<span class="lineno"></span><span class="comment" id="4765542">//&nbsp;JSON&nbsp;cannot&nbsp;represent&nbsp;cyclic&nbsp;data&nbsp;structures&nbsp;and&nbsp;Marshal&nbsp;does&nbsp;not</span><br>
<span class="lineno">130</span><span class="comment" id="4765611">//&nbsp;handle&nbsp;them.&nbsp;&nbsp;Passing&nbsp;cyclic&nbsp;structures&nbsp;to&nbsp;Marshal&nbsp;will&nbsp;result&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4765680">//&nbsp;an&nbsp;infinite&nbsp;recursion.</span><br>
<span class="lineno"></span><span class="comment" id="4765706">//</span><br>
<span class="lineno"></span><span class="keyword" id="4765709">func</span>&nbsp;<span class="ident" id="4765714">Marshal</span><span class="op" id="4765721">(</span><span class="ident" id="4765722">v</span>&nbsp;<span class="keyword" id="4765724">interface</span><span class="op" id="4765733">{</span><span class="op" id="4765734">}</span><span class="op" id="4765735">)</span>&nbsp;<span class="op" id="4765737">(</span><span class="op" id="4765738">[</span><span class="op" id="4765739">]</span><span class="builtintype" id="4765740">byte</span><span class="op" id="4765744">,</span>&nbsp;<span class="builtintype" id="4765746">error</span><span class="op" id="4765751">)</span>&nbsp;<span class="op" id="4765753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765756">e</span>&nbsp;<span class="op" id="4765758">:=</span>&nbsp;<span class="op" id="4765761">&amp;</span><span class="ident" id="4765762">encodeState</span><span class="op" id="4765773">{</span><span class="op" id="4765774">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765777">err</span>&nbsp;<span class="op" id="4765781">:=</span>&nbsp;<span class="ident" id="4765784">e</span><span class="op" id="4765785">.</span><span class="ident" id="4765786">marshal</span><span class="op" id="4765793">(</span><span class="ident" id="4765794">v</span><span class="op" id="4765795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765798">if</span>&nbsp;<span class="ident" id="4765801">err</span>&nbsp;<span class="op" id="4765805">!=</span>&nbsp;<span class="ident" id="4765808">nil</span>&nbsp;<span class="op" id="4765812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765816">return</span>&nbsp;<span class="ident" id="4765823">nil</span><span class="op" id="4765826">,</span>&nbsp;<span class="ident" id="4765828">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4765833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765836">return</span>&nbsp;<span class="ident" id="4765843">e</span><span class="op" id="4765844">.</span><span class="ident" id="4765845">Bytes</span><span class="op" id="4765850">(</span><span class="op" id="4765851">)</span><span class="op" id="4765852">,</span>&nbsp;<span class="ident" id="4765854">nil</span><br>
<span class="lineno">140</span><span class="op" id="4765858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4765861">//&nbsp;MarshalIndent&nbsp;is&nbsp;like&nbsp;Marshal&nbsp;but&nbsp;applies&nbsp;Indent&nbsp;to&nbsp;format&nbsp;the&nbsp;output.</span><br>
<span class="lineno"></span><span class="keyword" id="4765935">func</span>&nbsp;<span class="ident" id="4765940">MarshalIndent</span><span class="op" id="4765953">(</span><span class="ident" id="4765954">v</span>&nbsp;<span class="keyword" id="4765956">interface</span><span class="op" id="4765965">{</span><span class="op" id="4765966">}</span><span class="op" id="4765967">,</span>&nbsp;<span class="ident" id="4765969">prefix</span><span class="op" id="4765975">,</span>&nbsp;<span class="ident" id="4765977">indent</span>&nbsp;<span class="builtintype" id="4765984">string</span><span class="op" id="4765990">)</span>&nbsp;<span class="op" id="4765992">(</span><span class="op" id="4765993">[</span><span class="op" id="4765994">]</span><span class="builtintype" id="4765995">byte</span><span class="op" id="4765999">,</span>&nbsp;<span class="builtintype" id="4766001">error</span><span class="op" id="4766006">)</span>&nbsp;<span class="op" id="4766008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766011">b</span><span class="op" id="4766012">,</span>&nbsp;<span class="ident" id="4766014">err</span>&nbsp;<span class="op" id="4766018">:=</span>&nbsp;<span class="ident" id="4766021">Marshal</span><span class="op" id="4766028">(</span><span class="ident" id="4766029">v</span><span class="op" id="4766030">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766033">if</span>&nbsp;<span class="ident" id="4766036">err</span>&nbsp;<span class="op" id="4766040">!=</span>&nbsp;<span class="ident" id="4766043">nil</span>&nbsp;<span class="op" id="4766047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766051">return</span>&nbsp;<span class="ident" id="4766058">nil</span><span class="op" id="4766061">,</span>&nbsp;<span class="ident" id="4766063">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4766068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766071">var</span>&nbsp;<span class="ident" id="4766075">buf</span>&nbsp;<span class="ident" id="4766079">bytes</span><span class="op" id="4766084">.</span><span class="ident" id="4766085">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766093">err</span>&nbsp;<span class="op" id="4766097">=</span>&nbsp;<span class="ident" id="4766099">Indent</span><span class="op" id="4766105">(</span><span class="op" id="4766106">&amp;</span><span class="ident" id="4766107">buf</span><span class="op" id="4766110">,</span>&nbsp;<span class="ident" id="4766112">b</span><span class="op" id="4766113">,</span>&nbsp;<span class="ident" id="4766115">prefix</span><span class="op" id="4766121">,</span>&nbsp;<span class="ident" id="4766123">indent</span><span class="op" id="4766129">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766132">if</span>&nbsp;<span class="ident" id="4766135">err</span>&nbsp;<span class="op" id="4766139">!=</span>&nbsp;<span class="ident" id="4766142">nil</span>&nbsp;<span class="op" id="4766146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766150">return</span>&nbsp;<span class="ident" id="4766157">nil</span><span class="op" id="4766160">,</span>&nbsp;<span class="ident" id="4766162">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4766167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766170">return</span>&nbsp;<span class="ident" id="4766177">buf</span><span class="op" id="4766180">.</span><span class="ident" id="4766181">Bytes</span><span class="op" id="4766186">(</span><span class="op" id="4766187">)</span><span class="op" id="4766188">,</span>&nbsp;<span class="ident" id="4766190">nil</span><br>
<span class="lineno"></span><span class="op" id="4766194">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4766197">//&nbsp;HTMLEscape&nbsp;appends&nbsp;to&nbsp;dst&nbsp;the&nbsp;JSON-encoded&nbsp;src&nbsp;with&nbsp;&lt;,&nbsp;&gt;,&nbsp;&amp;,&nbsp;U+2028&nbsp;and&nbsp;U+2029</span><br>
<span class="lineno"></span><span class="comment" id="4766279">//&nbsp;characters&nbsp;inside&nbsp;string&nbsp;literals&nbsp;changed&nbsp;to&nbsp;\u003c,&nbsp;\u003e,&nbsp;\u0026,&nbsp;\u2028,&nbsp;\u2029</span><br>
<span class="lineno"></span><span class="comment" id="4766366">//&nbsp;so&nbsp;that&nbsp;the&nbsp;JSON&nbsp;will&nbsp;be&nbsp;safe&nbsp;to&nbsp;embed&nbsp;inside&nbsp;HTML&nbsp;&lt;script&gt;&nbsp;tags.</span><br>
<span class="lineno"></span><span class="comment" id="4766435">//&nbsp;For&nbsp;historical&nbsp;reasons,&nbsp;web&nbsp;browsers&nbsp;don&#39;t&nbsp;honor&nbsp;standard&nbsp;HTML</span><br>
<span class="lineno">160</span><span class="comment" id="4766501">//&nbsp;escaping&nbsp;within&nbsp;&lt;script&gt;&nbsp;tags,&nbsp;so&nbsp;an&nbsp;alternative&nbsp;JSON&nbsp;encoding&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="4766572">//&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4766584">func</span>&nbsp;<span class="ident" id="4766589">HTMLEscape</span><span class="op" id="4766599">(</span><span class="ident" id="4766600">dst</span>&nbsp;<span class="op" id="4766604">*</span><span class="ident" id="4766605">bytes</span><span class="op" id="4766610">.</span><span class="ident" id="4766611">Buffer</span><span class="op" id="4766617">,</span>&nbsp;<span class="ident" id="4766619">src</span>&nbsp;<span class="op" id="4766623">[</span><span class="op" id="4766624">]</span><span class="builtintype" id="4766625">byte</span><span class="op" id="4766629">)</span>&nbsp;<span class="op" id="4766631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766634">//&nbsp;The&nbsp;characters&nbsp;can&nbsp;only&nbsp;appear&nbsp;in&nbsp;string&nbsp;literals,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766689">//&nbsp;so&nbsp;just&nbsp;scan&nbsp;the&nbsp;string&nbsp;one&nbsp;byte&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766737">start</span>&nbsp;<span class="op" id="4766743">:=</span>&nbsp;<span class="num" id="4766746">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766749">for</span>&nbsp;<span class="ident" id="4766753">i</span><span class="op" id="4766754">,</span>&nbsp;<span class="ident" id="4766756">c</span>&nbsp;<span class="op" id="4766758">:=</span>&nbsp;<span class="keyword" id="4766761">range</span>&nbsp;<span class="ident" id="4766767">src</span>&nbsp;<span class="op" id="4766771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766775">if</span>&nbsp;<span class="ident" id="4766778">c</span>&nbsp;<span class="op" id="4766780">==</span>&nbsp;<span class="string" id="4766783">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="4766787">||</span>&nbsp;<span class="ident" id="4766790">c</span>&nbsp;<span class="op" id="4766792">==</span>&nbsp;<span class="string" id="4766795">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="4766799">||</span>&nbsp;<span class="ident" id="4766802">c</span>&nbsp;<span class="op" id="4766804">==</span>&nbsp;<span class="string" id="4766807">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="4766811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766816">if</span>&nbsp;<span class="ident" id="4766819">start</span>&nbsp;<span class="op" id="4766825">&lt;</span>&nbsp;<span class="ident" id="4766827">i</span>&nbsp;<span class="op" id="4766829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766835">dst</span><span class="op" id="4766838">.</span><span class="ident" id="4766839">Write</span><span class="op" id="4766844">(</span><span class="ident" id="4766845">src</span><span class="op" id="4766848">[</span><span class="ident" id="4766849">start</span><span class="op" id="4766854">:</span><span class="ident" id="4766855">i</span><span class="op" id="4766856">]</span><span class="op" id="4766857">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4766862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766867">dst</span><span class="op" id="4766870">.</span><span class="ident" id="4766871">WriteString</span><span class="op" id="4766882">(</span><span class="string" id="4766883">`\u00`</span><span class="op" id="4766889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766894">dst</span><span class="op" id="4766897">.</span><span class="ident" id="4766898">WriteByte</span><span class="op" id="4766907">(</span><span class="ident" id="4766908">hex</span><span class="op" id="4766911">[</span><span class="ident" id="4766912">c</span><span class="op" id="4766913">&gt;&gt;</span><span class="num" id="4766915">4</span><span class="op" id="4766916">]</span><span class="op" id="4766917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766922">dst</span><span class="op" id="4766925">.</span><span class="ident" id="4766926">WriteByte</span><span class="op" id="4766935">(</span><span class="ident" id="4766936">hex</span><span class="op" id="4766939">[</span><span class="ident" id="4766940">c</span><span class="op" id="4766941">&amp;</span><span class="num" id="4766942">0xF</span><span class="op" id="4766945">]</span><span class="op" id="4766946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766951">start</span>&nbsp;<span class="op" id="4766957">=</span>&nbsp;<span class="ident" id="4766959">i</span>&nbsp;<span class="op" id="4766961">+</span>&nbsp;<span class="num" id="4766963">1</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4766967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766971">//&nbsp;Convert&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;(E2&nbsp;80&nbsp;A8&nbsp;and&nbsp;E2&nbsp;80&nbsp;A9).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767027">if</span>&nbsp;<span class="ident" id="4767030">c</span>&nbsp;<span class="op" id="4767032">==</span>&nbsp;<span class="num" id="4767035">0xE2</span>&nbsp;<span class="op" id="4767040">&amp;&amp;</span>&nbsp;<span class="ident" id="4767043">i</span><span class="op" id="4767044">+</span><span class="num" id="4767045">2</span>&nbsp;<span class="op" id="4767047">&lt;</span>&nbsp;<span class="builtinfunc" id="4767049">len</span><span class="op" id="4767052">(</span><span class="ident" id="4767053">src</span><span class="op" id="4767056">)</span>&nbsp;<span class="op" id="4767058">&amp;&amp;</span>&nbsp;<span class="ident" id="4767061">src</span><span class="op" id="4767064">[</span><span class="ident" id="4767065">i</span><span class="op" id="4767066">+</span><span class="num" id="4767067">1</span><span class="op" id="4767068">]</span>&nbsp;<span class="op" id="4767070">==</span>&nbsp;<span class="num" id="4767073">0x80</span>&nbsp;<span class="op" id="4767078">&amp;&amp;</span>&nbsp;<span class="ident" id="4767081">src</span><span class="op" id="4767084">[</span><span class="ident" id="4767085">i</span><span class="op" id="4767086">+</span><span class="num" id="4767087">2</span><span class="op" id="4767088">]</span><span class="op" id="4767089">&amp;^</span><span class="num" id="4767091">1</span>&nbsp;<span class="op" id="4767093">==</span>&nbsp;<span class="num" id="4767096">0xA8</span>&nbsp;<span class="op" id="4767101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767106">if</span>&nbsp;<span class="ident" id="4767109">start</span>&nbsp;<span class="op" id="4767115">&lt;</span>&nbsp;<span class="ident" id="4767117">i</span>&nbsp;<span class="op" id="4767119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767125">dst</span><span class="op" id="4767128">.</span><span class="ident" id="4767129">Write</span><span class="op" id="4767134">(</span><span class="ident" id="4767135">src</span><span class="op" id="4767138">[</span><span class="ident" id="4767139">start</span><span class="op" id="4767144">:</span><span class="ident" id="4767145">i</span><span class="op" id="4767146">]</span><span class="op" id="4767147">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767157">dst</span><span class="op" id="4767160">.</span><span class="ident" id="4767161">WriteString</span><span class="op" id="4767172">(</span><span class="string" id="4767173">`\u202`</span><span class="op" id="4767180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767185">dst</span><span class="op" id="4767188">.</span><span class="ident" id="4767189">WriteByte</span><span class="op" id="4767198">(</span><span class="ident" id="4767199">hex</span><span class="op" id="4767202">[</span><span class="ident" id="4767203">src</span><span class="op" id="4767206">[</span><span class="ident" id="4767207">i</span><span class="op" id="4767208">+</span><span class="num" id="4767209">2</span><span class="op" id="4767210">]</span><span class="op" id="4767211">&amp;</span><span class="num" id="4767212">0xF</span><span class="op" id="4767215">]</span><span class="op" id="4767216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767221">start</span>&nbsp;<span class="op" id="4767227">=</span>&nbsp;<span class="ident" id="4767229">i</span>&nbsp;<span class="op" id="4767231">+</span>&nbsp;<span class="num" id="4767233">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767237">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767243">if</span>&nbsp;<span class="ident" id="4767246">start</span>&nbsp;<span class="op" id="4767252">&lt;</span>&nbsp;<span class="builtinfunc" id="4767254">len</span><span class="op" id="4767257">(</span><span class="ident" id="4767258">src</span><span class="op" id="4767261">)</span>&nbsp;<span class="op" id="4767263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767267">dst</span><span class="op" id="4767270">.</span><span class="ident" id="4767271">Write</span><span class="op" id="4767276">(</span><span class="ident" id="4767277">src</span><span class="op" id="4767280">[</span><span class="ident" id="4767281">start</span><span class="op" id="4767286">:</span><span class="op" id="4767287">]</span><span class="op" id="4767288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767291">}</span><br>
<span class="lineno"></span><span class="op" id="4767293">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4767296">//&nbsp;Marshaler&nbsp;is&nbsp;the&nbsp;interface&nbsp;implemented&nbsp;by&nbsp;objects&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4767354">//&nbsp;can&nbsp;marshal&nbsp;themselves&nbsp;into&nbsp;valid&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="4767397">type</span>&nbsp;<span class="ident" id="4767402">Marshaler</span>&nbsp;<span class="keyword" id="4767412">interface</span>&nbsp;<span class="op" id="4767422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767425">MarshalJSON</span><span class="op" id="4767436">(</span><span class="op" id="4767437">)</span>&nbsp;<span class="op" id="4767439">(</span><span class="op" id="4767440">[</span><span class="op" id="4767441">]</span><span class="builtintype" id="4767442">byte</span><span class="op" id="4767446">,</span>&nbsp;<span class="builtintype" id="4767448">error</span><span class="op" id="4767453">)</span><br>
<span class="lineno">195</span><span class="op" id="4767455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4767458">//&nbsp;An&nbsp;UnsupportedTypeError&nbsp;is&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when&nbsp;attempting</span><br>
<span class="lineno"></span><span class="comment" id="4767524">//&nbsp;to&nbsp;encode&nbsp;an&nbsp;unsupported&nbsp;value&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4767564">type</span>&nbsp;<span class="ident" id="4767569">UnsupportedTypeError</span>&nbsp;<span class="keyword" id="4767590">struct</span>&nbsp;<span class="op" id="4767597">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767600">Type</span>&nbsp;<span class="ident" id="4767605">reflect</span><span class="op" id="4767612">.</span><span class="ident" id="4767613">Type</span><br>
<span class="lineno"></span><span class="op" id="4767618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4767621">func</span>&nbsp;<span class="op" id="4767626">(</span><span class="ident" id="4767627">e</span>&nbsp;<span class="op" id="4767629">*</span><span class="ident" id="4767630">UnsupportedTypeError</span><span class="op" id="4767650">)</span>&nbsp;<span class="ident" id="4767652">Error</span><span class="op" id="4767657">(</span><span class="op" id="4767658">)</span>&nbsp;<span class="builtintype" id="4767660">string</span>&nbsp;<span class="op" id="4767667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767670">return</span>&nbsp;<span class="string" id="4767677">&#34;json:&nbsp;unsupported&nbsp;type:&nbsp;&#34;</span>&nbsp;<span class="op" id="4767704">+</span>&nbsp;<span class="ident" id="4767706">e</span><span class="op" id="4767707">.</span><span class="ident" id="4767708">Type</span><span class="op" id="4767712">.</span><span class="ident" id="4767713">String</span><span class="op" id="4767719">(</span><span class="op" id="4767720">)</span><br>
<span class="lineno">205</span><span class="op" id="4767722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4767725">type</span>&nbsp;<span class="ident" id="4767730">UnsupportedValueError</span>&nbsp;<span class="keyword" id="4767752">struct</span>&nbsp;<span class="op" id="4767759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767762">Value</span>&nbsp;<span class="ident" id="4767768">reflect</span><span class="op" id="4767775">.</span><span class="ident" id="4767776">Value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767783">Str</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4767789">string</span><br>
<span class="lineno">210</span><span class="op" id="4767796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4767799">func</span>&nbsp;<span class="op" id="4767804">(</span><span class="ident" id="4767805">e</span>&nbsp;<span class="op" id="4767807">*</span><span class="ident" id="4767808">UnsupportedValueError</span><span class="op" id="4767829">)</span>&nbsp;<span class="ident" id="4767831">Error</span><span class="op" id="4767836">(</span><span class="op" id="4767837">)</span>&nbsp;<span class="builtintype" id="4767839">string</span>&nbsp;<span class="op" id="4767846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767849">return</span>&nbsp;<span class="string" id="4767856">&#34;json:&nbsp;unsupported&nbsp;value:&nbsp;&#34;</span>&nbsp;<span class="op" id="4767884">+</span>&nbsp;<span class="ident" id="4767886">e</span><span class="op" id="4767887">.</span><span class="ident" id="4767888">Str</span><br>
<span class="lineno"></span><span class="op" id="4767892">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="4767895">//&nbsp;Before&nbsp;Go&nbsp;1.2,&nbsp;an&nbsp;InvalidUTF8Error&nbsp;was&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="4767962">//&nbsp;attempting&nbsp;to&nbsp;encode&nbsp;a&nbsp;string&nbsp;value&nbsp;with&nbsp;invalid&nbsp;UTF-8&nbsp;sequences.</span><br>
<span class="lineno"></span><span class="comment" id="4768031">//&nbsp;As&nbsp;of&nbsp;Go&nbsp;1.2,&nbsp;Marshal&nbsp;instead&nbsp;coerces&nbsp;the&nbsp;string&nbsp;to&nbsp;valid&nbsp;UTF-8&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4768101">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune&nbsp;U+FFFD.</span><br>
<span class="lineno">220</span><span class="comment" id="4768170">//&nbsp;This&nbsp;error&nbsp;is&nbsp;no&nbsp;longer&nbsp;generated&nbsp;but&nbsp;is&nbsp;kept&nbsp;for&nbsp;backwards&nbsp;compatibility</span><br>
<span class="lineno"></span><span class="comment" id="4768247">//&nbsp;with&nbsp;programs&nbsp;that&nbsp;might&nbsp;mention&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="4768287">type</span>&nbsp;<span class="ident" id="4768292">InvalidUTF8Error</span>&nbsp;<span class="keyword" id="4768309">struct</span>&nbsp;<span class="op" id="4768316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4768319">S</span>&nbsp;<span class="builtintype" id="4768321">string</span>&nbsp;<span class="comment" id="4768328">//&nbsp;the&nbsp;whole&nbsp;string&nbsp;value&nbsp;that&nbsp;caused&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="op" id="4768376">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="4768379">func</span>&nbsp;<span class="op" id="4768384">(</span><span class="ident" id="4768385">e</span>&nbsp;<span class="op" id="4768387">*</span><span class="ident" id="4768388">InvalidUTF8Error</span><span class="op" id="4768404">)</span>&nbsp;<span class="ident" id="4768406">Error</span><span class="op" id="4768411">(</span><span class="op" id="4768412">)</span>&nbsp;<span class="builtintype" id="4768414">string</span>&nbsp;<span class="op" id="4768421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4768424">return</span>&nbsp;<span class="string" id="4768431">&#34;json:&nbsp;invalid&nbsp;UTF-8&nbsp;in&nbsp;string:&nbsp;&#34;</span>&nbsp;<span class="op" id="4768465">+</span>&nbsp;<span class="ident" id="4768467">strconv</span><span class="op" id="4768474">.</span><span class="ident" id="4768475">Quote</span><span class="op" id="4768480">(</span><span class="ident" id="4768481">e</span><span class="op" id="4768482">.</span><span class="ident" id="4768483">S</span><span class="op" id="4768484">)</span><br>
<span class="lineno"></span><span class="op" id="4768486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="4768489">type</span>&nbsp;<span class="ident" id="4768494">MarshalerError</span>&nbsp;<span class="keyword" id="4768509">struct</span>&nbsp;<span class="op" id="4768516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4768519">Type</span>&nbsp;<span class="ident" id="4768524">reflect</span><span class="op" id="4768531">.</span><span class="ident" id="4768532">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4768538">Err</span>&nbsp;&nbsp;<span class="builtintype" id="4768543">error</span><br>
<span class="lineno"></span><span class="op" id="4768549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span><span class="keyword" id="4768552">func</span>&nbsp;<span class="op" id="4768557">(</span><span class="ident" id="4768558">e</span>&nbsp;<span class="op" id="4768560">*</span><span class="ident" id="4768561">MarshalerError</span><span class="op" id="4768575">)</span>&nbsp;<span class="ident" id="4768577">Error</span><span class="op" id="4768582">(</span><span class="op" id="4768583">)</span>&nbsp;<span class="builtintype" id="4768585">string</span>&nbsp;<span class="op" id="4768592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4768595">return</span>&nbsp;<span class="string" id="4768602">&#34;json:&nbsp;error&nbsp;calling&nbsp;MarshalJSON&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4768646">+</span>&nbsp;<span class="ident" id="4768648">e</span><span class="op" id="4768649">.</span><span class="ident" id="4768650">Type</span><span class="op" id="4768654">.</span><span class="ident" id="4768655">String</span><span class="op" id="4768661">(</span><span class="op" id="4768662">)</span>&nbsp;<span class="op" id="4768664">+</span>&nbsp;<span class="string" id="4768666">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="4768671">+</span>&nbsp;<span class="ident" id="4768673">e</span><span class="op" id="4768674">.</span><span class="ident" id="4768675">Err</span><span class="op" id="4768678">.</span><span class="ident" id="4768679">Error</span><span class="op" id="4768684">(</span><span class="op" id="4768685">)</span><br>
<span class="lineno"></span><span class="op" id="4768687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4768690">var</span>&nbsp;<span class="ident" id="4768694">hex</span>&nbsp;<span class="op" id="4768698">=</span>&nbsp;<span class="string" id="4768700">&#34;0123456789abcdef&#34;</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="4768720">//&nbsp;An&nbsp;encodeState&nbsp;encodes&nbsp;JSON&nbsp;into&nbsp;a&nbsp;bytes.Buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4768772">type</span>&nbsp;<span class="ident" id="4768777">encodeState</span>&nbsp;<span class="keyword" id="4768789">struct</span>&nbsp;<span class="op" id="4768796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4768799">bytes</span><span class="op" id="4768804">.</span><span class="ident" id="4768805">Buffer</span>&nbsp;<span class="comment" id="4768812">//&nbsp;accumulated&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4768835">scratch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4768848">[</span><span class="num" id="4768849">64</span><span class="op" id="4768851">]</span><span class="builtintype" id="4768852">byte</span><br>
<span class="lineno">245</span><span class="op" id="4768857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4768860">var</span>&nbsp;<span class="ident" id="4768864">encodeStatePool</span>&nbsp;<span class="ident" id="4768880">sync</span><span class="op" id="4768884">.</span><span class="ident" id="4768885">Pool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4768891">func</span>&nbsp;<span class="ident" id="4768896">newEncodeState</span><span class="op" id="4768910">(</span><span class="op" id="4768911">)</span>&nbsp;<span class="op" id="4768913">*</span><span class="ident" id="4768914">encodeState</span>&nbsp;<span class="op" id="4768926">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4768929">if</span>&nbsp;<span class="ident" id="4768932">v</span>&nbsp;<span class="op" id="4768934">:=</span>&nbsp;<span class="ident" id="4768937">encodeStatePool</span><span class="op" id="4768952">.</span><span class="ident" id="4768953">Get</span><span class="op" id="4768956">(</span><span class="op" id="4768957">)</span><span class="op" id="4768958">;</span>&nbsp;<span class="ident" id="4768960">v</span>&nbsp;<span class="op" id="4768962">!=</span>&nbsp;<span class="ident" id="4768965">nil</span>&nbsp;<span class="op" id="4768969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4768973">e</span>&nbsp;<span class="op" id="4768975">:=</span>&nbsp;<span class="ident" id="4768978">v</span><span class="op" id="4768979">.</span><span class="op" id="4768980">(</span><span class="op" id="4768981">*</span><span class="ident" id="4768982">encodeState</span><span class="op" id="4768993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4768997">e</span><span class="op" id="4768998">.</span><span class="ident" id="4768999">Reset</span><span class="op" id="4769004">(</span><span class="op" id="4769005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769009">return</span>&nbsp;<span class="ident" id="4769016">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769019">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769022">return</span>&nbsp;<span class="builtinfunc" id="4769029">new</span><span class="op" id="4769032">(</span><span class="ident" id="4769033">encodeState</span><span class="op" id="4769044">)</span><br>
<span class="lineno"></span><span class="op" id="4769046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4769049">func</span>&nbsp;<span class="op" id="4769054">(</span><span class="ident" id="4769055">e</span>&nbsp;<span class="op" id="4769057">*</span><span class="ident" id="4769058">encodeState</span><span class="op" id="4769069">)</span>&nbsp;<span class="ident" id="4769071">marshal</span><span class="op" id="4769078">(</span><span class="ident" id="4769079">v</span>&nbsp;<span class="keyword" id="4769081">interface</span><span class="op" id="4769090">{</span><span class="op" id="4769091">}</span><span class="op" id="4769092">)</span>&nbsp;<span class="op" id="4769094">(</span><span class="ident" id="4769095">err</span>&nbsp;<span class="builtintype" id="4769099">error</span><span class="op" id="4769104">)</span>&nbsp;<span class="op" id="4769106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769109">defer</span>&nbsp;<span class="keyword" id="4769115">func</span><span class="op" id="4769119">(</span><span class="op" id="4769120">)</span>&nbsp;<span class="op" id="4769122">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769126">if</span>&nbsp;<span class="ident" id="4769129">r</span>&nbsp;<span class="op" id="4769131">:=</span>&nbsp;<span class="builtinfunc" id="4769134">recover</span><span class="op" id="4769141">(</span><span class="op" id="4769142">)</span><span class="op" id="4769143">;</span>&nbsp;<span class="ident" id="4769145">r</span>&nbsp;<span class="op" id="4769147">!=</span>&nbsp;<span class="ident" id="4769150">nil</span>&nbsp;<span class="op" id="4769154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769159">if</span>&nbsp;<span class="ident" id="4769162">_</span><span class="op" id="4769163">,</span>&nbsp;<span class="ident" id="4769165">ok</span>&nbsp;<span class="op" id="4769168">:=</span>&nbsp;<span class="ident" id="4769171">r</span><span class="op" id="4769172">.</span><span class="op" id="4769173">(</span><span class="ident" id="4769174">runtime</span><span class="op" id="4769181">.</span><span class="ident" id="4769182">Error</span><span class="op" id="4769187">)</span><span class="op" id="4769188">;</span>&nbsp;<span class="ident" id="4769190">ok</span>&nbsp;<span class="op" id="4769193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4769199">panic</span><span class="op" id="4769204">(</span><span class="ident" id="4769205">r</span><span class="op" id="4769206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769216">if</span>&nbsp;<span class="ident" id="4769219">s</span><span class="op" id="4769220">,</span>&nbsp;<span class="ident" id="4769222">ok</span>&nbsp;<span class="op" id="4769225">:=</span>&nbsp;<span class="ident" id="4769228">r</span><span class="op" id="4769229">.</span><span class="op" id="4769230">(</span><span class="builtintype" id="4769231">string</span><span class="op" id="4769237">)</span><span class="op" id="4769238">;</span>&nbsp;<span class="ident" id="4769240">ok</span>&nbsp;<span class="op" id="4769243">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4769249">panic</span><span class="op" id="4769254">(</span><span class="ident" id="4769255">s</span><span class="op" id="4769256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769266">err</span>&nbsp;<span class="op" id="4769270">=</span>&nbsp;<span class="ident" id="4769272">r</span><span class="op" id="4769273">.</span><span class="op" id="4769274">(</span><span class="builtintype" id="4769275">error</span><span class="op" id="4769280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769287">}</span><span class="op" id="4769288">(</span><span class="op" id="4769289">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769292">e</span><span class="op" id="4769293">.</span><span class="ident" id="4769294">reflectValue</span><span class="op" id="4769306">(</span><span class="ident" id="4769307">reflect</span><span class="op" id="4769314">.</span><span class="ident" id="4769315">ValueOf</span><span class="op" id="4769322">(</span><span class="ident" id="4769323">v</span><span class="op" id="4769324">)</span><span class="op" id="4769325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769328">return</span>&nbsp;<span class="ident" id="4769335">nil</span><br>
<span class="lineno"></span><span class="op" id="4769339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4769342">func</span>&nbsp;<span class="op" id="4769347">(</span><span class="ident" id="4769348">e</span>&nbsp;<span class="op" id="4769350">*</span><span class="ident" id="4769351">encodeState</span><span class="op" id="4769362">)</span>&nbsp;<span class="builtintype" id="4769364">error</span><span class="op" id="4769369">(</span><span class="ident" id="4769370">err</span>&nbsp;<span class="builtintype" id="4769374">error</span><span class="op" id="4769379">)</span>&nbsp;<span class="op" id="4769381">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4769384">panic</span><span class="op" id="4769389">(</span><span class="ident" id="4769390">err</span><span class="op" id="4769393">)</span><br>
<span class="lineno"></span><span class="op" id="4769395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4769398">var</span>&nbsp;<span class="ident" id="4769402">byteSliceType</span>&nbsp;<span class="op" id="4769416">=</span>&nbsp;<span class="ident" id="4769418">reflect</span><span class="op" id="4769425">.</span><span class="ident" id="4769426">TypeOf</span><span class="op" id="4769432">(</span><span class="op" id="4769433">[</span><span class="op" id="4769434">]</span><span class="builtintype" id="4769435">byte</span><span class="op" id="4769439">(</span><span class="ident" id="4769440">nil</span><span class="op" id="4769443">)</span><span class="op" id="4769444">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="keyword" id="4769447">func</span>&nbsp;<span class="ident" id="4769452">isEmptyValue</span><span class="op" id="4769464">(</span><span class="ident" id="4769465">v</span>&nbsp;<span class="ident" id="4769467">reflect</span><span class="op" id="4769474">.</span><span class="ident" id="4769475">Value</span><span class="op" id="4769480">)</span>&nbsp;<span class="builtintype" id="4769482">bool</span>&nbsp;<span class="op" id="4769487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769490">switch</span>&nbsp;<span class="ident" id="4769497">v</span><span class="op" id="4769498">.</span><span class="ident" id="4769499">Kind</span><span class="op" id="4769503">(</span><span class="op" id="4769504">)</span>&nbsp;<span class="op" id="4769506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769509">case</span>&nbsp;<span class="ident" id="4769514">reflect</span><span class="op" id="4769521">.</span><span class="ident" id="4769522">Array</span><span class="op" id="4769527">,</span>&nbsp;<span class="ident" id="4769529">reflect</span><span class="op" id="4769536">.</span><span class="ident" id="4769537">Map</span><span class="op" id="4769540">,</span>&nbsp;<span class="ident" id="4769542">reflect</span><span class="op" id="4769549">.</span><span class="ident" id="4769550">Slice</span><span class="op" id="4769555">,</span>&nbsp;<span class="ident" id="4769557">reflect</span><span class="op" id="4769564">.</span><span class="ident" id="4769565">String</span><span class="op" id="4769571">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769575">return</span>&nbsp;<span class="ident" id="4769582">v</span><span class="op" id="4769583">.</span><span class="ident" id="4769584">Len</span><span class="op" id="4769587">(</span><span class="op" id="4769588">)</span>&nbsp;<span class="op" id="4769590">==</span>&nbsp;<span class="num" id="4769593">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769596">case</span>&nbsp;<span class="ident" id="4769601">reflect</span><span class="op" id="4769608">.</span><span class="ident" id="4769609">Bool</span><span class="op" id="4769613">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769617">return</span>&nbsp;<span class="op" id="4769624">!</span><span class="ident" id="4769625">v</span><span class="op" id="4769626">.</span><span class="ident" id="4769627">Bool</span><span class="op" id="4769631">(</span><span class="op" id="4769632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769635">case</span>&nbsp;<span class="ident" id="4769640">reflect</span><span class="op" id="4769647">.</span><span class="ident" id="4769648">Int</span><span class="op" id="4769651">,</span>&nbsp;<span class="ident" id="4769653">reflect</span><span class="op" id="4769660">.</span><span class="ident" id="4769661">Int8</span><span class="op" id="4769665">,</span>&nbsp;<span class="ident" id="4769667">reflect</span><span class="op" id="4769674">.</span><span class="ident" id="4769675">Int16</span><span class="op" id="4769680">,</span>&nbsp;<span class="ident" id="4769682">reflect</span><span class="op" id="4769689">.</span><span class="ident" id="4769690">Int32</span><span class="op" id="4769695">,</span>&nbsp;<span class="ident" id="4769697">reflect</span><span class="op" id="4769704">.</span><span class="ident" id="4769705">Int64</span><span class="op" id="4769710">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769714">return</span>&nbsp;<span class="ident" id="4769721">v</span><span class="op" id="4769722">.</span><span class="ident" id="4769723">Int</span><span class="op" id="4769726">(</span><span class="op" id="4769727">)</span>&nbsp;<span class="op" id="4769729">==</span>&nbsp;<span class="num" id="4769732">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769735">case</span>&nbsp;<span class="ident" id="4769740">reflect</span><span class="op" id="4769747">.</span><span class="ident" id="4769748">Uint</span><span class="op" id="4769752">,</span>&nbsp;<span class="ident" id="4769754">reflect</span><span class="op" id="4769761">.</span><span class="ident" id="4769762">Uint8</span><span class="op" id="4769767">,</span>&nbsp;<span class="ident" id="4769769">reflect</span><span class="op" id="4769776">.</span><span class="ident" id="4769777">Uint16</span><span class="op" id="4769783">,</span>&nbsp;<span class="ident" id="4769785">reflect</span><span class="op" id="4769792">.</span><span class="ident" id="4769793">Uint32</span><span class="op" id="4769799">,</span>&nbsp;<span class="ident" id="4769801">reflect</span><span class="op" id="4769808">.</span><span class="ident" id="4769809">Uint64</span><span class="op" id="4769815">,</span>&nbsp;<span class="ident" id="4769817">reflect</span><span class="op" id="4769824">.</span><span class="ident" id="4769825">Uintptr</span><span class="op" id="4769832">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769836">return</span>&nbsp;<span class="ident" id="4769843">v</span><span class="op" id="4769844">.</span><span class="ident" id="4769845">Uint</span><span class="op" id="4769849">(</span><span class="op" id="4769850">)</span>&nbsp;<span class="op" id="4769852">==</span>&nbsp;<span class="num" id="4769855">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769858">case</span>&nbsp;<span class="ident" id="4769863">reflect</span><span class="op" id="4769870">.</span><span class="ident" id="4769871">Float32</span><span class="op" id="4769878">,</span>&nbsp;<span class="ident" id="4769880">reflect</span><span class="op" id="4769887">.</span><span class="ident" id="4769888">Float64</span><span class="op" id="4769895">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769899">return</span>&nbsp;<span class="ident" id="4769906">v</span><span class="op" id="4769907">.</span><span class="ident" id="4769908">Float</span><span class="op" id="4769913">(</span><span class="op" id="4769914">)</span>&nbsp;<span class="op" id="4769916">==</span>&nbsp;<span class="num" id="4769919">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769922">case</span>&nbsp;<span class="ident" id="4769927">reflect</span><span class="op" id="4769934">.</span><span class="ident" id="4769935">Interface</span><span class="op" id="4769944">,</span>&nbsp;<span class="ident" id="4769946">reflect</span><span class="op" id="4769953">.</span><span class="ident" id="4769954">Ptr</span><span class="op" id="4769957">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769961">return</span>&nbsp;<span class="ident" id="4769968">v</span><span class="op" id="4769969">.</span><span class="ident" id="4769970">IsNil</span><span class="op" id="4769975">(</span><span class="op" id="4769976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769979">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769982">return</span>&nbsp;<span class="builtintype" id="4769989">false</span><br>
<span class="lineno"></span><span class="op" id="4769995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4769998">func</span>&nbsp;<span class="op" id="4770003">(</span><span class="ident" id="4770004">e</span>&nbsp;<span class="op" id="4770006">*</span><span class="ident" id="4770007">encodeState</span><span class="op" id="4770018">)</span>&nbsp;<span class="ident" id="4770020">reflectValue</span><span class="op" id="4770032">(</span><span class="ident" id="4770033">v</span>&nbsp;<span class="ident" id="4770035">reflect</span><span class="op" id="4770042">.</span><span class="ident" id="4770043">Value</span><span class="op" id="4770048">)</span>&nbsp;<span class="op" id="4770050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770053">valueEncoder</span><span class="op" id="4770065">(</span><span class="ident" id="4770066">v</span><span class="op" id="4770067">)</span><span class="op" id="4770068">(</span><span class="ident" id="4770069">e</span><span class="op" id="4770070">,</span>&nbsp;<span class="ident" id="4770072">v</span><span class="op" id="4770073">,</span>&nbsp;<span class="builtintype" id="4770075">false</span><span class="op" id="4770080">)</span><br>
<span class="lineno">300</span><span class="op" id="4770082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4770085">type</span>&nbsp;<span class="ident" id="4770090">encoderFunc</span>&nbsp;<span class="keyword" id="4770102">func</span><span class="op" id="4770106">(</span><span class="ident" id="4770107">e</span>&nbsp;<span class="op" id="4770109">*</span><span class="ident" id="4770110">encodeState</span><span class="op" id="4770121">,</span>&nbsp;<span class="ident" id="4770123">v</span>&nbsp;<span class="ident" id="4770125">reflect</span><span class="op" id="4770132">.</span><span class="ident" id="4770133">Value</span><span class="op" id="4770138">,</span>&nbsp;<span class="ident" id="4770140">quoted</span>&nbsp;<span class="builtintype" id="4770147">bool</span><span class="op" id="4770151">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4770154">var</span>&nbsp;<span class="ident" id="4770158">encoderCache</span>&nbsp;<span class="keyword" id="4770171">struct</span>&nbsp;<span class="op" id="4770178">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770181">sync</span><span class="op" id="4770185">.</span><span class="ident" id="4770186">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770195">m</span>&nbsp;<span class="keyword" id="4770197">map</span><span class="op" id="4770200">[</span><span class="ident" id="4770201">reflect</span><span class="op" id="4770208">.</span><span class="ident" id="4770209">Type</span><span class="op" id="4770213">]</span><span class="ident" id="4770214">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="4770226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4770229">func</span>&nbsp;<span class="ident" id="4770234">valueEncoder</span><span class="op" id="4770246">(</span><span class="ident" id="4770247">v</span>&nbsp;<span class="ident" id="4770249">reflect</span><span class="op" id="4770256">.</span><span class="ident" id="4770257">Value</span><span class="op" id="4770262">)</span>&nbsp;<span class="ident" id="4770264">encoderFunc</span>&nbsp;<span class="op" id="4770276">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770279">if</span>&nbsp;<span class="op" id="4770282">!</span><span class="ident" id="4770283">v</span><span class="op" id="4770284">.</span><span class="ident" id="4770285">IsValid</span><span class="op" id="4770292">(</span><span class="op" id="4770293">)</span>&nbsp;<span class="op" id="4770295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770299">return</span>&nbsp;<span class="ident" id="4770306">invalidValueEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4770327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770330">return</span>&nbsp;<span class="ident" id="4770337">typeEncoder</span><span class="op" id="4770348">(</span><span class="ident" id="4770349">v</span><span class="op" id="4770350">.</span><span class="ident" id="4770351">Type</span><span class="op" id="4770355">(</span><span class="op" id="4770356">)</span><span class="op" id="4770357">)</span><br>
<span class="lineno"></span><span class="op" id="4770359">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="4770362">func</span>&nbsp;<span class="ident" id="4770367">typeEncoder</span><span class="op" id="4770378">(</span><span class="ident" id="4770379">t</span>&nbsp;<span class="ident" id="4770381">reflect</span><span class="op" id="4770388">.</span><span class="ident" id="4770389">Type</span><span class="op" id="4770393">)</span>&nbsp;<span class="ident" id="4770395">encoderFunc</span>&nbsp;<span class="op" id="4770407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770410">encoderCache</span><span class="op" id="4770422">.</span><span class="ident" id="4770423">RLock</span><span class="op" id="4770428">(</span><span class="op" id="4770429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770432">f</span>&nbsp;<span class="op" id="4770434">:=</span>&nbsp;<span class="ident" id="4770437">encoderCache</span><span class="op" id="4770449">.</span><span class="ident" id="4770450">m</span><span class="op" id="4770451">[</span><span class="ident" id="4770452">t</span><span class="op" id="4770453">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770456">encoderCache</span><span class="op" id="4770468">.</span><span class="ident" id="4770469">RUnlock</span><span class="op" id="4770476">(</span><span class="op" id="4770477">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770480">if</span>&nbsp;<span class="ident" id="4770483">f</span>&nbsp;<span class="op" id="4770485">!=</span>&nbsp;<span class="ident" id="4770488">nil</span>&nbsp;<span class="op" id="4770492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770496">return</span>&nbsp;<span class="ident" id="4770503">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4770506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770510">//&nbsp;To&nbsp;deal&nbsp;with&nbsp;recursive&nbsp;types,&nbsp;populate&nbsp;the&nbsp;map&nbsp;with&nbsp;an</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770569">//&nbsp;indirect&nbsp;func&nbsp;before&nbsp;we&nbsp;build&nbsp;it.&nbsp;This&nbsp;type&nbsp;waits&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770630">//&nbsp;real&nbsp;func&nbsp;(f)&nbsp;to&nbsp;be&nbsp;ready&nbsp;and&nbsp;then&nbsp;calls&nbsp;it.&nbsp;&nbsp;This&nbsp;indirect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770694">//&nbsp;func&nbsp;is&nbsp;only&nbsp;used&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770737">encoderCache</span><span class="op" id="4770749">.</span><span class="ident" id="4770750">Lock</span><span class="op" id="4770754">(</span><span class="op" id="4770755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770758">if</span>&nbsp;<span class="ident" id="4770761">encoderCache</span><span class="op" id="4770773">.</span><span class="ident" id="4770774">m</span>&nbsp;<span class="op" id="4770776">==</span>&nbsp;<span class="ident" id="4770779">nil</span>&nbsp;<span class="op" id="4770783">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770787">encoderCache</span><span class="op" id="4770799">.</span><span class="ident" id="4770800">m</span>&nbsp;<span class="op" id="4770802">=</span>&nbsp;<span class="builtinfunc" id="4770804">make</span><span class="op" id="4770808">(</span><span class="keyword" id="4770809">map</span><span class="op" id="4770812">[</span><span class="ident" id="4770813">reflect</span><span class="op" id="4770820">.</span><span class="ident" id="4770821">Type</span><span class="op" id="4770825">]</span><span class="ident" id="4770826">encoderFunc</span><span class="op" id="4770837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4770840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770843">var</span>&nbsp;<span class="ident" id="4770847">wg</span>&nbsp;<span class="ident" id="4770850">sync</span><span class="op" id="4770854">.</span><span class="ident" id="4770855">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770866">wg</span><span class="op" id="4770868">.</span><span class="ident" id="4770869">Add</span><span class="op" id="4770872">(</span><span class="num" id="4770873">1</span><span class="op" id="4770874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770877">encoderCache</span><span class="op" id="4770889">.</span><span class="ident" id="4770890">m</span><span class="op" id="4770891">[</span><span class="ident" id="4770892">t</span><span class="op" id="4770893">]</span>&nbsp;<span class="op" id="4770895">=</span>&nbsp;<span class="keyword" id="4770897">func</span><span class="op" id="4770901">(</span><span class="ident" id="4770902">e</span>&nbsp;<span class="op" id="4770904">*</span><span class="ident" id="4770905">encodeState</span><span class="op" id="4770916">,</span>&nbsp;<span class="ident" id="4770918">v</span>&nbsp;<span class="ident" id="4770920">reflect</span><span class="op" id="4770927">.</span><span class="ident" id="4770928">Value</span><span class="op" id="4770933">,</span>&nbsp;<span class="ident" id="4770935">quoted</span>&nbsp;<span class="builtintype" id="4770942">bool</span><span class="op" id="4770946">)</span>&nbsp;<span class="op" id="4770948">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770952">wg</span><span class="op" id="4770954">.</span><span class="ident" id="4770955">Wait</span><span class="op" id="4770959">(</span><span class="op" id="4770960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770964">f</span><span class="op" id="4770965">(</span><span class="ident" id="4770966">e</span><span class="op" id="4770967">,</span>&nbsp;<span class="ident" id="4770969">v</span><span class="op" id="4770970">,</span>&nbsp;<span class="ident" id="4770972">quoted</span><span class="op" id="4770978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4770981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770984">encoderCache</span><span class="op" id="4770996">.</span><span class="ident" id="4770997">Unlock</span><span class="op" id="4771003">(</span><span class="op" id="4771004">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4771008">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4771041">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771108">f</span>&nbsp;<span class="op" id="4771110">=</span>&nbsp;<span class="ident" id="4771112">newTypeEncoder</span><span class="op" id="4771126">(</span><span class="ident" id="4771127">t</span><span class="op" id="4771128">,</span>&nbsp;<span class="builtintype" id="4771130">true</span><span class="op" id="4771134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771137">wg</span><span class="op" id="4771139">.</span><span class="ident" id="4771140">Done</span><span class="op" id="4771144">(</span><span class="op" id="4771145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771148">encoderCache</span><span class="op" id="4771160">.</span><span class="ident" id="4771161">Lock</span><span class="op" id="4771165">(</span><span class="op" id="4771166">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771169">encoderCache</span><span class="op" id="4771181">.</span><span class="ident" id="4771182">m</span><span class="op" id="4771183">[</span><span class="ident" id="4771184">t</span><span class="op" id="4771185">]</span>&nbsp;<span class="op" id="4771187">=</span>&nbsp;<span class="ident" id="4771189">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771192">encoderCache</span><span class="op" id="4771204">.</span><span class="ident" id="4771205">Unlock</span><span class="op" id="4771211">(</span><span class="op" id="4771212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771215">return</span>&nbsp;<span class="ident" id="4771222">f</span><br>
<span class="lineno"></span><span class="op" id="4771224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="4771227">var</span>&nbsp;<span class="op" id="4771231">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771234">marshalerType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4771252">=</span>&nbsp;<span class="ident" id="4771254">reflect</span><span class="op" id="4771261">.</span><span class="ident" id="4771262">TypeOf</span><span class="op" id="4771268">(</span><span class="builtinfunc" id="4771269">new</span><span class="op" id="4771272">(</span><span class="ident" id="4771273">Marshaler</span><span class="op" id="4771282">)</span><span class="op" id="4771283">)</span><span class="op" id="4771284">.</span><span class="ident" id="4771285">Elem</span><span class="op" id="4771289">(</span><span class="op" id="4771290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771293">textMarshalerType</span>&nbsp;<span class="op" id="4771311">=</span>&nbsp;<span class="ident" id="4771313">reflect</span><span class="op" id="4771320">.</span><span class="ident" id="4771321">TypeOf</span><span class="op" id="4771327">(</span><span class="builtinfunc" id="4771328">new</span><span class="op" id="4771331">(</span><span class="ident" id="4771332">encoding</span><span class="op" id="4771340">.</span><span class="ident" id="4771341">TextMarshaler</span><span class="op" id="4771354">)</span><span class="op" id="4771355">)</span><span class="op" id="4771356">.</span><span class="ident" id="4771357">Elem</span><span class="op" id="4771361">(</span><span class="op" id="4771362">)</span><br>
<span class="lineno"></span><span class="op" id="4771364">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="4771367">//&nbsp;newTypeEncoder&nbsp;constructs&nbsp;an&nbsp;encoderFunc&nbsp;for&nbsp;a&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="4771423">//&nbsp;The&nbsp;returned&nbsp;encoder&nbsp;only&nbsp;checks&nbsp;CanAddr&nbsp;when&nbsp;allowAddr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="4771491">func</span>&nbsp;<span class="ident" id="4771496">newTypeEncoder</span><span class="op" id="4771510">(</span><span class="ident" id="4771511">t</span>&nbsp;<span class="ident" id="4771513">reflect</span><span class="op" id="4771520">.</span><span class="ident" id="4771521">Type</span><span class="op" id="4771525">,</span>&nbsp;<span class="ident" id="4771527">allowAddr</span>&nbsp;<span class="builtintype" id="4771537">bool</span><span class="op" id="4771541">)</span>&nbsp;<span class="ident" id="4771543">encoderFunc</span>&nbsp;<span class="op" id="4771555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771558">if</span>&nbsp;<span class="ident" id="4771561">t</span><span class="op" id="4771562">.</span><span class="ident" id="4771563">Implements</span><span class="op" id="4771573">(</span><span class="ident" id="4771574">marshalerType</span><span class="op" id="4771587">)</span>&nbsp;<span class="op" id="4771589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771593">return</span>&nbsp;<span class="ident" id="4771600">marshalerEncoder</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771621">if</span>&nbsp;<span class="ident" id="4771624">t</span><span class="op" id="4771625">.</span><span class="ident" id="4771626">Kind</span><span class="op" id="4771630">(</span><span class="op" id="4771631">)</span>&nbsp;<span class="op" id="4771633">!=</span>&nbsp;<span class="ident" id="4771636">reflect</span><span class="op" id="4771643">.</span><span class="ident" id="4771644">Ptr</span>&nbsp;<span class="op" id="4771648">&amp;&amp;</span>&nbsp;<span class="ident" id="4771651">allowAddr</span>&nbsp;<span class="op" id="4771661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771665">if</span>&nbsp;<span class="ident" id="4771668">reflect</span><span class="op" id="4771675">.</span><span class="ident" id="4771676">PtrTo</span><span class="op" id="4771681">(</span><span class="ident" id="4771682">t</span><span class="op" id="4771683">)</span><span class="op" id="4771684">.</span><span class="ident" id="4771685">Implements</span><span class="op" id="4771695">(</span><span class="ident" id="4771696">marshalerType</span><span class="op" id="4771709">)</span>&nbsp;<span class="op" id="4771711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771716">return</span>&nbsp;<span class="ident" id="4771723">newCondAddrEncoder</span><span class="op" id="4771741">(</span><span class="ident" id="4771742">addrMarshalerEncoder</span><span class="op" id="4771762">,</span>&nbsp;<span class="ident" id="4771764">newTypeEncoder</span><span class="op" id="4771778">(</span><span class="ident" id="4771779">t</span><span class="op" id="4771780">,</span>&nbsp;<span class="builtintype" id="4771782">false</span><span class="op" id="4771787">)</span><span class="op" id="4771788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771792">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771799">if</span>&nbsp;<span class="ident" id="4771802">t</span><span class="op" id="4771803">.</span><span class="ident" id="4771804">Implements</span><span class="op" id="4771814">(</span><span class="ident" id="4771815">textMarshalerType</span><span class="op" id="4771832">)</span>&nbsp;<span class="op" id="4771834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771838">return</span>&nbsp;<span class="ident" id="4771845">textMarshalerEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771867">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771870">if</span>&nbsp;<span class="ident" id="4771873">t</span><span class="op" id="4771874">.</span><span class="ident" id="4771875">Kind</span><span class="op" id="4771879">(</span><span class="op" id="4771880">)</span>&nbsp;<span class="op" id="4771882">!=</span>&nbsp;<span class="ident" id="4771885">reflect</span><span class="op" id="4771892">.</span><span class="ident" id="4771893">Ptr</span>&nbsp;<span class="op" id="4771897">&amp;&amp;</span>&nbsp;<span class="ident" id="4771900">allowAddr</span>&nbsp;<span class="op" id="4771910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771914">if</span>&nbsp;<span class="ident" id="4771917">reflect</span><span class="op" id="4771924">.</span><span class="ident" id="4771925">PtrTo</span><span class="op" id="4771930">(</span><span class="ident" id="4771931">t</span><span class="op" id="4771932">)</span><span class="op" id="4771933">.</span><span class="ident" id="4771934">Implements</span><span class="op" id="4771944">(</span><span class="ident" id="4771945">textMarshalerType</span><span class="op" id="4771962">)</span>&nbsp;<span class="op" id="4771964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771969">return</span>&nbsp;<span class="ident" id="4771976">newCondAddrEncoder</span><span class="op" id="4771994">(</span><span class="ident" id="4771995">addrTextMarshalerEncoder</span><span class="op" id="4772019">,</span>&nbsp;<span class="ident" id="4772021">newTypeEncoder</span><span class="op" id="4772035">(</span><span class="ident" id="4772036">t</span><span class="op" id="4772037">,</span>&nbsp;<span class="builtintype" id="4772039">false</span><span class="op" id="4772044">)</span><span class="op" id="4772045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4772049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4772052">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772056">switch</span>&nbsp;<span class="ident" id="4772063">t</span><span class="op" id="4772064">.</span><span class="ident" id="4772065">Kind</span><span class="op" id="4772069">(</span><span class="op" id="4772070">)</span>&nbsp;<span class="op" id="4772072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772075">case</span>&nbsp;<span class="ident" id="4772080">reflect</span><span class="op" id="4772087">.</span><span class="ident" id="4772088">Bool</span><span class="op" id="4772092">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772096">return</span>&nbsp;<span class="ident" id="4772103">boolEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772116">case</span>&nbsp;<span class="ident" id="4772121">reflect</span><span class="op" id="4772128">.</span><span class="ident" id="4772129">Int</span><span class="op" id="4772132">,</span>&nbsp;<span class="ident" id="4772134">reflect</span><span class="op" id="4772141">.</span><span class="ident" id="4772142">Int8</span><span class="op" id="4772146">,</span>&nbsp;<span class="ident" id="4772148">reflect</span><span class="op" id="4772155">.</span><span class="ident" id="4772156">Int16</span><span class="op" id="4772161">,</span>&nbsp;<span class="ident" id="4772163">reflect</span><span class="op" id="4772170">.</span><span class="ident" id="4772171">Int32</span><span class="op" id="4772176">,</span>&nbsp;<span class="ident" id="4772178">reflect</span><span class="op" id="4772185">.</span><span class="ident" id="4772186">Int64</span><span class="op" id="4772191">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772195">return</span>&nbsp;<span class="ident" id="4772202">intEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772214">case</span>&nbsp;<span class="ident" id="4772219">reflect</span><span class="op" id="4772226">.</span><span class="ident" id="4772227">Uint</span><span class="op" id="4772231">,</span>&nbsp;<span class="ident" id="4772233">reflect</span><span class="op" id="4772240">.</span><span class="ident" id="4772241">Uint8</span><span class="op" id="4772246">,</span>&nbsp;<span class="ident" id="4772248">reflect</span><span class="op" id="4772255">.</span><span class="ident" id="4772256">Uint16</span><span class="op" id="4772262">,</span>&nbsp;<span class="ident" id="4772264">reflect</span><span class="op" id="4772271">.</span><span class="ident" id="4772272">Uint32</span><span class="op" id="4772278">,</span>&nbsp;<span class="ident" id="4772280">reflect</span><span class="op" id="4772287">.</span><span class="ident" id="4772288">Uint64</span><span class="op" id="4772294">,</span>&nbsp;<span class="ident" id="4772296">reflect</span><span class="op" id="4772303">.</span><span class="ident" id="4772304">Uintptr</span><span class="op" id="4772311">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772315">return</span>&nbsp;<span class="ident" id="4772322">uintEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772335">case</span>&nbsp;<span class="ident" id="4772340">reflect</span><span class="op" id="4772347">.</span><span class="ident" id="4772348">Float32</span><span class="op" id="4772355">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772359">return</span>&nbsp;<span class="ident" id="4772366">float32Encoder</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772382">case</span>&nbsp;<span class="ident" id="4772387">reflect</span><span class="op" id="4772394">.</span><span class="ident" id="4772395">Float64</span><span class="op" id="4772402">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772406">return</span>&nbsp;<span class="ident" id="4772413">float64Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772429">case</span>&nbsp;<span class="ident" id="4772434">reflect</span><span class="op" id="4772441">.</span><span class="ident" id="4772442">String</span><span class="op" id="4772448">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772452">return</span>&nbsp;<span class="ident" id="4772459">stringEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772474">case</span>&nbsp;<span class="ident" id="4772479">reflect</span><span class="op" id="4772486">.</span><span class="ident" id="4772487">Interface</span><span class="op" id="4772496">:</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772500">return</span>&nbsp;<span class="ident" id="4772507">interfaceEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772525">case</span>&nbsp;<span class="ident" id="4772530">reflect</span><span class="op" id="4772537">.</span><span class="ident" id="4772538">Struct</span><span class="op" id="4772544">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772548">return</span>&nbsp;<span class="ident" id="4772555">newStructEncoder</span><span class="op" id="4772571">(</span><span class="ident" id="4772572">t</span><span class="op" id="4772573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772576">case</span>&nbsp;<span class="ident" id="4772581">reflect</span><span class="op" id="4772588">.</span><span class="ident" id="4772589">Map</span><span class="op" id="4772592">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772596">return</span>&nbsp;<span class="ident" id="4772603">newMapEncoder</span><span class="op" id="4772616">(</span><span class="ident" id="4772617">t</span><span class="op" id="4772618">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772621">case</span>&nbsp;<span class="ident" id="4772626">reflect</span><span class="op" id="4772633">.</span><span class="ident" id="4772634">Slice</span><span class="op" id="4772639">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772643">return</span>&nbsp;<span class="ident" id="4772650">newSliceEncoder</span><span class="op" id="4772665">(</span><span class="ident" id="4772666">t</span><span class="op" id="4772667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772670">case</span>&nbsp;<span class="ident" id="4772675">reflect</span><span class="op" id="4772682">.</span><span class="ident" id="4772683">Array</span><span class="op" id="4772688">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772692">return</span>&nbsp;<span class="ident" id="4772699">newArrayEncoder</span><span class="op" id="4772714">(</span><span class="ident" id="4772715">t</span><span class="op" id="4772716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772719">case</span>&nbsp;<span class="ident" id="4772724">reflect</span><span class="op" id="4772731">.</span><span class="ident" id="4772732">Ptr</span><span class="op" id="4772735">:</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772739">return</span>&nbsp;<span class="ident" id="4772746">newPtrEncoder</span><span class="op" id="4772759">(</span><span class="ident" id="4772760">t</span><span class="op" id="4772761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772764">default</span><span class="op" id="4772771">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772775">return</span>&nbsp;<span class="ident" id="4772782">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4772806">}</span><br>
<span class="lineno"></span><span class="op" id="4772808">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="keyword" id="4772811">func</span>&nbsp;<span class="ident" id="4772816">invalidValueEncoder</span><span class="op" id="4772835">(</span><span class="ident" id="4772836">e</span>&nbsp;<span class="op" id="4772838">*</span><span class="ident" id="4772839">encodeState</span><span class="op" id="4772850">,</span>&nbsp;<span class="ident" id="4772852">v</span>&nbsp;<span class="ident" id="4772854">reflect</span><span class="op" id="4772861">.</span><span class="ident" id="4772862">Value</span><span class="op" id="4772867">,</span>&nbsp;<span class="ident" id="4772869">quoted</span>&nbsp;<span class="builtintype" id="4772876">bool</span><span class="op" id="4772880">)</span>&nbsp;<span class="op" id="4772882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4772885">e</span><span class="op" id="4772886">.</span><span class="ident" id="4772887">WriteString</span><span class="op" id="4772898">(</span><span class="string" id="4772899">&#34;null&#34;</span><span class="op" id="4772905">)</span><br>
<span class="lineno"></span><span class="op" id="4772907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="keyword" id="4772910">func</span>&nbsp;<span class="ident" id="4772915">marshalerEncoder</span><span class="op" id="4772931">(</span><span class="ident" id="4772932">e</span>&nbsp;<span class="op" id="4772934">*</span><span class="ident" id="4772935">encodeState</span><span class="op" id="4772946">,</span>&nbsp;<span class="ident" id="4772948">v</span>&nbsp;<span class="ident" id="4772950">reflect</span><span class="op" id="4772957">.</span><span class="ident" id="4772958">Value</span><span class="op" id="4772963">,</span>&nbsp;<span class="ident" id="4772965">quoted</span>&nbsp;<span class="builtintype" id="4772972">bool</span><span class="op" id="4772976">)</span>&nbsp;<span class="op" id="4772978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772981">if</span>&nbsp;<span class="ident" id="4772984">v</span><span class="op" id="4772985">.</span><span class="ident" id="4772986">Kind</span><span class="op" id="4772990">(</span><span class="op" id="4772991">)</span>&nbsp;<span class="op" id="4772993">==</span>&nbsp;<span class="ident" id="4772996">reflect</span><span class="op" id="4773003">.</span><span class="ident" id="4773004">Ptr</span>&nbsp;<span class="op" id="4773008">&amp;&amp;</span>&nbsp;<span class="ident" id="4773011">v</span><span class="op" id="4773012">.</span><span class="ident" id="4773013">IsNil</span><span class="op" id="4773018">(</span><span class="op" id="4773019">)</span>&nbsp;<span class="op" id="4773021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773025">e</span><span class="op" id="4773026">.</span><span class="ident" id="4773027">WriteString</span><span class="op" id="4773038">(</span><span class="string" id="4773039">&#34;null&#34;</span><span class="op" id="4773045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773049">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773057">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773060">m</span>&nbsp;<span class="op" id="4773062">:=</span>&nbsp;<span class="ident" id="4773065">v</span><span class="op" id="4773066">.</span><span class="ident" id="4773067">Interface</span><span class="op" id="4773076">(</span><span class="op" id="4773077">)</span><span class="op" id="4773078">.</span><span class="op" id="4773079">(</span><span class="ident" id="4773080">Marshaler</span><span class="op" id="4773089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773092">b</span><span class="op" id="4773093">,</span>&nbsp;<span class="ident" id="4773095">err</span>&nbsp;<span class="op" id="4773099">:=</span>&nbsp;<span class="ident" id="4773102">m</span><span class="op" id="4773103">.</span><span class="ident" id="4773104">MarshalJSON</span><span class="op" id="4773115">(</span><span class="op" id="4773116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773119">if</span>&nbsp;<span class="ident" id="4773122">err</span>&nbsp;<span class="op" id="4773126">==</span>&nbsp;<span class="ident" id="4773129">nil</span>&nbsp;<span class="op" id="4773133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4773137">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773184">err</span>&nbsp;<span class="op" id="4773188">=</span>&nbsp;<span class="ident" id="4773190">compact</span><span class="op" id="4773197">(</span><span class="op" id="4773198">&amp;</span><span class="ident" id="4773199">e</span><span class="op" id="4773200">.</span><span class="ident" id="4773201">Buffer</span><span class="op" id="4773207">,</span>&nbsp;<span class="ident" id="4773209">b</span><span class="op" id="4773210">,</span>&nbsp;<span class="builtintype" id="4773212">true</span><span class="op" id="4773216">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773222">if</span>&nbsp;<span class="ident" id="4773225">err</span>&nbsp;<span class="op" id="4773229">!=</span>&nbsp;<span class="ident" id="4773232">nil</span>&nbsp;<span class="op" id="4773236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773240">e</span><span class="op" id="4773241">.</span><span class="builtintype" id="4773242">error</span><span class="op" id="4773247">(</span><span class="op" id="4773248">&amp;</span><span class="ident" id="4773249">MarshalerError</span><span class="op" id="4773263">{</span><span class="ident" id="4773264">v</span><span class="op" id="4773265">.</span><span class="ident" id="4773266">Type</span><span class="op" id="4773270">(</span><span class="op" id="4773271">)</span><span class="op" id="4773272">,</span>&nbsp;<span class="ident" id="4773274">err</span><span class="op" id="4773277">}</span><span class="op" id="4773278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773281">}</span><br>
<span class="lineno"></span><span class="op" id="4773283">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="4773286">func</span>&nbsp;<span class="ident" id="4773291">addrMarshalerEncoder</span><span class="op" id="4773311">(</span><span class="ident" id="4773312">e</span>&nbsp;<span class="op" id="4773314">*</span><span class="ident" id="4773315">encodeState</span><span class="op" id="4773326">,</span>&nbsp;<span class="ident" id="4773328">v</span>&nbsp;<span class="ident" id="4773330">reflect</span><span class="op" id="4773337">.</span><span class="ident" id="4773338">Value</span><span class="op" id="4773343">,</span>&nbsp;<span class="ident" id="4773345">quoted</span>&nbsp;<span class="builtintype" id="4773352">bool</span><span class="op" id="4773356">)</span>&nbsp;<span class="op" id="4773358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773361">va</span>&nbsp;<span class="op" id="4773364">:=</span>&nbsp;<span class="ident" id="4773367">v</span><span class="op" id="4773368">.</span><span class="ident" id="4773369">Addr</span><span class="op" id="4773373">(</span><span class="op" id="4773374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773377">if</span>&nbsp;<span class="ident" id="4773380">va</span><span class="op" id="4773382">.</span><span class="ident" id="4773383">IsNil</span><span class="op" id="4773388">(</span><span class="op" id="4773389">)</span>&nbsp;<span class="op" id="4773391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773395">e</span><span class="op" id="4773396">.</span><span class="ident" id="4773397">WriteString</span><span class="op" id="4773408">(</span><span class="string" id="4773409">&#34;null&#34;</span><span class="op" id="4773415">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773419">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773430">m</span>&nbsp;<span class="op" id="4773432">:=</span>&nbsp;<span class="ident" id="4773435">va</span><span class="op" id="4773437">.</span><span class="ident" id="4773438">Interface</span><span class="op" id="4773447">(</span><span class="op" id="4773448">)</span><span class="op" id="4773449">.</span><span class="op" id="4773450">(</span><span class="ident" id="4773451">Marshaler</span><span class="op" id="4773460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773463">b</span><span class="op" id="4773464">,</span>&nbsp;<span class="ident" id="4773466">err</span>&nbsp;<span class="op" id="4773470">:=</span>&nbsp;<span class="ident" id="4773473">m</span><span class="op" id="4773474">.</span><span class="ident" id="4773475">MarshalJSON</span><span class="op" id="4773486">(</span><span class="op" id="4773487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773490">if</span>&nbsp;<span class="ident" id="4773493">err</span>&nbsp;<span class="op" id="4773497">==</span>&nbsp;<span class="ident" id="4773500">nil</span>&nbsp;<span class="op" id="4773504">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4773508">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773555">err</span>&nbsp;<span class="op" id="4773559">=</span>&nbsp;<span class="ident" id="4773561">compact</span><span class="op" id="4773568">(</span><span class="op" id="4773569">&amp;</span><span class="ident" id="4773570">e</span><span class="op" id="4773571">.</span><span class="ident" id="4773572">Buffer</span><span class="op" id="4773578">,</span>&nbsp;<span class="ident" id="4773580">b</span><span class="op" id="4773581">,</span>&nbsp;<span class="builtintype" id="4773583">true</span><span class="op" id="4773587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773593">if</span>&nbsp;<span class="ident" id="4773596">err</span>&nbsp;<span class="op" id="4773600">!=</span>&nbsp;<span class="ident" id="4773603">nil</span>&nbsp;<span class="op" id="4773607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773611">e</span><span class="op" id="4773612">.</span><span class="builtintype" id="4773613">error</span><span class="op" id="4773618">(</span><span class="op" id="4773619">&amp;</span><span class="ident" id="4773620">MarshalerError</span><span class="op" id="4773634">{</span><span class="ident" id="4773635">v</span><span class="op" id="4773636">.</span><span class="ident" id="4773637">Type</span><span class="op" id="4773641">(</span><span class="op" id="4773642">)</span><span class="op" id="4773643">,</span>&nbsp;<span class="ident" id="4773645">err</span><span class="op" id="4773648">}</span><span class="op" id="4773649">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773652">}</span><br>
<span class="lineno"></span><span class="op" id="4773654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4773657">func</span>&nbsp;<span class="ident" id="4773662">textMarshalerEncoder</span><span class="op" id="4773682">(</span><span class="ident" id="4773683">e</span>&nbsp;<span class="op" id="4773685">*</span><span class="ident" id="4773686">encodeState</span><span class="op" id="4773697">,</span>&nbsp;<span class="ident" id="4773699">v</span>&nbsp;<span class="ident" id="4773701">reflect</span><span class="op" id="4773708">.</span><span class="ident" id="4773709">Value</span><span class="op" id="4773714">,</span>&nbsp;<span class="ident" id="4773716">quoted</span>&nbsp;<span class="builtintype" id="4773723">bool</span><span class="op" id="4773727">)</span>&nbsp;<span class="op" id="4773729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773732">if</span>&nbsp;<span class="ident" id="4773735">v</span><span class="op" id="4773736">.</span><span class="ident" id="4773737">Kind</span><span class="op" id="4773741">(</span><span class="op" id="4773742">)</span>&nbsp;<span class="op" id="4773744">==</span>&nbsp;<span class="ident" id="4773747">reflect</span><span class="op" id="4773754">.</span><span class="ident" id="4773755">Ptr</span>&nbsp;<span class="op" id="4773759">&amp;&amp;</span>&nbsp;<span class="ident" id="4773762">v</span><span class="op" id="4773763">.</span><span class="ident" id="4773764">IsNil</span><span class="op" id="4773769">(</span><span class="op" id="4773770">)</span>&nbsp;<span class="op" id="4773772">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773776">e</span><span class="op" id="4773777">.</span><span class="ident" id="4773778">WriteString</span><span class="op" id="4773789">(</span><span class="string" id="4773790">&#34;null&#34;</span><span class="op" id="4773796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773800">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773811">m</span>&nbsp;<span class="op" id="4773813">:=</span>&nbsp;<span class="ident" id="4773816">v</span><span class="op" id="4773817">.</span><span class="ident" id="4773818">Interface</span><span class="op" id="4773827">(</span><span class="op" id="4773828">)</span><span class="op" id="4773829">.</span><span class="op" id="4773830">(</span><span class="ident" id="4773831">encoding</span><span class="op" id="4773839">.</span><span class="ident" id="4773840">TextMarshaler</span><span class="op" id="4773853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773856">b</span><span class="op" id="4773857">,</span>&nbsp;<span class="ident" id="4773859">err</span>&nbsp;<span class="op" id="4773863">:=</span>&nbsp;<span class="ident" id="4773866">m</span><span class="op" id="4773867">.</span><span class="ident" id="4773868">MarshalText</span><span class="op" id="4773879">(</span><span class="op" id="4773880">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773883">if</span>&nbsp;<span class="ident" id="4773886">err</span>&nbsp;<span class="op" id="4773890">==</span>&nbsp;<span class="ident" id="4773893">nil</span>&nbsp;<span class="op" id="4773897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773901">_</span><span class="op" id="4773902">,</span>&nbsp;<span class="ident" id="4773904">err</span>&nbsp;<span class="op" id="4773908">=</span>&nbsp;<span class="ident" id="4773910">e</span><span class="op" id="4773911">.</span><span class="ident" id="4773912">stringBytes</span><span class="op" id="4773923">(</span><span class="ident" id="4773924">b</span><span class="op" id="4773925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773931">if</span>&nbsp;<span class="ident" id="4773934">err</span>&nbsp;<span class="op" id="4773938">!=</span>&nbsp;<span class="ident" id="4773941">nil</span>&nbsp;<span class="op" id="4773945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773949">e</span><span class="op" id="4773950">.</span><span class="builtintype" id="4773951">error</span><span class="op" id="4773956">(</span><span class="op" id="4773957">&amp;</span><span class="ident" id="4773958">MarshalerError</span><span class="op" id="4773972">{</span><span class="ident" id="4773973">v</span><span class="op" id="4773974">.</span><span class="ident" id="4773975">Type</span><span class="op" id="4773979">(</span><span class="op" id="4773980">)</span><span class="op" id="4773981">,</span>&nbsp;<span class="ident" id="4773983">err</span><span class="op" id="4773986">}</span><span class="op" id="4773987">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773990">}</span><br>
<span class="lineno"></span><span class="op" id="4773992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4773995">func</span>&nbsp;<span class="ident" id="4774000">addrTextMarshalerEncoder</span><span class="op" id="4774024">(</span><span class="ident" id="4774025">e</span>&nbsp;<span class="op" id="4774027">*</span><span class="ident" id="4774028">encodeState</span><span class="op" id="4774039">,</span>&nbsp;<span class="ident" id="4774041">v</span>&nbsp;<span class="ident" id="4774043">reflect</span><span class="op" id="4774050">.</span><span class="ident" id="4774051">Value</span><span class="op" id="4774056">,</span>&nbsp;<span class="ident" id="4774058">quoted</span>&nbsp;<span class="builtintype" id="4774065">bool</span><span class="op" id="4774069">)</span>&nbsp;<span class="op" id="4774071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774074">va</span>&nbsp;<span class="op" id="4774077">:=</span>&nbsp;<span class="ident" id="4774080">v</span><span class="op" id="4774081">.</span><span class="ident" id="4774082">Addr</span><span class="op" id="4774086">(</span><span class="op" id="4774087">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774090">if</span>&nbsp;<span class="ident" id="4774093">va</span><span class="op" id="4774095">.</span><span class="ident" id="4774096">IsNil</span><span class="op" id="4774101">(</span><span class="op" id="4774102">)</span>&nbsp;<span class="op" id="4774104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774108">e</span><span class="op" id="4774109">.</span><span class="ident" id="4774110">WriteString</span><span class="op" id="4774121">(</span><span class="string" id="4774122">&#34;null&#34;</span><span class="op" id="4774128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774132">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774143">m</span>&nbsp;<span class="op" id="4774145">:=</span>&nbsp;<span class="ident" id="4774148">va</span><span class="op" id="4774150">.</span><span class="ident" id="4774151">Interface</span><span class="op" id="4774160">(</span><span class="op" id="4774161">)</span><span class="op" id="4774162">.</span><span class="op" id="4774163">(</span><span class="ident" id="4774164">encoding</span><span class="op" id="4774172">.</span><span class="ident" id="4774173">TextMarshaler</span><span class="op" id="4774186">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774189">b</span><span class="op" id="4774190">,</span>&nbsp;<span class="ident" id="4774192">err</span>&nbsp;<span class="op" id="4774196">:=</span>&nbsp;<span class="ident" id="4774199">m</span><span class="op" id="4774200">.</span><span class="ident" id="4774201">MarshalText</span><span class="op" id="4774212">(</span><span class="op" id="4774213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774216">if</span>&nbsp;<span class="ident" id="4774219">err</span>&nbsp;<span class="op" id="4774223">==</span>&nbsp;<span class="ident" id="4774226">nil</span>&nbsp;<span class="op" id="4774230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774234">_</span><span class="op" id="4774235">,</span>&nbsp;<span class="ident" id="4774237">err</span>&nbsp;<span class="op" id="4774241">=</span>&nbsp;<span class="ident" id="4774243">e</span><span class="op" id="4774244">.</span><span class="ident" id="4774245">stringBytes</span><span class="op" id="4774256">(</span><span class="ident" id="4774257">b</span><span class="op" id="4774258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774264">if</span>&nbsp;<span class="ident" id="4774267">err</span>&nbsp;<span class="op" id="4774271">!=</span>&nbsp;<span class="ident" id="4774274">nil</span>&nbsp;<span class="op" id="4774278">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774282">e</span><span class="op" id="4774283">.</span><span class="builtintype" id="4774284">error</span><span class="op" id="4774289">(</span><span class="op" id="4774290">&amp;</span><span class="ident" id="4774291">MarshalerError</span><span class="op" id="4774305">{</span><span class="ident" id="4774306">v</span><span class="op" id="4774307">.</span><span class="ident" id="4774308">Type</span><span class="op" id="4774312">(</span><span class="op" id="4774313">)</span><span class="op" id="4774314">,</span>&nbsp;<span class="ident" id="4774316">err</span><span class="op" id="4774319">}</span><span class="op" id="4774320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774323">}</span><br>
<span class="lineno"></span><span class="op" id="4774325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4774328">func</span>&nbsp;<span class="ident" id="4774333">boolEncoder</span><span class="op" id="4774344">(</span><span class="ident" id="4774345">e</span>&nbsp;<span class="op" id="4774347">*</span><span class="ident" id="4774348">encodeState</span><span class="op" id="4774359">,</span>&nbsp;<span class="ident" id="4774361">v</span>&nbsp;<span class="ident" id="4774363">reflect</span><span class="op" id="4774370">.</span><span class="ident" id="4774371">Value</span><span class="op" id="4774376">,</span>&nbsp;<span class="ident" id="4774378">quoted</span>&nbsp;<span class="builtintype" id="4774385">bool</span><span class="op" id="4774389">)</span>&nbsp;<span class="op" id="4774391">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774394">if</span>&nbsp;<span class="ident" id="4774397">quoted</span>&nbsp;<span class="op" id="4774404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774408">e</span><span class="op" id="4774409">.</span><span class="ident" id="4774410">WriteByte</span><span class="op" id="4774419">(</span><span class="string" id="4774420">&#39;&#34;&#39;</span><span class="op" id="4774423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774429">if</span>&nbsp;<span class="ident" id="4774432">v</span><span class="op" id="4774433">.</span><span class="ident" id="4774434">Bool</span><span class="op" id="4774438">(</span><span class="op" id="4774439">)</span>&nbsp;<span class="op" id="4774441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774445">e</span><span class="op" id="4774446">.</span><span class="ident" id="4774447">WriteString</span><span class="op" id="4774458">(</span><span class="string" id="4774459">&#34;true&#34;</span><span class="op" id="4774465">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774468">}</span>&nbsp;<span class="keyword" id="4774470">else</span>&nbsp;<span class="op" id="4774475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774479">e</span><span class="op" id="4774480">.</span><span class="ident" id="4774481">WriteString</span><span class="op" id="4774492">(</span><span class="string" id="4774493">&#34;false&#34;</span><span class="op" id="4774500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774506">if</span>&nbsp;<span class="ident" id="4774509">quoted</span>&nbsp;<span class="op" id="4774516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774520">e</span><span class="op" id="4774521">.</span><span class="ident" id="4774522">WriteByte</span><span class="op" id="4774531">(</span><span class="string" id="4774532">&#39;&#34;&#39;</span><span class="op" id="4774535">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774538">}</span><br>
<span class="lineno"></span><span class="op" id="4774540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4774543">func</span>&nbsp;<span class="ident" id="4774548">intEncoder</span><span class="op" id="4774558">(</span><span class="ident" id="4774559">e</span>&nbsp;<span class="op" id="4774561">*</span><span class="ident" id="4774562">encodeState</span><span class="op" id="4774573">,</span>&nbsp;<span class="ident" id="4774575">v</span>&nbsp;<span class="ident" id="4774577">reflect</span><span class="op" id="4774584">.</span><span class="ident" id="4774585">Value</span><span class="op" id="4774590">,</span>&nbsp;<span class="ident" id="4774592">quoted</span>&nbsp;<span class="builtintype" id="4774599">bool</span><span class="op" id="4774603">)</span>&nbsp;<span class="op" id="4774605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774608">b</span>&nbsp;<span class="op" id="4774610">:=</span>&nbsp;<span class="ident" id="4774613">strconv</span><span class="op" id="4774620">.</span><span class="ident" id="4774621">AppendInt</span><span class="op" id="4774630">(</span><span class="ident" id="4774631">e</span><span class="op" id="4774632">.</span><span class="ident" id="4774633">scratch</span><span class="op" id="4774640">[</span><span class="op" id="4774641">:</span><span class="num" id="4774642">0</span><span class="op" id="4774643">]</span><span class="op" id="4774644">,</span>&nbsp;<span class="ident" id="4774646">v</span><span class="op" id="4774647">.</span><span class="ident" id="4774648">Int</span><span class="op" id="4774651">(</span><span class="op" id="4774652">)</span><span class="op" id="4774653">,</span>&nbsp;<span class="num" id="4774655">10</span><span class="op" id="4774657">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774660">if</span>&nbsp;<span class="ident" id="4774663">quoted</span>&nbsp;<span class="op" id="4774670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774674">e</span><span class="op" id="4774675">.</span><span class="ident" id="4774676">WriteByte</span><span class="op" id="4774685">(</span><span class="string" id="4774686">&#39;&#34;&#39;</span><span class="op" id="4774689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774695">e</span><span class="op" id="4774696">.</span><span class="ident" id="4774697">Write</span><span class="op" id="4774702">(</span><span class="ident" id="4774703">b</span><span class="op" id="4774704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774707">if</span>&nbsp;<span class="ident" id="4774710">quoted</span>&nbsp;<span class="op" id="4774717">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774721">e</span><span class="op" id="4774722">.</span><span class="ident" id="4774723">WriteByte</span><span class="op" id="4774732">(</span><span class="string" id="4774733">&#39;&#34;&#39;</span><span class="op" id="4774736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774739">}</span><br>
<span class="lineno"></span><span class="op" id="4774741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4774744">func</span>&nbsp;<span class="ident" id="4774749">uintEncoder</span><span class="op" id="4774760">(</span><span class="ident" id="4774761">e</span>&nbsp;<span class="op" id="4774763">*</span><span class="ident" id="4774764">encodeState</span><span class="op" id="4774775">,</span>&nbsp;<span class="ident" id="4774777">v</span>&nbsp;<span class="ident" id="4774779">reflect</span><span class="op" id="4774786">.</span><span class="ident" id="4774787">Value</span><span class="op" id="4774792">,</span>&nbsp;<span class="ident" id="4774794">quoted</span>&nbsp;<span class="builtintype" id="4774801">bool</span><span class="op" id="4774805">)</span>&nbsp;<span class="op" id="4774807">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774810">b</span>&nbsp;<span class="op" id="4774812">:=</span>&nbsp;<span class="ident" id="4774815">strconv</span><span class="op" id="4774822">.</span><span class="ident" id="4774823">AppendUint</span><span class="op" id="4774833">(</span><span class="ident" id="4774834">e</span><span class="op" id="4774835">.</span><span class="ident" id="4774836">scratch</span><span class="op" id="4774843">[</span><span class="op" id="4774844">:</span><span class="num" id="4774845">0</span><span class="op" id="4774846">]</span><span class="op" id="4774847">,</span>&nbsp;<span class="ident" id="4774849">v</span><span class="op" id="4774850">.</span><span class="ident" id="4774851">Uint</span><span class="op" id="4774855">(</span><span class="op" id="4774856">)</span><span class="op" id="4774857">,</span>&nbsp;<span class="num" id="4774859">10</span><span class="op" id="4774861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774864">if</span>&nbsp;<span class="ident" id="4774867">quoted</span>&nbsp;<span class="op" id="4774874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774878">e</span><span class="op" id="4774879">.</span><span class="ident" id="4774880">WriteByte</span><span class="op" id="4774889">(</span><span class="string" id="4774890">&#39;&#34;&#39;</span><span class="op" id="4774893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774899">e</span><span class="op" id="4774900">.</span><span class="ident" id="4774901">Write</span><span class="op" id="4774906">(</span><span class="ident" id="4774907">b</span><span class="op" id="4774908">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774911">if</span>&nbsp;<span class="ident" id="4774914">quoted</span>&nbsp;<span class="op" id="4774921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774925">e</span><span class="op" id="4774926">.</span><span class="ident" id="4774927">WriteByte</span><span class="op" id="4774936">(</span><span class="string" id="4774937">&#39;&#34;&#39;</span><span class="op" id="4774940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774943">}</span><br>
<span class="lineno"></span><span class="op" id="4774945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="4774948">type</span>&nbsp;<span class="ident" id="4774953">floatEncoder</span>&nbsp;<span class="builtintype" id="4774966">int</span>&nbsp;<span class="comment" id="4774970">//&nbsp;number&nbsp;of&nbsp;bits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4774989">func</span>&nbsp;<span class="op" id="4774994">(</span><span class="ident" id="4774995">bits</span>&nbsp;<span class="ident" id="4775000">floatEncoder</span><span class="op" id="4775012">)</span>&nbsp;<span class="ident" id="4775014">encode</span><span class="op" id="4775020">(</span><span class="ident" id="4775021">e</span>&nbsp;<span class="op" id="4775023">*</span><span class="ident" id="4775024">encodeState</span><span class="op" id="4775035">,</span>&nbsp;<span class="ident" id="4775037">v</span>&nbsp;<span class="ident" id="4775039">reflect</span><span class="op" id="4775046">.</span><span class="ident" id="4775047">Value</span><span class="op" id="4775052">,</span>&nbsp;<span class="ident" id="4775054">quoted</span>&nbsp;<span class="builtintype" id="4775061">bool</span><span class="op" id="4775065">)</span>&nbsp;<span class="op" id="4775067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775070">f</span>&nbsp;<span class="op" id="4775072">:=</span>&nbsp;<span class="ident" id="4775075">v</span><span class="op" id="4775076">.</span><span class="ident" id="4775077">Float</span><span class="op" id="4775082">(</span><span class="op" id="4775083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775086">if</span>&nbsp;<span class="ident" id="4775089">math</span><span class="op" id="4775093">.</span><span class="ident" id="4775094">IsInf</span><span class="op" id="4775099">(</span><span class="ident" id="4775100">f</span><span class="op" id="4775101">,</span>&nbsp;<span class="num" id="4775103">0</span><span class="op" id="4775104">)</span>&nbsp;<span class="op" id="4775106">||</span>&nbsp;<span class="ident" id="4775109">math</span><span class="op" id="4775113">.</span><span class="ident" id="4775114">IsNaN</span><span class="op" id="4775119">(</span><span class="ident" id="4775120">f</span><span class="op" id="4775121">)</span>&nbsp;<span class="op" id="4775123">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775127">e</span><span class="op" id="4775128">.</span><span class="builtintype" id="4775129">error</span><span class="op" id="4775134">(</span><span class="op" id="4775135">&amp;</span><span class="ident" id="4775136">UnsupportedValueError</span><span class="op" id="4775157">{</span><span class="ident" id="4775158">v</span><span class="op" id="4775159">,</span>&nbsp;<span class="ident" id="4775161">strconv</span><span class="op" id="4775168">.</span><span class="ident" id="4775169">FormatFloat</span><span class="op" id="4775180">(</span><span class="ident" id="4775181">f</span><span class="op" id="4775182">,</span>&nbsp;<span class="string" id="4775184">&#39;g&#39;</span><span class="op" id="4775187">,</span>&nbsp;<span class="op" id="4775189">-</span><span class="num" id="4775190">1</span><span class="op" id="4775191">,</span>&nbsp;<span class="builtintype" id="4775193">int</span><span class="op" id="4775196">(</span><span class="ident" id="4775197">bits</span><span class="op" id="4775201">)</span><span class="op" id="4775202">)</span><span class="op" id="4775203">}</span><span class="op" id="4775204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775210">b</span>&nbsp;<span class="op" id="4775212">:=</span>&nbsp;<span class="ident" id="4775215">strconv</span><span class="op" id="4775222">.</span><span class="ident" id="4775223">AppendFloat</span><span class="op" id="4775234">(</span><span class="ident" id="4775235">e</span><span class="op" id="4775236">.</span><span class="ident" id="4775237">scratch</span><span class="op" id="4775244">[</span><span class="op" id="4775245">:</span><span class="num" id="4775246">0</span><span class="op" id="4775247">]</span><span class="op" id="4775248">,</span>&nbsp;<span class="ident" id="4775250">f</span><span class="op" id="4775251">,</span>&nbsp;<span class="string" id="4775253">&#39;g&#39;</span><span class="op" id="4775256">,</span>&nbsp;<span class="op" id="4775258">-</span><span class="num" id="4775259">1</span><span class="op" id="4775260">,</span>&nbsp;<span class="builtintype" id="4775262">int</span><span class="op" id="4775265">(</span><span class="ident" id="4775266">bits</span><span class="op" id="4775270">)</span><span class="op" id="4775271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775274">if</span>&nbsp;<span class="ident" id="4775277">quoted</span>&nbsp;<span class="op" id="4775284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775288">e</span><span class="op" id="4775289">.</span><span class="ident" id="4775290">WriteByte</span><span class="op" id="4775299">(</span><span class="string" id="4775300">&#39;&#34;&#39;</span><span class="op" id="4775303">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775309">e</span><span class="op" id="4775310">.</span><span class="ident" id="4775311">Write</span><span class="op" id="4775316">(</span><span class="ident" id="4775317">b</span><span class="op" id="4775318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775321">if</span>&nbsp;<span class="ident" id="4775324">quoted</span>&nbsp;<span class="op" id="4775331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775335">e</span><span class="op" id="4775336">.</span><span class="ident" id="4775337">WriteByte</span><span class="op" id="4775346">(</span><span class="string" id="4775347">&#39;&#34;&#39;</span><span class="op" id="4775350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775353">}</span><br>
<span class="lineno">525</span><span class="op" id="4775355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4775358">var</span>&nbsp;<span class="op" id="4775362">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775365">float32Encoder</span>&nbsp;<span class="op" id="4775380">=</span>&nbsp;<span class="op" id="4775382">(</span><span class="ident" id="4775383">floatEncoder</span><span class="op" id="4775395">(</span><span class="num" id="4775396">32</span><span class="op" id="4775398">)</span><span class="op" id="4775399">)</span><span class="op" id="4775400">.</span><span class="ident" id="4775401">encode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775409">float64Encoder</span>&nbsp;<span class="op" id="4775424">=</span>&nbsp;<span class="op" id="4775426">(</span><span class="ident" id="4775427">floatEncoder</span><span class="op" id="4775439">(</span><span class="num" id="4775440">64</span><span class="op" id="4775442">)</span><span class="op" id="4775443">)</span><span class="op" id="4775444">.</span><span class="ident" id="4775445">encode</span><br>
<span class="lineno">530</span><span class="op" id="4775452">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4775455">func</span>&nbsp;<span class="ident" id="4775460">stringEncoder</span><span class="op" id="4775473">(</span><span class="ident" id="4775474">e</span>&nbsp;<span class="op" id="4775476">*</span><span class="ident" id="4775477">encodeState</span><span class="op" id="4775488">,</span>&nbsp;<span class="ident" id="4775490">v</span>&nbsp;<span class="ident" id="4775492">reflect</span><span class="op" id="4775499">.</span><span class="ident" id="4775500">Value</span><span class="op" id="4775505">,</span>&nbsp;<span class="ident" id="4775507">quoted</span>&nbsp;<span class="builtintype" id="4775514">bool</span><span class="op" id="4775518">)</span>&nbsp;<span class="op" id="4775520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775523">if</span>&nbsp;<span class="ident" id="4775526">v</span><span class="op" id="4775527">.</span><span class="ident" id="4775528">Type</span><span class="op" id="4775532">(</span><span class="op" id="4775533">)</span>&nbsp;<span class="op" id="4775535">==</span>&nbsp;<span class="ident" id="4775538">numberType</span>&nbsp;<span class="op" id="4775549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775553">numStr</span>&nbsp;<span class="op" id="4775560">:=</span>&nbsp;<span class="ident" id="4775563">v</span><span class="op" id="4775564">.</span><span class="ident" id="4775565">String</span><span class="op" id="4775571">(</span><span class="op" id="4775572">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775576">if</span>&nbsp;<span class="ident" id="4775579">numStr</span>&nbsp;<span class="op" id="4775586">==</span>&nbsp;<span class="string" id="4775589">&#34;&#34;</span>&nbsp;<span class="op" id="4775592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775597">numStr</span>&nbsp;<span class="op" id="4775604">=</span>&nbsp;<span class="string" id="4775606">&#34;0&#34;</span>&nbsp;<span class="comment" id="4775610">//&nbsp;Number&#39;s&nbsp;zero-val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775637">e</span><span class="op" id="4775638">.</span><span class="ident" id="4775639">WriteString</span><span class="op" id="4775650">(</span><span class="ident" id="4775651">numStr</span><span class="op" id="4775657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775661">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775672">if</span>&nbsp;<span class="ident" id="4775675">quoted</span>&nbsp;<span class="op" id="4775682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775686">sb</span><span class="op" id="4775688">,</span>&nbsp;<span class="ident" id="4775690">err</span>&nbsp;<span class="op" id="4775694">:=</span>&nbsp;<span class="ident" id="4775697">Marshal</span><span class="op" id="4775704">(</span><span class="ident" id="4775705">v</span><span class="op" id="4775706">.</span><span class="ident" id="4775707">String</span><span class="op" id="4775713">(</span><span class="op" id="4775714">)</span><span class="op" id="4775715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775719">if</span>&nbsp;<span class="ident" id="4775722">err</span>&nbsp;<span class="op" id="4775726">!=</span>&nbsp;<span class="ident" id="4775729">nil</span>&nbsp;<span class="op" id="4775733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775738">e</span><span class="op" id="4775739">.</span><span class="builtintype" id="4775740">error</span><span class="op" id="4775745">(</span><span class="ident" id="4775746">err</span><span class="op" id="4775749">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775757">e</span><span class="op" id="4775758">.</span><span class="builtintype" id="4775759">string</span><span class="op" id="4775765">(</span><span class="builtintype" id="4775766">string</span><span class="op" id="4775772">(</span><span class="ident" id="4775773">sb</span><span class="op" id="4775775">)</span><span class="op" id="4775776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775779">}</span>&nbsp;<span class="keyword" id="4775781">else</span>&nbsp;<span class="op" id="4775786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775790">e</span><span class="op" id="4775791">.</span><span class="builtintype" id="4775792">string</span><span class="op" id="4775798">(</span><span class="ident" id="4775799">v</span><span class="op" id="4775800">.</span><span class="ident" id="4775801">String</span><span class="op" id="4775807">(</span><span class="op" id="4775808">)</span><span class="op" id="4775809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775812">}</span><br>
<span class="lineno">550</span><span class="op" id="4775814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4775817">func</span>&nbsp;<span class="ident" id="4775822">interfaceEncoder</span><span class="op" id="4775838">(</span><span class="ident" id="4775839">e</span>&nbsp;<span class="op" id="4775841">*</span><span class="ident" id="4775842">encodeState</span><span class="op" id="4775853">,</span>&nbsp;<span class="ident" id="4775855">v</span>&nbsp;<span class="ident" id="4775857">reflect</span><span class="op" id="4775864">.</span><span class="ident" id="4775865">Value</span><span class="op" id="4775870">,</span>&nbsp;<span class="ident" id="4775872">quoted</span>&nbsp;<span class="builtintype" id="4775879">bool</span><span class="op" id="4775883">)</span>&nbsp;<span class="op" id="4775885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775888">if</span>&nbsp;<span class="ident" id="4775891">v</span><span class="op" id="4775892">.</span><span class="ident" id="4775893">IsNil</span><span class="op" id="4775898">(</span><span class="op" id="4775899">)</span>&nbsp;<span class="op" id="4775901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775905">e</span><span class="op" id="4775906">.</span><span class="ident" id="4775907">WriteString</span><span class="op" id="4775918">(</span><span class="string" id="4775919">&#34;null&#34;</span><span class="op" id="4775925">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775929">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775940">e</span><span class="op" id="4775941">.</span><span class="ident" id="4775942">reflectValue</span><span class="op" id="4775954">(</span><span class="ident" id="4775955">v</span><span class="op" id="4775956">.</span><span class="ident" id="4775957">Elem</span><span class="op" id="4775961">(</span><span class="op" id="4775962">)</span><span class="op" id="4775963">)</span><br>
<span class="lineno"></span><span class="op" id="4775965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span><span class="keyword" id="4775968">func</span>&nbsp;<span class="ident" id="4775973">unsupportedTypeEncoder</span><span class="op" id="4775995">(</span><span class="ident" id="4775996">e</span>&nbsp;<span class="op" id="4775998">*</span><span class="ident" id="4775999">encodeState</span><span class="op" id="4776010">,</span>&nbsp;<span class="ident" id="4776012">v</span>&nbsp;<span class="ident" id="4776014">reflect</span><span class="op" id="4776021">.</span><span class="ident" id="4776022">Value</span><span class="op" id="4776027">,</span>&nbsp;<span class="ident" id="4776029">quoted</span>&nbsp;<span class="builtintype" id="4776036">bool</span><span class="op" id="4776040">)</span>&nbsp;<span class="op" id="4776042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776045">e</span><span class="op" id="4776046">.</span><span class="builtintype" id="4776047">error</span><span class="op" id="4776052">(</span><span class="op" id="4776053">&amp;</span><span class="ident" id="4776054">UnsupportedTypeError</span><span class="op" id="4776074">{</span><span class="ident" id="4776075">v</span><span class="op" id="4776076">.</span><span class="ident" id="4776077">Type</span><span class="op" id="4776081">(</span><span class="op" id="4776082">)</span><span class="op" id="4776083">}</span><span class="op" id="4776084">)</span><br>
<span class="lineno"></span><span class="op" id="4776086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4776089">type</span>&nbsp;<span class="ident" id="4776094">structEncoder</span>&nbsp;<span class="keyword" id="4776108">struct</span>&nbsp;<span class="op" id="4776115">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776118">fields</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4776128">[</span><span class="op" id="4776129">]</span><span class="ident" id="4776130">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776137">fieldEncs</span>&nbsp;<span class="op" id="4776147">[</span><span class="op" id="4776148">]</span><span class="ident" id="4776149">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="4776161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4776164">func</span>&nbsp;<span class="op" id="4776169">(</span><span class="ident" id="4776170">se</span>&nbsp;<span class="op" id="4776173">*</span><span class="ident" id="4776174">structEncoder</span><span class="op" id="4776187">)</span>&nbsp;<span class="ident" id="4776189">encode</span><span class="op" id="4776195">(</span><span class="ident" id="4776196">e</span>&nbsp;<span class="op" id="4776198">*</span><span class="ident" id="4776199">encodeState</span><span class="op" id="4776210">,</span>&nbsp;<span class="ident" id="4776212">v</span>&nbsp;<span class="ident" id="4776214">reflect</span><span class="op" id="4776221">.</span><span class="ident" id="4776222">Value</span><span class="op" id="4776227">,</span>&nbsp;<span class="ident" id="4776229">quoted</span>&nbsp;<span class="builtintype" id="4776236">bool</span><span class="op" id="4776240">)</span>&nbsp;<span class="op" id="4776242">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776245">e</span><span class="op" id="4776246">.</span><span class="ident" id="4776247">WriteByte</span><span class="op" id="4776256">(</span><span class="string" id="4776257">&#39;{&#39;</span><span class="op" id="4776260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776263">first</span>&nbsp;<span class="op" id="4776269">:=</span>&nbsp;<span class="builtintype" id="4776272">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4776278">for</span>&nbsp;<span class="ident" id="4776282">i</span><span class="op" id="4776283">,</span>&nbsp;<span class="ident" id="4776285">f</span>&nbsp;<span class="op" id="4776287">:=</span>&nbsp;<span class="keyword" id="4776290">range</span>&nbsp;<span class="ident" id="4776296">se</span><span class="op" id="4776298">.</span><span class="ident" id="4776299">fields</span>&nbsp;<span class="op" id="4776306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776310">fv</span>&nbsp;<span class="op" id="4776313">:=</span>&nbsp;<span class="ident" id="4776316">fieldByIndex</span><span class="op" id="4776328">(</span><span class="ident" id="4776329">v</span><span class="op" id="4776330">,</span>&nbsp;<span class="ident" id="4776332">f</span><span class="op" id="4776333">.</span><span class="ident" id="4776334">index</span><span class="op" id="4776339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4776343">if</span>&nbsp;<span class="op" id="4776346">!</span><span class="ident" id="4776347">fv</span><span class="op" id="4776349">.</span><span class="ident" id="4776350">IsValid</span><span class="op" id="4776357">(</span><span class="op" id="4776358">)</span>&nbsp;<span class="op" id="4776360">||</span>&nbsp;<span class="ident" id="4776363">f</span><span class="op" id="4776364">.</span><span class="ident" id="4776365">omitEmpty</span>&nbsp;<span class="op" id="4776375">&amp;&amp;</span>&nbsp;<span class="ident" id="4776378">isEmptyValue</span><span class="op" id="4776390">(</span><span class="ident" id="4776391">fv</span><span class="op" id="4776393">)</span>&nbsp;<span class="op" id="4776395">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4776400">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4776411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4776415">if</span>&nbsp;<span class="ident" id="4776418">first</span>&nbsp;<span class="op" id="4776424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776429">first</span>&nbsp;<span class="op" id="4776435">=</span>&nbsp;<span class="builtintype" id="4776437">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4776445">}</span>&nbsp;<span class="keyword" id="4776447">else</span>&nbsp;<span class="op" id="4776452">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776457">e</span><span class="op" id="4776458">.</span><span class="ident" id="4776459">WriteByte</span><span class="op" id="4776468">(</span><span class="string" id="4776469">&#39;,&#39;</span><span class="op" id="4776472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4776476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776480">e</span><span class="op" id="4776481">.</span><span class="builtintype" id="4776482">string</span><span class="op" id="4776488">(</span><span class="ident" id="4776489">f</span><span class="op" id="4776490">.</span><span class="ident" id="4776491">name</span><span class="op" id="4776495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776499">e</span><span class="op" id="4776500">.</span><span class="ident" id="4776501">WriteByte</span><span class="op" id="4776510">(</span><span class="string" id="4776511">&#39;:&#39;</span><span class="op" id="4776514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776518">se</span><span class="op" id="4776520">.</span><span class="ident" id="4776521">fieldEncs</span><span class="op" id="4776530">[</span><span class="ident" id="4776531">i</span><span class="op" id="4776532">]</span><span class="op" id="4776533">(</span><span class="ident" id="4776534">e</span><span class="op" id="4776535">,</span>&nbsp;<span class="ident" id="4776537">fv</span><span class="op" id="4776539">,</span>&nbsp;<span class="ident" id="4776541">f</span><span class="op" id="4776542">.</span><span class="ident" id="4776543">quoted</span><span class="op" id="4776549">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4776552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776555">e</span><span class="op" id="4776556">.</span><span class="ident" id="4776557">WriteByte</span><span class="op" id="4776566">(</span><span class="string" id="4776567">&#39;}&#39;</span><span class="op" id="4776570">)</span><br>
<span class="lineno"></span><span class="op" id="4776572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4776575">func</span>&nbsp;<span class="ident" id="4776580">newStructEncoder</span><span class="op" id="4776596">(</span><span class="ident" id="4776597">t</span>&nbsp;<span class="ident" id="4776599">reflect</span><span class="op" id="4776606">.</span><span class="ident" id="4776607">Type</span><span class="op" id="4776611">)</span>&nbsp;<span class="ident" id="4776613">encoderFunc</span>&nbsp;<span class="op" id="4776625">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776628">fields</span>&nbsp;<span class="op" id="4776635">:=</span>&nbsp;<span class="ident" id="4776638">cachedTypeFields</span><span class="op" id="4776654">(</span><span class="ident" id="4776655">t</span><span class="op" id="4776656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776659">se</span>&nbsp;<span class="op" id="4776662">:=</span>&nbsp;<span class="op" id="4776665">&amp;</span><span class="ident" id="4776666">structEncoder</span><span class="op" id="4776679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776683">fields</span><span class="op" id="4776689">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776694">fields</span><span class="op" id="4776700">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776704">fieldEncs</span><span class="op" id="4776713">:</span>&nbsp;<span class="builtinfunc" id="4776715">make</span><span class="op" id="4776719">(</span><span class="op" id="4776720">[</span><span class="op" id="4776721">]</span><span class="ident" id="4776722">encoderFunc</span><span class="op" id="4776733">,</span>&nbsp;<span class="builtinfunc" id="4776735">len</span><span class="op" id="4776738">(</span><span class="ident" id="4776739">fields</span><span class="op" id="4776745">)</span><span class="op" id="4776746">)</span><span class="op" id="4776747">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4776750">}</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4776753">for</span>&nbsp;<span class="ident" id="4776757">i</span><span class="op" id="4776758">,</span>&nbsp;<span class="ident" id="4776760">f</span>&nbsp;<span class="op" id="4776762">:=</span>&nbsp;<span class="keyword" id="4776765">range</span>&nbsp;<span class="ident" id="4776771">fields</span>&nbsp;<span class="op" id="4776778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776782">se</span><span class="op" id="4776784">.</span><span class="ident" id="4776785">fieldEncs</span><span class="op" id="4776794">[</span><span class="ident" id="4776795">i</span><span class="op" id="4776796">]</span>&nbsp;<span class="op" id="4776798">=</span>&nbsp;<span class="ident" id="4776800">typeEncoder</span><span class="op" id="4776811">(</span><span class="ident" id="4776812">typeByIndex</span><span class="op" id="4776823">(</span><span class="ident" id="4776824">t</span><span class="op" id="4776825">,</span>&nbsp;<span class="ident" id="4776827">f</span><span class="op" id="4776828">.</span><span class="ident" id="4776829">index</span><span class="op" id="4776834">)</span><span class="op" id="4776835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4776838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4776841">return</span>&nbsp;<span class="ident" id="4776848">se</span><span class="op" id="4776850">.</span><span class="ident" id="4776851">encode</span><br>
<span class="lineno"></span><span class="op" id="4776858">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="4776861">type</span>&nbsp;<span class="ident" id="4776866">mapEncoder</span>&nbsp;<span class="keyword" id="4776877">struct</span>&nbsp;<span class="op" id="4776884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776887">elemEnc</span>&nbsp;<span class="ident" id="4776895">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="4776907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span><span class="keyword" id="4776910">func</span>&nbsp;<span class="op" id="4776915">(</span><span class="ident" id="4776916">me</span>&nbsp;<span class="op" id="4776919">*</span><span class="ident" id="4776920">mapEncoder</span><span class="op" id="4776930">)</span>&nbsp;<span class="ident" id="4776932">encode</span><span class="op" id="4776938">(</span><span class="ident" id="4776939">e</span>&nbsp;<span class="op" id="4776941">*</span><span class="ident" id="4776942">encodeState</span><span class="op" id="4776953">,</span>&nbsp;<span class="ident" id="4776955">v</span>&nbsp;<span class="ident" id="4776957">reflect</span><span class="op" id="4776964">.</span><span class="ident" id="4776965">Value</span><span class="op" id="4776970">,</span>&nbsp;<span class="ident" id="4776972">_</span>&nbsp;<span class="builtintype" id="4776974">bool</span><span class="op" id="4776978">)</span>&nbsp;<span class="op" id="4776980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4776983">if</span>&nbsp;<span class="ident" id="4776986">v</span><span class="op" id="4776987">.</span><span class="ident" id="4776988">IsNil</span><span class="op" id="4776993">(</span><span class="op" id="4776994">)</span>&nbsp;<span class="op" id="4776996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777000">e</span><span class="op" id="4777001">.</span><span class="ident" id="4777002">WriteString</span><span class="op" id="4777013">(</span><span class="string" id="4777014">&#34;null&#34;</span><span class="op" id="4777020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777024">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777032">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777035">e</span><span class="op" id="4777036">.</span><span class="ident" id="4777037">WriteByte</span><span class="op" id="4777046">(</span><span class="string" id="4777047">&#39;{&#39;</span><span class="op" id="4777050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777053">var</span>&nbsp;<span class="ident" id="4777057">sv</span>&nbsp;<span class="ident" id="4777060">stringValues</span>&nbsp;<span class="op" id="4777073">=</span>&nbsp;<span class="ident" id="4777075">v</span><span class="op" id="4777076">.</span><span class="ident" id="4777077">MapKeys</span><span class="op" id="4777084">(</span><span class="op" id="4777085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777088">sort</span><span class="op" id="4777092">.</span><span class="ident" id="4777093">Sort</span><span class="op" id="4777097">(</span><span class="ident" id="4777098">sv</span><span class="op" id="4777100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777103">for</span>&nbsp;<span class="ident" id="4777107">i</span><span class="op" id="4777108">,</span>&nbsp;<span class="ident" id="4777110">k</span>&nbsp;<span class="op" id="4777112">:=</span>&nbsp;<span class="keyword" id="4777115">range</span>&nbsp;<span class="ident" id="4777121">sv</span>&nbsp;<span class="op" id="4777124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777128">if</span>&nbsp;<span class="ident" id="4777131">i</span>&nbsp;<span class="op" id="4777133">&gt;</span>&nbsp;<span class="num" id="4777135">0</span>&nbsp;<span class="op" id="4777137">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777142">e</span><span class="op" id="4777143">.</span><span class="ident" id="4777144">WriteByte</span><span class="op" id="4777153">(</span><span class="string" id="4777154">&#39;,&#39;</span><span class="op" id="4777157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777165">e</span><span class="op" id="4777166">.</span><span class="builtintype" id="4777167">string</span><span class="op" id="4777173">(</span><span class="ident" id="4777174">k</span><span class="op" id="4777175">.</span><span class="ident" id="4777176">String</span><span class="op" id="4777182">(</span><span class="op" id="4777183">)</span><span class="op" id="4777184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777188">e</span><span class="op" id="4777189">.</span><span class="ident" id="4777190">WriteByte</span><span class="op" id="4777199">(</span><span class="string" id="4777200">&#39;:&#39;</span><span class="op" id="4777203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777207">me</span><span class="op" id="4777209">.</span><span class="ident" id="4777210">elemEnc</span><span class="op" id="4777217">(</span><span class="ident" id="4777218">e</span><span class="op" id="4777219">,</span>&nbsp;<span class="ident" id="4777221">v</span><span class="op" id="4777222">.</span><span class="ident" id="4777223">MapIndex</span><span class="op" id="4777231">(</span><span class="ident" id="4777232">k</span><span class="op" id="4777233">)</span><span class="op" id="4777234">,</span>&nbsp;<span class="builtintype" id="4777236">false</span><span class="op" id="4777241">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777247">e</span><span class="op" id="4777248">.</span><span class="ident" id="4777249">WriteByte</span><span class="op" id="4777258">(</span><span class="string" id="4777259">&#39;}&#39;</span><span class="op" id="4777262">)</span><br>
<span class="lineno"></span><span class="op" id="4777264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4777267">func</span>&nbsp;<span class="ident" id="4777272">newMapEncoder</span><span class="op" id="4777285">(</span><span class="ident" id="4777286">t</span>&nbsp;<span class="ident" id="4777288">reflect</span><span class="op" id="4777295">.</span><span class="ident" id="4777296">Type</span><span class="op" id="4777300">)</span>&nbsp;<span class="ident" id="4777302">encoderFunc</span>&nbsp;<span class="op" id="4777314">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777317">if</span>&nbsp;<span class="ident" id="4777320">t</span><span class="op" id="4777321">.</span><span class="ident" id="4777322">Key</span><span class="op" id="4777325">(</span><span class="op" id="4777326">)</span><span class="op" id="4777327">.</span><span class="ident" id="4777328">Kind</span><span class="op" id="4777332">(</span><span class="op" id="4777333">)</span>&nbsp;<span class="op" id="4777335">!=</span>&nbsp;<span class="ident" id="4777338">reflect</span><span class="op" id="4777345">.</span><span class="ident" id="4777346">String</span>&nbsp;<span class="op" id="4777353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777357">return</span>&nbsp;<span class="ident" id="4777364">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777391">me</span>&nbsp;<span class="op" id="4777394">:=</span>&nbsp;<span class="op" id="4777397">&amp;</span><span class="ident" id="4777398">mapEncoder</span><span class="op" id="4777408">{</span><span class="ident" id="4777409">typeEncoder</span><span class="op" id="4777420">(</span><span class="ident" id="4777421">t</span><span class="op" id="4777422">.</span><span class="ident" id="4777423">Elem</span><span class="op" id="4777427">(</span><span class="op" id="4777428">)</span><span class="op" id="4777429">)</span><span class="op" id="4777430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777433">return</span>&nbsp;<span class="ident" id="4777440">me</span><span class="op" id="4777442">.</span><span class="ident" id="4777443">encode</span><br>
<span class="lineno">630</span><span class="op" id="4777450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4777453">func</span>&nbsp;<span class="ident" id="4777458">encodeByteSlice</span><span class="op" id="4777473">(</span><span class="ident" id="4777474">e</span>&nbsp;<span class="op" id="4777476">*</span><span class="ident" id="4777477">encodeState</span><span class="op" id="4777488">,</span>&nbsp;<span class="ident" id="4777490">v</span>&nbsp;<span class="ident" id="4777492">reflect</span><span class="op" id="4777499">.</span><span class="ident" id="4777500">Value</span><span class="op" id="4777505">,</span>&nbsp;<span class="ident" id="4777507">_</span>&nbsp;<span class="builtintype" id="4777509">bool</span><span class="op" id="4777513">)</span>&nbsp;<span class="op" id="4777515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777518">if</span>&nbsp;<span class="ident" id="4777521">v</span><span class="op" id="4777522">.</span><span class="ident" id="4777523">IsNil</span><span class="op" id="4777528">(</span><span class="op" id="4777529">)</span>&nbsp;<span class="op" id="4777531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777535">e</span><span class="op" id="4777536">.</span><span class="ident" id="4777537">WriteString</span><span class="op" id="4777548">(</span><span class="string" id="4777549">&#34;null&#34;</span><span class="op" id="4777555">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777559">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777570">s</span>&nbsp;<span class="op" id="4777572">:=</span>&nbsp;<span class="ident" id="4777575">v</span><span class="op" id="4777576">.</span><span class="ident" id="4777577">Bytes</span><span class="op" id="4777582">(</span><span class="op" id="4777583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777586">e</span><span class="op" id="4777587">.</span><span class="ident" id="4777588">WriteByte</span><span class="op" id="4777597">(</span><span class="string" id="4777598">&#39;&#34;&#39;</span><span class="op" id="4777601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777604">if</span>&nbsp;<span class="builtinfunc" id="4777607">len</span><span class="op" id="4777610">(</span><span class="ident" id="4777611">s</span><span class="op" id="4777612">)</span>&nbsp;<span class="op" id="4777614">&lt;</span>&nbsp;<span class="num" id="4777616">1024</span>&nbsp;<span class="op" id="4777621">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4777625">//&nbsp;for&nbsp;small&nbsp;buffers,&nbsp;using&nbsp;Encode&nbsp;directly&nbsp;is&nbsp;much&nbsp;faster.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777687">dst</span>&nbsp;<span class="op" id="4777691">:=</span>&nbsp;<span class="builtinfunc" id="4777694">make</span><span class="op" id="4777698">(</span><span class="op" id="4777699">[</span><span class="op" id="4777700">]</span><span class="builtintype" id="4777701">byte</span><span class="op" id="4777705">,</span>&nbsp;<span class="ident" id="4777707">base64</span><span class="op" id="4777713">.</span><span class="ident" id="4777714">StdEncoding</span><span class="op" id="4777725">.</span><span class="ident" id="4777726">EncodedLen</span><span class="op" id="4777736">(</span><span class="builtinfunc" id="4777737">len</span><span class="op" id="4777740">(</span><span class="ident" id="4777741">s</span><span class="op" id="4777742">)</span><span class="op" id="4777743">)</span><span class="op" id="4777744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777748">base64</span><span class="op" id="4777754">.</span><span class="ident" id="4777755">StdEncoding</span><span class="op" id="4777766">.</span><span class="ident" id="4777767">Encode</span><span class="op" id="4777773">(</span><span class="ident" id="4777774">dst</span><span class="op" id="4777777">,</span>&nbsp;<span class="ident" id="4777779">s</span><span class="op" id="4777780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777784">e</span><span class="op" id="4777785">.</span><span class="ident" id="4777786">Write</span><span class="op" id="4777791">(</span><span class="ident" id="4777792">dst</span><span class="op" id="4777795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777798">}</span>&nbsp;<span class="keyword" id="4777800">else</span>&nbsp;<span class="op" id="4777805">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4777809">//&nbsp;for&nbsp;large&nbsp;buffers,&nbsp;avoid&nbsp;unnecessary&nbsp;extra&nbsp;temporary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4777867">//&nbsp;buffer&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777886">enc</span>&nbsp;<span class="op" id="4777890">:=</span>&nbsp;<span class="ident" id="4777893">base64</span><span class="op" id="4777899">.</span><span class="ident" id="4777900">NewEncoder</span><span class="op" id="4777910">(</span><span class="ident" id="4777911">base64</span><span class="op" id="4777917">.</span><span class="ident" id="4777918">StdEncoding</span><span class="op" id="4777929">,</span>&nbsp;<span class="ident" id="4777931">e</span><span class="op" id="4777932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777936">enc</span><span class="op" id="4777939">.</span><span class="ident" id="4777940">Write</span><span class="op" id="4777945">(</span><span class="ident" id="4777946">s</span><span class="op" id="4777947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777951">enc</span><span class="op" id="4777954">.</span><span class="ident" id="4777955">Close</span><span class="op" id="4777960">(</span><span class="op" id="4777961">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777967">e</span><span class="op" id="4777968">.</span><span class="ident" id="4777969">WriteByte</span><span class="op" id="4777978">(</span><span class="string" id="4777979">&#39;&#34;&#39;</span><span class="op" id="4777982">)</span><br>
<span class="lineno"></span><span class="op" id="4777984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4777987">//&nbsp;sliceEncoder&nbsp;just&nbsp;wraps&nbsp;an&nbsp;arrayEncoder,&nbsp;checking&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;value&nbsp;isn&#39;t&nbsp;nil.</span><br>
<span class="lineno">655</span><span class="keyword" id="4778074">type</span>&nbsp;<span class="ident" id="4778079">sliceEncoder</span>&nbsp;<span class="keyword" id="4778092">struct</span>&nbsp;<span class="op" id="4778099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778102">arrayEnc</span>&nbsp;<span class="ident" id="4778111">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="4778123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4778126">func</span>&nbsp;<span class="op" id="4778131">(</span><span class="ident" id="4778132">se</span>&nbsp;<span class="op" id="4778135">*</span><span class="ident" id="4778136">sliceEncoder</span><span class="op" id="4778148">)</span>&nbsp;<span class="ident" id="4778150">encode</span><span class="op" id="4778156">(</span><span class="ident" id="4778157">e</span>&nbsp;<span class="op" id="4778159">*</span><span class="ident" id="4778160">encodeState</span><span class="op" id="4778171">,</span>&nbsp;<span class="ident" id="4778173">v</span>&nbsp;<span class="ident" id="4778175">reflect</span><span class="op" id="4778182">.</span><span class="ident" id="4778183">Value</span><span class="op" id="4778188">,</span>&nbsp;<span class="ident" id="4778190">_</span>&nbsp;<span class="builtintype" id="4778192">bool</span><span class="op" id="4778196">)</span>&nbsp;<span class="op" id="4778198">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778201">if</span>&nbsp;<span class="ident" id="4778204">v</span><span class="op" id="4778205">.</span><span class="ident" id="4778206">IsNil</span><span class="op" id="4778211">(</span><span class="op" id="4778212">)</span>&nbsp;<span class="op" id="4778214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778218">e</span><span class="op" id="4778219">.</span><span class="ident" id="4778220">WriteString</span><span class="op" id="4778231">(</span><span class="string" id="4778232">&#34;null&#34;</span><span class="op" id="4778238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778242">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778253">se</span><span class="op" id="4778255">.</span><span class="ident" id="4778256">arrayEnc</span><span class="op" id="4778264">(</span><span class="ident" id="4778265">e</span><span class="op" id="4778266">,</span>&nbsp;<span class="ident" id="4778268">v</span><span class="op" id="4778269">,</span>&nbsp;<span class="builtintype" id="4778271">false</span><span class="op" id="4778276">)</span><br>
<span class="lineno">665</span><span class="op" id="4778278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4778281">func</span>&nbsp;<span class="ident" id="4778286">newSliceEncoder</span><span class="op" id="4778301">(</span><span class="ident" id="4778302">t</span>&nbsp;<span class="ident" id="4778304">reflect</span><span class="op" id="4778311">.</span><span class="ident" id="4778312">Type</span><span class="op" id="4778316">)</span>&nbsp;<span class="ident" id="4778318">encoderFunc</span>&nbsp;<span class="op" id="4778330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4778333">//&nbsp;Byte&nbsp;slices&nbsp;get&nbsp;special&nbsp;treatment;&nbsp;arrays&nbsp;don&#39;t.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778386">if</span>&nbsp;<span class="ident" id="4778389">t</span><span class="op" id="4778390">.</span><span class="ident" id="4778391">Elem</span><span class="op" id="4778395">(</span><span class="op" id="4778396">)</span><span class="op" id="4778397">.</span><span class="ident" id="4778398">Kind</span><span class="op" id="4778402">(</span><span class="op" id="4778403">)</span>&nbsp;<span class="op" id="4778405">==</span>&nbsp;<span class="ident" id="4778408">reflect</span><span class="op" id="4778415">.</span><span class="ident" id="4778416">Uint8</span>&nbsp;<span class="op" id="4778422">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778426">return</span>&nbsp;<span class="ident" id="4778433">encodeByteSlice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778453">enc</span>&nbsp;<span class="op" id="4778457">:=</span>&nbsp;<span class="op" id="4778460">&amp;</span><span class="ident" id="4778461">sliceEncoder</span><span class="op" id="4778473">{</span><span class="ident" id="4778474">newArrayEncoder</span><span class="op" id="4778489">(</span><span class="ident" id="4778490">t</span><span class="op" id="4778491">)</span><span class="op" id="4778492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778495">return</span>&nbsp;<span class="ident" id="4778502">enc</span><span class="op" id="4778505">.</span><span class="ident" id="4778506">encode</span><br>
<span class="lineno"></span><span class="op" id="4778513">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="keyword" id="4778516">type</span>&nbsp;<span class="ident" id="4778521">arrayEncoder</span>&nbsp;<span class="keyword" id="4778534">struct</span>&nbsp;<span class="op" id="4778541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778544">elemEnc</span>&nbsp;<span class="ident" id="4778552">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="4778564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="keyword" id="4778567">func</span>&nbsp;<span class="op" id="4778572">(</span><span class="ident" id="4778573">ae</span>&nbsp;<span class="op" id="4778576">*</span><span class="ident" id="4778577">arrayEncoder</span><span class="op" id="4778589">)</span>&nbsp;<span class="ident" id="4778591">encode</span><span class="op" id="4778597">(</span><span class="ident" id="4778598">e</span>&nbsp;<span class="op" id="4778600">*</span><span class="ident" id="4778601">encodeState</span><span class="op" id="4778612">,</span>&nbsp;<span class="ident" id="4778614">v</span>&nbsp;<span class="ident" id="4778616">reflect</span><span class="op" id="4778623">.</span><span class="ident" id="4778624">Value</span><span class="op" id="4778629">,</span>&nbsp;<span class="ident" id="4778631">_</span>&nbsp;<span class="builtintype" id="4778633">bool</span><span class="op" id="4778637">)</span>&nbsp;<span class="op" id="4778639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778642">e</span><span class="op" id="4778643">.</span><span class="ident" id="4778644">WriteByte</span><span class="op" id="4778653">(</span><span class="string" id="4778654">&#39;[&#39;</span><span class="op" id="4778657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778660">n</span>&nbsp;<span class="op" id="4778662">:=</span>&nbsp;<span class="ident" id="4778665">v</span><span class="op" id="4778666">.</span><span class="ident" id="4778667">Len</span><span class="op" id="4778670">(</span><span class="op" id="4778671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778674">for</span>&nbsp;<span class="ident" id="4778678">i</span>&nbsp;<span class="op" id="4778680">:=</span>&nbsp;<span class="num" id="4778683">0</span><span class="op" id="4778684">;</span>&nbsp;<span class="ident" id="4778686">i</span>&nbsp;<span class="op" id="4778688">&lt;</span>&nbsp;<span class="ident" id="4778690">n</span><span class="op" id="4778691">;</span>&nbsp;<span class="ident" id="4778693">i</span><span class="op" id="4778694">++</span>&nbsp;<span class="op" id="4778697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778701">if</span>&nbsp;<span class="ident" id="4778704">i</span>&nbsp;<span class="op" id="4778706">&gt;</span>&nbsp;<span class="num" id="4778708">0</span>&nbsp;<span class="op" id="4778710">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778715">e</span><span class="op" id="4778716">.</span><span class="ident" id="4778717">WriteByte</span><span class="op" id="4778726">(</span><span class="string" id="4778727">&#39;,&#39;</span><span class="op" id="4778730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778738">ae</span><span class="op" id="4778740">.</span><span class="ident" id="4778741">elemEnc</span><span class="op" id="4778748">(</span><span class="ident" id="4778749">e</span><span class="op" id="4778750">,</span>&nbsp;<span class="ident" id="4778752">v</span><span class="op" id="4778753">.</span><span class="ident" id="4778754">Index</span><span class="op" id="4778759">(</span><span class="ident" id="4778760">i</span><span class="op" id="4778761">)</span><span class="op" id="4778762">,</span>&nbsp;<span class="builtintype" id="4778764">false</span><span class="op" id="4778769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778775">e</span><span class="op" id="4778776">.</span><span class="ident" id="4778777">WriteByte</span><span class="op" id="4778786">(</span><span class="string" id="4778787">&#39;]&#39;</span><span class="op" id="4778790">)</span><br>
<span class="lineno">690</span><span class="op" id="4778792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4778795">func</span>&nbsp;<span class="ident" id="4778800">newArrayEncoder</span><span class="op" id="4778815">(</span><span class="ident" id="4778816">t</span>&nbsp;<span class="ident" id="4778818">reflect</span><span class="op" id="4778825">.</span><span class="ident" id="4778826">Type</span><span class="op" id="4778830">)</span>&nbsp;<span class="ident" id="4778832">encoderFunc</span>&nbsp;<span class="op" id="4778844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778847">enc</span>&nbsp;<span class="op" id="4778851">:=</span>&nbsp;<span class="op" id="4778854">&amp;</span><span class="ident" id="4778855">arrayEncoder</span><span class="op" id="4778867">{</span><span class="ident" id="4778868">typeEncoder</span><span class="op" id="4778879">(</span><span class="ident" id="4778880">t</span><span class="op" id="4778881">.</span><span class="ident" id="4778882">Elem</span><span class="op" id="4778886">(</span><span class="op" id="4778887">)</span><span class="op" id="4778888">)</span><span class="op" id="4778889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778892">return</span>&nbsp;<span class="ident" id="4778899">enc</span><span class="op" id="4778902">.</span><span class="ident" id="4778903">encode</span><br>
<span class="lineno">695</span><span class="op" id="4778910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4778913">type</span>&nbsp;<span class="ident" id="4778918">ptrEncoder</span>&nbsp;<span class="keyword" id="4778929">struct</span>&nbsp;<span class="op" id="4778936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778939">elemEnc</span>&nbsp;<span class="ident" id="4778947">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="4778959">}</span><br>
<span class="lineno">700</span><br>
<span class="lineno"></span><span class="keyword" id="4778962">func</span>&nbsp;<span class="op" id="4778967">(</span><span class="ident" id="4778968">pe</span>&nbsp;<span class="op" id="4778971">*</span><span class="ident" id="4778972">ptrEncoder</span><span class="op" id="4778982">)</span>&nbsp;<span class="ident" id="4778984">encode</span><span class="op" id="4778990">(</span><span class="ident" id="4778991">e</span>&nbsp;<span class="op" id="4778993">*</span><span class="ident" id="4778994">encodeState</span><span class="op" id="4779005">,</span>&nbsp;<span class="ident" id="4779007">v</span>&nbsp;<span class="ident" id="4779009">reflect</span><span class="op" id="4779016">.</span><span class="ident" id="4779017">Value</span><span class="op" id="4779022">,</span>&nbsp;<span class="ident" id="4779024">quoted</span>&nbsp;<span class="builtintype" id="4779031">bool</span><span class="op" id="4779035">)</span>&nbsp;<span class="op" id="4779037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779040">if</span>&nbsp;<span class="ident" id="4779043">v</span><span class="op" id="4779044">.</span><span class="ident" id="4779045">IsNil</span><span class="op" id="4779050">(</span><span class="op" id="4779051">)</span>&nbsp;<span class="op" id="4779053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779057">e</span><span class="op" id="4779058">.</span><span class="ident" id="4779059">WriteString</span><span class="op" id="4779070">(</span><span class="string" id="4779071">&#34;null&#34;</span><span class="op" id="4779077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779081">return</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779092">pe</span><span class="op" id="4779094">.</span><span class="ident" id="4779095">elemEnc</span><span class="op" id="4779102">(</span><span class="ident" id="4779103">e</span><span class="op" id="4779104">,</span>&nbsp;<span class="ident" id="4779106">v</span><span class="op" id="4779107">.</span><span class="ident" id="4779108">Elem</span><span class="op" id="4779112">(</span><span class="op" id="4779113">)</span><span class="op" id="4779114">,</span>&nbsp;<span class="ident" id="4779116">quoted</span><span class="op" id="4779122">)</span><br>
<span class="lineno"></span><span class="op" id="4779124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4779127">func</span>&nbsp;<span class="ident" id="4779132">newPtrEncoder</span><span class="op" id="4779145">(</span><span class="ident" id="4779146">t</span>&nbsp;<span class="ident" id="4779148">reflect</span><span class="op" id="4779155">.</span><span class="ident" id="4779156">Type</span><span class="op" id="4779160">)</span>&nbsp;<span class="ident" id="4779162">encoderFunc</span>&nbsp;<span class="op" id="4779174">{</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779177">enc</span>&nbsp;<span class="op" id="4779181">:=</span>&nbsp;<span class="op" id="4779184">&amp;</span><span class="ident" id="4779185">ptrEncoder</span><span class="op" id="4779195">{</span><span class="ident" id="4779196">typeEncoder</span><span class="op" id="4779207">(</span><span class="ident" id="4779208">t</span><span class="op" id="4779209">.</span><span class="ident" id="4779210">Elem</span><span class="op" id="4779214">(</span><span class="op" id="4779215">)</span><span class="op" id="4779216">)</span><span class="op" id="4779217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779220">return</span>&nbsp;<span class="ident" id="4779227">enc</span><span class="op" id="4779230">.</span><span class="ident" id="4779231">encode</span><br>
<span class="lineno"></span><span class="op" id="4779238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4779241">type</span>&nbsp;<span class="ident" id="4779246">condAddrEncoder</span>&nbsp;<span class="keyword" id="4779262">struct</span>&nbsp;<span class="op" id="4779269">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779272">canAddrEnc</span><span class="op" id="4779282">,</span>&nbsp;<span class="ident" id="4779284">elseEnc</span>&nbsp;<span class="ident" id="4779292">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="4779304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4779307">func</span>&nbsp;<span class="op" id="4779312">(</span><span class="ident" id="4779313">ce</span>&nbsp;<span class="op" id="4779316">*</span><span class="ident" id="4779317">condAddrEncoder</span><span class="op" id="4779332">)</span>&nbsp;<span class="ident" id="4779334">encode</span><span class="op" id="4779340">(</span><span class="ident" id="4779341">e</span>&nbsp;<span class="op" id="4779343">*</span><span class="ident" id="4779344">encodeState</span><span class="op" id="4779355">,</span>&nbsp;<span class="ident" id="4779357">v</span>&nbsp;<span class="ident" id="4779359">reflect</span><span class="op" id="4779366">.</span><span class="ident" id="4779367">Value</span><span class="op" id="4779372">,</span>&nbsp;<span class="ident" id="4779374">quoted</span>&nbsp;<span class="builtintype" id="4779381">bool</span><span class="op" id="4779385">)</span>&nbsp;<span class="op" id="4779387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779390">if</span>&nbsp;<span class="ident" id="4779393">v</span><span class="op" id="4779394">.</span><span class="ident" id="4779395">CanAddr</span><span class="op" id="4779402">(</span><span class="op" id="4779403">)</span>&nbsp;<span class="op" id="4779405">{</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779409">ce</span><span class="op" id="4779411">.</span><span class="ident" id="4779412">canAddrEnc</span><span class="op" id="4779422">(</span><span class="ident" id="4779423">e</span><span class="op" id="4779424">,</span>&nbsp;<span class="ident" id="4779426">v</span><span class="op" id="4779427">,</span>&nbsp;<span class="ident" id="4779429">quoted</span><span class="op" id="4779435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779438">}</span>&nbsp;<span class="keyword" id="4779440">else</span>&nbsp;<span class="op" id="4779445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779449">ce</span><span class="op" id="4779451">.</span><span class="ident" id="4779452">elseEnc</span><span class="op" id="4779459">(</span><span class="ident" id="4779460">e</span><span class="op" id="4779461">,</span>&nbsp;<span class="ident" id="4779463">v</span><span class="op" id="4779464">,</span>&nbsp;<span class="ident" id="4779466">quoted</span><span class="op" id="4779472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779475">}</span><br>
<span class="lineno"></span><span class="op" id="4779477">}</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="4779480">//&nbsp;newCondAddrEncoder&nbsp;returns&nbsp;an&nbsp;encoder&nbsp;that&nbsp;checks&nbsp;whether&nbsp;its&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="4779551">//&nbsp;CanAddr&nbsp;and&nbsp;delegates&nbsp;to&nbsp;canAddrEnc&nbsp;if&nbsp;so,&nbsp;else&nbsp;to&nbsp;elseEnc.</span><br>
<span class="lineno"></span><span class="keyword" id="4779614">func</span>&nbsp;<span class="ident" id="4779619">newCondAddrEncoder</span><span class="op" id="4779637">(</span><span class="ident" id="4779638">canAddrEnc</span><span class="op" id="4779648">,</span>&nbsp;<span class="ident" id="4779650">elseEnc</span>&nbsp;<span class="ident" id="4779658">encoderFunc</span><span class="op" id="4779669">)</span>&nbsp;<span class="ident" id="4779671">encoderFunc</span>&nbsp;<span class="op" id="4779683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779686">enc</span>&nbsp;<span class="op" id="4779690">:=</span>&nbsp;<span class="op" id="4779693">&amp;</span><span class="ident" id="4779694">condAddrEncoder</span><span class="op" id="4779709">{</span><span class="ident" id="4779710">canAddrEnc</span><span class="op" id="4779720">:</span>&nbsp;<span class="ident" id="4779722">canAddrEnc</span><span class="op" id="4779732">,</span>&nbsp;<span class="ident" id="4779734">elseEnc</span><span class="op" id="4779741">:</span>&nbsp;<span class="ident" id="4779743">elseEnc</span><span class="op" id="4779750">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779753">return</span>&nbsp;<span class="ident" id="4779760">enc</span><span class="op" id="4779763">.</span><span class="ident" id="4779764">encode</span><br>
<span class="lineno"></span><span class="op" id="4779771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4779774">func</span>&nbsp;<span class="ident" id="4779779">isValidTag</span><span class="op" id="4779789">(</span><span class="ident" id="4779790">s</span>&nbsp;<span class="builtintype" id="4779792">string</span><span class="op" id="4779798">)</span>&nbsp;<span class="builtintype" id="4779800">bool</span>&nbsp;<span class="op" id="4779805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779808">if</span>&nbsp;<span class="ident" id="4779811">s</span>&nbsp;<span class="op" id="4779813">==</span>&nbsp;<span class="string" id="4779816">&#34;&#34;</span>&nbsp;<span class="op" id="4779819">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779823">return</span>&nbsp;<span class="builtintype" id="4779830">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779840">for</span>&nbsp;<span class="ident" id="4779844">_</span><span class="op" id="4779845">,</span>&nbsp;<span class="ident" id="4779847">c</span>&nbsp;<span class="op" id="4779849">:=</span>&nbsp;<span class="keyword" id="4779852">range</span>&nbsp;<span class="ident" id="4779858">s</span>&nbsp;<span class="op" id="4779860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779864">switch</span>&nbsp;<span class="op" id="4779871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779875">case</span>&nbsp;<span class="ident" id="4779880">strings</span><span class="op" id="4779887">.</span><span class="ident" id="4779888">ContainsRune</span><span class="op" id="4779900">(</span><span class="string" id="4779901">&#34;!#$%&amp;()*+-./:&lt;=&gt;?@[]^_{|}~&nbsp;&#34;</span><span class="op" id="4779930">,</span>&nbsp;<span class="ident" id="4779932">c</span><span class="op" id="4779933">)</span><span class="op" id="4779934">:</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4779939">//&nbsp;Backslash&nbsp;and&nbsp;quote&nbsp;chars&nbsp;are&nbsp;reserved,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4779989">//&nbsp;otherwise&nbsp;any&nbsp;punctuation&nbsp;chars&nbsp;are&nbsp;allowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4780039">//&nbsp;in&nbsp;a&nbsp;tag&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780059">default</span><span class="op" id="4780066">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780071">if</span>&nbsp;<span class="op" id="4780074">!</span><span class="ident" id="4780075">unicode</span><span class="op" id="4780082">.</span><span class="ident" id="4780083">IsLetter</span><span class="op" id="4780091">(</span><span class="ident" id="4780092">c</span><span class="op" id="4780093">)</span>&nbsp;<span class="op" id="4780095">&amp;&amp;</span>&nbsp;<span class="op" id="4780098">!</span><span class="ident" id="4780099">unicode</span><span class="op" id="4780106">.</span><span class="ident" id="4780107">IsDigit</span><span class="op" id="4780114">(</span><span class="ident" id="4780115">c</span><span class="op" id="4780116">)</span>&nbsp;<span class="op" id="4780118">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780124">return</span>&nbsp;<span class="builtintype" id="4780131">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780150">return</span>&nbsp;<span class="builtintype" id="4780157">true</span><br>
<span class="lineno">750</span><span class="op" id="4780162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4780165">func</span>&nbsp;<span class="ident" id="4780170">fieldByIndex</span><span class="op" id="4780182">(</span><span class="ident" id="4780183">v</span>&nbsp;<span class="ident" id="4780185">reflect</span><span class="op" id="4780192">.</span><span class="ident" id="4780193">Value</span><span class="op" id="4780198">,</span>&nbsp;<span class="ident" id="4780200">index</span>&nbsp;<span class="op" id="4780206">[</span><span class="op" id="4780207">]</span><span class="builtintype" id="4780208">int</span><span class="op" id="4780211">)</span>&nbsp;<span class="ident" id="4780213">reflect</span><span class="op" id="4780220">.</span><span class="ident" id="4780221">Value</span>&nbsp;<span class="op" id="4780227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780230">for</span>&nbsp;<span class="ident" id="4780234">_</span><span class="op" id="4780235">,</span>&nbsp;<span class="ident" id="4780237">i</span>&nbsp;<span class="op" id="4780239">:=</span>&nbsp;<span class="keyword" id="4780242">range</span>&nbsp;<span class="ident" id="4780248">index</span>&nbsp;<span class="op" id="4780254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780258">if</span>&nbsp;<span class="ident" id="4780261">v</span><span class="op" id="4780262">.</span><span class="ident" id="4780263">Kind</span><span class="op" id="4780267">(</span><span class="op" id="4780268">)</span>&nbsp;<span class="op" id="4780270">==</span>&nbsp;<span class="ident" id="4780273">reflect</span><span class="op" id="4780280">.</span><span class="ident" id="4780281">Ptr</span>&nbsp;<span class="op" id="4780285">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780290">if</span>&nbsp;<span class="ident" id="4780293">v</span><span class="op" id="4780294">.</span><span class="ident" id="4780295">IsNil</span><span class="op" id="4780300">(</span><span class="op" id="4780301">)</span>&nbsp;<span class="op" id="4780303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780309">return</span>&nbsp;<span class="ident" id="4780316">reflect</span><span class="op" id="4780323">.</span><span class="ident" id="4780324">Value</span><span class="op" id="4780329">{</span><span class="op" id="4780330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780340">v</span>&nbsp;<span class="op" id="4780342">=</span>&nbsp;<span class="ident" id="4780344">v</span><span class="op" id="4780345">.</span><span class="ident" id="4780346">Elem</span><span class="op" id="4780350">(</span><span class="op" id="4780351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780355">}</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780359">v</span>&nbsp;<span class="op" id="4780361">=</span>&nbsp;<span class="ident" id="4780363">v</span><span class="op" id="4780364">.</span><span class="ident" id="4780365">Field</span><span class="op" id="4780370">(</span><span class="ident" id="4780371">i</span><span class="op" id="4780372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780378">return</span>&nbsp;<span class="ident" id="4780385">v</span><br>
<span class="lineno"></span><span class="op" id="4780387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="4780390">func</span>&nbsp;<span class="ident" id="4780395">typeByIndex</span><span class="op" id="4780406">(</span><span class="ident" id="4780407">t</span>&nbsp;<span class="ident" id="4780409">reflect</span><span class="op" id="4780416">.</span><span class="ident" id="4780417">Type</span><span class="op" id="4780421">,</span>&nbsp;<span class="ident" id="4780423">index</span>&nbsp;<span class="op" id="4780429">[</span><span class="op" id="4780430">]</span><span class="builtintype" id="4780431">int</span><span class="op" id="4780434">)</span>&nbsp;<span class="ident" id="4780436">reflect</span><span class="op" id="4780443">.</span><span class="ident" id="4780444">Type</span>&nbsp;<span class="op" id="4780449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780452">for</span>&nbsp;<span class="ident" id="4780456">_</span><span class="op" id="4780457">,</span>&nbsp;<span class="ident" id="4780459">i</span>&nbsp;<span class="op" id="4780461">:=</span>&nbsp;<span class="keyword" id="4780464">range</span>&nbsp;<span class="ident" id="4780470">index</span>&nbsp;<span class="op" id="4780476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780480">if</span>&nbsp;<span class="ident" id="4780483">t</span><span class="op" id="4780484">.</span><span class="ident" id="4780485">Kind</span><span class="op" id="4780489">(</span><span class="op" id="4780490">)</span>&nbsp;<span class="op" id="4780492">==</span>&nbsp;<span class="ident" id="4780495">reflect</span><span class="op" id="4780502">.</span><span class="ident" id="4780503">Ptr</span>&nbsp;<span class="op" id="4780507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780512">t</span>&nbsp;<span class="op" id="4780514">=</span>&nbsp;<span class="ident" id="4780516">t</span><span class="op" id="4780517">.</span><span class="ident" id="4780518">Elem</span><span class="op" id="4780522">(</span><span class="op" id="4780523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780527">}</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780531">t</span>&nbsp;<span class="op" id="4780533">=</span>&nbsp;<span class="ident" id="4780535">t</span><span class="op" id="4780536">.</span><span class="ident" id="4780537">Field</span><span class="op" id="4780542">(</span><span class="ident" id="4780543">i</span><span class="op" id="4780544">)</span><span class="op" id="4780545">.</span><span class="ident" id="4780546">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780555">return</span>&nbsp;<span class="ident" id="4780562">t</span><br>
<span class="lineno"></span><span class="op" id="4780564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">775</span><span class="comment" id="4780567">//&nbsp;stringValues&nbsp;is&nbsp;a&nbsp;slice&nbsp;of&nbsp;reflect.Value&nbsp;holding&nbsp;*reflect.StringValue.</span><br>
<span class="lineno"></span><span class="comment" id="4780641">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;methods&nbsp;to&nbsp;sort&nbsp;by&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="4780689">type</span>&nbsp;<span class="ident" id="4780694">stringValues</span>&nbsp;<span class="op" id="4780707">[</span><span class="op" id="4780708">]</span><span class="ident" id="4780709">reflect</span><span class="op" id="4780716">.</span><span class="ident" id="4780717">Value</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4780724">func</span>&nbsp;<span class="op" id="4780729">(</span><span class="ident" id="4780730">sv</span>&nbsp;<span class="ident" id="4780733">stringValues</span><span class="op" id="4780745">)</span>&nbsp;<span class="ident" id="4780747">Len</span><span class="op" id="4780750">(</span><span class="op" id="4780751">)</span>&nbsp;<span class="builtintype" id="4780753">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4780767">{</span>&nbsp;<span class="keyword" id="4780769">return</span>&nbsp;<span class="builtinfunc" id="4780776">len</span><span class="op" id="4780779">(</span><span class="ident" id="4780780">sv</span><span class="op" id="4780782">)</span>&nbsp;<span class="op" id="4780784">}</span><br>
<span class="lineno">780</span><span class="keyword" id="4780786">func</span>&nbsp;<span class="op" id="4780791">(</span><span class="ident" id="4780792">sv</span>&nbsp;<span class="ident" id="4780795">stringValues</span><span class="op" id="4780807">)</span>&nbsp;<span class="ident" id="4780809">Swap</span><span class="op" id="4780813">(</span><span class="ident" id="4780814">i</span><span class="op" id="4780815">,</span>&nbsp;<span class="ident" id="4780817">j</span>&nbsp;<span class="builtintype" id="4780819">int</span><span class="op" id="4780822">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4780829">{</span>&nbsp;<span class="ident" id="4780831">sv</span><span class="op" id="4780833">[</span><span class="ident" id="4780834">i</span><span class="op" id="4780835">]</span><span class="op" id="4780836">,</span>&nbsp;<span class="ident" id="4780838">sv</span><span class="op" id="4780840">[</span><span class="ident" id="4780841">j</span><span class="op" id="4780842">]</span>&nbsp;<span class="op" id="4780844">=</span>&nbsp;<span class="ident" id="4780846">sv</span><span class="op" id="4780848">[</span><span class="ident" id="4780849">j</span><span class="op" id="4780850">]</span><span class="op" id="4780851">,</span>&nbsp;<span class="ident" id="4780853">sv</span><span class="op" id="4780855">[</span><span class="ident" id="4780856">i</span><span class="op" id="4780857">]</span>&nbsp;<span class="op" id="4780859">}</span><br>
<span class="lineno"></span><span class="keyword" id="4780861">func</span>&nbsp;<span class="op" id="4780866">(</span><span class="ident" id="4780867">sv</span>&nbsp;<span class="ident" id="4780870">stringValues</span><span class="op" id="4780882">)</span>&nbsp;<span class="ident" id="4780884">Less</span><span class="op" id="4780888">(</span><span class="ident" id="4780889">i</span><span class="op" id="4780890">,</span>&nbsp;<span class="ident" id="4780892">j</span>&nbsp;<span class="builtintype" id="4780894">int</span><span class="op" id="4780897">)</span>&nbsp;<span class="builtintype" id="4780899">bool</span>&nbsp;<span class="op" id="4780904">{</span>&nbsp;<span class="keyword" id="4780906">return</span>&nbsp;<span class="ident" id="4780913">sv</span><span class="op" id="4780915">.</span><span class="ident" id="4780916">get</span><span class="op" id="4780919">(</span><span class="ident" id="4780920">i</span><span class="op" id="4780921">)</span>&nbsp;<span class="op" id="4780923">&lt;</span>&nbsp;<span class="ident" id="4780925">sv</span><span class="op" id="4780927">.</span><span class="ident" id="4780928">get</span><span class="op" id="4780931">(</span><span class="ident" id="4780932">j</span><span class="op" id="4780933">)</span>&nbsp;<span class="op" id="4780935">}</span><br>
<span class="lineno"></span><span class="keyword" id="4780937">func</span>&nbsp;<span class="op" id="4780942">(</span><span class="ident" id="4780943">sv</span>&nbsp;<span class="ident" id="4780946">stringValues</span><span class="op" id="4780958">)</span>&nbsp;<span class="ident" id="4780960">get</span><span class="op" id="4780963">(</span><span class="ident" id="4780964">i</span>&nbsp;<span class="builtintype" id="4780966">int</span><span class="op" id="4780969">)</span>&nbsp;<span class="builtintype" id="4780971">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4780980">{</span>&nbsp;<span class="keyword" id="4780982">return</span>&nbsp;<span class="ident" id="4780989">sv</span><span class="op" id="4780991">[</span><span class="ident" id="4780992">i</span><span class="op" id="4780993">]</span><span class="op" id="4780994">.</span><span class="ident" id="4780995">String</span><span class="op" id="4781001">(</span><span class="op" id="4781002">)</span>&nbsp;<span class="op" id="4781004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4781007">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;stringBytes&nbsp;below.</span><br>
<span class="lineno">785</span><span class="keyword" id="4781053">func</span>&nbsp;<span class="op" id="4781058">(</span><span class="ident" id="4781059">e</span>&nbsp;<span class="op" id="4781061">*</span><span class="ident" id="4781062">encodeState</span><span class="op" id="4781073">)</span>&nbsp;<span class="builtintype" id="4781075">string</span><span class="op" id="4781081">(</span><span class="ident" id="4781082">s</span>&nbsp;<span class="builtintype" id="4781084">string</span><span class="op" id="4781090">)</span>&nbsp;<span class="op" id="4781092">(</span><span class="builtintype" id="4781093">int</span><span class="op" id="4781096">,</span>&nbsp;<span class="builtintype" id="4781098">error</span><span class="op" id="4781103">)</span>&nbsp;<span class="op" id="4781105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781108">len0</span>&nbsp;<span class="op" id="4781113">:=</span>&nbsp;<span class="ident" id="4781116">e</span><span class="op" id="4781117">.</span><span class="ident" id="4781118">Len</span><span class="op" id="4781121">(</span><span class="op" id="4781122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781125">e</span><span class="op" id="4781126">.</span><span class="ident" id="4781127">WriteByte</span><span class="op" id="4781136">(</span><span class="string" id="4781137">&#39;&#34;&#39;</span><span class="op" id="4781140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781143">start</span>&nbsp;<span class="op" id="4781149">:=</span>&nbsp;<span class="num" id="4781152">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781155">for</span>&nbsp;<span class="ident" id="4781159">i</span>&nbsp;<span class="op" id="4781161">:=</span>&nbsp;<span class="num" id="4781164">0</span><span class="op" id="4781165">;</span>&nbsp;<span class="ident" id="4781167">i</span>&nbsp;<span class="op" id="4781169">&lt;</span>&nbsp;<span class="builtinfunc" id="4781171">len</span><span class="op" id="4781174">(</span><span class="ident" id="4781175">s</span><span class="op" id="4781176">)</span><span class="op" id="4781177">;</span>&nbsp;<span class="op" id="4781179">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781183">if</span>&nbsp;<span class="ident" id="4781186">b</span>&nbsp;<span class="op" id="4781188">:=</span>&nbsp;<span class="ident" id="4781191">s</span><span class="op" id="4781192">[</span><span class="ident" id="4781193">i</span><span class="op" id="4781194">]</span><span class="op" id="4781195">;</span>&nbsp;<span class="ident" id="4781197">b</span>&nbsp;<span class="op" id="4781199">&lt;</span>&nbsp;<span class="ident" id="4781201">utf8</span><span class="op" id="4781205">.</span><span class="ident" id="4781206">RuneSelf</span>&nbsp;<span class="op" id="4781215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781220">if</span>&nbsp;<span class="num" id="4781223">0x20</span>&nbsp;<span class="op" id="4781228">&lt;=</span>&nbsp;<span class="ident" id="4781231">b</span>&nbsp;<span class="op" id="4781233">&amp;&amp;</span>&nbsp;<span class="ident" id="4781236">b</span>&nbsp;<span class="op" id="4781238">!=</span>&nbsp;<span class="string" id="4781241">&#39;\\&#39;</span>&nbsp;<span class="op" id="4781246">&amp;&amp;</span>&nbsp;<span class="ident" id="4781249">b</span>&nbsp;<span class="op" id="4781251">!=</span>&nbsp;<span class="string" id="4781254">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="4781258">&amp;&amp;</span>&nbsp;<span class="ident" id="4781261">b</span>&nbsp;<span class="op" id="4781263">!=</span>&nbsp;<span class="string" id="4781266">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="4781270">&amp;&amp;</span>&nbsp;<span class="ident" id="4781273">b</span>&nbsp;<span class="op" id="4781275">!=</span>&nbsp;<span class="string" id="4781278">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="4781282">&amp;&amp;</span>&nbsp;<span class="ident" id="4781285">b</span>&nbsp;<span class="op" id="4781287">!=</span>&nbsp;<span class="string" id="4781290">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="4781294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781300">i</span><span class="op" id="4781301">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781308">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781320">}</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781325">if</span>&nbsp;<span class="ident" id="4781328">start</span>&nbsp;<span class="op" id="4781334">&lt;</span>&nbsp;<span class="ident" id="4781336">i</span>&nbsp;<span class="op" id="4781338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781344">e</span><span class="op" id="4781345">.</span><span class="ident" id="4781346">WriteString</span><span class="op" id="4781357">(</span><span class="ident" id="4781358">s</span><span class="op" id="4781359">[</span><span class="ident" id="4781360">start</span><span class="op" id="4781365">:</span><span class="ident" id="4781366">i</span><span class="op" id="4781367">]</span><span class="op" id="4781368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781378">switch</span>&nbsp;<span class="ident" id="4781385">b</span>&nbsp;<span class="op" id="4781387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781392">case</span>&nbsp;<span class="string" id="4781397">&#39;\\&#39;</span><span class="op" id="4781401">,</span>&nbsp;<span class="string" id="4781403">&#39;&#34;&#39;</span><span class="op" id="4781406">:</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781412">e</span><span class="op" id="4781413">.</span><span class="ident" id="4781414">WriteByte</span><span class="op" id="4781423">(</span><span class="string" id="4781424">&#39;\\&#39;</span><span class="op" id="4781428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781434">e</span><span class="op" id="4781435">.</span><span class="ident" id="4781436">WriteByte</span><span class="op" id="4781445">(</span><span class="ident" id="4781446">b</span><span class="op" id="4781447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781452">case</span>&nbsp;<span class="string" id="4781457">&#39;\n&#39;</span><span class="op" id="4781461">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781467">e</span><span class="op" id="4781468">.</span><span class="ident" id="4781469">WriteByte</span><span class="op" id="4781478">(</span><span class="string" id="4781479">&#39;\\&#39;</span><span class="op" id="4781483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781489">e</span><span class="op" id="4781490">.</span><span class="ident" id="4781491">WriteByte</span><span class="op" id="4781500">(</span><span class="string" id="4781501">&#39;n&#39;</span><span class="op" id="4781504">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781509">case</span>&nbsp;<span class="string" id="4781514">&#39;\r&#39;</span><span class="op" id="4781518">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781524">e</span><span class="op" id="4781525">.</span><span class="ident" id="4781526">WriteByte</span><span class="op" id="4781535">(</span><span class="string" id="4781536">&#39;\\&#39;</span><span class="op" id="4781540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781546">e</span><span class="op" id="4781547">.</span><span class="ident" id="4781548">WriteByte</span><span class="op" id="4781557">(</span><span class="string" id="4781558">&#39;r&#39;</span><span class="op" id="4781561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781566">case</span>&nbsp;<span class="string" id="4781571">&#39;\t&#39;</span><span class="op" id="4781575">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781581">e</span><span class="op" id="4781582">.</span><span class="ident" id="4781583">WriteByte</span><span class="op" id="4781592">(</span><span class="string" id="4781593">&#39;\\&#39;</span><span class="op" id="4781597">)</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781603">e</span><span class="op" id="4781604">.</span><span class="ident" id="4781605">WriteByte</span><span class="op" id="4781614">(</span><span class="string" id="4781615">&#39;t&#39;</span><span class="op" id="4781618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781623">default</span><span class="op" id="4781630">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781636">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781691">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781757">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781820">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781879">e</span><span class="op" id="4781880">.</span><span class="ident" id="4781881">WriteString</span><span class="op" id="4781892">(</span><span class="string" id="4781893">`\u00`</span><span class="op" id="4781899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781905">e</span><span class="op" id="4781906">.</span><span class="ident" id="4781907">WriteByte</span><span class="op" id="4781916">(</span><span class="ident" id="4781917">hex</span><span class="op" id="4781920">[</span><span class="ident" id="4781921">b</span><span class="op" id="4781922">&gt;&gt;</span><span class="num" id="4781924">4</span><span class="op" id="4781925">]</span><span class="op" id="4781926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781932">e</span><span class="op" id="4781933">.</span><span class="ident" id="4781934">WriteByte</span><span class="op" id="4781943">(</span><span class="ident" id="4781944">hex</span><span class="op" id="4781947">[</span><span class="ident" id="4781948">b</span><span class="op" id="4781949">&amp;</span><span class="num" id="4781950">0xF</span><span class="op" id="4781953">]</span><span class="op" id="4781954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781959">}</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781964">i</span><span class="op" id="4781965">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781971">start</span>&nbsp;<span class="op" id="4781977">=</span>&nbsp;<span class="ident" id="4781979">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781984">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781999">c</span><span class="op" id="4782000">,</span>&nbsp;<span class="ident" id="4782002">size</span>&nbsp;<span class="op" id="4782007">:=</span>&nbsp;<span class="ident" id="4782010">utf8</span><span class="op" id="4782014">.</span><span class="ident" id="4782015">DecodeRuneInString</span><span class="op" id="4782033">(</span><span class="ident" id="4782034">s</span><span class="op" id="4782035">[</span><span class="ident" id="4782036">i</span><span class="op" id="4782037">:</span><span class="op" id="4782038">]</span><span class="op" id="4782039">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782043">if</span>&nbsp;<span class="ident" id="4782046">c</span>&nbsp;<span class="op" id="4782048">==</span>&nbsp;<span class="ident" id="4782051">utf8</span><span class="op" id="4782055">.</span><span class="ident" id="4782056">RuneError</span>&nbsp;<span class="op" id="4782066">&amp;&amp;</span>&nbsp;<span class="ident" id="4782069">size</span>&nbsp;<span class="op" id="4782074">==</span>&nbsp;<span class="num" id="4782077">1</span>&nbsp;<span class="op" id="4782079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782084">if</span>&nbsp;<span class="ident" id="4782087">start</span>&nbsp;<span class="op" id="4782093">&lt;</span>&nbsp;<span class="ident" id="4782095">i</span>&nbsp;<span class="op" id="4782097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782103">e</span><span class="op" id="4782104">.</span><span class="ident" id="4782105">WriteString</span><span class="op" id="4782116">(</span><span class="ident" id="4782117">s</span><span class="op" id="4782118">[</span><span class="ident" id="4782119">start</span><span class="op" id="4782124">:</span><span class="ident" id="4782125">i</span><span class="op" id="4782126">]</span><span class="op" id="4782127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4782132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782137">e</span><span class="op" id="4782138">.</span><span class="ident" id="4782139">WriteString</span><span class="op" id="4782150">(</span><span class="string" id="4782151">`\ufffd`</span><span class="op" id="4782159">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782164">i</span>&nbsp;<span class="op" id="4782166">+=</span>&nbsp;<span class="ident" id="4782169">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782177">start</span>&nbsp;<span class="op" id="4782183">=</span>&nbsp;<span class="ident" id="4782185">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782190">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4782201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4782205">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4782236">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4782272">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4782337">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4782408">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4782471">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4782518">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782597">if</span>&nbsp;<span class="ident" id="4782600">c</span>&nbsp;<span class="op" id="4782602">==</span>&nbsp;<span class="string" id="4782605">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="4782614">||</span>&nbsp;<span class="ident" id="4782617">c</span>&nbsp;<span class="op" id="4782619">==</span>&nbsp;<span class="string" id="4782622">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="4782631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782636">if</span>&nbsp;<span class="ident" id="4782639">start</span>&nbsp;<span class="op" id="4782645">&lt;</span>&nbsp;<span class="ident" id="4782647">i</span>&nbsp;<span class="op" id="4782649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782655">e</span><span class="op" id="4782656">.</span><span class="ident" id="4782657">WriteString</span><span class="op" id="4782668">(</span><span class="ident" id="4782669">s</span><span class="op" id="4782670">[</span><span class="ident" id="4782671">start</span><span class="op" id="4782676">:</span><span class="ident" id="4782677">i</span><span class="op" id="4782678">]</span><span class="op" id="4782679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4782684">}</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782689">e</span><span class="op" id="4782690">.</span><span class="ident" id="4782691">WriteString</span><span class="op" id="4782702">(</span><span class="string" id="4782703">`\u202`</span><span class="op" id="4782710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782715">e</span><span class="op" id="4782716">.</span><span class="ident" id="4782717">WriteByte</span><span class="op" id="4782726">(</span><span class="ident" id="4782727">hex</span><span class="op" id="4782730">[</span><span class="ident" id="4782731">c</span><span class="op" id="4782732">&amp;</span><span class="num" id="4782733">0xF</span><span class="op" id="4782736">]</span><span class="op" id="4782737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782742">i</span>&nbsp;<span class="op" id="4782744">+=</span>&nbsp;<span class="ident" id="4782747">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782755">start</span>&nbsp;<span class="op" id="4782761">=</span>&nbsp;<span class="ident" id="4782763">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782768">continue</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4782779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782783">i</span>&nbsp;<span class="op" id="4782785">+=</span>&nbsp;<span class="ident" id="4782788">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4782794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782797">if</span>&nbsp;<span class="ident" id="4782800">start</span>&nbsp;<span class="op" id="4782806">&lt;</span>&nbsp;<span class="builtinfunc" id="4782808">len</span><span class="op" id="4782811">(</span><span class="ident" id="4782812">s</span><span class="op" id="4782813">)</span>&nbsp;<span class="op" id="4782815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782819">e</span><span class="op" id="4782820">.</span><span class="ident" id="4782821">WriteString</span><span class="op" id="4782832">(</span><span class="ident" id="4782833">s</span><span class="op" id="4782834">[</span><span class="ident" id="4782835">start</span><span class="op" id="4782840">:</span><span class="op" id="4782841">]</span><span class="op" id="4782842">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4782845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782848">e</span><span class="op" id="4782849">.</span><span class="ident" id="4782850">WriteByte</span><span class="op" id="4782859">(</span><span class="string" id="4782860">&#39;&#34;&#39;</span><span class="op" id="4782863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782866">return</span>&nbsp;<span class="ident" id="4782873">e</span><span class="op" id="4782874">.</span><span class="ident" id="4782875">Len</span><span class="op" id="4782878">(</span><span class="op" id="4782879">)</span>&nbsp;<span class="op" id="4782881">-</span>&nbsp;<span class="ident" id="4782883">len0</span><span class="op" id="4782887">,</span>&nbsp;<span class="ident" id="4782889">nil</span><br>
<span class="lineno"></span><span class="op" id="4782893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span><span class="comment" id="4782896">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;string&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="4782937">func</span>&nbsp;<span class="op" id="4782942">(</span><span class="ident" id="4782943">e</span>&nbsp;<span class="op" id="4782945">*</span><span class="ident" id="4782946">encodeState</span><span class="op" id="4782957">)</span>&nbsp;<span class="ident" id="4782959">stringBytes</span><span class="op" id="4782970">(</span><span class="ident" id="4782971">s</span>&nbsp;<span class="op" id="4782973">[</span><span class="op" id="4782974">]</span><span class="builtintype" id="4782975">byte</span><span class="op" id="4782979">)</span>&nbsp;<span class="op" id="4782981">(</span><span class="builtintype" id="4782982">int</span><span class="op" id="4782985">,</span>&nbsp;<span class="builtintype" id="4782987">error</span><span class="op" id="4782992">)</span>&nbsp;<span class="op" id="4782994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782997">len0</span>&nbsp;<span class="op" id="4783002">:=</span>&nbsp;<span class="ident" id="4783005">e</span><span class="op" id="4783006">.</span><span class="ident" id="4783007">Len</span><span class="op" id="4783010">(</span><span class="op" id="4783011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783014">e</span><span class="op" id="4783015">.</span><span class="ident" id="4783016">WriteByte</span><span class="op" id="4783025">(</span><span class="string" id="4783026">&#39;&#34;&#39;</span><span class="op" id="4783029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783032">start</span>&nbsp;<span class="op" id="4783038">:=</span>&nbsp;<span class="num" id="4783041">0</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783044">for</span>&nbsp;<span class="ident" id="4783048">i</span>&nbsp;<span class="op" id="4783050">:=</span>&nbsp;<span class="num" id="4783053">0</span><span class="op" id="4783054">;</span>&nbsp;<span class="ident" id="4783056">i</span>&nbsp;<span class="op" id="4783058">&lt;</span>&nbsp;<span class="builtinfunc" id="4783060">len</span><span class="op" id="4783063">(</span><span class="ident" id="4783064">s</span><span class="op" id="4783065">)</span><span class="op" id="4783066">;</span>&nbsp;<span class="op" id="4783068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783072">if</span>&nbsp;<span class="ident" id="4783075">b</span>&nbsp;<span class="op" id="4783077">:=</span>&nbsp;<span class="ident" id="4783080">s</span><span class="op" id="4783081">[</span><span class="ident" id="4783082">i</span><span class="op" id="4783083">]</span><span class="op" id="4783084">;</span>&nbsp;<span class="ident" id="4783086">b</span>&nbsp;<span class="op" id="4783088">&lt;</span>&nbsp;<span class="ident" id="4783090">utf8</span><span class="op" id="4783094">.</span><span class="ident" id="4783095">RuneSelf</span>&nbsp;<span class="op" id="4783104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783109">if</span>&nbsp;<span class="num" id="4783112">0x20</span>&nbsp;<span class="op" id="4783117">&lt;=</span>&nbsp;<span class="ident" id="4783120">b</span>&nbsp;<span class="op" id="4783122">&amp;&amp;</span>&nbsp;<span class="ident" id="4783125">b</span>&nbsp;<span class="op" id="4783127">!=</span>&nbsp;<span class="string" id="4783130">&#39;\\&#39;</span>&nbsp;<span class="op" id="4783135">&amp;&amp;</span>&nbsp;<span class="ident" id="4783138">b</span>&nbsp;<span class="op" id="4783140">!=</span>&nbsp;<span class="string" id="4783143">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="4783147">&amp;&amp;</span>&nbsp;<span class="ident" id="4783150">b</span>&nbsp;<span class="op" id="4783152">!=</span>&nbsp;<span class="string" id="4783155">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="4783159">&amp;&amp;</span>&nbsp;<span class="ident" id="4783162">b</span>&nbsp;<span class="op" id="4783164">!=</span>&nbsp;<span class="string" id="4783167">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="4783171">&amp;&amp;</span>&nbsp;<span class="ident" id="4783174">b</span>&nbsp;<span class="op" id="4783176">!=</span>&nbsp;<span class="string" id="4783179">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="4783183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783189">i</span><span class="op" id="4783190">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783197">continue</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4783209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783214">if</span>&nbsp;<span class="ident" id="4783217">start</span>&nbsp;<span class="op" id="4783223">&lt;</span>&nbsp;<span class="ident" id="4783225">i</span>&nbsp;<span class="op" id="4783227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783233">e</span><span class="op" id="4783234">.</span><span class="ident" id="4783235">Write</span><span class="op" id="4783240">(</span><span class="ident" id="4783241">s</span><span class="op" id="4783242">[</span><span class="ident" id="4783243">start</span><span class="op" id="4783248">:</span><span class="ident" id="4783249">i</span><span class="op" id="4783250">]</span><span class="op" id="4783251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4783256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783261">switch</span>&nbsp;<span class="ident" id="4783268">b</span>&nbsp;<span class="op" id="4783270">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783275">case</span>&nbsp;<span class="string" id="4783280">&#39;\\&#39;</span><span class="op" id="4783284">,</span>&nbsp;<span class="string" id="4783286">&#39;&#34;&#39;</span><span class="op" id="4783289">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783295">e</span><span class="op" id="4783296">.</span><span class="ident" id="4783297">WriteByte</span><span class="op" id="4783306">(</span><span class="string" id="4783307">&#39;\\&#39;</span><span class="op" id="4783311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783317">e</span><span class="op" id="4783318">.</span><span class="ident" id="4783319">WriteByte</span><span class="op" id="4783328">(</span><span class="ident" id="4783329">b</span><span class="op" id="4783330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783335">case</span>&nbsp;<span class="string" id="4783340">&#39;\n&#39;</span><span class="op" id="4783344">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783350">e</span><span class="op" id="4783351">.</span><span class="ident" id="4783352">WriteByte</span><span class="op" id="4783361">(</span><span class="string" id="4783362">&#39;\\&#39;</span><span class="op" id="4783366">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783372">e</span><span class="op" id="4783373">.</span><span class="ident" id="4783374">WriteByte</span><span class="op" id="4783383">(</span><span class="string" id="4783384">&#39;n&#39;</span><span class="op" id="4783387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783392">case</span>&nbsp;<span class="string" id="4783397">&#39;\r&#39;</span><span class="op" id="4783401">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783407">e</span><span class="op" id="4783408">.</span><span class="ident" id="4783409">WriteByte</span><span class="op" id="4783418">(</span><span class="string" id="4783419">&#39;\\&#39;</span><span class="op" id="4783423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783429">e</span><span class="op" id="4783430">.</span><span class="ident" id="4783431">WriteByte</span><span class="op" id="4783440">(</span><span class="string" id="4783441">&#39;r&#39;</span><span class="op" id="4783444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783449">case</span>&nbsp;<span class="string" id="4783454">&#39;\t&#39;</span><span class="op" id="4783458">:</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783464">e</span><span class="op" id="4783465">.</span><span class="ident" id="4783466">WriteByte</span><span class="op" id="4783475">(</span><span class="string" id="4783476">&#39;\\&#39;</span><span class="op" id="4783480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783486">e</span><span class="op" id="4783487">.</span><span class="ident" id="4783488">WriteByte</span><span class="op" id="4783497">(</span><span class="string" id="4783498">&#39;t&#39;</span><span class="op" id="4783501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783506">default</span><span class="op" id="4783513">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4783519">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4783574">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;,&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4783641">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4783704">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783763">e</span><span class="op" id="4783764">.</span><span class="ident" id="4783765">WriteString</span><span class="op" id="4783776">(</span><span class="string" id="4783777">`\u00`</span><span class="op" id="4783783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783789">e</span><span class="op" id="4783790">.</span><span class="ident" id="4783791">WriteByte</span><span class="op" id="4783800">(</span><span class="ident" id="4783801">hex</span><span class="op" id="4783804">[</span><span class="ident" id="4783805">b</span><span class="op" id="4783806">&gt;&gt;</span><span class="num" id="4783808">4</span><span class="op" id="4783809">]</span><span class="op" id="4783810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783816">e</span><span class="op" id="4783817">.</span><span class="ident" id="4783818">WriteByte</span><span class="op" id="4783827">(</span><span class="ident" id="4783828">hex</span><span class="op" id="4783831">[</span><span class="ident" id="4783832">b</span><span class="op" id="4783833">&amp;</span><span class="num" id="4783834">0xF</span><span class="op" id="4783837">]</span><span class="op" id="4783838">)</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4783843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783848">i</span><span class="op" id="4783849">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783855">start</span>&nbsp;<span class="op" id="4783861">=</span>&nbsp;<span class="ident" id="4783863">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783868">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4783879">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783883">c</span><span class="op" id="4783884">,</span>&nbsp;<span class="ident" id="4783886">size</span>&nbsp;<span class="op" id="4783891">:=</span>&nbsp;<span class="ident" id="4783894">utf8</span><span class="op" id="4783898">.</span><span class="ident" id="4783899">DecodeRune</span><span class="op" id="4783909">(</span><span class="ident" id="4783910">s</span><span class="op" id="4783911">[</span><span class="ident" id="4783912">i</span><span class="op" id="4783913">:</span><span class="op" id="4783914">]</span><span class="op" id="4783915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783919">if</span>&nbsp;<span class="ident" id="4783922">c</span>&nbsp;<span class="op" id="4783924">==</span>&nbsp;<span class="ident" id="4783927">utf8</span><span class="op" id="4783931">.</span><span class="ident" id="4783932">RuneError</span>&nbsp;<span class="op" id="4783942">&amp;&amp;</span>&nbsp;<span class="ident" id="4783945">size</span>&nbsp;<span class="op" id="4783950">==</span>&nbsp;<span class="num" id="4783953">1</span>&nbsp;<span class="op" id="4783955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4783960">if</span>&nbsp;<span class="ident" id="4783963">start</span>&nbsp;<span class="op" id="4783969">&lt;</span>&nbsp;<span class="ident" id="4783971">i</span>&nbsp;<span class="op" id="4783973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4783979">e</span><span class="op" id="4783980">.</span><span class="ident" id="4783981">Write</span><span class="op" id="4783986">(</span><span class="ident" id="4783987">s</span><span class="op" id="4783988">[</span><span class="ident" id="4783989">start</span><span class="op" id="4783994">:</span><span class="ident" id="4783995">i</span><span class="op" id="4783996">]</span><span class="op" id="4783997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4784002">}</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784007">e</span><span class="op" id="4784008">.</span><span class="ident" id="4784009">WriteString</span><span class="op" id="4784020">(</span><span class="string" id="4784021">`\ufffd`</span><span class="op" id="4784029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784034">i</span>&nbsp;<span class="op" id="4784036">+=</span>&nbsp;<span class="ident" id="4784039">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784047">start</span>&nbsp;<span class="op" id="4784053">=</span>&nbsp;<span class="ident" id="4784055">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4784060">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4784071">}</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4784075">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4784106">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4784142">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4784207">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4784278">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4784341">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4784388">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4784467">if</span>&nbsp;<span class="ident" id="4784470">c</span>&nbsp;<span class="op" id="4784472">==</span>&nbsp;<span class="string" id="4784475">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="4784484">||</span>&nbsp;<span class="ident" id="4784487">c</span>&nbsp;<span class="op" id="4784489">==</span>&nbsp;<span class="string" id="4784492">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="4784501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4784506">if</span>&nbsp;<span class="ident" id="4784509">start</span>&nbsp;<span class="op" id="4784515">&lt;</span>&nbsp;<span class="ident" id="4784517">i</span>&nbsp;<span class="op" id="4784519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784525">e</span><span class="op" id="4784526">.</span><span class="ident" id="4784527">Write</span><span class="op" id="4784532">(</span><span class="ident" id="4784533">s</span><span class="op" id="4784534">[</span><span class="ident" id="4784535">start</span><span class="op" id="4784540">:</span><span class="ident" id="4784541">i</span><span class="op" id="4784542">]</span><span class="op" id="4784543">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4784548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784553">e</span><span class="op" id="4784554">.</span><span class="ident" id="4784555">WriteString</span><span class="op" id="4784566">(</span><span class="string" id="4784567">`\u202`</span><span class="op" id="4784574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784579">e</span><span class="op" id="4784580">.</span><span class="ident" id="4784581">WriteByte</span><span class="op" id="4784590">(</span><span class="ident" id="4784591">hex</span><span class="op" id="4784594">[</span><span class="ident" id="4784595">c</span><span class="op" id="4784596">&amp;</span><span class="num" id="4784597">0xF</span><span class="op" id="4784600">]</span><span class="op" id="4784601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784606">i</span>&nbsp;<span class="op" id="4784608">+=</span>&nbsp;<span class="ident" id="4784611">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784619">start</span>&nbsp;<span class="op" id="4784625">=</span>&nbsp;<span class="ident" id="4784627">i</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4784632">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4784643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784647">i</span>&nbsp;<span class="op" id="4784649">+=</span>&nbsp;<span class="ident" id="4784652">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4784658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4784661">if</span>&nbsp;<span class="ident" id="4784664">start</span>&nbsp;<span class="op" id="4784670">&lt;</span>&nbsp;<span class="builtinfunc" id="4784672">len</span><span class="op" id="4784675">(</span><span class="ident" id="4784676">s</span><span class="op" id="4784677">)</span>&nbsp;<span class="op" id="4784679">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784683">e</span><span class="op" id="4784684">.</span><span class="ident" id="4784685">Write</span><span class="op" id="4784690">(</span><span class="ident" id="4784691">s</span><span class="op" id="4784692">[</span><span class="ident" id="4784693">start</span><span class="op" id="4784698">:</span><span class="op" id="4784699">]</span><span class="op" id="4784700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4784703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784706">e</span><span class="op" id="4784707">.</span><span class="ident" id="4784708">WriteByte</span><span class="op" id="4784717">(</span><span class="string" id="4784718">&#39;&#34;&#39;</span><span class="op" id="4784721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4784724">return</span>&nbsp;<span class="ident" id="4784731">e</span><span class="op" id="4784732">.</span><span class="ident" id="4784733">Len</span><span class="op" id="4784736">(</span><span class="op" id="4784737">)</span>&nbsp;<span class="op" id="4784739">-</span>&nbsp;<span class="ident" id="4784741">len0</span><span class="op" id="4784745">,</span>&nbsp;<span class="ident" id="4784747">nil</span><br>
<span class="lineno"></span><span class="op" id="4784751">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="comment" id="4784754">//&nbsp;A&nbsp;field&nbsp;represents&nbsp;a&nbsp;single&nbsp;field&nbsp;found&nbsp;in&nbsp;a&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="4784810">type</span>&nbsp;<span class="ident" id="4784815">field</span>&nbsp;<span class="keyword" id="4784821">struct</span>&nbsp;<span class="op" id="4784828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784831">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4784841">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784849">nameBytes</span>&nbsp;<span class="op" id="4784859">[</span><span class="op" id="4784860">]</span><span class="builtintype" id="4784861">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4784882">//&nbsp;[]byte(name)</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784899">equalFold</span>&nbsp;<span class="keyword" id="4784909">func</span><span class="op" id="4784913">(</span><span class="ident" id="4784914">s</span><span class="op" id="4784915">,</span>&nbsp;<span class="ident" id="4784917">t</span>&nbsp;<span class="op" id="4784919">[</span><span class="op" id="4784920">]</span><span class="builtintype" id="4784921">byte</span><span class="op" id="4784925">)</span>&nbsp;<span class="builtintype" id="4784927">bool</span>&nbsp;<span class="comment" id="4784932">//&nbsp;bytes.EqualFold&nbsp;or&nbsp;equivalent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784967">tag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4784977">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4784983">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784993">[</span><span class="op" id="4784994">]</span><span class="builtintype" id="4784995">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785000">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785010">reflect</span><span class="op" id="4785017">.</span><span class="ident" id="4785018">Type</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785024">omitEmpty</span>&nbsp;<span class="builtintype" id="4785034">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785040">quoted</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4785050">bool</span><br>
<span class="lineno"></span><span class="op" id="4785055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4785058">func</span>&nbsp;<span class="ident" id="4785063">fillField</span><span class="op" id="4785072">(</span><span class="ident" id="4785073">f</span>&nbsp;<span class="ident" id="4785075">field</span><span class="op" id="4785080">)</span>&nbsp;<span class="ident" id="4785082">field</span>&nbsp;<span class="op" id="4785088">{</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785091">f</span><span class="op" id="4785092">.</span><span class="ident" id="4785093">nameBytes</span>&nbsp;<span class="op" id="4785103">=</span>&nbsp;<span class="op" id="4785105">[</span><span class="op" id="4785106">]</span><span class="builtintype" id="4785107">byte</span><span class="op" id="4785111">(</span><span class="ident" id="4785112">f</span><span class="op" id="4785113">.</span><span class="ident" id="4785114">name</span><span class="op" id="4785118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4785121">f</span><span class="op" id="4785122">.</span><span class="ident" id="4785123">equalFold</span>&nbsp;<span class="op" id="4785133">=</span>&nbsp;<span class="ident" id="4785135">foldFunc</span><span class="op" id="4785143">(</span><span class="ident" id="4785144">f</span><span class="op" id="4785145">.</span><span class="ident" id="4785146">nameBytes</span><span class="op" id="4785155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785158">return</span>&nbsp;<span class="ident" id="4785165">f</span><br>
<span class="lineno"></span><span class="op" id="4785167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">955</span><span class="comment" id="4785170">//&nbsp;byName&nbsp;sorts&nbsp;field&nbsp;by&nbsp;name,&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;depth,</span><br>
<span class="lineno"></span><span class="comment" id="4785227">//&nbsp;then&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;&#34;name&nbsp;came&nbsp;from&nbsp;json&nbsp;tag&#34;,&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4785286">//&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="4785324">type</span>&nbsp;<span class="ident" id="4785329">byName</span>&nbsp;<span class="op" id="4785336">[</span><span class="op" id="4785337">]</span><span class="ident" id="4785338">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">960</span><span class="keyword" id="4785345">func</span>&nbsp;<span class="op" id="4785350">(</span><span class="ident" id="4785351">x</span>&nbsp;<span class="ident" id="4785353">byName</span><span class="op" id="4785359">)</span>&nbsp;<span class="ident" id="4785361">Len</span><span class="op" id="4785364">(</span><span class="op" id="4785365">)</span>&nbsp;<span class="builtintype" id="4785367">int</span>&nbsp;<span class="op" id="4785371">{</span>&nbsp;<span class="keyword" id="4785373">return</span>&nbsp;<span class="builtinfunc" id="4785380">len</span><span class="op" id="4785383">(</span><span class="ident" id="4785384">x</span><span class="op" id="4785385">)</span>&nbsp;<span class="op" id="4785387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4785390">func</span>&nbsp;<span class="op" id="4785395">(</span><span class="ident" id="4785396">x</span>&nbsp;<span class="ident" id="4785398">byName</span><span class="op" id="4785404">)</span>&nbsp;<span class="ident" id="4785406">Swap</span><span class="op" id="4785410">(</span><span class="ident" id="4785411">i</span><span class="op" id="4785412">,</span>&nbsp;<span class="ident" id="4785414">j</span>&nbsp;<span class="builtintype" id="4785416">int</span><span class="op" id="4785419">)</span>&nbsp;<span class="op" id="4785421">{</span>&nbsp;<span class="ident" id="4785423">x</span><span class="op" id="4785424">[</span><span class="ident" id="4785425">i</span><span class="op" id="4785426">]</span><span class="op" id="4785427">,</span>&nbsp;<span class="ident" id="4785429">x</span><span class="op" id="4785430">[</span><span class="ident" id="4785431">j</span><span class="op" id="4785432">]</span>&nbsp;<span class="op" id="4785434">=</span>&nbsp;<span class="ident" id="4785436">x</span><span class="op" id="4785437">[</span><span class="ident" id="4785438">j</span><span class="op" id="4785439">]</span><span class="op" id="4785440">,</span>&nbsp;<span class="ident" id="4785442">x</span><span class="op" id="4785443">[</span><span class="ident" id="4785444">i</span><span class="op" id="4785445">]</span>&nbsp;<span class="op" id="4785447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4785450">func</span>&nbsp;<span class="op" id="4785455">(</span><span class="ident" id="4785456">x</span>&nbsp;<span class="ident" id="4785458">byName</span><span class="op" id="4785464">)</span>&nbsp;<span class="ident" id="4785466">Less</span><span class="op" id="4785470">(</span><span class="ident" id="4785471">i</span><span class="op" id="4785472">,</span>&nbsp;<span class="ident" id="4785474">j</span>&nbsp;<span class="builtintype" id="4785476">int</span><span class="op" id="4785479">)</span>&nbsp;<span class="builtintype" id="4785481">bool</span>&nbsp;<span class="op" id="4785486">{</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785489">if</span>&nbsp;<span class="ident" id="4785492">x</span><span class="op" id="4785493">[</span><span class="ident" id="4785494">i</span><span class="op" id="4785495">]</span><span class="op" id="4785496">.</span><span class="ident" id="4785497">name</span>&nbsp;<span class="op" id="4785502">!=</span>&nbsp;<span class="ident" id="4785505">x</span><span class="op" id="4785506">[</span><span class="ident" id="4785507">j</span><span class="op" id="4785508">]</span><span class="op" id="4785509">.</span><span class="ident" id="4785510">name</span>&nbsp;<span class="op" id="4785515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785519">return</span>&nbsp;<span class="ident" id="4785526">x</span><span class="op" id="4785527">[</span><span class="ident" id="4785528">i</span><span class="op" id="4785529">]</span><span class="op" id="4785530">.</span><span class="ident" id="4785531">name</span>&nbsp;<span class="op" id="4785536">&lt;</span>&nbsp;<span class="ident" id="4785538">x</span><span class="op" id="4785539">[</span><span class="ident" id="4785540">j</span><span class="op" id="4785541">]</span><span class="op" id="4785542">.</span><span class="ident" id="4785543">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4785549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785552">if</span>&nbsp;<span class="builtinfunc" id="4785555">len</span><span class="op" id="4785558">(</span><span class="ident" id="4785559">x</span><span class="op" id="4785560">[</span><span class="ident" id="4785561">i</span><span class="op" id="4785562">]</span><span class="op" id="4785563">.</span><span class="ident" id="4785564">index</span><span class="op" id="4785569">)</span>&nbsp;<span class="op" id="4785571">!=</span>&nbsp;<span class="builtinfunc" id="4785574">len</span><span class="op" id="4785577">(</span><span class="ident" id="4785578">x</span><span class="op" id="4785579">[</span><span class="ident" id="4785580">j</span><span class="op" id="4785581">]</span><span class="op" id="4785582">.</span><span class="ident" id="4785583">index</span><span class="op" id="4785588">)</span>&nbsp;<span class="op" id="4785590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785594">return</span>&nbsp;<span class="builtinfunc" id="4785601">len</span><span class="op" id="4785604">(</span><span class="ident" id="4785605">x</span><span class="op" id="4785606">[</span><span class="ident" id="4785607">i</span><span class="op" id="4785608">]</span><span class="op" id="4785609">.</span><span class="ident" id="4785610">index</span><span class="op" id="4785615">)</span>&nbsp;<span class="op" id="4785617">&lt;</span>&nbsp;<span class="builtinfunc" id="4785619">len</span><span class="op" id="4785622">(</span><span class="ident" id="4785623">x</span><span class="op" id="4785624">[</span><span class="ident" id="4785625">j</span><span class="op" id="4785626">]</span><span class="op" id="4785627">.</span><span class="ident" id="4785628">index</span><span class="op" id="4785633">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4785636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785639">if</span>&nbsp;<span class="ident" id="4785642">x</span><span class="op" id="4785643">[</span><span class="ident" id="4785644">i</span><span class="op" id="4785645">]</span><span class="op" id="4785646">.</span><span class="ident" id="4785647">tag</span>&nbsp;<span class="op" id="4785651">!=</span>&nbsp;<span class="ident" id="4785654">x</span><span class="op" id="4785655">[</span><span class="ident" id="4785656">j</span><span class="op" id="4785657">]</span><span class="op" id="4785658">.</span><span class="ident" id="4785659">tag</span>&nbsp;<span class="op" id="4785663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785667">return</span>&nbsp;<span class="ident" id="4785674">x</span><span class="op" id="4785675">[</span><span class="ident" id="4785676">i</span><span class="op" id="4785677">]</span><span class="op" id="4785678">.</span><span class="ident" id="4785679">tag</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4785684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785687">return</span>&nbsp;<span class="ident" id="4785694">byIndex</span><span class="op" id="4785701">(</span><span class="ident" id="4785702">x</span><span class="op" id="4785703">)</span><span class="op" id="4785704">.</span><span class="ident" id="4785705">Less</span><span class="op" id="4785709">(</span><span class="ident" id="4785710">i</span><span class="op" id="4785711">,</span>&nbsp;<span class="ident" id="4785713">j</span><span class="op" id="4785714">)</span><br>
<span class="lineno">975</span><span class="op" id="4785716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4785719">//&nbsp;byIndex&nbsp;sorts&nbsp;field&nbsp;by&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="4785761">type</span>&nbsp;<span class="ident" id="4785766">byIndex</span>&nbsp;<span class="op" id="4785774">[</span><span class="op" id="4785775">]</span><span class="ident" id="4785776">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="4785783">func</span>&nbsp;<span class="op" id="4785788">(</span><span class="ident" id="4785789">x</span>&nbsp;<span class="ident" id="4785791">byIndex</span><span class="op" id="4785798">)</span>&nbsp;<span class="ident" id="4785800">Len</span><span class="op" id="4785803">(</span><span class="op" id="4785804">)</span>&nbsp;<span class="builtintype" id="4785806">int</span>&nbsp;<span class="op" id="4785810">{</span>&nbsp;<span class="keyword" id="4785812">return</span>&nbsp;<span class="builtinfunc" id="4785819">len</span><span class="op" id="4785822">(</span><span class="ident" id="4785823">x</span><span class="op" id="4785824">)</span>&nbsp;<span class="op" id="4785826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4785829">func</span>&nbsp;<span class="op" id="4785834">(</span><span class="ident" id="4785835">x</span>&nbsp;<span class="ident" id="4785837">byIndex</span><span class="op" id="4785844">)</span>&nbsp;<span class="ident" id="4785846">Swap</span><span class="op" id="4785850">(</span><span class="ident" id="4785851">i</span><span class="op" id="4785852">,</span>&nbsp;<span class="ident" id="4785854">j</span>&nbsp;<span class="builtintype" id="4785856">int</span><span class="op" id="4785859">)</span>&nbsp;<span class="op" id="4785861">{</span>&nbsp;<span class="ident" id="4785863">x</span><span class="op" id="4785864">[</span><span class="ident" id="4785865">i</span><span class="op" id="4785866">]</span><span class="op" id="4785867">,</span>&nbsp;<span class="ident" id="4785869">x</span><span class="op" id="4785870">[</span><span class="ident" id="4785871">j</span><span class="op" id="4785872">]</span>&nbsp;<span class="op" id="4785874">=</span>&nbsp;<span class="ident" id="4785876">x</span><span class="op" id="4785877">[</span><span class="ident" id="4785878">j</span><span class="op" id="4785879">]</span><span class="op" id="4785880">,</span>&nbsp;<span class="ident" id="4785882">x</span><span class="op" id="4785883">[</span><span class="ident" id="4785884">i</span><span class="op" id="4785885">]</span>&nbsp;<span class="op" id="4785887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4785890">func</span>&nbsp;<span class="op" id="4785895">(</span><span class="ident" id="4785896">x</span>&nbsp;<span class="ident" id="4785898">byIndex</span><span class="op" id="4785905">)</span>&nbsp;<span class="ident" id="4785907">Less</span><span class="op" id="4785911">(</span><span class="ident" id="4785912">i</span><span class="op" id="4785913">,</span>&nbsp;<span class="ident" id="4785915">j</span>&nbsp;<span class="builtintype" id="4785917">int</span><span class="op" id="4785920">)</span>&nbsp;<span class="builtintype" id="4785922">bool</span>&nbsp;<span class="op" id="4785927">{</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785930">for</span>&nbsp;<span class="ident" id="4785934">k</span><span class="op" id="4785935">,</span>&nbsp;<span class="ident" id="4785937">xik</span>&nbsp;<span class="op" id="4785941">:=</span>&nbsp;<span class="keyword" id="4785944">range</span>&nbsp;<span class="ident" id="4785950">x</span><span class="op" id="4785951">[</span><span class="ident" id="4785952">i</span><span class="op" id="4785953">]</span><span class="op" id="4785954">.</span><span class="ident" id="4785955">index</span>&nbsp;<span class="op" id="4785961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785965">if</span>&nbsp;<span class="ident" id="4785968">k</span>&nbsp;<span class="op" id="4785970">&gt;=</span>&nbsp;<span class="builtinfunc" id="4785973">len</span><span class="op" id="4785976">(</span><span class="ident" id="4785977">x</span><span class="op" id="4785978">[</span><span class="ident" id="4785979">j</span><span class="op" id="4785980">]</span><span class="op" id="4785981">.</span><span class="ident" id="4785982">index</span><span class="op" id="4785987">)</span>&nbsp;<span class="op" id="4785989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4785994">return</span>&nbsp;<span class="builtintype" id="4786001">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4786009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4786013">if</span>&nbsp;<span class="ident" id="4786016">xik</span>&nbsp;<span class="op" id="4786020">!=</span>&nbsp;<span class="ident" id="4786023">x</span><span class="op" id="4786024">[</span><span class="ident" id="4786025">j</span><span class="op" id="4786026">]</span><span class="op" id="4786027">.</span><span class="ident" id="4786028">index</span><span class="op" id="4786033">[</span><span class="ident" id="4786034">k</span><span class="op" id="4786035">]</span>&nbsp;<span class="op" id="4786037">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4786042">return</span>&nbsp;<span class="ident" id="4786049">xik</span>&nbsp;<span class="op" id="4786053">&lt;</span>&nbsp;<span class="ident" id="4786055">x</span><span class="op" id="4786056">[</span><span class="ident" id="4786057">j</span><span class="op" id="4786058">]</span><span class="op" id="4786059">.</span><span class="ident" id="4786060">index</span><span class="op" id="4786065">[</span><span class="ident" id="4786066">k</span><span class="op" id="4786067">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4786071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4786074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4786077">return</span>&nbsp;<span class="builtinfunc" id="4786084">len</span><span class="op" id="4786087">(</span><span class="ident" id="4786088">x</span><span class="op" id="4786089">[</span><span class="ident" id="4786090">i</span><span class="op" id="4786091">]</span><span class="op" id="4786092">.</span><span class="ident" id="4786093">index</span><span class="op" id="4786098">)</span>&nbsp;<span class="op" id="4786100">&lt;</span>&nbsp;<span class="builtinfunc" id="4786102">len</span><span class="op" id="4786105">(</span><span class="ident" id="4786106">x</span><span class="op" id="4786107">[</span><span class="ident" id="4786108">j</span><span class="op" id="4786109">]</span><span class="op" id="4786110">.</span><span class="ident" id="4786111">index</span><span class="op" id="4786116">)</span><br>
<span class="lineno"></span><span class="op" id="4786118">}</span><br>
<span class="lineno">995</span><br>
<span class="lineno"></span><span class="comment" id="4786121">//&nbsp;typeFields&nbsp;returns&nbsp;a&nbsp;list&nbsp;of&nbsp;fields&nbsp;that&nbsp;JSON&nbsp;should&nbsp;recognize&nbsp;for&nbsp;the&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="4786207">//&nbsp;The&nbsp;algorithm&nbsp;is&nbsp;breadth-first&nbsp;search&nbsp;over&nbsp;the&nbsp;set&nbsp;of&nbsp;structs&nbsp;to&nbsp;include&nbsp;-&nbsp;the&nbsp;top&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="4786300">//&nbsp;and&nbsp;then&nbsp;any&nbsp;reachable&nbsp;anonymous&nbsp;structs.</span><br>
<span class="lineno"></span><span class="keyword" id="4786345">func</span>&nbsp;<span class="ident" id="4786350">typeFields</span><span class="op" id="4786360">(</span><span class="ident" id="4786361">t</span>&nbsp;<span class="ident" id="4786363">reflect</span><span class="op" id="4786370">.</span><span class="ident" id="4786371">Type</span><span class="op" id="4786375">)</span>&nbsp;<span class="op" id="4786377">[</span><span class="op" id="4786378">]</span><span class="ident" id="4786379">field</span>&nbsp;<span class="op" id="4786385">{</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4786388">//&nbsp;Anonymous&nbsp;fields&nbsp;to&nbsp;explore&nbsp;at&nbsp;the&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4786455">current</span>&nbsp;<span class="op" id="4786463">:=</span>&nbsp;<span class="op" id="4786466">[</span><span class="op" id="4786467">]</span><span class="ident" id="4786468">field</span><span class="op" id="4786473">{</span><span class="op" id="4786474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4786477">next</span>&nbsp;<span class="op" id="4786482">:=</span>&nbsp;<span class="op" id="4786485">[</span><span class="op" id="4786486">]</span><span class="ident" id="4786487">field</span><span class="op" id="4786492">{</span><span class="op" id="4786493">{</span><span class="ident" id="4786494">typ</span><span class="op" id="4786497">:</span>&nbsp;<span class="ident" id="4786499">t</span><span class="op" id="4786500">}</span><span class="op" id="4786501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4786505">//&nbsp;Count&nbsp;of&nbsp;queued&nbsp;names&nbsp;for&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4786563">count</span>&nbsp;<span class="op" id="4786569">:=</span>&nbsp;<span class="keyword" id="4786572">map</span><span class="op" id="4786575">[</span><span class="ident" id="4786576">reflect</span><span class="op" id="4786583">.</span><span class="ident" id="4786584">Type</span><span class="op" id="4786588">]</span><span class="builtintype" id="4786589">int</span><span class="op" id="4786592">{</span><span class="op" id="4786593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4786596">nextCount</span>&nbsp;<span class="op" id="4786606">:=</span>&nbsp;<span class="keyword" id="4786609">map</span><span class="op" id="4786612">[</span><span class="ident" id="4786613">reflect</span><span class="op" id="4786620">.</span><span class="ident" id="4786621">Type</span><span class="op" id="4786625">]</span><span class="builtintype" id="4786626">int</span><span class="op" id="4786629">{</span><span class="op" id="4786630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4786634">//&nbsp;Types&nbsp;already&nbsp;visited&nbsp;at&nbsp;an&nbsp;earlier&nbsp;level.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4786681">visited</span>&nbsp;<span class="op" id="4786689">:=</span>&nbsp;<span class="keyword" id="4786692">map</span><span class="op" id="4786695">[</span><span class="ident" id="4786696">reflect</span><span class="op" id="4786703">.</span><span class="ident" id="4786704">Type</span><span class="op" id="4786708">]</span><span class="builtintype" id="4786709">bool</span><span class="op" id="4786713">{</span><span class="op" id="4786714">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4786718">//&nbsp;Fields&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4786736">var</span>&nbsp;<span class="ident" id="4786740">fields</span>&nbsp;<span class="op" id="4786747">[</span><span class="op" id="4786748">]</span><span class="ident" id="4786749">field</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4786757">for</span>&nbsp;<span class="builtinfunc" id="4786761">len</span><span class="op" id="4786764">(</span><span class="ident" id="4786765">next</span><span class="op" id="4786769">)</span>&nbsp;<span class="op" id="4786771">&gt;</span>&nbsp;<span class="num" id="4786773">0</span>&nbsp;<span class="op" id="4786775">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4786779">current</span><span class="op" id="4786786">,</span>&nbsp;<span class="ident" id="4786788">next</span>&nbsp;<span class="op" id="4786793">=</span>&nbsp;<span class="ident" id="4786795">next</span><span class="op" id="4786799">,</span>&nbsp;<span class="ident" id="4786801">current</span><span class="op" id="4786808">[</span><span class="op" id="4786809">:</span><span class="num" id="4786810">0</span><span class="op" id="4786811">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4786815">count</span><span class="op" id="4786820">,</span>&nbsp;<span class="ident" id="4786822">nextCount</span>&nbsp;<span class="op" id="4786832">=</span>&nbsp;<span class="ident" id="4786834">nextCount</span><span class="op" id="4786843">,</span>&nbsp;<span class="keyword" id="4786845">map</span><span class="op" id="4786848">[</span><span class="ident" id="4786849">reflect</span><span class="op" id="4786856">.</span><span class="ident" id="4786857">Type</span><span class="op" id="4786861">]</span><span class="builtintype" id="4786862">int</span><span class="op" id="4786865">{</span><span class="op" id="4786866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4786871">for</span>&nbsp;<span class="ident" id="4786875">_</span><span class="op" id="4786876">,</span>&nbsp;<span class="ident" id="4786878">f</span>&nbsp;<span class="op" id="4786880">:=</span>&nbsp;<span class="keyword" id="4786883">range</span>&nbsp;<span class="ident" id="4786889">current</span>&nbsp;<span class="op" id="4786897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4786902">if</span>&nbsp;<span class="ident" id="4786905">visited</span><span class="op" id="4786912">[</span><span class="ident" id="4786913">f</span><span class="op" id="4786914">.</span><span class="ident" id="4786915">typ</span><span class="op" id="4786918">]</span>&nbsp;<span class="op" id="4786920">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4786926">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4786938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4786943">visited</span><span class="op" id="4786950">[</span><span class="ident" id="4786951">f</span><span class="op" id="4786952">.</span><span class="ident" id="4786953">typ</span><span class="op" id="4786956">]</span>&nbsp;<span class="op" id="4786958">=</span>&nbsp;<span class="builtintype" id="4786960">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4786969">//&nbsp;Scan&nbsp;f.typ&nbsp;for&nbsp;fields&nbsp;to&nbsp;include.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4787009">for</span>&nbsp;<span class="ident" id="4787013">i</span>&nbsp;<span class="op" id="4787015">:=</span>&nbsp;<span class="num" id="4787018">0</span><span class="op" id="4787019">;</span>&nbsp;<span class="ident" id="4787021">i</span>&nbsp;<span class="op" id="4787023">&lt;</span>&nbsp;<span class="ident" id="4787025">f</span><span class="op" id="4787026">.</span><span class="ident" id="4787027">typ</span><span class="op" id="4787030">.</span><span class="ident" id="4787031">NumField</span><span class="op" id="4787039">(</span><span class="op" id="4787040">)</span><span class="op" id="4787041">;</span>&nbsp;<span class="ident" id="4787043">i</span><span class="op" id="4787044">++</span>&nbsp;<span class="op" id="4787047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787053">sf</span>&nbsp;<span class="op" id="4787056">:=</span>&nbsp;<span class="ident" id="4787059">f</span><span class="op" id="4787060">.</span><span class="ident" id="4787061">typ</span><span class="op" id="4787064">.</span><span class="ident" id="4787065">Field</span><span class="op" id="4787070">(</span><span class="ident" id="4787071">i</span><span class="op" id="4787072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4787078">if</span>&nbsp;<span class="ident" id="4787081">sf</span><span class="op" id="4787083">.</span><span class="ident" id="4787084">PkgPath</span>&nbsp;<span class="op" id="4787092">!=</span>&nbsp;<span class="string" id="4787095">&#34;&#34;</span>&nbsp;<span class="op" id="4787098">{</span>&nbsp;<span class="comment" id="4787100">//&nbsp;unexported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4787119">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4787132">}</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787138">tag</span>&nbsp;<span class="op" id="4787142">:=</span>&nbsp;<span class="ident" id="4787145">sf</span><span class="op" id="4787147">.</span><span class="ident" id="4787148">Tag</span><span class="op" id="4787151">.</span><span class="ident" id="4787152">Get</span><span class="op" id="4787155">(</span><span class="string" id="4787156">&#34;json&#34;</span><span class="op" id="4787162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4787168">if</span>&nbsp;<span class="ident" id="4787171">tag</span>&nbsp;<span class="op" id="4787175">==</span>&nbsp;<span class="string" id="4787178">&#34;-&#34;</span>&nbsp;<span class="op" id="4787182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4787189">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4787202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787208">name</span><span class="op" id="4787212">,</span>&nbsp;<span class="ident" id="4787214">opts</span>&nbsp;<span class="op" id="4787219">:=</span>&nbsp;<span class="ident" id="4787222">parseTag</span><span class="op" id="4787230">(</span><span class="ident" id="4787231">tag</span><span class="op" id="4787234">)</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4787240">if</span>&nbsp;<span class="op" id="4787243">!</span><span class="ident" id="4787244">isValidTag</span><span class="op" id="4787254">(</span><span class="ident" id="4787255">name</span><span class="op" id="4787259">)</span>&nbsp;<span class="op" id="4787261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787268">name</span>&nbsp;<span class="op" id="4787273">=</span>&nbsp;<span class="string" id="4787275">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4787282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787288">index</span>&nbsp;<span class="op" id="4787294">:=</span>&nbsp;<span class="builtinfunc" id="4787297">make</span><span class="op" id="4787301">(</span><span class="op" id="4787302">[</span><span class="op" id="4787303">]</span><span class="builtintype" id="4787304">int</span><span class="op" id="4787307">,</span>&nbsp;<span class="builtinfunc" id="4787309">len</span><span class="op" id="4787312">(</span><span class="ident" id="4787313">f</span><span class="op" id="4787314">.</span><span class="ident" id="4787315">index</span><span class="op" id="4787320">)</span><span class="op" id="4787321">+</span><span class="num" id="4787322">1</span><span class="op" id="4787323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4787329">copy</span><span class="op" id="4787333">(</span><span class="ident" id="4787334">index</span><span class="op" id="4787339">,</span>&nbsp;<span class="ident" id="4787341">f</span><span class="op" id="4787342">.</span><span class="ident" id="4787343">index</span><span class="op" id="4787348">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787354">index</span><span class="op" id="4787359">[</span><span class="builtinfunc" id="4787360">len</span><span class="op" id="4787363">(</span><span class="ident" id="4787364">f</span><span class="op" id="4787365">.</span><span class="ident" id="4787366">index</span><span class="op" id="4787371">)</span><span class="op" id="4787372">]</span>&nbsp;<span class="op" id="4787374">=</span>&nbsp;<span class="ident" id="4787376">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787383">ft</span>&nbsp;<span class="op" id="4787386">:=</span>&nbsp;<span class="ident" id="4787389">sf</span><span class="op" id="4787391">.</span><span class="ident" id="4787392">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4787401">if</span>&nbsp;<span class="ident" id="4787404">ft</span><span class="op" id="4787406">.</span><span class="ident" id="4787407">Name</span><span class="op" id="4787411">(</span><span class="op" id="4787412">)</span>&nbsp;<span class="op" id="4787414">==</span>&nbsp;<span class="string" id="4787417">&#34;&#34;</span>&nbsp;<span class="op" id="4787420">&amp;&amp;</span>&nbsp;<span class="ident" id="4787423">ft</span><span class="op" id="4787425">.</span><span class="ident" id="4787426">Kind</span><span class="op" id="4787430">(</span><span class="op" id="4787431">)</span>&nbsp;<span class="op" id="4787433">==</span>&nbsp;<span class="ident" id="4787436">reflect</span><span class="op" id="4787443">.</span><span class="ident" id="4787444">Ptr</span>&nbsp;<span class="op" id="4787448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4787455">//&nbsp;Follow&nbsp;pointer.</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787479">ft</span>&nbsp;<span class="op" id="4787482">=</span>&nbsp;<span class="ident" id="4787484">ft</span><span class="op" id="4787486">.</span><span class="ident" id="4787487">Elem</span><span class="op" id="4787491">(</span><span class="op" id="4787492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4787498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4787505">//&nbsp;Record&nbsp;found&nbsp;field&nbsp;and&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4787551">if</span>&nbsp;<span class="ident" id="4787554">name</span>&nbsp;<span class="op" id="4787559">!=</span>&nbsp;<span class="string" id="4787562">&#34;&#34;</span>&nbsp;<span class="op" id="4787565">||</span>&nbsp;<span class="op" id="4787568">!</span><span class="ident" id="4787569">sf</span><span class="op" id="4787571">.</span><span class="ident" id="4787572">Anonymous</span>&nbsp;<span class="op" id="4787582">||</span>&nbsp;<span class="ident" id="4787585">ft</span><span class="op" id="4787587">.</span><span class="ident" id="4787588">Kind</span><span class="op" id="4787592">(</span><span class="op" id="4787593">)</span>&nbsp;<span class="op" id="4787595">!=</span>&nbsp;<span class="ident" id="4787598">reflect</span><span class="op" id="4787605">.</span><span class="ident" id="4787606">Struct</span>&nbsp;<span class="op" id="4787613">{</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787620">tagged</span>&nbsp;<span class="op" id="4787627">:=</span>&nbsp;<span class="ident" id="4787630">name</span>&nbsp;<span class="op" id="4787635">!=</span>&nbsp;<span class="string" id="4787638">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4787646">if</span>&nbsp;<span class="ident" id="4787649">name</span>&nbsp;<span class="op" id="4787654">==</span>&nbsp;<span class="string" id="4787657">&#34;&#34;</span>&nbsp;<span class="op" id="4787660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787668">name</span>&nbsp;<span class="op" id="4787673">=</span>&nbsp;<span class="ident" id="4787675">sf</span><span class="op" id="4787677">.</span><span class="ident" id="4787678">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4787688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787695">fields</span>&nbsp;<span class="op" id="4787702">=</span>&nbsp;<span class="builtinfunc" id="4787704">append</span><span class="op" id="4787710">(</span><span class="ident" id="4787711">fields</span><span class="op" id="4787717">,</span>&nbsp;<span class="ident" id="4787719">fillField</span><span class="op" id="4787728">(</span><span class="ident" id="4787729">field</span><span class="op" id="4787734">{</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787742">name</span><span class="op" id="4787746">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4787753">name</span><span class="op" id="4787757">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787765">tag</span><span class="op" id="4787768">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4787776">tagged</span><span class="op" id="4787782">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787790">index</span><span class="op" id="4787795">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4787801">index</span><span class="op" id="4787806">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787814">typ</span><span class="op" id="4787817">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4787825">ft</span><span class="op" id="4787827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787835">omitEmpty</span><span class="op" id="4787844">:</span>&nbsp;<span class="ident" id="4787846">opts</span><span class="op" id="4787850">.</span><span class="ident" id="4787851">Contains</span><span class="op" id="4787859">(</span><span class="string" id="4787860">&#34;omitempty&#34;</span><span class="op" id="4787871">)</span><span class="op" id="4787872">,</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4787880">quoted</span><span class="op" id="4787886">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4787891">opts</span><span class="op" id="4787895">.</span><span class="ident" id="4787896">Contains</span><span class="op" id="4787904">(</span><span class="string" id="4787905">&#34;string&#34;</span><span class="op" id="4787913">)</span><span class="op" id="4787914">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4787921">}</span><span class="op" id="4787922">)</span><span class="op" id="4787923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4787930">if</span>&nbsp;<span class="ident" id="4787933">count</span><span class="op" id="4787938">[</span><span class="ident" id="4787939">f</span><span class="op" id="4787940">.</span><span class="ident" id="4787941">typ</span><span class="op" id="4787944">]</span>&nbsp;<span class="op" id="4787946">&gt;</span>&nbsp;<span class="num" id="4787948">1</span>&nbsp;<span class="op" id="4787950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4787958">//&nbsp;If&nbsp;there&nbsp;were&nbsp;multiple&nbsp;instances,&nbsp;add&nbsp;a&nbsp;second,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4788015">//&nbsp;so&nbsp;that&nbsp;the&nbsp;annihilation&nbsp;code&nbsp;will&nbsp;see&nbsp;a&nbsp;duplicate.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4788076">//&nbsp;It&nbsp;only&nbsp;cares&nbsp;about&nbsp;the&nbsp;distinction&nbsp;between&nbsp;1&nbsp;or&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4788137">//&nbsp;so&nbsp;don&#39;t&nbsp;bother&nbsp;generating&nbsp;any&nbsp;more&nbsp;copies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4788190">fields</span>&nbsp;<span class="op" id="4788197">=</span>&nbsp;<span class="builtinfunc" id="4788199">append</span><span class="op" id="4788205">(</span><span class="ident" id="4788206">fields</span><span class="op" id="4788212">,</span>&nbsp;<span class="ident" id="4788214">fields</span><span class="op" id="4788220">[</span><span class="builtinfunc" id="4788221">len</span><span class="op" id="4788224">(</span><span class="ident" id="4788225">fields</span><span class="op" id="4788231">)</span><span class="op" id="4788232">-</span><span class="num" id="4788233">1</span><span class="op" id="4788234">]</span><span class="op" id="4788235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4788242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4788249">continue</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4788262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4788269">//&nbsp;Record&nbsp;new&nbsp;anonymous&nbsp;struct&nbsp;to&nbsp;explore&nbsp;in&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4788330">nextCount</span><span class="op" id="4788339">[</span><span class="ident" id="4788340">ft</span><span class="op" id="4788342">]</span><span class="op" id="4788343">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4788350">if</span>&nbsp;<span class="ident" id="4788353">nextCount</span><span class="op" id="4788362">[</span><span class="ident" id="4788363">ft</span><span class="op" id="4788365">]</span>&nbsp;<span class="op" id="4788367">==</span>&nbsp;<span class="num" id="4788370">1</span>&nbsp;<span class="op" id="4788372">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4788379">next</span>&nbsp;<span class="op" id="4788384">=</span>&nbsp;<span class="builtinfunc" id="4788386">append</span><span class="op" id="4788392">(</span><span class="ident" id="4788393">next</span><span class="op" id="4788397">,</span>&nbsp;<span class="ident" id="4788399">fillField</span><span class="op" id="4788408">(</span><span class="ident" id="4788409">field</span><span class="op" id="4788414">{</span><span class="ident" id="4788415">name</span><span class="op" id="4788419">:</span>&nbsp;<span class="ident" id="4788421">ft</span><span class="op" id="4788423">.</span><span class="ident" id="4788424">Name</span><span class="op" id="4788428">(</span><span class="op" id="4788429">)</span><span class="op" id="4788430">,</span>&nbsp;<span class="ident" id="4788432">index</span><span class="op" id="4788437">:</span>&nbsp;<span class="ident" id="4788439">index</span><span class="op" id="4788444">,</span>&nbsp;<span class="ident" id="4788446">typ</span><span class="op" id="4788449">:</span>&nbsp;<span class="ident" id="4788451">ft</span><span class="op" id="4788453">}</span><span class="op" id="4788454">)</span><span class="op" id="4788455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4788461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4788466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4788470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4788473">}</span><br>
<span class="lineno">1080</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4788477">sort</span><span class="op" id="4788481">.</span><span class="ident" id="4788482">Sort</span><span class="op" id="4788486">(</span><span class="ident" id="4788487">byName</span><span class="op" id="4788493">(</span><span class="ident" id="4788494">fields</span><span class="op" id="4788500">)</span><span class="op" id="4788501">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4788505">//&nbsp;Delete&nbsp;all&nbsp;fields&nbsp;that&nbsp;are&nbsp;hidden&nbsp;by&nbsp;the&nbsp;Go&nbsp;rules&nbsp;for&nbsp;embedded&nbsp;fields,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4788580">//&nbsp;except&nbsp;that&nbsp;fields&nbsp;with&nbsp;JSON&nbsp;tags&nbsp;are&nbsp;promoted.</span><br>
<span class="lineno">1085</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4788633">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;primary&nbsp;order&nbsp;of&nbsp;name,&nbsp;secondary&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4788701">//&nbsp;of&nbsp;field&nbsp;index&nbsp;length.&nbsp;Loop&nbsp;over&nbsp;names;&nbsp;for&nbsp;each&nbsp;name,&nbsp;delete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4788767">//&nbsp;hidden&nbsp;fields&nbsp;by&nbsp;choosing&nbsp;the&nbsp;one&nbsp;dominant&nbsp;field&nbsp;that&nbsp;survives.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4788835">out</span>&nbsp;<span class="op" id="4788839">:=</span>&nbsp;<span class="ident" id="4788842">fields</span><span class="op" id="4788848">[</span><span class="op" id="4788849">:</span><span class="num" id="4788850">0</span><span class="op" id="4788851">]</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4788854">for</span>&nbsp;<span class="ident" id="4788858">advance</span><span class="op" id="4788865">,</span>&nbsp;<span class="ident" id="4788867">i</span>&nbsp;<span class="op" id="4788869">:=</span>&nbsp;<span class="num" id="4788872">0</span><span class="op" id="4788873">,</span>&nbsp;<span class="num" id="4788875">0</span><span class="op" id="4788876">;</span>&nbsp;<span class="ident" id="4788878">i</span>&nbsp;<span class="op" id="4788880">&lt;</span>&nbsp;<span class="builtinfunc" id="4788882">len</span><span class="op" id="4788885">(</span><span class="ident" id="4788886">fields</span><span class="op" id="4788892">)</span><span class="op" id="4788893">;</span>&nbsp;<span class="ident" id="4788895">i</span>&nbsp;<span class="op" id="4788897">+=</span>&nbsp;<span class="ident" id="4788900">advance</span>&nbsp;<span class="op" id="4788908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4788912">//&nbsp;One&nbsp;iteration&nbsp;per&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4788941">//&nbsp;Find&nbsp;the&nbsp;sequence&nbsp;of&nbsp;fields&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;this&nbsp;first&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4789009">fi</span>&nbsp;<span class="op" id="4789012">:=</span>&nbsp;<span class="ident" id="4789015">fields</span><span class="op" id="4789021">[</span><span class="ident" id="4789022">i</span><span class="op" id="4789023">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4789027">name</span>&nbsp;<span class="op" id="4789032">:=</span>&nbsp;<span class="ident" id="4789035">fi</span><span class="op" id="4789037">.</span><span class="ident" id="4789038">name</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4789045">for</span>&nbsp;<span class="ident" id="4789049">advance</span>&nbsp;<span class="op" id="4789057">=</span>&nbsp;<span class="num" id="4789059">1</span><span class="op" id="4789060">;</span>&nbsp;<span class="ident" id="4789062">i</span><span class="op" id="4789063">+</span><span class="ident" id="4789064">advance</span>&nbsp;<span class="op" id="4789072">&lt;</span>&nbsp;<span class="builtinfunc" id="4789074">len</span><span class="op" id="4789077">(</span><span class="ident" id="4789078">fields</span><span class="op" id="4789084">)</span><span class="op" id="4789085">;</span>&nbsp;<span class="ident" id="4789087">advance</span><span class="op" id="4789094">++</span>&nbsp;<span class="op" id="4789097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4789102">fj</span>&nbsp;<span class="op" id="4789105">:=</span>&nbsp;<span class="ident" id="4789108">fields</span><span class="op" id="4789114">[</span><span class="ident" id="4789115">i</span><span class="op" id="4789116">+</span><span class="ident" id="4789117">advance</span><span class="op" id="4789124">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4789129">if</span>&nbsp;<span class="ident" id="4789132">fj</span><span class="op" id="4789134">.</span><span class="ident" id="4789135">name</span>&nbsp;<span class="op" id="4789140">!=</span>&nbsp;<span class="ident" id="4789143">name</span>&nbsp;<span class="op" id="4789148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4789154">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4789163">}</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4789167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4789171">if</span>&nbsp;<span class="ident" id="4789174">advance</span>&nbsp;<span class="op" id="4789182">==</span>&nbsp;<span class="num" id="4789185">1</span>&nbsp;<span class="op" id="4789187">{</span>&nbsp;<span class="comment" id="4789189">//&nbsp;Only&nbsp;one&nbsp;field&nbsp;with&nbsp;this&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4789225">out</span>&nbsp;<span class="op" id="4789229">=</span>&nbsp;<span class="builtinfunc" id="4789231">append</span><span class="op" id="4789237">(</span><span class="ident" id="4789238">out</span><span class="op" id="4789241">,</span>&nbsp;<span class="ident" id="4789243">fi</span><span class="op" id="4789245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4789250">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4789261">}</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4789265">dominant</span><span class="op" id="4789273">,</span>&nbsp;<span class="ident" id="4789275">ok</span>&nbsp;<span class="op" id="4789278">:=</span>&nbsp;<span class="ident" id="4789281">dominantField</span><span class="op" id="4789294">(</span><span class="ident" id="4789295">fields</span><span class="op" id="4789301">[</span><span class="ident" id="4789302">i</span>&nbsp;<span class="op" id="4789304">:</span>&nbsp;<span class="ident" id="4789306">i</span><span class="op" id="4789307">+</span><span class="ident" id="4789308">advance</span><span class="op" id="4789315">]</span><span class="op" id="4789316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4789320">if</span>&nbsp;<span class="ident" id="4789323">ok</span>&nbsp;<span class="op" id="4789326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4789331">out</span>&nbsp;<span class="op" id="4789335">=</span>&nbsp;<span class="builtinfunc" id="4789337">append</span><span class="op" id="4789343">(</span><span class="ident" id="4789344">out</span><span class="op" id="4789347">,</span>&nbsp;<span class="ident" id="4789349">dominant</span><span class="op" id="4789357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4789361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4789364">}</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4789368">fields</span>&nbsp;<span class="op" id="4789375">=</span>&nbsp;<span class="ident" id="4789377">out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4789382">sort</span><span class="op" id="4789386">.</span><span class="ident" id="4789387">Sort</span><span class="op" id="4789391">(</span><span class="ident" id="4789392">byIndex</span><span class="op" id="4789399">(</span><span class="ident" id="4789400">fields</span><span class="op" id="4789406">)</span><span class="op" id="4789407">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4789411">return</span>&nbsp;<span class="ident" id="4789418">fields</span><br>
<span class="lineno">1115</span><span class="op" id="4789425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4789428">//&nbsp;dominantField&nbsp;looks&nbsp;through&nbsp;the&nbsp;fields,&nbsp;all&nbsp;of&nbsp;which&nbsp;are&nbsp;known&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4789497">//&nbsp;have&nbsp;the&nbsp;same&nbsp;name,&nbsp;to&nbsp;find&nbsp;the&nbsp;single&nbsp;field&nbsp;that&nbsp;dominates&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4789564">//&nbsp;others&nbsp;using&nbsp;Go&#39;s&nbsp;embedding&nbsp;rules,&nbsp;modified&nbsp;by&nbsp;the&nbsp;presence&nbsp;of</span><br>
<span class="lineno">1120</span><span class="comment" id="4789630">//&nbsp;JSON&nbsp;tags.&nbsp;If&nbsp;there&nbsp;are&nbsp;multiple&nbsp;top-level&nbsp;fields,&nbsp;the&nbsp;boolean</span><br>
<span class="lineno"></span><span class="comment" id="4789696">//&nbsp;will&nbsp;be&nbsp;false:&nbsp;This&nbsp;condition&nbsp;is&nbsp;an&nbsp;error&nbsp;in&nbsp;Go&nbsp;and&nbsp;we&nbsp;skip&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="4789763">//&nbsp;the&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="4789778">func</span>&nbsp;<span class="ident" id="4789783">dominantField</span><span class="op" id="4789796">(</span><span class="ident" id="4789797">fields</span>&nbsp;<span class="op" id="4789804">[</span><span class="op" id="4789805">]</span><span class="ident" id="4789806">field</span><span class="op" id="4789811">)</span>&nbsp;<span class="op" id="4789813">(</span><span class="ident" id="4789814">field</span><span class="op" id="4789819">,</span>&nbsp;<span class="builtintype" id="4789821">bool</span><span class="op" id="4789825">)</span>&nbsp;<span class="op" id="4789827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4789830">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;increasing&nbsp;index-length&nbsp;order.&nbsp;The&nbsp;winner</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4789901">//&nbsp;must&nbsp;therefore&nbsp;be&nbsp;one&nbsp;with&nbsp;the&nbsp;shortest&nbsp;index&nbsp;length.&nbsp;Drop&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4789968">//&nbsp;longer&nbsp;entries,&nbsp;which&nbsp;is&nbsp;easy:&nbsp;just&nbsp;truncate&nbsp;the&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790028">length</span>&nbsp;<span class="op" id="4790035">:=</span>&nbsp;<span class="builtinfunc" id="4790038">len</span><span class="op" id="4790041">(</span><span class="ident" id="4790042">fields</span><span class="op" id="4790048">[</span><span class="num" id="4790049">0</span><span class="op" id="4790050">]</span><span class="op" id="4790051">.</span><span class="ident" id="4790052">index</span><span class="op" id="4790057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790060">tagged</span>&nbsp;<span class="op" id="4790067">:=</span>&nbsp;<span class="op" id="4790070">-</span><span class="num" id="4790071">1</span>&nbsp;<span class="comment" id="4790073">//&nbsp;Index&nbsp;of&nbsp;first&nbsp;tagged&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790106">for</span>&nbsp;<span class="ident" id="4790110">i</span><span class="op" id="4790111">,</span>&nbsp;<span class="ident" id="4790113">f</span>&nbsp;<span class="op" id="4790115">:=</span>&nbsp;<span class="keyword" id="4790118">range</span>&nbsp;<span class="ident" id="4790124">fields</span>&nbsp;<span class="op" id="4790131">{</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790135">if</span>&nbsp;<span class="builtinfunc" id="4790138">len</span><span class="op" id="4790141">(</span><span class="ident" id="4790142">f</span><span class="op" id="4790143">.</span><span class="ident" id="4790144">index</span><span class="op" id="4790149">)</span>&nbsp;<span class="op" id="4790151">&gt;</span>&nbsp;<span class="ident" id="4790153">length</span>&nbsp;<span class="op" id="4790160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790165">fields</span>&nbsp;<span class="op" id="4790172">=</span>&nbsp;<span class="ident" id="4790174">fields</span><span class="op" id="4790180">[</span><span class="op" id="4790181">:</span><span class="ident" id="4790182">i</span><span class="op" id="4790183">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790188">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4790196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790200">if</span>&nbsp;<span class="ident" id="4790203">f</span><span class="op" id="4790204">.</span><span class="ident" id="4790205">tag</span>&nbsp;<span class="op" id="4790209">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790214">if</span>&nbsp;<span class="ident" id="4790217">tagged</span>&nbsp;<span class="op" id="4790224">&gt;=</span>&nbsp;<span class="num" id="4790227">0</span>&nbsp;<span class="op" id="4790229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4790235">//&nbsp;Multiple&nbsp;tagged&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level:&nbsp;conflict.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4790294">//&nbsp;Return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790318">return</span>&nbsp;<span class="ident" id="4790325">field</span><span class="op" id="4790330">{</span><span class="op" id="4790331">}</span><span class="op" id="4790332">,</span>&nbsp;<span class="builtintype" id="4790334">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4790343">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790348">tagged</span>&nbsp;<span class="op" id="4790355">=</span>&nbsp;<span class="ident" id="4790357">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4790361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4790364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790367">if</span>&nbsp;<span class="ident" id="4790370">tagged</span>&nbsp;<span class="op" id="4790377">&gt;=</span>&nbsp;<span class="num" id="4790380">0</span>&nbsp;<span class="op" id="4790382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790386">return</span>&nbsp;<span class="ident" id="4790393">fields</span><span class="op" id="4790399">[</span><span class="ident" id="4790400">tagged</span><span class="op" id="4790406">]</span><span class="op" id="4790407">,</span>&nbsp;<span class="builtintype" id="4790409">true</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4790415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4790418">//&nbsp;All&nbsp;remaining&nbsp;fields&nbsp;have&nbsp;the&nbsp;same&nbsp;length.&nbsp;If&nbsp;there&#39;s&nbsp;more&nbsp;than&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4790491">//&nbsp;we&nbsp;have&nbsp;a&nbsp;conflict&nbsp;(two&nbsp;fields&nbsp;named&nbsp;&#34;X&#34;&nbsp;at&nbsp;the&nbsp;same&nbsp;level)&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4790562">//&nbsp;return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790583">if</span>&nbsp;<span class="builtinfunc" id="4790586">len</span><span class="op" id="4790589">(</span><span class="ident" id="4790590">fields</span><span class="op" id="4790596">)</span>&nbsp;<span class="op" id="4790598">&gt;</span>&nbsp;<span class="num" id="4790600">1</span>&nbsp;<span class="op" id="4790602">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790606">return</span>&nbsp;<span class="ident" id="4790613">field</span><span class="op" id="4790618">{</span><span class="op" id="4790619">}</span><span class="op" id="4790620">,</span>&nbsp;<span class="builtintype" id="4790622">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4790629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790632">return</span>&nbsp;<span class="ident" id="4790639">fields</span><span class="op" id="4790645">[</span><span class="num" id="4790646">0</span><span class="op" id="4790647">]</span><span class="op" id="4790648">,</span>&nbsp;<span class="builtintype" id="4790650">true</span><br>
<span class="lineno"></span><span class="op" id="4790655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1155</span><span class="keyword" id="4790658">var</span>&nbsp;<span class="ident" id="4790662">fieldCache</span>&nbsp;<span class="keyword" id="4790673">struct</span>&nbsp;<span class="op" id="4790680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790683">sync</span><span class="op" id="4790687">.</span><span class="ident" id="4790688">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790697">m</span>&nbsp;<span class="keyword" id="4790699">map</span><span class="op" id="4790702">[</span><span class="ident" id="4790703">reflect</span><span class="op" id="4790710">.</span><span class="ident" id="4790711">Type</span><span class="op" id="4790715">]</span><span class="op" id="4790716">[</span><span class="op" id="4790717">]</span><span class="ident" id="4790718">field</span><br>
<span class="lineno"></span><span class="op" id="4790724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1160</span><span class="comment" id="4790727">//&nbsp;cachedTypeFields&nbsp;is&nbsp;like&nbsp;typeFields&nbsp;but&nbsp;uses&nbsp;a&nbsp;cache&nbsp;to&nbsp;avoid&nbsp;repeated&nbsp;work.</span><br>
<span class="lineno"></span><span class="keyword" id="4790807">func</span>&nbsp;<span class="ident" id="4790812">cachedTypeFields</span><span class="op" id="4790828">(</span><span class="ident" id="4790829">t</span>&nbsp;<span class="ident" id="4790831">reflect</span><span class="op" id="4790838">.</span><span class="ident" id="4790839">Type</span><span class="op" id="4790843">)</span>&nbsp;<span class="op" id="4790845">[</span><span class="op" id="4790846">]</span><span class="ident" id="4790847">field</span>&nbsp;<span class="op" id="4790853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790856">fieldCache</span><span class="op" id="4790866">.</span><span class="ident" id="4790867">RLock</span><span class="op" id="4790872">(</span><span class="op" id="4790873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790876">f</span>&nbsp;<span class="op" id="4790878">:=</span>&nbsp;<span class="ident" id="4790881">fieldCache</span><span class="op" id="4790891">.</span><span class="ident" id="4790892">m</span><span class="op" id="4790893">[</span><span class="ident" id="4790894">t</span><span class="op" id="4790895">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4790898">fieldCache</span><span class="op" id="4790908">.</span><span class="ident" id="4790909">RUnlock</span><span class="op" id="4790916">(</span><span class="op" id="4790917">)</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790920">if</span>&nbsp;<span class="ident" id="4790923">f</span>&nbsp;<span class="op" id="4790925">!=</span>&nbsp;<span class="ident" id="4790928">nil</span>&nbsp;<span class="op" id="4790932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4790936">return</span>&nbsp;<span class="ident" id="4790943">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4790946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4790950">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4790983">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4791050">f</span>&nbsp;<span class="op" id="4791052">=</span>&nbsp;<span class="ident" id="4791054">typeFields</span><span class="op" id="4791064">(</span><span class="ident" id="4791065">t</span><span class="op" id="4791066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4791069">if</span>&nbsp;<span class="ident" id="4791072">f</span>&nbsp;<span class="op" id="4791074">==</span>&nbsp;<span class="ident" id="4791077">nil</span>&nbsp;<span class="op" id="4791081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4791085">f</span>&nbsp;<span class="op" id="4791087">=</span>&nbsp;<span class="op" id="4791089">[</span><span class="op" id="4791090">]</span><span class="ident" id="4791091">field</span><span class="op" id="4791096">{</span><span class="op" id="4791097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4791100">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4791104">fieldCache</span><span class="op" id="4791114">.</span><span class="ident" id="4791115">Lock</span><span class="op" id="4791119">(</span><span class="op" id="4791120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4791123">if</span>&nbsp;<span class="ident" id="4791126">fieldCache</span><span class="op" id="4791136">.</span><span class="ident" id="4791137">m</span>&nbsp;<span class="op" id="4791139">==</span>&nbsp;<span class="ident" id="4791142">nil</span>&nbsp;<span class="op" id="4791146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4791150">fieldCache</span><span class="op" id="4791160">.</span><span class="ident" id="4791161">m</span>&nbsp;<span class="op" id="4791163">=</span>&nbsp;<span class="keyword" id="4791165">map</span><span class="op" id="4791168">[</span><span class="ident" id="4791169">reflect</span><span class="op" id="4791176">.</span><span class="ident" id="4791177">Type</span><span class="op" id="4791181">]</span><span class="op" id="4791182">[</span><span class="op" id="4791183">]</span><span class="ident" id="4791184">field</span><span class="op" id="4791189">{</span><span class="op" id="4791190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4791193">}</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4791196">fieldCache</span><span class="op" id="4791206">.</span><span class="ident" id="4791207">m</span><span class="op" id="4791208">[</span><span class="ident" id="4791209">t</span><span class="op" id="4791210">]</span>&nbsp;<span class="op" id="4791212">=</span>&nbsp;<span class="ident" id="4791214">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4791217">fieldCache</span><span class="op" id="4791227">.</span><span class="ident" id="4791228">Unlock</span><span class="op" id="4791234">(</span><span class="op" id="4791235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4791238">return</span>&nbsp;<span class="ident" id="4791245">f</span><br>
<span class="lineno"></span><span class="op" id="4791247">}</span>
</div>
</body>
</html>
