<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="935534">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="935589">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="935643">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="935694">package</span>&nbsp;<span class="ident" id="935702">runtime_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="935716">import</span>&nbsp;<span class="op" id="935723">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="935726">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="935737">&#34;testing&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="935748">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="935756">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="935765">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="935768">type</span>&nbsp;<span class="ident" id="935773">Tintptr</span>&nbsp;<span class="op" id="935781">*</span><span class="builtintype" id="935782">int</span>&nbsp;<span class="comment" id="935786">//&nbsp;assignable&nbsp;to&nbsp;*int</span><br>
<span class="lineno">15</span><span class="keyword" id="935808">type</span>&nbsp;<span class="ident" id="935813">Tint</span>&nbsp;<span class="builtintype" id="935818">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="935826">//&nbsp;*Tint&nbsp;implements&nbsp;Tinter,&nbsp;interface{}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="935867">func</span>&nbsp;<span class="op" id="935872">(</span><span class="ident" id="935873">t</span>&nbsp;<span class="op" id="935875">*</span><span class="ident" id="935876">Tint</span><span class="op" id="935880">)</span>&nbsp;<span class="ident" id="935882">m</span><span class="op" id="935883">(</span><span class="op" id="935884">)</span>&nbsp;<span class="op" id="935886">{</span><span class="op" id="935887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="935890">type</span>&nbsp;<span class="ident" id="935895">Tinter</span>&nbsp;<span class="keyword" id="935902">interface</span>&nbsp;<span class="op" id="935912">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="935915">m</span><span class="op" id="935916">(</span><span class="op" id="935917">)</span><br>
<span class="lineno"></span><span class="op" id="935919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="935922">func</span>&nbsp;<span class="ident" id="935927">TestFinalizerType</span><span class="op" id="935944">(</span><span class="ident" id="935945">t</span>&nbsp;<span class="op" id="935947">*</span><span class="ident" id="935948">testing</span><span class="op" id="935955">.</span><span class="ident" id="935956">T</span><span class="op" id="935957">)</span>&nbsp;<span class="op" id="935959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="935962">if</span>&nbsp;<span class="ident" id="935965">runtime</span><span class="op" id="935972">.</span><span class="ident" id="935973">GOARCH</span>&nbsp;<span class="op" id="935980">!=</span>&nbsp;<span class="string" id="935983">&#34;amd64&#34;</span>&nbsp;<span class="op" id="935991">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="935995">t</span><span class="op" id="935996">.</span><span class="ident" id="935997">Skipf</span><span class="op" id="936002">(</span><span class="string" id="936003">&#34;Skipping&nbsp;on&nbsp;non-amd64&nbsp;machine&#34;</span><span class="op" id="936034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="936037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="936041">ch</span>&nbsp;<span class="op" id="936044">:=</span>&nbsp;<span class="builtinfunc" id="936047">make</span><span class="op" id="936051">(</span><span class="keyword" id="936052">chan</span>&nbsp;<span class="builtintype" id="936057">bool</span><span class="op" id="936061">,</span>&nbsp;<span class="num" id="936063">10</span><span class="op" id="936065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="936068">finalize</span>&nbsp;<span class="op" id="936077">:=</span>&nbsp;<span class="keyword" id="936080">func</span><span class="op" id="936084">(</span><span class="ident" id="936085">x</span>&nbsp;<span class="op" id="936087">*</span><span class="builtintype" id="936088">int</span><span class="op" id="936091">)</span>&nbsp;<span class="op" id="936093">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="936097">if</span>&nbsp;<span class="op" id="936100">*</span><span class="ident" id="936101">x</span>&nbsp;<span class="op" id="936103">!=</span>&nbsp;<span class="num" id="936106">97531</span>&nbsp;<span class="op" id="936112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="936117">t</span><span class="op" id="936118">.</span><span class="ident" id="936119">Errorf</span><span class="op" id="936125">(</span><span class="string" id="936126">&#34;finalizer&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="936149">,</span>&nbsp;<span class="op" id="936151">*</span><span class="ident" id="936152">x</span><span class="op" id="936153">,</span>&nbsp;<span class="num" id="936155">97531</span><span class="op" id="936160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="936164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="936168">ch</span>&nbsp;<span class="op" id="936171">&lt;-</span>&nbsp;<span class="ident" id="936174">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="936180">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="936184">var</span>&nbsp;<span class="ident" id="936188">finalizerTests</span>&nbsp;<span class="op" id="936203">=</span>&nbsp;<span class="op" id="936205">[</span><span class="op" id="936206">]</span><span class="keyword" id="936207">struct</span>&nbsp;<span class="op" id="936214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="936218">convert</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="936228">func</span><span class="op" id="936232">(</span><span class="op" id="936233">*</span><span class="builtintype" id="936234">int</span><span class="op" id="936237">)</span>&nbsp;<span class="keyword" id="936239">interface</span><span class="op" id="936248">{</span><span class="op" id="936249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="936253">finalizer</span>&nbsp;<span class="keyword" id="936263">interface</span><span class="op" id="936272">{</span><span class="op" id="936273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="936276">}</span><span class="op" id="936277">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="936281">{</span><span class="keyword" id="936282">func</span><span class="op" id="936286">(</span><span class="ident" id="936287">x</span>&nbsp;<span class="op" id="936289">*</span><span class="builtintype" id="936290">int</span><span class="op" id="936293">)</span>&nbsp;<span class="keyword" id="936295">interface</span><span class="op" id="936304">{</span><span class="op" id="936305">}</span>&nbsp;<span class="op" id="936307">{</span>&nbsp;<span class="keyword" id="936309">return</span>&nbsp;<span class="ident" id="936316">x</span>&nbsp;<span class="op" id="936318">}</span><span class="op" id="936319">,</span>&nbsp;<span class="keyword" id="936321">func</span><span class="op" id="936325">(</span><span class="ident" id="936326">v</span>&nbsp;<span class="op" id="936328">*</span><span class="builtintype" id="936329">int</span><span class="op" id="936332">)</span>&nbsp;<span class="op" id="936334">{</span>&nbsp;<span class="ident" id="936336">finalize</span><span class="op" id="936344">(</span><span class="ident" id="936345">v</span><span class="op" id="936346">)</span>&nbsp;<span class="op" id="936348">}</span><span class="op" id="936349">}</span><span class="op" id="936350">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="936354">{</span><span class="keyword" id="936355">func</span><span class="op" id="936359">(</span><span class="ident" id="936360">x</span>&nbsp;<span class="op" id="936362">*</span><span class="builtintype" id="936363">int</span><span class="op" id="936366">)</span>&nbsp;<span class="keyword" id="936368">interface</span><span class="op" id="936377">{</span><span class="op" id="936378">}</span>&nbsp;<span class="op" id="936380">{</span>&nbsp;<span class="keyword" id="936382">return</span>&nbsp;<span class="ident" id="936389">Tintptr</span><span class="op" id="936396">(</span><span class="ident" id="936397">x</span><span class="op" id="936398">)</span>&nbsp;<span class="op" id="936400">}</span><span class="op" id="936401">,</span>&nbsp;<span class="keyword" id="936403">func</span><span class="op" id="936407">(</span><span class="ident" id="936408">v</span>&nbsp;<span class="ident" id="936410">Tintptr</span><span class="op" id="936417">)</span>&nbsp;<span class="op" id="936419">{</span>&nbsp;<span class="ident" id="936421">finalize</span><span class="op" id="936429">(</span><span class="ident" id="936430">v</span><span class="op" id="936431">)</span>&nbsp;<span class="op" id="936433">}</span><span class="op" id="936434">}</span><span class="op" id="936435">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="936439">{</span><span class="keyword" id="936440">func</span><span class="op" id="936444">(</span><span class="ident" id="936445">x</span>&nbsp;<span class="op" id="936447">*</span><span class="builtintype" id="936448">int</span><span class="op" id="936451">)</span>&nbsp;<span class="keyword" id="936453">interface</span><span class="op" id="936462">{</span><span class="op" id="936463">}</span>&nbsp;<span class="op" id="936465">{</span>&nbsp;<span class="keyword" id="936467">return</span>&nbsp;<span class="ident" id="936474">Tintptr</span><span class="op" id="936481">(</span><span class="ident" id="936482">x</span><span class="op" id="936483">)</span>&nbsp;<span class="op" id="936485">}</span><span class="op" id="936486">,</span>&nbsp;<span class="keyword" id="936488">func</span><span class="op" id="936492">(</span><span class="ident" id="936493">v</span>&nbsp;<span class="op" id="936495">*</span><span class="builtintype" id="936496">int</span><span class="op" id="936499">)</span>&nbsp;<span class="op" id="936501">{</span>&nbsp;<span class="ident" id="936503">finalize</span><span class="op" id="936511">(</span><span class="ident" id="936512">v</span><span class="op" id="936513">)</span>&nbsp;<span class="op" id="936515">}</span><span class="op" id="936516">}</span><span class="op" id="936517">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="936521">{</span><span class="keyword" id="936522">func</span><span class="op" id="936526">(</span><span class="ident" id="936527">x</span>&nbsp;<span class="op" id="936529">*</span><span class="builtintype" id="936530">int</span><span class="op" id="936533">)</span>&nbsp;<span class="keyword" id="936535">interface</span><span class="op" id="936544">{</span><span class="op" id="936545">}</span>&nbsp;<span class="op" id="936547">{</span>&nbsp;<span class="keyword" id="936549">return</span>&nbsp;<span class="op" id="936556">(</span><span class="op" id="936557">*</span><span class="ident" id="936558">Tint</span><span class="op" id="936562">)</span><span class="op" id="936563">(</span><span class="ident" id="936564">x</span><span class="op" id="936565">)</span>&nbsp;<span class="op" id="936567">}</span><span class="op" id="936568">,</span>&nbsp;<span class="keyword" id="936570">func</span><span class="op" id="936574">(</span><span class="ident" id="936575">v</span>&nbsp;<span class="op" id="936577">*</span><span class="ident" id="936578">Tint</span><span class="op" id="936582">)</span>&nbsp;<span class="op" id="936584">{</span>&nbsp;<span class="ident" id="936586">finalize</span><span class="op" id="936594">(</span><span class="op" id="936595">(</span><span class="op" id="936596">*</span><span class="builtintype" id="936597">int</span><span class="op" id="936600">)</span><span class="op" id="936601">(</span><span class="ident" id="936602">v</span><span class="op" id="936603">)</span><span class="op" id="936604">)</span>&nbsp;<span class="op" id="936606">}</span><span class="op" id="936607">}</span><span class="op" id="936608">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="936612">{</span><span class="keyword" id="936613">func</span><span class="op" id="936617">(</span><span class="ident" id="936618">x</span>&nbsp;<span class="op" id="936620">*</span><span class="builtintype" id="936621">int</span><span class="op" id="936624">)</span>&nbsp;<span class="keyword" id="936626">interface</span><span class="op" id="936635">{</span><span class="op" id="936636">}</span>&nbsp;<span class="op" id="936638">{</span>&nbsp;<span class="keyword" id="936640">return</span>&nbsp;<span class="op" id="936647">(</span><span class="op" id="936648">*</span><span class="ident" id="936649">Tint</span><span class="op" id="936653">)</span><span class="op" id="936654">(</span><span class="ident" id="936655">x</span><span class="op" id="936656">)</span>&nbsp;<span class="op" id="936658">}</span><span class="op" id="936659">,</span>&nbsp;<span class="keyword" id="936661">func</span><span class="op" id="936665">(</span><span class="ident" id="936666">v</span>&nbsp;<span class="ident" id="936668">Tinter</span><span class="op" id="936674">)</span>&nbsp;<span class="op" id="936676">{</span>&nbsp;<span class="ident" id="936678">finalize</span><span class="op" id="936686">(</span><span class="op" id="936687">(</span><span class="op" id="936688">*</span><span class="builtintype" id="936689">int</span><span class="op" id="936692">)</span><span class="op" id="936693">(</span><span class="ident" id="936694">v</span><span class="op" id="936695">.</span><span class="op" id="936696">(</span><span class="op" id="936697">*</span><span class="ident" id="936698">Tint</span><span class="op" id="936702">)</span><span class="op" id="936703">)</span><span class="op" id="936704">)</span>&nbsp;<span class="op" id="936706">}</span><span class="op" id="936707">}</span><span class="op" id="936708">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="936711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="936715">for</span>&nbsp;<span class="ident" id="936719">i</span><span class="op" id="936720">,</span>&nbsp;<span class="ident" id="936722">tt</span>&nbsp;<span class="op" id="936725">:=</span>&nbsp;<span class="keyword" id="936728">range</span>&nbsp;<span class="ident" id="936734">finalizerTests</span>&nbsp;<span class="op" id="936749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="936753">done</span>&nbsp;<span class="op" id="936758">:=</span>&nbsp;<span class="builtinfunc" id="936761">make</span><span class="op" id="936765">(</span><span class="keyword" id="936766">chan</span>&nbsp;<span class="builtintype" id="936771">bool</span><span class="op" id="936775">,</span>&nbsp;<span class="num" id="936777">1</span><span class="op" id="936778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="936782">go</span>&nbsp;<span class="keyword" id="936785">func</span><span class="op" id="936789">(</span><span class="op" id="936790">)</span>&nbsp;<span class="op" id="936792">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="936797">//&nbsp;allocate&nbsp;struct&nbsp;with&nbsp;pointer&nbsp;to&nbsp;avoid&nbsp;hitting&nbsp;tinyalloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="936860">//&nbsp;Otherwise&nbsp;we&nbsp;can&#39;t&nbsp;be&nbsp;sure&nbsp;when&nbsp;the&nbsp;allocation&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="936918">//&nbsp;be&nbsp;freed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="936934">type</span>&nbsp;<span class="ident" id="936939">T</span>&nbsp;<span class="keyword" id="936941">struct</span>&nbsp;<span class="op" id="936948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="936954">v</span>&nbsp;<span class="builtintype" id="936956">int</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="936964">p</span>&nbsp;<span class="ident" id="936966">unsafe</span><span class="op" id="936972">.</span><span class="ident" id="936973">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="936984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="936989">v</span>&nbsp;<span class="op" id="936991">:=</span>&nbsp;<span class="op" id="936994">&amp;</span><span class="builtinfunc" id="936995">new</span><span class="op" id="936998">(</span><span class="ident" id="936999">T</span><span class="op" id="937000">)</span><span class="op" id="937001">.</span><span class="ident" id="937002">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="937007">*</span><span class="ident" id="937008">v</span>&nbsp;<span class="op" id="937010">=</span>&nbsp;<span class="num" id="937012">97531</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937021">runtime</span><span class="op" id="937028">.</span><span class="ident" id="937029">SetFinalizer</span><span class="op" id="937041">(</span><span class="ident" id="937042">tt</span><span class="op" id="937044">.</span><span class="ident" id="937045">convert</span><span class="op" id="937052">(</span><span class="ident" id="937053">v</span><span class="op" id="937054">)</span><span class="op" id="937055">,</span>&nbsp;<span class="ident" id="937057">tt</span><span class="op" id="937059">.</span><span class="ident" id="937060">finalizer</span><span class="op" id="937069">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937074">v</span>&nbsp;<span class="op" id="937076">=</span>&nbsp;<span class="ident" id="937078">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937085">done</span>&nbsp;<span class="op" id="937090">&lt;-</span>&nbsp;<span class="ident" id="937093">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="937100">}</span><span class="op" id="937101">(</span><span class="op" id="937102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="937106">&lt;-</span><span class="ident" id="937108">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937115">runtime</span><span class="op" id="937122">.</span><span class="ident" id="937123">GC</span><span class="op" id="937125">(</span><span class="op" id="937126">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="937130">select</span>&nbsp;<span class="op" id="937137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="937141">case</span>&nbsp;<span class="op" id="937146">&lt;-</span><span class="ident" id="937148">ch</span><span class="op" id="937150">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="937154">case</span>&nbsp;<span class="op" id="937159">&lt;-</span><span class="ident" id="937161">time</span><span class="op" id="937165">.</span><span class="ident" id="937166">After</span><span class="op" id="937171">(</span><span class="ident" id="937172">time</span><span class="op" id="937176">.</span><span class="ident" id="937177">Second</span>&nbsp;<span class="op" id="937184">*</span>&nbsp;<span class="num" id="937186">4</span><span class="op" id="937187">)</span><span class="op" id="937188">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937193">t</span><span class="op" id="937194">.</span><span class="ident" id="937195">Errorf</span><span class="op" id="937201">(</span><span class="string" id="937202">&#34;#%d:&nbsp;finalizer&nbsp;for&nbsp;type&nbsp;%T&nbsp;didn&#39;t&nbsp;run&#34;</span><span class="op" id="937241">,</span>&nbsp;<span class="ident" id="937243">i</span><span class="op" id="937244">,</span>&nbsp;<span class="ident" id="937246">tt</span><span class="op" id="937248">.</span><span class="ident" id="937249">finalizer</span><span class="op" id="937258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="937262">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="937265">}</span><br>
<span class="lineno"></span><span class="op" id="937267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="937270">type</span>&nbsp;<span class="ident" id="937275">bigValue</span>&nbsp;<span class="keyword" id="937284">struct</span>&nbsp;<span class="op" id="937291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937294">fill</span>&nbsp;<span class="ident" id="937299">uint64</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937307">it</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="937312">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937318">up</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="937323">string</span><br>
<span class="lineno"></span><span class="op" id="937330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="937333">func</span>&nbsp;<span class="ident" id="937338">TestFinalizerInterfaceBig</span><span class="op" id="937363">(</span><span class="ident" id="937364">t</span>&nbsp;<span class="op" id="937366">*</span><span class="ident" id="937367">testing</span><span class="op" id="937374">.</span><span class="ident" id="937375">T</span><span class="op" id="937376">)</span>&nbsp;<span class="op" id="937378">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="937381">if</span>&nbsp;<span class="ident" id="937384">runtime</span><span class="op" id="937391">.</span><span class="ident" id="937392">GOARCH</span>&nbsp;<span class="op" id="937399">!=</span>&nbsp;<span class="string" id="937402">&#34;amd64&#34;</span>&nbsp;<span class="op" id="937410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937414">t</span><span class="op" id="937415">.</span><span class="ident" id="937416">Skipf</span><span class="op" id="937421">(</span><span class="string" id="937422">&#34;Skipping&nbsp;on&nbsp;non-amd64&nbsp;machine&#34;</span><span class="op" id="937453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="937456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937459">ch</span>&nbsp;<span class="op" id="937462">:=</span>&nbsp;<span class="builtinfunc" id="937465">make</span><span class="op" id="937469">(</span><span class="keyword" id="937470">chan</span>&nbsp;<span class="builtintype" id="937475">bool</span><span class="op" id="937479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937482">done</span>&nbsp;<span class="op" id="937487">:=</span>&nbsp;<span class="builtinfunc" id="937490">make</span><span class="op" id="937494">(</span><span class="keyword" id="937495">chan</span>&nbsp;<span class="builtintype" id="937500">bool</span><span class="op" id="937504">,</span>&nbsp;<span class="num" id="937506">1</span><span class="op" id="937507">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="937510">go</span>&nbsp;<span class="keyword" id="937513">func</span><span class="op" id="937517">(</span><span class="op" id="937518">)</span>&nbsp;<span class="op" id="937520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937524">v</span>&nbsp;<span class="op" id="937526">:=</span>&nbsp;<span class="op" id="937529">&amp;</span><span class="ident" id="937530">bigValue</span><span class="op" id="937538">{</span><span class="num" id="937539">0xDEADBEEFDEADBEEF</span><span class="op" id="937557">,</span>&nbsp;<span class="ident" id="937559">true</span><span class="op" id="937563">,</span>&nbsp;<span class="string" id="937565">&#34;It&nbsp;matters&nbsp;not&nbsp;how&nbsp;strait&nbsp;the&nbsp;gate&#34;</span><span class="op" id="937601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937605">old</span>&nbsp;<span class="op" id="937609">:=</span>&nbsp;<span class="op" id="937612">*</span><span class="ident" id="937613">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937617">runtime</span><span class="op" id="937624">.</span><span class="ident" id="937625">SetFinalizer</span><span class="op" id="937637">(</span><span class="ident" id="937638">v</span><span class="op" id="937639">,</span>&nbsp;<span class="keyword" id="937641">func</span><span class="op" id="937645">(</span><span class="ident" id="937646">v</span>&nbsp;<span class="keyword" id="937648">interface</span><span class="op" id="937657">{</span><span class="op" id="937658">}</span><span class="op" id="937659">)</span>&nbsp;<span class="op" id="937661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937666">i</span><span class="op" id="937667">,</span>&nbsp;<span class="ident" id="937669">ok</span>&nbsp;<span class="op" id="937672">:=</span>&nbsp;<span class="ident" id="937675">v</span><span class="op" id="937676">.</span><span class="op" id="937677">(</span><span class="op" id="937678">*</span><span class="ident" id="937679">bigValue</span><span class="op" id="937687">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="937692">if</span>&nbsp;<span class="op" id="937695">!</span><span class="ident" id="937696">ok</span>&nbsp;<span class="op" id="937699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937705">t</span><span class="op" id="937706">.</span><span class="ident" id="937707">Errorf</span><span class="op" id="937713">(</span><span class="string" id="937714">&#34;finalizer&nbsp;called&nbsp;with&nbsp;type&nbsp;%T,&nbsp;want&nbsp;*bigValue&#34;</span><span class="op" id="937761">,</span>&nbsp;<span class="ident" id="937763">v</span><span class="op" id="937764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="937769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="937774">if</span>&nbsp;<span class="op" id="937777">*</span><span class="ident" id="937778">i</span>&nbsp;<span class="op" id="937780">!=</span>&nbsp;<span class="ident" id="937783">old</span>&nbsp;<span class="op" id="937787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937793">t</span><span class="op" id="937794">.</span><span class="ident" id="937795">Errorf</span><span class="op" id="937801">(</span><span class="string" id="937802">&#34;finalizer&nbsp;called&nbsp;with&nbsp;%+v,&nbsp;want&nbsp;%+v&#34;</span><span class="op" id="937839">,</span>&nbsp;<span class="op" id="937841">*</span><span class="ident" id="937842">i</span><span class="op" id="937843">,</span>&nbsp;<span class="ident" id="937845">old</span><span class="op" id="937848">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="937853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="937858">close</span><span class="op" id="937863">(</span><span class="ident" id="937864">ch</span><span class="op" id="937866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="937870">}</span><span class="op" id="937871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937875">v</span>&nbsp;<span class="op" id="937877">=</span>&nbsp;<span class="ident" id="937879">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937885">done</span>&nbsp;<span class="op" id="937890">&lt;-</span>&nbsp;<span class="ident" id="937893">true</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="937899">}</span><span class="op" id="937900">(</span><span class="op" id="937901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="937904">&lt;-</span><span class="ident" id="937906">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937912">runtime</span><span class="op" id="937919">.</span><span class="ident" id="937920">GC</span><span class="op" id="937922">(</span><span class="op" id="937923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="937926">select</span>&nbsp;<span class="op" id="937933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="937936">case</span>&nbsp;<span class="op" id="937941">&lt;-</span><span class="ident" id="937943">ch</span><span class="op" id="937945">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="937948">case</span>&nbsp;<span class="op" id="937953">&lt;-</span><span class="ident" id="937955">time</span><span class="op" id="937959">.</span><span class="ident" id="937960">After</span><span class="op" id="937965">(</span><span class="num" id="937966">4</span>&nbsp;<span class="op" id="937968">*</span>&nbsp;<span class="ident" id="937970">time</span><span class="op" id="937974">.</span><span class="ident" id="937975">Second</span><span class="op" id="937981">)</span><span class="op" id="937982">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="937986">t</span><span class="op" id="937987">.</span><span class="ident" id="937988">Errorf</span><span class="op" id="937994">(</span><span class="string" id="937995">&#34;finalizer&nbsp;for&nbsp;type&nbsp;*bigValue&nbsp;didn&#39;t&nbsp;run&#34;</span><span class="op" id="938036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="938039">}</span><br>
<span class="lineno"></span><span class="op" id="938041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="938044">func</span>&nbsp;<span class="ident" id="938049">fin</span><span class="op" id="938052">(</span><span class="ident" id="938053">v</span>&nbsp;<span class="op" id="938055">*</span><span class="builtintype" id="938056">int</span><span class="op" id="938059">)</span>&nbsp;<span class="op" id="938061">{</span><br>
<span class="lineno"></span><span class="op" id="938063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="938066">//&nbsp;Verify&nbsp;we&nbsp;don&#39;t&nbsp;crash&nbsp;at&nbsp;least.&nbsp;golang.org/issue/6857</span><br>
<span class="lineno"></span><span class="keyword" id="938123">func</span>&nbsp;<span class="ident" id="938128">TestFinalizerZeroSizedStruct</span><span class="op" id="938156">(</span><span class="ident" id="938157">t</span>&nbsp;<span class="op" id="938159">*</span><span class="ident" id="938160">testing</span><span class="op" id="938167">.</span><span class="ident" id="938168">T</span><span class="op" id="938169">)</span>&nbsp;<span class="op" id="938171">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="938174">type</span>&nbsp;<span class="ident" id="938179">Z</span>&nbsp;<span class="keyword" id="938181">struct</span><span class="op" id="938187">{</span><span class="op" id="938188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="938191">z</span>&nbsp;<span class="op" id="938193">:=</span>&nbsp;<span class="builtinfunc" id="938196">new</span><span class="op" id="938199">(</span><span class="ident" id="938200">Z</span><span class="op" id="938201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="938204">runtime</span><span class="op" id="938211">.</span><span class="ident" id="938212">SetFinalizer</span><span class="op" id="938224">(</span><span class="ident" id="938225">z</span><span class="op" id="938226">,</span>&nbsp;<span class="keyword" id="938228">func</span><span class="op" id="938232">(</span><span class="op" id="938233">*</span><span class="ident" id="938234">Z</span><span class="op" id="938235">)</span>&nbsp;<span class="op" id="938237">{</span><span class="op" id="938238">}</span><span class="op" id="938239">)</span><br>
<span class="lineno"></span><span class="op" id="938241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="938244">func</span>&nbsp;<span class="ident" id="938249">BenchmarkFinalizer</span><span class="op" id="938267">(</span><span class="ident" id="938268">b</span>&nbsp;<span class="op" id="938270">*</span><span class="ident" id="938271">testing</span><span class="op" id="938278">.</span><span class="ident" id="938279">B</span><span class="op" id="938280">)</span>&nbsp;<span class="op" id="938282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="938285">const</span>&nbsp;<span class="ident" id="938291">Batch</span>&nbsp;<span class="op" id="938297">=</span>&nbsp;<span class="num" id="938299">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="938305">b</span><span class="op" id="938306">.</span><span class="ident" id="938307">RunParallel</span><span class="op" id="938318">(</span><span class="keyword" id="938319">func</span><span class="op" id="938323">(</span><span class="ident" id="938324">pb</span>&nbsp;<span class="op" id="938327">*</span><span class="ident" id="938328">testing</span><span class="op" id="938335">.</span><span class="ident" id="938336">PB</span><span class="op" id="938338">)</span>&nbsp;<span class="op" id="938340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="938344">var</span>&nbsp;<span class="ident" id="938348">data</span>&nbsp;<span class="op" id="938353">[</span><span class="ident" id="938354">Batch</span><span class="op" id="938359">]</span><span class="op" id="938360">*</span><span class="builtintype" id="938361">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="938367">for</span>&nbsp;<span class="ident" id="938371">i</span>&nbsp;<span class="op" id="938373">:=</span>&nbsp;<span class="num" id="938376">0</span><span class="op" id="938377">;</span>&nbsp;<span class="ident" id="938379">i</span>&nbsp;<span class="op" id="938381">&lt;</span>&nbsp;<span class="ident" id="938383">Batch</span><span class="op" id="938388">;</span>&nbsp;<span class="ident" id="938390">i</span><span class="op" id="938391">++</span>&nbsp;<span class="op" id="938394">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="938399">data</span><span class="op" id="938403">[</span><span class="ident" id="938404">i</span><span class="op" id="938405">]</span>&nbsp;<span class="op" id="938407">=</span>&nbsp;<span class="builtinfunc" id="938409">new</span><span class="op" id="938412">(</span><span class="builtintype" id="938413">int</span><span class="op" id="938416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="938420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="938424">for</span>&nbsp;<span class="ident" id="938428">pb</span><span class="op" id="938430">.</span><span class="ident" id="938431">Next</span><span class="op" id="938435">(</span><span class="op" id="938436">)</span>&nbsp;<span class="op" id="938438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="938443">for</span>&nbsp;<span class="ident" id="938447">i</span>&nbsp;<span class="op" id="938449">:=</span>&nbsp;<span class="num" id="938452">0</span><span class="op" id="938453">;</span>&nbsp;<span class="ident" id="938455">i</span>&nbsp;<span class="op" id="938457">&lt;</span>&nbsp;<span class="ident" id="938459">Batch</span><span class="op" id="938464">;</span>&nbsp;<span class="ident" id="938466">i</span><span class="op" id="938467">++</span>&nbsp;<span class="op" id="938470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="938476">runtime</span><span class="op" id="938483">.</span><span class="ident" id="938484">SetFinalizer</span><span class="op" id="938496">(</span><span class="ident" id="938497">data</span><span class="op" id="938501">[</span><span class="ident" id="938502">i</span><span class="op" id="938503">]</span><span class="op" id="938504">,</span>&nbsp;<span class="ident" id="938506">fin</span><span class="op" id="938509">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="938514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="938519">for</span>&nbsp;<span class="ident" id="938523">i</span>&nbsp;<span class="op" id="938525">:=</span>&nbsp;<span class="num" id="938528">0</span><span class="op" id="938529">;</span>&nbsp;<span class="ident" id="938531">i</span>&nbsp;<span class="op" id="938533">&lt;</span>&nbsp;<span class="ident" id="938535">Batch</span><span class="op" id="938540">;</span>&nbsp;<span class="ident" id="938542">i</span><span class="op" id="938543">++</span>&nbsp;<span class="op" id="938546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="938552">runtime</span><span class="op" id="938559">.</span><span class="ident" id="938560">SetFinalizer</span><span class="op" id="938572">(</span><span class="ident" id="938573">data</span><span class="op" id="938577">[</span><span class="ident" id="938578">i</span><span class="op" id="938579">]</span><span class="op" id="938580">,</span>&nbsp;<span class="ident" id="938582">nil</span><span class="op" id="938585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="938590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="938594">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="938597">}</span><span class="op" id="938598">)</span><br>
<span class="lineno"></span><span class="op" id="938600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="938603">func</span>&nbsp;<span class="ident" id="938608">BenchmarkFinalizerRun</span><span class="op" id="938629">(</span><span class="ident" id="938630">b</span>&nbsp;<span class="op" id="938632">*</span><span class="ident" id="938633">testing</span><span class="op" id="938640">.</span><span class="ident" id="938641">B</span><span class="op" id="938642">)</span>&nbsp;<span class="op" id="938644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="938647">b</span><span class="op" id="938648">.</span><span class="ident" id="938649">RunParallel</span><span class="op" id="938660">(</span><span class="keyword" id="938661">func</span><span class="op" id="938665">(</span><span class="ident" id="938666">pb</span>&nbsp;<span class="op" id="938669">*</span><span class="ident" id="938670">testing</span><span class="op" id="938677">.</span><span class="ident" id="938678">PB</span><span class="op" id="938680">)</span>&nbsp;<span class="op" id="938682">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="938686">for</span>&nbsp;<span class="ident" id="938690">pb</span><span class="op" id="938692">.</span><span class="ident" id="938693">Next</span><span class="op" id="938697">(</span><span class="op" id="938698">)</span>&nbsp;<span class="op" id="938700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="938705">v</span>&nbsp;<span class="op" id="938707">:=</span>&nbsp;<span class="builtinfunc" id="938710">new</span><span class="op" id="938713">(</span><span class="builtintype" id="938714">int</span><span class="op" id="938717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="938722">runtime</span><span class="op" id="938729">.</span><span class="ident" id="938730">SetFinalizer</span><span class="op" id="938742">(</span><span class="ident" id="938743">v</span><span class="op" id="938744">,</span>&nbsp;<span class="ident" id="938746">fin</span><span class="op" id="938749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="938753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="938756">}</span><span class="op" id="938757">)</span><br>
<span class="lineno">145</span><span class="op" id="938759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="938762">//&nbsp;One&nbsp;chunk&nbsp;must&nbsp;be&nbsp;exactly&nbsp;one&nbsp;sizeclass&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="938814">//&nbsp;It&nbsp;should&nbsp;be&nbsp;a&nbsp;sizeclass&nbsp;not&nbsp;used&nbsp;much&nbsp;by&nbsp;others,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="938873">//&nbsp;have&nbsp;a&nbsp;greater&nbsp;chance&nbsp;of&nbsp;finding&nbsp;adjacent&nbsp;ones.</span><br>
<span class="lineno">150</span><span class="comment" id="938924">//&nbsp;size&nbsp;class&nbsp;19:&nbsp;320&nbsp;byte&nbsp;objects,&nbsp;25&nbsp;per&nbsp;page,&nbsp;1&nbsp;page&nbsp;alloc&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span><span class="keyword" id="938996">const</span>&nbsp;<span class="ident" id="939002">objsize</span>&nbsp;<span class="op" id="939010">=</span>&nbsp;<span class="num" id="939012">320</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="939017">type</span>&nbsp;<span class="ident" id="939022">objtype</span>&nbsp;<span class="op" id="939030">[</span><span class="ident" id="939031">objsize</span><span class="op" id="939038">]</span><span class="builtintype" id="939039">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="939045">func</span>&nbsp;<span class="ident" id="939050">adjChunks</span><span class="op" id="939059">(</span><span class="op" id="939060">)</span>&nbsp;<span class="op" id="939062">(</span><span class="op" id="939063">*</span><span class="ident" id="939064">objtype</span><span class="op" id="939071">,</span>&nbsp;<span class="op" id="939073">*</span><span class="ident" id="939074">objtype</span><span class="op" id="939081">)</span>&nbsp;<span class="op" id="939083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="939086">var</span>&nbsp;<span class="ident" id="939090">s</span>&nbsp;<span class="op" id="939092">[</span><span class="op" id="939093">]</span><span class="op" id="939094">*</span><span class="ident" id="939095">objtype</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="939105">for</span>&nbsp;<span class="op" id="939109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="939113">c</span>&nbsp;<span class="op" id="939115">:=</span>&nbsp;<span class="builtinfunc" id="939118">new</span><span class="op" id="939121">(</span><span class="ident" id="939122">objtype</span><span class="op" id="939129">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="939133">for</span>&nbsp;<span class="ident" id="939137">_</span><span class="op" id="939138">,</span>&nbsp;<span class="ident" id="939140">d</span>&nbsp;<span class="op" id="939142">:=</span>&nbsp;<span class="keyword" id="939145">range</span>&nbsp;<span class="ident" id="939151">s</span>&nbsp;<span class="op" id="939153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="939158">if</span>&nbsp;<span class="builtintype" id="939161">uintptr</span><span class="op" id="939168">(</span><span class="ident" id="939169">unsafe</span><span class="op" id="939175">.</span><span class="ident" id="939176">Pointer</span><span class="op" id="939183">(</span><span class="ident" id="939184">c</span><span class="op" id="939185">)</span><span class="op" id="939186">)</span><span class="op" id="939187">+</span><span class="ident" id="939188">unsafe</span><span class="op" id="939194">.</span><span class="ident" id="939195">Sizeof</span><span class="op" id="939201">(</span><span class="op" id="939202">*</span><span class="ident" id="939203">c</span><span class="op" id="939204">)</span>&nbsp;<span class="op" id="939206">==</span>&nbsp;<span class="builtintype" id="939209">uintptr</span><span class="op" id="939216">(</span><span class="ident" id="939217">unsafe</span><span class="op" id="939223">.</span><span class="ident" id="939224">Pointer</span><span class="op" id="939231">(</span><span class="ident" id="939232">d</span><span class="op" id="939233">)</span><span class="op" id="939234">)</span>&nbsp;<span class="op" id="939236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="939242">return</span>&nbsp;<span class="ident" id="939249">c</span><span class="op" id="939250">,</span>&nbsp;<span class="ident" id="939252">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="939257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="939262">if</span>&nbsp;<span class="builtintype" id="939265">uintptr</span><span class="op" id="939272">(</span><span class="ident" id="939273">unsafe</span><span class="op" id="939279">.</span><span class="ident" id="939280">Pointer</span><span class="op" id="939287">(</span><span class="ident" id="939288">d</span><span class="op" id="939289">)</span><span class="op" id="939290">)</span><span class="op" id="939291">+</span><span class="ident" id="939292">unsafe</span><span class="op" id="939298">.</span><span class="ident" id="939299">Sizeof</span><span class="op" id="939305">(</span><span class="op" id="939306">*</span><span class="ident" id="939307">c</span><span class="op" id="939308">)</span>&nbsp;<span class="op" id="939310">==</span>&nbsp;<span class="builtintype" id="939313">uintptr</span><span class="op" id="939320">(</span><span class="ident" id="939321">unsafe</span><span class="op" id="939327">.</span><span class="ident" id="939328">Pointer</span><span class="op" id="939335">(</span><span class="ident" id="939336">c</span><span class="op" id="939337">)</span><span class="op" id="939338">)</span>&nbsp;<span class="op" id="939340">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="939346">return</span>&nbsp;<span class="ident" id="939353">d</span><span class="op" id="939354">,</span>&nbsp;<span class="ident" id="939356">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="939361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="939365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="939369">s</span>&nbsp;<span class="op" id="939371">=</span>&nbsp;<span class="builtinfunc" id="939373">append</span><span class="op" id="939379">(</span><span class="ident" id="939380">s</span><span class="op" id="939381">,</span>&nbsp;<span class="ident" id="939383">c</span><span class="op" id="939384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="939387">}</span><br>
<span class="lineno">170</span><span class="op" id="939389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="939392">//&nbsp;Make&nbsp;sure&nbsp;an&nbsp;empty&nbsp;slice&nbsp;on&nbsp;the&nbsp;stack&nbsp;doesn&#39;t&nbsp;pin&nbsp;the&nbsp;next&nbsp;object&nbsp;in&nbsp;memory.</span><br>
<span class="lineno"></span><span class="keyword" id="939472">func</span>&nbsp;<span class="ident" id="939477">TestEmptySlice</span><span class="op" id="939491">(</span><span class="ident" id="939492">t</span>&nbsp;<span class="op" id="939494">*</span><span class="ident" id="939495">testing</span><span class="op" id="939502">.</span><span class="ident" id="939503">T</span><span class="op" id="939504">)</span>&nbsp;<span class="op" id="939506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="939509">if</span>&nbsp;<span class="ident" id="939512">true</span>&nbsp;<span class="op" id="939517">{</span>&nbsp;<span class="comment" id="939519">//&nbsp;disable&nbsp;until&nbsp;bug&nbsp;7564&nbsp;is&nbsp;fixed.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="939557">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="939565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="939568">x</span><span class="op" id="939569">,</span>&nbsp;<span class="ident" id="939571">y</span>&nbsp;<span class="op" id="939573">:=</span>&nbsp;<span class="ident" id="939576">adjChunks</span><span class="op" id="939585">(</span><span class="op" id="939586">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="939590">//&nbsp;the&nbsp;pointer&nbsp;inside&nbsp;xs&nbsp;points&nbsp;to&nbsp;y.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="939629">xs</span>&nbsp;<span class="op" id="939632">:=</span>&nbsp;<span class="ident" id="939635">x</span><span class="op" id="939636">[</span><span class="ident" id="939637">objsize</span><span class="op" id="939644">:</span><span class="op" id="939645">]</span>&nbsp;<span class="comment" id="939647">//&nbsp;change&nbsp;objsize&nbsp;to&nbsp;objsize-1&nbsp;and&nbsp;the&nbsp;test&nbsp;passes</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="939700">fin</span>&nbsp;<span class="op" id="939704">:=</span>&nbsp;<span class="builtinfunc" id="939707">make</span><span class="op" id="939711">(</span><span class="keyword" id="939712">chan</span>&nbsp;<span class="builtintype" id="939717">bool</span><span class="op" id="939721">,</span>&nbsp;<span class="num" id="939723">1</span><span class="op" id="939724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="939727">runtime</span><span class="op" id="939734">.</span><span class="ident" id="939735">SetFinalizer</span><span class="op" id="939747">(</span><span class="ident" id="939748">y</span><span class="op" id="939749">,</span>&nbsp;<span class="keyword" id="939751">func</span><span class="op" id="939755">(</span><span class="ident" id="939756">z</span>&nbsp;<span class="op" id="939758">*</span><span class="ident" id="939759">objtype</span><span class="op" id="939766">)</span>&nbsp;<span class="op" id="939768">{</span>&nbsp;<span class="ident" id="939770">fin</span>&nbsp;<span class="op" id="939774">&lt;-</span>&nbsp;<span class="ident" id="939777">true</span>&nbsp;<span class="op" id="939782">}</span><span class="op" id="939783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="939786">runtime</span><span class="op" id="939793">.</span><span class="ident" id="939794">GC</span><span class="op" id="939796">(</span><span class="op" id="939797">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="939800">select</span>&nbsp;<span class="op" id="939807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="939810">case</span>&nbsp;<span class="op" id="939815">&lt;-</span><span class="ident" id="939817">fin</span><span class="op" id="939820">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="939823">case</span>&nbsp;<span class="op" id="939828">&lt;-</span><span class="ident" id="939830">time</span><span class="op" id="939834">.</span><span class="ident" id="939835">After</span><span class="op" id="939840">(</span><span class="num" id="939841">4</span>&nbsp;<span class="op" id="939843">*</span>&nbsp;<span class="ident" id="939845">time</span><span class="op" id="939849">.</span><span class="ident" id="939850">Second</span><span class="op" id="939856">)</span><span class="op" id="939857">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="939861">t</span><span class="op" id="939862">.</span><span class="ident" id="939863">Errorf</span><span class="op" id="939869">(</span><span class="string" id="939870">&#34;finalizer&nbsp;of&nbsp;next&nbsp;object&nbsp;in&nbsp;memory&nbsp;didn&#39;t&nbsp;run&#34;</span><span class="op" id="939917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="939920">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="939923">xsglobal</span>&nbsp;<span class="op" id="939932">=</span>&nbsp;<span class="ident" id="939934">xs</span>&nbsp;<span class="comment" id="939937">//&nbsp;keep&nbsp;empty&nbsp;slice&nbsp;alive&nbsp;until&nbsp;here</span><br>
<span class="lineno"></span><span class="op" id="939974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="939977">var</span>&nbsp;<span class="ident" id="939981">xsglobal</span>&nbsp;<span class="op" id="939990">[</span><span class="op" id="939991">]</span><span class="builtintype" id="939992">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="939998">func</span>&nbsp;<span class="ident" id="940003">adjStringChunk</span><span class="op" id="940017">(</span><span class="op" id="940018">)</span>&nbsp;<span class="op" id="940020">(</span><span class="builtintype" id="940021">string</span><span class="op" id="940027">,</span>&nbsp;<span class="op" id="940029">*</span><span class="ident" id="940030">objtype</span><span class="op" id="940037">)</span>&nbsp;<span class="op" id="940039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940042">b</span>&nbsp;<span class="op" id="940044">:=</span>&nbsp;<span class="builtinfunc" id="940047">make</span><span class="op" id="940051">(</span><span class="op" id="940052">[</span><span class="op" id="940053">]</span><span class="builtintype" id="940054">byte</span><span class="op" id="940058">,</span>&nbsp;<span class="ident" id="940060">objsize</span><span class="op" id="940067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="940070">for</span>&nbsp;<span class="op" id="940074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940078">s</span>&nbsp;<span class="op" id="940080">:=</span>&nbsp;<span class="builtintype" id="940083">string</span><span class="op" id="940089">(</span><span class="ident" id="940090">b</span><span class="op" id="940091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940095">t</span>&nbsp;<span class="op" id="940097">:=</span>&nbsp;<span class="builtinfunc" id="940100">new</span><span class="op" id="940103">(</span><span class="ident" id="940104">objtype</span><span class="op" id="940111">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940115">p</span>&nbsp;<span class="op" id="940117">:=</span>&nbsp;<span class="op" id="940120">*</span><span class="op" id="940121">(</span><span class="op" id="940122">*</span><span class="builtintype" id="940123">uintptr</span><span class="op" id="940130">)</span><span class="op" id="940131">(</span><span class="ident" id="940132">unsafe</span><span class="op" id="940138">.</span><span class="ident" id="940139">Pointer</span><span class="op" id="940146">(</span><span class="op" id="940147">&amp;</span><span class="ident" id="940148">s</span><span class="op" id="940149">)</span><span class="op" id="940150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940154">q</span>&nbsp;<span class="op" id="940156">:=</span>&nbsp;<span class="builtintype" id="940159">uintptr</span><span class="op" id="940166">(</span><span class="ident" id="940167">unsafe</span><span class="op" id="940173">.</span><span class="ident" id="940174">Pointer</span><span class="op" id="940181">(</span><span class="ident" id="940182">t</span><span class="op" id="940183">)</span><span class="op" id="940184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="940188">if</span>&nbsp;<span class="ident" id="940191">p</span><span class="op" id="940192">+</span><span class="ident" id="940193">objsize</span>&nbsp;<span class="op" id="940201">==</span>&nbsp;<span class="ident" id="940204">q</span>&nbsp;<span class="op" id="940206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="940211">return</span>&nbsp;<span class="ident" id="940218">s</span><span class="op" id="940219">,</span>&nbsp;<span class="ident" id="940221">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="940225">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="940228">}</span><br>
<span class="lineno"></span><span class="op" id="940230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="940233">//&nbsp;Make&nbsp;sure&nbsp;an&nbsp;empty&nbsp;string&nbsp;on&nbsp;the&nbsp;stack&nbsp;doesn&#39;t&nbsp;pin&nbsp;the&nbsp;next&nbsp;object&nbsp;in&nbsp;memory.</span><br>
<span class="lineno"></span><span class="keyword" id="940314">func</span>&nbsp;<span class="ident" id="940319">TestEmptyString</span><span class="op" id="940334">(</span><span class="ident" id="940335">t</span>&nbsp;<span class="op" id="940337">*</span><span class="ident" id="940338">testing</span><span class="op" id="940345">.</span><span class="ident" id="940346">T</span><span class="op" id="940347">)</span>&nbsp;<span class="op" id="940349">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940352">x</span><span class="op" id="940353">,</span>&nbsp;<span class="ident" id="940355">y</span>&nbsp;<span class="op" id="940357">:=</span>&nbsp;<span class="ident" id="940360">adjStringChunk</span><span class="op" id="940374">(</span><span class="op" id="940375">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940379">ss</span>&nbsp;<span class="op" id="940382">:=</span>&nbsp;<span class="ident" id="940385">x</span><span class="op" id="940386">[</span><span class="ident" id="940387">objsize</span><span class="op" id="940394">:</span><span class="op" id="940395">]</span>&nbsp;<span class="comment" id="940397">//&nbsp;change&nbsp;objsize&nbsp;to&nbsp;objsize-1&nbsp;and&nbsp;the&nbsp;test&nbsp;passes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940449">fin</span>&nbsp;<span class="op" id="940453">:=</span>&nbsp;<span class="builtinfunc" id="940456">make</span><span class="op" id="940460">(</span><span class="keyword" id="940461">chan</span>&nbsp;<span class="builtintype" id="940466">bool</span><span class="op" id="940470">,</span>&nbsp;<span class="num" id="940472">1</span><span class="op" id="940473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="940476">//&nbsp;set&nbsp;finalizer&nbsp;on&nbsp;string&nbsp;contents&nbsp;of&nbsp;y</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940518">runtime</span><span class="op" id="940525">.</span><span class="ident" id="940526">SetFinalizer</span><span class="op" id="940538">(</span><span class="ident" id="940539">y</span><span class="op" id="940540">,</span>&nbsp;<span class="keyword" id="940542">func</span><span class="op" id="940546">(</span><span class="ident" id="940547">z</span>&nbsp;<span class="op" id="940549">*</span><span class="ident" id="940550">objtype</span><span class="op" id="940557">)</span>&nbsp;<span class="op" id="940559">{</span>&nbsp;<span class="ident" id="940561">fin</span>&nbsp;<span class="op" id="940565">&lt;-</span>&nbsp;<span class="ident" id="940568">true</span>&nbsp;<span class="op" id="940573">}</span><span class="op" id="940574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940577">runtime</span><span class="op" id="940584">.</span><span class="ident" id="940585">GC</span><span class="op" id="940587">(</span><span class="op" id="940588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="940591">select</span>&nbsp;<span class="op" id="940598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="940601">case</span>&nbsp;<span class="op" id="940606">&lt;-</span><span class="ident" id="940608">fin</span><span class="op" id="940611">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="940614">case</span>&nbsp;<span class="op" id="940619">&lt;-</span><span class="ident" id="940621">time</span><span class="op" id="940625">.</span><span class="ident" id="940626">After</span><span class="op" id="940631">(</span><span class="num" id="940632">4</span>&nbsp;<span class="op" id="940634">*</span>&nbsp;<span class="ident" id="940636">time</span><span class="op" id="940640">.</span><span class="ident" id="940641">Second</span><span class="op" id="940647">)</span><span class="op" id="940648">:</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940652">t</span><span class="op" id="940653">.</span><span class="ident" id="940654">Errorf</span><span class="op" id="940660">(</span><span class="string" id="940661">&#34;finalizer&nbsp;of&nbsp;next&nbsp;string&nbsp;in&nbsp;memory&nbsp;didn&#39;t&nbsp;run&#34;</span><span class="op" id="940708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="940711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940714">ssglobal</span>&nbsp;<span class="op" id="940723">=</span>&nbsp;<span class="ident" id="940725">ss</span>&nbsp;<span class="comment" id="940728">//&nbsp;keep&nbsp;0-length&nbsp;string&nbsp;live&nbsp;until&nbsp;here</span><br>
<span class="lineno"></span><span class="op" id="940768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="940771">var</span>&nbsp;<span class="ident" id="940775">ssglobal</span>&nbsp;<span class="builtintype" id="940784">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="940792">//&nbsp;Test&nbsp;for&nbsp;issue&nbsp;7656.</span><br>
<span class="lineno"></span><span class="keyword" id="940816">func</span>&nbsp;<span class="ident" id="940821">TestFinalizerOnGlobal</span><span class="op" id="940842">(</span><span class="ident" id="940843">t</span>&nbsp;<span class="op" id="940845">*</span><span class="ident" id="940846">testing</span><span class="op" id="940853">.</span><span class="ident" id="940854">T</span><span class="op" id="940855">)</span>&nbsp;<span class="op" id="940857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940860">runtime</span><span class="op" id="940867">.</span><span class="ident" id="940868">SetFinalizer</span><span class="op" id="940880">(</span><span class="ident" id="940881">Foo1</span><span class="op" id="940885">,</span>&nbsp;<span class="keyword" id="940887">func</span><span class="op" id="940891">(</span><span class="ident" id="940892">p</span>&nbsp;<span class="op" id="940894">*</span><span class="ident" id="940895">Object1</span><span class="op" id="940902">)</span>&nbsp;<span class="op" id="940904">{</span><span class="op" id="940905">}</span><span class="op" id="940906">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940909">runtime</span><span class="op" id="940916">.</span><span class="ident" id="940917">SetFinalizer</span><span class="op" id="940929">(</span><span class="ident" id="940930">Foo2</span><span class="op" id="940934">,</span>&nbsp;<span class="keyword" id="940936">func</span><span class="op" id="940940">(</span><span class="ident" id="940941">p</span>&nbsp;<span class="op" id="940943">*</span><span class="ident" id="940944">Object2</span><span class="op" id="940951">)</span>&nbsp;<span class="op" id="940953">{</span><span class="op" id="940954">}</span><span class="op" id="940955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940958">runtime</span><span class="op" id="940965">.</span><span class="ident" id="940966">SetFinalizer</span><span class="op" id="940978">(</span><span class="ident" id="940979">Foo1</span><span class="op" id="940983">,</span>&nbsp;<span class="ident" id="940985">nil</span><span class="op" id="940988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="940991">runtime</span><span class="op" id="940998">.</span><span class="ident" id="940999">SetFinalizer</span><span class="op" id="941011">(</span><span class="ident" id="941012">Foo2</span><span class="op" id="941016">,</span>&nbsp;<span class="ident" id="941018">nil</span><span class="op" id="941021">)</span><br>
<span class="lineno"></span><span class="op" id="941023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span><span class="keyword" id="941026">type</span>&nbsp;<span class="ident" id="941031">Object1</span>&nbsp;<span class="keyword" id="941039">struct</span>&nbsp;<span class="op" id="941046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="941049">Something</span>&nbsp;<span class="op" id="941059">[</span><span class="op" id="941060">]</span><span class="builtintype" id="941061">byte</span><br>
<span class="lineno"></span><span class="op" id="941066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="941069">type</span>&nbsp;<span class="ident" id="941074">Object2</span>&nbsp;<span class="keyword" id="941082">struct</span>&nbsp;<span class="op" id="941089">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="941092">Something</span>&nbsp;<span class="builtintype" id="941102">byte</span><br>
<span class="lineno"></span><span class="op" id="941107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="941110">var</span>&nbsp;<span class="op" id="941114">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="941117">Foo2</span>&nbsp;<span class="op" id="941122">=</span>&nbsp;<span class="op" id="941124">&amp;</span><span class="ident" id="941125">Object2</span><span class="op" id="941132">{</span><span class="op" id="941133">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="941136">Foo1</span>&nbsp;<span class="op" id="941141">=</span>&nbsp;<span class="op" id="941143">&amp;</span><span class="ident" id="941144">Object1</span><span class="op" id="941151">{</span><span class="op" id="941152">}</span><br>
<span class="lineno"></span><span class="op" id="941154">)</span>
</div>
</body>
</html>
