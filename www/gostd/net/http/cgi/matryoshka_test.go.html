<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6423742">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6423797">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6423851">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6423902">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="6423965">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="6424029">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6424086">package</span>&nbsp;<span class="ident" id="6424094">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="6424099">import</span>&nbsp;<span class="op" id="6424106">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424109">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424118">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424128">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424135">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424141">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424153">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424174">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424180">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424191">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424202">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6424209">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6424212">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="6424282">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="6424346">func</span>&nbsp;<span class="ident" id="6424351">TestHostingOurselves</span><span class="op" id="6424371">(</span><span class="ident" id="6424372">t</span>&nbsp;<span class="op" id="6424374">*</span><span class="ident" id="6424375">testing</span><span class="op" id="6424382">.</span><span class="ident" id="6424383">T</span><span class="op" id="6424384">)</span>&nbsp;<span class="op" id="6424386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6424389">if</span>&nbsp;<span class="ident" id="6424392">runtime</span><span class="op" id="6424399">.</span><span class="ident" id="6424400">GOOS</span>&nbsp;<span class="op" id="6424405">==</span>&nbsp;<span class="string" id="6424408">&#34;nacl&#34;</span>&nbsp;<span class="op" id="6424415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424419">t</span><span class="op" id="6424420">.</span><span class="ident" id="6424421">Skip</span><span class="op" id="6424425">(</span><span class="string" id="6424426">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="6424444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6424447">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424451">h</span>&nbsp;<span class="op" id="6424453">:=</span>&nbsp;<span class="op" id="6424456">&amp;</span><span class="ident" id="6424457">Handler</span><span class="op" id="6424464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424468">Path</span><span class="op" id="6424472">:</span>&nbsp;<span class="ident" id="6424474">os</span><span class="op" id="6424476">.</span><span class="ident" id="6424477">Args</span><span class="op" id="6424481">[</span><span class="num" id="6424482">0</span><span class="op" id="6424483">]</span><span class="op" id="6424484">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424488">Root</span><span class="op" id="6424492">:</span>&nbsp;<span class="string" id="6424494">&#34;/test.go&#34;</span><span class="op" id="6424504">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424508">Args</span><span class="op" id="6424512">:</span>&nbsp;<span class="op" id="6424514">[</span><span class="op" id="6424515">]</span><span class="builtintype" id="6424516">string</span><span class="op" id="6424522">{</span><span class="string" id="6424523">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6424556">}</span><span class="op" id="6424557">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6424560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424563">expectedMap</span>&nbsp;<span class="op" id="6424575">:=</span>&nbsp;<span class="keyword" id="6424578">map</span><span class="op" id="6424581">[</span><span class="builtintype" id="6424582">string</span><span class="op" id="6424588">]</span><span class="builtintype" id="6424589">string</span><span class="op" id="6424595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424599">&#34;test&#34;</span><span class="op" id="6424605">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6424624">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="6424642">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424646">&#34;param-a&#34;</span><span class="op" id="6424655">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6424671">&#34;b&#34;</span><span class="op" id="6424674">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424678">&#34;param-foo&#34;</span><span class="op" id="6424689">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6424703">&#34;bar&#34;</span><span class="op" id="6424708">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424712">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="6424735">:</span>&nbsp;<span class="string" id="6424737">&#34;CGI/1.1&#34;</span><span class="op" id="6424746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424750">&#34;env-HTTP_HOST&#34;</span><span class="op" id="6424765">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6424775">&#34;example.com&#34;</span><span class="op" id="6424788">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424792">&#34;env-PATH_INFO&#34;</span><span class="op" id="6424807">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6424817">&#34;&#34;</span><span class="op" id="6424819">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424823">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6424841">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6424848">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="6424861">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424865">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="6424882">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6424890">&#34;1.2.3.4&#34;</span><span class="op" id="6424899">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424903">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="6424920">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6424928">&#34;1.2.3.4&#34;</span><span class="op" id="6424937">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424941">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6424961">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6424966">&#34;GET&#34;</span><span class="op" id="6424971">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6424975">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6424992">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6425000">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="6425022">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6425026">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6425047">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6425051">os</span><span class="op" id="6425053">.</span><span class="ident" id="6425054">Args</span><span class="op" id="6425058">[</span><span class="num" id="6425059">0</span><span class="op" id="6425060">]</span><span class="op" id="6425061">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6425065">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6425082">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6425090">&#34;/test.go&#34;</span><span class="op" id="6425100">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6425104">&#34;env-SERVER_NAME&#34;</span><span class="op" id="6425121">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6425129">&#34;example.com&#34;</span><span class="op" id="6425142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6425146">&#34;env-SERVER_PORT&#34;</span><span class="op" id="6425163">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6425171">&#34;80&#34;</span><span class="op" id="6425175">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6425179">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="6425200">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6425204">&#34;go&#34;</span><span class="op" id="6425208">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6425211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425214">replay</span>&nbsp;<span class="op" id="6425221">:=</span>&nbsp;<span class="ident" id="6425224">runCgiTest</span><span class="op" id="6425234">(</span><span class="ident" id="6425235">t</span><span class="op" id="6425236">,</span>&nbsp;<span class="ident" id="6425238">h</span><span class="op" id="6425239">,</span>&nbsp;<span class="string" id="6425241">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6425299">,</span>&nbsp;<span class="ident" id="6425301">expectedMap</span><span class="op" id="6425312">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425316">if</span>&nbsp;<span class="ident" id="6425319">expected</span><span class="op" id="6425327">,</span>&nbsp;<span class="ident" id="6425329">got</span>&nbsp;<span class="op" id="6425333">:=</span>&nbsp;<span class="string" id="6425336">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6425362">,</span>&nbsp;<span class="ident" id="6425364">replay</span><span class="op" id="6425370">.</span><span class="ident" id="6425371">Header</span><span class="op" id="6425377">(</span><span class="op" id="6425378">)</span><span class="op" id="6425379">.</span><span class="ident" id="6425380">Get</span><span class="op" id="6425383">(</span><span class="string" id="6425384">&#34;Content-Type&#34;</span><span class="op" id="6425398">)</span><span class="op" id="6425399">;</span>&nbsp;<span class="ident" id="6425401">got</span>&nbsp;<span class="op" id="6425405">!=</span>&nbsp;<span class="ident" id="6425408">expected</span>&nbsp;<span class="op" id="6425417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425421">t</span><span class="op" id="6425422">.</span><span class="ident" id="6425423">Errorf</span><span class="op" id="6425429">(</span><span class="string" id="6425430">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6425469">,</span>&nbsp;<span class="ident" id="6425471">got</span><span class="op" id="6425474">,</span>&nbsp;<span class="ident" id="6425476">expected</span><span class="op" id="6425484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6425487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425490">if</span>&nbsp;<span class="ident" id="6425493">expected</span><span class="op" id="6425501">,</span>&nbsp;<span class="ident" id="6425503">got</span>&nbsp;<span class="op" id="6425507">:=</span>&nbsp;<span class="string" id="6425510">&#34;X-Test-Value&#34;</span><span class="op" id="6425524">,</span>&nbsp;<span class="ident" id="6425526">replay</span><span class="op" id="6425532">.</span><span class="ident" id="6425533">Header</span><span class="op" id="6425539">(</span><span class="op" id="6425540">)</span><span class="op" id="6425541">.</span><span class="ident" id="6425542">Get</span><span class="op" id="6425545">(</span><span class="string" id="6425546">&#34;X-Test-Header&#34;</span><span class="op" id="6425561">)</span><span class="op" id="6425562">;</span>&nbsp;<span class="ident" id="6425564">got</span>&nbsp;<span class="op" id="6425568">!=</span>&nbsp;<span class="ident" id="6425571">expected</span>&nbsp;<span class="op" id="6425580">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425584">t</span><span class="op" id="6425585">.</span><span class="ident" id="6425586">Errorf</span><span class="op" id="6425592">(</span><span class="string" id="6425593">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6425633">,</span>&nbsp;<span class="ident" id="6425635">got</span><span class="op" id="6425638">,</span>&nbsp;<span class="ident" id="6425640">expected</span><span class="op" id="6425648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6425651">}</span><br>
<span class="lineno"></span><span class="op" id="6425653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6425656">type</span>&nbsp;<span class="ident" id="6425661">customWriterRecorder</span>&nbsp;<span class="keyword" id="6425682">struct</span>&nbsp;<span class="op" id="6425689">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425692">w</span>&nbsp;<span class="ident" id="6425694">io</span><span class="op" id="6425696">.</span><span class="ident" id="6425697">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6425705">*</span><span class="ident" id="6425706">httptest</span><span class="op" id="6425714">.</span><span class="ident" id="6425715">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="6425732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6425735">func</span>&nbsp;<span class="op" id="6425740">(</span><span class="ident" id="6425741">r</span>&nbsp;<span class="op" id="6425743">*</span><span class="ident" id="6425744">customWriterRecorder</span><span class="op" id="6425764">)</span>&nbsp;<span class="ident" id="6425766">Write</span><span class="op" id="6425771">(</span><span class="ident" id="6425772">p</span>&nbsp;<span class="op" id="6425774">[</span><span class="op" id="6425775">]</span><span class="builtintype" id="6425776">byte</span><span class="op" id="6425780">)</span>&nbsp;<span class="op" id="6425782">(</span><span class="ident" id="6425783">n</span>&nbsp;<span class="builtintype" id="6425785">int</span><span class="op" id="6425788">,</span>&nbsp;<span class="ident" id="6425790">err</span>&nbsp;<span class="builtintype" id="6425794">error</span><span class="op" id="6425799">)</span>&nbsp;<span class="op" id="6425801">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425804">return</span>&nbsp;<span class="ident" id="6425811">r</span><span class="op" id="6425812">.</span><span class="ident" id="6425813">w</span><span class="op" id="6425814">.</span><span class="ident" id="6425815">Write</span><span class="op" id="6425820">(</span><span class="ident" id="6425821">p</span><span class="op" id="6425822">)</span><br>
<span class="lineno"></span><span class="op" id="6425824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6425827">type</span>&nbsp;<span class="ident" id="6425832">limitWriter</span>&nbsp;<span class="keyword" id="6425844">struct</span>&nbsp;<span class="op" id="6425851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425854">w</span>&nbsp;<span class="ident" id="6425856">io</span><span class="op" id="6425858">.</span><span class="ident" id="6425859">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425867">n</span>&nbsp;<span class="builtintype" id="6425869">int</span><br>
<span class="lineno"></span><span class="op" id="6425873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6425876">func</span>&nbsp;<span class="op" id="6425881">(</span><span class="ident" id="6425882">w</span>&nbsp;<span class="op" id="6425884">*</span><span class="ident" id="6425885">limitWriter</span><span class="op" id="6425896">)</span>&nbsp;<span class="ident" id="6425898">Write</span><span class="op" id="6425903">(</span><span class="ident" id="6425904">p</span>&nbsp;<span class="op" id="6425906">[</span><span class="op" id="6425907">]</span><span class="builtintype" id="6425908">byte</span><span class="op" id="6425912">)</span>&nbsp;<span class="op" id="6425914">(</span><span class="ident" id="6425915">n</span>&nbsp;<span class="builtintype" id="6425917">int</span><span class="op" id="6425920">,</span>&nbsp;<span class="ident" id="6425922">err</span>&nbsp;<span class="builtintype" id="6425926">error</span><span class="op" id="6425931">)</span>&nbsp;<span class="op" id="6425933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425936">if</span>&nbsp;<span class="builtinfunc" id="6425939">len</span><span class="op" id="6425942">(</span><span class="ident" id="6425943">p</span><span class="op" id="6425944">)</span>&nbsp;<span class="op" id="6425946">&gt;</span>&nbsp;<span class="ident" id="6425948">w</span><span class="op" id="6425949">.</span><span class="ident" id="6425950">n</span>&nbsp;<span class="op" id="6425952">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425956">p</span>&nbsp;<span class="op" id="6425958">=</span>&nbsp;<span class="ident" id="6425960">p</span><span class="op" id="6425961">[</span><span class="op" id="6425962">:</span><span class="ident" id="6425963">w</span><span class="op" id="6425964">.</span><span class="ident" id="6425965">n</span><span class="op" id="6425966">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6425969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425972">if</span>&nbsp;<span class="builtinfunc" id="6425975">len</span><span class="op" id="6425978">(</span><span class="ident" id="6425979">p</span><span class="op" id="6425980">)</span>&nbsp;<span class="op" id="6425982">&gt;</span>&nbsp;<span class="num" id="6425984">0</span>&nbsp;<span class="op" id="6425986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425990">n</span><span class="op" id="6425991">,</span>&nbsp;<span class="ident" id="6425993">err</span>&nbsp;<span class="op" id="6425997">=</span>&nbsp;<span class="ident" id="6425999">w</span><span class="op" id="6426000">.</span><span class="ident" id="6426001">w</span><span class="op" id="6426002">.</span><span class="ident" id="6426003">Write</span><span class="op" id="6426008">(</span><span class="ident" id="6426009">p</span><span class="op" id="6426010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426014">w</span><span class="op" id="6426015">.</span><span class="ident" id="6426016">n</span>&nbsp;<span class="op" id="6426018">-=</span>&nbsp;<span class="ident" id="6426021">n</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6426024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426027">if</span>&nbsp;<span class="ident" id="6426030">w</span><span class="op" id="6426031">.</span><span class="ident" id="6426032">n</span>&nbsp;<span class="op" id="6426034">==</span>&nbsp;<span class="num" id="6426037">0</span>&nbsp;<span class="op" id="6426039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426043">err</span>&nbsp;<span class="op" id="6426047">=</span>&nbsp;<span class="ident" id="6426049">errors</span><span class="op" id="6426055">.</span><span class="ident" id="6426056">New</span><span class="op" id="6426059">(</span><span class="string" id="6426060">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="6426078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6426081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426084">return</span><br>
<span class="lineno">90</span><span class="op" id="6426091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6426094">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="6426164">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="6426191">func</span>&nbsp;<span class="ident" id="6426196">TestKillChildAfterCopyError</span><span class="op" id="6426223">(</span><span class="ident" id="6426224">t</span>&nbsp;<span class="op" id="6426226">*</span><span class="ident" id="6426227">testing</span><span class="op" id="6426234">.</span><span class="ident" id="6426235">T</span><span class="op" id="6426236">)</span>&nbsp;<span class="op" id="6426238">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426241">if</span>&nbsp;<span class="ident" id="6426244">runtime</span><span class="op" id="6426251">.</span><span class="ident" id="6426252">GOOS</span>&nbsp;<span class="op" id="6426257">==</span>&nbsp;<span class="string" id="6426260">&#34;nacl&#34;</span>&nbsp;<span class="op" id="6426267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426271">t</span><span class="op" id="6426272">.</span><span class="ident" id="6426273">Skip</span><span class="op" id="6426277">(</span><span class="string" id="6426278">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="6426296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6426299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426303">defer</span>&nbsp;<span class="keyword" id="6426309">func</span><span class="op" id="6426313">(</span><span class="op" id="6426314">)</span>&nbsp;<span class="op" id="6426316">{</span>&nbsp;<span class="ident" id="6426318">testHookStartProcess</span>&nbsp;<span class="op" id="6426339">=</span>&nbsp;<span class="ident" id="6426341">nil</span>&nbsp;<span class="op" id="6426345">}</span><span class="op" id="6426346">(</span><span class="op" id="6426347">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426350">proc</span>&nbsp;<span class="op" id="6426355">:=</span>&nbsp;<span class="builtinfunc" id="6426358">make</span><span class="op" id="6426362">(</span><span class="keyword" id="6426363">chan</span>&nbsp;<span class="op" id="6426368">*</span><span class="ident" id="6426369">os</span><span class="op" id="6426371">.</span><span class="ident" id="6426372">Process</span><span class="op" id="6426379">,</span>&nbsp;<span class="num" id="6426381">1</span><span class="op" id="6426382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426385">testHookStartProcess</span>&nbsp;<span class="op" id="6426406">=</span>&nbsp;<span class="keyword" id="6426408">func</span><span class="op" id="6426412">(</span><span class="ident" id="6426413">p</span>&nbsp;<span class="op" id="6426415">*</span><span class="ident" id="6426416">os</span><span class="op" id="6426418">.</span><span class="ident" id="6426419">Process</span><span class="op" id="6426426">)</span>&nbsp;<span class="op" id="6426428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426432">proc</span>&nbsp;<span class="op" id="6426437">&lt;-</span>&nbsp;<span class="ident" id="6426440">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6426443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426447">h</span>&nbsp;<span class="op" id="6426449">:=</span>&nbsp;<span class="op" id="6426452">&amp;</span><span class="ident" id="6426453">Handler</span><span class="op" id="6426460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426464">Path</span><span class="op" id="6426468">:</span>&nbsp;<span class="ident" id="6426470">os</span><span class="op" id="6426472">.</span><span class="ident" id="6426473">Args</span><span class="op" id="6426477">[</span><span class="num" id="6426478">0</span><span class="op" id="6426479">]</span><span class="op" id="6426480">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426484">Root</span><span class="op" id="6426488">:</span>&nbsp;<span class="string" id="6426490">&#34;/test.go&#34;</span><span class="op" id="6426500">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426504">Args</span><span class="op" id="6426508">:</span>&nbsp;<span class="op" id="6426510">[</span><span class="op" id="6426511">]</span><span class="builtintype" id="6426512">string</span><span class="op" id="6426518">{</span><span class="string" id="6426519">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6426552">}</span><span class="op" id="6426553">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6426556">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426559">req</span><span class="op" id="6426562">,</span>&nbsp;<span class="ident" id="6426564">_</span>&nbsp;<span class="op" id="6426566">:=</span>&nbsp;<span class="ident" id="6426569">http</span><span class="op" id="6426573">.</span><span class="ident" id="6426574">NewRequest</span><span class="op" id="6426584">(</span><span class="string" id="6426585">&#34;GET&#34;</span><span class="op" id="6426590">,</span>&nbsp;<span class="string" id="6426592">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="6426637">,</span>&nbsp;<span class="ident" id="6426639">nil</span><span class="op" id="6426642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426645">rec</span>&nbsp;<span class="op" id="6426649">:=</span>&nbsp;<span class="ident" id="6426652">httptest</span><span class="op" id="6426660">.</span><span class="ident" id="6426661">NewRecorder</span><span class="op" id="6426672">(</span><span class="op" id="6426673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426676">var</span>&nbsp;<span class="ident" id="6426680">out</span>&nbsp;<span class="ident" id="6426684">bytes</span><span class="op" id="6426689">.</span><span class="ident" id="6426690">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426698">const</span>&nbsp;<span class="ident" id="6426704">writeLen</span>&nbsp;<span class="op" id="6426713">=</span>&nbsp;<span class="num" id="6426715">50</span>&nbsp;<span class="op" id="6426718">&lt;&lt;</span>&nbsp;<span class="num" id="6426721">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426725">rw</span>&nbsp;<span class="op" id="6426728">:=</span>&nbsp;<span class="op" id="6426731">&amp;</span><span class="ident" id="6426732">customWriterRecorder</span><span class="op" id="6426752">{</span><span class="op" id="6426753">&amp;</span><span class="ident" id="6426754">limitWriter</span><span class="op" id="6426765">{</span><span class="op" id="6426766">&amp;</span><span class="ident" id="6426767">out</span><span class="op" id="6426770">,</span>&nbsp;<span class="ident" id="6426772">writeLen</span><span class="op" id="6426780">}</span><span class="op" id="6426781">,</span>&nbsp;<span class="ident" id="6426783">rec</span><span class="op" id="6426786">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426790">donec</span>&nbsp;<span class="op" id="6426796">:=</span>&nbsp;<span class="builtinfunc" id="6426799">make</span><span class="op" id="6426803">(</span><span class="keyword" id="6426804">chan</span>&nbsp;<span class="builtintype" id="6426809">bool</span><span class="op" id="6426813">,</span>&nbsp;<span class="num" id="6426815">1</span><span class="op" id="6426816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426819">go</span>&nbsp;<span class="keyword" id="6426822">func</span><span class="op" id="6426826">(</span><span class="op" id="6426827">)</span>&nbsp;<span class="op" id="6426829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426833">h</span><span class="op" id="6426834">.</span><span class="ident" id="6426835">ServeHTTP</span><span class="op" id="6426844">(</span><span class="ident" id="6426845">rw</span><span class="op" id="6426847">,</span>&nbsp;<span class="ident" id="6426849">req</span><span class="op" id="6426852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426856">donec</span>&nbsp;<span class="op" id="6426862">&lt;-</span>&nbsp;<span class="builtintype" id="6426865">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6426871">}</span><span class="op" id="6426872">(</span><span class="op" id="6426873">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426877">select</span>&nbsp;<span class="op" id="6426884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426887">case</span>&nbsp;<span class="op" id="6426892">&lt;-</span><span class="ident" id="6426894">donec</span><span class="op" id="6426899">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426903">if</span>&nbsp;<span class="ident" id="6426906">out</span><span class="op" id="6426909">.</span><span class="ident" id="6426910">Len</span><span class="op" id="6426913">(</span><span class="op" id="6426914">)</span>&nbsp;<span class="op" id="6426916">!=</span>&nbsp;<span class="ident" id="6426919">writeLen</span>&nbsp;<span class="op" id="6426928">||</span>&nbsp;<span class="ident" id="6426931">out</span><span class="op" id="6426934">.</span><span class="ident" id="6426935">Bytes</span><span class="op" id="6426940">(</span><span class="op" id="6426941">)</span><span class="op" id="6426942">[</span><span class="num" id="6426943">0</span><span class="op" id="6426944">]</span>&nbsp;<span class="op" id="6426946">!=</span>&nbsp;<span class="string" id="6426949">&#39;a&#39;</span>&nbsp;<span class="op" id="6426953">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426958">t</span><span class="op" id="6426959">.</span><span class="ident" id="6426960">Errorf</span><span class="op" id="6426966">(</span><span class="string" id="6426967">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="6426990">,</span>&nbsp;<span class="ident" id="6426992">out</span><span class="op" id="6426995">.</span><span class="ident" id="6426996">Bytes</span><span class="op" id="6427001">(</span><span class="op" id="6427002">)</span><span class="op" id="6427003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427010">case</span>&nbsp;<span class="op" id="6427015">&lt;-</span><span class="ident" id="6427017">time</span><span class="op" id="6427021">.</span><span class="ident" id="6427022">After</span><span class="op" id="6427027">(</span><span class="num" id="6427028">5</span>&nbsp;<span class="op" id="6427030">*</span>&nbsp;<span class="ident" id="6427032">time</span><span class="op" id="6427036">.</span><span class="ident" id="6427037">Second</span><span class="op" id="6427043">)</span><span class="op" id="6427044">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427048">t</span><span class="op" id="6427049">.</span><span class="ident" id="6427050">Errorf</span><span class="op" id="6427056">(</span><span class="string" id="6427057">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="6427117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427121">select</span>&nbsp;<span class="op" id="6427128">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427132">case</span>&nbsp;<span class="ident" id="6427137">p</span>&nbsp;<span class="op" id="6427139">:=</span>&nbsp;<span class="op" id="6427142">&lt;-</span><span class="ident" id="6427144">proc</span><span class="op" id="6427148">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427153">p</span><span class="op" id="6427154">.</span><span class="ident" id="6427155">Kill</span><span class="op" id="6427159">(</span><span class="op" id="6427160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427165">t</span><span class="op" id="6427166">.</span><span class="ident" id="6427167">Logf</span><span class="op" id="6427171">(</span><span class="string" id="6427172">&#34;killed&nbsp;process&#34;</span><span class="op" id="6427188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427192">default</span><span class="op" id="6427199">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427204">t</span><span class="op" id="6427205">.</span><span class="ident" id="6427206">Logf</span><span class="op" id="6427210">(</span><span class="string" id="6427211">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="6427232">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427239">}</span><br>
<span class="lineno"></span><span class="op" id="6427241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6427244">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="6427301">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="6427326">func</span>&nbsp;<span class="ident" id="6427331">TestChildOnlyHeaders</span><span class="op" id="6427351">(</span><span class="ident" id="6427352">t</span>&nbsp;<span class="op" id="6427354">*</span><span class="ident" id="6427355">testing</span><span class="op" id="6427362">.</span><span class="ident" id="6427363">T</span><span class="op" id="6427364">)</span>&nbsp;<span class="op" id="6427366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427369">if</span>&nbsp;<span class="ident" id="6427372">runtime</span><span class="op" id="6427379">.</span><span class="ident" id="6427380">GOOS</span>&nbsp;<span class="op" id="6427385">==</span>&nbsp;<span class="string" id="6427388">&#34;nacl&#34;</span>&nbsp;<span class="op" id="6427395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427399">t</span><span class="op" id="6427400">.</span><span class="ident" id="6427401">Skip</span><span class="op" id="6427405">(</span><span class="string" id="6427406">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="6427424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427427">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427431">h</span>&nbsp;<span class="op" id="6427433">:=</span>&nbsp;<span class="op" id="6427436">&amp;</span><span class="ident" id="6427437">Handler</span><span class="op" id="6427444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427448">Path</span><span class="op" id="6427452">:</span>&nbsp;<span class="ident" id="6427454">os</span><span class="op" id="6427456">.</span><span class="ident" id="6427457">Args</span><span class="op" id="6427461">[</span><span class="num" id="6427462">0</span><span class="op" id="6427463">]</span><span class="op" id="6427464">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427468">Root</span><span class="op" id="6427472">:</span>&nbsp;<span class="string" id="6427474">&#34;/test.go&#34;</span><span class="op" id="6427484">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427488">Args</span><span class="op" id="6427492">:</span>&nbsp;<span class="op" id="6427494">[</span><span class="op" id="6427495">]</span><span class="builtintype" id="6427496">string</span><span class="op" id="6427502">{</span><span class="string" id="6427503">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6427536">}</span><span class="op" id="6427537">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427543">expectedMap</span>&nbsp;<span class="op" id="6427555">:=</span>&nbsp;<span class="keyword" id="6427558">map</span><span class="op" id="6427561">[</span><span class="builtintype" id="6427562">string</span><span class="op" id="6427568">]</span><span class="builtintype" id="6427569">string</span><span class="op" id="6427575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6427579">&#34;_body&#34;</span><span class="op" id="6427586">:</span>&nbsp;<span class="string" id="6427588">&#34;&#34;</span><span class="op" id="6427590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427596">replay</span>&nbsp;<span class="op" id="6427603">:=</span>&nbsp;<span class="ident" id="6427606">runCgiTest</span><span class="op" id="6427616">(</span><span class="ident" id="6427617">t</span><span class="op" id="6427618">,</span>&nbsp;<span class="ident" id="6427620">h</span><span class="op" id="6427621">,</span>&nbsp;<span class="string" id="6427623">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6427679">,</span>&nbsp;<span class="ident" id="6427681">expectedMap</span><span class="op" id="6427692">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427695">if</span>&nbsp;<span class="ident" id="6427698">expected</span><span class="op" id="6427706">,</span>&nbsp;<span class="ident" id="6427708">got</span>&nbsp;<span class="op" id="6427712">:=</span>&nbsp;<span class="string" id="6427715">&#34;X-Test-Value&#34;</span><span class="op" id="6427729">,</span>&nbsp;<span class="ident" id="6427731">replay</span><span class="op" id="6427737">.</span><span class="ident" id="6427738">Header</span><span class="op" id="6427744">(</span><span class="op" id="6427745">)</span><span class="op" id="6427746">.</span><span class="ident" id="6427747">Get</span><span class="op" id="6427750">(</span><span class="string" id="6427751">&#34;X-Test-Header&#34;</span><span class="op" id="6427766">)</span><span class="op" id="6427767">;</span>&nbsp;<span class="ident" id="6427769">got</span>&nbsp;<span class="op" id="6427773">!=</span>&nbsp;<span class="ident" id="6427776">expected</span>&nbsp;<span class="op" id="6427785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427789">t</span><span class="op" id="6427790">.</span><span class="ident" id="6427791">Errorf</span><span class="op" id="6427797">(</span><span class="string" id="6427798">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6427838">,</span>&nbsp;<span class="ident" id="6427840">got</span><span class="op" id="6427843">,</span>&nbsp;<span class="ident" id="6427845">expected</span><span class="op" id="6427853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427856">}</span><br>
<span class="lineno"></span><span class="op" id="6427858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="6427861">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="6427886">func</span>&nbsp;<span class="ident" id="6427891">Test500WithNoHeaders</span><span class="op" id="6427911">(</span><span class="ident" id="6427912">t</span>&nbsp;<span class="op" id="6427914">*</span><span class="ident" id="6427915">testing</span><span class="op" id="6427922">.</span><span class="ident" id="6427923">T</span><span class="op" id="6427924">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6427930">{</span>&nbsp;<span class="ident" id="6427932">want500Test</span><span class="op" id="6427943">(</span><span class="ident" id="6427944">t</span><span class="op" id="6427945">,</span>&nbsp;<span class="string" id="6427947">&#34;/immediate-disconnect&#34;</span><span class="op" id="6427970">)</span>&nbsp;<span class="op" id="6427972">}</span><br>
<span class="lineno"></span><span class="keyword" id="6427974">func</span>&nbsp;<span class="ident" id="6427979">Test500WithNoContentType</span><span class="op" id="6428003">(</span><span class="ident" id="6428004">t</span>&nbsp;<span class="op" id="6428006">*</span><span class="ident" id="6428007">testing</span><span class="op" id="6428014">.</span><span class="ident" id="6428015">T</span><span class="op" id="6428016">)</span>&nbsp;<span class="op" id="6428018">{</span>&nbsp;<span class="ident" id="6428020">want500Test</span><span class="op" id="6428031">(</span><span class="ident" id="6428032">t</span><span class="op" id="6428033">,</span>&nbsp;<span class="string" id="6428035">&#34;/no-content-type&#34;</span><span class="op" id="6428053">)</span>&nbsp;<span class="op" id="6428055">}</span><br>
<span class="lineno"></span><span class="keyword" id="6428057">func</span>&nbsp;<span class="ident" id="6428062">Test500WithEmptyHeaders</span><span class="op" id="6428085">(</span><span class="ident" id="6428086">t</span>&nbsp;<span class="op" id="6428088">*</span><span class="ident" id="6428089">testing</span><span class="op" id="6428096">.</span><span class="ident" id="6428097">T</span><span class="op" id="6428098">)</span>&nbsp;&nbsp;<span class="op" id="6428101">{</span>&nbsp;<span class="ident" id="6428103">want500Test</span><span class="op" id="6428114">(</span><span class="ident" id="6428115">t</span><span class="op" id="6428116">,</span>&nbsp;<span class="string" id="6428118">&#34;/empty-headers&#34;</span><span class="op" id="6428134">)</span>&nbsp;<span class="op" id="6428136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="6428139">func</span>&nbsp;<span class="ident" id="6428144">want500Test</span><span class="op" id="6428155">(</span><span class="ident" id="6428156">t</span>&nbsp;<span class="op" id="6428158">*</span><span class="ident" id="6428159">testing</span><span class="op" id="6428166">.</span><span class="ident" id="6428167">T</span><span class="op" id="6428168">,</span>&nbsp;<span class="ident" id="6428170">path</span>&nbsp;<span class="builtintype" id="6428175">string</span><span class="op" id="6428181">)</span>&nbsp;<span class="op" id="6428183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6428186">h</span>&nbsp;<span class="op" id="6428188">:=</span>&nbsp;<span class="op" id="6428191">&amp;</span><span class="ident" id="6428192">Handler</span><span class="op" id="6428199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6428203">Path</span><span class="op" id="6428207">:</span>&nbsp;<span class="ident" id="6428209">os</span><span class="op" id="6428211">.</span><span class="ident" id="6428212">Args</span><span class="op" id="6428216">[</span><span class="num" id="6428217">0</span><span class="op" id="6428218">]</span><span class="op" id="6428219">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6428223">Root</span><span class="op" id="6428227">:</span>&nbsp;<span class="string" id="6428229">&#34;/test.go&#34;</span><span class="op" id="6428239">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6428243">Args</span><span class="op" id="6428247">:</span>&nbsp;<span class="op" id="6428249">[</span><span class="op" id="6428250">]</span><span class="builtintype" id="6428251">string</span><span class="op" id="6428257">{</span><span class="string" id="6428258">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6428291">}</span><span class="op" id="6428292">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6428295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6428298">expectedMap</span>&nbsp;<span class="op" id="6428310">:=</span>&nbsp;<span class="keyword" id="6428313">map</span><span class="op" id="6428316">[</span><span class="builtintype" id="6428317">string</span><span class="op" id="6428323">]</span><span class="builtintype" id="6428324">string</span><span class="op" id="6428330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6428334">&#34;_body&#34;</span><span class="op" id="6428341">:</span>&nbsp;<span class="string" id="6428343">&#34;&#34;</span><span class="op" id="6428345">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6428348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6428351">replay</span>&nbsp;<span class="op" id="6428358">:=</span>&nbsp;<span class="ident" id="6428361">runCgiTest</span><span class="op" id="6428371">(</span><span class="ident" id="6428372">t</span><span class="op" id="6428373">,</span>&nbsp;<span class="ident" id="6428375">h</span><span class="op" id="6428376">,</span>&nbsp;<span class="string" id="6428378">&#34;GET&nbsp;&#34;</span><span class="op" id="6428384">+</span><span class="ident" id="6428385">path</span><span class="op" id="6428389">+</span><span class="string" id="6428390">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6428424">,</span>&nbsp;<span class="ident" id="6428426">expectedMap</span><span class="op" id="6428437">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6428440">if</span>&nbsp;<span class="ident" id="6428443">replay</span><span class="op" id="6428449">.</span><span class="ident" id="6428450">Code</span>&nbsp;<span class="op" id="6428455">!=</span>&nbsp;<span class="num" id="6428458">500</span>&nbsp;<span class="op" id="6428462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6428466">t</span><span class="op" id="6428467">.</span><span class="ident" id="6428468">Errorf</span><span class="op" id="6428474">(</span><span class="string" id="6428475">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="6428498">,</span>&nbsp;<span class="ident" id="6428500">replay</span><span class="op" id="6428506">.</span><span class="ident" id="6428507">Code</span><span class="op" id="6428511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6428514">}</span><br>
<span class="lineno"></span><span class="op" id="6428516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6428519">type</span>&nbsp;<span class="ident" id="6428524">neverEnding</span>&nbsp;<span class="builtintype" id="6428536">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6428542">func</span>&nbsp;<span class="op" id="6428547">(</span><span class="ident" id="6428548">b</span>&nbsp;<span class="ident" id="6428550">neverEnding</span><span class="op" id="6428561">)</span>&nbsp;<span class="ident" id="6428563">Read</span><span class="op" id="6428567">(</span><span class="ident" id="6428568">p</span>&nbsp;<span class="op" id="6428570">[</span><span class="op" id="6428571">]</span><span class="builtintype" id="6428572">byte</span><span class="op" id="6428576">)</span>&nbsp;<span class="op" id="6428578">(</span><span class="ident" id="6428579">n</span>&nbsp;<span class="builtintype" id="6428581">int</span><span class="op" id="6428584">,</span>&nbsp;<span class="ident" id="6428586">err</span>&nbsp;<span class="builtintype" id="6428590">error</span><span class="op" id="6428595">)</span>&nbsp;<span class="op" id="6428597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6428600">for</span>&nbsp;<span class="ident" id="6428604">i</span>&nbsp;<span class="op" id="6428606">:=</span>&nbsp;<span class="keyword" id="6428609">range</span>&nbsp;<span class="ident" id="6428615">p</span>&nbsp;<span class="op" id="6428617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6428621">p</span><span class="op" id="6428622">[</span><span class="ident" id="6428623">i</span><span class="op" id="6428624">]</span>&nbsp;<span class="op" id="6428626">=</span>&nbsp;<span class="builtintype" id="6428628">byte</span><span class="op" id="6428632">(</span><span class="ident" id="6428633">b</span><span class="op" id="6428634">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6428637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6428640">return</span>&nbsp;<span class="builtinfunc" id="6428647">len</span><span class="op" id="6428650">(</span><span class="ident" id="6428651">p</span><span class="op" id="6428652">)</span><span class="op" id="6428653">,</span>&nbsp;<span class="ident" id="6428655">nil</span><br>
<span class="lineno"></span><span class="op" id="6428659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6428662">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="6428692">func</span>&nbsp;<span class="ident" id="6428697">TestBeChildCGIProcess</span><span class="op" id="6428718">(</span><span class="ident" id="6428719">t</span>&nbsp;<span class="op" id="6428721">*</span><span class="ident" id="6428722">testing</span><span class="op" id="6428729">.</span><span class="ident" id="6428730">T</span><span class="op" id="6428731">)</span>&nbsp;<span class="op" id="6428733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6428736">if</span>&nbsp;<span class="ident" id="6428739">os</span><span class="op" id="6428741">.</span><span class="ident" id="6428742">Getenv</span><span class="op" id="6428748">(</span><span class="string" id="6428749">&#34;REQUEST_METHOD&#34;</span><span class="op" id="6428765">)</span>&nbsp;<span class="op" id="6428767">==</span>&nbsp;<span class="string" id="6428770">&#34;&#34;</span>&nbsp;<span class="op" id="6428773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6428777">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6428823">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6428831">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6428834">switch</span>&nbsp;<span class="ident" id="6428841">os</span><span class="op" id="6428843">.</span><span class="ident" id="6428844">Getenv</span><span class="op" id="6428850">(</span><span class="string" id="6428851">&#34;REQUEST_URI&#34;</span><span class="op" id="6428864">)</span>&nbsp;<span class="op" id="6428866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6428869">case</span>&nbsp;<span class="string" id="6428874">&#34;/immediate-disconnect&#34;</span><span class="op" id="6428897">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6428901">os</span><span class="op" id="6428903">.</span><span class="ident" id="6428904">Exit</span><span class="op" id="6428908">(</span><span class="num" id="6428909">0</span><span class="op" id="6428910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6428913">case</span>&nbsp;<span class="string" id="6428918">&#34;/no-content-type&#34;</span><span class="op" id="6428936">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6428940">fmt</span><span class="op" id="6428943">.</span><span class="ident" id="6428944">Printf</span><span class="op" id="6428950">(</span><span class="string" id="6428951">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="6428981">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6428985">os</span><span class="op" id="6428987">.</span><span class="ident" id="6428988">Exit</span><span class="op" id="6428992">(</span><span class="num" id="6428993">0</span><span class="op" id="6428994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6428997">case</span>&nbsp;<span class="string" id="6429002">&#34;/empty-headers&#34;</span><span class="op" id="6429018">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6429022">fmt</span><span class="op" id="6429025">.</span><span class="ident" id="6429026">Printf</span><span class="op" id="6429032">(</span><span class="string" id="6429033">&#34;\nHello&#34;</span><span class="op" id="6429042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6429046">os</span><span class="op" id="6429048">.</span><span class="ident" id="6429049">Exit</span><span class="op" id="6429053">(</span><span class="num" id="6429054">0</span><span class="op" id="6429055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6429058">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6429061">Serve</span><span class="op" id="6429066">(</span><span class="ident" id="6429067">http</span><span class="op" id="6429071">.</span><span class="ident" id="6429072">HandlerFunc</span><span class="op" id="6429083">(</span><span class="keyword" id="6429084">func</span><span class="op" id="6429088">(</span><span class="ident" id="6429089">rw</span>&nbsp;<span class="ident" id="6429092">http</span><span class="op" id="6429096">.</span><span class="ident" id="6429097">ResponseWriter</span><span class="op" id="6429111">,</span>&nbsp;<span class="ident" id="6429113">req</span>&nbsp;<span class="op" id="6429117">*</span><span class="ident" id="6429118">http</span><span class="op" id="6429122">.</span><span class="ident" id="6429123">Request</span><span class="op" id="6429130">)</span>&nbsp;<span class="op" id="6429132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6429136">rw</span><span class="op" id="6429138">.</span><span class="ident" id="6429139">Header</span><span class="op" id="6429145">(</span><span class="op" id="6429146">)</span><span class="op" id="6429147">.</span><span class="ident" id="6429148">Set</span><span class="op" id="6429151">(</span><span class="string" id="6429152">&#34;X-Test-Header&#34;</span><span class="op" id="6429167">,</span>&nbsp;<span class="string" id="6429169">&#34;X-Test-Value&#34;</span><span class="op" id="6429183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6429187">req</span><span class="op" id="6429190">.</span><span class="ident" id="6429191">ParseForm</span><span class="op" id="6429200">(</span><span class="op" id="6429201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6429205">if</span>&nbsp;<span class="ident" id="6429208">req</span><span class="op" id="6429211">.</span><span class="ident" id="6429212">FormValue</span><span class="op" id="6429221">(</span><span class="string" id="6429222">&#34;no-body&#34;</span><span class="op" id="6429231">)</span>&nbsp;<span class="op" id="6429233">==</span>&nbsp;<span class="string" id="6429236">&#34;1&#34;</span>&nbsp;<span class="op" id="6429240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6429245">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6429254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6429258">if</span>&nbsp;<span class="ident" id="6429261">req</span><span class="op" id="6429264">.</span><span class="ident" id="6429265">FormValue</span><span class="op" id="6429274">(</span><span class="string" id="6429275">&#34;write-forever&#34;</span><span class="op" id="6429290">)</span>&nbsp;<span class="op" id="6429292">==</span>&nbsp;<span class="string" id="6429295">&#34;1&#34;</span>&nbsp;<span class="op" id="6429299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6429304">io</span><span class="op" id="6429306">.</span><span class="ident" id="6429307">Copy</span><span class="op" id="6429311">(</span><span class="ident" id="6429312">rw</span><span class="op" id="6429314">,</span>&nbsp;<span class="ident" id="6429316">neverEnding</span><span class="op" id="6429327">(</span><span class="string" id="6429328">&#39;a&#39;</span><span class="op" id="6429331">)</span><span class="op" id="6429332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6429337">for</span>&nbsp;<span class="op" id="6429341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6429347">time</span><span class="op" id="6429351">.</span><span class="ident" id="6429352">Sleep</span><span class="op" id="6429357">(</span><span class="num" id="6429358">5</span>&nbsp;<span class="op" id="6429360">*</span>&nbsp;<span class="ident" id="6429362">time</span><span class="op" id="6429366">.</span><span class="ident" id="6429367">Second</span><span class="op" id="6429373">)</span>&nbsp;<span class="comment" id="6429375">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6429408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6429412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6429416">fmt</span><span class="op" id="6429419">.</span><span class="ident" id="6429420">Fprintf</span><span class="op" id="6429427">(</span><span class="ident" id="6429428">rw</span><span class="op" id="6429430">,</span>&nbsp;<span class="string" id="6429432">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="6429457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6429461">for</span>&nbsp;<span class="ident" id="6429465">k</span><span class="op" id="6429466">,</span>&nbsp;<span class="ident" id="6429468">vv</span>&nbsp;<span class="op" id="6429471">:=</span>&nbsp;<span class="keyword" id="6429474">range</span>&nbsp;<span class="ident" id="6429480">req</span><span class="op" id="6429483">.</span><span class="ident" id="6429484">Form</span>&nbsp;<span class="op" id="6429489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6429494">for</span>&nbsp;<span class="ident" id="6429498">_</span><span class="op" id="6429499">,</span>&nbsp;<span class="ident" id="6429501">v</span>&nbsp;<span class="op" id="6429503">:=</span>&nbsp;<span class="keyword" id="6429506">range</span>&nbsp;<span class="ident" id="6429512">vv</span>&nbsp;<span class="op" id="6429515">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6429521">fmt</span><span class="op" id="6429524">.</span><span class="ident" id="6429525">Fprintf</span><span class="op" id="6429532">(</span><span class="ident" id="6429533">rw</span><span class="op" id="6429535">,</span>&nbsp;<span class="string" id="6429537">&#34;param-%s=%s\n&#34;</span><span class="op" id="6429552">,</span>&nbsp;<span class="ident" id="6429554">k</span><span class="op" id="6429555">,</span>&nbsp;<span class="ident" id="6429557">v</span><span class="op" id="6429558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6429563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6429567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6429571">for</span>&nbsp;<span class="ident" id="6429575">_</span><span class="op" id="6429576">,</span>&nbsp;<span class="ident" id="6429578">kv</span>&nbsp;<span class="op" id="6429581">:=</span>&nbsp;<span class="keyword" id="6429584">range</span>&nbsp;<span class="ident" id="6429590">os</span><span class="op" id="6429592">.</span><span class="ident" id="6429593">Environ</span><span class="op" id="6429600">(</span><span class="op" id="6429601">)</span>&nbsp;<span class="op" id="6429603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6429608">fmt</span><span class="op" id="6429611">.</span><span class="ident" id="6429612">Fprintf</span><span class="op" id="6429619">(</span><span class="ident" id="6429620">rw</span><span class="op" id="6429622">,</span>&nbsp;<span class="string" id="6429624">&#34;env-%s\n&#34;</span><span class="op" id="6429634">,</span>&nbsp;<span class="ident" id="6429636">kv</span><span class="op" id="6429638">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6429642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6429645">}</span><span class="op" id="6429646">)</span><span class="op" id="6429647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6429650">os</span><span class="op" id="6429652">.</span><span class="ident" id="6429653">Exit</span><span class="op" id="6429657">(</span><span class="num" id="6429658">0</span><span class="op" id="6429659">)</span><br>
<span class="lineno"></span><span class="op" id="6429661">}</span>
</div>
</body>
</html>
