<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8169135">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8169190">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8169244">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8169295">package</span>&nbsp;<span class="ident" id="8169303">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8169308">import</span>&nbsp;<span class="op" id="8169315">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169318">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169327">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169335">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169342">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169348">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169354">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169365">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169376">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169386">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169397">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169408">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169416">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8169427">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8169434">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8169437">func</span>&nbsp;<span class="ident" id="8169442">newLocalListener</span><span class="op" id="8169458">(</span><span class="ident" id="8169459">t</span>&nbsp;<span class="op" id="8169461">*</span><span class="ident" id="8169462">testing</span><span class="op" id="8169469">.</span><span class="ident" id="8169470">T</span><span class="op" id="8169471">)</span>&nbsp;<span class="ident" id="8169473">Listener</span>&nbsp;<span class="op" id="8169482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169485">ln</span><span class="op" id="8169487">,</span>&nbsp;<span class="ident" id="8169489">err</span>&nbsp;<span class="op" id="8169493">:=</span>&nbsp;<span class="ident" id="8169496">Listen</span><span class="op" id="8169502">(</span><span class="string" id="8169503">&#34;tcp&#34;</span><span class="op" id="8169508">,</span>&nbsp;<span class="string" id="8169510">&#34;127.0.0.1:0&#34;</span><span class="op" id="8169523">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169526">if</span>&nbsp;<span class="ident" id="8169529">err</span>&nbsp;<span class="op" id="8169533">!=</span>&nbsp;<span class="ident" id="8169536">nil</span>&nbsp;<span class="op" id="8169540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169544">ln</span><span class="op" id="8169546">,</span>&nbsp;<span class="ident" id="8169548">err</span>&nbsp;<span class="op" id="8169552">=</span>&nbsp;<span class="ident" id="8169554">Listen</span><span class="op" id="8169560">(</span><span class="string" id="8169561">&#34;tcp6&#34;</span><span class="op" id="8169567">,</span>&nbsp;<span class="string" id="8169569">&#34;[::1]:0&#34;</span><span class="op" id="8169578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8169581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169584">if</span>&nbsp;<span class="ident" id="8169587">err</span>&nbsp;<span class="op" id="8169591">!=</span>&nbsp;<span class="ident" id="8169594">nil</span>&nbsp;<span class="op" id="8169598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169602">t</span><span class="op" id="8169603">.</span><span class="ident" id="8169604">Fatal</span><span class="op" id="8169609">(</span><span class="ident" id="8169610">err</span><span class="op" id="8169613">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8169616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169619">return</span>&nbsp;<span class="ident" id="8169626">ln</span><br>
<span class="lineno"></span><span class="op" id="8169629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8169632">func</span>&nbsp;<span class="ident" id="8169637">TestDialTimeout</span><span class="op" id="8169652">(</span><span class="ident" id="8169653">t</span>&nbsp;<span class="op" id="8169655">*</span><span class="ident" id="8169656">testing</span><span class="op" id="8169663">.</span><span class="ident" id="8169664">T</span><span class="op" id="8169665">)</span>&nbsp;<span class="op" id="8169667">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169670">origBacklog</span>&nbsp;<span class="op" id="8169682">:=</span>&nbsp;<span class="ident" id="8169685">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169702">defer</span>&nbsp;<span class="keyword" id="8169708">func</span><span class="op" id="8169712">(</span><span class="op" id="8169713">)</span>&nbsp;<span class="op" id="8169715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169719">listenerBacklog</span>&nbsp;<span class="op" id="8169735">=</span>&nbsp;<span class="ident" id="8169737">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8169750">}</span><span class="op" id="8169751">(</span><span class="op" id="8169752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169755">listenerBacklog</span>&nbsp;<span class="op" id="8169771">=</span>&nbsp;<span class="num" id="8169773">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169777">ln</span>&nbsp;<span class="op" id="8169780">:=</span>&nbsp;<span class="ident" id="8169783">newLocalListener</span><span class="op" id="8169799">(</span><span class="ident" id="8169800">t</span><span class="op" id="8169801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169804">defer</span>&nbsp;<span class="ident" id="8169810">ln</span><span class="op" id="8169812">.</span><span class="ident" id="8169813">Close</span><span class="op" id="8169818">(</span><span class="op" id="8169819">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169823">errc</span>&nbsp;<span class="op" id="8169828">:=</span>&nbsp;<span class="builtinfunc" id="8169831">make</span><span class="op" id="8169835">(</span><span class="keyword" id="8169836">chan</span>&nbsp;<span class="builtintype" id="8169841">error</span><span class="op" id="8169846">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169850">numConns</span>&nbsp;<span class="op" id="8169859">:=</span>&nbsp;<span class="ident" id="8169862">listenerBacklog</span>&nbsp;<span class="op" id="8169878">+</span>&nbsp;<span class="num" id="8169880">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8169886">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8169943">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169992">switch</span>&nbsp;<span class="ident" id="8169999">runtime</span><span class="op" id="8170006">.</span><span class="ident" id="8170007">GOOS</span>&nbsp;<span class="op" id="8170012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8170015">case</span>&nbsp;<span class="string" id="8170020">&#34;linux&#34;</span><span class="op" id="8170027">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170031">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170101">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170171">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8170241">for</span>&nbsp;<span class="ident" id="8170245">i</span>&nbsp;<span class="op" id="8170247">:=</span>&nbsp;<span class="num" id="8170250">0</span><span class="op" id="8170251">;</span>&nbsp;<span class="ident" id="8170253">i</span>&nbsp;<span class="op" id="8170255">&lt;</span>&nbsp;<span class="ident" id="8170257">numConns</span><span class="op" id="8170265">;</span>&nbsp;<span class="ident" id="8170267">i</span><span class="op" id="8170268">++</span>&nbsp;<span class="op" id="8170271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8170276">go</span>&nbsp;<span class="keyword" id="8170279">func</span><span class="op" id="8170283">(</span><span class="op" id="8170284">)</span>&nbsp;<span class="op" id="8170286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8170292">_</span><span class="op" id="8170293">,</span>&nbsp;<span class="ident" id="8170295">err</span>&nbsp;<span class="op" id="8170299">:=</span>&nbsp;<span class="ident" id="8170302">DialTimeout</span><span class="op" id="8170313">(</span><span class="string" id="8170314">&#34;tcp&#34;</span><span class="op" id="8170319">,</span>&nbsp;<span class="ident" id="8170321">ln</span><span class="op" id="8170323">.</span><span class="ident" id="8170324">Addr</span><span class="op" id="8170328">(</span><span class="op" id="8170329">)</span><span class="op" id="8170330">.</span><span class="ident" id="8170331">String</span><span class="op" id="8170337">(</span><span class="op" id="8170338">)</span><span class="op" id="8170339">,</span>&nbsp;<span class="num" id="8170341">200</span><span class="op" id="8170344">*</span><span class="ident" id="8170345">time</span><span class="op" id="8170349">.</span><span class="ident" id="8170350">Millisecond</span><span class="op" id="8170361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8170367">errc</span>&nbsp;<span class="op" id="8170372">&lt;-</span>&nbsp;<span class="ident" id="8170375">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8170382">}</span><span class="op" id="8170383">(</span><span class="op" id="8170384">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8170388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8170391">case</span>&nbsp;<span class="string" id="8170396">&#34;darwin&#34;</span><span class="op" id="8170404">,</span>&nbsp;<span class="string" id="8170406">&#34;plan9&#34;</span><span class="op" id="8170413">,</span>&nbsp;<span class="string" id="8170415">&#34;windows&#34;</span><span class="op" id="8170424">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170428">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170482">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170537">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170591">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170614">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170619">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170681">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170737">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170791">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170851">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170856">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8170923">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8171020">go</span>&nbsp;<span class="keyword" id="8171023">func</span><span class="op" id="8171027">(</span><span class="op" id="8171028">)</span>&nbsp;<span class="op" id="8171030">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8171035">c</span><span class="op" id="8171036">,</span>&nbsp;<span class="ident" id="8171038">err</span>&nbsp;<span class="op" id="8171042">:=</span>&nbsp;<span class="ident" id="8171045">DialTimeout</span><span class="op" id="8171056">(</span><span class="string" id="8171057">&#34;tcp&#34;</span><span class="op" id="8171062">,</span>&nbsp;<span class="string" id="8171064">&#34;127.0.71.111:49151&#34;</span><span class="op" id="8171084">,</span>&nbsp;<span class="num" id="8171086">200</span><span class="op" id="8171089">*</span><span class="ident" id="8171090">time</span><span class="op" id="8171094">.</span><span class="ident" id="8171095">Millisecond</span><span class="op" id="8171106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8171111">if</span>&nbsp;<span class="ident" id="8171114">err</span>&nbsp;<span class="op" id="8171118">==</span>&nbsp;<span class="ident" id="8171121">nil</span>&nbsp;<span class="op" id="8171125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8171131">err</span>&nbsp;<span class="op" id="8171135">=</span>&nbsp;<span class="ident" id="8171137">fmt</span><span class="op" id="8171140">.</span><span class="ident" id="8171141">Errorf</span><span class="op" id="8171147">(</span><span class="string" id="8171148">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="8171178">,</span>&nbsp;<span class="ident" id="8171180">c</span><span class="op" id="8171181">.</span><span class="ident" id="8171182">RemoteAddr</span><span class="op" id="8171192">(</span><span class="op" id="8171193">)</span><span class="op" id="8171194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8171200">c</span><span class="op" id="8171201">.</span><span class="ident" id="8171202">Close</span><span class="op" id="8171207">(</span><span class="op" id="8171208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8171213">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8171218">errc</span>&nbsp;<span class="op" id="8171223">&lt;-</span>&nbsp;<span class="ident" id="8171226">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8171232">}</span><span class="op" id="8171233">(</span><span class="op" id="8171234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8171237">default</span><span class="op" id="8171244">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8171248">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8171269">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8171335">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8171391">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8171407">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8171469">t</span><span class="op" id="8171470">.</span><span class="ident" id="8171471">Skipf</span><span class="op" id="8171476">(</span><span class="string" id="8171477">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="8171509">,</span>&nbsp;<span class="ident" id="8171511">runtime</span><span class="op" id="8171518">.</span><span class="ident" id="8171519">GOOS</span><span class="op" id="8171523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8171526">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8171530">connected</span>&nbsp;<span class="op" id="8171540">:=</span>&nbsp;<span class="num" id="8171543">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8171546">for</span>&nbsp;<span class="op" id="8171550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8171554">select</span>&nbsp;<span class="op" id="8171561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8171565">case</span>&nbsp;<span class="op" id="8171570">&lt;-</span><span class="ident" id="8171572">time</span><span class="op" id="8171576">.</span><span class="ident" id="8171577">After</span><span class="op" id="8171582">(</span><span class="num" id="8171583">15</span>&nbsp;<span class="op" id="8171586">*</span>&nbsp;<span class="ident" id="8171588">time</span><span class="op" id="8171592">.</span><span class="ident" id="8171593">Second</span><span class="op" id="8171599">)</span><span class="op" id="8171600">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8171605">t</span><span class="op" id="8171606">.</span><span class="ident" id="8171607">Fatal</span><span class="op" id="8171612">(</span><span class="string" id="8171613">&#34;too&nbsp;slow&#34;</span><span class="op" id="8171623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8171627">case</span>&nbsp;<span class="ident" id="8171632">err</span>&nbsp;<span class="op" id="8171636">:=</span>&nbsp;<span class="op" id="8171639">&lt;-</span><span class="ident" id="8171641">errc</span><span class="op" id="8171645">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8171650">if</span>&nbsp;<span class="ident" id="8171653">err</span>&nbsp;<span class="op" id="8171657">==</span>&nbsp;<span class="ident" id="8171660">nil</span>&nbsp;<span class="op" id="8171664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8171670">connected</span><span class="op" id="8171679">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8171686">if</span>&nbsp;<span class="ident" id="8171689">connected</span>&nbsp;<span class="op" id="8171699">==</span>&nbsp;<span class="ident" id="8171702">numConns</span>&nbsp;<span class="op" id="8171711">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8171718">t</span><span class="op" id="8171719">.</span><span class="ident" id="8171720">Fatal</span><span class="op" id="8171725">(</span><span class="string" id="8171726">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="8171780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8171786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8171791">}</span>&nbsp;<span class="keyword" id="8171793">else</span>&nbsp;<span class="op" id="8171798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8171804">terr</span><span class="op" id="8171808">,</span>&nbsp;<span class="ident" id="8171810">ok</span>&nbsp;<span class="op" id="8171813">:=</span>&nbsp;<span class="ident" id="8171816">err</span><span class="op" id="8171819">.</span><span class="op" id="8171820">(</span><span class="ident" id="8171821">timeout</span><span class="op" id="8171828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8171834">if</span>&nbsp;<span class="op" id="8171837">!</span><span class="ident" id="8171838">ok</span>&nbsp;<span class="op" id="8171841">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8171848">t</span><span class="op" id="8171849">.</span><span class="ident" id="8171850">Fatalf</span><span class="op" id="8171856">(</span><span class="string" id="8171857">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="8171906">,</span>&nbsp;<span class="ident" id="8171908">err</span><span class="op" id="8171911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8171917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8171923">if</span>&nbsp;<span class="op" id="8171926">!</span><span class="ident" id="8171927">terr</span><span class="op" id="8171931">.</span><span class="ident" id="8171932">Timeout</span><span class="op" id="8171939">(</span><span class="op" id="8171940">)</span>&nbsp;<span class="op" id="8171942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8171949">t</span><span class="op" id="8171950">.</span><span class="ident" id="8171951">Fatalf</span><span class="op" id="8171957">(</span><span class="string" id="8171958">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="8171987">,</span>&nbsp;<span class="ident" id="8171989">err</span><span class="op" id="8171992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8171998">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8172004">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8172041">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8172051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8172055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8172058">}</span><br>
<span class="lineno">115</span><span class="op" id="8172060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8172063">func</span>&nbsp;<span class="ident" id="8172068">TestSelfConnect</span><span class="op" id="8172083">(</span><span class="ident" id="8172084">t</span>&nbsp;<span class="op" id="8172086">*</span><span class="ident" id="8172087">testing</span><span class="op" id="8172094">.</span><span class="ident" id="8172095">T</span><span class="op" id="8172096">)</span>&nbsp;<span class="op" id="8172098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8172101">if</span>&nbsp;<span class="ident" id="8172104">runtime</span><span class="op" id="8172111">.</span><span class="ident" id="8172112">GOOS</span>&nbsp;<span class="op" id="8172117">==</span>&nbsp;<span class="string" id="8172120">&#34;windows&#34;</span>&nbsp;<span class="op" id="8172130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8172134">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8172181">t</span><span class="op" id="8172182">.</span><span class="ident" id="8172183">Skip</span><span class="op" id="8172187">(</span><span class="string" id="8172188">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="8172227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8172230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8172234">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8172283">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8172316">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8172371">l</span><span class="op" id="8172372">,</span>&nbsp;<span class="ident" id="8172374">err</span>&nbsp;<span class="op" id="8172378">:=</span>&nbsp;<span class="ident" id="8172381">Listen</span><span class="op" id="8172387">(</span><span class="string" id="8172388">&#34;tcp&#34;</span><span class="op" id="8172393">,</span>&nbsp;<span class="string" id="8172395">&#34;127.0.0.1:0&#34;</span><span class="op" id="8172408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8172411">if</span>&nbsp;<span class="ident" id="8172414">err</span>&nbsp;<span class="op" id="8172418">!=</span>&nbsp;<span class="ident" id="8172421">nil</span>&nbsp;<span class="op" id="8172425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8172429">t</span><span class="op" id="8172430">.</span><span class="ident" id="8172431">Fatal</span><span class="op" id="8172436">(</span><span class="ident" id="8172437">err</span><span class="op" id="8172440">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8172443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8172446">c</span><span class="op" id="8172447">,</span>&nbsp;<span class="ident" id="8172449">err</span>&nbsp;<span class="op" id="8172453">:=</span>&nbsp;<span class="ident" id="8172456">Dial</span><span class="op" id="8172460">(</span><span class="string" id="8172461">&#34;tcp&#34;</span><span class="op" id="8172466">,</span>&nbsp;<span class="ident" id="8172468">l</span><span class="op" id="8172469">.</span><span class="ident" id="8172470">Addr</span><span class="op" id="8172474">(</span><span class="op" id="8172475">)</span><span class="op" id="8172476">.</span><span class="ident" id="8172477">String</span><span class="op" id="8172483">(</span><span class="op" id="8172484">)</span><span class="op" id="8172485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8172488">if</span>&nbsp;<span class="ident" id="8172491">err</span>&nbsp;<span class="op" id="8172495">!=</span>&nbsp;<span class="ident" id="8172498">nil</span>&nbsp;<span class="op" id="8172502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8172506">t</span><span class="op" id="8172507">.</span><span class="ident" id="8172508">Fatal</span><span class="op" id="8172513">(</span><span class="ident" id="8172514">err</span><span class="op" id="8172517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8172520">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8172523">addr</span>&nbsp;<span class="op" id="8172528">:=</span>&nbsp;<span class="ident" id="8172531">c</span><span class="op" id="8172532">.</span><span class="ident" id="8172533">LocalAddr</span><span class="op" id="8172542">(</span><span class="op" id="8172543">)</span><span class="op" id="8172544">.</span><span class="ident" id="8172545">String</span><span class="op" id="8172551">(</span><span class="op" id="8172552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8172555">c</span><span class="op" id="8172556">.</span><span class="ident" id="8172557">Close</span><span class="op" id="8172562">(</span><span class="op" id="8172563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8172566">l</span><span class="op" id="8172567">.</span><span class="ident" id="8172568">Close</span><span class="op" id="8172573">(</span><span class="op" id="8172574">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8172578">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8172625">n</span>&nbsp;<span class="op" id="8172627">:=</span>&nbsp;<span class="num" id="8172630">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8172638">if</span>&nbsp;<span class="ident" id="8172641">testing</span><span class="op" id="8172648">.</span><span class="ident" id="8172649">Short</span><span class="op" id="8172654">(</span><span class="op" id="8172655">)</span>&nbsp;<span class="op" id="8172657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8172661">n</span>&nbsp;<span class="op" id="8172663">=</span>&nbsp;<span class="num" id="8172665">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8172671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8172674">switch</span>&nbsp;<span class="ident" id="8172681">runtime</span><span class="op" id="8172688">.</span><span class="ident" id="8172689">GOOS</span>&nbsp;<span class="op" id="8172694">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8172697">case</span>&nbsp;<span class="string" id="8172702">&#34;darwin&#34;</span><span class="op" id="8172710">,</span>&nbsp;<span class="string" id="8172712">&#34;dragonfly&#34;</span><span class="op" id="8172723">,</span>&nbsp;<span class="string" id="8172725">&#34;freebsd&#34;</span><span class="op" id="8172734">,</span>&nbsp;<span class="string" id="8172736">&#34;netbsd&#34;</span><span class="op" id="8172744">,</span>&nbsp;<span class="string" id="8172746">&#34;openbsd&#34;</span><span class="op" id="8172755">,</span>&nbsp;<span class="string" id="8172757">&#34;plan9&#34;</span><span class="op" id="8172764">,</span>&nbsp;<span class="string" id="8172766">&#34;solaris&#34;</span><span class="op" id="8172775">,</span>&nbsp;<span class="string" id="8172777">&#34;windows&#34;</span><span class="op" id="8172786">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8172790">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8172840">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8172895">n</span>&nbsp;<span class="op" id="8172897">=</span>&nbsp;<span class="num" id="8172899">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8172904">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8172907">for</span>&nbsp;<span class="ident" id="8172911">i</span>&nbsp;<span class="op" id="8172913">:=</span>&nbsp;<span class="num" id="8172916">0</span><span class="op" id="8172917">;</span>&nbsp;<span class="ident" id="8172919">i</span>&nbsp;<span class="op" id="8172921">&lt;</span>&nbsp;<span class="ident" id="8172923">n</span><span class="op" id="8172924">;</span>&nbsp;<span class="ident" id="8172926">i</span><span class="op" id="8172927">++</span>&nbsp;<span class="op" id="8172930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8172934">c</span><span class="op" id="8172935">,</span>&nbsp;<span class="ident" id="8172937">err</span>&nbsp;<span class="op" id="8172941">:=</span>&nbsp;<span class="ident" id="8172944">DialTimeout</span><span class="op" id="8172955">(</span><span class="string" id="8172956">&#34;tcp&#34;</span><span class="op" id="8172961">,</span>&nbsp;<span class="ident" id="8172963">addr</span><span class="op" id="8172967">,</span>&nbsp;<span class="ident" id="8172969">time</span><span class="op" id="8172973">.</span><span class="ident" id="8172974">Millisecond</span><span class="op" id="8172985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8172989">if</span>&nbsp;<span class="ident" id="8172992">err</span>&nbsp;<span class="op" id="8172996">==</span>&nbsp;<span class="ident" id="8172999">nil</span>&nbsp;<span class="op" id="8173003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8173008">if</span>&nbsp;<span class="ident" id="8173011">c</span><span class="op" id="8173012">.</span><span class="ident" id="8173013">LocalAddr</span><span class="op" id="8173022">(</span><span class="op" id="8173023">)</span><span class="op" id="8173024">.</span><span class="ident" id="8173025">String</span><span class="op" id="8173031">(</span><span class="op" id="8173032">)</span>&nbsp;<span class="op" id="8173034">==</span>&nbsp;<span class="ident" id="8173037">addr</span>&nbsp;<span class="op" id="8173042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8173048">t</span><span class="op" id="8173049">.</span><span class="ident" id="8173050">Errorf</span><span class="op" id="8173056">(</span><span class="string" id="8173057">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="8173084">,</span>&nbsp;<span class="ident" id="8173086">i</span><span class="op" id="8173087">,</span>&nbsp;<span class="ident" id="8173089">addr</span><span class="op" id="8173093">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173098">}</span>&nbsp;<span class="keyword" id="8173100">else</span>&nbsp;<span class="op" id="8173105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8173111">t</span><span class="op" id="8173112">.</span><span class="ident" id="8173113">Logf</span><span class="op" id="8173117">(</span><span class="string" id="8173118">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="8173180">,</span>&nbsp;<span class="ident" id="8173182">i</span><span class="op" id="8173183">,</span>&nbsp;<span class="ident" id="8173185">addr</span><span class="op" id="8173189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8173199">c</span><span class="op" id="8173200">.</span><span class="ident" id="8173201">Close</span><span class="op" id="8173206">(</span><span class="op" id="8173207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173211">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173214">}</span><br>
<span class="lineno"></span><span class="op" id="8173216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8173219">var</span>&nbsp;<span class="ident" id="8173223">runErrorTest</span>&nbsp;<span class="op" id="8173236">=</span>&nbsp;<span class="ident" id="8173238">flag</span><span class="op" id="8173242">.</span><span class="ident" id="8173243">Bool</span><span class="op" id="8173247">(</span><span class="string" id="8173248">&#34;run_error_test&#34;</span><span class="op" id="8173264">,</span>&nbsp;<span class="builtintype" id="8173266">false</span><span class="op" id="8173271">,</span>&nbsp;<span class="string" id="8173273">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="8173313">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="8173316">type</span>&nbsp;<span class="ident" id="8173321">DialErrorTest</span>&nbsp;<span class="keyword" id="8173335">struct</span>&nbsp;<span class="op" id="8173342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8173345">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8173353">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8173361">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8173369">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8173377">Pattern</span>&nbsp;<span class="builtintype" id="8173385">string</span><br>
<span class="lineno"></span><span class="op" id="8173392">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="8173395">var</span>&nbsp;<span class="ident" id="8173399">dialErrorTests</span>&nbsp;<span class="op" id="8173414">=</span>&nbsp;<span class="op" id="8173416">[</span><span class="op" id="8173417">]</span><span class="ident" id="8173418">DialErrorTest</span><span class="op" id="8173431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8173438">&#34;datakit&#34;</span><span class="op" id="8173447">,</span>&nbsp;<span class="string" id="8173449">&#34;mh/astro/r70&#34;</span><span class="op" id="8173463">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8173467">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="8173519">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173522">}</span><span class="op" id="8173523">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8173530">&#34;tcp&#34;</span><span class="op" id="8173535">,</span>&nbsp;<span class="string" id="8173537">&#34;127.0.0.1:☺&#34;</span><span class="op" id="8173552">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8173556">&#34;dial&nbsp;tcp&nbsp;127.0.0.1:☺:&nbsp;unknown&nbsp;port&nbsp;tcp/☺&#34;</span><span class="op" id="8173602">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173605">}</span><span class="op" id="8173606">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8173613">&#34;tcp&#34;</span><span class="op" id="8173618">,</span>&nbsp;<span class="string" id="8173620">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="8173649">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8173653">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="8173742">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173745">}</span><span class="op" id="8173746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173749">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8173753">&#34;tcp&#34;</span><span class="op" id="8173758">,</span>&nbsp;<span class="string" id="8173760">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="8173803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8173807">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="8173924">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173927">}</span><span class="op" id="8173928">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8173931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8173935">&#34;tcp&#34;</span><span class="op" id="8173940">,</span>&nbsp;<span class="string" id="8173942">&#34;no-such-name:80&#34;</span><span class="op" id="8173959">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8173963">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="8174037">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174040">}</span><span class="op" id="8174041">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8174048">&#34;tcp&#34;</span><span class="op" id="8174053">,</span>&nbsp;<span class="string" id="8174055">&#34;mh/astro/r70:http&#34;</span><span class="op" id="8174074">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8174078">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="8174148">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174151">}</span><span class="op" id="8174152">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8174159">&#34;unix&#34;</span><span class="op" id="8174165">,</span>&nbsp;<span class="string" id="8174167">&#34;/etc/file-not-found&#34;</span><span class="op" id="8174188">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8174192">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="8174250">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174253">}</span><span class="op" id="8174254">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8174261">&#34;unix&#34;</span><span class="op" id="8174267">,</span>&nbsp;<span class="string" id="8174269">&#34;/etc/&#34;</span><span class="op" id="8174276">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8174280">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="8174368">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174371">}</span><span class="op" id="8174372">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174375">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8174379">&#34;unixpacket&#34;</span><span class="op" id="8174391">,</span>&nbsp;<span class="string" id="8174393">&#34;/etc/file-not-found&#34;</span><span class="op" id="8174414">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8174418">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="8174482">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174485">}</span><span class="op" id="8174486">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8174493">&#34;unixpacket&#34;</span><span class="op" id="8174505">,</span>&nbsp;<span class="string" id="8174507">&#34;/etc/&#34;</span><span class="op" id="8174514">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8174518">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="8174612">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174615">}</span><span class="op" id="8174616">,</span><br>
<span class="lineno"></span><span class="op" id="8174618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8174621">var</span>&nbsp;<span class="ident" id="8174625">duplicateErrorPattern</span>&nbsp;<span class="op" id="8174647">=</span>&nbsp;<span class="string" id="8174649">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="8174672">func</span>&nbsp;<span class="ident" id="8174677">TestDialError</span><span class="op" id="8174690">(</span><span class="ident" id="8174691">t</span>&nbsp;<span class="op" id="8174693">*</span><span class="ident" id="8174694">testing</span><span class="op" id="8174701">.</span><span class="ident" id="8174702">T</span><span class="op" id="8174703">)</span>&nbsp;<span class="op" id="8174705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8174708">if</span>&nbsp;<span class="op" id="8174711">!</span><span class="op" id="8174712">*</span><span class="ident" id="8174713">runErrorTest</span>&nbsp;<span class="op" id="8174726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8174730">t</span><span class="op" id="8174731">.</span><span class="ident" id="8174732">Logf</span><span class="op" id="8174736">(</span><span class="string" id="8174737">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="8174783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8174787">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8174798">for</span>&nbsp;<span class="ident" id="8174802">i</span><span class="op" id="8174803">,</span>&nbsp;<span class="ident" id="8174805">tt</span>&nbsp;<span class="op" id="8174808">:=</span>&nbsp;<span class="keyword" id="8174811">range</span>&nbsp;<span class="ident" id="8174817">dialErrorTests</span>&nbsp;<span class="op" id="8174832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8174836">c</span><span class="op" id="8174837">,</span>&nbsp;<span class="ident" id="8174839">err</span>&nbsp;<span class="op" id="8174843">:=</span>&nbsp;<span class="ident" id="8174846">Dial</span><span class="op" id="8174850">(</span><span class="ident" id="8174851">tt</span><span class="op" id="8174853">.</span><span class="ident" id="8174854">Net</span><span class="op" id="8174857">,</span>&nbsp;<span class="ident" id="8174859">tt</span><span class="op" id="8174861">.</span><span class="ident" id="8174862">Raddr</span><span class="op" id="8174867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8174871">if</span>&nbsp;<span class="ident" id="8174874">c</span>&nbsp;<span class="op" id="8174876">!=</span>&nbsp;<span class="ident" id="8174879">nil</span>&nbsp;<span class="op" id="8174883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8174888">c</span><span class="op" id="8174889">.</span><span class="ident" id="8174890">Close</span><span class="op" id="8174895">(</span><span class="op" id="8174896">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8174904">if</span>&nbsp;<span class="ident" id="8174907">err</span>&nbsp;<span class="op" id="8174911">==</span>&nbsp;<span class="ident" id="8174914">nil</span>&nbsp;<span class="op" id="8174918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8174923">t</span><span class="op" id="8174924">.</span><span class="ident" id="8174925">Errorf</span><span class="op" id="8174931">(</span><span class="string" id="8174932">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="8174968">,</span>&nbsp;<span class="ident" id="8174970">i</span><span class="op" id="8174971">,</span>&nbsp;<span class="ident" id="8174973">tt</span><span class="op" id="8174975">.</span><span class="ident" id="8174976">Pattern</span><span class="op" id="8174983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8174988">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8174999">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8175003">s</span>&nbsp;<span class="op" id="8175005">:=</span>&nbsp;<span class="ident" id="8175008">err</span><span class="op" id="8175011">.</span><span class="ident" id="8175012">Error</span><span class="op" id="8175017">(</span><span class="op" id="8175018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8175022">match</span><span class="op" id="8175027">,</span>&nbsp;<span class="ident" id="8175029">_</span>&nbsp;<span class="op" id="8175031">:=</span>&nbsp;<span class="ident" id="8175034">regexp</span><span class="op" id="8175040">.</span><span class="ident" id="8175041">MatchString</span><span class="op" id="8175052">(</span><span class="ident" id="8175053">tt</span><span class="op" id="8175055">.</span><span class="ident" id="8175056">Pattern</span><span class="op" id="8175063">,</span>&nbsp;<span class="ident" id="8175065">s</span><span class="op" id="8175066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8175070">if</span>&nbsp;<span class="op" id="8175073">!</span><span class="ident" id="8175074">match</span>&nbsp;<span class="op" id="8175080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8175085">t</span><span class="op" id="8175086">.</span><span class="ident" id="8175087">Errorf</span><span class="op" id="8175093">(</span><span class="string" id="8175094">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="8175123">,</span>&nbsp;<span class="ident" id="8175125">i</span><span class="op" id="8175126">,</span>&nbsp;<span class="ident" id="8175128">s</span><span class="op" id="8175129">,</span>&nbsp;<span class="ident" id="8175131">tt</span><span class="op" id="8175133">.</span><span class="ident" id="8175134">Pattern</span><span class="op" id="8175141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8175145">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8175149">match</span><span class="op" id="8175154">,</span>&nbsp;<span class="ident" id="8175156">_</span>&nbsp;<span class="op" id="8175158">=</span>&nbsp;<span class="ident" id="8175160">regexp</span><span class="op" id="8175166">.</span><span class="ident" id="8175167">MatchString</span><span class="op" id="8175178">(</span><span class="ident" id="8175179">duplicateErrorPattern</span><span class="op" id="8175200">,</span>&nbsp;<span class="ident" id="8175202">s</span><span class="op" id="8175203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8175207">if</span>&nbsp;<span class="ident" id="8175210">match</span>&nbsp;<span class="op" id="8175216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8175221">t</span><span class="op" id="8175222">.</span><span class="ident" id="8175223">Errorf</span><span class="op" id="8175229">(</span><span class="string" id="8175230">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="8175273">,</span>&nbsp;<span class="ident" id="8175275">i</span><span class="op" id="8175276">,</span>&nbsp;<span class="ident" id="8175278">s</span><span class="op" id="8175279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8175283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8175286">}</span><br>
<span class="lineno">240</span><span class="op" id="8175288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8175291">var</span>&nbsp;<span class="ident" id="8175295">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="8175324">=</span>&nbsp;<span class="op" id="8175326">[</span><span class="op" id="8175327">]</span><span class="keyword" id="8175328">struct</span>&nbsp;<span class="op" id="8175335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8175338">net</span>&nbsp;&nbsp;<span class="builtintype" id="8175343">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8175351">addr</span>&nbsp;<span class="builtintype" id="8175356">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8175364">err</span>&nbsp;&nbsp;<span class="builtintype" id="8175369">error</span><br>
<span class="lineno"></span><span class="op" id="8175375">}</span><span class="op" id="8175376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8175379">{</span><span class="string" id="8175380">&#34;foo&#34;</span><span class="op" id="8175385">,</span>&nbsp;<span class="string" id="8175387">&#34;bar&#34;</span><span class="op" id="8175392">,</span>&nbsp;<span class="op" id="8175394">&amp;</span><span class="ident" id="8175395">OpError</span><span class="op" id="8175402">{</span><span class="ident" id="8175403">Op</span><span class="op" id="8175405">:</span>&nbsp;<span class="string" id="8175407">&#34;dial&#34;</span><span class="op" id="8175413">,</span>&nbsp;<span class="ident" id="8175415">Net</span><span class="op" id="8175418">:</span>&nbsp;<span class="string" id="8175420">&#34;foo&#34;</span><span class="op" id="8175425">,</span>&nbsp;<span class="ident" id="8175427">Addr</span><span class="op" id="8175431">:</span>&nbsp;<span class="ident" id="8175433">nil</span><span class="op" id="8175436">,</span>&nbsp;<span class="ident" id="8175438">Err</span><span class="op" id="8175441">:</span>&nbsp;<span class="ident" id="8175443">UnknownNetworkError</span><span class="op" id="8175462">(</span><span class="string" id="8175463">&#34;foo&#34;</span><span class="op" id="8175468">)</span><span class="op" id="8175469">}</span><span class="op" id="8175470">}</span><span class="op" id="8175471">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8175474">{</span><span class="string" id="8175475">&#34;baz&#34;</span><span class="op" id="8175480">,</span>&nbsp;<span class="string" id="8175482">&#34;&#34;</span><span class="op" id="8175484">,</span>&nbsp;<span class="op" id="8175486">&amp;</span><span class="ident" id="8175487">OpError</span><span class="op" id="8175494">{</span><span class="ident" id="8175495">Op</span><span class="op" id="8175497">:</span>&nbsp;<span class="string" id="8175499">&#34;listen&#34;</span><span class="op" id="8175507">,</span>&nbsp;<span class="ident" id="8175509">Net</span><span class="op" id="8175512">:</span>&nbsp;<span class="string" id="8175514">&#34;baz&#34;</span><span class="op" id="8175519">,</span>&nbsp;<span class="ident" id="8175521">Addr</span><span class="op" id="8175525">:</span>&nbsp;<span class="ident" id="8175527">nil</span><span class="op" id="8175530">,</span>&nbsp;<span class="ident" id="8175532">Err</span><span class="op" id="8175535">:</span>&nbsp;<span class="ident" id="8175537">UnknownNetworkError</span><span class="op" id="8175556">(</span><span class="string" id="8175557">&#34;baz&#34;</span><span class="op" id="8175562">)</span><span class="op" id="8175563">}</span><span class="op" id="8175564">}</span><span class="op" id="8175565">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8175568">{</span><span class="string" id="8175569">&#34;tcp&#34;</span><span class="op" id="8175574">,</span>&nbsp;<span class="string" id="8175576">&#34;&#34;</span><span class="op" id="8175578">,</span>&nbsp;<span class="op" id="8175580">&amp;</span><span class="ident" id="8175581">OpError</span><span class="op" id="8175588">{</span><span class="ident" id="8175589">Op</span><span class="op" id="8175591">:</span>&nbsp;<span class="string" id="8175593">&#34;dial&#34;</span><span class="op" id="8175599">,</span>&nbsp;<span class="ident" id="8175601">Net</span><span class="op" id="8175604">:</span>&nbsp;<span class="string" id="8175606">&#34;tcp&#34;</span><span class="op" id="8175611">,</span>&nbsp;<span class="ident" id="8175613">Addr</span><span class="op" id="8175617">:</span>&nbsp;<span class="ident" id="8175619">nil</span><span class="op" id="8175622">,</span>&nbsp;<span class="ident" id="8175624">Err</span><span class="op" id="8175627">:</span>&nbsp;<span class="ident" id="8175629">errMissingAddress</span><span class="op" id="8175646">}</span><span class="op" id="8175647">}</span><span class="op" id="8175648">,</span><br>
<span class="lineno">250</span><span class="op" id="8175650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8175653">func</span>&nbsp;<span class="ident" id="8175658">TestInvalidDialAndListenArgs</span><span class="op" id="8175686">(</span><span class="ident" id="8175687">t</span>&nbsp;<span class="op" id="8175689">*</span><span class="ident" id="8175690">testing</span><span class="op" id="8175697">.</span><span class="ident" id="8175698">T</span><span class="op" id="8175699">)</span>&nbsp;<span class="op" id="8175701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8175704">for</span>&nbsp;<span class="ident" id="8175708">_</span><span class="op" id="8175709">,</span>&nbsp;<span class="ident" id="8175711">tt</span>&nbsp;<span class="op" id="8175714">:=</span>&nbsp;<span class="keyword" id="8175717">range</span>&nbsp;<span class="ident" id="8175723">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="8175752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8175756">var</span>&nbsp;<span class="ident" id="8175760">err</span>&nbsp;<span class="builtintype" id="8175764">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8175772">switch</span>&nbsp;<span class="ident" id="8175779">tt</span><span class="op" id="8175781">.</span><span class="ident" id="8175782">err</span><span class="op" id="8175785">.</span><span class="op" id="8175786">(</span><span class="op" id="8175787">*</span><span class="ident" id="8175788">OpError</span><span class="op" id="8175795">)</span><span class="op" id="8175796">.</span><span class="ident" id="8175797">Op</span>&nbsp;<span class="op" id="8175800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8175804">case</span>&nbsp;<span class="string" id="8175809">&#34;dial&#34;</span><span class="op" id="8175815">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8175820">_</span><span class="op" id="8175821">,</span>&nbsp;<span class="ident" id="8175823">err</span>&nbsp;<span class="op" id="8175827">=</span>&nbsp;<span class="ident" id="8175829">Dial</span><span class="op" id="8175833">(</span><span class="ident" id="8175834">tt</span><span class="op" id="8175836">.</span><span class="ident" id="8175837">net</span><span class="op" id="8175840">,</span>&nbsp;<span class="ident" id="8175842">tt</span><span class="op" id="8175844">.</span><span class="ident" id="8175845">addr</span><span class="op" id="8175849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8175853">case</span>&nbsp;<span class="string" id="8175858">&#34;listen&#34;</span><span class="op" id="8175866">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8175871">_</span><span class="op" id="8175872">,</span>&nbsp;<span class="ident" id="8175874">err</span>&nbsp;<span class="op" id="8175878">=</span>&nbsp;<span class="ident" id="8175880">Listen</span><span class="op" id="8175886">(</span><span class="ident" id="8175887">tt</span><span class="op" id="8175889">.</span><span class="ident" id="8175890">net</span><span class="op" id="8175893">,</span>&nbsp;<span class="ident" id="8175895">tt</span><span class="op" id="8175897">.</span><span class="ident" id="8175898">addr</span><span class="op" id="8175902">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8175906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8175910">if</span>&nbsp;<span class="op" id="8175913">!</span><span class="ident" id="8175914">reflect</span><span class="op" id="8175921">.</span><span class="ident" id="8175922">DeepEqual</span><span class="op" id="8175931">(</span><span class="ident" id="8175932">tt</span><span class="op" id="8175934">.</span><span class="ident" id="8175935">err</span><span class="op" id="8175938">,</span>&nbsp;<span class="ident" id="8175940">err</span><span class="op" id="8175943">)</span>&nbsp;<span class="op" id="8175945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8175950">t</span><span class="op" id="8175951">.</span><span class="ident" id="8175952">Fatalf</span><span class="op" id="8175958">(</span><span class="string" id="8175959">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="8175982">,</span>&nbsp;<span class="ident" id="8175984">err</span><span class="op" id="8175987">,</span>&nbsp;<span class="ident" id="8175989">tt</span><span class="op" id="8175991">.</span><span class="ident" id="8175992">err</span><span class="op" id="8175995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8175999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8176002">}</span><br>
<span class="lineno">265</span><span class="op" id="8176004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8176007">func</span>&nbsp;<span class="ident" id="8176012">TestDialTimeoutFDLeak</span><span class="op" id="8176033">(</span><span class="ident" id="8176034">t</span>&nbsp;<span class="op" id="8176036">*</span><span class="ident" id="8176037">testing</span><span class="op" id="8176044">.</span><span class="ident" id="8176045">T</span><span class="op" id="8176046">)</span>&nbsp;<span class="op" id="8176048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176051">if</span>&nbsp;<span class="ident" id="8176054">runtime</span><span class="op" id="8176061">.</span><span class="ident" id="8176062">GOOS</span>&nbsp;<span class="op" id="8176067">!=</span>&nbsp;<span class="string" id="8176070">&#34;linux&#34;</span>&nbsp;<span class="op" id="8176078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8176082">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176127">t</span><span class="op" id="8176128">.</span><span class="ident" id="8176129">Skipf</span><span class="op" id="8176134">(</span><span class="string" id="8176135">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="8176156">,</span>&nbsp;<span class="ident" id="8176158">runtime</span><span class="op" id="8176165">.</span><span class="ident" id="8176166">GOOS</span><span class="op" id="8176170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8176173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176177">ln</span>&nbsp;<span class="op" id="8176180">:=</span>&nbsp;<span class="ident" id="8176183">newLocalListener</span><span class="op" id="8176199">(</span><span class="ident" id="8176200">t</span><span class="op" id="8176201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176204">defer</span>&nbsp;<span class="ident" id="8176210">ln</span><span class="op" id="8176212">.</span><span class="ident" id="8176213">Close</span><span class="op" id="8176218">(</span><span class="op" id="8176219">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176223">type</span>&nbsp;<span class="ident" id="8176228">connErr</span>&nbsp;<span class="keyword" id="8176236">struct</span>&nbsp;<span class="op" id="8176243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176247">conn</span>&nbsp;<span class="ident" id="8176252">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176259">err</span>&nbsp;&nbsp;<span class="builtintype" id="8176264">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8176271">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176274">dials</span>&nbsp;<span class="op" id="8176280">:=</span>&nbsp;<span class="ident" id="8176283">listenerBacklog</span>&nbsp;<span class="op" id="8176299">+</span>&nbsp;<span class="num" id="8176301">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8176306">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176386">maxGoodConnect</span>&nbsp;<span class="op" id="8176401">:=</span>&nbsp;<span class="ident" id="8176404">listenerBacklog</span>&nbsp;<span class="op" id="8176420">+</span>&nbsp;<span class="ident" id="8176422">runtime</span><span class="op" id="8176429">.</span><span class="ident" id="8176430">NumCPU</span><span class="op" id="8176436">(</span><span class="op" id="8176437">)</span><span class="op" id="8176438">*</span><span class="num" id="8176439">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176443">resc</span>&nbsp;<span class="op" id="8176448">:=</span>&nbsp;<span class="builtinfunc" id="8176451">make</span><span class="op" id="8176455">(</span><span class="keyword" id="8176456">chan</span>&nbsp;<span class="ident" id="8176461">connErr</span><span class="op" id="8176468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176471">for</span>&nbsp;<span class="ident" id="8176475">i</span>&nbsp;<span class="op" id="8176477">:=</span>&nbsp;<span class="num" id="8176480">0</span><span class="op" id="8176481">;</span>&nbsp;<span class="ident" id="8176483">i</span>&nbsp;<span class="op" id="8176485">&lt;</span>&nbsp;<span class="ident" id="8176487">dials</span><span class="op" id="8176492">;</span>&nbsp;<span class="ident" id="8176494">i</span><span class="op" id="8176495">++</span>&nbsp;<span class="op" id="8176498">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176502">go</span>&nbsp;<span class="keyword" id="8176505">func</span><span class="op" id="8176509">(</span><span class="op" id="8176510">)</span>&nbsp;<span class="op" id="8176512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176517">conn</span><span class="op" id="8176521">,</span>&nbsp;<span class="ident" id="8176523">err</span>&nbsp;<span class="op" id="8176527">:=</span>&nbsp;<span class="ident" id="8176530">DialTimeout</span><span class="op" id="8176541">(</span><span class="string" id="8176542">&#34;tcp&#34;</span><span class="op" id="8176547">,</span>&nbsp;<span class="ident" id="8176549">ln</span><span class="op" id="8176551">.</span><span class="ident" id="8176552">Addr</span><span class="op" id="8176556">(</span><span class="op" id="8176557">)</span><span class="op" id="8176558">.</span><span class="ident" id="8176559">String</span><span class="op" id="8176565">(</span><span class="op" id="8176566">)</span><span class="op" id="8176567">,</span>&nbsp;<span class="num" id="8176569">500</span><span class="op" id="8176572">*</span><span class="ident" id="8176573">time</span><span class="op" id="8176577">.</span><span class="ident" id="8176578">Millisecond</span><span class="op" id="8176589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176594">resc</span>&nbsp;<span class="op" id="8176599">&lt;-</span>&nbsp;<span class="ident" id="8176602">connErr</span><span class="op" id="8176609">{</span><span class="ident" id="8176610">conn</span><span class="op" id="8176614">,</span>&nbsp;<span class="ident" id="8176616">err</span><span class="op" id="8176619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8176623">}</span><span class="op" id="8176624">(</span><span class="op" id="8176625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8176628">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176632">var</span>&nbsp;<span class="ident" id="8176636">firstErr</span>&nbsp;<span class="builtintype" id="8176645">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176653">var</span>&nbsp;<span class="ident" id="8176657">ngood</span>&nbsp;<span class="builtintype" id="8176663">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176668">var</span>&nbsp;<span class="ident" id="8176672">toClose</span>&nbsp;<span class="op" id="8176680">[</span><span class="op" id="8176681">]</span><span class="ident" id="8176682">io</span><span class="op" id="8176684">.</span><span class="ident" id="8176685">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176693">for</span>&nbsp;<span class="ident" id="8176697">i</span>&nbsp;<span class="op" id="8176699">:=</span>&nbsp;<span class="num" id="8176702">0</span><span class="op" id="8176703">;</span>&nbsp;<span class="ident" id="8176705">i</span>&nbsp;<span class="op" id="8176707">&lt;</span>&nbsp;<span class="ident" id="8176709">dials</span><span class="op" id="8176714">;</span>&nbsp;<span class="ident" id="8176716">i</span><span class="op" id="8176717">++</span>&nbsp;<span class="op" id="8176720">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176724">ce</span>&nbsp;<span class="op" id="8176727">:=</span>&nbsp;<span class="op" id="8176730">&lt;-</span><span class="ident" id="8176732">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176739">if</span>&nbsp;<span class="ident" id="8176742">ce</span><span class="op" id="8176744">.</span><span class="ident" id="8176745">err</span>&nbsp;<span class="op" id="8176749">==</span>&nbsp;<span class="ident" id="8176752">nil</span>&nbsp;<span class="op" id="8176756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176761">ngood</span><span class="op" id="8176766">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176772">if</span>&nbsp;<span class="ident" id="8176775">ngood</span>&nbsp;<span class="op" id="8176781">&gt;</span>&nbsp;<span class="ident" id="8176783">maxGoodConnect</span>&nbsp;<span class="op" id="8176798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176804">t</span><span class="op" id="8176805">.</span><span class="ident" id="8176806">Errorf</span><span class="op" id="8176812">(</span><span class="string" id="8176813">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="8176852">,</span>&nbsp;<span class="ident" id="8176854">ngood</span><span class="op" id="8176859">,</span>&nbsp;<span class="ident" id="8176861">maxGoodConnect</span><span class="op" id="8176875">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8176880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176885">toClose</span>&nbsp;<span class="op" id="8176893">=</span>&nbsp;<span class="builtinfunc" id="8176895">append</span><span class="op" id="8176901">(</span><span class="ident" id="8176902">toClose</span><span class="op" id="8176909">,</span>&nbsp;<span class="ident" id="8176911">ce</span><span class="op" id="8176913">.</span><span class="ident" id="8176914">conn</span><span class="op" id="8176918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176923">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8176934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176938">err</span>&nbsp;<span class="op" id="8176942">:=</span>&nbsp;<span class="ident" id="8176945">ce</span><span class="op" id="8176947">.</span><span class="ident" id="8176948">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8176954">if</span>&nbsp;<span class="ident" id="8176957">firstErr</span>&nbsp;<span class="op" id="8176966">==</span>&nbsp;<span class="string" id="8176969">&#34;&#34;</span>&nbsp;<span class="op" id="8176972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8176977">firstErr</span>&nbsp;<span class="op" id="8176986">=</span>&nbsp;<span class="ident" id="8176988">err</span><span class="op" id="8176991">.</span><span class="ident" id="8176992">Error</span><span class="op" id="8176997">(</span><span class="op" id="8176998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8177002">}</span>&nbsp;<span class="keyword" id="8177004">else</span>&nbsp;<span class="keyword" id="8177009">if</span>&nbsp;<span class="ident" id="8177012">err</span><span class="op" id="8177015">.</span><span class="ident" id="8177016">Error</span><span class="op" id="8177021">(</span><span class="op" id="8177022">)</span>&nbsp;<span class="op" id="8177024">!=</span>&nbsp;<span class="ident" id="8177027">firstErr</span>&nbsp;<span class="op" id="8177036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8177041">t</span><span class="op" id="8177042">.</span><span class="ident" id="8177043">Fatalf</span><span class="op" id="8177049">(</span><span class="string" id="8177050">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="8177108">,</span>&nbsp;<span class="ident" id="8177110">firstErr</span><span class="op" id="8177118">,</span>&nbsp;<span class="ident" id="8177120">err</span><span class="op" id="8177123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8177127">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8177130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8177133">for</span>&nbsp;<span class="ident" id="8177137">_</span><span class="op" id="8177138">,</span>&nbsp;<span class="ident" id="8177140">c</span>&nbsp;<span class="op" id="8177142">:=</span>&nbsp;<span class="keyword" id="8177145">range</span>&nbsp;<span class="ident" id="8177151">toClose</span>&nbsp;<span class="op" id="8177159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8177163">c</span><span class="op" id="8177164">.</span><span class="ident" id="8177165">Close</span><span class="op" id="8177170">(</span><span class="op" id="8177171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8177174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8177177">for</span>&nbsp;<span class="ident" id="8177181">i</span>&nbsp;<span class="op" id="8177183">:=</span>&nbsp;<span class="num" id="8177186">0</span><span class="op" id="8177187">;</span>&nbsp;<span class="ident" id="8177189">i</span>&nbsp;<span class="op" id="8177191">&lt;</span>&nbsp;<span class="num" id="8177193">100</span><span class="op" id="8177196">;</span>&nbsp;<span class="ident" id="8177198">i</span><span class="op" id="8177199">++</span>&nbsp;<span class="op" id="8177202">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8177206">if</span>&nbsp;<span class="ident" id="8177209">got</span>&nbsp;<span class="op" id="8177213">:=</span>&nbsp;<span class="ident" id="8177216">numFD</span><span class="op" id="8177221">(</span><span class="op" id="8177222">)</span><span class="op" id="8177223">;</span>&nbsp;<span class="ident" id="8177225">got</span>&nbsp;<span class="op" id="8177229">&lt;</span>&nbsp;<span class="ident" id="8177231">dials</span>&nbsp;<span class="op" id="8177237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8177242">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8177261">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8177270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8177274">time</span><span class="op" id="8177278">.</span><span class="ident" id="8177279">Sleep</span><span class="op" id="8177284">(</span><span class="num" id="8177285">10</span>&nbsp;<span class="op" id="8177288">*</span>&nbsp;<span class="ident" id="8177290">time</span><span class="op" id="8177294">.</span><span class="ident" id="8177295">Millisecond</span><span class="op" id="8177306">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8177309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8177312">if</span>&nbsp;<span class="ident" id="8177315">got</span>&nbsp;<span class="op" id="8177319">:=</span>&nbsp;<span class="ident" id="8177322">numFD</span><span class="op" id="8177327">(</span><span class="op" id="8177328">)</span><span class="op" id="8177329">;</span>&nbsp;<span class="ident" id="8177331">got</span>&nbsp;<span class="op" id="8177335">&gt;=</span>&nbsp;<span class="ident" id="8177338">dials</span>&nbsp;<span class="op" id="8177344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8177348">t</span><span class="op" id="8177349">.</span><span class="ident" id="8177350">Errorf</span><span class="op" id="8177356">(</span><span class="string" id="8177357">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="8177399">,</span>&nbsp;<span class="ident" id="8177401">dials</span><span class="op" id="8177406">,</span>&nbsp;<span class="ident" id="8177408">got</span><span class="op" id="8177411">,</span>&nbsp;<span class="ident" id="8177413">dials</span><span class="op" id="8177418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8177421">}</span><br>
<span class="lineno"></span><span class="op" id="8177423">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="8177426">func</span>&nbsp;<span class="ident" id="8177431">numTCP</span><span class="op" id="8177437">(</span><span class="op" id="8177438">)</span>&nbsp;<span class="op" id="8177440">(</span><span class="ident" id="8177441">ntcp</span><span class="op" id="8177445">,</span>&nbsp;<span class="ident" id="8177447">nopen</span><span class="op" id="8177452">,</span>&nbsp;<span class="ident" id="8177454">nclose</span>&nbsp;<span class="builtintype" id="8177461">int</span><span class="op" id="8177464">,</span>&nbsp;<span class="ident" id="8177466">err</span>&nbsp;<span class="builtintype" id="8177470">error</span><span class="op" id="8177475">)</span>&nbsp;<span class="op" id="8177477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8177480">lsof</span><span class="op" id="8177484">,</span>&nbsp;<span class="ident" id="8177486">err</span>&nbsp;<span class="op" id="8177490">:=</span>&nbsp;<span class="ident" id="8177493">exec</span><span class="op" id="8177497">.</span><span class="ident" id="8177498">Command</span><span class="op" id="8177505">(</span><span class="string" id="8177506">&#34;lsof&#34;</span><span class="op" id="8177512">,</span>&nbsp;<span class="string" id="8177514">&#34;-n&#34;</span><span class="op" id="8177518">,</span>&nbsp;<span class="string" id="8177520">&#34;-p&#34;</span><span class="op" id="8177524">,</span>&nbsp;<span class="ident" id="8177526">strconv</span><span class="op" id="8177533">.</span><span class="ident" id="8177534">Itoa</span><span class="op" id="8177538">(</span><span class="ident" id="8177539">os</span><span class="op" id="8177541">.</span><span class="ident" id="8177542">Getpid</span><span class="op" id="8177548">(</span><span class="op" id="8177549">)</span><span class="op" id="8177550">)</span><span class="op" id="8177551">)</span><span class="op" id="8177552">.</span><span class="ident" id="8177553">Output</span><span class="op" id="8177559">(</span><span class="op" id="8177560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8177563">if</span>&nbsp;<span class="ident" id="8177566">err</span>&nbsp;<span class="op" id="8177570">!=</span>&nbsp;<span class="ident" id="8177573">nil</span>&nbsp;<span class="op" id="8177577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8177581">return</span>&nbsp;<span class="num" id="8177588">0</span><span class="op" id="8177589">,</span>&nbsp;<span class="num" id="8177591">0</span><span class="op" id="8177592">,</span>&nbsp;<span class="num" id="8177594">0</span><span class="op" id="8177595">,</span>&nbsp;<span class="ident" id="8177597">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8177602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8177605">ntcp</span>&nbsp;<span class="op" id="8177610">+=</span>&nbsp;<span class="ident" id="8177613">bytes</span><span class="op" id="8177618">.</span><span class="ident" id="8177619">Count</span><span class="op" id="8177624">(</span><span class="ident" id="8177625">lsof</span><span class="op" id="8177629">,</span>&nbsp;<span class="op" id="8177631">[</span><span class="op" id="8177632">]</span><span class="builtintype" id="8177633">byte</span><span class="op" id="8177637">(</span><span class="string" id="8177638">&#34;TCP&#34;</span><span class="op" id="8177643">)</span><span class="op" id="8177644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8177647">for</span>&nbsp;<span class="ident" id="8177651">_</span><span class="op" id="8177652">,</span>&nbsp;<span class="ident" id="8177654">state</span>&nbsp;<span class="op" id="8177660">:=</span>&nbsp;<span class="keyword" id="8177663">range</span>&nbsp;<span class="op" id="8177669">[</span><span class="op" id="8177670">]</span><span class="builtintype" id="8177671">string</span><span class="op" id="8177677">{</span><span class="string" id="8177678">&#34;LISTEN&#34;</span><span class="op" id="8177686">,</span>&nbsp;<span class="string" id="8177688">&#34;SYN_SENT&#34;</span><span class="op" id="8177698">,</span>&nbsp;<span class="string" id="8177700">&#34;SYN_RECEIVED&#34;</span><span class="op" id="8177714">,</span>&nbsp;<span class="string" id="8177716">&#34;ESTABLISHED&#34;</span><span class="op" id="8177729">}</span>&nbsp;<span class="op" id="8177731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8177735">nopen</span>&nbsp;<span class="op" id="8177741">+=</span>&nbsp;<span class="ident" id="8177744">bytes</span><span class="op" id="8177749">.</span><span class="ident" id="8177750">Count</span><span class="op" id="8177755">(</span><span class="ident" id="8177756">lsof</span><span class="op" id="8177760">,</span>&nbsp;<span class="op" id="8177762">[</span><span class="op" id="8177763">]</span><span class="builtintype" id="8177764">byte</span><span class="op" id="8177768">(</span><span class="ident" id="8177769">state</span><span class="op" id="8177774">)</span><span class="op" id="8177775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8177778">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8177781">for</span>&nbsp;<span class="ident" id="8177785">_</span><span class="op" id="8177786">,</span>&nbsp;<span class="ident" id="8177788">state</span>&nbsp;<span class="op" id="8177794">:=</span>&nbsp;<span class="keyword" id="8177797">range</span>&nbsp;<span class="op" id="8177803">[</span><span class="op" id="8177804">]</span><span class="builtintype" id="8177805">string</span><span class="op" id="8177811">{</span><span class="string" id="8177812">&#34;CLOSED&#34;</span><span class="op" id="8177820">,</span>&nbsp;<span class="string" id="8177822">&#34;CLOSE_WAIT&#34;</span><span class="op" id="8177834">,</span>&nbsp;<span class="string" id="8177836">&#34;LAST_ACK&#34;</span><span class="op" id="8177846">,</span>&nbsp;<span class="string" id="8177848">&#34;FIN_WAIT_1&#34;</span><span class="op" id="8177860">,</span>&nbsp;<span class="string" id="8177862">&#34;FIN_WAIT_2&#34;</span><span class="op" id="8177874">,</span>&nbsp;<span class="string" id="8177876">&#34;CLOSING&#34;</span><span class="op" id="8177885">,</span>&nbsp;<span class="string" id="8177887">&#34;TIME_WAIT&#34;</span><span class="op" id="8177898">}</span>&nbsp;<span class="op" id="8177900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8177904">nclose</span>&nbsp;<span class="op" id="8177911">+=</span>&nbsp;<span class="ident" id="8177914">bytes</span><span class="op" id="8177919">.</span><span class="ident" id="8177920">Count</span><span class="op" id="8177925">(</span><span class="ident" id="8177926">lsof</span><span class="op" id="8177930">,</span>&nbsp;<span class="op" id="8177932">[</span><span class="op" id="8177933">]</span><span class="builtintype" id="8177934">byte</span><span class="op" id="8177938">(</span><span class="ident" id="8177939">state</span><span class="op" id="8177944">)</span><span class="op" id="8177945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8177948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8177951">return</span>&nbsp;<span class="ident" id="8177958">ntcp</span><span class="op" id="8177962">,</span>&nbsp;<span class="ident" id="8177964">nopen</span><span class="op" id="8177969">,</span>&nbsp;<span class="ident" id="8177971">nclose</span><span class="op" id="8177977">,</span>&nbsp;<span class="ident" id="8177979">nil</span><br>
<span class="lineno"></span><span class="op" id="8177983">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="8177986">func</span>&nbsp;<span class="ident" id="8177991">TestDialMultiFDLeak</span><span class="op" id="8178010">(</span><span class="ident" id="8178011">t</span>&nbsp;<span class="op" id="8178013">*</span><span class="ident" id="8178014">testing</span><span class="op" id="8178021">.</span><span class="ident" id="8178022">T</span><span class="op" id="8178023">)</span>&nbsp;<span class="op" id="8178025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8178028">t</span><span class="op" id="8178029">.</span><span class="ident" id="8178030">Skip</span><span class="op" id="8178034">(</span><span class="string" id="8178035">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="8178071">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8178075">if</span>&nbsp;<span class="op" id="8178078">!</span><span class="ident" id="8178079">supportsIPv4</span>&nbsp;<span class="op" id="8178092">||</span>&nbsp;<span class="op" id="8178095">!</span><span class="ident" id="8178096">supportsIPv6</span>&nbsp;<span class="op" id="8178109">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8178113">t</span><span class="op" id="8178114">.</span><span class="ident" id="8178115">Skip</span><span class="op" id="8178119">(</span><span class="string" id="8178120">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="8178156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8178159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8178163">halfDeadServer</span>&nbsp;<span class="op" id="8178178">:=</span>&nbsp;<span class="keyword" id="8178181">func</span><span class="op" id="8178185">(</span><span class="ident" id="8178186">dss</span>&nbsp;<span class="op" id="8178190">*</span><span class="ident" id="8178191">dualStackServer</span><span class="op" id="8178206">,</span>&nbsp;<span class="ident" id="8178208">ln</span>&nbsp;<span class="ident" id="8178211">Listener</span><span class="op" id="8178219">)</span>&nbsp;<span class="op" id="8178221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8178225">for</span>&nbsp;<span class="op" id="8178229">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8178234">if</span>&nbsp;<span class="ident" id="8178237">c</span><span class="op" id="8178238">,</span>&nbsp;<span class="ident" id="8178240">err</span>&nbsp;<span class="op" id="8178244">:=</span>&nbsp;<span class="ident" id="8178247">ln</span><span class="op" id="8178249">.</span><span class="ident" id="8178250">Accept</span><span class="op" id="8178256">(</span><span class="op" id="8178257">)</span><span class="op" id="8178258">;</span>&nbsp;<span class="ident" id="8178260">err</span>&nbsp;<span class="op" id="8178264">!=</span>&nbsp;<span class="ident" id="8178267">nil</span>&nbsp;<span class="op" id="8178271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8178277">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8178287">}</span>&nbsp;<span class="keyword" id="8178289">else</span>&nbsp;<span class="op" id="8178294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8178300">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8178333">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8178376">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8178389">dss</span><span class="op" id="8178392">.</span><span class="ident" id="8178393">putConn</span><span class="op" id="8178400">(</span><span class="ident" id="8178401">c</span><span class="op" id="8178402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8178407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8178411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8178414">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8178417">dss</span><span class="op" id="8178420">,</span>&nbsp;<span class="ident" id="8178422">err</span>&nbsp;<span class="op" id="8178426">:=</span>&nbsp;<span class="ident" id="8178429">newDualStackServer</span><span class="op" id="8178447">(</span><span class="op" id="8178448">[</span><span class="op" id="8178449">]</span><span class="ident" id="8178450">streamListener</span><span class="op" id="8178464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8178468">{</span><span class="ident" id="8178469">net</span><span class="op" id="8178472">:</span>&nbsp;<span class="string" id="8178474">&#34;tcp4&#34;</span><span class="op" id="8178480">,</span>&nbsp;<span class="ident" id="8178482">addr</span><span class="op" id="8178486">:</span>&nbsp;<span class="string" id="8178488">&#34;127.0.0.1&#34;</span><span class="op" id="8178499">}</span><span class="op" id="8178500">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8178504">{</span><span class="ident" id="8178505">net</span><span class="op" id="8178508">:</span>&nbsp;<span class="string" id="8178510">&#34;tcp6&#34;</span><span class="op" id="8178516">,</span>&nbsp;<span class="ident" id="8178518">addr</span><span class="op" id="8178522">:</span>&nbsp;<span class="string" id="8178524">&#34;[::1]&#34;</span><span class="op" id="8178531">}</span><span class="op" id="8178532">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8178535">}</span><span class="op" id="8178536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8178539">if</span>&nbsp;<span class="ident" id="8178542">err</span>&nbsp;<span class="op" id="8178546">!=</span>&nbsp;<span class="ident" id="8178549">nil</span>&nbsp;<span class="op" id="8178553">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8178557">t</span><span class="op" id="8178558">.</span><span class="ident" id="8178559">Fatalf</span><span class="op" id="8178565">(</span><span class="string" id="8178566">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8178597">,</span>&nbsp;<span class="ident" id="8178599">err</span><span class="op" id="8178602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8178605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8178608">defer</span>&nbsp;<span class="ident" id="8178614">dss</span><span class="op" id="8178617">.</span><span class="ident" id="8178618">teardown</span><span class="op" id="8178626">(</span><span class="op" id="8178627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8178630">if</span>&nbsp;<span class="ident" id="8178633">err</span>&nbsp;<span class="op" id="8178637">:=</span>&nbsp;<span class="ident" id="8178640">dss</span><span class="op" id="8178643">.</span><span class="ident" id="8178644">buildup</span><span class="op" id="8178651">(</span><span class="ident" id="8178652">halfDeadServer</span><span class="op" id="8178666">)</span><span class="op" id="8178667">;</span>&nbsp;<span class="ident" id="8178669">err</span>&nbsp;<span class="op" id="8178673">!=</span>&nbsp;<span class="ident" id="8178676">nil</span>&nbsp;<span class="op" id="8178680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8178684">t</span><span class="op" id="8178685">.</span><span class="ident" id="8178686">Fatalf</span><span class="op" id="8178692">(</span><span class="string" id="8178693">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8178729">,</span>&nbsp;<span class="ident" id="8178731">err</span><span class="op" id="8178734">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8178737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8178741">_</span><span class="op" id="8178742">,</span>&nbsp;<span class="ident" id="8178744">before</span><span class="op" id="8178750">,</span>&nbsp;<span class="ident" id="8178752">_</span><span class="op" id="8178753">,</span>&nbsp;<span class="ident" id="8178755">err</span>&nbsp;<span class="op" id="8178759">:=</span>&nbsp;<span class="ident" id="8178762">numTCP</span><span class="op" id="8178768">(</span><span class="op" id="8178769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8178772">if</span>&nbsp;<span class="ident" id="8178775">err</span>&nbsp;<span class="op" id="8178779">!=</span>&nbsp;<span class="ident" id="8178782">nil</span>&nbsp;<span class="op" id="8178786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8178790">t</span><span class="op" id="8178791">.</span><span class="ident" id="8178792">Skipf</span><span class="op" id="8178797">(</span><span class="string" id="8178798">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="8178848">,</span>&nbsp;<span class="ident" id="8178850">err</span><span class="op" id="8178853">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8178856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8178860">var</span>&nbsp;<span class="ident" id="8178864">wg</span>&nbsp;<span class="ident" id="8178867">sync</span><span class="op" id="8178871">.</span><span class="ident" id="8178872">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8178883">portnum</span><span class="op" id="8178890">,</span>&nbsp;<span class="ident" id="8178892">_</span><span class="op" id="8178893">,</span>&nbsp;<span class="ident" id="8178895">_</span>&nbsp;<span class="op" id="8178897">:=</span>&nbsp;<span class="ident" id="8178900">dtoi</span><span class="op" id="8178904">(</span><span class="ident" id="8178905">dss</span><span class="op" id="8178908">.</span><span class="ident" id="8178909">port</span><span class="op" id="8178913">,</span>&nbsp;<span class="num" id="8178915">0</span><span class="op" id="8178916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8178919">ras</span>&nbsp;<span class="op" id="8178923">:=</span>&nbsp;<span class="ident" id="8178926">addrList</span><span class="op" id="8178934">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8178938">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8178991">&amp;</span><span class="ident" id="8178992">TCPAddr</span><span class="op" id="8178999">{</span><span class="ident" id="8179000">IP</span><span class="op" id="8179002">:</span>&nbsp;<span class="ident" id="8179004">IPv4</span><span class="op" id="8179008">(</span><span class="num" id="8179009">198</span><span class="op" id="8179012">,</span>&nbsp;<span class="num" id="8179014">18</span><span class="op" id="8179016">,</span>&nbsp;<span class="num" id="8179018">0</span><span class="op" id="8179019">,</span>&nbsp;<span class="num" id="8179021">254</span><span class="op" id="8179024">)</span><span class="op" id="8179025">,</span>&nbsp;<span class="ident" id="8179027">Port</span><span class="op" id="8179031">:</span>&nbsp;<span class="ident" id="8179033">portnum</span><span class="op" id="8179040">}</span><span class="op" id="8179041">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8179045">&amp;</span><span class="ident" id="8179046">TCPAddr</span><span class="op" id="8179053">{</span><span class="ident" id="8179054">IP</span><span class="op" id="8179056">:</span>&nbsp;<span class="ident" id="8179058">ParseIP</span><span class="op" id="8179065">(</span><span class="string" id="8179066">&#34;2001:2::254&#34;</span><span class="op" id="8179079">)</span><span class="op" id="8179080">,</span>&nbsp;<span class="ident" id="8179082">Port</span><span class="op" id="8179086">:</span>&nbsp;<span class="ident" id="8179088">portnum</span><span class="op" id="8179095">}</span><span class="op" id="8179096">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8179101">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8179138">&amp;</span><span class="ident" id="8179139">TCPAddr</span><span class="op" id="8179146">{</span><span class="ident" id="8179147">IP</span><span class="op" id="8179149">:</span>&nbsp;<span class="ident" id="8179151">IPv4</span><span class="op" id="8179155">(</span><span class="num" id="8179156">127</span><span class="op" id="8179159">,</span>&nbsp;<span class="num" id="8179161">0</span><span class="op" id="8179162">,</span>&nbsp;<span class="num" id="8179164">0</span><span class="op" id="8179165">,</span>&nbsp;<span class="num" id="8179167">1</span><span class="op" id="8179168">)</span><span class="op" id="8179169">,</span>&nbsp;<span class="ident" id="8179171">Port</span><span class="op" id="8179175">:</span>&nbsp;<span class="ident" id="8179177">portnum</span><span class="op" id="8179184">}</span><span class="op" id="8179185">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8179189">&amp;</span><span class="ident" id="8179190">TCPAddr</span><span class="op" id="8179197">{</span><span class="ident" id="8179198">IP</span><span class="op" id="8179200">:</span>&nbsp;<span class="ident" id="8179202">IPv6loopback</span><span class="op" id="8179214">,</span>&nbsp;<span class="ident" id="8179216">Port</span><span class="op" id="8179220">:</span>&nbsp;<span class="ident" id="8179222">portnum</span><span class="op" id="8179229">}</span><span class="op" id="8179230">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8179235">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8179287">&amp;</span><span class="ident" id="8179288">TCPAddr</span><span class="op" id="8179295">{</span><span class="ident" id="8179296">IP</span><span class="op" id="8179298">:</span>&nbsp;<span class="ident" id="8179300">IPv4</span><span class="op" id="8179304">(</span><span class="num" id="8179305">127</span><span class="op" id="8179308">,</span>&nbsp;<span class="num" id="8179310">0</span><span class="op" id="8179311">,</span>&nbsp;<span class="num" id="8179313">0</span><span class="op" id="8179314">,</span>&nbsp;<span class="num" id="8179316">1</span><span class="op" id="8179317">)</span><span class="op" id="8179318">,</span>&nbsp;<span class="ident" id="8179320">Port</span><span class="op" id="8179324">:</span>&nbsp;<span class="ident" id="8179326">portnum</span><span class="op" id="8179333">}</span><span class="op" id="8179334">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8179338">&amp;</span><span class="ident" id="8179339">TCPAddr</span><span class="op" id="8179346">{</span><span class="ident" id="8179347">IP</span><span class="op" id="8179349">:</span>&nbsp;<span class="ident" id="8179351">IPv6loopback</span><span class="op" id="8179363">,</span>&nbsp;<span class="ident" id="8179365">Port</span><span class="op" id="8179369">:</span>&nbsp;<span class="ident" id="8179371">portnum</span><span class="op" id="8179378">}</span><span class="op" id="8179379">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8179382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8179385">const</span>&nbsp;<span class="ident" id="8179391">T1</span>&nbsp;<span class="op" id="8179394">=</span>&nbsp;<span class="num" id="8179396">10</span>&nbsp;<span class="op" id="8179399">*</span>&nbsp;<span class="ident" id="8179401">time</span><span class="op" id="8179405">.</span><span class="ident" id="8179406">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8179419">const</span>&nbsp;<span class="ident" id="8179425">T2</span>&nbsp;<span class="op" id="8179428">=</span>&nbsp;<span class="num" id="8179430">2</span>&nbsp;<span class="op" id="8179432">*</span>&nbsp;<span class="ident" id="8179434">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8179438">const</span>&nbsp;<span class="ident" id="8179444">N</span>&nbsp;<span class="op" id="8179446">=</span>&nbsp;<span class="num" id="8179448">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8179452">for</span>&nbsp;<span class="ident" id="8179456">i</span>&nbsp;<span class="op" id="8179458">:=</span>&nbsp;<span class="num" id="8179461">0</span><span class="op" id="8179462">;</span>&nbsp;<span class="ident" id="8179464">i</span>&nbsp;<span class="op" id="8179466">&lt;</span>&nbsp;<span class="ident" id="8179468">N</span><span class="op" id="8179469">;</span>&nbsp;<span class="ident" id="8179471">i</span><span class="op" id="8179472">++</span>&nbsp;<span class="op" id="8179475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8179479">wg</span><span class="op" id="8179481">.</span><span class="ident" id="8179482">Add</span><span class="op" id="8179485">(</span><span class="num" id="8179486">1</span><span class="op" id="8179487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8179491">go</span>&nbsp;<span class="keyword" id="8179494">func</span><span class="op" id="8179498">(</span><span class="op" id="8179499">)</span>&nbsp;<span class="op" id="8179501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8179506">defer</span>&nbsp;<span class="ident" id="8179512">wg</span><span class="op" id="8179514">.</span><span class="ident" id="8179515">Done</span><span class="op" id="8179519">(</span><span class="op" id="8179520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8179525">if</span>&nbsp;<span class="ident" id="8179528">c</span><span class="op" id="8179529">,</span>&nbsp;<span class="ident" id="8179531">err</span>&nbsp;<span class="op" id="8179535">:=</span>&nbsp;<span class="ident" id="8179538">dialMulti</span><span class="op" id="8179547">(</span><span class="string" id="8179548">&#34;tcp&#34;</span><span class="op" id="8179553">,</span>&nbsp;<span class="string" id="8179555">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="8179575">,</span>&nbsp;<span class="ident" id="8179577">nil</span><span class="op" id="8179580">,</span>&nbsp;<span class="ident" id="8179582">ras</span><span class="op" id="8179585">,</span>&nbsp;<span class="ident" id="8179587">time</span><span class="op" id="8179591">.</span><span class="ident" id="8179592">Now</span><span class="op" id="8179595">(</span><span class="op" id="8179596">)</span><span class="op" id="8179597">.</span><span class="ident" id="8179598">Add</span><span class="op" id="8179601">(</span><span class="ident" id="8179602">T1</span><span class="op" id="8179604">)</span><span class="op" id="8179605">)</span><span class="op" id="8179606">;</span>&nbsp;<span class="ident" id="8179608">err</span>&nbsp;<span class="op" id="8179612">==</span>&nbsp;<span class="ident" id="8179615">nil</span>&nbsp;<span class="op" id="8179619">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8179625">c</span><span class="op" id="8179626">.</span><span class="ident" id="8179627">Close</span><span class="op" id="8179632">(</span><span class="op" id="8179633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8179638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8179642">}</span><span class="op" id="8179643">(</span><span class="op" id="8179644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8179647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8179650">wg</span><span class="op" id="8179652">.</span><span class="ident" id="8179653">Wait</span><span class="op" id="8179657">(</span><span class="op" id="8179658">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8179661">time</span><span class="op" id="8179665">.</span><span class="ident" id="8179666">Sleep</span><span class="op" id="8179671">(</span><span class="ident" id="8179672">T2</span><span class="op" id="8179674">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8179678">ntcp</span><span class="op" id="8179682">,</span>&nbsp;<span class="ident" id="8179684">after</span><span class="op" id="8179689">,</span>&nbsp;<span class="ident" id="8179691">nclose</span><span class="op" id="8179697">,</span>&nbsp;<span class="ident" id="8179699">err</span>&nbsp;<span class="op" id="8179703">:=</span>&nbsp;<span class="ident" id="8179706">numTCP</span><span class="op" id="8179712">(</span><span class="op" id="8179713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8179716">if</span>&nbsp;<span class="ident" id="8179719">err</span>&nbsp;<span class="op" id="8179723">!=</span>&nbsp;<span class="ident" id="8179726">nil</span>&nbsp;<span class="op" id="8179730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8179734">t</span><span class="op" id="8179735">.</span><span class="ident" id="8179736">Skipf</span><span class="op" id="8179741">(</span><span class="string" id="8179742">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="8179792">,</span>&nbsp;<span class="ident" id="8179794">err</span><span class="op" id="8179797">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8179800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8179803">t</span><span class="op" id="8179804">.</span><span class="ident" id="8179805">Logf</span><span class="op" id="8179809">(</span><span class="string" id="8179810">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="8179869">,</span>&nbsp;<span class="ident" id="8179871">ntcp</span><span class="op" id="8179875">,</span>&nbsp;<span class="ident" id="8179877">after</span><span class="op" id="8179882">,</span>&nbsp;<span class="ident" id="8179884">nclose</span><span class="op" id="8179890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8179894">if</span>&nbsp;<span class="ident" id="8179897">after</span>&nbsp;<span class="op" id="8179903">!=</span>&nbsp;<span class="ident" id="8179906">before</span>&nbsp;<span class="op" id="8179913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8179917">t</span><span class="op" id="8179918">.</span><span class="ident" id="8179919">Fatalf</span><span class="op" id="8179925">(</span><span class="string" id="8179926">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="8179961">,</span>&nbsp;<span class="ident" id="8179963">after</span><span class="op" id="8179968">,</span>&nbsp;<span class="ident" id="8179970">before</span><span class="op" id="8179976">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8179979">}</span><br>
<span class="lineno"></span><span class="op" id="8179981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8179984">func</span>&nbsp;<span class="ident" id="8179989">numFD</span><span class="op" id="8179994">(</span><span class="op" id="8179995">)</span>&nbsp;<span class="builtintype" id="8179997">int</span>&nbsp;<span class="op" id="8180001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180004">if</span>&nbsp;<span class="ident" id="8180007">runtime</span><span class="op" id="8180014">.</span><span class="ident" id="8180015">GOOS</span>&nbsp;<span class="op" id="8180020">==</span>&nbsp;<span class="string" id="8180023">&#34;linux&#34;</span>&nbsp;<span class="op" id="8180031">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180035">f</span><span class="op" id="8180036">,</span>&nbsp;<span class="ident" id="8180038">err</span>&nbsp;<span class="op" id="8180042">:=</span>&nbsp;<span class="ident" id="8180045">os</span><span class="op" id="8180047">.</span><span class="ident" id="8180048">Open</span><span class="op" id="8180052">(</span><span class="string" id="8180053">&#34;/proc/self/fd&#34;</span><span class="op" id="8180068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180072">if</span>&nbsp;<span class="ident" id="8180075">err</span>&nbsp;<span class="op" id="8180079">!=</span>&nbsp;<span class="ident" id="8180082">nil</span>&nbsp;<span class="op" id="8180086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8180091">panic</span><span class="op" id="8180096">(</span><span class="ident" id="8180097">err</span><span class="op" id="8180100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8180104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180108">defer</span>&nbsp;<span class="ident" id="8180114">f</span><span class="op" id="8180115">.</span><span class="ident" id="8180116">Close</span><span class="op" id="8180121">(</span><span class="op" id="8180122">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180126">names</span><span class="op" id="8180131">,</span>&nbsp;<span class="ident" id="8180133">err</span>&nbsp;<span class="op" id="8180137">:=</span>&nbsp;<span class="ident" id="8180140">f</span><span class="op" id="8180141">.</span><span class="ident" id="8180142">Readdirnames</span><span class="op" id="8180154">(</span><span class="num" id="8180155">0</span><span class="op" id="8180156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180160">if</span>&nbsp;<span class="ident" id="8180163">err</span>&nbsp;<span class="op" id="8180167">!=</span>&nbsp;<span class="ident" id="8180170">nil</span>&nbsp;<span class="op" id="8180174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8180179">panic</span><span class="op" id="8180184">(</span><span class="ident" id="8180185">err</span><span class="op" id="8180188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8180192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180196">return</span>&nbsp;<span class="builtinfunc" id="8180203">len</span><span class="op" id="8180206">(</span><span class="ident" id="8180207">names</span><span class="op" id="8180212">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8180215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8180218">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8180274">panic</span><span class="op" id="8180279">(</span><span class="string" id="8180280">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="8180309">+</span>&nbsp;<span class="ident" id="8180311">runtime</span><span class="op" id="8180318">.</span><span class="ident" id="8180319">GOOS</span><span class="op" id="8180323">)</span><br>
<span class="lineno"></span><span class="op" id="8180325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="8180328">func</span>&nbsp;<span class="ident" id="8180333">TestDialer</span><span class="op" id="8180343">(</span><span class="ident" id="8180344">t</span>&nbsp;<span class="op" id="8180346">*</span><span class="ident" id="8180347">testing</span><span class="op" id="8180354">.</span><span class="ident" id="8180355">T</span><span class="op" id="8180356">)</span>&nbsp;<span class="op" id="8180358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180361">ln</span><span class="op" id="8180363">,</span>&nbsp;<span class="ident" id="8180365">err</span>&nbsp;<span class="op" id="8180369">:=</span>&nbsp;<span class="ident" id="8180372">Listen</span><span class="op" id="8180378">(</span><span class="string" id="8180379">&#34;tcp4&#34;</span><span class="op" id="8180385">,</span>&nbsp;<span class="string" id="8180387">&#34;127.0.0.1:0&#34;</span><span class="op" id="8180400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180403">if</span>&nbsp;<span class="ident" id="8180406">err</span>&nbsp;<span class="op" id="8180410">!=</span>&nbsp;<span class="ident" id="8180413">nil</span>&nbsp;<span class="op" id="8180417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180421">t</span><span class="op" id="8180422">.</span><span class="ident" id="8180423">Fatalf</span><span class="op" id="8180429">(</span><span class="string" id="8180430">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8180449">,</span>&nbsp;<span class="ident" id="8180451">err</span><span class="op" id="8180454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8180457">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180460">defer</span>&nbsp;<span class="ident" id="8180466">ln</span><span class="op" id="8180468">.</span><span class="ident" id="8180469">Close</span><span class="op" id="8180474">(</span><span class="op" id="8180475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180478">ch</span>&nbsp;<span class="op" id="8180481">:=</span>&nbsp;<span class="builtinfunc" id="8180484">make</span><span class="op" id="8180488">(</span><span class="keyword" id="8180489">chan</span>&nbsp;<span class="builtintype" id="8180494">error</span><span class="op" id="8180499">,</span>&nbsp;<span class="num" id="8180501">1</span><span class="op" id="8180502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180505">go</span>&nbsp;<span class="keyword" id="8180508">func</span><span class="op" id="8180512">(</span><span class="op" id="8180513">)</span>&nbsp;<span class="op" id="8180515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180519">c</span><span class="op" id="8180520">,</span>&nbsp;<span class="ident" id="8180522">err</span>&nbsp;<span class="op" id="8180526">:=</span>&nbsp;<span class="ident" id="8180529">ln</span><span class="op" id="8180531">.</span><span class="ident" id="8180532">Accept</span><span class="op" id="8180538">(</span><span class="op" id="8180539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180543">if</span>&nbsp;<span class="ident" id="8180546">err</span>&nbsp;<span class="op" id="8180550">!=</span>&nbsp;<span class="ident" id="8180553">nil</span>&nbsp;<span class="op" id="8180557">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180562">ch</span>&nbsp;<span class="op" id="8180565">&lt;-</span>&nbsp;<span class="ident" id="8180568">fmt</span><span class="op" id="8180571">.</span><span class="ident" id="8180572">Errorf</span><span class="op" id="8180578">(</span><span class="string" id="8180579">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8180598">,</span>&nbsp;<span class="ident" id="8180600">err</span><span class="op" id="8180603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180608">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8180617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180621">defer</span>&nbsp;<span class="ident" id="8180627">c</span><span class="op" id="8180628">.</span><span class="ident" id="8180629">Close</span><span class="op" id="8180634">(</span><span class="op" id="8180635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180639">ch</span>&nbsp;<span class="op" id="8180642">&lt;-</span>&nbsp;<span class="ident" id="8180645">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8180650">}</span><span class="op" id="8180651">(</span><span class="op" id="8180652">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180656">laddr</span><span class="op" id="8180661">,</span>&nbsp;<span class="ident" id="8180663">err</span>&nbsp;<span class="op" id="8180667">:=</span>&nbsp;<span class="ident" id="8180670">ResolveTCPAddr</span><span class="op" id="8180684">(</span><span class="string" id="8180685">&#34;tcp4&#34;</span><span class="op" id="8180691">,</span>&nbsp;<span class="string" id="8180693">&#34;127.0.0.1:0&#34;</span><span class="op" id="8180706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180709">if</span>&nbsp;<span class="ident" id="8180712">err</span>&nbsp;<span class="op" id="8180716">!=</span>&nbsp;<span class="ident" id="8180719">nil</span>&nbsp;<span class="op" id="8180723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180727">t</span><span class="op" id="8180728">.</span><span class="ident" id="8180729">Fatalf</span><span class="op" id="8180735">(</span><span class="string" id="8180736">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8180763">,</span>&nbsp;<span class="ident" id="8180765">err</span><span class="op" id="8180768">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8180771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180774">d</span>&nbsp;<span class="op" id="8180776">:=</span>&nbsp;<span class="op" id="8180779">&amp;</span><span class="ident" id="8180780">Dialer</span><span class="op" id="8180786">{</span><span class="ident" id="8180787">LocalAddr</span><span class="op" id="8180796">:</span>&nbsp;<span class="ident" id="8180798">laddr</span><span class="op" id="8180803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180806">c</span><span class="op" id="8180807">,</span>&nbsp;<span class="ident" id="8180809">err</span>&nbsp;<span class="op" id="8180813">:=</span>&nbsp;<span class="ident" id="8180816">d</span><span class="op" id="8180817">.</span><span class="ident" id="8180818">Dial</span><span class="op" id="8180822">(</span><span class="string" id="8180823">&#34;tcp4&#34;</span><span class="op" id="8180829">,</span>&nbsp;<span class="ident" id="8180831">ln</span><span class="op" id="8180833">.</span><span class="ident" id="8180834">Addr</span><span class="op" id="8180838">(</span><span class="op" id="8180839">)</span><span class="op" id="8180840">.</span><span class="ident" id="8180841">String</span><span class="op" id="8180847">(</span><span class="op" id="8180848">)</span><span class="op" id="8180849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180852">if</span>&nbsp;<span class="ident" id="8180855">err</span>&nbsp;<span class="op" id="8180859">!=</span>&nbsp;<span class="ident" id="8180862">nil</span>&nbsp;<span class="op" id="8180866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180870">t</span><span class="op" id="8180871">.</span><span class="ident" id="8180872">Fatalf</span><span class="op" id="8180878">(</span><span class="string" id="8180879">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8180896">,</span>&nbsp;<span class="ident" id="8180898">err</span><span class="op" id="8180901">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8180904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180907">defer</span>&nbsp;<span class="ident" id="8180913">c</span><span class="op" id="8180914">.</span><span class="ident" id="8180915">Close</span><span class="op" id="8180920">(</span><span class="op" id="8180921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180924">c</span><span class="op" id="8180925">.</span><span class="ident" id="8180926">Read</span><span class="op" id="8180930">(</span><span class="builtinfunc" id="8180931">make</span><span class="op" id="8180935">(</span><span class="op" id="8180936">[</span><span class="op" id="8180937">]</span><span class="builtintype" id="8180938">byte</span><span class="op" id="8180942">,</span>&nbsp;<span class="num" id="8180944">1</span><span class="op" id="8180945">)</span><span class="op" id="8180946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180949">err</span>&nbsp;<span class="op" id="8180953">=</span>&nbsp;<span class="op" id="8180955">&lt;-</span><span class="ident" id="8180957">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8180961">if</span>&nbsp;<span class="ident" id="8180964">err</span>&nbsp;<span class="op" id="8180968">!=</span>&nbsp;<span class="ident" id="8180971">nil</span>&nbsp;<span class="op" id="8180975">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8180979">t</span><span class="op" id="8180980">.</span><span class="ident" id="8180981">Error</span><span class="op" id="8180986">(</span><span class="ident" id="8180987">err</span><span class="op" id="8180990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8180993">}</span><br>
<span class="lineno"></span><span class="op" id="8180995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8180998">func</span>&nbsp;<span class="ident" id="8181003">TestDialDualStackLocalhost</span><span class="op" id="8181029">(</span><span class="ident" id="8181030">t</span>&nbsp;<span class="op" id="8181032">*</span><span class="ident" id="8181033">testing</span><span class="op" id="8181040">.</span><span class="ident" id="8181041">T</span><span class="op" id="8181042">)</span>&nbsp;<span class="op" id="8181044">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8181047">switch</span>&nbsp;<span class="ident" id="8181054">runtime</span><span class="op" id="8181061">.</span><span class="ident" id="8181062">GOOS</span>&nbsp;<span class="op" id="8181067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8181070">case</span>&nbsp;<span class="string" id="8181075">&#34;nacl&#34;</span><span class="op" id="8181081">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8181085">t</span><span class="op" id="8181086">.</span><span class="ident" id="8181087">Skipf</span><span class="op" id="8181092">(</span><span class="string" id="8181093">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="8181114">,</span>&nbsp;<span class="ident" id="8181116">runtime</span><span class="op" id="8181123">.</span><span class="ident" id="8181124">GOOS</span><span class="op" id="8181128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8181131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8181135">if</span>&nbsp;<span class="ident" id="8181138">ips</span><span class="op" id="8181141">,</span>&nbsp;<span class="ident" id="8181143">err</span>&nbsp;<span class="op" id="8181147">:=</span>&nbsp;<span class="ident" id="8181150">LookupIP</span><span class="op" id="8181158">(</span><span class="string" id="8181159">&#34;localhost&#34;</span><span class="op" id="8181170">)</span><span class="op" id="8181171">;</span>&nbsp;<span class="ident" id="8181173">err</span>&nbsp;<span class="op" id="8181177">!=</span>&nbsp;<span class="ident" id="8181180">nil</span>&nbsp;<span class="op" id="8181184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8181188">t</span><span class="op" id="8181189">.</span><span class="ident" id="8181190">Fatalf</span><span class="op" id="8181196">(</span><span class="string" id="8181197">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8181218">,</span>&nbsp;<span class="ident" id="8181220">err</span><span class="op" id="8181223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8181226">}</span>&nbsp;<span class="keyword" id="8181228">else</span>&nbsp;<span class="keyword" id="8181233">if</span>&nbsp;<span class="builtinfunc" id="8181236">len</span><span class="op" id="8181239">(</span><span class="ident" id="8181240">ips</span><span class="op" id="8181243">)</span>&nbsp;<span class="op" id="8181245">&lt;</span>&nbsp;<span class="num" id="8181247">2</span>&nbsp;<span class="op" id="8181249">||</span>&nbsp;<span class="op" id="8181252">!</span><span class="ident" id="8181253">supportsIPv4</span>&nbsp;<span class="op" id="8181266">||</span>&nbsp;<span class="op" id="8181269">!</span><span class="ident" id="8181270">supportsIPv6</span>&nbsp;<span class="op" id="8181283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8181287">t</span><span class="op" id="8181288">.</span><span class="ident" id="8181289">Skip</span><span class="op" id="8181293">(</span><span class="string" id="8181294">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="8181366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8181369">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8181373">touchAndByeServer</span>&nbsp;<span class="op" id="8181391">:=</span>&nbsp;<span class="keyword" id="8181394">func</span><span class="op" id="8181398">(</span><span class="ident" id="8181399">dss</span>&nbsp;<span class="op" id="8181403">*</span><span class="ident" id="8181404">dualStackServer</span><span class="op" id="8181419">,</span>&nbsp;<span class="ident" id="8181421">ln</span>&nbsp;<span class="ident" id="8181424">Listener</span><span class="op" id="8181432">)</span>&nbsp;<span class="op" id="8181434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8181438">for</span>&nbsp;<span class="op" id="8181442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8181447">if</span>&nbsp;<span class="ident" id="8181450">c</span><span class="op" id="8181451">,</span>&nbsp;<span class="ident" id="8181453">err</span>&nbsp;<span class="op" id="8181457">:=</span>&nbsp;<span class="ident" id="8181460">ln</span><span class="op" id="8181462">.</span><span class="ident" id="8181463">Accept</span><span class="op" id="8181469">(</span><span class="op" id="8181470">)</span><span class="op" id="8181471">;</span>&nbsp;<span class="ident" id="8181473">err</span>&nbsp;<span class="op" id="8181477">!=</span>&nbsp;<span class="ident" id="8181480">nil</span>&nbsp;<span class="op" id="8181484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8181490">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8181500">}</span>&nbsp;<span class="keyword" id="8181502">else</span>&nbsp;<span class="op" id="8181507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8181513">c</span><span class="op" id="8181514">.</span><span class="ident" id="8181515">Close</span><span class="op" id="8181520">(</span><span class="op" id="8181521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8181526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8181530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8181533">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8181536">dss</span><span class="op" id="8181539">,</span>&nbsp;<span class="ident" id="8181541">err</span>&nbsp;<span class="op" id="8181545">:=</span>&nbsp;<span class="ident" id="8181548">newDualStackServer</span><span class="op" id="8181566">(</span><span class="op" id="8181567">[</span><span class="op" id="8181568">]</span><span class="ident" id="8181569">streamListener</span><span class="op" id="8181583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8181587">{</span><span class="ident" id="8181588">net</span><span class="op" id="8181591">:</span>&nbsp;<span class="string" id="8181593">&#34;tcp4&#34;</span><span class="op" id="8181599">,</span>&nbsp;<span class="ident" id="8181601">addr</span><span class="op" id="8181605">:</span>&nbsp;<span class="string" id="8181607">&#34;127.0.0.1&#34;</span><span class="op" id="8181618">}</span><span class="op" id="8181619">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8181623">{</span><span class="ident" id="8181624">net</span><span class="op" id="8181627">:</span>&nbsp;<span class="string" id="8181629">&#34;tcp6&#34;</span><span class="op" id="8181635">,</span>&nbsp;<span class="ident" id="8181637">addr</span><span class="op" id="8181641">:</span>&nbsp;<span class="string" id="8181643">&#34;[::1]&#34;</span><span class="op" id="8181650">}</span><span class="op" id="8181651">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8181654">}</span><span class="op" id="8181655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8181658">if</span>&nbsp;<span class="ident" id="8181661">err</span>&nbsp;<span class="op" id="8181665">!=</span>&nbsp;<span class="ident" id="8181668">nil</span>&nbsp;<span class="op" id="8181672">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8181676">t</span><span class="op" id="8181677">.</span><span class="ident" id="8181678">Fatalf</span><span class="op" id="8181684">(</span><span class="string" id="8181685">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8181716">,</span>&nbsp;<span class="ident" id="8181718">err</span><span class="op" id="8181721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8181724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8181727">defer</span>&nbsp;<span class="ident" id="8181733">dss</span><span class="op" id="8181736">.</span><span class="ident" id="8181737">teardown</span><span class="op" id="8181745">(</span><span class="op" id="8181746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8181749">if</span>&nbsp;<span class="ident" id="8181752">err</span>&nbsp;<span class="op" id="8181756">:=</span>&nbsp;<span class="ident" id="8181759">dss</span><span class="op" id="8181762">.</span><span class="ident" id="8181763">buildup</span><span class="op" id="8181770">(</span><span class="ident" id="8181771">touchAndByeServer</span><span class="op" id="8181788">)</span><span class="op" id="8181789">;</span>&nbsp;<span class="ident" id="8181791">err</span>&nbsp;<span class="op" id="8181795">!=</span>&nbsp;<span class="ident" id="8181798">nil</span>&nbsp;<span class="op" id="8181802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8181806">t</span><span class="op" id="8181807">.</span><span class="ident" id="8181808">Fatalf</span><span class="op" id="8181814">(</span><span class="string" id="8181815">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8181851">,</span>&nbsp;<span class="ident" id="8181853">err</span><span class="op" id="8181856">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8181859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8181863">d</span>&nbsp;<span class="op" id="8181865">:=</span>&nbsp;<span class="op" id="8181868">&amp;</span><span class="ident" id="8181869">Dialer</span><span class="op" id="8181875">{</span><span class="ident" id="8181876">DualStack</span><span class="op" id="8181885">:</span>&nbsp;<span class="builtintype" id="8181887">true</span><span class="op" id="8181891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8181894">for</span>&nbsp;<span class="keyword" id="8181898">range</span>&nbsp;<span class="ident" id="8181904">dss</span><span class="op" id="8181907">.</span><span class="ident" id="8181908">lns</span>&nbsp;<span class="op" id="8181912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8181916">if</span>&nbsp;<span class="ident" id="8181919">c</span><span class="op" id="8181920">,</span>&nbsp;<span class="ident" id="8181922">err</span>&nbsp;<span class="op" id="8181926">:=</span>&nbsp;<span class="ident" id="8181929">d</span><span class="op" id="8181930">.</span><span class="ident" id="8181931">Dial</span><span class="op" id="8181935">(</span><span class="string" id="8181936">&#34;tcp&#34;</span><span class="op" id="8181941">,</span>&nbsp;<span class="string" id="8181943">&#34;localhost:&#34;</span><span class="op" id="8181955">+</span><span class="ident" id="8181956">dss</span><span class="op" id="8181959">.</span><span class="ident" id="8181960">port</span><span class="op" id="8181964">)</span><span class="op" id="8181965">;</span>&nbsp;<span class="ident" id="8181967">err</span>&nbsp;<span class="op" id="8181971">!=</span>&nbsp;<span class="ident" id="8181974">nil</span>&nbsp;<span class="op" id="8181978">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8181983">t</span><span class="op" id="8181984">.</span><span class="ident" id="8181985">Errorf</span><span class="op" id="8181991">(</span><span class="string" id="8181992">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8182009">,</span>&nbsp;<span class="ident" id="8182011">err</span><span class="op" id="8182014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182018">}</span>&nbsp;<span class="keyword" id="8182020">else</span>&nbsp;<span class="op" id="8182025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8182030">if</span>&nbsp;<span class="ident" id="8182033">addr</span>&nbsp;<span class="op" id="8182038">:=</span>&nbsp;<span class="ident" id="8182041">c</span><span class="op" id="8182042">.</span><span class="ident" id="8182043">LocalAddr</span><span class="op" id="8182052">(</span><span class="op" id="8182053">)</span><span class="op" id="8182054">.</span><span class="op" id="8182055">(</span><span class="op" id="8182056">*</span><span class="ident" id="8182057">TCPAddr</span><span class="op" id="8182064">)</span><span class="op" id="8182065">;</span>&nbsp;<span class="ident" id="8182067">addr</span><span class="op" id="8182071">.</span><span class="ident" id="8182072">IP</span><span class="op" id="8182074">.</span><span class="ident" id="8182075">To4</span><span class="op" id="8182078">(</span><span class="op" id="8182079">)</span>&nbsp;<span class="op" id="8182081">!=</span>&nbsp;<span class="ident" id="8182084">nil</span>&nbsp;<span class="op" id="8182088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182094">dss</span><span class="op" id="8182097">.</span><span class="ident" id="8182098">teardownNetwork</span><span class="op" id="8182113">(</span><span class="string" id="8182114">&#34;tcp4&#34;</span><span class="op" id="8182120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182125">}</span>&nbsp;<span class="keyword" id="8182127">else</span>&nbsp;<span class="keyword" id="8182132">if</span>&nbsp;<span class="ident" id="8182135">addr</span><span class="op" id="8182139">.</span><span class="ident" id="8182140">IP</span><span class="op" id="8182142">.</span><span class="ident" id="8182143">To16</span><span class="op" id="8182147">(</span><span class="op" id="8182148">)</span>&nbsp;<span class="op" id="8182150">!=</span>&nbsp;<span class="ident" id="8182153">nil</span>&nbsp;<span class="op" id="8182157">&amp;&amp;</span>&nbsp;<span class="ident" id="8182160">addr</span><span class="op" id="8182164">.</span><span class="ident" id="8182165">IP</span><span class="op" id="8182167">.</span><span class="ident" id="8182168">To4</span><span class="op" id="8182171">(</span><span class="op" id="8182172">)</span>&nbsp;<span class="op" id="8182174">==</span>&nbsp;<span class="ident" id="8182177">nil</span>&nbsp;<span class="op" id="8182181">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182187">dss</span><span class="op" id="8182190">.</span><span class="ident" id="8182191">teardownNetwork</span><span class="op" id="8182206">(</span><span class="string" id="8182207">&#34;tcp6&#34;</span><span class="op" id="8182213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182223">c</span><span class="op" id="8182224">.</span><span class="ident" id="8182225">Close</span><span class="op" id="8182230">(</span><span class="op" id="8182231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182238">}</span><br>
<span class="lineno">515</span><span class="op" id="8182240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8182243">func</span>&nbsp;<span class="ident" id="8182248">TestDialerKeepAlive</span><span class="op" id="8182267">(</span><span class="ident" id="8182268">t</span>&nbsp;<span class="op" id="8182270">*</span><span class="ident" id="8182271">testing</span><span class="op" id="8182278">.</span><span class="ident" id="8182279">T</span><span class="op" id="8182280">)</span>&nbsp;<span class="op" id="8182282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182285">ln</span>&nbsp;<span class="op" id="8182288">:=</span>&nbsp;<span class="ident" id="8182291">newLocalListener</span><span class="op" id="8182307">(</span><span class="ident" id="8182308">t</span><span class="op" id="8182309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8182312">defer</span>&nbsp;<span class="ident" id="8182318">ln</span><span class="op" id="8182320">.</span><span class="ident" id="8182321">Close</span><span class="op" id="8182326">(</span><span class="op" id="8182327">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8182330">defer</span>&nbsp;<span class="keyword" id="8182336">func</span><span class="op" id="8182340">(</span><span class="op" id="8182341">)</span>&nbsp;<span class="op" id="8182343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182347">testHookSetKeepAlive</span>&nbsp;<span class="op" id="8182368">=</span>&nbsp;<span class="keyword" id="8182370">func</span><span class="op" id="8182374">(</span><span class="op" id="8182375">)</span>&nbsp;<span class="op" id="8182377">{</span><span class="op" id="8182378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182381">}</span><span class="op" id="8182382">(</span><span class="op" id="8182383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8182386">go</span>&nbsp;<span class="keyword" id="8182389">func</span><span class="op" id="8182393">(</span><span class="op" id="8182394">)</span>&nbsp;<span class="op" id="8182396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8182400">for</span>&nbsp;<span class="op" id="8182404">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182409">c</span><span class="op" id="8182410">,</span>&nbsp;<span class="ident" id="8182412">err</span>&nbsp;<span class="op" id="8182416">:=</span>&nbsp;<span class="ident" id="8182419">ln</span><span class="op" id="8182421">.</span><span class="ident" id="8182422">Accept</span><span class="op" id="8182428">(</span><span class="op" id="8182429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8182434">if</span>&nbsp;<span class="ident" id="8182437">err</span>&nbsp;<span class="op" id="8182441">!=</span>&nbsp;<span class="ident" id="8182444">nil</span>&nbsp;<span class="op" id="8182448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8182454">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182469">c</span><span class="op" id="8182470">.</span><span class="ident" id="8182471">Close</span><span class="op" id="8182476">(</span><span class="op" id="8182477">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182484">}</span><span class="op" id="8182485">(</span><span class="op" id="8182486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8182489">for</span>&nbsp;<span class="ident" id="8182493">_</span><span class="op" id="8182494">,</span>&nbsp;<span class="ident" id="8182496">keepAlive</span>&nbsp;<span class="op" id="8182506">:=</span>&nbsp;<span class="keyword" id="8182509">range</span>&nbsp;<span class="op" id="8182515">[</span><span class="op" id="8182516">]</span><span class="builtintype" id="8182517">bool</span><span class="op" id="8182521">{</span><span class="builtintype" id="8182522">false</span><span class="op" id="8182527">,</span>&nbsp;<span class="builtintype" id="8182529">true</span><span class="op" id="8182533">}</span>&nbsp;<span class="op" id="8182535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182539">got</span>&nbsp;<span class="op" id="8182543">:=</span>&nbsp;<span class="builtintype" id="8182546">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182554">testHookSetKeepAlive</span>&nbsp;<span class="op" id="8182575">=</span>&nbsp;<span class="keyword" id="8182577">func</span><span class="op" id="8182581">(</span><span class="op" id="8182582">)</span>&nbsp;<span class="op" id="8182584">{</span>&nbsp;<span class="ident" id="8182586">got</span>&nbsp;<span class="op" id="8182590">=</span>&nbsp;<span class="builtintype" id="8182592">true</span>&nbsp;<span class="op" id="8182597">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8182601">var</span>&nbsp;<span class="ident" id="8182605">d</span>&nbsp;<span class="ident" id="8182607">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8182616">if</span>&nbsp;<span class="ident" id="8182619">keepAlive</span>&nbsp;<span class="op" id="8182629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182634">d</span><span class="op" id="8182635">.</span><span class="ident" id="8182636">KeepAlive</span>&nbsp;<span class="op" id="8182646">=</span>&nbsp;<span class="num" id="8182648">30</span>&nbsp;<span class="op" id="8182651">*</span>&nbsp;<span class="ident" id="8182653">time</span><span class="op" id="8182657">.</span><span class="ident" id="8182658">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182671">c</span><span class="op" id="8182672">,</span>&nbsp;<span class="ident" id="8182674">err</span>&nbsp;<span class="op" id="8182678">:=</span>&nbsp;<span class="ident" id="8182681">d</span><span class="op" id="8182682">.</span><span class="ident" id="8182683">Dial</span><span class="op" id="8182687">(</span><span class="string" id="8182688">&#34;tcp&#34;</span><span class="op" id="8182693">,</span>&nbsp;<span class="ident" id="8182695">ln</span><span class="op" id="8182697">.</span><span class="ident" id="8182698">Addr</span><span class="op" id="8182702">(</span><span class="op" id="8182703">)</span><span class="op" id="8182704">.</span><span class="ident" id="8182705">String</span><span class="op" id="8182711">(</span><span class="op" id="8182712">)</span><span class="op" id="8182713">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8182717">if</span>&nbsp;<span class="ident" id="8182720">err</span>&nbsp;<span class="op" id="8182724">!=</span>&nbsp;<span class="ident" id="8182727">nil</span>&nbsp;<span class="op" id="8182731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182736">t</span><span class="op" id="8182737">.</span><span class="ident" id="8182738">Fatal</span><span class="op" id="8182743">(</span><span class="ident" id="8182744">err</span><span class="op" id="8182747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182755">c</span><span class="op" id="8182756">.</span><span class="ident" id="8182757">Close</span><span class="op" id="8182762">(</span><span class="op" id="8182763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8182767">if</span>&nbsp;<span class="ident" id="8182770">got</span>&nbsp;<span class="op" id="8182774">!=</span>&nbsp;<span class="ident" id="8182777">keepAlive</span>&nbsp;<span class="op" id="8182787">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8182792">t</span><span class="op" id="8182793">.</span><span class="ident" id="8182794">Errorf</span><span class="op" id="8182800">(</span><span class="string" id="8182801">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8182859">,</span>&nbsp;<span class="ident" id="8182861">d</span><span class="op" id="8182862">.</span><span class="ident" id="8182863">KeepAlive</span><span class="op" id="8182872">,</span>&nbsp;<span class="ident" id="8182874">got</span><span class="op" id="8182877">,</span>&nbsp;<span class="op" id="8182879">!</span><span class="ident" id="8182880">got</span><span class="op" id="8182883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8182890">}</span><br>
<span class="lineno"></span><span class="op" id="8182892">}</span>
</div>
</body>
</html>
