<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>os/signal</h2>
<ul>
<li><a href="/gostd/os/signal/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/os/signal/signal.go.html">signal.go</a></li>
<li><a href="/gostd/os/signal/signal_test.go.html">signal_test.go</a></li>
<li><a href="/gostd/os/signal/signal_unix.go.html">signal_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7381393">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7381448">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7381502">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7381553">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7381618">package</span>&nbsp;<span class="ident" id="7381626">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7381634">import</span>&nbsp;<span class="op" id="7381641">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7381644">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7381652">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7381665">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7381671">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7381682">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7381693">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7381704">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7381715">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7381726">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7381733">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7381736">func</span>&nbsp;<span class="ident" id="7381741">waitSig</span><span class="op" id="7381748">(</span><span class="ident" id="7381749">t</span>&nbsp;<span class="op" id="7381751">*</span><span class="ident" id="7381752">testing</span><span class="op" id="7381759">.</span><span class="ident" id="7381760">T</span><span class="op" id="7381761">,</span>&nbsp;<span class="ident" id="7381763">c</span>&nbsp;<span class="op" id="7381765">&lt;-</span><span class="keyword" id="7381767">chan</span>&nbsp;<span class="ident" id="7381772">os</span><span class="op" id="7381774">.</span><span class="ident" id="7381775">Signal</span><span class="op" id="7381781">,</span>&nbsp;<span class="ident" id="7381783">sig</span>&nbsp;<span class="ident" id="7381787">os</span><span class="op" id="7381789">.</span><span class="ident" id="7381790">Signal</span><span class="op" id="7381796">)</span>&nbsp;<span class="op" id="7381798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7381801">select</span>&nbsp;<span class="op" id="7381808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7381811">case</span>&nbsp;<span class="ident" id="7381816">s</span>&nbsp;<span class="op" id="7381818">:=</span>&nbsp;<span class="op" id="7381821">&lt;-</span><span class="ident" id="7381823">c</span><span class="op" id="7381824">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7381828">if</span>&nbsp;<span class="ident" id="7381831">s</span>&nbsp;<span class="op" id="7381833">!=</span>&nbsp;<span class="ident" id="7381836">sig</span>&nbsp;<span class="op" id="7381840">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7381845">t</span><span class="op" id="7381846">.</span><span class="ident" id="7381847">Fatalf</span><span class="op" id="7381853">(</span><span class="string" id="7381854">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7381878">,</span>&nbsp;<span class="ident" id="7381880">s</span><span class="op" id="7381881">,</span>&nbsp;<span class="ident" id="7381883">sig</span><span class="op" id="7381886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7381890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7381893">case</span>&nbsp;<span class="op" id="7381898">&lt;-</span><span class="ident" id="7381900">time</span><span class="op" id="7381904">.</span><span class="ident" id="7381905">After</span><span class="op" id="7381910">(</span><span class="num" id="7381911">1</span>&nbsp;<span class="op" id="7381913">*</span>&nbsp;<span class="ident" id="7381915">time</span><span class="op" id="7381919">.</span><span class="ident" id="7381920">Second</span><span class="op" id="7381926">)</span><span class="op" id="7381927">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7381931">t</span><span class="op" id="7381932">.</span><span class="ident" id="7381933">Fatalf</span><span class="op" id="7381939">(</span><span class="string" id="7381940">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="7381964">,</span>&nbsp;<span class="ident" id="7381966">sig</span><span class="op" id="7381969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7381972">}</span><br>
<span class="lineno">30</span><span class="op" id="7381974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7381977">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="7382019">func</span>&nbsp;<span class="ident" id="7382024">TestSignal</span><span class="op" id="7382034">(</span><span class="ident" id="7382035">t</span>&nbsp;<span class="op" id="7382037">*</span><span class="ident" id="7382038">testing</span><span class="op" id="7382045">.</span><span class="ident" id="7382046">T</span><span class="op" id="7382047">)</span>&nbsp;<span class="op" id="7382049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7382052">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382071">c</span>&nbsp;<span class="op" id="7382073">:=</span>&nbsp;<span class="builtinfunc" id="7382076">make</span><span class="op" id="7382080">(</span><span class="keyword" id="7382081">chan</span>&nbsp;<span class="ident" id="7382086">os</span><span class="op" id="7382088">.</span><span class="ident" id="7382089">Signal</span><span class="op" id="7382095">,</span>&nbsp;<span class="num" id="7382097">1</span><span class="op" id="7382098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382101">Notify</span><span class="op" id="7382107">(</span><span class="ident" id="7382108">c</span><span class="op" id="7382109">,</span>&nbsp;<span class="ident" id="7382111">syscall</span><span class="op" id="7382118">.</span><span class="ident" id="7382119">SIGHUP</span><span class="op" id="7382125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7382128">defer</span>&nbsp;<span class="ident" id="7382134">Stop</span><span class="op" id="7382138">(</span><span class="ident" id="7382139">c</span><span class="op" id="7382140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7382144">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382175">t</span><span class="op" id="7382176">.</span><span class="ident" id="7382177">Logf</span><span class="op" id="7382181">(</span><span class="string" id="7382182">&#34;sighup...&#34;</span><span class="op" id="7382193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382196">syscall</span><span class="op" id="7382203">.</span><span class="ident" id="7382204">Kill</span><span class="op" id="7382208">(</span><span class="ident" id="7382209">syscall</span><span class="op" id="7382216">.</span><span class="ident" id="7382217">Getpid</span><span class="op" id="7382223">(</span><span class="op" id="7382224">)</span><span class="op" id="7382225">,</span>&nbsp;<span class="ident" id="7382227">syscall</span><span class="op" id="7382234">.</span><span class="ident" id="7382235">SIGHUP</span><span class="op" id="7382241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382244">waitSig</span><span class="op" id="7382251">(</span><span class="ident" id="7382252">t</span><span class="op" id="7382253">,</span>&nbsp;<span class="ident" id="7382255">c</span><span class="op" id="7382256">,</span>&nbsp;<span class="ident" id="7382258">syscall</span><span class="op" id="7382265">.</span><span class="ident" id="7382266">SIGHUP</span><span class="op" id="7382272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7382276">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382311">c1</span>&nbsp;<span class="op" id="7382314">:=</span>&nbsp;<span class="builtinfunc" id="7382317">make</span><span class="op" id="7382321">(</span><span class="keyword" id="7382322">chan</span>&nbsp;<span class="ident" id="7382327">os</span><span class="op" id="7382329">.</span><span class="ident" id="7382330">Signal</span><span class="op" id="7382336">,</span>&nbsp;<span class="num" id="7382338">1</span><span class="op" id="7382339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382342">Notify</span><span class="op" id="7382348">(</span><span class="ident" id="7382349">c1</span><span class="op" id="7382351">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7382355">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382388">t</span><span class="op" id="7382389">.</span><span class="ident" id="7382390">Logf</span><span class="op" id="7382394">(</span><span class="string" id="7382395">&#34;sigwinch...&#34;</span><span class="op" id="7382408">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382411">syscall</span><span class="op" id="7382418">.</span><span class="ident" id="7382419">Kill</span><span class="op" id="7382423">(</span><span class="ident" id="7382424">syscall</span><span class="op" id="7382431">.</span><span class="ident" id="7382432">Getpid</span><span class="op" id="7382438">(</span><span class="op" id="7382439">)</span><span class="op" id="7382440">,</span>&nbsp;<span class="ident" id="7382442">syscall</span><span class="op" id="7382449">.</span><span class="ident" id="7382450">SIGWINCH</span><span class="op" id="7382458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382461">waitSig</span><span class="op" id="7382468">(</span><span class="ident" id="7382469">t</span><span class="op" id="7382470">,</span>&nbsp;<span class="ident" id="7382472">c1</span><span class="op" id="7382474">,</span>&nbsp;<span class="ident" id="7382476">syscall</span><span class="op" id="7382483">.</span><span class="ident" id="7382484">SIGWINCH</span><span class="op" id="7382492">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7382496">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7382541">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7382591">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382629">t</span><span class="op" id="7382630">.</span><span class="ident" id="7382631">Logf</span><span class="op" id="7382635">(</span><span class="string" id="7382636">&#34;sighup...&#34;</span><span class="op" id="7382647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382650">syscall</span><span class="op" id="7382657">.</span><span class="ident" id="7382658">Kill</span><span class="op" id="7382662">(</span><span class="ident" id="7382663">syscall</span><span class="op" id="7382670">.</span><span class="ident" id="7382671">Getpid</span><span class="op" id="7382677">(</span><span class="op" id="7382678">)</span><span class="op" id="7382679">,</span>&nbsp;<span class="ident" id="7382681">syscall</span><span class="op" id="7382688">.</span><span class="ident" id="7382689">SIGHUP</span><span class="op" id="7382695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382698">waitSig</span><span class="op" id="7382705">(</span><span class="ident" id="7382706">t</span><span class="op" id="7382707">,</span>&nbsp;<span class="ident" id="7382709">c1</span><span class="op" id="7382711">,</span>&nbsp;<span class="ident" id="7382713">syscall</span><span class="op" id="7382720">.</span><span class="ident" id="7382721">SIGHUP</span><span class="op" id="7382727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382730">t</span><span class="op" id="7382731">.</span><span class="ident" id="7382732">Logf</span><span class="op" id="7382736">(</span><span class="string" id="7382737">&#34;sighup...&#34;</span><span class="op" id="7382748">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382751">syscall</span><span class="op" id="7382758">.</span><span class="ident" id="7382759">Kill</span><span class="op" id="7382763">(</span><span class="ident" id="7382764">syscall</span><span class="op" id="7382771">.</span><span class="ident" id="7382772">Getpid</span><span class="op" id="7382778">(</span><span class="op" id="7382779">)</span><span class="op" id="7382780">,</span>&nbsp;<span class="ident" id="7382782">syscall</span><span class="op" id="7382789">.</span><span class="ident" id="7382790">SIGHUP</span><span class="op" id="7382796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382799">waitSig</span><span class="op" id="7382806">(</span><span class="ident" id="7382807">t</span><span class="op" id="7382808">,</span>&nbsp;<span class="ident" id="7382810">c1</span><span class="op" id="7382812">,</span>&nbsp;<span class="ident" id="7382814">syscall</span><span class="op" id="7382821">.</span><span class="ident" id="7382822">SIGHUP</span><span class="op" id="7382828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7382832">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382884">waitSig</span><span class="op" id="7382891">(</span><span class="ident" id="7382892">t</span><span class="op" id="7382893">,</span>&nbsp;<span class="ident" id="7382895">c</span><span class="op" id="7382896">,</span>&nbsp;<span class="ident" id="7382898">syscall</span><span class="op" id="7382905">.</span><span class="ident" id="7382906">SIGHUP</span><span class="op" id="7382912">)</span><br>
<span class="lineno">65</span><span class="op" id="7382914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7382917">func</span>&nbsp;<span class="ident" id="7382922">TestStress</span><span class="op" id="7382932">(</span><span class="ident" id="7382933">t</span>&nbsp;<span class="op" id="7382935">*</span><span class="ident" id="7382936">testing</span><span class="op" id="7382943">.</span><span class="ident" id="7382944">T</span><span class="op" id="7382945">)</span>&nbsp;<span class="op" id="7382947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382950">dur</span>&nbsp;<span class="op" id="7382954">:=</span>&nbsp;<span class="num" id="7382957">3</span>&nbsp;<span class="op" id="7382959">*</span>&nbsp;<span class="ident" id="7382961">time</span><span class="op" id="7382965">.</span><span class="ident" id="7382966">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7382974">if</span>&nbsp;<span class="ident" id="7382977">testing</span><span class="op" id="7382984">.</span><span class="ident" id="7382985">Short</span><span class="op" id="7382990">(</span><span class="op" id="7382991">)</span>&nbsp;<span class="op" id="7382993">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7382997">dur</span>&nbsp;<span class="op" id="7383001">=</span>&nbsp;<span class="num" id="7383003">100</span>&nbsp;<span class="op" id="7383007">*</span>&nbsp;<span class="ident" id="7383009">time</span><span class="op" id="7383013">.</span><span class="ident" id="7383014">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7383027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383030">defer</span>&nbsp;<span class="ident" id="7383036">runtime</span><span class="op" id="7383043">.</span><span class="ident" id="7383044">GOMAXPROCS</span><span class="op" id="7383054">(</span><span class="ident" id="7383055">runtime</span><span class="op" id="7383062">.</span><span class="ident" id="7383063">GOMAXPROCS</span><span class="op" id="7383073">(</span><span class="num" id="7383074">4</span><span class="op" id="7383075">)</span><span class="op" id="7383076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383079">done</span>&nbsp;<span class="op" id="7383084">:=</span>&nbsp;<span class="builtinfunc" id="7383087">make</span><span class="op" id="7383091">(</span><span class="keyword" id="7383092">chan</span>&nbsp;<span class="builtintype" id="7383097">bool</span><span class="op" id="7383101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383104">finished</span>&nbsp;<span class="op" id="7383113">:=</span>&nbsp;<span class="builtinfunc" id="7383116">make</span><span class="op" id="7383120">(</span><span class="keyword" id="7383121">chan</span>&nbsp;<span class="builtintype" id="7383126">bool</span><span class="op" id="7383130">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383133">go</span>&nbsp;<span class="keyword" id="7383136">func</span><span class="op" id="7383140">(</span><span class="op" id="7383141">)</span>&nbsp;<span class="op" id="7383143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383147">sig</span>&nbsp;<span class="op" id="7383151">:=</span>&nbsp;<span class="builtinfunc" id="7383154">make</span><span class="op" id="7383158">(</span><span class="keyword" id="7383159">chan</span>&nbsp;<span class="ident" id="7383164">os</span><span class="op" id="7383166">.</span><span class="ident" id="7383167">Signal</span><span class="op" id="7383173">,</span>&nbsp;<span class="num" id="7383175">1</span><span class="op" id="7383176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383180">Notify</span><span class="op" id="7383186">(</span><span class="ident" id="7383187">sig</span><span class="op" id="7383190">,</span>&nbsp;<span class="ident" id="7383192">syscall</span><span class="op" id="7383199">.</span><span class="ident" id="7383200">SIGUSR1</span><span class="op" id="7383207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383211">defer</span>&nbsp;<span class="ident" id="7383217">Stop</span><span class="op" id="7383221">(</span><span class="ident" id="7383222">sig</span><span class="op" id="7383225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383228">Loop</span><span class="op" id="7383232">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383236">for</span>&nbsp;<span class="op" id="7383240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383245">select</span>&nbsp;<span class="op" id="7383252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383257">case</span>&nbsp;<span class="op" id="7383262">&lt;-</span><span class="ident" id="7383264">sig</span><span class="op" id="7383267">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383272">case</span>&nbsp;<span class="op" id="7383277">&lt;-</span><span class="ident" id="7383279">done</span><span class="op" id="7383283">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383289">break</span>&nbsp;<span class="ident" id="7383295">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7383303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7383307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383311">finished</span>&nbsp;<span class="op" id="7383320">&lt;-</span>&nbsp;<span class="builtintype" id="7383323">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7383329">}</span><span class="op" id="7383330">(</span><span class="op" id="7383331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383334">go</span>&nbsp;<span class="keyword" id="7383337">func</span><span class="op" id="7383341">(</span><span class="op" id="7383342">)</span>&nbsp;<span class="op" id="7383344">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383347">Loop</span><span class="op" id="7383351">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383355">for</span>&nbsp;<span class="op" id="7383359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383364">select</span>&nbsp;<span class="op" id="7383371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383376">case</span>&nbsp;<span class="op" id="7383381">&lt;-</span><span class="ident" id="7383383">done</span><span class="op" id="7383387">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383393">break</span>&nbsp;<span class="ident" id="7383399">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7383407">default</span><span class="op" id="7383414">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383420">syscall</span><span class="op" id="7383427">.</span><span class="ident" id="7383428">Kill</span><span class="op" id="7383432">(</span><span class="ident" id="7383433">syscall</span><span class="op" id="7383440">.</span><span class="ident" id="7383441">Getpid</span><span class="op" id="7383447">(</span><span class="op" id="7383448">)</span><span class="op" id="7383449">,</span>&nbsp;<span class="ident" id="7383451">syscall</span><span class="op" id="7383458">.</span><span class="ident" id="7383459">SIGUSR1</span><span class="op" id="7383466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383472">runtime</span><span class="op" id="7383479">.</span><span class="ident" id="7383480">Gosched</span><span class="op" id="7383487">(</span><span class="op" id="7383488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7383493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7383497">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383501">finished</span>&nbsp;<span class="op" id="7383510">&lt;-</span>&nbsp;<span class="builtintype" id="7383513">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7383519">}</span><span class="op" id="7383520">(</span><span class="op" id="7383521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383524">time</span><span class="op" id="7383528">.</span><span class="ident" id="7383529">Sleep</span><span class="op" id="7383534">(</span><span class="ident" id="7383535">dur</span><span class="op" id="7383538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7383541">close</span><span class="op" id="7383546">(</span><span class="ident" id="7383547">done</span><span class="op" id="7383551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7383554">&lt;-</span><span class="ident" id="7383556">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7383566">&lt;-</span><span class="ident" id="7383568">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7383578">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7383649">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7383699">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383763">time</span><span class="op" id="7383767">.</span><span class="ident" id="7383768">Sleep</span><span class="op" id="7383773">(</span><span class="num" id="7383774">10</span>&nbsp;<span class="op" id="7383777">*</span>&nbsp;<span class="ident" id="7383779">time</span><span class="op" id="7383783">.</span><span class="ident" id="7383784">Millisecond</span><span class="op" id="7383795">)</span><br>
<span class="lineno">110</span><span class="op" id="7383797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7383800">var</span>&nbsp;<span class="ident" id="7383804">sendUncaughtSighup</span>&nbsp;<span class="op" id="7383823">=</span>&nbsp;<span class="ident" id="7383825">flag</span><span class="op" id="7383829">.</span><span class="ident" id="7383830">Int</span><span class="op" id="7383833">(</span><span class="string" id="7383834">&#34;send_uncaught_sighup&#34;</span><span class="op" id="7383856">,</span>&nbsp;<span class="num" id="7383858">0</span><span class="op" id="7383859">,</span>&nbsp;<span class="string" id="7383861">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="7383899">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7383902">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="7383957">func</span>&nbsp;<span class="ident" id="7383962">TestStop</span><span class="op" id="7383970">(</span><span class="ident" id="7383971">t</span>&nbsp;<span class="op" id="7383973">*</span><span class="ident" id="7383974">testing</span><span class="op" id="7383981">.</span><span class="ident" id="7383982">T</span><span class="op" id="7383983">)</span>&nbsp;<span class="op" id="7383985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7383988">sigs</span>&nbsp;<span class="op" id="7383993">:=</span>&nbsp;<span class="op" id="7383996">[</span><span class="op" id="7383997">]</span><span class="ident" id="7383998">syscall</span><span class="op" id="7384005">.</span><span class="ident" id="7384006">Signal</span><span class="op" id="7384012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7384016">syscall</span><span class="op" id="7384023">.</span><span class="ident" id="7384024">SIGWINCH</span><span class="op" id="7384032">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7384036">syscall</span><span class="op" id="7384043">.</span><span class="ident" id="7384044">SIGHUP</span><span class="op" id="7384050">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7384053">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7384057">for</span>&nbsp;<span class="ident" id="7384061">_</span><span class="op" id="7384062">,</span>&nbsp;<span class="ident" id="7384064">sig</span>&nbsp;<span class="op" id="7384068">:=</span>&nbsp;<span class="keyword" id="7384071">range</span>&nbsp;<span class="ident" id="7384077">sigs</span>&nbsp;<span class="op" id="7384082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7384086">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7384108">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7384153">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7384224">if</span>&nbsp;<span class="ident" id="7384227">sig</span>&nbsp;<span class="op" id="7384231">!=</span>&nbsp;<span class="ident" id="7384234">syscall</span><span class="op" id="7384241">.</span><span class="ident" id="7384242">SIGHUP</span>&nbsp;<span class="op" id="7384249">||</span>&nbsp;<span class="op" id="7384252">*</span><span class="ident" id="7384253">sendUncaughtSighup</span>&nbsp;<span class="op" id="7384272">==</span>&nbsp;<span class="num" id="7384275">1</span>&nbsp;<span class="op" id="7384277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7384282">syscall</span><span class="op" id="7384289">.</span><span class="ident" id="7384290">Kill</span><span class="op" id="7384294">(</span><span class="ident" id="7384295">syscall</span><span class="op" id="7384302">.</span><span class="ident" id="7384303">Getpid</span><span class="op" id="7384309">(</span><span class="op" id="7384310">)</span><span class="op" id="7384311">,</span>&nbsp;<span class="ident" id="7384313">sig</span><span class="op" id="7384316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7384320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7384324">time</span><span class="op" id="7384328">.</span><span class="ident" id="7384329">Sleep</span><span class="op" id="7384334">(</span><span class="num" id="7384335">100</span>&nbsp;<span class="op" id="7384339">*</span>&nbsp;<span class="ident" id="7384341">time</span><span class="op" id="7384345">.</span><span class="ident" id="7384346">Millisecond</span><span class="op" id="7384357">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7384362">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7384382">c</span>&nbsp;<span class="op" id="7384384">:=</span>&nbsp;<span class="builtinfunc" id="7384387">make</span><span class="op" id="7384391">(</span><span class="keyword" id="7384392">chan</span>&nbsp;<span class="ident" id="7384397">os</span><span class="op" id="7384399">.</span><span class="ident" id="7384400">Signal</span><span class="op" id="7384406">,</span>&nbsp;<span class="num" id="7384408">1</span><span class="op" id="7384409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7384413">Notify</span><span class="op" id="7384419">(</span><span class="ident" id="7384420">c</span><span class="op" id="7384421">,</span>&nbsp;<span class="ident" id="7384423">sig</span><span class="op" id="7384426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7384430">defer</span>&nbsp;<span class="ident" id="7384436">Stop</span><span class="op" id="7384440">(</span><span class="ident" id="7384441">c</span><span class="op" id="7384442">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7384447">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7384482">syscall</span><span class="op" id="7384489">.</span><span class="ident" id="7384490">Kill</span><span class="op" id="7384494">(</span><span class="ident" id="7384495">syscall</span><span class="op" id="7384502">.</span><span class="ident" id="7384503">Getpid</span><span class="op" id="7384509">(</span><span class="op" id="7384510">)</span><span class="op" id="7384511">,</span>&nbsp;<span class="ident" id="7384513">sig</span><span class="op" id="7384516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7384520">waitSig</span><span class="op" id="7384527">(</span><span class="ident" id="7384528">t</span><span class="op" id="7384529">,</span>&nbsp;<span class="ident" id="7384531">c</span><span class="op" id="7384532">,</span>&nbsp;<span class="ident" id="7384534">sig</span><span class="op" id="7384537">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7384542">Stop</span><span class="op" id="7384546">(</span><span class="ident" id="7384547">c</span><span class="op" id="7384548">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7384552">select</span>&nbsp;<span class="op" id="7384559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7384563">case</span>&nbsp;<span class="ident" id="7384568">s</span>&nbsp;<span class="op" id="7384570">:=</span>&nbsp;<span class="op" id="7384573">&lt;-</span><span class="ident" id="7384575">c</span><span class="op" id="7384576">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7384581">t</span><span class="op" id="7384582">.</span><span class="ident" id="7384583">Fatalf</span><span class="op" id="7384589">(</span><span class="string" id="7384590">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7384612">,</span>&nbsp;<span class="ident" id="7384614">s</span><span class="op" id="7384615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7384619">case</span>&nbsp;<span class="op" id="7384624">&lt;-</span><span class="ident" id="7384626">time</span><span class="op" id="7384630">.</span><span class="ident" id="7384631">After</span><span class="op" id="7384636">(</span><span class="num" id="7384637">100</span>&nbsp;<span class="op" id="7384641">*</span>&nbsp;<span class="ident" id="7384643">time</span><span class="op" id="7384647">.</span><span class="ident" id="7384648">Millisecond</span><span class="op" id="7384659">)</span><span class="op" id="7384660">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7384665">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7384693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7384698">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7384720">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7384765">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7384836">if</span>&nbsp;<span class="ident" id="7384839">sig</span>&nbsp;<span class="op" id="7384843">!=</span>&nbsp;<span class="ident" id="7384846">syscall</span><span class="op" id="7384853">.</span><span class="ident" id="7384854">SIGHUP</span>&nbsp;<span class="op" id="7384861">||</span>&nbsp;<span class="op" id="7384864">*</span><span class="ident" id="7384865">sendUncaughtSighup</span>&nbsp;<span class="op" id="7384884">==</span>&nbsp;<span class="num" id="7384887">2</span>&nbsp;<span class="op" id="7384889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7384894">syscall</span><span class="op" id="7384901">.</span><span class="ident" id="7384902">Kill</span><span class="op" id="7384906">(</span><span class="ident" id="7384907">syscall</span><span class="op" id="7384914">.</span><span class="ident" id="7384915">Getpid</span><span class="op" id="7384921">(</span><span class="op" id="7384922">)</span><span class="op" id="7384923">,</span>&nbsp;<span class="ident" id="7384925">sig</span><span class="op" id="7384928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7384932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7384937">select</span>&nbsp;<span class="op" id="7384944">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7384948">case</span>&nbsp;<span class="ident" id="7384953">s</span>&nbsp;<span class="op" id="7384955">:=</span>&nbsp;<span class="op" id="7384958">&lt;-</span><span class="ident" id="7384960">c</span><span class="op" id="7384961">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7384966">t</span><span class="op" id="7384967">.</span><span class="ident" id="7384968">Fatalf</span><span class="op" id="7384974">(</span><span class="string" id="7384975">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7384997">,</span>&nbsp;<span class="ident" id="7384999">s</span><span class="op" id="7385000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7385004">case</span>&nbsp;<span class="op" id="7385009">&lt;-</span><span class="ident" id="7385011">time</span><span class="op" id="7385015">.</span><span class="ident" id="7385016">After</span><span class="op" id="7385021">(</span><span class="num" id="7385022">100</span>&nbsp;<span class="op" id="7385026">*</span>&nbsp;<span class="ident" id="7385028">time</span><span class="op" id="7385032">.</span><span class="ident" id="7385033">Millisecond</span><span class="op" id="7385044">)</span><span class="op" id="7385045">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385050">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7385078">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7385081">}</span><br>
<span class="lineno"></span><span class="op" id="7385083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7385086">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="7385167">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="7385176">func</span>&nbsp;<span class="ident" id="7385181">TestNohup</span><span class="op" id="7385190">(</span><span class="ident" id="7385191">t</span>&nbsp;<span class="op" id="7385193">*</span><span class="ident" id="7385194">testing</span><span class="op" id="7385201">.</span><span class="ident" id="7385202">T</span><span class="op" id="7385203">)</span>&nbsp;<span class="op" id="7385205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385208">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385272">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385325">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7385369">c</span>&nbsp;<span class="op" id="7385371">:=</span>&nbsp;<span class="builtinfunc" id="7385374">make</span><span class="op" id="7385378">(</span><span class="keyword" id="7385379">chan</span>&nbsp;<span class="ident" id="7385384">os</span><span class="op" id="7385386">.</span><span class="ident" id="7385387">Signal</span><span class="op" id="7385393">,</span>&nbsp;<span class="num" id="7385395">1</span><span class="op" id="7385396">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7385399">Notify</span><span class="op" id="7385405">(</span><span class="ident" id="7385406">c</span><span class="op" id="7385407">,</span>&nbsp;<span class="ident" id="7385409">syscall</span><span class="op" id="7385416">.</span><span class="ident" id="7385417">SIGHUP</span><span class="op" id="7385423">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385427">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385500">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385567">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385633">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385712">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385790">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385794">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385877">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385960">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7385964">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7386024">for</span>&nbsp;<span class="ident" id="7386028">i</span>&nbsp;<span class="op" id="7386030">:=</span>&nbsp;<span class="num" id="7386033">1</span><span class="op" id="7386034">;</span>&nbsp;<span class="ident" id="7386036">i</span>&nbsp;<span class="op" id="7386038">&lt;=</span>&nbsp;<span class="num" id="7386041">2</span><span class="op" id="7386042">;</span>&nbsp;<span class="ident" id="7386044">i</span><span class="op" id="7386045">++</span>&nbsp;<span class="op" id="7386048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7386052">out</span><span class="op" id="7386055">,</span>&nbsp;<span class="ident" id="7386057">err</span>&nbsp;<span class="op" id="7386061">:=</span>&nbsp;<span class="ident" id="7386064">exec</span><span class="op" id="7386068">.</span><span class="ident" id="7386069">Command</span><span class="op" id="7386076">(</span><span class="ident" id="7386077">os</span><span class="op" id="7386079">.</span><span class="ident" id="7386080">Args</span><span class="op" id="7386084">[</span><span class="num" id="7386085">0</span><span class="op" id="7386086">]</span><span class="op" id="7386087">,</span>&nbsp;<span class="string" id="7386089">&#34;-test.run=TestStop&#34;</span><span class="op" id="7386109">,</span>&nbsp;<span class="string" id="7386111">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7386135">+</span><span class="ident" id="7386136">strconv</span><span class="op" id="7386143">.</span><span class="ident" id="7386144">Itoa</span><span class="op" id="7386148">(</span><span class="ident" id="7386149">i</span><span class="op" id="7386150">)</span><span class="op" id="7386151">)</span><span class="op" id="7386152">.</span><span class="ident" id="7386153">CombinedOutput</span><span class="op" id="7386167">(</span><span class="op" id="7386168">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7386172">if</span>&nbsp;<span class="ident" id="7386175">err</span>&nbsp;<span class="op" id="7386179">==</span>&nbsp;<span class="ident" id="7386182">nil</span>&nbsp;<span class="op" id="7386186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7386191">t</span><span class="op" id="7386192">.</span><span class="ident" id="7386193">Fatalf</span><span class="op" id="7386199">(</span><span class="string" id="7386200">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="7386289">,</span>&nbsp;<span class="ident" id="7386291">i</span><span class="op" id="7386292">,</span>&nbsp;<span class="ident" id="7386294">out</span><span class="op" id="7386297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7386301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7386304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7386308">Stop</span><span class="op" id="7386312">(</span><span class="ident" id="7386313">c</span><span class="op" id="7386314">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7386318">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7386376">_</span><span class="op" id="7386377">,</span>&nbsp;<span class="ident" id="7386379">err</span>&nbsp;<span class="op" id="7386383">:=</span>&nbsp;<span class="ident" id="7386386">os</span><span class="op" id="7386388">.</span><span class="ident" id="7386389">Stat</span><span class="op" id="7386393">(</span><span class="string" id="7386394">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7386410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7386413">if</span>&nbsp;<span class="ident" id="7386416">err</span>&nbsp;<span class="op" id="7386420">!=</span>&nbsp;<span class="ident" id="7386423">nil</span>&nbsp;<span class="op" id="7386427">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7386431">t</span><span class="op" id="7386432">.</span><span class="ident" id="7386433">Skip</span><span class="op" id="7386437">(</span><span class="string" id="7386438">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="7386487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7386490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7386494">for</span>&nbsp;<span class="ident" id="7386498">i</span>&nbsp;<span class="op" id="7386500">:=</span>&nbsp;<span class="num" id="7386503">1</span><span class="op" id="7386504">;</span>&nbsp;<span class="ident" id="7386506">i</span>&nbsp;<span class="op" id="7386508">&lt;=</span>&nbsp;<span class="num" id="7386511">2</span><span class="op" id="7386512">;</span>&nbsp;<span class="ident" id="7386514">i</span><span class="op" id="7386515">++</span>&nbsp;<span class="op" id="7386518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7386522">os</span><span class="op" id="7386524">.</span><span class="ident" id="7386525">Remove</span><span class="op" id="7386531">(</span><span class="string" id="7386532">&#34;nohup.out&#34;</span><span class="op" id="7386543">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7386547">out</span><span class="op" id="7386550">,</span>&nbsp;<span class="ident" id="7386552">err</span>&nbsp;<span class="op" id="7386556">:=</span>&nbsp;<span class="ident" id="7386559">exec</span><span class="op" id="7386563">.</span><span class="ident" id="7386564">Command</span><span class="op" id="7386571">(</span><span class="string" id="7386572">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7386588">,</span>&nbsp;<span class="ident" id="7386590">os</span><span class="op" id="7386592">.</span><span class="ident" id="7386593">Args</span><span class="op" id="7386597">[</span><span class="num" id="7386598">0</span><span class="op" id="7386599">]</span><span class="op" id="7386600">,</span>&nbsp;<span class="string" id="7386602">&#34;-test.run=TestStop&#34;</span><span class="op" id="7386622">,</span>&nbsp;<span class="string" id="7386624">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7386648">+</span><span class="ident" id="7386649">strconv</span><span class="op" id="7386656">.</span><span class="ident" id="7386657">Itoa</span><span class="op" id="7386661">(</span><span class="ident" id="7386662">i</span><span class="op" id="7386663">)</span><span class="op" id="7386664">)</span><span class="op" id="7386665">.</span><span class="ident" id="7386666">CombinedOutput</span><span class="op" id="7386680">(</span><span class="op" id="7386681">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7386686">data</span><span class="op" id="7386690">,</span>&nbsp;<span class="ident" id="7386692">_</span>&nbsp;<span class="op" id="7386694">:=</span>&nbsp;<span class="ident" id="7386697">ioutil</span><span class="op" id="7386703">.</span><span class="ident" id="7386704">ReadFile</span><span class="op" id="7386712">(</span><span class="string" id="7386713">&#34;nohup.out&#34;</span><span class="op" id="7386724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7386728">os</span><span class="op" id="7386730">.</span><span class="ident" id="7386731">Remove</span><span class="op" id="7386737">(</span><span class="string" id="7386738">&#34;nohup.out&#34;</span><span class="op" id="7386749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7386753">if</span>&nbsp;<span class="ident" id="7386756">err</span>&nbsp;<span class="op" id="7386760">!=</span>&nbsp;<span class="ident" id="7386763">nil</span>&nbsp;<span class="op" id="7386767">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7386772">t</span><span class="op" id="7386773">.</span><span class="ident" id="7386774">Fatalf</span><span class="op" id="7386780">(</span><span class="string" id="7386781">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="7386892">,</span>&nbsp;<span class="ident" id="7386894">i</span><span class="op" id="7386895">,</span>&nbsp;<span class="ident" id="7386897">err</span><span class="op" id="7386900">,</span>&nbsp;<span class="ident" id="7386902">out</span><span class="op" id="7386905">,</span>&nbsp;<span class="ident" id="7386907">data</span><span class="op" id="7386911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7386915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7386918">}</span><br>
<span class="lineno"></span><span class="op" id="7386920">}</span>
</div>
</body>
</html>
