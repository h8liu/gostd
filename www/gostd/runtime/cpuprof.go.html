<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html" class="current">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1504994">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1505050">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1505104">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1505155">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1505173">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1505224">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1505271">//</span><br>
<span class="lineno"></span><span class="comment" id="1505274">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1505340">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1505411">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1505480">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1505519">//</span><br>
<span class="lineno"></span><span class="comment" id="1505522">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1505596">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1505668">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1505737">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1505809">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1505876">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1505952">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1506024">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1506098">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1506176">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1506254">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1506334">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1506405">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1506483">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1506556">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1506578">//</span><br>
<span class="lineno">30</span><span class="comment" id="1506581">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1506653">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1506734">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1506811">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1506881">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1506954">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1507030">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1507104">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1507185">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1507269">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1507351">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1507390">//</span><br>
<span class="lineno"></span><span class="comment" id="1507393">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1507454">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1507532">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1507598">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1507671">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1507745">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1507818">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1507894">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1507959">package</span>&nbsp;<span class="ident" id="1507967">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1507976">import</span>&nbsp;<span class="string" id="1507983">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1507993">const</span>&nbsp;<span class="op" id="1507999">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508002">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508018">=</span>&nbsp;<span class="num" id="1508020">1</span>&nbsp;<span class="op" id="1508022">&lt;&lt;</span>&nbsp;<span class="num" id="1508025">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508029">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508045">=</span>&nbsp;<span class="num" id="1508047">1</span>&nbsp;<span class="op" id="1508049">&lt;&lt;</span>&nbsp;<span class="num" id="1508052">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508056">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508072">=</span>&nbsp;<span class="num" id="1508074">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508077">maxCPUProfStack</span>&nbsp;<span class="op" id="1508093">=</span>&nbsp;<span class="num" id="1508095">64</span><br>
<span class="lineno">60</span><span class="op" id="1508098">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1508101">type</span>&nbsp;<span class="ident" id="1508106">cpuprofEntry</span>&nbsp;<span class="keyword" id="1508119">struct</span>&nbsp;<span class="op" id="1508126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508129">count</span>&nbsp;<span class="builtintype" id="1508135">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508144">depth</span>&nbsp;<span class="builtintype" id="1508150">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508159">stack</span>&nbsp;<span class="op" id="1508165">[</span><span class="ident" id="1508166">maxCPUProfStack</span><span class="op" id="1508181">]</span><span class="builtintype" id="1508182">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1508190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1508193">type</span>&nbsp;<span class="ident" id="1508198">cpuProfile</span>&nbsp;<span class="keyword" id="1508209">struct</span>&nbsp;<span class="op" id="1508216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508219">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1508226">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1508234">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508254">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1508261">note</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1508269">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508294">count</span>&nbsp;&nbsp;<span class="builtintype" id="1508301">uintptr</span>&nbsp;<span class="comment" id="1508309">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508324">evicts</span>&nbsp;<span class="builtintype" id="1508331">uintptr</span>&nbsp;<span class="comment" id="1508339">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508358">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1508365">uintptr</span>&nbsp;<span class="comment" id="1508373">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508412">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508444">hash</span>&nbsp;<span class="op" id="1508449">[</span><span class="ident" id="1508450">numBuckets</span><span class="op" id="1508460">]</span><span class="keyword" id="1508461">struct</span>&nbsp;<span class="op" id="1508468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508472">entry</span>&nbsp;<span class="op" id="1508478">[</span><span class="ident" id="1508479">assoc</span><span class="op" id="1508484">]</span><span class="ident" id="1508485">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508503">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508540">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508590">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508640">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508648">[</span><span class="num" id="1508649">2</span><span class="op" id="1508650">]</span><span class="op" id="1508651">[</span><span class="ident" id="1508652">logSize</span>&nbsp;<span class="op" id="1508660">/</span>&nbsp;<span class="num" id="1508662">2</span><span class="op" id="1508663">]</span><span class="builtintype" id="1508664">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508673">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1508681">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508690">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1508698">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508705">handoff</span>&nbsp;<span class="builtintype" id="1508713">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508722">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508740">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508791">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508831">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1508840">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508848">wholding</span>&nbsp;<span class="builtintype" id="1508857">bool</span>&nbsp;<span class="comment" id="1508862">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508903">flushing</span>&nbsp;<span class="builtintype" id="1508912">bool</span>&nbsp;<span class="comment" id="1508917">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508959">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1508968">bool</span>&nbsp;<span class="comment" id="1508973">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1509021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1509024">var</span>&nbsp;<span class="op" id="1509028">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509031">cpuprofLock</span>&nbsp;<span class="ident" id="1509043">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509050">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509062">*</span><span class="ident" id="1509063">cpuProfile</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509076">eod</span>&nbsp;<span class="op" id="1509080">=</span>&nbsp;<span class="op" id="1509082">[</span><span class="num" id="1509083">3</span><span class="op" id="1509084">]</span><span class="builtintype" id="1509085">uintptr</span><span class="op" id="1509092">{</span><span class="num" id="1509093">0</span><span class="op" id="1509094">,</span>&nbsp;<span class="num" id="1509096">1</span><span class="op" id="1509097">,</span>&nbsp;<span class="num" id="1509099">0</span><span class="op" id="1509100">}</span><br>
<span class="lineno"></span><span class="op" id="1509102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1509105">func</span>&nbsp;<span class="ident" id="1509110">setcpuprofilerate_m</span><span class="op" id="1509129">(</span><span class="op" id="1509130">)</span>&nbsp;<span class="comment" id="1509132">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1509143">func</span>&nbsp;<span class="ident" id="1509148">setcpuprofilerate</span><span class="op" id="1509165">(</span><span class="ident" id="1509166">hz</span>&nbsp;<span class="builtintype" id="1509169">int32</span><span class="op" id="1509174">)</span>&nbsp;<span class="op" id="1509176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509179">g</span>&nbsp;<span class="op" id="1509181">:=</span>&nbsp;<span class="ident" id="1509184">getg</span><span class="op" id="1509188">(</span><span class="op" id="1509189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509192">g</span><span class="op" id="1509193">.</span><span class="ident" id="1509194">m</span><span class="op" id="1509195">.</span><span class="ident" id="1509196">scalararg</span><span class="op" id="1509205">[</span><span class="num" id="1509206">0</span><span class="op" id="1509207">]</span>&nbsp;<span class="op" id="1509209">=</span>&nbsp;<span class="builtintype" id="1509211">uintptr</span><span class="op" id="1509218">(</span><span class="ident" id="1509219">hz</span><span class="op" id="1509221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509224">onM</span><span class="op" id="1509227">(</span><span class="ident" id="1509228">setcpuprofilerate_m</span><span class="op" id="1509247">)</span><br>
<span class="lineno">110</span><span class="op" id="1509249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1509252">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1509308">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1509366">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1509405">func</span>&nbsp;<span class="ident" id="1509410">lostProfileData</span><span class="op" id="1509425">(</span><span class="op" id="1509426">)</span>&nbsp;<span class="op" id="1509428">{</span><span class="op" id="1509429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1509432">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1509507">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1509561">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1509644">//</span><br>
<span class="lineno"></span><span class="comment" id="1509647">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1509703">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1509769">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1509800">func</span>&nbsp;<span class="ident" id="1509805">SetCPUProfileRate</span><span class="op" id="1509822">(</span><span class="ident" id="1509823">hz</span>&nbsp;<span class="builtintype" id="1509826">int</span><span class="op" id="1509829">)</span>&nbsp;<span class="op" id="1509831">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1509834">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509872">if</span>&nbsp;<span class="ident" id="1509875">hz</span>&nbsp;<span class="op" id="1509878">&lt;</span>&nbsp;<span class="num" id="1509880">0</span>&nbsp;<span class="op" id="1509882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509886">hz</span>&nbsp;<span class="op" id="1509889">=</span>&nbsp;<span class="num" id="1509891">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509897">if</span>&nbsp;<span class="ident" id="1509900">hz</span>&nbsp;<span class="op" id="1509903">&gt;</span>&nbsp;<span class="num" id="1509905">1000000</span>&nbsp;<span class="op" id="1509913">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509917">hz</span>&nbsp;<span class="op" id="1509920">=</span>&nbsp;<span class="num" id="1509922">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509935">lock</span><span class="op" id="1509939">(</span><span class="op" id="1509940">&amp;</span><span class="ident" id="1509941">cpuprofLock</span><span class="op" id="1509952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509955">if</span>&nbsp;<span class="ident" id="1509958">hz</span>&nbsp;<span class="op" id="1509961">&gt;</span>&nbsp;<span class="num" id="1509963">0</span>&nbsp;<span class="op" id="1509965">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509969">if</span>&nbsp;<span class="ident" id="1509972">cpuprof</span>&nbsp;<span class="op" id="1509980">==</span>&nbsp;<span class="ident" id="1509983">nil</span>&nbsp;<span class="op" id="1509987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509992">cpuprof</span>&nbsp;<span class="op" id="1510000">=</span>&nbsp;<span class="op" id="1510002">(</span><span class="op" id="1510003">*</span><span class="ident" id="1510004">cpuProfile</span><span class="op" id="1510014">)</span><span class="op" id="1510015">(</span><span class="ident" id="1510016">sysAlloc</span><span class="op" id="1510024">(</span><span class="ident" id="1510025">unsafe</span><span class="op" id="1510031">.</span><span class="ident" id="1510032">Sizeof</span><span class="op" id="1510038">(</span><span class="ident" id="1510039">cpuProfile</span><span class="op" id="1510049">{</span><span class="op" id="1510050">}</span><span class="op" id="1510051">)</span><span class="op" id="1510052">,</span>&nbsp;<span class="op" id="1510054">&amp;</span><span class="ident" id="1510055">memstats</span><span class="op" id="1510063">.</span><span class="ident" id="1510064">other_sys</span><span class="op" id="1510073">)</span><span class="op" id="1510074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510079">if</span>&nbsp;<span class="ident" id="1510082">cpuprof</span>&nbsp;<span class="op" id="1510090">==</span>&nbsp;<span class="ident" id="1510093">nil</span>&nbsp;<span class="op" id="1510097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1510103">print</span><span class="op" id="1510108">(</span><span class="string" id="1510109">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1510158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510164">unlock</span><span class="op" id="1510170">(</span><span class="op" id="1510171">&amp;</span><span class="ident" id="1510172">cpuprofLock</span><span class="op" id="1510183">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510189">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510207">if</span>&nbsp;<span class="ident" id="1510210">cpuprof</span><span class="op" id="1510217">.</span><span class="ident" id="1510218">on</span>&nbsp;<span class="op" id="1510221">||</span>&nbsp;<span class="ident" id="1510224">cpuprof</span><span class="op" id="1510231">.</span><span class="ident" id="1510232">handoff</span>&nbsp;<span class="op" id="1510240">!=</span>&nbsp;<span class="num" id="1510243">0</span>&nbsp;<span class="op" id="1510245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1510250">print</span><span class="op" id="1510255">(</span><span class="string" id="1510256">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1510333">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510338">unlock</span><span class="op" id="1510344">(</span><span class="op" id="1510345">&amp;</span><span class="ident" id="1510346">cpuprofLock</span><span class="op" id="1510357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510362">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510376">cpuprof</span><span class="op" id="1510383">.</span><span class="ident" id="1510384">on</span>&nbsp;<span class="op" id="1510387">=</span>&nbsp;<span class="builtintype" id="1510389">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510396">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510429">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510519">p</span>&nbsp;<span class="op" id="1510521">:=</span>&nbsp;<span class="op" id="1510524">&amp;</span><span class="ident" id="1510525">cpuprof</span><span class="op" id="1510532">.</span><span class="ident" id="1510533">log</span><span class="op" id="1510536">[</span><span class="num" id="1510537">0</span><span class="op" id="1510538">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510542">p</span><span class="op" id="1510543">[</span><span class="num" id="1510544">0</span><span class="op" id="1510545">]</span>&nbsp;<span class="op" id="1510547">=</span>&nbsp;<span class="num" id="1510549">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1510567">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510589">p</span><span class="op" id="1510590">[</span><span class="num" id="1510591">1</span><span class="op" id="1510592">]</span>&nbsp;<span class="op" id="1510594">=</span>&nbsp;<span class="num" id="1510596">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1510614">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510636">p</span><span class="op" id="1510637">[</span><span class="num" id="1510638">2</span><span class="op" id="1510639">]</span>&nbsp;<span class="op" id="1510641">=</span>&nbsp;<span class="num" id="1510643">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1510661">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510681">p</span><span class="op" id="1510682">[</span><span class="num" id="1510683">3</span><span class="op" id="1510684">]</span>&nbsp;<span class="op" id="1510686">=</span>&nbsp;<span class="builtintype" id="1510688">uintptr</span><span class="op" id="1510695">(</span><span class="num" id="1510696">1e6</span>&nbsp;<span class="op" id="1510700">/</span>&nbsp;<span class="ident" id="1510702">hz</span><span class="op" id="1510704">)</span>&nbsp;<span class="comment" id="1510706">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510733">p</span><span class="op" id="1510734">[</span><span class="num" id="1510735">4</span><span class="op" id="1510736">]</span>&nbsp;<span class="op" id="1510738">=</span>&nbsp;<span class="num" id="1510740">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510744">cpuprof</span><span class="op" id="1510751">.</span><span class="ident" id="1510752">nlog</span>&nbsp;<span class="op" id="1510757">=</span>&nbsp;<span class="num" id="1510759">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510763">cpuprof</span><span class="op" id="1510770">.</span><span class="ident" id="1510771">toggle</span>&nbsp;<span class="op" id="1510778">=</span>&nbsp;<span class="num" id="1510780">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510784">cpuprof</span><span class="op" id="1510791">.</span><span class="ident" id="1510792">wholding</span>&nbsp;<span class="op" id="1510801">=</span>&nbsp;<span class="builtintype" id="1510803">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510811">cpuprof</span><span class="op" id="1510818">.</span><span class="ident" id="1510819">wtoggle</span>&nbsp;<span class="op" id="1510827">=</span>&nbsp;<span class="num" id="1510829">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510833">cpuprof</span><span class="op" id="1510840">.</span><span class="ident" id="1510841">flushing</span>&nbsp;<span class="op" id="1510850">=</span>&nbsp;<span class="builtintype" id="1510852">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510860">cpuprof</span><span class="op" id="1510867">.</span><span class="ident" id="1510868">eodSent</span>&nbsp;<span class="op" id="1510876">=</span>&nbsp;<span class="builtintype" id="1510878">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510886">noteclear</span><span class="op" id="1510895">(</span><span class="op" id="1510896">&amp;</span><span class="ident" id="1510897">cpuprof</span><span class="op" id="1510904">.</span><span class="ident" id="1510905">wait</span><span class="op" id="1510909">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510914">setcpuprofilerate</span><span class="op" id="1510931">(</span><span class="builtintype" id="1510932">int32</span><span class="op" id="1510937">(</span><span class="ident" id="1510938">hz</span><span class="op" id="1510940">)</span><span class="op" id="1510941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510944">}</span>&nbsp;<span class="keyword" id="1510946">else</span>&nbsp;<span class="keyword" id="1510951">if</span>&nbsp;<span class="ident" id="1510954">cpuprof</span>&nbsp;<span class="op" id="1510962">!=</span>&nbsp;<span class="ident" id="1510965">nil</span>&nbsp;<span class="op" id="1510969">&amp;&amp;</span>&nbsp;<span class="ident" id="1510972">cpuprof</span><span class="op" id="1510979">.</span><span class="ident" id="1510980">on</span>&nbsp;<span class="op" id="1510983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510987">setcpuprofilerate</span><span class="op" id="1511004">(</span><span class="num" id="1511005">0</span><span class="op" id="1511006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511010">cpuprof</span><span class="op" id="1511017">.</span><span class="ident" id="1511018">on</span>&nbsp;<span class="op" id="1511021">=</span>&nbsp;<span class="builtintype" id="1511023">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511032">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511105">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511164">for</span>&nbsp;<span class="op" id="1511168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511173">n</span>&nbsp;<span class="op" id="1511175">:=</span>&nbsp;<span class="ident" id="1511178">cpuprof</span><span class="op" id="1511185">.</span><span class="ident" id="1511186">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511197">if</span>&nbsp;<span class="ident" id="1511200">n</span><span class="op" id="1511201">&amp;</span><span class="num" id="1511202">0x80000000</span>&nbsp;<span class="op" id="1511213">!=</span>&nbsp;<span class="num" id="1511216">0</span>&nbsp;<span class="op" id="1511218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1511224">print</span><span class="op" id="1511229">(</span><span class="string" id="1511230">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1511267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511277">if</span>&nbsp;<span class="ident" id="1511280">cas</span><span class="op" id="1511283">(</span><span class="op" id="1511284">&amp;</span><span class="ident" id="1511285">cpuprof</span><span class="op" id="1511292">.</span><span class="ident" id="1511293">handoff</span><span class="op" id="1511300">,</span>&nbsp;<span class="ident" id="1511302">n</span><span class="op" id="1511303">,</span>&nbsp;<span class="ident" id="1511305">n</span><span class="op" id="1511306">|</span><span class="num" id="1511307">0x80000000</span><span class="op" id="1511317">)</span>&nbsp;<span class="op" id="1511319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511325">if</span>&nbsp;<span class="ident" id="1511328">n</span>&nbsp;<span class="op" id="1511330">==</span>&nbsp;<span class="num" id="1511333">0</span>&nbsp;<span class="op" id="1511335">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511342">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511412">notewakeup</span><span class="op" id="1511422">(</span><span class="op" id="1511423">&amp;</span><span class="ident" id="1511424">cpuprof</span><span class="op" id="1511431">.</span><span class="ident" id="1511432">wait</span><span class="op" id="1511436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511448">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511457">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511467">unlock</span><span class="op" id="1511473">(</span><span class="op" id="1511474">&amp;</span><span class="ident" id="1511475">cpuprofLock</span><span class="op" id="1511486">)</span><br>
<span class="lineno"></span><span class="op" id="1511488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1511491">func</span>&nbsp;<span class="ident" id="1511496">cpuproftick</span><span class="op" id="1511507">(</span><span class="ident" id="1511508">pc</span>&nbsp;<span class="op" id="1511511">*</span><span class="builtintype" id="1511512">uintptr</span><span class="op" id="1511519">,</span>&nbsp;<span class="ident" id="1511521">n</span>&nbsp;<span class="builtintype" id="1511523">int32</span><span class="op" id="1511528">)</span>&nbsp;<span class="op" id="1511530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511533">if</span>&nbsp;<span class="ident" id="1511536">n</span>&nbsp;<span class="op" id="1511538">&gt;</span>&nbsp;<span class="ident" id="1511540">maxCPUProfStack</span>&nbsp;<span class="op" id="1511556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511560">n</span>&nbsp;<span class="op" id="1511562">=</span>&nbsp;<span class="ident" id="1511564">maxCPUProfStack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511584">s</span>&nbsp;<span class="op" id="1511586">:=</span>&nbsp;<span class="op" id="1511589">(</span><span class="op" id="1511590">*</span><span class="op" id="1511591">[</span><span class="ident" id="1511592">maxCPUProfStack</span><span class="op" id="1511607">]</span><span class="builtintype" id="1511608">uintptr</span><span class="op" id="1511615">)</span><span class="op" id="1511616">(</span><span class="ident" id="1511617">unsafe</span><span class="op" id="1511623">.</span><span class="ident" id="1511624">Pointer</span><span class="op" id="1511631">(</span><span class="ident" id="1511632">pc</span><span class="op" id="1511634">)</span><span class="op" id="1511635">)</span><span class="op" id="1511636">[</span><span class="op" id="1511637">:</span><span class="ident" id="1511638">n</span><span class="op" id="1511639">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511642">cpuprof</span><span class="op" id="1511649">.</span><span class="ident" id="1511650">add</span><span class="op" id="1511653">(</span><span class="ident" id="1511654">s</span><span class="op" id="1511655">)</span><br>
<span class="lineno"></span><span class="op" id="1511657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1511660">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1511704">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1511772">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1511833">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1511903">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1511946">func</span>&nbsp;<span class="op" id="1511951">(</span><span class="ident" id="1511952">p</span>&nbsp;<span class="op" id="1511954">*</span><span class="ident" id="1511955">cpuProfile</span><span class="op" id="1511965">)</span>&nbsp;<span class="ident" id="1511967">add</span><span class="op" id="1511970">(</span><span class="ident" id="1511971">pc</span>&nbsp;<span class="op" id="1511974">[</span><span class="op" id="1511975">]</span><span class="builtintype" id="1511976">uintptr</span><span class="op" id="1511983">)</span>&nbsp;<span class="op" id="1511985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511988">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512006">h</span>&nbsp;<span class="op" id="1512008">:=</span>&nbsp;<span class="builtintype" id="1512011">uintptr</span><span class="op" id="1512018">(</span><span class="num" id="1512019">0</span><span class="op" id="1512020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512023">for</span>&nbsp;<span class="ident" id="1512027">_</span><span class="op" id="1512028">,</span>&nbsp;<span class="ident" id="1512030">x</span>&nbsp;<span class="op" id="1512032">:=</span>&nbsp;<span class="keyword" id="1512035">range</span>&nbsp;<span class="ident" id="1512041">pc</span>&nbsp;<span class="op" id="1512044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512048">h</span>&nbsp;<span class="op" id="1512050">=</span>&nbsp;<span class="ident" id="1512052">h</span><span class="op" id="1512053">&lt;&lt;</span><span class="num" id="1512055">8</span>&nbsp;<span class="op" id="1512057">|</span>&nbsp;<span class="op" id="1512059">(</span><span class="ident" id="1512060">h</span>&nbsp;<span class="op" id="1512062">&gt;&gt;</span>&nbsp;<span class="op" id="1512065">(</span><span class="num" id="1512066">8</span>&nbsp;<span class="op" id="1512068">*</span>&nbsp;<span class="op" id="1512070">(</span><span class="ident" id="1512071">unsafe</span><span class="op" id="1512077">.</span><span class="ident" id="1512078">Sizeof</span><span class="op" id="1512084">(</span><span class="ident" id="1512085">h</span><span class="op" id="1512086">)</span>&nbsp;<span class="op" id="1512088">-</span>&nbsp;<span class="num" id="1512090">1</span><span class="op" id="1512091">)</span><span class="op" id="1512092">)</span><span class="op" id="1512093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512097">h</span>&nbsp;<span class="op" id="1512099">+=</span>&nbsp;<span class="ident" id="1512102">x</span><span class="op" id="1512103">*</span><span class="num" id="1512104">31</span>&nbsp;<span class="op" id="1512107">+</span>&nbsp;<span class="ident" id="1512109">x</span><span class="op" id="1512110">*</span><span class="num" id="1512111">7</span>&nbsp;<span class="op" id="1512113">+</span>&nbsp;<span class="ident" id="1512115">x</span><span class="op" id="1512116">*</span><span class="num" id="1512117">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512120">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512123">p</span><span class="op" id="1512124">.</span><span class="ident" id="1512125">count</span><span class="op" id="1512130">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512135">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512187">b</span>&nbsp;<span class="op" id="1512189">:=</span>&nbsp;<span class="op" id="1512192">&amp;</span><span class="ident" id="1512193">p</span><span class="op" id="1512194">.</span><span class="ident" id="1512195">hash</span><span class="op" id="1512199">[</span><span class="ident" id="1512200">h</span><span class="op" id="1512201">%</span><span class="ident" id="1512202">numBuckets</span><span class="op" id="1512212">]</span><br>
<span class="lineno"></span><span class="ident" id="1512214">Assoc</span><span class="op" id="1512219">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512222">for</span>&nbsp;<span class="ident" id="1512226">i</span>&nbsp;<span class="op" id="1512228">:=</span>&nbsp;<span class="keyword" id="1512231">range</span>&nbsp;<span class="ident" id="1512237">b</span><span class="op" id="1512238">.</span><span class="ident" id="1512239">entry</span>&nbsp;<span class="op" id="1512245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512249">e</span>&nbsp;<span class="op" id="1512251">:=</span>&nbsp;<span class="op" id="1512254">&amp;</span><span class="ident" id="1512255">b</span><span class="op" id="1512256">.</span><span class="ident" id="1512257">entry</span><span class="op" id="1512262">[</span><span class="ident" id="1512263">i</span><span class="op" id="1512264">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512268">if</span>&nbsp;<span class="ident" id="1512271">e</span><span class="op" id="1512272">.</span><span class="ident" id="1512273">depth</span>&nbsp;<span class="op" id="1512279">!=</span>&nbsp;<span class="builtintype" id="1512282">uintptr</span><span class="op" id="1512289">(</span><span class="builtinfunc" id="1512290">len</span><span class="op" id="1512293">(</span><span class="ident" id="1512294">pc</span><span class="op" id="1512296">)</span><span class="op" id="1512297">)</span>&nbsp;<span class="op" id="1512299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512304">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512315">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512319">for</span>&nbsp;<span class="ident" id="1512323">j</span>&nbsp;<span class="op" id="1512325">:=</span>&nbsp;<span class="keyword" id="1512328">range</span>&nbsp;<span class="ident" id="1512334">pc</span>&nbsp;<span class="op" id="1512337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512342">if</span>&nbsp;<span class="ident" id="1512345">e</span><span class="op" id="1512346">.</span><span class="ident" id="1512347">stack</span><span class="op" id="1512352">[</span><span class="ident" id="1512353">j</span><span class="op" id="1512354">]</span>&nbsp;<span class="op" id="1512356">!=</span>&nbsp;<span class="ident" id="1512359">pc</span><span class="op" id="1512361">[</span><span class="ident" id="1512362">j</span><span class="op" id="1512363">]</span>&nbsp;<span class="op" id="1512365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512371">continue</span>&nbsp;<span class="ident" id="1512380">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512393">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512397">e</span><span class="op" id="1512398">.</span><span class="ident" id="1512399">count</span><span class="op" id="1512404">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512409">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512421">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512458">var</span>&nbsp;<span class="ident" id="1512462">e</span>&nbsp;<span class="op" id="1512464">*</span><span class="ident" id="1512465">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512479">for</span>&nbsp;<span class="ident" id="1512483">i</span>&nbsp;<span class="op" id="1512485">:=</span>&nbsp;<span class="keyword" id="1512488">range</span>&nbsp;<span class="ident" id="1512494">b</span><span class="op" id="1512495">.</span><span class="ident" id="1512496">entry</span>&nbsp;<span class="op" id="1512502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512506">if</span>&nbsp;<span class="ident" id="1512509">e</span>&nbsp;<span class="op" id="1512511">==</span>&nbsp;<span class="ident" id="1512514">nil</span>&nbsp;<span class="op" id="1512518">||</span>&nbsp;<span class="ident" id="1512521">b</span><span class="op" id="1512522">.</span><span class="ident" id="1512523">entry</span><span class="op" id="1512528">[</span><span class="ident" id="1512529">i</span><span class="op" id="1512530">]</span><span class="op" id="1512531">.</span><span class="ident" id="1512532">count</span>&nbsp;<span class="op" id="1512538">&lt;</span>&nbsp;<span class="ident" id="1512540">e</span><span class="op" id="1512541">.</span><span class="ident" id="1512542">count</span>&nbsp;<span class="op" id="1512548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512553">e</span>&nbsp;<span class="op" id="1512555">=</span>&nbsp;<span class="op" id="1512557">&amp;</span><span class="ident" id="1512558">b</span><span class="op" id="1512559">.</span><span class="ident" id="1512560">entry</span><span class="op" id="1512565">[</span><span class="ident" id="1512566">i</span><span class="op" id="1512567">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512571">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512577">if</span>&nbsp;<span class="ident" id="1512580">e</span><span class="op" id="1512581">.</span><span class="ident" id="1512582">count</span>&nbsp;<span class="op" id="1512588">&gt;</span>&nbsp;<span class="num" id="1512590">0</span>&nbsp;<span class="op" id="1512592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512596">if</span>&nbsp;<span class="op" id="1512599">!</span><span class="ident" id="1512600">p</span><span class="op" id="1512601">.</span><span class="ident" id="1512602">evict</span><span class="op" id="1512607">(</span><span class="ident" id="1512608">e</span><span class="op" id="1512609">)</span>&nbsp;<span class="op" id="1512611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512616">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512665">p</span><span class="op" id="1512666">.</span><span class="ident" id="1512667">lost</span><span class="op" id="1512671">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512677">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512690">p</span><span class="op" id="1512691">.</span><span class="ident" id="1512692">evicts</span><span class="op" id="1512698">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512706">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512741">e</span><span class="op" id="1512742">.</span><span class="ident" id="1512743">depth</span>&nbsp;<span class="op" id="1512749">=</span>&nbsp;<span class="builtintype" id="1512751">uintptr</span><span class="op" id="1512758">(</span><span class="builtinfunc" id="1512759">len</span><span class="op" id="1512762">(</span><span class="ident" id="1512763">pc</span><span class="op" id="1512765">)</span><span class="op" id="1512766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512769">e</span><span class="op" id="1512770">.</span><span class="ident" id="1512771">count</span>&nbsp;<span class="op" id="1512777">=</span>&nbsp;<span class="num" id="1512779">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1512782">copy</span><span class="op" id="1512786">(</span><span class="ident" id="1512787">e</span><span class="op" id="1512788">.</span><span class="ident" id="1512789">stack</span><span class="op" id="1512794">[</span><span class="op" id="1512795">:</span><span class="op" id="1512796">]</span><span class="op" id="1512797">,</span>&nbsp;<span class="ident" id="1512799">pc</span><span class="op" id="1512801">)</span><br>
<span class="lineno"></span><span class="op" id="1512803">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1512806">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1512867">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1512928">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1512991">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1513050">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1513108">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1513149">func</span>&nbsp;<span class="op" id="1513154">(</span><span class="ident" id="1513155">p</span>&nbsp;<span class="op" id="1513157">*</span><span class="ident" id="1513158">cpuProfile</span><span class="op" id="1513168">)</span>&nbsp;<span class="ident" id="1513170">evict</span><span class="op" id="1513175">(</span><span class="ident" id="1513176">e</span>&nbsp;<span class="op" id="1513178">*</span><span class="ident" id="1513179">cpuprofEntry</span><span class="op" id="1513191">)</span>&nbsp;<span class="builtintype" id="1513193">bool</span>&nbsp;<span class="op" id="1513198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513201">d</span>&nbsp;<span class="op" id="1513203">:=</span>&nbsp;<span class="ident" id="1513206">e</span><span class="op" id="1513207">.</span><span class="ident" id="1513208">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513215">nslot</span>&nbsp;<span class="op" id="1513221">:=</span>&nbsp;<span class="ident" id="1513224">d</span>&nbsp;<span class="op" id="1513226">+</span>&nbsp;<span class="num" id="1513228">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513231">log</span>&nbsp;<span class="op" id="1513235">:=</span>&nbsp;<span class="op" id="1513238">&amp;</span><span class="ident" id="1513239">p</span><span class="op" id="1513240">.</span><span class="ident" id="1513241">log</span><span class="op" id="1513244">[</span><span class="ident" id="1513245">p</span><span class="op" id="1513246">.</span><span class="ident" id="1513247">toggle</span><span class="op" id="1513253">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513256">if</span>&nbsp;<span class="ident" id="1513259">p</span><span class="op" id="1513260">.</span><span class="ident" id="1513261">nlog</span><span class="op" id="1513265">+</span><span class="ident" id="1513266">nslot</span>&nbsp;<span class="op" id="1513272">&gt;</span>&nbsp;<span class="builtintype" id="1513274">uintptr</span><span class="op" id="1513281">(</span><span class="builtinfunc" id="1513282">len</span><span class="op" id="1513285">(</span><span class="ident" id="1513286">p</span><span class="op" id="1513287">.</span><span class="ident" id="1513288">log</span><span class="op" id="1513291">[</span><span class="num" id="1513292">0</span><span class="op" id="1513293">]</span><span class="op" id="1513294">)</span><span class="op" id="1513295">)</span>&nbsp;<span class="op" id="1513297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513301">if</span>&nbsp;<span class="op" id="1513304">!</span><span class="ident" id="1513305">p</span><span class="op" id="1513306">.</span><span class="ident" id="1513307">flushlog</span><span class="op" id="1513315">(</span><span class="op" id="1513316">)</span>&nbsp;<span class="op" id="1513318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513323">return</span>&nbsp;<span class="builtintype" id="1513330">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1513338">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513342">log</span>&nbsp;<span class="op" id="1513346">=</span>&nbsp;<span class="op" id="1513348">&amp;</span><span class="ident" id="1513349">p</span><span class="op" id="1513350">.</span><span class="ident" id="1513351">log</span><span class="op" id="1513354">[</span><span class="ident" id="1513355">p</span><span class="op" id="1513356">.</span><span class="ident" id="1513357">toggle</span><span class="op" id="1513363">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1513366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513370">q</span>&nbsp;<span class="op" id="1513372">:=</span>&nbsp;<span class="ident" id="1513375">p</span><span class="op" id="1513376">.</span><span class="ident" id="1513377">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513383">log</span><span class="op" id="1513386">[</span><span class="ident" id="1513387">q</span><span class="op" id="1513388">]</span>&nbsp;<span class="op" id="1513390">=</span>&nbsp;<span class="ident" id="1513392">e</span><span class="op" id="1513393">.</span><span class="ident" id="1513394">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513401">q</span><span class="op" id="1513402">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513406">log</span><span class="op" id="1513409">[</span><span class="ident" id="1513410">q</span><span class="op" id="1513411">]</span>&nbsp;<span class="op" id="1513413">=</span>&nbsp;<span class="ident" id="1513415">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513418">q</span><span class="op" id="1513419">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1513423">copy</span><span class="op" id="1513427">(</span><span class="ident" id="1513428">log</span><span class="op" id="1513431">[</span><span class="ident" id="1513432">q</span><span class="op" id="1513433">:</span><span class="op" id="1513434">]</span><span class="op" id="1513435">,</span>&nbsp;<span class="ident" id="1513437">e</span><span class="op" id="1513438">.</span><span class="ident" id="1513439">stack</span><span class="op" id="1513444">[</span><span class="op" id="1513445">:</span><span class="ident" id="1513446">d</span><span class="op" id="1513447">]</span><span class="op" id="1513448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513451">q</span>&nbsp;<span class="op" id="1513453">+=</span>&nbsp;<span class="ident" id="1513456">d</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513459">p</span><span class="op" id="1513460">.</span><span class="ident" id="1513461">nlog</span>&nbsp;<span class="op" id="1513466">=</span>&nbsp;<span class="ident" id="1513468">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513471">e</span><span class="op" id="1513472">.</span><span class="ident" id="1513473">count</span>&nbsp;<span class="op" id="1513479">=</span>&nbsp;<span class="num" id="1513481">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513484">return</span>&nbsp;<span class="builtintype" id="1513491">true</span><br>
<span class="lineno"></span><span class="op" id="1513496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1513499">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1513571">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1513654">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1513726">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1513805">func</span>&nbsp;<span class="op" id="1513810">(</span><span class="ident" id="1513811">p</span>&nbsp;<span class="op" id="1513813">*</span><span class="ident" id="1513814">cpuProfile</span><span class="op" id="1513824">)</span>&nbsp;<span class="ident" id="1513826">flushlog</span><span class="op" id="1513834">(</span><span class="op" id="1513835">)</span>&nbsp;<span class="builtintype" id="1513837">bool</span>&nbsp;<span class="op" id="1513842">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513845">if</span>&nbsp;<span class="op" id="1513848">!</span><span class="ident" id="1513849">cas</span><span class="op" id="1513852">(</span><span class="op" id="1513853">&amp;</span><span class="ident" id="1513854">p</span><span class="op" id="1513855">.</span><span class="ident" id="1513856">handoff</span><span class="op" id="1513863">,</span>&nbsp;<span class="num" id="1513865">0</span><span class="op" id="1513866">,</span>&nbsp;<span class="builtintype" id="1513868">uint32</span><span class="op" id="1513874">(</span><span class="ident" id="1513875">p</span><span class="op" id="1513876">.</span><span class="ident" id="1513877">nlog</span><span class="op" id="1513881">)</span><span class="op" id="1513882">)</span>&nbsp;<span class="op" id="1513884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513888">return</span>&nbsp;<span class="builtintype" id="1513895">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1513902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513905">notewakeup</span><span class="op" id="1513915">(</span><span class="op" id="1513916">&amp;</span><span class="ident" id="1513917">p</span><span class="op" id="1513918">.</span><span class="ident" id="1513919">wait</span><span class="op" id="1513923">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513927">p</span><span class="op" id="1513928">.</span><span class="ident" id="1513929">toggle</span>&nbsp;<span class="op" id="1513936">=</span>&nbsp;<span class="num" id="1513938">1</span>&nbsp;<span class="op" id="1513940">-</span>&nbsp;<span class="ident" id="1513942">p</span><span class="op" id="1513943">.</span><span class="ident" id="1513944">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513952">log</span>&nbsp;<span class="op" id="1513956">:=</span>&nbsp;<span class="op" id="1513959">&amp;</span><span class="ident" id="1513960">p</span><span class="op" id="1513961">.</span><span class="ident" id="1513962">log</span><span class="op" id="1513965">[</span><span class="ident" id="1513966">p</span><span class="op" id="1513967">.</span><span class="ident" id="1513968">toggle</span><span class="op" id="1513974">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513977">q</span>&nbsp;<span class="op" id="1513979">:=</span>&nbsp;<span class="builtintype" id="1513982">uintptr</span><span class="op" id="1513989">(</span><span class="num" id="1513990">0</span><span class="op" id="1513991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513994">if</span>&nbsp;<span class="ident" id="1513997">p</span><span class="op" id="1513998">.</span><span class="ident" id="1513999">lost</span>&nbsp;<span class="op" id="1514004">&gt;</span>&nbsp;<span class="num" id="1514006">0</span>&nbsp;<span class="op" id="1514008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514012">lostPC</span>&nbsp;<span class="op" id="1514019">:=</span>&nbsp;<span class="ident" id="1514022">funcPC</span><span class="op" id="1514028">(</span><span class="ident" id="1514029">lostProfileData</span><span class="op" id="1514044">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514048">log</span><span class="op" id="1514051">[</span><span class="num" id="1514052">0</span><span class="op" id="1514053">]</span>&nbsp;<span class="op" id="1514055">=</span>&nbsp;<span class="ident" id="1514057">p</span><span class="op" id="1514058">.</span><span class="ident" id="1514059">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514066">log</span><span class="op" id="1514069">[</span><span class="num" id="1514070">1</span><span class="op" id="1514071">]</span>&nbsp;<span class="op" id="1514073">=</span>&nbsp;<span class="num" id="1514075">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514079">log</span><span class="op" id="1514082">[</span><span class="num" id="1514083">2</span><span class="op" id="1514084">]</span>&nbsp;<span class="op" id="1514086">=</span>&nbsp;<span class="ident" id="1514088">lostPC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514097">q</span>&nbsp;<span class="op" id="1514099">=</span>&nbsp;<span class="num" id="1514101">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514105">p</span><span class="op" id="1514106">.</span><span class="ident" id="1514107">lost</span>&nbsp;<span class="op" id="1514112">=</span>&nbsp;<span class="num" id="1514114">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514120">p</span><span class="op" id="1514121">.</span><span class="ident" id="1514122">nlog</span>&nbsp;<span class="op" id="1514127">=</span>&nbsp;<span class="ident" id="1514129">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514132">return</span>&nbsp;<span class="builtintype" id="1514139">true</span><br>
<span class="lineno"></span><span class="op" id="1514144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1514147">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1514220">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1514293">func</span>&nbsp;<span class="op" id="1514298">(</span><span class="ident" id="1514299">p</span>&nbsp;<span class="op" id="1514301">*</span><span class="ident" id="1514302">cpuProfile</span><span class="op" id="1514312">)</span>&nbsp;<span class="ident" id="1514314">getprofile</span><span class="op" id="1514324">(</span><span class="op" id="1514325">)</span>&nbsp;<span class="op" id="1514327">[</span><span class="op" id="1514328">]</span><span class="builtintype" id="1514329">byte</span>&nbsp;<span class="op" id="1514334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514337">if</span>&nbsp;<span class="ident" id="1514340">p</span>&nbsp;<span class="op" id="1514342">==</span>&nbsp;<span class="ident" id="1514345">nil</span>&nbsp;<span class="op" id="1514349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514353">return</span>&nbsp;<span class="ident" id="1514360">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514369">if</span>&nbsp;<span class="ident" id="1514372">p</span><span class="op" id="1514373">.</span><span class="ident" id="1514374">wholding</span>&nbsp;<span class="op" id="1514383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514387">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514438">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514500">for</span>&nbsp;<span class="op" id="1514504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514509">n</span>&nbsp;<span class="op" id="1514511">:=</span>&nbsp;<span class="ident" id="1514514">p</span><span class="op" id="1514515">.</span><span class="ident" id="1514516">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514527">if</span>&nbsp;<span class="ident" id="1514530">n</span>&nbsp;<span class="op" id="1514532">==</span>&nbsp;<span class="num" id="1514535">0</span>&nbsp;<span class="op" id="1514537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1514543">print</span><span class="op" id="1514548">(</span><span class="string" id="1514549">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1514600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514606">return</span>&nbsp;<span class="ident" id="1514613">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514625">if</span>&nbsp;<span class="ident" id="1514628">n</span><span class="op" id="1514629">&amp;</span><span class="num" id="1514630">0x80000000</span>&nbsp;<span class="op" id="1514641">!=</span>&nbsp;<span class="num" id="1514644">0</span>&nbsp;<span class="op" id="1514646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514652">p</span><span class="op" id="1514653">.</span><span class="ident" id="1514654">wtoggle</span>&nbsp;<span class="op" id="1514662">=</span>&nbsp;<span class="num" id="1514664">1</span>&nbsp;<span class="op" id="1514666">-</span>&nbsp;<span class="ident" id="1514668">p</span><span class="op" id="1514669">.</span><span class="ident" id="1514670">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514682">p</span><span class="op" id="1514683">.</span><span class="ident" id="1514684">wholding</span>&nbsp;<span class="op" id="1514693">=</span>&nbsp;<span class="builtintype" id="1514695">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514705">p</span><span class="op" id="1514706">.</span><span class="ident" id="1514707">flushing</span>&nbsp;<span class="op" id="1514716">=</span>&nbsp;<span class="builtintype" id="1514718">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514727">goto</span>&nbsp;<span class="ident" id="1514732">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514746">if</span>&nbsp;<span class="ident" id="1514749">cas</span><span class="op" id="1514752">(</span><span class="op" id="1514753">&amp;</span><span class="ident" id="1514754">p</span><span class="op" id="1514755">.</span><span class="ident" id="1514756">handoff</span><span class="op" id="1514763">,</span>&nbsp;<span class="ident" id="1514765">n</span><span class="op" id="1514766">,</span>&nbsp;<span class="num" id="1514768">0</span><span class="op" id="1514769">)</span>&nbsp;<span class="op" id="1514771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514777">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514786">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514794">p</span><span class="op" id="1514795">.</span><span class="ident" id="1514796">wtoggle</span>&nbsp;<span class="op" id="1514804">=</span>&nbsp;<span class="num" id="1514806">1</span>&nbsp;<span class="op" id="1514808">-</span>&nbsp;<span class="ident" id="1514810">p</span><span class="op" id="1514811">.</span><span class="ident" id="1514812">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514822">p</span><span class="op" id="1514823">.</span><span class="ident" id="1514824">wholding</span>&nbsp;<span class="op" id="1514833">=</span>&nbsp;<span class="builtintype" id="1514835">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514846">if</span>&nbsp;<span class="ident" id="1514849">p</span><span class="op" id="1514850">.</span><span class="ident" id="1514851">flushing</span>&nbsp;<span class="op" id="1514860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514864">goto</span>&nbsp;<span class="ident" id="1514869">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514880">if</span>&nbsp;<span class="op" id="1514883">!</span><span class="ident" id="1514884">p</span><span class="op" id="1514885">.</span><span class="ident" id="1514886">on</span>&nbsp;<span class="op" id="1514889">&amp;&amp;</span>&nbsp;<span class="ident" id="1514892">p</span><span class="op" id="1514893">.</span><span class="ident" id="1514894">handoff</span>&nbsp;<span class="op" id="1514902">==</span>&nbsp;<span class="num" id="1514905">0</span>&nbsp;<span class="op" id="1514907">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514911">return</span>&nbsp;<span class="ident" id="1514918">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514927">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514949">notetsleepg</span><span class="op" id="1514960">(</span><span class="op" id="1514961">&amp;</span><span class="ident" id="1514962">p</span><span class="op" id="1514963">.</span><span class="ident" id="1514964">wait</span><span class="op" id="1514968">,</span>&nbsp;<span class="op" id="1514970">-</span><span class="num" id="1514971">1</span><span class="op" id="1514972">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514975">noteclear</span><span class="op" id="1514984">(</span><span class="op" id="1514985">&amp;</span><span class="ident" id="1514986">p</span><span class="op" id="1514987">.</span><span class="ident" id="1514988">wait</span><span class="op" id="1514992">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514996">switch</span>&nbsp;<span class="ident" id="1515003">n</span>&nbsp;<span class="op" id="1515005">:=</span>&nbsp;<span class="ident" id="1515008">p</span><span class="op" id="1515009">.</span><span class="ident" id="1515010">handoff</span><span class="op" id="1515017">;</span>&nbsp;<span class="op" id="1515019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515022">case</span>&nbsp;<span class="ident" id="1515027">n</span>&nbsp;<span class="op" id="1515029">==</span>&nbsp;<span class="num" id="1515032">0</span><span class="op" id="1515033">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1515037">print</span><span class="op" id="1515042">(</span><span class="string" id="1515043">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1515091">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515095">return</span>&nbsp;<span class="ident" id="1515102">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515107">case</span>&nbsp;<span class="ident" id="1515112">n</span>&nbsp;<span class="op" id="1515114">==</span>&nbsp;<span class="num" id="1515117">0x80000000</span><span class="op" id="1515127">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515131">p</span><span class="op" id="1515132">.</span><span class="ident" id="1515133">flushing</span>&nbsp;<span class="op" id="1515142">=</span>&nbsp;<span class="builtintype" id="1515144">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515151">goto</span>&nbsp;<span class="ident" id="1515156">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515163">default</span><span class="op" id="1515170">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515174">n</span>&nbsp;<span class="op" id="1515176">&amp;^=</span>&nbsp;<span class="num" id="1515180">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515194">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515225">p</span><span class="op" id="1515226">.</span><span class="ident" id="1515227">wholding</span>&nbsp;<span class="op" id="1515236">=</span>&nbsp;<span class="builtintype" id="1515238">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515246">return</span>&nbsp;<span class="ident" id="1515253">uintptrBytes</span><span class="op" id="1515265">(</span><span class="ident" id="1515266">p</span><span class="op" id="1515267">.</span><span class="ident" id="1515268">log</span><span class="op" id="1515271">[</span><span class="ident" id="1515272">p</span><span class="op" id="1515273">.</span><span class="ident" id="1515274">wtoggle</span><span class="op" id="1515281">]</span><span class="op" id="1515282">[</span><span class="op" id="1515283">:</span><span class="ident" id="1515284">n</span><span class="op" id="1515285">]</span><span class="op" id="1515286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515293">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515312">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515364">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515429">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1515481">Flush</span><span class="op" id="1515486">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515489">for</span>&nbsp;<span class="ident" id="1515493">i</span>&nbsp;<span class="op" id="1515495">:=</span>&nbsp;<span class="keyword" id="1515498">range</span>&nbsp;<span class="ident" id="1515504">p</span><span class="op" id="1515505">.</span><span class="ident" id="1515506">hash</span>&nbsp;<span class="op" id="1515511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515515">b</span>&nbsp;<span class="op" id="1515517">:=</span>&nbsp;<span class="op" id="1515520">&amp;</span><span class="ident" id="1515521">p</span><span class="op" id="1515522">.</span><span class="ident" id="1515523">hash</span><span class="op" id="1515527">[</span><span class="ident" id="1515528">i</span><span class="op" id="1515529">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515533">for</span>&nbsp;<span class="ident" id="1515537">j</span>&nbsp;<span class="op" id="1515539">:=</span>&nbsp;<span class="keyword" id="1515542">range</span>&nbsp;<span class="ident" id="1515548">b</span><span class="op" id="1515549">.</span><span class="ident" id="1515550">entry</span>&nbsp;<span class="op" id="1515556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515561">e</span>&nbsp;<span class="op" id="1515563">:=</span>&nbsp;<span class="op" id="1515566">&amp;</span><span class="ident" id="1515567">b</span><span class="op" id="1515568">.</span><span class="ident" id="1515569">entry</span><span class="op" id="1515574">[</span><span class="ident" id="1515575">j</span><span class="op" id="1515576">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515581">if</span>&nbsp;<span class="ident" id="1515584">e</span><span class="op" id="1515585">.</span><span class="ident" id="1515586">count</span>&nbsp;<span class="op" id="1515592">&gt;</span>&nbsp;<span class="num" id="1515594">0</span>&nbsp;<span class="op" id="1515596">&amp;&amp;</span>&nbsp;<span class="op" id="1515599">!</span><span class="ident" id="1515600">p</span><span class="op" id="1515601">.</span><span class="ident" id="1515602">evict</span><span class="op" id="1515607">(</span><span class="ident" id="1515608">e</span><span class="op" id="1515609">)</span>&nbsp;<span class="op" id="1515611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515617">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515682">break</span>&nbsp;<span class="ident" id="1515688">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515708">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515737">if</span>&nbsp;<span class="ident" id="1515740">p</span><span class="op" id="1515741">.</span><span class="ident" id="1515742">nlog</span>&nbsp;<span class="op" id="1515747">&gt;</span>&nbsp;<span class="num" id="1515749">0</span>&nbsp;<span class="op" id="1515751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515755">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515807">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515855">n</span>&nbsp;<span class="op" id="1515857">:=</span>&nbsp;<span class="ident" id="1515860">p</span><span class="op" id="1515861">.</span><span class="ident" id="1515862">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515869">p</span><span class="op" id="1515870">.</span><span class="ident" id="1515871">nlog</span>&nbsp;<span class="op" id="1515876">=</span>&nbsp;<span class="num" id="1515878">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515882">return</span>&nbsp;<span class="ident" id="1515889">uintptrBytes</span><span class="op" id="1515901">(</span><span class="ident" id="1515902">p</span><span class="op" id="1515903">.</span><span class="ident" id="1515904">log</span><span class="op" id="1515907">[</span><span class="ident" id="1515908">p</span><span class="op" id="1515909">.</span><span class="ident" id="1515910">toggle</span><span class="op" id="1515916">]</span><span class="op" id="1515917">[</span><span class="op" id="1515918">:</span><span class="ident" id="1515919">n</span><span class="op" id="1515920">]</span><span class="op" id="1515921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515928">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515991">if</span>&nbsp;<span class="op" id="1515994">!</span><span class="ident" id="1515995">p</span><span class="op" id="1515996">.</span><span class="ident" id="1515997">eodSent</span>&nbsp;<span class="op" id="1516005">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516009">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516075">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516140">p</span><span class="op" id="1516141">.</span><span class="ident" id="1516142">eodSent</span>&nbsp;<span class="op" id="1516150">=</span>&nbsp;<span class="builtintype" id="1516152">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516159">return</span>&nbsp;<span class="ident" id="1516166">uintptrBytes</span><span class="op" id="1516178">(</span><span class="ident" id="1516179">eod</span><span class="op" id="1516182">[</span><span class="op" id="1516183">:</span><span class="op" id="1516184">]</span><span class="op" id="1516185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516188">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516192">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516236">p</span><span class="op" id="1516237">.</span><span class="ident" id="1516238">flushing</span>&nbsp;<span class="op" id="1516247">=</span>&nbsp;<span class="builtintype" id="1516249">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516256">if</span>&nbsp;<span class="op" id="1516259">!</span><span class="ident" id="1516260">cas</span><span class="op" id="1516263">(</span><span class="op" id="1516264">&amp;</span><span class="ident" id="1516265">p</span><span class="op" id="1516266">.</span><span class="ident" id="1516267">handoff</span><span class="op" id="1516274">,</span>&nbsp;<span class="ident" id="1516276">p</span><span class="op" id="1516277">.</span><span class="ident" id="1516278">handoff</span><span class="op" id="1516285">,</span>&nbsp;<span class="num" id="1516287">0</span><span class="op" id="1516288">)</span>&nbsp;<span class="op" id="1516290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1516294">print</span><span class="op" id="1516299">(</span><span class="string" id="1516300">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1516348">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516354">return</span>&nbsp;<span class="ident" id="1516361">nil</span><br>
<span class="lineno"></span><span class="op" id="1516365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1516368">func</span>&nbsp;<span class="ident" id="1516373">uintptrBytes</span><span class="op" id="1516385">(</span><span class="ident" id="1516386">p</span>&nbsp;<span class="op" id="1516388">[</span><span class="op" id="1516389">]</span><span class="builtintype" id="1516390">uintptr</span><span class="op" id="1516397">)</span>&nbsp;<span class="op" id="1516399">(</span><span class="ident" id="1516400">ret</span>&nbsp;<span class="op" id="1516404">[</span><span class="op" id="1516405">]</span><span class="builtintype" id="1516406">byte</span><span class="op" id="1516410">)</span>&nbsp;<span class="op" id="1516412">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516415">pp</span>&nbsp;<span class="op" id="1516418">:=</span>&nbsp;<span class="op" id="1516421">(</span><span class="op" id="1516422">*</span><span class="ident" id="1516423">sliceStruct</span><span class="op" id="1516434">)</span><span class="op" id="1516435">(</span><span class="ident" id="1516436">unsafe</span><span class="op" id="1516442">.</span><span class="ident" id="1516443">Pointer</span><span class="op" id="1516450">(</span><span class="op" id="1516451">&amp;</span><span class="ident" id="1516452">p</span><span class="op" id="1516453">)</span><span class="op" id="1516454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516457">rp</span>&nbsp;<span class="op" id="1516460">:=</span>&nbsp;<span class="op" id="1516463">(</span><span class="op" id="1516464">*</span><span class="ident" id="1516465">sliceStruct</span><span class="op" id="1516476">)</span><span class="op" id="1516477">(</span><span class="ident" id="1516478">unsafe</span><span class="op" id="1516484">.</span><span class="ident" id="1516485">Pointer</span><span class="op" id="1516492">(</span><span class="op" id="1516493">&amp;</span><span class="ident" id="1516494">ret</span><span class="op" id="1516497">)</span><span class="op" id="1516498">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516502">rp</span><span class="op" id="1516504">.</span><span class="ident" id="1516505">array</span>&nbsp;<span class="op" id="1516511">=</span>&nbsp;<span class="ident" id="1516513">pp</span><span class="op" id="1516515">.</span><span class="ident" id="1516516">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516523">rp</span><span class="op" id="1516525">.</span><span class="builtinfunc" id="1516526">len</span>&nbsp;<span class="op" id="1516530">=</span>&nbsp;<span class="ident" id="1516532">pp</span><span class="op" id="1516534">.</span><span class="builtinfunc" id="1516535">len</span>&nbsp;<span class="op" id="1516539">*</span>&nbsp;<span class="builtintype" id="1516541">int</span><span class="op" id="1516544">(</span><span class="ident" id="1516545">unsafe</span><span class="op" id="1516551">.</span><span class="ident" id="1516552">Sizeof</span><span class="op" id="1516558">(</span><span class="ident" id="1516559">p</span><span class="op" id="1516560">[</span><span class="num" id="1516561">0</span><span class="op" id="1516562">]</span><span class="op" id="1516563">)</span><span class="op" id="1516564">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516567">rp</span><span class="op" id="1516569">.</span><span class="builtinfunc" id="1516570">cap</span>&nbsp;<span class="op" id="1516574">=</span>&nbsp;<span class="ident" id="1516576">rp</span><span class="op" id="1516578">.</span><span class="builtinfunc" id="1516579">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516585">return</span><br>
<span class="lineno"></span><span class="op" id="1516592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1516595">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1516674">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1516759">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1516838">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1516913">//</span><br>
<span class="lineno">420</span><span class="comment" id="1516916">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1516972">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1517038">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1517062">func</span>&nbsp;<span class="ident" id="1517067">CPUProfile</span><span class="op" id="1517077">(</span><span class="op" id="1517078">)</span>&nbsp;<span class="op" id="1517080">[</span><span class="op" id="1517081">]</span><span class="builtintype" id="1517082">byte</span>&nbsp;<span class="op" id="1517087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517090">return</span>&nbsp;<span class="ident" id="1517097">cpuprof</span><span class="op" id="1517104">.</span><span class="ident" id="1517105">getprofile</span><span class="op" id="1517115">(</span><span class="op" id="1517116">)</span><br>
<span class="lineno">425</span><span class="op" id="1517118">}</span>
</div>
</body>
</html>
