<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/textproto</h2>
<ul>
<li><a href="/gostd/net/textproto/header.go.html">header.go</a></li>
<li><a href="/gostd/net/textproto/pipeline.go.html">pipeline.go</a></li>
<li><a href="/gostd/net/textproto/reader.go.html">reader.go</a></li>
<li><a href="/gostd/net/textproto/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/net/textproto/textproto.go.html">textproto.go</a></li>
<li><a href="/gostd/net/textproto/writer.go.html">writer.go</a></li>
<li><a href="/gostd/net/textproto/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3053809">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3053865">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3053919">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3053970">package</span>&nbsp;<span class="ident" id="3053978">textproto</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3053989">import</span>&nbsp;<span class="op" id="3053996">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3053999">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="3054006">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="3054009">//&nbsp;A&nbsp;Pipeline&nbsp;manages&nbsp;a&nbsp;pipelined&nbsp;in-order&nbsp;request/response&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="comment" id="3054079">//</span><br>
<span class="lineno"></span><span class="comment" id="3054082">//&nbsp;To&nbsp;use&nbsp;a&nbsp;Pipeline&nbsp;p&nbsp;to&nbsp;manage&nbsp;multiple&nbsp;clients&nbsp;on&nbsp;a&nbsp;connection,</span><br>
<span class="lineno"></span><span class="comment" id="3054149">//&nbsp;each&nbsp;client&nbsp;should&nbsp;run:</span><br>
<span class="lineno">15</span><span class="comment" id="3054176">//</span><br>
<span class="lineno"></span><span class="comment" id="3054179">//&nbsp;&nbsp;&nbsp;&nbspid&nbsp;:=&nbsp;p.Next()&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;take&nbsp;a&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="3054214">//</span><br>
<span class="lineno"></span><span class="comment" id="3054217">//&nbsp;&nbsp;&nbsp;&nbspp.StartRequest(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;send&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3054272">//&nbsp;&nbsp;&nbsp;&nbsp«send&nbsp;request»</span><br>
<span class="lineno">20</span><span class="comment" id="3054292">//&nbsp;&nbsp;&nbsp;&nbspp.EndRequest(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;request&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="3054352">//</span><br>
<span class="lineno"></span><span class="comment" id="3054355">//&nbsp;&nbsp;&nbsp;&nbspp.StartResponse(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;read&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3054412">//&nbsp;&nbsp;&nbsp;&nbsp«read&nbsp;response»</span><br>
<span class="lineno"></span><span class="comment" id="3054433">//&nbsp;&nbsp;&nbsp;&nbspp.EndResponse(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;response&nbsp;is&nbsp;read</span><br>
<span class="lineno">25</span><span class="comment" id="3054495">//</span><br>
<span class="lineno"></span><span class="comment" id="3054498">//&nbsp;A&nbsp;pipelined&nbsp;server&nbsp;can&nbsp;use&nbsp;the&nbsp;same&nbsp;calls&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3054558">//&nbsp;responses&nbsp;computed&nbsp;in&nbsp;parallel&nbsp;are&nbsp;written&nbsp;in&nbsp;the&nbsp;correct&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="3054626">type</span>&nbsp;<span class="ident" id="3054631">Pipeline</span>&nbsp;<span class="keyword" id="3054640">struct</span>&nbsp;<span class="op" id="3054647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3054650">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3054659">sync</span><span class="op" id="3054663">.</span><span class="ident" id="3054664">Mutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3054671">id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3054680">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3054686">request</span>&nbsp;&nbsp;<span class="ident" id="3054695">sequencer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3054706">response</span>&nbsp;<span class="ident" id="3054715">sequencer</span><br>
<span class="lineno"></span><span class="op" id="3054725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3054728">//&nbsp;Next&nbsp;returns&nbsp;the&nbsp;next&nbsp;id&nbsp;for&nbsp;a&nbsp;request/response&nbsp;pair.</span><br>
<span class="lineno"></span><span class="keyword" id="3054785">func</span>&nbsp;<span class="op" id="3054790">(</span><span class="ident" id="3054791">p</span>&nbsp;<span class="op" id="3054793">*</span><span class="ident" id="3054794">Pipeline</span><span class="op" id="3054802">)</span>&nbsp;<span class="ident" id="3054804">Next</span><span class="op" id="3054808">(</span><span class="op" id="3054809">)</span>&nbsp;<span class="builtintype" id="3054811">uint</span>&nbsp;<span class="op" id="3054816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3054819">p</span><span class="op" id="3054820">.</span><span class="ident" id="3054821">mu</span><span class="op" id="3054823">.</span><span class="ident" id="3054824">Lock</span><span class="op" id="3054828">(</span><span class="op" id="3054829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3054832">id</span>&nbsp;<span class="op" id="3054835">:=</span>&nbsp;<span class="ident" id="3054838">p</span><span class="op" id="3054839">.</span><span class="ident" id="3054840">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3054844">p</span><span class="op" id="3054845">.</span><span class="ident" id="3054846">id</span><span class="op" id="3054848">++</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3054852">p</span><span class="op" id="3054853">.</span><span class="ident" id="3054854">mu</span><span class="op" id="3054856">.</span><span class="ident" id="3054857">Unlock</span><span class="op" id="3054863">(</span><span class="op" id="3054864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3054867">return</span>&nbsp;<span class="ident" id="3054874">id</span><br>
<span class="lineno"></span><span class="op" id="3054877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3054880">//&nbsp;StartRequest&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;send&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;receive)</span><br>
<span class="lineno">45</span><span class="comment" id="3054963">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="3054997">func</span>&nbsp;<span class="op" id="3055002">(</span><span class="ident" id="3055003">p</span>&nbsp;<span class="op" id="3055005">*</span><span class="ident" id="3055006">Pipeline</span><span class="op" id="3055014">)</span>&nbsp;<span class="ident" id="3055016">StartRequest</span><span class="op" id="3055028">(</span><span class="ident" id="3055029">id</span>&nbsp;<span class="builtintype" id="3055032">uint</span><span class="op" id="3055036">)</span>&nbsp;<span class="op" id="3055038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3055041">p</span><span class="op" id="3055042">.</span><span class="ident" id="3055043">request</span><span class="op" id="3055050">.</span><span class="ident" id="3055051">Start</span><span class="op" id="3055056">(</span><span class="ident" id="3055057">id</span><span class="op" id="3055059">)</span><br>
<span class="lineno"></span><span class="op" id="3055061">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3055064">//&nbsp;EndRequest&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="3055138">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;received).</span><br>
<span class="lineno"></span><span class="keyword" id="3055178">func</span>&nbsp;<span class="op" id="3055183">(</span><span class="ident" id="3055184">p</span>&nbsp;<span class="op" id="3055186">*</span><span class="ident" id="3055187">Pipeline</span><span class="op" id="3055195">)</span>&nbsp;<span class="ident" id="3055197">EndRequest</span><span class="op" id="3055207">(</span><span class="ident" id="3055208">id</span>&nbsp;<span class="builtintype" id="3055211">uint</span><span class="op" id="3055215">)</span>&nbsp;<span class="op" id="3055217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3055220">p</span><span class="op" id="3055221">.</span><span class="ident" id="3055222">request</span><span class="op" id="3055229">.</span><span class="ident" id="3055230">End</span><span class="op" id="3055233">(</span><span class="ident" id="3055234">id</span><span class="op" id="3055236">)</span><br>
<span class="lineno"></span><span class="op" id="3055238">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="3055241">//&nbsp;StartResponse&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;receive&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;send)</span><br>
<span class="lineno"></span><span class="comment" id="3055325">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="3055359">func</span>&nbsp;<span class="op" id="3055364">(</span><span class="ident" id="3055365">p</span>&nbsp;<span class="op" id="3055367">*</span><span class="ident" id="3055368">Pipeline</span><span class="op" id="3055376">)</span>&nbsp;<span class="ident" id="3055378">StartResponse</span><span class="op" id="3055391">(</span><span class="ident" id="3055392">id</span>&nbsp;<span class="builtintype" id="3055395">uint</span><span class="op" id="3055399">)</span>&nbsp;<span class="op" id="3055401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3055404">p</span><span class="op" id="3055405">.</span><span class="ident" id="3055406">response</span><span class="op" id="3055414">.</span><span class="ident" id="3055415">Start</span><span class="op" id="3055420">(</span><span class="ident" id="3055421">id</span><span class="op" id="3055423">)</span><br>
<span class="lineno">60</span><span class="op" id="3055425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3055428">//&nbsp;EndResponse&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;response&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;received</span><br>
<span class="lineno"></span><span class="comment" id="3055508">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;sent).</span><br>
<span class="lineno"></span><span class="keyword" id="3055544">func</span>&nbsp;<span class="op" id="3055549">(</span><span class="ident" id="3055550">p</span>&nbsp;<span class="op" id="3055552">*</span><span class="ident" id="3055553">Pipeline</span><span class="op" id="3055561">)</span>&nbsp;<span class="ident" id="3055563">EndResponse</span><span class="op" id="3055574">(</span><span class="ident" id="3055575">id</span>&nbsp;<span class="builtintype" id="3055578">uint</span><span class="op" id="3055582">)</span>&nbsp;<span class="op" id="3055584">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3055587">p</span><span class="op" id="3055588">.</span><span class="ident" id="3055589">response</span><span class="op" id="3055597">.</span><span class="ident" id="3055598">End</span><span class="op" id="3055601">(</span><span class="ident" id="3055602">id</span><span class="op" id="3055604">)</span><br>
<span class="lineno"></span><span class="op" id="3055606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3055609">//&nbsp;A&nbsp;sequencer&nbsp;schedules&nbsp;a&nbsp;sequence&nbsp;of&nbsp;numbered&nbsp;events&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3055674">//&nbsp;happen&nbsp;in&nbsp;order,&nbsp;one&nbsp;after&nbsp;the&nbsp;other.&nbsp;&nbsp;The&nbsp;event&nbsp;numbering&nbsp;must&nbsp;start</span><br>
<span class="lineno">70</span><span class="comment" id="3055747">//&nbsp;at&nbsp;0&nbsp;and&nbsp;increment&nbsp;without&nbsp;skipping.&nbsp;&nbsp;The&nbsp;event&nbsp;number&nbsp;wraps&nbsp;around</span><br>
<span class="lineno"></span><span class="comment" id="3055818">//&nbsp;safely&nbsp;as&nbsp;long&nbsp;as&nbsp;there&nbsp;are&nbsp;not&nbsp;2^32&nbsp;simultaneous&nbsp;events&nbsp;pending.</span><br>
<span class="lineno"></span><span class="keyword" id="3055887">type</span>&nbsp;<span class="ident" id="3055892">sequencer</span>&nbsp;<span class="keyword" id="3055902">struct</span>&nbsp;<span class="op" id="3055909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3055912">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3055917">sync</span><span class="op" id="3055921">.</span><span class="ident" id="3055922">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3055929">id</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3055934">uint</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3055940">wait</span>&nbsp;<span class="keyword" id="3055945">map</span><span class="op" id="3055948">[</span><span class="builtintype" id="3055949">uint</span><span class="op" id="3055953">]</span><span class="keyword" id="3055954">chan</span>&nbsp;<span class="builtintype" id="3055959">uint</span><br>
<span class="lineno"></span><span class="op" id="3055964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3055967">//&nbsp;Start&nbsp;waits&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;for&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;to&nbsp;begin.</span><br>
<span class="lineno"></span><span class="comment" id="3056035">//&nbsp;That&nbsp;is,&nbsp;except&nbsp;for&nbsp;the&nbsp;first&nbsp;event,&nbsp;it&nbsp;waits&nbsp;until&nbsp;End(id-1)&nbsp;has</span><br>
<span class="lineno">80</span><span class="comment" id="3056104">//&nbsp;been&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="3056120">func</span>&nbsp;<span class="op" id="3056125">(</span><span class="ident" id="3056126">s</span>&nbsp;<span class="op" id="3056128">*</span><span class="ident" id="3056129">sequencer</span><span class="op" id="3056138">)</span>&nbsp;<span class="ident" id="3056140">Start</span><span class="op" id="3056145">(</span><span class="ident" id="3056146">id</span>&nbsp;<span class="builtintype" id="3056149">uint</span><span class="op" id="3056153">)</span>&nbsp;<span class="op" id="3056155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056158">s</span><span class="op" id="3056159">.</span><span class="ident" id="3056160">mu</span><span class="op" id="3056162">.</span><span class="ident" id="3056163">Lock</span><span class="op" id="3056167">(</span><span class="op" id="3056168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3056171">if</span>&nbsp;<span class="ident" id="3056174">s</span><span class="op" id="3056175">.</span><span class="ident" id="3056176">id</span>&nbsp;<span class="op" id="3056179">==</span>&nbsp;<span class="ident" id="3056182">id</span>&nbsp;<span class="op" id="3056185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056189">s</span><span class="op" id="3056190">.</span><span class="ident" id="3056191">mu</span><span class="op" id="3056193">.</span><span class="ident" id="3056194">Unlock</span><span class="op" id="3056200">(</span><span class="op" id="3056201">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3056205">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3056213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056216">c</span>&nbsp;<span class="op" id="3056218">:=</span>&nbsp;<span class="builtinfunc" id="3056221">make</span><span class="op" id="3056225">(</span><span class="keyword" id="3056226">chan</span>&nbsp;<span class="builtintype" id="3056231">uint</span><span class="op" id="3056235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3056238">if</span>&nbsp;<span class="ident" id="3056241">s</span><span class="op" id="3056242">.</span><span class="ident" id="3056243">wait</span>&nbsp;<span class="op" id="3056248">==</span>&nbsp;<span class="ident" id="3056251">nil</span>&nbsp;<span class="op" id="3056255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056259">s</span><span class="op" id="3056260">.</span><span class="ident" id="3056261">wait</span>&nbsp;<span class="op" id="3056266">=</span>&nbsp;<span class="builtinfunc" id="3056268">make</span><span class="op" id="3056272">(</span><span class="keyword" id="3056273">map</span><span class="op" id="3056276">[</span><span class="builtintype" id="3056277">uint</span><span class="op" id="3056281">]</span><span class="keyword" id="3056282">chan</span>&nbsp;<span class="builtintype" id="3056287">uint</span><span class="op" id="3056291">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3056294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056297">s</span><span class="op" id="3056298">.</span><span class="ident" id="3056299">wait</span><span class="op" id="3056303">[</span><span class="ident" id="3056304">id</span><span class="op" id="3056306">]</span>&nbsp;<span class="op" id="3056308">=</span>&nbsp;<span class="ident" id="3056310">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056313">s</span><span class="op" id="3056314">.</span><span class="ident" id="3056315">mu</span><span class="op" id="3056317">.</span><span class="ident" id="3056318">Unlock</span><span class="op" id="3056324">(</span><span class="op" id="3056325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3056328">&lt;-</span><span class="ident" id="3056330">c</span><br>
<span class="lineno"></span><span class="op" id="3056332">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="3056335">//&nbsp;End&nbsp;notifies&nbsp;the&nbsp;sequencer&nbsp;that&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;has&nbsp;completed,</span><br>
<span class="lineno"></span><span class="comment" id="3056407">//&nbsp;allowing&nbsp;it&nbsp;to&nbsp;schedule&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id+1.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3056483">//&nbsp;to&nbsp;call&nbsp;End&nbsp;with&nbsp;an&nbsp;id&nbsp;that&nbsp;is&nbsp;not&nbsp;the&nbsp;number&nbsp;of&nbsp;the&nbsp;active&nbsp;event.</span><br>
<span class="lineno"></span><span class="keyword" id="3056553">func</span>&nbsp;<span class="op" id="3056558">(</span><span class="ident" id="3056559">s</span>&nbsp;<span class="op" id="3056561">*</span><span class="ident" id="3056562">sequencer</span><span class="op" id="3056571">)</span>&nbsp;<span class="ident" id="3056573">End</span><span class="op" id="3056576">(</span><span class="ident" id="3056577">id</span>&nbsp;<span class="builtintype" id="3056580">uint</span><span class="op" id="3056584">)</span>&nbsp;<span class="op" id="3056586">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056589">s</span><span class="op" id="3056590">.</span><span class="ident" id="3056591">mu</span><span class="op" id="3056593">.</span><span class="ident" id="3056594">Lock</span><span class="op" id="3056598">(</span><span class="op" id="3056599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3056602">if</span>&nbsp;<span class="ident" id="3056605">s</span><span class="op" id="3056606">.</span><span class="ident" id="3056607">id</span>&nbsp;<span class="op" id="3056610">!=</span>&nbsp;<span class="ident" id="3056613">id</span>&nbsp;<span class="op" id="3056616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3056620">panic</span><span class="op" id="3056625">(</span><span class="string" id="3056626">&#34;out&nbsp;of&nbsp;sync&#34;</span><span class="op" id="3056639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3056642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056645">id</span><span class="op" id="3056647">++</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056651">s</span><span class="op" id="3056652">.</span><span class="ident" id="3056653">id</span>&nbsp;<span class="op" id="3056656">=</span>&nbsp;<span class="ident" id="3056658">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3056662">if</span>&nbsp;<span class="ident" id="3056665">s</span><span class="op" id="3056666">.</span><span class="ident" id="3056667">wait</span>&nbsp;<span class="op" id="3056672">==</span>&nbsp;<span class="ident" id="3056675">nil</span>&nbsp;<span class="op" id="3056679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056683">s</span><span class="op" id="3056684">.</span><span class="ident" id="3056685">wait</span>&nbsp;<span class="op" id="3056690">=</span>&nbsp;<span class="builtinfunc" id="3056692">make</span><span class="op" id="3056696">(</span><span class="keyword" id="3056697">map</span><span class="op" id="3056700">[</span><span class="builtintype" id="3056701">uint</span><span class="op" id="3056705">]</span><span class="keyword" id="3056706">chan</span>&nbsp;<span class="builtintype" id="3056711">uint</span><span class="op" id="3056715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3056718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056721">c</span><span class="op" id="3056722">,</span>&nbsp;<span class="ident" id="3056724">ok</span>&nbsp;<span class="op" id="3056727">:=</span>&nbsp;<span class="ident" id="3056730">s</span><span class="op" id="3056731">.</span><span class="ident" id="3056732">wait</span><span class="op" id="3056736">[</span><span class="ident" id="3056737">id</span><span class="op" id="3056739">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3056742">if</span>&nbsp;<span class="ident" id="3056745">ok</span>&nbsp;<span class="op" id="3056748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3056752">delete</span><span class="op" id="3056758">(</span><span class="ident" id="3056759">s</span><span class="op" id="3056760">.</span><span class="ident" id="3056761">wait</span><span class="op" id="3056765">,</span>&nbsp;<span class="ident" id="3056767">id</span><span class="op" id="3056769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3056772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056775">s</span><span class="op" id="3056776">.</span><span class="ident" id="3056777">mu</span><span class="op" id="3056779">.</span><span class="ident" id="3056780">Unlock</span><span class="op" id="3056786">(</span><span class="op" id="3056787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3056790">if</span>&nbsp;<span class="ident" id="3056793">ok</span>&nbsp;<span class="op" id="3056796">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3056800">c</span>&nbsp;<span class="op" id="3056802">&lt;-</span>&nbsp;<span class="num" id="3056805">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3056808">}</span><br>
<span class="lineno"></span><span class="op" id="3056810">}</span>
</div>
</body>
</html>
