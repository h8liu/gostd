<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/draw</h2>
<ul>
<li><a href="/gostd/image/draw/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/image/draw/clip_test.go.html">clip_test.go</a></li>
<li><a href="/gostd/image/draw/draw.go.html" class="current">draw.go</a></li>
<li><a href="/gostd/image/draw/draw_test.go.html">draw_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5756814">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5756870">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5756924">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5756975">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="5757029">//</span><br>
<span class="lineno"></span><span class="comment" id="5757032">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="5757104">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="5757154">package</span>&nbsp;<span class="ident" id="5757162">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5757168">import</span>&nbsp;<span class="op" id="5757175">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5757178">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5757187">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="5757201">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5757204">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="5757266">const</span>&nbsp;<span class="ident" id="5757272">m</span>&nbsp;<span class="op" id="5757274">=</span>&nbsp;<span class="num" id="5757276">1</span><span class="op" id="5757277">&lt;&lt;</span><span class="num" id="5757279">16</span>&nbsp;<span class="op" id="5757282">-</span>&nbsp;<span class="num" id="5757284">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5757287">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="5757358">type</span>&nbsp;<span class="ident" id="5757363">Image</span>&nbsp;<span class="keyword" id="5757369">interface</span>&nbsp;<span class="op" id="5757379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5757382">image</span><span class="op" id="5757387">.</span><span class="ident" id="5757388">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5757395">Set</span><span class="op" id="5757398">(</span><span class="ident" id="5757399">x</span><span class="op" id="5757400">,</span>&nbsp;<span class="ident" id="5757402">y</span>&nbsp;<span class="builtintype" id="5757404">int</span><span class="op" id="5757407">,</span>&nbsp;<span class="ident" id="5757409">c</span>&nbsp;<span class="ident" id="5757411">color</span><span class="op" id="5757416">.</span><span class="ident" id="5757417">Color</span><span class="op" id="5757422">)</span><br>
<span class="lineno"></span><span class="op" id="5757424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5757427">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5757473">type</span>&nbsp;<span class="ident" id="5757478">Quantizer</span>&nbsp;<span class="keyword" id="5757488">interface</span>&nbsp;<span class="op" id="5757498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5757501">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5757572">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5757639">Quantize</span><span class="op" id="5757647">(</span><span class="ident" id="5757648">p</span>&nbsp;<span class="ident" id="5757650">color</span><span class="op" id="5757655">.</span><span class="ident" id="5757656">Palette</span><span class="op" id="5757663">,</span>&nbsp;<span class="ident" id="5757665">m</span>&nbsp;<span class="ident" id="5757667">image</span><span class="op" id="5757672">.</span><span class="ident" id="5757673">Image</span><span class="op" id="5757678">)</span>&nbsp;<span class="ident" id="5757680">color</span><span class="op" id="5757685">.</span><span class="ident" id="5757686">Palette</span><br>
<span class="lineno">30</span><span class="op" id="5757694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5757697">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="5757742">type</span>&nbsp;<span class="ident" id="5757747">Op</span>&nbsp;<span class="builtintype" id="5757750">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5757755">const</span>&nbsp;<span class="op" id="5757761">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5757764">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5757811">Over</span>&nbsp;<span class="ident" id="5757816">Op</span>&nbsp;<span class="op" id="5757819">=</span>&nbsp;<span class="ident" id="5757821">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5757827">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5757862">Src</span><br>
<span class="lineno">40</span><span class="op" id="5757866">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5757869">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5757948">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="5757955">func</span>&nbsp;<span class="op" id="5757960">(</span><span class="ident" id="5757961">op</span>&nbsp;<span class="ident" id="5757964">Op</span><span class="op" id="5757966">)</span>&nbsp;<span class="ident" id="5757968">Draw</span><span class="op" id="5757972">(</span><span class="ident" id="5757973">dst</span>&nbsp;<span class="ident" id="5757977">Image</span><span class="op" id="5757982">,</span>&nbsp;<span class="ident" id="5757984">r</span>&nbsp;<span class="ident" id="5757986">image</span><span class="op" id="5757991">.</span><span class="ident" id="5757992">Rectangle</span><span class="op" id="5758001">,</span>&nbsp;<span class="ident" id="5758003">src</span>&nbsp;<span class="ident" id="5758007">image</span><span class="op" id="5758012">.</span><span class="ident" id="5758013">Image</span><span class="op" id="5758018">,</span>&nbsp;<span class="ident" id="5758020">sp</span>&nbsp;<span class="ident" id="5758023">image</span><span class="op" id="5758028">.</span><span class="ident" id="5758029">Point</span><span class="op" id="5758034">)</span>&nbsp;<span class="op" id="5758036">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5758039">DrawMask</span><span class="op" id="5758047">(</span><span class="ident" id="5758048">dst</span><span class="op" id="5758051">,</span>&nbsp;<span class="ident" id="5758053">r</span><span class="op" id="5758054">,</span>&nbsp;<span class="ident" id="5758056">src</span><span class="op" id="5758059">,</span>&nbsp;<span class="ident" id="5758061">sp</span><span class="op" id="5758063">,</span>&nbsp;<span class="builtintype" id="5758065">nil</span><span class="op" id="5758068">,</span>&nbsp;<span class="ident" id="5758070">image</span><span class="op" id="5758075">.</span><span class="ident" id="5758076">Point</span><span class="op" id="5758081">{</span><span class="op" id="5758082">}</span><span class="op" id="5758083">,</span>&nbsp;<span class="ident" id="5758085">op</span><span class="op" id="5758087">)</span><br>
<span class="lineno"></span><span class="op" id="5758089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5758092">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="5758128">type</span>&nbsp;<span class="ident" id="5758133">Drawer</span>&nbsp;<span class="keyword" id="5758140">interface</span>&nbsp;<span class="op" id="5758150">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5758153">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5758219">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5758281">Draw</span><span class="op" id="5758285">(</span><span class="ident" id="5758286">dst</span>&nbsp;<span class="ident" id="5758290">Image</span><span class="op" id="5758295">,</span>&nbsp;<span class="ident" id="5758297">r</span>&nbsp;<span class="ident" id="5758299">image</span><span class="op" id="5758304">.</span><span class="ident" id="5758305">Rectangle</span><span class="op" id="5758314">,</span>&nbsp;<span class="ident" id="5758316">src</span>&nbsp;<span class="ident" id="5758320">image</span><span class="op" id="5758325">.</span><span class="ident" id="5758326">Image</span><span class="op" id="5758331">,</span>&nbsp;<span class="ident" id="5758333">sp</span>&nbsp;<span class="ident" id="5758336">image</span><span class="op" id="5758341">.</span><span class="ident" id="5758342">Point</span><span class="op" id="5758347">)</span><br>
<span class="lineno"></span><span class="op" id="5758349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5758352">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5758428">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="5758442">var</span>&nbsp;<span class="ident" id="5758446">FloydSteinberg</span>&nbsp;<span class="ident" id="5758461">Drawer</span>&nbsp;<span class="op" id="5758468">=</span>&nbsp;<span class="ident" id="5758470">floydSteinberg</span><span class="op" id="5758484">{</span><span class="op" id="5758485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5758488">type</span>&nbsp;<span class="ident" id="5758493">floydSteinberg</span>&nbsp;<span class="keyword" id="5758508">struct</span><span class="op" id="5758514">{</span><span class="op" id="5758515">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5758518">func</span>&nbsp;<span class="op" id="5758523">(</span><span class="ident" id="5758524">floydSteinberg</span><span class="op" id="5758538">)</span>&nbsp;<span class="ident" id="5758540">Draw</span><span class="op" id="5758544">(</span><span class="ident" id="5758545">dst</span>&nbsp;<span class="ident" id="5758549">Image</span><span class="op" id="5758554">,</span>&nbsp;<span class="ident" id="5758556">r</span>&nbsp;<span class="ident" id="5758558">image</span><span class="op" id="5758563">.</span><span class="ident" id="5758564">Rectangle</span><span class="op" id="5758573">,</span>&nbsp;<span class="ident" id="5758575">src</span>&nbsp;<span class="ident" id="5758579">image</span><span class="op" id="5758584">.</span><span class="ident" id="5758585">Image</span><span class="op" id="5758590">,</span>&nbsp;<span class="ident" id="5758592">sp</span>&nbsp;<span class="ident" id="5758595">image</span><span class="op" id="5758600">.</span><span class="ident" id="5758601">Point</span><span class="op" id="5758606">)</span>&nbsp;<span class="op" id="5758608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5758611">clip</span><span class="op" id="5758615">(</span><span class="ident" id="5758616">dst</span><span class="op" id="5758619">,</span>&nbsp;<span class="op" id="5758621">&amp;</span><span class="ident" id="5758622">r</span><span class="op" id="5758623">,</span>&nbsp;<span class="ident" id="5758625">src</span><span class="op" id="5758628">,</span>&nbsp;<span class="op" id="5758630">&amp;</span><span class="ident" id="5758631">sp</span><span class="op" id="5758633">,</span>&nbsp;<span class="builtintype" id="5758635">nil</span><span class="op" id="5758638">,</span>&nbsp;<span class="builtintype" id="5758640">nil</span><span class="op" id="5758643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5758646">if</span>&nbsp;<span class="ident" id="5758649">r</span><span class="op" id="5758650">.</span><span class="ident" id="5758651">Empty</span><span class="op" id="5758656">(</span><span class="op" id="5758657">)</span>&nbsp;<span class="op" id="5758659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5758663">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5758671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5758674">drawPaletted</span><span class="op" id="5758686">(</span><span class="ident" id="5758687">dst</span><span class="op" id="5758690">,</span>&nbsp;<span class="ident" id="5758692">r</span><span class="op" id="5758693">,</span>&nbsp;<span class="ident" id="5758695">src</span><span class="op" id="5758698">,</span>&nbsp;<span class="ident" id="5758700">sp</span><span class="op" id="5758702">,</span>&nbsp;<span class="builtintype" id="5758704">true</span><span class="op" id="5758708">)</span><br>
<span class="lineno"></span><span class="op" id="5758710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5758713">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="5758785">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5758862">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="5758905">func</span>&nbsp;<span class="ident" id="5758910">clip</span><span class="op" id="5758914">(</span><span class="ident" id="5758915">dst</span>&nbsp;<span class="ident" id="5758919">Image</span><span class="op" id="5758924">,</span>&nbsp;<span class="ident" id="5758926">r</span>&nbsp;<span class="op" id="5758928">*</span><span class="ident" id="5758929">image</span><span class="op" id="5758934">.</span><span class="ident" id="5758935">Rectangle</span><span class="op" id="5758944">,</span>&nbsp;<span class="ident" id="5758946">src</span>&nbsp;<span class="ident" id="5758950">image</span><span class="op" id="5758955">.</span><span class="ident" id="5758956">Image</span><span class="op" id="5758961">,</span>&nbsp;<span class="ident" id="5758963">sp</span>&nbsp;<span class="op" id="5758966">*</span><span class="ident" id="5758967">image</span><span class="op" id="5758972">.</span><span class="ident" id="5758973">Point</span><span class="op" id="5758978">,</span>&nbsp;<span class="ident" id="5758980">mask</span>&nbsp;<span class="ident" id="5758985">image</span><span class="op" id="5758990">.</span><span class="ident" id="5758991">Image</span><span class="op" id="5758996">,</span>&nbsp;<span class="ident" id="5758998">mp</span>&nbsp;<span class="op" id="5759001">*</span><span class="ident" id="5759002">image</span><span class="op" id="5759007">.</span><span class="ident" id="5759008">Point</span><span class="op" id="5759013">)</span>&nbsp;<span class="op" id="5759015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5759018">orig</span>&nbsp;<span class="op" id="5759023">:=</span>&nbsp;<span class="ident" id="5759026">r</span><span class="op" id="5759027">.</span><span class="ident" id="5759028">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5759033">*</span><span class="ident" id="5759034">r</span>&nbsp;<span class="op" id="5759036">=</span>&nbsp;<span class="ident" id="5759038">r</span><span class="op" id="5759039">.</span><span class="ident" id="5759040">Intersect</span><span class="op" id="5759049">(</span><span class="ident" id="5759050">dst</span><span class="op" id="5759053">.</span><span class="ident" id="5759054">Bounds</span><span class="op" id="5759060">(</span><span class="op" id="5759061">)</span><span class="op" id="5759062">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5759065">*</span><span class="ident" id="5759066">r</span>&nbsp;<span class="op" id="5759068">=</span>&nbsp;<span class="ident" id="5759070">r</span><span class="op" id="5759071">.</span><span class="ident" id="5759072">Intersect</span><span class="op" id="5759081">(</span><span class="ident" id="5759082">src</span><span class="op" id="5759085">.</span><span class="ident" id="5759086">Bounds</span><span class="op" id="5759092">(</span><span class="op" id="5759093">)</span><span class="op" id="5759094">.</span><span class="ident" id="5759095">Add</span><span class="op" id="5759098">(</span><span class="ident" id="5759099">orig</span><span class="op" id="5759103">.</span><span class="ident" id="5759104">Sub</span><span class="op" id="5759107">(</span><span class="op" id="5759108">*</span><span class="ident" id="5759109">sp</span><span class="op" id="5759111">)</span><span class="op" id="5759112">)</span><span class="op" id="5759113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5759116">if</span>&nbsp;<span class="ident" id="5759119">mask</span>&nbsp;<span class="op" id="5759124">!=</span>&nbsp;<span class="builtintype" id="5759127">nil</span>&nbsp;<span class="op" id="5759131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5759135">*</span><span class="ident" id="5759136">r</span>&nbsp;<span class="op" id="5759138">=</span>&nbsp;<span class="ident" id="5759140">r</span><span class="op" id="5759141">.</span><span class="ident" id="5759142">Intersect</span><span class="op" id="5759151">(</span><span class="ident" id="5759152">mask</span><span class="op" id="5759156">.</span><span class="ident" id="5759157">Bounds</span><span class="op" id="5759163">(</span><span class="op" id="5759164">)</span><span class="op" id="5759165">.</span><span class="ident" id="5759166">Add</span><span class="op" id="5759169">(</span><span class="ident" id="5759170">orig</span><span class="op" id="5759174">.</span><span class="ident" id="5759175">Sub</span><span class="op" id="5759178">(</span><span class="op" id="5759179">*</span><span class="ident" id="5759180">mp</span><span class="op" id="5759182">)</span><span class="op" id="5759183">)</span><span class="op" id="5759184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5759187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5759190">dx</span>&nbsp;<span class="op" id="5759193">:=</span>&nbsp;<span class="ident" id="5759196">r</span><span class="op" id="5759197">.</span><span class="ident" id="5759198">Min</span><span class="op" id="5759201">.</span><span class="ident" id="5759202">X</span>&nbsp;<span class="op" id="5759204">-</span>&nbsp;<span class="ident" id="5759206">orig</span><span class="op" id="5759210">.</span><span class="ident" id="5759211">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5759214">dy</span>&nbsp;<span class="op" id="5759217">:=</span>&nbsp;<span class="ident" id="5759220">r</span><span class="op" id="5759221">.</span><span class="ident" id="5759222">Min</span><span class="op" id="5759225">.</span><span class="ident" id="5759226">Y</span>&nbsp;<span class="op" id="5759228">-</span>&nbsp;<span class="ident" id="5759230">orig</span><span class="op" id="5759234">.</span><span class="ident" id="5759235">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5759238">if</span>&nbsp;<span class="ident" id="5759241">dx</span>&nbsp;<span class="op" id="5759244">==</span>&nbsp;<span class="num" id="5759247">0</span>&nbsp;<span class="op" id="5759249">&amp;&amp;</span>&nbsp;<span class="ident" id="5759252">dy</span>&nbsp;<span class="op" id="5759255">==</span>&nbsp;<span class="num" id="5759258">0</span>&nbsp;<span class="op" id="5759260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5759264">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5759272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5759275">(</span><span class="op" id="5759276">*</span><span class="ident" id="5759277">sp</span><span class="op" id="5759279">)</span><span class="op" id="5759280">.</span><span class="ident" id="5759281">X</span>&nbsp;<span class="op" id="5759283">+=</span>&nbsp;<span class="ident" id="5759286">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5759290">(</span><span class="op" id="5759291">*</span><span class="ident" id="5759292">sp</span><span class="op" id="5759294">)</span><span class="op" id="5759295">.</span><span class="ident" id="5759296">Y</span>&nbsp;<span class="op" id="5759298">+=</span>&nbsp;<span class="ident" id="5759301">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5759305">(</span><span class="op" id="5759306">*</span><span class="ident" id="5759307">mp</span><span class="op" id="5759309">)</span><span class="op" id="5759310">.</span><span class="ident" id="5759311">X</span>&nbsp;<span class="op" id="5759313">+=</span>&nbsp;<span class="ident" id="5759316">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5759320">(</span><span class="op" id="5759321">*</span><span class="ident" id="5759322">mp</span><span class="op" id="5759324">)</span><span class="op" id="5759325">.</span><span class="ident" id="5759326">Y</span>&nbsp;<span class="op" id="5759328">+=</span>&nbsp;<span class="ident" id="5759331">dy</span><br>
<span class="lineno"></span><span class="op" id="5759334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="5759337">func</span>&nbsp;<span class="ident" id="5759342">processBackward</span><span class="op" id="5759357">(</span><span class="ident" id="5759358">dst</span>&nbsp;<span class="ident" id="5759362">Image</span><span class="op" id="5759367">,</span>&nbsp;<span class="ident" id="5759369">r</span>&nbsp;<span class="ident" id="5759371">image</span><span class="op" id="5759376">.</span><span class="ident" id="5759377">Rectangle</span><span class="op" id="5759386">,</span>&nbsp;<span class="ident" id="5759388">src</span>&nbsp;<span class="ident" id="5759392">image</span><span class="op" id="5759397">.</span><span class="ident" id="5759398">Image</span><span class="op" id="5759403">,</span>&nbsp;<span class="ident" id="5759405">sp</span>&nbsp;<span class="ident" id="5759408">image</span><span class="op" id="5759413">.</span><span class="ident" id="5759414">Point</span><span class="op" id="5759419">)</span>&nbsp;<span class="builtintype" id="5759421">bool</span>&nbsp;<span class="op" id="5759426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5759429">return</span>&nbsp;<span class="ident" id="5759436">image</span><span class="op" id="5759441">.</span><span class="ident" id="5759442">Image</span><span class="op" id="5759447">(</span><span class="ident" id="5759448">dst</span><span class="op" id="5759451">)</span>&nbsp;<span class="op" id="5759453">==</span>&nbsp;<span class="ident" id="5759456">src</span>&nbsp;<span class="op" id="5759460">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5759465">r</span><span class="op" id="5759466">.</span><span class="ident" id="5759467">Overlaps</span><span class="op" id="5759475">(</span><span class="ident" id="5759476">r</span><span class="op" id="5759477">.</span><span class="ident" id="5759478">Add</span><span class="op" id="5759481">(</span><span class="ident" id="5759482">sp</span><span class="op" id="5759484">.</span><span class="ident" id="5759485">Sub</span><span class="op" id="5759488">(</span><span class="ident" id="5759489">r</span><span class="op" id="5759490">.</span><span class="ident" id="5759491">Min</span><span class="op" id="5759494">)</span><span class="op" id="5759495">)</span><span class="op" id="5759496">)</span>&nbsp;<span class="op" id="5759498">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5759503">(</span><span class="ident" id="5759504">sp</span><span class="op" id="5759506">.</span><span class="ident" id="5759507">Y</span>&nbsp;<span class="op" id="5759509">&lt;</span>&nbsp;<span class="ident" id="5759511">r</span><span class="op" id="5759512">.</span><span class="ident" id="5759513">Min</span><span class="op" id="5759516">.</span><span class="ident" id="5759517">Y</span>&nbsp;<span class="op" id="5759519">||</span>&nbsp;<span class="op" id="5759522">(</span><span class="ident" id="5759523">sp</span><span class="op" id="5759525">.</span><span class="ident" id="5759526">Y</span>&nbsp;<span class="op" id="5759528">==</span>&nbsp;<span class="ident" id="5759531">r</span><span class="op" id="5759532">.</span><span class="ident" id="5759533">Min</span><span class="op" id="5759536">.</span><span class="ident" id="5759537">Y</span>&nbsp;<span class="op" id="5759539">&amp;&amp;</span>&nbsp;<span class="ident" id="5759542">sp</span><span class="op" id="5759544">.</span><span class="ident" id="5759545">X</span>&nbsp;<span class="op" id="5759547">&lt;</span>&nbsp;<span class="ident" id="5759549">r</span><span class="op" id="5759550">.</span><span class="ident" id="5759551">Min</span><span class="op" id="5759554">.</span><span class="ident" id="5759555">X</span><span class="op" id="5759556">)</span><span class="op" id="5759557">)</span><br>
<span class="lineno"></span><span class="op" id="5759559">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5759562">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="5759602">func</span>&nbsp;<span class="ident" id="5759607">Draw</span><span class="op" id="5759611">(</span><span class="ident" id="5759612">dst</span>&nbsp;<span class="ident" id="5759616">Image</span><span class="op" id="5759621">,</span>&nbsp;<span class="ident" id="5759623">r</span>&nbsp;<span class="ident" id="5759625">image</span><span class="op" id="5759630">.</span><span class="ident" id="5759631">Rectangle</span><span class="op" id="5759640">,</span>&nbsp;<span class="ident" id="5759642">src</span>&nbsp;<span class="ident" id="5759646">image</span><span class="op" id="5759651">.</span><span class="ident" id="5759652">Image</span><span class="op" id="5759657">,</span>&nbsp;<span class="ident" id="5759659">sp</span>&nbsp;<span class="ident" id="5759662">image</span><span class="op" id="5759667">.</span><span class="ident" id="5759668">Point</span><span class="op" id="5759673">,</span>&nbsp;<span class="ident" id="5759675">op</span>&nbsp;<span class="ident" id="5759678">Op</span><span class="op" id="5759680">)</span>&nbsp;<span class="op" id="5759682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5759685">DrawMask</span><span class="op" id="5759693">(</span><span class="ident" id="5759694">dst</span><span class="op" id="5759697">,</span>&nbsp;<span class="ident" id="5759699">r</span><span class="op" id="5759700">,</span>&nbsp;<span class="ident" id="5759702">src</span><span class="op" id="5759705">,</span>&nbsp;<span class="ident" id="5759707">sp</span><span class="op" id="5759709">,</span>&nbsp;<span class="builtintype" id="5759711">nil</span><span class="op" id="5759714">,</span>&nbsp;<span class="ident" id="5759716">image</span><span class="op" id="5759721">.</span><span class="ident" id="5759722">Point</span><span class="op" id="5759727">{</span><span class="op" id="5759728">}</span><span class="op" id="5759729">,</span>&nbsp;<span class="ident" id="5759731">op</span><span class="op" id="5759733">)</span><br>
<span class="lineno"></span><span class="op" id="5759735">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5759738">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5759834">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5759923">func</span>&nbsp;<span class="ident" id="5759928">DrawMask</span><span class="op" id="5759936">(</span><span class="ident" id="5759937">dst</span>&nbsp;<span class="ident" id="5759941">Image</span><span class="op" id="5759946">,</span>&nbsp;<span class="ident" id="5759948">r</span>&nbsp;<span class="ident" id="5759950">image</span><span class="op" id="5759955">.</span><span class="ident" id="5759956">Rectangle</span><span class="op" id="5759965">,</span>&nbsp;<span class="ident" id="5759967">src</span>&nbsp;<span class="ident" id="5759971">image</span><span class="op" id="5759976">.</span><span class="ident" id="5759977">Image</span><span class="op" id="5759982">,</span>&nbsp;<span class="ident" id="5759984">sp</span>&nbsp;<span class="ident" id="5759987">image</span><span class="op" id="5759992">.</span><span class="ident" id="5759993">Point</span><span class="op" id="5759998">,</span>&nbsp;<span class="ident" id="5760000">mask</span>&nbsp;<span class="ident" id="5760005">image</span><span class="op" id="5760010">.</span><span class="ident" id="5760011">Image</span><span class="op" id="5760016">,</span>&nbsp;<span class="ident" id="5760018">mp</span>&nbsp;<span class="ident" id="5760021">image</span><span class="op" id="5760026">.</span><span class="ident" id="5760027">Point</span><span class="op" id="5760032">,</span>&nbsp;<span class="ident" id="5760034">op</span>&nbsp;<span class="ident" id="5760037">Op</span><span class="op" id="5760039">)</span>&nbsp;<span class="op" id="5760041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5760044">clip</span><span class="op" id="5760048">(</span><span class="ident" id="5760049">dst</span><span class="op" id="5760052">,</span>&nbsp;<span class="op" id="5760054">&amp;</span><span class="ident" id="5760055">r</span><span class="op" id="5760056">,</span>&nbsp;<span class="ident" id="5760058">src</span><span class="op" id="5760061">,</span>&nbsp;<span class="op" id="5760063">&amp;</span><span class="ident" id="5760064">sp</span><span class="op" id="5760066">,</span>&nbsp;<span class="ident" id="5760068">mask</span><span class="op" id="5760072">,</span>&nbsp;<span class="op" id="5760074">&amp;</span><span class="ident" id="5760075">mp</span><span class="op" id="5760077">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760080">if</span>&nbsp;<span class="ident" id="5760083">r</span><span class="op" id="5760084">.</span><span class="ident" id="5760085">Empty</span><span class="op" id="5760090">(</span><span class="op" id="5760091">)</span>&nbsp;<span class="op" id="5760093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760097">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5760105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5760109">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760222">switch</span>&nbsp;<span class="ident" id="5760229">dst0</span>&nbsp;<span class="op" id="5760234">:=</span>&nbsp;<span class="ident" id="5760237">dst</span><span class="op" id="5760240">.</span><span class="op" id="5760241">(</span><span class="keyword" id="5760242">type</span><span class="op" id="5760246">)</span>&nbsp;<span class="op" id="5760248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760251">case</span>&nbsp;<span class="op" id="5760256">*</span><span class="ident" id="5760257">image</span><span class="op" id="5760262">.</span><span class="ident" id="5760263">RGBA</span><span class="op" id="5760267">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760271">if</span>&nbsp;<span class="ident" id="5760274">op</span>&nbsp;<span class="op" id="5760277">==</span>&nbsp;<span class="ident" id="5760280">Over</span>&nbsp;<span class="op" id="5760285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760290">if</span>&nbsp;<span class="ident" id="5760293">mask</span>&nbsp;<span class="op" id="5760298">==</span>&nbsp;<span class="builtintype" id="5760301">nil</span>&nbsp;<span class="op" id="5760305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760311">switch</span>&nbsp;<span class="ident" id="5760318">src0</span>&nbsp;<span class="op" id="5760323">:=</span>&nbsp;<span class="ident" id="5760326">src</span><span class="op" id="5760329">.</span><span class="op" id="5760330">(</span><span class="keyword" id="5760331">type</span><span class="op" id="5760335">)</span>&nbsp;<span class="op" id="5760337">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760343">case</span>&nbsp;<span class="op" id="5760348">*</span><span class="ident" id="5760349">image</span><span class="op" id="5760354">.</span><span class="ident" id="5760355">Uniform</span><span class="op" id="5760362">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5760369">drawFillOver</span><span class="op" id="5760381">(</span><span class="ident" id="5760382">dst0</span><span class="op" id="5760386">,</span>&nbsp;<span class="ident" id="5760388">r</span><span class="op" id="5760389">,</span>&nbsp;<span class="ident" id="5760391">src0</span><span class="op" id="5760395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760402">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760413">case</span>&nbsp;<span class="op" id="5760418">*</span><span class="ident" id="5760419">image</span><span class="op" id="5760424">.</span><span class="ident" id="5760425">RGBA</span><span class="op" id="5760429">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5760436">drawCopyOver</span><span class="op" id="5760448">(</span><span class="ident" id="5760449">dst0</span><span class="op" id="5760453">,</span>&nbsp;<span class="ident" id="5760455">r</span><span class="op" id="5760456">,</span>&nbsp;<span class="ident" id="5760458">src0</span><span class="op" id="5760462">,</span>&nbsp;<span class="ident" id="5760464">sp</span><span class="op" id="5760466">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760473">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760484">case</span>&nbsp;<span class="op" id="5760489">*</span><span class="ident" id="5760490">image</span><span class="op" id="5760495">.</span><span class="ident" id="5760496">NRGBA</span><span class="op" id="5760501">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5760508">drawNRGBAOver</span><span class="op" id="5760521">(</span><span class="ident" id="5760522">dst0</span><span class="op" id="5760526">,</span>&nbsp;<span class="ident" id="5760528">r</span><span class="op" id="5760529">,</span>&nbsp;<span class="ident" id="5760531">src0</span><span class="op" id="5760535">,</span>&nbsp;<span class="ident" id="5760537">sp</span><span class="op" id="5760539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760546">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760557">case</span>&nbsp;<span class="op" id="5760562">*</span><span class="ident" id="5760563">image</span><span class="op" id="5760568">.</span><span class="ident" id="5760569">YCbCr</span><span class="op" id="5760574">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760581">if</span>&nbsp;<span class="ident" id="5760584">drawYCbCr</span><span class="op" id="5760593">(</span><span class="ident" id="5760594">dst0</span><span class="op" id="5760598">,</span>&nbsp;<span class="ident" id="5760600">r</span><span class="op" id="5760601">,</span>&nbsp;<span class="ident" id="5760603">src0</span><span class="op" id="5760607">,</span>&nbsp;<span class="ident" id="5760609">sp</span><span class="op" id="5760611">)</span>&nbsp;<span class="op" id="5760613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760621">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5760633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5760639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5760644">}</span>&nbsp;<span class="keyword" id="5760646">else</span>&nbsp;<span class="keyword" id="5760651">if</span>&nbsp;<span class="ident" id="5760654">mask0</span><span class="op" id="5760659">,</span>&nbsp;<span class="ident" id="5760661">ok</span>&nbsp;<span class="op" id="5760664">:=</span>&nbsp;<span class="ident" id="5760667">mask</span><span class="op" id="5760671">.</span><span class="op" id="5760672">(</span><span class="op" id="5760673">*</span><span class="ident" id="5760674">image</span><span class="op" id="5760679">.</span><span class="ident" id="5760680">Alpha</span><span class="op" id="5760685">)</span><span class="op" id="5760686">;</span>&nbsp;<span class="ident" id="5760688">ok</span>&nbsp;<span class="op" id="5760691">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760697">switch</span>&nbsp;<span class="ident" id="5760704">src0</span>&nbsp;<span class="op" id="5760709">:=</span>&nbsp;<span class="ident" id="5760712">src</span><span class="op" id="5760715">.</span><span class="op" id="5760716">(</span><span class="keyword" id="5760717">type</span><span class="op" id="5760721">)</span>&nbsp;<span class="op" id="5760723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760729">case</span>&nbsp;<span class="op" id="5760734">*</span><span class="ident" id="5760735">image</span><span class="op" id="5760740">.</span><span class="ident" id="5760741">Uniform</span><span class="op" id="5760748">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5760755">drawGlyphOver</span><span class="op" id="5760768">(</span><span class="ident" id="5760769">dst0</span><span class="op" id="5760773">,</span>&nbsp;<span class="ident" id="5760775">r</span><span class="op" id="5760776">,</span>&nbsp;<span class="ident" id="5760778">src0</span><span class="op" id="5760782">,</span>&nbsp;<span class="ident" id="5760784">mask0</span><span class="op" id="5760789">,</span>&nbsp;<span class="ident" id="5760791">mp</span><span class="op" id="5760793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760800">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5760811">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5760816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5760820">}</span>&nbsp;<span class="keyword" id="5760822">else</span>&nbsp;<span class="op" id="5760827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760832">if</span>&nbsp;<span class="ident" id="5760835">mask</span>&nbsp;<span class="op" id="5760840">==</span>&nbsp;<span class="builtintype" id="5760843">nil</span>&nbsp;<span class="op" id="5760847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760853">switch</span>&nbsp;<span class="ident" id="5760860">src0</span>&nbsp;<span class="op" id="5760865">:=</span>&nbsp;<span class="ident" id="5760868">src</span><span class="op" id="5760871">.</span><span class="op" id="5760872">(</span><span class="keyword" id="5760873">type</span><span class="op" id="5760877">)</span>&nbsp;<span class="op" id="5760879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760885">case</span>&nbsp;<span class="op" id="5760890">*</span><span class="ident" id="5760891">image</span><span class="op" id="5760896">.</span><span class="ident" id="5760897">Uniform</span><span class="op" id="5760904">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5760911">drawFillSrc</span><span class="op" id="5760922">(</span><span class="ident" id="5760923">dst0</span><span class="op" id="5760927">,</span>&nbsp;<span class="ident" id="5760929">r</span><span class="op" id="5760930">,</span>&nbsp;<span class="ident" id="5760932">src0</span><span class="op" id="5760936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760943">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5760954">case</span>&nbsp;<span class="op" id="5760959">*</span><span class="ident" id="5760960">image</span><span class="op" id="5760965">.</span><span class="ident" id="5760966">RGBA</span><span class="op" id="5760970">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5760977">drawCopySrc</span><span class="op" id="5760988">(</span><span class="ident" id="5760989">dst0</span><span class="op" id="5760993">,</span>&nbsp;<span class="ident" id="5760995">r</span><span class="op" id="5760996">,</span>&nbsp;<span class="ident" id="5760998">src0</span><span class="op" id="5761002">,</span>&nbsp;<span class="ident" id="5761004">sp</span><span class="op" id="5761006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761013">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761024">case</span>&nbsp;<span class="op" id="5761029">*</span><span class="ident" id="5761030">image</span><span class="op" id="5761035">.</span><span class="ident" id="5761036">NRGBA</span><span class="op" id="5761041">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761048">drawNRGBASrc</span><span class="op" id="5761060">(</span><span class="ident" id="5761061">dst0</span><span class="op" id="5761065">,</span>&nbsp;<span class="ident" id="5761067">r</span><span class="op" id="5761068">,</span>&nbsp;<span class="ident" id="5761070">src0</span><span class="op" id="5761074">,</span>&nbsp;<span class="ident" id="5761076">sp</span><span class="op" id="5761078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761085">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761096">case</span>&nbsp;<span class="op" id="5761101">*</span><span class="ident" id="5761102">image</span><span class="op" id="5761107">.</span><span class="ident" id="5761108">YCbCr</span><span class="op" id="5761113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761120">if</span>&nbsp;<span class="ident" id="5761123">drawYCbCr</span><span class="op" id="5761132">(</span><span class="ident" id="5761133">dst0</span><span class="op" id="5761137">,</span>&nbsp;<span class="ident" id="5761139">r</span><span class="op" id="5761140">,</span>&nbsp;<span class="ident" id="5761142">src0</span><span class="op" id="5761146">,</span>&nbsp;<span class="ident" id="5761148">sp</span><span class="op" id="5761150">)</span>&nbsp;<span class="op" id="5761152">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761160">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5761172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5761178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5761183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5761187">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761191">drawRGBA</span><span class="op" id="5761199">(</span><span class="ident" id="5761200">dst0</span><span class="op" id="5761204">,</span>&nbsp;<span class="ident" id="5761206">r</span><span class="op" id="5761207">,</span>&nbsp;<span class="ident" id="5761209">src</span><span class="op" id="5761212">,</span>&nbsp;<span class="ident" id="5761214">sp</span><span class="op" id="5761216">,</span>&nbsp;<span class="ident" id="5761218">mask</span><span class="op" id="5761222">,</span>&nbsp;<span class="ident" id="5761224">mp</span><span class="op" id="5761226">,</span>&nbsp;<span class="ident" id="5761228">op</span><span class="op" id="5761230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761234">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761242">case</span>&nbsp;<span class="op" id="5761247">*</span><span class="ident" id="5761248">image</span><span class="op" id="5761253">.</span><span class="ident" id="5761254">Paletted</span><span class="op" id="5761262">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761266">if</span>&nbsp;<span class="ident" id="5761269">op</span>&nbsp;<span class="op" id="5761272">==</span>&nbsp;<span class="ident" id="5761275">Src</span>&nbsp;<span class="op" id="5761279">&amp;&amp;</span>&nbsp;<span class="ident" id="5761282">mask</span>&nbsp;<span class="op" id="5761287">==</span>&nbsp;<span class="builtintype" id="5761290">nil</span>&nbsp;<span class="op" id="5761294">&amp;&amp;</span>&nbsp;<span class="op" id="5761297">!</span><span class="ident" id="5761298">processBackward</span><span class="op" id="5761313">(</span><span class="ident" id="5761314">dst</span><span class="op" id="5761317">,</span>&nbsp;<span class="ident" id="5761319">r</span><span class="op" id="5761320">,</span>&nbsp;<span class="ident" id="5761322">src</span><span class="op" id="5761325">,</span>&nbsp;<span class="ident" id="5761327">sp</span><span class="op" id="5761329">)</span>&nbsp;<span class="op" id="5761331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761336">drawPaletted</span><span class="op" id="5761348">(</span><span class="ident" id="5761349">dst0</span><span class="op" id="5761353">,</span>&nbsp;<span class="ident" id="5761355">r</span><span class="op" id="5761356">,</span>&nbsp;<span class="ident" id="5761358">src</span><span class="op" id="5761361">,</span>&nbsp;<span class="ident" id="5761363">sp</span><span class="op" id="5761365">,</span>&nbsp;<span class="builtintype" id="5761367">false</span><span class="op" id="5761372">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5761376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5761379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761383">x0</span><span class="op" id="5761385">,</span>&nbsp;<span class="ident" id="5761387">x1</span><span class="op" id="5761389">,</span>&nbsp;<span class="ident" id="5761391">dx</span>&nbsp;<span class="op" id="5761394">:=</span>&nbsp;<span class="ident" id="5761397">r</span><span class="op" id="5761398">.</span><span class="ident" id="5761399">Min</span><span class="op" id="5761402">.</span><span class="ident" id="5761403">X</span><span class="op" id="5761404">,</span>&nbsp;<span class="ident" id="5761406">r</span><span class="op" id="5761407">.</span><span class="ident" id="5761408">Max</span><span class="op" id="5761411">.</span><span class="ident" id="5761412">X</span><span class="op" id="5761413">,</span>&nbsp;<span class="num" id="5761415">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761418">y0</span><span class="op" id="5761420">,</span>&nbsp;<span class="ident" id="5761422">y1</span><span class="op" id="5761424">,</span>&nbsp;<span class="ident" id="5761426">dy</span>&nbsp;<span class="op" id="5761429">:=</span>&nbsp;<span class="ident" id="5761432">r</span><span class="op" id="5761433">.</span><span class="ident" id="5761434">Min</span><span class="op" id="5761437">.</span><span class="ident" id="5761438">Y</span><span class="op" id="5761439">,</span>&nbsp;<span class="ident" id="5761441">r</span><span class="op" id="5761442">.</span><span class="ident" id="5761443">Max</span><span class="op" id="5761446">.</span><span class="ident" id="5761447">Y</span><span class="op" id="5761448">,</span>&nbsp;<span class="num" id="5761450">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761453">if</span>&nbsp;<span class="ident" id="5761456">processBackward</span><span class="op" id="5761471">(</span><span class="ident" id="5761472">dst</span><span class="op" id="5761475">,</span>&nbsp;<span class="ident" id="5761477">r</span><span class="op" id="5761478">,</span>&nbsp;<span class="ident" id="5761480">src</span><span class="op" id="5761483">,</span>&nbsp;<span class="ident" id="5761485">sp</span><span class="op" id="5761487">)</span>&nbsp;<span class="op" id="5761489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761493">x0</span><span class="op" id="5761495">,</span>&nbsp;<span class="ident" id="5761497">x1</span><span class="op" id="5761499">,</span>&nbsp;<span class="ident" id="5761501">dx</span>&nbsp;<span class="op" id="5761504">=</span>&nbsp;<span class="ident" id="5761506">x1</span><span class="op" id="5761508">-</span><span class="num" id="5761509">1</span><span class="op" id="5761510">,</span>&nbsp;<span class="ident" id="5761512">x0</span><span class="op" id="5761514">-</span><span class="num" id="5761515">1</span><span class="op" id="5761516">,</span>&nbsp;<span class="op" id="5761518">-</span><span class="num" id="5761519">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761523">y0</span><span class="op" id="5761525">,</span>&nbsp;<span class="ident" id="5761527">y1</span><span class="op" id="5761529">,</span>&nbsp;<span class="ident" id="5761531">dy</span>&nbsp;<span class="op" id="5761534">=</span>&nbsp;<span class="ident" id="5761536">y1</span><span class="op" id="5761538">-</span><span class="num" id="5761539">1</span><span class="op" id="5761540">,</span>&nbsp;<span class="ident" id="5761542">y0</span><span class="op" id="5761544">-</span><span class="num" id="5761545">1</span><span class="op" id="5761546">,</span>&nbsp;<span class="op" id="5761548">-</span><span class="num" id="5761549">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5761552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761556">var</span>&nbsp;<span class="ident" id="5761560">out</span>&nbsp;<span class="ident" id="5761564">color</span><span class="op" id="5761569">.</span><span class="ident" id="5761570">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761578">sy</span>&nbsp;<span class="op" id="5761581">:=</span>&nbsp;<span class="ident" id="5761584">sp</span><span class="op" id="5761586">.</span><span class="ident" id="5761587">Y</span>&nbsp;<span class="op" id="5761589">+</span>&nbsp;<span class="ident" id="5761591">y0</span>&nbsp;<span class="op" id="5761594">-</span>&nbsp;<span class="ident" id="5761596">r</span><span class="op" id="5761597">.</span><span class="ident" id="5761598">Min</span><span class="op" id="5761601">.</span><span class="ident" id="5761602">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761605">my</span>&nbsp;<span class="op" id="5761608">:=</span>&nbsp;<span class="ident" id="5761611">mp</span><span class="op" id="5761613">.</span><span class="ident" id="5761614">Y</span>&nbsp;<span class="op" id="5761616">+</span>&nbsp;<span class="ident" id="5761618">y0</span>&nbsp;<span class="op" id="5761621">-</span>&nbsp;<span class="ident" id="5761623">r</span><span class="op" id="5761624">.</span><span class="ident" id="5761625">Min</span><span class="op" id="5761628">.</span><span class="ident" id="5761629">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761632">for</span>&nbsp;<span class="ident" id="5761636">y</span>&nbsp;<span class="op" id="5761638">:=</span>&nbsp;<span class="ident" id="5761641">y0</span><span class="op" id="5761643">;</span>&nbsp;<span class="ident" id="5761645">y</span>&nbsp;<span class="op" id="5761647">!=</span>&nbsp;<span class="ident" id="5761650">y1</span><span class="op" id="5761652">;</span>&nbsp;<span class="ident" id="5761654">y</span><span class="op" id="5761655">,</span>&nbsp;<span class="ident" id="5761657">sy</span><span class="op" id="5761659">,</span>&nbsp;<span class="ident" id="5761661">my</span>&nbsp;<span class="op" id="5761664">=</span>&nbsp;<span class="ident" id="5761666">y</span><span class="op" id="5761667">+</span><span class="ident" id="5761668">dy</span><span class="op" id="5761670">,</span>&nbsp;<span class="ident" id="5761672">sy</span><span class="op" id="5761674">+</span><span class="ident" id="5761675">dy</span><span class="op" id="5761677">,</span>&nbsp;<span class="ident" id="5761679">my</span><span class="op" id="5761681">+</span><span class="ident" id="5761682">dy</span>&nbsp;<span class="op" id="5761685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761689">sx</span>&nbsp;<span class="op" id="5761692">:=</span>&nbsp;<span class="ident" id="5761695">sp</span><span class="op" id="5761697">.</span><span class="ident" id="5761698">X</span>&nbsp;<span class="op" id="5761700">+</span>&nbsp;<span class="ident" id="5761702">x0</span>&nbsp;<span class="op" id="5761705">-</span>&nbsp;<span class="ident" id="5761707">r</span><span class="op" id="5761708">.</span><span class="ident" id="5761709">Min</span><span class="op" id="5761712">.</span><span class="ident" id="5761713">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761717">mx</span>&nbsp;<span class="op" id="5761720">:=</span>&nbsp;<span class="ident" id="5761723">mp</span><span class="op" id="5761725">.</span><span class="ident" id="5761726">X</span>&nbsp;<span class="op" id="5761728">+</span>&nbsp;<span class="ident" id="5761730">x0</span>&nbsp;<span class="op" id="5761733">-</span>&nbsp;<span class="ident" id="5761735">r</span><span class="op" id="5761736">.</span><span class="ident" id="5761737">Min</span><span class="op" id="5761740">.</span><span class="ident" id="5761741">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761745">for</span>&nbsp;<span class="ident" id="5761749">x</span>&nbsp;<span class="op" id="5761751">:=</span>&nbsp;<span class="ident" id="5761754">x0</span><span class="op" id="5761756">;</span>&nbsp;<span class="ident" id="5761758">x</span>&nbsp;<span class="op" id="5761760">!=</span>&nbsp;<span class="ident" id="5761763">x1</span><span class="op" id="5761765">;</span>&nbsp;<span class="ident" id="5761767">x</span><span class="op" id="5761768">,</span>&nbsp;<span class="ident" id="5761770">sx</span><span class="op" id="5761772">,</span>&nbsp;<span class="ident" id="5761774">mx</span>&nbsp;<span class="op" id="5761777">=</span>&nbsp;<span class="ident" id="5761779">x</span><span class="op" id="5761780">+</span><span class="ident" id="5761781">dx</span><span class="op" id="5761783">,</span>&nbsp;<span class="ident" id="5761785">sx</span><span class="op" id="5761787">+</span><span class="ident" id="5761788">dx</span><span class="op" id="5761790">,</span>&nbsp;<span class="ident" id="5761792">mx</span><span class="op" id="5761794">+</span><span class="ident" id="5761795">dx</span>&nbsp;<span class="op" id="5761798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761803">ma</span>&nbsp;<span class="op" id="5761806">:=</span>&nbsp;<span class="builtintype" id="5761809">uint32</span><span class="op" id="5761815">(</span><span class="ident" id="5761816">m</span><span class="op" id="5761817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761822">if</span>&nbsp;<span class="ident" id="5761825">mask</span>&nbsp;<span class="op" id="5761830">!=</span>&nbsp;<span class="builtintype" id="5761833">nil</span>&nbsp;<span class="op" id="5761837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761843">_</span><span class="op" id="5761844">,</span>&nbsp;<span class="ident" id="5761846">_</span><span class="op" id="5761847">,</span>&nbsp;<span class="ident" id="5761849">_</span><span class="op" id="5761850">,</span>&nbsp;<span class="ident" id="5761852">ma</span>&nbsp;<span class="op" id="5761855">=</span>&nbsp;<span class="ident" id="5761857">mask</span><span class="op" id="5761861">.</span><span class="ident" id="5761862">At</span><span class="op" id="5761864">(</span><span class="ident" id="5761865">mx</span><span class="op" id="5761867">,</span>&nbsp;<span class="ident" id="5761869">my</span><span class="op" id="5761871">)</span><span class="op" id="5761872">.</span><span class="ident" id="5761873">RGBA</span><span class="op" id="5761877">(</span><span class="op" id="5761878">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5761883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761888">switch</span>&nbsp;<span class="op" id="5761895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761900">case</span>&nbsp;<span class="ident" id="5761905">ma</span>&nbsp;<span class="op" id="5761908">==</span>&nbsp;<span class="num" id="5761911">0</span><span class="op" id="5761912">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5761918">if</span>&nbsp;<span class="ident" id="5761921">op</span>&nbsp;<span class="op" id="5761924">==</span>&nbsp;<span class="ident" id="5761927">Over</span>&nbsp;<span class="op" id="5761932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5761939">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5761953">}</span>&nbsp;<span class="keyword" id="5761955">else</span>&nbsp;<span class="op" id="5761960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5761967">dst</span><span class="op" id="5761970">.</span><span class="ident" id="5761971">Set</span><span class="op" id="5761974">(</span><span class="ident" id="5761975">x</span><span class="op" id="5761976">,</span>&nbsp;<span class="ident" id="5761978">y</span><span class="op" id="5761979">,</span>&nbsp;<span class="ident" id="5761981">color</span><span class="op" id="5761986">.</span><span class="ident" id="5761987">Transparent</span><span class="op" id="5761998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5762004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5762009">case</span>&nbsp;<span class="ident" id="5762014">ma</span>&nbsp;<span class="op" id="5762017">==</span>&nbsp;<span class="ident" id="5762020">m</span>&nbsp;<span class="op" id="5762022">&amp;&amp;</span>&nbsp;<span class="ident" id="5762025">op</span>&nbsp;<span class="op" id="5762028">==</span>&nbsp;<span class="ident" id="5762031">Src</span><span class="op" id="5762034">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762040">dst</span><span class="op" id="5762043">.</span><span class="ident" id="5762044">Set</span><span class="op" id="5762047">(</span><span class="ident" id="5762048">x</span><span class="op" id="5762049">,</span>&nbsp;<span class="ident" id="5762051">y</span><span class="op" id="5762052">,</span>&nbsp;<span class="ident" id="5762054">src</span><span class="op" id="5762057">.</span><span class="ident" id="5762058">At</span><span class="op" id="5762060">(</span><span class="ident" id="5762061">sx</span><span class="op" id="5762063">,</span>&nbsp;<span class="ident" id="5762065">sy</span><span class="op" id="5762067">)</span><span class="op" id="5762068">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5762073">default</span><span class="op" id="5762080">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762086">sr</span><span class="op" id="5762088">,</span>&nbsp;<span class="ident" id="5762090">sg</span><span class="op" id="5762092">,</span>&nbsp;<span class="ident" id="5762094">sb</span><span class="op" id="5762096">,</span>&nbsp;<span class="ident" id="5762098">sa</span>&nbsp;<span class="op" id="5762101">:=</span>&nbsp;<span class="ident" id="5762104">src</span><span class="op" id="5762107">.</span><span class="ident" id="5762108">At</span><span class="op" id="5762110">(</span><span class="ident" id="5762111">sx</span><span class="op" id="5762113">,</span>&nbsp;<span class="ident" id="5762115">sy</span><span class="op" id="5762117">)</span><span class="op" id="5762118">.</span><span class="ident" id="5762119">RGBA</span><span class="op" id="5762123">(</span><span class="op" id="5762124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5762130">if</span>&nbsp;<span class="ident" id="5762133">op</span>&nbsp;<span class="op" id="5762136">==</span>&nbsp;<span class="ident" id="5762139">Over</span>&nbsp;<span class="op" id="5762144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762151">dr</span><span class="op" id="5762153">,</span>&nbsp;<span class="ident" id="5762155">dg</span><span class="op" id="5762157">,</span>&nbsp;<span class="ident" id="5762159">db</span><span class="op" id="5762161">,</span>&nbsp;<span class="ident" id="5762163">da</span>&nbsp;<span class="op" id="5762166">:=</span>&nbsp;<span class="ident" id="5762169">dst</span><span class="op" id="5762172">.</span><span class="ident" id="5762173">At</span><span class="op" id="5762175">(</span><span class="ident" id="5762176">x</span><span class="op" id="5762177">,</span>&nbsp;<span class="ident" id="5762179">y</span><span class="op" id="5762180">)</span><span class="op" id="5762181">.</span><span class="ident" id="5762182">RGBA</span><span class="op" id="5762186">(</span><span class="op" id="5762187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762194">a</span>&nbsp;<span class="op" id="5762196">:=</span>&nbsp;<span class="ident" id="5762199">m</span>&nbsp;<span class="op" id="5762201">-</span>&nbsp;<span class="op" id="5762203">(</span><span class="ident" id="5762204">sa</span>&nbsp;<span class="op" id="5762207">*</span>&nbsp;<span class="ident" id="5762209">ma</span>&nbsp;<span class="op" id="5762212">/</span>&nbsp;<span class="ident" id="5762214">m</span><span class="op" id="5762215">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762222">out</span><span class="op" id="5762225">.</span><span class="ident" id="5762226">R</span>&nbsp;<span class="op" id="5762228">=</span>&nbsp;<span class="builtintype" id="5762230">uint16</span><span class="op" id="5762236">(</span><span class="op" id="5762237">(</span><span class="ident" id="5762238">dr</span><span class="op" id="5762240">*</span><span class="ident" id="5762241">a</span>&nbsp;<span class="op" id="5762243">+</span>&nbsp;<span class="ident" id="5762245">sr</span><span class="op" id="5762247">*</span><span class="ident" id="5762248">ma</span><span class="op" id="5762250">)</span>&nbsp;<span class="op" id="5762252">/</span>&nbsp;<span class="ident" id="5762254">m</span><span class="op" id="5762255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762262">out</span><span class="op" id="5762265">.</span><span class="ident" id="5762266">G</span>&nbsp;<span class="op" id="5762268">=</span>&nbsp;<span class="builtintype" id="5762270">uint16</span><span class="op" id="5762276">(</span><span class="op" id="5762277">(</span><span class="ident" id="5762278">dg</span><span class="op" id="5762280">*</span><span class="ident" id="5762281">a</span>&nbsp;<span class="op" id="5762283">+</span>&nbsp;<span class="ident" id="5762285">sg</span><span class="op" id="5762287">*</span><span class="ident" id="5762288">ma</span><span class="op" id="5762290">)</span>&nbsp;<span class="op" id="5762292">/</span>&nbsp;<span class="ident" id="5762294">m</span><span class="op" id="5762295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762302">out</span><span class="op" id="5762305">.</span><span class="ident" id="5762306">B</span>&nbsp;<span class="op" id="5762308">=</span>&nbsp;<span class="builtintype" id="5762310">uint16</span><span class="op" id="5762316">(</span><span class="op" id="5762317">(</span><span class="ident" id="5762318">db</span><span class="op" id="5762320">*</span><span class="ident" id="5762321">a</span>&nbsp;<span class="op" id="5762323">+</span>&nbsp;<span class="ident" id="5762325">sb</span><span class="op" id="5762327">*</span><span class="ident" id="5762328">ma</span><span class="op" id="5762330">)</span>&nbsp;<span class="op" id="5762332">/</span>&nbsp;<span class="ident" id="5762334">m</span><span class="op" id="5762335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762342">out</span><span class="op" id="5762345">.</span><span class="ident" id="5762346">A</span>&nbsp;<span class="op" id="5762348">=</span>&nbsp;<span class="builtintype" id="5762350">uint16</span><span class="op" id="5762356">(</span><span class="op" id="5762357">(</span><span class="ident" id="5762358">da</span><span class="op" id="5762360">*</span><span class="ident" id="5762361">a</span>&nbsp;<span class="op" id="5762363">+</span>&nbsp;<span class="ident" id="5762365">sa</span><span class="op" id="5762367">*</span><span class="ident" id="5762368">ma</span><span class="op" id="5762370">)</span>&nbsp;<span class="op" id="5762372">/</span>&nbsp;<span class="ident" id="5762374">m</span><span class="op" id="5762375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5762381">}</span>&nbsp;<span class="keyword" id="5762383">else</span>&nbsp;<span class="op" id="5762388">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762395">out</span><span class="op" id="5762398">.</span><span class="ident" id="5762399">R</span>&nbsp;<span class="op" id="5762401">=</span>&nbsp;<span class="builtintype" id="5762403">uint16</span><span class="op" id="5762409">(</span><span class="ident" id="5762410">sr</span>&nbsp;<span class="op" id="5762413">*</span>&nbsp;<span class="ident" id="5762415">ma</span>&nbsp;<span class="op" id="5762418">/</span>&nbsp;<span class="ident" id="5762420">m</span><span class="op" id="5762421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762428">out</span><span class="op" id="5762431">.</span><span class="ident" id="5762432">G</span>&nbsp;<span class="op" id="5762434">=</span>&nbsp;<span class="builtintype" id="5762436">uint16</span><span class="op" id="5762442">(</span><span class="ident" id="5762443">sg</span>&nbsp;<span class="op" id="5762446">*</span>&nbsp;<span class="ident" id="5762448">ma</span>&nbsp;<span class="op" id="5762451">/</span>&nbsp;<span class="ident" id="5762453">m</span><span class="op" id="5762454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762461">out</span><span class="op" id="5762464">.</span><span class="ident" id="5762465">B</span>&nbsp;<span class="op" id="5762467">=</span>&nbsp;<span class="builtintype" id="5762469">uint16</span><span class="op" id="5762475">(</span><span class="ident" id="5762476">sb</span>&nbsp;<span class="op" id="5762479">*</span>&nbsp;<span class="ident" id="5762481">ma</span>&nbsp;<span class="op" id="5762484">/</span>&nbsp;<span class="ident" id="5762486">m</span><span class="op" id="5762487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762494">out</span><span class="op" id="5762497">.</span><span class="ident" id="5762498">A</span>&nbsp;<span class="op" id="5762500">=</span>&nbsp;<span class="builtintype" id="5762502">uint16</span><span class="op" id="5762508">(</span><span class="ident" id="5762509">sa</span>&nbsp;<span class="op" id="5762512">*</span>&nbsp;<span class="ident" id="5762514">ma</span>&nbsp;<span class="op" id="5762517">/</span>&nbsp;<span class="ident" id="5762519">m</span><span class="op" id="5762520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5762526">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5762532">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5762593">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5762658">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5762721">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762782">dst</span><span class="op" id="5762785">.</span><span class="ident" id="5762786">Set</span><span class="op" id="5762789">(</span><span class="ident" id="5762790">x</span><span class="op" id="5762791">,</span>&nbsp;<span class="ident" id="5762793">y</span><span class="op" id="5762794">,</span>&nbsp;<span class="op" id="5762796">&amp;</span><span class="ident" id="5762797">out</span><span class="op" id="5762800">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5762805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5762809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5762812">}</span><br>
<span class="lineno"></span><span class="op" id="5762814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="5762817">func</span>&nbsp;<span class="ident" id="5762822">drawFillOver</span><span class="op" id="5762834">(</span><span class="ident" id="5762835">dst</span>&nbsp;<span class="op" id="5762839">*</span><span class="ident" id="5762840">image</span><span class="op" id="5762845">.</span><span class="ident" id="5762846">RGBA</span><span class="op" id="5762850">,</span>&nbsp;<span class="ident" id="5762852">r</span>&nbsp;<span class="ident" id="5762854">image</span><span class="op" id="5762859">.</span><span class="ident" id="5762860">Rectangle</span><span class="op" id="5762869">,</span>&nbsp;<span class="ident" id="5762871">src</span>&nbsp;<span class="op" id="5762875">*</span><span class="ident" id="5762876">image</span><span class="op" id="5762881">.</span><span class="ident" id="5762882">Uniform</span><span class="op" id="5762889">)</span>&nbsp;<span class="op" id="5762891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762894">sr</span><span class="op" id="5762896">,</span>&nbsp;<span class="ident" id="5762898">sg</span><span class="op" id="5762900">,</span>&nbsp;<span class="ident" id="5762902">sb</span><span class="op" id="5762904">,</span>&nbsp;<span class="ident" id="5762906">sa</span>&nbsp;<span class="op" id="5762909">:=</span>&nbsp;<span class="ident" id="5762912">src</span><span class="op" id="5762915">.</span><span class="ident" id="5762916">RGBA</span><span class="op" id="5762920">(</span><span class="op" id="5762921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5762924">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762982">a</span>&nbsp;<span class="op" id="5762984">:=</span>&nbsp;<span class="op" id="5762987">(</span><span class="ident" id="5762988">m</span>&nbsp;<span class="op" id="5762990">-</span>&nbsp;<span class="ident" id="5762992">sa</span><span class="op" id="5762994">)</span>&nbsp;<span class="op" id="5762996">*</span>&nbsp;<span class="num" id="5762998">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763005">i0</span>&nbsp;<span class="op" id="5763008">:=</span>&nbsp;<span class="ident" id="5763011">dst</span><span class="op" id="5763014">.</span><span class="ident" id="5763015">PixOffset</span><span class="op" id="5763024">(</span><span class="ident" id="5763025">r</span><span class="op" id="5763026">.</span><span class="ident" id="5763027">Min</span><span class="op" id="5763030">.</span><span class="ident" id="5763031">X</span><span class="op" id="5763032">,</span>&nbsp;<span class="ident" id="5763034">r</span><span class="op" id="5763035">.</span><span class="ident" id="5763036">Min</span><span class="op" id="5763039">.</span><span class="ident" id="5763040">Y</span><span class="op" id="5763041">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763044">i1</span>&nbsp;<span class="op" id="5763047">:=</span>&nbsp;<span class="ident" id="5763050">i0</span>&nbsp;<span class="op" id="5763053">+</span>&nbsp;<span class="ident" id="5763055">r</span><span class="op" id="5763056">.</span><span class="ident" id="5763057">Dx</span><span class="op" id="5763059">(</span><span class="op" id="5763060">)</span><span class="op" id="5763061">*</span><span class="num" id="5763062">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5763065">for</span>&nbsp;<span class="ident" id="5763069">y</span>&nbsp;<span class="op" id="5763071">:=</span>&nbsp;<span class="ident" id="5763074">r</span><span class="op" id="5763075">.</span><span class="ident" id="5763076">Min</span><span class="op" id="5763079">.</span><span class="ident" id="5763080">Y</span><span class="op" id="5763081">;</span>&nbsp;<span class="ident" id="5763083">y</span>&nbsp;<span class="op" id="5763085">!=</span>&nbsp;<span class="ident" id="5763088">r</span><span class="op" id="5763089">.</span><span class="ident" id="5763090">Max</span><span class="op" id="5763093">.</span><span class="ident" id="5763094">Y</span><span class="op" id="5763095">;</span>&nbsp;<span class="ident" id="5763097">y</span><span class="op" id="5763098">++</span>&nbsp;<span class="op" id="5763101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5763105">for</span>&nbsp;<span class="ident" id="5763109">i</span>&nbsp;<span class="op" id="5763111">:=</span>&nbsp;<span class="ident" id="5763114">i0</span><span class="op" id="5763116">;</span>&nbsp;<span class="ident" id="5763118">i</span>&nbsp;<span class="op" id="5763120">&lt;</span>&nbsp;<span class="ident" id="5763122">i1</span><span class="op" id="5763124">;</span>&nbsp;<span class="ident" id="5763126">i</span>&nbsp;<span class="op" id="5763128">+=</span>&nbsp;<span class="num" id="5763131">4</span>&nbsp;<span class="op" id="5763133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763138">dr</span>&nbsp;<span class="op" id="5763141">:=</span>&nbsp;<span class="builtintype" id="5763144">uint32</span><span class="op" id="5763150">(</span><span class="ident" id="5763151">dst</span><span class="op" id="5763154">.</span><span class="ident" id="5763155">Pix</span><span class="op" id="5763158">[</span><span class="ident" id="5763159">i</span><span class="op" id="5763160">+</span><span class="num" id="5763161">0</span><span class="op" id="5763162">]</span><span class="op" id="5763163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763168">dg</span>&nbsp;<span class="op" id="5763171">:=</span>&nbsp;<span class="builtintype" id="5763174">uint32</span><span class="op" id="5763180">(</span><span class="ident" id="5763181">dst</span><span class="op" id="5763184">.</span><span class="ident" id="5763185">Pix</span><span class="op" id="5763188">[</span><span class="ident" id="5763189">i</span><span class="op" id="5763190">+</span><span class="num" id="5763191">1</span><span class="op" id="5763192">]</span><span class="op" id="5763193">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763198">db</span>&nbsp;<span class="op" id="5763201">:=</span>&nbsp;<span class="builtintype" id="5763204">uint32</span><span class="op" id="5763210">(</span><span class="ident" id="5763211">dst</span><span class="op" id="5763214">.</span><span class="ident" id="5763215">Pix</span><span class="op" id="5763218">[</span><span class="ident" id="5763219">i</span><span class="op" id="5763220">+</span><span class="num" id="5763221">2</span><span class="op" id="5763222">]</span><span class="op" id="5763223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763228">da</span>&nbsp;<span class="op" id="5763231">:=</span>&nbsp;<span class="builtintype" id="5763234">uint32</span><span class="op" id="5763240">(</span><span class="ident" id="5763241">dst</span><span class="op" id="5763244">.</span><span class="ident" id="5763245">Pix</span><span class="op" id="5763248">[</span><span class="ident" id="5763249">i</span><span class="op" id="5763250">+</span><span class="num" id="5763251">3</span><span class="op" id="5763252">]</span><span class="op" id="5763253">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763259">dst</span><span class="op" id="5763262">.</span><span class="ident" id="5763263">Pix</span><span class="op" id="5763266">[</span><span class="ident" id="5763267">i</span><span class="op" id="5763268">+</span><span class="num" id="5763269">0</span><span class="op" id="5763270">]</span>&nbsp;<span class="op" id="5763272">=</span>&nbsp;<span class="builtintype" id="5763274">uint8</span><span class="op" id="5763279">(</span><span class="op" id="5763280">(</span><span class="ident" id="5763281">dr</span><span class="op" id="5763283">*</span><span class="ident" id="5763284">a</span><span class="op" id="5763285">/</span><span class="ident" id="5763286">m</span>&nbsp;<span class="op" id="5763288">+</span>&nbsp;<span class="ident" id="5763290">sr</span><span class="op" id="5763292">)</span>&nbsp;<span class="op" id="5763294">&gt;&gt;</span>&nbsp;<span class="num" id="5763297">8</span><span class="op" id="5763298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763303">dst</span><span class="op" id="5763306">.</span><span class="ident" id="5763307">Pix</span><span class="op" id="5763310">[</span><span class="ident" id="5763311">i</span><span class="op" id="5763312">+</span><span class="num" id="5763313">1</span><span class="op" id="5763314">]</span>&nbsp;<span class="op" id="5763316">=</span>&nbsp;<span class="builtintype" id="5763318">uint8</span><span class="op" id="5763323">(</span><span class="op" id="5763324">(</span><span class="ident" id="5763325">dg</span><span class="op" id="5763327">*</span><span class="ident" id="5763328">a</span><span class="op" id="5763329">/</span><span class="ident" id="5763330">m</span>&nbsp;<span class="op" id="5763332">+</span>&nbsp;<span class="ident" id="5763334">sg</span><span class="op" id="5763336">)</span>&nbsp;<span class="op" id="5763338">&gt;&gt;</span>&nbsp;<span class="num" id="5763341">8</span><span class="op" id="5763342">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763347">dst</span><span class="op" id="5763350">.</span><span class="ident" id="5763351">Pix</span><span class="op" id="5763354">[</span><span class="ident" id="5763355">i</span><span class="op" id="5763356">+</span><span class="num" id="5763357">2</span><span class="op" id="5763358">]</span>&nbsp;<span class="op" id="5763360">=</span>&nbsp;<span class="builtintype" id="5763362">uint8</span><span class="op" id="5763367">(</span><span class="op" id="5763368">(</span><span class="ident" id="5763369">db</span><span class="op" id="5763371">*</span><span class="ident" id="5763372">a</span><span class="op" id="5763373">/</span><span class="ident" id="5763374">m</span>&nbsp;<span class="op" id="5763376">+</span>&nbsp;<span class="ident" id="5763378">sb</span><span class="op" id="5763380">)</span>&nbsp;<span class="op" id="5763382">&gt;&gt;</span>&nbsp;<span class="num" id="5763385">8</span><span class="op" id="5763386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763391">dst</span><span class="op" id="5763394">.</span><span class="ident" id="5763395">Pix</span><span class="op" id="5763398">[</span><span class="ident" id="5763399">i</span><span class="op" id="5763400">+</span><span class="num" id="5763401">3</span><span class="op" id="5763402">]</span>&nbsp;<span class="op" id="5763404">=</span>&nbsp;<span class="builtintype" id="5763406">uint8</span><span class="op" id="5763411">(</span><span class="op" id="5763412">(</span><span class="ident" id="5763413">da</span><span class="op" id="5763415">*</span><span class="ident" id="5763416">a</span><span class="op" id="5763417">/</span><span class="ident" id="5763418">m</span>&nbsp;<span class="op" id="5763420">+</span>&nbsp;<span class="ident" id="5763422">sa</span><span class="op" id="5763424">)</span>&nbsp;<span class="op" id="5763426">&gt;&gt;</span>&nbsp;<span class="num" id="5763429">8</span><span class="op" id="5763430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5763434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763438">i0</span>&nbsp;<span class="op" id="5763441">+=</span>&nbsp;<span class="ident" id="5763444">dst</span><span class="op" id="5763447">.</span><span class="ident" id="5763448">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763457">i1</span>&nbsp;<span class="op" id="5763460">+=</span>&nbsp;<span class="ident" id="5763463">dst</span><span class="op" id="5763466">.</span><span class="ident" id="5763467">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5763475">}</span><br>
<span class="lineno"></span><span class="op" id="5763477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5763480">func</span>&nbsp;<span class="ident" id="5763485">drawFillSrc</span><span class="op" id="5763496">(</span><span class="ident" id="5763497">dst</span>&nbsp;<span class="op" id="5763501">*</span><span class="ident" id="5763502">image</span><span class="op" id="5763507">.</span><span class="ident" id="5763508">RGBA</span><span class="op" id="5763512">,</span>&nbsp;<span class="ident" id="5763514">r</span>&nbsp;<span class="ident" id="5763516">image</span><span class="op" id="5763521">.</span><span class="ident" id="5763522">Rectangle</span><span class="op" id="5763531">,</span>&nbsp;<span class="ident" id="5763533">src</span>&nbsp;<span class="op" id="5763537">*</span><span class="ident" id="5763538">image</span><span class="op" id="5763543">.</span><span class="ident" id="5763544">Uniform</span><span class="op" id="5763551">)</span>&nbsp;<span class="op" id="5763553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763556">sr</span><span class="op" id="5763558">,</span>&nbsp;<span class="ident" id="5763560">sg</span><span class="op" id="5763562">,</span>&nbsp;<span class="ident" id="5763564">sb</span><span class="op" id="5763566">,</span>&nbsp;<span class="ident" id="5763568">sa</span>&nbsp;<span class="op" id="5763571">:=</span>&nbsp;<span class="ident" id="5763574">src</span><span class="op" id="5763577">.</span><span class="ident" id="5763578">RGBA</span><span class="op" id="5763582">(</span><span class="op" id="5763583">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5763586">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5763688">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5763792">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763863">i0</span>&nbsp;<span class="op" id="5763866">:=</span>&nbsp;<span class="ident" id="5763869">dst</span><span class="op" id="5763872">.</span><span class="ident" id="5763873">PixOffset</span><span class="op" id="5763882">(</span><span class="ident" id="5763883">r</span><span class="op" id="5763884">.</span><span class="ident" id="5763885">Min</span><span class="op" id="5763888">.</span><span class="ident" id="5763889">X</span><span class="op" id="5763890">,</span>&nbsp;<span class="ident" id="5763892">r</span><span class="op" id="5763893">.</span><span class="ident" id="5763894">Min</span><span class="op" id="5763897">.</span><span class="ident" id="5763898">Y</span><span class="op" id="5763899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763902">i1</span>&nbsp;<span class="op" id="5763905">:=</span>&nbsp;<span class="ident" id="5763908">i0</span>&nbsp;<span class="op" id="5763911">+</span>&nbsp;<span class="ident" id="5763913">r</span><span class="op" id="5763914">.</span><span class="ident" id="5763915">Dx</span><span class="op" id="5763917">(</span><span class="op" id="5763918">)</span><span class="op" id="5763919">*</span><span class="num" id="5763920">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5763923">for</span>&nbsp;<span class="ident" id="5763927">i</span>&nbsp;<span class="op" id="5763929">:=</span>&nbsp;<span class="ident" id="5763932">i0</span><span class="op" id="5763934">;</span>&nbsp;<span class="ident" id="5763936">i</span>&nbsp;<span class="op" id="5763938">&lt;</span>&nbsp;<span class="ident" id="5763940">i1</span><span class="op" id="5763942">;</span>&nbsp;<span class="ident" id="5763944">i</span>&nbsp;<span class="op" id="5763946">+=</span>&nbsp;<span class="num" id="5763949">4</span>&nbsp;<span class="op" id="5763951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763955">dst</span><span class="op" id="5763958">.</span><span class="ident" id="5763959">Pix</span><span class="op" id="5763962">[</span><span class="ident" id="5763963">i</span><span class="op" id="5763964">+</span><span class="num" id="5763965">0</span><span class="op" id="5763966">]</span>&nbsp;<span class="op" id="5763968">=</span>&nbsp;<span class="builtintype" id="5763970">uint8</span><span class="op" id="5763975">(</span><span class="ident" id="5763976">sr</span>&nbsp;<span class="op" id="5763979">&gt;&gt;</span>&nbsp;<span class="num" id="5763982">8</span><span class="op" id="5763983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763987">dst</span><span class="op" id="5763990">.</span><span class="ident" id="5763991">Pix</span><span class="op" id="5763994">[</span><span class="ident" id="5763995">i</span><span class="op" id="5763996">+</span><span class="num" id="5763997">1</span><span class="op" id="5763998">]</span>&nbsp;<span class="op" id="5764000">=</span>&nbsp;<span class="builtintype" id="5764002">uint8</span><span class="op" id="5764007">(</span><span class="ident" id="5764008">sg</span>&nbsp;<span class="op" id="5764011">&gt;&gt;</span>&nbsp;<span class="num" id="5764014">8</span><span class="op" id="5764015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764019">dst</span><span class="op" id="5764022">.</span><span class="ident" id="5764023">Pix</span><span class="op" id="5764026">[</span><span class="ident" id="5764027">i</span><span class="op" id="5764028">+</span><span class="num" id="5764029">2</span><span class="op" id="5764030">]</span>&nbsp;<span class="op" id="5764032">=</span>&nbsp;<span class="builtintype" id="5764034">uint8</span><span class="op" id="5764039">(</span><span class="ident" id="5764040">sb</span>&nbsp;<span class="op" id="5764043">&gt;&gt;</span>&nbsp;<span class="num" id="5764046">8</span><span class="op" id="5764047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764051">dst</span><span class="op" id="5764054">.</span><span class="ident" id="5764055">Pix</span><span class="op" id="5764058">[</span><span class="ident" id="5764059">i</span><span class="op" id="5764060">+</span><span class="num" id="5764061">3</span><span class="op" id="5764062">]</span>&nbsp;<span class="op" id="5764064">=</span>&nbsp;<span class="builtintype" id="5764066">uint8</span><span class="op" id="5764071">(</span><span class="ident" id="5764072">sa</span>&nbsp;<span class="op" id="5764075">&gt;&gt;</span>&nbsp;<span class="num" id="5764078">8</span><span class="op" id="5764079">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5764082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764085">firstRow</span>&nbsp;<span class="op" id="5764094">:=</span>&nbsp;<span class="ident" id="5764097">dst</span><span class="op" id="5764100">.</span><span class="ident" id="5764101">Pix</span><span class="op" id="5764104">[</span><span class="ident" id="5764105">i0</span><span class="op" id="5764107">:</span><span class="ident" id="5764108">i1</span><span class="op" id="5764110">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5764113">for</span>&nbsp;<span class="ident" id="5764117">y</span>&nbsp;<span class="op" id="5764119">:=</span>&nbsp;<span class="ident" id="5764122">r</span><span class="op" id="5764123">.</span><span class="ident" id="5764124">Min</span><span class="op" id="5764127">.</span><span class="ident" id="5764128">Y</span>&nbsp;<span class="op" id="5764130">+</span>&nbsp;<span class="num" id="5764132">1</span><span class="op" id="5764133">;</span>&nbsp;<span class="ident" id="5764135">y</span>&nbsp;<span class="op" id="5764137">&lt;</span>&nbsp;<span class="ident" id="5764139">r</span><span class="op" id="5764140">.</span><span class="ident" id="5764141">Max</span><span class="op" id="5764144">.</span><span class="ident" id="5764145">Y</span><span class="op" id="5764146">;</span>&nbsp;<span class="ident" id="5764148">y</span><span class="op" id="5764149">++</span>&nbsp;<span class="op" id="5764152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764156">i0</span>&nbsp;<span class="op" id="5764159">+=</span>&nbsp;<span class="ident" id="5764162">dst</span><span class="op" id="5764165">.</span><span class="ident" id="5764166">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764175">i1</span>&nbsp;<span class="op" id="5764178">+=</span>&nbsp;<span class="ident" id="5764181">dst</span><span class="op" id="5764184">.</span><span class="ident" id="5764185">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5764194">copy</span><span class="op" id="5764198">(</span><span class="ident" id="5764199">dst</span><span class="op" id="5764202">.</span><span class="ident" id="5764203">Pix</span><span class="op" id="5764206">[</span><span class="ident" id="5764207">i0</span><span class="op" id="5764209">:</span><span class="ident" id="5764210">i1</span><span class="op" id="5764212">]</span><span class="op" id="5764213">,</span>&nbsp;<span class="ident" id="5764215">firstRow</span><span class="op" id="5764223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5764226">}</span><br>
<span class="lineno"></span><span class="op" id="5764228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5764231">func</span>&nbsp;<span class="ident" id="5764236">drawCopyOver</span><span class="op" id="5764248">(</span><span class="ident" id="5764249">dst</span>&nbsp;<span class="op" id="5764253">*</span><span class="ident" id="5764254">image</span><span class="op" id="5764259">.</span><span class="ident" id="5764260">RGBA</span><span class="op" id="5764264">,</span>&nbsp;<span class="ident" id="5764266">r</span>&nbsp;<span class="ident" id="5764268">image</span><span class="op" id="5764273">.</span><span class="ident" id="5764274">Rectangle</span><span class="op" id="5764283">,</span>&nbsp;<span class="ident" id="5764285">src</span>&nbsp;<span class="op" id="5764289">*</span><span class="ident" id="5764290">image</span><span class="op" id="5764295">.</span><span class="ident" id="5764296">RGBA</span><span class="op" id="5764300">,</span>&nbsp;<span class="ident" id="5764302">sp</span>&nbsp;<span class="ident" id="5764305">image</span><span class="op" id="5764310">.</span><span class="ident" id="5764311">Point</span><span class="op" id="5764316">)</span>&nbsp;<span class="op" id="5764318">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764321">dx</span><span class="op" id="5764323">,</span>&nbsp;<span class="ident" id="5764325">dy</span>&nbsp;<span class="op" id="5764328">:=</span>&nbsp;<span class="ident" id="5764331">r</span><span class="op" id="5764332">.</span><span class="ident" id="5764333">Dx</span><span class="op" id="5764335">(</span><span class="op" id="5764336">)</span><span class="op" id="5764337">,</span>&nbsp;<span class="ident" id="5764339">r</span><span class="op" id="5764340">.</span><span class="ident" id="5764341">Dy</span><span class="op" id="5764343">(</span><span class="op" id="5764344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764347">d0</span>&nbsp;<span class="op" id="5764350">:=</span>&nbsp;<span class="ident" id="5764353">dst</span><span class="op" id="5764356">.</span><span class="ident" id="5764357">PixOffset</span><span class="op" id="5764366">(</span><span class="ident" id="5764367">r</span><span class="op" id="5764368">.</span><span class="ident" id="5764369">Min</span><span class="op" id="5764372">.</span><span class="ident" id="5764373">X</span><span class="op" id="5764374">,</span>&nbsp;<span class="ident" id="5764376">r</span><span class="op" id="5764377">.</span><span class="ident" id="5764378">Min</span><span class="op" id="5764381">.</span><span class="ident" id="5764382">Y</span><span class="op" id="5764383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764386">s0</span>&nbsp;<span class="op" id="5764389">:=</span>&nbsp;<span class="ident" id="5764392">src</span><span class="op" id="5764395">.</span><span class="ident" id="5764396">PixOffset</span><span class="op" id="5764405">(</span><span class="ident" id="5764406">sp</span><span class="op" id="5764408">.</span><span class="ident" id="5764409">X</span><span class="op" id="5764410">,</span>&nbsp;<span class="ident" id="5764412">sp</span><span class="op" id="5764414">.</span><span class="ident" id="5764415">Y</span><span class="op" id="5764416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5764419">var</span>&nbsp;<span class="op" id="5764423">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764427">ddelta</span><span class="op" id="5764433">,</span>&nbsp;<span class="ident" id="5764435">sdelta</span>&nbsp;<span class="builtintype" id="5764442">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764448">i0</span><span class="op" id="5764450">,</span>&nbsp;<span class="ident" id="5764452">i1</span><span class="op" id="5764454">,</span>&nbsp;<span class="ident" id="5764456">idelta</span>&nbsp;<span class="builtintype" id="5764463">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5764468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5764471">if</span>&nbsp;<span class="ident" id="5764474">r</span><span class="op" id="5764475">.</span><span class="ident" id="5764476">Min</span><span class="op" id="5764479">.</span><span class="ident" id="5764480">Y</span>&nbsp;<span class="op" id="5764482">&lt;</span>&nbsp;<span class="ident" id="5764484">sp</span><span class="op" id="5764486">.</span><span class="ident" id="5764487">Y</span>&nbsp;<span class="op" id="5764489">||</span>&nbsp;<span class="ident" id="5764492">r</span><span class="op" id="5764493">.</span><span class="ident" id="5764494">Min</span><span class="op" id="5764497">.</span><span class="ident" id="5764498">Y</span>&nbsp;<span class="op" id="5764500">==</span>&nbsp;<span class="ident" id="5764503">sp</span><span class="op" id="5764505">.</span><span class="ident" id="5764506">Y</span>&nbsp;<span class="op" id="5764508">&amp;&amp;</span>&nbsp;<span class="ident" id="5764511">r</span><span class="op" id="5764512">.</span><span class="ident" id="5764513">Min</span><span class="op" id="5764516">.</span><span class="ident" id="5764517">X</span>&nbsp;<span class="op" id="5764519">&lt;=</span>&nbsp;<span class="ident" id="5764522">sp</span><span class="op" id="5764524">.</span><span class="ident" id="5764525">X</span>&nbsp;<span class="op" id="5764527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764531">ddelta</span>&nbsp;<span class="op" id="5764538">=</span>&nbsp;<span class="ident" id="5764540">dst</span><span class="op" id="5764543">.</span><span class="ident" id="5764544">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764553">sdelta</span>&nbsp;<span class="op" id="5764560">=</span>&nbsp;<span class="ident" id="5764562">src</span><span class="op" id="5764565">.</span><span class="ident" id="5764566">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764575">i0</span><span class="op" id="5764577">,</span>&nbsp;<span class="ident" id="5764579">i1</span><span class="op" id="5764581">,</span>&nbsp;<span class="ident" id="5764583">idelta</span>&nbsp;<span class="op" id="5764590">=</span>&nbsp;<span class="num" id="5764592">0</span><span class="op" id="5764593">,</span>&nbsp;<span class="ident" id="5764595">dx</span><span class="op" id="5764597">*</span><span class="num" id="5764598">4</span><span class="op" id="5764599">,</span>&nbsp;<span class="op" id="5764601">+</span><span class="num" id="5764602">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5764605">}</span>&nbsp;<span class="keyword" id="5764607">else</span>&nbsp;<span class="op" id="5764612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5764616">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5764724">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764824">d0</span>&nbsp;<span class="op" id="5764827">+=</span>&nbsp;<span class="op" id="5764830">(</span><span class="ident" id="5764831">dy</span>&nbsp;<span class="op" id="5764834">-</span>&nbsp;<span class="num" id="5764836">1</span><span class="op" id="5764837">)</span>&nbsp;<span class="op" id="5764839">*</span>&nbsp;<span class="ident" id="5764841">dst</span><span class="op" id="5764844">.</span><span class="ident" id="5764845">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764854">s0</span>&nbsp;<span class="op" id="5764857">+=</span>&nbsp;<span class="op" id="5764860">(</span><span class="ident" id="5764861">dy</span>&nbsp;<span class="op" id="5764864">-</span>&nbsp;<span class="num" id="5764866">1</span><span class="op" id="5764867">)</span>&nbsp;<span class="op" id="5764869">*</span>&nbsp;<span class="ident" id="5764871">src</span><span class="op" id="5764874">.</span><span class="ident" id="5764875">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764884">ddelta</span>&nbsp;<span class="op" id="5764891">=</span>&nbsp;<span class="op" id="5764893">-</span><span class="ident" id="5764894">dst</span><span class="op" id="5764897">.</span><span class="ident" id="5764898">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764907">sdelta</span>&nbsp;<span class="op" id="5764914">=</span>&nbsp;<span class="op" id="5764916">-</span><span class="ident" id="5764917">src</span><span class="op" id="5764920">.</span><span class="ident" id="5764921">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764930">i0</span><span class="op" id="5764932">,</span>&nbsp;<span class="ident" id="5764934">i1</span><span class="op" id="5764936">,</span>&nbsp;<span class="ident" id="5764938">idelta</span>&nbsp;<span class="op" id="5764945">=</span>&nbsp;<span class="op" id="5764947">(</span><span class="ident" id="5764948">dx</span><span class="op" id="5764950">-</span><span class="num" id="5764951">1</span><span class="op" id="5764952">)</span><span class="op" id="5764953">*</span><span class="num" id="5764954">4</span><span class="op" id="5764955">,</span>&nbsp;<span class="op" id="5764957">-</span><span class="num" id="5764958">4</span><span class="op" id="5764959">,</span>&nbsp;<span class="op" id="5764961">-</span><span class="num" id="5764962">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5764965">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5764968">for</span>&nbsp;<span class="op" id="5764972">;</span>&nbsp;<span class="ident" id="5764974">dy</span>&nbsp;<span class="op" id="5764977">&gt;</span>&nbsp;<span class="num" id="5764979">0</span><span class="op" id="5764980">;</span>&nbsp;<span class="ident" id="5764982">dy</span><span class="op" id="5764984">--</span>&nbsp;<span class="op" id="5764987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764991">dpix</span>&nbsp;<span class="op" id="5764996">:=</span>&nbsp;<span class="ident" id="5764999">dst</span><span class="op" id="5765002">.</span><span class="ident" id="5765003">Pix</span><span class="op" id="5765006">[</span><span class="ident" id="5765007">d0</span><span class="op" id="5765009">:</span><span class="op" id="5765010">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765014">spix</span>&nbsp;<span class="op" id="5765019">:=</span>&nbsp;<span class="ident" id="5765022">src</span><span class="op" id="5765025">.</span><span class="ident" id="5765026">Pix</span><span class="op" id="5765029">[</span><span class="ident" id="5765030">s0</span><span class="op" id="5765032">:</span><span class="op" id="5765033">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5765037">for</span>&nbsp;<span class="ident" id="5765041">i</span>&nbsp;<span class="op" id="5765043">:=</span>&nbsp;<span class="ident" id="5765046">i0</span><span class="op" id="5765048">;</span>&nbsp;<span class="ident" id="5765050">i</span>&nbsp;<span class="op" id="5765052">!=</span>&nbsp;<span class="ident" id="5765055">i1</span><span class="op" id="5765057">;</span>&nbsp;<span class="ident" id="5765059">i</span>&nbsp;<span class="op" id="5765061">+=</span>&nbsp;<span class="ident" id="5765064">idelta</span>&nbsp;<span class="op" id="5765071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765076">sr</span>&nbsp;<span class="op" id="5765079">:=</span>&nbsp;<span class="builtintype" id="5765082">uint32</span><span class="op" id="5765088">(</span><span class="ident" id="5765089">spix</span><span class="op" id="5765093">[</span><span class="ident" id="5765094">i</span><span class="op" id="5765095">+</span><span class="num" id="5765096">0</span><span class="op" id="5765097">]</span><span class="op" id="5765098">)</span>&nbsp;<span class="op" id="5765100">*</span>&nbsp;<span class="num" id="5765102">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765111">sg</span>&nbsp;<span class="op" id="5765114">:=</span>&nbsp;<span class="builtintype" id="5765117">uint32</span><span class="op" id="5765123">(</span><span class="ident" id="5765124">spix</span><span class="op" id="5765128">[</span><span class="ident" id="5765129">i</span><span class="op" id="5765130">+</span><span class="num" id="5765131">1</span><span class="op" id="5765132">]</span><span class="op" id="5765133">)</span>&nbsp;<span class="op" id="5765135">*</span>&nbsp;<span class="num" id="5765137">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765146">sb</span>&nbsp;<span class="op" id="5765149">:=</span>&nbsp;<span class="builtintype" id="5765152">uint32</span><span class="op" id="5765158">(</span><span class="ident" id="5765159">spix</span><span class="op" id="5765163">[</span><span class="ident" id="5765164">i</span><span class="op" id="5765165">+</span><span class="num" id="5765166">2</span><span class="op" id="5765167">]</span><span class="op" id="5765168">)</span>&nbsp;<span class="op" id="5765170">*</span>&nbsp;<span class="num" id="5765172">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765181">sa</span>&nbsp;<span class="op" id="5765184">:=</span>&nbsp;<span class="builtintype" id="5765187">uint32</span><span class="op" id="5765193">(</span><span class="ident" id="5765194">spix</span><span class="op" id="5765198">[</span><span class="ident" id="5765199">i</span><span class="op" id="5765200">+</span><span class="num" id="5765201">3</span><span class="op" id="5765202">]</span><span class="op" id="5765203">)</span>&nbsp;<span class="op" id="5765205">*</span>&nbsp;<span class="num" id="5765207">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765217">dr</span>&nbsp;<span class="op" id="5765220">:=</span>&nbsp;<span class="builtintype" id="5765223">uint32</span><span class="op" id="5765229">(</span><span class="ident" id="5765230">dpix</span><span class="op" id="5765234">[</span><span class="ident" id="5765235">i</span><span class="op" id="5765236">+</span><span class="num" id="5765237">0</span><span class="op" id="5765238">]</span><span class="op" id="5765239">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765244">dg</span>&nbsp;<span class="op" id="5765247">:=</span>&nbsp;<span class="builtintype" id="5765250">uint32</span><span class="op" id="5765256">(</span><span class="ident" id="5765257">dpix</span><span class="op" id="5765261">[</span><span class="ident" id="5765262">i</span><span class="op" id="5765263">+</span><span class="num" id="5765264">1</span><span class="op" id="5765265">]</span><span class="op" id="5765266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765271">db</span>&nbsp;<span class="op" id="5765274">:=</span>&nbsp;<span class="builtintype" id="5765277">uint32</span><span class="op" id="5765283">(</span><span class="ident" id="5765284">dpix</span><span class="op" id="5765288">[</span><span class="ident" id="5765289">i</span><span class="op" id="5765290">+</span><span class="num" id="5765291">2</span><span class="op" id="5765292">]</span><span class="op" id="5765293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765298">da</span>&nbsp;<span class="op" id="5765301">:=</span>&nbsp;<span class="builtintype" id="5765304">uint32</span><span class="op" id="5765310">(</span><span class="ident" id="5765311">dpix</span><span class="op" id="5765315">[</span><span class="ident" id="5765316">i</span><span class="op" id="5765317">+</span><span class="num" id="5765318">3</span><span class="op" id="5765319">]</span><span class="op" id="5765320">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5765326">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765386">a</span>&nbsp;<span class="op" id="5765388">:=</span>&nbsp;<span class="op" id="5765391">(</span><span class="ident" id="5765392">m</span>&nbsp;<span class="op" id="5765394">-</span>&nbsp;<span class="ident" id="5765396">sa</span><span class="op" id="5765398">)</span>&nbsp;<span class="op" id="5765400">*</span>&nbsp;<span class="num" id="5765402">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765412">dpix</span><span class="op" id="5765416">[</span><span class="ident" id="5765417">i</span><span class="op" id="5765418">+</span><span class="num" id="5765419">0</span><span class="op" id="5765420">]</span>&nbsp;<span class="op" id="5765422">=</span>&nbsp;<span class="builtintype" id="5765424">uint8</span><span class="op" id="5765429">(</span><span class="op" id="5765430">(</span><span class="ident" id="5765431">dr</span><span class="op" id="5765433">*</span><span class="ident" id="5765434">a</span><span class="op" id="5765435">/</span><span class="ident" id="5765436">m</span>&nbsp;<span class="op" id="5765438">+</span>&nbsp;<span class="ident" id="5765440">sr</span><span class="op" id="5765442">)</span>&nbsp;<span class="op" id="5765444">&gt;&gt;</span>&nbsp;<span class="num" id="5765447">8</span><span class="op" id="5765448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765453">dpix</span><span class="op" id="5765457">[</span><span class="ident" id="5765458">i</span><span class="op" id="5765459">+</span><span class="num" id="5765460">1</span><span class="op" id="5765461">]</span>&nbsp;<span class="op" id="5765463">=</span>&nbsp;<span class="builtintype" id="5765465">uint8</span><span class="op" id="5765470">(</span><span class="op" id="5765471">(</span><span class="ident" id="5765472">dg</span><span class="op" id="5765474">*</span><span class="ident" id="5765475">a</span><span class="op" id="5765476">/</span><span class="ident" id="5765477">m</span>&nbsp;<span class="op" id="5765479">+</span>&nbsp;<span class="ident" id="5765481">sg</span><span class="op" id="5765483">)</span>&nbsp;<span class="op" id="5765485">&gt;&gt;</span>&nbsp;<span class="num" id="5765488">8</span><span class="op" id="5765489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765494">dpix</span><span class="op" id="5765498">[</span><span class="ident" id="5765499">i</span><span class="op" id="5765500">+</span><span class="num" id="5765501">2</span><span class="op" id="5765502">]</span>&nbsp;<span class="op" id="5765504">=</span>&nbsp;<span class="builtintype" id="5765506">uint8</span><span class="op" id="5765511">(</span><span class="op" id="5765512">(</span><span class="ident" id="5765513">db</span><span class="op" id="5765515">*</span><span class="ident" id="5765516">a</span><span class="op" id="5765517">/</span><span class="ident" id="5765518">m</span>&nbsp;<span class="op" id="5765520">+</span>&nbsp;<span class="ident" id="5765522">sb</span><span class="op" id="5765524">)</span>&nbsp;<span class="op" id="5765526">&gt;&gt;</span>&nbsp;<span class="num" id="5765529">8</span><span class="op" id="5765530">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765535">dpix</span><span class="op" id="5765539">[</span><span class="ident" id="5765540">i</span><span class="op" id="5765541">+</span><span class="num" id="5765542">3</span><span class="op" id="5765543">]</span>&nbsp;<span class="op" id="5765545">=</span>&nbsp;<span class="builtintype" id="5765547">uint8</span><span class="op" id="5765552">(</span><span class="op" id="5765553">(</span><span class="ident" id="5765554">da</span><span class="op" id="5765556">*</span><span class="ident" id="5765557">a</span><span class="op" id="5765558">/</span><span class="ident" id="5765559">m</span>&nbsp;<span class="op" id="5765561">+</span>&nbsp;<span class="ident" id="5765563">sa</span><span class="op" id="5765565">)</span>&nbsp;<span class="op" id="5765567">&gt;&gt;</span>&nbsp;<span class="num" id="5765570">8</span><span class="op" id="5765571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5765575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765579">d0</span>&nbsp;<span class="op" id="5765582">+=</span>&nbsp;<span class="ident" id="5765585">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765594">s0</span>&nbsp;<span class="op" id="5765597">+=</span>&nbsp;<span class="ident" id="5765600">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5765608">}</span><br>
<span class="lineno">305</span><span class="op" id="5765610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5765613">func</span>&nbsp;<span class="ident" id="5765618">drawCopySrc</span><span class="op" id="5765629">(</span><span class="ident" id="5765630">dst</span>&nbsp;<span class="op" id="5765634">*</span><span class="ident" id="5765635">image</span><span class="op" id="5765640">.</span><span class="ident" id="5765641">RGBA</span><span class="op" id="5765645">,</span>&nbsp;<span class="ident" id="5765647">r</span>&nbsp;<span class="ident" id="5765649">image</span><span class="op" id="5765654">.</span><span class="ident" id="5765655">Rectangle</span><span class="op" id="5765664">,</span>&nbsp;<span class="ident" id="5765666">src</span>&nbsp;<span class="op" id="5765670">*</span><span class="ident" id="5765671">image</span><span class="op" id="5765676">.</span><span class="ident" id="5765677">RGBA</span><span class="op" id="5765681">,</span>&nbsp;<span class="ident" id="5765683">sp</span>&nbsp;<span class="ident" id="5765686">image</span><span class="op" id="5765691">.</span><span class="ident" id="5765692">Point</span><span class="op" id="5765697">)</span>&nbsp;<span class="op" id="5765699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765702">n</span><span class="op" id="5765703">,</span>&nbsp;<span class="ident" id="5765705">dy</span>&nbsp;<span class="op" id="5765708">:=</span>&nbsp;<span class="num" id="5765711">4</span><span class="op" id="5765712">*</span><span class="ident" id="5765713">r</span><span class="op" id="5765714">.</span><span class="ident" id="5765715">Dx</span><span class="op" id="5765717">(</span><span class="op" id="5765718">)</span><span class="op" id="5765719">,</span>&nbsp;<span class="ident" id="5765721">r</span><span class="op" id="5765722">.</span><span class="ident" id="5765723">Dy</span><span class="op" id="5765725">(</span><span class="op" id="5765726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765729">d0</span>&nbsp;<span class="op" id="5765732">:=</span>&nbsp;<span class="ident" id="5765735">dst</span><span class="op" id="5765738">.</span><span class="ident" id="5765739">PixOffset</span><span class="op" id="5765748">(</span><span class="ident" id="5765749">r</span><span class="op" id="5765750">.</span><span class="ident" id="5765751">Min</span><span class="op" id="5765754">.</span><span class="ident" id="5765755">X</span><span class="op" id="5765756">,</span>&nbsp;<span class="ident" id="5765758">r</span><span class="op" id="5765759">.</span><span class="ident" id="5765760">Min</span><span class="op" id="5765763">.</span><span class="ident" id="5765764">Y</span><span class="op" id="5765765">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765768">s0</span>&nbsp;<span class="op" id="5765771">:=</span>&nbsp;<span class="ident" id="5765774">src</span><span class="op" id="5765777">.</span><span class="ident" id="5765778">PixOffset</span><span class="op" id="5765787">(</span><span class="ident" id="5765788">sp</span><span class="op" id="5765790">.</span><span class="ident" id="5765791">X</span><span class="op" id="5765792">,</span>&nbsp;<span class="ident" id="5765794">sp</span><span class="op" id="5765796">.</span><span class="ident" id="5765797">Y</span><span class="op" id="5765798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5765801">var</span>&nbsp;<span class="ident" id="5765805">ddelta</span><span class="op" id="5765811">,</span>&nbsp;<span class="ident" id="5765813">sdelta</span>&nbsp;<span class="builtintype" id="5765820">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5765825">if</span>&nbsp;<span class="ident" id="5765828">r</span><span class="op" id="5765829">.</span><span class="ident" id="5765830">Min</span><span class="op" id="5765833">.</span><span class="ident" id="5765834">Y</span>&nbsp;<span class="op" id="5765836">&lt;=</span>&nbsp;<span class="ident" id="5765839">sp</span><span class="op" id="5765841">.</span><span class="ident" id="5765842">Y</span>&nbsp;<span class="op" id="5765844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765848">ddelta</span>&nbsp;<span class="op" id="5765855">=</span>&nbsp;<span class="ident" id="5765857">dst</span><span class="op" id="5765860">.</span><span class="ident" id="5765861">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765870">sdelta</span>&nbsp;<span class="op" id="5765877">=</span>&nbsp;<span class="ident" id="5765879">src</span><span class="op" id="5765882">.</span><span class="ident" id="5765883">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5765891">}</span>&nbsp;<span class="keyword" id="5765893">else</span>&nbsp;<span class="op" id="5765898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5765902">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5766002">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5766098">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766194">d0</span>&nbsp;<span class="op" id="5766197">+=</span>&nbsp;<span class="op" id="5766200">(</span><span class="ident" id="5766201">dy</span>&nbsp;<span class="op" id="5766204">-</span>&nbsp;<span class="num" id="5766206">1</span><span class="op" id="5766207">)</span>&nbsp;<span class="op" id="5766209">*</span>&nbsp;<span class="ident" id="5766211">dst</span><span class="op" id="5766214">.</span><span class="ident" id="5766215">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766224">s0</span>&nbsp;<span class="op" id="5766227">+=</span>&nbsp;<span class="op" id="5766230">(</span><span class="ident" id="5766231">dy</span>&nbsp;<span class="op" id="5766234">-</span>&nbsp;<span class="num" id="5766236">1</span><span class="op" id="5766237">)</span>&nbsp;<span class="op" id="5766239">*</span>&nbsp;<span class="ident" id="5766241">src</span><span class="op" id="5766244">.</span><span class="ident" id="5766245">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766254">ddelta</span>&nbsp;<span class="op" id="5766261">=</span>&nbsp;<span class="op" id="5766263">-</span><span class="ident" id="5766264">dst</span><span class="op" id="5766267">.</span><span class="ident" id="5766268">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766277">sdelta</span>&nbsp;<span class="op" id="5766284">=</span>&nbsp;<span class="op" id="5766286">-</span><span class="ident" id="5766287">src</span><span class="op" id="5766290">.</span><span class="ident" id="5766291">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5766299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766302">for</span>&nbsp;<span class="op" id="5766306">;</span>&nbsp;<span class="ident" id="5766308">dy</span>&nbsp;<span class="op" id="5766311">&gt;</span>&nbsp;<span class="num" id="5766313">0</span><span class="op" id="5766314">;</span>&nbsp;<span class="ident" id="5766316">dy</span><span class="op" id="5766318">--</span>&nbsp;<span class="op" id="5766321">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5766325">copy</span><span class="op" id="5766329">(</span><span class="ident" id="5766330">dst</span><span class="op" id="5766333">.</span><span class="ident" id="5766334">Pix</span><span class="op" id="5766337">[</span><span class="ident" id="5766338">d0</span><span class="op" id="5766340">:</span><span class="ident" id="5766341">d0</span><span class="op" id="5766343">+</span><span class="ident" id="5766344">n</span><span class="op" id="5766345">]</span><span class="op" id="5766346">,</span>&nbsp;<span class="ident" id="5766348">src</span><span class="op" id="5766351">.</span><span class="ident" id="5766352">Pix</span><span class="op" id="5766355">[</span><span class="ident" id="5766356">s0</span><span class="op" id="5766358">:</span><span class="ident" id="5766359">s0</span><span class="op" id="5766361">+</span><span class="ident" id="5766362">n</span><span class="op" id="5766363">]</span><span class="op" id="5766364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766368">d0</span>&nbsp;<span class="op" id="5766371">+=</span>&nbsp;<span class="ident" id="5766374">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766383">s0</span>&nbsp;<span class="op" id="5766386">+=</span>&nbsp;<span class="ident" id="5766389">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5766397">}</span><br>
<span class="lineno"></span><span class="op" id="5766399">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="5766402">func</span>&nbsp;<span class="ident" id="5766407">drawNRGBAOver</span><span class="op" id="5766420">(</span><span class="ident" id="5766421">dst</span>&nbsp;<span class="op" id="5766425">*</span><span class="ident" id="5766426">image</span><span class="op" id="5766431">.</span><span class="ident" id="5766432">RGBA</span><span class="op" id="5766436">,</span>&nbsp;<span class="ident" id="5766438">r</span>&nbsp;<span class="ident" id="5766440">image</span><span class="op" id="5766445">.</span><span class="ident" id="5766446">Rectangle</span><span class="op" id="5766455">,</span>&nbsp;<span class="ident" id="5766457">src</span>&nbsp;<span class="op" id="5766461">*</span><span class="ident" id="5766462">image</span><span class="op" id="5766467">.</span><span class="ident" id="5766468">NRGBA</span><span class="op" id="5766473">,</span>&nbsp;<span class="ident" id="5766475">sp</span>&nbsp;<span class="ident" id="5766478">image</span><span class="op" id="5766483">.</span><span class="ident" id="5766484">Point</span><span class="op" id="5766489">)</span>&nbsp;<span class="op" id="5766491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766494">i0</span>&nbsp;<span class="op" id="5766497">:=</span>&nbsp;<span class="op" id="5766500">(</span><span class="ident" id="5766501">r</span><span class="op" id="5766502">.</span><span class="ident" id="5766503">Min</span><span class="op" id="5766506">.</span><span class="ident" id="5766507">X</span>&nbsp;<span class="op" id="5766509">-</span>&nbsp;<span class="ident" id="5766511">dst</span><span class="op" id="5766514">.</span><span class="ident" id="5766515">Rect</span><span class="op" id="5766519">.</span><span class="ident" id="5766520">Min</span><span class="op" id="5766523">.</span><span class="ident" id="5766524">X</span><span class="op" id="5766525">)</span>&nbsp;<span class="op" id="5766527">*</span>&nbsp;<span class="num" id="5766529">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766532">i1</span>&nbsp;<span class="op" id="5766535">:=</span>&nbsp;<span class="op" id="5766538">(</span><span class="ident" id="5766539">r</span><span class="op" id="5766540">.</span><span class="ident" id="5766541">Max</span><span class="op" id="5766544">.</span><span class="ident" id="5766545">X</span>&nbsp;<span class="op" id="5766547">-</span>&nbsp;<span class="ident" id="5766549">dst</span><span class="op" id="5766552">.</span><span class="ident" id="5766553">Rect</span><span class="op" id="5766557">.</span><span class="ident" id="5766558">Min</span><span class="op" id="5766561">.</span><span class="ident" id="5766562">X</span><span class="op" id="5766563">)</span>&nbsp;<span class="op" id="5766565">*</span>&nbsp;<span class="num" id="5766567">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766570">si0</span>&nbsp;<span class="op" id="5766574">:=</span>&nbsp;<span class="op" id="5766577">(</span><span class="ident" id="5766578">sp</span><span class="op" id="5766580">.</span><span class="ident" id="5766581">X</span>&nbsp;<span class="op" id="5766583">-</span>&nbsp;<span class="ident" id="5766585">src</span><span class="op" id="5766588">.</span><span class="ident" id="5766589">Rect</span><span class="op" id="5766593">.</span><span class="ident" id="5766594">Min</span><span class="op" id="5766597">.</span><span class="ident" id="5766598">X</span><span class="op" id="5766599">)</span>&nbsp;<span class="op" id="5766601">*</span>&nbsp;<span class="num" id="5766603">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766606">yMax</span>&nbsp;<span class="op" id="5766611">:=</span>&nbsp;<span class="ident" id="5766614">r</span><span class="op" id="5766615">.</span><span class="ident" id="5766616">Max</span><span class="op" id="5766619">.</span><span class="ident" id="5766620">Y</span>&nbsp;<span class="op" id="5766622">-</span>&nbsp;<span class="ident" id="5766624">dst</span><span class="op" id="5766627">.</span><span class="ident" id="5766628">Rect</span><span class="op" id="5766632">.</span><span class="ident" id="5766633">Min</span><span class="op" id="5766636">.</span><span class="ident" id="5766637">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766641">y</span>&nbsp;<span class="op" id="5766643">:=</span>&nbsp;<span class="ident" id="5766646">r</span><span class="op" id="5766647">.</span><span class="ident" id="5766648">Min</span><span class="op" id="5766651">.</span><span class="ident" id="5766652">Y</span>&nbsp;<span class="op" id="5766654">-</span>&nbsp;<span class="ident" id="5766656">dst</span><span class="op" id="5766659">.</span><span class="ident" id="5766660">Rect</span><span class="op" id="5766664">.</span><span class="ident" id="5766665">Min</span><span class="op" id="5766668">.</span><span class="ident" id="5766669">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766672">sy</span>&nbsp;<span class="op" id="5766675">:=</span>&nbsp;<span class="ident" id="5766678">sp</span><span class="op" id="5766680">.</span><span class="ident" id="5766681">Y</span>&nbsp;<span class="op" id="5766683">-</span>&nbsp;<span class="ident" id="5766685">src</span><span class="op" id="5766688">.</span><span class="ident" id="5766689">Rect</span><span class="op" id="5766693">.</span><span class="ident" id="5766694">Min</span><span class="op" id="5766697">.</span><span class="ident" id="5766698">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766701">for</span>&nbsp;<span class="op" id="5766705">;</span>&nbsp;<span class="ident" id="5766707">y</span>&nbsp;<span class="op" id="5766709">!=</span>&nbsp;<span class="ident" id="5766712">yMax</span><span class="op" id="5766716">;</span>&nbsp;<span class="ident" id="5766718">y</span><span class="op" id="5766719">,</span>&nbsp;<span class="ident" id="5766721">sy</span>&nbsp;<span class="op" id="5766724">=</span>&nbsp;<span class="ident" id="5766726">y</span><span class="op" id="5766727">+</span><span class="num" id="5766728">1</span><span class="op" id="5766729">,</span>&nbsp;<span class="ident" id="5766731">sy</span><span class="op" id="5766733">+</span><span class="num" id="5766734">1</span>&nbsp;<span class="op" id="5766736">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766740">dpix</span>&nbsp;<span class="op" id="5766745">:=</span>&nbsp;<span class="ident" id="5766748">dst</span><span class="op" id="5766751">.</span><span class="ident" id="5766752">Pix</span><span class="op" id="5766755">[</span><span class="ident" id="5766756">y</span><span class="op" id="5766757">*</span><span class="ident" id="5766758">dst</span><span class="op" id="5766761">.</span><span class="ident" id="5766762">Stride</span><span class="op" id="5766768">:</span><span class="op" id="5766769">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766773">spix</span>&nbsp;<span class="op" id="5766778">:=</span>&nbsp;<span class="ident" id="5766781">src</span><span class="op" id="5766784">.</span><span class="ident" id="5766785">Pix</span><span class="op" id="5766788">[</span><span class="ident" id="5766789">sy</span><span class="op" id="5766791">*</span><span class="ident" id="5766792">src</span><span class="op" id="5766795">.</span><span class="ident" id="5766796">Stride</span><span class="op" id="5766802">:</span><span class="op" id="5766803">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766808">for</span>&nbsp;<span class="ident" id="5766812">i</span><span class="op" id="5766813">,</span>&nbsp;<span class="ident" id="5766815">si</span>&nbsp;<span class="op" id="5766818">:=</span>&nbsp;<span class="ident" id="5766821">i0</span><span class="op" id="5766823">,</span>&nbsp;<span class="ident" id="5766825">si0</span><span class="op" id="5766828">;</span>&nbsp;<span class="ident" id="5766830">i</span>&nbsp;<span class="op" id="5766832">&lt;</span>&nbsp;<span class="ident" id="5766834">i1</span><span class="op" id="5766836">;</span>&nbsp;<span class="ident" id="5766838">i</span><span class="op" id="5766839">,</span>&nbsp;<span class="ident" id="5766841">si</span>&nbsp;<span class="op" id="5766844">=</span>&nbsp;<span class="ident" id="5766846">i</span><span class="op" id="5766847">+</span><span class="num" id="5766848">4</span><span class="op" id="5766849">,</span>&nbsp;<span class="ident" id="5766851">si</span><span class="op" id="5766853">+</span><span class="num" id="5766854">4</span>&nbsp;<span class="op" id="5766856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5766861">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766929">sa</span>&nbsp;<span class="op" id="5766932">:=</span>&nbsp;<span class="builtintype" id="5766935">uint32</span><span class="op" id="5766941">(</span><span class="ident" id="5766942">spix</span><span class="op" id="5766946">[</span><span class="ident" id="5766947">si</span><span class="op" id="5766949">+</span><span class="num" id="5766950">3</span><span class="op" id="5766951">]</span><span class="op" id="5766952">)</span>&nbsp;<span class="op" id="5766954">*</span>&nbsp;<span class="num" id="5766956">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766965">sr</span>&nbsp;<span class="op" id="5766968">:=</span>&nbsp;<span class="builtintype" id="5766971">uint32</span><span class="op" id="5766977">(</span><span class="ident" id="5766978">spix</span><span class="op" id="5766982">[</span><span class="ident" id="5766983">si</span><span class="op" id="5766985">+</span><span class="num" id="5766986">0</span><span class="op" id="5766987">]</span><span class="op" id="5766988">)</span>&nbsp;<span class="op" id="5766990">*</span>&nbsp;<span class="ident" id="5766992">sa</span>&nbsp;<span class="op" id="5766995">/</span>&nbsp;<span class="num" id="5766997">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767005">sg</span>&nbsp;<span class="op" id="5767008">:=</span>&nbsp;<span class="builtintype" id="5767011">uint32</span><span class="op" id="5767017">(</span><span class="ident" id="5767018">spix</span><span class="op" id="5767022">[</span><span class="ident" id="5767023">si</span><span class="op" id="5767025">+</span><span class="num" id="5767026">1</span><span class="op" id="5767027">]</span><span class="op" id="5767028">)</span>&nbsp;<span class="op" id="5767030">*</span>&nbsp;<span class="ident" id="5767032">sa</span>&nbsp;<span class="op" id="5767035">/</span>&nbsp;<span class="num" id="5767037">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767045">sb</span>&nbsp;<span class="op" id="5767048">:=</span>&nbsp;<span class="builtintype" id="5767051">uint32</span><span class="op" id="5767057">(</span><span class="ident" id="5767058">spix</span><span class="op" id="5767062">[</span><span class="ident" id="5767063">si</span><span class="op" id="5767065">+</span><span class="num" id="5767066">2</span><span class="op" id="5767067">]</span><span class="op" id="5767068">)</span>&nbsp;<span class="op" id="5767070">*</span>&nbsp;<span class="ident" id="5767072">sa</span>&nbsp;<span class="op" id="5767075">/</span>&nbsp;<span class="num" id="5767077">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767086">dr</span>&nbsp;<span class="op" id="5767089">:=</span>&nbsp;<span class="builtintype" id="5767092">uint32</span><span class="op" id="5767098">(</span><span class="ident" id="5767099">dpix</span><span class="op" id="5767103">[</span><span class="ident" id="5767104">i</span><span class="op" id="5767105">+</span><span class="num" id="5767106">0</span><span class="op" id="5767107">]</span><span class="op" id="5767108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767113">dg</span>&nbsp;<span class="op" id="5767116">:=</span>&nbsp;<span class="builtintype" id="5767119">uint32</span><span class="op" id="5767125">(</span><span class="ident" id="5767126">dpix</span><span class="op" id="5767130">[</span><span class="ident" id="5767131">i</span><span class="op" id="5767132">+</span><span class="num" id="5767133">1</span><span class="op" id="5767134">]</span><span class="op" id="5767135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767140">db</span>&nbsp;<span class="op" id="5767143">:=</span>&nbsp;<span class="builtintype" id="5767146">uint32</span><span class="op" id="5767152">(</span><span class="ident" id="5767153">dpix</span><span class="op" id="5767157">[</span><span class="ident" id="5767158">i</span><span class="op" id="5767159">+</span><span class="num" id="5767160">2</span><span class="op" id="5767161">]</span><span class="op" id="5767162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767167">da</span>&nbsp;<span class="op" id="5767170">:=</span>&nbsp;<span class="builtintype" id="5767173">uint32</span><span class="op" id="5767179">(</span><span class="ident" id="5767180">dpix</span><span class="op" id="5767184">[</span><span class="ident" id="5767185">i</span><span class="op" id="5767186">+</span><span class="num" id="5767187">3</span><span class="op" id="5767188">]</span><span class="op" id="5767189">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5767195">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767255">a</span>&nbsp;<span class="op" id="5767257">:=</span>&nbsp;<span class="op" id="5767260">(</span><span class="ident" id="5767261">m</span>&nbsp;<span class="op" id="5767263">-</span>&nbsp;<span class="ident" id="5767265">sa</span><span class="op" id="5767267">)</span>&nbsp;<span class="op" id="5767269">*</span>&nbsp;<span class="num" id="5767271">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767281">dpix</span><span class="op" id="5767285">[</span><span class="ident" id="5767286">i</span><span class="op" id="5767287">+</span><span class="num" id="5767288">0</span><span class="op" id="5767289">]</span>&nbsp;<span class="op" id="5767291">=</span>&nbsp;<span class="builtintype" id="5767293">uint8</span><span class="op" id="5767298">(</span><span class="op" id="5767299">(</span><span class="ident" id="5767300">dr</span><span class="op" id="5767302">*</span><span class="ident" id="5767303">a</span><span class="op" id="5767304">/</span><span class="ident" id="5767305">m</span>&nbsp;<span class="op" id="5767307">+</span>&nbsp;<span class="ident" id="5767309">sr</span><span class="op" id="5767311">)</span>&nbsp;<span class="op" id="5767313">&gt;&gt;</span>&nbsp;<span class="num" id="5767316">8</span><span class="op" id="5767317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767322">dpix</span><span class="op" id="5767326">[</span><span class="ident" id="5767327">i</span><span class="op" id="5767328">+</span><span class="num" id="5767329">1</span><span class="op" id="5767330">]</span>&nbsp;<span class="op" id="5767332">=</span>&nbsp;<span class="builtintype" id="5767334">uint8</span><span class="op" id="5767339">(</span><span class="op" id="5767340">(</span><span class="ident" id="5767341">dg</span><span class="op" id="5767343">*</span><span class="ident" id="5767344">a</span><span class="op" id="5767345">/</span><span class="ident" id="5767346">m</span>&nbsp;<span class="op" id="5767348">+</span>&nbsp;<span class="ident" id="5767350">sg</span><span class="op" id="5767352">)</span>&nbsp;<span class="op" id="5767354">&gt;&gt;</span>&nbsp;<span class="num" id="5767357">8</span><span class="op" id="5767358">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767363">dpix</span><span class="op" id="5767367">[</span><span class="ident" id="5767368">i</span><span class="op" id="5767369">+</span><span class="num" id="5767370">2</span><span class="op" id="5767371">]</span>&nbsp;<span class="op" id="5767373">=</span>&nbsp;<span class="builtintype" id="5767375">uint8</span><span class="op" id="5767380">(</span><span class="op" id="5767381">(</span><span class="ident" id="5767382">db</span><span class="op" id="5767384">*</span><span class="ident" id="5767385">a</span><span class="op" id="5767386">/</span><span class="ident" id="5767387">m</span>&nbsp;<span class="op" id="5767389">+</span>&nbsp;<span class="ident" id="5767391">sb</span><span class="op" id="5767393">)</span>&nbsp;<span class="op" id="5767395">&gt;&gt;</span>&nbsp;<span class="num" id="5767398">8</span><span class="op" id="5767399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767404">dpix</span><span class="op" id="5767408">[</span><span class="ident" id="5767409">i</span><span class="op" id="5767410">+</span><span class="num" id="5767411">3</span><span class="op" id="5767412">]</span>&nbsp;<span class="op" id="5767414">=</span>&nbsp;<span class="builtintype" id="5767416">uint8</span><span class="op" id="5767421">(</span><span class="op" id="5767422">(</span><span class="ident" id="5767423">da</span><span class="op" id="5767425">*</span><span class="ident" id="5767426">a</span><span class="op" id="5767427">/</span><span class="ident" id="5767428">m</span>&nbsp;<span class="op" id="5767430">+</span>&nbsp;<span class="ident" id="5767432">sa</span><span class="op" id="5767434">)</span>&nbsp;<span class="op" id="5767436">&gt;&gt;</span>&nbsp;<span class="num" id="5767439">8</span><span class="op" id="5767440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5767444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5767447">}</span><br>
<span class="lineno"></span><span class="op" id="5767449">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="5767452">func</span>&nbsp;<span class="ident" id="5767457">drawNRGBASrc</span><span class="op" id="5767469">(</span><span class="ident" id="5767470">dst</span>&nbsp;<span class="op" id="5767474">*</span><span class="ident" id="5767475">image</span><span class="op" id="5767480">.</span><span class="ident" id="5767481">RGBA</span><span class="op" id="5767485">,</span>&nbsp;<span class="ident" id="5767487">r</span>&nbsp;<span class="ident" id="5767489">image</span><span class="op" id="5767494">.</span><span class="ident" id="5767495">Rectangle</span><span class="op" id="5767504">,</span>&nbsp;<span class="ident" id="5767506">src</span>&nbsp;<span class="op" id="5767510">*</span><span class="ident" id="5767511">image</span><span class="op" id="5767516">.</span><span class="ident" id="5767517">NRGBA</span><span class="op" id="5767522">,</span>&nbsp;<span class="ident" id="5767524">sp</span>&nbsp;<span class="ident" id="5767527">image</span><span class="op" id="5767532">.</span><span class="ident" id="5767533">Point</span><span class="op" id="5767538">)</span>&nbsp;<span class="op" id="5767540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767543">i0</span>&nbsp;<span class="op" id="5767546">:=</span>&nbsp;<span class="op" id="5767549">(</span><span class="ident" id="5767550">r</span><span class="op" id="5767551">.</span><span class="ident" id="5767552">Min</span><span class="op" id="5767555">.</span><span class="ident" id="5767556">X</span>&nbsp;<span class="op" id="5767558">-</span>&nbsp;<span class="ident" id="5767560">dst</span><span class="op" id="5767563">.</span><span class="ident" id="5767564">Rect</span><span class="op" id="5767568">.</span><span class="ident" id="5767569">Min</span><span class="op" id="5767572">.</span><span class="ident" id="5767573">X</span><span class="op" id="5767574">)</span>&nbsp;<span class="op" id="5767576">*</span>&nbsp;<span class="num" id="5767578">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767581">i1</span>&nbsp;<span class="op" id="5767584">:=</span>&nbsp;<span class="op" id="5767587">(</span><span class="ident" id="5767588">r</span><span class="op" id="5767589">.</span><span class="ident" id="5767590">Max</span><span class="op" id="5767593">.</span><span class="ident" id="5767594">X</span>&nbsp;<span class="op" id="5767596">-</span>&nbsp;<span class="ident" id="5767598">dst</span><span class="op" id="5767601">.</span><span class="ident" id="5767602">Rect</span><span class="op" id="5767606">.</span><span class="ident" id="5767607">Min</span><span class="op" id="5767610">.</span><span class="ident" id="5767611">X</span><span class="op" id="5767612">)</span>&nbsp;<span class="op" id="5767614">*</span>&nbsp;<span class="num" id="5767616">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767619">si0</span>&nbsp;<span class="op" id="5767623">:=</span>&nbsp;<span class="op" id="5767626">(</span><span class="ident" id="5767627">sp</span><span class="op" id="5767629">.</span><span class="ident" id="5767630">X</span>&nbsp;<span class="op" id="5767632">-</span>&nbsp;<span class="ident" id="5767634">src</span><span class="op" id="5767637">.</span><span class="ident" id="5767638">Rect</span><span class="op" id="5767642">.</span><span class="ident" id="5767643">Min</span><span class="op" id="5767646">.</span><span class="ident" id="5767647">X</span><span class="op" id="5767648">)</span>&nbsp;<span class="op" id="5767650">*</span>&nbsp;<span class="num" id="5767652">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767655">yMax</span>&nbsp;<span class="op" id="5767660">:=</span>&nbsp;<span class="ident" id="5767663">r</span><span class="op" id="5767664">.</span><span class="ident" id="5767665">Max</span><span class="op" id="5767668">.</span><span class="ident" id="5767669">Y</span>&nbsp;<span class="op" id="5767671">-</span>&nbsp;<span class="ident" id="5767673">dst</span><span class="op" id="5767676">.</span><span class="ident" id="5767677">Rect</span><span class="op" id="5767681">.</span><span class="ident" id="5767682">Min</span><span class="op" id="5767685">.</span><span class="ident" id="5767686">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767690">y</span>&nbsp;<span class="op" id="5767692">:=</span>&nbsp;<span class="ident" id="5767695">r</span><span class="op" id="5767696">.</span><span class="ident" id="5767697">Min</span><span class="op" id="5767700">.</span><span class="ident" id="5767701">Y</span>&nbsp;<span class="op" id="5767703">-</span>&nbsp;<span class="ident" id="5767705">dst</span><span class="op" id="5767708">.</span><span class="ident" id="5767709">Rect</span><span class="op" id="5767713">.</span><span class="ident" id="5767714">Min</span><span class="op" id="5767717">.</span><span class="ident" id="5767718">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767721">sy</span>&nbsp;<span class="op" id="5767724">:=</span>&nbsp;<span class="ident" id="5767727">sp</span><span class="op" id="5767729">.</span><span class="ident" id="5767730">Y</span>&nbsp;<span class="op" id="5767732">-</span>&nbsp;<span class="ident" id="5767734">src</span><span class="op" id="5767737">.</span><span class="ident" id="5767738">Rect</span><span class="op" id="5767742">.</span><span class="ident" id="5767743">Min</span><span class="op" id="5767746">.</span><span class="ident" id="5767747">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5767750">for</span>&nbsp;<span class="op" id="5767754">;</span>&nbsp;<span class="ident" id="5767756">y</span>&nbsp;<span class="op" id="5767758">!=</span>&nbsp;<span class="ident" id="5767761">yMax</span><span class="op" id="5767765">;</span>&nbsp;<span class="ident" id="5767767">y</span><span class="op" id="5767768">,</span>&nbsp;<span class="ident" id="5767770">sy</span>&nbsp;<span class="op" id="5767773">=</span>&nbsp;<span class="ident" id="5767775">y</span><span class="op" id="5767776">+</span><span class="num" id="5767777">1</span><span class="op" id="5767778">,</span>&nbsp;<span class="ident" id="5767780">sy</span><span class="op" id="5767782">+</span><span class="num" id="5767783">1</span>&nbsp;<span class="op" id="5767785">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767789">dpix</span>&nbsp;<span class="op" id="5767794">:=</span>&nbsp;<span class="ident" id="5767797">dst</span><span class="op" id="5767800">.</span><span class="ident" id="5767801">Pix</span><span class="op" id="5767804">[</span><span class="ident" id="5767805">y</span><span class="op" id="5767806">*</span><span class="ident" id="5767807">dst</span><span class="op" id="5767810">.</span><span class="ident" id="5767811">Stride</span><span class="op" id="5767817">:</span><span class="op" id="5767818">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767822">spix</span>&nbsp;<span class="op" id="5767827">:=</span>&nbsp;<span class="ident" id="5767830">src</span><span class="op" id="5767833">.</span><span class="ident" id="5767834">Pix</span><span class="op" id="5767837">[</span><span class="ident" id="5767838">sy</span><span class="op" id="5767840">*</span><span class="ident" id="5767841">src</span><span class="op" id="5767844">.</span><span class="ident" id="5767845">Stride</span><span class="op" id="5767851">:</span><span class="op" id="5767852">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5767857">for</span>&nbsp;<span class="ident" id="5767861">i</span><span class="op" id="5767862">,</span>&nbsp;<span class="ident" id="5767864">si</span>&nbsp;<span class="op" id="5767867">:=</span>&nbsp;<span class="ident" id="5767870">i0</span><span class="op" id="5767872">,</span>&nbsp;<span class="ident" id="5767874">si0</span><span class="op" id="5767877">;</span>&nbsp;<span class="ident" id="5767879">i</span>&nbsp;<span class="op" id="5767881">&lt;</span>&nbsp;<span class="ident" id="5767883">i1</span><span class="op" id="5767885">;</span>&nbsp;<span class="ident" id="5767887">i</span><span class="op" id="5767888">,</span>&nbsp;<span class="ident" id="5767890">si</span>&nbsp;<span class="op" id="5767893">=</span>&nbsp;<span class="ident" id="5767895">i</span><span class="op" id="5767896">+</span><span class="num" id="5767897">4</span><span class="op" id="5767898">,</span>&nbsp;<span class="ident" id="5767900">si</span><span class="op" id="5767902">+</span><span class="num" id="5767903">4</span>&nbsp;<span class="op" id="5767905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5767910">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767978">sa</span>&nbsp;<span class="op" id="5767981">:=</span>&nbsp;<span class="builtintype" id="5767984">uint32</span><span class="op" id="5767990">(</span><span class="ident" id="5767991">spix</span><span class="op" id="5767995">[</span><span class="ident" id="5767996">si</span><span class="op" id="5767998">+</span><span class="num" id="5767999">3</span><span class="op" id="5768000">]</span><span class="op" id="5768001">)</span>&nbsp;<span class="op" id="5768003">*</span>&nbsp;<span class="num" id="5768005">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768014">sr</span>&nbsp;<span class="op" id="5768017">:=</span>&nbsp;<span class="builtintype" id="5768020">uint32</span><span class="op" id="5768026">(</span><span class="ident" id="5768027">spix</span><span class="op" id="5768031">[</span><span class="ident" id="5768032">si</span><span class="op" id="5768034">+</span><span class="num" id="5768035">0</span><span class="op" id="5768036">]</span><span class="op" id="5768037">)</span>&nbsp;<span class="op" id="5768039">*</span>&nbsp;<span class="ident" id="5768041">sa</span>&nbsp;<span class="op" id="5768044">/</span>&nbsp;<span class="num" id="5768046">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768054">sg</span>&nbsp;<span class="op" id="5768057">:=</span>&nbsp;<span class="builtintype" id="5768060">uint32</span><span class="op" id="5768066">(</span><span class="ident" id="5768067">spix</span><span class="op" id="5768071">[</span><span class="ident" id="5768072">si</span><span class="op" id="5768074">+</span><span class="num" id="5768075">1</span><span class="op" id="5768076">]</span><span class="op" id="5768077">)</span>&nbsp;<span class="op" id="5768079">*</span>&nbsp;<span class="ident" id="5768081">sa</span>&nbsp;<span class="op" id="5768084">/</span>&nbsp;<span class="num" id="5768086">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768094">sb</span>&nbsp;<span class="op" id="5768097">:=</span>&nbsp;<span class="builtintype" id="5768100">uint32</span><span class="op" id="5768106">(</span><span class="ident" id="5768107">spix</span><span class="op" id="5768111">[</span><span class="ident" id="5768112">si</span><span class="op" id="5768114">+</span><span class="num" id="5768115">2</span><span class="op" id="5768116">]</span><span class="op" id="5768117">)</span>&nbsp;<span class="op" id="5768119">*</span>&nbsp;<span class="ident" id="5768121">sa</span>&nbsp;<span class="op" id="5768124">/</span>&nbsp;<span class="num" id="5768126">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768135">dpix</span><span class="op" id="5768139">[</span><span class="ident" id="5768140">i</span><span class="op" id="5768141">+</span><span class="num" id="5768142">0</span><span class="op" id="5768143">]</span>&nbsp;<span class="op" id="5768145">=</span>&nbsp;<span class="builtintype" id="5768147">uint8</span><span class="op" id="5768152">(</span><span class="ident" id="5768153">sr</span>&nbsp;<span class="op" id="5768156">&gt;&gt;</span>&nbsp;<span class="num" id="5768159">8</span><span class="op" id="5768160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768165">dpix</span><span class="op" id="5768169">[</span><span class="ident" id="5768170">i</span><span class="op" id="5768171">+</span><span class="num" id="5768172">1</span><span class="op" id="5768173">]</span>&nbsp;<span class="op" id="5768175">=</span>&nbsp;<span class="builtintype" id="5768177">uint8</span><span class="op" id="5768182">(</span><span class="ident" id="5768183">sg</span>&nbsp;<span class="op" id="5768186">&gt;&gt;</span>&nbsp;<span class="num" id="5768189">8</span><span class="op" id="5768190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768195">dpix</span><span class="op" id="5768199">[</span><span class="ident" id="5768200">i</span><span class="op" id="5768201">+</span><span class="num" id="5768202">2</span><span class="op" id="5768203">]</span>&nbsp;<span class="op" id="5768205">=</span>&nbsp;<span class="builtintype" id="5768207">uint8</span><span class="op" id="5768212">(</span><span class="ident" id="5768213">sb</span>&nbsp;<span class="op" id="5768216">&gt;&gt;</span>&nbsp;<span class="num" id="5768219">8</span><span class="op" id="5768220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768225">dpix</span><span class="op" id="5768229">[</span><span class="ident" id="5768230">i</span><span class="op" id="5768231">+</span><span class="num" id="5768232">3</span><span class="op" id="5768233">]</span>&nbsp;<span class="op" id="5768235">=</span>&nbsp;<span class="builtintype" id="5768237">uint8</span><span class="op" id="5768242">(</span><span class="ident" id="5768243">sa</span>&nbsp;<span class="op" id="5768246">&gt;&gt;</span>&nbsp;<span class="num" id="5768249">8</span><span class="op" id="5768250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5768254">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5768257">}</span><br>
<span class="lineno"></span><span class="op" id="5768259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5768262">func</span>&nbsp;<span class="ident" id="5768267">drawYCbCr</span><span class="op" id="5768276">(</span><span class="ident" id="5768277">dst</span>&nbsp;<span class="op" id="5768281">*</span><span class="ident" id="5768282">image</span><span class="op" id="5768287">.</span><span class="ident" id="5768288">RGBA</span><span class="op" id="5768292">,</span>&nbsp;<span class="ident" id="5768294">r</span>&nbsp;<span class="ident" id="5768296">image</span><span class="op" id="5768301">.</span><span class="ident" id="5768302">Rectangle</span><span class="op" id="5768311">,</span>&nbsp;<span class="ident" id="5768313">src</span>&nbsp;<span class="op" id="5768317">*</span><span class="ident" id="5768318">image</span><span class="op" id="5768323">.</span><span class="ident" id="5768324">YCbCr</span><span class="op" id="5768329">,</span>&nbsp;<span class="ident" id="5768331">sp</span>&nbsp;<span class="ident" id="5768334">image</span><span class="op" id="5768339">.</span><span class="ident" id="5768340">Point</span><span class="op" id="5768345">)</span>&nbsp;<span class="op" id="5768347">(</span><span class="ident" id="5768348">ok</span>&nbsp;<span class="builtintype" id="5768351">bool</span><span class="op" id="5768355">)</span>&nbsp;<span class="op" id="5768357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5768360">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5768440">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768503">x0</span>&nbsp;<span class="op" id="5768506">:=</span>&nbsp;<span class="op" id="5768509">(</span><span class="ident" id="5768510">r</span><span class="op" id="5768511">.</span><span class="ident" id="5768512">Min</span><span class="op" id="5768515">.</span><span class="ident" id="5768516">X</span>&nbsp;<span class="op" id="5768518">-</span>&nbsp;<span class="ident" id="5768520">dst</span><span class="op" id="5768523">.</span><span class="ident" id="5768524">Rect</span><span class="op" id="5768528">.</span><span class="ident" id="5768529">Min</span><span class="op" id="5768532">.</span><span class="ident" id="5768533">X</span><span class="op" id="5768534">)</span>&nbsp;<span class="op" id="5768536">*</span>&nbsp;<span class="num" id="5768538">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768541">x1</span>&nbsp;<span class="op" id="5768544">:=</span>&nbsp;<span class="op" id="5768547">(</span><span class="ident" id="5768548">r</span><span class="op" id="5768549">.</span><span class="ident" id="5768550">Max</span><span class="op" id="5768553">.</span><span class="ident" id="5768554">X</span>&nbsp;<span class="op" id="5768556">-</span>&nbsp;<span class="ident" id="5768558">dst</span><span class="op" id="5768561">.</span><span class="ident" id="5768562">Rect</span><span class="op" id="5768566">.</span><span class="ident" id="5768567">Min</span><span class="op" id="5768570">.</span><span class="ident" id="5768571">X</span><span class="op" id="5768572">)</span>&nbsp;<span class="op" id="5768574">*</span>&nbsp;<span class="num" id="5768576">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768579">y0</span>&nbsp;<span class="op" id="5768582">:=</span>&nbsp;<span class="ident" id="5768585">r</span><span class="op" id="5768586">.</span><span class="ident" id="5768587">Min</span><span class="op" id="5768590">.</span><span class="ident" id="5768591">Y</span>&nbsp;<span class="op" id="5768593">-</span>&nbsp;<span class="ident" id="5768595">dst</span><span class="op" id="5768598">.</span><span class="ident" id="5768599">Rect</span><span class="op" id="5768603">.</span><span class="ident" id="5768604">Min</span><span class="op" id="5768607">.</span><span class="ident" id="5768608">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768611">y1</span>&nbsp;<span class="op" id="5768614">:=</span>&nbsp;<span class="ident" id="5768617">r</span><span class="op" id="5768618">.</span><span class="ident" id="5768619">Max</span><span class="op" id="5768622">.</span><span class="ident" id="5768623">Y</span>&nbsp;<span class="op" id="5768625">-</span>&nbsp;<span class="ident" id="5768627">dst</span><span class="op" id="5768630">.</span><span class="ident" id="5768631">Rect</span><span class="op" id="5768635">.</span><span class="ident" id="5768636">Min</span><span class="op" id="5768639">.</span><span class="ident" id="5768640">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768643">switch</span>&nbsp;<span class="ident" id="5768650">src</span><span class="op" id="5768653">.</span><span class="ident" id="5768654">SubsampleRatio</span>&nbsp;<span class="op" id="5768669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768672">case</span>&nbsp;<span class="ident" id="5768677">image</span><span class="op" id="5768682">.</span><span class="ident" id="5768683">YCbCrSubsampleRatio444</span><span class="op" id="5768705">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768709">for</span>&nbsp;<span class="ident" id="5768713">y</span><span class="op" id="5768714">,</span>&nbsp;<span class="ident" id="5768716">sy</span>&nbsp;<span class="op" id="5768719">:=</span>&nbsp;<span class="ident" id="5768722">y0</span><span class="op" id="5768724">,</span>&nbsp;<span class="ident" id="5768726">sp</span><span class="op" id="5768728">.</span><span class="ident" id="5768729">Y</span><span class="op" id="5768730">;</span>&nbsp;<span class="ident" id="5768732">y</span>&nbsp;<span class="op" id="5768734">!=</span>&nbsp;<span class="ident" id="5768737">y1</span><span class="op" id="5768739">;</span>&nbsp;<span class="ident" id="5768741">y</span><span class="op" id="5768742">,</span>&nbsp;<span class="ident" id="5768744">sy</span>&nbsp;<span class="op" id="5768747">=</span>&nbsp;<span class="ident" id="5768749">y</span><span class="op" id="5768750">+</span><span class="num" id="5768751">1</span><span class="op" id="5768752">,</span>&nbsp;<span class="ident" id="5768754">sy</span><span class="op" id="5768756">+</span><span class="num" id="5768757">1</span>&nbsp;<span class="op" id="5768759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768764">dpix</span>&nbsp;<span class="op" id="5768769">:=</span>&nbsp;<span class="ident" id="5768772">dst</span><span class="op" id="5768775">.</span><span class="ident" id="5768776">Pix</span><span class="op" id="5768779">[</span><span class="ident" id="5768780">y</span><span class="op" id="5768781">*</span><span class="ident" id="5768782">dst</span><span class="op" id="5768785">.</span><span class="ident" id="5768786">Stride</span><span class="op" id="5768792">:</span><span class="op" id="5768793">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768798">yi</span>&nbsp;<span class="op" id="5768801">:=</span>&nbsp;<span class="op" id="5768804">(</span><span class="ident" id="5768805">sy</span><span class="op" id="5768807">-</span><span class="ident" id="5768808">src</span><span class="op" id="5768811">.</span><span class="ident" id="5768812">Rect</span><span class="op" id="5768816">.</span><span class="ident" id="5768817">Min</span><span class="op" id="5768820">.</span><span class="ident" id="5768821">Y</span><span class="op" id="5768822">)</span><span class="op" id="5768823">*</span><span class="ident" id="5768824">src</span><span class="op" id="5768827">.</span><span class="ident" id="5768828">YStride</span>&nbsp;<span class="op" id="5768836">+</span>&nbsp;<span class="op" id="5768838">(</span><span class="ident" id="5768839">sp</span><span class="op" id="5768841">.</span><span class="ident" id="5768842">X</span>&nbsp;<span class="op" id="5768844">-</span>&nbsp;<span class="ident" id="5768846">src</span><span class="op" id="5768849">.</span><span class="ident" id="5768850">Rect</span><span class="op" id="5768854">.</span><span class="ident" id="5768855">Min</span><span class="op" id="5768858">.</span><span class="ident" id="5768859">X</span><span class="op" id="5768860">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768865">ci</span>&nbsp;<span class="op" id="5768868">:=</span>&nbsp;<span class="op" id="5768871">(</span><span class="ident" id="5768872">sy</span><span class="op" id="5768874">-</span><span class="ident" id="5768875">src</span><span class="op" id="5768878">.</span><span class="ident" id="5768879">Rect</span><span class="op" id="5768883">.</span><span class="ident" id="5768884">Min</span><span class="op" id="5768887">.</span><span class="ident" id="5768888">Y</span><span class="op" id="5768889">)</span><span class="op" id="5768890">*</span><span class="ident" id="5768891">src</span><span class="op" id="5768894">.</span><span class="ident" id="5768895">CStride</span>&nbsp;<span class="op" id="5768903">+</span>&nbsp;<span class="op" id="5768905">(</span><span class="ident" id="5768906">sp</span><span class="op" id="5768908">.</span><span class="ident" id="5768909">X</span>&nbsp;<span class="op" id="5768911">-</span>&nbsp;<span class="ident" id="5768913">src</span><span class="op" id="5768916">.</span><span class="ident" id="5768917">Rect</span><span class="op" id="5768921">.</span><span class="ident" id="5768922">Min</span><span class="op" id="5768925">.</span><span class="ident" id="5768926">X</span><span class="op" id="5768927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768932">for</span>&nbsp;<span class="ident" id="5768936">x</span>&nbsp;<span class="op" id="5768938">:=</span>&nbsp;<span class="ident" id="5768941">x0</span><span class="op" id="5768943">;</span>&nbsp;<span class="ident" id="5768945">x</span>&nbsp;<span class="op" id="5768947">!=</span>&nbsp;<span class="ident" id="5768950">x1</span><span class="op" id="5768952">;</span>&nbsp;<span class="ident" id="5768954">x</span><span class="op" id="5768955">,</span>&nbsp;<span class="ident" id="5768957">yi</span><span class="op" id="5768959">,</span>&nbsp;<span class="ident" id="5768961">ci</span>&nbsp;<span class="op" id="5768964">=</span>&nbsp;<span class="ident" id="5768966">x</span><span class="op" id="5768967">+</span><span class="num" id="5768968">4</span><span class="op" id="5768969">,</span>&nbsp;<span class="ident" id="5768971">yi</span><span class="op" id="5768973">+</span><span class="num" id="5768974">1</span><span class="op" id="5768975">,</span>&nbsp;<span class="ident" id="5768977">ci</span><span class="op" id="5768979">+</span><span class="num" id="5768980">1</span>&nbsp;<span class="op" id="5768982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768988">rr</span><span class="op" id="5768990">,</span>&nbsp;<span class="ident" id="5768992">gg</span><span class="op" id="5768994">,</span>&nbsp;<span class="ident" id="5768996">bb</span>&nbsp;<span class="op" id="5768999">:=</span>&nbsp;<span class="ident" id="5769002">color</span><span class="op" id="5769007">.</span><span class="ident" id="5769008">YCbCrToRGB</span><span class="op" id="5769018">(</span><span class="ident" id="5769019">src</span><span class="op" id="5769022">.</span><span class="ident" id="5769023">Y</span><span class="op" id="5769024">[</span><span class="ident" id="5769025">yi</span><span class="op" id="5769027">]</span><span class="op" id="5769028">,</span>&nbsp;<span class="ident" id="5769030">src</span><span class="op" id="5769033">.</span><span class="ident" id="5769034">Cb</span><span class="op" id="5769036">[</span><span class="ident" id="5769037">ci</span><span class="op" id="5769039">]</span><span class="op" id="5769040">,</span>&nbsp;<span class="ident" id="5769042">src</span><span class="op" id="5769045">.</span><span class="ident" id="5769046">Cr</span><span class="op" id="5769048">[</span><span class="ident" id="5769049">ci</span><span class="op" id="5769051">]</span><span class="op" id="5769052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769058">dpix</span><span class="op" id="5769062">[</span><span class="ident" id="5769063">x</span><span class="op" id="5769064">+</span><span class="num" id="5769065">0</span><span class="op" id="5769066">]</span>&nbsp;<span class="op" id="5769068">=</span>&nbsp;<span class="ident" id="5769070">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769077">dpix</span><span class="op" id="5769081">[</span><span class="ident" id="5769082">x</span><span class="op" id="5769083">+</span><span class="num" id="5769084">1</span><span class="op" id="5769085">]</span>&nbsp;<span class="op" id="5769087">=</span>&nbsp;<span class="ident" id="5769089">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769096">dpix</span><span class="op" id="5769100">[</span><span class="ident" id="5769101">x</span><span class="op" id="5769102">+</span><span class="num" id="5769103">2</span><span class="op" id="5769104">]</span>&nbsp;<span class="op" id="5769106">=</span>&nbsp;<span class="ident" id="5769108">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769115">dpix</span><span class="op" id="5769119">[</span><span class="ident" id="5769120">x</span><span class="op" id="5769121">+</span><span class="num" id="5769122">3</span><span class="op" id="5769123">]</span>&nbsp;<span class="op" id="5769125">=</span>&nbsp;<span class="num" id="5769127">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5769134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5769138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5769141">case</span>&nbsp;<span class="ident" id="5769146">image</span><span class="op" id="5769151">.</span><span class="ident" id="5769152">YCbCrSubsampleRatio422</span><span class="op" id="5769174">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5769178">for</span>&nbsp;<span class="ident" id="5769182">y</span><span class="op" id="5769183">,</span>&nbsp;<span class="ident" id="5769185">sy</span>&nbsp;<span class="op" id="5769188">:=</span>&nbsp;<span class="ident" id="5769191">y0</span><span class="op" id="5769193">,</span>&nbsp;<span class="ident" id="5769195">sp</span><span class="op" id="5769197">.</span><span class="ident" id="5769198">Y</span><span class="op" id="5769199">;</span>&nbsp;<span class="ident" id="5769201">y</span>&nbsp;<span class="op" id="5769203">!=</span>&nbsp;<span class="ident" id="5769206">y1</span><span class="op" id="5769208">;</span>&nbsp;<span class="ident" id="5769210">y</span><span class="op" id="5769211">,</span>&nbsp;<span class="ident" id="5769213">sy</span>&nbsp;<span class="op" id="5769216">=</span>&nbsp;<span class="ident" id="5769218">y</span><span class="op" id="5769219">+</span><span class="num" id="5769220">1</span><span class="op" id="5769221">,</span>&nbsp;<span class="ident" id="5769223">sy</span><span class="op" id="5769225">+</span><span class="num" id="5769226">1</span>&nbsp;<span class="op" id="5769228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769233">dpix</span>&nbsp;<span class="op" id="5769238">:=</span>&nbsp;<span class="ident" id="5769241">dst</span><span class="op" id="5769244">.</span><span class="ident" id="5769245">Pix</span><span class="op" id="5769248">[</span><span class="ident" id="5769249">y</span><span class="op" id="5769250">*</span><span class="ident" id="5769251">dst</span><span class="op" id="5769254">.</span><span class="ident" id="5769255">Stride</span><span class="op" id="5769261">:</span><span class="op" id="5769262">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769267">yi</span>&nbsp;<span class="op" id="5769270">:=</span>&nbsp;<span class="op" id="5769273">(</span><span class="ident" id="5769274">sy</span><span class="op" id="5769276">-</span><span class="ident" id="5769277">src</span><span class="op" id="5769280">.</span><span class="ident" id="5769281">Rect</span><span class="op" id="5769285">.</span><span class="ident" id="5769286">Min</span><span class="op" id="5769289">.</span><span class="ident" id="5769290">Y</span><span class="op" id="5769291">)</span><span class="op" id="5769292">*</span><span class="ident" id="5769293">src</span><span class="op" id="5769296">.</span><span class="ident" id="5769297">YStride</span>&nbsp;<span class="op" id="5769305">+</span>&nbsp;<span class="op" id="5769307">(</span><span class="ident" id="5769308">sp</span><span class="op" id="5769310">.</span><span class="ident" id="5769311">X</span>&nbsp;<span class="op" id="5769313">-</span>&nbsp;<span class="ident" id="5769315">src</span><span class="op" id="5769318">.</span><span class="ident" id="5769319">Rect</span><span class="op" id="5769323">.</span><span class="ident" id="5769324">Min</span><span class="op" id="5769327">.</span><span class="ident" id="5769328">X</span><span class="op" id="5769329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769334">ciBase</span>&nbsp;<span class="op" id="5769341">:=</span>&nbsp;<span class="op" id="5769344">(</span><span class="ident" id="5769345">sy</span><span class="op" id="5769347">-</span><span class="ident" id="5769348">src</span><span class="op" id="5769351">.</span><span class="ident" id="5769352">Rect</span><span class="op" id="5769356">.</span><span class="ident" id="5769357">Min</span><span class="op" id="5769360">.</span><span class="ident" id="5769361">Y</span><span class="op" id="5769362">)</span><span class="op" id="5769363">*</span><span class="ident" id="5769364">src</span><span class="op" id="5769367">.</span><span class="ident" id="5769368">CStride</span>&nbsp;<span class="op" id="5769376">-</span>&nbsp;<span class="ident" id="5769378">src</span><span class="op" id="5769381">.</span><span class="ident" id="5769382">Rect</span><span class="op" id="5769386">.</span><span class="ident" id="5769387">Min</span><span class="op" id="5769390">.</span><span class="ident" id="5769391">X</span><span class="op" id="5769392">/</span><span class="num" id="5769393">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5769398">for</span>&nbsp;<span class="ident" id="5769402">x</span><span class="op" id="5769403">,</span>&nbsp;<span class="ident" id="5769405">sx</span>&nbsp;<span class="op" id="5769408">:=</span>&nbsp;<span class="ident" id="5769411">x0</span><span class="op" id="5769413">,</span>&nbsp;<span class="ident" id="5769415">sp</span><span class="op" id="5769417">.</span><span class="ident" id="5769418">X</span><span class="op" id="5769419">;</span>&nbsp;<span class="ident" id="5769421">x</span>&nbsp;<span class="op" id="5769423">!=</span>&nbsp;<span class="ident" id="5769426">x1</span><span class="op" id="5769428">;</span>&nbsp;<span class="ident" id="5769430">x</span><span class="op" id="5769431">,</span>&nbsp;<span class="ident" id="5769433">sx</span><span class="op" id="5769435">,</span>&nbsp;<span class="ident" id="5769437">yi</span>&nbsp;<span class="op" id="5769440">=</span>&nbsp;<span class="ident" id="5769442">x</span><span class="op" id="5769443">+</span><span class="num" id="5769444">4</span><span class="op" id="5769445">,</span>&nbsp;<span class="ident" id="5769447">sx</span><span class="op" id="5769449">+</span><span class="num" id="5769450">1</span><span class="op" id="5769451">,</span>&nbsp;<span class="ident" id="5769453">yi</span><span class="op" id="5769455">+</span><span class="num" id="5769456">1</span>&nbsp;<span class="op" id="5769458">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769464">ci</span>&nbsp;<span class="op" id="5769467">:=</span>&nbsp;<span class="ident" id="5769470">ciBase</span>&nbsp;<span class="op" id="5769477">+</span>&nbsp;<span class="ident" id="5769479">sx</span><span class="op" id="5769481">/</span><span class="num" id="5769482">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769488">rr</span><span class="op" id="5769490">,</span>&nbsp;<span class="ident" id="5769492">gg</span><span class="op" id="5769494">,</span>&nbsp;<span class="ident" id="5769496">bb</span>&nbsp;<span class="op" id="5769499">:=</span>&nbsp;<span class="ident" id="5769502">color</span><span class="op" id="5769507">.</span><span class="ident" id="5769508">YCbCrToRGB</span><span class="op" id="5769518">(</span><span class="ident" id="5769519">src</span><span class="op" id="5769522">.</span><span class="ident" id="5769523">Y</span><span class="op" id="5769524">[</span><span class="ident" id="5769525">yi</span><span class="op" id="5769527">]</span><span class="op" id="5769528">,</span>&nbsp;<span class="ident" id="5769530">src</span><span class="op" id="5769533">.</span><span class="ident" id="5769534">Cb</span><span class="op" id="5769536">[</span><span class="ident" id="5769537">ci</span><span class="op" id="5769539">]</span><span class="op" id="5769540">,</span>&nbsp;<span class="ident" id="5769542">src</span><span class="op" id="5769545">.</span><span class="ident" id="5769546">Cr</span><span class="op" id="5769548">[</span><span class="ident" id="5769549">ci</span><span class="op" id="5769551">]</span><span class="op" id="5769552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769558">dpix</span><span class="op" id="5769562">[</span><span class="ident" id="5769563">x</span><span class="op" id="5769564">+</span><span class="num" id="5769565">0</span><span class="op" id="5769566">]</span>&nbsp;<span class="op" id="5769568">=</span>&nbsp;<span class="ident" id="5769570">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769577">dpix</span><span class="op" id="5769581">[</span><span class="ident" id="5769582">x</span><span class="op" id="5769583">+</span><span class="num" id="5769584">1</span><span class="op" id="5769585">]</span>&nbsp;<span class="op" id="5769587">=</span>&nbsp;<span class="ident" id="5769589">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769596">dpix</span><span class="op" id="5769600">[</span><span class="ident" id="5769601">x</span><span class="op" id="5769602">+</span><span class="num" id="5769603">2</span><span class="op" id="5769604">]</span>&nbsp;<span class="op" id="5769606">=</span>&nbsp;<span class="ident" id="5769608">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769615">dpix</span><span class="op" id="5769619">[</span><span class="ident" id="5769620">x</span><span class="op" id="5769621">+</span><span class="num" id="5769622">3</span><span class="op" id="5769623">]</span>&nbsp;<span class="op" id="5769625">=</span>&nbsp;<span class="num" id="5769627">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5769634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5769638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5769641">case</span>&nbsp;<span class="ident" id="5769646">image</span><span class="op" id="5769651">.</span><span class="ident" id="5769652">YCbCrSubsampleRatio420</span><span class="op" id="5769674">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5769678">for</span>&nbsp;<span class="ident" id="5769682">y</span><span class="op" id="5769683">,</span>&nbsp;<span class="ident" id="5769685">sy</span>&nbsp;<span class="op" id="5769688">:=</span>&nbsp;<span class="ident" id="5769691">y0</span><span class="op" id="5769693">,</span>&nbsp;<span class="ident" id="5769695">sp</span><span class="op" id="5769697">.</span><span class="ident" id="5769698">Y</span><span class="op" id="5769699">;</span>&nbsp;<span class="ident" id="5769701">y</span>&nbsp;<span class="op" id="5769703">!=</span>&nbsp;<span class="ident" id="5769706">y1</span><span class="op" id="5769708">;</span>&nbsp;<span class="ident" id="5769710">y</span><span class="op" id="5769711">,</span>&nbsp;<span class="ident" id="5769713">sy</span>&nbsp;<span class="op" id="5769716">=</span>&nbsp;<span class="ident" id="5769718">y</span><span class="op" id="5769719">+</span><span class="num" id="5769720">1</span><span class="op" id="5769721">,</span>&nbsp;<span class="ident" id="5769723">sy</span><span class="op" id="5769725">+</span><span class="num" id="5769726">1</span>&nbsp;<span class="op" id="5769728">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769733">dpix</span>&nbsp;<span class="op" id="5769738">:=</span>&nbsp;<span class="ident" id="5769741">dst</span><span class="op" id="5769744">.</span><span class="ident" id="5769745">Pix</span><span class="op" id="5769748">[</span><span class="ident" id="5769749">y</span><span class="op" id="5769750">*</span><span class="ident" id="5769751">dst</span><span class="op" id="5769754">.</span><span class="ident" id="5769755">Stride</span><span class="op" id="5769761">:</span><span class="op" id="5769762">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769767">yi</span>&nbsp;<span class="op" id="5769770">:=</span>&nbsp;<span class="op" id="5769773">(</span><span class="ident" id="5769774">sy</span><span class="op" id="5769776">-</span><span class="ident" id="5769777">src</span><span class="op" id="5769780">.</span><span class="ident" id="5769781">Rect</span><span class="op" id="5769785">.</span><span class="ident" id="5769786">Min</span><span class="op" id="5769789">.</span><span class="ident" id="5769790">Y</span><span class="op" id="5769791">)</span><span class="op" id="5769792">*</span><span class="ident" id="5769793">src</span><span class="op" id="5769796">.</span><span class="ident" id="5769797">YStride</span>&nbsp;<span class="op" id="5769805">+</span>&nbsp;<span class="op" id="5769807">(</span><span class="ident" id="5769808">sp</span><span class="op" id="5769810">.</span><span class="ident" id="5769811">X</span>&nbsp;<span class="op" id="5769813">-</span>&nbsp;<span class="ident" id="5769815">src</span><span class="op" id="5769818">.</span><span class="ident" id="5769819">Rect</span><span class="op" id="5769823">.</span><span class="ident" id="5769824">Min</span><span class="op" id="5769827">.</span><span class="ident" id="5769828">X</span><span class="op" id="5769829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769834">ciBase</span>&nbsp;<span class="op" id="5769841">:=</span>&nbsp;<span class="op" id="5769844">(</span><span class="ident" id="5769845">sy</span><span class="op" id="5769847">/</span><span class="num" id="5769848">2</span><span class="op" id="5769849">-</span><span class="ident" id="5769850">src</span><span class="op" id="5769853">.</span><span class="ident" id="5769854">Rect</span><span class="op" id="5769858">.</span><span class="ident" id="5769859">Min</span><span class="op" id="5769862">.</span><span class="ident" id="5769863">Y</span><span class="op" id="5769864">/</span><span class="num" id="5769865">2</span><span class="op" id="5769866">)</span><span class="op" id="5769867">*</span><span class="ident" id="5769868">src</span><span class="op" id="5769871">.</span><span class="ident" id="5769872">CStride</span>&nbsp;<span class="op" id="5769880">-</span>&nbsp;<span class="ident" id="5769882">src</span><span class="op" id="5769885">.</span><span class="ident" id="5769886">Rect</span><span class="op" id="5769890">.</span><span class="ident" id="5769891">Min</span><span class="op" id="5769894">.</span><span class="ident" id="5769895">X</span><span class="op" id="5769896">/</span><span class="num" id="5769897">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5769902">for</span>&nbsp;<span class="ident" id="5769906">x</span><span class="op" id="5769907">,</span>&nbsp;<span class="ident" id="5769909">sx</span>&nbsp;<span class="op" id="5769912">:=</span>&nbsp;<span class="ident" id="5769915">x0</span><span class="op" id="5769917">,</span>&nbsp;<span class="ident" id="5769919">sp</span><span class="op" id="5769921">.</span><span class="ident" id="5769922">X</span><span class="op" id="5769923">;</span>&nbsp;<span class="ident" id="5769925">x</span>&nbsp;<span class="op" id="5769927">!=</span>&nbsp;<span class="ident" id="5769930">x1</span><span class="op" id="5769932">;</span>&nbsp;<span class="ident" id="5769934">x</span><span class="op" id="5769935">,</span>&nbsp;<span class="ident" id="5769937">sx</span><span class="op" id="5769939">,</span>&nbsp;<span class="ident" id="5769941">yi</span>&nbsp;<span class="op" id="5769944">=</span>&nbsp;<span class="ident" id="5769946">x</span><span class="op" id="5769947">+</span><span class="num" id="5769948">4</span><span class="op" id="5769949">,</span>&nbsp;<span class="ident" id="5769951">sx</span><span class="op" id="5769953">+</span><span class="num" id="5769954">1</span><span class="op" id="5769955">,</span>&nbsp;<span class="ident" id="5769957">yi</span><span class="op" id="5769959">+</span><span class="num" id="5769960">1</span>&nbsp;<span class="op" id="5769962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769968">ci</span>&nbsp;<span class="op" id="5769971">:=</span>&nbsp;<span class="ident" id="5769974">ciBase</span>&nbsp;<span class="op" id="5769981">+</span>&nbsp;<span class="ident" id="5769983">sx</span><span class="op" id="5769985">/</span><span class="num" id="5769986">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769992">rr</span><span class="op" id="5769994">,</span>&nbsp;<span class="ident" id="5769996">gg</span><span class="op" id="5769998">,</span>&nbsp;<span class="ident" id="5770000">bb</span>&nbsp;<span class="op" id="5770003">:=</span>&nbsp;<span class="ident" id="5770006">color</span><span class="op" id="5770011">.</span><span class="ident" id="5770012">YCbCrToRGB</span><span class="op" id="5770022">(</span><span class="ident" id="5770023">src</span><span class="op" id="5770026">.</span><span class="ident" id="5770027">Y</span><span class="op" id="5770028">[</span><span class="ident" id="5770029">yi</span><span class="op" id="5770031">]</span><span class="op" id="5770032">,</span>&nbsp;<span class="ident" id="5770034">src</span><span class="op" id="5770037">.</span><span class="ident" id="5770038">Cb</span><span class="op" id="5770040">[</span><span class="ident" id="5770041">ci</span><span class="op" id="5770043">]</span><span class="op" id="5770044">,</span>&nbsp;<span class="ident" id="5770046">src</span><span class="op" id="5770049">.</span><span class="ident" id="5770050">Cr</span><span class="op" id="5770052">[</span><span class="ident" id="5770053">ci</span><span class="op" id="5770055">]</span><span class="op" id="5770056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770062">dpix</span><span class="op" id="5770066">[</span><span class="ident" id="5770067">x</span><span class="op" id="5770068">+</span><span class="num" id="5770069">0</span><span class="op" id="5770070">]</span>&nbsp;<span class="op" id="5770072">=</span>&nbsp;<span class="ident" id="5770074">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770081">dpix</span><span class="op" id="5770085">[</span><span class="ident" id="5770086">x</span><span class="op" id="5770087">+</span><span class="num" id="5770088">1</span><span class="op" id="5770089">]</span>&nbsp;<span class="op" id="5770091">=</span>&nbsp;<span class="ident" id="5770093">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770100">dpix</span><span class="op" id="5770104">[</span><span class="ident" id="5770105">x</span><span class="op" id="5770106">+</span><span class="num" id="5770107">2</span><span class="op" id="5770108">]</span>&nbsp;<span class="op" id="5770110">=</span>&nbsp;<span class="ident" id="5770112">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770119">dpix</span><span class="op" id="5770123">[</span><span class="ident" id="5770124">x</span><span class="op" id="5770125">+</span><span class="num" id="5770126">3</span><span class="op" id="5770127">]</span>&nbsp;<span class="op" id="5770129">=</span>&nbsp;<span class="num" id="5770131">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5770138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5770142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770145">case</span>&nbsp;<span class="ident" id="5770150">image</span><span class="op" id="5770155">.</span><span class="ident" id="5770156">YCbCrSubsampleRatio440</span><span class="op" id="5770178">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770182">for</span>&nbsp;<span class="ident" id="5770186">y</span><span class="op" id="5770187">,</span>&nbsp;<span class="ident" id="5770189">sy</span>&nbsp;<span class="op" id="5770192">:=</span>&nbsp;<span class="ident" id="5770195">y0</span><span class="op" id="5770197">,</span>&nbsp;<span class="ident" id="5770199">sp</span><span class="op" id="5770201">.</span><span class="ident" id="5770202">Y</span><span class="op" id="5770203">;</span>&nbsp;<span class="ident" id="5770205">y</span>&nbsp;<span class="op" id="5770207">!=</span>&nbsp;<span class="ident" id="5770210">y1</span><span class="op" id="5770212">;</span>&nbsp;<span class="ident" id="5770214">y</span><span class="op" id="5770215">,</span>&nbsp;<span class="ident" id="5770217">sy</span>&nbsp;<span class="op" id="5770220">=</span>&nbsp;<span class="ident" id="5770222">y</span><span class="op" id="5770223">+</span><span class="num" id="5770224">1</span><span class="op" id="5770225">,</span>&nbsp;<span class="ident" id="5770227">sy</span><span class="op" id="5770229">+</span><span class="num" id="5770230">1</span>&nbsp;<span class="op" id="5770232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770237">dpix</span>&nbsp;<span class="op" id="5770242">:=</span>&nbsp;<span class="ident" id="5770245">dst</span><span class="op" id="5770248">.</span><span class="ident" id="5770249">Pix</span><span class="op" id="5770252">[</span><span class="ident" id="5770253">y</span><span class="op" id="5770254">*</span><span class="ident" id="5770255">dst</span><span class="op" id="5770258">.</span><span class="ident" id="5770259">Stride</span><span class="op" id="5770265">:</span><span class="op" id="5770266">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770271">yi</span>&nbsp;<span class="op" id="5770274">:=</span>&nbsp;<span class="op" id="5770277">(</span><span class="ident" id="5770278">sy</span><span class="op" id="5770280">-</span><span class="ident" id="5770281">src</span><span class="op" id="5770284">.</span><span class="ident" id="5770285">Rect</span><span class="op" id="5770289">.</span><span class="ident" id="5770290">Min</span><span class="op" id="5770293">.</span><span class="ident" id="5770294">Y</span><span class="op" id="5770295">)</span><span class="op" id="5770296">*</span><span class="ident" id="5770297">src</span><span class="op" id="5770300">.</span><span class="ident" id="5770301">YStride</span>&nbsp;<span class="op" id="5770309">+</span>&nbsp;<span class="op" id="5770311">(</span><span class="ident" id="5770312">sp</span><span class="op" id="5770314">.</span><span class="ident" id="5770315">X</span>&nbsp;<span class="op" id="5770317">-</span>&nbsp;<span class="ident" id="5770319">src</span><span class="op" id="5770322">.</span><span class="ident" id="5770323">Rect</span><span class="op" id="5770327">.</span><span class="ident" id="5770328">Min</span><span class="op" id="5770331">.</span><span class="ident" id="5770332">X</span><span class="op" id="5770333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770338">ci</span>&nbsp;<span class="op" id="5770341">:=</span>&nbsp;<span class="op" id="5770344">(</span><span class="ident" id="5770345">sy</span><span class="op" id="5770347">/</span><span class="num" id="5770348">2</span><span class="op" id="5770349">-</span><span class="ident" id="5770350">src</span><span class="op" id="5770353">.</span><span class="ident" id="5770354">Rect</span><span class="op" id="5770358">.</span><span class="ident" id="5770359">Min</span><span class="op" id="5770362">.</span><span class="ident" id="5770363">Y</span><span class="op" id="5770364">/</span><span class="num" id="5770365">2</span><span class="op" id="5770366">)</span><span class="op" id="5770367">*</span><span class="ident" id="5770368">src</span><span class="op" id="5770371">.</span><span class="ident" id="5770372">CStride</span>&nbsp;<span class="op" id="5770380">+</span>&nbsp;<span class="op" id="5770382">(</span><span class="ident" id="5770383">sp</span><span class="op" id="5770385">.</span><span class="ident" id="5770386">X</span>&nbsp;<span class="op" id="5770388">-</span>&nbsp;<span class="ident" id="5770390">src</span><span class="op" id="5770393">.</span><span class="ident" id="5770394">Rect</span><span class="op" id="5770398">.</span><span class="ident" id="5770399">Min</span><span class="op" id="5770402">.</span><span class="ident" id="5770403">X</span><span class="op" id="5770404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770409">for</span>&nbsp;<span class="ident" id="5770413">x</span>&nbsp;<span class="op" id="5770415">:=</span>&nbsp;<span class="ident" id="5770418">x0</span><span class="op" id="5770420">;</span>&nbsp;<span class="ident" id="5770422">x</span>&nbsp;<span class="op" id="5770424">!=</span>&nbsp;<span class="ident" id="5770427">x1</span><span class="op" id="5770429">;</span>&nbsp;<span class="ident" id="5770431">x</span><span class="op" id="5770432">,</span>&nbsp;<span class="ident" id="5770434">yi</span><span class="op" id="5770436">,</span>&nbsp;<span class="ident" id="5770438">ci</span>&nbsp;<span class="op" id="5770441">=</span>&nbsp;<span class="ident" id="5770443">x</span><span class="op" id="5770444">+</span><span class="num" id="5770445">4</span><span class="op" id="5770446">,</span>&nbsp;<span class="ident" id="5770448">yi</span><span class="op" id="5770450">+</span><span class="num" id="5770451">1</span><span class="op" id="5770452">,</span>&nbsp;<span class="ident" id="5770454">ci</span><span class="op" id="5770456">+</span><span class="num" id="5770457">1</span>&nbsp;<span class="op" id="5770459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770465">rr</span><span class="op" id="5770467">,</span>&nbsp;<span class="ident" id="5770469">gg</span><span class="op" id="5770471">,</span>&nbsp;<span class="ident" id="5770473">bb</span>&nbsp;<span class="op" id="5770476">:=</span>&nbsp;<span class="ident" id="5770479">color</span><span class="op" id="5770484">.</span><span class="ident" id="5770485">YCbCrToRGB</span><span class="op" id="5770495">(</span><span class="ident" id="5770496">src</span><span class="op" id="5770499">.</span><span class="ident" id="5770500">Y</span><span class="op" id="5770501">[</span><span class="ident" id="5770502">yi</span><span class="op" id="5770504">]</span><span class="op" id="5770505">,</span>&nbsp;<span class="ident" id="5770507">src</span><span class="op" id="5770510">.</span><span class="ident" id="5770511">Cb</span><span class="op" id="5770513">[</span><span class="ident" id="5770514">ci</span><span class="op" id="5770516">]</span><span class="op" id="5770517">,</span>&nbsp;<span class="ident" id="5770519">src</span><span class="op" id="5770522">.</span><span class="ident" id="5770523">Cr</span><span class="op" id="5770525">[</span><span class="ident" id="5770526">ci</span><span class="op" id="5770528">]</span><span class="op" id="5770529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770535">dpix</span><span class="op" id="5770539">[</span><span class="ident" id="5770540">x</span><span class="op" id="5770541">+</span><span class="num" id="5770542">0</span><span class="op" id="5770543">]</span>&nbsp;<span class="op" id="5770545">=</span>&nbsp;<span class="ident" id="5770547">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770554">dpix</span><span class="op" id="5770558">[</span><span class="ident" id="5770559">x</span><span class="op" id="5770560">+</span><span class="num" id="5770561">1</span><span class="op" id="5770562">]</span>&nbsp;<span class="op" id="5770564">=</span>&nbsp;<span class="ident" id="5770566">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770573">dpix</span><span class="op" id="5770577">[</span><span class="ident" id="5770578">x</span><span class="op" id="5770579">+</span><span class="num" id="5770580">2</span><span class="op" id="5770581">]</span>&nbsp;<span class="op" id="5770583">=</span>&nbsp;<span class="ident" id="5770585">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770592">dpix</span><span class="op" id="5770596">[</span><span class="ident" id="5770597">x</span><span class="op" id="5770598">+</span><span class="num" id="5770599">3</span><span class="op" id="5770600">]</span>&nbsp;<span class="op" id="5770602">=</span>&nbsp;<span class="num" id="5770604">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5770611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5770615">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770618">default</span><span class="op" id="5770625">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770629">return</span>&nbsp;<span class="builtintype" id="5770636">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5770643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770646">return</span>&nbsp;<span class="builtintype" id="5770653">true</span><br>
<span class="lineno"></span><span class="op" id="5770658">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="5770661">func</span>&nbsp;<span class="ident" id="5770666">drawGlyphOver</span><span class="op" id="5770679">(</span><span class="ident" id="5770680">dst</span>&nbsp;<span class="op" id="5770684">*</span><span class="ident" id="5770685">image</span><span class="op" id="5770690">.</span><span class="ident" id="5770691">RGBA</span><span class="op" id="5770695">,</span>&nbsp;<span class="ident" id="5770697">r</span>&nbsp;<span class="ident" id="5770699">image</span><span class="op" id="5770704">.</span><span class="ident" id="5770705">Rectangle</span><span class="op" id="5770714">,</span>&nbsp;<span class="ident" id="5770716">src</span>&nbsp;<span class="op" id="5770720">*</span><span class="ident" id="5770721">image</span><span class="op" id="5770726">.</span><span class="ident" id="5770727">Uniform</span><span class="op" id="5770734">,</span>&nbsp;<span class="ident" id="5770736">mask</span>&nbsp;<span class="op" id="5770741">*</span><span class="ident" id="5770742">image</span><span class="op" id="5770747">.</span><span class="ident" id="5770748">Alpha</span><span class="op" id="5770753">,</span>&nbsp;<span class="ident" id="5770755">mp</span>&nbsp;<span class="ident" id="5770758">image</span><span class="op" id="5770763">.</span><span class="ident" id="5770764">Point</span><span class="op" id="5770769">)</span>&nbsp;<span class="op" id="5770771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770774">i0</span>&nbsp;<span class="op" id="5770777">:=</span>&nbsp;<span class="ident" id="5770780">dst</span><span class="op" id="5770783">.</span><span class="ident" id="5770784">PixOffset</span><span class="op" id="5770793">(</span><span class="ident" id="5770794">r</span><span class="op" id="5770795">.</span><span class="ident" id="5770796">Min</span><span class="op" id="5770799">.</span><span class="ident" id="5770800">X</span><span class="op" id="5770801">,</span>&nbsp;<span class="ident" id="5770803">r</span><span class="op" id="5770804">.</span><span class="ident" id="5770805">Min</span><span class="op" id="5770808">.</span><span class="ident" id="5770809">Y</span><span class="op" id="5770810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770813">i1</span>&nbsp;<span class="op" id="5770816">:=</span>&nbsp;<span class="ident" id="5770819">i0</span>&nbsp;<span class="op" id="5770822">+</span>&nbsp;<span class="ident" id="5770824">r</span><span class="op" id="5770825">.</span><span class="ident" id="5770826">Dx</span><span class="op" id="5770828">(</span><span class="op" id="5770829">)</span><span class="op" id="5770830">*</span><span class="num" id="5770831">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770834">mi0</span>&nbsp;<span class="op" id="5770838">:=</span>&nbsp;<span class="ident" id="5770841">mask</span><span class="op" id="5770845">.</span><span class="ident" id="5770846">PixOffset</span><span class="op" id="5770855">(</span><span class="ident" id="5770856">mp</span><span class="op" id="5770858">.</span><span class="ident" id="5770859">X</span><span class="op" id="5770860">,</span>&nbsp;<span class="ident" id="5770862">mp</span><span class="op" id="5770864">.</span><span class="ident" id="5770865">Y</span><span class="op" id="5770866">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770869">sr</span><span class="op" id="5770871">,</span>&nbsp;<span class="ident" id="5770873">sg</span><span class="op" id="5770875">,</span>&nbsp;<span class="ident" id="5770877">sb</span><span class="op" id="5770879">,</span>&nbsp;<span class="ident" id="5770881">sa</span>&nbsp;<span class="op" id="5770884">:=</span>&nbsp;<span class="ident" id="5770887">src</span><span class="op" id="5770890">.</span><span class="ident" id="5770891">RGBA</span><span class="op" id="5770895">(</span><span class="op" id="5770896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770899">for</span>&nbsp;<span class="ident" id="5770903">y</span><span class="op" id="5770904">,</span>&nbsp;<span class="ident" id="5770906">my</span>&nbsp;<span class="op" id="5770909">:=</span>&nbsp;<span class="ident" id="5770912">r</span><span class="op" id="5770913">.</span><span class="ident" id="5770914">Min</span><span class="op" id="5770917">.</span><span class="ident" id="5770918">Y</span><span class="op" id="5770919">,</span>&nbsp;<span class="ident" id="5770921">mp</span><span class="op" id="5770923">.</span><span class="ident" id="5770924">Y</span><span class="op" id="5770925">;</span>&nbsp;<span class="ident" id="5770927">y</span>&nbsp;<span class="op" id="5770929">!=</span>&nbsp;<span class="ident" id="5770932">r</span><span class="op" id="5770933">.</span><span class="ident" id="5770934">Max</span><span class="op" id="5770937">.</span><span class="ident" id="5770938">Y</span><span class="op" id="5770939">;</span>&nbsp;<span class="ident" id="5770941">y</span><span class="op" id="5770942">,</span>&nbsp;<span class="ident" id="5770944">my</span>&nbsp;<span class="op" id="5770947">=</span>&nbsp;<span class="ident" id="5770949">y</span><span class="op" id="5770950">+</span><span class="num" id="5770951">1</span><span class="op" id="5770952">,</span>&nbsp;<span class="ident" id="5770954">my</span><span class="op" id="5770956">+</span><span class="num" id="5770957">1</span>&nbsp;<span class="op" id="5770959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770963">for</span>&nbsp;<span class="ident" id="5770967">i</span><span class="op" id="5770968">,</span>&nbsp;<span class="ident" id="5770970">mi</span>&nbsp;<span class="op" id="5770973">:=</span>&nbsp;<span class="ident" id="5770976">i0</span><span class="op" id="5770978">,</span>&nbsp;<span class="ident" id="5770980">mi0</span><span class="op" id="5770983">;</span>&nbsp;<span class="ident" id="5770985">i</span>&nbsp;<span class="op" id="5770987">&lt;</span>&nbsp;<span class="ident" id="5770989">i1</span><span class="op" id="5770991">;</span>&nbsp;<span class="ident" id="5770993">i</span><span class="op" id="5770994">,</span>&nbsp;<span class="ident" id="5770996">mi</span>&nbsp;<span class="op" id="5770999">=</span>&nbsp;<span class="ident" id="5771001">i</span><span class="op" id="5771002">+</span><span class="num" id="5771003">4</span><span class="op" id="5771004">,</span>&nbsp;<span class="ident" id="5771006">mi</span><span class="op" id="5771008">+</span><span class="num" id="5771009">1</span>&nbsp;<span class="op" id="5771011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771016">ma</span>&nbsp;<span class="op" id="5771019">:=</span>&nbsp;<span class="builtintype" id="5771022">uint32</span><span class="op" id="5771028">(</span><span class="ident" id="5771029">mask</span><span class="op" id="5771033">.</span><span class="ident" id="5771034">Pix</span><span class="op" id="5771037">[</span><span class="ident" id="5771038">mi</span><span class="op" id="5771040">]</span><span class="op" id="5771041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5771046">if</span>&nbsp;<span class="ident" id="5771049">ma</span>&nbsp;<span class="op" id="5771052">==</span>&nbsp;<span class="num" id="5771055">0</span>&nbsp;<span class="op" id="5771057">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5771063">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5771075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771080">ma</span>&nbsp;<span class="op" id="5771083">|=</span>&nbsp;<span class="ident" id="5771086">ma</span>&nbsp;<span class="op" id="5771089">&lt;&lt;</span>&nbsp;<span class="num" id="5771092">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771098">dr</span>&nbsp;<span class="op" id="5771101">:=</span>&nbsp;<span class="builtintype" id="5771104">uint32</span><span class="op" id="5771110">(</span><span class="ident" id="5771111">dst</span><span class="op" id="5771114">.</span><span class="ident" id="5771115">Pix</span><span class="op" id="5771118">[</span><span class="ident" id="5771119">i</span><span class="op" id="5771120">+</span><span class="num" id="5771121">0</span><span class="op" id="5771122">]</span><span class="op" id="5771123">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771128">dg</span>&nbsp;<span class="op" id="5771131">:=</span>&nbsp;<span class="builtintype" id="5771134">uint32</span><span class="op" id="5771140">(</span><span class="ident" id="5771141">dst</span><span class="op" id="5771144">.</span><span class="ident" id="5771145">Pix</span><span class="op" id="5771148">[</span><span class="ident" id="5771149">i</span><span class="op" id="5771150">+</span><span class="num" id="5771151">1</span><span class="op" id="5771152">]</span><span class="op" id="5771153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771158">db</span>&nbsp;<span class="op" id="5771161">:=</span>&nbsp;<span class="builtintype" id="5771164">uint32</span><span class="op" id="5771170">(</span><span class="ident" id="5771171">dst</span><span class="op" id="5771174">.</span><span class="ident" id="5771175">Pix</span><span class="op" id="5771178">[</span><span class="ident" id="5771179">i</span><span class="op" id="5771180">+</span><span class="num" id="5771181">2</span><span class="op" id="5771182">]</span><span class="op" id="5771183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771188">da</span>&nbsp;<span class="op" id="5771191">:=</span>&nbsp;<span class="builtintype" id="5771194">uint32</span><span class="op" id="5771200">(</span><span class="ident" id="5771201">dst</span><span class="op" id="5771204">.</span><span class="ident" id="5771205">Pix</span><span class="op" id="5771208">[</span><span class="ident" id="5771209">i</span><span class="op" id="5771210">+</span><span class="num" id="5771211">3</span><span class="op" id="5771212">]</span><span class="op" id="5771213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5771219">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771279">a</span>&nbsp;<span class="op" id="5771281">:=</span>&nbsp;<span class="op" id="5771284">(</span><span class="ident" id="5771285">m</span>&nbsp;<span class="op" id="5771287">-</span>&nbsp;<span class="op" id="5771289">(</span><span class="ident" id="5771290">sa</span>&nbsp;<span class="op" id="5771293">*</span>&nbsp;<span class="ident" id="5771295">ma</span>&nbsp;<span class="op" id="5771298">/</span>&nbsp;<span class="ident" id="5771300">m</span><span class="op" id="5771301">)</span><span class="op" id="5771302">)</span>&nbsp;<span class="op" id="5771304">*</span>&nbsp;<span class="num" id="5771306">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771316">dst</span><span class="op" id="5771319">.</span><span class="ident" id="5771320">Pix</span><span class="op" id="5771323">[</span><span class="ident" id="5771324">i</span><span class="op" id="5771325">+</span><span class="num" id="5771326">0</span><span class="op" id="5771327">]</span>&nbsp;<span class="op" id="5771329">=</span>&nbsp;<span class="builtintype" id="5771331">uint8</span><span class="op" id="5771336">(</span><span class="op" id="5771337">(</span><span class="ident" id="5771338">dr</span><span class="op" id="5771340">*</span><span class="ident" id="5771341">a</span>&nbsp;<span class="op" id="5771343">+</span>&nbsp;<span class="ident" id="5771345">sr</span><span class="op" id="5771347">*</span><span class="ident" id="5771348">ma</span><span class="op" id="5771350">)</span>&nbsp;<span class="op" id="5771352">/</span>&nbsp;<span class="ident" id="5771354">m</span>&nbsp;<span class="op" id="5771356">&gt;&gt;</span>&nbsp;<span class="num" id="5771359">8</span><span class="op" id="5771360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771365">dst</span><span class="op" id="5771368">.</span><span class="ident" id="5771369">Pix</span><span class="op" id="5771372">[</span><span class="ident" id="5771373">i</span><span class="op" id="5771374">+</span><span class="num" id="5771375">1</span><span class="op" id="5771376">]</span>&nbsp;<span class="op" id="5771378">=</span>&nbsp;<span class="builtintype" id="5771380">uint8</span><span class="op" id="5771385">(</span><span class="op" id="5771386">(</span><span class="ident" id="5771387">dg</span><span class="op" id="5771389">*</span><span class="ident" id="5771390">a</span>&nbsp;<span class="op" id="5771392">+</span>&nbsp;<span class="ident" id="5771394">sg</span><span class="op" id="5771396">*</span><span class="ident" id="5771397">ma</span><span class="op" id="5771399">)</span>&nbsp;<span class="op" id="5771401">/</span>&nbsp;<span class="ident" id="5771403">m</span>&nbsp;<span class="op" id="5771405">&gt;&gt;</span>&nbsp;<span class="num" id="5771408">8</span><span class="op" id="5771409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771414">dst</span><span class="op" id="5771417">.</span><span class="ident" id="5771418">Pix</span><span class="op" id="5771421">[</span><span class="ident" id="5771422">i</span><span class="op" id="5771423">+</span><span class="num" id="5771424">2</span><span class="op" id="5771425">]</span>&nbsp;<span class="op" id="5771427">=</span>&nbsp;<span class="builtintype" id="5771429">uint8</span><span class="op" id="5771434">(</span><span class="op" id="5771435">(</span><span class="ident" id="5771436">db</span><span class="op" id="5771438">*</span><span class="ident" id="5771439">a</span>&nbsp;<span class="op" id="5771441">+</span>&nbsp;<span class="ident" id="5771443">sb</span><span class="op" id="5771445">*</span><span class="ident" id="5771446">ma</span><span class="op" id="5771448">)</span>&nbsp;<span class="op" id="5771450">/</span>&nbsp;<span class="ident" id="5771452">m</span>&nbsp;<span class="op" id="5771454">&gt;&gt;</span>&nbsp;<span class="num" id="5771457">8</span><span class="op" id="5771458">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771463">dst</span><span class="op" id="5771466">.</span><span class="ident" id="5771467">Pix</span><span class="op" id="5771470">[</span><span class="ident" id="5771471">i</span><span class="op" id="5771472">+</span><span class="num" id="5771473">3</span><span class="op" id="5771474">]</span>&nbsp;<span class="op" id="5771476">=</span>&nbsp;<span class="builtintype" id="5771478">uint8</span><span class="op" id="5771483">(</span><span class="op" id="5771484">(</span><span class="ident" id="5771485">da</span><span class="op" id="5771487">*</span><span class="ident" id="5771488">a</span>&nbsp;<span class="op" id="5771490">+</span>&nbsp;<span class="ident" id="5771492">sa</span><span class="op" id="5771494">*</span><span class="ident" id="5771495">ma</span><span class="op" id="5771497">)</span>&nbsp;<span class="op" id="5771499">/</span>&nbsp;<span class="ident" id="5771501">m</span>&nbsp;<span class="op" id="5771503">&gt;&gt;</span>&nbsp;<span class="num" id="5771506">8</span><span class="op" id="5771507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5771511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771515">i0</span>&nbsp;<span class="op" id="5771518">+=</span>&nbsp;<span class="ident" id="5771521">dst</span><span class="op" id="5771524">.</span><span class="ident" id="5771525">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771534">i1</span>&nbsp;<span class="op" id="5771537">+=</span>&nbsp;<span class="ident" id="5771540">dst</span><span class="op" id="5771543">.</span><span class="ident" id="5771544">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771553">mi0</span>&nbsp;<span class="op" id="5771557">+=</span>&nbsp;<span class="ident" id="5771560">mask</span><span class="op" id="5771564">.</span><span class="ident" id="5771565">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5771573">}</span><br>
<span class="lineno"></span><span class="op" id="5771575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5771578">func</span>&nbsp;<span class="ident" id="5771583">drawRGBA</span><span class="op" id="5771591">(</span><span class="ident" id="5771592">dst</span>&nbsp;<span class="op" id="5771596">*</span><span class="ident" id="5771597">image</span><span class="op" id="5771602">.</span><span class="ident" id="5771603">RGBA</span><span class="op" id="5771607">,</span>&nbsp;<span class="ident" id="5771609">r</span>&nbsp;<span class="ident" id="5771611">image</span><span class="op" id="5771616">.</span><span class="ident" id="5771617">Rectangle</span><span class="op" id="5771626">,</span>&nbsp;<span class="ident" id="5771628">src</span>&nbsp;<span class="ident" id="5771632">image</span><span class="op" id="5771637">.</span><span class="ident" id="5771638">Image</span><span class="op" id="5771643">,</span>&nbsp;<span class="ident" id="5771645">sp</span>&nbsp;<span class="ident" id="5771648">image</span><span class="op" id="5771653">.</span><span class="ident" id="5771654">Point</span><span class="op" id="5771659">,</span>&nbsp;<span class="ident" id="5771661">mask</span>&nbsp;<span class="ident" id="5771666">image</span><span class="op" id="5771671">.</span><span class="ident" id="5771672">Image</span><span class="op" id="5771677">,</span>&nbsp;<span class="ident" id="5771679">mp</span>&nbsp;<span class="ident" id="5771682">image</span><span class="op" id="5771687">.</span><span class="ident" id="5771688">Point</span><span class="op" id="5771693">,</span>&nbsp;<span class="ident" id="5771695">op</span>&nbsp;<span class="ident" id="5771698">Op</span><span class="op" id="5771700">)</span>&nbsp;<span class="op" id="5771702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771705">x0</span><span class="op" id="5771707">,</span>&nbsp;<span class="ident" id="5771709">x1</span><span class="op" id="5771711">,</span>&nbsp;<span class="ident" id="5771713">dx</span>&nbsp;<span class="op" id="5771716">:=</span>&nbsp;<span class="ident" id="5771719">r</span><span class="op" id="5771720">.</span><span class="ident" id="5771721">Min</span><span class="op" id="5771724">.</span><span class="ident" id="5771725">X</span><span class="op" id="5771726">,</span>&nbsp;<span class="ident" id="5771728">r</span><span class="op" id="5771729">.</span><span class="ident" id="5771730">Max</span><span class="op" id="5771733">.</span><span class="ident" id="5771734">X</span><span class="op" id="5771735">,</span>&nbsp;<span class="num" id="5771737">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771740">y0</span><span class="op" id="5771742">,</span>&nbsp;<span class="ident" id="5771744">y1</span><span class="op" id="5771746">,</span>&nbsp;<span class="ident" id="5771748">dy</span>&nbsp;<span class="op" id="5771751">:=</span>&nbsp;<span class="ident" id="5771754">r</span><span class="op" id="5771755">.</span><span class="ident" id="5771756">Min</span><span class="op" id="5771759">.</span><span class="ident" id="5771760">Y</span><span class="op" id="5771761">,</span>&nbsp;<span class="ident" id="5771763">r</span><span class="op" id="5771764">.</span><span class="ident" id="5771765">Max</span><span class="op" id="5771768">.</span><span class="ident" id="5771769">Y</span><span class="op" id="5771770">,</span>&nbsp;<span class="num" id="5771772">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5771775">if</span>&nbsp;<span class="ident" id="5771778">image</span><span class="op" id="5771783">.</span><span class="ident" id="5771784">Image</span><span class="op" id="5771789">(</span><span class="ident" id="5771790">dst</span><span class="op" id="5771793">)</span>&nbsp;<span class="op" id="5771795">==</span>&nbsp;<span class="ident" id="5771798">src</span>&nbsp;<span class="op" id="5771802">&amp;&amp;</span>&nbsp;<span class="ident" id="5771805">r</span><span class="op" id="5771806">.</span><span class="ident" id="5771807">Overlaps</span><span class="op" id="5771815">(</span><span class="ident" id="5771816">r</span><span class="op" id="5771817">.</span><span class="ident" id="5771818">Add</span><span class="op" id="5771821">(</span><span class="ident" id="5771822">sp</span><span class="op" id="5771824">.</span><span class="ident" id="5771825">Sub</span><span class="op" id="5771828">(</span><span class="ident" id="5771829">r</span><span class="op" id="5771830">.</span><span class="ident" id="5771831">Min</span><span class="op" id="5771834">)</span><span class="op" id="5771835">)</span><span class="op" id="5771836">)</span>&nbsp;<span class="op" id="5771838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5771842">if</span>&nbsp;<span class="ident" id="5771845">sp</span><span class="op" id="5771847">.</span><span class="ident" id="5771848">Y</span>&nbsp;<span class="op" id="5771850">&lt;</span>&nbsp;<span class="ident" id="5771852">r</span><span class="op" id="5771853">.</span><span class="ident" id="5771854">Min</span><span class="op" id="5771857">.</span><span class="ident" id="5771858">Y</span>&nbsp;<span class="op" id="5771860">||</span>&nbsp;<span class="ident" id="5771863">sp</span><span class="op" id="5771865">.</span><span class="ident" id="5771866">Y</span>&nbsp;<span class="op" id="5771868">==</span>&nbsp;<span class="ident" id="5771871">r</span><span class="op" id="5771872">.</span><span class="ident" id="5771873">Min</span><span class="op" id="5771876">.</span><span class="ident" id="5771877">Y</span>&nbsp;<span class="op" id="5771879">&amp;&amp;</span>&nbsp;<span class="ident" id="5771882">sp</span><span class="op" id="5771884">.</span><span class="ident" id="5771885">X</span>&nbsp;<span class="op" id="5771887">&lt;</span>&nbsp;<span class="ident" id="5771889">r</span><span class="op" id="5771890">.</span><span class="ident" id="5771891">Min</span><span class="op" id="5771894">.</span><span class="ident" id="5771895">X</span>&nbsp;<span class="op" id="5771897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771902">x0</span><span class="op" id="5771904">,</span>&nbsp;<span class="ident" id="5771906">x1</span><span class="op" id="5771908">,</span>&nbsp;<span class="ident" id="5771910">dx</span>&nbsp;<span class="op" id="5771913">=</span>&nbsp;<span class="ident" id="5771915">x1</span><span class="op" id="5771917">-</span><span class="num" id="5771918">1</span><span class="op" id="5771919">,</span>&nbsp;<span class="ident" id="5771921">x0</span><span class="op" id="5771923">-</span><span class="num" id="5771924">1</span><span class="op" id="5771925">,</span>&nbsp;<span class="op" id="5771927">-</span><span class="num" id="5771928">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771933">y0</span><span class="op" id="5771935">,</span>&nbsp;<span class="ident" id="5771937">y1</span><span class="op" id="5771939">,</span>&nbsp;<span class="ident" id="5771941">dy</span>&nbsp;<span class="op" id="5771944">=</span>&nbsp;<span class="ident" id="5771946">y1</span><span class="op" id="5771948">-</span><span class="num" id="5771949">1</span><span class="op" id="5771950">,</span>&nbsp;<span class="ident" id="5771952">y0</span><span class="op" id="5771954">-</span><span class="num" id="5771955">1</span><span class="op" id="5771956">,</span>&nbsp;<span class="op" id="5771958">-</span><span class="num" id="5771959">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5771963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5771966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771970">sy</span>&nbsp;<span class="op" id="5771973">:=</span>&nbsp;<span class="ident" id="5771976">sp</span><span class="op" id="5771978">.</span><span class="ident" id="5771979">Y</span>&nbsp;<span class="op" id="5771981">+</span>&nbsp;<span class="ident" id="5771983">y0</span>&nbsp;<span class="op" id="5771986">-</span>&nbsp;<span class="ident" id="5771988">r</span><span class="op" id="5771989">.</span><span class="ident" id="5771990">Min</span><span class="op" id="5771993">.</span><span class="ident" id="5771994">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771997">my</span>&nbsp;<span class="op" id="5772000">:=</span>&nbsp;<span class="ident" id="5772003">mp</span><span class="op" id="5772005">.</span><span class="ident" id="5772006">Y</span>&nbsp;<span class="op" id="5772008">+</span>&nbsp;<span class="ident" id="5772010">y0</span>&nbsp;<span class="op" id="5772013">-</span>&nbsp;<span class="ident" id="5772015">r</span><span class="op" id="5772016">.</span><span class="ident" id="5772017">Min</span><span class="op" id="5772020">.</span><span class="ident" id="5772021">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772024">sx0</span>&nbsp;<span class="op" id="5772028">:=</span>&nbsp;<span class="ident" id="5772031">sp</span><span class="op" id="5772033">.</span><span class="ident" id="5772034">X</span>&nbsp;<span class="op" id="5772036">+</span>&nbsp;<span class="ident" id="5772038">x0</span>&nbsp;<span class="op" id="5772041">-</span>&nbsp;<span class="ident" id="5772043">r</span><span class="op" id="5772044">.</span><span class="ident" id="5772045">Min</span><span class="op" id="5772048">.</span><span class="ident" id="5772049">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772052">mx0</span>&nbsp;<span class="op" id="5772056">:=</span>&nbsp;<span class="ident" id="5772059">mp</span><span class="op" id="5772061">.</span><span class="ident" id="5772062">X</span>&nbsp;<span class="op" id="5772064">+</span>&nbsp;<span class="ident" id="5772066">x0</span>&nbsp;<span class="op" id="5772069">-</span>&nbsp;<span class="ident" id="5772071">r</span><span class="op" id="5772072">.</span><span class="ident" id="5772073">Min</span><span class="op" id="5772076">.</span><span class="ident" id="5772077">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772080">sx1</span>&nbsp;<span class="op" id="5772084">:=</span>&nbsp;<span class="ident" id="5772087">sx0</span>&nbsp;<span class="op" id="5772091">+</span>&nbsp;<span class="op" id="5772093">(</span><span class="ident" id="5772094">x1</span>&nbsp;<span class="op" id="5772097">-</span>&nbsp;<span class="ident" id="5772099">x0</span><span class="op" id="5772101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772104">i0</span>&nbsp;<span class="op" id="5772107">:=</span>&nbsp;<span class="ident" id="5772110">dst</span><span class="op" id="5772113">.</span><span class="ident" id="5772114">PixOffset</span><span class="op" id="5772123">(</span><span class="ident" id="5772124">x0</span><span class="op" id="5772126">,</span>&nbsp;<span class="ident" id="5772128">y0</span><span class="op" id="5772130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772133">di</span>&nbsp;<span class="op" id="5772136">:=</span>&nbsp;<span class="ident" id="5772139">dx</span>&nbsp;<span class="op" id="5772142">*</span>&nbsp;<span class="num" id="5772144">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5772147">for</span>&nbsp;<span class="ident" id="5772151">y</span>&nbsp;<span class="op" id="5772153">:=</span>&nbsp;<span class="ident" id="5772156">y0</span><span class="op" id="5772158">;</span>&nbsp;<span class="ident" id="5772160">y</span>&nbsp;<span class="op" id="5772162">!=</span>&nbsp;<span class="ident" id="5772165">y1</span><span class="op" id="5772167">;</span>&nbsp;<span class="ident" id="5772169">y</span><span class="op" id="5772170">,</span>&nbsp;<span class="ident" id="5772172">sy</span><span class="op" id="5772174">,</span>&nbsp;<span class="ident" id="5772176">my</span>&nbsp;<span class="op" id="5772179">=</span>&nbsp;<span class="ident" id="5772181">y</span><span class="op" id="5772182">+</span><span class="ident" id="5772183">dy</span><span class="op" id="5772185">,</span>&nbsp;<span class="ident" id="5772187">sy</span><span class="op" id="5772189">+</span><span class="ident" id="5772190">dy</span><span class="op" id="5772192">,</span>&nbsp;<span class="ident" id="5772194">my</span><span class="op" id="5772196">+</span><span class="ident" id="5772197">dy</span>&nbsp;<span class="op" id="5772200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5772204">for</span>&nbsp;<span class="ident" id="5772208">i</span><span class="op" id="5772209">,</span>&nbsp;<span class="ident" id="5772211">sx</span><span class="op" id="5772213">,</span>&nbsp;<span class="ident" id="5772215">mx</span>&nbsp;<span class="op" id="5772218">:=</span>&nbsp;<span class="ident" id="5772221">i0</span><span class="op" id="5772223">,</span>&nbsp;<span class="ident" id="5772225">sx0</span><span class="op" id="5772228">,</span>&nbsp;<span class="ident" id="5772230">mx0</span><span class="op" id="5772233">;</span>&nbsp;<span class="ident" id="5772235">sx</span>&nbsp;<span class="op" id="5772238">!=</span>&nbsp;<span class="ident" id="5772241">sx1</span><span class="op" id="5772244">;</span>&nbsp;<span class="ident" id="5772246">i</span><span class="op" id="5772247">,</span>&nbsp;<span class="ident" id="5772249">sx</span><span class="op" id="5772251">,</span>&nbsp;<span class="ident" id="5772253">mx</span>&nbsp;<span class="op" id="5772256">=</span>&nbsp;<span class="ident" id="5772258">i</span><span class="op" id="5772259">+</span><span class="ident" id="5772260">di</span><span class="op" id="5772262">,</span>&nbsp;<span class="ident" id="5772264">sx</span><span class="op" id="5772266">+</span><span class="ident" id="5772267">dx</span><span class="op" id="5772269">,</span>&nbsp;<span class="ident" id="5772271">mx</span><span class="op" id="5772273">+</span><span class="ident" id="5772274">dx</span>&nbsp;<span class="op" id="5772277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772282">ma</span>&nbsp;<span class="op" id="5772285">:=</span>&nbsp;<span class="builtintype" id="5772288">uint32</span><span class="op" id="5772294">(</span><span class="ident" id="5772295">m</span><span class="op" id="5772296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5772301">if</span>&nbsp;<span class="ident" id="5772304">mask</span>&nbsp;<span class="op" id="5772309">!=</span>&nbsp;<span class="builtintype" id="5772312">nil</span>&nbsp;<span class="op" id="5772316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772322">_</span><span class="op" id="5772323">,</span>&nbsp;<span class="ident" id="5772325">_</span><span class="op" id="5772326">,</span>&nbsp;<span class="ident" id="5772328">_</span><span class="op" id="5772329">,</span>&nbsp;<span class="ident" id="5772331">ma</span>&nbsp;<span class="op" id="5772334">=</span>&nbsp;<span class="ident" id="5772336">mask</span><span class="op" id="5772340">.</span><span class="ident" id="5772341">At</span><span class="op" id="5772343">(</span><span class="ident" id="5772344">mx</span><span class="op" id="5772346">,</span>&nbsp;<span class="ident" id="5772348">my</span><span class="op" id="5772350">)</span><span class="op" id="5772351">.</span><span class="ident" id="5772352">RGBA</span><span class="op" id="5772356">(</span><span class="op" id="5772357">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5772362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772367">sr</span><span class="op" id="5772369">,</span>&nbsp;<span class="ident" id="5772371">sg</span><span class="op" id="5772373">,</span>&nbsp;<span class="ident" id="5772375">sb</span><span class="op" id="5772377">,</span>&nbsp;<span class="ident" id="5772379">sa</span>&nbsp;<span class="op" id="5772382">:=</span>&nbsp;<span class="ident" id="5772385">src</span><span class="op" id="5772388">.</span><span class="ident" id="5772389">At</span><span class="op" id="5772391">(</span><span class="ident" id="5772392">sx</span><span class="op" id="5772394">,</span>&nbsp;<span class="ident" id="5772396">sy</span><span class="op" id="5772398">)</span><span class="op" id="5772399">.</span><span class="ident" id="5772400">RGBA</span><span class="op" id="5772404">(</span><span class="op" id="5772405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5772410">if</span>&nbsp;<span class="ident" id="5772413">op</span>&nbsp;<span class="op" id="5772416">==</span>&nbsp;<span class="ident" id="5772419">Over</span>&nbsp;<span class="op" id="5772424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772430">dr</span>&nbsp;<span class="op" id="5772433">:=</span>&nbsp;<span class="builtintype" id="5772436">uint32</span><span class="op" id="5772442">(</span><span class="ident" id="5772443">dst</span><span class="op" id="5772446">.</span><span class="ident" id="5772447">Pix</span><span class="op" id="5772450">[</span><span class="ident" id="5772451">i</span><span class="op" id="5772452">+</span><span class="num" id="5772453">0</span><span class="op" id="5772454">]</span><span class="op" id="5772455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772461">dg</span>&nbsp;<span class="op" id="5772464">:=</span>&nbsp;<span class="builtintype" id="5772467">uint32</span><span class="op" id="5772473">(</span><span class="ident" id="5772474">dst</span><span class="op" id="5772477">.</span><span class="ident" id="5772478">Pix</span><span class="op" id="5772481">[</span><span class="ident" id="5772482">i</span><span class="op" id="5772483">+</span><span class="num" id="5772484">1</span><span class="op" id="5772485">]</span><span class="op" id="5772486">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772492">db</span>&nbsp;<span class="op" id="5772495">:=</span>&nbsp;<span class="builtintype" id="5772498">uint32</span><span class="op" id="5772504">(</span><span class="ident" id="5772505">dst</span><span class="op" id="5772508">.</span><span class="ident" id="5772509">Pix</span><span class="op" id="5772512">[</span><span class="ident" id="5772513">i</span><span class="op" id="5772514">+</span><span class="num" id="5772515">2</span><span class="op" id="5772516">]</span><span class="op" id="5772517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772523">da</span>&nbsp;<span class="op" id="5772526">:=</span>&nbsp;<span class="builtintype" id="5772529">uint32</span><span class="op" id="5772535">(</span><span class="ident" id="5772536">dst</span><span class="op" id="5772539">.</span><span class="ident" id="5772540">Pix</span><span class="op" id="5772543">[</span><span class="ident" id="5772544">i</span><span class="op" id="5772545">+</span><span class="num" id="5772546">3</span><span class="op" id="5772547">]</span><span class="op" id="5772548">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5772555">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5772635">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5772693">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5772714">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5772780">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5772845">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772917">a</span>&nbsp;<span class="op" id="5772919">:=</span>&nbsp;<span class="op" id="5772922">(</span><span class="ident" id="5772923">m</span>&nbsp;<span class="op" id="5772925">-</span>&nbsp;<span class="op" id="5772927">(</span><span class="ident" id="5772928">sa</span>&nbsp;<span class="op" id="5772931">*</span>&nbsp;<span class="ident" id="5772933">ma</span>&nbsp;<span class="op" id="5772936">/</span>&nbsp;<span class="ident" id="5772938">m</span><span class="op" id="5772939">)</span><span class="op" id="5772940">)</span>&nbsp;<span class="op" id="5772942">*</span>&nbsp;<span class="num" id="5772944">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772955">dst</span><span class="op" id="5772958">.</span><span class="ident" id="5772959">Pix</span><span class="op" id="5772962">[</span><span class="ident" id="5772963">i</span><span class="op" id="5772964">+</span><span class="num" id="5772965">0</span><span class="op" id="5772966">]</span>&nbsp;<span class="op" id="5772968">=</span>&nbsp;<span class="builtintype" id="5772970">uint8</span><span class="op" id="5772975">(</span><span class="op" id="5772976">(</span><span class="ident" id="5772977">dr</span><span class="op" id="5772979">*</span><span class="ident" id="5772980">a</span>&nbsp;<span class="op" id="5772982">+</span>&nbsp;<span class="ident" id="5772984">sr</span><span class="op" id="5772986">*</span><span class="ident" id="5772987">ma</span><span class="op" id="5772989">)</span>&nbsp;<span class="op" id="5772991">/</span>&nbsp;<span class="ident" id="5772993">m</span>&nbsp;<span class="op" id="5772995">&gt;&gt;</span>&nbsp;<span class="num" id="5772998">8</span><span class="op" id="5772999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773005">dst</span><span class="op" id="5773008">.</span><span class="ident" id="5773009">Pix</span><span class="op" id="5773012">[</span><span class="ident" id="5773013">i</span><span class="op" id="5773014">+</span><span class="num" id="5773015">1</span><span class="op" id="5773016">]</span>&nbsp;<span class="op" id="5773018">=</span>&nbsp;<span class="builtintype" id="5773020">uint8</span><span class="op" id="5773025">(</span><span class="op" id="5773026">(</span><span class="ident" id="5773027">dg</span><span class="op" id="5773029">*</span><span class="ident" id="5773030">a</span>&nbsp;<span class="op" id="5773032">+</span>&nbsp;<span class="ident" id="5773034">sg</span><span class="op" id="5773036">*</span><span class="ident" id="5773037">ma</span><span class="op" id="5773039">)</span>&nbsp;<span class="op" id="5773041">/</span>&nbsp;<span class="ident" id="5773043">m</span>&nbsp;<span class="op" id="5773045">&gt;&gt;</span>&nbsp;<span class="num" id="5773048">8</span><span class="op" id="5773049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773055">dst</span><span class="op" id="5773058">.</span><span class="ident" id="5773059">Pix</span><span class="op" id="5773062">[</span><span class="ident" id="5773063">i</span><span class="op" id="5773064">+</span><span class="num" id="5773065">2</span><span class="op" id="5773066">]</span>&nbsp;<span class="op" id="5773068">=</span>&nbsp;<span class="builtintype" id="5773070">uint8</span><span class="op" id="5773075">(</span><span class="op" id="5773076">(</span><span class="ident" id="5773077">db</span><span class="op" id="5773079">*</span><span class="ident" id="5773080">a</span>&nbsp;<span class="op" id="5773082">+</span>&nbsp;<span class="ident" id="5773084">sb</span><span class="op" id="5773086">*</span><span class="ident" id="5773087">ma</span><span class="op" id="5773089">)</span>&nbsp;<span class="op" id="5773091">/</span>&nbsp;<span class="ident" id="5773093">m</span>&nbsp;<span class="op" id="5773095">&gt;&gt;</span>&nbsp;<span class="num" id="5773098">8</span><span class="op" id="5773099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773105">dst</span><span class="op" id="5773108">.</span><span class="ident" id="5773109">Pix</span><span class="op" id="5773112">[</span><span class="ident" id="5773113">i</span><span class="op" id="5773114">+</span><span class="num" id="5773115">3</span><span class="op" id="5773116">]</span>&nbsp;<span class="op" id="5773118">=</span>&nbsp;<span class="builtintype" id="5773120">uint8</span><span class="op" id="5773125">(</span><span class="op" id="5773126">(</span><span class="ident" id="5773127">da</span><span class="op" id="5773129">*</span><span class="ident" id="5773130">a</span>&nbsp;<span class="op" id="5773132">+</span>&nbsp;<span class="ident" id="5773134">sa</span><span class="op" id="5773136">*</span><span class="ident" id="5773137">ma</span><span class="op" id="5773139">)</span>&nbsp;<span class="op" id="5773141">/</span>&nbsp;<span class="ident" id="5773143">m</span>&nbsp;<span class="op" id="5773145">&gt;&gt;</span>&nbsp;<span class="num" id="5773148">8</span><span class="op" id="5773149">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5773155">}</span>&nbsp;<span class="keyword" id="5773157">else</span>&nbsp;<span class="op" id="5773162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773168">dst</span><span class="op" id="5773171">.</span><span class="ident" id="5773172">Pix</span><span class="op" id="5773175">[</span><span class="ident" id="5773176">i</span><span class="op" id="5773177">+</span><span class="num" id="5773178">0</span><span class="op" id="5773179">]</span>&nbsp;<span class="op" id="5773181">=</span>&nbsp;<span class="builtintype" id="5773183">uint8</span><span class="op" id="5773188">(</span><span class="ident" id="5773189">sr</span>&nbsp;<span class="op" id="5773192">*</span>&nbsp;<span class="ident" id="5773194">ma</span>&nbsp;<span class="op" id="5773197">/</span>&nbsp;<span class="ident" id="5773199">m</span>&nbsp;<span class="op" id="5773201">&gt;&gt;</span>&nbsp;<span class="num" id="5773204">8</span><span class="op" id="5773205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773211">dst</span><span class="op" id="5773214">.</span><span class="ident" id="5773215">Pix</span><span class="op" id="5773218">[</span><span class="ident" id="5773219">i</span><span class="op" id="5773220">+</span><span class="num" id="5773221">1</span><span class="op" id="5773222">]</span>&nbsp;<span class="op" id="5773224">=</span>&nbsp;<span class="builtintype" id="5773226">uint8</span><span class="op" id="5773231">(</span><span class="ident" id="5773232">sg</span>&nbsp;<span class="op" id="5773235">*</span>&nbsp;<span class="ident" id="5773237">ma</span>&nbsp;<span class="op" id="5773240">/</span>&nbsp;<span class="ident" id="5773242">m</span>&nbsp;<span class="op" id="5773244">&gt;&gt;</span>&nbsp;<span class="num" id="5773247">8</span><span class="op" id="5773248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773254">dst</span><span class="op" id="5773257">.</span><span class="ident" id="5773258">Pix</span><span class="op" id="5773261">[</span><span class="ident" id="5773262">i</span><span class="op" id="5773263">+</span><span class="num" id="5773264">2</span><span class="op" id="5773265">]</span>&nbsp;<span class="op" id="5773267">=</span>&nbsp;<span class="builtintype" id="5773269">uint8</span><span class="op" id="5773274">(</span><span class="ident" id="5773275">sb</span>&nbsp;<span class="op" id="5773278">*</span>&nbsp;<span class="ident" id="5773280">ma</span>&nbsp;<span class="op" id="5773283">/</span>&nbsp;<span class="ident" id="5773285">m</span>&nbsp;<span class="op" id="5773287">&gt;&gt;</span>&nbsp;<span class="num" id="5773290">8</span><span class="op" id="5773291">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773297">dst</span><span class="op" id="5773300">.</span><span class="ident" id="5773301">Pix</span><span class="op" id="5773304">[</span><span class="ident" id="5773305">i</span><span class="op" id="5773306">+</span><span class="num" id="5773307">3</span><span class="op" id="5773308">]</span>&nbsp;<span class="op" id="5773310">=</span>&nbsp;<span class="builtintype" id="5773312">uint8</span><span class="op" id="5773317">(</span><span class="ident" id="5773318">sa</span>&nbsp;<span class="op" id="5773321">*</span>&nbsp;<span class="ident" id="5773323">ma</span>&nbsp;<span class="op" id="5773326">/</span>&nbsp;<span class="ident" id="5773328">m</span>&nbsp;<span class="op" id="5773330">&gt;&gt;</span>&nbsp;<span class="num" id="5773333">8</span><span class="op" id="5773334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5773339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5773343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773347">i0</span>&nbsp;<span class="op" id="5773350">+=</span>&nbsp;<span class="ident" id="5773353">dy</span>&nbsp;<span class="op" id="5773356">*</span>&nbsp;<span class="ident" id="5773358">dst</span><span class="op" id="5773361">.</span><span class="ident" id="5773362">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5773370">}</span><br>
<span class="lineno">545</span><span class="op" id="5773372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5773375">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="5773422">func</span>&nbsp;<span class="ident" id="5773427">clamp</span><span class="op" id="5773432">(</span><span class="ident" id="5773433">i</span>&nbsp;<span class="builtintype" id="5773435">int32</span><span class="op" id="5773440">)</span>&nbsp;<span class="builtintype" id="5773442">int32</span>&nbsp;<span class="op" id="5773448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773451">if</span>&nbsp;<span class="ident" id="5773454">i</span>&nbsp;<span class="op" id="5773456">&lt;</span>&nbsp;<span class="num" id="5773458">0</span>&nbsp;<span class="op" id="5773460">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773464">return</span>&nbsp;<span class="num" id="5773471">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5773474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773477">if</span>&nbsp;<span class="ident" id="5773480">i</span>&nbsp;<span class="op" id="5773482">&gt;</span>&nbsp;<span class="num" id="5773484">0xffff</span>&nbsp;<span class="op" id="5773491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773495">return</span>&nbsp;<span class="num" id="5773502">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5773510">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773513">return</span>&nbsp;<span class="ident" id="5773520">i</span><br>
<span class="lineno"></span><span class="op" id="5773522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5773525">func</span>&nbsp;<span class="ident" id="5773530">drawPaletted</span><span class="op" id="5773542">(</span><span class="ident" id="5773543">dst</span>&nbsp;<span class="ident" id="5773547">Image</span><span class="op" id="5773552">,</span>&nbsp;<span class="ident" id="5773554">r</span>&nbsp;<span class="ident" id="5773556">image</span><span class="op" id="5773561">.</span><span class="ident" id="5773562">Rectangle</span><span class="op" id="5773571">,</span>&nbsp;<span class="ident" id="5773573">src</span>&nbsp;<span class="ident" id="5773577">image</span><span class="op" id="5773582">.</span><span class="ident" id="5773583">Image</span><span class="op" id="5773588">,</span>&nbsp;<span class="ident" id="5773590">sp</span>&nbsp;<span class="ident" id="5773593">image</span><span class="op" id="5773598">.</span><span class="ident" id="5773599">Point</span><span class="op" id="5773604">,</span>&nbsp;<span class="ident" id="5773606">floydSteinberg</span>&nbsp;<span class="builtintype" id="5773621">bool</span><span class="op" id="5773625">)</span>&nbsp;<span class="op" id="5773627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5773630">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5773697">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5773762">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5773825">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5773895">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5773966">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5774037">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774083">palette</span><span class="op" id="5774090">,</span>&nbsp;<span class="ident" id="5774092">pix</span><span class="op" id="5774095">,</span>&nbsp;<span class="ident" id="5774097">stride</span>&nbsp;<span class="op" id="5774104">:=</span>&nbsp;<span class="op" id="5774107">[</span><span class="op" id="5774108">]</span><span class="op" id="5774109">[</span><span class="num" id="5774110">3</span><span class="op" id="5774111">]</span><span class="builtintype" id="5774112">int32</span><span class="op" id="5774117">(</span><span class="builtintype" id="5774118">nil</span><span class="op" id="5774121">)</span><span class="op" id="5774122">,</span>&nbsp;<span class="op" id="5774124">[</span><span class="op" id="5774125">]</span><span class="builtintype" id="5774126">byte</span><span class="op" id="5774130">(</span><span class="builtintype" id="5774131">nil</span><span class="op" id="5774134">)</span><span class="op" id="5774135">,</span>&nbsp;<span class="num" id="5774137">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774140">if</span>&nbsp;<span class="ident" id="5774143">p</span><span class="op" id="5774144">,</span>&nbsp;<span class="ident" id="5774146">ok</span>&nbsp;<span class="op" id="5774149">:=</span>&nbsp;<span class="ident" id="5774152">dst</span><span class="op" id="5774155">.</span><span class="op" id="5774156">(</span><span class="op" id="5774157">*</span><span class="ident" id="5774158">image</span><span class="op" id="5774163">.</span><span class="ident" id="5774164">Paletted</span><span class="op" id="5774172">)</span><span class="op" id="5774173">;</span>&nbsp;<span class="ident" id="5774175">ok</span>&nbsp;<span class="op" id="5774178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774182">palette</span>&nbsp;<span class="op" id="5774190">=</span>&nbsp;<span class="builtinfunc" id="5774192">make</span><span class="op" id="5774196">(</span><span class="op" id="5774197">[</span><span class="op" id="5774198">]</span><span class="op" id="5774199">[</span><span class="num" id="5774200">3</span><span class="op" id="5774201">]</span><span class="builtintype" id="5774202">int32</span><span class="op" id="5774207">,</span>&nbsp;<span class="builtinfunc" id="5774209">len</span><span class="op" id="5774212">(</span><span class="ident" id="5774213">p</span><span class="op" id="5774214">.</span><span class="ident" id="5774215">Palette</span><span class="op" id="5774222">)</span><span class="op" id="5774223">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774227">for</span>&nbsp;<span class="ident" id="5774231">i</span><span class="op" id="5774232">,</span>&nbsp;<span class="ident" id="5774234">col</span>&nbsp;<span class="op" id="5774238">:=</span>&nbsp;<span class="keyword" id="5774241">range</span>&nbsp;<span class="ident" id="5774247">p</span><span class="op" id="5774248">.</span><span class="ident" id="5774249">Palette</span>&nbsp;<span class="op" id="5774257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774262">r</span><span class="op" id="5774263">,</span>&nbsp;<span class="ident" id="5774265">g</span><span class="op" id="5774266">,</span>&nbsp;<span class="ident" id="5774268">b</span><span class="op" id="5774269">,</span>&nbsp;<span class="ident" id="5774271">_</span>&nbsp;<span class="op" id="5774273">:=</span>&nbsp;<span class="ident" id="5774276">col</span><span class="op" id="5774279">.</span><span class="ident" id="5774280">RGBA</span><span class="op" id="5774284">(</span><span class="op" id="5774285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774290">palette</span><span class="op" id="5774297">[</span><span class="ident" id="5774298">i</span><span class="op" id="5774299">]</span><span class="op" id="5774300">[</span><span class="num" id="5774301">0</span><span class="op" id="5774302">]</span>&nbsp;<span class="op" id="5774304">=</span>&nbsp;<span class="builtintype" id="5774306">int32</span><span class="op" id="5774311">(</span><span class="ident" id="5774312">r</span><span class="op" id="5774313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774318">palette</span><span class="op" id="5774325">[</span><span class="ident" id="5774326">i</span><span class="op" id="5774327">]</span><span class="op" id="5774328">[</span><span class="num" id="5774329">1</span><span class="op" id="5774330">]</span>&nbsp;<span class="op" id="5774332">=</span>&nbsp;<span class="builtintype" id="5774334">int32</span><span class="op" id="5774339">(</span><span class="ident" id="5774340">g</span><span class="op" id="5774341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774346">palette</span><span class="op" id="5774353">[</span><span class="ident" id="5774354">i</span><span class="op" id="5774355">]</span><span class="op" id="5774356">[</span><span class="num" id="5774357">2</span><span class="op" id="5774358">]</span>&nbsp;<span class="op" id="5774360">=</span>&nbsp;<span class="builtintype" id="5774362">int32</span><span class="op" id="5774367">(</span><span class="ident" id="5774368">b</span><span class="op" id="5774369">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5774373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774377">pix</span><span class="op" id="5774380">,</span>&nbsp;<span class="ident" id="5774382">stride</span>&nbsp;<span class="op" id="5774389">=</span>&nbsp;<span class="ident" id="5774391">p</span><span class="op" id="5774392">.</span><span class="ident" id="5774393">Pix</span><span class="op" id="5774396">[</span><span class="ident" id="5774397">p</span><span class="op" id="5774398">.</span><span class="ident" id="5774399">PixOffset</span><span class="op" id="5774408">(</span><span class="ident" id="5774409">r</span><span class="op" id="5774410">.</span><span class="ident" id="5774411">Min</span><span class="op" id="5774414">.</span><span class="ident" id="5774415">X</span><span class="op" id="5774416">,</span>&nbsp;<span class="ident" id="5774418">r</span><span class="op" id="5774419">.</span><span class="ident" id="5774420">Min</span><span class="op" id="5774423">.</span><span class="ident" id="5774424">Y</span><span class="op" id="5774425">)</span><span class="op" id="5774426">:</span><span class="op" id="5774427">]</span><span class="op" id="5774428">,</span>&nbsp;<span class="ident" id="5774430">p</span><span class="op" id="5774431">.</span><span class="ident" id="5774432">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5774440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5774444">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5774519">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5774594">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774650">var</span>&nbsp;<span class="ident" id="5774654">quantErrorCurr</span><span class="op" id="5774668">,</span>&nbsp;<span class="ident" id="5774670">quantErrorNext</span>&nbsp;<span class="op" id="5774685">[</span><span class="op" id="5774686">]</span><span class="op" id="5774687">[</span><span class="num" id="5774688">3</span><span class="op" id="5774689">]</span><span class="builtintype" id="5774690">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774697">if</span>&nbsp;<span class="ident" id="5774700">floydSteinberg</span>&nbsp;<span class="op" id="5774715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774719">quantErrorCurr</span>&nbsp;<span class="op" id="5774734">=</span>&nbsp;<span class="builtinfunc" id="5774736">make</span><span class="op" id="5774740">(</span><span class="op" id="5774741">[</span><span class="op" id="5774742">]</span><span class="op" id="5774743">[</span><span class="num" id="5774744">3</span><span class="op" id="5774745">]</span><span class="builtintype" id="5774746">int32</span><span class="op" id="5774751">,</span>&nbsp;<span class="ident" id="5774753">r</span><span class="op" id="5774754">.</span><span class="ident" id="5774755">Dx</span><span class="op" id="5774757">(</span><span class="op" id="5774758">)</span><span class="op" id="5774759">+</span><span class="num" id="5774760">2</span><span class="op" id="5774761">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774765">quantErrorNext</span>&nbsp;<span class="op" id="5774780">=</span>&nbsp;<span class="builtinfunc" id="5774782">make</span><span class="op" id="5774786">(</span><span class="op" id="5774787">[</span><span class="op" id="5774788">]</span><span class="op" id="5774789">[</span><span class="num" id="5774790">3</span><span class="op" id="5774791">]</span><span class="builtintype" id="5774792">int32</span><span class="op" id="5774797">,</span>&nbsp;<span class="ident" id="5774799">r</span><span class="op" id="5774800">.</span><span class="ident" id="5774801">Dx</span><span class="op" id="5774803">(</span><span class="op" id="5774804">)</span><span class="op" id="5774805">+</span><span class="num" id="5774806">2</span><span class="op" id="5774807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5774810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5774814">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774847">out</span>&nbsp;<span class="op" id="5774851">:=</span>&nbsp;<span class="ident" id="5774854">color</span><span class="op" id="5774859">.</span><span class="ident" id="5774860">RGBA64</span><span class="op" id="5774866">{</span><span class="ident" id="5774867">A</span><span class="op" id="5774868">:</span>&nbsp;<span class="num" id="5774870">0xffff</span><span class="op" id="5774876">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774879">for</span>&nbsp;<span class="ident" id="5774883">y</span>&nbsp;<span class="op" id="5774885">:=</span>&nbsp;<span class="num" id="5774888">0</span><span class="op" id="5774889">;</span>&nbsp;<span class="ident" id="5774891">y</span>&nbsp;<span class="op" id="5774893">!=</span>&nbsp;<span class="ident" id="5774896">r</span><span class="op" id="5774897">.</span><span class="ident" id="5774898">Dy</span><span class="op" id="5774900">(</span><span class="op" id="5774901">)</span><span class="op" id="5774902">;</span>&nbsp;<span class="ident" id="5774904">y</span><span class="op" id="5774905">++</span>&nbsp;<span class="op" id="5774908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774912">for</span>&nbsp;<span class="ident" id="5774916">x</span>&nbsp;<span class="op" id="5774918">:=</span>&nbsp;<span class="num" id="5774921">0</span><span class="op" id="5774922">;</span>&nbsp;<span class="ident" id="5774924">x</span>&nbsp;<span class="op" id="5774926">!=</span>&nbsp;<span class="ident" id="5774929">r</span><span class="op" id="5774930">.</span><span class="ident" id="5774931">Dx</span><span class="op" id="5774933">(</span><span class="op" id="5774934">)</span><span class="op" id="5774935">;</span>&nbsp;<span class="ident" id="5774937">x</span><span class="op" id="5774938">++</span>&nbsp;<span class="op" id="5774941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5774946">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5775004">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775042">sr</span><span class="op" id="5775044">,</span>&nbsp;<span class="ident" id="5775046">sg</span><span class="op" id="5775048">,</span>&nbsp;<span class="ident" id="5775050">sb</span><span class="op" id="5775052">,</span>&nbsp;<span class="ident" id="5775054">_</span>&nbsp;<span class="op" id="5775056">:=</span>&nbsp;<span class="ident" id="5775059">src</span><span class="op" id="5775062">.</span><span class="ident" id="5775063">At</span><span class="op" id="5775065">(</span><span class="ident" id="5775066">sp</span><span class="op" id="5775068">.</span><span class="ident" id="5775069">X</span><span class="op" id="5775070">+</span><span class="ident" id="5775071">x</span><span class="op" id="5775072">,</span>&nbsp;<span class="ident" id="5775074">sp</span><span class="op" id="5775076">.</span><span class="ident" id="5775077">Y</span><span class="op" id="5775078">+</span><span class="ident" id="5775079">y</span><span class="op" id="5775080">)</span><span class="op" id="5775081">.</span><span class="ident" id="5775082">RGBA</span><span class="op" id="5775086">(</span><span class="op" id="5775087">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775092">er</span><span class="op" id="5775094">,</span>&nbsp;<span class="ident" id="5775096">eg</span><span class="op" id="5775098">,</span>&nbsp;<span class="ident" id="5775100">eb</span>&nbsp;<span class="op" id="5775103">:=</span>&nbsp;<span class="builtintype" id="5775106">int32</span><span class="op" id="5775111">(</span><span class="ident" id="5775112">sr</span><span class="op" id="5775114">)</span><span class="op" id="5775115">,</span>&nbsp;<span class="builtintype" id="5775117">int32</span><span class="op" id="5775122">(</span><span class="ident" id="5775123">sg</span><span class="op" id="5775125">)</span><span class="op" id="5775126">,</span>&nbsp;<span class="builtintype" id="5775128">int32</span><span class="op" id="5775133">(</span><span class="ident" id="5775134">sb</span><span class="op" id="5775136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775141">if</span>&nbsp;<span class="ident" id="5775144">floydSteinberg</span>&nbsp;<span class="op" id="5775159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775165">er</span>&nbsp;<span class="op" id="5775168">=</span>&nbsp;<span class="ident" id="5775170">clamp</span><span class="op" id="5775175">(</span><span class="ident" id="5775176">er</span>&nbsp;<span class="op" id="5775179">+</span>&nbsp;<span class="ident" id="5775181">quantErrorCurr</span><span class="op" id="5775195">[</span><span class="ident" id="5775196">x</span><span class="op" id="5775197">+</span><span class="num" id="5775198">1</span><span class="op" id="5775199">]</span><span class="op" id="5775200">[</span><span class="num" id="5775201">0</span><span class="op" id="5775202">]</span><span class="op" id="5775203">/</span><span class="num" id="5775204">16</span><span class="op" id="5775206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775212">eg</span>&nbsp;<span class="op" id="5775215">=</span>&nbsp;<span class="ident" id="5775217">clamp</span><span class="op" id="5775222">(</span><span class="ident" id="5775223">eg</span>&nbsp;<span class="op" id="5775226">+</span>&nbsp;<span class="ident" id="5775228">quantErrorCurr</span><span class="op" id="5775242">[</span><span class="ident" id="5775243">x</span><span class="op" id="5775244">+</span><span class="num" id="5775245">1</span><span class="op" id="5775246">]</span><span class="op" id="5775247">[</span><span class="num" id="5775248">1</span><span class="op" id="5775249">]</span><span class="op" id="5775250">/</span><span class="num" id="5775251">16</span><span class="op" id="5775253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775259">eb</span>&nbsp;<span class="op" id="5775262">=</span>&nbsp;<span class="ident" id="5775264">clamp</span><span class="op" id="5775269">(</span><span class="ident" id="5775270">eb</span>&nbsp;<span class="op" id="5775273">+</span>&nbsp;<span class="ident" id="5775275">quantErrorCurr</span><span class="op" id="5775289">[</span><span class="ident" id="5775290">x</span><span class="op" id="5775291">+</span><span class="num" id="5775292">1</span><span class="op" id="5775293">]</span><span class="op" id="5775294">[</span><span class="num" id="5775295">2</span><span class="op" id="5775296">]</span><span class="op" id="5775297">/</span><span class="num" id="5775298">16</span><span class="op" id="5775300">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5775305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775311">if</span>&nbsp;<span class="ident" id="5775314">palette</span>&nbsp;<span class="op" id="5775322">!=</span>&nbsp;<span class="builtintype" id="5775325">nil</span>&nbsp;<span class="op" id="5775329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5775335">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5775403">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5775471">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5775540">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775592">bestIndex</span><span class="op" id="5775601">,</span>&nbsp;<span class="ident" id="5775603">bestSSD</span>&nbsp;<span class="op" id="5775611">:=</span>&nbsp;<span class="num" id="5775614">0</span><span class="op" id="5775615">,</span>&nbsp;<span class="builtintype" id="5775617">uint32</span><span class="op" id="5775623">(</span><span class="num" id="5775624">1</span><span class="op" id="5775625">&lt;&lt;</span><span class="num" id="5775627">32</span><span class="op" id="5775629">-</span><span class="num" id="5775630">1</span><span class="op" id="5775631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775637">for</span>&nbsp;<span class="ident" id="5775641">index</span><span class="op" id="5775646">,</span>&nbsp;<span class="ident" id="5775648">p</span>&nbsp;<span class="op" id="5775650">:=</span>&nbsp;<span class="keyword" id="5775653">range</span>&nbsp;<span class="ident" id="5775659">palette</span>&nbsp;<span class="op" id="5775667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775674">delta</span>&nbsp;<span class="op" id="5775680">:=</span>&nbsp;<span class="op" id="5775683">(</span><span class="ident" id="5775684">er</span>&nbsp;<span class="op" id="5775687">-</span>&nbsp;<span class="ident" id="5775689">p</span><span class="op" id="5775690">[</span><span class="num" id="5775691">0</span><span class="op" id="5775692">]</span><span class="op" id="5775693">)</span>&nbsp;<span class="op" id="5775695">&gt;&gt;</span>&nbsp;<span class="num" id="5775698">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775705">ssd</span>&nbsp;<span class="op" id="5775709">:=</span>&nbsp;<span class="builtintype" id="5775712">uint32</span><span class="op" id="5775718">(</span><span class="ident" id="5775719">delta</span>&nbsp;<span class="op" id="5775725">*</span>&nbsp;<span class="ident" id="5775727">delta</span><span class="op" id="5775732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775739">delta</span>&nbsp;<span class="op" id="5775745">=</span>&nbsp;<span class="op" id="5775747">(</span><span class="ident" id="5775748">eg</span>&nbsp;<span class="op" id="5775751">-</span>&nbsp;<span class="ident" id="5775753">p</span><span class="op" id="5775754">[</span><span class="num" id="5775755">1</span><span class="op" id="5775756">]</span><span class="op" id="5775757">)</span>&nbsp;<span class="op" id="5775759">&gt;&gt;</span>&nbsp;<span class="num" id="5775762">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775769">ssd</span>&nbsp;<span class="op" id="5775773">+=</span>&nbsp;<span class="builtintype" id="5775776">uint32</span><span class="op" id="5775782">(</span><span class="ident" id="5775783">delta</span>&nbsp;<span class="op" id="5775789">*</span>&nbsp;<span class="ident" id="5775791">delta</span><span class="op" id="5775796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775803">delta</span>&nbsp;<span class="op" id="5775809">=</span>&nbsp;<span class="op" id="5775811">(</span><span class="ident" id="5775812">eb</span>&nbsp;<span class="op" id="5775815">-</span>&nbsp;<span class="ident" id="5775817">p</span><span class="op" id="5775818">[</span><span class="num" id="5775819">2</span><span class="op" id="5775820">]</span><span class="op" id="5775821">)</span>&nbsp;<span class="op" id="5775823">&gt;&gt;</span>&nbsp;<span class="num" id="5775826">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775833">ssd</span>&nbsp;<span class="op" id="5775837">+=</span>&nbsp;<span class="builtintype" id="5775840">uint32</span><span class="op" id="5775846">(</span><span class="ident" id="5775847">delta</span>&nbsp;<span class="op" id="5775853">*</span>&nbsp;<span class="ident" id="5775855">delta</span><span class="op" id="5775860">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775867">if</span>&nbsp;<span class="ident" id="5775870">ssd</span>&nbsp;<span class="op" id="5775874">&lt;</span>&nbsp;<span class="ident" id="5775876">bestSSD</span>&nbsp;<span class="op" id="5775884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775892">bestIndex</span><span class="op" id="5775901">,</span>&nbsp;<span class="ident" id="5775903">bestSSD</span>&nbsp;<span class="op" id="5775911">=</span>&nbsp;<span class="ident" id="5775913">index</span><span class="op" id="5775918">,</span>&nbsp;<span class="ident" id="5775920">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775930">if</span>&nbsp;<span class="ident" id="5775933">ssd</span>&nbsp;<span class="op" id="5775937">==</span>&nbsp;<span class="num" id="5775940">0</span>&nbsp;<span class="op" id="5775942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775951">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5775963">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5775970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5775976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775982">pix</span><span class="op" id="5775985">[</span><span class="ident" id="5775986">y</span><span class="op" id="5775987">*</span><span class="ident" id="5775988">stride</span><span class="op" id="5775994">+</span><span class="ident" id="5775995">x</span><span class="op" id="5775996">]</span>&nbsp;<span class="op" id="5775998">=</span>&nbsp;<span class="builtintype" id="5776000">byte</span><span class="op" id="5776004">(</span><span class="ident" id="5776005">bestIndex</span><span class="op" id="5776014">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5776021">if</span>&nbsp;<span class="op" id="5776024">!</span><span class="ident" id="5776025">floydSteinberg</span>&nbsp;<span class="op" id="5776040">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5776047">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776066">er</span>&nbsp;<span class="op" id="5776069">-=</span>&nbsp;<span class="builtintype" id="5776072">int32</span><span class="op" id="5776077">(</span><span class="ident" id="5776078">palette</span><span class="op" id="5776085">[</span><span class="ident" id="5776086">bestIndex</span><span class="op" id="5776095">]</span><span class="op" id="5776096">[</span><span class="num" id="5776097">0</span><span class="op" id="5776098">]</span><span class="op" id="5776099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776105">eg</span>&nbsp;<span class="op" id="5776108">-=</span>&nbsp;<span class="builtintype" id="5776111">int32</span><span class="op" id="5776116">(</span><span class="ident" id="5776117">palette</span><span class="op" id="5776124">[</span><span class="ident" id="5776125">bestIndex</span><span class="op" id="5776134">]</span><span class="op" id="5776135">[</span><span class="num" id="5776136">1</span><span class="op" id="5776137">]</span><span class="op" id="5776138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776144">eb</span>&nbsp;<span class="op" id="5776147">-=</span>&nbsp;<span class="builtintype" id="5776150">int32</span><span class="op" id="5776155">(</span><span class="ident" id="5776156">palette</span><span class="op" id="5776163">[</span><span class="ident" id="5776164">bestIndex</span><span class="op" id="5776173">]</span><span class="op" id="5776174">[</span><span class="num" id="5776175">2</span><span class="op" id="5776176">]</span><span class="op" id="5776177">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776183">}</span>&nbsp;<span class="keyword" id="5776185">else</span>&nbsp;<span class="op" id="5776190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776196">out</span><span class="op" id="5776199">.</span><span class="ident" id="5776200">R</span>&nbsp;<span class="op" id="5776202">=</span>&nbsp;<span class="builtintype" id="5776204">uint16</span><span class="op" id="5776210">(</span><span class="ident" id="5776211">er</span><span class="op" id="5776213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776219">out</span><span class="op" id="5776222">.</span><span class="ident" id="5776223">G</span>&nbsp;<span class="op" id="5776225">=</span>&nbsp;<span class="builtintype" id="5776227">uint16</span><span class="op" id="5776233">(</span><span class="ident" id="5776234">eg</span><span class="op" id="5776236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776242">out</span><span class="op" id="5776245">.</span><span class="ident" id="5776246">B</span>&nbsp;<span class="op" id="5776248">=</span>&nbsp;<span class="builtintype" id="5776250">uint16</span><span class="op" id="5776256">(</span><span class="ident" id="5776257">eb</span><span class="op" id="5776259">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5776265">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5776326">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5776391">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5776454">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776515">dst</span><span class="op" id="5776518">.</span><span class="ident" id="5776519">Set</span><span class="op" id="5776522">(</span><span class="ident" id="5776523">r</span><span class="op" id="5776524">.</span><span class="ident" id="5776525">Min</span><span class="op" id="5776528">.</span><span class="ident" id="5776529">X</span><span class="op" id="5776530">+</span><span class="ident" id="5776531">x</span><span class="op" id="5776532">,</span>&nbsp;<span class="ident" id="5776534">r</span><span class="op" id="5776535">.</span><span class="ident" id="5776536">Min</span><span class="op" id="5776539">.</span><span class="ident" id="5776540">Y</span><span class="op" id="5776541">+</span><span class="ident" id="5776542">y</span><span class="op" id="5776543">,</span>&nbsp;<span class="op" id="5776545">&amp;</span><span class="ident" id="5776546">out</span><span class="op" id="5776549">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5776556">if</span>&nbsp;<span class="op" id="5776559">!</span><span class="ident" id="5776560">floydSteinberg</span>&nbsp;<span class="op" id="5776575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5776582">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776601">sr</span><span class="op" id="5776603">,</span>&nbsp;<span class="ident" id="5776605">sg</span><span class="op" id="5776607">,</span>&nbsp;<span class="ident" id="5776609">sb</span><span class="op" id="5776611">,</span>&nbsp;<span class="ident" id="5776613">_</span>&nbsp;<span class="op" id="5776615">=</span>&nbsp;<span class="ident" id="5776617">dst</span><span class="op" id="5776620">.</span><span class="ident" id="5776621">At</span><span class="op" id="5776623">(</span><span class="ident" id="5776624">r</span><span class="op" id="5776625">.</span><span class="ident" id="5776626">Min</span><span class="op" id="5776629">.</span><span class="ident" id="5776630">X</span><span class="op" id="5776631">+</span><span class="ident" id="5776632">x</span><span class="op" id="5776633">,</span>&nbsp;<span class="ident" id="5776635">r</span><span class="op" id="5776636">.</span><span class="ident" id="5776637">Min</span><span class="op" id="5776640">.</span><span class="ident" id="5776641">Y</span><span class="op" id="5776642">+</span><span class="ident" id="5776643">y</span><span class="op" id="5776644">)</span><span class="op" id="5776645">.</span><span class="ident" id="5776646">RGBA</span><span class="op" id="5776650">(</span><span class="op" id="5776651">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776657">er</span>&nbsp;<span class="op" id="5776660">-=</span>&nbsp;<span class="builtintype" id="5776663">int32</span><span class="op" id="5776668">(</span><span class="ident" id="5776669">sr</span><span class="op" id="5776671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776677">eg</span>&nbsp;<span class="op" id="5776680">-=</span>&nbsp;<span class="builtintype" id="5776683">int32</span><span class="op" id="5776688">(</span><span class="ident" id="5776689">sg</span><span class="op" id="5776691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776697">eb</span>&nbsp;<span class="op" id="5776700">-=</span>&nbsp;<span class="builtintype" id="5776703">int32</span><span class="op" id="5776708">(</span><span class="ident" id="5776709">sb</span><span class="op" id="5776711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5776722">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776778">quantErrorNext</span><span class="op" id="5776792">[</span><span class="ident" id="5776793">x</span><span class="op" id="5776794">+</span><span class="num" id="5776795">0</span><span class="op" id="5776796">]</span><span class="op" id="5776797">[</span><span class="num" id="5776798">0</span><span class="op" id="5776799">]</span>&nbsp;<span class="op" id="5776801">+=</span>&nbsp;<span class="ident" id="5776804">er</span>&nbsp;<span class="op" id="5776807">*</span>&nbsp;<span class="num" id="5776809">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776814">quantErrorNext</span><span class="op" id="5776828">[</span><span class="ident" id="5776829">x</span><span class="op" id="5776830">+</span><span class="num" id="5776831">0</span><span class="op" id="5776832">]</span><span class="op" id="5776833">[</span><span class="num" id="5776834">1</span><span class="op" id="5776835">]</span>&nbsp;<span class="op" id="5776837">+=</span>&nbsp;<span class="ident" id="5776840">eg</span>&nbsp;<span class="op" id="5776843">*</span>&nbsp;<span class="num" id="5776845">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776850">quantErrorNext</span><span class="op" id="5776864">[</span><span class="ident" id="5776865">x</span><span class="op" id="5776866">+</span><span class="num" id="5776867">0</span><span class="op" id="5776868">]</span><span class="op" id="5776869">[</span><span class="num" id="5776870">2</span><span class="op" id="5776871">]</span>&nbsp;<span class="op" id="5776873">+=</span>&nbsp;<span class="ident" id="5776876">eb</span>&nbsp;<span class="op" id="5776879">*</span>&nbsp;<span class="num" id="5776881">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776886">quantErrorNext</span><span class="op" id="5776900">[</span><span class="ident" id="5776901">x</span><span class="op" id="5776902">+</span><span class="num" id="5776903">1</span><span class="op" id="5776904">]</span><span class="op" id="5776905">[</span><span class="num" id="5776906">0</span><span class="op" id="5776907">]</span>&nbsp;<span class="op" id="5776909">+=</span>&nbsp;<span class="ident" id="5776912">er</span>&nbsp;<span class="op" id="5776915">*</span>&nbsp;<span class="num" id="5776917">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776922">quantErrorNext</span><span class="op" id="5776936">[</span><span class="ident" id="5776937">x</span><span class="op" id="5776938">+</span><span class="num" id="5776939">1</span><span class="op" id="5776940">]</span><span class="op" id="5776941">[</span><span class="num" id="5776942">1</span><span class="op" id="5776943">]</span>&nbsp;<span class="op" id="5776945">+=</span>&nbsp;<span class="ident" id="5776948">eg</span>&nbsp;<span class="op" id="5776951">*</span>&nbsp;<span class="num" id="5776953">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776958">quantErrorNext</span><span class="op" id="5776972">[</span><span class="ident" id="5776973">x</span><span class="op" id="5776974">+</span><span class="num" id="5776975">1</span><span class="op" id="5776976">]</span><span class="op" id="5776977">[</span><span class="num" id="5776978">2</span><span class="op" id="5776979">]</span>&nbsp;<span class="op" id="5776981">+=</span>&nbsp;<span class="ident" id="5776984">eb</span>&nbsp;<span class="op" id="5776987">*</span>&nbsp;<span class="num" id="5776989">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776994">quantErrorNext</span><span class="op" id="5777008">[</span><span class="ident" id="5777009">x</span><span class="op" id="5777010">+</span><span class="num" id="5777011">2</span><span class="op" id="5777012">]</span><span class="op" id="5777013">[</span><span class="num" id="5777014">0</span><span class="op" id="5777015">]</span>&nbsp;<span class="op" id="5777017">+=</span>&nbsp;<span class="ident" id="5777020">er</span>&nbsp;<span class="op" id="5777023">*</span>&nbsp;<span class="num" id="5777025">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5777030">quantErrorNext</span><span class="op" id="5777044">[</span><span class="ident" id="5777045">x</span><span class="op" id="5777046">+</span><span class="num" id="5777047">2</span><span class="op" id="5777048">]</span><span class="op" id="5777049">[</span><span class="num" id="5777050">1</span><span class="op" id="5777051">]</span>&nbsp;<span class="op" id="5777053">+=</span>&nbsp;<span class="ident" id="5777056">eg</span>&nbsp;<span class="op" id="5777059">*</span>&nbsp;<span class="num" id="5777061">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5777066">quantErrorNext</span><span class="op" id="5777080">[</span><span class="ident" id="5777081">x</span><span class="op" id="5777082">+</span><span class="num" id="5777083">2</span><span class="op" id="5777084">]</span><span class="op" id="5777085">[</span><span class="num" id="5777086">2</span><span class="op" id="5777087">]</span>&nbsp;<span class="op" id="5777089">+=</span>&nbsp;<span class="ident" id="5777092">eb</span>&nbsp;<span class="op" id="5777095">*</span>&nbsp;<span class="num" id="5777097">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5777102">quantErrorCurr</span><span class="op" id="5777116">[</span><span class="ident" id="5777117">x</span><span class="op" id="5777118">+</span><span class="num" id="5777119">2</span><span class="op" id="5777120">]</span><span class="op" id="5777121">[</span><span class="num" id="5777122">0</span><span class="op" id="5777123">]</span>&nbsp;<span class="op" id="5777125">+=</span>&nbsp;<span class="ident" id="5777128">er</span>&nbsp;<span class="op" id="5777131">*</span>&nbsp;<span class="num" id="5777133">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5777138">quantErrorCurr</span><span class="op" id="5777152">[</span><span class="ident" id="5777153">x</span><span class="op" id="5777154">+</span><span class="num" id="5777155">2</span><span class="op" id="5777156">]</span><span class="op" id="5777157">[</span><span class="num" id="5777158">1</span><span class="op" id="5777159">]</span>&nbsp;<span class="op" id="5777161">+=</span>&nbsp;<span class="ident" id="5777164">eg</span>&nbsp;<span class="op" id="5777167">*</span>&nbsp;<span class="num" id="5777169">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5777174">quantErrorCurr</span><span class="op" id="5777188">[</span><span class="ident" id="5777189">x</span><span class="op" id="5777190">+</span><span class="num" id="5777191">2</span><span class="op" id="5777192">]</span><span class="op" id="5777193">[</span><span class="num" id="5777194">2</span><span class="op" id="5777195">]</span>&nbsp;<span class="op" id="5777197">+=</span>&nbsp;<span class="ident" id="5777200">eb</span>&nbsp;<span class="op" id="5777203">*</span>&nbsp;<span class="num" id="5777205">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5777209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5777214">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5777259">if</span>&nbsp;<span class="ident" id="5777262">floydSteinberg</span>&nbsp;<span class="op" id="5777277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5777282">quantErrorCurr</span><span class="op" id="5777296">,</span>&nbsp;<span class="ident" id="5777298">quantErrorNext</span>&nbsp;<span class="op" id="5777313">=</span>&nbsp;<span class="ident" id="5777315">quantErrorNext</span><span class="op" id="5777329">,</span>&nbsp;<span class="ident" id="5777331">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5777349">for</span>&nbsp;<span class="ident" id="5777353">i</span>&nbsp;<span class="op" id="5777355">:=</span>&nbsp;<span class="keyword" id="5777358">range</span>&nbsp;<span class="ident" id="5777364">quantErrorNext</span>&nbsp;<span class="op" id="5777379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5777385">quantErrorNext</span><span class="op" id="5777399">[</span><span class="ident" id="5777400">i</span><span class="op" id="5777401">]</span>&nbsp;<span class="op" id="5777403">=</span>&nbsp;<span class="op" id="5777405">[</span><span class="num" id="5777406">3</span><span class="op" id="5777407">]</span><span class="builtintype" id="5777408">int32</span><span class="op" id="5777413">{</span><span class="op" id="5777414">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5777419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5777423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5777426">}</span><br>
<span class="lineno"></span><span class="op" id="5777428">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
