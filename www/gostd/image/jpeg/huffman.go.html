<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6348301">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6348356">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6348410">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6348461">package</span>&nbsp;<span class="ident" id="6348469">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6348475">import</span>&nbsp;<span class="op" id="6348482">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6348485">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6348490">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="6348493">//&nbsp;maxCodeLength&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="6348571">const</span>&nbsp;<span class="ident" id="6348577">maxCodeLength</span>&nbsp;<span class="op" id="6348591">=</span>&nbsp;<span class="num" id="6348593">16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6348597">//&nbsp;maxNCodes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;tree.</span><br>
<span class="lineno">15</span><span class="keyword" id="6348672">const</span>&nbsp;<span class="ident" id="6348678">maxNCodes</span>&nbsp;<span class="op" id="6348688">=</span>&nbsp;<span class="num" id="6348690">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6348695">//&nbsp;lutSize&nbsp;is&nbsp;the&nbsp;log-2&nbsp;size&nbsp;of&nbsp;the&nbsp;Huffman&nbsp;decoder&#39;s&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="6348764">const</span>&nbsp;<span class="ident" id="6348770">lutSize</span>&nbsp;<span class="op" id="6348778">=</span>&nbsp;<span class="num" id="6348780">8</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6348783">//&nbsp;huffman&nbsp;is&nbsp;a&nbsp;Huffman&nbsp;decoder,&nbsp;specified&nbsp;in&nbsp;section&nbsp;C.</span><br>
<span class="lineno"></span><span class="keyword" id="6348840">type</span>&nbsp;<span class="ident" id="6348845">huffman</span>&nbsp;<span class="keyword" id="6348853">struct</span>&nbsp;<span class="op" id="6348860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6348863">//&nbsp;length&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6348910">nCodes</span>&nbsp;<span class="builtintype" id="6348917">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6348924">//&nbsp;lut&nbsp;is&nbsp;the&nbsp;look-up&nbsp;table&nbsp;for&nbsp;the&nbsp;next&nbsp;lutSize&nbsp;bits&nbsp;in&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6348998">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;the&nbsp;uint16&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.&nbsp;The&nbsp;low&nbsp;8&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6349070">//&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;code&nbsp;length,&nbsp;or&nbsp;0&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;fit&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6349143">//&nbsp;lutSize&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349161">lut</span>&nbsp;<span class="op" id="6349165">[</span><span class="num" id="6349166">1</span>&nbsp;<span class="op" id="6349168">&lt;&lt;</span>&nbsp;<span class="ident" id="6349171">lutSize</span><span class="op" id="6349178">]</span><span class="builtintype" id="6349179">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6349187">//&nbsp;vals&nbsp;are&nbsp;the&nbsp;decoded&nbsp;values,&nbsp;sorted&nbsp;by&nbsp;their&nbsp;encoding.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349246">vals</span>&nbsp;<span class="op" id="6349251">[</span><span class="ident" id="6349252">maxNCodes</span><span class="op" id="6349261">]</span><span class="builtintype" id="6349262">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6349269">//&nbsp;minCodes[i]&nbsp;is&nbsp;the&nbsp;minimum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6349340">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349366">minCodes</span>&nbsp;<span class="op" id="6349375">[</span><span class="ident" id="6349376">maxCodeLength</span><span class="op" id="6349389">]</span><span class="builtintype" id="6349390">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6349397">//&nbsp;maxCodes[i]&nbsp;is&nbsp;the&nbsp;maximum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6349468">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349494">maxCodes</span>&nbsp;<span class="op" id="6349503">[</span><span class="ident" id="6349504">maxCodeLength</span><span class="op" id="6349517">]</span><span class="builtintype" id="6349518">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6349525">//&nbsp;valsIndices[i]&nbsp;is&nbsp;the&nbsp;index&nbsp;into&nbsp;vals&nbsp;of&nbsp;minCodes[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6349583">valsIndices</span>&nbsp;<span class="op" id="6349595">[</span><span class="ident" id="6349596">maxCodeLength</span><span class="op" id="6349609">]</span><span class="builtintype" id="6349610">int32</span><br>
<span class="lineno"></span><span class="op" id="6349616">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="6349619">//&nbsp;errShortHuffmanData&nbsp;means&nbsp;that&nbsp;an&nbsp;unexpected&nbsp;EOF&nbsp;occurred&nbsp;while&nbsp;decoding</span><br>
<span class="lineno"></span><span class="comment" id="6349695">//&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6349712">var</span>&nbsp;<span class="ident" id="6349716">errShortHuffmanData</span>&nbsp;<span class="op" id="6349736">=</span>&nbsp;<span class="ident" id="6349738">FormatError</span><span class="op" id="6349749">(</span><span class="string" id="6349750">&#34;short&nbsp;Huffman&nbsp;data&#34;</span><span class="op" id="6349770">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6349773">//&nbsp;ensureNBits&nbsp;reads&nbsp;bytes&nbsp;from&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;to&nbsp;ensure&nbsp;that&nbsp;d.bits.n&nbsp;is&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6349851">//&nbsp;least&nbsp;n.&nbsp;For&nbsp;best&nbsp;performance&nbsp;(avoiding&nbsp;function&nbsp;calls&nbsp;inside&nbsp;hot&nbsp;loops),</span><br>
<span class="lineno"></span><span class="comment" id="6349928">//&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;responsible&nbsp;for&nbsp;first&nbsp;checking&nbsp;that&nbsp;d.bits.n&nbsp;&lt;&nbsp;n.</span><br>
<span class="lineno"></span><span class="keyword" id="6350003">func</span>&nbsp;<span class="op" id="6350008">(</span><span class="ident" id="6350009">d</span>&nbsp;<span class="op" id="6350011">*</span><span class="ident" id="6350012">decoder</span><span class="op" id="6350019">)</span>&nbsp;<span class="ident" id="6350021">ensureNBits</span><span class="op" id="6350032">(</span><span class="ident" id="6350033">n</span>&nbsp;<span class="builtintype" id="6350035">int32</span><span class="op" id="6350040">)</span>&nbsp;<span class="builtintype" id="6350042">error</span>&nbsp;<span class="op" id="6350048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350051">for</span>&nbsp;<span class="op" id="6350055">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350059">c</span><span class="op" id="6350060">,</span>&nbsp;<span class="ident" id="6350062">err</span>&nbsp;<span class="op" id="6350066">:=</span>&nbsp;<span class="ident" id="6350069">d</span><span class="op" id="6350070">.</span><span class="ident" id="6350071">readByteStuffedByte</span><span class="op" id="6350090">(</span><span class="op" id="6350091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350095">if</span>&nbsp;<span class="ident" id="6350098">err</span>&nbsp;<span class="op" id="6350102">!=</span>&nbsp;<span class="ident" id="6350105">nil</span>&nbsp;<span class="op" id="6350109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350114">if</span>&nbsp;<span class="ident" id="6350117">err</span>&nbsp;<span class="op" id="6350121">==</span>&nbsp;<span class="ident" id="6350124">io</span><span class="op" id="6350126">.</span><span class="ident" id="6350127">EOF</span>&nbsp;<span class="op" id="6350131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350137">return</span>&nbsp;<span class="ident" id="6350144">errShortHuffmanData</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6350167">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350172">return</span>&nbsp;<span class="ident" id="6350179">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6350185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350189">d</span><span class="op" id="6350190">.</span><span class="ident" id="6350191">bits</span><span class="op" id="6350195">.</span><span class="ident" id="6350196">a</span>&nbsp;<span class="op" id="6350198">=</span>&nbsp;<span class="ident" id="6350200">d</span><span class="op" id="6350201">.</span><span class="ident" id="6350202">bits</span><span class="op" id="6350206">.</span><span class="ident" id="6350207">a</span><span class="op" id="6350208">&lt;&lt;</span><span class="num" id="6350210">8</span>&nbsp;<span class="op" id="6350212">|</span>&nbsp;<span class="builtintype" id="6350214">uint32</span><span class="op" id="6350220">(</span><span class="ident" id="6350221">c</span><span class="op" id="6350222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350226">d</span><span class="op" id="6350227">.</span><span class="ident" id="6350228">bits</span><span class="op" id="6350232">.</span><span class="ident" id="6350233">n</span>&nbsp;<span class="op" id="6350235">+=</span>&nbsp;<span class="num" id="6350238">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350242">if</span>&nbsp;<span class="ident" id="6350245">d</span><span class="op" id="6350246">.</span><span class="ident" id="6350247">bits</span><span class="op" id="6350251">.</span><span class="ident" id="6350252">m</span>&nbsp;<span class="op" id="6350254">==</span>&nbsp;<span class="num" id="6350257">0</span>&nbsp;<span class="op" id="6350259">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350264">d</span><span class="op" id="6350265">.</span><span class="ident" id="6350266">bits</span><span class="op" id="6350270">.</span><span class="ident" id="6350271">m</span>&nbsp;<span class="op" id="6350273">=</span>&nbsp;<span class="num" id="6350275">1</span>&nbsp;<span class="op" id="6350277">&lt;&lt;</span>&nbsp;<span class="num" id="6350280">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6350284">}</span>&nbsp;<span class="keyword" id="6350286">else</span>&nbsp;<span class="op" id="6350291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350296">d</span><span class="op" id="6350297">.</span><span class="ident" id="6350298">bits</span><span class="op" id="6350302">.</span><span class="ident" id="6350303">m</span>&nbsp;<span class="op" id="6350305">&lt;&lt;=</span>&nbsp;<span class="num" id="6350309">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6350313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350317">if</span>&nbsp;<span class="ident" id="6350320">d</span><span class="op" id="6350321">.</span><span class="ident" id="6350322">bits</span><span class="op" id="6350326">.</span><span class="ident" id="6350327">n</span>&nbsp;<span class="op" id="6350329">&gt;=</span>&nbsp;<span class="ident" id="6350332">n</span>&nbsp;<span class="op" id="6350334">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350339">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6350347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6350350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350353">return</span>&nbsp;<span class="ident" id="6350360">nil</span><br>
<span class="lineno"></span><span class="op" id="6350364">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="6350367">//&nbsp;receiveExtend&nbsp;is&nbsp;the&nbsp;composition&nbsp;of&nbsp;RECEIVE&nbsp;and&nbsp;EXTEND,&nbsp;specified&nbsp;in&nbsp;section</span><br>
<span class="lineno"></span><span class="comment" id="6350447">//&nbsp;F.2.2.1.</span><br>
<span class="lineno"></span><span class="keyword" id="6350459">func</span>&nbsp;<span class="op" id="6350464">(</span><span class="ident" id="6350465">d</span>&nbsp;<span class="op" id="6350467">*</span><span class="ident" id="6350468">decoder</span><span class="op" id="6350475">)</span>&nbsp;<span class="ident" id="6350477">receiveExtend</span><span class="op" id="6350490">(</span><span class="ident" id="6350491">t</span>&nbsp;<span class="builtintype" id="6350493">uint8</span><span class="op" id="6350498">)</span>&nbsp;<span class="op" id="6350500">(</span><span class="builtintype" id="6350501">int32</span><span class="op" id="6350506">,</span>&nbsp;<span class="builtintype" id="6350508">error</span><span class="op" id="6350513">)</span>&nbsp;<span class="op" id="6350515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350518">if</span>&nbsp;<span class="ident" id="6350521">d</span><span class="op" id="6350522">.</span><span class="ident" id="6350523">bits</span><span class="op" id="6350527">.</span><span class="ident" id="6350528">n</span>&nbsp;<span class="op" id="6350530">&lt;</span>&nbsp;<span class="builtintype" id="6350532">int32</span><span class="op" id="6350537">(</span><span class="ident" id="6350538">t</span><span class="op" id="6350539">)</span>&nbsp;<span class="op" id="6350541">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350545">if</span>&nbsp;<span class="ident" id="6350548">err</span>&nbsp;<span class="op" id="6350552">:=</span>&nbsp;<span class="ident" id="6350555">d</span><span class="op" id="6350556">.</span><span class="ident" id="6350557">ensureNBits</span><span class="op" id="6350568">(</span><span class="builtintype" id="6350569">int32</span><span class="op" id="6350574">(</span><span class="ident" id="6350575">t</span><span class="op" id="6350576">)</span><span class="op" id="6350577">)</span><span class="op" id="6350578">;</span>&nbsp;<span class="ident" id="6350580">err</span>&nbsp;<span class="op" id="6350584">!=</span>&nbsp;<span class="ident" id="6350587">nil</span>&nbsp;<span class="op" id="6350591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350596">return</span>&nbsp;<span class="num" id="6350603">0</span><span class="op" id="6350604">,</span>&nbsp;<span class="ident" id="6350606">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6350612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6350615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350618">d</span><span class="op" id="6350619">.</span><span class="ident" id="6350620">bits</span><span class="op" id="6350624">.</span><span class="ident" id="6350625">n</span>&nbsp;<span class="op" id="6350627">-=</span>&nbsp;<span class="builtintype" id="6350630">int32</span><span class="op" id="6350635">(</span><span class="ident" id="6350636">t</span><span class="op" id="6350637">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350640">d</span><span class="op" id="6350641">.</span><span class="ident" id="6350642">bits</span><span class="op" id="6350646">.</span><span class="ident" id="6350647">m</span>&nbsp;<span class="op" id="6350649">&gt;&gt;=</span>&nbsp;<span class="ident" id="6350653">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350656">s</span>&nbsp;<span class="op" id="6350658">:=</span>&nbsp;<span class="builtintype" id="6350661">int32</span><span class="op" id="6350666">(</span><span class="num" id="6350667">1</span><span class="op" id="6350668">)</span>&nbsp;<span class="op" id="6350670">&lt;&lt;</span>&nbsp;<span class="ident" id="6350673">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350676">x</span>&nbsp;<span class="op" id="6350678">:=</span>&nbsp;<span class="builtintype" id="6350681">int32</span><span class="op" id="6350686">(</span><span class="ident" id="6350687">d</span><span class="op" id="6350688">.</span><span class="ident" id="6350689">bits</span><span class="op" id="6350693">.</span><span class="ident" id="6350694">a</span><span class="op" id="6350695">&gt;&gt;</span><span class="builtintype" id="6350697">uint8</span><span class="op" id="6350702">(</span><span class="ident" id="6350703">d</span><span class="op" id="6350704">.</span><span class="ident" id="6350705">bits</span><span class="op" id="6350709">.</span><span class="ident" id="6350710">n</span><span class="op" id="6350711">)</span><span class="op" id="6350712">)</span>&nbsp;<span class="op" id="6350714">&amp;</span>&nbsp;<span class="op" id="6350716">(</span><span class="ident" id="6350717">s</span>&nbsp;<span class="op" id="6350719">-</span>&nbsp;<span class="num" id="6350721">1</span><span class="op" id="6350722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350725">if</span>&nbsp;<span class="ident" id="6350728">x</span>&nbsp;<span class="op" id="6350730">&lt;</span>&nbsp;<span class="ident" id="6350732">s</span><span class="op" id="6350733">&gt;&gt;</span><span class="num" id="6350735">1</span>&nbsp;<span class="op" id="6350737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6350741">x</span>&nbsp;<span class="op" id="6350743">+=</span>&nbsp;<span class="op" id="6350746">(</span><span class="op" id="6350747">(</span><span class="op" id="6350748">-</span><span class="num" id="6350749">1</span><span class="op" id="6350750">)</span>&nbsp;<span class="op" id="6350752">&lt;&lt;</span>&nbsp;<span class="ident" id="6350755">t</span><span class="op" id="6350756">)</span>&nbsp;<span class="op" id="6350758">+</span>&nbsp;<span class="num" id="6350760">1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6350763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350766">return</span>&nbsp;<span class="ident" id="6350773">x</span><span class="op" id="6350774">,</span>&nbsp;<span class="ident" id="6350776">nil</span><br>
<span class="lineno"></span><span class="op" id="6350780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6350783">//&nbsp;processDHT&nbsp;processes&nbsp;a&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker,&nbsp;and&nbsp;initializes&nbsp;a&nbsp;huffman</span><br>
<span class="lineno">90</span><span class="comment" id="6350864">//&nbsp;struct&nbsp;from&nbsp;its&nbsp;contents.&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.2.</span><br>
<span class="lineno"></span><span class="keyword" id="6350923">func</span>&nbsp;<span class="op" id="6350928">(</span><span class="ident" id="6350929">d</span>&nbsp;<span class="op" id="6350931">*</span><span class="ident" id="6350932">decoder</span><span class="op" id="6350939">)</span>&nbsp;<span class="ident" id="6350941">processDHT</span><span class="op" id="6350951">(</span><span class="ident" id="6350952">n</span>&nbsp;<span class="builtintype" id="6350954">int</span><span class="op" id="6350957">)</span>&nbsp;<span class="builtintype" id="6350959">error</span>&nbsp;<span class="op" id="6350965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350968">for</span>&nbsp;<span class="ident" id="6350972">n</span>&nbsp;<span class="op" id="6350974">&gt;</span>&nbsp;<span class="num" id="6350976">0</span>&nbsp;<span class="op" id="6350978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350982">if</span>&nbsp;<span class="ident" id="6350985">n</span>&nbsp;<span class="op" id="6350987">&lt;</span>&nbsp;<span class="num" id="6350989">17</span>&nbsp;<span class="op" id="6350992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6350997">return</span>&nbsp;<span class="ident" id="6351004">FormatError</span><span class="op" id="6351015">(</span><span class="string" id="6351016">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6351038">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6351042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351046">if</span>&nbsp;<span class="ident" id="6351049">err</span>&nbsp;<span class="op" id="6351053">:=</span>&nbsp;<span class="ident" id="6351056">d</span><span class="op" id="6351057">.</span><span class="ident" id="6351058">readFull</span><span class="op" id="6351066">(</span><span class="ident" id="6351067">d</span><span class="op" id="6351068">.</span><span class="ident" id="6351069">tmp</span><span class="op" id="6351072">[</span><span class="op" id="6351073">:</span><span class="num" id="6351074">17</span><span class="op" id="6351076">]</span><span class="op" id="6351077">)</span><span class="op" id="6351078">;</span>&nbsp;<span class="ident" id="6351080">err</span>&nbsp;<span class="op" id="6351084">!=</span>&nbsp;<span class="ident" id="6351087">nil</span>&nbsp;<span class="op" id="6351091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351096">return</span>&nbsp;<span class="ident" id="6351103">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6351109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6351113">tc</span>&nbsp;<span class="op" id="6351116">:=</span>&nbsp;<span class="ident" id="6351119">d</span><span class="op" id="6351120">.</span><span class="ident" id="6351121">tmp</span><span class="op" id="6351124">[</span><span class="num" id="6351125">0</span><span class="op" id="6351126">]</span>&nbsp;<span class="op" id="6351128">&gt;&gt;</span>&nbsp;<span class="num" id="6351131">4</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351135">if</span>&nbsp;<span class="ident" id="6351138">tc</span>&nbsp;<span class="op" id="6351141">&gt;</span>&nbsp;<span class="ident" id="6351143">maxTc</span>&nbsp;<span class="op" id="6351149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351154">return</span>&nbsp;<span class="ident" id="6351161">FormatError</span><span class="op" id="6351172">(</span><span class="string" id="6351173">&#34;bad&nbsp;Tc&nbsp;value&#34;</span><span class="op" id="6351187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6351191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6351195">th</span>&nbsp;<span class="op" id="6351198">:=</span>&nbsp;<span class="ident" id="6351201">d</span><span class="op" id="6351202">.</span><span class="ident" id="6351203">tmp</span><span class="op" id="6351206">[</span><span class="num" id="6351207">0</span><span class="op" id="6351208">]</span>&nbsp;<span class="op" id="6351210">&amp;</span>&nbsp;<span class="num" id="6351212">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351219">if</span>&nbsp;<span class="ident" id="6351222">th</span>&nbsp;<span class="op" id="6351225">&gt;</span>&nbsp;<span class="ident" id="6351227">maxTh</span>&nbsp;<span class="op" id="6351233">||</span>&nbsp;<span class="op" id="6351236">!</span><span class="ident" id="6351237">d</span><span class="op" id="6351238">.</span><span class="ident" id="6351239">progressive</span>&nbsp;<span class="op" id="6351251">&amp;&amp;</span>&nbsp;<span class="ident" id="6351254">th</span>&nbsp;<span class="op" id="6351257">&gt;</span>&nbsp;<span class="num" id="6351259">1</span>&nbsp;<span class="op" id="6351261">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351266">return</span>&nbsp;<span class="ident" id="6351273">FormatError</span><span class="op" id="6351284">(</span><span class="string" id="6351285">&#34;bad&nbsp;Th&nbsp;value&#34;</span><span class="op" id="6351299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6351303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6351307">h</span>&nbsp;<span class="op" id="6351309">:=</span>&nbsp;<span class="op" id="6351312">&amp;</span><span class="ident" id="6351313">d</span><span class="op" id="6351314">.</span><span class="ident" id="6351315">huff</span><span class="op" id="6351319">[</span><span class="ident" id="6351320">tc</span><span class="op" id="6351322">]</span><span class="op" id="6351323">[</span><span class="ident" id="6351324">th</span><span class="op" id="6351326">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6351331">//&nbsp;Read&nbsp;nCodes&nbsp;and&nbsp;h.vals&nbsp;(and&nbsp;derive&nbsp;h.nCodes).</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6351382">//&nbsp;nCodes[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;with&nbsp;code&nbsp;length&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6351440">//&nbsp;h.nCodes&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6351484">h</span><span class="op" id="6351485">.</span><span class="ident" id="6351486">nCodes</span>&nbsp;<span class="op" id="6351493">=</span>&nbsp;<span class="num" id="6351495">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351499">var</span>&nbsp;<span class="ident" id="6351503">nCodes</span>&nbsp;<span class="op" id="6351510">[</span><span class="ident" id="6351511">maxCodeLength</span><span class="op" id="6351524">]</span><span class="builtintype" id="6351525">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351533">for</span>&nbsp;<span class="ident" id="6351537">i</span>&nbsp;<span class="op" id="6351539">:=</span>&nbsp;<span class="keyword" id="6351542">range</span>&nbsp;<span class="ident" id="6351548">nCodes</span>&nbsp;<span class="op" id="6351555">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6351560">nCodes</span><span class="op" id="6351566">[</span><span class="ident" id="6351567">i</span><span class="op" id="6351568">]</span>&nbsp;<span class="op" id="6351570">=</span>&nbsp;<span class="builtintype" id="6351572">int32</span><span class="op" id="6351577">(</span><span class="ident" id="6351578">d</span><span class="op" id="6351579">.</span><span class="ident" id="6351580">tmp</span><span class="op" id="6351583">[</span><span class="ident" id="6351584">i</span><span class="op" id="6351585">+</span><span class="num" id="6351586">1</span><span class="op" id="6351587">]</span><span class="op" id="6351588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6351593">h</span><span class="op" id="6351594">.</span><span class="ident" id="6351595">nCodes</span>&nbsp;<span class="op" id="6351602">+=</span>&nbsp;<span class="ident" id="6351605">nCodes</span><span class="op" id="6351611">[</span><span class="ident" id="6351612">i</span><span class="op" id="6351613">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6351617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351621">if</span>&nbsp;<span class="ident" id="6351624">h</span><span class="op" id="6351625">.</span><span class="ident" id="6351626">nCodes</span>&nbsp;<span class="op" id="6351633">==</span>&nbsp;<span class="num" id="6351636">0</span>&nbsp;<span class="op" id="6351638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351643">return</span>&nbsp;<span class="ident" id="6351650">FormatError</span><span class="op" id="6351661">(</span><span class="string" id="6351662">&#34;Huffman&nbsp;table&nbsp;has&nbsp;zero&nbsp;length&#34;</span><span class="op" id="6351693">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6351697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351701">if</span>&nbsp;<span class="ident" id="6351704">h</span><span class="op" id="6351705">.</span><span class="ident" id="6351706">nCodes</span>&nbsp;<span class="op" id="6351713">&gt;</span>&nbsp;<span class="ident" id="6351715">maxNCodes</span>&nbsp;<span class="op" id="6351725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351730">return</span>&nbsp;<span class="ident" id="6351737">FormatError</span><span class="op" id="6351748">(</span><span class="string" id="6351749">&#34;Huffman&nbsp;table&nbsp;has&nbsp;excessive&nbsp;length&#34;</span><span class="op" id="6351785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6351789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6351793">n</span>&nbsp;<span class="op" id="6351795">-=</span>&nbsp;<span class="builtintype" id="6351798">int</span><span class="op" id="6351801">(</span><span class="ident" id="6351802">h</span><span class="op" id="6351803">.</span><span class="ident" id="6351804">nCodes</span><span class="op" id="6351810">)</span>&nbsp;<span class="op" id="6351812">+</span>&nbsp;<span class="num" id="6351814">17</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351819">if</span>&nbsp;<span class="ident" id="6351822">n</span>&nbsp;<span class="op" id="6351824">&lt;</span>&nbsp;<span class="num" id="6351826">0</span>&nbsp;<span class="op" id="6351828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351833">return</span>&nbsp;<span class="ident" id="6351840">FormatError</span><span class="op" id="6351851">(</span><span class="string" id="6351852">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6351874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6351878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351882">if</span>&nbsp;<span class="ident" id="6351885">err</span>&nbsp;<span class="op" id="6351889">:=</span>&nbsp;<span class="ident" id="6351892">d</span><span class="op" id="6351893">.</span><span class="ident" id="6351894">readFull</span><span class="op" id="6351902">(</span><span class="ident" id="6351903">h</span><span class="op" id="6351904">.</span><span class="ident" id="6351905">vals</span><span class="op" id="6351909">[</span><span class="op" id="6351910">:</span><span class="ident" id="6351911">h</span><span class="op" id="6351912">.</span><span class="ident" id="6351913">nCodes</span><span class="op" id="6351919">]</span><span class="op" id="6351920">)</span><span class="op" id="6351921">;</span>&nbsp;<span class="ident" id="6351923">err</span>&nbsp;<span class="op" id="6351927">!=</span>&nbsp;<span class="ident" id="6351930">nil</span>&nbsp;<span class="op" id="6351934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351939">return</span>&nbsp;<span class="ident" id="6351946">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6351952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6351957">//&nbsp;Derive&nbsp;the&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6351988">for</span>&nbsp;<span class="ident" id="6351992">i</span>&nbsp;<span class="op" id="6351994">:=</span>&nbsp;<span class="keyword" id="6351997">range</span>&nbsp;<span class="ident" id="6352003">h</span><span class="op" id="6352004">.</span><span class="ident" id="6352005">lut</span>&nbsp;<span class="op" id="6352009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352014">h</span><span class="op" id="6352015">.</span><span class="ident" id="6352016">lut</span><span class="op" id="6352019">[</span><span class="ident" id="6352020">i</span><span class="op" id="6352021">]</span>&nbsp;<span class="op" id="6352023">=</span>&nbsp;<span class="num" id="6352025">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352033">var</span>&nbsp;<span class="ident" id="6352037">x</span><span class="op" id="6352038">,</span>&nbsp;<span class="ident" id="6352040">code</span>&nbsp;<span class="builtintype" id="6352045">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352054">for</span>&nbsp;<span class="ident" id="6352058">i</span>&nbsp;<span class="op" id="6352060">:=</span>&nbsp;<span class="builtintype" id="6352063">uint32</span><span class="op" id="6352069">(</span><span class="num" id="6352070">0</span><span class="op" id="6352071">)</span><span class="op" id="6352072">;</span>&nbsp;<span class="ident" id="6352074">i</span>&nbsp;<span class="op" id="6352076">&lt;</span>&nbsp;<span class="ident" id="6352078">lutSize</span><span class="op" id="6352085">;</span>&nbsp;<span class="ident" id="6352087">i</span><span class="op" id="6352088">++</span>&nbsp;<span class="op" id="6352091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352096">code</span>&nbsp;<span class="op" id="6352101">&lt;&lt;=</span>&nbsp;<span class="num" id="6352105">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352110">for</span>&nbsp;<span class="ident" id="6352114">j</span>&nbsp;<span class="op" id="6352116">:=</span>&nbsp;<span class="builtintype" id="6352119">int32</span><span class="op" id="6352124">(</span><span class="num" id="6352125">0</span><span class="op" id="6352126">)</span><span class="op" id="6352127">;</span>&nbsp;<span class="ident" id="6352129">j</span>&nbsp;<span class="op" id="6352131">&lt;</span>&nbsp;<span class="ident" id="6352133">nCodes</span><span class="op" id="6352139">[</span><span class="ident" id="6352140">i</span><span class="op" id="6352141">]</span><span class="op" id="6352142">;</span>&nbsp;<span class="ident" id="6352144">j</span><span class="op" id="6352145">++</span>&nbsp;<span class="op" id="6352148">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6352154">//&nbsp;The&nbsp;codeLength&nbsp;is&nbsp;1+i,&nbsp;so&nbsp;shift&nbsp;code&nbsp;by&nbsp;8-(1+i)&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6352212">//&nbsp;calculate&nbsp;the&nbsp;high&nbsp;bits&nbsp;for&nbsp;every&nbsp;8-bit&nbsp;sequence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6352268">//&nbsp;whose&nbsp;codeLength&#39;s&nbsp;high&nbsp;bits&nbsp;matches&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6352318">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;lutValue&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6352376">//&nbsp;The&nbsp;low&nbsp;8&nbsp;bits&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;codeLength.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352425">base</span>&nbsp;<span class="op" id="6352430">:=</span>&nbsp;<span class="builtintype" id="6352433">uint8</span><span class="op" id="6352438">(</span><span class="ident" id="6352439">code</span>&nbsp;<span class="op" id="6352444">&lt;&lt;</span>&nbsp;<span class="op" id="6352447">(</span><span class="num" id="6352448">7</span>&nbsp;<span class="op" id="6352450">-</span>&nbsp;<span class="ident" id="6352452">i</span><span class="op" id="6352453">)</span><span class="op" id="6352454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352460">lutValue</span>&nbsp;<span class="op" id="6352469">:=</span>&nbsp;<span class="builtintype" id="6352472">uint16</span><span class="op" id="6352478">(</span><span class="ident" id="6352479">h</span><span class="op" id="6352480">.</span><span class="ident" id="6352481">vals</span><span class="op" id="6352485">[</span><span class="ident" id="6352486">x</span><span class="op" id="6352487">]</span><span class="op" id="6352488">)</span><span class="op" id="6352489">&lt;&lt;</span><span class="num" id="6352491">8</span>&nbsp;<span class="op" id="6352493">|</span>&nbsp;<span class="builtintype" id="6352495">uint16</span><span class="op" id="6352501">(</span><span class="num" id="6352502">2</span><span class="op" id="6352503">+</span><span class="ident" id="6352504">i</span><span class="op" id="6352505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352511">for</span>&nbsp;<span class="ident" id="6352515">k</span>&nbsp;<span class="op" id="6352517">:=</span>&nbsp;<span class="builtintype" id="6352520">uint8</span><span class="op" id="6352525">(</span><span class="num" id="6352526">0</span><span class="op" id="6352527">)</span><span class="op" id="6352528">;</span>&nbsp;<span class="ident" id="6352530">k</span>&nbsp;<span class="op" id="6352532">&lt;</span>&nbsp;<span class="num" id="6352534">1</span><span class="op" id="6352535">&lt;&lt;</span><span class="op" id="6352537">(</span><span class="num" id="6352538">7</span><span class="op" id="6352539">-</span><span class="ident" id="6352540">i</span><span class="op" id="6352541">)</span><span class="op" id="6352542">;</span>&nbsp;<span class="ident" id="6352544">k</span><span class="op" id="6352545">++</span>&nbsp;<span class="op" id="6352548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352555">h</span><span class="op" id="6352556">.</span><span class="ident" id="6352557">lut</span><span class="op" id="6352560">[</span><span class="ident" id="6352561">base</span><span class="op" id="6352565">|</span><span class="ident" id="6352566">k</span><span class="op" id="6352567">]</span>&nbsp;<span class="op" id="6352569">=</span>&nbsp;<span class="ident" id="6352571">lutValue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352584">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352590">code</span><span class="op" id="6352594">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352601">x</span><span class="op" id="6352602">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6352617">//&nbsp;Derive&nbsp;minCodes,&nbsp;maxCodes,&nbsp;and&nbsp;valsIndices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352666">var</span>&nbsp;<span class="ident" id="6352670">c</span><span class="op" id="6352671">,</span>&nbsp;<span class="ident" id="6352673">index</span>&nbsp;<span class="builtintype" id="6352679">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352687">for</span>&nbsp;<span class="ident" id="6352691">i</span><span class="op" id="6352692">,</span>&nbsp;<span class="ident" id="6352694">n</span>&nbsp;<span class="op" id="6352696">:=</span>&nbsp;<span class="keyword" id="6352699">range</span>&nbsp;<span class="ident" id="6352705">nCodes</span>&nbsp;<span class="op" id="6352712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352717">if</span>&nbsp;<span class="ident" id="6352720">n</span>&nbsp;<span class="op" id="6352722">==</span>&nbsp;<span class="num" id="6352725">0</span>&nbsp;<span class="op" id="6352727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352733">h</span><span class="op" id="6352734">.</span><span class="ident" id="6352735">minCodes</span><span class="op" id="6352743">[</span><span class="ident" id="6352744">i</span><span class="op" id="6352745">]</span>&nbsp;<span class="op" id="6352747">=</span>&nbsp;<span class="op" id="6352749">-</span><span class="num" id="6352750">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352756">h</span><span class="op" id="6352757">.</span><span class="ident" id="6352758">maxCodes</span><span class="op" id="6352766">[</span><span class="ident" id="6352767">i</span><span class="op" id="6352768">]</span>&nbsp;<span class="op" id="6352770">=</span>&nbsp;<span class="op" id="6352772">-</span><span class="num" id="6352773">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352779">h</span><span class="op" id="6352780">.</span><span class="ident" id="6352781">valsIndices</span><span class="op" id="6352792">[</span><span class="ident" id="6352793">i</span><span class="op" id="6352794">]</span>&nbsp;<span class="op" id="6352796">=</span>&nbsp;<span class="op" id="6352798">-</span><span class="num" id="6352799">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352804">}</span>&nbsp;<span class="keyword" id="6352806">else</span>&nbsp;<span class="op" id="6352811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352817">h</span><span class="op" id="6352818">.</span><span class="ident" id="6352819">minCodes</span><span class="op" id="6352827">[</span><span class="ident" id="6352828">i</span><span class="op" id="6352829">]</span>&nbsp;<span class="op" id="6352831">=</span>&nbsp;<span class="ident" id="6352833">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352839">h</span><span class="op" id="6352840">.</span><span class="ident" id="6352841">maxCodes</span><span class="op" id="6352849">[</span><span class="ident" id="6352850">i</span><span class="op" id="6352851">]</span>&nbsp;<span class="op" id="6352853">=</span>&nbsp;<span class="ident" id="6352855">c</span>&nbsp;<span class="op" id="6352857">+</span>&nbsp;<span class="ident" id="6352859">n</span>&nbsp;<span class="op" id="6352861">-</span>&nbsp;<span class="num" id="6352863">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352869">h</span><span class="op" id="6352870">.</span><span class="ident" id="6352871">valsIndices</span><span class="op" id="6352882">[</span><span class="ident" id="6352883">i</span><span class="op" id="6352884">]</span>&nbsp;<span class="op" id="6352886">=</span>&nbsp;<span class="ident" id="6352888">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352898">c</span>&nbsp;<span class="op" id="6352900">+=</span>&nbsp;<span class="ident" id="6352903">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352909">index</span>&nbsp;<span class="op" id="6352915">+=</span>&nbsp;<span class="ident" id="6352918">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6352928">c</span>&nbsp;<span class="op" id="6352930">&lt;&lt;=</span>&nbsp;<span class="num" id="6352934">1</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6352941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6352944">return</span>&nbsp;<span class="ident" id="6352951">nil</span><br>
<span class="lineno"></span><span class="op" id="6352955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="6352958">//&nbsp;decodeHuffman&nbsp;returns&nbsp;the&nbsp;next&nbsp;Huffman-coded&nbsp;value&nbsp;from&nbsp;the&nbsp;bit-stream,</span><br>
<span class="lineno"></span><span class="comment" id="6353033">//&nbsp;decoded&nbsp;according&nbsp;to&nbsp;h.</span><br>
<span class="lineno"></span><span class="keyword" id="6353060">func</span>&nbsp;<span class="op" id="6353065">(</span><span class="ident" id="6353066">d</span>&nbsp;<span class="op" id="6353068">*</span><span class="ident" id="6353069">decoder</span><span class="op" id="6353076">)</span>&nbsp;<span class="ident" id="6353078">decodeHuffman</span><span class="op" id="6353091">(</span><span class="ident" id="6353092">h</span>&nbsp;<span class="op" id="6353094">*</span><span class="ident" id="6353095">huffman</span><span class="op" id="6353102">)</span>&nbsp;<span class="op" id="6353104">(</span><span class="builtintype" id="6353105">uint8</span><span class="op" id="6353110">,</span>&nbsp;<span class="builtintype" id="6353112">error</span><span class="op" id="6353117">)</span>&nbsp;<span class="op" id="6353119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353122">if</span>&nbsp;<span class="ident" id="6353125">h</span><span class="op" id="6353126">.</span><span class="ident" id="6353127">nCodes</span>&nbsp;<span class="op" id="6353134">==</span>&nbsp;<span class="num" id="6353137">0</span>&nbsp;<span class="op" id="6353139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353143">return</span>&nbsp;<span class="num" id="6353150">0</span><span class="op" id="6353151">,</span>&nbsp;<span class="ident" id="6353153">FormatError</span><span class="op" id="6353164">(</span><span class="string" id="6353165">&#34;uninitialized&nbsp;Huffman&nbsp;table&#34;</span><span class="op" id="6353194">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353201">if</span>&nbsp;<span class="ident" id="6353204">d</span><span class="op" id="6353205">.</span><span class="ident" id="6353206">bits</span><span class="op" id="6353210">.</span><span class="ident" id="6353211">n</span>&nbsp;<span class="op" id="6353213">&lt;</span>&nbsp;<span class="num" id="6353215">8</span>&nbsp;<span class="op" id="6353217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353221">if</span>&nbsp;<span class="ident" id="6353224">err</span>&nbsp;<span class="op" id="6353228">:=</span>&nbsp;<span class="ident" id="6353231">d</span><span class="op" id="6353232">.</span><span class="ident" id="6353233">ensureNBits</span><span class="op" id="6353244">(</span><span class="num" id="6353245">8</span><span class="op" id="6353246">)</span><span class="op" id="6353247">;</span>&nbsp;<span class="ident" id="6353249">err</span>&nbsp;<span class="op" id="6353253">!=</span>&nbsp;<span class="ident" id="6353256">nil</span>&nbsp;<span class="op" id="6353260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353265">if</span>&nbsp;<span class="ident" id="6353268">err</span>&nbsp;<span class="op" id="6353272">!=</span>&nbsp;<span class="ident" id="6353275">errMissingFF00</span>&nbsp;<span class="op" id="6353290">&amp;&amp;</span>&nbsp;<span class="ident" id="6353293">err</span>&nbsp;<span class="op" id="6353297">!=</span>&nbsp;<span class="ident" id="6353300">errShortHuffmanData</span>&nbsp;<span class="op" id="6353320">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353326">return</span>&nbsp;<span class="num" id="6353333">0</span><span class="op" id="6353334">,</span>&nbsp;<span class="ident" id="6353336">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6353348">//&nbsp;There&nbsp;are&nbsp;no&nbsp;more&nbsp;bytes&nbsp;of&nbsp;data&nbsp;in&nbsp;this&nbsp;segment,&nbsp;but&nbsp;we&nbsp;may&nbsp;still</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6353420">//&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;next&nbsp;symbol&nbsp;out&nbsp;of&nbsp;the&nbsp;previously&nbsp;read&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6353491">//&nbsp;First,&nbsp;undo&nbsp;the&nbsp;readByte&nbsp;that&nbsp;the&nbsp;ensureNBits&nbsp;call&nbsp;made.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353554">d</span><span class="op" id="6353555">.</span><span class="ident" id="6353556">unreadByteStuffedByte</span><span class="op" id="6353577">(</span><span class="op" id="6353578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353583">goto</span>&nbsp;<span class="ident" id="6353588">slowPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353605">if</span>&nbsp;<span class="ident" id="6353608">v</span>&nbsp;<span class="op" id="6353610">:=</span>&nbsp;<span class="ident" id="6353613">h</span><span class="op" id="6353614">.</span><span class="ident" id="6353615">lut</span><span class="op" id="6353618">[</span><span class="op" id="6353619">(</span><span class="ident" id="6353620">d</span><span class="op" id="6353621">.</span><span class="ident" id="6353622">bits</span><span class="op" id="6353626">.</span><span class="ident" id="6353627">a</span><span class="op" id="6353628">&gt;&gt;</span><span class="builtintype" id="6353630">uint32</span><span class="op" id="6353636">(</span><span class="ident" id="6353637">d</span><span class="op" id="6353638">.</span><span class="ident" id="6353639">bits</span><span class="op" id="6353643">.</span><span class="ident" id="6353644">n</span><span class="op" id="6353645">-</span><span class="ident" id="6353646">lutSize</span><span class="op" id="6353653">)</span><span class="op" id="6353654">)</span><span class="op" id="6353655">&amp;</span><span class="num" id="6353656">0xff</span><span class="op" id="6353660">]</span><span class="op" id="6353661">;</span>&nbsp;<span class="ident" id="6353663">v</span>&nbsp;<span class="op" id="6353665">!=</span>&nbsp;<span class="num" id="6353668">0</span>&nbsp;<span class="op" id="6353670">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353674">n</span>&nbsp;<span class="op" id="6353676">:=</span>&nbsp;<span class="op" id="6353679">(</span><span class="ident" id="6353680">v</span>&nbsp;<span class="op" id="6353682">&amp;</span>&nbsp;<span class="num" id="6353684">0xff</span><span class="op" id="6353688">)</span>&nbsp;<span class="op" id="6353690">-</span>&nbsp;<span class="num" id="6353692">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353696">d</span><span class="op" id="6353697">.</span><span class="ident" id="6353698">bits</span><span class="op" id="6353702">.</span><span class="ident" id="6353703">n</span>&nbsp;<span class="op" id="6353705">-=</span>&nbsp;<span class="builtintype" id="6353708">int32</span><span class="op" id="6353713">(</span><span class="ident" id="6353714">n</span><span class="op" id="6353715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353719">d</span><span class="op" id="6353720">.</span><span class="ident" id="6353721">bits</span><span class="op" id="6353725">.</span><span class="ident" id="6353726">m</span>&nbsp;<span class="op" id="6353728">&gt;&gt;=</span>&nbsp;<span class="ident" id="6353732">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353736">return</span>&nbsp;<span class="builtintype" id="6353743">uint8</span><span class="op" id="6353748">(</span><span class="ident" id="6353749">v</span>&nbsp;<span class="op" id="6353751">&gt;&gt;</span>&nbsp;<span class="num" id="6353754">8</span><span class="op" id="6353755">)</span><span class="op" id="6353756">,</span>&nbsp;<span class="ident" id="6353758">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353763">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="ident" id="6353766">slowPath</span><span class="op" id="6353774">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353777">for</span>&nbsp;<span class="ident" id="6353781">i</span><span class="op" id="6353782">,</span>&nbsp;<span class="ident" id="6353784">code</span>&nbsp;<span class="op" id="6353789">:=</span>&nbsp;<span class="num" id="6353792">0</span><span class="op" id="6353793">,</span>&nbsp;<span class="builtintype" id="6353795">int32</span><span class="op" id="6353800">(</span><span class="num" id="6353801">0</span><span class="op" id="6353802">)</span><span class="op" id="6353803">;</span>&nbsp;<span class="ident" id="6353805">i</span>&nbsp;<span class="op" id="6353807">&lt;</span>&nbsp;<span class="ident" id="6353809">maxCodeLength</span><span class="op" id="6353822">;</span>&nbsp;<span class="ident" id="6353824">i</span><span class="op" id="6353825">++</span>&nbsp;<span class="op" id="6353828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353832">if</span>&nbsp;<span class="ident" id="6353835">d</span><span class="op" id="6353836">.</span><span class="ident" id="6353837">bits</span><span class="op" id="6353841">.</span><span class="ident" id="6353842">n</span>&nbsp;<span class="op" id="6353844">==</span>&nbsp;<span class="num" id="6353847">0</span>&nbsp;<span class="op" id="6353849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353854">if</span>&nbsp;<span class="ident" id="6353857">err</span>&nbsp;<span class="op" id="6353861">:=</span>&nbsp;<span class="ident" id="6353864">d</span><span class="op" id="6353865">.</span><span class="ident" id="6353866">ensureNBits</span><span class="op" id="6353877">(</span><span class="num" id="6353878">1</span><span class="op" id="6353879">)</span><span class="op" id="6353880">;</span>&nbsp;<span class="ident" id="6353882">err</span>&nbsp;<span class="op" id="6353886">!=</span>&nbsp;<span class="ident" id="6353889">nil</span>&nbsp;<span class="op" id="6353893">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353899">return</span>&nbsp;<span class="num" id="6353906">0</span><span class="op" id="6353907">,</span>&nbsp;<span class="ident" id="6353909">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6353924">if</span>&nbsp;<span class="ident" id="6353927">d</span><span class="op" id="6353928">.</span><span class="ident" id="6353929">bits</span><span class="op" id="6353933">.</span><span class="ident" id="6353934">a</span><span class="op" id="6353935">&amp;</span><span class="ident" id="6353936">d</span><span class="op" id="6353937">.</span><span class="ident" id="6353938">bits</span><span class="op" id="6353942">.</span><span class="ident" id="6353943">m</span>&nbsp;<span class="op" id="6353945">!=</span>&nbsp;<span class="num" id="6353948">0</span>&nbsp;<span class="op" id="6353950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353955">code</span>&nbsp;<span class="op" id="6353960">|=</span>&nbsp;<span class="num" id="6353963">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6353967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353971">d</span><span class="op" id="6353972">.</span><span class="ident" id="6353973">bits</span><span class="op" id="6353977">.</span><span class="ident" id="6353978">n</span><span class="op" id="6353979">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6353984">d</span><span class="op" id="6353985">.</span><span class="ident" id="6353986">bits</span><span class="op" id="6353990">.</span><span class="ident" id="6353991">m</span>&nbsp;<span class="op" id="6353993">&gt;&gt;=</span>&nbsp;<span class="num" id="6353997">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354001">if</span>&nbsp;<span class="ident" id="6354004">code</span>&nbsp;<span class="op" id="6354009">&lt;=</span>&nbsp;<span class="ident" id="6354012">h</span><span class="op" id="6354013">.</span><span class="ident" id="6354014">maxCodes</span><span class="op" id="6354022">[</span><span class="ident" id="6354023">i</span><span class="op" id="6354024">]</span>&nbsp;<span class="op" id="6354026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354031">return</span>&nbsp;<span class="ident" id="6354038">h</span><span class="op" id="6354039">.</span><span class="ident" id="6354040">vals</span><span class="op" id="6354044">[</span><span class="ident" id="6354045">h</span><span class="op" id="6354046">.</span><span class="ident" id="6354047">valsIndices</span><span class="op" id="6354058">[</span><span class="ident" id="6354059">i</span><span class="op" id="6354060">]</span><span class="op" id="6354061">+</span><span class="ident" id="6354062">code</span><span class="op" id="6354066">-</span><span class="ident" id="6354067">h</span><span class="op" id="6354068">.</span><span class="ident" id="6354069">minCodes</span><span class="op" id="6354077">[</span><span class="ident" id="6354078">i</span><span class="op" id="6354079">]</span><span class="op" id="6354080">]</span><span class="op" id="6354081">,</span>&nbsp;<span class="ident" id="6354083">nil</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354093">code</span>&nbsp;<span class="op" id="6354098">&lt;&lt;=</span>&nbsp;<span class="num" id="6354102">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354108">return</span>&nbsp;<span class="num" id="6354115">0</span><span class="op" id="6354116">,</span>&nbsp;<span class="ident" id="6354118">FormatError</span><span class="op" id="6354129">(</span><span class="string" id="6354130">&#34;bad&nbsp;Huffman&nbsp;code&#34;</span><span class="op" id="6354148">)</span><br>
<span class="lineno"></span><span class="op" id="6354150">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="6354153">func</span>&nbsp;<span class="op" id="6354158">(</span><span class="ident" id="6354159">d</span>&nbsp;<span class="op" id="6354161">*</span><span class="ident" id="6354162">decoder</span><span class="op" id="6354169">)</span>&nbsp;<span class="ident" id="6354171">decodeBit</span><span class="op" id="6354180">(</span><span class="op" id="6354181">)</span>&nbsp;<span class="op" id="6354183">(</span><span class="builtintype" id="6354184">bool</span><span class="op" id="6354188">,</span>&nbsp;<span class="builtintype" id="6354190">error</span><span class="op" id="6354195">)</span>&nbsp;<span class="op" id="6354197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354200">if</span>&nbsp;<span class="ident" id="6354203">d</span><span class="op" id="6354204">.</span><span class="ident" id="6354205">bits</span><span class="op" id="6354209">.</span><span class="ident" id="6354210">n</span>&nbsp;<span class="op" id="6354212">==</span>&nbsp;<span class="num" id="6354215">0</span>&nbsp;<span class="op" id="6354217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354221">if</span>&nbsp;<span class="ident" id="6354224">err</span>&nbsp;<span class="op" id="6354228">:=</span>&nbsp;<span class="ident" id="6354231">d</span><span class="op" id="6354232">.</span><span class="ident" id="6354233">ensureNBits</span><span class="op" id="6354244">(</span><span class="num" id="6354245">1</span><span class="op" id="6354246">)</span><span class="op" id="6354247">;</span>&nbsp;<span class="ident" id="6354249">err</span>&nbsp;<span class="op" id="6354253">!=</span>&nbsp;<span class="ident" id="6354256">nil</span>&nbsp;<span class="op" id="6354260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354265">return</span>&nbsp;<span class="builtintype" id="6354272">false</span><span class="op" id="6354277">,</span>&nbsp;<span class="ident" id="6354279">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354291">ret</span>&nbsp;<span class="op" id="6354295">:=</span>&nbsp;<span class="ident" id="6354298">d</span><span class="op" id="6354299">.</span><span class="ident" id="6354300">bits</span><span class="op" id="6354304">.</span><span class="ident" id="6354305">a</span><span class="op" id="6354306">&amp;</span><span class="ident" id="6354307">d</span><span class="op" id="6354308">.</span><span class="ident" id="6354309">bits</span><span class="op" id="6354313">.</span><span class="ident" id="6354314">m</span>&nbsp;<span class="op" id="6354316">!=</span>&nbsp;<span class="num" id="6354319">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354322">d</span><span class="op" id="6354323">.</span><span class="ident" id="6354324">bits</span><span class="op" id="6354328">.</span><span class="ident" id="6354329">n</span><span class="op" id="6354330">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354334">d</span><span class="op" id="6354335">.</span><span class="ident" id="6354336">bits</span><span class="op" id="6354340">.</span><span class="ident" id="6354341">m</span>&nbsp;<span class="op" id="6354343">&gt;&gt;=</span>&nbsp;<span class="num" id="6354347">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354350">return</span>&nbsp;<span class="ident" id="6354357">ret</span><span class="op" id="6354360">,</span>&nbsp;<span class="ident" id="6354362">nil</span><br>
<span class="lineno"></span><span class="op" id="6354366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6354369">func</span>&nbsp;<span class="op" id="6354374">(</span><span class="ident" id="6354375">d</span>&nbsp;<span class="op" id="6354377">*</span><span class="ident" id="6354378">decoder</span><span class="op" id="6354385">)</span>&nbsp;<span class="ident" id="6354387">decodeBits</span><span class="op" id="6354397">(</span><span class="ident" id="6354398">n</span>&nbsp;<span class="builtintype" id="6354400">int32</span><span class="op" id="6354405">)</span>&nbsp;<span class="op" id="6354407">(</span><span class="builtintype" id="6354408">uint32</span><span class="op" id="6354414">,</span>&nbsp;<span class="builtintype" id="6354416">error</span><span class="op" id="6354421">)</span>&nbsp;<span class="op" id="6354423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354426">if</span>&nbsp;<span class="ident" id="6354429">d</span><span class="op" id="6354430">.</span><span class="ident" id="6354431">bits</span><span class="op" id="6354435">.</span><span class="ident" id="6354436">n</span>&nbsp;<span class="op" id="6354438">&lt;</span>&nbsp;<span class="ident" id="6354440">n</span>&nbsp;<span class="op" id="6354442">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354446">if</span>&nbsp;<span class="ident" id="6354449">err</span>&nbsp;<span class="op" id="6354453">:=</span>&nbsp;<span class="ident" id="6354456">d</span><span class="op" id="6354457">.</span><span class="ident" id="6354458">ensureNBits</span><span class="op" id="6354469">(</span><span class="ident" id="6354470">n</span><span class="op" id="6354471">)</span><span class="op" id="6354472">;</span>&nbsp;<span class="ident" id="6354474">err</span>&nbsp;<span class="op" id="6354478">!=</span>&nbsp;<span class="ident" id="6354481">nil</span>&nbsp;<span class="op" id="6354485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354490">return</span>&nbsp;<span class="num" id="6354497">0</span><span class="op" id="6354498">,</span>&nbsp;<span class="ident" id="6354500">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6354509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354512">ret</span>&nbsp;<span class="op" id="6354516">:=</span>&nbsp;<span class="ident" id="6354519">d</span><span class="op" id="6354520">.</span><span class="ident" id="6354521">bits</span><span class="op" id="6354525">.</span><span class="ident" id="6354526">a</span>&nbsp;<span class="op" id="6354528">&gt;&gt;</span>&nbsp;<span class="builtintype" id="6354531">uint32</span><span class="op" id="6354537">(</span><span class="ident" id="6354538">d</span><span class="op" id="6354539">.</span><span class="ident" id="6354540">bits</span><span class="op" id="6354544">.</span><span class="ident" id="6354545">n</span><span class="op" id="6354546">-</span><span class="ident" id="6354547">n</span><span class="op" id="6354548">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354551">ret</span>&nbsp;<span class="op" id="6354555">&amp;=</span>&nbsp;<span class="op" id="6354558">(</span><span class="num" id="6354559">1</span>&nbsp;<span class="op" id="6354561">&lt;&lt;</span>&nbsp;<span class="builtintype" id="6354564">uint32</span><span class="op" id="6354570">(</span><span class="ident" id="6354571">n</span><span class="op" id="6354572">)</span><span class="op" id="6354573">)</span>&nbsp;<span class="op" id="6354575">-</span>&nbsp;<span class="num" id="6354577">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354580">d</span><span class="op" id="6354581">.</span><span class="ident" id="6354582">bits</span><span class="op" id="6354586">.</span><span class="ident" id="6354587">n</span>&nbsp;<span class="op" id="6354589">-=</span>&nbsp;<span class="ident" id="6354592">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6354595">d</span><span class="op" id="6354596">.</span><span class="ident" id="6354597">bits</span><span class="op" id="6354601">.</span><span class="ident" id="6354602">m</span>&nbsp;<span class="op" id="6354604">&gt;&gt;=</span>&nbsp;<span class="builtintype" id="6354608">uint32</span><span class="op" id="6354614">(</span><span class="ident" id="6354615">n</span><span class="op" id="6354616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6354619">return</span>&nbsp;<span class="ident" id="6354626">ret</span><span class="op" id="6354629">,</span>&nbsp;<span class="ident" id="6354631">nil</span><br>
<span class="lineno"></span><span class="op" id="6354635">}</span>
</div>
</body>
</html>
