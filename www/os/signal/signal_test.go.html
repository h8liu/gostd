<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7910073">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7910128">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7910182">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7910233">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7910298">package</span>&nbsp;<span class="ident" id="7910306">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7910314">import</span>&nbsp;<span class="op" id="7910321">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7910324">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7910332">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7910345">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7910351">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7910362">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7910373">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7910384">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7910395">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7910406">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7910413">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7910416">func</span>&nbsp;<span class="ident" id="7910421">waitSig</span><span class="op" id="7910428">(</span><span class="ident" id="7910429">t</span>&nbsp;<span class="op" id="7910431">*</span><span class="ident" id="7910432">testing</span><span class="op" id="7910439">.</span><span class="ident" id="7910440">T</span><span class="op" id="7910441">,</span>&nbsp;<span class="ident" id="7910443">c</span>&nbsp;<span class="op" id="7910445">&lt;-</span><span class="keyword" id="7910447">chan</span>&nbsp;<span class="ident" id="7910452">os</span><span class="op" id="7910454">.</span><span class="ident" id="7910455">Signal</span><span class="op" id="7910461">,</span>&nbsp;<span class="ident" id="7910463">sig</span>&nbsp;<span class="ident" id="7910467">os</span><span class="op" id="7910469">.</span><span class="ident" id="7910470">Signal</span><span class="op" id="7910476">)</span>&nbsp;<span class="op" id="7910478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7910481">select</span>&nbsp;<span class="op" id="7910488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7910491">case</span>&nbsp;<span class="ident" id="7910496">s</span>&nbsp;<span class="op" id="7910498">:=</span>&nbsp;<span class="op" id="7910501">&lt;-</span><span class="ident" id="7910503">c</span><span class="op" id="7910504">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7910508">if</span>&nbsp;<span class="ident" id="7910511">s</span>&nbsp;<span class="op" id="7910513">!=</span>&nbsp;<span class="ident" id="7910516">sig</span>&nbsp;<span class="op" id="7910520">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7910525">t</span><span class="op" id="7910526">.</span><span class="ident" id="7910527">Fatalf</span><span class="op" id="7910533">(</span><span class="string" id="7910534">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7910558">,</span>&nbsp;<span class="ident" id="7910560">s</span><span class="op" id="7910561">,</span>&nbsp;<span class="ident" id="7910563">sig</span><span class="op" id="7910566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7910570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7910573">case</span>&nbsp;<span class="op" id="7910578">&lt;-</span><span class="ident" id="7910580">time</span><span class="op" id="7910584">.</span><span class="ident" id="7910585">After</span><span class="op" id="7910590">(</span><span class="num" id="7910591">1</span>&nbsp;<span class="op" id="7910593">*</span>&nbsp;<span class="ident" id="7910595">time</span><span class="op" id="7910599">.</span><span class="ident" id="7910600">Second</span><span class="op" id="7910606">)</span><span class="op" id="7910607">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7910611">t</span><span class="op" id="7910612">.</span><span class="ident" id="7910613">Fatalf</span><span class="op" id="7910619">(</span><span class="string" id="7910620">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="7910644">,</span>&nbsp;<span class="ident" id="7910646">sig</span><span class="op" id="7910649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7910652">}</span><br>
<span class="lineno">30</span><span class="op" id="7910654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7910657">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="7910699">func</span>&nbsp;<span class="ident" id="7910704">TestSignal</span><span class="op" id="7910714">(</span><span class="ident" id="7910715">t</span>&nbsp;<span class="op" id="7910717">*</span><span class="ident" id="7910718">testing</span><span class="op" id="7910725">.</span><span class="ident" id="7910726">T</span><span class="op" id="7910727">)</span>&nbsp;<span class="op" id="7910729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7910732">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7910751">c</span>&nbsp;<span class="op" id="7910753">:=</span>&nbsp;<span class="builtinfunc" id="7910756">make</span><span class="op" id="7910760">(</span><span class="keyword" id="7910761">chan</span>&nbsp;<span class="ident" id="7910766">os</span><span class="op" id="7910768">.</span><span class="ident" id="7910769">Signal</span><span class="op" id="7910775">,</span>&nbsp;<span class="num" id="7910777">1</span><span class="op" id="7910778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7910781">Notify</span><span class="op" id="7910787">(</span><span class="ident" id="7910788">c</span><span class="op" id="7910789">,</span>&nbsp;<span class="ident" id="7910791">syscall</span><span class="op" id="7910798">.</span><span class="ident" id="7910799">SIGHUP</span><span class="op" id="7910805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7910808">defer</span>&nbsp;<span class="ident" id="7910814">Stop</span><span class="op" id="7910818">(</span><span class="ident" id="7910819">c</span><span class="op" id="7910820">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7910824">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7910855">t</span><span class="op" id="7910856">.</span><span class="ident" id="7910857">Logf</span><span class="op" id="7910861">(</span><span class="string" id="7910862">&#34;sighup...&#34;</span><span class="op" id="7910873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7910876">syscall</span><span class="op" id="7910883">.</span><span class="ident" id="7910884">Kill</span><span class="op" id="7910888">(</span><span class="ident" id="7910889">syscall</span><span class="op" id="7910896">.</span><span class="ident" id="7910897">Getpid</span><span class="op" id="7910903">(</span><span class="op" id="7910904">)</span><span class="op" id="7910905">,</span>&nbsp;<span class="ident" id="7910907">syscall</span><span class="op" id="7910914">.</span><span class="ident" id="7910915">SIGHUP</span><span class="op" id="7910921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7910924">waitSig</span><span class="op" id="7910931">(</span><span class="ident" id="7910932">t</span><span class="op" id="7910933">,</span>&nbsp;<span class="ident" id="7910935">c</span><span class="op" id="7910936">,</span>&nbsp;<span class="ident" id="7910938">syscall</span><span class="op" id="7910945">.</span><span class="ident" id="7910946">SIGHUP</span><span class="op" id="7910952">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7910956">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7910991">c1</span>&nbsp;<span class="op" id="7910994">:=</span>&nbsp;<span class="builtinfunc" id="7910997">make</span><span class="op" id="7911001">(</span><span class="keyword" id="7911002">chan</span>&nbsp;<span class="ident" id="7911007">os</span><span class="op" id="7911009">.</span><span class="ident" id="7911010">Signal</span><span class="op" id="7911016">,</span>&nbsp;<span class="num" id="7911018">1</span><span class="op" id="7911019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911022">Notify</span><span class="op" id="7911028">(</span><span class="ident" id="7911029">c1</span><span class="op" id="7911031">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7911035">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911068">t</span><span class="op" id="7911069">.</span><span class="ident" id="7911070">Logf</span><span class="op" id="7911074">(</span><span class="string" id="7911075">&#34;sigwinch...&#34;</span><span class="op" id="7911088">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911091">syscall</span><span class="op" id="7911098">.</span><span class="ident" id="7911099">Kill</span><span class="op" id="7911103">(</span><span class="ident" id="7911104">syscall</span><span class="op" id="7911111">.</span><span class="ident" id="7911112">Getpid</span><span class="op" id="7911118">(</span><span class="op" id="7911119">)</span><span class="op" id="7911120">,</span>&nbsp;<span class="ident" id="7911122">syscall</span><span class="op" id="7911129">.</span><span class="ident" id="7911130">SIGWINCH</span><span class="op" id="7911138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911141">waitSig</span><span class="op" id="7911148">(</span><span class="ident" id="7911149">t</span><span class="op" id="7911150">,</span>&nbsp;<span class="ident" id="7911152">c1</span><span class="op" id="7911154">,</span>&nbsp;<span class="ident" id="7911156">syscall</span><span class="op" id="7911163">.</span><span class="ident" id="7911164">SIGWINCH</span><span class="op" id="7911172">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7911176">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7911221">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7911271">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911309">t</span><span class="op" id="7911310">.</span><span class="ident" id="7911311">Logf</span><span class="op" id="7911315">(</span><span class="string" id="7911316">&#34;sighup...&#34;</span><span class="op" id="7911327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911330">syscall</span><span class="op" id="7911337">.</span><span class="ident" id="7911338">Kill</span><span class="op" id="7911342">(</span><span class="ident" id="7911343">syscall</span><span class="op" id="7911350">.</span><span class="ident" id="7911351">Getpid</span><span class="op" id="7911357">(</span><span class="op" id="7911358">)</span><span class="op" id="7911359">,</span>&nbsp;<span class="ident" id="7911361">syscall</span><span class="op" id="7911368">.</span><span class="ident" id="7911369">SIGHUP</span><span class="op" id="7911375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911378">waitSig</span><span class="op" id="7911385">(</span><span class="ident" id="7911386">t</span><span class="op" id="7911387">,</span>&nbsp;<span class="ident" id="7911389">c1</span><span class="op" id="7911391">,</span>&nbsp;<span class="ident" id="7911393">syscall</span><span class="op" id="7911400">.</span><span class="ident" id="7911401">SIGHUP</span><span class="op" id="7911407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911410">t</span><span class="op" id="7911411">.</span><span class="ident" id="7911412">Logf</span><span class="op" id="7911416">(</span><span class="string" id="7911417">&#34;sighup...&#34;</span><span class="op" id="7911428">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911431">syscall</span><span class="op" id="7911438">.</span><span class="ident" id="7911439">Kill</span><span class="op" id="7911443">(</span><span class="ident" id="7911444">syscall</span><span class="op" id="7911451">.</span><span class="ident" id="7911452">Getpid</span><span class="op" id="7911458">(</span><span class="op" id="7911459">)</span><span class="op" id="7911460">,</span>&nbsp;<span class="ident" id="7911462">syscall</span><span class="op" id="7911469">.</span><span class="ident" id="7911470">SIGHUP</span><span class="op" id="7911476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911479">waitSig</span><span class="op" id="7911486">(</span><span class="ident" id="7911487">t</span><span class="op" id="7911488">,</span>&nbsp;<span class="ident" id="7911490">c1</span><span class="op" id="7911492">,</span>&nbsp;<span class="ident" id="7911494">syscall</span><span class="op" id="7911501">.</span><span class="ident" id="7911502">SIGHUP</span><span class="op" id="7911508">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7911512">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911564">waitSig</span><span class="op" id="7911571">(</span><span class="ident" id="7911572">t</span><span class="op" id="7911573">,</span>&nbsp;<span class="ident" id="7911575">c</span><span class="op" id="7911576">,</span>&nbsp;<span class="ident" id="7911578">syscall</span><span class="op" id="7911585">.</span><span class="ident" id="7911586">SIGHUP</span><span class="op" id="7911592">)</span><br>
<span class="lineno">65</span><span class="op" id="7911594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7911597">func</span>&nbsp;<span class="ident" id="7911602">TestStress</span><span class="op" id="7911612">(</span><span class="ident" id="7911613">t</span>&nbsp;<span class="op" id="7911615">*</span><span class="ident" id="7911616">testing</span><span class="op" id="7911623">.</span><span class="ident" id="7911624">T</span><span class="op" id="7911625">)</span>&nbsp;<span class="op" id="7911627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911630">dur</span>&nbsp;<span class="op" id="7911634">:=</span>&nbsp;<span class="num" id="7911637">3</span>&nbsp;<span class="op" id="7911639">*</span>&nbsp;<span class="ident" id="7911641">time</span><span class="op" id="7911645">.</span><span class="ident" id="7911646">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7911654">if</span>&nbsp;<span class="ident" id="7911657">testing</span><span class="op" id="7911664">.</span><span class="ident" id="7911665">Short</span><span class="op" id="7911670">(</span><span class="op" id="7911671">)</span>&nbsp;<span class="op" id="7911673">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911677">dur</span>&nbsp;<span class="op" id="7911681">=</span>&nbsp;<span class="num" id="7911683">100</span>&nbsp;<span class="op" id="7911687">*</span>&nbsp;<span class="ident" id="7911689">time</span><span class="op" id="7911693">.</span><span class="ident" id="7911694">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7911707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7911710">defer</span>&nbsp;<span class="ident" id="7911716">runtime</span><span class="op" id="7911723">.</span><span class="ident" id="7911724">GOMAXPROCS</span><span class="op" id="7911734">(</span><span class="ident" id="7911735">runtime</span><span class="op" id="7911742">.</span><span class="ident" id="7911743">GOMAXPROCS</span><span class="op" id="7911753">(</span><span class="num" id="7911754">4</span><span class="op" id="7911755">)</span><span class="op" id="7911756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911759">done</span>&nbsp;<span class="op" id="7911764">:=</span>&nbsp;<span class="builtinfunc" id="7911767">make</span><span class="op" id="7911771">(</span><span class="keyword" id="7911772">chan</span>&nbsp;<span class="builtintype" id="7911777">bool</span><span class="op" id="7911781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911784">finished</span>&nbsp;<span class="op" id="7911793">:=</span>&nbsp;<span class="builtinfunc" id="7911796">make</span><span class="op" id="7911800">(</span><span class="keyword" id="7911801">chan</span>&nbsp;<span class="builtintype" id="7911806">bool</span><span class="op" id="7911810">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7911813">go</span>&nbsp;<span class="keyword" id="7911816">func</span><span class="op" id="7911820">(</span><span class="op" id="7911821">)</span>&nbsp;<span class="op" id="7911823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911827">sig</span>&nbsp;<span class="op" id="7911831">:=</span>&nbsp;<span class="builtinfunc" id="7911834">make</span><span class="op" id="7911838">(</span><span class="keyword" id="7911839">chan</span>&nbsp;<span class="ident" id="7911844">os</span><span class="op" id="7911846">.</span><span class="ident" id="7911847">Signal</span><span class="op" id="7911853">,</span>&nbsp;<span class="num" id="7911855">1</span><span class="op" id="7911856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911860">Notify</span><span class="op" id="7911866">(</span><span class="ident" id="7911867">sig</span><span class="op" id="7911870">,</span>&nbsp;<span class="ident" id="7911872">syscall</span><span class="op" id="7911879">.</span><span class="ident" id="7911880">SIGUSR1</span><span class="op" id="7911887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7911891">defer</span>&nbsp;<span class="ident" id="7911897">Stop</span><span class="op" id="7911901">(</span><span class="ident" id="7911902">sig</span><span class="op" id="7911905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911908">Loop</span><span class="op" id="7911912">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7911916">for</span>&nbsp;<span class="op" id="7911920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7911925">select</span>&nbsp;<span class="op" id="7911932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7911937">case</span>&nbsp;<span class="op" id="7911942">&lt;-</span><span class="ident" id="7911944">sig</span><span class="op" id="7911947">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7911952">case</span>&nbsp;<span class="op" id="7911957">&lt;-</span><span class="ident" id="7911959">done</span><span class="op" id="7911963">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7911969">break</span>&nbsp;<span class="ident" id="7911975">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7911983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7911987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7911991">finished</span>&nbsp;<span class="op" id="7912000">&lt;-</span>&nbsp;<span class="ident" id="7912003">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7912009">}</span><span class="op" id="7912010">(</span><span class="op" id="7912011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7912014">go</span>&nbsp;<span class="keyword" id="7912017">func</span><span class="op" id="7912021">(</span><span class="op" id="7912022">)</span>&nbsp;<span class="op" id="7912024">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7912027">Loop</span><span class="op" id="7912031">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7912035">for</span>&nbsp;<span class="op" id="7912039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7912044">select</span>&nbsp;<span class="op" id="7912051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7912056">case</span>&nbsp;<span class="op" id="7912061">&lt;-</span><span class="ident" id="7912063">done</span><span class="op" id="7912067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7912073">break</span>&nbsp;<span class="ident" id="7912079">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7912087">default</span><span class="op" id="7912094">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7912100">syscall</span><span class="op" id="7912107">.</span><span class="ident" id="7912108">Kill</span><span class="op" id="7912112">(</span><span class="ident" id="7912113">syscall</span><span class="op" id="7912120">.</span><span class="ident" id="7912121">Getpid</span><span class="op" id="7912127">(</span><span class="op" id="7912128">)</span><span class="op" id="7912129">,</span>&nbsp;<span class="ident" id="7912131">syscall</span><span class="op" id="7912138">.</span><span class="ident" id="7912139">SIGUSR1</span><span class="op" id="7912146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7912152">runtime</span><span class="op" id="7912159">.</span><span class="ident" id="7912160">Gosched</span><span class="op" id="7912167">(</span><span class="op" id="7912168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7912173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7912177">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7912181">finished</span>&nbsp;<span class="op" id="7912190">&lt;-</span>&nbsp;<span class="ident" id="7912193">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7912199">}</span><span class="op" id="7912200">(</span><span class="op" id="7912201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7912204">time</span><span class="op" id="7912208">.</span><span class="ident" id="7912209">Sleep</span><span class="op" id="7912214">(</span><span class="ident" id="7912215">dur</span><span class="op" id="7912218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7912221">close</span><span class="op" id="7912226">(</span><span class="ident" id="7912227">done</span><span class="op" id="7912231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7912234">&lt;-</span><span class="ident" id="7912236">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7912246">&lt;-</span><span class="ident" id="7912248">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7912258">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7912329">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7912379">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7912443">time</span><span class="op" id="7912447">.</span><span class="ident" id="7912448">Sleep</span><span class="op" id="7912453">(</span><span class="num" id="7912454">10</span>&nbsp;<span class="op" id="7912457">*</span>&nbsp;<span class="ident" id="7912459">time</span><span class="op" id="7912463">.</span><span class="ident" id="7912464">Millisecond</span><span class="op" id="7912475">)</span><br>
<span class="lineno">110</span><span class="op" id="7912477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7912480">var</span>&nbsp;<span class="ident" id="7912484">sendUncaughtSighup</span>&nbsp;<span class="op" id="7912503">=</span>&nbsp;<span class="ident" id="7912505">flag</span><span class="op" id="7912509">.</span><span class="ident" id="7912510">Int</span><span class="op" id="7912513">(</span><span class="string" id="7912514">&#34;send_uncaught_sighup&#34;</span><span class="op" id="7912536">,</span>&nbsp;<span class="num" id="7912538">0</span><span class="op" id="7912539">,</span>&nbsp;<span class="string" id="7912541">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="7912579">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7912582">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="7912637">func</span>&nbsp;<span class="ident" id="7912642">TestStop</span><span class="op" id="7912650">(</span><span class="ident" id="7912651">t</span>&nbsp;<span class="op" id="7912653">*</span><span class="ident" id="7912654">testing</span><span class="op" id="7912661">.</span><span class="ident" id="7912662">T</span><span class="op" id="7912663">)</span>&nbsp;<span class="op" id="7912665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7912668">sigs</span>&nbsp;<span class="op" id="7912673">:=</span>&nbsp;<span class="op" id="7912676">[</span><span class="op" id="7912677">]</span><span class="ident" id="7912678">syscall</span><span class="op" id="7912685">.</span><span class="ident" id="7912686">Signal</span><span class="op" id="7912692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7912696">syscall</span><span class="op" id="7912703">.</span><span class="ident" id="7912704">SIGWINCH</span><span class="op" id="7912712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7912716">syscall</span><span class="op" id="7912723">.</span><span class="ident" id="7912724">SIGHUP</span><span class="op" id="7912730">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7912733">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7912737">for</span>&nbsp;<span class="ident" id="7912741">_</span><span class="op" id="7912742">,</span>&nbsp;<span class="ident" id="7912744">sig</span>&nbsp;<span class="op" id="7912748">:=</span>&nbsp;<span class="keyword" id="7912751">range</span>&nbsp;<span class="ident" id="7912757">sigs</span>&nbsp;<span class="op" id="7912762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7912766">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7912788">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7912833">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7912904">if</span>&nbsp;<span class="ident" id="7912907">sig</span>&nbsp;<span class="op" id="7912911">!=</span>&nbsp;<span class="ident" id="7912914">syscall</span><span class="op" id="7912921">.</span><span class="ident" id="7912922">SIGHUP</span>&nbsp;<span class="op" id="7912929">||</span>&nbsp;<span class="op" id="7912932">*</span><span class="ident" id="7912933">sendUncaughtSighup</span>&nbsp;<span class="op" id="7912952">==</span>&nbsp;<span class="num" id="7912955">1</span>&nbsp;<span class="op" id="7912957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7912962">syscall</span><span class="op" id="7912969">.</span><span class="ident" id="7912970">Kill</span><span class="op" id="7912974">(</span><span class="ident" id="7912975">syscall</span><span class="op" id="7912982">.</span><span class="ident" id="7912983">Getpid</span><span class="op" id="7912989">(</span><span class="op" id="7912990">)</span><span class="op" id="7912991">,</span>&nbsp;<span class="ident" id="7912993">sig</span><span class="op" id="7912996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7913000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7913004">time</span><span class="op" id="7913008">.</span><span class="ident" id="7913009">Sleep</span><span class="op" id="7913014">(</span><span class="num" id="7913015">100</span>&nbsp;<span class="op" id="7913019">*</span>&nbsp;<span class="ident" id="7913021">time</span><span class="op" id="7913025">.</span><span class="ident" id="7913026">Millisecond</span><span class="op" id="7913037">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7913042">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7913062">c</span>&nbsp;<span class="op" id="7913064">:=</span>&nbsp;<span class="builtinfunc" id="7913067">make</span><span class="op" id="7913071">(</span><span class="keyword" id="7913072">chan</span>&nbsp;<span class="ident" id="7913077">os</span><span class="op" id="7913079">.</span><span class="ident" id="7913080">Signal</span><span class="op" id="7913086">,</span>&nbsp;<span class="num" id="7913088">1</span><span class="op" id="7913089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7913093">Notify</span><span class="op" id="7913099">(</span><span class="ident" id="7913100">c</span><span class="op" id="7913101">,</span>&nbsp;<span class="ident" id="7913103">sig</span><span class="op" id="7913106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7913110">defer</span>&nbsp;<span class="ident" id="7913116">Stop</span><span class="op" id="7913120">(</span><span class="ident" id="7913121">c</span><span class="op" id="7913122">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7913127">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7913162">syscall</span><span class="op" id="7913169">.</span><span class="ident" id="7913170">Kill</span><span class="op" id="7913174">(</span><span class="ident" id="7913175">syscall</span><span class="op" id="7913182">.</span><span class="ident" id="7913183">Getpid</span><span class="op" id="7913189">(</span><span class="op" id="7913190">)</span><span class="op" id="7913191">,</span>&nbsp;<span class="ident" id="7913193">sig</span><span class="op" id="7913196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7913200">waitSig</span><span class="op" id="7913207">(</span><span class="ident" id="7913208">t</span><span class="op" id="7913209">,</span>&nbsp;<span class="ident" id="7913211">c</span><span class="op" id="7913212">,</span>&nbsp;<span class="ident" id="7913214">sig</span><span class="op" id="7913217">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7913222">Stop</span><span class="op" id="7913226">(</span><span class="ident" id="7913227">c</span><span class="op" id="7913228">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7913232">select</span>&nbsp;<span class="op" id="7913239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7913243">case</span>&nbsp;<span class="ident" id="7913248">s</span>&nbsp;<span class="op" id="7913250">:=</span>&nbsp;<span class="op" id="7913253">&lt;-</span><span class="ident" id="7913255">c</span><span class="op" id="7913256">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7913261">t</span><span class="op" id="7913262">.</span><span class="ident" id="7913263">Fatalf</span><span class="op" id="7913269">(</span><span class="string" id="7913270">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7913292">,</span>&nbsp;<span class="ident" id="7913294">s</span><span class="op" id="7913295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7913299">case</span>&nbsp;<span class="op" id="7913304">&lt;-</span><span class="ident" id="7913306">time</span><span class="op" id="7913310">.</span><span class="ident" id="7913311">After</span><span class="op" id="7913316">(</span><span class="num" id="7913317">100</span>&nbsp;<span class="op" id="7913321">*</span>&nbsp;<span class="ident" id="7913323">time</span><span class="op" id="7913327">.</span><span class="ident" id="7913328">Millisecond</span><span class="op" id="7913339">)</span><span class="op" id="7913340">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7913345">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7913373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7913378">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7913400">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7913445">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7913516">if</span>&nbsp;<span class="ident" id="7913519">sig</span>&nbsp;<span class="op" id="7913523">!=</span>&nbsp;<span class="ident" id="7913526">syscall</span><span class="op" id="7913533">.</span><span class="ident" id="7913534">SIGHUP</span>&nbsp;<span class="op" id="7913541">||</span>&nbsp;<span class="op" id="7913544">*</span><span class="ident" id="7913545">sendUncaughtSighup</span>&nbsp;<span class="op" id="7913564">==</span>&nbsp;<span class="num" id="7913567">2</span>&nbsp;<span class="op" id="7913569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7913574">syscall</span><span class="op" id="7913581">.</span><span class="ident" id="7913582">Kill</span><span class="op" id="7913586">(</span><span class="ident" id="7913587">syscall</span><span class="op" id="7913594">.</span><span class="ident" id="7913595">Getpid</span><span class="op" id="7913601">(</span><span class="op" id="7913602">)</span><span class="op" id="7913603">,</span>&nbsp;<span class="ident" id="7913605">sig</span><span class="op" id="7913608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7913612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7913617">select</span>&nbsp;<span class="op" id="7913624">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7913628">case</span>&nbsp;<span class="ident" id="7913633">s</span>&nbsp;<span class="op" id="7913635">:=</span>&nbsp;<span class="op" id="7913638">&lt;-</span><span class="ident" id="7913640">c</span><span class="op" id="7913641">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7913646">t</span><span class="op" id="7913647">.</span><span class="ident" id="7913648">Fatalf</span><span class="op" id="7913654">(</span><span class="string" id="7913655">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7913677">,</span>&nbsp;<span class="ident" id="7913679">s</span><span class="op" id="7913680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7913684">case</span>&nbsp;<span class="op" id="7913689">&lt;-</span><span class="ident" id="7913691">time</span><span class="op" id="7913695">.</span><span class="ident" id="7913696">After</span><span class="op" id="7913701">(</span><span class="num" id="7913702">100</span>&nbsp;<span class="op" id="7913706">*</span>&nbsp;<span class="ident" id="7913708">time</span><span class="op" id="7913712">.</span><span class="ident" id="7913713">Millisecond</span><span class="op" id="7913724">)</span><span class="op" id="7913725">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7913730">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7913758">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7913761">}</span><br>
<span class="lineno"></span><span class="op" id="7913763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7913766">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="7913847">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="7913856">func</span>&nbsp;<span class="ident" id="7913861">TestNohup</span><span class="op" id="7913870">(</span><span class="ident" id="7913871">t</span>&nbsp;<span class="op" id="7913873">*</span><span class="ident" id="7913874">testing</span><span class="op" id="7913881">.</span><span class="ident" id="7913882">T</span><span class="op" id="7913883">)</span>&nbsp;<span class="op" id="7913885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7913888">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7913952">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7914005">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7914049">c</span>&nbsp;<span class="op" id="7914051">:=</span>&nbsp;<span class="builtinfunc" id="7914054">make</span><span class="op" id="7914058">(</span><span class="keyword" id="7914059">chan</span>&nbsp;<span class="ident" id="7914064">os</span><span class="op" id="7914066">.</span><span class="ident" id="7914067">Signal</span><span class="op" id="7914073">,</span>&nbsp;<span class="num" id="7914075">1</span><span class="op" id="7914076">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7914079">Notify</span><span class="op" id="7914085">(</span><span class="ident" id="7914086">c</span><span class="op" id="7914087">,</span>&nbsp;<span class="ident" id="7914089">syscall</span><span class="op" id="7914096">.</span><span class="ident" id="7914097">SIGHUP</span><span class="op" id="7914103">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7914107">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7914180">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7914247">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7914313">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7914392">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7914470">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7914474">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7914557">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7914640">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7914644">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7914704">for</span>&nbsp;<span class="ident" id="7914708">i</span>&nbsp;<span class="op" id="7914710">:=</span>&nbsp;<span class="num" id="7914713">1</span><span class="op" id="7914714">;</span>&nbsp;<span class="ident" id="7914716">i</span>&nbsp;<span class="op" id="7914718">&lt;=</span>&nbsp;<span class="num" id="7914721">2</span><span class="op" id="7914722">;</span>&nbsp;<span class="ident" id="7914724">i</span><span class="op" id="7914725">++</span>&nbsp;<span class="op" id="7914728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7914732">out</span><span class="op" id="7914735">,</span>&nbsp;<span class="ident" id="7914737">err</span>&nbsp;<span class="op" id="7914741">:=</span>&nbsp;<span class="ident" id="7914744">exec</span><span class="op" id="7914748">.</span><span class="ident" id="7914749">Command</span><span class="op" id="7914756">(</span><span class="ident" id="7914757">os</span><span class="op" id="7914759">.</span><span class="ident" id="7914760">Args</span><span class="op" id="7914764">[</span><span class="num" id="7914765">0</span><span class="op" id="7914766">]</span><span class="op" id="7914767">,</span>&nbsp;<span class="string" id="7914769">&#34;-test.run=TestStop&#34;</span><span class="op" id="7914789">,</span>&nbsp;<span class="string" id="7914791">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7914815">+</span><span class="ident" id="7914816">strconv</span><span class="op" id="7914823">.</span><span class="ident" id="7914824">Itoa</span><span class="op" id="7914828">(</span><span class="ident" id="7914829">i</span><span class="op" id="7914830">)</span><span class="op" id="7914831">)</span><span class="op" id="7914832">.</span><span class="ident" id="7914833">CombinedOutput</span><span class="op" id="7914847">(</span><span class="op" id="7914848">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7914852">if</span>&nbsp;<span class="ident" id="7914855">err</span>&nbsp;<span class="op" id="7914859">==</span>&nbsp;<span class="ident" id="7914862">nil</span>&nbsp;<span class="op" id="7914866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7914871">t</span><span class="op" id="7914872">.</span><span class="ident" id="7914873">Fatalf</span><span class="op" id="7914879">(</span><span class="string" id="7914880">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="7914969">,</span>&nbsp;<span class="ident" id="7914971">i</span><span class="op" id="7914972">,</span>&nbsp;<span class="ident" id="7914974">out</span><span class="op" id="7914977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7914981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7914984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7914988">Stop</span><span class="op" id="7914992">(</span><span class="ident" id="7914993">c</span><span class="op" id="7914994">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7914998">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7915056">_</span><span class="op" id="7915057">,</span>&nbsp;<span class="ident" id="7915059">err</span>&nbsp;<span class="op" id="7915063">:=</span>&nbsp;<span class="ident" id="7915066">os</span><span class="op" id="7915068">.</span><span class="ident" id="7915069">Stat</span><span class="op" id="7915073">(</span><span class="string" id="7915074">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7915090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7915093">if</span>&nbsp;<span class="ident" id="7915096">err</span>&nbsp;<span class="op" id="7915100">!=</span>&nbsp;<span class="ident" id="7915103">nil</span>&nbsp;<span class="op" id="7915107">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7915111">t</span><span class="op" id="7915112">.</span><span class="ident" id="7915113">Skip</span><span class="op" id="7915117">(</span><span class="string" id="7915118">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="7915167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7915170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7915174">for</span>&nbsp;<span class="ident" id="7915178">i</span>&nbsp;<span class="op" id="7915180">:=</span>&nbsp;<span class="num" id="7915183">1</span><span class="op" id="7915184">;</span>&nbsp;<span class="ident" id="7915186">i</span>&nbsp;<span class="op" id="7915188">&lt;=</span>&nbsp;<span class="num" id="7915191">2</span><span class="op" id="7915192">;</span>&nbsp;<span class="ident" id="7915194">i</span><span class="op" id="7915195">++</span>&nbsp;<span class="op" id="7915198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7915202">os</span><span class="op" id="7915204">.</span><span class="ident" id="7915205">Remove</span><span class="op" id="7915211">(</span><span class="string" id="7915212">&#34;nohup.out&#34;</span><span class="op" id="7915223">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7915227">out</span><span class="op" id="7915230">,</span>&nbsp;<span class="ident" id="7915232">err</span>&nbsp;<span class="op" id="7915236">:=</span>&nbsp;<span class="ident" id="7915239">exec</span><span class="op" id="7915243">.</span><span class="ident" id="7915244">Command</span><span class="op" id="7915251">(</span><span class="string" id="7915252">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7915268">,</span>&nbsp;<span class="ident" id="7915270">os</span><span class="op" id="7915272">.</span><span class="ident" id="7915273">Args</span><span class="op" id="7915277">[</span><span class="num" id="7915278">0</span><span class="op" id="7915279">]</span><span class="op" id="7915280">,</span>&nbsp;<span class="string" id="7915282">&#34;-test.run=TestStop&#34;</span><span class="op" id="7915302">,</span>&nbsp;<span class="string" id="7915304">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7915328">+</span><span class="ident" id="7915329">strconv</span><span class="op" id="7915336">.</span><span class="ident" id="7915337">Itoa</span><span class="op" id="7915341">(</span><span class="ident" id="7915342">i</span><span class="op" id="7915343">)</span><span class="op" id="7915344">)</span><span class="op" id="7915345">.</span><span class="ident" id="7915346">CombinedOutput</span><span class="op" id="7915360">(</span><span class="op" id="7915361">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7915366">data</span><span class="op" id="7915370">,</span>&nbsp;<span class="ident" id="7915372">_</span>&nbsp;<span class="op" id="7915374">:=</span>&nbsp;<span class="ident" id="7915377">ioutil</span><span class="op" id="7915383">.</span><span class="ident" id="7915384">ReadFile</span><span class="op" id="7915392">(</span><span class="string" id="7915393">&#34;nohup.out&#34;</span><span class="op" id="7915404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7915408">os</span><span class="op" id="7915410">.</span><span class="ident" id="7915411">Remove</span><span class="op" id="7915417">(</span><span class="string" id="7915418">&#34;nohup.out&#34;</span><span class="op" id="7915429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7915433">if</span>&nbsp;<span class="ident" id="7915436">err</span>&nbsp;<span class="op" id="7915440">!=</span>&nbsp;<span class="ident" id="7915443">nil</span>&nbsp;<span class="op" id="7915447">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7915452">t</span><span class="op" id="7915453">.</span><span class="ident" id="7915454">Fatalf</span><span class="op" id="7915460">(</span><span class="string" id="7915461">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="7915572">,</span>&nbsp;<span class="ident" id="7915574">i</span><span class="op" id="7915575">,</span>&nbsp;<span class="ident" id="7915577">err</span><span class="op" id="7915580">,</span>&nbsp;<span class="ident" id="7915582">out</span><span class="op" id="7915585">,</span>&nbsp;<span class="ident" id="7915587">data</span><span class="op" id="7915591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7915595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7915598">}</span><br>
<span class="lineno"></span><span class="op" id="7915600">}</span>
</div>
</body>
</html>
