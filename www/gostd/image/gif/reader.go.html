<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6321650">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6321705">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6321759">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6321810">//&nbsp;Package&nbsp;gif&nbsp;implements&nbsp;a&nbsp;GIF&nbsp;image&nbsp;decoder&nbsp;and&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="comment" id="6321869">//</span><br>
<span class="lineno"></span><span class="comment" id="6321872">//&nbsp;The&nbsp;GIF&nbsp;specification&nbsp;is&nbsp;at&nbsp;http://www.w3.org/Graphics/GIF/spec-gif89a.txt.</span><br>
<span class="lineno"></span><span class="keyword" id="6321951">package</span>&nbsp;<span class="ident" id="6321959">gif</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="6321964">import</span>&nbsp;<span class="op" id="6321971">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6321974">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6321983">&#34;compress/lzw&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6321999">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6322009">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6322016">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6322025">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6322040">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6322045">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="6322048">var</span>&nbsp;<span class="op" id="6322052">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322055">errNotEnough</span>&nbsp;<span class="op" id="6322068">=</span>&nbsp;<span class="ident" id="6322070">errors</span><span class="op" id="6322076">.</span><span class="ident" id="6322077">New</span><span class="op" id="6322080">(</span><span class="string" id="6322081">&#34;gif:&nbsp;not&nbsp;enough&nbsp;image&nbsp;data&#34;</span><span class="op" id="6322109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322112">errTooMuch</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6322125">=</span>&nbsp;<span class="ident" id="6322127">errors</span><span class="op" id="6322133">.</span><span class="ident" id="6322134">New</span><span class="op" id="6322137">(</span><span class="string" id="6322138">&#34;gif:&nbsp;too&nbsp;much&nbsp;image&nbsp;data&#34;</span><span class="op" id="6322164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322167">errBadPixel</span>&nbsp;&nbsp;<span class="op" id="6322180">=</span>&nbsp;<span class="ident" id="6322182">errors</span><span class="op" id="6322188">.</span><span class="ident" id="6322189">New</span><span class="op" id="6322192">(</span><span class="string" id="6322193">&#34;gif:&nbsp;invalid&nbsp;pixel&nbsp;value&#34;</span><span class="op" id="6322219">)</span><br>
<span class="lineno"></span><span class="op" id="6322221">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="6322224">//&nbsp;If&nbsp;the&nbsp;io.Reader&nbsp;does&nbsp;not&nbsp;also&nbsp;have&nbsp;ReadByte,&nbsp;then&nbsp;decode&nbsp;will&nbsp;introduce&nbsp;its&nbsp;own&nbsp;buffering.</span><br>
<span class="lineno"></span><span class="keyword" id="6322319">type</span>&nbsp;<span class="ident" id="6322324">reader</span>&nbsp;<span class="keyword" id="6322331">interface</span>&nbsp;<span class="op" id="6322341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322344">io</span><span class="op" id="6322346">.</span><span class="ident" id="6322347">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322355">io</span><span class="op" id="6322357">.</span><span class="ident" id="6322358">ByteReader</span><br>
<span class="lineno">30</span><span class="op" id="6322369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6322372">//&nbsp;Masks&nbsp;etc.</span><br>
<span class="lineno"></span><span class="keyword" id="6322386">const</span>&nbsp;<span class="op" id="6322392">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6322395">//&nbsp;Fields.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322407">fColorMapFollows</span>&nbsp;<span class="op" id="6322424">=</span>&nbsp;<span class="num" id="6322426">1</span>&nbsp;<span class="op" id="6322428">&lt;&lt;</span>&nbsp;<span class="num" id="6322431">7</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6322435">//&nbsp;Image&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322453">ifLocalColorTable</span>&nbsp;<span class="op" id="6322471">=</span>&nbsp;<span class="num" id="6322473">1</span>&nbsp;<span class="op" id="6322475">&lt;&lt;</span>&nbsp;<span class="num" id="6322478">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322481">ifInterlace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322499">=</span>&nbsp;<span class="num" id="6322501">1</span>&nbsp;<span class="op" id="6322503">&lt;&lt;</span>&nbsp;<span class="num" id="6322506">6</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322509">ifPixelSizeMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6322527">=</span>&nbsp;<span class="num" id="6322529">7</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6322533">//&nbsp;Graphic&nbsp;control&nbsp;flags.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322560">gcTransparentColorSet</span>&nbsp;<span class="op" id="6322582">=</span>&nbsp;<span class="num" id="6322584">1</span>&nbsp;<span class="op" id="6322586">&lt;&lt;</span>&nbsp;<span class="num" id="6322589">0</span><br>
<span class="lineno"></span><span class="op" id="6322591">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="6322594">//&nbsp;Section&nbsp;indicators.</span><br>
<span class="lineno"></span><span class="keyword" id="6322617">const</span>&nbsp;<span class="op" id="6322623">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322626">sExtension</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322643">=</span>&nbsp;<span class="num" id="6322645">0x21</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322651">sImageDescriptor</span>&nbsp;<span class="op" id="6322668">=</span>&nbsp;<span class="num" id="6322670">0x2C</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322676">sTrailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322693">=</span>&nbsp;<span class="num" id="6322695">0x3B</span><br>
<span class="lineno"></span><span class="op" id="6322700">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6322703">//&nbsp;Extensions.</span><br>
<span class="lineno"></span><span class="keyword" id="6322718">const</span>&nbsp;<span class="op" id="6322724">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322727">eText</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322743">=</span>&nbsp;<span class="num" id="6322745">0x01</span>&nbsp;<span class="comment" id="6322750">//&nbsp;Plain&nbsp;Text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322765">eGraphicControl</span>&nbsp;<span class="op" id="6322781">=</span>&nbsp;<span class="num" id="6322783">0xF9</span>&nbsp;<span class="comment" id="6322788">//&nbsp;Graphic&nbsp;Control</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322808">eComment</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322824">=</span>&nbsp;<span class="num" id="6322826">0xFE</span>&nbsp;<span class="comment" id="6322831">//&nbsp;Comment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322843">eApplication</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6322859">=</span>&nbsp;<span class="num" id="6322861">0xFF</span>&nbsp;<span class="comment" id="6322866">//&nbsp;Application</span><br>
<span class="lineno"></span><span class="op" id="6322881">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="6322884">//&nbsp;decoder&nbsp;is&nbsp;the&nbsp;type&nbsp;used&nbsp;to&nbsp;decode&nbsp;a&nbsp;GIF&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="6322934">type</span>&nbsp;<span class="ident" id="6322939">decoder</span>&nbsp;<span class="keyword" id="6322947">struct</span>&nbsp;<span class="op" id="6322954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322957">r</span>&nbsp;<span class="ident" id="6322959">reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6322968">//&nbsp;From&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6322985">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6323001">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323009">width</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6323025">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323030">height</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6323046">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323051">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6323067">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323073">headerFields</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6323089">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323095">backgroundIndex</span>&nbsp;<span class="builtintype" id="6323111">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323117">loopCount</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6323133">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323138">delayTime</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6323154">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6323160">//&nbsp;Unused&nbsp;from&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323184">aspect</span>&nbsp;<span class="builtintype" id="6323191">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6323198">//&nbsp;From&nbsp;image&nbsp;descriptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323225">imageFields</span>&nbsp;<span class="builtintype" id="6323237">byte</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6323244">//&nbsp;From&nbsp;graphics&nbsp;control.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323271">transparentIndex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6323291">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323297">hasTransparentIndex</span>&nbsp;<span class="builtintype" id="6323317">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6323324">//&nbsp;Computed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323338">pixelSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6323353">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323359">globalColorMap</span>&nbsp;<span class="ident" id="6323374">color</span><span class="op" id="6323379">.</span><span class="ident" id="6323380">Palette</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6323390">//&nbsp;Used&nbsp;when&nbsp;decoding.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323414">delay</span>&nbsp;<span class="op" id="6323420">[</span><span class="op" id="6323421">]</span><span class="builtintype" id="6323422">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323427">image</span>&nbsp;<span class="op" id="6323433">[</span><span class="op" id="6323434">]</span><span class="op" id="6323435">*</span><span class="ident" id="6323436">image</span><span class="op" id="6323441">.</span><span class="ident" id="6323442">Paletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323452">tmp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6323458">[</span><span class="num" id="6323459">1024</span><span class="op" id="6323463">]</span><span class="builtintype" id="6323464">byte</span>&nbsp;<span class="comment" id="6323469">//&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;768&nbsp;so&nbsp;we&nbsp;can&nbsp;read&nbsp;color&nbsp;map</span><br>
<span class="lineno"></span><span class="op" id="6323518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="6323521">//&nbsp;blockReader&nbsp;parses&nbsp;the&nbsp;block&nbsp;structure&nbsp;of&nbsp;GIF&nbsp;image&nbsp;data,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="6323588">//&nbsp;comprises&nbsp;(n,&nbsp;(n&nbsp;bytes))&nbsp;blocks,&nbsp;with&nbsp;1&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;255.&nbsp;&nbsp;It&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6323655">//&nbsp;reader&nbsp;given&nbsp;to&nbsp;the&nbsp;LZW&nbsp;decoder,&nbsp;which&nbsp;is&nbsp;thus&nbsp;immune&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6323719">//&nbsp;blocking.&nbsp;&nbsp;After&nbsp;the&nbsp;LZW&nbsp;decoder&nbsp;completes,&nbsp;there&nbsp;will&nbsp;be&nbsp;a&nbsp;0-byte</span><br>
<span class="lineno"></span><span class="comment" id="6323789">//&nbsp;block&nbsp;remaining&nbsp;(0,&nbsp;()),&nbsp;which&nbsp;is&nbsp;consumed&nbsp;when&nbsp;checking&nbsp;that&nbsp;the</span><br>
<span class="lineno">100</span><span class="comment" id="6323858">//&nbsp;blockReader&nbsp;is&nbsp;exhausted.</span><br>
<span class="lineno"></span><span class="keyword" id="6323887">type</span>&nbsp;<span class="ident" id="6323892">blockReader</span>&nbsp;<span class="keyword" id="6323904">struct</span>&nbsp;<span class="op" id="6323911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323914">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6323920">reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323928">slice</span>&nbsp;<span class="op" id="6323934">[</span><span class="op" id="6323935">]</span><span class="builtintype" id="6323936">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323942">err</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6323948">error</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6323955">tmp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6323961">[</span><span class="num" id="6323962">256</span><span class="op" id="6323965">]</span><span class="builtintype" id="6323966">byte</span><br>
<span class="lineno"></span><span class="op" id="6323971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6323974">func</span>&nbsp;<span class="op" id="6323979">(</span><span class="ident" id="6323980">b</span>&nbsp;<span class="op" id="6323982">*</span><span class="ident" id="6323983">blockReader</span><span class="op" id="6323994">)</span>&nbsp;<span class="ident" id="6323996">Read</span><span class="op" id="6324000">(</span><span class="ident" id="6324001">p</span>&nbsp;<span class="op" id="6324003">[</span><span class="op" id="6324004">]</span><span class="builtintype" id="6324005">byte</span><span class="op" id="6324009">)</span>&nbsp;<span class="op" id="6324011">(</span><span class="builtintype" id="6324012">int</span><span class="op" id="6324015">,</span>&nbsp;<span class="builtintype" id="6324017">error</span><span class="op" id="6324022">)</span>&nbsp;<span class="op" id="6324024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324027">if</span>&nbsp;<span class="ident" id="6324030">b</span><span class="op" id="6324031">.</span><span class="ident" id="6324032">err</span>&nbsp;<span class="op" id="6324036">!=</span>&nbsp;<span class="ident" id="6324039">nil</span>&nbsp;<span class="op" id="6324043">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324047">return</span>&nbsp;<span class="num" id="6324054">0</span><span class="op" id="6324055">,</span>&nbsp;<span class="ident" id="6324057">b</span><span class="op" id="6324058">.</span><span class="ident" id="6324059">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324067">if</span>&nbsp;<span class="builtinfunc" id="6324070">len</span><span class="op" id="6324073">(</span><span class="ident" id="6324074">p</span><span class="op" id="6324075">)</span>&nbsp;<span class="op" id="6324077">==</span>&nbsp;<span class="num" id="6324080">0</span>&nbsp;<span class="op" id="6324082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324086">return</span>&nbsp;<span class="num" id="6324093">0</span><span class="op" id="6324094">,</span>&nbsp;<span class="ident" id="6324096">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324101">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324104">if</span>&nbsp;<span class="builtinfunc" id="6324107">len</span><span class="op" id="6324110">(</span><span class="ident" id="6324111">b</span><span class="op" id="6324112">.</span><span class="ident" id="6324113">slice</span><span class="op" id="6324118">)</span>&nbsp;<span class="op" id="6324120">==</span>&nbsp;<span class="num" id="6324123">0</span>&nbsp;<span class="op" id="6324125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324129">var</span>&nbsp;<span class="ident" id="6324133">blockLen</span>&nbsp;<span class="builtintype" id="6324142">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324150">blockLen</span><span class="op" id="6324158">,</span>&nbsp;<span class="ident" id="6324160">b</span><span class="op" id="6324161">.</span><span class="ident" id="6324162">err</span>&nbsp;<span class="op" id="6324166">=</span>&nbsp;<span class="ident" id="6324168">b</span><span class="op" id="6324169">.</span><span class="ident" id="6324170">r</span><span class="op" id="6324171">.</span><span class="ident" id="6324172">ReadByte</span><span class="op" id="6324180">(</span><span class="op" id="6324181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324185">if</span>&nbsp;<span class="ident" id="6324188">b</span><span class="op" id="6324189">.</span><span class="ident" id="6324190">err</span>&nbsp;<span class="op" id="6324194">!=</span>&nbsp;<span class="ident" id="6324197">nil</span>&nbsp;<span class="op" id="6324201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324206">return</span>&nbsp;<span class="num" id="6324213">0</span><span class="op" id="6324214">,</span>&nbsp;<span class="ident" id="6324216">b</span><span class="op" id="6324217">.</span><span class="ident" id="6324218">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324228">if</span>&nbsp;<span class="ident" id="6324231">blockLen</span>&nbsp;<span class="op" id="6324240">==</span>&nbsp;<span class="num" id="6324243">0</span>&nbsp;<span class="op" id="6324245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324250">b</span><span class="op" id="6324251">.</span><span class="ident" id="6324252">err</span>&nbsp;<span class="op" id="6324256">=</span>&nbsp;<span class="ident" id="6324258">io</span><span class="op" id="6324260">.</span><span class="ident" id="6324261">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324268">return</span>&nbsp;<span class="num" id="6324275">0</span><span class="op" id="6324276">,</span>&nbsp;<span class="ident" id="6324278">b</span><span class="op" id="6324279">.</span><span class="ident" id="6324280">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324286">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324290">b</span><span class="op" id="6324291">.</span><span class="ident" id="6324292">slice</span>&nbsp;<span class="op" id="6324298">=</span>&nbsp;<span class="ident" id="6324300">b</span><span class="op" id="6324301">.</span><span class="ident" id="6324302">tmp</span><span class="op" id="6324305">[</span><span class="num" id="6324306">0</span><span class="op" id="6324307">:</span><span class="ident" id="6324308">blockLen</span><span class="op" id="6324316">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324320">if</span>&nbsp;<span class="ident" id="6324323">_</span><span class="op" id="6324324">,</span>&nbsp;<span class="ident" id="6324326">b</span><span class="op" id="6324327">.</span><span class="ident" id="6324328">err</span>&nbsp;<span class="op" id="6324332">=</span>&nbsp;<span class="ident" id="6324334">io</span><span class="op" id="6324336">.</span><span class="ident" id="6324337">ReadFull</span><span class="op" id="6324345">(</span><span class="ident" id="6324346">b</span><span class="op" id="6324347">.</span><span class="ident" id="6324348">r</span><span class="op" id="6324349">,</span>&nbsp;<span class="ident" id="6324351">b</span><span class="op" id="6324352">.</span><span class="ident" id="6324353">slice</span><span class="op" id="6324358">)</span><span class="op" id="6324359">;</span>&nbsp;<span class="ident" id="6324361">b</span><span class="op" id="6324362">.</span><span class="ident" id="6324363">err</span>&nbsp;<span class="op" id="6324367">!=</span>&nbsp;<span class="ident" id="6324370">nil</span>&nbsp;<span class="op" id="6324374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324379">return</span>&nbsp;<span class="num" id="6324386">0</span><span class="op" id="6324387">,</span>&nbsp;<span class="ident" id="6324389">b</span><span class="op" id="6324390">.</span><span class="ident" id="6324391">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324400">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324403">n</span>&nbsp;<span class="op" id="6324405">:=</span>&nbsp;<span class="builtinfunc" id="6324408">copy</span><span class="op" id="6324412">(</span><span class="ident" id="6324413">p</span><span class="op" id="6324414">,</span>&nbsp;<span class="ident" id="6324416">b</span><span class="op" id="6324417">.</span><span class="ident" id="6324418">slice</span><span class="op" id="6324423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324426">b</span><span class="op" id="6324427">.</span><span class="ident" id="6324428">slice</span>&nbsp;<span class="op" id="6324434">=</span>&nbsp;<span class="ident" id="6324436">b</span><span class="op" id="6324437">.</span><span class="ident" id="6324438">slice</span><span class="op" id="6324443">[</span><span class="ident" id="6324444">n</span><span class="op" id="6324445">:</span><span class="op" id="6324446">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324449">return</span>&nbsp;<span class="ident" id="6324456">n</span><span class="op" id="6324457">,</span>&nbsp;<span class="ident" id="6324459">nil</span><br>
<span class="lineno"></span><span class="op" id="6324463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="comment" id="6324466">//&nbsp;decode&nbsp;reads&nbsp;a&nbsp;GIF&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;stores&nbsp;the&nbsp;result&nbsp;in&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="6324529">func</span>&nbsp;<span class="op" id="6324534">(</span><span class="ident" id="6324535">d</span>&nbsp;<span class="op" id="6324537">*</span><span class="ident" id="6324538">decoder</span><span class="op" id="6324545">)</span>&nbsp;<span class="ident" id="6324547">decode</span><span class="op" id="6324553">(</span><span class="ident" id="6324554">r</span>&nbsp;<span class="ident" id="6324556">io</span><span class="op" id="6324558">.</span><span class="ident" id="6324559">Reader</span><span class="op" id="6324565">,</span>&nbsp;<span class="ident" id="6324567">configOnly</span>&nbsp;<span class="builtintype" id="6324578">bool</span><span class="op" id="6324582">)</span>&nbsp;<span class="builtintype" id="6324584">error</span>&nbsp;<span class="op" id="6324590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6324593">//&nbsp;Add&nbsp;buffering&nbsp;if&nbsp;r&nbsp;does&nbsp;not&nbsp;provide&nbsp;ReadByte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324643">if</span>&nbsp;<span class="ident" id="6324646">rr</span><span class="op" id="6324648">,</span>&nbsp;<span class="ident" id="6324650">ok</span>&nbsp;<span class="op" id="6324653">:=</span>&nbsp;<span class="ident" id="6324656">r</span><span class="op" id="6324657">.</span><span class="op" id="6324658">(</span><span class="ident" id="6324659">reader</span><span class="op" id="6324665">)</span><span class="op" id="6324666">;</span>&nbsp;<span class="ident" id="6324668">ok</span>&nbsp;<span class="op" id="6324671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324675">d</span><span class="op" id="6324676">.</span><span class="ident" id="6324677">r</span>&nbsp;<span class="op" id="6324679">=</span>&nbsp;<span class="ident" id="6324681">rr</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324685">}</span>&nbsp;<span class="keyword" id="6324687">else</span>&nbsp;<span class="op" id="6324692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324696">d</span><span class="op" id="6324697">.</span><span class="ident" id="6324698">r</span>&nbsp;<span class="op" id="6324700">=</span>&nbsp;<span class="ident" id="6324702">bufio</span><span class="op" id="6324707">.</span><span class="ident" id="6324708">NewReader</span><span class="op" id="6324717">(</span><span class="ident" id="6324718">r</span><span class="op" id="6324719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324726">err</span>&nbsp;<span class="op" id="6324730">:=</span>&nbsp;<span class="ident" id="6324733">d</span><span class="op" id="6324734">.</span><span class="ident" id="6324735">readHeaderAndScreenDescriptor</span><span class="op" id="6324764">(</span><span class="op" id="6324765">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324768">if</span>&nbsp;<span class="ident" id="6324771">err</span>&nbsp;<span class="op" id="6324775">!=</span>&nbsp;<span class="ident" id="6324778">nil</span>&nbsp;<span class="op" id="6324782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324786">return</span>&nbsp;<span class="ident" id="6324793">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324801">if</span>&nbsp;<span class="ident" id="6324804">configOnly</span>&nbsp;<span class="op" id="6324815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324819">return</span>&nbsp;<span class="ident" id="6324826">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324835">if</span>&nbsp;<span class="ident" id="6324838">d</span><span class="op" id="6324839">.</span><span class="ident" id="6324840">headerFields</span><span class="op" id="6324852">&amp;</span><span class="ident" id="6324853">fColorMapFollows</span>&nbsp;<span class="op" id="6324870">!=</span>&nbsp;<span class="num" id="6324873">0</span>&nbsp;<span class="op" id="6324875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324879">if</span>&nbsp;<span class="ident" id="6324882">d</span><span class="op" id="6324883">.</span><span class="ident" id="6324884">globalColorMap</span><span class="op" id="6324898">,</span>&nbsp;<span class="ident" id="6324900">err</span>&nbsp;<span class="op" id="6324904">=</span>&nbsp;<span class="ident" id="6324906">d</span><span class="op" id="6324907">.</span><span class="ident" id="6324908">readColorMap</span><span class="op" id="6324920">(</span><span class="op" id="6324921">)</span><span class="op" id="6324922">;</span>&nbsp;<span class="ident" id="6324924">err</span>&nbsp;<span class="op" id="6324928">!=</span>&nbsp;<span class="ident" id="6324931">nil</span>&nbsp;<span class="op" id="6324935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324940">return</span>&nbsp;<span class="ident" id="6324947">err</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6324956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324960">for</span>&nbsp;<span class="op" id="6324964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6324968">c</span><span class="op" id="6324969">,</span>&nbsp;<span class="ident" id="6324971">err</span>&nbsp;<span class="op" id="6324975">:=</span>&nbsp;<span class="ident" id="6324978">d</span><span class="op" id="6324979">.</span><span class="ident" id="6324980">r</span><span class="op" id="6324981">.</span><span class="ident" id="6324982">ReadByte</span><span class="op" id="6324990">(</span><span class="op" id="6324991">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6324995">if</span>&nbsp;<span class="ident" id="6324998">err</span>&nbsp;<span class="op" id="6325002">!=</span>&nbsp;<span class="ident" id="6325005">nil</span>&nbsp;<span class="op" id="6325009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325014">return</span>&nbsp;<span class="ident" id="6325021">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325031">switch</span>&nbsp;<span class="ident" id="6325038">c</span>&nbsp;<span class="op" id="6325040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325044">case</span>&nbsp;<span class="ident" id="6325049">sExtension</span><span class="op" id="6325059">:</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325064">if</span>&nbsp;<span class="ident" id="6325067">err</span>&nbsp;<span class="op" id="6325071">=</span>&nbsp;<span class="ident" id="6325073">d</span><span class="op" id="6325074">.</span><span class="ident" id="6325075">readExtension</span><span class="op" id="6325088">(</span><span class="op" id="6325089">)</span><span class="op" id="6325090">;</span>&nbsp;<span class="ident" id="6325092">err</span>&nbsp;<span class="op" id="6325096">!=</span>&nbsp;<span class="ident" id="6325099">nil</span>&nbsp;<span class="op" id="6325103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325109">return</span>&nbsp;<span class="ident" id="6325116">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325128">case</span>&nbsp;<span class="ident" id="6325133">sImageDescriptor</span><span class="op" id="6325149">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325154">m</span><span class="op" id="6325155">,</span>&nbsp;<span class="ident" id="6325157">err</span>&nbsp;<span class="op" id="6325161">:=</span>&nbsp;<span class="ident" id="6325164">d</span><span class="op" id="6325165">.</span><span class="ident" id="6325166">newImageFromDescriptor</span><span class="op" id="6325188">(</span><span class="op" id="6325189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325194">if</span>&nbsp;<span class="ident" id="6325197">err</span>&nbsp;<span class="op" id="6325201">!=</span>&nbsp;<span class="ident" id="6325204">nil</span>&nbsp;<span class="op" id="6325208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325214">return</span>&nbsp;<span class="ident" id="6325221">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325233">useLocalColorMap</span>&nbsp;<span class="op" id="6325250">:=</span>&nbsp;<span class="ident" id="6325253">d</span><span class="op" id="6325254">.</span><span class="ident" id="6325255">imageFields</span><span class="op" id="6325266">&amp;</span><span class="ident" id="6325267">fColorMapFollows</span>&nbsp;<span class="op" id="6325284">!=</span>&nbsp;<span class="num" id="6325287">0</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325292">if</span>&nbsp;<span class="ident" id="6325295">useLocalColorMap</span>&nbsp;<span class="op" id="6325312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325318">m</span><span class="op" id="6325319">.</span><span class="ident" id="6325320">Palette</span><span class="op" id="6325327">,</span>&nbsp;<span class="ident" id="6325329">err</span>&nbsp;<span class="op" id="6325333">=</span>&nbsp;<span class="ident" id="6325335">d</span><span class="op" id="6325336">.</span><span class="ident" id="6325337">readColorMap</span><span class="op" id="6325349">(</span><span class="op" id="6325350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325356">if</span>&nbsp;<span class="ident" id="6325359">err</span>&nbsp;<span class="op" id="6325363">!=</span>&nbsp;<span class="ident" id="6325366">nil</span>&nbsp;<span class="op" id="6325370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325377">return</span>&nbsp;<span class="ident" id="6325384">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325392">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325397">}</span>&nbsp;<span class="keyword" id="6325399">else</span>&nbsp;<span class="op" id="6325404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325410">m</span><span class="op" id="6325411">.</span><span class="ident" id="6325412">Palette</span>&nbsp;<span class="op" id="6325420">=</span>&nbsp;<span class="ident" id="6325422">d</span><span class="op" id="6325423">.</span><span class="ident" id="6325424">globalColorMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325447">if</span>&nbsp;<span class="ident" id="6325450">d</span><span class="op" id="6325451">.</span><span class="ident" id="6325452">hasTransparentIndex</span>&nbsp;<span class="op" id="6325472">&amp;&amp;</span>&nbsp;<span class="builtintype" id="6325475">int</span><span class="op" id="6325478">(</span><span class="ident" id="6325479">d</span><span class="op" id="6325480">.</span><span class="ident" id="6325481">transparentIndex</span><span class="op" id="6325497">)</span>&nbsp;<span class="op" id="6325499">&lt;</span>&nbsp;<span class="builtinfunc" id="6325501">len</span><span class="op" id="6325504">(</span><span class="ident" id="6325505">m</span><span class="op" id="6325506">.</span><span class="ident" id="6325507">Palette</span><span class="op" id="6325514">)</span>&nbsp;<span class="op" id="6325516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325522">if</span>&nbsp;<span class="op" id="6325525">!</span><span class="ident" id="6325526">useLocalColorMap</span>&nbsp;<span class="op" id="6325543">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6325550">//&nbsp;Clone&nbsp;the&nbsp;global&nbsp;color&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325586">m</span><span class="op" id="6325587">.</span><span class="ident" id="6325588">Palette</span>&nbsp;<span class="op" id="6325596">=</span>&nbsp;<span class="builtinfunc" id="6325598">append</span><span class="op" id="6325604">(</span><span class="ident" id="6325605">color</span><span class="op" id="6325610">.</span><span class="ident" id="6325611">Palette</span><span class="op" id="6325618">(</span><span class="ident" id="6325619">nil</span><span class="op" id="6325622">)</span><span class="op" id="6325623">,</span>&nbsp;<span class="ident" id="6325625">d</span><span class="op" id="6325626">.</span><span class="ident" id="6325627">globalColorMap</span><span class="op" id="6325641">...</span><span class="op" id="6325644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325656">m</span><span class="op" id="6325657">.</span><span class="ident" id="6325658">Palette</span><span class="op" id="6325665">[</span><span class="ident" id="6325666">d</span><span class="op" id="6325667">.</span><span class="ident" id="6325668">transparentIndex</span><span class="op" id="6325684">]</span>&nbsp;<span class="op" id="6325686">=</span>&nbsp;<span class="ident" id="6325688">color</span><span class="op" id="6325693">.</span><span class="ident" id="6325694">RGBA</span><span class="op" id="6325698">{</span><span class="op" id="6325699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325704">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325709">litWidth</span><span class="op" id="6325717">,</span>&nbsp;<span class="ident" id="6325719">err</span>&nbsp;<span class="op" id="6325723">:=</span>&nbsp;<span class="ident" id="6325726">d</span><span class="op" id="6325727">.</span><span class="ident" id="6325728">r</span><span class="op" id="6325729">.</span><span class="ident" id="6325730">ReadByte</span><span class="op" id="6325738">(</span><span class="op" id="6325739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325744">if</span>&nbsp;<span class="ident" id="6325747">err</span>&nbsp;<span class="op" id="6325751">!=</span>&nbsp;<span class="ident" id="6325754">nil</span>&nbsp;<span class="op" id="6325758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325764">return</span>&nbsp;<span class="ident" id="6325771">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325783">if</span>&nbsp;<span class="ident" id="6325786">litWidth</span>&nbsp;<span class="op" id="6325795">&lt;</span>&nbsp;<span class="num" id="6325797">2</span>&nbsp;<span class="op" id="6325799">||</span>&nbsp;<span class="ident" id="6325802">litWidth</span>&nbsp;<span class="op" id="6325811">&gt;</span>&nbsp;<span class="num" id="6325813">8</span>&nbsp;<span class="op" id="6325815">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6325821">return</span>&nbsp;<span class="ident" id="6325828">fmt</span><span class="op" id="6325831">.</span><span class="ident" id="6325832">Errorf</span><span class="op" id="6325838">(</span><span class="string" id="6325839">&#34;gif:&nbsp;pixel&nbsp;size&nbsp;in&nbsp;decode&nbsp;out&nbsp;of&nbsp;range:&nbsp;%d&#34;</span><span class="op" id="6325883">,</span>&nbsp;<span class="ident" id="6325885">litWidth</span><span class="op" id="6325893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6325898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6325903">//&nbsp;A&nbsp;wonderfully&nbsp;Go-like&nbsp;piece&nbsp;of&nbsp;magic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325947">br</span>&nbsp;<span class="op" id="6325950">:=</span>&nbsp;<span class="op" id="6325953">&amp;</span><span class="ident" id="6325954">blockReader</span><span class="op" id="6325965">{</span><span class="ident" id="6325966">r</span><span class="op" id="6325967">:</span>&nbsp;<span class="ident" id="6325969">d</span><span class="op" id="6325970">.</span><span class="ident" id="6325971">r</span><span class="op" id="6325972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6325977">lzwr</span>&nbsp;<span class="op" id="6325982">:=</span>&nbsp;<span class="ident" id="6325985">lzw</span><span class="op" id="6325988">.</span><span class="ident" id="6325989">NewReader</span><span class="op" id="6325998">(</span><span class="ident" id="6325999">br</span><span class="op" id="6326001">,</span>&nbsp;<span class="ident" id="6326003">lzw</span><span class="op" id="6326006">.</span><span class="ident" id="6326007">LSB</span><span class="op" id="6326010">,</span>&nbsp;<span class="builtintype" id="6326012">int</span><span class="op" id="6326015">(</span><span class="ident" id="6326016">litWidth</span><span class="op" id="6326024">)</span><span class="op" id="6326025">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326030">defer</span>&nbsp;<span class="ident" id="6326036">lzwr</span><span class="op" id="6326040">.</span><span class="ident" id="6326041">Close</span><span class="op" id="6326046">(</span><span class="op" id="6326047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326052">if</span>&nbsp;<span class="ident" id="6326055">_</span><span class="op" id="6326056">,</span>&nbsp;<span class="ident" id="6326058">err</span>&nbsp;<span class="op" id="6326062">=</span>&nbsp;<span class="ident" id="6326064">io</span><span class="op" id="6326066">.</span><span class="ident" id="6326067">ReadFull</span><span class="op" id="6326075">(</span><span class="ident" id="6326076">lzwr</span><span class="op" id="6326080">,</span>&nbsp;<span class="ident" id="6326082">m</span><span class="op" id="6326083">.</span><span class="ident" id="6326084">Pix</span><span class="op" id="6326087">)</span><span class="op" id="6326088">;</span>&nbsp;<span class="ident" id="6326090">err</span>&nbsp;<span class="op" id="6326094">!=</span>&nbsp;<span class="ident" id="6326097">nil</span>&nbsp;<span class="op" id="6326101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326107">if</span>&nbsp;<span class="ident" id="6326110">err</span>&nbsp;<span class="op" id="6326114">!=</span>&nbsp;<span class="ident" id="6326117">io</span><span class="op" id="6326119">.</span><span class="ident" id="6326120">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="6326137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326144">return</span>&nbsp;<span class="ident" id="6326151">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6326159">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326165">return</span>&nbsp;<span class="ident" id="6326172">errNotEnough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6326188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6326193">//&nbsp;Both&nbsp;lzwr&nbsp;and&nbsp;br&nbsp;should&nbsp;be&nbsp;exhausted.&nbsp;Reading&nbsp;from&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6326255">//&nbsp;should&nbsp;yield&nbsp;(0,&nbsp;io.EOF).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326287">if</span>&nbsp;<span class="ident" id="6326290">n</span><span class="op" id="6326291">,</span>&nbsp;<span class="ident" id="6326293">err</span>&nbsp;<span class="op" id="6326297">:=</span>&nbsp;<span class="ident" id="6326300">lzwr</span><span class="op" id="6326304">.</span><span class="ident" id="6326305">Read</span><span class="op" id="6326309">(</span><span class="ident" id="6326310">d</span><span class="op" id="6326311">.</span><span class="ident" id="6326312">tmp</span><span class="op" id="6326315">[</span><span class="op" id="6326316">:</span><span class="num" id="6326317">1</span><span class="op" id="6326318">]</span><span class="op" id="6326319">)</span><span class="op" id="6326320">;</span>&nbsp;<span class="ident" id="6326322">n</span>&nbsp;<span class="op" id="6326324">!=</span>&nbsp;<span class="num" id="6326327">0</span>&nbsp;<span class="op" id="6326329">||</span>&nbsp;<span class="ident" id="6326332">err</span>&nbsp;<span class="op" id="6326336">!=</span>&nbsp;<span class="ident" id="6326339">io</span><span class="op" id="6326341">.</span><span class="ident" id="6326342">EOF</span>&nbsp;<span class="op" id="6326346">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326352">if</span>&nbsp;<span class="ident" id="6326355">err</span>&nbsp;<span class="op" id="6326359">!=</span>&nbsp;<span class="ident" id="6326362">nil</span>&nbsp;<span class="op" id="6326366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326373">return</span>&nbsp;<span class="ident" id="6326380">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6326388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326394">return</span>&nbsp;<span class="ident" id="6326401">errTooMuch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6326415">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326420">if</span>&nbsp;<span class="ident" id="6326423">n</span><span class="op" id="6326424">,</span>&nbsp;<span class="ident" id="6326426">err</span>&nbsp;<span class="op" id="6326430">:=</span>&nbsp;<span class="ident" id="6326433">br</span><span class="op" id="6326435">.</span><span class="ident" id="6326436">Read</span><span class="op" id="6326440">(</span><span class="ident" id="6326441">d</span><span class="op" id="6326442">.</span><span class="ident" id="6326443">tmp</span><span class="op" id="6326446">[</span><span class="op" id="6326447">:</span><span class="num" id="6326448">1</span><span class="op" id="6326449">]</span><span class="op" id="6326450">)</span><span class="op" id="6326451">;</span>&nbsp;<span class="ident" id="6326453">n</span>&nbsp;<span class="op" id="6326455">!=</span>&nbsp;<span class="num" id="6326458">0</span>&nbsp;<span class="op" id="6326460">||</span>&nbsp;<span class="ident" id="6326463">err</span>&nbsp;<span class="op" id="6326467">!=</span>&nbsp;<span class="ident" id="6326470">io</span><span class="op" id="6326472">.</span><span class="ident" id="6326473">EOF</span>&nbsp;<span class="op" id="6326477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326483">if</span>&nbsp;<span class="ident" id="6326486">err</span>&nbsp;<span class="op" id="6326490">!=</span>&nbsp;<span class="ident" id="6326493">nil</span>&nbsp;<span class="op" id="6326497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326504">return</span>&nbsp;<span class="ident" id="6326511">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6326519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326525">return</span>&nbsp;<span class="ident" id="6326532">errTooMuch</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6326546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6326552">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;color&nbsp;indexes&nbsp;are&nbsp;inside&nbsp;the&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326611">if</span>&nbsp;<span class="builtinfunc" id="6326614">len</span><span class="op" id="6326617">(</span><span class="ident" id="6326618">m</span><span class="op" id="6326619">.</span><span class="ident" id="6326620">Palette</span><span class="op" id="6326627">)</span>&nbsp;<span class="op" id="6326629">&lt;</span>&nbsp;<span class="num" id="6326631">256</span>&nbsp;<span class="op" id="6326635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326641">for</span>&nbsp;<span class="ident" id="6326645">_</span><span class="op" id="6326646">,</span>&nbsp;<span class="ident" id="6326648">pixel</span>&nbsp;<span class="op" id="6326654">:=</span>&nbsp;<span class="keyword" id="6326657">range</span>&nbsp;<span class="ident" id="6326663">m</span><span class="op" id="6326664">.</span><span class="ident" id="6326665">Pix</span>&nbsp;<span class="op" id="6326669">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326676">if</span>&nbsp;<span class="builtintype" id="6326679">int</span><span class="op" id="6326682">(</span><span class="ident" id="6326683">pixel</span><span class="op" id="6326688">)</span>&nbsp;<span class="op" id="6326690">&gt;=</span>&nbsp;<span class="builtinfunc" id="6326693">len</span><span class="op" id="6326696">(</span><span class="ident" id="6326697">m</span><span class="op" id="6326698">.</span><span class="ident" id="6326699">Palette</span><span class="op" id="6326706">)</span>&nbsp;<span class="op" id="6326708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326716">return</span>&nbsp;<span class="ident" id="6326723">errBadPixel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6326740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6326746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6326751">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6326757">//&nbsp;Undo&nbsp;the&nbsp;interlacing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6326798">if</span>&nbsp;<span class="ident" id="6326801">d</span><span class="op" id="6326802">.</span><span class="ident" id="6326803">imageFields</span><span class="op" id="6326814">&amp;</span><span class="ident" id="6326815">ifInterlace</span>&nbsp;<span class="op" id="6326827">!=</span>&nbsp;<span class="num" id="6326830">0</span>&nbsp;<span class="op" id="6326832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6326838">uninterlace</span><span class="op" id="6326849">(</span><span class="ident" id="6326850">m</span><span class="op" id="6326851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6326856">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6326862">d</span><span class="op" id="6326863">.</span><span class="ident" id="6326864">image</span>&nbsp;<span class="op" id="6326870">=</span>&nbsp;<span class="builtinfunc" id="6326872">append</span><span class="op" id="6326878">(</span><span class="ident" id="6326879">d</span><span class="op" id="6326880">.</span><span class="ident" id="6326881">image</span><span class="op" id="6326886">,</span>&nbsp;<span class="ident" id="6326888">m</span><span class="op" id="6326889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6326894">d</span><span class="op" id="6326895">.</span><span class="ident" id="6326896">delay</span>&nbsp;<span class="op" id="6326902">=</span>&nbsp;<span class="builtinfunc" id="6326904">append</span><span class="op" id="6326910">(</span><span class="ident" id="6326911">d</span><span class="op" id="6326912">.</span><span class="ident" id="6326913">delay</span><span class="op" id="6326918">,</span>&nbsp;<span class="ident" id="6326920">d</span><span class="op" id="6326921">.</span><span class="ident" id="6326922">delayTime</span><span class="op" id="6326931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6326936">//&nbsp;The&nbsp;GIF89a&nbsp;spec,&nbsp;Section&nbsp;23&nbsp;(Graphic&nbsp;Control&nbsp;Extension)&nbsp;says:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6327004">//&nbsp;&#34;The&nbsp;scope&nbsp;of&nbsp;this&nbsp;extension&nbsp;is&nbsp;the&nbsp;first&nbsp;graphic&nbsp;rendering&nbsp;block</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6327076">//&nbsp;to&nbsp;follow.&#34;&nbsp;We&nbsp;therefore&nbsp;reset&nbsp;the&nbsp;GCE&nbsp;fields&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6327137">d</span><span class="op" id="6327138">.</span><span class="ident" id="6327139">delayTime</span>&nbsp;<span class="op" id="6327149">=</span>&nbsp;<span class="num" id="6327151">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6327156">d</span><span class="op" id="6327157">.</span><span class="ident" id="6327158">hasTransparentIndex</span>&nbsp;<span class="op" id="6327178">=</span>&nbsp;<span class="builtintype" id="6327180">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327189">case</span>&nbsp;<span class="ident" id="6327194">sTrailer</span><span class="op" id="6327202">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327207">if</span>&nbsp;<span class="builtinfunc" id="6327210">len</span><span class="op" id="6327213">(</span><span class="ident" id="6327214">d</span><span class="op" id="6327215">.</span><span class="ident" id="6327216">image</span><span class="op" id="6327221">)</span>&nbsp;<span class="op" id="6327223">==</span>&nbsp;<span class="num" id="6327226">0</span>&nbsp;<span class="op" id="6327228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327234">return</span>&nbsp;<span class="ident" id="6327241">io</span><span class="op" id="6327243">.</span><span class="ident" id="6327244">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6327264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327269">return</span>&nbsp;<span class="ident" id="6327276">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327283">default</span><span class="op" id="6327290">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327295">return</span>&nbsp;<span class="ident" id="6327302">fmt</span><span class="op" id="6327305">.</span><span class="ident" id="6327306">Errorf</span><span class="op" id="6327312">(</span><span class="string" id="6327313">&#34;gif:&nbsp;unknown&nbsp;block&nbsp;type:&nbsp;0x%.2x&#34;</span><span class="op" id="6327346">,</span>&nbsp;<span class="ident" id="6327348">c</span><span class="op" id="6327349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6327353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6327356">}</span><br>
<span class="lineno"></span><span class="op" id="6327358">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6327361">func</span>&nbsp;<span class="op" id="6327366">(</span><span class="ident" id="6327367">d</span>&nbsp;<span class="op" id="6327369">*</span><span class="ident" id="6327370">decoder</span><span class="op" id="6327377">)</span>&nbsp;<span class="ident" id="6327379">readHeaderAndScreenDescriptor</span><span class="op" id="6327408">(</span><span class="op" id="6327409">)</span>&nbsp;<span class="builtintype" id="6327411">error</span>&nbsp;<span class="op" id="6327417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6327420">_</span><span class="op" id="6327421">,</span>&nbsp;<span class="ident" id="6327423">err</span>&nbsp;<span class="op" id="6327427">:=</span>&nbsp;<span class="ident" id="6327430">io</span><span class="op" id="6327432">.</span><span class="ident" id="6327433">ReadFull</span><span class="op" id="6327441">(</span><span class="ident" id="6327442">d</span><span class="op" id="6327443">.</span><span class="ident" id="6327444">r</span><span class="op" id="6327445">,</span>&nbsp;<span class="ident" id="6327447">d</span><span class="op" id="6327448">.</span><span class="ident" id="6327449">tmp</span><span class="op" id="6327452">[</span><span class="num" id="6327453">0</span><span class="op" id="6327454">:</span><span class="num" id="6327455">13</span><span class="op" id="6327457">]</span><span class="op" id="6327458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327461">if</span>&nbsp;<span class="ident" id="6327464">err</span>&nbsp;<span class="op" id="6327468">!=</span>&nbsp;<span class="ident" id="6327471">nil</span>&nbsp;<span class="op" id="6327475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327479">return</span>&nbsp;<span class="ident" id="6327486">err</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6327491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6327494">d</span><span class="op" id="6327495">.</span><span class="ident" id="6327496">vers</span>&nbsp;<span class="op" id="6327501">=</span>&nbsp;<span class="builtintype" id="6327503">string</span><span class="op" id="6327509">(</span><span class="ident" id="6327510">d</span><span class="op" id="6327511">.</span><span class="ident" id="6327512">tmp</span><span class="op" id="6327515">[</span><span class="num" id="6327516">0</span><span class="op" id="6327517">:</span><span class="num" id="6327518">6</span><span class="op" id="6327519">]</span><span class="op" id="6327520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327523">if</span>&nbsp;<span class="ident" id="6327526">d</span><span class="op" id="6327527">.</span><span class="ident" id="6327528">vers</span>&nbsp;<span class="op" id="6327533">!=</span>&nbsp;<span class="string" id="6327536">&#34;GIF87a&#34;</span>&nbsp;<span class="op" id="6327545">&amp;&amp;</span>&nbsp;<span class="ident" id="6327548">d</span><span class="op" id="6327549">.</span><span class="ident" id="6327550">vers</span>&nbsp;<span class="op" id="6327555">!=</span>&nbsp;<span class="string" id="6327558">&#34;GIF89a&#34;</span>&nbsp;<span class="op" id="6327567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327571">return</span>&nbsp;<span class="ident" id="6327578">fmt</span><span class="op" id="6327581">.</span><span class="ident" id="6327582">Errorf</span><span class="op" id="6327588">(</span><span class="string" id="6327589">&#34;gif:&nbsp;can&#39;t&nbsp;recognize&nbsp;format&nbsp;%s&#34;</span><span class="op" id="6327621">,</span>&nbsp;<span class="ident" id="6327623">d</span><span class="op" id="6327624">.</span><span class="ident" id="6327625">vers</span><span class="op" id="6327629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6327632">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6327635">d</span><span class="op" id="6327636">.</span><span class="ident" id="6327637">width</span>&nbsp;<span class="op" id="6327643">=</span>&nbsp;<span class="builtintype" id="6327645">int</span><span class="op" id="6327648">(</span><span class="ident" id="6327649">d</span><span class="op" id="6327650">.</span><span class="ident" id="6327651">tmp</span><span class="op" id="6327654">[</span><span class="num" id="6327655">6</span><span class="op" id="6327656">]</span><span class="op" id="6327657">)</span>&nbsp;<span class="op" id="6327659">+</span>&nbsp;<span class="builtintype" id="6327661">int</span><span class="op" id="6327664">(</span><span class="ident" id="6327665">d</span><span class="op" id="6327666">.</span><span class="ident" id="6327667">tmp</span><span class="op" id="6327670">[</span><span class="num" id="6327671">7</span><span class="op" id="6327672">]</span><span class="op" id="6327673">)</span><span class="op" id="6327674">&lt;&lt;</span><span class="num" id="6327676">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6327679">d</span><span class="op" id="6327680">.</span><span class="ident" id="6327681">height</span>&nbsp;<span class="op" id="6327688">=</span>&nbsp;<span class="builtintype" id="6327690">int</span><span class="op" id="6327693">(</span><span class="ident" id="6327694">d</span><span class="op" id="6327695">.</span><span class="ident" id="6327696">tmp</span><span class="op" id="6327699">[</span><span class="num" id="6327700">8</span><span class="op" id="6327701">]</span><span class="op" id="6327702">)</span>&nbsp;<span class="op" id="6327704">+</span>&nbsp;<span class="builtintype" id="6327706">int</span><span class="op" id="6327709">(</span><span class="ident" id="6327710">d</span><span class="op" id="6327711">.</span><span class="ident" id="6327712">tmp</span><span class="op" id="6327715">[</span><span class="num" id="6327716">9</span><span class="op" id="6327717">]</span><span class="op" id="6327718">)</span><span class="op" id="6327719">&lt;&lt;</span><span class="num" id="6327721">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6327724">d</span><span class="op" id="6327725">.</span><span class="ident" id="6327726">headerFields</span>&nbsp;<span class="op" id="6327739">=</span>&nbsp;<span class="ident" id="6327741">d</span><span class="op" id="6327742">.</span><span class="ident" id="6327743">tmp</span><span class="op" id="6327746">[</span><span class="num" id="6327747">10</span><span class="op" id="6327749">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6327752">d</span><span class="op" id="6327753">.</span><span class="ident" id="6327754">backgroundIndex</span>&nbsp;<span class="op" id="6327770">=</span>&nbsp;<span class="ident" id="6327772">d</span><span class="op" id="6327773">.</span><span class="ident" id="6327774">tmp</span><span class="op" id="6327777">[</span><span class="num" id="6327778">11</span><span class="op" id="6327780">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6327783">d</span><span class="op" id="6327784">.</span><span class="ident" id="6327785">aspect</span>&nbsp;<span class="op" id="6327792">=</span>&nbsp;<span class="ident" id="6327794">d</span><span class="op" id="6327795">.</span><span class="ident" id="6327796">tmp</span><span class="op" id="6327799">[</span><span class="num" id="6327800">12</span><span class="op" id="6327802">]</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6327805">d</span><span class="op" id="6327806">.</span><span class="ident" id="6327807">loopCount</span>&nbsp;<span class="op" id="6327817">=</span>&nbsp;<span class="op" id="6327819">-</span><span class="num" id="6327820">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6327823">d</span><span class="op" id="6327824">.</span><span class="ident" id="6327825">pixelSize</span>&nbsp;<span class="op" id="6327835">=</span>&nbsp;<span class="builtintype" id="6327837">uint</span><span class="op" id="6327841">(</span><span class="ident" id="6327842">d</span><span class="op" id="6327843">.</span><span class="ident" id="6327844">headerFields</span><span class="op" id="6327856">&amp;</span><span class="num" id="6327857">7</span><span class="op" id="6327858">)</span>&nbsp;<span class="op" id="6327860">+</span>&nbsp;<span class="num" id="6327862">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327865">return</span>&nbsp;<span class="ident" id="6327872">nil</span><br>
<span class="lineno"></span><span class="op" id="6327876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="6327879">func</span>&nbsp;<span class="op" id="6327884">(</span><span class="ident" id="6327885">d</span>&nbsp;<span class="op" id="6327887">*</span><span class="ident" id="6327888">decoder</span><span class="op" id="6327895">)</span>&nbsp;<span class="ident" id="6327897">readColorMap</span><span class="op" id="6327909">(</span><span class="op" id="6327910">)</span>&nbsp;<span class="op" id="6327912">(</span><span class="ident" id="6327913">color</span><span class="op" id="6327918">.</span><span class="ident" id="6327919">Palette</span><span class="op" id="6327926">,</span>&nbsp;<span class="builtintype" id="6327928">error</span><span class="op" id="6327933">)</span>&nbsp;<span class="op" id="6327935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327938">if</span>&nbsp;<span class="ident" id="6327941">d</span><span class="op" id="6327942">.</span><span class="ident" id="6327943">pixelSize</span>&nbsp;<span class="op" id="6327953">&gt;</span>&nbsp;<span class="num" id="6327955">8</span>&nbsp;<span class="op" id="6327957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6327961">return</span>&nbsp;<span class="ident" id="6327968">nil</span><span class="op" id="6327971">,</span>&nbsp;<span class="ident" id="6327973">fmt</span><span class="op" id="6327976">.</span><span class="ident" id="6327977">Errorf</span><span class="op" id="6327983">(</span><span class="string" id="6327984">&#34;gif:&nbsp;can&#39;t&nbsp;handle&nbsp;%d&nbsp;bits&nbsp;per&nbsp;pixel&#34;</span><span class="op" id="6328021">,</span>&nbsp;<span class="ident" id="6328023">d</span><span class="op" id="6328024">.</span><span class="ident" id="6328025">pixelSize</span><span class="op" id="6328034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6328037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328040">numColors</span>&nbsp;<span class="op" id="6328050">:=</span>&nbsp;<span class="num" id="6328053">1</span>&nbsp;<span class="op" id="6328055">&lt;&lt;</span>&nbsp;<span class="ident" id="6328058">d</span><span class="op" id="6328059">.</span><span class="ident" id="6328060">pixelSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328071">if</span>&nbsp;<span class="ident" id="6328074">d</span><span class="op" id="6328075">.</span><span class="ident" id="6328076">imageFields</span><span class="op" id="6328087">&amp;</span><span class="ident" id="6328088">ifLocalColorTable</span>&nbsp;<span class="op" id="6328106">!=</span>&nbsp;<span class="num" id="6328109">0</span>&nbsp;<span class="op" id="6328111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328115">numColors</span>&nbsp;<span class="op" id="6328125">=</span>&nbsp;<span class="num" id="6328127">1</span>&nbsp;<span class="op" id="6328129">&lt;&lt;</span>&nbsp;<span class="op" id="6328132">(</span><span class="op" id="6328133">(</span><span class="ident" id="6328134">d</span><span class="op" id="6328135">.</span><span class="ident" id="6328136">imageFields</span>&nbsp;<span class="op" id="6328148">&amp;</span>&nbsp;<span class="ident" id="6328150">ifPixelSizeMask</span><span class="op" id="6328165">)</span>&nbsp;<span class="op" id="6328167">+</span>&nbsp;<span class="num" id="6328169">1</span><span class="op" id="6328170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6328173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328176">numValues</span>&nbsp;<span class="op" id="6328186">:=</span>&nbsp;<span class="num" id="6328189">3</span>&nbsp;<span class="op" id="6328191">*</span>&nbsp;<span class="ident" id="6328193">numColors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328204">_</span><span class="op" id="6328205">,</span>&nbsp;<span class="ident" id="6328207">err</span>&nbsp;<span class="op" id="6328211">:=</span>&nbsp;<span class="ident" id="6328214">io</span><span class="op" id="6328216">.</span><span class="ident" id="6328217">ReadFull</span><span class="op" id="6328225">(</span><span class="ident" id="6328226">d</span><span class="op" id="6328227">.</span><span class="ident" id="6328228">r</span><span class="op" id="6328229">,</span>&nbsp;<span class="ident" id="6328231">d</span><span class="op" id="6328232">.</span><span class="ident" id="6328233">tmp</span><span class="op" id="6328236">[</span><span class="num" id="6328237">0</span><span class="op" id="6328238">:</span><span class="ident" id="6328239">numValues</span><span class="op" id="6328248">]</span><span class="op" id="6328249">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328252">if</span>&nbsp;<span class="ident" id="6328255">err</span>&nbsp;<span class="op" id="6328259">!=</span>&nbsp;<span class="ident" id="6328262">nil</span>&nbsp;<span class="op" id="6328266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328270">return</span>&nbsp;<span class="ident" id="6328277">nil</span><span class="op" id="6328280">,</span>&nbsp;<span class="ident" id="6328282">fmt</span><span class="op" id="6328285">.</span><span class="ident" id="6328286">Errorf</span><span class="op" id="6328292">(</span><span class="string" id="6328293">&#34;gif:&nbsp;short&nbsp;read&nbsp;on&nbsp;color&nbsp;map:&nbsp;%s&#34;</span><span class="op" id="6328327">,</span>&nbsp;<span class="ident" id="6328329">err</span><span class="op" id="6328332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6328335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328338">colorMap</span>&nbsp;<span class="op" id="6328347">:=</span>&nbsp;<span class="builtinfunc" id="6328350">make</span><span class="op" id="6328354">(</span><span class="ident" id="6328355">color</span><span class="op" id="6328360">.</span><span class="ident" id="6328361">Palette</span><span class="op" id="6328368">,</span>&nbsp;<span class="ident" id="6328370">numColors</span><span class="op" id="6328379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328382">j</span>&nbsp;<span class="op" id="6328384">:=</span>&nbsp;<span class="num" id="6328387">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328390">for</span>&nbsp;<span class="ident" id="6328394">i</span>&nbsp;<span class="op" id="6328396">:=</span>&nbsp;<span class="keyword" id="6328399">range</span>&nbsp;<span class="ident" id="6328405">colorMap</span>&nbsp;<span class="op" id="6328414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328418">colorMap</span><span class="op" id="6328426">[</span><span class="ident" id="6328427">i</span><span class="op" id="6328428">]</span>&nbsp;<span class="op" id="6328430">=</span>&nbsp;<span class="ident" id="6328432">color</span><span class="op" id="6328437">.</span><span class="ident" id="6328438">RGBA</span><span class="op" id="6328442">{</span><span class="ident" id="6328443">d</span><span class="op" id="6328444">.</span><span class="ident" id="6328445">tmp</span><span class="op" id="6328448">[</span><span class="ident" id="6328449">j</span><span class="op" id="6328450">+</span><span class="num" id="6328451">0</span><span class="op" id="6328452">]</span><span class="op" id="6328453">,</span>&nbsp;<span class="ident" id="6328455">d</span><span class="op" id="6328456">.</span><span class="ident" id="6328457">tmp</span><span class="op" id="6328460">[</span><span class="ident" id="6328461">j</span><span class="op" id="6328462">+</span><span class="num" id="6328463">1</span><span class="op" id="6328464">]</span><span class="op" id="6328465">,</span>&nbsp;<span class="ident" id="6328467">d</span><span class="op" id="6328468">.</span><span class="ident" id="6328469">tmp</span><span class="op" id="6328472">[</span><span class="ident" id="6328473">j</span><span class="op" id="6328474">+</span><span class="num" id="6328475">2</span><span class="op" id="6328476">]</span><span class="op" id="6328477">,</span>&nbsp;<span class="num" id="6328479">0xFF</span><span class="op" id="6328483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328487">j</span>&nbsp;<span class="op" id="6328489">+=</span>&nbsp;<span class="num" id="6328492">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6328495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328498">return</span>&nbsp;<span class="ident" id="6328505">colorMap</span><span class="op" id="6328513">,</span>&nbsp;<span class="ident" id="6328515">nil</span><br>
<span class="lineno">295</span><span class="op" id="6328519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6328522">func</span>&nbsp;<span class="op" id="6328527">(</span><span class="ident" id="6328528">d</span>&nbsp;<span class="op" id="6328530">*</span><span class="ident" id="6328531">decoder</span><span class="op" id="6328538">)</span>&nbsp;<span class="ident" id="6328540">readExtension</span><span class="op" id="6328553">(</span><span class="op" id="6328554">)</span>&nbsp;<span class="builtintype" id="6328556">error</span>&nbsp;<span class="op" id="6328562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328565">extension</span><span class="op" id="6328574">,</span>&nbsp;<span class="ident" id="6328576">err</span>&nbsp;<span class="op" id="6328580">:=</span>&nbsp;<span class="ident" id="6328583">d</span><span class="op" id="6328584">.</span><span class="ident" id="6328585">r</span><span class="op" id="6328586">.</span><span class="ident" id="6328587">ReadByte</span><span class="op" id="6328595">(</span><span class="op" id="6328596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328599">if</span>&nbsp;<span class="ident" id="6328602">err</span>&nbsp;<span class="op" id="6328606">!=</span>&nbsp;<span class="ident" id="6328609">nil</span>&nbsp;<span class="op" id="6328613">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328617">return</span>&nbsp;<span class="ident" id="6328624">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6328629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328632">size</span>&nbsp;<span class="op" id="6328637">:=</span>&nbsp;<span class="num" id="6328640">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328643">switch</span>&nbsp;<span class="ident" id="6328650">extension</span>&nbsp;<span class="op" id="6328660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328663">case</span>&nbsp;<span class="ident" id="6328668">eText</span><span class="op" id="6328673">:</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328677">size</span>&nbsp;<span class="op" id="6328682">=</span>&nbsp;<span class="num" id="6328684">13</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328688">case</span>&nbsp;<span class="ident" id="6328693">eGraphicControl</span><span class="op" id="6328708">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328712">return</span>&nbsp;<span class="ident" id="6328719">d</span><span class="op" id="6328720">.</span><span class="ident" id="6328721">readGraphicControl</span><span class="op" id="6328739">(</span><span class="op" id="6328740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328743">case</span>&nbsp;<span class="ident" id="6328748">eComment</span><span class="op" id="6328756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6328760">//&nbsp;nothing&nbsp;to&nbsp;do&nbsp;but&nbsp;read&nbsp;the&nbsp;data.</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328797">case</span>&nbsp;<span class="ident" id="6328802">eApplication</span><span class="op" id="6328814">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328818">b</span><span class="op" id="6328819">,</span>&nbsp;<span class="ident" id="6328821">err</span>&nbsp;<span class="op" id="6328825">:=</span>&nbsp;<span class="ident" id="6328828">d</span><span class="op" id="6328829">.</span><span class="ident" id="6328830">r</span><span class="op" id="6328831">.</span><span class="ident" id="6328832">ReadByte</span><span class="op" id="6328840">(</span><span class="op" id="6328841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328845">if</span>&nbsp;<span class="ident" id="6328848">err</span>&nbsp;<span class="op" id="6328852">!=</span>&nbsp;<span class="ident" id="6328855">nil</span>&nbsp;<span class="op" id="6328859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328864">return</span>&nbsp;<span class="ident" id="6328871">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6328877">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6328881">//&nbsp;The&nbsp;spec&nbsp;requires&nbsp;size&nbsp;be&nbsp;11,&nbsp;but&nbsp;Adobe&nbsp;sometimes&nbsp;uses&nbsp;10.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6328945">size</span>&nbsp;<span class="op" id="6328950">=</span>&nbsp;<span class="builtintype" id="6328952">int</span><span class="op" id="6328955">(</span><span class="ident" id="6328956">b</span><span class="op" id="6328957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328960">default</span><span class="op" id="6328967">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6328971">return</span>&nbsp;<span class="ident" id="6328978">fmt</span><span class="op" id="6328981">.</span><span class="ident" id="6328982">Errorf</span><span class="op" id="6328988">(</span><span class="string" id="6328989">&#34;gif:&nbsp;unknown&nbsp;extension&nbsp;0x%.2x&#34;</span><span class="op" id="6329020">,</span>&nbsp;<span class="ident" id="6329022">extension</span><span class="op" id="6329031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6329034">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329037">if</span>&nbsp;<span class="ident" id="6329040">size</span>&nbsp;<span class="op" id="6329045">&gt;</span>&nbsp;<span class="num" id="6329047">0</span>&nbsp;<span class="op" id="6329049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329053">if</span>&nbsp;<span class="ident" id="6329056">_</span><span class="op" id="6329057">,</span>&nbsp;<span class="ident" id="6329059">err</span>&nbsp;<span class="op" id="6329063">:=</span>&nbsp;<span class="ident" id="6329066">io</span><span class="op" id="6329068">.</span><span class="ident" id="6329069">ReadFull</span><span class="op" id="6329077">(</span><span class="ident" id="6329078">d</span><span class="op" id="6329079">.</span><span class="ident" id="6329080">r</span><span class="op" id="6329081">,</span>&nbsp;<span class="ident" id="6329083">d</span><span class="op" id="6329084">.</span><span class="ident" id="6329085">tmp</span><span class="op" id="6329088">[</span><span class="num" id="6329089">0</span><span class="op" id="6329090">:</span><span class="ident" id="6329091">size</span><span class="op" id="6329095">]</span><span class="op" id="6329096">)</span><span class="op" id="6329097">;</span>&nbsp;<span class="ident" id="6329099">err</span>&nbsp;<span class="op" id="6329103">!=</span>&nbsp;<span class="ident" id="6329106">nil</span>&nbsp;<span class="op" id="6329110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329115">return</span>&nbsp;<span class="ident" id="6329122">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6329128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6329131">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6329135">//&nbsp;Application&nbsp;Extension&nbsp;with&nbsp;&#34;NETSCAPE2.0&#34;&nbsp;as&nbsp;string&nbsp;and&nbsp;1&nbsp;in&nbsp;data&nbsp;means</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6329210">//&nbsp;this&nbsp;extension&nbsp;defines&nbsp;a&nbsp;loop&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329251">if</span>&nbsp;<span class="ident" id="6329254">extension</span>&nbsp;<span class="op" id="6329264">==</span>&nbsp;<span class="ident" id="6329267">eApplication</span>&nbsp;<span class="op" id="6329280">&amp;&amp;</span>&nbsp;<span class="builtintype" id="6329283">string</span><span class="op" id="6329289">(</span><span class="ident" id="6329290">d</span><span class="op" id="6329291">.</span><span class="ident" id="6329292">tmp</span><span class="op" id="6329295">[</span><span class="op" id="6329296">:</span><span class="ident" id="6329297">size</span><span class="op" id="6329301">]</span><span class="op" id="6329302">)</span>&nbsp;<span class="op" id="6329304">==</span>&nbsp;<span class="string" id="6329307">&#34;NETSCAPE2.0&#34;</span>&nbsp;<span class="op" id="6329321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6329325">n</span><span class="op" id="6329326">,</span>&nbsp;<span class="ident" id="6329328">err</span>&nbsp;<span class="op" id="6329332">:=</span>&nbsp;<span class="ident" id="6329335">d</span><span class="op" id="6329336">.</span><span class="ident" id="6329337">readBlock</span><span class="op" id="6329346">(</span><span class="op" id="6329347">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329351">if</span>&nbsp;<span class="ident" id="6329354">n</span>&nbsp;<span class="op" id="6329356">==</span>&nbsp;<span class="num" id="6329359">0</span>&nbsp;<span class="op" id="6329361">||</span>&nbsp;<span class="ident" id="6329364">err</span>&nbsp;<span class="op" id="6329368">!=</span>&nbsp;<span class="ident" id="6329371">nil</span>&nbsp;<span class="op" id="6329375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329380">return</span>&nbsp;<span class="ident" id="6329387">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6329393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329397">if</span>&nbsp;<span class="ident" id="6329400">n</span>&nbsp;<span class="op" id="6329402">==</span>&nbsp;<span class="num" id="6329405">3</span>&nbsp;<span class="op" id="6329407">&amp;&amp;</span>&nbsp;<span class="ident" id="6329410">d</span><span class="op" id="6329411">.</span><span class="ident" id="6329412">tmp</span><span class="op" id="6329415">[</span><span class="num" id="6329416">0</span><span class="op" id="6329417">]</span>&nbsp;<span class="op" id="6329419">==</span>&nbsp;<span class="num" id="6329422">1</span>&nbsp;<span class="op" id="6329424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6329429">d</span><span class="op" id="6329430">.</span><span class="ident" id="6329431">loopCount</span>&nbsp;<span class="op" id="6329441">=</span>&nbsp;<span class="builtintype" id="6329443">int</span><span class="op" id="6329446">(</span><span class="ident" id="6329447">d</span><span class="op" id="6329448">.</span><span class="ident" id="6329449">tmp</span><span class="op" id="6329452">[</span><span class="num" id="6329453">1</span><span class="op" id="6329454">]</span><span class="op" id="6329455">)</span>&nbsp;<span class="op" id="6329457">|</span>&nbsp;<span class="builtintype" id="6329459">int</span><span class="op" id="6329462">(</span><span class="ident" id="6329463">d</span><span class="op" id="6329464">.</span><span class="ident" id="6329465">tmp</span><span class="op" id="6329468">[</span><span class="num" id="6329469">2</span><span class="op" id="6329470">]</span><span class="op" id="6329471">)</span><span class="op" id="6329472">&lt;&lt;</span><span class="num" id="6329474">8</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6329478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6329481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329484">for</span>&nbsp;<span class="op" id="6329488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6329492">n</span><span class="op" id="6329493">,</span>&nbsp;<span class="ident" id="6329495">err</span>&nbsp;<span class="op" id="6329499">:=</span>&nbsp;<span class="ident" id="6329502">d</span><span class="op" id="6329503">.</span><span class="ident" id="6329504">readBlock</span><span class="op" id="6329513">(</span><span class="op" id="6329514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329518">if</span>&nbsp;<span class="ident" id="6329521">n</span>&nbsp;<span class="op" id="6329523">==</span>&nbsp;<span class="num" id="6329526">0</span>&nbsp;<span class="op" id="6329528">||</span>&nbsp;<span class="ident" id="6329531">err</span>&nbsp;<span class="op" id="6329535">!=</span>&nbsp;<span class="ident" id="6329538">nil</span>&nbsp;<span class="op" id="6329542">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329547">return</span>&nbsp;<span class="ident" id="6329554">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6329560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6329563">}</span><br>
<span class="lineno"></span><span class="op" id="6329565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="keyword" id="6329568">func</span>&nbsp;<span class="op" id="6329573">(</span><span class="ident" id="6329574">d</span>&nbsp;<span class="op" id="6329576">*</span><span class="ident" id="6329577">decoder</span><span class="op" id="6329584">)</span>&nbsp;<span class="ident" id="6329586">readGraphicControl</span><span class="op" id="6329604">(</span><span class="op" id="6329605">)</span>&nbsp;<span class="builtintype" id="6329607">error</span>&nbsp;<span class="op" id="6329613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329616">if</span>&nbsp;<span class="ident" id="6329619">_</span><span class="op" id="6329620">,</span>&nbsp;<span class="ident" id="6329622">err</span>&nbsp;<span class="op" id="6329626">:=</span>&nbsp;<span class="ident" id="6329629">io</span><span class="op" id="6329631">.</span><span class="ident" id="6329632">ReadFull</span><span class="op" id="6329640">(</span><span class="ident" id="6329641">d</span><span class="op" id="6329642">.</span><span class="ident" id="6329643">r</span><span class="op" id="6329644">,</span>&nbsp;<span class="ident" id="6329646">d</span><span class="op" id="6329647">.</span><span class="ident" id="6329648">tmp</span><span class="op" id="6329651">[</span><span class="num" id="6329652">0</span><span class="op" id="6329653">:</span><span class="num" id="6329654">6</span><span class="op" id="6329655">]</span><span class="op" id="6329656">)</span><span class="op" id="6329657">;</span>&nbsp;<span class="ident" id="6329659">err</span>&nbsp;<span class="op" id="6329663">!=</span>&nbsp;<span class="ident" id="6329666">nil</span>&nbsp;<span class="op" id="6329670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329674">return</span>&nbsp;<span class="ident" id="6329681">fmt</span><span class="op" id="6329684">.</span><span class="ident" id="6329685">Errorf</span><span class="op" id="6329691">(</span><span class="string" id="6329692">&#34;gif:&nbsp;can&#39;t&nbsp;read&nbsp;graphic&nbsp;control:&nbsp;%s&#34;</span><span class="op" id="6329729">,</span>&nbsp;<span class="ident" id="6329731">err</span><span class="op" id="6329734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6329737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6329740">d</span><span class="op" id="6329741">.</span><span class="ident" id="6329742">flags</span>&nbsp;<span class="op" id="6329748">=</span>&nbsp;<span class="ident" id="6329750">d</span><span class="op" id="6329751">.</span><span class="ident" id="6329752">tmp</span><span class="op" id="6329755">[</span><span class="num" id="6329756">1</span><span class="op" id="6329757">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6329760">d</span><span class="op" id="6329761">.</span><span class="ident" id="6329762">delayTime</span>&nbsp;<span class="op" id="6329772">=</span>&nbsp;<span class="builtintype" id="6329774">int</span><span class="op" id="6329777">(</span><span class="ident" id="6329778">d</span><span class="op" id="6329779">.</span><span class="ident" id="6329780">tmp</span><span class="op" id="6329783">[</span><span class="num" id="6329784">2</span><span class="op" id="6329785">]</span><span class="op" id="6329786">)</span>&nbsp;<span class="op" id="6329788">|</span>&nbsp;<span class="builtintype" id="6329790">int</span><span class="op" id="6329793">(</span><span class="ident" id="6329794">d</span><span class="op" id="6329795">.</span><span class="ident" id="6329796">tmp</span><span class="op" id="6329799">[</span><span class="num" id="6329800">3</span><span class="op" id="6329801">]</span><span class="op" id="6329802">)</span><span class="op" id="6329803">&lt;&lt;</span><span class="num" id="6329805">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329808">if</span>&nbsp;<span class="ident" id="6329811">d</span><span class="op" id="6329812">.</span><span class="ident" id="6329813">flags</span><span class="op" id="6329818">&amp;</span><span class="ident" id="6329819">gcTransparentColorSet</span>&nbsp;<span class="op" id="6329841">!=</span>&nbsp;<span class="num" id="6329844">0</span>&nbsp;<span class="op" id="6329846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6329850">d</span><span class="op" id="6329851">.</span><span class="ident" id="6329852">transparentIndex</span>&nbsp;<span class="op" id="6329869">=</span>&nbsp;<span class="ident" id="6329871">d</span><span class="op" id="6329872">.</span><span class="ident" id="6329873">tmp</span><span class="op" id="6329876">[</span><span class="num" id="6329877">4</span><span class="op" id="6329878">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6329882">d</span><span class="op" id="6329883">.</span><span class="ident" id="6329884">hasTransparentIndex</span>&nbsp;<span class="op" id="6329904">=</span>&nbsp;<span class="builtintype" id="6329906">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6329912">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6329915">return</span>&nbsp;<span class="ident" id="6329922">nil</span><br>
<span class="lineno"></span><span class="op" id="6329926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6329929">func</span>&nbsp;<span class="op" id="6329934">(</span><span class="ident" id="6329935">d</span>&nbsp;<span class="op" id="6329937">*</span><span class="ident" id="6329938">decoder</span><span class="op" id="6329945">)</span>&nbsp;<span class="ident" id="6329947">newImageFromDescriptor</span><span class="op" id="6329969">(</span><span class="op" id="6329970">)</span>&nbsp;<span class="op" id="6329972">(</span><span class="op" id="6329973">*</span><span class="ident" id="6329974">image</span><span class="op" id="6329979">.</span><span class="ident" id="6329980">Paletted</span><span class="op" id="6329988">,</span>&nbsp;<span class="builtintype" id="6329990">error</span><span class="op" id="6329995">)</span>&nbsp;<span class="op" id="6329997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6330000">if</span>&nbsp;<span class="ident" id="6330003">_</span><span class="op" id="6330004">,</span>&nbsp;<span class="ident" id="6330006">err</span>&nbsp;<span class="op" id="6330010">:=</span>&nbsp;<span class="ident" id="6330013">io</span><span class="op" id="6330015">.</span><span class="ident" id="6330016">ReadFull</span><span class="op" id="6330024">(</span><span class="ident" id="6330025">d</span><span class="op" id="6330026">.</span><span class="ident" id="6330027">r</span><span class="op" id="6330028">,</span>&nbsp;<span class="ident" id="6330030">d</span><span class="op" id="6330031">.</span><span class="ident" id="6330032">tmp</span><span class="op" id="6330035">[</span><span class="num" id="6330036">0</span><span class="op" id="6330037">:</span><span class="num" id="6330038">9</span><span class="op" id="6330039">]</span><span class="op" id="6330040">)</span><span class="op" id="6330041">;</span>&nbsp;<span class="ident" id="6330043">err</span>&nbsp;<span class="op" id="6330047">!=</span>&nbsp;<span class="ident" id="6330050">nil</span>&nbsp;<span class="op" id="6330054">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6330058">return</span>&nbsp;<span class="ident" id="6330065">nil</span><span class="op" id="6330068">,</span>&nbsp;<span class="ident" id="6330070">fmt</span><span class="op" id="6330073">.</span><span class="ident" id="6330074">Errorf</span><span class="op" id="6330080">(</span><span class="string" id="6330081">&#34;gif:&nbsp;can&#39;t&nbsp;read&nbsp;image&nbsp;descriptor:&nbsp;%s&#34;</span><span class="op" id="6330119">,</span>&nbsp;<span class="ident" id="6330121">err</span><span class="op" id="6330124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6330127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6330130">left</span>&nbsp;<span class="op" id="6330135">:=</span>&nbsp;<span class="builtintype" id="6330138">int</span><span class="op" id="6330141">(</span><span class="ident" id="6330142">d</span><span class="op" id="6330143">.</span><span class="ident" id="6330144">tmp</span><span class="op" id="6330147">[</span><span class="num" id="6330148">0</span><span class="op" id="6330149">]</span><span class="op" id="6330150">)</span>&nbsp;<span class="op" id="6330152">+</span>&nbsp;<span class="builtintype" id="6330154">int</span><span class="op" id="6330157">(</span><span class="ident" id="6330158">d</span><span class="op" id="6330159">.</span><span class="ident" id="6330160">tmp</span><span class="op" id="6330163">[</span><span class="num" id="6330164">1</span><span class="op" id="6330165">]</span><span class="op" id="6330166">)</span><span class="op" id="6330167">&lt;&lt;</span><span class="num" id="6330169">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6330172">top</span>&nbsp;<span class="op" id="6330176">:=</span>&nbsp;<span class="builtintype" id="6330179">int</span><span class="op" id="6330182">(</span><span class="ident" id="6330183">d</span><span class="op" id="6330184">.</span><span class="ident" id="6330185">tmp</span><span class="op" id="6330188">[</span><span class="num" id="6330189">2</span><span class="op" id="6330190">]</span><span class="op" id="6330191">)</span>&nbsp;<span class="op" id="6330193">+</span>&nbsp;<span class="builtintype" id="6330195">int</span><span class="op" id="6330198">(</span><span class="ident" id="6330199">d</span><span class="op" id="6330200">.</span><span class="ident" id="6330201">tmp</span><span class="op" id="6330204">[</span><span class="num" id="6330205">3</span><span class="op" id="6330206">]</span><span class="op" id="6330207">)</span><span class="op" id="6330208">&lt;&lt;</span><span class="num" id="6330210">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6330213">width</span>&nbsp;<span class="op" id="6330219">:=</span>&nbsp;<span class="builtintype" id="6330222">int</span><span class="op" id="6330225">(</span><span class="ident" id="6330226">d</span><span class="op" id="6330227">.</span><span class="ident" id="6330228">tmp</span><span class="op" id="6330231">[</span><span class="num" id="6330232">4</span><span class="op" id="6330233">]</span><span class="op" id="6330234">)</span>&nbsp;<span class="op" id="6330236">+</span>&nbsp;<span class="builtintype" id="6330238">int</span><span class="op" id="6330241">(</span><span class="ident" id="6330242">d</span><span class="op" id="6330243">.</span><span class="ident" id="6330244">tmp</span><span class="op" id="6330247">[</span><span class="num" id="6330248">5</span><span class="op" id="6330249">]</span><span class="op" id="6330250">)</span><span class="op" id="6330251">&lt;&lt;</span><span class="num" id="6330253">8</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6330256">height</span>&nbsp;<span class="op" id="6330263">:=</span>&nbsp;<span class="builtintype" id="6330266">int</span><span class="op" id="6330269">(</span><span class="ident" id="6330270">d</span><span class="op" id="6330271">.</span><span class="ident" id="6330272">tmp</span><span class="op" id="6330275">[</span><span class="num" id="6330276">6</span><span class="op" id="6330277">]</span><span class="op" id="6330278">)</span>&nbsp;<span class="op" id="6330280">+</span>&nbsp;<span class="builtintype" id="6330282">int</span><span class="op" id="6330285">(</span><span class="ident" id="6330286">d</span><span class="op" id="6330287">.</span><span class="ident" id="6330288">tmp</span><span class="op" id="6330291">[</span><span class="num" id="6330292">7</span><span class="op" id="6330293">]</span><span class="op" id="6330294">)</span><span class="op" id="6330295">&lt;&lt;</span><span class="num" id="6330297">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6330300">d</span><span class="op" id="6330301">.</span><span class="ident" id="6330302">imageFields</span>&nbsp;<span class="op" id="6330314">=</span>&nbsp;<span class="ident" id="6330316">d</span><span class="op" id="6330317">.</span><span class="ident" id="6330318">tmp</span><span class="op" id="6330321">[</span><span class="num" id="6330322">8</span><span class="op" id="6330323">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6330327">//&nbsp;The&nbsp;GIF89a&nbsp;spec,&nbsp;Section&nbsp;20&nbsp;(Image&nbsp;Descriptor)&nbsp;says:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6330384">//&nbsp;&#34;Each&nbsp;image&nbsp;must&nbsp;fit&nbsp;within&nbsp;the&nbsp;boundaries&nbsp;of&nbsp;the&nbsp;Logical</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6330446">//&nbsp;Screen,&nbsp;as&nbsp;defined&nbsp;in&nbsp;the&nbsp;Logical&nbsp;Screen&nbsp;Descriptor.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6330504">bounds</span>&nbsp;<span class="op" id="6330511">:=</span>&nbsp;<span class="ident" id="6330514">image</span><span class="op" id="6330519">.</span><span class="ident" id="6330520">Rect</span><span class="op" id="6330524">(</span><span class="ident" id="6330525">left</span><span class="op" id="6330529">,</span>&nbsp;<span class="ident" id="6330531">top</span><span class="op" id="6330534">,</span>&nbsp;<span class="ident" id="6330536">left</span><span class="op" id="6330540">+</span><span class="ident" id="6330541">width</span><span class="op" id="6330546">,</span>&nbsp;<span class="ident" id="6330548">top</span><span class="op" id="6330551">+</span><span class="ident" id="6330552">height</span><span class="op" id="6330558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6330561">if</span>&nbsp;<span class="ident" id="6330564">bounds</span>&nbsp;<span class="op" id="6330571">!=</span>&nbsp;<span class="ident" id="6330574">bounds</span><span class="op" id="6330580">.</span><span class="ident" id="6330581">Intersect</span><span class="op" id="6330590">(</span><span class="ident" id="6330591">image</span><span class="op" id="6330596">.</span><span class="ident" id="6330597">Rect</span><span class="op" id="6330601">(</span><span class="num" id="6330602">0</span><span class="op" id="6330603">,</span>&nbsp;<span class="num" id="6330605">0</span><span class="op" id="6330606">,</span>&nbsp;<span class="ident" id="6330608">d</span><span class="op" id="6330609">.</span><span class="ident" id="6330610">width</span><span class="op" id="6330615">,</span>&nbsp;<span class="ident" id="6330617">d</span><span class="op" id="6330618">.</span><span class="ident" id="6330619">height</span><span class="op" id="6330625">)</span><span class="op" id="6330626">)</span>&nbsp;<span class="op" id="6330628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6330632">return</span>&nbsp;<span class="ident" id="6330639">nil</span><span class="op" id="6330642">,</span>&nbsp;<span class="ident" id="6330644">errors</span><span class="op" id="6330650">.</span><span class="ident" id="6330651">New</span><span class="op" id="6330654">(</span><span class="string" id="6330655">&#34;gif:&nbsp;frame&nbsp;bounds&nbsp;larger&nbsp;than&nbsp;image&nbsp;bounds&#34;</span><span class="op" id="6330699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6330702">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6330705">return</span>&nbsp;<span class="ident" id="6330712">image</span><span class="op" id="6330717">.</span><span class="ident" id="6330718">NewPaletted</span><span class="op" id="6330729">(</span><span class="ident" id="6330730">bounds</span><span class="op" id="6330736">,</span>&nbsp;<span class="ident" id="6330738">nil</span><span class="op" id="6330741">)</span><span class="op" id="6330742">,</span>&nbsp;<span class="ident" id="6330744">nil</span><br>
<span class="lineno"></span><span class="op" id="6330748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6330751">func</span>&nbsp;<span class="op" id="6330756">(</span><span class="ident" id="6330757">d</span>&nbsp;<span class="op" id="6330759">*</span><span class="ident" id="6330760">decoder</span><span class="op" id="6330767">)</span>&nbsp;<span class="ident" id="6330769">readBlock</span><span class="op" id="6330778">(</span><span class="op" id="6330779">)</span>&nbsp;<span class="op" id="6330781">(</span><span class="builtintype" id="6330782">int</span><span class="op" id="6330785">,</span>&nbsp;<span class="builtintype" id="6330787">error</span><span class="op" id="6330792">)</span>&nbsp;<span class="op" id="6330794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6330797">n</span><span class="op" id="6330798">,</span>&nbsp;<span class="ident" id="6330800">err</span>&nbsp;<span class="op" id="6330804">:=</span>&nbsp;<span class="ident" id="6330807">d</span><span class="op" id="6330808">.</span><span class="ident" id="6330809">r</span><span class="op" id="6330810">.</span><span class="ident" id="6330811">ReadByte</span><span class="op" id="6330819">(</span><span class="op" id="6330820">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6330823">if</span>&nbsp;<span class="ident" id="6330826">n</span>&nbsp;<span class="op" id="6330828">==</span>&nbsp;<span class="num" id="6330831">0</span>&nbsp;<span class="op" id="6330833">||</span>&nbsp;<span class="ident" id="6330836">err</span>&nbsp;<span class="op" id="6330840">!=</span>&nbsp;<span class="ident" id="6330843">nil</span>&nbsp;<span class="op" id="6330847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6330851">return</span>&nbsp;<span class="num" id="6330858">0</span><span class="op" id="6330859">,</span>&nbsp;<span class="ident" id="6330861">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6330866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6330869">return</span>&nbsp;<span class="ident" id="6330876">io</span><span class="op" id="6330878">.</span><span class="ident" id="6330879">ReadFull</span><span class="op" id="6330887">(</span><span class="ident" id="6330888">d</span><span class="op" id="6330889">.</span><span class="ident" id="6330890">r</span><span class="op" id="6330891">,</span>&nbsp;<span class="ident" id="6330893">d</span><span class="op" id="6330894">.</span><span class="ident" id="6330895">tmp</span><span class="op" id="6330898">[</span><span class="num" id="6330899">0</span><span class="op" id="6330900">:</span><span class="ident" id="6330901">n</span><span class="op" id="6330902">]</span><span class="op" id="6330903">)</span><br>
<span class="lineno"></span><span class="op" id="6330905">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="comment" id="6330908">//&nbsp;interlaceScan&nbsp;defines&nbsp;the&nbsp;ordering&nbsp;for&nbsp;a&nbsp;pass&nbsp;of&nbsp;the&nbsp;interlace&nbsp;algorithm.</span><br>
<span class="lineno"></span><span class="keyword" id="6330985">type</span>&nbsp;<span class="ident" id="6330990">interlaceScan</span>&nbsp;<span class="keyword" id="6331004">struct</span>&nbsp;<span class="op" id="6331011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6331014">skip</span><span class="op" id="6331018">,</span>&nbsp;<span class="ident" id="6331020">start</span>&nbsp;<span class="builtintype" id="6331026">int</span><br>
<span class="lineno"></span><span class="op" id="6331030">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="6331033">//&nbsp;interlacing&nbsp;represents&nbsp;the&nbsp;set&nbsp;of&nbsp;scans&nbsp;in&nbsp;an&nbsp;interlaced&nbsp;GIF&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="6331104">var</span>&nbsp;<span class="ident" id="6331108">interlacing</span>&nbsp;<span class="op" id="6331120">=</span>&nbsp;<span class="op" id="6331122">[</span><span class="op" id="6331123">]</span><span class="ident" id="6331124">interlaceScan</span><span class="op" id="6331137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6331140">{</span><span class="num" id="6331141">8</span><span class="op" id="6331142">,</span>&nbsp;<span class="num" id="6331144">0</span><span class="op" id="6331145">}</span><span class="op" id="6331146">,</span>&nbsp;<span class="comment" id="6331148">//&nbsp;Group&nbsp;1&nbsp;:&nbsp;Every&nbsp;8th.&nbsp;row,&nbsp;starting&nbsp;with&nbsp;row&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6331199">{</span><span class="num" id="6331200">8</span><span class="op" id="6331201">,</span>&nbsp;<span class="num" id="6331203">4</span><span class="op" id="6331204">}</span><span class="op" id="6331205">,</span>&nbsp;<span class="comment" id="6331207">//&nbsp;Group&nbsp;2&nbsp;:&nbsp;Every&nbsp;8th.&nbsp;row,&nbsp;starting&nbsp;with&nbsp;row&nbsp;4.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6331258">{</span><span class="num" id="6331259">4</span><span class="op" id="6331260">,</span>&nbsp;<span class="num" id="6331262">2</span><span class="op" id="6331263">}</span><span class="op" id="6331264">,</span>&nbsp;<span class="comment" id="6331266">//&nbsp;Group&nbsp;3&nbsp;:&nbsp;Every&nbsp;4th.&nbsp;row,&nbsp;starting&nbsp;with&nbsp;row&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6331317">{</span><span class="num" id="6331318">2</span><span class="op" id="6331319">,</span>&nbsp;<span class="num" id="6331321">1</span><span class="op" id="6331322">}</span><span class="op" id="6331323">,</span>&nbsp;<span class="comment" id="6331325">//&nbsp;Group&nbsp;4&nbsp;:&nbsp;Every&nbsp;2nd.&nbsp;row,&nbsp;starting&nbsp;with&nbsp;row&nbsp;1.</span><br>
<span class="lineno"></span><span class="op" id="6331375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6331378">//&nbsp;uninterlace&nbsp;rearranges&nbsp;the&nbsp;pixels&nbsp;in&nbsp;m&nbsp;to&nbsp;account&nbsp;for&nbsp;interlaced&nbsp;input.</span><br>
<span class="lineno">400</span><span class="keyword" id="6331453">func</span>&nbsp;<span class="ident" id="6331458">uninterlace</span><span class="op" id="6331469">(</span><span class="ident" id="6331470">m</span>&nbsp;<span class="op" id="6331472">*</span><span class="ident" id="6331473">image</span><span class="op" id="6331478">.</span><span class="ident" id="6331479">Paletted</span><span class="op" id="6331487">)</span>&nbsp;<span class="op" id="6331489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6331492">var</span>&nbsp;<span class="ident" id="6331496">nPix</span>&nbsp;<span class="op" id="6331501">[</span><span class="op" id="6331502">]</span><span class="builtintype" id="6331503">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6331510">dx</span>&nbsp;<span class="op" id="6331513">:=</span>&nbsp;<span class="ident" id="6331516">m</span><span class="op" id="6331517">.</span><span class="ident" id="6331518">Bounds</span><span class="op" id="6331524">(</span><span class="op" id="6331525">)</span><span class="op" id="6331526">.</span><span class="ident" id="6331527">Dx</span><span class="op" id="6331529">(</span><span class="op" id="6331530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6331533">dy</span>&nbsp;<span class="op" id="6331536">:=</span>&nbsp;<span class="ident" id="6331539">m</span><span class="op" id="6331540">.</span><span class="ident" id="6331541">Bounds</span><span class="op" id="6331547">(</span><span class="op" id="6331548">)</span><span class="op" id="6331549">.</span><span class="ident" id="6331550">Dy</span><span class="op" id="6331552">(</span><span class="op" id="6331553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6331556">nPix</span>&nbsp;<span class="op" id="6331561">=</span>&nbsp;<span class="builtinfunc" id="6331563">make</span><span class="op" id="6331567">(</span><span class="op" id="6331568">[</span><span class="op" id="6331569">]</span><span class="builtintype" id="6331570">uint8</span><span class="op" id="6331575">,</span>&nbsp;<span class="ident" id="6331577">dx</span><span class="op" id="6331579">*</span><span class="ident" id="6331580">dy</span><span class="op" id="6331582">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6331585">offset</span>&nbsp;<span class="op" id="6331592">:=</span>&nbsp;<span class="num" id="6331595">0</span>&nbsp;<span class="comment" id="6331597">//&nbsp;steps&nbsp;through&nbsp;the&nbsp;input&nbsp;by&nbsp;sequential&nbsp;scan&nbsp;lines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6331651">for</span>&nbsp;<span class="ident" id="6331655">_</span><span class="op" id="6331656">,</span>&nbsp;<span class="ident" id="6331658">pass</span>&nbsp;<span class="op" id="6331663">:=</span>&nbsp;<span class="keyword" id="6331666">range</span>&nbsp;<span class="ident" id="6331672">interlacing</span>&nbsp;<span class="op" id="6331684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6331688">nOffset</span>&nbsp;<span class="op" id="6331696">:=</span>&nbsp;<span class="ident" id="6331699">pass</span><span class="op" id="6331703">.</span><span class="ident" id="6331704">start</span>&nbsp;<span class="op" id="6331710">*</span>&nbsp;<span class="ident" id="6331712">dx</span>&nbsp;<span class="comment" id="6331715">//&nbsp;steps&nbsp;through&nbsp;the&nbsp;output&nbsp;as&nbsp;defined&nbsp;by&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6331765">for</span>&nbsp;<span class="ident" id="6331769">y</span>&nbsp;<span class="op" id="6331771">:=</span>&nbsp;<span class="ident" id="6331774">pass</span><span class="op" id="6331778">.</span><span class="ident" id="6331779">start</span><span class="op" id="6331784">;</span>&nbsp;<span class="ident" id="6331786">y</span>&nbsp;<span class="op" id="6331788">&lt;</span>&nbsp;<span class="ident" id="6331790">dy</span><span class="op" id="6331792">;</span>&nbsp;<span class="ident" id="6331794">y</span>&nbsp;<span class="op" id="6331796">+=</span>&nbsp;<span class="ident" id="6331799">pass</span><span class="op" id="6331803">.</span><span class="ident" id="6331804">skip</span>&nbsp;<span class="op" id="6331809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6331814">copy</span><span class="op" id="6331818">(</span><span class="ident" id="6331819">nPix</span><span class="op" id="6331823">[</span><span class="ident" id="6331824">nOffset</span><span class="op" id="6331831">:</span><span class="ident" id="6331832">nOffset</span><span class="op" id="6331839">+</span><span class="ident" id="6331840">dx</span><span class="op" id="6331842">]</span><span class="op" id="6331843">,</span>&nbsp;<span class="ident" id="6331845">m</span><span class="op" id="6331846">.</span><span class="ident" id="6331847">Pix</span><span class="op" id="6331850">[</span><span class="ident" id="6331851">offset</span><span class="op" id="6331857">:</span><span class="ident" id="6331858">offset</span><span class="op" id="6331864">+</span><span class="ident" id="6331865">dx</span><span class="op" id="6331867">]</span><span class="op" id="6331868">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6331873">offset</span>&nbsp;<span class="op" id="6331880">+=</span>&nbsp;<span class="ident" id="6331883">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6331889">nOffset</span>&nbsp;<span class="op" id="6331897">+=</span>&nbsp;<span class="ident" id="6331900">dx</span>&nbsp;<span class="op" id="6331903">*</span>&nbsp;<span class="ident" id="6331905">pass</span><span class="op" id="6331909">.</span><span class="ident" id="6331910">skip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6331917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6331920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6331923">m</span><span class="op" id="6331924">.</span><span class="ident" id="6331925">Pix</span>&nbsp;<span class="op" id="6331929">=</span>&nbsp;<span class="ident" id="6331931">nPix</span><br>
<span class="lineno">415</span><span class="op" id="6331936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6331939">//&nbsp;Decode&nbsp;reads&nbsp;a&nbsp;GIF&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;the&nbsp;first&nbsp;embedded</span><br>
<span class="lineno"></span><span class="comment" id="6332005">//&nbsp;image&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="6332033">func</span>&nbsp;<span class="ident" id="6332038">Decode</span><span class="op" id="6332044">(</span><span class="ident" id="6332045">r</span>&nbsp;<span class="ident" id="6332047">io</span><span class="op" id="6332049">.</span><span class="ident" id="6332050">Reader</span><span class="op" id="6332056">)</span>&nbsp;<span class="op" id="6332058">(</span><span class="ident" id="6332059">image</span><span class="op" id="6332064">.</span><span class="ident" id="6332065">Image</span><span class="op" id="6332070">,</span>&nbsp;<span class="builtintype" id="6332072">error</span><span class="op" id="6332077">)</span>&nbsp;<span class="op" id="6332079">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6332082">var</span>&nbsp;<span class="ident" id="6332086">d</span>&nbsp;<span class="ident" id="6332088">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6332097">if</span>&nbsp;<span class="ident" id="6332100">err</span>&nbsp;<span class="op" id="6332104">:=</span>&nbsp;<span class="ident" id="6332107">d</span><span class="op" id="6332108">.</span><span class="ident" id="6332109">decode</span><span class="op" id="6332115">(</span><span class="ident" id="6332116">r</span><span class="op" id="6332117">,</span>&nbsp;<span class="builtintype" id="6332119">false</span><span class="op" id="6332124">)</span><span class="op" id="6332125">;</span>&nbsp;<span class="ident" id="6332127">err</span>&nbsp;<span class="op" id="6332131">!=</span>&nbsp;<span class="ident" id="6332134">nil</span>&nbsp;<span class="op" id="6332138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6332142">return</span>&nbsp;<span class="ident" id="6332149">nil</span><span class="op" id="6332152">,</span>&nbsp;<span class="ident" id="6332154">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6332159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6332162">return</span>&nbsp;<span class="ident" id="6332169">d</span><span class="op" id="6332170">.</span><span class="ident" id="6332171">image</span><span class="op" id="6332176">[</span><span class="num" id="6332177">0</span><span class="op" id="6332178">]</span><span class="op" id="6332179">,</span>&nbsp;<span class="ident" id="6332181">nil</span><br>
<span class="lineno">425</span><span class="op" id="6332185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6332188">//&nbsp;GIF&nbsp;represents&nbsp;the&nbsp;possibly&nbsp;multiple&nbsp;images&nbsp;stored&nbsp;in&nbsp;a&nbsp;GIF&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="6332257">type</span>&nbsp;<span class="ident" id="6332262">GIF</span>&nbsp;<span class="keyword" id="6332266">struct</span>&nbsp;<span class="op" id="6332273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6332276">Image</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6332286">[</span><span class="op" id="6332287">]</span><span class="op" id="6332288">*</span><span class="ident" id="6332289">image</span><span class="op" id="6332294">.</span><span class="ident" id="6332295">Paletted</span>&nbsp;<span class="comment" id="6332304">//&nbsp;The&nbsp;successive&nbsp;images.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6332331">Delay</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6332341">[</span><span class="op" id="6332342">]</span><span class="builtintype" id="6332343">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6332359">//&nbsp;The&nbsp;successive&nbsp;delay&nbsp;times,&nbsp;one&nbsp;per&nbsp;frame,&nbsp;in&nbsp;100ths&nbsp;of&nbsp;a&nbsp;second.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6332429">LoopCount</span>&nbsp;<span class="builtintype" id="6332439">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6332457">//&nbsp;The&nbsp;loop&nbsp;count.</span><br>
<span class="lineno"></span><span class="op" id="6332476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6332479">//&nbsp;DecodeAll&nbsp;reads&nbsp;a&nbsp;GIF&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;the&nbsp;sequential&nbsp;frames</span><br>
<span class="lineno">435</span><span class="comment" id="6332551">//&nbsp;and&nbsp;timing&nbsp;information.</span><br>
<span class="lineno"></span><span class="keyword" id="6332578">func</span>&nbsp;<span class="ident" id="6332583">DecodeAll</span><span class="op" id="6332592">(</span><span class="ident" id="6332593">r</span>&nbsp;<span class="ident" id="6332595">io</span><span class="op" id="6332597">.</span><span class="ident" id="6332598">Reader</span><span class="op" id="6332604">)</span>&nbsp;<span class="op" id="6332606">(</span><span class="op" id="6332607">*</span><span class="ident" id="6332608">GIF</span><span class="op" id="6332611">,</span>&nbsp;<span class="builtintype" id="6332613">error</span><span class="op" id="6332618">)</span>&nbsp;<span class="op" id="6332620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6332623">var</span>&nbsp;<span class="ident" id="6332627">d</span>&nbsp;<span class="ident" id="6332629">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6332638">if</span>&nbsp;<span class="ident" id="6332641">err</span>&nbsp;<span class="op" id="6332645">:=</span>&nbsp;<span class="ident" id="6332648">d</span><span class="op" id="6332649">.</span><span class="ident" id="6332650">decode</span><span class="op" id="6332656">(</span><span class="ident" id="6332657">r</span><span class="op" id="6332658">,</span>&nbsp;<span class="builtintype" id="6332660">false</span><span class="op" id="6332665">)</span><span class="op" id="6332666">;</span>&nbsp;<span class="ident" id="6332668">err</span>&nbsp;<span class="op" id="6332672">!=</span>&nbsp;<span class="ident" id="6332675">nil</span>&nbsp;<span class="op" id="6332679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6332683">return</span>&nbsp;<span class="ident" id="6332690">nil</span><span class="op" id="6332693">,</span>&nbsp;<span class="ident" id="6332695">err</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6332700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6332703">gif</span>&nbsp;<span class="op" id="6332707">:=</span>&nbsp;<span class="op" id="6332710">&amp;</span><span class="ident" id="6332711">GIF</span><span class="op" id="6332714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6332718">Image</span><span class="op" id="6332723">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332729">d</span><span class="op" id="6332730">.</span><span class="ident" id="6332731">image</span><span class="op" id="6332736">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6332740">LoopCount</span><span class="op" id="6332749">:</span>&nbsp;<span class="ident" id="6332751">d</span><span class="op" id="6332752">.</span><span class="ident" id="6332753">loopCount</span><span class="op" id="6332762">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6332766">Delay</span><span class="op" id="6332771">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6332777">d</span><span class="op" id="6332778">.</span><span class="ident" id="6332779">delay</span><span class="op" id="6332784">,</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6332787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6332790">return</span>&nbsp;<span class="ident" id="6332797">gif</span><span class="op" id="6332800">,</span>&nbsp;<span class="ident" id="6332802">nil</span><br>
<span class="lineno"></span><span class="op" id="6332806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6332809">//&nbsp;DecodeConfig&nbsp;returns&nbsp;the&nbsp;global&nbsp;color&nbsp;model&nbsp;and&nbsp;dimensions&nbsp;of&nbsp;a&nbsp;GIF&nbsp;image</span><br>
<span class="lineno">450</span><span class="comment" id="6332886">//&nbsp;without&nbsp;decoding&nbsp;the&nbsp;entire&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="6332924">func</span>&nbsp;<span class="ident" id="6332929">DecodeConfig</span><span class="op" id="6332941">(</span><span class="ident" id="6332942">r</span>&nbsp;<span class="ident" id="6332944">io</span><span class="op" id="6332946">.</span><span class="ident" id="6332947">Reader</span><span class="op" id="6332953">)</span>&nbsp;<span class="op" id="6332955">(</span><span class="ident" id="6332956">image</span><span class="op" id="6332961">.</span><span class="ident" id="6332962">Config</span><span class="op" id="6332968">,</span>&nbsp;<span class="builtintype" id="6332970">error</span><span class="op" id="6332975">)</span>&nbsp;<span class="op" id="6332977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6332980">var</span>&nbsp;<span class="ident" id="6332984">d</span>&nbsp;<span class="ident" id="6332986">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6332995">if</span>&nbsp;<span class="ident" id="6332998">err</span>&nbsp;<span class="op" id="6333002">:=</span>&nbsp;<span class="ident" id="6333005">d</span><span class="op" id="6333006">.</span><span class="ident" id="6333007">decode</span><span class="op" id="6333013">(</span><span class="ident" id="6333014">r</span><span class="op" id="6333015">,</span>&nbsp;<span class="builtintype" id="6333017">true</span><span class="op" id="6333021">)</span><span class="op" id="6333022">;</span>&nbsp;<span class="ident" id="6333024">err</span>&nbsp;<span class="op" id="6333028">!=</span>&nbsp;<span class="ident" id="6333031">nil</span>&nbsp;<span class="op" id="6333035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6333039">return</span>&nbsp;<span class="ident" id="6333046">image</span><span class="op" id="6333051">.</span><span class="ident" id="6333052">Config</span><span class="op" id="6333058">{</span><span class="op" id="6333059">}</span><span class="op" id="6333060">,</span>&nbsp;<span class="ident" id="6333062">err</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6333067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6333070">return</span>&nbsp;<span class="ident" id="6333077">image</span><span class="op" id="6333082">.</span><span class="ident" id="6333083">Config</span><span class="op" id="6333089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6333093">ColorModel</span><span class="op" id="6333103">:</span>&nbsp;<span class="ident" id="6333105">d</span><span class="op" id="6333106">.</span><span class="ident" id="6333107">globalColorMap</span><span class="op" id="6333121">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6333125">Width</span><span class="op" id="6333130">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333137">d</span><span class="op" id="6333138">.</span><span class="ident" id="6333139">width</span><span class="op" id="6333144">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6333148">Height</span><span class="op" id="6333154">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6333160">d</span><span class="op" id="6333161">.</span><span class="ident" id="6333162">height</span><span class="op" id="6333168">,</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6333171">}</span><span class="op" id="6333172">,</span>&nbsp;<span class="ident" id="6333174">nil</span><br>
<span class="lineno"></span><span class="op" id="6333178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6333181">func</span>&nbsp;<span class="ident" id="6333186">init</span><span class="op" id="6333190">(</span><span class="op" id="6333191">)</span>&nbsp;<span class="op" id="6333193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6333196">image</span><span class="op" id="6333201">.</span><span class="ident" id="6333202">RegisterFormat</span><span class="op" id="6333216">(</span><span class="string" id="6333217">&#34;gif&#34;</span><span class="op" id="6333222">,</span>&nbsp;<span class="string" id="6333224">&#34;GIF8?a&#34;</span><span class="op" id="6333232">,</span>&nbsp;<span class="ident" id="6333234">Decode</span><span class="op" id="6333240">,</span>&nbsp;<span class="ident" id="6333242">DecodeConfig</span><span class="op" id="6333254">)</span><br>
<span class="lineno">465</span><span class="op" id="6333256">}</span>
</div>
</body>
</html>
