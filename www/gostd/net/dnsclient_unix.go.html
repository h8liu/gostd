<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html" class="current">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3690883">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3690938">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3690992">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3691043">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3691108">//&nbsp;DNS&nbsp;client:&nbsp;see&nbsp;RFC&nbsp;1035.</span><br>
<span class="lineno"></span><span class="comment" id="3691137">//&nbsp;Has&nbsp;to&nbsp;be&nbsp;linked&nbsp;into&nbsp;package&nbsp;net&nbsp;for&nbsp;Dial.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3691185">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span><span class="comment" id="3691199">//&nbsp;&nbsp;&nbsp;&nbsp;Could&nbsp;potentially&nbsp;handle&nbsp;many&nbsp;outstanding&nbsp;lookups&nbsp;faster.</span><br>
<span class="lineno"></span><span class="comment" id="3691260">//&nbsp;&nbsp;&nbsp;&nbsp;Could&nbsp;have&nbsp;a&nbsp;small&nbsp;cache.</span><br>
<span class="lineno"></span><span class="comment" id="3691289">//&nbsp;&nbsp;&nbsp;&nbsp;Random&nbsp;UDP&nbsp;source&nbsp;port&nbsp;(net.Dial&nbsp;should&nbsp;do&nbsp;that&nbsp;for&nbsp;us).</span><br>
<span class="lineno"></span><span class="comment" id="3691349">//&nbsp;&nbsp;&nbsp;&nbsp;Random&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3691373">package</span>&nbsp;<span class="ident" id="3691381">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3691386">import</span>&nbsp;<span class="op" id="3691393">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3691396">&#34;errors&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3691406">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3691412">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3691425">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3691431">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3691439">&#34;time&#34;</span><br>
<span class="lineno">25</span><span class="op" id="3691446">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3691449">//&nbsp;A&nbsp;dnsConn&nbsp;represents&nbsp;a&nbsp;DNS&nbsp;transport&nbsp;endpoint.</span><br>
<span class="lineno"></span><span class="keyword" id="3691499">type</span>&nbsp;<span class="ident" id="3691504">dnsConn</span>&nbsp;<span class="keyword" id="3691512">interface</span>&nbsp;<span class="op" id="3691522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3691525">Conn</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3691532">//&nbsp;readDNSResponse&nbsp;reads&nbsp;a&nbsp;DNS&nbsp;response&nbsp;message&nbsp;from&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3691594">//&nbsp;transport&nbsp;endpoint&nbsp;and&nbsp;returns&nbsp;the&nbsp;received&nbsp;DNS&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3691655">//&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3691668">readDNSResponse</span><span class="op" id="3691683">(</span><span class="op" id="3691684">)</span>&nbsp;<span class="op" id="3691686">(</span><span class="op" id="3691687">*</span><span class="ident" id="3691688">dnsMsg</span><span class="op" id="3691694">,</span>&nbsp;<span class="builtintype" id="3691696">error</span><span class="op" id="3691701">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3691705">//&nbsp;writeDNSQuery&nbsp;writes&nbsp;a&nbsp;DNS&nbsp;query&nbsp;message&nbsp;to&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3691761">//&nbsp;connection&nbsp;endpoint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3691786">writeDNSQuery</span><span class="op" id="3691799">(</span><span class="op" id="3691800">*</span><span class="ident" id="3691801">dnsMsg</span><span class="op" id="3691807">)</span>&nbsp;<span class="builtintype" id="3691809">error</span><br>
<span class="lineno"></span><span class="op" id="3691815">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3691818">func</span>&nbsp;<span class="op" id="3691823">(</span><span class="ident" id="3691824">c</span>&nbsp;<span class="op" id="3691826">*</span><span class="ident" id="3691827">UDPConn</span><span class="op" id="3691834">)</span>&nbsp;<span class="ident" id="3691836">readDNSResponse</span><span class="op" id="3691851">(</span><span class="op" id="3691852">)</span>&nbsp;<span class="op" id="3691854">(</span><span class="op" id="3691855">*</span><span class="ident" id="3691856">dnsMsg</span><span class="op" id="3691862">,</span>&nbsp;<span class="builtintype" id="3691864">error</span><span class="op" id="3691869">)</span>&nbsp;<span class="op" id="3691871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3691874">b</span>&nbsp;<span class="op" id="3691876">:=</span>&nbsp;<span class="builtinfunc" id="3691879">make</span><span class="op" id="3691883">(</span><span class="op" id="3691884">[</span><span class="op" id="3691885">]</span><span class="builtintype" id="3691886">byte</span><span class="op" id="3691890">,</span>&nbsp;<span class="num" id="3691892">512</span><span class="op" id="3691895">)</span>&nbsp;<span class="comment" id="3691897">//&nbsp;see&nbsp;RFC&nbsp;1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3691914">n</span><span class="op" id="3691915">,</span>&nbsp;<span class="ident" id="3691917">err</span>&nbsp;<span class="op" id="3691921">:=</span>&nbsp;<span class="ident" id="3691924">c</span><span class="op" id="3691925">.</span><span class="ident" id="3691926">Read</span><span class="op" id="3691930">(</span><span class="ident" id="3691931">b</span><span class="op" id="3691932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3691935">if</span>&nbsp;<span class="ident" id="3691938">err</span>&nbsp;<span class="op" id="3691942">!=</span>&nbsp;<span class="builtintype" id="3691945">nil</span>&nbsp;<span class="op" id="3691949">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3691953">return</span>&nbsp;<span class="builtintype" id="3691960">nil</span><span class="op" id="3691963">,</span>&nbsp;<span class="ident" id="3691965">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3691970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3691973">msg</span>&nbsp;<span class="op" id="3691977">:=</span>&nbsp;<span class="op" id="3691980">&amp;</span><span class="ident" id="3691981">dnsMsg</span><span class="op" id="3691987">{</span><span class="op" id="3691988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3691991">if</span>&nbsp;<span class="op" id="3691994">!</span><span class="ident" id="3691995">msg</span><span class="op" id="3691998">.</span><span class="ident" id="3691999">Unpack</span><span class="op" id="3692005">(</span><span class="ident" id="3692006">b</span><span class="op" id="3692007">[</span><span class="op" id="3692008">:</span><span class="ident" id="3692009">n</span><span class="op" id="3692010">]</span><span class="op" id="3692011">)</span>&nbsp;<span class="op" id="3692013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692017">return</span>&nbsp;<span class="builtintype" id="3692024">nil</span><span class="op" id="3692027">,</span>&nbsp;<span class="ident" id="3692029">errors</span><span class="op" id="3692035">.</span><span class="ident" id="3692036">New</span><span class="op" id="3692039">(</span><span class="string" id="3692040">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3692070">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3692073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692076">return</span>&nbsp;<span class="ident" id="3692083">msg</span><span class="op" id="3692086">,</span>&nbsp;<span class="builtintype" id="3692088">nil</span><br>
<span class="lineno"></span><span class="op" id="3692092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3692095">func</span>&nbsp;<span class="op" id="3692100">(</span><span class="ident" id="3692101">c</span>&nbsp;<span class="op" id="3692103">*</span><span class="ident" id="3692104">UDPConn</span><span class="op" id="3692111">)</span>&nbsp;<span class="ident" id="3692113">writeDNSQuery</span><span class="op" id="3692126">(</span><span class="ident" id="3692127">msg</span>&nbsp;<span class="op" id="3692131">*</span><span class="ident" id="3692132">dnsMsg</span><span class="op" id="3692138">)</span>&nbsp;<span class="builtintype" id="3692140">error</span>&nbsp;<span class="op" id="3692146">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3692149">b</span><span class="op" id="3692150">,</span>&nbsp;<span class="ident" id="3692152">ok</span>&nbsp;<span class="op" id="3692155">:=</span>&nbsp;<span class="ident" id="3692158">msg</span><span class="op" id="3692161">.</span><span class="ident" id="3692162">Pack</span><span class="op" id="3692166">(</span><span class="op" id="3692167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692170">if</span>&nbsp;<span class="op" id="3692173">!</span><span class="ident" id="3692174">ok</span>&nbsp;<span class="op" id="3692177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692181">return</span>&nbsp;<span class="ident" id="3692188">errors</span><span class="op" id="3692194">.</span><span class="ident" id="3692195">New</span><span class="op" id="3692198">(</span><span class="string" id="3692199">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3692227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3692230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692233">if</span>&nbsp;<span class="ident" id="3692236">_</span><span class="op" id="3692237">,</span>&nbsp;<span class="ident" id="3692239">err</span>&nbsp;<span class="op" id="3692243">:=</span>&nbsp;<span class="ident" id="3692246">c</span><span class="op" id="3692247">.</span><span class="ident" id="3692248">Write</span><span class="op" id="3692253">(</span><span class="ident" id="3692254">b</span><span class="op" id="3692255">)</span><span class="op" id="3692256">;</span>&nbsp;<span class="ident" id="3692258">err</span>&nbsp;<span class="op" id="3692262">!=</span>&nbsp;<span class="builtintype" id="3692265">nil</span>&nbsp;<span class="op" id="3692269">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692273">return</span>&nbsp;<span class="ident" id="3692280">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3692285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692288">return</span>&nbsp;<span class="builtintype" id="3692295">nil</span><br>
<span class="lineno"></span><span class="op" id="3692299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="3692302">func</span>&nbsp;<span class="op" id="3692307">(</span><span class="ident" id="3692308">c</span>&nbsp;<span class="op" id="3692310">*</span><span class="ident" id="3692311">TCPConn</span><span class="op" id="3692318">)</span>&nbsp;<span class="ident" id="3692320">readDNSResponse</span><span class="op" id="3692335">(</span><span class="op" id="3692336">)</span>&nbsp;<span class="op" id="3692338">(</span><span class="op" id="3692339">*</span><span class="ident" id="3692340">dnsMsg</span><span class="op" id="3692346">,</span>&nbsp;<span class="builtintype" id="3692348">error</span><span class="op" id="3692353">)</span>&nbsp;<span class="op" id="3692355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3692358">b</span>&nbsp;<span class="op" id="3692360">:=</span>&nbsp;<span class="builtinfunc" id="3692363">make</span><span class="op" id="3692367">(</span><span class="op" id="3692368">[</span><span class="op" id="3692369">]</span><span class="builtintype" id="3692370">byte</span><span class="op" id="3692374">,</span>&nbsp;<span class="num" id="3692376">1280</span><span class="op" id="3692380">)</span>&nbsp;<span class="comment" id="3692382">//&nbsp;1280&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;initial&nbsp;size&nbsp;for&nbsp;IP&nbsp;over&nbsp;Ethernet,&nbsp;see&nbsp;RFC&nbsp;4035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692455">if</span>&nbsp;<span class="ident" id="3692458">_</span><span class="op" id="3692459">,</span>&nbsp;<span class="ident" id="3692461">err</span>&nbsp;<span class="op" id="3692465">:=</span>&nbsp;<span class="ident" id="3692468">io</span><span class="op" id="3692470">.</span><span class="ident" id="3692471">ReadFull</span><span class="op" id="3692479">(</span><span class="ident" id="3692480">c</span><span class="op" id="3692481">,</span>&nbsp;<span class="ident" id="3692483">b</span><span class="op" id="3692484">[</span><span class="op" id="3692485">:</span><span class="num" id="3692486">2</span><span class="op" id="3692487">]</span><span class="op" id="3692488">)</span><span class="op" id="3692489">;</span>&nbsp;<span class="ident" id="3692491">err</span>&nbsp;<span class="op" id="3692495">!=</span>&nbsp;<span class="builtintype" id="3692498">nil</span>&nbsp;<span class="op" id="3692502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692506">return</span>&nbsp;<span class="builtintype" id="3692513">nil</span><span class="op" id="3692516">,</span>&nbsp;<span class="ident" id="3692518">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3692523">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3692526">l</span>&nbsp;<span class="op" id="3692528">:=</span>&nbsp;<span class="builtintype" id="3692531">int</span><span class="op" id="3692534">(</span><span class="ident" id="3692535">b</span><span class="op" id="3692536">[</span><span class="num" id="3692537">0</span><span class="op" id="3692538">]</span><span class="op" id="3692539">)</span><span class="op" id="3692540">&lt;&lt;</span><span class="num" id="3692542">8</span>&nbsp;<span class="op" id="3692544">|</span>&nbsp;<span class="builtintype" id="3692546">int</span><span class="op" id="3692549">(</span><span class="ident" id="3692550">b</span><span class="op" id="3692551">[</span><span class="num" id="3692552">1</span><span class="op" id="3692553">]</span><span class="op" id="3692554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692557">if</span>&nbsp;<span class="ident" id="3692560">l</span>&nbsp;<span class="op" id="3692562">&gt;</span>&nbsp;<span class="builtinfunc" id="3692564">len</span><span class="op" id="3692567">(</span><span class="ident" id="3692568">b</span><span class="op" id="3692569">)</span>&nbsp;<span class="op" id="3692571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3692575">b</span>&nbsp;<span class="op" id="3692577">=</span>&nbsp;<span class="builtinfunc" id="3692579">make</span><span class="op" id="3692583">(</span><span class="op" id="3692584">[</span><span class="op" id="3692585">]</span><span class="builtintype" id="3692586">byte</span><span class="op" id="3692590">,</span>&nbsp;<span class="ident" id="3692592">l</span><span class="op" id="3692593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3692596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3692599">n</span><span class="op" id="3692600">,</span>&nbsp;<span class="ident" id="3692602">err</span>&nbsp;<span class="op" id="3692606">:=</span>&nbsp;<span class="ident" id="3692609">io</span><span class="op" id="3692611">.</span><span class="ident" id="3692612">ReadFull</span><span class="op" id="3692620">(</span><span class="ident" id="3692621">c</span><span class="op" id="3692622">,</span>&nbsp;<span class="ident" id="3692624">b</span><span class="op" id="3692625">[</span><span class="op" id="3692626">:</span><span class="ident" id="3692627">l</span><span class="op" id="3692628">]</span><span class="op" id="3692629">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692632">if</span>&nbsp;<span class="ident" id="3692635">err</span>&nbsp;<span class="op" id="3692639">!=</span>&nbsp;<span class="builtintype" id="3692642">nil</span>&nbsp;<span class="op" id="3692646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692650">return</span>&nbsp;<span class="builtintype" id="3692657">nil</span><span class="op" id="3692660">,</span>&nbsp;<span class="ident" id="3692662">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3692667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3692670">msg</span>&nbsp;<span class="op" id="3692674">:=</span>&nbsp;<span class="op" id="3692677">&amp;</span><span class="ident" id="3692678">dnsMsg</span><span class="op" id="3692684">{</span><span class="op" id="3692685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692688">if</span>&nbsp;<span class="op" id="3692691">!</span><span class="ident" id="3692692">msg</span><span class="op" id="3692695">.</span><span class="ident" id="3692696">Unpack</span><span class="op" id="3692702">(</span><span class="ident" id="3692703">b</span><span class="op" id="3692704">[</span><span class="op" id="3692705">:</span><span class="ident" id="3692706">n</span><span class="op" id="3692707">]</span><span class="op" id="3692708">)</span>&nbsp;<span class="op" id="3692710">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692714">return</span>&nbsp;<span class="builtintype" id="3692721">nil</span><span class="op" id="3692724">,</span>&nbsp;<span class="ident" id="3692726">errors</span><span class="op" id="3692732">.</span><span class="ident" id="3692733">New</span><span class="op" id="3692736">(</span><span class="string" id="3692737">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3692767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3692770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692773">return</span>&nbsp;<span class="ident" id="3692780">msg</span><span class="op" id="3692783">,</span>&nbsp;<span class="builtintype" id="3692785">nil</span><br>
<span class="lineno"></span><span class="op" id="3692789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="3692792">func</span>&nbsp;<span class="op" id="3692797">(</span><span class="ident" id="3692798">c</span>&nbsp;<span class="op" id="3692800">*</span><span class="ident" id="3692801">TCPConn</span><span class="op" id="3692808">)</span>&nbsp;<span class="ident" id="3692810">writeDNSQuery</span><span class="op" id="3692823">(</span><span class="ident" id="3692824">msg</span>&nbsp;<span class="op" id="3692828">*</span><span class="ident" id="3692829">dnsMsg</span><span class="op" id="3692835">)</span>&nbsp;<span class="builtintype" id="3692837">error</span>&nbsp;<span class="op" id="3692843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3692846">b</span><span class="op" id="3692847">,</span>&nbsp;<span class="ident" id="3692849">ok</span>&nbsp;<span class="op" id="3692852">:=</span>&nbsp;<span class="ident" id="3692855">msg</span><span class="op" id="3692858">.</span><span class="ident" id="3692859">Pack</span><span class="op" id="3692863">(</span><span class="op" id="3692864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692867">if</span>&nbsp;<span class="op" id="3692870">!</span><span class="ident" id="3692871">ok</span>&nbsp;<span class="op" id="3692874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3692878">return</span>&nbsp;<span class="ident" id="3692885">errors</span><span class="op" id="3692891">.</span><span class="ident" id="3692892">New</span><span class="op" id="3692895">(</span><span class="string" id="3692896">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3692924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3692927">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3692930">l</span>&nbsp;<span class="op" id="3692932">:=</span>&nbsp;<span class="builtintype" id="3692935">uint16</span><span class="op" id="3692941">(</span><span class="builtinfunc" id="3692942">len</span><span class="op" id="3692945">(</span><span class="ident" id="3692946">b</span><span class="op" id="3692947">)</span><span class="op" id="3692948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3692951">b</span>&nbsp;<span class="op" id="3692953">=</span>&nbsp;<span class="builtinfunc" id="3692955">append</span><span class="op" id="3692961">(</span><span class="op" id="3692962">[</span><span class="op" id="3692963">]</span><span class="builtintype" id="3692964">byte</span><span class="op" id="3692968">{</span><span class="builtintype" id="3692969">byte</span><span class="op" id="3692973">(</span><span class="ident" id="3692974">l</span>&nbsp;<span class="op" id="3692976">&gt;&gt;</span>&nbsp;<span class="num" id="3692979">8</span><span class="op" id="3692980">)</span><span class="op" id="3692981">,</span>&nbsp;<span class="builtintype" id="3692983">byte</span><span class="op" id="3692987">(</span><span class="ident" id="3692988">l</span><span class="op" id="3692989">)</span><span class="op" id="3692990">}</span><span class="op" id="3692991">,</span>&nbsp;<span class="ident" id="3692993">b</span><span class="op" id="3692994">...</span><span class="op" id="3692997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693000">if</span>&nbsp;<span class="ident" id="3693003">_</span><span class="op" id="3693004">,</span>&nbsp;<span class="ident" id="3693006">err</span>&nbsp;<span class="op" id="3693010">:=</span>&nbsp;<span class="ident" id="3693013">c</span><span class="op" id="3693014">.</span><span class="ident" id="3693015">Write</span><span class="op" id="3693020">(</span><span class="ident" id="3693021">b</span><span class="op" id="3693022">)</span><span class="op" id="3693023">;</span>&nbsp;<span class="ident" id="3693025">err</span>&nbsp;<span class="op" id="3693029">!=</span>&nbsp;<span class="builtintype" id="3693032">nil</span>&nbsp;<span class="op" id="3693036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693040">return</span>&nbsp;<span class="ident" id="3693047">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3693052">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693055">return</span>&nbsp;<span class="builtintype" id="3693062">nil</span><br>
<span class="lineno"></span><span class="op" id="3693066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3693069">func</span>&nbsp;<span class="op" id="3693074">(</span><span class="ident" id="3693075">d</span>&nbsp;<span class="op" id="3693077">*</span><span class="ident" id="3693078">Dialer</span><span class="op" id="3693084">)</span>&nbsp;<span class="ident" id="3693086">dialDNS</span><span class="op" id="3693093">(</span><span class="ident" id="3693094">network</span><span class="op" id="3693101">,</span>&nbsp;<span class="ident" id="3693103">server</span>&nbsp;<span class="builtintype" id="3693110">string</span><span class="op" id="3693116">)</span>&nbsp;<span class="op" id="3693118">(</span><span class="ident" id="3693119">dnsConn</span><span class="op" id="3693126">,</span>&nbsp;<span class="builtintype" id="3693128">error</span><span class="op" id="3693133">)</span>&nbsp;<span class="op" id="3693135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693138">switch</span>&nbsp;<span class="ident" id="3693145">network</span>&nbsp;<span class="op" id="3693153">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693156">case</span>&nbsp;<span class="string" id="3693161">&#34;tcp&#34;</span><span class="op" id="3693166">,</span>&nbsp;<span class="string" id="3693168">&#34;tcp4&#34;</span><span class="op" id="3693174">,</span>&nbsp;<span class="string" id="3693176">&#34;tcp6&#34;</span><span class="op" id="3693182">,</span>&nbsp;<span class="string" id="3693184">&#34;udp&#34;</span><span class="op" id="3693189">,</span>&nbsp;<span class="string" id="3693191">&#34;udp4&#34;</span><span class="op" id="3693197">,</span>&nbsp;<span class="string" id="3693199">&#34;udp6&#34;</span><span class="op" id="3693205">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693208">default</span><span class="op" id="3693215">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693219">return</span>&nbsp;<span class="builtintype" id="3693226">nil</span><span class="op" id="3693229">,</span>&nbsp;<span class="ident" id="3693231">UnknownNetworkError</span><span class="op" id="3693250">(</span><span class="ident" id="3693251">network</span><span class="op" id="3693258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3693261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3693264">//&nbsp;Calling&nbsp;Dial&nbsp;here&nbsp;is&nbsp;scary&nbsp;--&nbsp;we&nbsp;have&nbsp;to&nbsp;be&nbsp;sure&nbsp;not&nbsp;to</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3693324">//&nbsp;dial&nbsp;a&nbsp;name&nbsp;that&nbsp;will&nbsp;require&nbsp;a&nbsp;DNS&nbsp;lookup,&nbsp;or&nbsp;Dial&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3693385">//&nbsp;call&nbsp;back&nbsp;here&nbsp;to&nbsp;translate&nbsp;it.&nbsp;The&nbsp;DNS&nbsp;config&nbsp;parser&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3693447">//&nbsp;already&nbsp;checked&nbsp;that&nbsp;all&nbsp;the&nbsp;cfg.servers[i]&nbsp;are&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3693502">//&nbsp;addresses,&nbsp;which&nbsp;Dial&nbsp;will&nbsp;use&nbsp;without&nbsp;a&nbsp;DNS&nbsp;lookup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3693559">c</span><span class="op" id="3693560">,</span>&nbsp;<span class="ident" id="3693562">err</span>&nbsp;<span class="op" id="3693566">:=</span>&nbsp;<span class="ident" id="3693569">d</span><span class="op" id="3693570">.</span><span class="ident" id="3693571">Dial</span><span class="op" id="3693575">(</span><span class="ident" id="3693576">network</span><span class="op" id="3693583">,</span>&nbsp;<span class="ident" id="3693585">server</span><span class="op" id="3693591">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693594">if</span>&nbsp;<span class="ident" id="3693597">err</span>&nbsp;<span class="op" id="3693601">!=</span>&nbsp;<span class="builtintype" id="3693604">nil</span>&nbsp;<span class="op" id="3693608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693612">return</span>&nbsp;<span class="builtintype" id="3693619">nil</span><span class="op" id="3693622">,</span>&nbsp;<span class="ident" id="3693624">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3693629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693632">switch</span>&nbsp;<span class="ident" id="3693639">network</span>&nbsp;<span class="op" id="3693647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693650">case</span>&nbsp;<span class="string" id="3693655">&#34;tcp&#34;</span><span class="op" id="3693660">,</span>&nbsp;<span class="string" id="3693662">&#34;tcp4&#34;</span><span class="op" id="3693668">,</span>&nbsp;<span class="string" id="3693670">&#34;tcp6&#34;</span><span class="op" id="3693676">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693680">return</span>&nbsp;<span class="ident" id="3693687">c</span><span class="op" id="3693688">.</span><span class="op" id="3693689">(</span><span class="op" id="3693690">*</span><span class="ident" id="3693691">TCPConn</span><span class="op" id="3693698">)</span><span class="op" id="3693699">,</span>&nbsp;<span class="builtintype" id="3693701">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693706">case</span>&nbsp;<span class="string" id="3693711">&#34;udp&#34;</span><span class="op" id="3693716">,</span>&nbsp;<span class="string" id="3693718">&#34;udp4&#34;</span><span class="op" id="3693724">,</span>&nbsp;<span class="string" id="3693726">&#34;udp6&#34;</span><span class="op" id="3693732">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3693736">return</span>&nbsp;<span class="ident" id="3693743">c</span><span class="op" id="3693744">.</span><span class="op" id="3693745">(</span><span class="op" id="3693746">*</span><span class="ident" id="3693747">UDPConn</span><span class="op" id="3693754">)</span><span class="op" id="3693755">,</span>&nbsp;<span class="builtintype" id="3693757">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3693762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3693765">panic</span><span class="op" id="3693770">(</span><span class="string" id="3693771">&#34;unreachable&#34;</span><span class="op" id="3693784">)</span><br>
<span class="lineno">120</span><span class="op" id="3693786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3693789">//&nbsp;exchange&nbsp;sends&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;connection&nbsp;and&nbsp;hopes&nbsp;for&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3693859">func</span>&nbsp;<span class="ident" id="3693864">exchange</span><span class="op" id="3693872">(</span><span class="ident" id="3693873">server</span><span class="op" id="3693879">,</span>&nbsp;<span class="ident" id="3693881">name</span>&nbsp;<span class="builtintype" id="3693886">string</span><span class="op" id="3693892">,</span>&nbsp;<span class="ident" id="3693894">qtype</span>&nbsp;<span class="builtintype" id="3693900">uint16</span><span class="op" id="3693906">,</span>&nbsp;<span class="ident" id="3693908">timeout</span>&nbsp;<span class="ident" id="3693916">time</span><span class="op" id="3693920">.</span><span class="ident" id="3693921">Duration</span><span class="op" id="3693929">)</span>&nbsp;<span class="op" id="3693931">(</span><span class="op" id="3693932">*</span><span class="ident" id="3693933">dnsMsg</span><span class="op" id="3693939">,</span>&nbsp;<span class="builtintype" id="3693941">error</span><span class="op" id="3693946">)</span>&nbsp;<span class="op" id="3693948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3693951">d</span>&nbsp;<span class="op" id="3693953">:=</span>&nbsp;<span class="ident" id="3693956">Dialer</span><span class="op" id="3693962">{</span><span class="ident" id="3693963">Timeout</span><span class="op" id="3693970">:</span>&nbsp;<span class="ident" id="3693972">timeout</span><span class="op" id="3693979">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3693982">out</span>&nbsp;<span class="op" id="3693986">:=</span>&nbsp;<span class="ident" id="3693989">dnsMsg</span><span class="op" id="3693995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3693999">dnsMsgHdr</span><span class="op" id="3694008">:</span>&nbsp;<span class="ident" id="3694010">dnsMsgHdr</span><span class="op" id="3694019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3694024">recursion_desired</span><span class="op" id="3694041">:</span>&nbsp;<span class="builtintype" id="3694043">true</span><span class="op" id="3694047">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3694051">}</span><span class="op" id="3694052">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3694056">question</span><span class="op" id="3694064">:</span>&nbsp;<span class="op" id="3694066">[</span><span class="op" id="3694067">]</span><span class="ident" id="3694068">dnsQuestion</span><span class="op" id="3694079">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3694084">{</span><span class="ident" id="3694085">name</span><span class="op" id="3694089">,</span>&nbsp;<span class="ident" id="3694091">qtype</span><span class="op" id="3694096">,</span>&nbsp;<span class="ident" id="3694098">dnsClassINET</span><span class="op" id="3694110">}</span><span class="op" id="3694111">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3694115">}</span><span class="op" id="3694116">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3694119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694122">for</span>&nbsp;<span class="ident" id="3694126">_</span><span class="op" id="3694127">,</span>&nbsp;<span class="ident" id="3694129">network</span>&nbsp;<span class="op" id="3694137">:=</span>&nbsp;<span class="keyword" id="3694140">range</span>&nbsp;<span class="op" id="3694146">[</span><span class="op" id="3694147">]</span><span class="builtintype" id="3694148">string</span><span class="op" id="3694154">{</span><span class="string" id="3694155">&#34;udp&#34;</span><span class="op" id="3694160">,</span>&nbsp;<span class="string" id="3694162">&#34;tcp&#34;</span><span class="op" id="3694167">}</span>&nbsp;<span class="op" id="3694169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3694173">c</span><span class="op" id="3694174">,</span>&nbsp;<span class="ident" id="3694176">err</span>&nbsp;<span class="op" id="3694180">:=</span>&nbsp;<span class="ident" id="3694183">d</span><span class="op" id="3694184">.</span><span class="ident" id="3694185">dialDNS</span><span class="op" id="3694192">(</span><span class="ident" id="3694193">network</span><span class="op" id="3694200">,</span>&nbsp;<span class="ident" id="3694202">server</span><span class="op" id="3694208">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694212">if</span>&nbsp;<span class="ident" id="3694215">err</span>&nbsp;<span class="op" id="3694219">!=</span>&nbsp;<span class="builtintype" id="3694222">nil</span>&nbsp;<span class="op" id="3694226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694231">return</span>&nbsp;<span class="builtintype" id="3694238">nil</span><span class="op" id="3694241">,</span>&nbsp;<span class="ident" id="3694243">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3694249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694253">defer</span>&nbsp;<span class="ident" id="3694259">c</span><span class="op" id="3694260">.</span><span class="ident" id="3694261">Close</span><span class="op" id="3694266">(</span><span class="op" id="3694267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694271">if</span>&nbsp;<span class="ident" id="3694274">timeout</span>&nbsp;<span class="op" id="3694282">&gt;</span>&nbsp;<span class="num" id="3694284">0</span>&nbsp;<span class="op" id="3694286">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3694291">c</span><span class="op" id="3694292">.</span><span class="ident" id="3694293">SetDeadline</span><span class="op" id="3694304">(</span><span class="ident" id="3694305">time</span><span class="op" id="3694309">.</span><span class="ident" id="3694310">Now</span><span class="op" id="3694313">(</span><span class="op" id="3694314">)</span><span class="op" id="3694315">.</span><span class="ident" id="3694316">Add</span><span class="op" id="3694319">(</span><span class="ident" id="3694320">timeout</span><span class="op" id="3694327">)</span><span class="op" id="3694328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3694332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3694336">out</span><span class="op" id="3694339">.</span><span class="ident" id="3694340">id</span>&nbsp;<span class="op" id="3694343">=</span>&nbsp;<span class="builtintype" id="3694345">uint16</span><span class="op" id="3694351">(</span><span class="ident" id="3694352">rand</span><span class="op" id="3694356">.</span><span class="ident" id="3694357">Int</span><span class="op" id="3694360">(</span><span class="op" id="3694361">)</span><span class="op" id="3694362">)</span>&nbsp;<span class="op" id="3694364">^</span>&nbsp;<span class="builtintype" id="3694366">uint16</span><span class="op" id="3694372">(</span><span class="ident" id="3694373">time</span><span class="op" id="3694377">.</span><span class="ident" id="3694378">Now</span><span class="op" id="3694381">(</span><span class="op" id="3694382">)</span><span class="op" id="3694383">.</span><span class="ident" id="3694384">UnixNano</span><span class="op" id="3694392">(</span><span class="op" id="3694393">)</span><span class="op" id="3694394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694398">if</span>&nbsp;<span class="ident" id="3694401">err</span>&nbsp;<span class="op" id="3694405">:=</span>&nbsp;<span class="ident" id="3694408">c</span><span class="op" id="3694409">.</span><span class="ident" id="3694410">writeDNSQuery</span><span class="op" id="3694423">(</span><span class="op" id="3694424">&amp;</span><span class="ident" id="3694425">out</span><span class="op" id="3694428">)</span><span class="op" id="3694429">;</span>&nbsp;<span class="ident" id="3694431">err</span>&nbsp;<span class="op" id="3694435">!=</span>&nbsp;<span class="builtintype" id="3694438">nil</span>&nbsp;<span class="op" id="3694442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694447">return</span>&nbsp;<span class="builtintype" id="3694454">nil</span><span class="op" id="3694457">,</span>&nbsp;<span class="ident" id="3694459">err</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3694465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3694469">in</span><span class="op" id="3694471">,</span>&nbsp;<span class="ident" id="3694473">err</span>&nbsp;<span class="op" id="3694477">:=</span>&nbsp;<span class="ident" id="3694480">c</span><span class="op" id="3694481">.</span><span class="ident" id="3694482">readDNSResponse</span><span class="op" id="3694497">(</span><span class="op" id="3694498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694502">if</span>&nbsp;<span class="ident" id="3694505">err</span>&nbsp;<span class="op" id="3694509">!=</span>&nbsp;<span class="builtintype" id="3694512">nil</span>&nbsp;<span class="op" id="3694516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694521">return</span>&nbsp;<span class="builtintype" id="3694528">nil</span><span class="op" id="3694531">,</span>&nbsp;<span class="ident" id="3694533">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3694539">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694543">if</span>&nbsp;<span class="ident" id="3694546">in</span><span class="op" id="3694548">.</span><span class="ident" id="3694549">id</span>&nbsp;<span class="op" id="3694552">!=</span>&nbsp;<span class="ident" id="3694555">out</span><span class="op" id="3694558">.</span><span class="ident" id="3694559">id</span>&nbsp;<span class="op" id="3694562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694567">return</span>&nbsp;<span class="builtintype" id="3694574">nil</span><span class="op" id="3694577">,</span>&nbsp;<span class="ident" id="3694579">errors</span><span class="op" id="3694585">.</span><span class="ident" id="3694586">New</span><span class="op" id="3694589">(</span><span class="string" id="3694590">&#34;DNS&nbsp;message&nbsp;ID&nbsp;mismatch&#34;</span><span class="op" id="3694615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3694619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694623">if</span>&nbsp;<span class="ident" id="3694626">in</span><span class="op" id="3694628">.</span><span class="ident" id="3694629">truncated</span>&nbsp;<span class="op" id="3694639">{</span>&nbsp;<span class="comment" id="3694641">//&nbsp;see&nbsp;RFC&nbsp;5966</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694660">continue</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3694671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694675">return</span>&nbsp;<span class="ident" id="3694682">in</span><span class="op" id="3694684">,</span>&nbsp;<span class="builtintype" id="3694686">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3694691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694694">return</span>&nbsp;<span class="builtintype" id="3694701">nil</span><span class="op" id="3694704">,</span>&nbsp;<span class="ident" id="3694706">errors</span><span class="op" id="3694712">.</span><span class="ident" id="3694713">New</span><span class="op" id="3694716">(</span><span class="string" id="3694717">&#34;no&nbsp;answer&nbsp;from&nbsp;DNS&nbsp;server&#34;</span><span class="op" id="3694744">)</span><br>
<span class="lineno"></span><span class="op" id="3694746">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3694749">//&nbsp;Do&nbsp;a&nbsp;lookup&nbsp;for&nbsp;a&nbsp;single&nbsp;name,&nbsp;which&nbsp;must&nbsp;be&nbsp;rooted</span><br>
<span class="lineno"></span><span class="comment" id="3694804">//&nbsp;(otherwise&nbsp;answer&nbsp;will&nbsp;not&nbsp;find&nbsp;the&nbsp;answers).</span><br>
<span class="lineno"></span><span class="keyword" id="3694853">func</span>&nbsp;<span class="ident" id="3694858">tryOneName</span><span class="op" id="3694868">(</span><span class="ident" id="3694869">cfg</span>&nbsp;<span class="op" id="3694873">*</span><span class="ident" id="3694874">dnsConfig</span><span class="op" id="3694883">,</span>&nbsp;<span class="ident" id="3694885">name</span>&nbsp;<span class="builtintype" id="3694890">string</span><span class="op" id="3694896">,</span>&nbsp;<span class="ident" id="3694898">qtype</span>&nbsp;<span class="builtintype" id="3694904">uint16</span><span class="op" id="3694910">)</span>&nbsp;<span class="op" id="3694912">(</span><span class="builtintype" id="3694913">string</span><span class="op" id="3694919">,</span>&nbsp;<span class="op" id="3694921">[</span><span class="op" id="3694922">]</span><span class="ident" id="3694923">dnsRR</span><span class="op" id="3694928">,</span>&nbsp;<span class="builtintype" id="3694930">error</span><span class="op" id="3694935">)</span>&nbsp;<span class="op" id="3694937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694940">if</span>&nbsp;<span class="builtinfunc" id="3694943">len</span><span class="op" id="3694946">(</span><span class="ident" id="3694947">cfg</span><span class="op" id="3694950">.</span><span class="ident" id="3694951">servers</span><span class="op" id="3694958">)</span>&nbsp;<span class="op" id="3694960">==</span>&nbsp;<span class="num" id="3694963">0</span>&nbsp;<span class="op" id="3694965">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694969">return</span>&nbsp;<span class="string" id="3694976">&#34;&#34;</span><span class="op" id="3694978">,</span>&nbsp;<span class="builtintype" id="3694980">nil</span><span class="op" id="3694983">,</span>&nbsp;<span class="op" id="3694985">&amp;</span><span class="ident" id="3694986">DNSError</span><span class="op" id="3694994">{</span><span class="ident" id="3694995">Err</span><span class="op" id="3694998">:</span>&nbsp;<span class="string" id="3695000">&#34;no&nbsp;DNS&nbsp;servers&#34;</span><span class="op" id="3695016">,</span>&nbsp;<span class="ident" id="3695018">Name</span><span class="op" id="3695022">:</span>&nbsp;<span class="ident" id="3695024">name</span><span class="op" id="3695028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3695031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3695034">if</span>&nbsp;<span class="builtinfunc" id="3695037">len</span><span class="op" id="3695040">(</span><span class="ident" id="3695041">name</span><span class="op" id="3695045">)</span>&nbsp;<span class="op" id="3695047">&gt;=</span>&nbsp;<span class="num" id="3695050">256</span>&nbsp;<span class="op" id="3695054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3695058">return</span>&nbsp;<span class="string" id="3695065">&#34;&#34;</span><span class="op" id="3695067">,</span>&nbsp;<span class="builtintype" id="3695069">nil</span><span class="op" id="3695072">,</span>&nbsp;<span class="op" id="3695074">&amp;</span><span class="ident" id="3695075">DNSError</span><span class="op" id="3695083">{</span><span class="ident" id="3695084">Err</span><span class="op" id="3695087">:</span>&nbsp;<span class="string" id="3695089">&#34;DNS&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="3695108">,</span>&nbsp;<span class="ident" id="3695110">Name</span><span class="op" id="3695114">:</span>&nbsp;<span class="ident" id="3695116">name</span><span class="op" id="3695120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3695123">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695126">timeout</span>&nbsp;<span class="op" id="3695134">:=</span>&nbsp;<span class="ident" id="3695137">time</span><span class="op" id="3695141">.</span><span class="ident" id="3695142">Duration</span><span class="op" id="3695150">(</span><span class="ident" id="3695151">cfg</span><span class="op" id="3695154">.</span><span class="ident" id="3695155">timeout</span><span class="op" id="3695162">)</span>&nbsp;<span class="op" id="3695164">*</span>&nbsp;<span class="ident" id="3695166">time</span><span class="op" id="3695170">.</span><span class="ident" id="3695171">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3695179">var</span>&nbsp;<span class="ident" id="3695183">lastErr</span>&nbsp;<span class="builtintype" id="3695191">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3695198">for</span>&nbsp;<span class="ident" id="3695202">i</span>&nbsp;<span class="op" id="3695204">:=</span>&nbsp;<span class="num" id="3695207">0</span><span class="op" id="3695208">;</span>&nbsp;<span class="ident" id="3695210">i</span>&nbsp;<span class="op" id="3695212">&lt;</span>&nbsp;<span class="ident" id="3695214">cfg</span><span class="op" id="3695217">.</span><span class="ident" id="3695218">attempts</span><span class="op" id="3695226">;</span>&nbsp;<span class="ident" id="3695228">i</span><span class="op" id="3695229">++</span>&nbsp;<span class="op" id="3695232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3695236">for</span>&nbsp;<span class="ident" id="3695240">_</span><span class="op" id="3695241">,</span>&nbsp;<span class="ident" id="3695243">server</span>&nbsp;<span class="op" id="3695250">:=</span>&nbsp;<span class="keyword" id="3695253">range</span>&nbsp;<span class="ident" id="3695259">cfg</span><span class="op" id="3695262">.</span><span class="ident" id="3695263">servers</span>&nbsp;<span class="op" id="3695271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695276">server</span>&nbsp;<span class="op" id="3695283">=</span>&nbsp;<span class="ident" id="3695285">JoinHostPort</span><span class="op" id="3695297">(</span><span class="ident" id="3695298">server</span><span class="op" id="3695304">,</span>&nbsp;<span class="string" id="3695306">&#34;53&#34;</span><span class="op" id="3695310">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695315">msg</span><span class="op" id="3695318">,</span>&nbsp;<span class="ident" id="3695320">err</span>&nbsp;<span class="op" id="3695324">:=</span>&nbsp;<span class="ident" id="3695327">exchange</span><span class="op" id="3695335">(</span><span class="ident" id="3695336">server</span><span class="op" id="3695342">,</span>&nbsp;<span class="ident" id="3695344">name</span><span class="op" id="3695348">,</span>&nbsp;<span class="ident" id="3695350">qtype</span><span class="op" id="3695355">,</span>&nbsp;<span class="ident" id="3695357">timeout</span><span class="op" id="3695364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3695369">if</span>&nbsp;<span class="ident" id="3695372">err</span>&nbsp;<span class="op" id="3695376">!=</span>&nbsp;<span class="builtintype" id="3695379">nil</span>&nbsp;<span class="op" id="3695383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695389">lastErr</span>&nbsp;<span class="op" id="3695397">=</span>&nbsp;<span class="op" id="3695399">&amp;</span><span class="ident" id="3695400">DNSError</span><span class="op" id="3695408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695415">Err</span><span class="op" id="3695418">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695423">err</span><span class="op" id="3695426">.</span><span class="ident" id="3695427">Error</span><span class="op" id="3695432">(</span><span class="op" id="3695433">)</span><span class="op" id="3695434">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695441">Name</span><span class="op" id="3695445">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3695449">name</span><span class="op" id="3695453">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695460">Server</span><span class="op" id="3695466">:</span>&nbsp;<span class="ident" id="3695468">server</span><span class="op" id="3695474">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3695480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3695486">if</span>&nbsp;<span class="ident" id="3695489">nerr</span><span class="op" id="3695493">,</span>&nbsp;<span class="ident" id="3695495">ok</span>&nbsp;<span class="op" id="3695498">:=</span>&nbsp;<span class="ident" id="3695501">err</span><span class="op" id="3695504">.</span><span class="op" id="3695505">(</span><span class="ident" id="3695506">Error</span><span class="op" id="3695511">)</span><span class="op" id="3695512">;</span>&nbsp;<span class="ident" id="3695514">ok</span>&nbsp;<span class="op" id="3695517">&amp;&amp;</span>&nbsp;<span class="ident" id="3695520">nerr</span><span class="op" id="3695524">.</span><span class="ident" id="3695525">Timeout</span><span class="op" id="3695532">(</span><span class="op" id="3695533">)</span>&nbsp;<span class="op" id="3695535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695542">lastErr</span><span class="op" id="3695549">.</span><span class="op" id="3695550">(</span><span class="op" id="3695551">*</span><span class="ident" id="3695552">DNSError</span><span class="op" id="3695560">)</span><span class="op" id="3695561">.</span><span class="ident" id="3695562">IsTimeout</span>&nbsp;<span class="op" id="3695572">=</span>&nbsp;<span class="builtintype" id="3695574">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3695583">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3695589">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3695601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695606">cname</span><span class="op" id="3695611">,</span>&nbsp;<span class="ident" id="3695613">addrs</span><span class="op" id="3695618">,</span>&nbsp;<span class="ident" id="3695620">err</span>&nbsp;<span class="op" id="3695624">:=</span>&nbsp;<span class="ident" id="3695627">answer</span><span class="op" id="3695633">(</span><span class="ident" id="3695634">name</span><span class="op" id="3695638">,</span>&nbsp;<span class="ident" id="3695640">server</span><span class="op" id="3695646">,</span>&nbsp;<span class="ident" id="3695648">msg</span><span class="op" id="3695651">,</span>&nbsp;<span class="ident" id="3695653">qtype</span><span class="op" id="3695658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3695663">if</span>&nbsp;<span class="ident" id="3695666">err</span>&nbsp;<span class="op" id="3695670">==</span>&nbsp;<span class="builtintype" id="3695673">nil</span>&nbsp;<span class="op" id="3695677">||</span>&nbsp;<span class="ident" id="3695680">err</span><span class="op" id="3695683">.</span><span class="op" id="3695684">(</span><span class="op" id="3695685">*</span><span class="ident" id="3695686">DNSError</span><span class="op" id="3695694">)</span><span class="op" id="3695695">.</span><span class="ident" id="3695696">Err</span>&nbsp;<span class="op" id="3695700">==</span>&nbsp;<span class="ident" id="3695703">noSuchHost</span>&nbsp;<span class="op" id="3695714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3695720">return</span>&nbsp;<span class="ident" id="3695727">cname</span><span class="op" id="3695732">,</span>&nbsp;<span class="ident" id="3695734">addrs</span><span class="op" id="3695739">,</span>&nbsp;<span class="ident" id="3695741">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3695748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695753">lastErr</span>&nbsp;<span class="op" id="3695761">=</span>&nbsp;<span class="ident" id="3695763">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3695769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3695772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3695775">return</span>&nbsp;<span class="string" id="3695782">&#34;&#34;</span><span class="op" id="3695784">,</span>&nbsp;<span class="builtintype" id="3695786">nil</span><span class="op" id="3695789">,</span>&nbsp;<span class="ident" id="3695791">lastErr</span><br>
<span class="lineno">195</span><span class="op" id="3695799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3695802">func</span>&nbsp;<span class="ident" id="3695807">convertRR_A</span><span class="op" id="3695818">(</span><span class="ident" id="3695819">records</span>&nbsp;<span class="op" id="3695827">[</span><span class="op" id="3695828">]</span><span class="ident" id="3695829">dnsRR</span><span class="op" id="3695834">)</span>&nbsp;<span class="op" id="3695836">[</span><span class="op" id="3695837">]</span><span class="ident" id="3695838">IP</span>&nbsp;<span class="op" id="3695841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695844">addrs</span>&nbsp;<span class="op" id="3695850">:=</span>&nbsp;<span class="builtinfunc" id="3695853">make</span><span class="op" id="3695857">(</span><span class="op" id="3695858">[</span><span class="op" id="3695859">]</span><span class="ident" id="3695860">IP</span><span class="op" id="3695862">,</span>&nbsp;<span class="builtinfunc" id="3695864">len</span><span class="op" id="3695867">(</span><span class="ident" id="3695868">records</span><span class="op" id="3695875">)</span><span class="op" id="3695876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3695879">for</span>&nbsp;<span class="ident" id="3695883">i</span><span class="op" id="3695884">,</span>&nbsp;<span class="ident" id="3695886">rr</span>&nbsp;<span class="op" id="3695889">:=</span>&nbsp;<span class="keyword" id="3695892">range</span>&nbsp;<span class="ident" id="3695898">records</span>&nbsp;<span class="op" id="3695906">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695910">a</span>&nbsp;<span class="op" id="3695912">:=</span>&nbsp;<span class="ident" id="3695915">rr</span><span class="op" id="3695917">.</span><span class="op" id="3695918">(</span><span class="op" id="3695919">*</span><span class="ident" id="3695920">dnsRR_A</span><span class="op" id="3695927">)</span><span class="op" id="3695928">.</span><span class="ident" id="3695929">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3695933">addrs</span><span class="op" id="3695938">[</span><span class="ident" id="3695939">i</span><span class="op" id="3695940">]</span>&nbsp;<span class="op" id="3695942">=</span>&nbsp;<span class="ident" id="3695944">IPv4</span><span class="op" id="3695948">(</span><span class="builtintype" id="3695949">byte</span><span class="op" id="3695953">(</span><span class="ident" id="3695954">a</span><span class="op" id="3695955">&gt;&gt;</span><span class="num" id="3695957">24</span><span class="op" id="3695959">)</span><span class="op" id="3695960">,</span>&nbsp;<span class="builtintype" id="3695962">byte</span><span class="op" id="3695966">(</span><span class="ident" id="3695967">a</span><span class="op" id="3695968">&gt;&gt;</span><span class="num" id="3695970">16</span><span class="op" id="3695972">)</span><span class="op" id="3695973">,</span>&nbsp;<span class="builtintype" id="3695975">byte</span><span class="op" id="3695979">(</span><span class="ident" id="3695980">a</span><span class="op" id="3695981">&gt;&gt;</span><span class="num" id="3695983">8</span><span class="op" id="3695984">)</span><span class="op" id="3695985">,</span>&nbsp;<span class="builtintype" id="3695987">byte</span><span class="op" id="3695991">(</span><span class="ident" id="3695992">a</span><span class="op" id="3695993">)</span><span class="op" id="3695994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3695997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3696000">return</span>&nbsp;<span class="ident" id="3696007">addrs</span><br>
<span class="lineno"></span><span class="op" id="3696013">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="3696016">func</span>&nbsp;<span class="ident" id="3696021">convertRR_AAAA</span><span class="op" id="3696035">(</span><span class="ident" id="3696036">records</span>&nbsp;<span class="op" id="3696044">[</span><span class="op" id="3696045">]</span><span class="ident" id="3696046">dnsRR</span><span class="op" id="3696051">)</span>&nbsp;<span class="op" id="3696053">[</span><span class="op" id="3696054">]</span><span class="ident" id="3696055">IP</span>&nbsp;<span class="op" id="3696058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696061">addrs</span>&nbsp;<span class="op" id="3696067">:=</span>&nbsp;<span class="builtinfunc" id="3696070">make</span><span class="op" id="3696074">(</span><span class="op" id="3696075">[</span><span class="op" id="3696076">]</span><span class="ident" id="3696077">IP</span><span class="op" id="3696079">,</span>&nbsp;<span class="builtinfunc" id="3696081">len</span><span class="op" id="3696084">(</span><span class="ident" id="3696085">records</span><span class="op" id="3696092">)</span><span class="op" id="3696093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3696096">for</span>&nbsp;<span class="ident" id="3696100">i</span><span class="op" id="3696101">,</span>&nbsp;<span class="ident" id="3696103">rr</span>&nbsp;<span class="op" id="3696106">:=</span>&nbsp;<span class="keyword" id="3696109">range</span>&nbsp;<span class="ident" id="3696115">records</span>&nbsp;<span class="op" id="3696123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696127">a</span>&nbsp;<span class="op" id="3696129">:=</span>&nbsp;<span class="builtinfunc" id="3696132">make</span><span class="op" id="3696136">(</span><span class="ident" id="3696137">IP</span><span class="op" id="3696139">,</span>&nbsp;<span class="ident" id="3696141">IPv6len</span><span class="op" id="3696148">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3696152">copy</span><span class="op" id="3696156">(</span><span class="ident" id="3696157">a</span><span class="op" id="3696158">,</span>&nbsp;<span class="ident" id="3696160">rr</span><span class="op" id="3696162">.</span><span class="op" id="3696163">(</span><span class="op" id="3696164">*</span><span class="ident" id="3696165">dnsRR_AAAA</span><span class="op" id="3696175">)</span><span class="op" id="3696176">.</span><span class="ident" id="3696177">AAAA</span><span class="op" id="3696181">[</span><span class="op" id="3696182">:</span><span class="op" id="3696183">]</span><span class="op" id="3696184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696188">addrs</span><span class="op" id="3696193">[</span><span class="ident" id="3696194">i</span><span class="op" id="3696195">]</span>&nbsp;<span class="op" id="3696197">=</span>&nbsp;<span class="ident" id="3696199">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3696202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3696205">return</span>&nbsp;<span class="ident" id="3696212">addrs</span><br>
<span class="lineno"></span><span class="op" id="3696218">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="3696221">var</span>&nbsp;<span class="ident" id="3696225">cfg</span>&nbsp;<span class="keyword" id="3696229">struct</span>&nbsp;<span class="op" id="3696236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696239">ch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3696249">chan</span>&nbsp;<span class="keyword" id="3696254">struct</span><span class="op" id="3696260">{</span><span class="op" id="3696261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696264">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696274">sync</span><span class="op" id="3696278">.</span><span class="ident" id="3696279">RWMutex</span>&nbsp;<span class="comment" id="3696287">//&nbsp;protects&nbsp;dnsConfig&nbsp;and&nbsp;dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696321">dnsConfig</span>&nbsp;<span class="op" id="3696331">*</span><span class="ident" id="3696332">dnsConfig</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696343">dnserr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3696353">error</span><br>
<span class="lineno"></span><span class="op" id="3696359">}</span><br>
<span class="lineno"></span><span class="keyword" id="3696361">var</span>&nbsp;<span class="ident" id="3696365">onceLoadConfig</span>&nbsp;<span class="ident" id="3696380">sync</span><span class="op" id="3696384">.</span><span class="ident" id="3696385">Once</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3696391">//&nbsp;Assume&nbsp;dns&nbsp;config&nbsp;file&nbsp;is&nbsp;/etc/resolv.conf&nbsp;here</span><br>
<span class="lineno">225</span><span class="keyword" id="3696442">func</span>&nbsp;<span class="ident" id="3696447">loadDefaultConfig</span><span class="op" id="3696464">(</span><span class="op" id="3696465">)</span>&nbsp;<span class="op" id="3696467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696470">loadConfig</span><span class="op" id="3696480">(</span><span class="string" id="3696481">&#34;/etc/resolv.conf&#34;</span><span class="op" id="3696499">,</span>&nbsp;<span class="num" id="3696501">5</span><span class="op" id="3696502">*</span><span class="ident" id="3696503">time</span><span class="op" id="3696507">.</span><span class="ident" id="3696508">Second</span><span class="op" id="3696514">,</span>&nbsp;<span class="builtintype" id="3696516">nil</span><span class="op" id="3696519">)</span><br>
<span class="lineno"></span><span class="op" id="3696521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3696524">func</span>&nbsp;<span class="ident" id="3696529">loadConfig</span><span class="op" id="3696539">(</span><span class="ident" id="3696540">resolvConfPath</span>&nbsp;<span class="builtintype" id="3696555">string</span><span class="op" id="3696561">,</span>&nbsp;<span class="ident" id="3696563">reloadTime</span>&nbsp;<span class="ident" id="3696574">time</span><span class="op" id="3696578">.</span><span class="ident" id="3696579">Duration</span><span class="op" id="3696587">,</span>&nbsp;<span class="ident" id="3696589">quit</span>&nbsp;<span class="op" id="3696594">&lt;-</span><span class="keyword" id="3696596">chan</span>&nbsp;<span class="keyword" id="3696601">chan</span>&nbsp;<span class="keyword" id="3696606">struct</span><span class="op" id="3696612">{</span><span class="op" id="3696613">}</span><span class="op" id="3696614">)</span>&nbsp;<span class="op" id="3696616">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3696619">var</span>&nbsp;<span class="ident" id="3696623">mtime</span>&nbsp;<span class="ident" id="3696629">time</span><span class="op" id="3696633">.</span><span class="ident" id="3696634">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696640">cfg</span><span class="op" id="3696643">.</span><span class="ident" id="3696644">ch</span>&nbsp;<span class="op" id="3696647">=</span>&nbsp;<span class="builtinfunc" id="3696649">make</span><span class="op" id="3696653">(</span><span class="keyword" id="3696654">chan</span>&nbsp;<span class="keyword" id="3696659">struct</span><span class="op" id="3696665">{</span><span class="op" id="3696666">}</span><span class="op" id="3696667">,</span>&nbsp;<span class="num" id="3696669">1</span><span class="op" id="3696670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3696673">if</span>&nbsp;<span class="ident" id="3696676">fi</span><span class="op" id="3696678">,</span>&nbsp;<span class="ident" id="3696680">err</span>&nbsp;<span class="op" id="3696684">:=</span>&nbsp;<span class="ident" id="3696687">os</span><span class="op" id="3696689">.</span><span class="ident" id="3696690">Stat</span><span class="op" id="3696694">(</span><span class="ident" id="3696695">resolvConfPath</span><span class="op" id="3696709">)</span><span class="op" id="3696710">;</span>&nbsp;<span class="ident" id="3696712">err</span>&nbsp;<span class="op" id="3696716">!=</span>&nbsp;<span class="builtintype" id="3696719">nil</span>&nbsp;<span class="op" id="3696723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696727">cfg</span><span class="op" id="3696730">.</span><span class="ident" id="3696731">dnserr</span>&nbsp;<span class="op" id="3696738">=</span>&nbsp;<span class="ident" id="3696740">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3696745">}</span>&nbsp;<span class="keyword" id="3696747">else</span>&nbsp;<span class="op" id="3696752">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696756">mtime</span>&nbsp;<span class="op" id="3696762">=</span>&nbsp;<span class="ident" id="3696764">fi</span><span class="op" id="3696766">.</span><span class="ident" id="3696767">ModTime</span><span class="op" id="3696774">(</span><span class="op" id="3696775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696779">cfg</span><span class="op" id="3696782">.</span><span class="ident" id="3696783">dnsConfig</span><span class="op" id="3696792">,</span>&nbsp;<span class="ident" id="3696794">cfg</span><span class="op" id="3696797">.</span><span class="ident" id="3696798">dnserr</span>&nbsp;<span class="op" id="3696805">=</span>&nbsp;<span class="ident" id="3696807">dnsReadConfig</span><span class="op" id="3696820">(</span><span class="ident" id="3696821">resolvConfPath</span><span class="op" id="3696835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3696838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3696841">go</span>&nbsp;<span class="keyword" id="3696844">func</span><span class="op" id="3696848">(</span><span class="op" id="3696849">)</span>&nbsp;<span class="op" id="3696851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3696855">for</span>&nbsp;<span class="op" id="3696859">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696864">time</span><span class="op" id="3696868">.</span><span class="ident" id="3696869">Sleep</span><span class="op" id="3696874">(</span><span class="ident" id="3696875">reloadTime</span><span class="op" id="3696885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3696890">select</span>&nbsp;<span class="op" id="3696897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3696902">case</span>&nbsp;<span class="ident" id="3696907">qresp</span>&nbsp;<span class="op" id="3696913">:=</span>&nbsp;<span class="op" id="3696916">&lt;-</span><span class="ident" id="3696918">quit</span><span class="op" id="3696922">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696928">qresp</span>&nbsp;<span class="op" id="3696934">&lt;-</span>&nbsp;<span class="keyword" id="3696937">struct</span><span class="op" id="3696943">{</span><span class="op" id="3696944">}</span><span class="op" id="3696945">{</span><span class="op" id="3696946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3696952">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3696962">case</span>&nbsp;<span class="op" id="3696967">&lt;-</span><span class="ident" id="3696969">cfg</span><span class="op" id="3696972">.</span><span class="ident" id="3696973">ch</span><span class="op" id="3696975">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3696980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3696986">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3697038">fi</span><span class="op" id="3697040">,</span>&nbsp;<span class="ident" id="3697042">err</span>&nbsp;<span class="op" id="3697046">:=</span>&nbsp;<span class="ident" id="3697049">os</span><span class="op" id="3697051">.</span><span class="ident" id="3697052">Stat</span><span class="op" id="3697056">(</span><span class="ident" id="3697057">resolvConfPath</span><span class="op" id="3697071">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697076">if</span>&nbsp;<span class="ident" id="3697079">err</span>&nbsp;<span class="op" id="3697083">!=</span>&nbsp;<span class="builtintype" id="3697086">nil</span>&nbsp;<span class="op" id="3697090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697096">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3697113">//&nbsp;If&nbsp;the&nbsp;resolv.conf&nbsp;mtime&nbsp;didn&#39;t&nbsp;change,&nbsp;do&nbsp;not&nbsp;reload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3697173">m</span>&nbsp;<span class="op" id="3697175">:=</span>&nbsp;<span class="ident" id="3697178">fi</span><span class="op" id="3697180">.</span><span class="ident" id="3697181">ModTime</span><span class="op" id="3697188">(</span><span class="op" id="3697189">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697194">if</span>&nbsp;<span class="ident" id="3697197">m</span><span class="op" id="3697198">.</span><span class="ident" id="3697199">Equal</span><span class="op" id="3697204">(</span><span class="ident" id="3697205">mtime</span><span class="op" id="3697210">)</span>&nbsp;<span class="op" id="3697212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697218">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3697235">mtime</span>&nbsp;<span class="op" id="3697241">=</span>&nbsp;<span class="ident" id="3697243">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3697248">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3697300">ncfg</span><span class="op" id="3697304">,</span>&nbsp;<span class="ident" id="3697306">err</span>&nbsp;<span class="op" id="3697310">:=</span>&nbsp;<span class="ident" id="3697313">dnsReadConfig</span><span class="op" id="3697326">(</span><span class="ident" id="3697327">resolvConfPath</span><span class="op" id="3697341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697346">if</span>&nbsp;<span class="ident" id="3697349">err</span>&nbsp;<span class="op" id="3697353">!=</span>&nbsp;<span class="builtintype" id="3697356">nil</span>&nbsp;<span class="op" id="3697360">||</span>&nbsp;<span class="builtinfunc" id="3697363">len</span><span class="op" id="3697366">(</span><span class="ident" id="3697367">ncfg</span><span class="op" id="3697371">.</span><span class="ident" id="3697372">servers</span><span class="op" id="3697379">)</span>&nbsp;<span class="op" id="3697381">==</span>&nbsp;<span class="num" id="3697384">0</span>&nbsp;<span class="op" id="3697386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697392">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3697409">cfg</span><span class="op" id="3697412">.</span><span class="ident" id="3697413">mu</span><span class="op" id="3697415">.</span><span class="ident" id="3697416">Lock</span><span class="op" id="3697420">(</span><span class="op" id="3697421">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3697426">cfg</span><span class="op" id="3697429">.</span><span class="ident" id="3697430">dnsConfig</span>&nbsp;<span class="op" id="3697440">=</span>&nbsp;<span class="ident" id="3697442">ncfg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3697450">cfg</span><span class="op" id="3697453">.</span><span class="ident" id="3697454">dnserr</span>&nbsp;<span class="op" id="3697461">=</span>&nbsp;<span class="builtintype" id="3697463">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3697470">cfg</span><span class="op" id="3697473">.</span><span class="ident" id="3697474">mu</span><span class="op" id="3697476">.</span><span class="ident" id="3697477">Unlock</span><span class="op" id="3697483">(</span><span class="op" id="3697484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697491">}</span><span class="op" id="3697492">(</span><span class="op" id="3697493">)</span><br>
<span class="lineno">270</span><span class="op" id="3697495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3697498">func</span>&nbsp;<span class="ident" id="3697503">lookup</span><span class="op" id="3697509">(</span><span class="ident" id="3697510">name</span>&nbsp;<span class="builtintype" id="3697515">string</span><span class="op" id="3697521">,</span>&nbsp;<span class="ident" id="3697523">qtype</span>&nbsp;<span class="builtintype" id="3697529">uint16</span><span class="op" id="3697535">)</span>&nbsp;<span class="op" id="3697537">(</span><span class="ident" id="3697538">cname</span>&nbsp;<span class="builtintype" id="3697544">string</span><span class="op" id="3697550">,</span>&nbsp;<span class="ident" id="3697552">addrs</span>&nbsp;<span class="op" id="3697558">[</span><span class="op" id="3697559">]</span><span class="ident" id="3697560">dnsRR</span><span class="op" id="3697565">,</span>&nbsp;<span class="ident" id="3697567">err</span>&nbsp;<span class="builtintype" id="3697571">error</span><span class="op" id="3697576">)</span>&nbsp;<span class="op" id="3697578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697581">if</span>&nbsp;<span class="op" id="3697584">!</span><span class="ident" id="3697585">isDomainName</span><span class="op" id="3697597">(</span><span class="ident" id="3697598">name</span><span class="op" id="3697602">)</span>&nbsp;<span class="op" id="3697604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697608">return</span>&nbsp;<span class="ident" id="3697615">name</span><span class="op" id="3697619">,</span>&nbsp;<span class="builtintype" id="3697621">nil</span><span class="op" id="3697624">,</span>&nbsp;<span class="op" id="3697626">&amp;</span><span class="ident" id="3697627">DNSError</span><span class="op" id="3697635">{</span><span class="ident" id="3697636">Err</span><span class="op" id="3697639">:</span>&nbsp;<span class="string" id="3697641">&#34;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="3697662">,</span>&nbsp;<span class="ident" id="3697664">Name</span><span class="op" id="3697668">:</span>&nbsp;<span class="ident" id="3697670">name</span><span class="op" id="3697674">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3697680">onceLoadConfig</span><span class="op" id="3697694">.</span><span class="ident" id="3697695">Do</span><span class="op" id="3697697">(</span><span class="ident" id="3697698">loadDefaultConfig</span><span class="op" id="3697715">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697719">select</span>&nbsp;<span class="op" id="3697726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697729">case</span>&nbsp;<span class="ident" id="3697734">cfg</span><span class="op" id="3697737">.</span><span class="ident" id="3697738">ch</span>&nbsp;<span class="op" id="3697741">&lt;-</span>&nbsp;<span class="keyword" id="3697744">struct</span><span class="op" id="3697750">{</span><span class="op" id="3697751">}</span><span class="op" id="3697752">{</span><span class="op" id="3697753">}</span><span class="op" id="3697754">:</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697757">default</span><span class="op" id="3697764">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3697771">cfg</span><span class="op" id="3697774">.</span><span class="ident" id="3697775">mu</span><span class="op" id="3697777">.</span><span class="ident" id="3697778">RLock</span><span class="op" id="3697783">(</span><span class="op" id="3697784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697787">defer</span>&nbsp;<span class="ident" id="3697793">cfg</span><span class="op" id="3697796">.</span><span class="ident" id="3697797">mu</span><span class="op" id="3697799">.</span><span class="ident" id="3697800">RUnlock</span><span class="op" id="3697807">(</span><span class="op" id="3697808">)</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697812">if</span>&nbsp;<span class="ident" id="3697815">cfg</span><span class="op" id="3697818">.</span><span class="ident" id="3697819">dnserr</span>&nbsp;<span class="op" id="3697826">!=</span>&nbsp;<span class="builtintype" id="3697829">nil</span>&nbsp;<span class="op" id="3697833">||</span>&nbsp;<span class="ident" id="3697836">cfg</span><span class="op" id="3697839">.</span><span class="ident" id="3697840">dnsConfig</span>&nbsp;<span class="op" id="3697850">==</span>&nbsp;<span class="builtintype" id="3697853">nil</span>&nbsp;<span class="op" id="3697857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3697861">err</span>&nbsp;<span class="op" id="3697865">=</span>&nbsp;<span class="ident" id="3697867">cfg</span><span class="op" id="3697870">.</span><span class="ident" id="3697871">dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3697880">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3697888">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3697891">//&nbsp;If&nbsp;name&nbsp;is&nbsp;rooted&nbsp;(trailing&nbsp;dot)&nbsp;or&nbsp;has&nbsp;enough&nbsp;dots,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3697948">//&nbsp;try&nbsp;it&nbsp;by&nbsp;itself&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3697976">rooted</span>&nbsp;<span class="op" id="3697983">:=</span>&nbsp;<span class="builtinfunc" id="3697986">len</span><span class="op" id="3697989">(</span><span class="ident" id="3697990">name</span><span class="op" id="3697994">)</span>&nbsp;<span class="op" id="3697996">&gt;</span>&nbsp;<span class="num" id="3697998">0</span>&nbsp;<span class="op" id="3698000">&amp;&amp;</span>&nbsp;<span class="ident" id="3698003">name</span><span class="op" id="3698007">[</span><span class="builtinfunc" id="3698008">len</span><span class="op" id="3698011">(</span><span class="ident" id="3698012">name</span><span class="op" id="3698016">)</span><span class="op" id="3698017">-</span><span class="num" id="3698018">1</span><span class="op" id="3698019">]</span>&nbsp;<span class="op" id="3698021">==</span>&nbsp;<span class="string" id="3698024">&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3698029">if</span>&nbsp;<span class="ident" id="3698032">rooted</span>&nbsp;<span class="op" id="3698039">||</span>&nbsp;<span class="ident" id="3698042">count</span><span class="op" id="3698047">(</span><span class="ident" id="3698048">name</span><span class="op" id="3698052">,</span>&nbsp;<span class="string" id="3698054">&#39;.&#39;</span><span class="op" id="3698057">)</span>&nbsp;<span class="op" id="3698059">&gt;=</span>&nbsp;<span class="ident" id="3698062">cfg</span><span class="op" id="3698065">.</span><span class="ident" id="3698066">dnsConfig</span><span class="op" id="3698075">.</span><span class="ident" id="3698076">ndots</span>&nbsp;<span class="op" id="3698082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3698086">rname</span>&nbsp;<span class="op" id="3698092">:=</span>&nbsp;<span class="ident" id="3698095">name</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3698102">if</span>&nbsp;<span class="op" id="3698105">!</span><span class="ident" id="3698106">rooted</span>&nbsp;<span class="op" id="3698113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3698118">rname</span>&nbsp;<span class="op" id="3698124">+=</span>&nbsp;<span class="string" id="3698127">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3698133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3698137">//&nbsp;Can&nbsp;try&nbsp;as&nbsp;ordinary&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3698168">cname</span><span class="op" id="3698173">,</span>&nbsp;<span class="ident" id="3698175">addrs</span><span class="op" id="3698180">,</span>&nbsp;<span class="ident" id="3698182">err</span>&nbsp;<span class="op" id="3698186">=</span>&nbsp;<span class="ident" id="3698188">tryOneName</span><span class="op" id="3698198">(</span><span class="ident" id="3698199">cfg</span><span class="op" id="3698202">.</span><span class="ident" id="3698203">dnsConfig</span><span class="op" id="3698212">,</span>&nbsp;<span class="ident" id="3698214">rname</span><span class="op" id="3698219">,</span>&nbsp;<span class="ident" id="3698221">qtype</span><span class="op" id="3698226">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3698230">if</span>&nbsp;<span class="ident" id="3698233">rooted</span>&nbsp;<span class="op" id="3698240">||</span>&nbsp;<span class="ident" id="3698243">err</span>&nbsp;<span class="op" id="3698247">==</span>&nbsp;<span class="builtintype" id="3698250">nil</span>&nbsp;<span class="op" id="3698254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3698259">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3698268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3698271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3698275">//&nbsp;Otherwise,&nbsp;try&nbsp;suffixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3698304">for</span>&nbsp;<span class="ident" id="3698308">i</span>&nbsp;<span class="op" id="3698310">:=</span>&nbsp;<span class="num" id="3698313">0</span><span class="op" id="3698314">;</span>&nbsp;<span class="ident" id="3698316">i</span>&nbsp;<span class="op" id="3698318">&lt;</span>&nbsp;<span class="builtinfunc" id="3698320">len</span><span class="op" id="3698323">(</span><span class="ident" id="3698324">cfg</span><span class="op" id="3698327">.</span><span class="ident" id="3698328">dnsConfig</span><span class="op" id="3698337">.</span><span class="ident" id="3698338">search</span><span class="op" id="3698344">)</span><span class="op" id="3698345">;</span>&nbsp;<span class="ident" id="3698347">i</span><span class="op" id="3698348">++</span>&nbsp;<span class="op" id="3698351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3698355">rname</span>&nbsp;<span class="op" id="3698361">:=</span>&nbsp;<span class="ident" id="3698364">name</span>&nbsp;<span class="op" id="3698369">+</span>&nbsp;<span class="string" id="3698371">&#34;.&#34;</span>&nbsp;<span class="op" id="3698375">+</span>&nbsp;<span class="ident" id="3698377">cfg</span><span class="op" id="3698380">.</span><span class="ident" id="3698381">dnsConfig</span><span class="op" id="3698390">.</span><span class="ident" id="3698391">search</span><span class="op" id="3698397">[</span><span class="ident" id="3698398">i</span><span class="op" id="3698399">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3698403">if</span>&nbsp;<span class="ident" id="3698406">rname</span><span class="op" id="3698411">[</span><span class="builtinfunc" id="3698412">len</span><span class="op" id="3698415">(</span><span class="ident" id="3698416">rname</span><span class="op" id="3698421">)</span><span class="op" id="3698422">-</span><span class="num" id="3698423">1</span><span class="op" id="3698424">]</span>&nbsp;<span class="op" id="3698426">!=</span>&nbsp;<span class="string" id="3698429">&#39;.&#39;</span>&nbsp;<span class="op" id="3698433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3698438">rname</span>&nbsp;<span class="op" id="3698444">+=</span>&nbsp;<span class="string" id="3698447">&#34;.&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3698453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3698457">cname</span><span class="op" id="3698462">,</span>&nbsp;<span class="ident" id="3698464">addrs</span><span class="op" id="3698469">,</span>&nbsp;<span class="ident" id="3698471">err</span>&nbsp;<span class="op" id="3698475">=</span>&nbsp;<span class="ident" id="3698477">tryOneName</span><span class="op" id="3698487">(</span><span class="ident" id="3698488">cfg</span><span class="op" id="3698491">.</span><span class="ident" id="3698492">dnsConfig</span><span class="op" id="3698501">,</span>&nbsp;<span class="ident" id="3698503">rname</span><span class="op" id="3698508">,</span>&nbsp;<span class="ident" id="3698510">qtype</span><span class="op" id="3698515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3698519">if</span>&nbsp;<span class="ident" id="3698522">err</span>&nbsp;<span class="op" id="3698526">==</span>&nbsp;<span class="builtintype" id="3698529">nil</span>&nbsp;<span class="op" id="3698533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3698538">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3698547">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3698550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3698554">//&nbsp;Last&nbsp;ditch&nbsp;effort:&nbsp;try&nbsp;unsuffixed&nbsp;only&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3698620">//&nbsp;that&nbsp;is,&nbsp;name&nbsp;is&nbsp;not&nbsp;rooted&nbsp;and&nbsp;has&nbsp;less&nbsp;than&nbsp;ndots&nbsp;dots.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3698682">if</span>&nbsp;<span class="ident" id="3698685">count</span><span class="op" id="3698690">(</span><span class="ident" id="3698691">name</span><span class="op" id="3698695">,</span>&nbsp;<span class="string" id="3698697">&#39;.&#39;</span><span class="op" id="3698700">)</span>&nbsp;<span class="op" id="3698702">&lt;</span>&nbsp;<span class="ident" id="3698704">cfg</span><span class="op" id="3698707">.</span><span class="ident" id="3698708">dnsConfig</span><span class="op" id="3698717">.</span><span class="ident" id="3698718">ndots</span>&nbsp;<span class="op" id="3698724">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3698728">cname</span><span class="op" id="3698733">,</span>&nbsp;<span class="ident" id="3698735">addrs</span><span class="op" id="3698740">,</span>&nbsp;<span class="ident" id="3698742">err</span>&nbsp;<span class="op" id="3698746">=</span>&nbsp;<span class="ident" id="3698748">tryOneName</span><span class="op" id="3698758">(</span><span class="ident" id="3698759">cfg</span><span class="op" id="3698762">.</span><span class="ident" id="3698763">dnsConfig</span><span class="op" id="3698772">,</span>&nbsp;<span class="ident" id="3698774">name</span><span class="op" id="3698778">+</span><span class="string" id="3698779">&#34;.&#34;</span><span class="op" id="3698782">,</span>&nbsp;<span class="ident" id="3698784">qtype</span><span class="op" id="3698789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3698793">if</span>&nbsp;<span class="ident" id="3698796">err</span>&nbsp;<span class="op" id="3698800">==</span>&nbsp;<span class="builtintype" id="3698803">nil</span>&nbsp;<span class="op" id="3698807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3698812">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3698821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3698824">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3698828">if</span>&nbsp;<span class="ident" id="3698831">e</span><span class="op" id="3698832">,</span>&nbsp;<span class="ident" id="3698834">ok</span>&nbsp;<span class="op" id="3698837">:=</span>&nbsp;<span class="ident" id="3698840">err</span><span class="op" id="3698843">.</span><span class="op" id="3698844">(</span><span class="op" id="3698845">*</span><span class="ident" id="3698846">DNSError</span><span class="op" id="3698854">)</span><span class="op" id="3698855">;</span>&nbsp;<span class="ident" id="3698857">ok</span>&nbsp;<span class="op" id="3698860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3698864">//&nbsp;Show&nbsp;original&nbsp;name&nbsp;passed&nbsp;to&nbsp;lookup,&nbsp;not&nbsp;suffixed&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3698924">//&nbsp;In&nbsp;general&nbsp;we&nbsp;might&nbsp;have&nbsp;tried&nbsp;many&nbsp;suffixes;&nbsp;showing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3698983">//&nbsp;just&nbsp;one&nbsp;is&nbsp;misleading.&nbsp;See&nbsp;also&nbsp;golang.org/issue/6324.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3699044">e</span><span class="op" id="3699045">.</span><span class="ident" id="3699046">Name</span>&nbsp;<span class="op" id="3699051">=</span>&nbsp;<span class="ident" id="3699053">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3699059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3699062">return</span><br>
<span class="lineno"></span><span class="op" id="3699069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="3699072">//&nbsp;goLookupHost&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupHost.</span><br>
<span class="lineno"></span><span class="comment" id="3699135">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3699195">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3699259">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3699320">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">340</span><span class="comment" id="3699383">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3699395">func</span>&nbsp;<span class="ident" id="3699400">goLookupHost</span><span class="op" id="3699412">(</span><span class="ident" id="3699413">name</span>&nbsp;<span class="builtintype" id="3699418">string</span><span class="op" id="3699424">)</span>&nbsp;<span class="op" id="3699426">(</span><span class="ident" id="3699427">addrs</span>&nbsp;<span class="op" id="3699433">[</span><span class="op" id="3699434">]</span><span class="builtintype" id="3699435">string</span><span class="op" id="3699441">,</span>&nbsp;<span class="ident" id="3699443">err</span>&nbsp;<span class="builtintype" id="3699447">error</span><span class="op" id="3699452">)</span>&nbsp;<span class="op" id="3699454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3699457">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;they&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3699504">addrs</span>&nbsp;<span class="op" id="3699510">=</span>&nbsp;<span class="ident" id="3699512">lookupStaticHost</span><span class="op" id="3699528">(</span><span class="ident" id="3699529">name</span><span class="op" id="3699533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3699536">if</span>&nbsp;<span class="builtinfunc" id="3699539">len</span><span class="op" id="3699542">(</span><span class="ident" id="3699543">addrs</span><span class="op" id="3699548">)</span>&nbsp;<span class="op" id="3699550">&gt;</span>&nbsp;<span class="num" id="3699552">0</span>&nbsp;<span class="op" id="3699554">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3699558">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3699566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3699569">ips</span><span class="op" id="3699572">,</span>&nbsp;<span class="ident" id="3699574">err</span>&nbsp;<span class="op" id="3699578">:=</span>&nbsp;<span class="ident" id="3699581">goLookupIP</span><span class="op" id="3699591">(</span><span class="ident" id="3699592">name</span><span class="op" id="3699596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3699599">if</span>&nbsp;<span class="ident" id="3699602">err</span>&nbsp;<span class="op" id="3699606">!=</span>&nbsp;<span class="builtintype" id="3699609">nil</span>&nbsp;<span class="op" id="3699613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3699617">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3699625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3699628">addrs</span>&nbsp;<span class="op" id="3699634">=</span>&nbsp;<span class="builtinfunc" id="3699636">make</span><span class="op" id="3699640">(</span><span class="op" id="3699641">[</span><span class="op" id="3699642">]</span><span class="builtintype" id="3699643">string</span><span class="op" id="3699649">,</span>&nbsp;<span class="num" id="3699651">0</span><span class="op" id="3699652">,</span>&nbsp;<span class="builtinfunc" id="3699654">len</span><span class="op" id="3699657">(</span><span class="ident" id="3699658">ips</span><span class="op" id="3699661">)</span><span class="op" id="3699662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3699665">for</span>&nbsp;<span class="ident" id="3699669">_</span><span class="op" id="3699670">,</span>&nbsp;<span class="ident" id="3699672">ip</span>&nbsp;<span class="op" id="3699675">:=</span>&nbsp;<span class="keyword" id="3699678">range</span>&nbsp;<span class="ident" id="3699684">ips</span>&nbsp;<span class="op" id="3699688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3699692">addrs</span>&nbsp;<span class="op" id="3699698">=</span>&nbsp;<span class="builtinfunc" id="3699700">append</span><span class="op" id="3699706">(</span><span class="ident" id="3699707">addrs</span><span class="op" id="3699712">,</span>&nbsp;<span class="ident" id="3699714">ip</span><span class="op" id="3699716">.</span><span class="ident" id="3699717">String</span><span class="op" id="3699723">(</span><span class="op" id="3699724">)</span><span class="op" id="3699725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3699728">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3699731">return</span><br>
<span class="lineno"></span><span class="op" id="3699738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3699741">//&nbsp;goLookupIP&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupIP.</span><br>
<span class="lineno"></span><span class="comment" id="3699800">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno">360</span><span class="comment" id="3699858">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3699920">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3699981">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3700044">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3700056">func</span>&nbsp;<span class="ident" id="3700061">goLookupIP</span><span class="op" id="3700071">(</span><span class="ident" id="3700072">name</span>&nbsp;<span class="builtintype" id="3700077">string</span><span class="op" id="3700083">)</span>&nbsp;<span class="op" id="3700085">(</span><span class="ident" id="3700086">addrs</span>&nbsp;<span class="op" id="3700092">[</span><span class="op" id="3700093">]</span><span class="ident" id="3700094">IP</span><span class="op" id="3700096">,</span>&nbsp;<span class="ident" id="3700098">err</span>&nbsp;<span class="builtintype" id="3700102">error</span><span class="op" id="3700107">)</span>&nbsp;<span class="op" id="3700109">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3700112">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3700157">haddrs</span>&nbsp;<span class="op" id="3700164">:=</span>&nbsp;<span class="ident" id="3700167">lookupStaticHost</span><span class="op" id="3700183">(</span><span class="ident" id="3700184">name</span><span class="op" id="3700188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700191">if</span>&nbsp;<span class="builtinfunc" id="3700194">len</span><span class="op" id="3700197">(</span><span class="ident" id="3700198">haddrs</span><span class="op" id="3700204">)</span>&nbsp;<span class="op" id="3700206">&gt;</span>&nbsp;<span class="num" id="3700208">0</span>&nbsp;<span class="op" id="3700210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700214">for</span>&nbsp;<span class="ident" id="3700218">_</span><span class="op" id="3700219">,</span>&nbsp;<span class="ident" id="3700221">haddr</span>&nbsp;<span class="op" id="3700227">:=</span>&nbsp;<span class="keyword" id="3700230">range</span>&nbsp;<span class="ident" id="3700236">haddrs</span>&nbsp;<span class="op" id="3700243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700248">if</span>&nbsp;<span class="ident" id="3700251">ip</span>&nbsp;<span class="op" id="3700254">:=</span>&nbsp;<span class="ident" id="3700257">ParseIP</span><span class="op" id="3700264">(</span><span class="ident" id="3700265">haddr</span><span class="op" id="3700270">)</span><span class="op" id="3700271">;</span>&nbsp;<span class="ident" id="3700273">ip</span>&nbsp;<span class="op" id="3700276">!=</span>&nbsp;<span class="builtintype" id="3700279">nil</span>&nbsp;<span class="op" id="3700283">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3700289">addrs</span>&nbsp;<span class="op" id="3700295">=</span>&nbsp;<span class="builtinfunc" id="3700297">append</span><span class="op" id="3700303">(</span><span class="ident" id="3700304">addrs</span><span class="op" id="3700309">,</span>&nbsp;<span class="ident" id="3700311">ip</span><span class="op" id="3700313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3700318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3700322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700326">if</span>&nbsp;<span class="builtinfunc" id="3700329">len</span><span class="op" id="3700332">(</span><span class="ident" id="3700333">addrs</span><span class="op" id="3700338">)</span>&nbsp;<span class="op" id="3700340">&gt;</span>&nbsp;<span class="num" id="3700342">0</span>&nbsp;<span class="op" id="3700344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700349">return</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3700358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3700361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700364">type</span>&nbsp;<span class="ident" id="3700369">racer</span>&nbsp;<span class="keyword" id="3700375">struct</span>&nbsp;<span class="op" id="3700382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3700386">qtype</span>&nbsp;<span class="builtintype" id="3700392">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3700401">rrs</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3700407">[</span><span class="op" id="3700408">]</span><span class="ident" id="3700409">dnsRR</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3700417">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3700424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3700427">lane</span>&nbsp;<span class="op" id="3700432">:=</span>&nbsp;<span class="builtinfunc" id="3700435">make</span><span class="op" id="3700439">(</span><span class="keyword" id="3700440">chan</span>&nbsp;<span class="ident" id="3700445">racer</span><span class="op" id="3700450">,</span>&nbsp;<span class="num" id="3700452">1</span><span class="op" id="3700453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3700456">qtypes</span>&nbsp;<span class="op" id="3700463">:=</span>&nbsp;<span class="op" id="3700466">[</span><span class="op" id="3700467">...</span><span class="op" id="3700470">]</span><span class="builtintype" id="3700471">uint16</span><span class="op" id="3700477">{</span><span class="ident" id="3700478">dnsTypeA</span><span class="op" id="3700486">,</span>&nbsp;<span class="ident" id="3700488">dnsTypeAAAA</span><span class="op" id="3700499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700502">for</span>&nbsp;<span class="ident" id="3700506">_</span><span class="op" id="3700507">,</span>&nbsp;<span class="ident" id="3700509">qtype</span>&nbsp;<span class="op" id="3700515">:=</span>&nbsp;<span class="keyword" id="3700518">range</span>&nbsp;<span class="ident" id="3700524">qtypes</span>&nbsp;<span class="op" id="3700531">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700535">go</span>&nbsp;<span class="keyword" id="3700538">func</span><span class="op" id="3700542">(</span><span class="ident" id="3700543">qtype</span>&nbsp;<span class="builtintype" id="3700549">uint16</span><span class="op" id="3700555">)</span>&nbsp;<span class="op" id="3700557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3700562">_</span><span class="op" id="3700563">,</span>&nbsp;<span class="ident" id="3700565">rrs</span><span class="op" id="3700568">,</span>&nbsp;<span class="ident" id="3700570">err</span>&nbsp;<span class="op" id="3700574">:=</span>&nbsp;<span class="ident" id="3700577">lookup</span><span class="op" id="3700583">(</span><span class="ident" id="3700584">name</span><span class="op" id="3700588">,</span>&nbsp;<span class="ident" id="3700590">qtype</span><span class="op" id="3700595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3700600">lane</span>&nbsp;<span class="op" id="3700605">&lt;-</span>&nbsp;<span class="ident" id="3700608">racer</span><span class="op" id="3700613">{</span><span class="ident" id="3700614">qtype</span><span class="op" id="3700619">,</span>&nbsp;<span class="ident" id="3700621">rrs</span><span class="op" id="3700624">,</span>&nbsp;<span class="ident" id="3700626">err</span><span class="op" id="3700629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3700633">}</span><span class="op" id="3700634">(</span><span class="ident" id="3700635">qtype</span><span class="op" id="3700640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3700643">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700646">var</span>&nbsp;<span class="ident" id="3700650">lastErr</span>&nbsp;<span class="builtintype" id="3700658">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700665">for</span>&nbsp;<span class="keyword" id="3700669">range</span>&nbsp;<span class="ident" id="3700675">qtypes</span>&nbsp;<span class="op" id="3700682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3700686">racer</span>&nbsp;<span class="op" id="3700692">:=</span>&nbsp;<span class="op" id="3700695">&lt;-</span><span class="ident" id="3700697">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700704">if</span>&nbsp;<span class="ident" id="3700707">racer</span><span class="op" id="3700712">.</span><span class="builtintype" id="3700713">error</span>&nbsp;<span class="op" id="3700719">!=</span>&nbsp;<span class="builtintype" id="3700722">nil</span>&nbsp;<span class="op" id="3700726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3700731">lastErr</span>&nbsp;<span class="op" id="3700739">=</span>&nbsp;<span class="ident" id="3700741">racer</span><span class="op" id="3700746">.</span><span class="builtintype" id="3700747">error</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700756">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3700767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700771">switch</span>&nbsp;<span class="ident" id="3700778">racer</span><span class="op" id="3700783">.</span><span class="ident" id="3700784">qtype</span>&nbsp;<span class="op" id="3700790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700794">case</span>&nbsp;<span class="ident" id="3700799">dnsTypeA</span><span class="op" id="3700807">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3700812">addrs</span>&nbsp;<span class="op" id="3700818">=</span>&nbsp;<span class="builtinfunc" id="3700820">append</span><span class="op" id="3700826">(</span><span class="ident" id="3700827">addrs</span><span class="op" id="3700832">,</span>&nbsp;<span class="ident" id="3700834">convertRR_A</span><span class="op" id="3700845">(</span><span class="ident" id="3700846">racer</span><span class="op" id="3700851">.</span><span class="ident" id="3700852">rrs</span><span class="op" id="3700855">)</span><span class="op" id="3700856">...</span><span class="op" id="3700859">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700863">case</span>&nbsp;<span class="ident" id="3700868">dnsTypeAAAA</span><span class="op" id="3700879">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3700884">addrs</span>&nbsp;<span class="op" id="3700890">=</span>&nbsp;<span class="builtinfunc" id="3700892">append</span><span class="op" id="3700898">(</span><span class="ident" id="3700899">addrs</span><span class="op" id="3700904">,</span>&nbsp;<span class="ident" id="3700906">convertRR_AAAA</span><span class="op" id="3700920">(</span><span class="ident" id="3700921">racer</span><span class="op" id="3700926">.</span><span class="ident" id="3700927">rrs</span><span class="op" id="3700930">)</span><span class="op" id="3700931">...</span><span class="op" id="3700934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3700938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3700941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700944">if</span>&nbsp;<span class="builtinfunc" id="3700947">len</span><span class="op" id="3700950">(</span><span class="ident" id="3700951">addrs</span><span class="op" id="3700956">)</span>&nbsp;<span class="op" id="3700958">==</span>&nbsp;<span class="num" id="3700961">0</span>&nbsp;<span class="op" id="3700963">&amp;&amp;</span>&nbsp;<span class="ident" id="3700966">lastErr</span>&nbsp;<span class="op" id="3700974">!=</span>&nbsp;<span class="builtintype" id="3700977">nil</span>&nbsp;<span class="op" id="3700981">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3700985">return</span>&nbsp;<span class="builtintype" id="3700992">nil</span><span class="op" id="3700995">,</span>&nbsp;<span class="ident" id="3700997">lastErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3701006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3701009">return</span>&nbsp;<span class="ident" id="3701016">addrs</span><span class="op" id="3701021">,</span>&nbsp;<span class="builtintype" id="3701023">nil</span><br>
<span class="lineno"></span><span class="op" id="3701027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="3701030">//&nbsp;goLookupCNAME&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupCNAME.</span><br>
<span class="lineno"></span><span class="comment" id="3701095">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3701156">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3701221">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3701282">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">415</span><span class="comment" id="3701345">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3701357">func</span>&nbsp;<span class="ident" id="3701362">goLookupCNAME</span><span class="op" id="3701375">(</span><span class="ident" id="3701376">name</span>&nbsp;<span class="builtintype" id="3701381">string</span><span class="op" id="3701387">)</span>&nbsp;<span class="op" id="3701389">(</span><span class="ident" id="3701390">cname</span>&nbsp;<span class="builtintype" id="3701396">string</span><span class="op" id="3701402">,</span>&nbsp;<span class="ident" id="3701404">err</span>&nbsp;<span class="builtintype" id="3701408">error</span><span class="op" id="3701413">)</span>&nbsp;<span class="op" id="3701415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3701418">_</span><span class="op" id="3701419">,</span>&nbsp;<span class="ident" id="3701421">rr</span><span class="op" id="3701423">,</span>&nbsp;<span class="ident" id="3701425">err</span>&nbsp;<span class="op" id="3701429">:=</span>&nbsp;<span class="ident" id="3701432">lookup</span><span class="op" id="3701438">(</span><span class="ident" id="3701439">name</span><span class="op" id="3701443">,</span>&nbsp;<span class="ident" id="3701445">dnsTypeCNAME</span><span class="op" id="3701457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3701460">if</span>&nbsp;<span class="ident" id="3701463">err</span>&nbsp;<span class="op" id="3701467">!=</span>&nbsp;<span class="builtintype" id="3701470">nil</span>&nbsp;<span class="op" id="3701474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3701478">return</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3701486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3701489">cname</span>&nbsp;<span class="op" id="3701495">=</span>&nbsp;<span class="ident" id="3701497">rr</span><span class="op" id="3701499">[</span><span class="num" id="3701500">0</span><span class="op" id="3701501">]</span><span class="op" id="3701502">.</span><span class="op" id="3701503">(</span><span class="op" id="3701504">*</span><span class="ident" id="3701505">dnsRR_CNAME</span><span class="op" id="3701516">)</span><span class="op" id="3701517">.</span><span class="ident" id="3701518">Cname</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3701525">return</span><br>
<span class="lineno"></span><span class="op" id="3701532">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
