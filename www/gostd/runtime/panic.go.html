<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html" class="current">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1598136">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1598191">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1598245">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1598296">package</span>&nbsp;<span class="ident" id="1598304">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1598313">import</span>&nbsp;<span class="string" id="1598320">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1598330">var</span>&nbsp;<span class="ident" id="1598334">indexError</span>&nbsp;<span class="op" id="1598345">=</span>&nbsp;<span class="builtintype" id="1598347">error</span><span class="op" id="1598352">(</span><span class="ident" id="1598353">errorString</span><span class="op" id="1598364">(</span><span class="string" id="1598365">&#34;index&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1598385">)</span><span class="op" id="1598386">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1598389">func</span>&nbsp;<span class="ident" id="1598394">panicindex</span><span class="op" id="1598404">(</span><span class="op" id="1598405">)</span>&nbsp;<span class="op" id="1598407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1598410">panic</span><span class="op" id="1598415">(</span><span class="ident" id="1598416">indexError</span><span class="op" id="1598426">)</span><br>
<span class="lineno"></span><span class="op" id="1598428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1598431">var</span>&nbsp;<span class="ident" id="1598435">sliceError</span>&nbsp;<span class="op" id="1598446">=</span>&nbsp;<span class="builtintype" id="1598448">error</span><span class="op" id="1598453">(</span><span class="ident" id="1598454">errorString</span><span class="op" id="1598465">(</span><span class="string" id="1598466">&#34;slice&nbsp;bounds&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1598493">)</span><span class="op" id="1598494">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1598497">func</span>&nbsp;<span class="ident" id="1598502">panicslice</span><span class="op" id="1598512">(</span><span class="op" id="1598513">)</span>&nbsp;<span class="op" id="1598515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1598518">panic</span><span class="op" id="1598523">(</span><span class="ident" id="1598524">sliceError</span><span class="op" id="1598534">)</span><br>
<span class="lineno"></span><span class="op" id="1598536">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="1598539">var</span>&nbsp;<span class="ident" id="1598543">divideError</span>&nbsp;<span class="op" id="1598555">=</span>&nbsp;<span class="builtintype" id="1598557">error</span><span class="op" id="1598562">(</span><span class="ident" id="1598563">errorString</span><span class="op" id="1598574">(</span><span class="string" id="1598575">&#34;integer&nbsp;divide&nbsp;by&nbsp;zero&#34;</span><span class="op" id="1598599">)</span><span class="op" id="1598600">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1598603">func</span>&nbsp;<span class="ident" id="1598608">panicdivide</span><span class="op" id="1598619">(</span><span class="op" id="1598620">)</span>&nbsp;<span class="op" id="1598622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1598625">panic</span><span class="op" id="1598630">(</span><span class="ident" id="1598631">divideError</span><span class="op" id="1598642">)</span><br>
<span class="lineno">25</span><span class="op" id="1598644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1598647">var</span>&nbsp;<span class="ident" id="1598651">overflowError</span>&nbsp;<span class="op" id="1598665">=</span>&nbsp;<span class="builtintype" id="1598667">error</span><span class="op" id="1598672">(</span><span class="ident" id="1598673">errorString</span><span class="op" id="1598684">(</span><span class="string" id="1598685">&#34;integer&nbsp;overflow&#34;</span><span class="op" id="1598703">)</span><span class="op" id="1598704">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1598707">func</span>&nbsp;<span class="ident" id="1598712">panicoverflow</span><span class="op" id="1598725">(</span><span class="op" id="1598726">)</span>&nbsp;<span class="op" id="1598728">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1598731">panic</span><span class="op" id="1598736">(</span><span class="ident" id="1598737">overflowError</span><span class="op" id="1598750">)</span><br>
<span class="lineno"></span><span class="op" id="1598752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1598755">var</span>&nbsp;<span class="ident" id="1598759">floatError</span>&nbsp;<span class="op" id="1598770">=</span>&nbsp;<span class="builtintype" id="1598772">error</span><span class="op" id="1598777">(</span><span class="ident" id="1598778">errorString</span><span class="op" id="1598789">(</span><span class="string" id="1598790">&#34;floating&nbsp;point&nbsp;error&#34;</span><span class="op" id="1598812">)</span><span class="op" id="1598813">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1598816">func</span>&nbsp;<span class="ident" id="1598821">panicfloat</span><span class="op" id="1598831">(</span><span class="op" id="1598832">)</span>&nbsp;<span class="op" id="1598834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1598837">panic</span><span class="op" id="1598842">(</span><span class="ident" id="1598843">floatError</span><span class="op" id="1598853">)</span><br>
<span class="lineno"></span><span class="op" id="1598855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1598858">var</span>&nbsp;<span class="ident" id="1598862">memoryError</span>&nbsp;<span class="op" id="1598874">=</span>&nbsp;<span class="builtintype" id="1598876">error</span><span class="op" id="1598881">(</span><span class="ident" id="1598882">errorString</span><span class="op" id="1598893">(</span><span class="string" id="1598894">&#34;invalid&nbsp;memory&nbsp;address&nbsp;or&nbsp;nil&nbsp;pointer&nbsp;dereference&#34;</span><span class="op" id="1598945">)</span><span class="op" id="1598946">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="1598949">func</span>&nbsp;<span class="ident" id="1598954">panicmem</span><span class="op" id="1598962">(</span><span class="op" id="1598963">)</span>&nbsp;<span class="op" id="1598965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1598968">panic</span><span class="op" id="1598973">(</span><span class="ident" id="1598974">memoryError</span><span class="op" id="1598985">)</span><br>
<span class="lineno"></span><span class="op" id="1598987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1598990">func</span>&nbsp;<span class="ident" id="1598995">throwreturn</span><span class="op" id="1599006">(</span><span class="op" id="1599007">)</span>&nbsp;<span class="op" id="1599009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599012">gothrow</span><span class="op" id="1599019">(</span><span class="string" id="1599020">&#34;no&nbsp;return&nbsp;at&nbsp;end&nbsp;of&nbsp;a&nbsp;typed&nbsp;function&nbsp;-&nbsp;compiler&nbsp;is&nbsp;broken&#34;</span><span class="op" id="1599079">)</span><br>
<span class="lineno"></span><span class="op" id="1599081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1599084">func</span>&nbsp;<span class="ident" id="1599089">throwinit</span><span class="op" id="1599098">(</span><span class="op" id="1599099">)</span>&nbsp;<span class="op" id="1599101">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599104">gothrow</span><span class="op" id="1599111">(</span><span class="string" id="1599112">&#34;recursive&nbsp;call&nbsp;during&nbsp;initialization&nbsp;-&nbsp;linker&nbsp;skew&#34;</span><span class="op" id="1599164">)</span><br>
<span class="lineno"></span><span class="op" id="1599166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1599169">//&nbsp;Create&nbsp;a&nbsp;new&nbsp;deferred&nbsp;function&nbsp;fn&nbsp;with&nbsp;siz&nbsp;bytes&nbsp;of&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="1599235">//&nbsp;The&nbsp;compiler&nbsp;turns&nbsp;a&nbsp;defer&nbsp;statement&nbsp;into&nbsp;a&nbsp;call&nbsp;to&nbsp;this.</span><br>
<span class="lineno">55</span><span class="comment" id="1599296">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1599309">func</span>&nbsp;<span class="ident" id="1599314">deferproc</span><span class="op" id="1599323">(</span><span class="ident" id="1599324">siz</span>&nbsp;<span class="builtintype" id="1599328">int32</span><span class="op" id="1599333">,</span>&nbsp;<span class="ident" id="1599335">fn</span>&nbsp;<span class="op" id="1599338">*</span><span class="ident" id="1599339">funcval</span><span class="op" id="1599346">)</span>&nbsp;<span class="op" id="1599348">{</span>&nbsp;<span class="comment" id="1599350">//&nbsp;arguments&nbsp;of&nbsp;fn&nbsp;follow&nbsp;fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1599380">//&nbsp;the&nbsp;arguments&nbsp;of&nbsp;fn&nbsp;are&nbsp;in&nbsp;a&nbsp;perilous&nbsp;state.&nbsp;&nbsp;The&nbsp;stack&nbsp;map</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1599444">//&nbsp;for&nbsp;deferproc&nbsp;does&nbsp;not&nbsp;describe&nbsp;them.&nbsp;&nbsp;So&nbsp;we&nbsp;can&#39;t&nbsp;let&nbsp;garbage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1599511">//&nbsp;collection&nbsp;or&nbsp;stack&nbsp;copying&nbsp;trigger&nbsp;until&nbsp;we&#39;ve&nbsp;copied&nbsp;them&nbsp;out</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1599579">//&nbsp;to&nbsp;somewhere&nbsp;safe.&nbsp;&nbsp;deferproc_m&nbsp;does&nbsp;that.&nbsp;&nbsp;Until&nbsp;deferproc_m,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1599646">//&nbsp;we&nbsp;can&nbsp;only&nbsp;call&nbsp;nosplit&nbsp;routines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599685">argp</span>&nbsp;<span class="op" id="1599690">:=</span>&nbsp;<span class="builtintype" id="1599693">uintptr</span><span class="op" id="1599700">(</span><span class="ident" id="1599701">unsafe</span><span class="op" id="1599707">.</span><span class="ident" id="1599708">Pointer</span><span class="op" id="1599715">(</span><span class="op" id="1599716">&amp;</span><span class="ident" id="1599717">fn</span><span class="op" id="1599719">)</span><span class="op" id="1599720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599723">argp</span>&nbsp;<span class="op" id="1599728">+=</span>&nbsp;<span class="ident" id="1599731">unsafe</span><span class="op" id="1599737">.</span><span class="ident" id="1599738">Sizeof</span><span class="op" id="1599744">(</span><span class="ident" id="1599745">fn</span><span class="op" id="1599747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599750">if</span>&nbsp;<span class="ident" id="1599753">GOARCH</span>&nbsp;<span class="op" id="1599760">==</span>&nbsp;<span class="string" id="1599763">&#34;arm&#34;</span>&nbsp;<span class="op" id="1599769">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599773">argp</span>&nbsp;<span class="op" id="1599778">+=</span>&nbsp;<span class="ident" id="1599781">ptrSize</span>&nbsp;<span class="comment" id="1599789">//&nbsp;skip&nbsp;caller&#39;s&nbsp;saved&nbsp;link&nbsp;register</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599830">mp</span>&nbsp;<span class="op" id="1599833">:=</span>&nbsp;<span class="ident" id="1599836">acquirem</span><span class="op" id="1599844">(</span><span class="op" id="1599845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599848">mp</span><span class="op" id="1599850">.</span><span class="ident" id="1599851">scalararg</span><span class="op" id="1599860">[</span><span class="num" id="1599861">0</span><span class="op" id="1599862">]</span>&nbsp;<span class="op" id="1599864">=</span>&nbsp;<span class="builtintype" id="1599866">uintptr</span><span class="op" id="1599873">(</span><span class="ident" id="1599874">siz</span><span class="op" id="1599877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599880">mp</span><span class="op" id="1599882">.</span><span class="ident" id="1599883">ptrarg</span><span class="op" id="1599889">[</span><span class="num" id="1599890">0</span><span class="op" id="1599891">]</span>&nbsp;<span class="op" id="1599893">=</span>&nbsp;<span class="ident" id="1599895">unsafe</span><span class="op" id="1599901">.</span><span class="ident" id="1599902">Pointer</span><span class="op" id="1599909">(</span><span class="ident" id="1599910">fn</span><span class="op" id="1599912">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599915">mp</span><span class="op" id="1599917">.</span><span class="ident" id="1599918">scalararg</span><span class="op" id="1599927">[</span><span class="num" id="1599928">1</span><span class="op" id="1599929">]</span>&nbsp;<span class="op" id="1599931">=</span>&nbsp;<span class="ident" id="1599933">argp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599939">mp</span><span class="op" id="1599941">.</span><span class="ident" id="1599942">scalararg</span><span class="op" id="1599951">[</span><span class="num" id="1599952">2</span><span class="op" id="1599953">]</span>&nbsp;<span class="op" id="1599955">=</span>&nbsp;<span class="ident" id="1599957">getcallerpc</span><span class="op" id="1599968">(</span><span class="ident" id="1599969">unsafe</span><span class="op" id="1599975">.</span><span class="ident" id="1599976">Pointer</span><span class="op" id="1599983">(</span><span class="op" id="1599984">&amp;</span><span class="ident" id="1599985">siz</span><span class="op" id="1599988">)</span><span class="op" id="1599989">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599993">if</span>&nbsp;<span class="ident" id="1599996">mp</span><span class="op" id="1599998">.</span><span class="ident" id="1599999">curg</span>&nbsp;<span class="op" id="1600004">!=</span>&nbsp;<span class="ident" id="1600007">getg</span><span class="op" id="1600011">(</span><span class="op" id="1600012">)</span>&nbsp;<span class="op" id="1600014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1600018">//&nbsp;go&nbsp;code&nbsp;on&nbsp;the&nbsp;m&nbsp;stack&nbsp;can&#39;t&nbsp;defer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600058">gothrow</span><span class="op" id="1600065">(</span><span class="string" id="1600066">&#34;defer&nbsp;on&nbsp;m&#34;</span><span class="op" id="1600078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600085">onM</span><span class="op" id="1600088">(</span><span class="ident" id="1600089">deferproc_m</span><span class="op" id="1600100">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600104">releasem</span><span class="op" id="1600112">(</span><span class="ident" id="1600113">mp</span><span class="op" id="1600115">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1600119">//&nbsp;deferproc&nbsp;returns&nbsp;0&nbsp;normally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1600153">//&nbsp;a&nbsp;deferred&nbsp;func&nbsp;that&nbsp;stops&nbsp;a&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1600192">//&nbsp;makes&nbsp;the&nbsp;deferproc&nbsp;return&nbsp;1.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1600226">//&nbsp;the&nbsp;code&nbsp;the&nbsp;compiler&nbsp;generates&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1600269">//&nbsp;checks&nbsp;the&nbsp;return&nbsp;value&nbsp;and&nbsp;jumps&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1600314">//&nbsp;end&nbsp;of&nbsp;the&nbsp;function&nbsp;if&nbsp;deferproc&nbsp;returns&nbsp;!=&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600365">return0</span><span class="op" id="1600372">(</span><span class="op" id="1600373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1600376">//&nbsp;No&nbsp;code&nbsp;can&nbsp;go&nbsp;here&nbsp;-&nbsp;the&nbsp;C&nbsp;return&nbsp;register&nbsp;has</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1600428">//&nbsp;been&nbsp;set&nbsp;and&nbsp;must&nbsp;not&nbsp;be&nbsp;clobbered.</span><br>
<span class="lineno"></span><span class="op" id="1600467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1600470">//&nbsp;Small&nbsp;malloc&nbsp;size&nbsp;classes&nbsp;&gt;=&nbsp;16&nbsp;are&nbsp;the&nbsp;multiples&nbsp;of&nbsp;16:&nbsp;16,&nbsp;32,&nbsp;48,&nbsp;64,&nbsp;80,&nbsp;96,&nbsp;112,&nbsp;128,&nbsp;144,&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="1600573">//&nbsp;Each&nbsp;P&nbsp;holds&nbsp;a&nbsp;pool&nbsp;for&nbsp;defers&nbsp;with&nbsp;small&nbsp;arg&nbsp;sizes.</span><br>
<span class="lineno">95</span><span class="comment" id="1600629">//&nbsp;Assign&nbsp;defer&nbsp;allocations&nbsp;to&nbsp;pools&nbsp;by&nbsp;rounding&nbsp;to&nbsp;16,&nbsp;to&nbsp;match&nbsp;malloc&nbsp;size&nbsp;classes.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1600716">const</span>&nbsp;<span class="op" id="1600722">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600725">deferHeaderSize</span>&nbsp;<span class="op" id="1600741">=</span>&nbsp;<span class="ident" id="1600743">unsafe</span><span class="op" id="1600749">.</span><span class="ident" id="1600750">Sizeof</span><span class="op" id="1600756">(</span><span class="ident" id="1600757">_defer</span><span class="op" id="1600763">{</span><span class="op" id="1600764">}</span><span class="op" id="1600765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600768">minDeferAlloc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1600784">=</span>&nbsp;<span class="op" id="1600786">(</span><span class="ident" id="1600787">deferHeaderSize</span>&nbsp;<span class="op" id="1600803">+</span>&nbsp;<span class="num" id="1600805">15</span><span class="op" id="1600807">)</span>&nbsp;<span class="op" id="1600809">&amp;^</span>&nbsp;<span class="num" id="1600812">15</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600816">minDeferArgs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600832">=</span>&nbsp;<span class="ident" id="1600834">minDeferAlloc</span>&nbsp;<span class="op" id="1600848">-</span>&nbsp;<span class="ident" id="1600850">deferHeaderSize</span><br>
<span class="lineno"></span><span class="op" id="1600866">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1600869">//&nbsp;defer&nbsp;size&nbsp;class&nbsp;for&nbsp;arg&nbsp;size&nbsp;sz</span><br>
<span class="lineno"></span><span class="comment" id="1600905">//go:nosplit</span><br>
<span class="lineno">105</span><span class="keyword" id="1600918">func</span>&nbsp;<span class="ident" id="1600923">deferclass</span><span class="op" id="1600933">(</span><span class="ident" id="1600934">siz</span>&nbsp;<span class="builtintype" id="1600938">uintptr</span><span class="op" id="1600945">)</span>&nbsp;<span class="builtintype" id="1600947">uintptr</span>&nbsp;<span class="op" id="1600955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600958">if</span>&nbsp;<span class="ident" id="1600961">siz</span>&nbsp;<span class="op" id="1600965">&lt;=</span>&nbsp;<span class="ident" id="1600968">minDeferArgs</span>&nbsp;<span class="op" id="1600981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600985">return</span>&nbsp;<span class="num" id="1600992">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600998">return</span>&nbsp;<span class="op" id="1601005">(</span><span class="ident" id="1601006">siz</span>&nbsp;<span class="op" id="1601010">-</span>&nbsp;<span class="ident" id="1601012">minDeferArgs</span>&nbsp;<span class="op" id="1601025">+</span>&nbsp;<span class="num" id="1601027">15</span><span class="op" id="1601029">)</span>&nbsp;<span class="op" id="1601031">/</span>&nbsp;<span class="num" id="1601033">16</span><br>
<span class="lineno">110</span><span class="op" id="1601036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1601039">//&nbsp;total&nbsp;size&nbsp;of&nbsp;memory&nbsp;block&nbsp;for&nbsp;defer&nbsp;with&nbsp;arg&nbsp;size&nbsp;sz</span><br>
<span class="lineno"></span><span class="keyword" id="1601096">func</span>&nbsp;<span class="ident" id="1601101">totaldefersize</span><span class="op" id="1601115">(</span><span class="ident" id="1601116">siz</span>&nbsp;<span class="builtintype" id="1601120">uintptr</span><span class="op" id="1601127">)</span>&nbsp;<span class="builtintype" id="1601129">uintptr</span>&nbsp;<span class="op" id="1601137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601140">if</span>&nbsp;<span class="ident" id="1601143">siz</span>&nbsp;<span class="op" id="1601147">&lt;=</span>&nbsp;<span class="ident" id="1601150">minDeferArgs</span>&nbsp;<span class="op" id="1601163">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601167">return</span>&nbsp;<span class="ident" id="1601174">minDeferAlloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601192">return</span>&nbsp;<span class="ident" id="1601199">deferHeaderSize</span>&nbsp;<span class="op" id="1601215">+</span>&nbsp;<span class="ident" id="1601217">siz</span><br>
<span class="lineno"></span><span class="op" id="1601221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="1601224">//&nbsp;Ensure&nbsp;that&nbsp;defer&nbsp;arg&nbsp;sizes&nbsp;that&nbsp;map&nbsp;to&nbsp;the&nbsp;same&nbsp;defer&nbsp;size&nbsp;class</span><br>
<span class="lineno"></span><span class="comment" id="1601293">//&nbsp;also&nbsp;map&nbsp;to&nbsp;the&nbsp;same&nbsp;malloc&nbsp;size&nbsp;class.</span><br>
<span class="lineno"></span><span class="keyword" id="1601336">func</span>&nbsp;<span class="ident" id="1601341">testdefersizes</span><span class="op" id="1601355">(</span><span class="op" id="1601356">)</span>&nbsp;<span class="op" id="1601358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601361">var</span>&nbsp;<span class="ident" id="1601365">m</span>&nbsp;<span class="op" id="1601367">[</span><span class="builtinfunc" id="1601368">len</span><span class="op" id="1601371">(</span><span class="ident" id="1601372">p</span><span class="op" id="1601373">{</span><span class="op" id="1601374">}</span><span class="op" id="1601375">.</span><span class="ident" id="1601376">deferpool</span><span class="op" id="1601385">)</span><span class="op" id="1601386">]</span><span class="builtintype" id="1601387">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601395">for</span>&nbsp;<span class="ident" id="1601399">i</span>&nbsp;<span class="op" id="1601401">:=</span>&nbsp;<span class="keyword" id="1601404">range</span>&nbsp;<span class="ident" id="1601410">m</span>&nbsp;<span class="op" id="1601412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601416">m</span><span class="op" id="1601417">[</span><span class="ident" id="1601418">i</span><span class="op" id="1601419">]</span>&nbsp;<span class="op" id="1601421">=</span>&nbsp;<span class="op" id="1601423">-</span><span class="num" id="1601424">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601430">for</span>&nbsp;<span class="ident" id="1601434">i</span>&nbsp;<span class="op" id="1601436">:=</span>&nbsp;<span class="builtintype" id="1601439">uintptr</span><span class="op" id="1601446">(</span><span class="num" id="1601447">0</span><span class="op" id="1601448">)</span><span class="op" id="1601449">;</span>&nbsp;<span class="op" id="1601451">;</span>&nbsp;<span class="ident" id="1601453">i</span><span class="op" id="1601454">++</span>&nbsp;<span class="op" id="1601457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601461">defersc</span>&nbsp;<span class="op" id="1601469">:=</span>&nbsp;<span class="ident" id="1601472">deferclass</span><span class="op" id="1601482">(</span><span class="ident" id="1601483">i</span><span class="op" id="1601484">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601488">if</span>&nbsp;<span class="ident" id="1601491">defersc</span>&nbsp;<span class="op" id="1601499">&gt;=</span>&nbsp;<span class="builtintype" id="1601502">uintptr</span><span class="op" id="1601509">(</span><span class="builtinfunc" id="1601510">len</span><span class="op" id="1601513">(</span><span class="ident" id="1601514">m</span><span class="op" id="1601515">)</span><span class="op" id="1601516">)</span>&nbsp;<span class="op" id="1601518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601523">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601535">siz</span>&nbsp;<span class="op" id="1601539">:=</span>&nbsp;<span class="ident" id="1601542">goroundupsize</span><span class="op" id="1601555">(</span><span class="ident" id="1601556">totaldefersize</span><span class="op" id="1601570">(</span><span class="ident" id="1601571">i</span><span class="op" id="1601572">)</span><span class="op" id="1601573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601577">if</span>&nbsp;<span class="ident" id="1601580">m</span><span class="op" id="1601581">[</span><span class="ident" id="1601582">defersc</span><span class="op" id="1601589">]</span>&nbsp;<span class="op" id="1601591">&lt;</span>&nbsp;<span class="num" id="1601593">0</span>&nbsp;<span class="op" id="1601595">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601600">m</span><span class="op" id="1601601">[</span><span class="ident" id="1601602">defersc</span><span class="op" id="1601609">]</span>&nbsp;<span class="op" id="1601611">=</span>&nbsp;<span class="builtintype" id="1601613">int32</span><span class="op" id="1601618">(</span><span class="ident" id="1601619">siz</span><span class="op" id="1601622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601627">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601642">if</span>&nbsp;<span class="ident" id="1601645">m</span><span class="op" id="1601646">[</span><span class="ident" id="1601647">defersc</span><span class="op" id="1601654">]</span>&nbsp;<span class="op" id="1601656">!=</span>&nbsp;<span class="builtintype" id="1601659">int32</span><span class="op" id="1601664">(</span><span class="ident" id="1601665">siz</span><span class="op" id="1601668">)</span>&nbsp;<span class="op" id="1601670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1601675">print</span><span class="op" id="1601680">(</span><span class="string" id="1601681">&#34;bad&nbsp;defer&nbsp;size&nbsp;class:&nbsp;i=&#34;</span><span class="op" id="1601707">,</span>&nbsp;<span class="ident" id="1601709">i</span><span class="op" id="1601710">,</span>&nbsp;<span class="string" id="1601712">&#34;&nbsp;siz=&#34;</span><span class="op" id="1601719">,</span>&nbsp;<span class="ident" id="1601721">siz</span><span class="op" id="1601724">,</span>&nbsp;<span class="string" id="1601726">&#34;&nbsp;defersc=&#34;</span><span class="op" id="1601737">,</span>&nbsp;<span class="ident" id="1601739">defersc</span><span class="op" id="1601746">,</span>&nbsp;<span class="string" id="1601748">&#34;\n&#34;</span><span class="op" id="1601752">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601757">gothrow</span><span class="op" id="1601764">(</span><span class="string" id="1601765">&#34;bad&nbsp;defer&nbsp;size&nbsp;class&#34;</span><span class="op" id="1601787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601794">}</span><br>
<span class="lineno"></span><span class="op" id="1601796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="1601799">//&nbsp;The&nbsp;arguments&nbsp;associated&nbsp;with&nbsp;a&nbsp;deferred&nbsp;call&nbsp;are&nbsp;stored</span><br>
<span class="lineno"></span><span class="comment" id="1601859">//&nbsp;immediately&nbsp;after&nbsp;the&nbsp;_defer&nbsp;header&nbsp;in&nbsp;memory.</span><br>
<span class="lineno"></span><span class="comment" id="1601909">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1601922">func</span>&nbsp;<span class="ident" id="1601927">deferArgs</span><span class="op" id="1601936">(</span><span class="ident" id="1601937">d</span>&nbsp;<span class="op" id="1601939">*</span><span class="ident" id="1601940">_defer</span><span class="op" id="1601946">)</span>&nbsp;<span class="ident" id="1601948">unsafe</span><span class="op" id="1601954">.</span><span class="ident" id="1601955">Pointer</span>&nbsp;<span class="op" id="1601963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601966">return</span>&nbsp;<span class="ident" id="1601973">add</span><span class="op" id="1601976">(</span><span class="ident" id="1601977">unsafe</span><span class="op" id="1601983">.</span><span class="ident" id="1601984">Pointer</span><span class="op" id="1601991">(</span><span class="ident" id="1601992">d</span><span class="op" id="1601993">)</span><span class="op" id="1601994">,</span>&nbsp;<span class="ident" id="1601996">unsafe</span><span class="op" id="1602002">.</span><span class="ident" id="1602003">Sizeof</span><span class="op" id="1602009">(</span><span class="op" id="1602010">*</span><span class="ident" id="1602011">d</span><span class="op" id="1602012">)</span><span class="op" id="1602013">)</span><br>
<span class="lineno">150</span><span class="op" id="1602015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1602018">var</span>&nbsp;<span class="ident" id="1602022">deferType</span>&nbsp;<span class="op" id="1602032">*</span><span class="ident" id="1602033">_type</span>&nbsp;<span class="comment" id="1602039">//&nbsp;type&nbsp;of&nbsp;_defer&nbsp;struct</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1602065">func</span>&nbsp;<span class="ident" id="1602070">init</span><span class="op" id="1602074">(</span><span class="op" id="1602075">)</span>&nbsp;<span class="op" id="1602077">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602080">var</span>&nbsp;<span class="ident" id="1602084">x</span>&nbsp;<span class="keyword" id="1602086">interface</span><span class="op" id="1602095">{</span><span class="op" id="1602096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602099">x</span>&nbsp;<span class="op" id="1602101">=</span>&nbsp;<span class="op" id="1602103">(</span><span class="op" id="1602104">*</span><span class="ident" id="1602105">_defer</span><span class="op" id="1602111">)</span><span class="op" id="1602112">(</span><span class="ident" id="1602113">nil</span><span class="op" id="1602116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602119">deferType</span>&nbsp;<span class="op" id="1602129">=</span>&nbsp;<span class="op" id="1602131">(</span><span class="op" id="1602132">*</span><span class="op" id="1602133">(</span><span class="op" id="1602134">*</span><span class="op" id="1602135">*</span><span class="ident" id="1602136">ptrtype</span><span class="op" id="1602143">)</span><span class="op" id="1602144">(</span><span class="ident" id="1602145">unsafe</span><span class="op" id="1602151">.</span><span class="ident" id="1602152">Pointer</span><span class="op" id="1602159">(</span><span class="op" id="1602160">&amp;</span><span class="ident" id="1602161">x</span><span class="op" id="1602162">)</span><span class="op" id="1602163">)</span><span class="op" id="1602164">)</span><span class="op" id="1602165">.</span><span class="ident" id="1602166">elem</span><br>
<span class="lineno"></span><span class="op" id="1602171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="1602174">//&nbsp;Allocate&nbsp;a&nbsp;Defer,&nbsp;usually&nbsp;using&nbsp;per-P&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="1602221">//&nbsp;Each&nbsp;defer&nbsp;must&nbsp;be&nbsp;released&nbsp;with&nbsp;freedefer.</span><br>
<span class="lineno"></span><span class="comment" id="1602268">//&nbsp;Note:&nbsp;runs&nbsp;on&nbsp;M&nbsp;stack</span><br>
<span class="lineno"></span><span class="keyword" id="1602293">func</span>&nbsp;<span class="ident" id="1602298">newdefer</span><span class="op" id="1602306">(</span><span class="ident" id="1602307">siz</span>&nbsp;<span class="builtintype" id="1602311">int32</span><span class="op" id="1602316">)</span>&nbsp;<span class="op" id="1602318">*</span><span class="ident" id="1602319">_defer</span>&nbsp;<span class="op" id="1602326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602329">var</span>&nbsp;<span class="ident" id="1602333">d</span>&nbsp;<span class="op" id="1602335">*</span><span class="ident" id="1602336">_defer</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602344">sc</span>&nbsp;<span class="op" id="1602347">:=</span>&nbsp;<span class="ident" id="1602350">deferclass</span><span class="op" id="1602360">(</span><span class="builtintype" id="1602361">uintptr</span><span class="op" id="1602368">(</span><span class="ident" id="1602369">siz</span><span class="op" id="1602372">)</span><span class="op" id="1602373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602376">mp</span>&nbsp;<span class="op" id="1602379">:=</span>&nbsp;<span class="ident" id="1602382">acquirem</span><span class="op" id="1602390">(</span><span class="op" id="1602391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602394">if</span>&nbsp;<span class="ident" id="1602397">sc</span>&nbsp;<span class="op" id="1602400">&lt;</span>&nbsp;<span class="builtintype" id="1602402">uintptr</span><span class="op" id="1602409">(</span><span class="builtinfunc" id="1602410">len</span><span class="op" id="1602413">(</span><span class="ident" id="1602414">p</span><span class="op" id="1602415">{</span><span class="op" id="1602416">}</span><span class="op" id="1602417">.</span><span class="ident" id="1602418">deferpool</span><span class="op" id="1602427">)</span><span class="op" id="1602428">)</span>&nbsp;<span class="op" id="1602430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602434">pp</span>&nbsp;<span class="op" id="1602437">:=</span>&nbsp;<span class="ident" id="1602440">mp</span><span class="op" id="1602442">.</span><span class="ident" id="1602443">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602447">d</span>&nbsp;<span class="op" id="1602449">=</span>&nbsp;<span class="ident" id="1602451">pp</span><span class="op" id="1602453">.</span><span class="ident" id="1602454">deferpool</span><span class="op" id="1602463">[</span><span class="ident" id="1602464">sc</span><span class="op" id="1602466">]</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602470">if</span>&nbsp;<span class="ident" id="1602473">d</span>&nbsp;<span class="op" id="1602475">!=</span>&nbsp;<span class="ident" id="1602478">nil</span>&nbsp;<span class="op" id="1602482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602487">pp</span><span class="op" id="1602489">.</span><span class="ident" id="1602490">deferpool</span><span class="op" id="1602499">[</span><span class="ident" id="1602500">sc</span><span class="op" id="1602502">]</span>&nbsp;<span class="op" id="1602504">=</span>&nbsp;<span class="ident" id="1602506">d</span><span class="op" id="1602507">.</span><span class="ident" id="1602508">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602521">if</span>&nbsp;<span class="ident" id="1602524">d</span>&nbsp;<span class="op" id="1602526">==</span>&nbsp;<span class="ident" id="1602529">nil</span>&nbsp;<span class="op" id="1602533">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1602537">//&nbsp;Allocate&nbsp;new&nbsp;defer+args.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602567">total</span>&nbsp;<span class="op" id="1602573">:=</span>&nbsp;<span class="ident" id="1602576">goroundupsize</span><span class="op" id="1602589">(</span><span class="ident" id="1602590">totaldefersize</span><span class="op" id="1602604">(</span><span class="builtintype" id="1602605">uintptr</span><span class="op" id="1602612">(</span><span class="ident" id="1602613">siz</span><span class="op" id="1602616">)</span><span class="op" id="1602617">)</span><span class="op" id="1602618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602622">d</span>&nbsp;<span class="op" id="1602624">=</span>&nbsp;<span class="op" id="1602626">(</span><span class="op" id="1602627">*</span><span class="ident" id="1602628">_defer</span><span class="op" id="1602634">)</span><span class="op" id="1602635">(</span><span class="ident" id="1602636">mallocgc</span><span class="op" id="1602644">(</span><span class="ident" id="1602645">total</span><span class="op" id="1602650">,</span>&nbsp;<span class="ident" id="1602652">deferType</span><span class="op" id="1602661">,</span>&nbsp;<span class="num" id="1602663">0</span><span class="op" id="1602664">)</span><span class="op" id="1602665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602671">d</span><span class="op" id="1602672">.</span><span class="ident" id="1602673">siz</span>&nbsp;<span class="op" id="1602677">=</span>&nbsp;<span class="ident" id="1602679">siz</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602684">gp</span>&nbsp;<span class="op" id="1602687">:=</span>&nbsp;<span class="ident" id="1602690">mp</span><span class="op" id="1602692">.</span><span class="ident" id="1602693">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602699">d</span><span class="op" id="1602700">.</span><span class="ident" id="1602701">link</span>&nbsp;<span class="op" id="1602706">=</span>&nbsp;<span class="ident" id="1602708">gp</span><span class="op" id="1602710">.</span><span class="ident" id="1602711">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602719">gp</span><span class="op" id="1602721">.</span><span class="ident" id="1602722">_defer</span>&nbsp;<span class="op" id="1602729">=</span>&nbsp;<span class="ident" id="1602731">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602734">releasem</span><span class="op" id="1602742">(</span><span class="ident" id="1602743">mp</span><span class="op" id="1602745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602748">return</span>&nbsp;<span class="ident" id="1602755">d</span><br>
<span class="lineno">185</span><span class="op" id="1602757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1602760">//&nbsp;Free&nbsp;the&nbsp;given&nbsp;defer.</span><br>
<span class="lineno"></span><span class="comment" id="1602785">//&nbsp;The&nbsp;defer&nbsp;cannot&nbsp;be&nbsp;used&nbsp;after&nbsp;this&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="1602830">//go:nosplit</span><br>
<span class="lineno">190</span><span class="keyword" id="1602843">func</span>&nbsp;<span class="ident" id="1602848">freedefer</span><span class="op" id="1602857">(</span><span class="ident" id="1602858">d</span>&nbsp;<span class="op" id="1602860">*</span><span class="ident" id="1602861">_defer</span><span class="op" id="1602867">)</span>&nbsp;<span class="op" id="1602869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602872">if</span>&nbsp;<span class="ident" id="1602875">d</span><span class="op" id="1602876">.</span><span class="ident" id="1602877">_panic</span>&nbsp;<span class="op" id="1602884">!=</span>&nbsp;<span class="ident" id="1602887">nil</span>&nbsp;<span class="op" id="1602891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602895">freedeferpanic</span><span class="op" id="1602909">(</span><span class="op" id="1602910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602916">if</span>&nbsp;<span class="ident" id="1602919">d</span><span class="op" id="1602920">.</span><span class="ident" id="1602921">fn</span>&nbsp;<span class="op" id="1602924">!=</span>&nbsp;<span class="ident" id="1602927">nil</span>&nbsp;<span class="op" id="1602931">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602935">freedeferfn</span><span class="op" id="1602946">(</span><span class="op" id="1602947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602953">sc</span>&nbsp;<span class="op" id="1602956">:=</span>&nbsp;<span class="ident" id="1602959">deferclass</span><span class="op" id="1602969">(</span><span class="builtintype" id="1602970">uintptr</span><span class="op" id="1602977">(</span><span class="ident" id="1602978">d</span><span class="op" id="1602979">.</span><span class="ident" id="1602980">siz</span><span class="op" id="1602983">)</span><span class="op" id="1602984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602987">if</span>&nbsp;<span class="ident" id="1602990">sc</span>&nbsp;<span class="op" id="1602993">&lt;</span>&nbsp;<span class="builtintype" id="1602995">uintptr</span><span class="op" id="1603002">(</span><span class="builtinfunc" id="1603003">len</span><span class="op" id="1603006">(</span><span class="ident" id="1603007">p</span><span class="op" id="1603008">{</span><span class="op" id="1603009">}</span><span class="op" id="1603010">.</span><span class="ident" id="1603011">deferpool</span><span class="op" id="1603020">)</span><span class="op" id="1603021">)</span>&nbsp;<span class="op" id="1603023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603027">mp</span>&nbsp;<span class="op" id="1603030">:=</span>&nbsp;<span class="ident" id="1603033">acquirem</span><span class="op" id="1603041">(</span><span class="op" id="1603042">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603046">pp</span>&nbsp;<span class="op" id="1603049">:=</span>&nbsp;<span class="ident" id="1603052">mp</span><span class="op" id="1603054">.</span><span class="ident" id="1603055">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1603059">*</span><span class="ident" id="1603060">d</span>&nbsp;<span class="op" id="1603062">=</span>&nbsp;<span class="ident" id="1603064">_defer</span><span class="op" id="1603070">{</span><span class="op" id="1603071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603075">d</span><span class="op" id="1603076">.</span><span class="ident" id="1603077">link</span>&nbsp;<span class="op" id="1603082">=</span>&nbsp;<span class="ident" id="1603084">pp</span><span class="op" id="1603086">.</span><span class="ident" id="1603087">deferpool</span><span class="op" id="1603096">[</span><span class="ident" id="1603097">sc</span><span class="op" id="1603099">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603103">pp</span><span class="op" id="1603105">.</span><span class="ident" id="1603106">deferpool</span><span class="op" id="1603115">[</span><span class="ident" id="1603116">sc</span><span class="op" id="1603118">]</span>&nbsp;<span class="op" id="1603120">=</span>&nbsp;<span class="ident" id="1603122">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603126">releasem</span><span class="op" id="1603134">(</span><span class="ident" id="1603135">mp</span><span class="op" id="1603137">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1603140">}</span><br>
<span class="lineno"></span><span class="op" id="1603142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1603145">//&nbsp;Separate&nbsp;function&nbsp;so&nbsp;that&nbsp;it&nbsp;can&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1603194">//&nbsp;Windows&nbsp;otherwise&nbsp;runs&nbsp;out&nbsp;of&nbsp;stack&nbsp;space.</span><br>
<span class="lineno">210</span><span class="keyword" id="1603240">func</span>&nbsp;<span class="ident" id="1603245">freedeferpanic</span><span class="op" id="1603259">(</span><span class="op" id="1603260">)</span>&nbsp;<span class="op" id="1603262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1603265">//&nbsp;_panic&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;d&nbsp;is&nbsp;unlinked&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603322">gothrow</span><span class="op" id="1603329">(</span><span class="string" id="1603330">&#34;freedefer&nbsp;with&nbsp;d._panic&nbsp;!=&nbsp;nil&#34;</span><span class="op" id="1603362">)</span><br>
<span class="lineno"></span><span class="op" id="1603364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="1603367">func</span>&nbsp;<span class="ident" id="1603372">freedeferfn</span><span class="op" id="1603383">(</span><span class="op" id="1603384">)</span>&nbsp;<span class="op" id="1603386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1603389">//&nbsp;fn&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;d&nbsp;is&nbsp;unlinked&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603442">gothrow</span><span class="op" id="1603449">(</span><span class="string" id="1603450">&#34;freedefer&nbsp;with&nbsp;d.fn&nbsp;!=&nbsp;nil&#34;</span><span class="op" id="1603478">)</span><br>
<span class="lineno"></span><span class="op" id="1603480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span><span class="comment" id="1603483">//&nbsp;Run&nbsp;a&nbsp;deferred&nbsp;function&nbsp;if&nbsp;there&nbsp;is&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1603527">//&nbsp;The&nbsp;compiler&nbsp;inserts&nbsp;a&nbsp;call&nbsp;to&nbsp;this&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="1603584">//&nbsp;function&nbsp;which&nbsp;calls&nbsp;defer.</span><br>
<span class="lineno"></span><span class="comment" id="1603615">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;deferred&nbsp;function,&nbsp;this&nbsp;will&nbsp;call&nbsp;runtimejmpdefer,</span><br>
<span class="lineno"></span><span class="comment" id="1603685">//&nbsp;which&nbsp;will&nbsp;jump&nbsp;to&nbsp;the&nbsp;deferred&nbsp;function&nbsp;such&nbsp;that&nbsp;it&nbsp;appears</span><br>
<span class="lineno">225</span><span class="comment" id="1603750">//&nbsp;to&nbsp;have&nbsp;been&nbsp;called&nbsp;by&nbsp;the&nbsp;caller&nbsp;of&nbsp;deferreturn&nbsp;at&nbsp;the&nbsp;point</span><br>
<span class="lineno"></span><span class="comment" id="1603815">//&nbsp;just&nbsp;before&nbsp;deferreturn&nbsp;was&nbsp;called.&nbsp;&nbsp;The&nbsp;effect&nbsp;is&nbsp;that&nbsp;deferreturn</span><br>
<span class="lineno"></span><span class="comment" id="1603886">//&nbsp;is&nbsp;called&nbsp;again&nbsp;and&nbsp;again&nbsp;until&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;deferred&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="1603959">//&nbsp;Cannot&nbsp;split&nbsp;the&nbsp;stack&nbsp;because&nbsp;we&nbsp;reuse&nbsp;the&nbsp;caller&#39;s&nbsp;frame&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1604024">//&nbsp;call&nbsp;the&nbsp;deferred&nbsp;function.</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="1604056">//&nbsp;The&nbsp;single&nbsp;argument&nbsp;isn&#39;t&nbsp;actually&nbsp;used&nbsp;-&nbsp;it&nbsp;just&nbsp;has&nbsp;its&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="1604125">//&nbsp;taken&nbsp;so&nbsp;it&nbsp;can&nbsp;be&nbsp;matched&nbsp;against&nbsp;pending&nbsp;defers.</span><br>
<span class="lineno"></span><span class="comment" id="1604179">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1604192">func</span>&nbsp;<span class="ident" id="1604197">deferreturn</span><span class="op" id="1604208">(</span><span class="ident" id="1604209">arg0</span>&nbsp;<span class="builtintype" id="1604214">uintptr</span><span class="op" id="1604221">)</span>&nbsp;<span class="op" id="1604223">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604226">gp</span>&nbsp;<span class="op" id="1604229">:=</span>&nbsp;<span class="ident" id="1604232">getg</span><span class="op" id="1604236">(</span><span class="op" id="1604237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604240">d</span>&nbsp;<span class="op" id="1604242">:=</span>&nbsp;<span class="ident" id="1604245">gp</span><span class="op" id="1604247">.</span><span class="ident" id="1604248">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604256">if</span>&nbsp;<span class="ident" id="1604259">d</span>&nbsp;<span class="op" id="1604261">==</span>&nbsp;<span class="ident" id="1604264">nil</span>&nbsp;<span class="op" id="1604268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604272">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604280">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604283">argp</span>&nbsp;<span class="op" id="1604288">:=</span>&nbsp;<span class="builtintype" id="1604291">uintptr</span><span class="op" id="1604298">(</span><span class="ident" id="1604299">unsafe</span><span class="op" id="1604305">.</span><span class="ident" id="1604306">Pointer</span><span class="op" id="1604313">(</span><span class="op" id="1604314">&amp;</span><span class="ident" id="1604315">arg0</span><span class="op" id="1604319">)</span><span class="op" id="1604320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604323">if</span>&nbsp;<span class="ident" id="1604326">d</span><span class="op" id="1604327">.</span><span class="ident" id="1604328">argp</span>&nbsp;<span class="op" id="1604333">!=</span>&nbsp;<span class="ident" id="1604336">argp</span>&nbsp;<span class="op" id="1604341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604345">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604357">//&nbsp;Moving&nbsp;arguments&nbsp;around.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604386">//&nbsp;Do&nbsp;not&nbsp;allow&nbsp;preemption&nbsp;here,&nbsp;because&nbsp;the&nbsp;garbage&nbsp;collector</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604450">//&nbsp;won&#39;t&nbsp;know&nbsp;the&nbsp;form&nbsp;of&nbsp;the&nbsp;arguments&nbsp;until&nbsp;the&nbsp;jmpdefer&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604514">//&nbsp;flip&nbsp;the&nbsp;PC&nbsp;over&nbsp;to&nbsp;fn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604542">mp</span>&nbsp;<span class="op" id="1604545">:=</span>&nbsp;<span class="ident" id="1604548">acquirem</span><span class="op" id="1604556">(</span><span class="op" id="1604557">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604560">memmove</span><span class="op" id="1604567">(</span><span class="ident" id="1604568">unsafe</span><span class="op" id="1604574">.</span><span class="ident" id="1604575">Pointer</span><span class="op" id="1604582">(</span><span class="ident" id="1604583">argp</span><span class="op" id="1604587">)</span><span class="op" id="1604588">,</span>&nbsp;<span class="ident" id="1604590">deferArgs</span><span class="op" id="1604599">(</span><span class="ident" id="1604600">d</span><span class="op" id="1604601">)</span><span class="op" id="1604602">,</span>&nbsp;<span class="builtintype" id="1604604">uintptr</span><span class="op" id="1604611">(</span><span class="ident" id="1604612">d</span><span class="op" id="1604613">.</span><span class="ident" id="1604614">siz</span><span class="op" id="1604617">)</span><span class="op" id="1604618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604621">fn</span>&nbsp;<span class="op" id="1604624">:=</span>&nbsp;<span class="ident" id="1604627">d</span><span class="op" id="1604628">.</span><span class="ident" id="1604629">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604633">d</span><span class="op" id="1604634">.</span><span class="ident" id="1604635">fn</span>&nbsp;<span class="op" id="1604638">=</span>&nbsp;<span class="ident" id="1604640">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604645">gp</span><span class="op" id="1604647">.</span><span class="ident" id="1604648">_defer</span>&nbsp;<span class="op" id="1604655">=</span>&nbsp;<span class="ident" id="1604657">d</span><span class="op" id="1604658">.</span><span class="ident" id="1604659">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604665">freedefer</span><span class="op" id="1604674">(</span><span class="ident" id="1604675">d</span><span class="op" id="1604676">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604679">releasem</span><span class="op" id="1604687">(</span><span class="ident" id="1604688">mp</span><span class="op" id="1604690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604693">jmpdefer</span><span class="op" id="1604701">(</span><span class="ident" id="1604702">fn</span><span class="op" id="1604704">,</span>&nbsp;<span class="ident" id="1604706">argp</span><span class="op" id="1604710">)</span><br>
<span class="lineno"></span><span class="op" id="1604712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1604715">//&nbsp;Goexit&nbsp;terminates&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;calls&nbsp;it.&nbsp;&nbsp;No&nbsp;other&nbsp;goroutine&nbsp;is&nbsp;affected.</span><br>
<span class="lineno">260</span><span class="comment" id="1604798">//&nbsp;Goexit&nbsp;runs&nbsp;all&nbsp;deferred&nbsp;calls&nbsp;before&nbsp;terminating&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;Because&nbsp;Goexit</span><br>
<span class="lineno"></span><span class="comment" id="1604882">//&nbsp;is&nbsp;not&nbsp;panic,&nbsp;however,&nbsp;any&nbsp;recover&nbsp;calls&nbsp;in&nbsp;those&nbsp;deferred&nbsp;functions&nbsp;will&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1604971">//</span><br>
<span class="lineno"></span><span class="comment" id="1604974">//&nbsp;Calling&nbsp;Goexit&nbsp;from&nbsp;the&nbsp;main&nbsp;goroutine&nbsp;terminates&nbsp;that&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1605042">//&nbsp;without&nbsp;func&nbsp;main&nbsp;returning.&nbsp;Since&nbsp;func&nbsp;main&nbsp;has&nbsp;not&nbsp;returned,</span><br>
<span class="lineno">265</span><span class="comment" id="1605108">//&nbsp;the&nbsp;program&nbsp;continues&nbsp;execution&nbsp;of&nbsp;other&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="1605164">//&nbsp;If&nbsp;all&nbsp;other&nbsp;goroutines&nbsp;exit,&nbsp;the&nbsp;program&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="1605218">func</span>&nbsp;<span class="ident" id="1605223">Goexit</span><span class="op" id="1605229">(</span><span class="op" id="1605230">)</span>&nbsp;<span class="op" id="1605232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605235">//&nbsp;Run&nbsp;all&nbsp;deferred&nbsp;functions&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605293">//&nbsp;This&nbsp;code&nbsp;is&nbsp;similar&nbsp;to&nbsp;gopanic,&nbsp;see&nbsp;that&nbsp;implementation</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605354">//&nbsp;for&nbsp;detailed&nbsp;comments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605381">gp</span>&nbsp;<span class="op" id="1605384">:=</span>&nbsp;<span class="ident" id="1605387">getg</span><span class="op" id="1605391">(</span><span class="op" id="1605392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605395">for</span>&nbsp;<span class="op" id="1605399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605403">d</span>&nbsp;<span class="op" id="1605405">:=</span>&nbsp;<span class="ident" id="1605408">gp</span><span class="op" id="1605410">.</span><span class="ident" id="1605411">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605420">if</span>&nbsp;<span class="ident" id="1605423">d</span>&nbsp;<span class="op" id="1605425">==</span>&nbsp;<span class="ident" id="1605428">nil</span>&nbsp;<span class="op" id="1605432">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605437">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605449">if</span>&nbsp;<span class="ident" id="1605452">d</span><span class="op" id="1605453">.</span><span class="ident" id="1605454">started</span>&nbsp;<span class="op" id="1605462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605467">if</span>&nbsp;<span class="ident" id="1605470">d</span><span class="op" id="1605471">.</span><span class="ident" id="1605472">_panic</span>&nbsp;<span class="op" id="1605479">!=</span>&nbsp;<span class="ident" id="1605482">nil</span>&nbsp;<span class="op" id="1605486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605492">d</span><span class="op" id="1605493">.</span><span class="ident" id="1605494">_panic</span><span class="op" id="1605500">.</span><span class="ident" id="1605501">aborted</span>&nbsp;<span class="op" id="1605509">=</span>&nbsp;<span class="builtintype" id="1605511">true</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605520">d</span><span class="op" id="1605521">.</span><span class="ident" id="1605522">_panic</span>&nbsp;<span class="op" id="1605529">=</span>&nbsp;<span class="ident" id="1605531">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605543">d</span><span class="op" id="1605544">.</span><span class="ident" id="1605545">fn</span>&nbsp;<span class="op" id="1605548">=</span>&nbsp;<span class="ident" id="1605550">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605557">gp</span><span class="op" id="1605559">.</span><span class="ident" id="1605560">_defer</span>&nbsp;<span class="op" id="1605567">=</span>&nbsp;<span class="ident" id="1605569">d</span><span class="op" id="1605570">.</span><span class="ident" id="1605571">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605579">freedefer</span><span class="op" id="1605588">(</span><span class="ident" id="1605589">d</span><span class="op" id="1605590">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605595">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605610">d</span><span class="op" id="1605611">.</span><span class="ident" id="1605612">started</span>&nbsp;<span class="op" id="1605620">=</span>&nbsp;<span class="builtintype" id="1605622">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605629">reflectcall</span><span class="op" id="1605640">(</span><span class="ident" id="1605641">unsafe</span><span class="op" id="1605647">.</span><span class="ident" id="1605648">Pointer</span><span class="op" id="1605655">(</span><span class="ident" id="1605656">d</span><span class="op" id="1605657">.</span><span class="ident" id="1605658">fn</span><span class="op" id="1605660">)</span><span class="op" id="1605661">,</span>&nbsp;<span class="ident" id="1605663">deferArgs</span><span class="op" id="1605672">(</span><span class="ident" id="1605673">d</span><span class="op" id="1605674">)</span><span class="op" id="1605675">,</span>&nbsp;<span class="builtintype" id="1605677">uint32</span><span class="op" id="1605683">(</span><span class="ident" id="1605684">d</span><span class="op" id="1605685">.</span><span class="ident" id="1605686">siz</span><span class="op" id="1605689">)</span><span class="op" id="1605690">,</span>&nbsp;<span class="builtintype" id="1605692">uint32</span><span class="op" id="1605698">(</span><span class="ident" id="1605699">d</span><span class="op" id="1605700">.</span><span class="ident" id="1605701">siz</span><span class="op" id="1605704">)</span><span class="op" id="1605705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605709">if</span>&nbsp;<span class="ident" id="1605712">gp</span><span class="op" id="1605714">.</span><span class="ident" id="1605715">_defer</span>&nbsp;<span class="op" id="1605722">!=</span>&nbsp;<span class="ident" id="1605725">d</span>&nbsp;<span class="op" id="1605727">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605732">gothrow</span><span class="op" id="1605739">(</span><span class="string" id="1605740">&#34;bad&nbsp;defer&nbsp;entry&nbsp;in&nbsp;Goexit&#34;</span><span class="op" id="1605767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605775">d</span><span class="op" id="1605776">.</span><span class="ident" id="1605777">_panic</span>&nbsp;<span class="op" id="1605784">=</span>&nbsp;<span class="ident" id="1605786">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605792">d</span><span class="op" id="1605793">.</span><span class="ident" id="1605794">fn</span>&nbsp;<span class="op" id="1605797">=</span>&nbsp;<span class="ident" id="1605799">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605805">gp</span><span class="op" id="1605807">.</span><span class="ident" id="1605808">_defer</span>&nbsp;<span class="op" id="1605815">=</span>&nbsp;<span class="ident" id="1605817">d</span><span class="op" id="1605818">.</span><span class="ident" id="1605819">link</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605826">freedefer</span><span class="op" id="1605835">(</span><span class="ident" id="1605836">d</span><span class="op" id="1605837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605841">//&nbsp;Note:&nbsp;we&nbsp;ignore&nbsp;recovers&nbsp;here&nbsp;because&nbsp;Goexit&nbsp;isn&#39;t&nbsp;a&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605907">goexit</span><span class="op" id="1605913">(</span><span class="op" id="1605914">)</span><br>
<span class="lineno"></span><span class="op" id="1605916">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span><span class="keyword" id="1605919">func</span>&nbsp;<span class="ident" id="1605924">canpanic</span><span class="op" id="1605932">(</span><span class="op" id="1605933">*</span><span class="ident" id="1605934">g</span><span class="op" id="1605935">)</span>&nbsp;<span class="builtintype" id="1605937">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1605943">//&nbsp;Print&nbsp;all&nbsp;currently&nbsp;active&nbsp;panics.&nbsp;&nbsp;Used&nbsp;when&nbsp;crashing.</span><br>
<span class="lineno"></span><span class="keyword" id="1606002">func</span>&nbsp;<span class="ident" id="1606007">printpanics</span><span class="op" id="1606018">(</span><span class="ident" id="1606019">p</span>&nbsp;<span class="op" id="1606021">*</span><span class="ident" id="1606022">_panic</span><span class="op" id="1606028">)</span>&nbsp;<span class="op" id="1606030">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606033">if</span>&nbsp;<span class="ident" id="1606036">p</span><span class="op" id="1606037">.</span><span class="ident" id="1606038">link</span>&nbsp;<span class="op" id="1606043">!=</span>&nbsp;<span class="ident" id="1606046">nil</span>&nbsp;<span class="op" id="1606050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606054">printpanics</span><span class="op" id="1606065">(</span><span class="ident" id="1606066">p</span><span class="op" id="1606067">.</span><span class="ident" id="1606068">link</span><span class="op" id="1606072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1606076">print</span><span class="op" id="1606081">(</span><span class="string" id="1606082">&#34;\t&#34;</span><span class="op" id="1606086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1606092">print</span><span class="op" id="1606097">(</span><span class="string" id="1606098">&#34;panic:&nbsp;&#34;</span><span class="op" id="1606107">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606110">printany</span><span class="op" id="1606118">(</span><span class="ident" id="1606119">p</span><span class="op" id="1606120">.</span><span class="ident" id="1606121">arg</span><span class="op" id="1606124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606127">if</span>&nbsp;<span class="ident" id="1606130">p</span><span class="op" id="1606131">.</span><span class="ident" id="1606132">recovered</span>&nbsp;<span class="op" id="1606142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1606146">print</span><span class="op" id="1606151">(</span><span class="string" id="1606152">&#34;&nbsp;[recovered]&#34;</span><span class="op" id="1606166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1606172">print</span><span class="op" id="1606177">(</span><span class="string" id="1606178">&#34;\n&#34;</span><span class="op" id="1606182">)</span><br>
<span class="lineno">315</span><span class="op" id="1606184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1606187">//&nbsp;The&nbsp;implementation&nbsp;of&nbsp;the&nbsp;predeclared&nbsp;function&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="1606244">func</span>&nbsp;<span class="ident" id="1606249">gopanic</span><span class="op" id="1606256">(</span><span class="ident" id="1606257">e</span>&nbsp;<span class="keyword" id="1606259">interface</span><span class="op" id="1606268">{</span><span class="op" id="1606269">}</span><span class="op" id="1606270">)</span>&nbsp;<span class="op" id="1606272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606275">gp</span>&nbsp;<span class="op" id="1606278">:=</span>&nbsp;<span class="ident" id="1606281">getg</span><span class="op" id="1606285">(</span><span class="op" id="1606286">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606289">if</span>&nbsp;<span class="ident" id="1606292">gp</span><span class="op" id="1606294">.</span><span class="ident" id="1606295">m</span><span class="op" id="1606296">.</span><span class="ident" id="1606297">curg</span>&nbsp;<span class="op" id="1606302">!=</span>&nbsp;<span class="ident" id="1606305">gp</span>&nbsp;<span class="op" id="1606308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606312">gothrow</span><span class="op" id="1606319">(</span><span class="string" id="1606320">&#34;panic&nbsp;on&nbsp;m&nbsp;stack&#34;</span><span class="op" id="1606338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606345">//&nbsp;m.softfloat&nbsp;is&nbsp;set&nbsp;during&nbsp;software&nbsp;floating&nbsp;point.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606400">//&nbsp;It&nbsp;increments&nbsp;m.locks&nbsp;to&nbsp;avoid&nbsp;preemption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606447">//&nbsp;We&nbsp;moved&nbsp;the&nbsp;memory&nbsp;loads&nbsp;out,&nbsp;so&nbsp;there&nbsp;shouldn&#39;t&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606504">//&nbsp;any&nbsp;reason&nbsp;for&nbsp;it&nbsp;to&nbsp;panic&nbsp;anymore.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606544">if</span>&nbsp;<span class="ident" id="1606547">gp</span><span class="op" id="1606549">.</span><span class="ident" id="1606550">m</span><span class="op" id="1606551">.</span><span class="ident" id="1606552">softfloat</span>&nbsp;<span class="op" id="1606562">!=</span>&nbsp;<span class="num" id="1606565">0</span>&nbsp;<span class="op" id="1606567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606571">gp</span><span class="op" id="1606573">.</span><span class="ident" id="1606574">m</span><span class="op" id="1606575">.</span><span class="ident" id="1606576">locks</span><span class="op" id="1606581">--</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606586">gp</span><span class="op" id="1606588">.</span><span class="ident" id="1606589">m</span><span class="op" id="1606590">.</span><span class="ident" id="1606591">softfloat</span>&nbsp;<span class="op" id="1606601">=</span>&nbsp;<span class="num" id="1606603">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606607">gothrow</span><span class="op" id="1606614">(</span><span class="string" id="1606615">&#34;panic&nbsp;during&nbsp;softfloat&#34;</span><span class="op" id="1606639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606645">if</span>&nbsp;<span class="ident" id="1606648">gp</span><span class="op" id="1606650">.</span><span class="ident" id="1606651">m</span><span class="op" id="1606652">.</span><span class="ident" id="1606653">mallocing</span>&nbsp;<span class="op" id="1606663">!=</span>&nbsp;<span class="num" id="1606666">0</span>&nbsp;<span class="op" id="1606668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1606672">print</span><span class="op" id="1606677">(</span><span class="string" id="1606678">&#34;panic:&nbsp;&#34;</span><span class="op" id="1606687">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606691">printany</span><span class="op" id="1606699">(</span><span class="ident" id="1606700">e</span><span class="op" id="1606701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1606705">print</span><span class="op" id="1606710">(</span><span class="string" id="1606711">&#34;\n&#34;</span><span class="op" id="1606715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606719">gothrow</span><span class="op" id="1606726">(</span><span class="string" id="1606727">&#34;panic&nbsp;during&nbsp;malloc&#34;</span><span class="op" id="1606748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606754">if</span>&nbsp;<span class="ident" id="1606757">gp</span><span class="op" id="1606759">.</span><span class="ident" id="1606760">m</span><span class="op" id="1606761">.</span><span class="ident" id="1606762">gcing</span>&nbsp;<span class="op" id="1606768">!=</span>&nbsp;<span class="num" id="1606771">0</span>&nbsp;<span class="op" id="1606773">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1606777">print</span><span class="op" id="1606782">(</span><span class="string" id="1606783">&#34;panic:&nbsp;&#34;</span><span class="op" id="1606792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606796">printany</span><span class="op" id="1606804">(</span><span class="ident" id="1606805">e</span><span class="op" id="1606806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1606810">print</span><span class="op" id="1606815">(</span><span class="string" id="1606816">&#34;\n&#34;</span><span class="op" id="1606820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606824">gothrow</span><span class="op" id="1606831">(</span><span class="string" id="1606832">&#34;panic&nbsp;during&nbsp;gc&#34;</span><span class="op" id="1606849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606852">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606855">if</span>&nbsp;<span class="ident" id="1606858">gp</span><span class="op" id="1606860">.</span><span class="ident" id="1606861">m</span><span class="op" id="1606862">.</span><span class="ident" id="1606863">locks</span>&nbsp;<span class="op" id="1606869">!=</span>&nbsp;<span class="num" id="1606872">0</span>&nbsp;<span class="op" id="1606874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1606878">print</span><span class="op" id="1606883">(</span><span class="string" id="1606884">&#34;panic:&nbsp;&#34;</span><span class="op" id="1606893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606897">printany</span><span class="op" id="1606905">(</span><span class="ident" id="1606906">e</span><span class="op" id="1606907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1606911">print</span><span class="op" id="1606916">(</span><span class="string" id="1606917">&#34;\n&#34;</span><span class="op" id="1606921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606925">gothrow</span><span class="op" id="1606932">(</span><span class="string" id="1606933">&#34;panic&nbsp;holding&nbsp;locks&#34;</span><span class="op" id="1606954">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606961">var</span>&nbsp;<span class="ident" id="1606965">p</span>&nbsp;<span class="ident" id="1606967">_panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606975">p</span><span class="op" id="1606976">.</span><span class="ident" id="1606977">arg</span>&nbsp;<span class="op" id="1606981">=</span>&nbsp;<span class="ident" id="1606983">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606986">p</span><span class="op" id="1606987">.</span><span class="ident" id="1606988">link</span>&nbsp;<span class="op" id="1606993">=</span>&nbsp;<span class="ident" id="1606995">gp</span><span class="op" id="1606997">.</span><span class="ident" id="1606998">_panic</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607006">gp</span><span class="op" id="1607008">.</span><span class="ident" id="1607009">_panic</span>&nbsp;<span class="op" id="1607016">=</span>&nbsp;<span class="op" id="1607018">(</span><span class="op" id="1607019">*</span><span class="ident" id="1607020">_panic</span><span class="op" id="1607026">)</span><span class="op" id="1607027">(</span><span class="ident" id="1607028">noescape</span><span class="op" id="1607036">(</span><span class="ident" id="1607037">unsafe</span><span class="op" id="1607043">.</span><span class="ident" id="1607044">Pointer</span><span class="op" id="1607051">(</span><span class="op" id="1607052">&amp;</span><span class="ident" id="1607053">p</span><span class="op" id="1607054">)</span><span class="op" id="1607055">)</span><span class="op" id="1607056">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607060">for</span>&nbsp;<span class="op" id="1607064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607068">d</span>&nbsp;<span class="op" id="1607070">:=</span>&nbsp;<span class="ident" id="1607073">gp</span><span class="op" id="1607075">.</span><span class="ident" id="1607076">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607085">if</span>&nbsp;<span class="ident" id="1607088">d</span>&nbsp;<span class="op" id="1607090">==</span>&nbsp;<span class="ident" id="1607093">nil</span>&nbsp;<span class="op" id="1607097">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607102">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607115">//&nbsp;If&nbsp;defer&nbsp;was&nbsp;started&nbsp;by&nbsp;earlier&nbsp;panic&nbsp;or&nbsp;Goexit&nbsp;(and,&nbsp;since&nbsp;we&#39;re&nbsp;back&nbsp;here,&nbsp;that&nbsp;triggered&nbsp;a&nbsp;new&nbsp;panic),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607226">//&nbsp;take&nbsp;defer&nbsp;off&nbsp;list.&nbsp;The&nbsp;earlier&nbsp;panic&nbsp;or&nbsp;Goexit&nbsp;will&nbsp;not&nbsp;continue&nbsp;running.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607307">if</span>&nbsp;<span class="ident" id="1607310">d</span><span class="op" id="1607311">.</span><span class="ident" id="1607312">started</span>&nbsp;<span class="op" id="1607320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607325">if</span>&nbsp;<span class="ident" id="1607328">d</span><span class="op" id="1607329">.</span><span class="ident" id="1607330">_panic</span>&nbsp;<span class="op" id="1607337">!=</span>&nbsp;<span class="ident" id="1607340">nil</span>&nbsp;<span class="op" id="1607344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607350">d</span><span class="op" id="1607351">.</span><span class="ident" id="1607352">_panic</span><span class="op" id="1607358">.</span><span class="ident" id="1607359">aborted</span>&nbsp;<span class="op" id="1607367">=</span>&nbsp;<span class="builtintype" id="1607369">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607382">d</span><span class="op" id="1607383">.</span><span class="ident" id="1607384">_panic</span>&nbsp;<span class="op" id="1607391">=</span>&nbsp;<span class="ident" id="1607393">nil</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607400">d</span><span class="op" id="1607401">.</span><span class="ident" id="1607402">fn</span>&nbsp;<span class="op" id="1607405">=</span>&nbsp;<span class="ident" id="1607407">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607414">gp</span><span class="op" id="1607416">.</span><span class="ident" id="1607417">_defer</span>&nbsp;<span class="op" id="1607424">=</span>&nbsp;<span class="ident" id="1607426">d</span><span class="op" id="1607427">.</span><span class="ident" id="1607428">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607436">freedefer</span><span class="op" id="1607445">(</span><span class="ident" id="1607446">d</span><span class="op" id="1607447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607452">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607463">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607468">//&nbsp;Mark&nbsp;defer&nbsp;as&nbsp;started,&nbsp;but&nbsp;keep&nbsp;on&nbsp;list,&nbsp;so&nbsp;that&nbsp;traceback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607532">//&nbsp;can&nbsp;find&nbsp;and&nbsp;update&nbsp;the&nbsp;defer&#39;s&nbsp;argument&nbsp;frame&nbsp;if&nbsp;stack&nbsp;growth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607600">//&nbsp;or&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;hapens&nbsp;before&nbsp;reflectcall&nbsp;starts&nbsp;executing&nbsp;d.fn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607678">d</span><span class="op" id="1607679">.</span><span class="ident" id="1607680">started</span>&nbsp;<span class="op" id="1607688">=</span>&nbsp;<span class="builtintype" id="1607690">true</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607698">//&nbsp;Record&nbsp;the&nbsp;panic&nbsp;that&nbsp;is&nbsp;running&nbsp;the&nbsp;defer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607747">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;new&nbsp;panic&nbsp;during&nbsp;the&nbsp;deferred&nbsp;call,&nbsp;that&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607813">//&nbsp;will&nbsp;find&nbsp;d&nbsp;in&nbsp;the&nbsp;list&nbsp;and&nbsp;will&nbsp;mark&nbsp;d._panic&nbsp;(this&nbsp;panic)&nbsp;aborted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607887">d</span><span class="op" id="1607888">.</span><span class="ident" id="1607889">_panic</span>&nbsp;<span class="op" id="1607896">=</span>&nbsp;<span class="op" id="1607898">(</span><span class="op" id="1607899">*</span><span class="ident" id="1607900">_panic</span><span class="op" id="1607906">)</span><span class="op" id="1607907">(</span><span class="ident" id="1607908">noescape</span><span class="op" id="1607916">(</span><span class="op" id="1607917">(</span><span class="ident" id="1607918">unsafe</span><span class="op" id="1607924">.</span><span class="ident" id="1607925">Pointer</span><span class="op" id="1607932">)</span><span class="op" id="1607933">(</span><span class="op" id="1607934">&amp;</span><span class="ident" id="1607935">p</span><span class="op" id="1607936">)</span><span class="op" id="1607937">)</span><span class="op" id="1607938">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607943">p</span><span class="op" id="1607944">.</span><span class="ident" id="1607945">argp</span>&nbsp;<span class="op" id="1607950">=</span>&nbsp;<span class="ident" id="1607952">unsafe</span><span class="op" id="1607958">.</span><span class="ident" id="1607959">Pointer</span><span class="op" id="1607966">(</span><span class="ident" id="1607967">getargp</span><span class="op" id="1607974">(</span><span class="num" id="1607975">0</span><span class="op" id="1607976">)</span><span class="op" id="1607977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607981">reflectcall</span><span class="op" id="1607992">(</span><span class="ident" id="1607993">unsafe</span><span class="op" id="1607999">.</span><span class="ident" id="1608000">Pointer</span><span class="op" id="1608007">(</span><span class="ident" id="1608008">d</span><span class="op" id="1608009">.</span><span class="ident" id="1608010">fn</span><span class="op" id="1608012">)</span><span class="op" id="1608013">,</span>&nbsp;<span class="ident" id="1608015">deferArgs</span><span class="op" id="1608024">(</span><span class="ident" id="1608025">d</span><span class="op" id="1608026">)</span><span class="op" id="1608027">,</span>&nbsp;<span class="builtintype" id="1608029">uint32</span><span class="op" id="1608035">(</span><span class="ident" id="1608036">d</span><span class="op" id="1608037">.</span><span class="ident" id="1608038">siz</span><span class="op" id="1608041">)</span><span class="op" id="1608042">,</span>&nbsp;<span class="builtintype" id="1608044">uint32</span><span class="op" id="1608050">(</span><span class="ident" id="1608051">d</span><span class="op" id="1608052">.</span><span class="ident" id="1608053">siz</span><span class="op" id="1608056">)</span><span class="op" id="1608057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608061">p</span><span class="op" id="1608062">.</span><span class="ident" id="1608063">argp</span>&nbsp;<span class="op" id="1608068">=</span>&nbsp;<span class="ident" id="1608070">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608077">//&nbsp;reflectcall&nbsp;did&nbsp;not&nbsp;panic.&nbsp;Remove&nbsp;d.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608119">if</span>&nbsp;<span class="ident" id="1608122">gp</span><span class="op" id="1608124">.</span><span class="ident" id="1608125">_defer</span>&nbsp;<span class="op" id="1608132">!=</span>&nbsp;<span class="ident" id="1608135">d</span>&nbsp;<span class="op" id="1608137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608142">gothrow</span><span class="op" id="1608149">(</span><span class="string" id="1608150">&#34;bad&nbsp;defer&nbsp;entry&nbsp;in&nbsp;panic&#34;</span><span class="op" id="1608176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608184">d</span><span class="op" id="1608185">.</span><span class="ident" id="1608186">_panic</span>&nbsp;<span class="op" id="1608193">=</span>&nbsp;<span class="ident" id="1608195">nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608201">d</span><span class="op" id="1608202">.</span><span class="ident" id="1608203">fn</span>&nbsp;<span class="op" id="1608206">=</span>&nbsp;<span class="ident" id="1608208">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608214">gp</span><span class="op" id="1608216">.</span><span class="ident" id="1608217">_defer</span>&nbsp;<span class="op" id="1608224">=</span>&nbsp;<span class="ident" id="1608226">d</span><span class="op" id="1608227">.</span><span class="ident" id="1608228">link</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608236">//&nbsp;trigger&nbsp;shrinkage&nbsp;to&nbsp;test&nbsp;stack&nbsp;copy.&nbsp;&nbsp;See&nbsp;stack_test.go:TestStackPanic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608313">//GC()</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608323">pc</span>&nbsp;<span class="op" id="1608326">:=</span>&nbsp;<span class="ident" id="1608329">d</span><span class="op" id="1608330">.</span><span class="ident" id="1608331">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608336">argp</span>&nbsp;<span class="op" id="1608341">:=</span>&nbsp;<span class="ident" id="1608344">unsafe</span><span class="op" id="1608350">.</span><span class="ident" id="1608351">Pointer</span><span class="op" id="1608358">(</span><span class="ident" id="1608359">d</span><span class="op" id="1608360">.</span><span class="ident" id="1608361">argp</span><span class="op" id="1608365">)</span>&nbsp;<span class="comment" id="1608367">//&nbsp;must&nbsp;be&nbsp;pointer&nbsp;so&nbsp;it&nbsp;gets&nbsp;adjusted&nbsp;during&nbsp;stack&nbsp;copy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608426">freedefer</span><span class="op" id="1608435">(</span><span class="ident" id="1608436">d</span><span class="op" id="1608437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608441">if</span>&nbsp;<span class="ident" id="1608444">p</span><span class="op" id="1608445">.</span><span class="ident" id="1608446">recovered</span>&nbsp;<span class="op" id="1608456">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608461">gp</span><span class="op" id="1608463">.</span><span class="ident" id="1608464">_panic</span>&nbsp;<span class="op" id="1608471">=</span>&nbsp;<span class="ident" id="1608473">p</span><span class="op" id="1608474">.</span><span class="ident" id="1608475">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608483">//&nbsp;Aborted&nbsp;panics&nbsp;are&nbsp;marked&nbsp;but&nbsp;remain&nbsp;on&nbsp;the&nbsp;g.panic&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608547">//&nbsp;Remove&nbsp;them&nbsp;from&nbsp;the&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608580">for</span>&nbsp;<span class="ident" id="1608584">gp</span><span class="op" id="1608586">.</span><span class="ident" id="1608587">_panic</span>&nbsp;<span class="op" id="1608594">!=</span>&nbsp;<span class="ident" id="1608597">nil</span>&nbsp;<span class="op" id="1608601">&amp;&amp;</span>&nbsp;<span class="ident" id="1608604">gp</span><span class="op" id="1608606">.</span><span class="ident" id="1608607">_panic</span><span class="op" id="1608613">.</span><span class="ident" id="1608614">aborted</span>&nbsp;<span class="op" id="1608622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608628">gp</span><span class="op" id="1608630">.</span><span class="ident" id="1608631">_panic</span>&nbsp;<span class="op" id="1608638">=</span>&nbsp;<span class="ident" id="1608640">gp</span><span class="op" id="1608642">.</span><span class="ident" id="1608643">_panic</span><span class="op" id="1608649">.</span><span class="ident" id="1608650">link</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608663">if</span>&nbsp;<span class="ident" id="1608666">gp</span><span class="op" id="1608668">.</span><span class="ident" id="1608669">_panic</span>&nbsp;<span class="op" id="1608676">==</span>&nbsp;<span class="ident" id="1608679">nil</span>&nbsp;<span class="op" id="1608683">{</span>&nbsp;<span class="comment" id="1608685">//&nbsp;must&nbsp;be&nbsp;done&nbsp;with&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608717">gp</span><span class="op" id="1608719">.</span><span class="ident" id="1608720">sig</span>&nbsp;<span class="op" id="1608724">=</span>&nbsp;<span class="num" id="1608726">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608736">//&nbsp;Pass&nbsp;information&nbsp;about&nbsp;recovering&nbsp;frame&nbsp;to&nbsp;recovery.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608795">gp</span><span class="op" id="1608797">.</span><span class="ident" id="1608798">sigcode0</span>&nbsp;<span class="op" id="1608807">=</span>&nbsp;<span class="builtintype" id="1608809">uintptr</span><span class="op" id="1608816">(</span><span class="ident" id="1608817">argp</span><span class="op" id="1608821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608826">gp</span><span class="op" id="1608828">.</span><span class="ident" id="1608829">sigcode1</span>&nbsp;<span class="op" id="1608838">=</span>&nbsp;<span class="ident" id="1608840">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608846">mcall</span><span class="op" id="1608851">(</span><span class="ident" id="1608852">recovery_m</span><span class="op" id="1608862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608867">gothrow</span><span class="op" id="1608874">(</span><span class="string" id="1608875">&#34;recovery&nbsp;failed&#34;</span><span class="op" id="1608892">)</span>&nbsp;<span class="comment" id="1608894">//&nbsp;mcall&nbsp;should&nbsp;not&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608923">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608930">//&nbsp;ran&nbsp;out&nbsp;of&nbsp;deferred&nbsp;calls&nbsp;-&nbsp;old-school&nbsp;panic&nbsp;now</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608983">startpanic</span><span class="op" id="1608993">(</span><span class="op" id="1608994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608997">printpanics</span><span class="op" id="1609008">(</span><span class="ident" id="1609009">gp</span><span class="op" id="1609011">.</span><span class="ident" id="1609012">_panic</span><span class="op" id="1609018">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609021">dopanic</span><span class="op" id="1609028">(</span><span class="num" id="1609029">0</span><span class="op" id="1609030">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1609038">//&nbsp;should&nbsp;not&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609060">*</span><span class="op" id="1609061">(</span><span class="op" id="1609062">*</span><span class="builtintype" id="1609063">int</span><span class="op" id="1609066">)</span><span class="op" id="1609067">(</span><span class="ident" id="1609068">nil</span><span class="op" id="1609071">)</span>&nbsp;<span class="op" id="1609073">=</span>&nbsp;<span class="num" id="1609075">0</span>&nbsp;<span class="comment" id="1609077">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno"></span><span class="op" id="1609092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1609095">//&nbsp;getargp&nbsp;returns&nbsp;the&nbsp;location&nbsp;where&nbsp;the&nbsp;caller</span><br>
<span class="lineno">430</span><span class="comment" id="1609144">//&nbsp;writes&nbsp;outgoing&nbsp;function&nbsp;call&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="1609188">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1609201">func</span>&nbsp;<span class="ident" id="1609206">getargp</span><span class="op" id="1609213">(</span><span class="ident" id="1609214">x</span>&nbsp;<span class="builtintype" id="1609216">int</span><span class="op" id="1609219">)</span>&nbsp;<span class="builtintype" id="1609221">uintptr</span>&nbsp;<span class="op" id="1609229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1609232">//&nbsp;x&nbsp;is&nbsp;an&nbsp;argument&nbsp;mainly&nbsp;so&nbsp;that&nbsp;we&nbsp;can&nbsp;return&nbsp;its&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1609295">//&nbsp;However,&nbsp;we&nbsp;need&nbsp;to&nbsp;make&nbsp;the&nbsp;function&nbsp;complex&nbsp;enough</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1609352">//&nbsp;that&nbsp;it&nbsp;won&#39;t&nbsp;be&nbsp;inlined.&nbsp;We&nbsp;always&nbsp;pass&nbsp;x&nbsp;=&nbsp;0,&nbsp;so&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1609417">//&nbsp;does&nbsp;nothing&nbsp;other&nbsp;than&nbsp;keep&nbsp;the&nbsp;compiler&nbsp;from&nbsp;thinking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1609477">//&nbsp;the&nbsp;function&nbsp;is&nbsp;simple&nbsp;enough&nbsp;to&nbsp;inline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609522">if</span>&nbsp;<span class="ident" id="1609525">x</span>&nbsp;<span class="op" id="1609527">&gt;</span>&nbsp;<span class="num" id="1609529">0</span>&nbsp;<span class="op" id="1609531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609535">return</span>&nbsp;<span class="ident" id="1609542">getcallersp</span><span class="op" id="1609553">(</span><span class="ident" id="1609554">unsafe</span><span class="op" id="1609560">.</span><span class="ident" id="1609561">Pointer</span><span class="op" id="1609568">(</span><span class="op" id="1609569">&amp;</span><span class="ident" id="1609570">x</span><span class="op" id="1609571">)</span><span class="op" id="1609572">)</span>&nbsp;<span class="op" id="1609574">*</span>&nbsp;<span class="num" id="1609576">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609582">return</span>&nbsp;<span class="builtintype" id="1609589">uintptr</span><span class="op" id="1609596">(</span><span class="ident" id="1609597">noescape</span><span class="op" id="1609605">(</span><span class="ident" id="1609606">unsafe</span><span class="op" id="1609612">.</span><span class="ident" id="1609613">Pointer</span><span class="op" id="1609620">(</span><span class="op" id="1609621">&amp;</span><span class="ident" id="1609622">x</span><span class="op" id="1609623">)</span><span class="op" id="1609624">)</span><span class="op" id="1609625">)</span><br>
<span class="lineno"></span><span class="op" id="1609627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1609630">//&nbsp;The&nbsp;implementation&nbsp;of&nbsp;the&nbsp;predeclared&nbsp;function&nbsp;recover.</span><br>
<span class="lineno">445</span><span class="comment" id="1609689">//&nbsp;Cannot&nbsp;split&nbsp;the&nbsp;stack&nbsp;because&nbsp;it&nbsp;needs&nbsp;to&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="1609744">//&nbsp;find&nbsp;the&nbsp;stack&nbsp;segment&nbsp;of&nbsp;its&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1609785">//</span><br>
<span class="lineno"></span><span class="comment" id="1609788">//&nbsp;TODO(rsc):&nbsp;Once&nbsp;we&nbsp;commit&nbsp;to&nbsp;CopyStackAlways,</span><br>
<span class="lineno"></span><span class="comment" id="1609837">//&nbsp;this&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;nosplit.</span><br>
<span class="lineno">450</span><span class="comment" id="1609873">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1609886">func</span>&nbsp;<span class="ident" id="1609891">gorecover</span><span class="op" id="1609900">(</span><span class="ident" id="1609901">argp</span>&nbsp;<span class="builtintype" id="1609906">uintptr</span><span class="op" id="1609913">)</span>&nbsp;<span class="keyword" id="1609915">interface</span><span class="op" id="1609924">{</span><span class="op" id="1609925">}</span>&nbsp;<span class="op" id="1609927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1609930">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;a&nbsp;function&nbsp;running&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;deferred&nbsp;call&nbsp;during&nbsp;the&nbsp;panic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1610009">//&nbsp;Must&nbsp;be&nbsp;called&nbsp;from&nbsp;the&nbsp;topmost&nbsp;function&nbsp;of&nbsp;the&nbsp;call</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1610066">//&nbsp;(the&nbsp;function&nbsp;used&nbsp;in&nbsp;the&nbsp;defer&nbsp;statement).</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1610114">//&nbsp;p.argp&nbsp;is&nbsp;the&nbsp;argument&nbsp;pointer&nbsp;of&nbsp;that&nbsp;topmost&nbsp;deferred&nbsp;function&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1610189">//&nbsp;Compare&nbsp;against&nbsp;argp&nbsp;reported&nbsp;by&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1610234">//&nbsp;If&nbsp;they&nbsp;match,&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;who&nbsp;can&nbsp;recover.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610292">gp</span>&nbsp;<span class="op" id="1610295">:=</span>&nbsp;<span class="ident" id="1610298">getg</span><span class="op" id="1610302">(</span><span class="op" id="1610303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610306">p</span>&nbsp;<span class="op" id="1610308">:=</span>&nbsp;<span class="ident" id="1610311">gp</span><span class="op" id="1610313">.</span><span class="ident" id="1610314">_panic</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610322">if</span>&nbsp;<span class="ident" id="1610325">p</span>&nbsp;<span class="op" id="1610327">!=</span>&nbsp;<span class="ident" id="1610330">nil</span>&nbsp;<span class="op" id="1610334">&amp;&amp;</span>&nbsp;<span class="op" id="1610337">!</span><span class="ident" id="1610338">p</span><span class="op" id="1610339">.</span><span class="ident" id="1610340">recovered</span>&nbsp;<span class="op" id="1610350">&amp;&amp;</span>&nbsp;<span class="ident" id="1610353">argp</span>&nbsp;<span class="op" id="1610358">==</span>&nbsp;<span class="builtintype" id="1610361">uintptr</span><span class="op" id="1610368">(</span><span class="ident" id="1610369">p</span><span class="op" id="1610370">.</span><span class="ident" id="1610371">argp</span><span class="op" id="1610375">)</span>&nbsp;<span class="op" id="1610377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610381">p</span><span class="op" id="1610382">.</span><span class="ident" id="1610383">recovered</span>&nbsp;<span class="op" id="1610393">=</span>&nbsp;<span class="builtintype" id="1610395">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610402">return</span>&nbsp;<span class="ident" id="1610409">p</span><span class="op" id="1610410">.</span><span class="ident" id="1610411">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610419">return</span>&nbsp;<span class="ident" id="1610426">nil</span><br>
<span class="lineno">465</span><span class="op" id="1610430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1610433">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1610446">func</span>&nbsp;<span class="ident" id="1610451">startpanic</span><span class="op" id="1610461">(</span><span class="op" id="1610462">)</span>&nbsp;<span class="op" id="1610464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610467">onM_signalok</span><span class="op" id="1610479">(</span><span class="ident" id="1610480">startpanic_m</span><span class="op" id="1610492">)</span><br>
<span class="lineno">470</span><span class="op" id="1610494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1610497">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1610510">func</span>&nbsp;<span class="ident" id="1610515">dopanic</span><span class="op" id="1610522">(</span><span class="ident" id="1610523">unused</span>&nbsp;<span class="builtintype" id="1610530">int</span><span class="op" id="1610533">)</span>&nbsp;<span class="op" id="1610535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610538">gp</span>&nbsp;<span class="op" id="1610541">:=</span>&nbsp;<span class="ident" id="1610544">getg</span><span class="op" id="1610548">(</span><span class="op" id="1610549">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610552">mp</span>&nbsp;<span class="op" id="1610555">:=</span>&nbsp;<span class="ident" id="1610558">acquirem</span><span class="op" id="1610566">(</span><span class="op" id="1610567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610570">mp</span><span class="op" id="1610572">.</span><span class="ident" id="1610573">ptrarg</span><span class="op" id="1610579">[</span><span class="num" id="1610580">0</span><span class="op" id="1610581">]</span>&nbsp;<span class="op" id="1610583">=</span>&nbsp;<span class="ident" id="1610585">unsafe</span><span class="op" id="1610591">.</span><span class="ident" id="1610592">Pointer</span><span class="op" id="1610599">(</span><span class="ident" id="1610600">gp</span><span class="op" id="1610602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610605">mp</span><span class="op" id="1610607">.</span><span class="ident" id="1610608">scalararg</span><span class="op" id="1610617">[</span><span class="num" id="1610618">0</span><span class="op" id="1610619">]</span>&nbsp;<span class="op" id="1610621">=</span>&nbsp;<span class="ident" id="1610623">getcallerpc</span><span class="op" id="1610634">(</span><span class="op" id="1610635">(</span><span class="ident" id="1610636">unsafe</span><span class="op" id="1610642">.</span><span class="ident" id="1610643">Pointer</span><span class="op" id="1610650">)</span><span class="op" id="1610651">(</span><span class="op" id="1610652">&amp;</span><span class="ident" id="1610653">unused</span><span class="op" id="1610659">)</span><span class="op" id="1610660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610663">mp</span><span class="op" id="1610665">.</span><span class="ident" id="1610666">scalararg</span><span class="op" id="1610675">[</span><span class="num" id="1610676">1</span><span class="op" id="1610677">]</span>&nbsp;<span class="op" id="1610679">=</span>&nbsp;<span class="ident" id="1610681">getcallersp</span><span class="op" id="1610692">(</span><span class="op" id="1610693">(</span><span class="ident" id="1610694">unsafe</span><span class="op" id="1610700">.</span><span class="ident" id="1610701">Pointer</span><span class="op" id="1610708">)</span><span class="op" id="1610709">(</span><span class="op" id="1610710">&amp;</span><span class="ident" id="1610711">unused</span><span class="op" id="1610717">)</span><span class="op" id="1610718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610721">onM_signalok</span><span class="op" id="1610733">(</span><span class="ident" id="1610734">dopanic_m</span><span class="op" id="1610743">)</span>&nbsp;<span class="comment" id="1610745">//&nbsp;should&nbsp;never&nbsp;return</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610769">*</span><span class="op" id="1610770">(</span><span class="op" id="1610771">*</span><span class="builtintype" id="1610772">int</span><span class="op" id="1610775">)</span><span class="op" id="1610776">(</span><span class="ident" id="1610777">nil</span><span class="op" id="1610780">)</span>&nbsp;<span class="op" id="1610782">=</span>&nbsp;<span class="num" id="1610784">0</span><br>
<span class="lineno"></span><span class="op" id="1610786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1610789">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1610802">func</span>&nbsp;<span class="ident" id="1610807">throw</span><span class="op" id="1610812">(</span><span class="ident" id="1610813">s</span>&nbsp;<span class="op" id="1610815">*</span><span class="builtintype" id="1610816">byte</span><span class="op" id="1610820">)</span>&nbsp;<span class="op" id="1610822">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610825">gp</span>&nbsp;<span class="op" id="1610828">:=</span>&nbsp;<span class="ident" id="1610831">getg</span><span class="op" id="1610835">(</span><span class="op" id="1610836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610839">if</span>&nbsp;<span class="ident" id="1610842">gp</span><span class="op" id="1610844">.</span><span class="ident" id="1610845">m</span><span class="op" id="1610846">.</span><span class="ident" id="1610847">throwing</span>&nbsp;<span class="op" id="1610856">==</span>&nbsp;<span class="num" id="1610859">0</span>&nbsp;<span class="op" id="1610861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610865">gp</span><span class="op" id="1610867">.</span><span class="ident" id="1610868">m</span><span class="op" id="1610869">.</span><span class="ident" id="1610870">throwing</span>&nbsp;<span class="op" id="1610879">=</span>&nbsp;<span class="num" id="1610881">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610887">startpanic</span><span class="op" id="1610897">(</span><span class="op" id="1610898">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1610901">print</span><span class="op" id="1610906">(</span><span class="string" id="1610907">&#34;fatal&nbsp;error:&nbsp;&#34;</span><span class="op" id="1610922">,</span>&nbsp;<span class="ident" id="1610924">gostringnocopy</span><span class="op" id="1610938">(</span><span class="ident" id="1610939">s</span><span class="op" id="1610940">)</span><span class="op" id="1610941">,</span>&nbsp;<span class="string" id="1610943">&#34;\n&#34;</span><span class="op" id="1610947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610950">dopanic</span><span class="op" id="1610957">(</span><span class="num" id="1610958">0</span><span class="op" id="1610959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610962">*</span><span class="op" id="1610963">(</span><span class="op" id="1610964">*</span><span class="builtintype" id="1610965">int</span><span class="op" id="1610968">)</span><span class="op" id="1610969">(</span><span class="ident" id="1610970">nil</span><span class="op" id="1610973">)</span>&nbsp;<span class="op" id="1610975">=</span>&nbsp;<span class="num" id="1610977">0</span>&nbsp;<span class="comment" id="1610979">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno"></span><span class="op" id="1610994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="1610997">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1611010">func</span>&nbsp;<span class="ident" id="1611015">gothrow</span><span class="op" id="1611022">(</span><span class="ident" id="1611023">s</span>&nbsp;<span class="builtintype" id="1611025">string</span><span class="op" id="1611031">)</span>&nbsp;<span class="op" id="1611033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611036">gp</span>&nbsp;<span class="op" id="1611039">:=</span>&nbsp;<span class="ident" id="1611042">getg</span><span class="op" id="1611046">(</span><span class="op" id="1611047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611050">if</span>&nbsp;<span class="ident" id="1611053">gp</span><span class="op" id="1611055">.</span><span class="ident" id="1611056">m</span><span class="op" id="1611057">.</span><span class="ident" id="1611058">throwing</span>&nbsp;<span class="op" id="1611067">==</span>&nbsp;<span class="num" id="1611070">0</span>&nbsp;<span class="op" id="1611072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611076">gp</span><span class="op" id="1611078">.</span><span class="ident" id="1611079">m</span><span class="op" id="1611080">.</span><span class="ident" id="1611081">throwing</span>&nbsp;<span class="op" id="1611090">=</span>&nbsp;<span class="num" id="1611092">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611098">startpanic</span><span class="op" id="1611108">(</span><span class="op" id="1611109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1611112">print</span><span class="op" id="1611117">(</span><span class="string" id="1611118">&#34;fatal&nbsp;error:&nbsp;&#34;</span><span class="op" id="1611133">,</span>&nbsp;<span class="ident" id="1611135">s</span><span class="op" id="1611136">,</span>&nbsp;<span class="string" id="1611138">&#34;\n&#34;</span><span class="op" id="1611142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611145">dopanic</span><span class="op" id="1611152">(</span><span class="num" id="1611153">0</span><span class="op" id="1611154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611157">*</span><span class="op" id="1611158">(</span><span class="op" id="1611159">*</span><span class="builtintype" id="1611160">int</span><span class="op" id="1611163">)</span><span class="op" id="1611164">(</span><span class="ident" id="1611165">nil</span><span class="op" id="1611168">)</span>&nbsp;<span class="op" id="1611170">=</span>&nbsp;<span class="num" id="1611172">0</span>&nbsp;<span class="comment" id="1611174">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno">505</span><span class="op" id="1611189">}</span>
</div>
</body>
</html>
