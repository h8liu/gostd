<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1824580">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1824635">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1824689">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1824740">package</span>&nbsp;<span class="ident" id="1824748">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1824757">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;channels.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1824815">import</span>&nbsp;<span class="string" id="1824822">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1824832">const</span>&nbsp;<span class="op" id="1824838">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1824841">maxAlign</span>&nbsp;&nbsp;<span class="op" id="1824851">=</span>&nbsp;<span class="num" id="1824853">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1824856">hchanSize</span>&nbsp;<span class="op" id="1824866">=</span>&nbsp;<span class="ident" id="1824868">unsafe</span><span class="op" id="1824874">.</span><span class="ident" id="1824875">Sizeof</span><span class="op" id="1824881">(</span><span class="ident" id="1824882">hchan</span><span class="op" id="1824887">{</span><span class="op" id="1824888">}</span><span class="op" id="1824889">)</span>&nbsp;<span class="op" id="1824891">+</span>&nbsp;<span class="builtintype" id="1824893">uintptr</span><span class="op" id="1824900">(</span><span class="op" id="1824901">-</span><span class="builtintype" id="1824902">int</span><span class="op" id="1824905">(</span><span class="ident" id="1824906">unsafe</span><span class="op" id="1824912">.</span><span class="ident" id="1824913">Sizeof</span><span class="op" id="1824919">(</span><span class="ident" id="1824920">hchan</span><span class="op" id="1824925">{</span><span class="op" id="1824926">}</span><span class="op" id="1824927">)</span><span class="op" id="1824928">)</span><span class="op" id="1824929">&amp;</span><span class="op" id="1824930">(</span><span class="ident" id="1824931">maxAlign</span><span class="op" id="1824939">-</span><span class="num" id="1824940">1</span><span class="op" id="1824941">)</span><span class="op" id="1824942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1824945">debugChan</span>&nbsp;<span class="op" id="1824955">=</span>&nbsp;<span class="builtintype" id="1824957">false</span><br>
<span class="lineno">15</span><span class="op" id="1824963">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1824966">//&nbsp;TODO(khr):&nbsp;make&nbsp;hchan.buf&nbsp;an&nbsp;unsafe.Pointer,&nbsp;not&nbsp;a&nbsp;*uint8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1825028">func</span>&nbsp;<span class="ident" id="1825033">makechan</span><span class="op" id="1825041">(</span><span class="ident" id="1825042">t</span>&nbsp;<span class="op" id="1825044">*</span><span class="ident" id="1825045">chantype</span><span class="op" id="1825053">,</span>&nbsp;<span class="ident" id="1825055">size</span>&nbsp;<span class="ident" id="1825060">int64</span><span class="op" id="1825065">)</span>&nbsp;<span class="op" id="1825067">*</span><span class="ident" id="1825068">hchan</span>&nbsp;<span class="op" id="1825074">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1825077">elem</span>&nbsp;<span class="op" id="1825082">:=</span>&nbsp;<span class="ident" id="1825085">t</span><span class="op" id="1825086">.</span><span class="ident" id="1825087">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1825094">//&nbsp;compiler&nbsp;checks&nbsp;this&nbsp;but&nbsp;be&nbsp;safe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1825132">if</span>&nbsp;<span class="ident" id="1825135">elem</span><span class="op" id="1825139">.</span><span class="ident" id="1825140">size</span>&nbsp;<span class="op" id="1825145">&gt;=</span>&nbsp;<span class="num" id="1825148">1</span><span class="op" id="1825149">&lt;&lt;</span><span class="num" id="1825151">16</span>&nbsp;<span class="op" id="1825154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1825158">gothrow</span><span class="op" id="1825165">(</span><span class="string" id="1825166">&#34;makechan:&nbsp;invalid&nbsp;channel&nbsp;element&nbsp;type&#34;</span><span class="op" id="1825206">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1825209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1825212">if</span>&nbsp;<span class="ident" id="1825215">hchanSize</span><span class="op" id="1825224">%</span><span class="ident" id="1825225">maxAlign</span>&nbsp;<span class="op" id="1825234">!=</span>&nbsp;<span class="num" id="1825237">0</span>&nbsp;<span class="op" id="1825239">||</span>&nbsp;<span class="ident" id="1825242">elem</span><span class="op" id="1825246">.</span><span class="ident" id="1825247">align</span>&nbsp;<span class="op" id="1825253">&gt;</span>&nbsp;<span class="ident" id="1825255">maxAlign</span>&nbsp;<span class="op" id="1825264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1825268">gothrow</span><span class="op" id="1825275">(</span><span class="string" id="1825276">&#34;makechan:&nbsp;bad&nbsp;alignment&#34;</span><span class="op" id="1825301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1825304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1825307">if</span>&nbsp;<span class="ident" id="1825310">size</span>&nbsp;<span class="op" id="1825315">&lt;</span>&nbsp;<span class="num" id="1825317">0</span>&nbsp;<span class="op" id="1825319">||</span>&nbsp;<span class="ident" id="1825322">int64</span><span class="op" id="1825327">(</span><span class="builtintype" id="1825328">uintptr</span><span class="op" id="1825335">(</span><span class="ident" id="1825336">size</span><span class="op" id="1825340">)</span><span class="op" id="1825341">)</span>&nbsp;<span class="op" id="1825343">!=</span>&nbsp;<span class="ident" id="1825346">size</span>&nbsp;<span class="op" id="1825351">||</span>&nbsp;<span class="op" id="1825354">(</span><span class="ident" id="1825355">elem</span><span class="op" id="1825359">.</span><span class="ident" id="1825360">size</span>&nbsp;<span class="op" id="1825365">&gt;</span>&nbsp;<span class="num" id="1825367">0</span>&nbsp;<span class="op" id="1825369">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1825372">uintptr</span><span class="op" id="1825379">(</span><span class="ident" id="1825380">size</span><span class="op" id="1825384">)</span>&nbsp;<span class="op" id="1825386">&gt;</span>&nbsp;<span class="op" id="1825388">(</span><span class="ident" id="1825389">maxmem</span><span class="op" id="1825395">-</span><span class="ident" id="1825396">hchanSize</span><span class="op" id="1825405">)</span><span class="op" id="1825406">/</span><span class="builtintype" id="1825407">uintptr</span><span class="op" id="1825414">(</span><span class="ident" id="1825415">elem</span><span class="op" id="1825419">.</span><span class="ident" id="1825420">size</span><span class="op" id="1825424">)</span><span class="op" id="1825425">)</span>&nbsp;<span class="op" id="1825427">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1825431">panic</span><span class="op" id="1825436">(</span><span class="string" id="1825437">&#34;makechan:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1825466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1825469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1825473">var</span>&nbsp;<span class="ident" id="1825477">c</span>&nbsp;<span class="op" id="1825479">*</span><span class="ident" id="1825480">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1825487">if</span>&nbsp;<span class="ident" id="1825490">elem</span><span class="op" id="1825494">.</span><span class="ident" id="1825495">kind</span><span class="op" id="1825499">&amp;</span><span class="ident" id="1825500">kindNoPointers</span>&nbsp;<span class="op" id="1825515">!=</span>&nbsp;<span class="num" id="1825518">0</span>&nbsp;<span class="op" id="1825520">||</span>&nbsp;<span class="ident" id="1825523">size</span>&nbsp;<span class="op" id="1825528">==</span>&nbsp;<span class="num" id="1825531">0</span>&nbsp;<span class="op" id="1825533">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1825537">//&nbsp;Allocate&nbsp;memory&nbsp;in&nbsp;one&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1825571">//&nbsp;Hchan&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC&nbsp;in&nbsp;this&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1825641">//&nbsp;buf&nbsp;points&nbsp;into&nbsp;the&nbsp;same&nbsp;allocation,&nbsp;elemtype&nbsp;is&nbsp;persistent.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1825707">//&nbsp;SudoG&#39;s&nbsp;are&nbsp;referenced&nbsp;from&nbsp;their&nbsp;owning&nbsp;thread&nbsp;so&nbsp;they&nbsp;can&#39;t&nbsp;be&nbsp;collected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1825788">//&nbsp;TODO(dvyukov,rlh):&nbsp;Rethink&nbsp;when&nbsp;collector&nbsp;can&nbsp;move&nbsp;allocated&nbsp;objects.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1825863">c</span>&nbsp;<span class="op" id="1825865">=</span>&nbsp;<span class="op" id="1825867">(</span><span class="op" id="1825868">*</span><span class="ident" id="1825869">hchan</span><span class="op" id="1825874">)</span><span class="op" id="1825875">(</span><span class="ident" id="1825876">mallocgc</span><span class="op" id="1825884">(</span><span class="ident" id="1825885">hchanSize</span><span class="op" id="1825894">+</span><span class="builtintype" id="1825895">uintptr</span><span class="op" id="1825902">(</span><span class="ident" id="1825903">size</span><span class="op" id="1825907">)</span><span class="op" id="1825908">*</span><span class="builtintype" id="1825909">uintptr</span><span class="op" id="1825916">(</span><span class="ident" id="1825917">elem</span><span class="op" id="1825921">.</span><span class="ident" id="1825922">size</span><span class="op" id="1825926">)</span><span class="op" id="1825927">,</span>&nbsp;<span class="ident" id="1825929">nil</span><span class="op" id="1825932">,</span>&nbsp;<span class="ident" id="1825934">flagNoScan</span><span class="op" id="1825944">)</span><span class="op" id="1825945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1825949">if</span>&nbsp;<span class="ident" id="1825952">size</span>&nbsp;<span class="op" id="1825957">&gt;</span>&nbsp;<span class="num" id="1825959">0</span>&nbsp;<span class="op" id="1825961">&amp;&amp;</span>&nbsp;<span class="ident" id="1825964">elem</span><span class="op" id="1825968">.</span><span class="ident" id="1825969">size</span>&nbsp;<span class="op" id="1825974">!=</span>&nbsp;<span class="num" id="1825977">0</span>&nbsp;<span class="op" id="1825979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1825984">c</span><span class="op" id="1825985">.</span><span class="ident" id="1825986">buf</span>&nbsp;<span class="op" id="1825990">=</span>&nbsp;<span class="op" id="1825992">(</span><span class="op" id="1825993">*</span><span class="builtintype" id="1825994">uint8</span><span class="op" id="1825999">)</span><span class="op" id="1826000">(</span><span class="ident" id="1826001">add</span><span class="op" id="1826004">(</span><span class="ident" id="1826005">unsafe</span><span class="op" id="1826011">.</span><span class="ident" id="1826012">Pointer</span><span class="op" id="1826019">(</span><span class="ident" id="1826020">c</span><span class="op" id="1826021">)</span><span class="op" id="1826022">,</span>&nbsp;<span class="ident" id="1826024">hchanSize</span><span class="op" id="1826033">)</span><span class="op" id="1826034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1826038">}</span>&nbsp;<span class="keyword" id="1826040">else</span>&nbsp;<span class="op" id="1826045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1826050">c</span><span class="op" id="1826051">.</span><span class="ident" id="1826052">buf</span>&nbsp;<span class="op" id="1826056">=</span>&nbsp;<span class="op" id="1826058">(</span><span class="op" id="1826059">*</span><span class="builtintype" id="1826060">uint8</span><span class="op" id="1826065">)</span><span class="op" id="1826066">(</span><span class="ident" id="1826067">unsafe</span><span class="op" id="1826073">.</span><span class="ident" id="1826074">Pointer</span><span class="op" id="1826081">(</span><span class="ident" id="1826082">c</span><span class="op" id="1826083">)</span><span class="op" id="1826084">)</span>&nbsp;<span class="comment" id="1826086">//&nbsp;race&nbsp;detector&nbsp;uses&nbsp;this&nbsp;location&nbsp;for&nbsp;synchronization</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1826144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1826147">}</span>&nbsp;<span class="keyword" id="1826149">else</span>&nbsp;<span class="op" id="1826154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1826158">c</span>&nbsp;<span class="op" id="1826160">=</span>&nbsp;<span class="builtinfunc" id="1826162">new</span><span class="op" id="1826165">(</span><span class="ident" id="1826166">hchan</span><span class="op" id="1826171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1826175">c</span><span class="op" id="1826176">.</span><span class="ident" id="1826177">buf</span>&nbsp;<span class="op" id="1826181">=</span>&nbsp;<span class="op" id="1826183">(</span><span class="op" id="1826184">*</span><span class="builtintype" id="1826185">uint8</span><span class="op" id="1826190">)</span><span class="op" id="1826191">(</span><span class="ident" id="1826192">newarray</span><span class="op" id="1826200">(</span><span class="ident" id="1826201">elem</span><span class="op" id="1826205">,</span>&nbsp;<span class="builtintype" id="1826207">uintptr</span><span class="op" id="1826214">(</span><span class="ident" id="1826215">size</span><span class="op" id="1826219">)</span><span class="op" id="1826220">)</span><span class="op" id="1826221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1826224">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1826227">c</span><span class="op" id="1826228">.</span><span class="ident" id="1826229">elemsize</span>&nbsp;<span class="op" id="1826238">=</span>&nbsp;<span class="builtintype" id="1826240">uint16</span><span class="op" id="1826246">(</span><span class="ident" id="1826247">elem</span><span class="op" id="1826251">.</span><span class="ident" id="1826252">size</span><span class="op" id="1826256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1826259">c</span><span class="op" id="1826260">.</span><span class="ident" id="1826261">elemtype</span>&nbsp;<span class="op" id="1826270">=</span>&nbsp;<span class="ident" id="1826272">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1826278">c</span><span class="op" id="1826279">.</span><span class="ident" id="1826280">dataqsiz</span>&nbsp;<span class="op" id="1826289">=</span>&nbsp;<span class="builtintype" id="1826291">uint</span><span class="op" id="1826295">(</span><span class="ident" id="1826296">size</span><span class="op" id="1826300">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1826304">if</span>&nbsp;<span class="ident" id="1826307">debugChan</span>&nbsp;<span class="op" id="1826317">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1826321">print</span><span class="op" id="1826326">(</span><span class="string" id="1826327">&#34;makechan:&nbsp;chan=&#34;</span><span class="op" id="1826344">,</span>&nbsp;<span class="ident" id="1826346">c</span><span class="op" id="1826347">,</span>&nbsp;<span class="string" id="1826349">&#34;;&nbsp;elemsize=&#34;</span><span class="op" id="1826362">,</span>&nbsp;<span class="ident" id="1826364">elem</span><span class="op" id="1826368">.</span><span class="ident" id="1826369">size</span><span class="op" id="1826373">,</span>&nbsp;<span class="string" id="1826375">&#34;;&nbsp;elemalg=&#34;</span><span class="op" id="1826387">,</span>&nbsp;<span class="ident" id="1826389">elem</span><span class="op" id="1826393">.</span><span class="ident" id="1826394">alg</span><span class="op" id="1826397">,</span>&nbsp;<span class="string" id="1826399">&#34;;&nbsp;dataqsiz=&#34;</span><span class="op" id="1826412">,</span>&nbsp;<span class="ident" id="1826414">size</span><span class="op" id="1826418">,</span>&nbsp;<span class="string" id="1826420">&#34;\n&#34;</span><span class="op" id="1826424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1826427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1826430">return</span>&nbsp;<span class="ident" id="1826437">c</span><br>
<span class="lineno"></span><span class="op" id="1826439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1826442">//&nbsp;chanbuf(c,&nbsp;i)&nbsp;is&nbsp;pointer&nbsp;to&nbsp;the&nbsp;i&#39;th&nbsp;slot&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1826502">func</span>&nbsp;<span class="ident" id="1826507">chanbuf</span><span class="op" id="1826514">(</span><span class="ident" id="1826515">c</span>&nbsp;<span class="op" id="1826517">*</span><span class="ident" id="1826518">hchan</span><span class="op" id="1826523">,</span>&nbsp;<span class="ident" id="1826525">i</span>&nbsp;<span class="builtintype" id="1826527">uint</span><span class="op" id="1826531">)</span>&nbsp;<span class="ident" id="1826533">unsafe</span><span class="op" id="1826539">.</span><span class="ident" id="1826540">Pointer</span>&nbsp;<span class="op" id="1826548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1826551">return</span>&nbsp;<span class="ident" id="1826558">add</span><span class="op" id="1826561">(</span><span class="ident" id="1826562">unsafe</span><span class="op" id="1826568">.</span><span class="ident" id="1826569">Pointer</span><span class="op" id="1826576">(</span><span class="ident" id="1826577">c</span><span class="op" id="1826578">.</span><span class="ident" id="1826579">buf</span><span class="op" id="1826582">)</span><span class="op" id="1826583">,</span>&nbsp;<span class="builtintype" id="1826585">uintptr</span><span class="op" id="1826592">(</span><span class="ident" id="1826593">i</span><span class="op" id="1826594">)</span><span class="op" id="1826595">*</span><span class="builtintype" id="1826596">uintptr</span><span class="op" id="1826603">(</span><span class="ident" id="1826604">c</span><span class="op" id="1826605">.</span><span class="ident" id="1826606">elemsize</span><span class="op" id="1826614">)</span><span class="op" id="1826615">)</span><br>
<span class="lineno"></span><span class="op" id="1826617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1826620">//&nbsp;entry&nbsp;point&nbsp;for&nbsp;c&nbsp;&lt;-&nbsp;x&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1826665">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1826678">func</span>&nbsp;<span class="ident" id="1826683">chansend1</span><span class="op" id="1826692">(</span><span class="ident" id="1826693">t</span>&nbsp;<span class="op" id="1826695">*</span><span class="ident" id="1826696">chantype</span><span class="op" id="1826704">,</span>&nbsp;<span class="ident" id="1826706">c</span>&nbsp;<span class="op" id="1826708">*</span><span class="ident" id="1826709">hchan</span><span class="op" id="1826714">,</span>&nbsp;<span class="ident" id="1826716">elem</span>&nbsp;<span class="ident" id="1826721">unsafe</span><span class="op" id="1826727">.</span><span class="ident" id="1826728">Pointer</span><span class="op" id="1826735">)</span>&nbsp;<span class="op" id="1826737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1826740">chansend</span><span class="op" id="1826748">(</span><span class="ident" id="1826749">t</span><span class="op" id="1826750">,</span>&nbsp;<span class="ident" id="1826752">c</span><span class="op" id="1826753">,</span>&nbsp;<span class="ident" id="1826755">elem</span><span class="op" id="1826759">,</span>&nbsp;<span class="builtintype" id="1826761">true</span><span class="op" id="1826765">,</span>&nbsp;<span class="ident" id="1826767">getcallerpc</span><span class="op" id="1826778">(</span><span class="ident" id="1826779">unsafe</span><span class="op" id="1826785">.</span><span class="ident" id="1826786">Pointer</span><span class="op" id="1826793">(</span><span class="op" id="1826794">&amp;</span><span class="ident" id="1826795">t</span><span class="op" id="1826796">)</span><span class="op" id="1826797">)</span><span class="op" id="1826798">)</span><br>
<span class="lineno"></span><span class="op" id="1826800">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1826803">/*<br>
<span class="lineno"></span>&nbsp;*&nbsp;generic&nbsp;single&nbsp;channel&nbsp;send/recv<br>
<span class="lineno"></span>&nbsp;*&nbsp;If&nbsp;block&nbsp;is&nbsp;not&nbsp;nil,<br>
<span class="lineno"></span>&nbsp;*&nbsp;then&nbsp;the&nbsp;protocol&nbsp;will&nbsp;not<br>
<span class="lineno">75</span>&nbsp;*&nbsp;sleep&nbsp;but&nbsp;return&nbsp;if&nbsp;it&nbsp;could<br>
<span class="lineno"></span>&nbsp;*&nbsp;not&nbsp;complete.<br>
<span class="lineno"></span>&nbsp;*<br>
<span class="lineno"></span>&nbsp;*&nbsp;sleep&nbsp;can&nbsp;wake&nbsp;up&nbsp;with&nbsp;g.param&nbsp;==&nbsp;nil<br>
<span class="lineno"></span>&nbsp;*&nbsp;when&nbsp;a&nbsp;channel&nbsp;involved&nbsp;in&nbsp;the&nbsp;sleep&nbsp;has<br>
<span class="lineno">80</span>&nbsp;*&nbsp;been&nbsp;closed.&nbsp;&nbsp;it&nbsp;is&nbsp;easiest&nbsp;to&nbsp;loop&nbsp;and&nbsp;re-run<br>
<span class="lineno"></span>&nbsp;*&nbsp;the&nbsp;operation;&nbsp;we&#39;ll&nbsp;see&nbsp;that&nbsp;it&#39;s&nbsp;now&nbsp;closed.<br>
<span class="lineno"></span>&nbsp;*/</span><br>
<span class="lineno"></span><span class="keyword" id="1827137">func</span>&nbsp;<span class="ident" id="1827142">chansend</span><span class="op" id="1827150">(</span><span class="ident" id="1827151">t</span>&nbsp;<span class="op" id="1827153">*</span><span class="ident" id="1827154">chantype</span><span class="op" id="1827162">,</span>&nbsp;<span class="ident" id="1827164">c</span>&nbsp;<span class="op" id="1827166">*</span><span class="ident" id="1827167">hchan</span><span class="op" id="1827172">,</span>&nbsp;<span class="ident" id="1827174">ep</span>&nbsp;<span class="ident" id="1827177">unsafe</span><span class="op" id="1827183">.</span><span class="ident" id="1827184">Pointer</span><span class="op" id="1827191">,</span>&nbsp;<span class="ident" id="1827193">block</span>&nbsp;<span class="builtintype" id="1827199">bool</span><span class="op" id="1827203">,</span>&nbsp;<span class="ident" id="1827205">callerpc</span>&nbsp;<span class="builtintype" id="1827214">uintptr</span><span class="op" id="1827221">)</span>&nbsp;<span class="builtintype" id="1827223">bool</span>&nbsp;<span class="op" id="1827228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1827231">if</span>&nbsp;<span class="ident" id="1827234">raceenabled</span>&nbsp;<span class="op" id="1827246">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1827250">raceReadObjectPC</span><span class="op" id="1827266">(</span><span class="ident" id="1827267">t</span><span class="op" id="1827268">.</span><span class="ident" id="1827269">elem</span><span class="op" id="1827273">,</span>&nbsp;<span class="ident" id="1827275">ep</span><span class="op" id="1827277">,</span>&nbsp;<span class="ident" id="1827279">callerpc</span><span class="op" id="1827287">,</span>&nbsp;<span class="ident" id="1827289">funcPC</span><span class="op" id="1827295">(</span><span class="ident" id="1827296">chansend</span><span class="op" id="1827304">)</span><span class="op" id="1827305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1827308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1827312">if</span>&nbsp;<span class="ident" id="1827315">c</span>&nbsp;<span class="op" id="1827317">==</span>&nbsp;<span class="ident" id="1827320">nil</span>&nbsp;<span class="op" id="1827324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1827328">if</span>&nbsp;<span class="op" id="1827331">!</span><span class="ident" id="1827332">block</span>&nbsp;<span class="op" id="1827338">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1827343">return</span>&nbsp;<span class="builtintype" id="1827350">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1827358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1827362">gopark</span><span class="op" id="1827368">(</span><span class="ident" id="1827369">nil</span><span class="op" id="1827372">,</span>&nbsp;<span class="ident" id="1827374">nil</span><span class="op" id="1827377">,</span>&nbsp;<span class="string" id="1827379">&#34;chan&nbsp;send&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1827401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1827405">gothrow</span><span class="op" id="1827412">(</span><span class="string" id="1827413">&#34;unreachable&#34;</span><span class="op" id="1827426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1827429">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1827433">if</span>&nbsp;<span class="ident" id="1827436">debugChan</span>&nbsp;<span class="op" id="1827446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1827450">print</span><span class="op" id="1827455">(</span><span class="string" id="1827456">&#34;chansend:&nbsp;chan=&#34;</span><span class="op" id="1827473">,</span>&nbsp;<span class="ident" id="1827475">c</span><span class="op" id="1827476">,</span>&nbsp;<span class="string" id="1827478">&#34;\n&#34;</span><span class="op" id="1827482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1827485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1827489">if</span>&nbsp;<span class="ident" id="1827492">raceenabled</span>&nbsp;<span class="op" id="1827504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1827508">racereadpc</span><span class="op" id="1827518">(</span><span class="ident" id="1827519">unsafe</span><span class="op" id="1827525">.</span><span class="ident" id="1827526">Pointer</span><span class="op" id="1827533">(</span><span class="ident" id="1827534">c</span><span class="op" id="1827535">)</span><span class="op" id="1827536">,</span>&nbsp;<span class="ident" id="1827538">callerpc</span><span class="op" id="1827546">,</span>&nbsp;<span class="ident" id="1827548">funcPC</span><span class="op" id="1827554">(</span><span class="ident" id="1827555">chansend</span><span class="op" id="1827563">)</span><span class="op" id="1827564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1827567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1827571">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1827654">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1827658">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1827741">//&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1827823">//&nbsp;(first&nbsp;c.closed&nbsp;and&nbsp;second&nbsp;c.recvq.first&nbsp;or&nbsp;c.qcount&nbsp;depending&nbsp;on&nbsp;kind&nbsp;of&nbsp;channel).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1827911">//&nbsp;Because&nbsp;a&nbsp;closed&nbsp;channel&nbsp;cannot&nbsp;transition&nbsp;from&nbsp;&#39;ready&nbsp;for&nbsp;sending&#39;&nbsp;to</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1827986">//&nbsp;&#39;not&nbsp;ready&nbsp;for&nbsp;sending&#39;,&nbsp;even&nbsp;if&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed&nbsp;between&nbsp;the&nbsp;two&nbsp;observations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1828075">//&nbsp;they&nbsp;imply&nbsp;a&nbsp;moment&nbsp;between&nbsp;the&nbsp;two&nbsp;when&nbsp;the&nbsp;channel&nbsp;was&nbsp;both&nbsp;not&nbsp;yet&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1828156">//&nbsp;and&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1828243">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;send&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1828288">//</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1828292">//&nbsp;It&nbsp;is&nbsp;okay&nbsp;if&nbsp;the&nbsp;reads&nbsp;are&nbsp;reordered&nbsp;here:&nbsp;if&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1828378">//&nbsp;ready&nbsp;for&nbsp;sending&nbsp;and&nbsp;then&nbsp;observe&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;closed,&nbsp;that&nbsp;implies&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1828462">//&nbsp;channel&nbsp;wasn&#39;t&nbsp;closed&nbsp;during&nbsp;the&nbsp;first&nbsp;observation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1828518">if</span>&nbsp;<span class="op" id="1828521">!</span><span class="ident" id="1828522">block</span>&nbsp;<span class="op" id="1828528">&amp;&amp;</span>&nbsp;<span class="ident" id="1828531">c</span><span class="op" id="1828532">.</span><span class="ident" id="1828533">closed</span>&nbsp;<span class="op" id="1828540">==</span>&nbsp;<span class="num" id="1828543">0</span>&nbsp;<span class="op" id="1828545">&amp;&amp;</span>&nbsp;<span class="op" id="1828548">(</span><span class="op" id="1828549">(</span><span class="ident" id="1828550">c</span><span class="op" id="1828551">.</span><span class="ident" id="1828552">dataqsiz</span>&nbsp;<span class="op" id="1828561">==</span>&nbsp;<span class="num" id="1828564">0</span>&nbsp;<span class="op" id="1828566">&amp;&amp;</span>&nbsp;<span class="ident" id="1828569">c</span><span class="op" id="1828570">.</span><span class="ident" id="1828571">recvq</span><span class="op" id="1828576">.</span><span class="ident" id="1828577">first</span>&nbsp;<span class="op" id="1828583">==</span>&nbsp;<span class="ident" id="1828586">nil</span><span class="op" id="1828589">)</span>&nbsp;<span class="op" id="1828591">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1828596">(</span><span class="ident" id="1828597">c</span><span class="op" id="1828598">.</span><span class="ident" id="1828599">dataqsiz</span>&nbsp;<span class="op" id="1828608">&gt;</span>&nbsp;<span class="num" id="1828610">0</span>&nbsp;<span class="op" id="1828612">&amp;&amp;</span>&nbsp;<span class="ident" id="1828615">c</span><span class="op" id="1828616">.</span><span class="ident" id="1828617">qcount</span>&nbsp;<span class="op" id="1828624">==</span>&nbsp;<span class="ident" id="1828627">c</span><span class="op" id="1828628">.</span><span class="ident" id="1828629">dataqsiz</span><span class="op" id="1828637">)</span><span class="op" id="1828638">)</span>&nbsp;<span class="op" id="1828640">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1828644">return</span>&nbsp;<span class="builtintype" id="1828651">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1828658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1828662">var</span>&nbsp;<span class="ident" id="1828666">t0</span>&nbsp;<span class="ident" id="1828669">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1828676">if</span>&nbsp;<span class="ident" id="1828679">blockprofilerate</span>&nbsp;<span class="op" id="1828696">&gt;</span>&nbsp;<span class="num" id="1828698">0</span>&nbsp;<span class="op" id="1828700">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1828704">t0</span>&nbsp;<span class="op" id="1828707">=</span>&nbsp;<span class="ident" id="1828709">cputicks</span><span class="op" id="1828717">(</span><span class="op" id="1828718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1828721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1828725">lock</span><span class="op" id="1828729">(</span><span class="op" id="1828730">&amp;</span><span class="ident" id="1828731">c</span><span class="op" id="1828732">.</span><span class="ident" id="1828733">lock</span><span class="op" id="1828737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1828740">if</span>&nbsp;<span class="ident" id="1828743">c</span><span class="op" id="1828744">.</span><span class="ident" id="1828745">closed</span>&nbsp;<span class="op" id="1828752">!=</span>&nbsp;<span class="num" id="1828755">0</span>&nbsp;<span class="op" id="1828757">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1828761">unlock</span><span class="op" id="1828767">(</span><span class="op" id="1828768">&amp;</span><span class="ident" id="1828769">c</span><span class="op" id="1828770">.</span><span class="ident" id="1828771">lock</span><span class="op" id="1828775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1828779">panic</span><span class="op" id="1828784">(</span><span class="string" id="1828785">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1828809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1828812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1828816">if</span>&nbsp;<span class="ident" id="1828819">c</span><span class="op" id="1828820">.</span><span class="ident" id="1828821">dataqsiz</span>&nbsp;<span class="op" id="1828830">==</span>&nbsp;<span class="num" id="1828833">0</span>&nbsp;<span class="op" id="1828835">{</span>&nbsp;<span class="comment" id="1828837">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1828862">sg</span>&nbsp;<span class="op" id="1828865">:=</span>&nbsp;<span class="ident" id="1828868">c</span><span class="op" id="1828869">.</span><span class="ident" id="1828870">recvq</span><span class="op" id="1828875">.</span><span class="ident" id="1828876">dequeue</span><span class="op" id="1828883">(</span><span class="op" id="1828884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1828888">if</span>&nbsp;<span class="ident" id="1828891">sg</span>&nbsp;<span class="op" id="1828894">!=</span>&nbsp;<span class="ident" id="1828897">nil</span>&nbsp;<span class="op" id="1828901">{</span>&nbsp;<span class="comment" id="1828903">//&nbsp;found&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1828934">if</span>&nbsp;<span class="ident" id="1828937">raceenabled</span>&nbsp;<span class="op" id="1828949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1828955">racesync</span><span class="op" id="1828963">(</span><span class="ident" id="1828964">c</span><span class="op" id="1828965">,</span>&nbsp;<span class="ident" id="1828967">sg</span><span class="op" id="1828969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1828974">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1828979">unlock</span><span class="op" id="1828985">(</span><span class="op" id="1828986">&amp;</span><span class="ident" id="1828987">c</span><span class="op" id="1828988">.</span><span class="ident" id="1828989">lock</span><span class="op" id="1828993">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1828999">recvg</span>&nbsp;<span class="op" id="1829005">:=</span>&nbsp;<span class="ident" id="1829008">sg</span><span class="op" id="1829010">.</span><span class="ident" id="1829011">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1829016">if</span>&nbsp;<span class="ident" id="1829019">sg</span><span class="op" id="1829021">.</span><span class="ident" id="1829022">elem</span>&nbsp;<span class="op" id="1829027">!=</span>&nbsp;<span class="ident" id="1829030">nil</span>&nbsp;<span class="op" id="1829034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829040">memmove</span><span class="op" id="1829047">(</span><span class="ident" id="1829048">unsafe</span><span class="op" id="1829054">.</span><span class="ident" id="1829055">Pointer</span><span class="op" id="1829062">(</span><span class="ident" id="1829063">sg</span><span class="op" id="1829065">.</span><span class="ident" id="1829066">elem</span><span class="op" id="1829070">)</span><span class="op" id="1829071">,</span>&nbsp;<span class="ident" id="1829073">ep</span><span class="op" id="1829075">,</span>&nbsp;<span class="builtintype" id="1829077">uintptr</span><span class="op" id="1829084">(</span><span class="ident" id="1829085">c</span><span class="op" id="1829086">.</span><span class="ident" id="1829087">elemsize</span><span class="op" id="1829095">)</span><span class="op" id="1829096">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829102">sg</span><span class="op" id="1829104">.</span><span class="ident" id="1829105">elem</span>&nbsp;<span class="op" id="1829110">=</span>&nbsp;<span class="ident" id="1829112">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1829119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829124">recvg</span><span class="op" id="1829129">.</span><span class="ident" id="1829130">param</span>&nbsp;<span class="op" id="1829136">=</span>&nbsp;<span class="ident" id="1829138">unsafe</span><span class="op" id="1829144">.</span><span class="ident" id="1829145">Pointer</span><span class="op" id="1829152">(</span><span class="ident" id="1829153">sg</span><span class="op" id="1829155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1829160">if</span>&nbsp;<span class="ident" id="1829163">sg</span><span class="op" id="1829165">.</span><span class="ident" id="1829166">releasetime</span>&nbsp;<span class="op" id="1829178">!=</span>&nbsp;<span class="num" id="1829181">0</span>&nbsp;<span class="op" id="1829183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829189">sg</span><span class="op" id="1829191">.</span><span class="ident" id="1829192">releasetime</span>&nbsp;<span class="op" id="1829204">=</span>&nbsp;<span class="ident" id="1829206">cputicks</span><span class="op" id="1829214">(</span><span class="op" id="1829215">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1829220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829225">goready</span><span class="op" id="1829232">(</span><span class="ident" id="1829233">recvg</span><span class="op" id="1829238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1829243">return</span>&nbsp;<span class="builtintype" id="1829250">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1829257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1829262">if</span>&nbsp;<span class="op" id="1829265">!</span><span class="ident" id="1829266">block</span>&nbsp;<span class="op" id="1829272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829277">unlock</span><span class="op" id="1829283">(</span><span class="op" id="1829284">&amp;</span><span class="ident" id="1829285">c</span><span class="op" id="1829286">.</span><span class="ident" id="1829287">lock</span><span class="op" id="1829291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1829296">return</span>&nbsp;<span class="builtintype" id="1829303">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1829311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1829316">//&nbsp;no&nbsp;receiver&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829367">gp</span>&nbsp;<span class="op" id="1829370">:=</span>&nbsp;<span class="ident" id="1829373">getg</span><span class="op" id="1829377">(</span><span class="op" id="1829378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829382">mysg</span>&nbsp;<span class="op" id="1829387">:=</span>&nbsp;<span class="ident" id="1829390">acquireSudog</span><span class="op" id="1829402">(</span><span class="op" id="1829403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829407">mysg</span><span class="op" id="1829411">.</span><span class="ident" id="1829412">releasetime</span>&nbsp;<span class="op" id="1829424">=</span>&nbsp;<span class="num" id="1829426">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1829430">if</span>&nbsp;<span class="ident" id="1829433">t0</span>&nbsp;<span class="op" id="1829436">!=</span>&nbsp;<span class="num" id="1829439">0</span>&nbsp;<span class="op" id="1829441">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829446">mysg</span><span class="op" id="1829450">.</span><span class="ident" id="1829451">releasetime</span>&nbsp;<span class="op" id="1829463">=</span>&nbsp;<span class="op" id="1829465">-</span><span class="num" id="1829466">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1829470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829474">mysg</span><span class="op" id="1829478">.</span><span class="ident" id="1829479">elem</span>&nbsp;<span class="op" id="1829484">=</span>&nbsp;<span class="ident" id="1829486">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829491">mysg</span><span class="op" id="1829495">.</span><span class="ident" id="1829496">waitlink</span>&nbsp;<span class="op" id="1829505">=</span>&nbsp;<span class="ident" id="1829507">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829513">gp</span><span class="op" id="1829515">.</span><span class="ident" id="1829516">waiting</span>&nbsp;<span class="op" id="1829524">=</span>&nbsp;<span class="ident" id="1829526">mysg</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829533">mysg</span><span class="op" id="1829537">.</span><span class="ident" id="1829538">g</span>&nbsp;<span class="op" id="1829540">=</span>&nbsp;<span class="ident" id="1829542">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829547">mysg</span><span class="op" id="1829551">.</span><span class="ident" id="1829552">selectdone</span>&nbsp;<span class="op" id="1829563">=</span>&nbsp;<span class="ident" id="1829565">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829571">gp</span><span class="op" id="1829573">.</span><span class="ident" id="1829574">param</span>&nbsp;<span class="op" id="1829580">=</span>&nbsp;<span class="ident" id="1829582">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829588">c</span><span class="op" id="1829589">.</span><span class="ident" id="1829590">sendq</span><span class="op" id="1829595">.</span><span class="ident" id="1829596">enqueue</span><span class="op" id="1829603">(</span><span class="ident" id="1829604">mysg</span><span class="op" id="1829608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829612">goparkunlock</span><span class="op" id="1829624">(</span><span class="op" id="1829625">&amp;</span><span class="ident" id="1829626">c</span><span class="op" id="1829627">.</span><span class="ident" id="1829628">lock</span><span class="op" id="1829632">,</span>&nbsp;<span class="string" id="1829634">&#34;chan&nbsp;send&#34;</span><span class="op" id="1829645">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1829650">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1829675">if</span>&nbsp;<span class="ident" id="1829678">mysg</span>&nbsp;<span class="op" id="1829683">!=</span>&nbsp;<span class="ident" id="1829686">gp</span><span class="op" id="1829688">.</span><span class="ident" id="1829689">waiting</span>&nbsp;<span class="op" id="1829697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829702">gothrow</span><span class="op" id="1829709">(</span><span class="string" id="1829710">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1829740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1829744">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829748">gp</span><span class="op" id="1829750">.</span><span class="ident" id="1829751">waiting</span>&nbsp;<span class="op" id="1829759">=</span>&nbsp;<span class="ident" id="1829761">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1829767">if</span>&nbsp;<span class="ident" id="1829770">gp</span><span class="op" id="1829772">.</span><span class="ident" id="1829773">param</span>&nbsp;<span class="op" id="1829779">==</span>&nbsp;<span class="ident" id="1829782">nil</span>&nbsp;<span class="op" id="1829786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1829791">if</span>&nbsp;<span class="ident" id="1829794">c</span><span class="op" id="1829795">.</span><span class="ident" id="1829796">closed</span>&nbsp;<span class="op" id="1829803">==</span>&nbsp;<span class="num" id="1829806">0</span>&nbsp;<span class="op" id="1829808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829814">gothrow</span><span class="op" id="1829821">(</span><span class="string" id="1829822">&#34;chansend:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1829849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1829854">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1829859">panic</span><span class="op" id="1829864">(</span><span class="string" id="1829865">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1829889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1829893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829897">gp</span><span class="op" id="1829899">.</span><span class="ident" id="1829900">param</span>&nbsp;<span class="op" id="1829906">=</span>&nbsp;<span class="ident" id="1829908">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1829914">if</span>&nbsp;<span class="ident" id="1829917">mysg</span><span class="op" id="1829921">.</span><span class="ident" id="1829922">releasetime</span>&nbsp;<span class="op" id="1829934">&gt;</span>&nbsp;<span class="num" id="1829936">0</span>&nbsp;<span class="op" id="1829938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829943">blockevent</span><span class="op" id="1829953">(</span><span class="ident" id="1829954">int64</span><span class="op" id="1829959">(</span><span class="ident" id="1829960">mysg</span><span class="op" id="1829964">.</span><span class="ident" id="1829965">releasetime</span><span class="op" id="1829976">)</span><span class="op" id="1829977">-</span><span class="ident" id="1829978">t0</span><span class="op" id="1829980">,</span>&nbsp;<span class="num" id="1829982">2</span><span class="op" id="1829983">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1829987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1829991">releaseSudog</span><span class="op" id="1830003">(</span><span class="ident" id="1830004">mysg</span><span class="op" id="1830008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1830012">return</span>&nbsp;<span class="builtintype" id="1830019">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1830025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1830029">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1830054">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;space&nbsp;to&nbsp;write&nbsp;our&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1830096">var</span>&nbsp;<span class="ident" id="1830100">t1</span>&nbsp;<span class="ident" id="1830103">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1830110">for</span>&nbsp;<span class="ident" id="1830114">c</span><span class="op" id="1830115">.</span><span class="ident" id="1830116">qcount</span>&nbsp;<span class="op" id="1830123">&gt;=</span>&nbsp;<span class="ident" id="1830126">c</span><span class="op" id="1830127">.</span><span class="ident" id="1830128">dataqsiz</span>&nbsp;<span class="op" id="1830137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1830141">if</span>&nbsp;<span class="op" id="1830144">!</span><span class="ident" id="1830145">block</span>&nbsp;<span class="op" id="1830151">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830156">unlock</span><span class="op" id="1830162">(</span><span class="op" id="1830163">&amp;</span><span class="ident" id="1830164">c</span><span class="op" id="1830165">.</span><span class="ident" id="1830166">lock</span><span class="op" id="1830170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1830175">return</span>&nbsp;<span class="builtintype" id="1830182">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1830190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830194">gp</span>&nbsp;<span class="op" id="1830197">:=</span>&nbsp;<span class="ident" id="1830200">getg</span><span class="op" id="1830204">(</span><span class="op" id="1830205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830209">mysg</span>&nbsp;<span class="op" id="1830214">:=</span>&nbsp;<span class="ident" id="1830217">acquireSudog</span><span class="op" id="1830229">(</span><span class="op" id="1830230">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830234">mysg</span><span class="op" id="1830238">.</span><span class="ident" id="1830239">releasetime</span>&nbsp;<span class="op" id="1830251">=</span>&nbsp;<span class="num" id="1830253">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1830257">if</span>&nbsp;<span class="ident" id="1830260">t0</span>&nbsp;<span class="op" id="1830263">!=</span>&nbsp;<span class="num" id="1830266">0</span>&nbsp;<span class="op" id="1830268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830273">mysg</span><span class="op" id="1830277">.</span><span class="ident" id="1830278">releasetime</span>&nbsp;<span class="op" id="1830290">=</span>&nbsp;<span class="op" id="1830292">-</span><span class="num" id="1830293">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1830297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830301">mysg</span><span class="op" id="1830305">.</span><span class="ident" id="1830306">g</span>&nbsp;<span class="op" id="1830308">=</span>&nbsp;<span class="ident" id="1830310">gp</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830315">mysg</span><span class="op" id="1830319">.</span><span class="ident" id="1830320">elem</span>&nbsp;<span class="op" id="1830325">=</span>&nbsp;<span class="ident" id="1830327">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830333">mysg</span><span class="op" id="1830337">.</span><span class="ident" id="1830338">selectdone</span>&nbsp;<span class="op" id="1830349">=</span>&nbsp;<span class="ident" id="1830351">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830357">c</span><span class="op" id="1830358">.</span><span class="ident" id="1830359">sendq</span><span class="op" id="1830364">.</span><span class="ident" id="1830365">enqueue</span><span class="op" id="1830372">(</span><span class="ident" id="1830373">mysg</span><span class="op" id="1830377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830381">goparkunlock</span><span class="op" id="1830393">(</span><span class="op" id="1830394">&amp;</span><span class="ident" id="1830395">c</span><span class="op" id="1830396">.</span><span class="ident" id="1830397">lock</span><span class="op" id="1830401">,</span>&nbsp;<span class="string" id="1830403">&#34;chan&nbsp;send&#34;</span><span class="op" id="1830414">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1830419">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1830455">if</span>&nbsp;<span class="ident" id="1830458">mysg</span><span class="op" id="1830462">.</span><span class="ident" id="1830463">releasetime</span>&nbsp;<span class="op" id="1830475">&gt;</span>&nbsp;<span class="num" id="1830477">0</span>&nbsp;<span class="op" id="1830479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830484">t1</span>&nbsp;<span class="op" id="1830487">=</span>&nbsp;<span class="ident" id="1830489">mysg</span><span class="op" id="1830493">.</span><span class="ident" id="1830494">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1830508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830512">releaseSudog</span><span class="op" id="1830524">(</span><span class="ident" id="1830525">mysg</span><span class="op" id="1830529">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830533">lock</span><span class="op" id="1830537">(</span><span class="op" id="1830538">&amp;</span><span class="ident" id="1830539">c</span><span class="op" id="1830540">.</span><span class="ident" id="1830541">lock</span><span class="op" id="1830545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1830549">if</span>&nbsp;<span class="ident" id="1830552">c</span><span class="op" id="1830553">.</span><span class="ident" id="1830554">closed</span>&nbsp;<span class="op" id="1830561">!=</span>&nbsp;<span class="num" id="1830564">0</span>&nbsp;<span class="op" id="1830566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830571">unlock</span><span class="op" id="1830577">(</span><span class="op" id="1830578">&amp;</span><span class="ident" id="1830579">c</span><span class="op" id="1830580">.</span><span class="ident" id="1830581">lock</span><span class="op" id="1830585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1830590">panic</span><span class="op" id="1830595">(</span><span class="string" id="1830596">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1830620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1830624">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1830627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1830631">//&nbsp;write&nbsp;our&nbsp;data&nbsp;into&nbsp;the&nbsp;channel&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1830674">if</span>&nbsp;<span class="ident" id="1830677">raceenabled</span>&nbsp;<span class="op" id="1830689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830693">raceacquire</span><span class="op" id="1830704">(</span><span class="ident" id="1830705">chanbuf</span><span class="op" id="1830712">(</span><span class="ident" id="1830713">c</span><span class="op" id="1830714">,</span>&nbsp;<span class="ident" id="1830716">c</span><span class="op" id="1830717">.</span><span class="ident" id="1830718">sendx</span><span class="op" id="1830723">)</span><span class="op" id="1830724">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830728">racerelease</span><span class="op" id="1830739">(</span><span class="ident" id="1830740">chanbuf</span><span class="op" id="1830747">(</span><span class="ident" id="1830748">c</span><span class="op" id="1830749">,</span>&nbsp;<span class="ident" id="1830751">c</span><span class="op" id="1830752">.</span><span class="ident" id="1830753">sendx</span><span class="op" id="1830758">)</span><span class="op" id="1830759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1830762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830765">memmove</span><span class="op" id="1830772">(</span><span class="ident" id="1830773">chanbuf</span><span class="op" id="1830780">(</span><span class="ident" id="1830781">c</span><span class="op" id="1830782">,</span>&nbsp;<span class="ident" id="1830784">c</span><span class="op" id="1830785">.</span><span class="ident" id="1830786">sendx</span><span class="op" id="1830791">)</span><span class="op" id="1830792">,</span>&nbsp;<span class="ident" id="1830794">ep</span><span class="op" id="1830796">,</span>&nbsp;<span class="builtintype" id="1830798">uintptr</span><span class="op" id="1830805">(</span><span class="ident" id="1830806">c</span><span class="op" id="1830807">.</span><span class="ident" id="1830808">elemsize</span><span class="op" id="1830816">)</span><span class="op" id="1830817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830820">c</span><span class="op" id="1830821">.</span><span class="ident" id="1830822">sendx</span><span class="op" id="1830827">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1830831">if</span>&nbsp;<span class="ident" id="1830834">c</span><span class="op" id="1830835">.</span><span class="ident" id="1830836">sendx</span>&nbsp;<span class="op" id="1830842">==</span>&nbsp;<span class="ident" id="1830845">c</span><span class="op" id="1830846">.</span><span class="ident" id="1830847">dataqsiz</span>&nbsp;<span class="op" id="1830856">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830860">c</span><span class="op" id="1830861">.</span><span class="ident" id="1830862">sendx</span>&nbsp;<span class="op" id="1830868">=</span>&nbsp;<span class="num" id="1830870">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1830873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830876">c</span><span class="op" id="1830877">.</span><span class="ident" id="1830878">qcount</span><span class="op" id="1830884">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1830889">//&nbsp;wake&nbsp;up&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830920">sg</span>&nbsp;<span class="op" id="1830923">:=</span>&nbsp;<span class="ident" id="1830926">c</span><span class="op" id="1830927">.</span><span class="ident" id="1830928">recvq</span><span class="op" id="1830933">.</span><span class="ident" id="1830934">dequeue</span><span class="op" id="1830941">(</span><span class="op" id="1830942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1830945">if</span>&nbsp;<span class="ident" id="1830948">sg</span>&nbsp;<span class="op" id="1830951">!=</span>&nbsp;<span class="ident" id="1830954">nil</span>&nbsp;<span class="op" id="1830958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830962">recvg</span>&nbsp;<span class="op" id="1830968">:=</span>&nbsp;<span class="ident" id="1830971">sg</span><span class="op" id="1830973">.</span><span class="ident" id="1830974">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1830978">unlock</span><span class="op" id="1830984">(</span><span class="op" id="1830985">&amp;</span><span class="ident" id="1830986">c</span><span class="op" id="1830987">.</span><span class="ident" id="1830988">lock</span><span class="op" id="1830992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1830996">if</span>&nbsp;<span class="ident" id="1830999">sg</span><span class="op" id="1831001">.</span><span class="ident" id="1831002">releasetime</span>&nbsp;<span class="op" id="1831014">!=</span>&nbsp;<span class="num" id="1831017">0</span>&nbsp;<span class="op" id="1831019">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831024">sg</span><span class="op" id="1831026">.</span><span class="ident" id="1831027">releasetime</span>&nbsp;<span class="op" id="1831039">=</span>&nbsp;<span class="ident" id="1831041">cputicks</span><span class="op" id="1831049">(</span><span class="op" id="1831050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831058">goready</span><span class="op" id="1831065">(</span><span class="ident" id="1831066">recvg</span><span class="op" id="1831071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831074">}</span>&nbsp;<span class="keyword" id="1831076">else</span>&nbsp;<span class="op" id="1831081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831085">unlock</span><span class="op" id="1831091">(</span><span class="op" id="1831092">&amp;</span><span class="ident" id="1831093">c</span><span class="op" id="1831094">.</span><span class="ident" id="1831095">lock</span><span class="op" id="1831099">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831105">if</span>&nbsp;<span class="ident" id="1831108">t1</span>&nbsp;<span class="op" id="1831111">&gt;</span>&nbsp;<span class="num" id="1831113">0</span>&nbsp;<span class="op" id="1831115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831119">blockevent</span><span class="op" id="1831129">(</span><span class="ident" id="1831130">t1</span><span class="op" id="1831132">-</span><span class="ident" id="1831133">t0</span><span class="op" id="1831135">,</span>&nbsp;<span class="num" id="1831137">2</span><span class="op" id="1831138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831144">return</span>&nbsp;<span class="builtintype" id="1831151">true</span><br>
<span class="lineno">255</span><span class="op" id="1831156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1831159">func</span>&nbsp;<span class="ident" id="1831164">closechan</span><span class="op" id="1831173">(</span><span class="ident" id="1831174">c</span>&nbsp;<span class="op" id="1831176">*</span><span class="ident" id="1831177">hchan</span><span class="op" id="1831182">)</span>&nbsp;<span class="op" id="1831184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831187">if</span>&nbsp;<span class="ident" id="1831190">c</span>&nbsp;<span class="op" id="1831192">==</span>&nbsp;<span class="ident" id="1831195">nil</span>&nbsp;<span class="op" id="1831199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1831203">panic</span><span class="op" id="1831208">(</span><span class="string" id="1831209">&#34;close&nbsp;of&nbsp;nil&nbsp;channel&#34;</span><span class="op" id="1831231">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831238">lock</span><span class="op" id="1831242">(</span><span class="op" id="1831243">&amp;</span><span class="ident" id="1831244">c</span><span class="op" id="1831245">.</span><span class="ident" id="1831246">lock</span><span class="op" id="1831250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831253">if</span>&nbsp;<span class="ident" id="1831256">c</span><span class="op" id="1831257">.</span><span class="ident" id="1831258">closed</span>&nbsp;<span class="op" id="1831265">!=</span>&nbsp;<span class="num" id="1831268">0</span>&nbsp;<span class="op" id="1831270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831274">unlock</span><span class="op" id="1831280">(</span><span class="op" id="1831281">&amp;</span><span class="ident" id="1831282">c</span><span class="op" id="1831283">.</span><span class="ident" id="1831284">lock</span><span class="op" id="1831288">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1831292">panic</span><span class="op" id="1831297">(</span><span class="string" id="1831298">&#34;close&nbsp;of&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1831323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831330">if</span>&nbsp;<span class="ident" id="1831333">raceenabled</span>&nbsp;<span class="op" id="1831345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831349">callerpc</span>&nbsp;<span class="op" id="1831358">:=</span>&nbsp;<span class="ident" id="1831361">getcallerpc</span><span class="op" id="1831372">(</span><span class="ident" id="1831373">unsafe</span><span class="op" id="1831379">.</span><span class="ident" id="1831380">Pointer</span><span class="op" id="1831387">(</span><span class="op" id="1831388">&amp;</span><span class="ident" id="1831389">c</span><span class="op" id="1831390">)</span><span class="op" id="1831391">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831395">racewritepc</span><span class="op" id="1831406">(</span><span class="ident" id="1831407">unsafe</span><span class="op" id="1831413">.</span><span class="ident" id="1831414">Pointer</span><span class="op" id="1831421">(</span><span class="ident" id="1831422">c</span><span class="op" id="1831423">)</span><span class="op" id="1831424">,</span>&nbsp;<span class="ident" id="1831426">callerpc</span><span class="op" id="1831434">,</span>&nbsp;<span class="ident" id="1831436">funcPC</span><span class="op" id="1831442">(</span><span class="ident" id="1831443">closechan</span><span class="op" id="1831452">)</span><span class="op" id="1831453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831457">racerelease</span><span class="op" id="1831468">(</span><span class="ident" id="1831469">unsafe</span><span class="op" id="1831475">.</span><span class="ident" id="1831476">Pointer</span><span class="op" id="1831483">(</span><span class="ident" id="1831484">c</span><span class="op" id="1831485">)</span><span class="op" id="1831486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831493">c</span><span class="op" id="1831494">.</span><span class="ident" id="1831495">closed</span>&nbsp;<span class="op" id="1831502">=</span>&nbsp;<span class="num" id="1831504">1</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1831508">//&nbsp;release&nbsp;all&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831532">for</span>&nbsp;<span class="op" id="1831536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831540">sg</span>&nbsp;<span class="op" id="1831543">:=</span>&nbsp;<span class="ident" id="1831546">c</span><span class="op" id="1831547">.</span><span class="ident" id="1831548">recvq</span><span class="op" id="1831553">.</span><span class="ident" id="1831554">dequeue</span><span class="op" id="1831561">(</span><span class="op" id="1831562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831566">if</span>&nbsp;<span class="ident" id="1831569">sg</span>&nbsp;<span class="op" id="1831572">==</span>&nbsp;<span class="ident" id="1831575">nil</span>&nbsp;<span class="op" id="1831579">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831584">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831596">gp</span>&nbsp;<span class="op" id="1831599">:=</span>&nbsp;<span class="ident" id="1831602">sg</span><span class="op" id="1831604">.</span><span class="ident" id="1831605">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831609">sg</span><span class="op" id="1831611">.</span><span class="ident" id="1831612">elem</span>&nbsp;<span class="op" id="1831617">=</span>&nbsp;<span class="ident" id="1831619">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831625">gp</span><span class="op" id="1831627">.</span><span class="ident" id="1831628">param</span>&nbsp;<span class="op" id="1831634">=</span>&nbsp;<span class="ident" id="1831636">nil</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831642">if</span>&nbsp;<span class="ident" id="1831645">sg</span><span class="op" id="1831647">.</span><span class="ident" id="1831648">releasetime</span>&nbsp;<span class="op" id="1831660">!=</span>&nbsp;<span class="num" id="1831663">0</span>&nbsp;<span class="op" id="1831665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831670">sg</span><span class="op" id="1831672">.</span><span class="ident" id="1831673">releasetime</span>&nbsp;<span class="op" id="1831685">=</span>&nbsp;<span class="ident" id="1831687">cputicks</span><span class="op" id="1831695">(</span><span class="op" id="1831696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831704">goready</span><span class="op" id="1831711">(</span><span class="ident" id="1831712">gp</span><span class="op" id="1831714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831717">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1831721">//&nbsp;release&nbsp;all&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831745">for</span>&nbsp;<span class="op" id="1831749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831753">sg</span>&nbsp;<span class="op" id="1831756">:=</span>&nbsp;<span class="ident" id="1831759">c</span><span class="op" id="1831760">.</span><span class="ident" id="1831761">sendq</span><span class="op" id="1831766">.</span><span class="ident" id="1831767">dequeue</span><span class="op" id="1831774">(</span><span class="op" id="1831775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831779">if</span>&nbsp;<span class="ident" id="1831782">sg</span>&nbsp;<span class="op" id="1831785">==</span>&nbsp;<span class="ident" id="1831788">nil</span>&nbsp;<span class="op" id="1831792">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831797">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831809">gp</span>&nbsp;<span class="op" id="1831812">:=</span>&nbsp;<span class="ident" id="1831815">sg</span><span class="op" id="1831817">.</span><span class="ident" id="1831818">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831822">sg</span><span class="op" id="1831824">.</span><span class="ident" id="1831825">elem</span>&nbsp;<span class="op" id="1831830">=</span>&nbsp;<span class="ident" id="1831832">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831838">gp</span><span class="op" id="1831840">.</span><span class="ident" id="1831841">param</span>&nbsp;<span class="op" id="1831847">=</span>&nbsp;<span class="ident" id="1831849">nil</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1831855">if</span>&nbsp;<span class="ident" id="1831858">sg</span><span class="op" id="1831860">.</span><span class="ident" id="1831861">releasetime</span>&nbsp;<span class="op" id="1831873">!=</span>&nbsp;<span class="num" id="1831876">0</span>&nbsp;<span class="op" id="1831878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831883">sg</span><span class="op" id="1831885">.</span><span class="ident" id="1831886">releasetime</span>&nbsp;<span class="op" id="1831898">=</span>&nbsp;<span class="ident" id="1831900">cputicks</span><span class="op" id="1831908">(</span><span class="op" id="1831909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831917">goready</span><span class="op" id="1831924">(</span><span class="ident" id="1831925">gp</span><span class="op" id="1831927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1831930">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1831933">unlock</span><span class="op" id="1831939">(</span><span class="op" id="1831940">&amp;</span><span class="ident" id="1831941">c</span><span class="op" id="1831942">.</span><span class="ident" id="1831943">lock</span><span class="op" id="1831947">)</span><br>
<span class="lineno"></span><span class="op" id="1831949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1831952">//&nbsp;entry&nbsp;points&nbsp;for&nbsp;&lt;-&nbsp;c&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1831996">//go:nosplit</span><br>
<span class="lineno">310</span><span class="keyword" id="1832009">func</span>&nbsp;<span class="ident" id="1832014">chanrecv1</span><span class="op" id="1832023">(</span><span class="ident" id="1832024">t</span>&nbsp;<span class="op" id="1832026">*</span><span class="ident" id="1832027">chantype</span><span class="op" id="1832035">,</span>&nbsp;<span class="ident" id="1832037">c</span>&nbsp;<span class="op" id="1832039">*</span><span class="ident" id="1832040">hchan</span><span class="op" id="1832045">,</span>&nbsp;<span class="ident" id="1832047">elem</span>&nbsp;<span class="ident" id="1832052">unsafe</span><span class="op" id="1832058">.</span><span class="ident" id="1832059">Pointer</span><span class="op" id="1832066">)</span>&nbsp;<span class="op" id="1832068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1832071">chanrecv</span><span class="op" id="1832079">(</span><span class="ident" id="1832080">t</span><span class="op" id="1832081">,</span>&nbsp;<span class="ident" id="1832083">c</span><span class="op" id="1832084">,</span>&nbsp;<span class="ident" id="1832086">elem</span><span class="op" id="1832090">,</span>&nbsp;<span class="builtintype" id="1832092">true</span><span class="op" id="1832096">)</span><br>
<span class="lineno"></span><span class="op" id="1832098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1832101">//go:nosplit</span><br>
<span class="lineno">315</span><span class="keyword" id="1832114">func</span>&nbsp;<span class="ident" id="1832119">chanrecv2</span><span class="op" id="1832128">(</span><span class="ident" id="1832129">t</span>&nbsp;<span class="op" id="1832131">*</span><span class="ident" id="1832132">chantype</span><span class="op" id="1832140">,</span>&nbsp;<span class="ident" id="1832142">c</span>&nbsp;<span class="op" id="1832144">*</span><span class="ident" id="1832145">hchan</span><span class="op" id="1832150">,</span>&nbsp;<span class="ident" id="1832152">elem</span>&nbsp;<span class="ident" id="1832157">unsafe</span><span class="op" id="1832163">.</span><span class="ident" id="1832164">Pointer</span><span class="op" id="1832171">)</span>&nbsp;<span class="op" id="1832173">(</span><span class="ident" id="1832174">received</span>&nbsp;<span class="builtintype" id="1832183">bool</span><span class="op" id="1832187">)</span>&nbsp;<span class="op" id="1832189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1832192">_</span><span class="op" id="1832193">,</span>&nbsp;<span class="ident" id="1832195">received</span>&nbsp;<span class="op" id="1832204">=</span>&nbsp;<span class="ident" id="1832206">chanrecv</span><span class="op" id="1832214">(</span><span class="ident" id="1832215">t</span><span class="op" id="1832216">,</span>&nbsp;<span class="ident" id="1832218">c</span><span class="op" id="1832219">,</span>&nbsp;<span class="ident" id="1832221">elem</span><span class="op" id="1832225">,</span>&nbsp;<span class="builtintype" id="1832227">true</span><span class="op" id="1832231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1832234">return</span><br>
<span class="lineno"></span><span class="op" id="1832241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="comment" id="1832244">//&nbsp;chanrecv&nbsp;receives&nbsp;on&nbsp;channel&nbsp;c&nbsp;and&nbsp;writes&nbsp;the&nbsp;received&nbsp;data&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span><span class="comment" id="1832314">//&nbsp;ep&nbsp;may&nbsp;be&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;received&nbsp;data&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="1832372">//&nbsp;If&nbsp;block&nbsp;==&nbsp;false&nbsp;and&nbsp;no&nbsp;elements&nbsp;are&nbsp;available,&nbsp;returns&nbsp;(false,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1832448">//&nbsp;Otherwise,&nbsp;if&nbsp;c&nbsp;is&nbsp;closed,&nbsp;zeros&nbsp;*ep&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1832515">//&nbsp;Otherwise,&nbsp;fills&nbsp;in&nbsp;*ep&nbsp;with&nbsp;an&nbsp;element&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;true).</span><br>
<span class="lineno">325</span><span class="keyword" id="1832584">func</span>&nbsp;<span class="ident" id="1832589">chanrecv</span><span class="op" id="1832597">(</span><span class="ident" id="1832598">t</span>&nbsp;<span class="op" id="1832600">*</span><span class="ident" id="1832601">chantype</span><span class="op" id="1832609">,</span>&nbsp;<span class="ident" id="1832611">c</span>&nbsp;<span class="op" id="1832613">*</span><span class="ident" id="1832614">hchan</span><span class="op" id="1832619">,</span>&nbsp;<span class="ident" id="1832621">ep</span>&nbsp;<span class="ident" id="1832624">unsafe</span><span class="op" id="1832630">.</span><span class="ident" id="1832631">Pointer</span><span class="op" id="1832638">,</span>&nbsp;<span class="ident" id="1832640">block</span>&nbsp;<span class="builtintype" id="1832646">bool</span><span class="op" id="1832650">)</span>&nbsp;<span class="op" id="1832652">(</span><span class="ident" id="1832653">selected</span><span class="op" id="1832661">,</span>&nbsp;<span class="ident" id="1832663">received</span>&nbsp;<span class="builtintype" id="1832672">bool</span><span class="op" id="1832676">)</span>&nbsp;<span class="op" id="1832678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1832681">//&nbsp;raceenabled:&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;check&nbsp;ep,&nbsp;as&nbsp;it&nbsp;is&nbsp;always&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1832753">if</span>&nbsp;<span class="ident" id="1832756">debugChan</span>&nbsp;<span class="op" id="1832766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1832770">print</span><span class="op" id="1832775">(</span><span class="string" id="1832776">&#34;chanrecv:&nbsp;chan=&#34;</span><span class="op" id="1832793">,</span>&nbsp;<span class="ident" id="1832795">c</span><span class="op" id="1832796">,</span>&nbsp;<span class="string" id="1832798">&#34;\n&#34;</span><span class="op" id="1832802">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1832805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1832809">if</span>&nbsp;<span class="ident" id="1832812">c</span>&nbsp;<span class="op" id="1832814">==</span>&nbsp;<span class="ident" id="1832817">nil</span>&nbsp;<span class="op" id="1832821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1832825">if</span>&nbsp;<span class="op" id="1832828">!</span><span class="ident" id="1832829">block</span>&nbsp;<span class="op" id="1832835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1832840">return</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1832849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1832853">gopark</span><span class="op" id="1832859">(</span><span class="ident" id="1832860">nil</span><span class="op" id="1832863">,</span>&nbsp;<span class="ident" id="1832865">nil</span><span class="op" id="1832868">,</span>&nbsp;<span class="string" id="1832870">&#34;chan&nbsp;receive&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1832895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1832899">gothrow</span><span class="op" id="1832906">(</span><span class="string" id="1832907">&#34;unreachable&#34;</span><span class="op" id="1832920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1832923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1832927">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1833010">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1833014">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;ready&nbsp;for&nbsp;receiving,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1833099">//&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1833181">//&nbsp;(first&nbsp;c.sendq.first&nbsp;or&nbsp;c.qcount,&nbsp;and&nbsp;second&nbsp;c.closed).</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1833241">//&nbsp;Because&nbsp;a&nbsp;channel&nbsp;cannot&nbsp;be&nbsp;reopened,&nbsp;the&nbsp;later&nbsp;observation&nbsp;of&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1833320">//&nbsp;being&nbsp;not&nbsp;closed&nbsp;implies&nbsp;that&nbsp;it&nbsp;was&nbsp;also&nbsp;not&nbsp;closed&nbsp;at&nbsp;the&nbsp;moment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1833398">//&nbsp;first&nbsp;observation.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1833476">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;receive&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1833524">//</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1833528">//&nbsp;The&nbsp;order&nbsp;of&nbsp;operations&nbsp;is&nbsp;important&nbsp;here:&nbsp;reversing&nbsp;the&nbsp;operations&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1833612">//&nbsp;incorrect&nbsp;behavior&nbsp;when&nbsp;racing&nbsp;with&nbsp;a&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1833661">if</span>&nbsp;<span class="op" id="1833664">!</span><span class="ident" id="1833665">block</span>&nbsp;<span class="op" id="1833671">&amp;&amp;</span>&nbsp;<span class="op" id="1833674">(</span><span class="ident" id="1833675">c</span><span class="op" id="1833676">.</span><span class="ident" id="1833677">dataqsiz</span>&nbsp;<span class="op" id="1833686">==</span>&nbsp;<span class="num" id="1833689">0</span>&nbsp;<span class="op" id="1833691">&amp;&amp;</span>&nbsp;<span class="ident" id="1833694">c</span><span class="op" id="1833695">.</span><span class="ident" id="1833696">sendq</span><span class="op" id="1833701">.</span><span class="ident" id="1833702">first</span>&nbsp;<span class="op" id="1833708">==</span>&nbsp;<span class="ident" id="1833711">nil</span>&nbsp;<span class="op" id="1833715">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1833720">c</span><span class="op" id="1833721">.</span><span class="ident" id="1833722">dataqsiz</span>&nbsp;<span class="op" id="1833731">&gt;</span>&nbsp;<span class="num" id="1833733">0</span>&nbsp;<span class="op" id="1833735">&amp;&amp;</span>&nbsp;<span class="ident" id="1833738">atomicloaduint</span><span class="op" id="1833752">(</span><span class="op" id="1833753">&amp;</span><span class="ident" id="1833754">c</span><span class="op" id="1833755">.</span><span class="ident" id="1833756">qcount</span><span class="op" id="1833762">)</span>&nbsp;<span class="op" id="1833764">==</span>&nbsp;<span class="num" id="1833767">0</span><span class="op" id="1833768">)</span>&nbsp;<span class="op" id="1833770">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1833775">atomicload</span><span class="op" id="1833785">(</span><span class="op" id="1833786">&amp;</span><span class="ident" id="1833787">c</span><span class="op" id="1833788">.</span><span class="ident" id="1833789">closed</span><span class="op" id="1833795">)</span>&nbsp;<span class="op" id="1833797">==</span>&nbsp;<span class="num" id="1833800">0</span>&nbsp;<span class="op" id="1833802">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1833806">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1833814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1833818">var</span>&nbsp;<span class="ident" id="1833822">t0</span>&nbsp;<span class="ident" id="1833825">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1833832">if</span>&nbsp;<span class="ident" id="1833835">blockprofilerate</span>&nbsp;<span class="op" id="1833852">&gt;</span>&nbsp;<span class="num" id="1833854">0</span>&nbsp;<span class="op" id="1833856">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1833860">t0</span>&nbsp;<span class="op" id="1833863">=</span>&nbsp;<span class="ident" id="1833865">cputicks</span><span class="op" id="1833873">(</span><span class="op" id="1833874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1833877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1833881">lock</span><span class="op" id="1833885">(</span><span class="op" id="1833886">&amp;</span><span class="ident" id="1833887">c</span><span class="op" id="1833888">.</span><span class="ident" id="1833889">lock</span><span class="op" id="1833893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1833896">if</span>&nbsp;<span class="ident" id="1833899">c</span><span class="op" id="1833900">.</span><span class="ident" id="1833901">dataqsiz</span>&nbsp;<span class="op" id="1833910">==</span>&nbsp;<span class="num" id="1833913">0</span>&nbsp;<span class="op" id="1833915">{</span>&nbsp;<span class="comment" id="1833917">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1833942">if</span>&nbsp;<span class="ident" id="1833945">c</span><span class="op" id="1833946">.</span><span class="ident" id="1833947">closed</span>&nbsp;<span class="op" id="1833954">!=</span>&nbsp;<span class="num" id="1833957">0</span>&nbsp;<span class="op" id="1833959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1833964">return</span>&nbsp;<span class="ident" id="1833971">recvclosed</span><span class="op" id="1833981">(</span><span class="ident" id="1833982">c</span><span class="op" id="1833983">,</span>&nbsp;<span class="ident" id="1833985">ep</span><span class="op" id="1833987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1833991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1833996">sg</span>&nbsp;<span class="op" id="1833999">:=</span>&nbsp;<span class="ident" id="1834002">c</span><span class="op" id="1834003">.</span><span class="ident" id="1834004">sendq</span><span class="op" id="1834009">.</span><span class="ident" id="1834010">dequeue</span><span class="op" id="1834017">(</span><span class="op" id="1834018">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1834022">if</span>&nbsp;<span class="ident" id="1834025">sg</span>&nbsp;<span class="op" id="1834028">!=</span>&nbsp;<span class="ident" id="1834031">nil</span>&nbsp;<span class="op" id="1834035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1834040">if</span>&nbsp;<span class="ident" id="1834043">raceenabled</span>&nbsp;<span class="op" id="1834055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834061">racesync</span><span class="op" id="1834069">(</span><span class="ident" id="1834070">c</span><span class="op" id="1834071">,</span>&nbsp;<span class="ident" id="1834073">sg</span><span class="op" id="1834075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1834080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834085">unlock</span><span class="op" id="1834091">(</span><span class="op" id="1834092">&amp;</span><span class="ident" id="1834093">c</span><span class="op" id="1834094">.</span><span class="ident" id="1834095">lock</span><span class="op" id="1834099">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1834105">if</span>&nbsp;<span class="ident" id="1834108">ep</span>&nbsp;<span class="op" id="1834111">!=</span>&nbsp;<span class="ident" id="1834114">nil</span>&nbsp;<span class="op" id="1834118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834124">memmove</span><span class="op" id="1834131">(</span><span class="ident" id="1834132">ep</span><span class="op" id="1834134">,</span>&nbsp;<span class="ident" id="1834136">sg</span><span class="op" id="1834138">.</span><span class="ident" id="1834139">elem</span><span class="op" id="1834143">,</span>&nbsp;<span class="builtintype" id="1834145">uintptr</span><span class="op" id="1834152">(</span><span class="ident" id="1834153">c</span><span class="op" id="1834154">.</span><span class="ident" id="1834155">elemsize</span><span class="op" id="1834163">)</span><span class="op" id="1834164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1834169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834174">sg</span><span class="op" id="1834176">.</span><span class="ident" id="1834177">elem</span>&nbsp;<span class="op" id="1834182">=</span>&nbsp;<span class="ident" id="1834184">nil</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834191">gp</span>&nbsp;<span class="op" id="1834194">:=</span>&nbsp;<span class="ident" id="1834197">sg</span><span class="op" id="1834199">.</span><span class="ident" id="1834200">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834205">gp</span><span class="op" id="1834207">.</span><span class="ident" id="1834208">param</span>&nbsp;<span class="op" id="1834214">=</span>&nbsp;<span class="ident" id="1834216">unsafe</span><span class="op" id="1834222">.</span><span class="ident" id="1834223">Pointer</span><span class="op" id="1834230">(</span><span class="ident" id="1834231">sg</span><span class="op" id="1834233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1834238">if</span>&nbsp;<span class="ident" id="1834241">sg</span><span class="op" id="1834243">.</span><span class="ident" id="1834244">releasetime</span>&nbsp;<span class="op" id="1834256">!=</span>&nbsp;<span class="num" id="1834259">0</span>&nbsp;<span class="op" id="1834261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834267">sg</span><span class="op" id="1834269">.</span><span class="ident" id="1834270">releasetime</span>&nbsp;<span class="op" id="1834282">=</span>&nbsp;<span class="ident" id="1834284">cputicks</span><span class="op" id="1834292">(</span><span class="op" id="1834293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1834298">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834303">goready</span><span class="op" id="1834310">(</span><span class="ident" id="1834311">gp</span><span class="op" id="1834313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834318">selected</span>&nbsp;<span class="op" id="1834327">=</span>&nbsp;<span class="builtintype" id="1834329">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834337">received</span>&nbsp;<span class="op" id="1834346">=</span>&nbsp;<span class="builtintype" id="1834348">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1834356">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1834365">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1834370">if</span>&nbsp;<span class="op" id="1834373">!</span><span class="ident" id="1834374">block</span>&nbsp;<span class="op" id="1834380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834385">unlock</span><span class="op" id="1834391">(</span><span class="op" id="1834392">&amp;</span><span class="ident" id="1834393">c</span><span class="op" id="1834394">.</span><span class="ident" id="1834395">lock</span><span class="op" id="1834399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1834404">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1834413">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1834418">//&nbsp;no&nbsp;sender&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834467">gp</span>&nbsp;<span class="op" id="1834470">:=</span>&nbsp;<span class="ident" id="1834473">getg</span><span class="op" id="1834477">(</span><span class="op" id="1834478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834482">mysg</span>&nbsp;<span class="op" id="1834487">:=</span>&nbsp;<span class="ident" id="1834490">acquireSudog</span><span class="op" id="1834502">(</span><span class="op" id="1834503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834507">mysg</span><span class="op" id="1834511">.</span><span class="ident" id="1834512">releasetime</span>&nbsp;<span class="op" id="1834524">=</span>&nbsp;<span class="num" id="1834526">0</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1834530">if</span>&nbsp;<span class="ident" id="1834533">t0</span>&nbsp;<span class="op" id="1834536">!=</span>&nbsp;<span class="num" id="1834539">0</span>&nbsp;<span class="op" id="1834541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834546">mysg</span><span class="op" id="1834550">.</span><span class="ident" id="1834551">releasetime</span>&nbsp;<span class="op" id="1834563">=</span>&nbsp;<span class="op" id="1834565">-</span><span class="num" id="1834566">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1834570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834574">mysg</span><span class="op" id="1834578">.</span><span class="ident" id="1834579">elem</span>&nbsp;<span class="op" id="1834584">=</span>&nbsp;<span class="ident" id="1834586">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834591">mysg</span><span class="op" id="1834595">.</span><span class="ident" id="1834596">waitlink</span>&nbsp;<span class="op" id="1834605">=</span>&nbsp;<span class="ident" id="1834607">nil</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834613">gp</span><span class="op" id="1834615">.</span><span class="ident" id="1834616">waiting</span>&nbsp;<span class="op" id="1834624">=</span>&nbsp;<span class="ident" id="1834626">mysg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834633">mysg</span><span class="op" id="1834637">.</span><span class="ident" id="1834638">g</span>&nbsp;<span class="op" id="1834640">=</span>&nbsp;<span class="ident" id="1834642">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834647">mysg</span><span class="op" id="1834651">.</span><span class="ident" id="1834652">selectdone</span>&nbsp;<span class="op" id="1834663">=</span>&nbsp;<span class="ident" id="1834665">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834671">gp</span><span class="op" id="1834673">.</span><span class="ident" id="1834674">param</span>&nbsp;<span class="op" id="1834680">=</span>&nbsp;<span class="ident" id="1834682">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834688">c</span><span class="op" id="1834689">.</span><span class="ident" id="1834690">recvq</span><span class="op" id="1834695">.</span><span class="ident" id="1834696">enqueue</span><span class="op" id="1834703">(</span><span class="ident" id="1834704">mysg</span><span class="op" id="1834708">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834712">goparkunlock</span><span class="op" id="1834724">(</span><span class="op" id="1834725">&amp;</span><span class="ident" id="1834726">c</span><span class="op" id="1834727">.</span><span class="ident" id="1834728">lock</span><span class="op" id="1834732">,</span>&nbsp;<span class="string" id="1834734">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1834748">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1834753">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1834777">if</span>&nbsp;<span class="ident" id="1834780">mysg</span>&nbsp;<span class="op" id="1834785">!=</span>&nbsp;<span class="ident" id="1834788">gp</span><span class="op" id="1834790">.</span><span class="ident" id="1834791">waiting</span>&nbsp;<span class="op" id="1834799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834804">gothrow</span><span class="op" id="1834811">(</span><span class="string" id="1834812">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1834842">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1834846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834850">gp</span><span class="op" id="1834852">.</span><span class="ident" id="1834853">waiting</span>&nbsp;<span class="op" id="1834861">=</span>&nbsp;<span class="ident" id="1834863">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1834869">if</span>&nbsp;<span class="ident" id="1834872">mysg</span><span class="op" id="1834876">.</span><span class="ident" id="1834877">releasetime</span>&nbsp;<span class="op" id="1834889">&gt;</span>&nbsp;<span class="num" id="1834891">0</span>&nbsp;<span class="op" id="1834893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834898">blockevent</span><span class="op" id="1834908">(</span><span class="ident" id="1834909">mysg</span><span class="op" id="1834913">.</span><span class="ident" id="1834914">releasetime</span><span class="op" id="1834925">-</span><span class="ident" id="1834926">t0</span><span class="op" id="1834928">,</span>&nbsp;<span class="num" id="1834930">2</span><span class="op" id="1834931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1834935">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834939">haveData</span>&nbsp;<span class="op" id="1834948">:=</span>&nbsp;<span class="ident" id="1834951">gp</span><span class="op" id="1834953">.</span><span class="ident" id="1834954">param</span>&nbsp;<span class="op" id="1834960">!=</span>&nbsp;<span class="ident" id="1834963">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834969">gp</span><span class="op" id="1834971">.</span><span class="ident" id="1834972">param</span>&nbsp;<span class="op" id="1834978">=</span>&nbsp;<span class="ident" id="1834980">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1834986">releaseSudog</span><span class="op" id="1834998">(</span><span class="ident" id="1834999">mysg</span><span class="op" id="1835003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835008">if</span>&nbsp;<span class="ident" id="1835011">haveData</span>&nbsp;<span class="op" id="1835020">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1835025">//&nbsp;a&nbsp;sender&nbsp;sent&nbsp;us&nbsp;some&nbsp;data.&nbsp;It&nbsp;already&nbsp;wrote&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835083">selected</span>&nbsp;<span class="op" id="1835092">=</span>&nbsp;<span class="builtintype" id="1835094">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835102">received</span>&nbsp;<span class="op" id="1835111">=</span>&nbsp;<span class="builtintype" id="1835113">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835121">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1835130">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835135">lock</span><span class="op" id="1835139">(</span><span class="op" id="1835140">&amp;</span><span class="ident" id="1835141">c</span><span class="op" id="1835142">.</span><span class="ident" id="1835143">lock</span><span class="op" id="1835147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835151">if</span>&nbsp;<span class="ident" id="1835154">c</span><span class="op" id="1835155">.</span><span class="ident" id="1835156">closed</span>&nbsp;<span class="op" id="1835163">==</span>&nbsp;<span class="num" id="1835166">0</span>&nbsp;<span class="op" id="1835168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835173">gothrow</span><span class="op" id="1835180">(</span><span class="string" id="1835181">&#34;chanrecv:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1835208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1835212">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835216">return</span>&nbsp;<span class="ident" id="1835223">recvclosed</span><span class="op" id="1835233">(</span><span class="ident" id="1835234">c</span><span class="op" id="1835235">,</span>&nbsp;<span class="ident" id="1835237">ep</span><span class="op" id="1835239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1835242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1835246">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1835271">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;data&nbsp;to&nbsp;appear</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835304">var</span>&nbsp;<span class="ident" id="1835308">t1</span>&nbsp;<span class="ident" id="1835311">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835318">for</span>&nbsp;<span class="ident" id="1835322">c</span><span class="op" id="1835323">.</span><span class="ident" id="1835324">qcount</span>&nbsp;<span class="op" id="1835331">&lt;=</span>&nbsp;<span class="num" id="1835334">0</span>&nbsp;<span class="op" id="1835336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835340">if</span>&nbsp;<span class="ident" id="1835343">c</span><span class="op" id="1835344">.</span><span class="ident" id="1835345">closed</span>&nbsp;<span class="op" id="1835352">!=</span>&nbsp;<span class="num" id="1835355">0</span>&nbsp;<span class="op" id="1835357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835362">selected</span><span class="op" id="1835370">,</span>&nbsp;<span class="ident" id="1835372">received</span>&nbsp;<span class="op" id="1835381">=</span>&nbsp;<span class="ident" id="1835383">recvclosed</span><span class="op" id="1835393">(</span><span class="ident" id="1835394">c</span><span class="op" id="1835395">,</span>&nbsp;<span class="ident" id="1835397">ep</span><span class="op" id="1835399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835404">if</span>&nbsp;<span class="ident" id="1835407">t1</span>&nbsp;<span class="op" id="1835410">&gt;</span>&nbsp;<span class="num" id="1835412">0</span>&nbsp;<span class="op" id="1835414">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835420">blockevent</span><span class="op" id="1835430">(</span><span class="ident" id="1835431">t1</span><span class="op" id="1835433">-</span><span class="ident" id="1835434">t0</span><span class="op" id="1835436">,</span>&nbsp;<span class="num" id="1835438">2</span><span class="op" id="1835439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1835444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835449">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1835458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835463">if</span>&nbsp;<span class="op" id="1835466">!</span><span class="ident" id="1835467">block</span>&nbsp;<span class="op" id="1835473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835478">unlock</span><span class="op" id="1835484">(</span><span class="op" id="1835485">&amp;</span><span class="ident" id="1835486">c</span><span class="op" id="1835487">.</span><span class="ident" id="1835488">lock</span><span class="op" id="1835492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835497">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1835506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1835511">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;send&nbsp;an&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835552">gp</span>&nbsp;<span class="op" id="1835555">:=</span>&nbsp;<span class="ident" id="1835558">getg</span><span class="op" id="1835562">(</span><span class="op" id="1835563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835567">mysg</span>&nbsp;<span class="op" id="1835572">:=</span>&nbsp;<span class="ident" id="1835575">acquireSudog</span><span class="op" id="1835587">(</span><span class="op" id="1835588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835592">mysg</span><span class="op" id="1835596">.</span><span class="ident" id="1835597">releasetime</span>&nbsp;<span class="op" id="1835609">=</span>&nbsp;<span class="num" id="1835611">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835615">if</span>&nbsp;<span class="ident" id="1835618">t0</span>&nbsp;<span class="op" id="1835621">!=</span>&nbsp;<span class="num" id="1835624">0</span>&nbsp;<span class="op" id="1835626">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835631">mysg</span><span class="op" id="1835635">.</span><span class="ident" id="1835636">releasetime</span>&nbsp;<span class="op" id="1835648">=</span>&nbsp;<span class="op" id="1835650">-</span><span class="num" id="1835651">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1835655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835659">mysg</span><span class="op" id="1835663">.</span><span class="ident" id="1835664">elem</span>&nbsp;<span class="op" id="1835669">=</span>&nbsp;<span class="ident" id="1835671">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835677">mysg</span><span class="op" id="1835681">.</span><span class="ident" id="1835682">g</span>&nbsp;<span class="op" id="1835684">=</span>&nbsp;<span class="ident" id="1835686">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835691">mysg</span><span class="op" id="1835695">.</span><span class="ident" id="1835696">selectdone</span>&nbsp;<span class="op" id="1835707">=</span>&nbsp;<span class="ident" id="1835709">nil</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835716">c</span><span class="op" id="1835717">.</span><span class="ident" id="1835718">recvq</span><span class="op" id="1835723">.</span><span class="ident" id="1835724">enqueue</span><span class="op" id="1835731">(</span><span class="ident" id="1835732">mysg</span><span class="op" id="1835736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835740">goparkunlock</span><span class="op" id="1835752">(</span><span class="op" id="1835753">&amp;</span><span class="ident" id="1835754">c</span><span class="op" id="1835755">.</span><span class="ident" id="1835756">lock</span><span class="op" id="1835760">,</span>&nbsp;<span class="string" id="1835762">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1835776">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1835781">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835817">if</span>&nbsp;<span class="ident" id="1835820">mysg</span><span class="op" id="1835824">.</span><span class="ident" id="1835825">releasetime</span>&nbsp;<span class="op" id="1835837">&gt;</span>&nbsp;<span class="num" id="1835839">0</span>&nbsp;<span class="op" id="1835841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835846">t1</span>&nbsp;<span class="op" id="1835849">=</span>&nbsp;<span class="ident" id="1835851">mysg</span><span class="op" id="1835855">.</span><span class="ident" id="1835856">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1835870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835874">releaseSudog</span><span class="op" id="1835886">(</span><span class="ident" id="1835887">mysg</span><span class="op" id="1835891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835895">lock</span><span class="op" id="1835899">(</span><span class="op" id="1835900">&amp;</span><span class="ident" id="1835901">c</span><span class="op" id="1835902">.</span><span class="ident" id="1835903">lock</span><span class="op" id="1835907">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1835910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1835914">if</span>&nbsp;<span class="ident" id="1835917">raceenabled</span>&nbsp;<span class="op" id="1835929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835933">raceacquire</span><span class="op" id="1835944">(</span><span class="ident" id="1835945">chanbuf</span><span class="op" id="1835952">(</span><span class="ident" id="1835953">c</span><span class="op" id="1835954">,</span>&nbsp;<span class="ident" id="1835956">c</span><span class="op" id="1835957">.</span><span class="ident" id="1835958">recvx</span><span class="op" id="1835963">)</span><span class="op" id="1835964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1835968">racerelease</span><span class="op" id="1835979">(</span><span class="ident" id="1835980">chanbuf</span><span class="op" id="1835987">(</span><span class="ident" id="1835988">c</span><span class="op" id="1835989">,</span>&nbsp;<span class="ident" id="1835991">c</span><span class="op" id="1835992">.</span><span class="ident" id="1835993">recvx</span><span class="op" id="1835998">)</span><span class="op" id="1835999">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1836002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1836005">if</span>&nbsp;<span class="ident" id="1836008">ep</span>&nbsp;<span class="op" id="1836011">!=</span>&nbsp;<span class="ident" id="1836014">nil</span>&nbsp;<span class="op" id="1836018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836022">memmove</span><span class="op" id="1836029">(</span><span class="ident" id="1836030">ep</span><span class="op" id="1836032">,</span>&nbsp;<span class="ident" id="1836034">chanbuf</span><span class="op" id="1836041">(</span><span class="ident" id="1836042">c</span><span class="op" id="1836043">,</span>&nbsp;<span class="ident" id="1836045">c</span><span class="op" id="1836046">.</span><span class="ident" id="1836047">recvx</span><span class="op" id="1836052">)</span><span class="op" id="1836053">,</span>&nbsp;<span class="builtintype" id="1836055">uintptr</span><span class="op" id="1836062">(</span><span class="ident" id="1836063">c</span><span class="op" id="1836064">.</span><span class="ident" id="1836065">elemsize</span><span class="op" id="1836073">)</span><span class="op" id="1836074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1836077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836080">memclr</span><span class="op" id="1836086">(</span><span class="ident" id="1836087">chanbuf</span><span class="op" id="1836094">(</span><span class="ident" id="1836095">c</span><span class="op" id="1836096">,</span>&nbsp;<span class="ident" id="1836098">c</span><span class="op" id="1836099">.</span><span class="ident" id="1836100">recvx</span><span class="op" id="1836105">)</span><span class="op" id="1836106">,</span>&nbsp;<span class="builtintype" id="1836108">uintptr</span><span class="op" id="1836115">(</span><span class="ident" id="1836116">c</span><span class="op" id="1836117">.</span><span class="ident" id="1836118">elemsize</span><span class="op" id="1836126">)</span><span class="op" id="1836127">)</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836131">c</span><span class="op" id="1836132">.</span><span class="ident" id="1836133">recvx</span><span class="op" id="1836138">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1836142">if</span>&nbsp;<span class="ident" id="1836145">c</span><span class="op" id="1836146">.</span><span class="ident" id="1836147">recvx</span>&nbsp;<span class="op" id="1836153">==</span>&nbsp;<span class="ident" id="1836156">c</span><span class="op" id="1836157">.</span><span class="ident" id="1836158">dataqsiz</span>&nbsp;<span class="op" id="1836167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836171">c</span><span class="op" id="1836172">.</span><span class="ident" id="1836173">recvx</span>&nbsp;<span class="op" id="1836179">=</span>&nbsp;<span class="num" id="1836181">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1836184">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836187">c</span><span class="op" id="1836188">.</span><span class="ident" id="1836189">qcount</span><span class="op" id="1836195">--</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1836200">//&nbsp;ping&nbsp;a&nbsp;sender&nbsp;now&nbsp;that&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836242">sg</span>&nbsp;<span class="op" id="1836245">:=</span>&nbsp;<span class="ident" id="1836248">c</span><span class="op" id="1836249">.</span><span class="ident" id="1836250">sendq</span><span class="op" id="1836255">.</span><span class="ident" id="1836256">dequeue</span><span class="op" id="1836263">(</span><span class="op" id="1836264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1836267">if</span>&nbsp;<span class="ident" id="1836270">sg</span>&nbsp;<span class="op" id="1836273">!=</span>&nbsp;<span class="ident" id="1836276">nil</span>&nbsp;<span class="op" id="1836280">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836284">gp</span>&nbsp;<span class="op" id="1836287">:=</span>&nbsp;<span class="ident" id="1836290">sg</span><span class="op" id="1836292">.</span><span class="ident" id="1836293">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836297">unlock</span><span class="op" id="1836303">(</span><span class="op" id="1836304">&amp;</span><span class="ident" id="1836305">c</span><span class="op" id="1836306">.</span><span class="ident" id="1836307">lock</span><span class="op" id="1836311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1836315">if</span>&nbsp;<span class="ident" id="1836318">sg</span><span class="op" id="1836320">.</span><span class="ident" id="1836321">releasetime</span>&nbsp;<span class="op" id="1836333">!=</span>&nbsp;<span class="num" id="1836336">0</span>&nbsp;<span class="op" id="1836338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836343">sg</span><span class="op" id="1836345">.</span><span class="ident" id="1836346">releasetime</span>&nbsp;<span class="op" id="1836358">=</span>&nbsp;<span class="ident" id="1836360">cputicks</span><span class="op" id="1836368">(</span><span class="op" id="1836369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1836373">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836377">goready</span><span class="op" id="1836384">(</span><span class="ident" id="1836385">gp</span><span class="op" id="1836387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1836390">}</span>&nbsp;<span class="keyword" id="1836392">else</span>&nbsp;<span class="op" id="1836397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836401">unlock</span><span class="op" id="1836407">(</span><span class="op" id="1836408">&amp;</span><span class="ident" id="1836409">c</span><span class="op" id="1836410">.</span><span class="ident" id="1836411">lock</span><span class="op" id="1836415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1836418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1836422">if</span>&nbsp;<span class="ident" id="1836425">t1</span>&nbsp;<span class="op" id="1836428">&gt;</span>&nbsp;<span class="num" id="1836430">0</span>&nbsp;<span class="op" id="1836432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836436">blockevent</span><span class="op" id="1836446">(</span><span class="ident" id="1836447">t1</span><span class="op" id="1836449">-</span><span class="ident" id="1836450">t0</span><span class="op" id="1836452">,</span>&nbsp;<span class="num" id="1836454">2</span><span class="op" id="1836455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1836458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836461">selected</span>&nbsp;<span class="op" id="1836470">=</span>&nbsp;<span class="builtintype" id="1836472">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836478">received</span>&nbsp;<span class="op" id="1836487">=</span>&nbsp;<span class="builtintype" id="1836489">true</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1836495">return</span><br>
<span class="lineno"></span><span class="op" id="1836502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1836505">//&nbsp;recvclosed&nbsp;is&nbsp;a&nbsp;helper&nbsp;function&nbsp;for&nbsp;chanrecv.&nbsp;&nbsp;Handles&nbsp;cleanup</span><br>
<span class="lineno"></span><span class="comment" id="1836571">//&nbsp;when&nbsp;the&nbsp;receiver&nbsp;encounters&nbsp;a&nbsp;closed&nbsp;channel.</span><br>
<span class="lineno">515</span><span class="comment" id="1836621">//&nbsp;Caller&nbsp;must&nbsp;hold&nbsp;c.lock,&nbsp;recvclosed&nbsp;will&nbsp;release&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1836683">func</span>&nbsp;<span class="ident" id="1836688">recvclosed</span><span class="op" id="1836698">(</span><span class="ident" id="1836699">c</span>&nbsp;<span class="op" id="1836701">*</span><span class="ident" id="1836702">hchan</span><span class="op" id="1836707">,</span>&nbsp;<span class="ident" id="1836709">ep</span>&nbsp;<span class="ident" id="1836712">unsafe</span><span class="op" id="1836718">.</span><span class="ident" id="1836719">Pointer</span><span class="op" id="1836726">)</span>&nbsp;<span class="op" id="1836728">(</span><span class="ident" id="1836729">selected</span><span class="op" id="1836737">,</span>&nbsp;<span class="ident" id="1836739">recevied</span>&nbsp;<span class="builtintype" id="1836748">bool</span><span class="op" id="1836752">)</span>&nbsp;<span class="op" id="1836754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1836757">if</span>&nbsp;<span class="ident" id="1836760">raceenabled</span>&nbsp;<span class="op" id="1836772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836776">raceacquire</span><span class="op" id="1836787">(</span><span class="ident" id="1836788">unsafe</span><span class="op" id="1836794">.</span><span class="ident" id="1836795">Pointer</span><span class="op" id="1836802">(</span><span class="ident" id="1836803">c</span><span class="op" id="1836804">)</span><span class="op" id="1836805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1836808">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836811">unlock</span><span class="op" id="1836817">(</span><span class="op" id="1836818">&amp;</span><span class="ident" id="1836819">c</span><span class="op" id="1836820">.</span><span class="ident" id="1836821">lock</span><span class="op" id="1836825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1836828">if</span>&nbsp;<span class="ident" id="1836831">ep</span>&nbsp;<span class="op" id="1836834">!=</span>&nbsp;<span class="ident" id="1836837">nil</span>&nbsp;<span class="op" id="1836841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1836845">memclr</span><span class="op" id="1836851">(</span><span class="ident" id="1836852">ep</span><span class="op" id="1836854">,</span>&nbsp;<span class="builtintype" id="1836856">uintptr</span><span class="op" id="1836863">(</span><span class="ident" id="1836864">c</span><span class="op" id="1836865">.</span><span class="ident" id="1836866">elemsize</span><span class="op" id="1836874">)</span><span class="op" id="1836875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1836878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1836881">return</span>&nbsp;<span class="builtintype" id="1836888">true</span><span class="op" id="1836892">,</span>&nbsp;<span class="builtintype" id="1836894">false</span><br>
<span class="lineno">525</span><span class="op" id="1836900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1836903">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1836926">//</span><br>
<span class="lineno"></span><span class="comment" id="1836929">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno">530</span><span class="comment" id="1836941">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;c&nbsp;&lt;-&nbsp;v:</span><br>
<span class="lineno"></span><span class="comment" id="1836957">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1836969">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1836981">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1836993">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">535</span><span class="comment" id="1836998">//</span><br>
<span class="lineno"></span><span class="comment" id="1837001">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1837007">//</span><br>
<span class="lineno"></span><span class="comment" id="1837010">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbsend(c,&nbsp;v)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1837037">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">540</span><span class="comment" id="1837049">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1837061">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1837073">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1837078">//</span><br>
<span class="lineno"></span><span class="keyword" id="1837081">func</span>&nbsp;<span class="ident" id="1837086">selectnbsend</span><span class="op" id="1837098">(</span><span class="ident" id="1837099">t</span>&nbsp;<span class="op" id="1837101">*</span><span class="ident" id="1837102">chantype</span><span class="op" id="1837110">,</span>&nbsp;<span class="ident" id="1837112">c</span>&nbsp;<span class="op" id="1837114">*</span><span class="ident" id="1837115">hchan</span><span class="op" id="1837120">,</span>&nbsp;<span class="ident" id="1837122">elem</span>&nbsp;<span class="ident" id="1837127">unsafe</span><span class="op" id="1837133">.</span><span class="ident" id="1837134">Pointer</span><span class="op" id="1837141">)</span>&nbsp;<span class="op" id="1837143">(</span><span class="ident" id="1837144">selected</span>&nbsp;<span class="builtintype" id="1837153">bool</span><span class="op" id="1837157">)</span>&nbsp;<span class="op" id="1837159">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1837162">return</span>&nbsp;<span class="ident" id="1837169">chansend</span><span class="op" id="1837177">(</span><span class="ident" id="1837178">t</span><span class="op" id="1837179">,</span>&nbsp;<span class="ident" id="1837181">c</span><span class="op" id="1837182">,</span>&nbsp;<span class="ident" id="1837184">elem</span><span class="op" id="1837188">,</span>&nbsp;<span class="builtintype" id="1837190">false</span><span class="op" id="1837195">,</span>&nbsp;<span class="ident" id="1837197">getcallerpc</span><span class="op" id="1837208">(</span><span class="ident" id="1837209">unsafe</span><span class="op" id="1837215">.</span><span class="ident" id="1837216">Pointer</span><span class="op" id="1837223">(</span><span class="op" id="1837224">&amp;</span><span class="ident" id="1837225">t</span><span class="op" id="1837226">)</span><span class="op" id="1837227">)</span><span class="op" id="1837228">)</span><br>
<span class="lineno"></span><span class="op" id="1837230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1837233">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1837256">//</span><br>
<span class="lineno">550</span><span class="comment" id="1837259">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1837271">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1837288">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1837300">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1837312">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">555</span><span class="comment" id="1837324">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1837329">//</span><br>
<span class="lineno"></span><span class="comment" id="1837332">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1837338">//</span><br>
<span class="lineno"></span><span class="comment" id="1837341">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbrecv(&amp;v,&nbsp;c)&nbsp;{</span><br>
<span class="lineno">560</span><span class="comment" id="1837369">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1837381">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1837393">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1837405">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1837410">//</span><br>
<span class="lineno">565</span><span class="keyword" id="1837413">func</span>&nbsp;<span class="ident" id="1837418">selectnbrecv</span><span class="op" id="1837430">(</span><span class="ident" id="1837431">t</span>&nbsp;<span class="op" id="1837433">*</span><span class="ident" id="1837434">chantype</span><span class="op" id="1837442">,</span>&nbsp;<span class="ident" id="1837444">elem</span>&nbsp;<span class="ident" id="1837449">unsafe</span><span class="op" id="1837455">.</span><span class="ident" id="1837456">Pointer</span><span class="op" id="1837463">,</span>&nbsp;<span class="ident" id="1837465">c</span>&nbsp;<span class="op" id="1837467">*</span><span class="ident" id="1837468">hchan</span><span class="op" id="1837473">)</span>&nbsp;<span class="op" id="1837475">(</span><span class="ident" id="1837476">selected</span>&nbsp;<span class="builtintype" id="1837485">bool</span><span class="op" id="1837489">)</span>&nbsp;<span class="op" id="1837491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837494">selected</span><span class="op" id="1837502">,</span>&nbsp;<span class="ident" id="1837504">_</span>&nbsp;<span class="op" id="1837506">=</span>&nbsp;<span class="ident" id="1837508">chanrecv</span><span class="op" id="1837516">(</span><span class="ident" id="1837517">t</span><span class="op" id="1837518">,</span>&nbsp;<span class="ident" id="1837520">c</span><span class="op" id="1837521">,</span>&nbsp;<span class="ident" id="1837523">elem</span><span class="op" id="1837527">,</span>&nbsp;<span class="builtintype" id="1837529">false</span><span class="op" id="1837534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1837537">return</span><br>
<span class="lineno"></span><span class="op" id="1837544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span><span class="comment" id="1837547">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1837570">//</span><br>
<span class="lineno"></span><span class="comment" id="1837573">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1837585">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v,&nbsp;ok&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1837606">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">575</span><span class="comment" id="1837618">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1837630">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1837642">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1837647">//</span><br>
<span class="lineno"></span><span class="comment" id="1837650">//&nbsp;as</span><br>
<span class="lineno">580</span><span class="comment" id="1837656">//</span><br>
<span class="lineno"></span><span class="comment" id="1837659">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;c&nbsp;!=&nbsp;nil&nbsp;&amp;&amp;&nbsp;selectnbrecv2(&amp;v,&nbsp;&amp;ok,&nbsp;c)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1837705">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1837717">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1837729">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">585</span><span class="comment" id="1837741">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1837746">//</span><br>
<span class="lineno"></span><span class="keyword" id="1837749">func</span>&nbsp;<span class="ident" id="1837754">selectnbrecv2</span><span class="op" id="1837767">(</span><span class="ident" id="1837768">t</span>&nbsp;<span class="op" id="1837770">*</span><span class="ident" id="1837771">chantype</span><span class="op" id="1837779">,</span>&nbsp;<span class="ident" id="1837781">elem</span>&nbsp;<span class="ident" id="1837786">unsafe</span><span class="op" id="1837792">.</span><span class="ident" id="1837793">Pointer</span><span class="op" id="1837800">,</span>&nbsp;<span class="ident" id="1837802">received</span>&nbsp;<span class="op" id="1837811">*</span><span class="builtintype" id="1837812">bool</span><span class="op" id="1837816">,</span>&nbsp;<span class="ident" id="1837818">c</span>&nbsp;<span class="op" id="1837820">*</span><span class="ident" id="1837821">hchan</span><span class="op" id="1837826">)</span>&nbsp;<span class="op" id="1837828">(</span><span class="ident" id="1837829">selected</span>&nbsp;<span class="builtintype" id="1837838">bool</span><span class="op" id="1837842">)</span>&nbsp;<span class="op" id="1837844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1837847">//&nbsp;TODO(khr):&nbsp;just&nbsp;return&nbsp;2&nbsp;values&nbsp;from&nbsp;this&nbsp;function,&nbsp;now&nbsp;that&nbsp;it&nbsp;is&nbsp;in&nbsp;Go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1837925">selected</span><span class="op" id="1837933">,</span>&nbsp;<span class="op" id="1837935">*</span><span class="ident" id="1837936">received</span>&nbsp;<span class="op" id="1837945">=</span>&nbsp;<span class="ident" id="1837947">chanrecv</span><span class="op" id="1837955">(</span><span class="ident" id="1837956">t</span><span class="op" id="1837957">,</span>&nbsp;<span class="ident" id="1837959">c</span><span class="op" id="1837960">,</span>&nbsp;<span class="ident" id="1837962">elem</span><span class="op" id="1837966">,</span>&nbsp;<span class="builtintype" id="1837968">false</span><span class="op" id="1837973">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1837976">return</span><br>
<span class="lineno"></span><span class="op" id="1837983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1837986">func</span>&nbsp;<span class="ident" id="1837991">reflect_chansend</span><span class="op" id="1838007">(</span><span class="ident" id="1838008">t</span>&nbsp;<span class="op" id="1838010">*</span><span class="ident" id="1838011">chantype</span><span class="op" id="1838019">,</span>&nbsp;<span class="ident" id="1838021">c</span>&nbsp;<span class="op" id="1838023">*</span><span class="ident" id="1838024">hchan</span><span class="op" id="1838029">,</span>&nbsp;<span class="ident" id="1838031">elem</span>&nbsp;<span class="ident" id="1838036">unsafe</span><span class="op" id="1838042">.</span><span class="ident" id="1838043">Pointer</span><span class="op" id="1838050">,</span>&nbsp;<span class="ident" id="1838052">nb</span>&nbsp;<span class="builtintype" id="1838055">bool</span><span class="op" id="1838059">)</span>&nbsp;<span class="op" id="1838061">(</span><span class="ident" id="1838062">selected</span>&nbsp;<span class="builtintype" id="1838071">bool</span><span class="op" id="1838075">)</span>&nbsp;<span class="op" id="1838077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838080">return</span>&nbsp;<span class="ident" id="1838087">chansend</span><span class="op" id="1838095">(</span><span class="ident" id="1838096">t</span><span class="op" id="1838097">,</span>&nbsp;<span class="ident" id="1838099">c</span><span class="op" id="1838100">,</span>&nbsp;<span class="ident" id="1838102">elem</span><span class="op" id="1838106">,</span>&nbsp;<span class="op" id="1838108">!</span><span class="ident" id="1838109">nb</span><span class="op" id="1838111">,</span>&nbsp;<span class="ident" id="1838113">getcallerpc</span><span class="op" id="1838124">(</span><span class="ident" id="1838125">unsafe</span><span class="op" id="1838131">.</span><span class="ident" id="1838132">Pointer</span><span class="op" id="1838139">(</span><span class="op" id="1838140">&amp;</span><span class="ident" id="1838141">t</span><span class="op" id="1838142">)</span><span class="op" id="1838143">)</span><span class="op" id="1838144">)</span><br>
<span class="lineno">595</span><span class="op" id="1838146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1838149">func</span>&nbsp;<span class="ident" id="1838154">reflect_chanrecv</span><span class="op" id="1838170">(</span><span class="ident" id="1838171">t</span>&nbsp;<span class="op" id="1838173">*</span><span class="ident" id="1838174">chantype</span><span class="op" id="1838182">,</span>&nbsp;<span class="ident" id="1838184">c</span>&nbsp;<span class="op" id="1838186">*</span><span class="ident" id="1838187">hchan</span><span class="op" id="1838192">,</span>&nbsp;<span class="ident" id="1838194">nb</span>&nbsp;<span class="builtintype" id="1838197">bool</span><span class="op" id="1838201">,</span>&nbsp;<span class="ident" id="1838203">elem</span>&nbsp;<span class="ident" id="1838208">unsafe</span><span class="op" id="1838214">.</span><span class="ident" id="1838215">Pointer</span><span class="op" id="1838222">)</span>&nbsp;<span class="op" id="1838224">(</span><span class="ident" id="1838225">selected</span>&nbsp;<span class="builtintype" id="1838234">bool</span><span class="op" id="1838238">,</span>&nbsp;<span class="ident" id="1838240">received</span>&nbsp;<span class="builtintype" id="1838249">bool</span><span class="op" id="1838253">)</span>&nbsp;<span class="op" id="1838255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838258">return</span>&nbsp;<span class="ident" id="1838265">chanrecv</span><span class="op" id="1838273">(</span><span class="ident" id="1838274">t</span><span class="op" id="1838275">,</span>&nbsp;<span class="ident" id="1838277">c</span><span class="op" id="1838278">,</span>&nbsp;<span class="ident" id="1838280">elem</span><span class="op" id="1838284">,</span>&nbsp;<span class="op" id="1838286">!</span><span class="ident" id="1838287">nb</span><span class="op" id="1838289">)</span><br>
<span class="lineno"></span><span class="op" id="1838291">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="1838294">func</span>&nbsp;<span class="ident" id="1838299">reflect_chanlen</span><span class="op" id="1838314">(</span><span class="ident" id="1838315">c</span>&nbsp;<span class="op" id="1838317">*</span><span class="ident" id="1838318">hchan</span><span class="op" id="1838323">)</span>&nbsp;<span class="builtintype" id="1838325">int</span>&nbsp;<span class="op" id="1838329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838332">if</span>&nbsp;<span class="ident" id="1838335">c</span>&nbsp;<span class="op" id="1838337">==</span>&nbsp;<span class="ident" id="1838340">nil</span>&nbsp;<span class="op" id="1838344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838348">return</span>&nbsp;<span class="num" id="1838355">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1838358">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838361">return</span>&nbsp;<span class="builtintype" id="1838368">int</span><span class="op" id="1838371">(</span><span class="ident" id="1838372">c</span><span class="op" id="1838373">.</span><span class="ident" id="1838374">qcount</span><span class="op" id="1838380">)</span><br>
<span class="lineno"></span><span class="op" id="1838382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1838385">func</span>&nbsp;<span class="ident" id="1838390">reflect_chancap</span><span class="op" id="1838405">(</span><span class="ident" id="1838406">c</span>&nbsp;<span class="op" id="1838408">*</span><span class="ident" id="1838409">hchan</span><span class="op" id="1838414">)</span>&nbsp;<span class="builtintype" id="1838416">int</span>&nbsp;<span class="op" id="1838420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838423">if</span>&nbsp;<span class="ident" id="1838426">c</span>&nbsp;<span class="op" id="1838428">==</span>&nbsp;<span class="ident" id="1838431">nil</span>&nbsp;<span class="op" id="1838435">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838439">return</span>&nbsp;<span class="num" id="1838446">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1838449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838452">return</span>&nbsp;<span class="builtintype" id="1838459">int</span><span class="op" id="1838462">(</span><span class="ident" id="1838463">c</span><span class="op" id="1838464">.</span><span class="ident" id="1838465">dataqsiz</span><span class="op" id="1838473">)</span><br>
<span class="lineno"></span><span class="op" id="1838475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="keyword" id="1838478">func</span>&nbsp;<span class="op" id="1838483">(</span><span class="ident" id="1838484">q</span>&nbsp;<span class="op" id="1838486">*</span><span class="ident" id="1838487">waitq</span><span class="op" id="1838492">)</span>&nbsp;<span class="ident" id="1838494">enqueue</span><span class="op" id="1838501">(</span><span class="ident" id="1838502">sgp</span>&nbsp;<span class="op" id="1838506">*</span><span class="ident" id="1838507">sudog</span><span class="op" id="1838512">)</span>&nbsp;<span class="op" id="1838514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838517">sgp</span><span class="op" id="1838520">.</span><span class="ident" id="1838521">next</span>&nbsp;<span class="op" id="1838526">=</span>&nbsp;<span class="ident" id="1838528">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838533">if</span>&nbsp;<span class="ident" id="1838536">q</span><span class="op" id="1838537">.</span><span class="ident" id="1838538">first</span>&nbsp;<span class="op" id="1838544">==</span>&nbsp;<span class="ident" id="1838547">nil</span>&nbsp;<span class="op" id="1838551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838555">q</span><span class="op" id="1838556">.</span><span class="ident" id="1838557">first</span>&nbsp;<span class="op" id="1838563">=</span>&nbsp;<span class="ident" id="1838565">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838571">q</span><span class="op" id="1838572">.</span><span class="ident" id="1838573">last</span>&nbsp;<span class="op" id="1838578">=</span>&nbsp;<span class="ident" id="1838580">sgp</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838586">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1838594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838597">q</span><span class="op" id="1838598">.</span><span class="ident" id="1838599">last</span><span class="op" id="1838603">.</span><span class="ident" id="1838604">next</span>&nbsp;<span class="op" id="1838609">=</span>&nbsp;<span class="ident" id="1838611">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838616">q</span><span class="op" id="1838617">.</span><span class="ident" id="1838618">last</span>&nbsp;<span class="op" id="1838623">=</span>&nbsp;<span class="ident" id="1838625">sgp</span><br>
<span class="lineno"></span><span class="op" id="1838629">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span><span class="keyword" id="1838632">func</span>&nbsp;<span class="op" id="1838637">(</span><span class="ident" id="1838638">q</span>&nbsp;<span class="op" id="1838640">*</span><span class="ident" id="1838641">waitq</span><span class="op" id="1838646">)</span>&nbsp;<span class="ident" id="1838648">dequeue</span><span class="op" id="1838655">(</span><span class="op" id="1838656">)</span>&nbsp;<span class="op" id="1838658">*</span><span class="ident" id="1838659">sudog</span>&nbsp;<span class="op" id="1838665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838668">for</span>&nbsp;<span class="op" id="1838672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838676">sgp</span>&nbsp;<span class="op" id="1838680">:=</span>&nbsp;<span class="ident" id="1838683">q</span><span class="op" id="1838684">.</span><span class="ident" id="1838685">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838693">if</span>&nbsp;<span class="ident" id="1838696">sgp</span>&nbsp;<span class="op" id="1838700">==</span>&nbsp;<span class="ident" id="1838703">nil</span>&nbsp;<span class="op" id="1838707">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838712">return</span>&nbsp;<span class="ident" id="1838719">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1838725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838729">q</span><span class="op" id="1838730">.</span><span class="ident" id="1838731">first</span>&nbsp;<span class="op" id="1838737">=</span>&nbsp;<span class="ident" id="1838739">sgp</span><span class="op" id="1838742">.</span><span class="ident" id="1838743">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838750">sgp</span><span class="op" id="1838753">.</span><span class="ident" id="1838754">next</span>&nbsp;<span class="op" id="1838759">=</span>&nbsp;<span class="ident" id="1838761">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838767">if</span>&nbsp;<span class="ident" id="1838770">q</span><span class="op" id="1838771">.</span><span class="ident" id="1838772">last</span>&nbsp;<span class="op" id="1838777">==</span>&nbsp;<span class="ident" id="1838780">sgp</span>&nbsp;<span class="op" id="1838784">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1838789">q</span><span class="op" id="1838790">.</span><span class="ident" id="1838791">last</span>&nbsp;<span class="op" id="1838796">=</span>&nbsp;<span class="ident" id="1838798">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1838804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1838809">//&nbsp;if&nbsp;sgp&nbsp;participates&nbsp;in&nbsp;a&nbsp;select&nbsp;and&nbsp;is&nbsp;already&nbsp;signaled,&nbsp;ignore&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838881">if</span>&nbsp;<span class="ident" id="1838884">sgp</span><span class="op" id="1838887">.</span><span class="ident" id="1838888">selectdone</span>&nbsp;<span class="op" id="1838899">!=</span>&nbsp;<span class="ident" id="1838902">nil</span>&nbsp;<span class="op" id="1838906">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1838911">//&nbsp;claim&nbsp;the&nbsp;right&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1838943">if</span>&nbsp;<span class="op" id="1838946">*</span><span class="ident" id="1838947">sgp</span><span class="op" id="1838950">.</span><span class="ident" id="1838951">selectdone</span>&nbsp;<span class="op" id="1838962">!=</span>&nbsp;<span class="num" id="1838965">0</span>&nbsp;<span class="op" id="1838967">||</span>&nbsp;<span class="op" id="1838970">!</span><span class="ident" id="1838971">cas</span><span class="op" id="1838974">(</span><span class="ident" id="1838975">sgp</span><span class="op" id="1838978">.</span><span class="ident" id="1838979">selectdone</span><span class="op" id="1838989">,</span>&nbsp;<span class="num" id="1838991">0</span><span class="op" id="1838992">,</span>&nbsp;<span class="num" id="1838994">1</span><span class="op" id="1838995">)</span>&nbsp;<span class="op" id="1838997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1839003">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1839015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1839019">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1839024">return</span>&nbsp;<span class="ident" id="1839031">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1839036">}</span><br>
<span class="lineno"></span><span class="op" id="1839038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="keyword" id="1839041">func</span>&nbsp;<span class="ident" id="1839046">racesync</span><span class="op" id="1839054">(</span><span class="ident" id="1839055">c</span>&nbsp;<span class="op" id="1839057">*</span><span class="ident" id="1839058">hchan</span><span class="op" id="1839063">,</span>&nbsp;<span class="ident" id="1839065">sg</span>&nbsp;<span class="op" id="1839068">*</span><span class="ident" id="1839069">sudog</span><span class="op" id="1839074">)</span>&nbsp;<span class="op" id="1839076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1839079">racerelease</span><span class="op" id="1839090">(</span><span class="ident" id="1839091">chanbuf</span><span class="op" id="1839098">(</span><span class="ident" id="1839099">c</span><span class="op" id="1839100">,</span>&nbsp;<span class="num" id="1839102">0</span><span class="op" id="1839103">)</span><span class="op" id="1839104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1839107">raceacquireg</span><span class="op" id="1839119">(</span><span class="ident" id="1839120">sg</span><span class="op" id="1839122">.</span><span class="ident" id="1839123">g</span><span class="op" id="1839124">,</span>&nbsp;<span class="ident" id="1839126">chanbuf</span><span class="op" id="1839133">(</span><span class="ident" id="1839134">c</span><span class="op" id="1839135">,</span>&nbsp;<span class="num" id="1839137">0</span><span class="op" id="1839138">)</span><span class="op" id="1839139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1839142">racereleaseg</span><span class="op" id="1839154">(</span><span class="ident" id="1839155">sg</span><span class="op" id="1839157">.</span><span class="ident" id="1839158">g</span><span class="op" id="1839159">,</span>&nbsp;<span class="ident" id="1839161">chanbuf</span><span class="op" id="1839168">(</span><span class="ident" id="1839169">c</span><span class="op" id="1839170">,</span>&nbsp;<span class="num" id="1839172">0</span><span class="op" id="1839173">)</span><span class="op" id="1839174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1839177">raceacquire</span><span class="op" id="1839188">(</span><span class="ident" id="1839189">chanbuf</span><span class="op" id="1839196">(</span><span class="ident" id="1839197">c</span><span class="op" id="1839198">,</span>&nbsp;<span class="num" id="1839200">0</span><span class="op" id="1839201">)</span><span class="op" id="1839202">)</span><br>
<span class="lineno">655</span><span class="op" id="1839204">}</span>
</div>
</body>
</html>
