<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7072197">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7072252">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7072306">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7072357">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7072382">package</span>&nbsp;<span class="ident" id="7072390">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7072400">import</span>&nbsp;<span class="op" id="7072407">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7072410">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7072423">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7072435">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7072456">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7072467">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7072478">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7072489">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7072496">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7072499">const</span>&nbsp;<span class="ident" id="7072505">fakeHopHeader</span>&nbsp;<span class="op" id="7072519">=</span>&nbsp;<span class="string" id="7072521">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7072551">func</span>&nbsp;<span class="ident" id="7072556">init</span><span class="op" id="7072560">(</span><span class="op" id="7072561">)</span>&nbsp;<span class="op" id="7072563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7072566">hopHeaders</span>&nbsp;<span class="op" id="7072577">=</span>&nbsp;<span class="builtinfunc" id="7072579">append</span><span class="op" id="7072585">(</span><span class="ident" id="7072586">hopHeaders</span><span class="op" id="7072596">,</span>&nbsp;<span class="ident" id="7072598">fakeHopHeader</span><span class="op" id="7072611">)</span><br>
<span class="lineno"></span><span class="op" id="7072613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7072616">func</span>&nbsp;<span class="ident" id="7072621">TestReverseProxy</span><span class="op" id="7072637">(</span><span class="ident" id="7072638">t</span>&nbsp;<span class="op" id="7072640">*</span><span class="ident" id="7072641">testing</span><span class="op" id="7072648">.</span><span class="ident" id="7072649">T</span><span class="op" id="7072650">)</span>&nbsp;<span class="op" id="7072652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7072655">const</span>&nbsp;<span class="ident" id="7072661">backendResponse</span>&nbsp;<span class="op" id="7072677">=</span>&nbsp;<span class="string" id="7072679">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7072699">const</span>&nbsp;<span class="ident" id="7072705">backendStatus</span>&nbsp;<span class="op" id="7072719">=</span>&nbsp;<span class="num" id="7072721">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7072726">backend</span>&nbsp;<span class="op" id="7072734">:=</span>&nbsp;<span class="ident" id="7072737">httptest</span><span class="op" id="7072745">.</span><span class="ident" id="7072746">NewServer</span><span class="op" id="7072755">(</span><span class="ident" id="7072756">http</span><span class="op" id="7072760">.</span><span class="ident" id="7072761">HandlerFunc</span><span class="op" id="7072772">(</span><span class="keyword" id="7072773">func</span><span class="op" id="7072777">(</span><span class="ident" id="7072778">w</span>&nbsp;<span class="ident" id="7072780">http</span><span class="op" id="7072784">.</span><span class="ident" id="7072785">ResponseWriter</span><span class="op" id="7072799">,</span>&nbsp;<span class="ident" id="7072801">r</span>&nbsp;<span class="op" id="7072803">*</span><span class="ident" id="7072804">http</span><span class="op" id="7072808">.</span><span class="ident" id="7072809">Request</span><span class="op" id="7072816">)</span>&nbsp;<span class="op" id="7072818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7072822">if</span>&nbsp;<span class="builtinfunc" id="7072825">len</span><span class="op" id="7072828">(</span><span class="ident" id="7072829">r</span><span class="op" id="7072830">.</span><span class="ident" id="7072831">TransferEncoding</span><span class="op" id="7072847">)</span>&nbsp;<span class="op" id="7072849">&gt;</span>&nbsp;<span class="num" id="7072851">0</span>&nbsp;<span class="op" id="7072853">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7072858">t</span><span class="op" id="7072859">.</span><span class="ident" id="7072860">Errorf</span><span class="op" id="7072866">(</span><span class="string" id="7072867">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="7072912">,</span>&nbsp;<span class="ident" id="7072914">r</span><span class="op" id="7072915">.</span><span class="ident" id="7072916">TransferEncoding</span><span class="op" id="7072932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7072936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7072940">if</span>&nbsp;<span class="ident" id="7072943">r</span><span class="op" id="7072944">.</span><span class="ident" id="7072945">Header</span><span class="op" id="7072951">.</span><span class="ident" id="7072952">Get</span><span class="op" id="7072955">(</span><span class="string" id="7072956">&#34;X-Forwarded-For&#34;</span><span class="op" id="7072973">)</span>&nbsp;<span class="op" id="7072975">==</span>&nbsp;<span class="string" id="7072978">&#34;&#34;</span>&nbsp;<span class="op" id="7072981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7072986">t</span><span class="op" id="7072987">.</span><span class="ident" id="7072988">Errorf</span><span class="op" id="7072994">(</span><span class="string" id="7072995">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7073030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7073034">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7073038">if</span>&nbsp;<span class="ident" id="7073041">c</span>&nbsp;<span class="op" id="7073043">:=</span>&nbsp;<span class="ident" id="7073046">r</span><span class="op" id="7073047">.</span><span class="ident" id="7073048">Header</span><span class="op" id="7073054">.</span><span class="ident" id="7073055">Get</span><span class="op" id="7073058">(</span><span class="string" id="7073059">&#34;Connection&#34;</span><span class="op" id="7073071">)</span><span class="op" id="7073072">;</span>&nbsp;<span class="ident" id="7073074">c</span>&nbsp;<span class="op" id="7073076">!=</span>&nbsp;<span class="string" id="7073079">&#34;&#34;</span>&nbsp;<span class="op" id="7073082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073087">t</span><span class="op" id="7073088">.</span><span class="ident" id="7073089">Errorf</span><span class="op" id="7073095">(</span><span class="string" id="7073096">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7073136">,</span>&nbsp;<span class="ident" id="7073138">c</span><span class="op" id="7073139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7073143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7073147">if</span>&nbsp;<span class="ident" id="7073150">c</span>&nbsp;<span class="op" id="7073152">:=</span>&nbsp;<span class="ident" id="7073155">r</span><span class="op" id="7073156">.</span><span class="ident" id="7073157">Header</span><span class="op" id="7073163">.</span><span class="ident" id="7073164">Get</span><span class="op" id="7073167">(</span><span class="string" id="7073168">&#34;Upgrade&#34;</span><span class="op" id="7073177">)</span><span class="op" id="7073178">;</span>&nbsp;<span class="ident" id="7073180">c</span>&nbsp;<span class="op" id="7073182">!=</span>&nbsp;<span class="string" id="7073185">&#34;&#34;</span>&nbsp;<span class="op" id="7073188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073193">t</span><span class="op" id="7073194">.</span><span class="ident" id="7073195">Errorf</span><span class="op" id="7073201">(</span><span class="string" id="7073202">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7073239">,</span>&nbsp;<span class="ident" id="7073241">c</span><span class="op" id="7073242">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7073246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7073250">if</span>&nbsp;<span class="ident" id="7073253">g</span><span class="op" id="7073254">,</span>&nbsp;<span class="ident" id="7073256">e</span>&nbsp;<span class="op" id="7073258">:=</span>&nbsp;<span class="ident" id="7073261">r</span><span class="op" id="7073262">.</span><span class="ident" id="7073263">Host</span><span class="op" id="7073267">,</span>&nbsp;<span class="string" id="7073269">&#34;some-name&#34;</span><span class="op" id="7073280">;</span>&nbsp;<span class="ident" id="7073282">g</span>&nbsp;<span class="op" id="7073284">!=</span>&nbsp;<span class="ident" id="7073287">e</span>&nbsp;<span class="op" id="7073289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073294">t</span><span class="op" id="7073295">.</span><span class="ident" id="7073296">Errorf</span><span class="op" id="7073302">(</span><span class="string" id="7073303">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7073340">,</span>&nbsp;<span class="ident" id="7073342">g</span><span class="op" id="7073343">,</span>&nbsp;<span class="ident" id="7073345">e</span><span class="op" id="7073346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7073350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073354">w</span><span class="op" id="7073355">.</span><span class="ident" id="7073356">Header</span><span class="op" id="7073362">(</span><span class="op" id="7073363">)</span><span class="op" id="7073364">.</span><span class="ident" id="7073365">Set</span><span class="op" id="7073368">(</span><span class="string" id="7073369">&#34;X-Foo&#34;</span><span class="op" id="7073376">,</span>&nbsp;<span class="string" id="7073378">&#34;bar&#34;</span><span class="op" id="7073383">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073387">w</span><span class="op" id="7073388">.</span><span class="ident" id="7073389">Header</span><span class="op" id="7073395">(</span><span class="op" id="7073396">)</span><span class="op" id="7073397">.</span><span class="ident" id="7073398">Set</span><span class="op" id="7073401">(</span><span class="string" id="7073402">&#34;Upgrade&#34;</span><span class="op" id="7073411">,</span>&nbsp;<span class="string" id="7073413">&#34;foo&#34;</span><span class="op" id="7073418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073422">w</span><span class="op" id="7073423">.</span><span class="ident" id="7073424">Header</span><span class="op" id="7073430">(</span><span class="op" id="7073431">)</span><span class="op" id="7073432">.</span><span class="ident" id="7073433">Set</span><span class="op" id="7073436">(</span><span class="ident" id="7073437">fakeHopHeader</span><span class="op" id="7073450">,</span>&nbsp;<span class="string" id="7073452">&#34;foo&#34;</span><span class="op" id="7073457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073461">w</span><span class="op" id="7073462">.</span><span class="ident" id="7073463">Header</span><span class="op" id="7073469">(</span><span class="op" id="7073470">)</span><span class="op" id="7073471">.</span><span class="ident" id="7073472">Add</span><span class="op" id="7073475">(</span><span class="string" id="7073476">&#34;X-Multi-Value&#34;</span><span class="op" id="7073491">,</span>&nbsp;<span class="string" id="7073493">&#34;foo&#34;</span><span class="op" id="7073498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073502">w</span><span class="op" id="7073503">.</span><span class="ident" id="7073504">Header</span><span class="op" id="7073510">(</span><span class="op" id="7073511">)</span><span class="op" id="7073512">.</span><span class="ident" id="7073513">Add</span><span class="op" id="7073516">(</span><span class="string" id="7073517">&#34;X-Multi-Value&#34;</span><span class="op" id="7073532">,</span>&nbsp;<span class="string" id="7073534">&#34;bar&#34;</span><span class="op" id="7073539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073543">http</span><span class="op" id="7073547">.</span><span class="ident" id="7073548">SetCookie</span><span class="op" id="7073557">(</span><span class="ident" id="7073558">w</span><span class="op" id="7073559">,</span>&nbsp;<span class="op" id="7073561">&amp;</span><span class="ident" id="7073562">http</span><span class="op" id="7073566">.</span><span class="ident" id="7073567">Cookie</span><span class="op" id="7073573">{</span><span class="ident" id="7073574">Name</span><span class="op" id="7073578">:</span>&nbsp;<span class="string" id="7073580">&#34;flavor&#34;</span><span class="op" id="7073588">,</span>&nbsp;<span class="ident" id="7073590">Value</span><span class="op" id="7073595">:</span>&nbsp;<span class="string" id="7073597">&#34;chocolateChip&#34;</span><span class="op" id="7073612">}</span><span class="op" id="7073613">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073617">w</span><span class="op" id="7073618">.</span><span class="ident" id="7073619">WriteHeader</span><span class="op" id="7073630">(</span><span class="ident" id="7073631">backendStatus</span><span class="op" id="7073644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073648">w</span><span class="op" id="7073649">.</span><span class="ident" id="7073650">Write</span><span class="op" id="7073655">(</span><span class="op" id="7073656">[</span><span class="op" id="7073657">]</span><span class="builtintype" id="7073658">byte</span><span class="op" id="7073662">(</span><span class="ident" id="7073663">backendResponse</span><span class="op" id="7073678">)</span><span class="op" id="7073679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7073682">}</span><span class="op" id="7073683">)</span><span class="op" id="7073684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7073687">defer</span>&nbsp;<span class="ident" id="7073693">backend</span><span class="op" id="7073700">.</span><span class="ident" id="7073701">Close</span><span class="op" id="7073706">(</span><span class="op" id="7073707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073710">backendURL</span><span class="op" id="7073720">,</span>&nbsp;<span class="ident" id="7073722">err</span>&nbsp;<span class="op" id="7073726">:=</span>&nbsp;<span class="ident" id="7073729">url</span><span class="op" id="7073732">.</span><span class="ident" id="7073733">Parse</span><span class="op" id="7073738">(</span><span class="ident" id="7073739">backend</span><span class="op" id="7073746">.</span><span class="ident" id="7073747">URL</span><span class="op" id="7073750">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7073753">if</span>&nbsp;<span class="ident" id="7073756">err</span>&nbsp;<span class="op" id="7073760">!=</span>&nbsp;<span class="ident" id="7073763">nil</span>&nbsp;<span class="op" id="7073767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073771">t</span><span class="op" id="7073772">.</span><span class="ident" id="7073773">Fatal</span><span class="op" id="7073778">(</span><span class="ident" id="7073779">err</span><span class="op" id="7073782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7073785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073788">proxyHandler</span>&nbsp;<span class="op" id="7073801">:=</span>&nbsp;<span class="ident" id="7073804">NewSingleHostReverseProxy</span><span class="op" id="7073829">(</span><span class="ident" id="7073830">backendURL</span><span class="op" id="7073840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073843">frontend</span>&nbsp;<span class="op" id="7073852">:=</span>&nbsp;<span class="ident" id="7073855">httptest</span><span class="op" id="7073863">.</span><span class="ident" id="7073864">NewServer</span><span class="op" id="7073873">(</span><span class="ident" id="7073874">proxyHandler</span><span class="op" id="7073886">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7073889">defer</span>&nbsp;<span class="ident" id="7073895">frontend</span><span class="op" id="7073903">.</span><span class="ident" id="7073904">Close</span><span class="op" id="7073909">(</span><span class="op" id="7073910">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073914">getReq</span><span class="op" id="7073920">,</span>&nbsp;<span class="ident" id="7073922">_</span>&nbsp;<span class="op" id="7073924">:=</span>&nbsp;<span class="ident" id="7073927">http</span><span class="op" id="7073931">.</span><span class="ident" id="7073932">NewRequest</span><span class="op" id="7073942">(</span><span class="string" id="7073943">&#34;GET&#34;</span><span class="op" id="7073948">,</span>&nbsp;<span class="ident" id="7073950">frontend</span><span class="op" id="7073958">.</span><span class="ident" id="7073959">URL</span><span class="op" id="7073962">,</span>&nbsp;<span class="ident" id="7073964">nil</span><span class="op" id="7073967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073970">getReq</span><span class="op" id="7073976">.</span><span class="ident" id="7073977">Host</span>&nbsp;<span class="op" id="7073982">=</span>&nbsp;<span class="string" id="7073984">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7073997">getReq</span><span class="op" id="7074003">.</span><span class="ident" id="7074004">Header</span><span class="op" id="7074010">.</span><span class="ident" id="7074011">Set</span><span class="op" id="7074014">(</span><span class="string" id="7074015">&#34;Connection&#34;</span><span class="op" id="7074027">,</span>&nbsp;<span class="string" id="7074029">&#34;close&#34;</span><span class="op" id="7074036">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7074039">getReq</span><span class="op" id="7074045">.</span><span class="ident" id="7074046">Header</span><span class="op" id="7074052">.</span><span class="ident" id="7074053">Set</span><span class="op" id="7074056">(</span><span class="string" id="7074057">&#34;Upgrade&#34;</span><span class="op" id="7074066">,</span>&nbsp;<span class="string" id="7074068">&#34;foo&#34;</span><span class="op" id="7074073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7074076">getReq</span><span class="op" id="7074082">.</span><span class="ident" id="7074083">Close</span>&nbsp;<span class="op" id="7074089">=</span>&nbsp;<span class="builtintype" id="7074091">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7074097">res</span><span class="op" id="7074100">,</span>&nbsp;<span class="ident" id="7074102">err</span>&nbsp;<span class="op" id="7074106">:=</span>&nbsp;<span class="ident" id="7074109">http</span><span class="op" id="7074113">.</span><span class="ident" id="7074114">DefaultClient</span><span class="op" id="7074127">.</span><span class="ident" id="7074128">Do</span><span class="op" id="7074130">(</span><span class="ident" id="7074131">getReq</span><span class="op" id="7074137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7074140">if</span>&nbsp;<span class="ident" id="7074143">err</span>&nbsp;<span class="op" id="7074147">!=</span>&nbsp;<span class="ident" id="7074150">nil</span>&nbsp;<span class="op" id="7074154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7074158">t</span><span class="op" id="7074159">.</span><span class="ident" id="7074160">Fatalf</span><span class="op" id="7074166">(</span><span class="string" id="7074167">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7074176">,</span>&nbsp;<span class="ident" id="7074178">err</span><span class="op" id="7074181">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7074184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7074187">if</span>&nbsp;<span class="ident" id="7074190">g</span><span class="op" id="7074191">,</span>&nbsp;<span class="ident" id="7074193">e</span>&nbsp;<span class="op" id="7074195">:=</span>&nbsp;<span class="ident" id="7074198">res</span><span class="op" id="7074201">.</span><span class="ident" id="7074202">StatusCode</span><span class="op" id="7074212">,</span>&nbsp;<span class="ident" id="7074214">backendStatus</span><span class="op" id="7074227">;</span>&nbsp;<span class="ident" id="7074229">g</span>&nbsp;<span class="op" id="7074231">!=</span>&nbsp;<span class="ident" id="7074234">e</span>&nbsp;<span class="op" id="7074236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7074240">t</span><span class="op" id="7074241">.</span><span class="ident" id="7074242">Errorf</span><span class="op" id="7074248">(</span><span class="string" id="7074249">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7074285">,</span>&nbsp;<span class="ident" id="7074287">g</span><span class="op" id="7074288">,</span>&nbsp;<span class="ident" id="7074290">e</span><span class="op" id="7074291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7074294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7074297">if</span>&nbsp;<span class="ident" id="7074300">g</span><span class="op" id="7074301">,</span>&nbsp;<span class="ident" id="7074303">e</span>&nbsp;<span class="op" id="7074305">:=</span>&nbsp;<span class="ident" id="7074308">res</span><span class="op" id="7074311">.</span><span class="ident" id="7074312">Header</span><span class="op" id="7074318">.</span><span class="ident" id="7074319">Get</span><span class="op" id="7074322">(</span><span class="string" id="7074323">&#34;X-Foo&#34;</span><span class="op" id="7074330">)</span><span class="op" id="7074331">,</span>&nbsp;<span class="string" id="7074333">&#34;bar&#34;</span><span class="op" id="7074338">;</span>&nbsp;<span class="ident" id="7074340">g</span>&nbsp;<span class="op" id="7074342">!=</span>&nbsp;<span class="ident" id="7074345">e</span>&nbsp;<span class="op" id="7074347">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7074351">t</span><span class="op" id="7074352">.</span><span class="ident" id="7074353">Errorf</span><span class="op" id="7074359">(</span><span class="string" id="7074360">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7074387">,</span>&nbsp;<span class="ident" id="7074389">g</span><span class="op" id="7074390">,</span>&nbsp;<span class="ident" id="7074392">e</span><span class="op" id="7074393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7074396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7074399">if</span>&nbsp;<span class="ident" id="7074402">c</span>&nbsp;<span class="op" id="7074404">:=</span>&nbsp;<span class="ident" id="7074407">res</span><span class="op" id="7074410">.</span><span class="ident" id="7074411">Header</span><span class="op" id="7074417">.</span><span class="ident" id="7074418">Get</span><span class="op" id="7074421">(</span><span class="ident" id="7074422">fakeHopHeader</span><span class="op" id="7074435">)</span><span class="op" id="7074436">;</span>&nbsp;<span class="ident" id="7074438">c</span>&nbsp;<span class="op" id="7074440">!=</span>&nbsp;<span class="string" id="7074443">&#34;&#34;</span>&nbsp;<span class="op" id="7074446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7074450">t</span><span class="op" id="7074451">.</span><span class="ident" id="7074452">Errorf</span><span class="op" id="7074458">(</span><span class="string" id="7074459">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7074483">,</span>&nbsp;<span class="ident" id="7074485">fakeHopHeader</span><span class="op" id="7074498">,</span>&nbsp;<span class="ident" id="7074500">c</span><span class="op" id="7074501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7074504">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7074507">if</span>&nbsp;<span class="ident" id="7074510">g</span><span class="op" id="7074511">,</span>&nbsp;<span class="ident" id="7074513">e</span>&nbsp;<span class="op" id="7074515">:=</span>&nbsp;<span class="builtinfunc" id="7074518">len</span><span class="op" id="7074521">(</span><span class="ident" id="7074522">res</span><span class="op" id="7074525">.</span><span class="ident" id="7074526">Header</span><span class="op" id="7074532">[</span><span class="string" id="7074533">&#34;X-Multi-Value&#34;</span><span class="op" id="7074548">]</span><span class="op" id="7074549">)</span><span class="op" id="7074550">,</span>&nbsp;<span class="num" id="7074552">2</span><span class="op" id="7074553">;</span>&nbsp;<span class="ident" id="7074555">g</span>&nbsp;<span class="op" id="7074557">!=</span>&nbsp;<span class="ident" id="7074560">e</span>&nbsp;<span class="op" id="7074562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7074566">t</span><span class="op" id="7074567">.</span><span class="ident" id="7074568">Errorf</span><span class="op" id="7074574">(</span><span class="string" id="7074575">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7074624">,</span>&nbsp;<span class="ident" id="7074626">g</span><span class="op" id="7074627">,</span>&nbsp;<span class="ident" id="7074629">e</span><span class="op" id="7074630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7074633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7074636">if</span>&nbsp;<span class="ident" id="7074639">g</span><span class="op" id="7074640">,</span>&nbsp;<span class="ident" id="7074642">e</span>&nbsp;<span class="op" id="7074644">:=</span>&nbsp;<span class="builtinfunc" id="7074647">len</span><span class="op" id="7074650">(</span><span class="ident" id="7074651">res</span><span class="op" id="7074654">.</span><span class="ident" id="7074655">Header</span><span class="op" id="7074661">[</span><span class="string" id="7074662">&#34;Set-Cookie&#34;</span><span class="op" id="7074674">]</span><span class="op" id="7074675">)</span><span class="op" id="7074676">,</span>&nbsp;<span class="num" id="7074678">1</span><span class="op" id="7074679">;</span>&nbsp;<span class="ident" id="7074681">g</span>&nbsp;<span class="op" id="7074683">!=</span>&nbsp;<span class="ident" id="7074686">e</span>&nbsp;<span class="op" id="7074688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7074692">t</span><span class="op" id="7074693">.</span><span class="ident" id="7074694">Fatalf</span><span class="op" id="7074700">(</span><span class="string" id="7074701">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7074729">,</span>&nbsp;<span class="ident" id="7074731">g</span><span class="op" id="7074732">,</span>&nbsp;<span class="ident" id="7074734">e</span><span class="op" id="7074735">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7074738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7074741">if</span>&nbsp;<span class="ident" id="7074744">cookie</span>&nbsp;<span class="op" id="7074751">:=</span>&nbsp;<span class="ident" id="7074754">res</span><span class="op" id="7074757">.</span><span class="ident" id="7074758">Cookies</span><span class="op" id="7074765">(</span><span class="op" id="7074766">)</span><span class="op" id="7074767">[</span><span class="num" id="7074768">0</span><span class="op" id="7074769">]</span><span class="op" id="7074770">;</span>&nbsp;<span class="ident" id="7074772">cookie</span><span class="op" id="7074778">.</span><span class="ident" id="7074779">Name</span>&nbsp;<span class="op" id="7074784">!=</span>&nbsp;<span class="string" id="7074787">&#34;flavor&#34;</span>&nbsp;<span class="op" id="7074796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7074800">t</span><span class="op" id="7074801">.</span><span class="ident" id="7074802">Errorf</span><span class="op" id="7074808">(</span><span class="string" id="7074809">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="7074831">,</span>&nbsp;<span class="ident" id="7074833">cookie</span><span class="op" id="7074839">.</span><span class="ident" id="7074840">Name</span><span class="op" id="7074844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7074847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7074850">bodyBytes</span><span class="op" id="7074859">,</span>&nbsp;<span class="ident" id="7074861">_</span>&nbsp;<span class="op" id="7074863">:=</span>&nbsp;<span class="ident" id="7074866">ioutil</span><span class="op" id="7074872">.</span><span class="ident" id="7074873">ReadAll</span><span class="op" id="7074880">(</span><span class="ident" id="7074881">res</span><span class="op" id="7074884">.</span><span class="ident" id="7074885">Body</span><span class="op" id="7074889">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7074892">if</span>&nbsp;<span class="ident" id="7074895">g</span><span class="op" id="7074896">,</span>&nbsp;<span class="ident" id="7074898">e</span>&nbsp;<span class="op" id="7074900">:=</span>&nbsp;<span class="builtintype" id="7074903">string</span><span class="op" id="7074909">(</span><span class="ident" id="7074910">bodyBytes</span><span class="op" id="7074919">)</span><span class="op" id="7074920">,</span>&nbsp;<span class="ident" id="7074922">backendResponse</span><span class="op" id="7074937">;</span>&nbsp;<span class="ident" id="7074939">g</span>&nbsp;<span class="op" id="7074941">!=</span>&nbsp;<span class="ident" id="7074944">e</span>&nbsp;<span class="op" id="7074946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7074950">t</span><span class="op" id="7074951">.</span><span class="ident" id="7074952">Errorf</span><span class="op" id="7074958">(</span><span class="string" id="7074959">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7074985">,</span>&nbsp;<span class="ident" id="7074987">g</span><span class="op" id="7074988">,</span>&nbsp;<span class="ident" id="7074990">e</span><span class="op" id="7074991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7074994">}</span><br>
<span class="lineno"></span><span class="op" id="7074996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7074999">func</span>&nbsp;<span class="ident" id="7075004">TestXForwardedFor</span><span class="op" id="7075021">(</span><span class="ident" id="7075022">t</span>&nbsp;<span class="op" id="7075024">*</span><span class="ident" id="7075025">testing</span><span class="op" id="7075032">.</span><span class="ident" id="7075033">T</span><span class="op" id="7075034">)</span>&nbsp;<span class="op" id="7075036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7075039">const</span>&nbsp;<span class="ident" id="7075045">prevForwardedFor</span>&nbsp;<span class="op" id="7075062">=</span>&nbsp;<span class="string" id="7075064">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7075077">const</span>&nbsp;<span class="ident" id="7075083">backendResponse</span>&nbsp;<span class="op" id="7075099">=</span>&nbsp;<span class="string" id="7075101">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7075121">const</span>&nbsp;<span class="ident" id="7075127">backendStatus</span>&nbsp;<span class="op" id="7075141">=</span>&nbsp;<span class="num" id="7075143">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075148">backend</span>&nbsp;<span class="op" id="7075156">:=</span>&nbsp;<span class="ident" id="7075159">httptest</span><span class="op" id="7075167">.</span><span class="ident" id="7075168">NewServer</span><span class="op" id="7075177">(</span><span class="ident" id="7075178">http</span><span class="op" id="7075182">.</span><span class="ident" id="7075183">HandlerFunc</span><span class="op" id="7075194">(</span><span class="keyword" id="7075195">func</span><span class="op" id="7075199">(</span><span class="ident" id="7075200">w</span>&nbsp;<span class="ident" id="7075202">http</span><span class="op" id="7075206">.</span><span class="ident" id="7075207">ResponseWriter</span><span class="op" id="7075221">,</span>&nbsp;<span class="ident" id="7075223">r</span>&nbsp;<span class="op" id="7075225">*</span><span class="ident" id="7075226">http</span><span class="op" id="7075230">.</span><span class="ident" id="7075231">Request</span><span class="op" id="7075238">)</span>&nbsp;<span class="op" id="7075240">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7075244">if</span>&nbsp;<span class="ident" id="7075247">r</span><span class="op" id="7075248">.</span><span class="ident" id="7075249">Header</span><span class="op" id="7075255">.</span><span class="ident" id="7075256">Get</span><span class="op" id="7075259">(</span><span class="string" id="7075260">&#34;X-Forwarded-For&#34;</span><span class="op" id="7075277">)</span>&nbsp;<span class="op" id="7075279">==</span>&nbsp;<span class="string" id="7075282">&#34;&#34;</span>&nbsp;<span class="op" id="7075285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075290">t</span><span class="op" id="7075291">.</span><span class="ident" id="7075292">Errorf</span><span class="op" id="7075298">(</span><span class="string" id="7075299">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7075334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7075338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7075342">if</span>&nbsp;<span class="op" id="7075345">!</span><span class="ident" id="7075346">strings</span><span class="op" id="7075353">.</span><span class="ident" id="7075354">Contains</span><span class="op" id="7075362">(</span><span class="ident" id="7075363">r</span><span class="op" id="7075364">.</span><span class="ident" id="7075365">Header</span><span class="op" id="7075371">.</span><span class="ident" id="7075372">Get</span><span class="op" id="7075375">(</span><span class="string" id="7075376">&#34;X-Forwarded-For&#34;</span><span class="op" id="7075393">)</span><span class="op" id="7075394">,</span>&nbsp;<span class="ident" id="7075396">prevForwardedFor</span><span class="op" id="7075412">)</span>&nbsp;<span class="op" id="7075414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075419">t</span><span class="op" id="7075420">.</span><span class="ident" id="7075421">Errorf</span><span class="op" id="7075427">(</span><span class="string" id="7075428">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="7075471">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7075475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075479">w</span><span class="op" id="7075480">.</span><span class="ident" id="7075481">WriteHeader</span><span class="op" id="7075492">(</span><span class="ident" id="7075493">backendStatus</span><span class="op" id="7075506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075510">w</span><span class="op" id="7075511">.</span><span class="ident" id="7075512">Write</span><span class="op" id="7075517">(</span><span class="op" id="7075518">[</span><span class="op" id="7075519">]</span><span class="builtintype" id="7075520">byte</span><span class="op" id="7075524">(</span><span class="ident" id="7075525">backendResponse</span><span class="op" id="7075540">)</span><span class="op" id="7075541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7075544">}</span><span class="op" id="7075545">)</span><span class="op" id="7075546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7075549">defer</span>&nbsp;<span class="ident" id="7075555">backend</span><span class="op" id="7075562">.</span><span class="ident" id="7075563">Close</span><span class="op" id="7075568">(</span><span class="op" id="7075569">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075572">backendURL</span><span class="op" id="7075582">,</span>&nbsp;<span class="ident" id="7075584">err</span>&nbsp;<span class="op" id="7075588">:=</span>&nbsp;<span class="ident" id="7075591">url</span><span class="op" id="7075594">.</span><span class="ident" id="7075595">Parse</span><span class="op" id="7075600">(</span><span class="ident" id="7075601">backend</span><span class="op" id="7075608">.</span><span class="ident" id="7075609">URL</span><span class="op" id="7075612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7075615">if</span>&nbsp;<span class="ident" id="7075618">err</span>&nbsp;<span class="op" id="7075622">!=</span>&nbsp;<span class="ident" id="7075625">nil</span>&nbsp;<span class="op" id="7075629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075633">t</span><span class="op" id="7075634">.</span><span class="ident" id="7075635">Fatal</span><span class="op" id="7075640">(</span><span class="ident" id="7075641">err</span><span class="op" id="7075644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7075647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075650">proxyHandler</span>&nbsp;<span class="op" id="7075663">:=</span>&nbsp;<span class="ident" id="7075666">NewSingleHostReverseProxy</span><span class="op" id="7075691">(</span><span class="ident" id="7075692">backendURL</span><span class="op" id="7075702">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075705">frontend</span>&nbsp;<span class="op" id="7075714">:=</span>&nbsp;<span class="ident" id="7075717">httptest</span><span class="op" id="7075725">.</span><span class="ident" id="7075726">NewServer</span><span class="op" id="7075735">(</span><span class="ident" id="7075736">proxyHandler</span><span class="op" id="7075748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7075751">defer</span>&nbsp;<span class="ident" id="7075757">frontend</span><span class="op" id="7075765">.</span><span class="ident" id="7075766">Close</span><span class="op" id="7075771">(</span><span class="op" id="7075772">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075776">getReq</span><span class="op" id="7075782">,</span>&nbsp;<span class="ident" id="7075784">_</span>&nbsp;<span class="op" id="7075786">:=</span>&nbsp;<span class="ident" id="7075789">http</span><span class="op" id="7075793">.</span><span class="ident" id="7075794">NewRequest</span><span class="op" id="7075804">(</span><span class="string" id="7075805">&#34;GET&#34;</span><span class="op" id="7075810">,</span>&nbsp;<span class="ident" id="7075812">frontend</span><span class="op" id="7075820">.</span><span class="ident" id="7075821">URL</span><span class="op" id="7075824">,</span>&nbsp;<span class="ident" id="7075826">nil</span><span class="op" id="7075829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075832">getReq</span><span class="op" id="7075838">.</span><span class="ident" id="7075839">Host</span>&nbsp;<span class="op" id="7075844">=</span>&nbsp;<span class="string" id="7075846">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075859">getReq</span><span class="op" id="7075865">.</span><span class="ident" id="7075866">Header</span><span class="op" id="7075872">.</span><span class="ident" id="7075873">Set</span><span class="op" id="7075876">(</span><span class="string" id="7075877">&#34;Connection&#34;</span><span class="op" id="7075889">,</span>&nbsp;<span class="string" id="7075891">&#34;close&#34;</span><span class="op" id="7075898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075901">getReq</span><span class="op" id="7075907">.</span><span class="ident" id="7075908">Header</span><span class="op" id="7075914">.</span><span class="ident" id="7075915">Set</span><span class="op" id="7075918">(</span><span class="string" id="7075919">&#34;X-Forwarded-For&#34;</span><span class="op" id="7075936">,</span>&nbsp;<span class="ident" id="7075938">prevForwardedFor</span><span class="op" id="7075954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075957">getReq</span><span class="op" id="7075963">.</span><span class="ident" id="7075964">Close</span>&nbsp;<span class="op" id="7075970">=</span>&nbsp;<span class="builtintype" id="7075972">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7075978">res</span><span class="op" id="7075981">,</span>&nbsp;<span class="ident" id="7075983">err</span>&nbsp;<span class="op" id="7075987">:=</span>&nbsp;<span class="ident" id="7075990">http</span><span class="op" id="7075994">.</span><span class="ident" id="7075995">DefaultClient</span><span class="op" id="7076008">.</span><span class="ident" id="7076009">Do</span><span class="op" id="7076011">(</span><span class="ident" id="7076012">getReq</span><span class="op" id="7076018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7076021">if</span>&nbsp;<span class="ident" id="7076024">err</span>&nbsp;<span class="op" id="7076028">!=</span>&nbsp;<span class="ident" id="7076031">nil</span>&nbsp;<span class="op" id="7076035">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7076039">t</span><span class="op" id="7076040">.</span><span class="ident" id="7076041">Fatalf</span><span class="op" id="7076047">(</span><span class="string" id="7076048">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7076057">,</span>&nbsp;<span class="ident" id="7076059">err</span><span class="op" id="7076062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7076065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7076068">if</span>&nbsp;<span class="ident" id="7076071">g</span><span class="op" id="7076072">,</span>&nbsp;<span class="ident" id="7076074">e</span>&nbsp;<span class="op" id="7076076">:=</span>&nbsp;<span class="ident" id="7076079">res</span><span class="op" id="7076082">.</span><span class="ident" id="7076083">StatusCode</span><span class="op" id="7076093">,</span>&nbsp;<span class="ident" id="7076095">backendStatus</span><span class="op" id="7076108">;</span>&nbsp;<span class="ident" id="7076110">g</span>&nbsp;<span class="op" id="7076112">!=</span>&nbsp;<span class="ident" id="7076115">e</span>&nbsp;<span class="op" id="7076117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7076121">t</span><span class="op" id="7076122">.</span><span class="ident" id="7076123">Errorf</span><span class="op" id="7076129">(</span><span class="string" id="7076130">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7076166">,</span>&nbsp;<span class="ident" id="7076168">g</span><span class="op" id="7076169">,</span>&nbsp;<span class="ident" id="7076171">e</span><span class="op" id="7076172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7076175">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7076178">bodyBytes</span><span class="op" id="7076187">,</span>&nbsp;<span class="ident" id="7076189">_</span>&nbsp;<span class="op" id="7076191">:=</span>&nbsp;<span class="ident" id="7076194">ioutil</span><span class="op" id="7076200">.</span><span class="ident" id="7076201">ReadAll</span><span class="op" id="7076208">(</span><span class="ident" id="7076209">res</span><span class="op" id="7076212">.</span><span class="ident" id="7076213">Body</span><span class="op" id="7076217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7076220">if</span>&nbsp;<span class="ident" id="7076223">g</span><span class="op" id="7076224">,</span>&nbsp;<span class="ident" id="7076226">e</span>&nbsp;<span class="op" id="7076228">:=</span>&nbsp;<span class="builtintype" id="7076231">string</span><span class="op" id="7076237">(</span><span class="ident" id="7076238">bodyBytes</span><span class="op" id="7076247">)</span><span class="op" id="7076248">,</span>&nbsp;<span class="ident" id="7076250">backendResponse</span><span class="op" id="7076265">;</span>&nbsp;<span class="ident" id="7076267">g</span>&nbsp;<span class="op" id="7076269">!=</span>&nbsp;<span class="ident" id="7076272">e</span>&nbsp;<span class="op" id="7076274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7076278">t</span><span class="op" id="7076279">.</span><span class="ident" id="7076280">Errorf</span><span class="op" id="7076286">(</span><span class="string" id="7076287">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7076313">,</span>&nbsp;<span class="ident" id="7076315">g</span><span class="op" id="7076316">,</span>&nbsp;<span class="ident" id="7076318">e</span><span class="op" id="7076319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7076322">}</span><br>
<span class="lineno"></span><span class="op" id="7076324">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="7076327">var</span>&nbsp;<span class="ident" id="7076331">proxyQueryTests</span>&nbsp;<span class="op" id="7076347">=</span>&nbsp;<span class="op" id="7076349">[</span><span class="op" id="7076350">]</span><span class="keyword" id="7076351">struct</span>&nbsp;<span class="op" id="7076358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7076361">baseSuffix</span>&nbsp;<span class="builtintype" id="7076372">string</span>&nbsp;<span class="comment" id="7076379">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7076412">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="7076423">string</span>&nbsp;<span class="comment" id="7076430">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7076474">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7076485">string</span>&nbsp;<span class="comment" id="7076492">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="7076553">}</span><span class="op" id="7076554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7076557">{</span><span class="string" id="7076558">&#34;&#34;</span><span class="op" id="7076560">,</span>&nbsp;<span class="string" id="7076562">&#34;&#34;</span><span class="op" id="7076564">,</span>&nbsp;<span class="string" id="7076566">&#34;&#34;</span><span class="op" id="7076568">}</span><span class="op" id="7076569">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7076572">{</span><span class="string" id="7076573">&#34;?sta=tic&#34;</span><span class="op" id="7076583">,</span>&nbsp;<span class="string" id="7076585">&#34;?us=er&#34;</span><span class="op" id="7076593">,</span>&nbsp;<span class="string" id="7076595">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="7076610">}</span><span class="op" id="7076611">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7076614">{</span><span class="string" id="7076615">&#34;&#34;</span><span class="op" id="7076617">,</span>&nbsp;<span class="string" id="7076619">&#34;?us=er&#34;</span><span class="op" id="7076627">,</span>&nbsp;<span class="string" id="7076629">&#34;us=er&#34;</span><span class="op" id="7076636">}</span><span class="op" id="7076637">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7076640">{</span><span class="string" id="7076641">&#34;?sta=tic&#34;</span><span class="op" id="7076651">,</span>&nbsp;<span class="string" id="7076653">&#34;&#34;</span><span class="op" id="7076655">,</span>&nbsp;<span class="string" id="7076657">&#34;sta=tic&#34;</span><span class="op" id="7076666">}</span><span class="op" id="7076667">,</span><br>
<span class="lineno">145</span><span class="op" id="7076669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7076672">func</span>&nbsp;<span class="ident" id="7076677">TestReverseProxyQuery</span><span class="op" id="7076698">(</span><span class="ident" id="7076699">t</span>&nbsp;<span class="op" id="7076701">*</span><span class="ident" id="7076702">testing</span><span class="op" id="7076709">.</span><span class="ident" id="7076710">T</span><span class="op" id="7076711">)</span>&nbsp;<span class="op" id="7076713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7076716">backend</span>&nbsp;<span class="op" id="7076724">:=</span>&nbsp;<span class="ident" id="7076727">httptest</span><span class="op" id="7076735">.</span><span class="ident" id="7076736">NewServer</span><span class="op" id="7076745">(</span><span class="ident" id="7076746">http</span><span class="op" id="7076750">.</span><span class="ident" id="7076751">HandlerFunc</span><span class="op" id="7076762">(</span><span class="keyword" id="7076763">func</span><span class="op" id="7076767">(</span><span class="ident" id="7076768">w</span>&nbsp;<span class="ident" id="7076770">http</span><span class="op" id="7076774">.</span><span class="ident" id="7076775">ResponseWriter</span><span class="op" id="7076789">,</span>&nbsp;<span class="ident" id="7076791">r</span>&nbsp;<span class="op" id="7076793">*</span><span class="ident" id="7076794">http</span><span class="op" id="7076798">.</span><span class="ident" id="7076799">Request</span><span class="op" id="7076806">)</span>&nbsp;<span class="op" id="7076808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7076812">w</span><span class="op" id="7076813">.</span><span class="ident" id="7076814">Header</span><span class="op" id="7076820">(</span><span class="op" id="7076821">)</span><span class="op" id="7076822">.</span><span class="ident" id="7076823">Set</span><span class="op" id="7076826">(</span><span class="string" id="7076827">&#34;X-Got-Query&#34;</span><span class="op" id="7076840">,</span>&nbsp;<span class="ident" id="7076842">r</span><span class="op" id="7076843">.</span><span class="ident" id="7076844">URL</span><span class="op" id="7076847">.</span><span class="ident" id="7076848">RawQuery</span><span class="op" id="7076856">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7076860">w</span><span class="op" id="7076861">.</span><span class="ident" id="7076862">Write</span><span class="op" id="7076867">(</span><span class="op" id="7076868">[</span><span class="op" id="7076869">]</span><span class="builtintype" id="7076870">byte</span><span class="op" id="7076874">(</span><span class="string" id="7076875">&#34;hi&#34;</span><span class="op" id="7076879">)</span><span class="op" id="7076880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7076883">}</span><span class="op" id="7076884">)</span><span class="op" id="7076885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7076888">defer</span>&nbsp;<span class="ident" id="7076894">backend</span><span class="op" id="7076901">.</span><span class="ident" id="7076902">Close</span><span class="op" id="7076907">(</span><span class="op" id="7076908">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7076912">for</span>&nbsp;<span class="ident" id="7076916">i</span><span class="op" id="7076917">,</span>&nbsp;<span class="ident" id="7076919">tt</span>&nbsp;<span class="op" id="7076922">:=</span>&nbsp;<span class="keyword" id="7076925">range</span>&nbsp;<span class="ident" id="7076931">proxyQueryTests</span>&nbsp;<span class="op" id="7076947">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7076951">backendURL</span><span class="op" id="7076961">,</span>&nbsp;<span class="ident" id="7076963">err</span>&nbsp;<span class="op" id="7076967">:=</span>&nbsp;<span class="ident" id="7076970">url</span><span class="op" id="7076973">.</span><span class="ident" id="7076974">Parse</span><span class="op" id="7076979">(</span><span class="ident" id="7076980">backend</span><span class="op" id="7076987">.</span><span class="ident" id="7076988">URL</span>&nbsp;<span class="op" id="7076992">+</span>&nbsp;<span class="ident" id="7076994">tt</span><span class="op" id="7076996">.</span><span class="ident" id="7076997">baseSuffix</span><span class="op" id="7077007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7077011">if</span>&nbsp;<span class="ident" id="7077014">err</span>&nbsp;<span class="op" id="7077018">!=</span>&nbsp;<span class="ident" id="7077021">nil</span>&nbsp;<span class="op" id="7077025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077030">t</span><span class="op" id="7077031">.</span><span class="ident" id="7077032">Fatal</span><span class="op" id="7077037">(</span><span class="ident" id="7077038">err</span><span class="op" id="7077041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7077045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077049">frontend</span>&nbsp;<span class="op" id="7077058">:=</span>&nbsp;<span class="ident" id="7077061">httptest</span><span class="op" id="7077069">.</span><span class="ident" id="7077070">NewServer</span><span class="op" id="7077079">(</span><span class="ident" id="7077080">NewSingleHostReverseProxy</span><span class="op" id="7077105">(</span><span class="ident" id="7077106">backendURL</span><span class="op" id="7077116">)</span><span class="op" id="7077117">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077121">req</span><span class="op" id="7077124">,</span>&nbsp;<span class="ident" id="7077126">_</span>&nbsp;<span class="op" id="7077128">:=</span>&nbsp;<span class="ident" id="7077131">http</span><span class="op" id="7077135">.</span><span class="ident" id="7077136">NewRequest</span><span class="op" id="7077146">(</span><span class="string" id="7077147">&#34;GET&#34;</span><span class="op" id="7077152">,</span>&nbsp;<span class="ident" id="7077154">frontend</span><span class="op" id="7077162">.</span><span class="ident" id="7077163">URL</span><span class="op" id="7077166">+</span><span class="ident" id="7077167">tt</span><span class="op" id="7077169">.</span><span class="ident" id="7077170">reqSuffix</span><span class="op" id="7077179">,</span>&nbsp;<span class="ident" id="7077181">nil</span><span class="op" id="7077184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077188">req</span><span class="op" id="7077191">.</span><span class="ident" id="7077192">Close</span>&nbsp;<span class="op" id="7077198">=</span>&nbsp;<span class="builtintype" id="7077200">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077207">res</span><span class="op" id="7077210">,</span>&nbsp;<span class="ident" id="7077212">err</span>&nbsp;<span class="op" id="7077216">:=</span>&nbsp;<span class="ident" id="7077219">http</span><span class="op" id="7077223">.</span><span class="ident" id="7077224">DefaultClient</span><span class="op" id="7077237">.</span><span class="ident" id="7077238">Do</span><span class="op" id="7077240">(</span><span class="ident" id="7077241">req</span><span class="op" id="7077244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7077248">if</span>&nbsp;<span class="ident" id="7077251">err</span>&nbsp;<span class="op" id="7077255">!=</span>&nbsp;<span class="ident" id="7077258">nil</span>&nbsp;<span class="op" id="7077262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077267">t</span><span class="op" id="7077268">.</span><span class="ident" id="7077269">Fatalf</span><span class="op" id="7077275">(</span><span class="string" id="7077276">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="7077289">,</span>&nbsp;<span class="ident" id="7077291">i</span><span class="op" id="7077292">,</span>&nbsp;<span class="ident" id="7077294">err</span><span class="op" id="7077297">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7077301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7077305">if</span>&nbsp;<span class="ident" id="7077308">g</span><span class="op" id="7077309">,</span>&nbsp;<span class="ident" id="7077311">e</span>&nbsp;<span class="op" id="7077313">:=</span>&nbsp;<span class="ident" id="7077316">res</span><span class="op" id="7077319">.</span><span class="ident" id="7077320">Header</span><span class="op" id="7077326">.</span><span class="ident" id="7077327">Get</span><span class="op" id="7077330">(</span><span class="string" id="7077331">&#34;X-Got-Query&#34;</span><span class="op" id="7077344">)</span><span class="op" id="7077345">,</span>&nbsp;<span class="ident" id="7077347">tt</span><span class="op" id="7077349">.</span><span class="ident" id="7077350">want</span><span class="op" id="7077354">;</span>&nbsp;<span class="ident" id="7077356">g</span>&nbsp;<span class="op" id="7077358">!=</span>&nbsp;<span class="ident" id="7077361">e</span>&nbsp;<span class="op" id="7077363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077368">t</span><span class="op" id="7077369">.</span><span class="ident" id="7077370">Errorf</span><span class="op" id="7077376">(</span><span class="string" id="7077377">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7077408">,</span>&nbsp;<span class="ident" id="7077410">i</span><span class="op" id="7077411">,</span>&nbsp;<span class="ident" id="7077413">g</span><span class="op" id="7077414">,</span>&nbsp;<span class="ident" id="7077416">e</span><span class="op" id="7077417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7077421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077425">res</span><span class="op" id="7077428">.</span><span class="ident" id="7077429">Body</span><span class="op" id="7077433">.</span><span class="ident" id="7077434">Close</span><span class="op" id="7077439">(</span><span class="op" id="7077440">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077444">frontend</span><span class="op" id="7077452">.</span><span class="ident" id="7077453">Close</span><span class="op" id="7077458">(</span><span class="op" id="7077459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7077462">}</span><br>
<span class="lineno"></span><span class="op" id="7077464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7077467">func</span>&nbsp;<span class="ident" id="7077472">TestReverseProxyFlushInterval</span><span class="op" id="7077501">(</span><span class="ident" id="7077502">t</span>&nbsp;<span class="op" id="7077504">*</span><span class="ident" id="7077505">testing</span><span class="op" id="7077512">.</span><span class="ident" id="7077513">T</span><span class="op" id="7077514">)</span>&nbsp;<span class="op" id="7077516">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7077519">const</span>&nbsp;<span class="ident" id="7077525">expected</span>&nbsp;<span class="op" id="7077534">=</span>&nbsp;<span class="string" id="7077536">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077542">backend</span>&nbsp;<span class="op" id="7077550">:=</span>&nbsp;<span class="ident" id="7077553">httptest</span><span class="op" id="7077561">.</span><span class="ident" id="7077562">NewServer</span><span class="op" id="7077571">(</span><span class="ident" id="7077572">http</span><span class="op" id="7077576">.</span><span class="ident" id="7077577">HandlerFunc</span><span class="op" id="7077588">(</span><span class="keyword" id="7077589">func</span><span class="op" id="7077593">(</span><span class="ident" id="7077594">w</span>&nbsp;<span class="ident" id="7077596">http</span><span class="op" id="7077600">.</span><span class="ident" id="7077601">ResponseWriter</span><span class="op" id="7077615">,</span>&nbsp;<span class="ident" id="7077617">r</span>&nbsp;<span class="op" id="7077619">*</span><span class="ident" id="7077620">http</span><span class="op" id="7077624">.</span><span class="ident" id="7077625">Request</span><span class="op" id="7077632">)</span>&nbsp;<span class="op" id="7077634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077638">w</span><span class="op" id="7077639">.</span><span class="ident" id="7077640">Write</span><span class="op" id="7077645">(</span><span class="op" id="7077646">[</span><span class="op" id="7077647">]</span><span class="builtintype" id="7077648">byte</span><span class="op" id="7077652">(</span><span class="ident" id="7077653">expected</span><span class="op" id="7077661">)</span><span class="op" id="7077662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7077665">}</span><span class="op" id="7077666">)</span><span class="op" id="7077667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7077670">defer</span>&nbsp;<span class="ident" id="7077676">backend</span><span class="op" id="7077683">.</span><span class="ident" id="7077684">Close</span><span class="op" id="7077689">(</span><span class="op" id="7077690">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077694">backendURL</span><span class="op" id="7077704">,</span>&nbsp;<span class="ident" id="7077706">err</span>&nbsp;<span class="op" id="7077710">:=</span>&nbsp;<span class="ident" id="7077713">url</span><span class="op" id="7077716">.</span><span class="ident" id="7077717">Parse</span><span class="op" id="7077722">(</span><span class="ident" id="7077723">backend</span><span class="op" id="7077730">.</span><span class="ident" id="7077731">URL</span><span class="op" id="7077734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7077737">if</span>&nbsp;<span class="ident" id="7077740">err</span>&nbsp;<span class="op" id="7077744">!=</span>&nbsp;<span class="ident" id="7077747">nil</span>&nbsp;<span class="op" id="7077751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077755">t</span><span class="op" id="7077756">.</span><span class="ident" id="7077757">Fatal</span><span class="op" id="7077762">(</span><span class="ident" id="7077763">err</span><span class="op" id="7077766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7077769">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077773">proxyHandler</span>&nbsp;<span class="op" id="7077786">:=</span>&nbsp;<span class="ident" id="7077789">NewSingleHostReverseProxy</span><span class="op" id="7077814">(</span><span class="ident" id="7077815">backendURL</span><span class="op" id="7077825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077828">proxyHandler</span><span class="op" id="7077840">.</span><span class="ident" id="7077841">FlushInterval</span>&nbsp;<span class="op" id="7077855">=</span>&nbsp;<span class="ident" id="7077857">time</span><span class="op" id="7077861">.</span><span class="ident" id="7077862">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077876">done</span>&nbsp;<span class="op" id="7077881">:=</span>&nbsp;<span class="builtinfunc" id="7077884">make</span><span class="op" id="7077888">(</span><span class="keyword" id="7077889">chan</span>&nbsp;<span class="builtintype" id="7077894">bool</span><span class="op" id="7077898">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077901">onExitFlushLoop</span>&nbsp;<span class="op" id="7077917">=</span>&nbsp;<span class="keyword" id="7077919">func</span><span class="op" id="7077923">(</span><span class="op" id="7077924">)</span>&nbsp;<span class="op" id="7077926">{</span>&nbsp;<span class="ident" id="7077928">done</span>&nbsp;<span class="op" id="7077933">&lt;-</span>&nbsp;<span class="builtintype" id="7077936">true</span>&nbsp;<span class="op" id="7077941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7077944">defer</span>&nbsp;<span class="keyword" id="7077950">func</span><span class="op" id="7077954">(</span><span class="op" id="7077955">)</span>&nbsp;<span class="op" id="7077957">{</span>&nbsp;<span class="ident" id="7077959">onExitFlushLoop</span>&nbsp;<span class="op" id="7077975">=</span>&nbsp;<span class="ident" id="7077977">nil</span>&nbsp;<span class="op" id="7077981">}</span><span class="op" id="7077982">(</span><span class="op" id="7077983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7077987">frontend</span>&nbsp;<span class="op" id="7077996">:=</span>&nbsp;<span class="ident" id="7077999">httptest</span><span class="op" id="7078007">.</span><span class="ident" id="7078008">NewServer</span><span class="op" id="7078017">(</span><span class="ident" id="7078018">proxyHandler</span><span class="op" id="7078030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7078033">defer</span>&nbsp;<span class="ident" id="7078039">frontend</span><span class="op" id="7078047">.</span><span class="ident" id="7078048">Close</span><span class="op" id="7078053">(</span><span class="op" id="7078054">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7078058">req</span><span class="op" id="7078061">,</span>&nbsp;<span class="ident" id="7078063">_</span>&nbsp;<span class="op" id="7078065">:=</span>&nbsp;<span class="ident" id="7078068">http</span><span class="op" id="7078072">.</span><span class="ident" id="7078073">NewRequest</span><span class="op" id="7078083">(</span><span class="string" id="7078084">&#34;GET&#34;</span><span class="op" id="7078089">,</span>&nbsp;<span class="ident" id="7078091">frontend</span><span class="op" id="7078099">.</span><span class="ident" id="7078100">URL</span><span class="op" id="7078103">,</span>&nbsp;<span class="ident" id="7078105">nil</span><span class="op" id="7078108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7078111">req</span><span class="op" id="7078114">.</span><span class="ident" id="7078115">Close</span>&nbsp;<span class="op" id="7078121">=</span>&nbsp;<span class="builtintype" id="7078123">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7078129">res</span><span class="op" id="7078132">,</span>&nbsp;<span class="ident" id="7078134">err</span>&nbsp;<span class="op" id="7078138">:=</span>&nbsp;<span class="ident" id="7078141">http</span><span class="op" id="7078145">.</span><span class="ident" id="7078146">DefaultClient</span><span class="op" id="7078159">.</span><span class="ident" id="7078160">Do</span><span class="op" id="7078162">(</span><span class="ident" id="7078163">req</span><span class="op" id="7078166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7078169">if</span>&nbsp;<span class="ident" id="7078172">err</span>&nbsp;<span class="op" id="7078176">!=</span>&nbsp;<span class="ident" id="7078179">nil</span>&nbsp;<span class="op" id="7078183">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7078187">t</span><span class="op" id="7078188">.</span><span class="ident" id="7078189">Fatalf</span><span class="op" id="7078195">(</span><span class="string" id="7078196">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7078205">,</span>&nbsp;<span class="ident" id="7078207">err</span><span class="op" id="7078210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7078213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7078216">defer</span>&nbsp;<span class="ident" id="7078222">res</span><span class="op" id="7078225">.</span><span class="ident" id="7078226">Body</span><span class="op" id="7078230">.</span><span class="ident" id="7078231">Close</span><span class="op" id="7078236">(</span><span class="op" id="7078237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7078240">if</span>&nbsp;<span class="ident" id="7078243">bodyBytes</span><span class="op" id="7078252">,</span>&nbsp;<span class="ident" id="7078254">_</span>&nbsp;<span class="op" id="7078256">:=</span>&nbsp;<span class="ident" id="7078259">ioutil</span><span class="op" id="7078265">.</span><span class="ident" id="7078266">ReadAll</span><span class="op" id="7078273">(</span><span class="ident" id="7078274">res</span><span class="op" id="7078277">.</span><span class="ident" id="7078278">Body</span><span class="op" id="7078282">)</span><span class="op" id="7078283">;</span>&nbsp;<span class="builtintype" id="7078285">string</span><span class="op" id="7078291">(</span><span class="ident" id="7078292">bodyBytes</span><span class="op" id="7078301">)</span>&nbsp;<span class="op" id="7078303">!=</span>&nbsp;<span class="ident" id="7078306">expected</span>&nbsp;<span class="op" id="7078315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7078319">t</span><span class="op" id="7078320">.</span><span class="ident" id="7078321">Errorf</span><span class="op" id="7078327">(</span><span class="string" id="7078328">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7078354">,</span>&nbsp;<span class="ident" id="7078356">bodyBytes</span><span class="op" id="7078365">,</span>&nbsp;<span class="ident" id="7078367">expected</span><span class="op" id="7078375">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7078378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7078382">select</span>&nbsp;<span class="op" id="7078389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7078392">case</span>&nbsp;<span class="op" id="7078397">&lt;-</span><span class="ident" id="7078399">done</span><span class="op" id="7078403">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7078407">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7078414">case</span>&nbsp;<span class="op" id="7078419">&lt;-</span><span class="ident" id="7078421">time</span><span class="op" id="7078425">.</span><span class="ident" id="7078426">After</span><span class="op" id="7078431">(</span><span class="num" id="7078432">5</span>&nbsp;<span class="op" id="7078434">*</span>&nbsp;<span class="ident" id="7078436">time</span><span class="op" id="7078440">.</span><span class="ident" id="7078441">Second</span><span class="op" id="7078447">)</span><span class="op" id="7078448">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7078452">t</span><span class="op" id="7078453">.</span><span class="ident" id="7078454">Error</span><span class="op" id="7078459">(</span><span class="string" id="7078460">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="7078503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7078506">}</span><br>
<span class="lineno"></span><span class="op" id="7078508">}</span>
</div>
</body>
</html>
