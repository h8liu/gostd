<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/x509</h2>
<ul>
<li><a href="/gostd/crypto/x509/cert_pool.go.html">cert_pool.go</a></li>
<li><a href="/gostd/crypto/x509/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/x509/pem_decrypt.go.html">pem_decrypt.go</a></li>
<li><a href="/gostd/crypto/x509/pem_decrypt_test.go.html">pem_decrypt_test.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs1.go.html">pkcs1.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs8.go.html">pkcs8.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs8_test.go.html">pkcs8_test.go</a></li>
<li><a href="/gostd/crypto/x509/root.go.html">root.go</a></li>
<li><a href="/gostd/crypto/x509/root_unix.go.html">root_unix.go</a></li>
<li><a href="/gostd/crypto/x509/sec1.go.html">sec1.go</a></li>
<li><a href="/gostd/crypto/x509/sec1_test.go.html">sec1_test.go</a></li>
<li><a href="/gostd/crypto/x509/verify.go.html" class="current">verify.go</a></li>
<li><a href="/gostd/crypto/x509/verify_test.go.html">verify_test.go</a></li>
<li><a href="/gostd/crypto/x509/x509.go.html">x509.go</a></li>
<li><a href="/gostd/crypto/x509/x509_test.go.html">x509_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4514541">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4514596">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4514650">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4514701">package</span>&nbsp;<span class="ident" id="4514709">x509</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4514715">import</span>&nbsp;<span class="op" id="4514722">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4514725">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4514732">&#34;net&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4514739">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4514750">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4514761">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4514769">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="4514784">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="4514787">type</span>&nbsp;<span class="ident" id="4514792">InvalidReason</span>&nbsp;<span class="builtintype" id="4514806">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4514811">const</span>&nbsp;<span class="op" id="4514817">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4514820">//&nbsp;NotAuthorizedToSign&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;another</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4514892">//&nbsp;which&nbsp;isn&#39;t&nbsp;marked&nbsp;as&nbsp;a&nbsp;CA&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4514936">NotAuthorizedToSign</span>&nbsp;<span class="ident" id="4514956">InvalidReason</span>&nbsp;<span class="op" id="4514970">=</span>&nbsp;<span class="ident" id="4514972">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4514978">//&nbsp;Expired&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;has&nbsp;expired,&nbsp;based&nbsp;on&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4515048">//&nbsp;given&nbsp;in&nbsp;the&nbsp;VerifyOptions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4515080">Expired</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4515089">//&nbsp;CANotAuthorizedForThisName&nbsp;results&nbsp;when&nbsp;an&nbsp;intermediate&nbsp;or&nbsp;root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4515157">//&nbsp;certificate&nbsp;has&nbsp;a&nbsp;name&nbsp;constraint&nbsp;which&nbsp;doesn&#39;t&nbsp;include&nbsp;the&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4515226">//&nbsp;being&nbsp;checked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4515245">CANotAuthorizedForThisName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4515273">//&nbsp;TooManyIntermediates&nbsp;results&nbsp;when&nbsp;a&nbsp;path&nbsp;length&nbsp;constraint&nbsp;is</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4515339">//&nbsp;violated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4515353">TooManyIntermediates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4515375">//&nbsp;IncompatibleUsage&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&#39;s&nbsp;key&nbsp;usage&nbsp;indicates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4515448">//&nbsp;that&nbsp;it&nbsp;may&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;a&nbsp;different&nbsp;purpose.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4515502">IncompatibleUsage</span><br>
<span class="lineno">35</span><span class="op" id="4515520">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4515523">//&nbsp;CertificateInvalidError&nbsp;results&nbsp;when&nbsp;an&nbsp;odd&nbsp;error&nbsp;occurs.&nbsp;Users&nbsp;of&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="4515598">//&nbsp;library&nbsp;probably&nbsp;want&nbsp;to&nbsp;handle&nbsp;all&nbsp;these&nbsp;errors&nbsp;uniformly.</span><br>
<span class="lineno"></span><span class="keyword" id="4515661">type</span>&nbsp;<span class="ident" id="4515666">CertificateInvalidError</span>&nbsp;<span class="keyword" id="4515690">struct</span>&nbsp;<span class="op" id="4515697">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4515700">Cert</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4515707">*</span><span class="ident" id="4515708">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4515721">Reason</span>&nbsp;<span class="ident" id="4515728">InvalidReason</span><br>
<span class="lineno"></span><span class="op" id="4515742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4515745">func</span>&nbsp;<span class="op" id="4515750">(</span><span class="ident" id="4515751">e</span>&nbsp;<span class="ident" id="4515753">CertificateInvalidError</span><span class="op" id="4515776">)</span>&nbsp;<span class="ident" id="4515778">Error</span><span class="op" id="4515783">(</span><span class="op" id="4515784">)</span>&nbsp;<span class="builtintype" id="4515786">string</span>&nbsp;<span class="op" id="4515793">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4515796">switch</span>&nbsp;<span class="ident" id="4515803">e</span><span class="op" id="4515804">.</span><span class="ident" id="4515805">Reason</span>&nbsp;<span class="op" id="4515812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4515815">case</span>&nbsp;<span class="ident" id="4515820">NotAuthorizedToSign</span><span class="op" id="4515839">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4515843">return</span>&nbsp;<span class="string" id="4515850">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;other&nbsp;certificates&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4515916">case</span>&nbsp;<span class="ident" id="4515921">Expired</span><span class="op" id="4515928">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4515932">return</span>&nbsp;<span class="string" id="4515939">&#34;x509:&nbsp;certificate&nbsp;has&nbsp;expired&nbsp;or&nbsp;is&nbsp;not&nbsp;yet&nbsp;valid&#34;</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4515992">case</span>&nbsp;<span class="ident" id="4515997">CANotAuthorizedForThisName</span><span class="op" id="4516023">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516027">return</span>&nbsp;<span class="string" id="4516034">&#34;x509:&nbsp;a&nbsp;root&nbsp;or&nbsp;intermediate&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;in&nbsp;this&nbsp;domain&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516119">case</span>&nbsp;<span class="ident" id="4516124">TooManyIntermediates</span><span class="op" id="4516144">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516148">return</span>&nbsp;<span class="string" id="4516155">&#34;x509:&nbsp;too&nbsp;many&nbsp;intermediates&nbsp;for&nbsp;path&nbsp;length&nbsp;constraint&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516214">case</span>&nbsp;<span class="ident" id="4516219">IncompatibleUsage</span><span class="op" id="4516236">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516240">return</span>&nbsp;<span class="string" id="4516247">&#34;x509:&nbsp;certificate&nbsp;specifies&nbsp;an&nbsp;incompatible&nbsp;key&nbsp;usage&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4516304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516307">return</span>&nbsp;<span class="string" id="4516314">&#34;x509:&nbsp;unknown&nbsp;error&#34;</span><br>
<span class="lineno"></span><span class="op" id="4516336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="4516339">//&nbsp;HostnameError&nbsp;results&nbsp;when&nbsp;the&nbsp;set&nbsp;of&nbsp;authorized&nbsp;names&nbsp;doesn&#39;t&nbsp;match&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4516415">//&nbsp;requested&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="4516434">type</span>&nbsp;<span class="ident" id="4516439">HostnameError</span>&nbsp;<span class="keyword" id="4516453">struct</span>&nbsp;<span class="op" id="4516460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4516463">Certificate</span>&nbsp;<span class="op" id="4516475">*</span><span class="ident" id="4516476">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4516489">Host</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4516501">string</span><br>
<span class="lineno">65</span><span class="op" id="4516508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4516511">func</span>&nbsp;<span class="op" id="4516516">(</span><span class="ident" id="4516517">h</span>&nbsp;<span class="ident" id="4516519">HostnameError</span><span class="op" id="4516532">)</span>&nbsp;<span class="ident" id="4516534">Error</span><span class="op" id="4516539">(</span><span class="op" id="4516540">)</span>&nbsp;<span class="builtintype" id="4516542">string</span>&nbsp;<span class="op" id="4516549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4516552">c</span>&nbsp;<span class="op" id="4516554">:=</span>&nbsp;<span class="ident" id="4516557">h</span><span class="op" id="4516558">.</span><span class="ident" id="4516559">Certificate</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516573">var</span>&nbsp;<span class="ident" id="4516577">valid</span>&nbsp;<span class="builtintype" id="4516583">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516591">if</span>&nbsp;<span class="ident" id="4516594">ip</span>&nbsp;<span class="op" id="4516597">:=</span>&nbsp;<span class="ident" id="4516600">net</span><span class="op" id="4516603">.</span><span class="ident" id="4516604">ParseIP</span><span class="op" id="4516611">(</span><span class="ident" id="4516612">h</span><span class="op" id="4516613">.</span><span class="ident" id="4516614">Host</span><span class="op" id="4516618">)</span><span class="op" id="4516619">;</span>&nbsp;<span class="ident" id="4516621">ip</span>&nbsp;<span class="op" id="4516624">!=</span>&nbsp;<span class="builtintype" id="4516627">nil</span>&nbsp;<span class="op" id="4516631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4516635">//&nbsp;Trying&nbsp;to&nbsp;validate&nbsp;an&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516665">if</span>&nbsp;<span class="builtinfunc" id="4516668">len</span><span class="op" id="4516671">(</span><span class="ident" id="4516672">c</span><span class="op" id="4516673">.</span><span class="ident" id="4516674">IPAddresses</span><span class="op" id="4516685">)</span>&nbsp;<span class="op" id="4516687">==</span>&nbsp;<span class="num" id="4516690">0</span>&nbsp;<span class="op" id="4516692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516697">return</span>&nbsp;<span class="string" id="4516704">&#34;x509:&nbsp;cannot&nbsp;validate&nbsp;certificate&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="4516745">+</span>&nbsp;<span class="ident" id="4516747">h</span><span class="op" id="4516748">.</span><span class="ident" id="4516749">Host</span>&nbsp;<span class="op" id="4516754">+</span>&nbsp;<span class="string" id="4516756">&#34;&nbsp;because&nbsp;it&nbsp;doesn&#39;t&nbsp;contain&nbsp;any&nbsp;IP&nbsp;SANs&#34;</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4516800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516804">for</span>&nbsp;<span class="ident" id="4516808">_</span><span class="op" id="4516809">,</span>&nbsp;<span class="ident" id="4516811">san</span>&nbsp;<span class="op" id="4516815">:=</span>&nbsp;<span class="keyword" id="4516818">range</span>&nbsp;<span class="ident" id="4516824">c</span><span class="op" id="4516825">.</span><span class="ident" id="4516826">IPAddresses</span>&nbsp;<span class="op" id="4516838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516843">if</span>&nbsp;<span class="builtinfunc" id="4516846">len</span><span class="op" id="4516849">(</span><span class="ident" id="4516850">valid</span><span class="op" id="4516855">)</span>&nbsp;<span class="op" id="4516857">&gt;</span>&nbsp;<span class="num" id="4516859">0</span>&nbsp;<span class="op" id="4516861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4516867">valid</span>&nbsp;<span class="op" id="4516873">+=</span>&nbsp;<span class="string" id="4516876">&#34;,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4516884">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4516889">valid</span>&nbsp;<span class="op" id="4516895">+=</span>&nbsp;<span class="ident" id="4516898">san</span><span class="op" id="4516901">.</span><span class="ident" id="4516902">String</span><span class="op" id="4516908">(</span><span class="op" id="4516909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4516913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4516916">}</span>&nbsp;<span class="keyword" id="4516918">else</span>&nbsp;<span class="op" id="4516923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4516927">if</span>&nbsp;<span class="builtinfunc" id="4516930">len</span><span class="op" id="4516933">(</span><span class="ident" id="4516934">c</span><span class="op" id="4516935">.</span><span class="ident" id="4516936">DNSNames</span><span class="op" id="4516944">)</span>&nbsp;<span class="op" id="4516946">&gt;</span>&nbsp;<span class="num" id="4516948">0</span>&nbsp;<span class="op" id="4516950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4516955">valid</span>&nbsp;<span class="op" id="4516961">=</span>&nbsp;<span class="ident" id="4516963">strings</span><span class="op" id="4516970">.</span><span class="ident" id="4516971">Join</span><span class="op" id="4516975">(</span><span class="ident" id="4516976">c</span><span class="op" id="4516977">.</span><span class="ident" id="4516978">DNSNames</span><span class="op" id="4516986">,</span>&nbsp;<span class="string" id="4516988">&#34;,&nbsp;&#34;</span><span class="op" id="4516992">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4516996">}</span>&nbsp;<span class="keyword" id="4516998">else</span>&nbsp;<span class="op" id="4517003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4517008">valid</span>&nbsp;<span class="op" id="4517014">=</span>&nbsp;<span class="ident" id="4517016">c</span><span class="op" id="4517017">.</span><span class="ident" id="4517018">Subject</span><span class="op" id="4517025">.</span><span class="ident" id="4517026">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4517039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4517042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4517045">return</span>&nbsp;<span class="string" id="4517052">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;valid&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="4517086">+</span>&nbsp;<span class="ident" id="4517088">valid</span>&nbsp;<span class="op" id="4517094">+</span>&nbsp;<span class="string" id="4517096">&#34;,&nbsp;not&nbsp;&#34;</span>&nbsp;<span class="op" id="4517105">+</span>&nbsp;<span class="ident" id="4517107">h</span><span class="op" id="4517108">.</span><span class="ident" id="4517109">Host</span><br>
<span class="lineno">90</span><span class="op" id="4517114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4517117">//&nbsp;UnknownAuthorityError&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&nbsp;issuer&nbsp;is&nbsp;unknown</span><br>
<span class="lineno"></span><span class="keyword" id="4517189">type</span>&nbsp;<span class="ident" id="4517194">UnknownAuthorityError</span>&nbsp;<span class="keyword" id="4517216">struct</span>&nbsp;<span class="op" id="4517223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4517226">cert</span>&nbsp;<span class="op" id="4517231">*</span><span class="ident" id="4517232">Certificate</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4517245">//&nbsp;hintErr&nbsp;contains&nbsp;an&nbsp;error&nbsp;that&nbsp;may&nbsp;be&nbsp;helpful&nbsp;in&nbsp;determining&nbsp;why&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4517317">//&nbsp;authority&nbsp;wasn&#39;t&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4517345">hintErr</span>&nbsp;<span class="builtintype" id="4517353">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4517360">//&nbsp;hintCert&nbsp;contains&nbsp;a&nbsp;possible&nbsp;authority&nbsp;certificate&nbsp;that&nbsp;was&nbsp;rejected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4517433">//&nbsp;because&nbsp;of&nbsp;the&nbsp;error&nbsp;in&nbsp;hintErr.</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4517470">hintCert</span>&nbsp;<span class="op" id="4517479">*</span><span class="ident" id="4517480">Certificate</span><br>
<span class="lineno"></span><span class="op" id="4517492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4517495">func</span>&nbsp;<span class="op" id="4517500">(</span><span class="ident" id="4517501">e</span>&nbsp;<span class="ident" id="4517503">UnknownAuthorityError</span><span class="op" id="4517524">)</span>&nbsp;<span class="ident" id="4517526">Error</span><span class="op" id="4517531">(</span><span class="op" id="4517532">)</span>&nbsp;<span class="builtintype" id="4517534">string</span>&nbsp;<span class="op" id="4517541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4517544">s</span>&nbsp;<span class="op" id="4517546">:=</span>&nbsp;<span class="string" id="4517549">&#34;x509:&nbsp;certificate&nbsp;signed&nbsp;by&nbsp;unknown&nbsp;authority&#34;</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4517598">if</span>&nbsp;<span class="ident" id="4517601">e</span><span class="op" id="4517602">.</span><span class="ident" id="4517603">hintErr</span>&nbsp;<span class="op" id="4517611">!=</span>&nbsp;<span class="builtintype" id="4517614">nil</span>&nbsp;<span class="op" id="4517618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4517622">certName</span>&nbsp;<span class="op" id="4517631">:=</span>&nbsp;<span class="ident" id="4517634">e</span><span class="op" id="4517635">.</span><span class="ident" id="4517636">hintCert</span><span class="op" id="4517644">.</span><span class="ident" id="4517645">Subject</span><span class="op" id="4517652">.</span><span class="ident" id="4517653">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4517666">if</span>&nbsp;<span class="builtinfunc" id="4517669">len</span><span class="op" id="4517672">(</span><span class="ident" id="4517673">certName</span><span class="op" id="4517681">)</span>&nbsp;<span class="op" id="4517683">==</span>&nbsp;<span class="num" id="4517686">0</span>&nbsp;<span class="op" id="4517688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4517693">if</span>&nbsp;<span class="builtinfunc" id="4517696">len</span><span class="op" id="4517699">(</span><span class="ident" id="4517700">e</span><span class="op" id="4517701">.</span><span class="ident" id="4517702">hintCert</span><span class="op" id="4517710">.</span><span class="ident" id="4517711">Subject</span><span class="op" id="4517718">.</span><span class="ident" id="4517719">Organization</span><span class="op" id="4517731">)</span>&nbsp;<span class="op" id="4517733">&gt;</span>&nbsp;<span class="num" id="4517735">0</span>&nbsp;<span class="op" id="4517737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4517743">certName</span>&nbsp;<span class="op" id="4517752">=</span>&nbsp;<span class="ident" id="4517754">e</span><span class="op" id="4517755">.</span><span class="ident" id="4517756">hintCert</span><span class="op" id="4517764">.</span><span class="ident" id="4517765">Subject</span><span class="op" id="4517772">.</span><span class="ident" id="4517773">Organization</span><span class="op" id="4517785">[</span><span class="num" id="4517786">0</span><span class="op" id="4517787">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4517792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4517797">certName</span>&nbsp;<span class="op" id="4517806">=</span>&nbsp;<span class="string" id="4517808">&#34;serial:&#34;</span>&nbsp;<span class="op" id="4517818">+</span>&nbsp;<span class="ident" id="4517820">e</span><span class="op" id="4517821">.</span><span class="ident" id="4517822">hintCert</span><span class="op" id="4517830">.</span><span class="ident" id="4517831">SerialNumber</span><span class="op" id="4517843">.</span><span class="ident" id="4517844">String</span><span class="op" id="4517850">(</span><span class="op" id="4517851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4517855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4517859">s</span>&nbsp;<span class="op" id="4517861">+=</span>&nbsp;<span class="ident" id="4517864">fmt</span><span class="op" id="4517867">.</span><span class="ident" id="4517868">Sprintf</span><span class="op" id="4517875">(</span><span class="string" id="4517876">&#34;&nbsp;(possibly&nbsp;because&nbsp;of&nbsp;%q&nbsp;while&nbsp;trying&nbsp;to&nbsp;verify&nbsp;candidate&nbsp;authority&nbsp;certificate&nbsp;%q)&#34;</span><span class="op" id="4517961">,</span>&nbsp;<span class="ident" id="4517963">e</span><span class="op" id="4517964">.</span><span class="ident" id="4517965">hintErr</span><span class="op" id="4517972">,</span>&nbsp;<span class="ident" id="4517974">certName</span><span class="op" id="4517982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4517985">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4517988">return</span>&nbsp;<span class="ident" id="4517995">s</span><br>
<span class="lineno"></span><span class="op" id="4517997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4518000">//&nbsp;SystemRootsError&nbsp;results&nbsp;when&nbsp;we&nbsp;fail&nbsp;to&nbsp;load&nbsp;the&nbsp;system&nbsp;root&nbsp;certificates.</span><br>
<span class="lineno"></span><span class="keyword" id="4518079">type</span>&nbsp;<span class="ident" id="4518084">SystemRootsError</span>&nbsp;<span class="keyword" id="4518101">struct</span><span class="op" id="4518107">{</span><span class="op" id="4518108">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="4518111">func</span>&nbsp;<span class="op" id="4518116">(</span><span class="ident" id="4518117">SystemRootsError</span><span class="op" id="4518133">)</span>&nbsp;<span class="ident" id="4518135">Error</span><span class="op" id="4518140">(</span><span class="op" id="4518141">)</span>&nbsp;<span class="builtintype" id="4518143">string</span>&nbsp;<span class="op" id="4518150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4518153">return</span>&nbsp;<span class="string" id="4518160">&#34;x509:&nbsp;failed&nbsp;to&nbsp;load&nbsp;system&nbsp;roots&nbsp;and&nbsp;no&nbsp;roots&nbsp;provided&#34;</span><br>
<span class="lineno"></span><span class="op" id="4518218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="4518221">//&nbsp;VerifyOptions&nbsp;contains&nbsp;parameters&nbsp;for&nbsp;Certificate.Verify.&nbsp;It&#39;s&nbsp;a&nbsp;structure</span><br>
<span class="lineno"></span><span class="comment" id="4518299">//&nbsp;because&nbsp;other&nbsp;PKIX&nbsp;verification&nbsp;APIs&nbsp;have&nbsp;ended&nbsp;up&nbsp;needing&nbsp;many&nbsp;options.</span><br>
<span class="lineno"></span><span class="keyword" id="4518375">type</span>&nbsp;<span class="ident" id="4518380">VerifyOptions</span>&nbsp;<span class="keyword" id="4518394">struct</span>&nbsp;<span class="op" id="4518401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4518404">DNSName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4518418">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4518426">Intermediates</span>&nbsp;<span class="op" id="4518440">*</span><span class="ident" id="4518441">CertPool</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4518451">Roots</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4518465">*</span><span class="ident" id="4518466">CertPool</span>&nbsp;<span class="comment" id="4518475">//&nbsp;if&nbsp;nil,&nbsp;the&nbsp;system&nbsp;roots&nbsp;are&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4518513">CurrentTime</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4518527">time</span><span class="op" id="4518531">.</span><span class="ident" id="4518532">Time</span>&nbsp;<span class="comment" id="4518537">//&nbsp;if&nbsp;zero,&nbsp;the&nbsp;current&nbsp;time&nbsp;is&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4518575">//&nbsp;KeyUsage&nbsp;specifies&nbsp;which&nbsp;Extended&nbsp;Key&nbsp;Usage&nbsp;values&nbsp;are&nbsp;acceptable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4518646">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;means&nbsp;ExtKeyUsageServerAuth.&nbsp;Key&nbsp;usage&nbsp;is&nbsp;considered&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4518719">//&nbsp;constraint&nbsp;down&nbsp;the&nbsp;chain&nbsp;which&nbsp;mirrors&nbsp;Windows&nbsp;CryptoAPI&nbsp;behaviour,</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4518792">//&nbsp;but&nbsp;not&nbsp;the&nbsp;spec.&nbsp;To&nbsp;accept&nbsp;any&nbsp;key&nbsp;usage,&nbsp;include&nbsp;ExtKeyUsageAny.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4518863">KeyUsages</span>&nbsp;<span class="op" id="4518873">[</span><span class="op" id="4518874">]</span><span class="ident" id="4518875">ExtKeyUsage</span><br>
<span class="lineno"></span><span class="op" id="4518887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4518890">const</span>&nbsp;<span class="op" id="4518896">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4518899">leafCertificate</span>&nbsp;<span class="op" id="4518915">=</span>&nbsp;<span class="ident" id="4518917">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4518923">intermediateCertificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4518948">rootCertificate</span><br>
<span class="lineno"></span><span class="op" id="4518964">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="4518967">//&nbsp;isValid&nbsp;performs&nbsp;validity&nbsp;checks&nbsp;on&nbsp;the&nbsp;c.</span><br>
<span class="lineno"></span><span class="keyword" id="4519013">func</span>&nbsp;<span class="op" id="4519018">(</span><span class="ident" id="4519019">c</span>&nbsp;<span class="op" id="4519021">*</span><span class="ident" id="4519022">Certificate</span><span class="op" id="4519033">)</span>&nbsp;<span class="ident" id="4519035">isValid</span><span class="op" id="4519042">(</span><span class="ident" id="4519043">certType</span>&nbsp;<span class="builtintype" id="4519052">int</span><span class="op" id="4519055">,</span>&nbsp;<span class="ident" id="4519057">currentChain</span>&nbsp;<span class="op" id="4519070">[</span><span class="op" id="4519071">]</span><span class="op" id="4519072">*</span><span class="ident" id="4519073">Certificate</span><span class="op" id="4519084">,</span>&nbsp;<span class="ident" id="4519086">opts</span>&nbsp;<span class="op" id="4519091">*</span><span class="ident" id="4519092">VerifyOptions</span><span class="op" id="4519105">)</span>&nbsp;<span class="builtintype" id="4519107">error</span>&nbsp;<span class="op" id="4519113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4519116">now</span>&nbsp;<span class="op" id="4519120">:=</span>&nbsp;<span class="ident" id="4519123">opts</span><span class="op" id="4519127">.</span><span class="ident" id="4519128">CurrentTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4519141">if</span>&nbsp;<span class="ident" id="4519144">now</span><span class="op" id="4519147">.</span><span class="ident" id="4519148">IsZero</span><span class="op" id="4519154">(</span><span class="op" id="4519155">)</span>&nbsp;<span class="op" id="4519157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4519161">now</span>&nbsp;<span class="op" id="4519165">=</span>&nbsp;<span class="ident" id="4519167">time</span><span class="op" id="4519171">.</span><span class="ident" id="4519172">Now</span><span class="op" id="4519175">(</span><span class="op" id="4519176">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4519179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4519182">if</span>&nbsp;<span class="ident" id="4519185">now</span><span class="op" id="4519188">.</span><span class="ident" id="4519189">Before</span><span class="op" id="4519195">(</span><span class="ident" id="4519196">c</span><span class="op" id="4519197">.</span><span class="ident" id="4519198">NotBefore</span><span class="op" id="4519207">)</span>&nbsp;<span class="op" id="4519209">||</span>&nbsp;<span class="ident" id="4519212">now</span><span class="op" id="4519215">.</span><span class="ident" id="4519216">After</span><span class="op" id="4519221">(</span><span class="ident" id="4519222">c</span><span class="op" id="4519223">.</span><span class="ident" id="4519224">NotAfter</span><span class="op" id="4519232">)</span>&nbsp;<span class="op" id="4519234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4519238">return</span>&nbsp;<span class="ident" id="4519245">CertificateInvalidError</span><span class="op" id="4519268">{</span><span class="ident" id="4519269">c</span><span class="op" id="4519270">,</span>&nbsp;<span class="ident" id="4519272">Expired</span><span class="op" id="4519279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4519282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4519286">if</span>&nbsp;<span class="builtinfunc" id="4519289">len</span><span class="op" id="4519292">(</span><span class="ident" id="4519293">c</span><span class="op" id="4519294">.</span><span class="ident" id="4519295">PermittedDNSDomains</span><span class="op" id="4519314">)</span>&nbsp;<span class="op" id="4519316">&gt;</span>&nbsp;<span class="num" id="4519318">0</span>&nbsp;<span class="op" id="4519320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4519324">ok</span>&nbsp;<span class="op" id="4519327">:=</span>&nbsp;<span class="builtintype" id="4519330">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4519338">for</span>&nbsp;<span class="ident" id="4519342">_</span><span class="op" id="4519343">,</span>&nbsp;<span class="ident" id="4519345">domain</span>&nbsp;<span class="op" id="4519352">:=</span>&nbsp;<span class="keyword" id="4519355">range</span>&nbsp;<span class="ident" id="4519361">c</span><span class="op" id="4519362">.</span><span class="ident" id="4519363">PermittedDNSDomains</span>&nbsp;<span class="op" id="4519383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4519388">if</span>&nbsp;<span class="ident" id="4519391">opts</span><span class="op" id="4519395">.</span><span class="ident" id="4519396">DNSName</span>&nbsp;<span class="op" id="4519404">==</span>&nbsp;<span class="ident" id="4519407">domain</span>&nbsp;<span class="op" id="4519414">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4519421">(</span><span class="ident" id="4519422">strings</span><span class="op" id="4519429">.</span><span class="ident" id="4519430">HasSuffix</span><span class="op" id="4519439">(</span><span class="ident" id="4519440">opts</span><span class="op" id="4519444">.</span><span class="ident" id="4519445">DNSName</span><span class="op" id="4519452">,</span>&nbsp;<span class="ident" id="4519454">domain</span><span class="op" id="4519460">)</span>&nbsp;<span class="op" id="4519462">&amp;&amp;</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4519470">len</span><span class="op" id="4519473">(</span><span class="ident" id="4519474">opts</span><span class="op" id="4519478">.</span><span class="ident" id="4519479">DNSName</span><span class="op" id="4519486">)</span>&nbsp;<span class="op" id="4519488">&gt;=</span>&nbsp;<span class="num" id="4519491">1</span><span class="op" id="4519492">+</span><span class="builtinfunc" id="4519493">len</span><span class="op" id="4519496">(</span><span class="ident" id="4519497">domain</span><span class="op" id="4519503">)</span>&nbsp;<span class="op" id="4519505">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4519513">opts</span><span class="op" id="4519517">.</span><span class="ident" id="4519518">DNSName</span><span class="op" id="4519525">[</span><span class="builtinfunc" id="4519526">len</span><span class="op" id="4519529">(</span><span class="ident" id="4519530">opts</span><span class="op" id="4519534">.</span><span class="ident" id="4519535">DNSName</span><span class="op" id="4519542">)</span><span class="op" id="4519543">-</span><span class="builtinfunc" id="4519544">len</span><span class="op" id="4519547">(</span><span class="ident" id="4519548">domain</span><span class="op" id="4519554">)</span><span class="op" id="4519555">-</span><span class="num" id="4519556">1</span><span class="op" id="4519557">]</span>&nbsp;<span class="op" id="4519559">==</span>&nbsp;<span class="string" id="4519562">&#39;.&#39;</span><span class="op" id="4519565">)</span>&nbsp;<span class="op" id="4519567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4519573">ok</span>&nbsp;<span class="op" id="4519576">=</span>&nbsp;<span class="builtintype" id="4519578">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4519587">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4519596">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4519600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4519605">if</span>&nbsp;<span class="op" id="4519608">!</span><span class="ident" id="4519609">ok</span>&nbsp;<span class="op" id="4519612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4519617">return</span>&nbsp;<span class="ident" id="4519624">CertificateInvalidError</span><span class="op" id="4519647">{</span><span class="ident" id="4519648">c</span><span class="op" id="4519649">,</span>&nbsp;<span class="ident" id="4519651">CANotAuthorizedForThisName</span><span class="op" id="4519677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4519681">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4519684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4519688">//&nbsp;KeyUsage&nbsp;status&nbsp;flags&nbsp;are&nbsp;ignored.&nbsp;From&nbsp;Engineering&nbsp;Security,&nbsp;Peter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4519760">//&nbsp;Gutmann:&nbsp;A&nbsp;European&nbsp;government&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signing&nbsp;certificates&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4519833">//&nbsp;being&nbsp;valid&nbsp;for&nbsp;encryption&nbsp;only,&nbsp;but&nbsp;no-one&nbsp;noticed.&nbsp;Another</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4519898">//&nbsp;European&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signature&nbsp;keys&nbsp;as&nbsp;not&nbsp;being&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4519963">//&nbsp;signatures.&nbsp;A&nbsp;different&nbsp;CA&nbsp;marked&nbsp;its&nbsp;own&nbsp;trusted&nbsp;root&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4520034">//&nbsp;as&nbsp;being&nbsp;invalid&nbsp;for&nbsp;certificate&nbsp;signing.&nbsp;&nbsp;Another&nbsp;national&nbsp;CA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4520101">//&nbsp;distributed&nbsp;a&nbsp;certificate&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;data&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4520166">//&nbsp;country’s&nbsp;tax&nbsp;authority&nbsp;that&nbsp;was&nbsp;marked&nbsp;as&nbsp;only&nbsp;being&nbsp;usable&nbsp;for</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4520237">//&nbsp;digital&nbsp;signatures&nbsp;but&nbsp;not&nbsp;for&nbsp;encryption.&nbsp;Yet&nbsp;another&nbsp;CA&nbsp;reversed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4520308">//&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bit&nbsp;flags&nbsp;in&nbsp;the&nbsp;keyUsage&nbsp;due&nbsp;to&nbsp;confusion&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4520377">//&nbsp;encoding&nbsp;endianness,&nbsp;essentially&nbsp;setting&nbsp;a&nbsp;random&nbsp;keyUsage&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4520443">//&nbsp;certificates&nbsp;that&nbsp;it&nbsp;issued.&nbsp;Another&nbsp;CA&nbsp;created&nbsp;a&nbsp;self-invalidating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4520515">//&nbsp;certificate&nbsp;by&nbsp;adding&nbsp;a&nbsp;certificate&nbsp;policy&nbsp;statement&nbsp;stipulating</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4520584">//&nbsp;that&nbsp;the&nbsp;certificate&nbsp;had&nbsp;to&nbsp;be&nbsp;used&nbsp;strictly&nbsp;as&nbsp;specified&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4520653">//&nbsp;keyUsage,&nbsp;and&nbsp;a&nbsp;keyUsage&nbsp;containing&nbsp;a&nbsp;flag&nbsp;indicating&nbsp;that&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4520724">//&nbsp;encryption&nbsp;key&nbsp;could&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;Diffie-Hellman&nbsp;key&nbsp;agreement.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4520797">if</span>&nbsp;<span class="ident" id="4520800">certType</span>&nbsp;<span class="op" id="4520809">==</span>&nbsp;<span class="ident" id="4520812">intermediateCertificate</span>&nbsp;<span class="op" id="4520836">&amp;&amp;</span>&nbsp;<span class="op" id="4520839">(</span><span class="op" id="4520840">!</span><span class="ident" id="4520841">c</span><span class="op" id="4520842">.</span><span class="ident" id="4520843">BasicConstraintsValid</span>&nbsp;<span class="op" id="4520865">||</span>&nbsp;<span class="op" id="4520868">!</span><span class="ident" id="4520869">c</span><span class="op" id="4520870">.</span><span class="ident" id="4520871">IsCA</span><span class="op" id="4520875">)</span>&nbsp;<span class="op" id="4520877">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4520881">return</span>&nbsp;<span class="ident" id="4520888">CertificateInvalidError</span><span class="op" id="4520911">{</span><span class="ident" id="4520912">c</span><span class="op" id="4520913">,</span>&nbsp;<span class="ident" id="4520915">NotAuthorizedToSign</span><span class="op" id="4520934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4520937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4520941">if</span>&nbsp;<span class="ident" id="4520944">c</span><span class="op" id="4520945">.</span><span class="ident" id="4520946">BasicConstraintsValid</span>&nbsp;<span class="op" id="4520968">&amp;&amp;</span>&nbsp;<span class="ident" id="4520971">c</span><span class="op" id="4520972">.</span><span class="ident" id="4520973">MaxPathLen</span>&nbsp;<span class="op" id="4520984">&gt;=</span>&nbsp;<span class="num" id="4520987">0</span>&nbsp;<span class="op" id="4520989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4520993">numIntermediates</span>&nbsp;<span class="op" id="4521010">:=</span>&nbsp;<span class="builtinfunc" id="4521013">len</span><span class="op" id="4521016">(</span><span class="ident" id="4521017">currentChain</span><span class="op" id="4521029">)</span>&nbsp;<span class="op" id="4521031">-</span>&nbsp;<span class="num" id="4521033">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4521037">if</span>&nbsp;<span class="ident" id="4521040">numIntermediates</span>&nbsp;<span class="op" id="4521057">&gt;</span>&nbsp;<span class="ident" id="4521059">c</span><span class="op" id="4521060">.</span><span class="ident" id="4521061">MaxPathLen</span>&nbsp;<span class="op" id="4521072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4521077">return</span>&nbsp;<span class="ident" id="4521084">CertificateInvalidError</span><span class="op" id="4521107">{</span><span class="ident" id="4521108">c</span><span class="op" id="4521109">,</span>&nbsp;<span class="ident" id="4521111">TooManyIntermediates</span><span class="op" id="4521131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4521135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4521138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4521142">return</span>&nbsp;<span class="builtintype" id="4521149">nil</span><br>
<span class="lineno"></span><span class="op" id="4521153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4521156">//&nbsp;Verify&nbsp;attempts&nbsp;to&nbsp;verify&nbsp;c&nbsp;by&nbsp;building&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;from&nbsp;c&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4521230">//&nbsp;certificate&nbsp;in&nbsp;opts.Roots,&nbsp;using&nbsp;certificates&nbsp;in&nbsp;opts.Intermediates&nbsp;if</span><br>
<span class="lineno">205</span><span class="comment" id="4521304">//&nbsp;needed.&nbsp;If&nbsp;successful,&nbsp;it&nbsp;returns&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;where&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="4521376">//&nbsp;element&nbsp;of&nbsp;the&nbsp;chain&nbsp;is&nbsp;c&nbsp;and&nbsp;the&nbsp;last&nbsp;element&nbsp;is&nbsp;from&nbsp;opts.Roots.</span><br>
<span class="lineno"></span><span class="comment" id="4521446">//</span><br>
<span class="lineno"></span><span class="comment" id="4521449">//&nbsp;If&nbsp;opts.Roots&nbsp;is&nbsp;nil&nbsp;and&nbsp;system&nbsp;roots&nbsp;are&nbsp;unavailable&nbsp;the&nbsp;returned&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4521525">//&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;SystemRootsError.</span><br>
<span class="lineno">210</span><span class="comment" id="4521562">//</span><br>
<span class="lineno"></span><span class="comment" id="4521565">//&nbsp;WARNING:&nbsp;this&nbsp;doesn&#39;t&nbsp;do&nbsp;any&nbsp;revocation&nbsp;checking.</span><br>
<span class="lineno"></span><span class="keyword" id="4521618">func</span>&nbsp;<span class="op" id="4521623">(</span><span class="ident" id="4521624">c</span>&nbsp;<span class="op" id="4521626">*</span><span class="ident" id="4521627">Certificate</span><span class="op" id="4521638">)</span>&nbsp;<span class="ident" id="4521640">Verify</span><span class="op" id="4521646">(</span><span class="ident" id="4521647">opts</span>&nbsp;<span class="ident" id="4521652">VerifyOptions</span><span class="op" id="4521665">)</span>&nbsp;<span class="op" id="4521667">(</span><span class="ident" id="4521668">chains</span>&nbsp;<span class="op" id="4521675">[</span><span class="op" id="4521676">]</span><span class="op" id="4521677">[</span><span class="op" id="4521678">]</span><span class="op" id="4521679">*</span><span class="ident" id="4521680">Certificate</span><span class="op" id="4521691">,</span>&nbsp;<span class="ident" id="4521693">err</span>&nbsp;<span class="builtintype" id="4521697">error</span><span class="op" id="4521702">)</span>&nbsp;<span class="op" id="4521704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4521707">//&nbsp;Use&nbsp;Windows&#39;s&nbsp;own&nbsp;verification&nbsp;and&nbsp;chain&nbsp;building.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4521762">if</span>&nbsp;<span class="ident" id="4521765">opts</span><span class="op" id="4521769">.</span><span class="ident" id="4521770">Roots</span>&nbsp;<span class="op" id="4521776">==</span>&nbsp;<span class="builtintype" id="4521779">nil</span>&nbsp;<span class="op" id="4521783">&amp;&amp;</span>&nbsp;<span class="ident" id="4521786">runtime</span><span class="op" id="4521793">.</span><span class="ident" id="4521794">GOOS</span>&nbsp;<span class="op" id="4521799">==</span>&nbsp;<span class="string" id="4521802">&#34;windows&#34;</span>&nbsp;<span class="op" id="4521812">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4521816">return</span>&nbsp;<span class="ident" id="4521823">c</span><span class="op" id="4521824">.</span><span class="ident" id="4521825">systemVerify</span><span class="op" id="4521837">(</span><span class="op" id="4521838">&amp;</span><span class="ident" id="4521839">opts</span><span class="op" id="4521843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4521846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4521850">if</span>&nbsp;<span class="ident" id="4521853">opts</span><span class="op" id="4521857">.</span><span class="ident" id="4521858">Roots</span>&nbsp;<span class="op" id="4521864">==</span>&nbsp;<span class="builtintype" id="4521867">nil</span>&nbsp;<span class="op" id="4521871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4521875">opts</span><span class="op" id="4521879">.</span><span class="ident" id="4521880">Roots</span>&nbsp;<span class="op" id="4521886">=</span>&nbsp;<span class="ident" id="4521888">systemRootsPool</span><span class="op" id="4521903">(</span><span class="op" id="4521904">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4521908">if</span>&nbsp;<span class="ident" id="4521911">opts</span><span class="op" id="4521915">.</span><span class="ident" id="4521916">Roots</span>&nbsp;<span class="op" id="4521922">==</span>&nbsp;<span class="builtintype" id="4521925">nil</span>&nbsp;<span class="op" id="4521929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4521934">return</span>&nbsp;<span class="builtintype" id="4521941">nil</span><span class="op" id="4521944">,</span>&nbsp;<span class="ident" id="4521946">SystemRootsError</span><span class="op" id="4521962">{</span><span class="op" id="4521963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4521967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4521970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4521974">err</span>&nbsp;<span class="op" id="4521978">=</span>&nbsp;<span class="ident" id="4521980">c</span><span class="op" id="4521981">.</span><span class="ident" id="4521982">isValid</span><span class="op" id="4521989">(</span><span class="ident" id="4521990">leafCertificate</span><span class="op" id="4522005">,</span>&nbsp;<span class="builtintype" id="4522007">nil</span><span class="op" id="4522010">,</span>&nbsp;<span class="op" id="4522012">&amp;</span><span class="ident" id="4522013">opts</span><span class="op" id="4522017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522020">if</span>&nbsp;<span class="ident" id="4522023">err</span>&nbsp;<span class="op" id="4522027">!=</span>&nbsp;<span class="builtintype" id="4522030">nil</span>&nbsp;<span class="op" id="4522034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522038">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4522046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522050">if</span>&nbsp;<span class="builtinfunc" id="4522053">len</span><span class="op" id="4522056">(</span><span class="ident" id="4522057">opts</span><span class="op" id="4522061">.</span><span class="ident" id="4522062">DNSName</span><span class="op" id="4522069">)</span>&nbsp;<span class="op" id="4522071">&gt;</span>&nbsp;<span class="num" id="4522073">0</span>&nbsp;<span class="op" id="4522075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4522079">err</span>&nbsp;<span class="op" id="4522083">=</span>&nbsp;<span class="ident" id="4522085">c</span><span class="op" id="4522086">.</span><span class="ident" id="4522087">VerifyHostname</span><span class="op" id="4522101">(</span><span class="ident" id="4522102">opts</span><span class="op" id="4522106">.</span><span class="ident" id="4522107">DNSName</span><span class="op" id="4522114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522118">if</span>&nbsp;<span class="ident" id="4522121">err</span>&nbsp;<span class="op" id="4522125">!=</span>&nbsp;<span class="builtintype" id="4522128">nil</span>&nbsp;<span class="op" id="4522132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522137">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4522146">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4522149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4522153">candidateChains</span><span class="op" id="4522168">,</span>&nbsp;<span class="ident" id="4522170">err</span>&nbsp;<span class="op" id="4522174">:=</span>&nbsp;<span class="ident" id="4522177">c</span><span class="op" id="4522178">.</span><span class="ident" id="4522179">buildChains</span><span class="op" id="4522190">(</span><span class="builtinfunc" id="4522191">make</span><span class="op" id="4522195">(</span><span class="keyword" id="4522196">map</span><span class="op" id="4522199">[</span><span class="builtintype" id="4522200">int</span><span class="op" id="4522203">]</span><span class="op" id="4522204">[</span><span class="op" id="4522205">]</span><span class="op" id="4522206">[</span><span class="op" id="4522207">]</span><span class="op" id="4522208">*</span><span class="ident" id="4522209">Certificate</span><span class="op" id="4522220">)</span><span class="op" id="4522221">,</span>&nbsp;<span class="op" id="4522223">[</span><span class="op" id="4522224">]</span><span class="op" id="4522225">*</span><span class="ident" id="4522226">Certificate</span><span class="op" id="4522237">{</span><span class="ident" id="4522238">c</span><span class="op" id="4522239">}</span><span class="op" id="4522240">,</span>&nbsp;<span class="op" id="4522242">&amp;</span><span class="ident" id="4522243">opts</span><span class="op" id="4522247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522250">if</span>&nbsp;<span class="ident" id="4522253">err</span>&nbsp;<span class="op" id="4522257">!=</span>&nbsp;<span class="builtintype" id="4522260">nil</span>&nbsp;<span class="op" id="4522264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522268">return</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4522276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4522280">keyUsages</span>&nbsp;<span class="op" id="4522290">:=</span>&nbsp;<span class="ident" id="4522293">opts</span><span class="op" id="4522297">.</span><span class="ident" id="4522298">KeyUsages</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522309">if</span>&nbsp;<span class="builtinfunc" id="4522312">len</span><span class="op" id="4522315">(</span><span class="ident" id="4522316">keyUsages</span><span class="op" id="4522325">)</span>&nbsp;<span class="op" id="4522327">==</span>&nbsp;<span class="num" id="4522330">0</span>&nbsp;<span class="op" id="4522332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4522336">keyUsages</span>&nbsp;<span class="op" id="4522346">=</span>&nbsp;<span class="op" id="4522348">[</span><span class="op" id="4522349">]</span><span class="ident" id="4522350">ExtKeyUsage</span><span class="op" id="4522361">{</span><span class="ident" id="4522362">ExtKeyUsageServerAuth</span><span class="op" id="4522383">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4522386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4522390">//&nbsp;If&nbsp;any&nbsp;key&nbsp;usage&nbsp;is&nbsp;acceptable&nbsp;then&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522442">for</span>&nbsp;<span class="ident" id="4522446">_</span><span class="op" id="4522447">,</span>&nbsp;<span class="ident" id="4522449">usage</span>&nbsp;<span class="op" id="4522455">:=</span>&nbsp;<span class="keyword" id="4522458">range</span>&nbsp;<span class="ident" id="4522464">keyUsages</span>&nbsp;<span class="op" id="4522474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522478">if</span>&nbsp;<span class="ident" id="4522481">usage</span>&nbsp;<span class="op" id="4522487">==</span>&nbsp;<span class="ident" id="4522490">ExtKeyUsageAny</span>&nbsp;<span class="op" id="4522505">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4522510">chains</span>&nbsp;<span class="op" id="4522517">=</span>&nbsp;<span class="ident" id="4522519">candidateChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522538">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4522547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4522550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522554">for</span>&nbsp;<span class="ident" id="4522558">_</span><span class="op" id="4522559">,</span>&nbsp;<span class="ident" id="4522561">candidate</span>&nbsp;<span class="op" id="4522571">:=</span>&nbsp;<span class="keyword" id="4522574">range</span>&nbsp;<span class="ident" id="4522580">candidateChains</span>&nbsp;<span class="op" id="4522596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522600">if</span>&nbsp;<span class="ident" id="4522603">checkChainForKeyUsage</span><span class="op" id="4522624">(</span><span class="ident" id="4522625">candidate</span><span class="op" id="4522634">,</span>&nbsp;<span class="ident" id="4522636">keyUsages</span><span class="op" id="4522645">)</span>&nbsp;<span class="op" id="4522647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4522652">chains</span>&nbsp;<span class="op" id="4522659">=</span>&nbsp;<span class="builtinfunc" id="4522661">append</span><span class="op" id="4522667">(</span><span class="ident" id="4522668">chains</span><span class="op" id="4522674">,</span>&nbsp;<span class="ident" id="4522676">candidate</span><span class="op" id="4522685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4522689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4522692">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522696">if</span>&nbsp;<span class="builtinfunc" id="4522699">len</span><span class="op" id="4522702">(</span><span class="ident" id="4522703">chains</span><span class="op" id="4522709">)</span>&nbsp;<span class="op" id="4522711">==</span>&nbsp;<span class="num" id="4522714">0</span>&nbsp;<span class="op" id="4522716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4522720">err</span>&nbsp;<span class="op" id="4522724">=</span>&nbsp;<span class="ident" id="4522726">CertificateInvalidError</span><span class="op" id="4522749">{</span><span class="ident" id="4522750">c</span><span class="op" id="4522751">,</span>&nbsp;<span class="ident" id="4522753">IncompatibleUsage</span><span class="op" id="4522770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4522773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522777">return</span><br>
<span class="lineno"></span><span class="op" id="4522784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4522787">func</span>&nbsp;<span class="ident" id="4522792">appendToFreshChain</span><span class="op" id="4522810">(</span><span class="ident" id="4522811">chain</span>&nbsp;<span class="op" id="4522817">[</span><span class="op" id="4522818">]</span><span class="op" id="4522819">*</span><span class="ident" id="4522820">Certificate</span><span class="op" id="4522831">,</span>&nbsp;<span class="ident" id="4522833">cert</span>&nbsp;<span class="op" id="4522838">*</span><span class="ident" id="4522839">Certificate</span><span class="op" id="4522850">)</span>&nbsp;<span class="op" id="4522852">[</span><span class="op" id="4522853">]</span><span class="op" id="4522854">*</span><span class="ident" id="4522855">Certificate</span>&nbsp;<span class="op" id="4522867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4522870">n</span>&nbsp;<span class="op" id="4522872">:=</span>&nbsp;<span class="builtinfunc" id="4522875">make</span><span class="op" id="4522879">(</span><span class="op" id="4522880">[</span><span class="op" id="4522881">]</span><span class="op" id="4522882">*</span><span class="ident" id="4522883">Certificate</span><span class="op" id="4522894">,</span>&nbsp;<span class="builtinfunc" id="4522896">len</span><span class="op" id="4522899">(</span><span class="ident" id="4522900">chain</span><span class="op" id="4522905">)</span><span class="op" id="4522906">+</span><span class="num" id="4522907">1</span><span class="op" id="4522908">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4522911">copy</span><span class="op" id="4522915">(</span><span class="ident" id="4522916">n</span><span class="op" id="4522917">,</span>&nbsp;<span class="ident" id="4522919">chain</span><span class="op" id="4522924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4522927">n</span><span class="op" id="4522928">[</span><span class="builtinfunc" id="4522929">len</span><span class="op" id="4522932">(</span><span class="ident" id="4522933">chain</span><span class="op" id="4522938">)</span><span class="op" id="4522939">]</span>&nbsp;<span class="op" id="4522941">=</span>&nbsp;<span class="ident" id="4522943">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4522949">return</span>&nbsp;<span class="ident" id="4522956">n</span><br>
<span class="lineno"></span><span class="op" id="4522958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="4522961">func</span>&nbsp;<span class="op" id="4522966">(</span><span class="ident" id="4522967">c</span>&nbsp;<span class="op" id="4522969">*</span><span class="ident" id="4522970">Certificate</span><span class="op" id="4522981">)</span>&nbsp;<span class="ident" id="4522983">buildChains</span><span class="op" id="4522994">(</span><span class="ident" id="4522995">cache</span>&nbsp;<span class="keyword" id="4523001">map</span><span class="op" id="4523004">[</span><span class="builtintype" id="4523005">int</span><span class="op" id="4523008">]</span><span class="op" id="4523009">[</span><span class="op" id="4523010">]</span><span class="op" id="4523011">[</span><span class="op" id="4523012">]</span><span class="op" id="4523013">*</span><span class="ident" id="4523014">Certificate</span><span class="op" id="4523025">,</span>&nbsp;<span class="ident" id="4523027">currentChain</span>&nbsp;<span class="op" id="4523040">[</span><span class="op" id="4523041">]</span><span class="op" id="4523042">*</span><span class="ident" id="4523043">Certificate</span><span class="op" id="4523054">,</span>&nbsp;<span class="ident" id="4523056">opts</span>&nbsp;<span class="op" id="4523061">*</span><span class="ident" id="4523062">VerifyOptions</span><span class="op" id="4523075">)</span>&nbsp;<span class="op" id="4523077">(</span><span class="ident" id="4523078">chains</span>&nbsp;<span class="op" id="4523085">[</span><span class="op" id="4523086">]</span><span class="op" id="4523087">[</span><span class="op" id="4523088">]</span><span class="op" id="4523089">*</span><span class="ident" id="4523090">Certificate</span><span class="op" id="4523101">,</span>&nbsp;<span class="ident" id="4523103">err</span>&nbsp;<span class="builtintype" id="4523107">error</span><span class="op" id="4523112">)</span>&nbsp;<span class="op" id="4523114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4523117">possibleRoots</span><span class="op" id="4523130">,</span>&nbsp;<span class="ident" id="4523132">failedRoot</span><span class="op" id="4523142">,</span>&nbsp;<span class="ident" id="4523144">rootErr</span>&nbsp;<span class="op" id="4523152">:=</span>&nbsp;<span class="ident" id="4523155">opts</span><span class="op" id="4523159">.</span><span class="ident" id="4523160">Roots</span><span class="op" id="4523165">.</span><span class="ident" id="4523166">findVerifiedParents</span><span class="op" id="4523185">(</span><span class="ident" id="4523186">c</span><span class="op" id="4523187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4523190">for</span>&nbsp;<span class="ident" id="4523194">_</span><span class="op" id="4523195">,</span>&nbsp;<span class="ident" id="4523197">rootNum</span>&nbsp;<span class="op" id="4523205">:=</span>&nbsp;<span class="keyword" id="4523208">range</span>&nbsp;<span class="ident" id="4523214">possibleRoots</span>&nbsp;<span class="op" id="4523228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4523232">root</span>&nbsp;<span class="op" id="4523237">:=</span>&nbsp;<span class="ident" id="4523240">opts</span><span class="op" id="4523244">.</span><span class="ident" id="4523245">Roots</span><span class="op" id="4523250">.</span><span class="ident" id="4523251">certs</span><span class="op" id="4523256">[</span><span class="ident" id="4523257">rootNum</span><span class="op" id="4523264">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4523268">err</span>&nbsp;<span class="op" id="4523272">=</span>&nbsp;<span class="ident" id="4523274">root</span><span class="op" id="4523278">.</span><span class="ident" id="4523279">isValid</span><span class="op" id="4523286">(</span><span class="ident" id="4523287">rootCertificate</span><span class="op" id="4523302">,</span>&nbsp;<span class="ident" id="4523304">currentChain</span><span class="op" id="4523316">,</span>&nbsp;<span class="ident" id="4523318">opts</span><span class="op" id="4523322">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4523326">if</span>&nbsp;<span class="ident" id="4523329">err</span>&nbsp;<span class="op" id="4523333">!=</span>&nbsp;<span class="builtintype" id="4523336">nil</span>&nbsp;<span class="op" id="4523340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4523345">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4523356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4523360">chains</span>&nbsp;<span class="op" id="4523367">=</span>&nbsp;<span class="builtinfunc" id="4523369">append</span><span class="op" id="4523375">(</span><span class="ident" id="4523376">chains</span><span class="op" id="4523382">,</span>&nbsp;<span class="ident" id="4523384">appendToFreshChain</span><span class="op" id="4523402">(</span><span class="ident" id="4523403">currentChain</span><span class="op" id="4523415">,</span>&nbsp;<span class="ident" id="4523417">root</span><span class="op" id="4523421">)</span><span class="op" id="4523422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4523425">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4523429">possibleIntermediates</span><span class="op" id="4523450">,</span>&nbsp;<span class="ident" id="4523452">failedIntermediate</span><span class="op" id="4523470">,</span>&nbsp;<span class="ident" id="4523472">intermediateErr</span>&nbsp;<span class="op" id="4523488">:=</span>&nbsp;<span class="ident" id="4523491">opts</span><span class="op" id="4523495">.</span><span class="ident" id="4523496">Intermediates</span><span class="op" id="4523509">.</span><span class="ident" id="4523510">findVerifiedParents</span><span class="op" id="4523529">(</span><span class="ident" id="4523530">c</span><span class="op" id="4523531">)</span><br>
<span class="lineno"></span><span class="ident" id="4523533">nextIntermediate</span><span class="op" id="4523549">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4523552">for</span>&nbsp;<span class="ident" id="4523556">_</span><span class="op" id="4523557">,</span>&nbsp;<span class="ident" id="4523559">intermediateNum</span>&nbsp;<span class="op" id="4523575">:=</span>&nbsp;<span class="keyword" id="4523578">range</span>&nbsp;<span class="ident" id="4523584">possibleIntermediates</span>&nbsp;<span class="op" id="4523606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4523610">intermediate</span>&nbsp;<span class="op" id="4523623">:=</span>&nbsp;<span class="ident" id="4523626">opts</span><span class="op" id="4523630">.</span><span class="ident" id="4523631">Intermediates</span><span class="op" id="4523644">.</span><span class="ident" id="4523645">certs</span><span class="op" id="4523650">[</span><span class="ident" id="4523651">intermediateNum</span><span class="op" id="4523666">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4523670">for</span>&nbsp;<span class="ident" id="4523674">_</span><span class="op" id="4523675">,</span>&nbsp;<span class="ident" id="4523677">cert</span>&nbsp;<span class="op" id="4523682">:=</span>&nbsp;<span class="keyword" id="4523685">range</span>&nbsp;<span class="ident" id="4523691">currentChain</span>&nbsp;<span class="op" id="4523704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4523709">if</span>&nbsp;<span class="ident" id="4523712">cert</span>&nbsp;<span class="op" id="4523717">==</span>&nbsp;<span class="ident" id="4523720">intermediate</span>&nbsp;<span class="op" id="4523733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4523739">continue</span>&nbsp;<span class="ident" id="4523748">nextIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4523768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4523772">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4523776">err</span>&nbsp;<span class="op" id="4523780">=</span>&nbsp;<span class="ident" id="4523782">intermediate</span><span class="op" id="4523794">.</span><span class="ident" id="4523795">isValid</span><span class="op" id="4523802">(</span><span class="ident" id="4523803">intermediateCertificate</span><span class="op" id="4523826">,</span>&nbsp;<span class="ident" id="4523828">currentChain</span><span class="op" id="4523840">,</span>&nbsp;<span class="ident" id="4523842">opts</span><span class="op" id="4523846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4523850">if</span>&nbsp;<span class="ident" id="4523853">err</span>&nbsp;<span class="op" id="4523857">!=</span>&nbsp;<span class="builtintype" id="4523860">nil</span>&nbsp;<span class="op" id="4523864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4523869">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4523880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4523884">var</span>&nbsp;<span class="ident" id="4523888">childChains</span>&nbsp;<span class="op" id="4523900">[</span><span class="op" id="4523901">]</span><span class="op" id="4523902">[</span><span class="op" id="4523903">]</span><span class="op" id="4523904">*</span><span class="ident" id="4523905">Certificate</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4523919">childChains</span><span class="op" id="4523930">,</span>&nbsp;<span class="ident" id="4523932">ok</span>&nbsp;<span class="op" id="4523935">:=</span>&nbsp;<span class="ident" id="4523938">cache</span><span class="op" id="4523943">[</span><span class="ident" id="4523944">intermediateNum</span><span class="op" id="4523959">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4523963">if</span>&nbsp;<span class="op" id="4523966">!</span><span class="ident" id="4523967">ok</span>&nbsp;<span class="op" id="4523970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4523975">childChains</span><span class="op" id="4523986">,</span>&nbsp;<span class="ident" id="4523988">err</span>&nbsp;<span class="op" id="4523992">=</span>&nbsp;<span class="ident" id="4523994">intermediate</span><span class="op" id="4524006">.</span><span class="ident" id="4524007">buildChains</span><span class="op" id="4524018">(</span><span class="ident" id="4524019">cache</span><span class="op" id="4524024">,</span>&nbsp;<span class="ident" id="4524026">appendToFreshChain</span><span class="op" id="4524044">(</span><span class="ident" id="4524045">currentChain</span><span class="op" id="4524057">,</span>&nbsp;<span class="ident" id="4524059">intermediate</span><span class="op" id="4524071">)</span><span class="op" id="4524072">,</span>&nbsp;<span class="ident" id="4524074">opts</span><span class="op" id="4524078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4524083">cache</span><span class="op" id="4524088">[</span><span class="ident" id="4524089">intermediateNum</span><span class="op" id="4524104">]</span>&nbsp;<span class="op" id="4524106">=</span>&nbsp;<span class="ident" id="4524108">childChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4524122">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4524126">chains</span>&nbsp;<span class="op" id="4524133">=</span>&nbsp;<span class="builtinfunc" id="4524135">append</span><span class="op" id="4524141">(</span><span class="ident" id="4524142">chains</span><span class="op" id="4524148">,</span>&nbsp;<span class="ident" id="4524150">childChains</span><span class="op" id="4524161">...</span><span class="op" id="4524164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4524167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524171">if</span>&nbsp;<span class="builtinfunc" id="4524174">len</span><span class="op" id="4524177">(</span><span class="ident" id="4524178">chains</span><span class="op" id="4524184">)</span>&nbsp;<span class="op" id="4524186">&gt;</span>&nbsp;<span class="num" id="4524188">0</span>&nbsp;<span class="op" id="4524190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4524194">err</span>&nbsp;<span class="op" id="4524198">=</span>&nbsp;<span class="builtintype" id="4524200">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4524205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524209">if</span>&nbsp;<span class="builtinfunc" id="4524212">len</span><span class="op" id="4524215">(</span><span class="ident" id="4524216">chains</span><span class="op" id="4524222">)</span>&nbsp;<span class="op" id="4524224">==</span>&nbsp;<span class="num" id="4524227">0</span>&nbsp;<span class="op" id="4524229">&amp;&amp;</span>&nbsp;<span class="ident" id="4524232">err</span>&nbsp;<span class="op" id="4524236">==</span>&nbsp;<span class="builtintype" id="4524239">nil</span>&nbsp;<span class="op" id="4524243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4524247">hintErr</span>&nbsp;<span class="op" id="4524255">:=</span>&nbsp;<span class="ident" id="4524258">rootErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4524268">hintCert</span>&nbsp;<span class="op" id="4524277">:=</span>&nbsp;<span class="ident" id="4524280">failedRoot</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524293">if</span>&nbsp;<span class="ident" id="4524296">hintErr</span>&nbsp;<span class="op" id="4524304">==</span>&nbsp;<span class="builtintype" id="4524307">nil</span>&nbsp;<span class="op" id="4524311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4524316">hintErr</span>&nbsp;<span class="op" id="4524324">=</span>&nbsp;<span class="ident" id="4524326">intermediateErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4524345">hintCert</span>&nbsp;<span class="op" id="4524354">=</span>&nbsp;<span class="ident" id="4524356">failedIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4524377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4524381">err</span>&nbsp;<span class="op" id="4524385">=</span>&nbsp;<span class="ident" id="4524387">UnknownAuthorityError</span><span class="op" id="4524408">{</span><span class="ident" id="4524409">c</span><span class="op" id="4524410">,</span>&nbsp;<span class="ident" id="4524412">hintErr</span><span class="op" id="4524419">,</span>&nbsp;<span class="ident" id="4524421">hintCert</span><span class="op" id="4524429">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4524432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524436">return</span><br>
<span class="lineno"></span><span class="op" id="4524443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="keyword" id="4524446">func</span>&nbsp;<span class="ident" id="4524451">matchHostnames</span><span class="op" id="4524465">(</span><span class="ident" id="4524466">pattern</span><span class="op" id="4524473">,</span>&nbsp;<span class="ident" id="4524475">host</span>&nbsp;<span class="builtintype" id="4524480">string</span><span class="op" id="4524486">)</span>&nbsp;<span class="builtintype" id="4524488">bool</span>&nbsp;<span class="op" id="4524493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524496">if</span>&nbsp;<span class="builtinfunc" id="4524499">len</span><span class="op" id="4524502">(</span><span class="ident" id="4524503">pattern</span><span class="op" id="4524510">)</span>&nbsp;<span class="op" id="4524512">==</span>&nbsp;<span class="num" id="4524515">0</span>&nbsp;<span class="op" id="4524517">||</span>&nbsp;<span class="builtinfunc" id="4524520">len</span><span class="op" id="4524523">(</span><span class="ident" id="4524524">host</span><span class="op" id="4524528">)</span>&nbsp;<span class="op" id="4524530">==</span>&nbsp;<span class="num" id="4524533">0</span>&nbsp;<span class="op" id="4524535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524539">return</span>&nbsp;<span class="builtintype" id="4524546">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4524553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4524557">patternParts</span>&nbsp;<span class="op" id="4524570">:=</span>&nbsp;<span class="ident" id="4524573">strings</span><span class="op" id="4524580">.</span><span class="ident" id="4524581">Split</span><span class="op" id="4524586">(</span><span class="ident" id="4524587">pattern</span><span class="op" id="4524594">,</span>&nbsp;<span class="string" id="4524596">&#34;.&#34;</span><span class="op" id="4524599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4524602">hostParts</span>&nbsp;<span class="op" id="4524612">:=</span>&nbsp;<span class="ident" id="4524615">strings</span><span class="op" id="4524622">.</span><span class="ident" id="4524623">Split</span><span class="op" id="4524628">(</span><span class="ident" id="4524629">host</span><span class="op" id="4524633">,</span>&nbsp;<span class="string" id="4524635">&#34;.&#34;</span><span class="op" id="4524638">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524642">if</span>&nbsp;<span class="builtinfunc" id="4524645">len</span><span class="op" id="4524648">(</span><span class="ident" id="4524649">patternParts</span><span class="op" id="4524661">)</span>&nbsp;<span class="op" id="4524663">!=</span>&nbsp;<span class="builtinfunc" id="4524666">len</span><span class="op" id="4524669">(</span><span class="ident" id="4524670">hostParts</span><span class="op" id="4524679">)</span>&nbsp;<span class="op" id="4524681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524685">return</span>&nbsp;<span class="builtintype" id="4524692">false</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4524699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524703">for</span>&nbsp;<span class="ident" id="4524707">i</span><span class="op" id="4524708">,</span>&nbsp;<span class="ident" id="4524710">patternPart</span>&nbsp;<span class="op" id="4524722">:=</span>&nbsp;<span class="keyword" id="4524725">range</span>&nbsp;<span class="ident" id="4524731">patternParts</span>&nbsp;<span class="op" id="4524744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524748">if</span>&nbsp;<span class="ident" id="4524751">patternPart</span>&nbsp;<span class="op" id="4524763">==</span>&nbsp;<span class="string" id="4524766">&#34;*&#34;</span>&nbsp;<span class="op" id="4524770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524775">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4524786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524790">if</span>&nbsp;<span class="ident" id="4524793">patternPart</span>&nbsp;<span class="op" id="4524805">!=</span>&nbsp;<span class="ident" id="4524808">hostParts</span><span class="op" id="4524817">[</span><span class="ident" id="4524818">i</span><span class="op" id="4524819">]</span>&nbsp;<span class="op" id="4524821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524826">return</span>&nbsp;<span class="builtintype" id="4524833">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4524841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4524844">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4524848">return</span>&nbsp;<span class="builtintype" id="4524855">true</span><br>
<span class="lineno"></span><span class="op" id="4524860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4524863">//&nbsp;toLowerCaseASCII&nbsp;returns&nbsp;a&nbsp;lower-case&nbsp;version&nbsp;of&nbsp;in.&nbsp;See&nbsp;RFC&nbsp;6125&nbsp;6.4.1.&nbsp;We&nbsp;use</span><br>
<span class="lineno">350</span><span class="comment" id="4524946">//&nbsp;an&nbsp;explicitly&nbsp;ASCII&nbsp;function&nbsp;to&nbsp;avoid&nbsp;any&nbsp;sharp&nbsp;corners&nbsp;resulting&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4525020">//&nbsp;performing&nbsp;Unicode&nbsp;operations&nbsp;on&nbsp;DNS&nbsp;labels.</span><br>
<span class="lineno"></span><span class="keyword" id="4525068">func</span>&nbsp;<span class="ident" id="4525073">toLowerCaseASCII</span><span class="op" id="4525089">(</span><span class="ident" id="4525090">in</span>&nbsp;<span class="builtintype" id="4525093">string</span><span class="op" id="4525099">)</span>&nbsp;<span class="builtintype" id="4525101">string</span>&nbsp;<span class="op" id="4525108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4525111">//&nbsp;If&nbsp;the&nbsp;string&nbsp;is&nbsp;already&nbsp;lower-case&nbsp;then&nbsp;there&#39;s&nbsp;nothing&nbsp;to&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4525179">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4525198">:=</span>&nbsp;<span class="builtintype" id="4525201">true</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4525207">for</span>&nbsp;<span class="ident" id="4525211">_</span><span class="op" id="4525212">,</span>&nbsp;<span class="ident" id="4525214">c</span>&nbsp;<span class="op" id="4525216">:=</span>&nbsp;<span class="keyword" id="4525219">range</span>&nbsp;<span class="ident" id="4525225">in</span>&nbsp;<span class="op" id="4525228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4525232">if</span>&nbsp;<span class="ident" id="4525235">c</span>&nbsp;<span class="op" id="4525237">==</span>&nbsp;<span class="ident" id="4525240">utf8</span><span class="op" id="4525244">.</span><span class="ident" id="4525245">RuneError</span>&nbsp;<span class="op" id="4525255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4525260">//&nbsp;If&nbsp;we&nbsp;get&nbsp;a&nbsp;UTF-8&nbsp;error&nbsp;then&nbsp;there&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4525310">//&nbsp;upper-case&nbsp;ASCII&nbsp;bytes&nbsp;in&nbsp;the&nbsp;invalid&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4525364">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4525383">=</span>&nbsp;<span class="builtintype" id="4525385">false</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4525394">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4525402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4525406">if</span>&nbsp;<span class="string" id="4525409">&#39;A&#39;</span>&nbsp;<span class="op" id="4525413">&lt;=</span>&nbsp;<span class="ident" id="4525416">c</span>&nbsp;<span class="op" id="4525418">&amp;&amp;</span>&nbsp;<span class="ident" id="4525421">c</span>&nbsp;<span class="op" id="4525423">&lt;=</span>&nbsp;<span class="string" id="4525426">&#39;Z&#39;</span>&nbsp;<span class="op" id="4525430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4525435">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4525454">=</span>&nbsp;<span class="builtintype" id="4525456">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4525465">break</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4525473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4525476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4525480">if</span>&nbsp;<span class="ident" id="4525483">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4525502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4525506">return</span>&nbsp;<span class="ident" id="4525513">in</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4525517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4525521">out</span>&nbsp;<span class="op" id="4525525">:=</span>&nbsp;<span class="op" id="4525528">[</span><span class="op" id="4525529">]</span><span class="builtintype" id="4525530">byte</span><span class="op" id="4525534">(</span><span class="ident" id="4525535">in</span><span class="op" id="4525537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4525540">for</span>&nbsp;<span class="ident" id="4525544">i</span><span class="op" id="4525545">,</span>&nbsp;<span class="ident" id="4525547">c</span>&nbsp;<span class="op" id="4525549">:=</span>&nbsp;<span class="keyword" id="4525552">range</span>&nbsp;<span class="ident" id="4525558">out</span>&nbsp;<span class="op" id="4525562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4525566">if</span>&nbsp;<span class="string" id="4525569">&#39;A&#39;</span>&nbsp;<span class="op" id="4525573">&lt;=</span>&nbsp;<span class="ident" id="4525576">c</span>&nbsp;<span class="op" id="4525578">&amp;&amp;</span>&nbsp;<span class="ident" id="4525581">c</span>&nbsp;<span class="op" id="4525583">&lt;=</span>&nbsp;<span class="string" id="4525586">&#39;Z&#39;</span>&nbsp;<span class="op" id="4525590">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4525595">out</span><span class="op" id="4525598">[</span><span class="ident" id="4525599">i</span><span class="op" id="4525600">]</span>&nbsp;<span class="op" id="4525602">+=</span>&nbsp;<span class="string" id="4525605">&#39;a&#39;</span>&nbsp;<span class="op" id="4525609">-</span>&nbsp;<span class="string" id="4525611">&#39;A&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4525617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4525620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4525623">return</span>&nbsp;<span class="builtintype" id="4525630">string</span><span class="op" id="4525636">(</span><span class="ident" id="4525637">out</span><span class="op" id="4525640">)</span><br>
<span class="lineno"></span><span class="op" id="4525642">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="4525645">//&nbsp;VerifyHostname&nbsp;returns&nbsp;nil&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;valid&nbsp;certificate&nbsp;for&nbsp;the&nbsp;named&nbsp;host.</span><br>
<span class="lineno"></span><span class="comment" id="4525723">//&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error&nbsp;describing&nbsp;the&nbsp;mismatch.</span><br>
<span class="lineno"></span><span class="keyword" id="4525781">func</span>&nbsp;<span class="op" id="4525786">(</span><span class="ident" id="4525787">c</span>&nbsp;<span class="op" id="4525789">*</span><span class="ident" id="4525790">Certificate</span><span class="op" id="4525801">)</span>&nbsp;<span class="ident" id="4525803">VerifyHostname</span><span class="op" id="4525817">(</span><span class="ident" id="4525818">h</span>&nbsp;<span class="builtintype" id="4525820">string</span><span class="op" id="4525826">)</span>&nbsp;<span class="builtintype" id="4525828">error</span>&nbsp;<span class="op" id="4525834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4525837">//&nbsp;IP&nbsp;addresses&nbsp;may&nbsp;be&nbsp;written&nbsp;in&nbsp;[&nbsp;].</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4525877">candidateIP</span>&nbsp;<span class="op" id="4525889">:=</span>&nbsp;<span class="ident" id="4525892">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4525895">if</span>&nbsp;<span class="builtinfunc" id="4525898">len</span><span class="op" id="4525901">(</span><span class="ident" id="4525902">h</span><span class="op" id="4525903">)</span>&nbsp;<span class="op" id="4525905">&gt;=</span>&nbsp;<span class="num" id="4525908">3</span>&nbsp;<span class="op" id="4525910">&amp;&amp;</span>&nbsp;<span class="ident" id="4525913">h</span><span class="op" id="4525914">[</span><span class="num" id="4525915">0</span><span class="op" id="4525916">]</span>&nbsp;<span class="op" id="4525918">==</span>&nbsp;<span class="string" id="4525921">&#39;[&#39;</span>&nbsp;<span class="op" id="4525925">&amp;&amp;</span>&nbsp;<span class="ident" id="4525928">h</span><span class="op" id="4525929">[</span><span class="builtinfunc" id="4525930">len</span><span class="op" id="4525933">(</span><span class="ident" id="4525934">h</span><span class="op" id="4525935">)</span><span class="op" id="4525936">-</span><span class="num" id="4525937">1</span><span class="op" id="4525938">]</span>&nbsp;<span class="op" id="4525940">==</span>&nbsp;<span class="string" id="4525943">&#39;]&#39;</span>&nbsp;<span class="op" id="4525947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4525951">candidateIP</span>&nbsp;<span class="op" id="4525963">=</span>&nbsp;<span class="ident" id="4525965">h</span><span class="op" id="4525966">[</span><span class="num" id="4525967">1</span>&nbsp;<span class="op" id="4525969">:</span>&nbsp;<span class="builtinfunc" id="4525971">len</span><span class="op" id="4525974">(</span><span class="ident" id="4525975">h</span><span class="op" id="4525976">)</span><span class="op" id="4525977">-</span><span class="num" id="4525978">1</span><span class="op" id="4525979">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4525982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4525985">if</span>&nbsp;<span class="ident" id="4525988">ip</span>&nbsp;<span class="op" id="4525991">:=</span>&nbsp;<span class="ident" id="4525994">net</span><span class="op" id="4525997">.</span><span class="ident" id="4525998">ParseIP</span><span class="op" id="4526005">(</span><span class="ident" id="4526006">candidateIP</span><span class="op" id="4526017">)</span><span class="op" id="4526018">;</span>&nbsp;<span class="ident" id="4526020">ip</span>&nbsp;<span class="op" id="4526023">!=</span>&nbsp;<span class="builtintype" id="4526026">nil</span>&nbsp;<span class="op" id="4526030">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4526034">//&nbsp;We&nbsp;only&nbsp;match&nbsp;IP&nbsp;addresses&nbsp;against&nbsp;IP&nbsp;SANs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4526083">//&nbsp;https://tools.ietf.org/html/rfc6125#appendix-B.2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4526137">for</span>&nbsp;<span class="ident" id="4526141">_</span><span class="op" id="4526142">,</span>&nbsp;<span class="ident" id="4526144">candidate</span>&nbsp;<span class="op" id="4526154">:=</span>&nbsp;<span class="keyword" id="4526157">range</span>&nbsp;<span class="ident" id="4526163">c</span><span class="op" id="4526164">.</span><span class="ident" id="4526165">IPAddresses</span>&nbsp;<span class="op" id="4526177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4526182">if</span>&nbsp;<span class="ident" id="4526185">ip</span><span class="op" id="4526187">.</span><span class="ident" id="4526188">Equal</span><span class="op" id="4526193">(</span><span class="ident" id="4526194">candidate</span><span class="op" id="4526203">)</span>&nbsp;<span class="op" id="4526205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4526211">return</span>&nbsp;<span class="builtintype" id="4526218">nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4526225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4526229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4526233">return</span>&nbsp;<span class="ident" id="4526240">HostnameError</span><span class="op" id="4526253">{</span><span class="ident" id="4526254">c</span><span class="op" id="4526255">,</span>&nbsp;<span class="ident" id="4526257">candidateIP</span><span class="op" id="4526268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4526271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4526275">lowered</span>&nbsp;<span class="op" id="4526283">:=</span>&nbsp;<span class="ident" id="4526286">toLowerCaseASCII</span><span class="op" id="4526302">(</span><span class="ident" id="4526303">h</span><span class="op" id="4526304">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4526308">if</span>&nbsp;<span class="builtinfunc" id="4526311">len</span><span class="op" id="4526314">(</span><span class="ident" id="4526315">c</span><span class="op" id="4526316">.</span><span class="ident" id="4526317">DNSNames</span><span class="op" id="4526325">)</span>&nbsp;<span class="op" id="4526327">&gt;</span>&nbsp;<span class="num" id="4526329">0</span>&nbsp;<span class="op" id="4526331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4526335">for</span>&nbsp;<span class="ident" id="4526339">_</span><span class="op" id="4526340">,</span>&nbsp;<span class="ident" id="4526342">match</span>&nbsp;<span class="op" id="4526348">:=</span>&nbsp;<span class="keyword" id="4526351">range</span>&nbsp;<span class="ident" id="4526357">c</span><span class="op" id="4526358">.</span><span class="ident" id="4526359">DNSNames</span>&nbsp;<span class="op" id="4526368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4526373">if</span>&nbsp;<span class="ident" id="4526376">matchHostnames</span><span class="op" id="4526390">(</span><span class="ident" id="4526391">toLowerCaseASCII</span><span class="op" id="4526407">(</span><span class="ident" id="4526408">match</span><span class="op" id="4526413">)</span><span class="op" id="4526414">,</span>&nbsp;<span class="ident" id="4526416">lowered</span><span class="op" id="4526423">)</span>&nbsp;<span class="op" id="4526425">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4526431">return</span>&nbsp;<span class="builtintype" id="4526438">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4526445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4526449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4526453">//&nbsp;If&nbsp;Subject&nbsp;Alt&nbsp;Name&nbsp;is&nbsp;given,&nbsp;we&nbsp;ignore&nbsp;the&nbsp;common&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4526514">}</span>&nbsp;<span class="keyword" id="4526516">else</span>&nbsp;<span class="keyword" id="4526521">if</span>&nbsp;<span class="ident" id="4526524">matchHostnames</span><span class="op" id="4526538">(</span><span class="ident" id="4526539">toLowerCaseASCII</span><span class="op" id="4526555">(</span><span class="ident" id="4526556">c</span><span class="op" id="4526557">.</span><span class="ident" id="4526558">Subject</span><span class="op" id="4526565">.</span><span class="ident" id="4526566">CommonName</span><span class="op" id="4526576">)</span><span class="op" id="4526577">,</span>&nbsp;<span class="ident" id="4526579">lowered</span><span class="op" id="4526586">)</span>&nbsp;<span class="op" id="4526588">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4526592">return</span>&nbsp;<span class="builtintype" id="4526599">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4526604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4526608">return</span>&nbsp;<span class="ident" id="4526615">HostnameError</span><span class="op" id="4526628">{</span><span class="ident" id="4526629">c</span><span class="op" id="4526630">,</span>&nbsp;<span class="ident" id="4526632">h</span><span class="op" id="4526633">}</span><br>
<span class="lineno"></span><span class="op" id="4526635">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span><span class="keyword" id="4526638">func</span>&nbsp;<span class="ident" id="4526643">checkChainForKeyUsage</span><span class="op" id="4526664">(</span><span class="ident" id="4526665">chain</span>&nbsp;<span class="op" id="4526671">[</span><span class="op" id="4526672">]</span><span class="op" id="4526673">*</span><span class="ident" id="4526674">Certificate</span><span class="op" id="4526685">,</span>&nbsp;<span class="ident" id="4526687">keyUsages</span>&nbsp;<span class="op" id="4526697">[</span><span class="op" id="4526698">]</span><span class="ident" id="4526699">ExtKeyUsage</span><span class="op" id="4526710">)</span>&nbsp;<span class="builtintype" id="4526712">bool</span>&nbsp;<span class="op" id="4526717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4526720">usages</span>&nbsp;<span class="op" id="4526727">:=</span>&nbsp;<span class="builtinfunc" id="4526730">make</span><span class="op" id="4526734">(</span><span class="op" id="4526735">[</span><span class="op" id="4526736">]</span><span class="ident" id="4526737">ExtKeyUsage</span><span class="op" id="4526748">,</span>&nbsp;<span class="builtinfunc" id="4526750">len</span><span class="op" id="4526753">(</span><span class="ident" id="4526754">keyUsages</span><span class="op" id="4526763">)</span><span class="op" id="4526764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4526767">copy</span><span class="op" id="4526771">(</span><span class="ident" id="4526772">usages</span><span class="op" id="4526778">,</span>&nbsp;<span class="ident" id="4526780">keyUsages</span><span class="op" id="4526789">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4526793">if</span>&nbsp;<span class="builtinfunc" id="4526796">len</span><span class="op" id="4526799">(</span><span class="ident" id="4526800">chain</span><span class="op" id="4526805">)</span>&nbsp;<span class="op" id="4526807">==</span>&nbsp;<span class="num" id="4526810">0</span>&nbsp;<span class="op" id="4526812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4526816">return</span>&nbsp;<span class="builtintype" id="4526823">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4526830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4526834">usagesRemaining</span>&nbsp;<span class="op" id="4526850">:=</span>&nbsp;<span class="builtinfunc" id="4526853">len</span><span class="op" id="4526856">(</span><span class="ident" id="4526857">usages</span><span class="op" id="4526863">)</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4526867">//&nbsp;We&nbsp;walk&nbsp;down&nbsp;the&nbsp;list&nbsp;and&nbsp;cross&nbsp;out&nbsp;any&nbsp;usages&nbsp;that&nbsp;aren&#39;t&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4526940">//&nbsp;by&nbsp;each&nbsp;certificate.&nbsp;If&nbsp;we&nbsp;cross&nbsp;out&nbsp;all&nbsp;the&nbsp;usages,&nbsp;then&nbsp;the&nbsp;chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4527012">//&nbsp;is&nbsp;unacceptable.</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="ident" id="4527033">NextCert</span><span class="op" id="4527041">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527044">for</span>&nbsp;<span class="ident" id="4527048">i</span>&nbsp;<span class="op" id="4527050">:=</span>&nbsp;<span class="builtinfunc" id="4527053">len</span><span class="op" id="4527056">(</span><span class="ident" id="4527057">chain</span><span class="op" id="4527062">)</span>&nbsp;<span class="op" id="4527064">-</span>&nbsp;<span class="num" id="4527066">1</span><span class="op" id="4527067">;</span>&nbsp;<span class="ident" id="4527069">i</span>&nbsp;<span class="op" id="4527071">&gt;=</span>&nbsp;<span class="num" id="4527074">0</span><span class="op" id="4527075">;</span>&nbsp;<span class="ident" id="4527077">i</span><span class="op" id="4527078">--</span>&nbsp;<span class="op" id="4527081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4527085">cert</span>&nbsp;<span class="op" id="4527090">:=</span>&nbsp;<span class="ident" id="4527093">chain</span><span class="op" id="4527098">[</span><span class="ident" id="4527099">i</span><span class="op" id="4527100">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527104">if</span>&nbsp;<span class="builtinfunc" id="4527107">len</span><span class="op" id="4527110">(</span><span class="ident" id="4527111">cert</span><span class="op" id="4527115">.</span><span class="ident" id="4527116">ExtKeyUsage</span><span class="op" id="4527127">)</span>&nbsp;<span class="op" id="4527129">==</span>&nbsp;<span class="num" id="4527132">0</span>&nbsp;<span class="op" id="4527134">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4527137">len</span><span class="op" id="4527140">(</span><span class="ident" id="4527141">cert</span><span class="op" id="4527145">.</span><span class="ident" id="4527146">UnknownExtKeyUsage</span><span class="op" id="4527164">)</span>&nbsp;<span class="op" id="4527166">==</span>&nbsp;<span class="num" id="4527169">0</span>&nbsp;<span class="op" id="4527171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4527176">//&nbsp;The&nbsp;certificate&nbsp;doesn&#39;t&nbsp;have&nbsp;any&nbsp;extended&nbsp;key&nbsp;usage&nbsp;specified.</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527245">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4527256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527261">for</span>&nbsp;<span class="ident" id="4527265">_</span><span class="op" id="4527266">,</span>&nbsp;<span class="ident" id="4527268">usage</span>&nbsp;<span class="op" id="4527274">:=</span>&nbsp;<span class="keyword" id="4527277">range</span>&nbsp;<span class="ident" id="4527283">cert</span><span class="op" id="4527287">.</span><span class="ident" id="4527288">ExtKeyUsage</span>&nbsp;<span class="op" id="4527300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527305">if</span>&nbsp;<span class="ident" id="4527308">usage</span>&nbsp;<span class="op" id="4527314">==</span>&nbsp;<span class="ident" id="4527317">ExtKeyUsageAny</span>&nbsp;<span class="op" id="4527332">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4527338">//&nbsp;The&nbsp;certificate&nbsp;is&nbsp;explicitly&nbsp;good&nbsp;for&nbsp;any&nbsp;usage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527395">continue</span>&nbsp;<span class="ident" id="4527404">NextCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4527416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4527420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527425">const</span>&nbsp;<span class="ident" id="4527431">invalidUsage</span>&nbsp;<span class="ident" id="4527444">ExtKeyUsage</span>&nbsp;<span class="op" id="4527456">=</span>&nbsp;<span class="op" id="4527458">-</span><span class="num" id="4527459">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4527463">NextRequestedUsage</span><span class="op" id="4527481">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527485">for</span>&nbsp;<span class="ident" id="4527489">i</span><span class="op" id="4527490">,</span>&nbsp;<span class="ident" id="4527492">requestedUsage</span>&nbsp;<span class="op" id="4527507">:=</span>&nbsp;<span class="keyword" id="4527510">range</span>&nbsp;<span class="ident" id="4527516">usages</span>&nbsp;<span class="op" id="4527523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527528">if</span>&nbsp;<span class="ident" id="4527531">requestedUsage</span>&nbsp;<span class="op" id="4527546">==</span>&nbsp;<span class="ident" id="4527549">invalidUsage</span>&nbsp;<span class="op" id="4527562">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527568">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4527580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527586">for</span>&nbsp;<span class="ident" id="4527590">_</span><span class="op" id="4527591">,</span>&nbsp;<span class="ident" id="4527593">usage</span>&nbsp;<span class="op" id="4527599">:=</span>&nbsp;<span class="keyword" id="4527602">range</span>&nbsp;<span class="ident" id="4527608">cert</span><span class="op" id="4527612">.</span><span class="ident" id="4527613">ExtKeyUsage</span>&nbsp;<span class="op" id="4527625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527631">if</span>&nbsp;<span class="ident" id="4527634">requestedUsage</span>&nbsp;<span class="op" id="4527649">==</span>&nbsp;<span class="ident" id="4527652">usage</span>&nbsp;<span class="op" id="4527658">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4527665">continue</span>&nbsp;<span class="ident" id="4527674">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4527697">}</span>&nbsp;<span class="keyword" id="4527699">else</span>&nbsp;<span class="keyword" id="4527704">if</span>&nbsp;<span class="ident" id="4527707">requestedUsage</span>&nbsp;<span class="op" id="4527722">==</span>&nbsp;<span class="ident" id="4527725">ExtKeyUsageServerAuth</span>&nbsp;<span class="op" id="4527747">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4527755">(</span><span class="ident" id="4527756">usage</span>&nbsp;<span class="op" id="4527762">==</span>&nbsp;<span class="ident" id="4527765">ExtKeyUsageNetscapeServerGatedCrypto</span>&nbsp;<span class="op" id="4527802">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4527811">usage</span>&nbsp;<span class="op" id="4527817">==</span>&nbsp;<span class="ident" id="4527820">ExtKeyUsageMicrosoftServerGatedCrypto</span><span class="op" id="4527857">)</span>&nbsp;<span class="op" id="4527859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4527866">//&nbsp;In&nbsp;order&nbsp;to&nbsp;support&nbsp;COMODO</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4527901">//&nbsp;certificate&nbsp;chains,&nbsp;we&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4527940">//&nbsp;accept&nbsp;Netscape&nbsp;or&nbsp;Microsoft&nbsp;SGC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4527981">//&nbsp;usages&nbsp;as&nbsp;equal&nbsp;to&nbsp;ServerAuth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4528020">continue</span>&nbsp;<span class="ident" id="4528029">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4528052">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4528057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4528063">usages</span><span class="op" id="4528069">[</span><span class="ident" id="4528070">i</span><span class="op" id="4528071">]</span>&nbsp;<span class="op" id="4528073">=</span>&nbsp;<span class="ident" id="4528075">invalidUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4528091">usagesRemaining</span><span class="op" id="4528106">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4528112">if</span>&nbsp;<span class="ident" id="4528115">usagesRemaining</span>&nbsp;<span class="op" id="4528131">==</span>&nbsp;<span class="num" id="4528134">0</span>&nbsp;<span class="op" id="4528136">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4528142">return</span>&nbsp;<span class="builtintype" id="4528149">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4528158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4528162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4528165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4528169">return</span>&nbsp;<span class="builtintype" id="4528176">true</span><br>
<span class="lineno"></span><span class="op" id="4528181">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
