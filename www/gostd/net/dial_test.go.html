<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8187336">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8187391">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8187445">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8187496">package</span>&nbsp;<span class="ident" id="8187504">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8187509">import</span>&nbsp;<span class="op" id="8187516">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187519">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187528">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187536">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187543">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187549">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187555">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187566">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187577">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187587">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187598">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187609">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187617">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8187628">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8187635">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8187638">func</span>&nbsp;<span class="ident" id="8187643">newLocalListener</span><span class="op" id="8187659">(</span><span class="ident" id="8187660">t</span>&nbsp;<span class="op" id="8187662">*</span><span class="ident" id="8187663">testing</span><span class="op" id="8187670">.</span><span class="ident" id="8187671">T</span><span class="op" id="8187672">)</span>&nbsp;<span class="ident" id="8187674">Listener</span>&nbsp;<span class="op" id="8187683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8187686">ln</span><span class="op" id="8187688">,</span>&nbsp;<span class="ident" id="8187690">err</span>&nbsp;<span class="op" id="8187694">:=</span>&nbsp;<span class="ident" id="8187697">Listen</span><span class="op" id="8187703">(</span><span class="string" id="8187704">&#34;tcp&#34;</span><span class="op" id="8187709">,</span>&nbsp;<span class="string" id="8187711">&#34;127.0.0.1:0&#34;</span><span class="op" id="8187724">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8187727">if</span>&nbsp;<span class="ident" id="8187730">err</span>&nbsp;<span class="op" id="8187734">!=</span>&nbsp;<span class="ident" id="8187737">nil</span>&nbsp;<span class="op" id="8187741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8187745">ln</span><span class="op" id="8187747">,</span>&nbsp;<span class="ident" id="8187749">err</span>&nbsp;<span class="op" id="8187753">=</span>&nbsp;<span class="ident" id="8187755">Listen</span><span class="op" id="8187761">(</span><span class="string" id="8187762">&#34;tcp6&#34;</span><span class="op" id="8187768">,</span>&nbsp;<span class="string" id="8187770">&#34;[::1]:0&#34;</span><span class="op" id="8187779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8187782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8187785">if</span>&nbsp;<span class="ident" id="8187788">err</span>&nbsp;<span class="op" id="8187792">!=</span>&nbsp;<span class="ident" id="8187795">nil</span>&nbsp;<span class="op" id="8187799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8187803">t</span><span class="op" id="8187804">.</span><span class="ident" id="8187805">Fatal</span><span class="op" id="8187810">(</span><span class="ident" id="8187811">err</span><span class="op" id="8187814">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8187817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8187820">return</span>&nbsp;<span class="ident" id="8187827">ln</span><br>
<span class="lineno"></span><span class="op" id="8187830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8187833">func</span>&nbsp;<span class="ident" id="8187838">TestDialTimeout</span><span class="op" id="8187853">(</span><span class="ident" id="8187854">t</span>&nbsp;<span class="op" id="8187856">*</span><span class="ident" id="8187857">testing</span><span class="op" id="8187864">.</span><span class="ident" id="8187865">T</span><span class="op" id="8187866">)</span>&nbsp;<span class="op" id="8187868">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8187871">origBacklog</span>&nbsp;<span class="op" id="8187883">:=</span>&nbsp;<span class="ident" id="8187886">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8187903">defer</span>&nbsp;<span class="keyword" id="8187909">func</span><span class="op" id="8187913">(</span><span class="op" id="8187914">)</span>&nbsp;<span class="op" id="8187916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8187920">listenerBacklog</span>&nbsp;<span class="op" id="8187936">=</span>&nbsp;<span class="ident" id="8187938">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8187951">}</span><span class="op" id="8187952">(</span><span class="op" id="8187953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8187956">listenerBacklog</span>&nbsp;<span class="op" id="8187972">=</span>&nbsp;<span class="num" id="8187974">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8187978">ln</span>&nbsp;<span class="op" id="8187981">:=</span>&nbsp;<span class="ident" id="8187984">newLocalListener</span><span class="op" id="8188000">(</span><span class="ident" id="8188001">t</span><span class="op" id="8188002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8188005">defer</span>&nbsp;<span class="ident" id="8188011">ln</span><span class="op" id="8188013">.</span><span class="ident" id="8188014">Close</span><span class="op" id="8188019">(</span><span class="op" id="8188020">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8188024">errc</span>&nbsp;<span class="op" id="8188029">:=</span>&nbsp;<span class="builtinfunc" id="8188032">make</span><span class="op" id="8188036">(</span><span class="keyword" id="8188037">chan</span>&nbsp;<span class="builtintype" id="8188042">error</span><span class="op" id="8188047">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8188051">numConns</span>&nbsp;<span class="op" id="8188060">:=</span>&nbsp;<span class="ident" id="8188063">listenerBacklog</span>&nbsp;<span class="op" id="8188079">+</span>&nbsp;<span class="num" id="8188081">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188087">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188144">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8188193">switch</span>&nbsp;<span class="ident" id="8188200">runtime</span><span class="op" id="8188207">.</span><span class="ident" id="8188208">GOOS</span>&nbsp;<span class="op" id="8188213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8188216">case</span>&nbsp;<span class="string" id="8188221">&#34;linux&#34;</span><span class="op" id="8188228">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188232">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188302">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188372">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8188442">for</span>&nbsp;<span class="ident" id="8188446">i</span>&nbsp;<span class="op" id="8188448">:=</span>&nbsp;<span class="num" id="8188451">0</span><span class="op" id="8188452">;</span>&nbsp;<span class="ident" id="8188454">i</span>&nbsp;<span class="op" id="8188456">&lt;</span>&nbsp;<span class="ident" id="8188458">numConns</span><span class="op" id="8188466">;</span>&nbsp;<span class="ident" id="8188468">i</span><span class="op" id="8188469">++</span>&nbsp;<span class="op" id="8188472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8188477">go</span>&nbsp;<span class="keyword" id="8188480">func</span><span class="op" id="8188484">(</span><span class="op" id="8188485">)</span>&nbsp;<span class="op" id="8188487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8188493">_</span><span class="op" id="8188494">,</span>&nbsp;<span class="ident" id="8188496">err</span>&nbsp;<span class="op" id="8188500">:=</span>&nbsp;<span class="ident" id="8188503">DialTimeout</span><span class="op" id="8188514">(</span><span class="string" id="8188515">&#34;tcp&#34;</span><span class="op" id="8188520">,</span>&nbsp;<span class="ident" id="8188522">ln</span><span class="op" id="8188524">.</span><span class="ident" id="8188525">Addr</span><span class="op" id="8188529">(</span><span class="op" id="8188530">)</span><span class="op" id="8188531">.</span><span class="ident" id="8188532">String</span><span class="op" id="8188538">(</span><span class="op" id="8188539">)</span><span class="op" id="8188540">,</span>&nbsp;<span class="num" id="8188542">200</span><span class="op" id="8188545">*</span><span class="ident" id="8188546">time</span><span class="op" id="8188550">.</span><span class="ident" id="8188551">Millisecond</span><span class="op" id="8188562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8188568">errc</span>&nbsp;<span class="op" id="8188573">&lt;-</span>&nbsp;<span class="ident" id="8188576">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8188583">}</span><span class="op" id="8188584">(</span><span class="op" id="8188585">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8188589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8188592">case</span>&nbsp;<span class="string" id="8188597">&#34;darwin&#34;</span><span class="op" id="8188605">,</span>&nbsp;<span class="string" id="8188607">&#34;plan9&#34;</span><span class="op" id="8188614">,</span>&nbsp;<span class="string" id="8188616">&#34;windows&#34;</span><span class="op" id="8188625">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188629">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188683">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188738">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188792">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188815">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188820">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188882">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188938">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8188992">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8189052">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8189057">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8189124">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8189221">go</span>&nbsp;<span class="keyword" id="8189224">func</span><span class="op" id="8189228">(</span><span class="op" id="8189229">)</span>&nbsp;<span class="op" id="8189231">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8189236">c</span><span class="op" id="8189237">,</span>&nbsp;<span class="ident" id="8189239">err</span>&nbsp;<span class="op" id="8189243">:=</span>&nbsp;<span class="ident" id="8189246">DialTimeout</span><span class="op" id="8189257">(</span><span class="string" id="8189258">&#34;tcp&#34;</span><span class="op" id="8189263">,</span>&nbsp;<span class="string" id="8189265">&#34;127.0.71.111:49151&#34;</span><span class="op" id="8189285">,</span>&nbsp;<span class="num" id="8189287">200</span><span class="op" id="8189290">*</span><span class="ident" id="8189291">time</span><span class="op" id="8189295">.</span><span class="ident" id="8189296">Millisecond</span><span class="op" id="8189307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8189312">if</span>&nbsp;<span class="ident" id="8189315">err</span>&nbsp;<span class="op" id="8189319">==</span>&nbsp;<span class="ident" id="8189322">nil</span>&nbsp;<span class="op" id="8189326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8189332">err</span>&nbsp;<span class="op" id="8189336">=</span>&nbsp;<span class="ident" id="8189338">fmt</span><span class="op" id="8189341">.</span><span class="ident" id="8189342">Errorf</span><span class="op" id="8189348">(</span><span class="string" id="8189349">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="8189379">,</span>&nbsp;<span class="ident" id="8189381">c</span><span class="op" id="8189382">.</span><span class="ident" id="8189383">RemoteAddr</span><span class="op" id="8189393">(</span><span class="op" id="8189394">)</span><span class="op" id="8189395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8189401">c</span><span class="op" id="8189402">.</span><span class="ident" id="8189403">Close</span><span class="op" id="8189408">(</span><span class="op" id="8189409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8189414">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8189419">errc</span>&nbsp;<span class="op" id="8189424">&lt;-</span>&nbsp;<span class="ident" id="8189427">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8189433">}</span><span class="op" id="8189434">(</span><span class="op" id="8189435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8189438">default</span><span class="op" id="8189445">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8189449">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8189470">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8189536">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8189592">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8189608">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8189670">t</span><span class="op" id="8189671">.</span><span class="ident" id="8189672">Skipf</span><span class="op" id="8189677">(</span><span class="string" id="8189678">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="8189710">,</span>&nbsp;<span class="ident" id="8189712">runtime</span><span class="op" id="8189719">.</span><span class="ident" id="8189720">GOOS</span><span class="op" id="8189724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8189727">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8189731">connected</span>&nbsp;<span class="op" id="8189741">:=</span>&nbsp;<span class="num" id="8189744">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8189747">for</span>&nbsp;<span class="op" id="8189751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8189755">select</span>&nbsp;<span class="op" id="8189762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8189766">case</span>&nbsp;<span class="op" id="8189771">&lt;-</span><span class="ident" id="8189773">time</span><span class="op" id="8189777">.</span><span class="ident" id="8189778">After</span><span class="op" id="8189783">(</span><span class="num" id="8189784">15</span>&nbsp;<span class="op" id="8189787">*</span>&nbsp;<span class="ident" id="8189789">time</span><span class="op" id="8189793">.</span><span class="ident" id="8189794">Second</span><span class="op" id="8189800">)</span><span class="op" id="8189801">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8189806">t</span><span class="op" id="8189807">.</span><span class="ident" id="8189808">Fatal</span><span class="op" id="8189813">(</span><span class="string" id="8189814">&#34;too&nbsp;slow&#34;</span><span class="op" id="8189824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8189828">case</span>&nbsp;<span class="ident" id="8189833">err</span>&nbsp;<span class="op" id="8189837">:=</span>&nbsp;<span class="op" id="8189840">&lt;-</span><span class="ident" id="8189842">errc</span><span class="op" id="8189846">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8189851">if</span>&nbsp;<span class="ident" id="8189854">err</span>&nbsp;<span class="op" id="8189858">==</span>&nbsp;<span class="ident" id="8189861">nil</span>&nbsp;<span class="op" id="8189865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8189871">connected</span><span class="op" id="8189880">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8189887">if</span>&nbsp;<span class="ident" id="8189890">connected</span>&nbsp;<span class="op" id="8189900">==</span>&nbsp;<span class="ident" id="8189903">numConns</span>&nbsp;<span class="op" id="8189912">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8189919">t</span><span class="op" id="8189920">.</span><span class="ident" id="8189921">Fatal</span><span class="op" id="8189926">(</span><span class="string" id="8189927">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="8189981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8189987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8189992">}</span>&nbsp;<span class="keyword" id="8189994">else</span>&nbsp;<span class="op" id="8189999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190005">terr</span><span class="op" id="8190009">,</span>&nbsp;<span class="ident" id="8190011">ok</span>&nbsp;<span class="op" id="8190014">:=</span>&nbsp;<span class="ident" id="8190017">err</span><span class="op" id="8190020">.</span><span class="op" id="8190021">(</span><span class="ident" id="8190022">timeout</span><span class="op" id="8190029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190035">if</span>&nbsp;<span class="op" id="8190038">!</span><span class="ident" id="8190039">ok</span>&nbsp;<span class="op" id="8190042">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190049">t</span><span class="op" id="8190050">.</span><span class="ident" id="8190051">Fatalf</span><span class="op" id="8190057">(</span><span class="string" id="8190058">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="8190107">,</span>&nbsp;<span class="ident" id="8190109">err</span><span class="op" id="8190112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190124">if</span>&nbsp;<span class="op" id="8190127">!</span><span class="ident" id="8190128">terr</span><span class="op" id="8190132">.</span><span class="ident" id="8190133">Timeout</span><span class="op" id="8190140">(</span><span class="op" id="8190141">)</span>&nbsp;<span class="op" id="8190143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190150">t</span><span class="op" id="8190151">.</span><span class="ident" id="8190152">Fatalf</span><span class="op" id="8190158">(</span><span class="string" id="8190159">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="8190188">,</span>&nbsp;<span class="ident" id="8190190">err</span><span class="op" id="8190193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190199">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8190205">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190242">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190259">}</span><br>
<span class="lineno">115</span><span class="op" id="8190261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8190264">func</span>&nbsp;<span class="ident" id="8190269">TestSelfConnect</span><span class="op" id="8190284">(</span><span class="ident" id="8190285">t</span>&nbsp;<span class="op" id="8190287">*</span><span class="ident" id="8190288">testing</span><span class="op" id="8190295">.</span><span class="ident" id="8190296">T</span><span class="op" id="8190297">)</span>&nbsp;<span class="op" id="8190299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190302">if</span>&nbsp;<span class="ident" id="8190305">runtime</span><span class="op" id="8190312">.</span><span class="ident" id="8190313">GOOS</span>&nbsp;<span class="op" id="8190318">==</span>&nbsp;<span class="string" id="8190321">&#34;windows&#34;</span>&nbsp;<span class="op" id="8190331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8190335">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190382">t</span><span class="op" id="8190383">.</span><span class="ident" id="8190384">Skip</span><span class="op" id="8190388">(</span><span class="string" id="8190389">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="8190428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8190435">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8190484">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8190517">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190572">l</span><span class="op" id="8190573">,</span>&nbsp;<span class="ident" id="8190575">err</span>&nbsp;<span class="op" id="8190579">:=</span>&nbsp;<span class="ident" id="8190582">Listen</span><span class="op" id="8190588">(</span><span class="string" id="8190589">&#34;tcp&#34;</span><span class="op" id="8190594">,</span>&nbsp;<span class="string" id="8190596">&#34;127.0.0.1:0&#34;</span><span class="op" id="8190609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190612">if</span>&nbsp;<span class="ident" id="8190615">err</span>&nbsp;<span class="op" id="8190619">!=</span>&nbsp;<span class="ident" id="8190622">nil</span>&nbsp;<span class="op" id="8190626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190630">t</span><span class="op" id="8190631">.</span><span class="ident" id="8190632">Fatal</span><span class="op" id="8190637">(</span><span class="ident" id="8190638">err</span><span class="op" id="8190641">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190647">c</span><span class="op" id="8190648">,</span>&nbsp;<span class="ident" id="8190650">err</span>&nbsp;<span class="op" id="8190654">:=</span>&nbsp;<span class="ident" id="8190657">Dial</span><span class="op" id="8190661">(</span><span class="string" id="8190662">&#34;tcp&#34;</span><span class="op" id="8190667">,</span>&nbsp;<span class="ident" id="8190669">l</span><span class="op" id="8190670">.</span><span class="ident" id="8190671">Addr</span><span class="op" id="8190675">(</span><span class="op" id="8190676">)</span><span class="op" id="8190677">.</span><span class="ident" id="8190678">String</span><span class="op" id="8190684">(</span><span class="op" id="8190685">)</span><span class="op" id="8190686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190689">if</span>&nbsp;<span class="ident" id="8190692">err</span>&nbsp;<span class="op" id="8190696">!=</span>&nbsp;<span class="ident" id="8190699">nil</span>&nbsp;<span class="op" id="8190703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190707">t</span><span class="op" id="8190708">.</span><span class="ident" id="8190709">Fatal</span><span class="op" id="8190714">(</span><span class="ident" id="8190715">err</span><span class="op" id="8190718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190721">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190724">addr</span>&nbsp;<span class="op" id="8190729">:=</span>&nbsp;<span class="ident" id="8190732">c</span><span class="op" id="8190733">.</span><span class="ident" id="8190734">LocalAddr</span><span class="op" id="8190743">(</span><span class="op" id="8190744">)</span><span class="op" id="8190745">.</span><span class="ident" id="8190746">String</span><span class="op" id="8190752">(</span><span class="op" id="8190753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190756">c</span><span class="op" id="8190757">.</span><span class="ident" id="8190758">Close</span><span class="op" id="8190763">(</span><span class="op" id="8190764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190767">l</span><span class="op" id="8190768">.</span><span class="ident" id="8190769">Close</span><span class="op" id="8190774">(</span><span class="op" id="8190775">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8190779">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190826">n</span>&nbsp;<span class="op" id="8190828">:=</span>&nbsp;<span class="num" id="8190831">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190839">if</span>&nbsp;<span class="ident" id="8190842">testing</span><span class="op" id="8190849">.</span><span class="ident" id="8190850">Short</span><span class="op" id="8190855">(</span><span class="op" id="8190856">)</span>&nbsp;<span class="op" id="8190858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190862">n</span>&nbsp;<span class="op" id="8190864">=</span>&nbsp;<span class="num" id="8190866">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190875">switch</span>&nbsp;<span class="ident" id="8190882">runtime</span><span class="op" id="8190889">.</span><span class="ident" id="8190890">GOOS</span>&nbsp;<span class="op" id="8190895">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190898">case</span>&nbsp;<span class="string" id="8190903">&#34;darwin&#34;</span><span class="op" id="8190911">,</span>&nbsp;<span class="string" id="8190913">&#34;dragonfly&#34;</span><span class="op" id="8190924">,</span>&nbsp;<span class="string" id="8190926">&#34;freebsd&#34;</span><span class="op" id="8190935">,</span>&nbsp;<span class="string" id="8190937">&#34;netbsd&#34;</span><span class="op" id="8190945">,</span>&nbsp;<span class="string" id="8190947">&#34;openbsd&#34;</span><span class="op" id="8190956">,</span>&nbsp;<span class="string" id="8190958">&#34;plan9&#34;</span><span class="op" id="8190965">,</span>&nbsp;<span class="string" id="8190967">&#34;solaris&#34;</span><span class="op" id="8190976">,</span>&nbsp;<span class="string" id="8190978">&#34;windows&#34;</span><span class="op" id="8190987">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8190991">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8191041">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191096">n</span>&nbsp;<span class="op" id="8191098">=</span>&nbsp;<span class="num" id="8191100">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191105">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8191108">for</span>&nbsp;<span class="ident" id="8191112">i</span>&nbsp;<span class="op" id="8191114">:=</span>&nbsp;<span class="num" id="8191117">0</span><span class="op" id="8191118">;</span>&nbsp;<span class="ident" id="8191120">i</span>&nbsp;<span class="op" id="8191122">&lt;</span>&nbsp;<span class="ident" id="8191124">n</span><span class="op" id="8191125">;</span>&nbsp;<span class="ident" id="8191127">i</span><span class="op" id="8191128">++</span>&nbsp;<span class="op" id="8191131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191135">c</span><span class="op" id="8191136">,</span>&nbsp;<span class="ident" id="8191138">err</span>&nbsp;<span class="op" id="8191142">:=</span>&nbsp;<span class="ident" id="8191145">DialTimeout</span><span class="op" id="8191156">(</span><span class="string" id="8191157">&#34;tcp&#34;</span><span class="op" id="8191162">,</span>&nbsp;<span class="ident" id="8191164">addr</span><span class="op" id="8191168">,</span>&nbsp;<span class="ident" id="8191170">time</span><span class="op" id="8191174">.</span><span class="ident" id="8191175">Millisecond</span><span class="op" id="8191186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8191190">if</span>&nbsp;<span class="ident" id="8191193">err</span>&nbsp;<span class="op" id="8191197">==</span>&nbsp;<span class="ident" id="8191200">nil</span>&nbsp;<span class="op" id="8191204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8191209">if</span>&nbsp;<span class="ident" id="8191212">c</span><span class="op" id="8191213">.</span><span class="ident" id="8191214">LocalAddr</span><span class="op" id="8191223">(</span><span class="op" id="8191224">)</span><span class="op" id="8191225">.</span><span class="ident" id="8191226">String</span><span class="op" id="8191232">(</span><span class="op" id="8191233">)</span>&nbsp;<span class="op" id="8191235">==</span>&nbsp;<span class="ident" id="8191238">addr</span>&nbsp;<span class="op" id="8191243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191249">t</span><span class="op" id="8191250">.</span><span class="ident" id="8191251">Errorf</span><span class="op" id="8191257">(</span><span class="string" id="8191258">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="8191285">,</span>&nbsp;<span class="ident" id="8191287">i</span><span class="op" id="8191288">,</span>&nbsp;<span class="ident" id="8191290">addr</span><span class="op" id="8191294">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191299">}</span>&nbsp;<span class="keyword" id="8191301">else</span>&nbsp;<span class="op" id="8191306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191312">t</span><span class="op" id="8191313">.</span><span class="ident" id="8191314">Logf</span><span class="op" id="8191318">(</span><span class="string" id="8191319">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="8191381">,</span>&nbsp;<span class="ident" id="8191383">i</span><span class="op" id="8191384">,</span>&nbsp;<span class="ident" id="8191386">addr</span><span class="op" id="8191390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191400">c</span><span class="op" id="8191401">.</span><span class="ident" id="8191402">Close</span><span class="op" id="8191407">(</span><span class="op" id="8191408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191412">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191415">}</span><br>
<span class="lineno"></span><span class="op" id="8191417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8191420">var</span>&nbsp;<span class="ident" id="8191424">runErrorTest</span>&nbsp;<span class="op" id="8191437">=</span>&nbsp;<span class="ident" id="8191439">flag</span><span class="op" id="8191443">.</span><span class="ident" id="8191444">Bool</span><span class="op" id="8191448">(</span><span class="string" id="8191449">&#34;run_error_test&#34;</span><span class="op" id="8191465">,</span>&nbsp;<span class="builtintype" id="8191467">false</span><span class="op" id="8191472">,</span>&nbsp;<span class="string" id="8191474">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="8191514">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="8191517">type</span>&nbsp;<span class="ident" id="8191522">DialErrorTest</span>&nbsp;<span class="keyword" id="8191536">struct</span>&nbsp;<span class="op" id="8191543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191546">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8191554">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191562">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8191570">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191578">Pattern</span>&nbsp;<span class="builtintype" id="8191586">string</span><br>
<span class="lineno"></span><span class="op" id="8191593">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="8191596">var</span>&nbsp;<span class="ident" id="8191600">dialErrorTests</span>&nbsp;<span class="op" id="8191615">=</span>&nbsp;<span class="op" id="8191617">[</span><span class="op" id="8191618">]</span><span class="ident" id="8191619">DialErrorTest</span><span class="op" id="8191632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8191639">&#34;datakit&#34;</span><span class="op" id="8191648">,</span>&nbsp;<span class="string" id="8191650">&#34;mh/astro/r70&#34;</span><span class="op" id="8191664">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8191668">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="8191720">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191723">}</span><span class="op" id="8191724">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8191731">&#34;tcp&#34;</span><span class="op" id="8191736">,</span>&nbsp;<span class="string" id="8191738">&#34;127.0.0.1:☺&#34;</span><span class="op" id="8191753">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8191757">&#34;dial&nbsp;tcp&nbsp;127.0.0.1:☺:&nbsp;unknown&nbsp;port&nbsp;tcp/☺&#34;</span><span class="op" id="8191803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191806">}</span><span class="op" id="8191807">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8191814">&#34;tcp&#34;</span><span class="op" id="8191819">,</span>&nbsp;<span class="string" id="8191821">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="8191850">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8191854">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="8191943">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191946">}</span><span class="op" id="8191947">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191950">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8191954">&#34;tcp&#34;</span><span class="op" id="8191959">,</span>&nbsp;<span class="string" id="8191961">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="8192004">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192008">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="8192125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192128">}</span><span class="op" id="8192129">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192136">&#34;tcp&#34;</span><span class="op" id="8192141">,</span>&nbsp;<span class="string" id="8192143">&#34;no-such-name:80&#34;</span><span class="op" id="8192160">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192164">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="8192238">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192241">}</span><span class="op" id="8192242">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192249">&#34;tcp&#34;</span><span class="op" id="8192254">,</span>&nbsp;<span class="string" id="8192256">&#34;mh/astro/r70:http&#34;</span><span class="op" id="8192275">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192279">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="8192349">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192352">}</span><span class="op" id="8192353">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192360">&#34;unix&#34;</span><span class="op" id="8192366">,</span>&nbsp;<span class="string" id="8192368">&#34;/etc/file-not-found&#34;</span><span class="op" id="8192389">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192393">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="8192451">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192454">}</span><span class="op" id="8192455">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192462">&#34;unix&#34;</span><span class="op" id="8192468">,</span>&nbsp;<span class="string" id="8192470">&#34;/etc/&#34;</span><span class="op" id="8192477">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192481">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="8192569">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192572">}</span><span class="op" id="8192573">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192576">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192580">&#34;unixpacket&#34;</span><span class="op" id="8192592">,</span>&nbsp;<span class="string" id="8192594">&#34;/etc/file-not-found&#34;</span><span class="op" id="8192615">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192619">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="8192683">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192686">}</span><span class="op" id="8192687">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192694">&#34;unixpacket&#34;</span><span class="op" id="8192706">,</span>&nbsp;<span class="string" id="8192708">&#34;/etc/&#34;</span><span class="op" id="8192715">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8192719">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="8192813">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192816">}</span><span class="op" id="8192817">,</span><br>
<span class="lineno"></span><span class="op" id="8192819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8192822">var</span>&nbsp;<span class="ident" id="8192826">duplicateErrorPattern</span>&nbsp;<span class="op" id="8192848">=</span>&nbsp;<span class="string" id="8192850">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="8192873">func</span>&nbsp;<span class="ident" id="8192878">TestDialError</span><span class="op" id="8192891">(</span><span class="ident" id="8192892">t</span>&nbsp;<span class="op" id="8192894">*</span><span class="ident" id="8192895">testing</span><span class="op" id="8192902">.</span><span class="ident" id="8192903">T</span><span class="op" id="8192904">)</span>&nbsp;<span class="op" id="8192906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8192909">if</span>&nbsp;<span class="op" id="8192912">!</span><span class="op" id="8192913">*</span><span class="ident" id="8192914">runErrorTest</span>&nbsp;<span class="op" id="8192927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192931">t</span><span class="op" id="8192932">.</span><span class="ident" id="8192933">Logf</span><span class="op" id="8192937">(</span><span class="string" id="8192938">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="8192984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8192988">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8192999">for</span>&nbsp;<span class="ident" id="8193003">i</span><span class="op" id="8193004">,</span>&nbsp;<span class="ident" id="8193006">tt</span>&nbsp;<span class="op" id="8193009">:=</span>&nbsp;<span class="keyword" id="8193012">range</span>&nbsp;<span class="ident" id="8193018">dialErrorTests</span>&nbsp;<span class="op" id="8193033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193037">c</span><span class="op" id="8193038">,</span>&nbsp;<span class="ident" id="8193040">err</span>&nbsp;<span class="op" id="8193044">:=</span>&nbsp;<span class="ident" id="8193047">Dial</span><span class="op" id="8193051">(</span><span class="ident" id="8193052">tt</span><span class="op" id="8193054">.</span><span class="ident" id="8193055">Net</span><span class="op" id="8193058">,</span>&nbsp;<span class="ident" id="8193060">tt</span><span class="op" id="8193062">.</span><span class="ident" id="8193063">Raddr</span><span class="op" id="8193068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193072">if</span>&nbsp;<span class="ident" id="8193075">c</span>&nbsp;<span class="op" id="8193077">!=</span>&nbsp;<span class="ident" id="8193080">nil</span>&nbsp;<span class="op" id="8193084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193089">c</span><span class="op" id="8193090">.</span><span class="ident" id="8193091">Close</span><span class="op" id="8193096">(</span><span class="op" id="8193097">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193105">if</span>&nbsp;<span class="ident" id="8193108">err</span>&nbsp;<span class="op" id="8193112">==</span>&nbsp;<span class="ident" id="8193115">nil</span>&nbsp;<span class="op" id="8193119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193124">t</span><span class="op" id="8193125">.</span><span class="ident" id="8193126">Errorf</span><span class="op" id="8193132">(</span><span class="string" id="8193133">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="8193169">,</span>&nbsp;<span class="ident" id="8193171">i</span><span class="op" id="8193172">,</span>&nbsp;<span class="ident" id="8193174">tt</span><span class="op" id="8193176">.</span><span class="ident" id="8193177">Pattern</span><span class="op" id="8193184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193189">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193200">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193204">s</span>&nbsp;<span class="op" id="8193206">:=</span>&nbsp;<span class="ident" id="8193209">err</span><span class="op" id="8193212">.</span><span class="ident" id="8193213">Error</span><span class="op" id="8193218">(</span><span class="op" id="8193219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193223">match</span><span class="op" id="8193228">,</span>&nbsp;<span class="ident" id="8193230">_</span>&nbsp;<span class="op" id="8193232">:=</span>&nbsp;<span class="ident" id="8193235">regexp</span><span class="op" id="8193241">.</span><span class="ident" id="8193242">MatchString</span><span class="op" id="8193253">(</span><span class="ident" id="8193254">tt</span><span class="op" id="8193256">.</span><span class="ident" id="8193257">Pattern</span><span class="op" id="8193264">,</span>&nbsp;<span class="ident" id="8193266">s</span><span class="op" id="8193267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193271">if</span>&nbsp;<span class="op" id="8193274">!</span><span class="ident" id="8193275">match</span>&nbsp;<span class="op" id="8193281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193286">t</span><span class="op" id="8193287">.</span><span class="ident" id="8193288">Errorf</span><span class="op" id="8193294">(</span><span class="string" id="8193295">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="8193324">,</span>&nbsp;<span class="ident" id="8193326">i</span><span class="op" id="8193327">,</span>&nbsp;<span class="ident" id="8193329">s</span><span class="op" id="8193330">,</span>&nbsp;<span class="ident" id="8193332">tt</span><span class="op" id="8193334">.</span><span class="ident" id="8193335">Pattern</span><span class="op" id="8193342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193346">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193350">match</span><span class="op" id="8193355">,</span>&nbsp;<span class="ident" id="8193357">_</span>&nbsp;<span class="op" id="8193359">=</span>&nbsp;<span class="ident" id="8193361">regexp</span><span class="op" id="8193367">.</span><span class="ident" id="8193368">MatchString</span><span class="op" id="8193379">(</span><span class="ident" id="8193380">duplicateErrorPattern</span><span class="op" id="8193401">,</span>&nbsp;<span class="ident" id="8193403">s</span><span class="op" id="8193404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193408">if</span>&nbsp;<span class="ident" id="8193411">match</span>&nbsp;<span class="op" id="8193417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193422">t</span><span class="op" id="8193423">.</span><span class="ident" id="8193424">Errorf</span><span class="op" id="8193430">(</span><span class="string" id="8193431">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="8193474">,</span>&nbsp;<span class="ident" id="8193476">i</span><span class="op" id="8193477">,</span>&nbsp;<span class="ident" id="8193479">s</span><span class="op" id="8193480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193487">}</span><br>
<span class="lineno">240</span><span class="op" id="8193489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8193492">var</span>&nbsp;<span class="ident" id="8193496">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="8193525">=</span>&nbsp;<span class="op" id="8193527">[</span><span class="op" id="8193528">]</span><span class="keyword" id="8193529">struct</span>&nbsp;<span class="op" id="8193536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193539">net</span>&nbsp;&nbsp;<span class="builtintype" id="8193544">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193552">addr</span>&nbsp;<span class="builtintype" id="8193557">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193565">err</span>&nbsp;&nbsp;<span class="builtintype" id="8193570">error</span><br>
<span class="lineno"></span><span class="op" id="8193576">}</span><span class="op" id="8193577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193580">{</span><span class="string" id="8193581">&#34;foo&#34;</span><span class="op" id="8193586">,</span>&nbsp;<span class="string" id="8193588">&#34;bar&#34;</span><span class="op" id="8193593">,</span>&nbsp;<span class="op" id="8193595">&amp;</span><span class="ident" id="8193596">OpError</span><span class="op" id="8193603">{</span><span class="ident" id="8193604">Op</span><span class="op" id="8193606">:</span>&nbsp;<span class="string" id="8193608">&#34;dial&#34;</span><span class="op" id="8193614">,</span>&nbsp;<span class="ident" id="8193616">Net</span><span class="op" id="8193619">:</span>&nbsp;<span class="string" id="8193621">&#34;foo&#34;</span><span class="op" id="8193626">,</span>&nbsp;<span class="ident" id="8193628">Addr</span><span class="op" id="8193632">:</span>&nbsp;<span class="ident" id="8193634">nil</span><span class="op" id="8193637">,</span>&nbsp;<span class="ident" id="8193639">Err</span><span class="op" id="8193642">:</span>&nbsp;<span class="ident" id="8193644">UnknownNetworkError</span><span class="op" id="8193663">(</span><span class="string" id="8193664">&#34;foo&#34;</span><span class="op" id="8193669">)</span><span class="op" id="8193670">}</span><span class="op" id="8193671">}</span><span class="op" id="8193672">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193675">{</span><span class="string" id="8193676">&#34;baz&#34;</span><span class="op" id="8193681">,</span>&nbsp;<span class="string" id="8193683">&#34;&#34;</span><span class="op" id="8193685">,</span>&nbsp;<span class="op" id="8193687">&amp;</span><span class="ident" id="8193688">OpError</span><span class="op" id="8193695">{</span><span class="ident" id="8193696">Op</span><span class="op" id="8193698">:</span>&nbsp;<span class="string" id="8193700">&#34;listen&#34;</span><span class="op" id="8193708">,</span>&nbsp;<span class="ident" id="8193710">Net</span><span class="op" id="8193713">:</span>&nbsp;<span class="string" id="8193715">&#34;baz&#34;</span><span class="op" id="8193720">,</span>&nbsp;<span class="ident" id="8193722">Addr</span><span class="op" id="8193726">:</span>&nbsp;<span class="ident" id="8193728">nil</span><span class="op" id="8193731">,</span>&nbsp;<span class="ident" id="8193733">Err</span><span class="op" id="8193736">:</span>&nbsp;<span class="ident" id="8193738">UnknownNetworkError</span><span class="op" id="8193757">(</span><span class="string" id="8193758">&#34;baz&#34;</span><span class="op" id="8193763">)</span><span class="op" id="8193764">}</span><span class="op" id="8193765">}</span><span class="op" id="8193766">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193769">{</span><span class="string" id="8193770">&#34;tcp&#34;</span><span class="op" id="8193775">,</span>&nbsp;<span class="string" id="8193777">&#34;&#34;</span><span class="op" id="8193779">,</span>&nbsp;<span class="op" id="8193781">&amp;</span><span class="ident" id="8193782">OpError</span><span class="op" id="8193789">{</span><span class="ident" id="8193790">Op</span><span class="op" id="8193792">:</span>&nbsp;<span class="string" id="8193794">&#34;dial&#34;</span><span class="op" id="8193800">,</span>&nbsp;<span class="ident" id="8193802">Net</span><span class="op" id="8193805">:</span>&nbsp;<span class="string" id="8193807">&#34;tcp&#34;</span><span class="op" id="8193812">,</span>&nbsp;<span class="ident" id="8193814">Addr</span><span class="op" id="8193818">:</span>&nbsp;<span class="ident" id="8193820">nil</span><span class="op" id="8193823">,</span>&nbsp;<span class="ident" id="8193825">Err</span><span class="op" id="8193828">:</span>&nbsp;<span class="ident" id="8193830">errMissingAddress</span><span class="op" id="8193847">}</span><span class="op" id="8193848">}</span><span class="op" id="8193849">,</span><br>
<span class="lineno">250</span><span class="op" id="8193851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8193854">func</span>&nbsp;<span class="ident" id="8193859">TestInvalidDialAndListenArgs</span><span class="op" id="8193887">(</span><span class="ident" id="8193888">t</span>&nbsp;<span class="op" id="8193890">*</span><span class="ident" id="8193891">testing</span><span class="op" id="8193898">.</span><span class="ident" id="8193899">T</span><span class="op" id="8193900">)</span>&nbsp;<span class="op" id="8193902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193905">for</span>&nbsp;<span class="ident" id="8193909">_</span><span class="op" id="8193910">,</span>&nbsp;<span class="ident" id="8193912">tt</span>&nbsp;<span class="op" id="8193915">:=</span>&nbsp;<span class="keyword" id="8193918">range</span>&nbsp;<span class="ident" id="8193924">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="8193953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193957">var</span>&nbsp;<span class="ident" id="8193961">err</span>&nbsp;<span class="builtintype" id="8193965">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193973">switch</span>&nbsp;<span class="ident" id="8193980">tt</span><span class="op" id="8193982">.</span><span class="ident" id="8193983">err</span><span class="op" id="8193986">.</span><span class="op" id="8193987">(</span><span class="op" id="8193988">*</span><span class="ident" id="8193989">OpError</span><span class="op" id="8193996">)</span><span class="op" id="8193997">.</span><span class="ident" id="8193998">Op</span>&nbsp;<span class="op" id="8194001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194005">case</span>&nbsp;<span class="string" id="8194010">&#34;dial&#34;</span><span class="op" id="8194016">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194021">_</span><span class="op" id="8194022">,</span>&nbsp;<span class="ident" id="8194024">err</span>&nbsp;<span class="op" id="8194028">=</span>&nbsp;<span class="ident" id="8194030">Dial</span><span class="op" id="8194034">(</span><span class="ident" id="8194035">tt</span><span class="op" id="8194037">.</span><span class="ident" id="8194038">net</span><span class="op" id="8194041">,</span>&nbsp;<span class="ident" id="8194043">tt</span><span class="op" id="8194045">.</span><span class="ident" id="8194046">addr</span><span class="op" id="8194050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194054">case</span>&nbsp;<span class="string" id="8194059">&#34;listen&#34;</span><span class="op" id="8194067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194072">_</span><span class="op" id="8194073">,</span>&nbsp;<span class="ident" id="8194075">err</span>&nbsp;<span class="op" id="8194079">=</span>&nbsp;<span class="ident" id="8194081">Listen</span><span class="op" id="8194087">(</span><span class="ident" id="8194088">tt</span><span class="op" id="8194090">.</span><span class="ident" id="8194091">net</span><span class="op" id="8194094">,</span>&nbsp;<span class="ident" id="8194096">tt</span><span class="op" id="8194098">.</span><span class="ident" id="8194099">addr</span><span class="op" id="8194103">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194111">if</span>&nbsp;<span class="op" id="8194114">!</span><span class="ident" id="8194115">reflect</span><span class="op" id="8194122">.</span><span class="ident" id="8194123">DeepEqual</span><span class="op" id="8194132">(</span><span class="ident" id="8194133">tt</span><span class="op" id="8194135">.</span><span class="ident" id="8194136">err</span><span class="op" id="8194139">,</span>&nbsp;<span class="ident" id="8194141">err</span><span class="op" id="8194144">)</span>&nbsp;<span class="op" id="8194146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194151">t</span><span class="op" id="8194152">.</span><span class="ident" id="8194153">Fatalf</span><span class="op" id="8194159">(</span><span class="string" id="8194160">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="8194183">,</span>&nbsp;<span class="ident" id="8194185">err</span><span class="op" id="8194188">,</span>&nbsp;<span class="ident" id="8194190">tt</span><span class="op" id="8194192">.</span><span class="ident" id="8194193">err</span><span class="op" id="8194196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194203">}</span><br>
<span class="lineno">265</span><span class="op" id="8194205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8194208">func</span>&nbsp;<span class="ident" id="8194213">TestDialTimeoutFDLeak</span><span class="op" id="8194234">(</span><span class="ident" id="8194235">t</span>&nbsp;<span class="op" id="8194237">*</span><span class="ident" id="8194238">testing</span><span class="op" id="8194245">.</span><span class="ident" id="8194246">T</span><span class="op" id="8194247">)</span>&nbsp;<span class="op" id="8194249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194252">if</span>&nbsp;<span class="ident" id="8194255">runtime</span><span class="op" id="8194262">.</span><span class="ident" id="8194263">GOOS</span>&nbsp;<span class="op" id="8194268">!=</span>&nbsp;<span class="string" id="8194271">&#34;linux&#34;</span>&nbsp;<span class="op" id="8194279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8194283">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194328">t</span><span class="op" id="8194329">.</span><span class="ident" id="8194330">Skipf</span><span class="op" id="8194335">(</span><span class="string" id="8194336">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="8194357">,</span>&nbsp;<span class="ident" id="8194359">runtime</span><span class="op" id="8194366">.</span><span class="ident" id="8194367">GOOS</span><span class="op" id="8194371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194378">ln</span>&nbsp;<span class="op" id="8194381">:=</span>&nbsp;<span class="ident" id="8194384">newLocalListener</span><span class="op" id="8194400">(</span><span class="ident" id="8194401">t</span><span class="op" id="8194402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194405">defer</span>&nbsp;<span class="ident" id="8194411">ln</span><span class="op" id="8194413">.</span><span class="ident" id="8194414">Close</span><span class="op" id="8194419">(</span><span class="op" id="8194420">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194424">type</span>&nbsp;<span class="ident" id="8194429">connErr</span>&nbsp;<span class="keyword" id="8194437">struct</span>&nbsp;<span class="op" id="8194444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194448">conn</span>&nbsp;<span class="ident" id="8194453">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194460">err</span>&nbsp;&nbsp;<span class="builtintype" id="8194465">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194472">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194475">dials</span>&nbsp;<span class="op" id="8194481">:=</span>&nbsp;<span class="ident" id="8194484">listenerBacklog</span>&nbsp;<span class="op" id="8194500">+</span>&nbsp;<span class="num" id="8194502">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8194507">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194587">maxGoodConnect</span>&nbsp;<span class="op" id="8194602">:=</span>&nbsp;<span class="ident" id="8194605">listenerBacklog</span>&nbsp;<span class="op" id="8194621">+</span>&nbsp;<span class="ident" id="8194623">runtime</span><span class="op" id="8194630">.</span><span class="ident" id="8194631">NumCPU</span><span class="op" id="8194637">(</span><span class="op" id="8194638">)</span><span class="op" id="8194639">*</span><span class="num" id="8194640">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194644">resc</span>&nbsp;<span class="op" id="8194649">:=</span>&nbsp;<span class="builtinfunc" id="8194652">make</span><span class="op" id="8194656">(</span><span class="keyword" id="8194657">chan</span>&nbsp;<span class="ident" id="8194662">connErr</span><span class="op" id="8194669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194672">for</span>&nbsp;<span class="ident" id="8194676">i</span>&nbsp;<span class="op" id="8194678">:=</span>&nbsp;<span class="num" id="8194681">0</span><span class="op" id="8194682">;</span>&nbsp;<span class="ident" id="8194684">i</span>&nbsp;<span class="op" id="8194686">&lt;</span>&nbsp;<span class="ident" id="8194688">dials</span><span class="op" id="8194693">;</span>&nbsp;<span class="ident" id="8194695">i</span><span class="op" id="8194696">++</span>&nbsp;<span class="op" id="8194699">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194703">go</span>&nbsp;<span class="keyword" id="8194706">func</span><span class="op" id="8194710">(</span><span class="op" id="8194711">)</span>&nbsp;<span class="op" id="8194713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194718">conn</span><span class="op" id="8194722">,</span>&nbsp;<span class="ident" id="8194724">err</span>&nbsp;<span class="op" id="8194728">:=</span>&nbsp;<span class="ident" id="8194731">DialTimeout</span><span class="op" id="8194742">(</span><span class="string" id="8194743">&#34;tcp&#34;</span><span class="op" id="8194748">,</span>&nbsp;<span class="ident" id="8194750">ln</span><span class="op" id="8194752">.</span><span class="ident" id="8194753">Addr</span><span class="op" id="8194757">(</span><span class="op" id="8194758">)</span><span class="op" id="8194759">.</span><span class="ident" id="8194760">String</span><span class="op" id="8194766">(</span><span class="op" id="8194767">)</span><span class="op" id="8194768">,</span>&nbsp;<span class="num" id="8194770">500</span><span class="op" id="8194773">*</span><span class="ident" id="8194774">time</span><span class="op" id="8194778">.</span><span class="ident" id="8194779">Millisecond</span><span class="op" id="8194790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194795">resc</span>&nbsp;<span class="op" id="8194800">&lt;-</span>&nbsp;<span class="ident" id="8194803">connErr</span><span class="op" id="8194810">{</span><span class="ident" id="8194811">conn</span><span class="op" id="8194815">,</span>&nbsp;<span class="ident" id="8194817">err</span><span class="op" id="8194820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194824">}</span><span class="op" id="8194825">(</span><span class="op" id="8194826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194829">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194833">var</span>&nbsp;<span class="ident" id="8194837">firstErr</span>&nbsp;<span class="builtintype" id="8194846">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194854">var</span>&nbsp;<span class="ident" id="8194858">ngood</span>&nbsp;<span class="builtintype" id="8194864">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194869">var</span>&nbsp;<span class="ident" id="8194873">toClose</span>&nbsp;<span class="op" id="8194881">[</span><span class="op" id="8194882">]</span><span class="ident" id="8194883">io</span><span class="op" id="8194885">.</span><span class="ident" id="8194886">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194894">for</span>&nbsp;<span class="ident" id="8194898">i</span>&nbsp;<span class="op" id="8194900">:=</span>&nbsp;<span class="num" id="8194903">0</span><span class="op" id="8194904">;</span>&nbsp;<span class="ident" id="8194906">i</span>&nbsp;<span class="op" id="8194908">&lt;</span>&nbsp;<span class="ident" id="8194910">dials</span><span class="op" id="8194915">;</span>&nbsp;<span class="ident" id="8194917">i</span><span class="op" id="8194918">++</span>&nbsp;<span class="op" id="8194921">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194925">ce</span>&nbsp;<span class="op" id="8194928">:=</span>&nbsp;<span class="op" id="8194931">&lt;-</span><span class="ident" id="8194933">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194940">if</span>&nbsp;<span class="ident" id="8194943">ce</span><span class="op" id="8194945">.</span><span class="ident" id="8194946">err</span>&nbsp;<span class="op" id="8194950">==</span>&nbsp;<span class="ident" id="8194953">nil</span>&nbsp;<span class="op" id="8194957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194962">ngood</span><span class="op" id="8194967">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194973">if</span>&nbsp;<span class="ident" id="8194976">ngood</span>&nbsp;<span class="op" id="8194982">&gt;</span>&nbsp;<span class="ident" id="8194984">maxGoodConnect</span>&nbsp;<span class="op" id="8194999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195005">t</span><span class="op" id="8195006">.</span><span class="ident" id="8195007">Errorf</span><span class="op" id="8195013">(</span><span class="string" id="8195014">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="8195053">,</span>&nbsp;<span class="ident" id="8195055">ngood</span><span class="op" id="8195060">,</span>&nbsp;<span class="ident" id="8195062">maxGoodConnect</span><span class="op" id="8195076">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195086">toClose</span>&nbsp;<span class="op" id="8195094">=</span>&nbsp;<span class="builtinfunc" id="8195096">append</span><span class="op" id="8195102">(</span><span class="ident" id="8195103">toClose</span><span class="op" id="8195110">,</span>&nbsp;<span class="ident" id="8195112">ce</span><span class="op" id="8195114">.</span><span class="ident" id="8195115">conn</span><span class="op" id="8195119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195124">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195139">err</span>&nbsp;<span class="op" id="8195143">:=</span>&nbsp;<span class="ident" id="8195146">ce</span><span class="op" id="8195148">.</span><span class="ident" id="8195149">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195155">if</span>&nbsp;<span class="ident" id="8195158">firstErr</span>&nbsp;<span class="op" id="8195167">==</span>&nbsp;<span class="string" id="8195170">&#34;&#34;</span>&nbsp;<span class="op" id="8195173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195178">firstErr</span>&nbsp;<span class="op" id="8195187">=</span>&nbsp;<span class="ident" id="8195189">err</span><span class="op" id="8195192">.</span><span class="ident" id="8195193">Error</span><span class="op" id="8195198">(</span><span class="op" id="8195199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195203">}</span>&nbsp;<span class="keyword" id="8195205">else</span>&nbsp;<span class="keyword" id="8195210">if</span>&nbsp;<span class="ident" id="8195213">err</span><span class="op" id="8195216">.</span><span class="ident" id="8195217">Error</span><span class="op" id="8195222">(</span><span class="op" id="8195223">)</span>&nbsp;<span class="op" id="8195225">!=</span>&nbsp;<span class="ident" id="8195228">firstErr</span>&nbsp;<span class="op" id="8195237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195242">t</span><span class="op" id="8195243">.</span><span class="ident" id="8195244">Fatalf</span><span class="op" id="8195250">(</span><span class="string" id="8195251">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="8195309">,</span>&nbsp;<span class="ident" id="8195311">firstErr</span><span class="op" id="8195319">,</span>&nbsp;<span class="ident" id="8195321">err</span><span class="op" id="8195324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195328">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195334">for</span>&nbsp;<span class="ident" id="8195338">_</span><span class="op" id="8195339">,</span>&nbsp;<span class="ident" id="8195341">c</span>&nbsp;<span class="op" id="8195343">:=</span>&nbsp;<span class="keyword" id="8195346">range</span>&nbsp;<span class="ident" id="8195352">toClose</span>&nbsp;<span class="op" id="8195360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195364">c</span><span class="op" id="8195365">.</span><span class="ident" id="8195366">Close</span><span class="op" id="8195371">(</span><span class="op" id="8195372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195378">for</span>&nbsp;<span class="ident" id="8195382">i</span>&nbsp;<span class="op" id="8195384">:=</span>&nbsp;<span class="num" id="8195387">0</span><span class="op" id="8195388">;</span>&nbsp;<span class="ident" id="8195390">i</span>&nbsp;<span class="op" id="8195392">&lt;</span>&nbsp;<span class="num" id="8195394">100</span><span class="op" id="8195397">;</span>&nbsp;<span class="ident" id="8195399">i</span><span class="op" id="8195400">++</span>&nbsp;<span class="op" id="8195403">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195407">if</span>&nbsp;<span class="ident" id="8195410">got</span>&nbsp;<span class="op" id="8195414">:=</span>&nbsp;<span class="ident" id="8195417">numFD</span><span class="op" id="8195422">(</span><span class="op" id="8195423">)</span><span class="op" id="8195424">;</span>&nbsp;<span class="ident" id="8195426">got</span>&nbsp;<span class="op" id="8195430">&lt;</span>&nbsp;<span class="ident" id="8195432">dials</span>&nbsp;<span class="op" id="8195438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8195443">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195462">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195475">time</span><span class="op" id="8195479">.</span><span class="ident" id="8195480">Sleep</span><span class="op" id="8195485">(</span><span class="num" id="8195486">10</span>&nbsp;<span class="op" id="8195489">*</span>&nbsp;<span class="ident" id="8195491">time</span><span class="op" id="8195495">.</span><span class="ident" id="8195496">Millisecond</span><span class="op" id="8195507">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195513">if</span>&nbsp;<span class="ident" id="8195516">got</span>&nbsp;<span class="op" id="8195520">:=</span>&nbsp;<span class="ident" id="8195523">numFD</span><span class="op" id="8195528">(</span><span class="op" id="8195529">)</span><span class="op" id="8195530">;</span>&nbsp;<span class="ident" id="8195532">got</span>&nbsp;<span class="op" id="8195536">&gt;=</span>&nbsp;<span class="ident" id="8195539">dials</span>&nbsp;<span class="op" id="8195545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195549">t</span><span class="op" id="8195550">.</span><span class="ident" id="8195551">Errorf</span><span class="op" id="8195557">(</span><span class="string" id="8195558">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="8195600">,</span>&nbsp;<span class="ident" id="8195602">dials</span><span class="op" id="8195607">,</span>&nbsp;<span class="ident" id="8195609">got</span><span class="op" id="8195612">,</span>&nbsp;<span class="ident" id="8195614">dials</span><span class="op" id="8195619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195622">}</span><br>
<span class="lineno"></span><span class="op" id="8195624">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="8195627">func</span>&nbsp;<span class="ident" id="8195632">numTCP</span><span class="op" id="8195638">(</span><span class="op" id="8195639">)</span>&nbsp;<span class="op" id="8195641">(</span><span class="ident" id="8195642">ntcp</span><span class="op" id="8195646">,</span>&nbsp;<span class="ident" id="8195648">nopen</span><span class="op" id="8195653">,</span>&nbsp;<span class="ident" id="8195655">nclose</span>&nbsp;<span class="builtintype" id="8195662">int</span><span class="op" id="8195665">,</span>&nbsp;<span class="ident" id="8195667">err</span>&nbsp;<span class="builtintype" id="8195671">error</span><span class="op" id="8195676">)</span>&nbsp;<span class="op" id="8195678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195681">lsof</span><span class="op" id="8195685">,</span>&nbsp;<span class="ident" id="8195687">err</span>&nbsp;<span class="op" id="8195691">:=</span>&nbsp;<span class="ident" id="8195694">exec</span><span class="op" id="8195698">.</span><span class="ident" id="8195699">Command</span><span class="op" id="8195706">(</span><span class="string" id="8195707">&#34;lsof&#34;</span><span class="op" id="8195713">,</span>&nbsp;<span class="string" id="8195715">&#34;-n&#34;</span><span class="op" id="8195719">,</span>&nbsp;<span class="string" id="8195721">&#34;-p&#34;</span><span class="op" id="8195725">,</span>&nbsp;<span class="ident" id="8195727">strconv</span><span class="op" id="8195734">.</span><span class="ident" id="8195735">Itoa</span><span class="op" id="8195739">(</span><span class="ident" id="8195740">os</span><span class="op" id="8195742">.</span><span class="ident" id="8195743">Getpid</span><span class="op" id="8195749">(</span><span class="op" id="8195750">)</span><span class="op" id="8195751">)</span><span class="op" id="8195752">)</span><span class="op" id="8195753">.</span><span class="ident" id="8195754">Output</span><span class="op" id="8195760">(</span><span class="op" id="8195761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195764">if</span>&nbsp;<span class="ident" id="8195767">err</span>&nbsp;<span class="op" id="8195771">!=</span>&nbsp;<span class="ident" id="8195774">nil</span>&nbsp;<span class="op" id="8195778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195782">return</span>&nbsp;<span class="num" id="8195789">0</span><span class="op" id="8195790">,</span>&nbsp;<span class="num" id="8195792">0</span><span class="op" id="8195793">,</span>&nbsp;<span class="num" id="8195795">0</span><span class="op" id="8195796">,</span>&nbsp;<span class="ident" id="8195798">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195806">ntcp</span>&nbsp;<span class="op" id="8195811">+=</span>&nbsp;<span class="ident" id="8195814">bytes</span><span class="op" id="8195819">.</span><span class="ident" id="8195820">Count</span><span class="op" id="8195825">(</span><span class="ident" id="8195826">lsof</span><span class="op" id="8195830">,</span>&nbsp;<span class="op" id="8195832">[</span><span class="op" id="8195833">]</span><span class="builtintype" id="8195834">byte</span><span class="op" id="8195838">(</span><span class="string" id="8195839">&#34;TCP&#34;</span><span class="op" id="8195844">)</span><span class="op" id="8195845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195848">for</span>&nbsp;<span class="ident" id="8195852">_</span><span class="op" id="8195853">,</span>&nbsp;<span class="ident" id="8195855">state</span>&nbsp;<span class="op" id="8195861">:=</span>&nbsp;<span class="keyword" id="8195864">range</span>&nbsp;<span class="op" id="8195870">[</span><span class="op" id="8195871">]</span><span class="builtintype" id="8195872">string</span><span class="op" id="8195878">{</span><span class="string" id="8195879">&#34;LISTEN&#34;</span><span class="op" id="8195887">,</span>&nbsp;<span class="string" id="8195889">&#34;SYN_SENT&#34;</span><span class="op" id="8195899">,</span>&nbsp;<span class="string" id="8195901">&#34;SYN_RECEIVED&#34;</span><span class="op" id="8195915">,</span>&nbsp;<span class="string" id="8195917">&#34;ESTABLISHED&#34;</span><span class="op" id="8195930">}</span>&nbsp;<span class="op" id="8195932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195936">nopen</span>&nbsp;<span class="op" id="8195942">+=</span>&nbsp;<span class="ident" id="8195945">bytes</span><span class="op" id="8195950">.</span><span class="ident" id="8195951">Count</span><span class="op" id="8195956">(</span><span class="ident" id="8195957">lsof</span><span class="op" id="8195961">,</span>&nbsp;<span class="op" id="8195963">[</span><span class="op" id="8195964">]</span><span class="builtintype" id="8195965">byte</span><span class="op" id="8195969">(</span><span class="ident" id="8195970">state</span><span class="op" id="8195975">)</span><span class="op" id="8195976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195979">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195982">for</span>&nbsp;<span class="ident" id="8195986">_</span><span class="op" id="8195987">,</span>&nbsp;<span class="ident" id="8195989">state</span>&nbsp;<span class="op" id="8195995">:=</span>&nbsp;<span class="keyword" id="8195998">range</span>&nbsp;<span class="op" id="8196004">[</span><span class="op" id="8196005">]</span><span class="builtintype" id="8196006">string</span><span class="op" id="8196012">{</span><span class="string" id="8196013">&#34;CLOSED&#34;</span><span class="op" id="8196021">,</span>&nbsp;<span class="string" id="8196023">&#34;CLOSE_WAIT&#34;</span><span class="op" id="8196035">,</span>&nbsp;<span class="string" id="8196037">&#34;LAST_ACK&#34;</span><span class="op" id="8196047">,</span>&nbsp;<span class="string" id="8196049">&#34;FIN_WAIT_1&#34;</span><span class="op" id="8196061">,</span>&nbsp;<span class="string" id="8196063">&#34;FIN_WAIT_2&#34;</span><span class="op" id="8196075">,</span>&nbsp;<span class="string" id="8196077">&#34;CLOSING&#34;</span><span class="op" id="8196086">,</span>&nbsp;<span class="string" id="8196088">&#34;TIME_WAIT&#34;</span><span class="op" id="8196099">}</span>&nbsp;<span class="op" id="8196101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8196105">nclose</span>&nbsp;<span class="op" id="8196112">+=</span>&nbsp;<span class="ident" id="8196115">bytes</span><span class="op" id="8196120">.</span><span class="ident" id="8196121">Count</span><span class="op" id="8196126">(</span><span class="ident" id="8196127">lsof</span><span class="op" id="8196131">,</span>&nbsp;<span class="op" id="8196133">[</span><span class="op" id="8196134">]</span><span class="builtintype" id="8196135">byte</span><span class="op" id="8196139">(</span><span class="ident" id="8196140">state</span><span class="op" id="8196145">)</span><span class="op" id="8196146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8196149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8196152">return</span>&nbsp;<span class="ident" id="8196159">ntcp</span><span class="op" id="8196163">,</span>&nbsp;<span class="ident" id="8196165">nopen</span><span class="op" id="8196170">,</span>&nbsp;<span class="ident" id="8196172">nclose</span><span class="op" id="8196178">,</span>&nbsp;<span class="ident" id="8196180">nil</span><br>
<span class="lineno"></span><span class="op" id="8196184">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="8196187">func</span>&nbsp;<span class="ident" id="8196192">TestDialMultiFDLeak</span><span class="op" id="8196211">(</span><span class="ident" id="8196212">t</span>&nbsp;<span class="op" id="8196214">*</span><span class="ident" id="8196215">testing</span><span class="op" id="8196222">.</span><span class="ident" id="8196223">T</span><span class="op" id="8196224">)</span>&nbsp;<span class="op" id="8196226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8196229">t</span><span class="op" id="8196230">.</span><span class="ident" id="8196231">Skip</span><span class="op" id="8196235">(</span><span class="string" id="8196236">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="8196272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8196276">if</span>&nbsp;<span class="op" id="8196279">!</span><span class="ident" id="8196280">supportsIPv4</span>&nbsp;<span class="op" id="8196293">||</span>&nbsp;<span class="op" id="8196296">!</span><span class="ident" id="8196297">supportsIPv6</span>&nbsp;<span class="op" id="8196310">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8196314">t</span><span class="op" id="8196315">.</span><span class="ident" id="8196316">Skip</span><span class="op" id="8196320">(</span><span class="string" id="8196321">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="8196357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8196360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8196364">halfDeadServer</span>&nbsp;<span class="op" id="8196379">:=</span>&nbsp;<span class="keyword" id="8196382">func</span><span class="op" id="8196386">(</span><span class="ident" id="8196387">dss</span>&nbsp;<span class="op" id="8196391">*</span><span class="ident" id="8196392">dualStackServer</span><span class="op" id="8196407">,</span>&nbsp;<span class="ident" id="8196409">ln</span>&nbsp;<span class="ident" id="8196412">Listener</span><span class="op" id="8196420">)</span>&nbsp;<span class="op" id="8196422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8196426">for</span>&nbsp;<span class="op" id="8196430">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8196435">if</span>&nbsp;<span class="ident" id="8196438">c</span><span class="op" id="8196439">,</span>&nbsp;<span class="ident" id="8196441">err</span>&nbsp;<span class="op" id="8196445">:=</span>&nbsp;<span class="ident" id="8196448">ln</span><span class="op" id="8196450">.</span><span class="ident" id="8196451">Accept</span><span class="op" id="8196457">(</span><span class="op" id="8196458">)</span><span class="op" id="8196459">;</span>&nbsp;<span class="ident" id="8196461">err</span>&nbsp;<span class="op" id="8196465">!=</span>&nbsp;<span class="ident" id="8196468">nil</span>&nbsp;<span class="op" id="8196472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8196478">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8196488">}</span>&nbsp;<span class="keyword" id="8196490">else</span>&nbsp;<span class="op" id="8196495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8196501">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8196534">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8196577">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8196590">dss</span><span class="op" id="8196593">.</span><span class="ident" id="8196594">putConn</span><span class="op" id="8196601">(</span><span class="ident" id="8196602">c</span><span class="op" id="8196603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8196608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8196612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8196615">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8196618">dss</span><span class="op" id="8196621">,</span>&nbsp;<span class="ident" id="8196623">err</span>&nbsp;<span class="op" id="8196627">:=</span>&nbsp;<span class="ident" id="8196630">newDualStackServer</span><span class="op" id="8196648">(</span><span class="op" id="8196649">[</span><span class="op" id="8196650">]</span><span class="ident" id="8196651">streamListener</span><span class="op" id="8196665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8196669">{</span><span class="ident" id="8196670">net</span><span class="op" id="8196673">:</span>&nbsp;<span class="string" id="8196675">&#34;tcp4&#34;</span><span class="op" id="8196681">,</span>&nbsp;<span class="ident" id="8196683">addr</span><span class="op" id="8196687">:</span>&nbsp;<span class="string" id="8196689">&#34;127.0.0.1&#34;</span><span class="op" id="8196700">}</span><span class="op" id="8196701">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8196705">{</span><span class="ident" id="8196706">net</span><span class="op" id="8196709">:</span>&nbsp;<span class="string" id="8196711">&#34;tcp6&#34;</span><span class="op" id="8196717">,</span>&nbsp;<span class="ident" id="8196719">addr</span><span class="op" id="8196723">:</span>&nbsp;<span class="string" id="8196725">&#34;[::1]&#34;</span><span class="op" id="8196732">}</span><span class="op" id="8196733">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8196736">}</span><span class="op" id="8196737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8196740">if</span>&nbsp;<span class="ident" id="8196743">err</span>&nbsp;<span class="op" id="8196747">!=</span>&nbsp;<span class="ident" id="8196750">nil</span>&nbsp;<span class="op" id="8196754">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8196758">t</span><span class="op" id="8196759">.</span><span class="ident" id="8196760">Fatalf</span><span class="op" id="8196766">(</span><span class="string" id="8196767">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8196798">,</span>&nbsp;<span class="ident" id="8196800">err</span><span class="op" id="8196803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8196806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8196809">defer</span>&nbsp;<span class="ident" id="8196815">dss</span><span class="op" id="8196818">.</span><span class="ident" id="8196819">teardown</span><span class="op" id="8196827">(</span><span class="op" id="8196828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8196831">if</span>&nbsp;<span class="ident" id="8196834">err</span>&nbsp;<span class="op" id="8196838">:=</span>&nbsp;<span class="ident" id="8196841">dss</span><span class="op" id="8196844">.</span><span class="ident" id="8196845">buildup</span><span class="op" id="8196852">(</span><span class="ident" id="8196853">halfDeadServer</span><span class="op" id="8196867">)</span><span class="op" id="8196868">;</span>&nbsp;<span class="ident" id="8196870">err</span>&nbsp;<span class="op" id="8196874">!=</span>&nbsp;<span class="ident" id="8196877">nil</span>&nbsp;<span class="op" id="8196881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8196885">t</span><span class="op" id="8196886">.</span><span class="ident" id="8196887">Fatalf</span><span class="op" id="8196893">(</span><span class="string" id="8196894">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8196930">,</span>&nbsp;<span class="ident" id="8196932">err</span><span class="op" id="8196935">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8196938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8196942">_</span><span class="op" id="8196943">,</span>&nbsp;<span class="ident" id="8196945">before</span><span class="op" id="8196951">,</span>&nbsp;<span class="ident" id="8196953">_</span><span class="op" id="8196954">,</span>&nbsp;<span class="ident" id="8196956">err</span>&nbsp;<span class="op" id="8196960">:=</span>&nbsp;<span class="ident" id="8196963">numTCP</span><span class="op" id="8196969">(</span><span class="op" id="8196970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8196973">if</span>&nbsp;<span class="ident" id="8196976">err</span>&nbsp;<span class="op" id="8196980">!=</span>&nbsp;<span class="ident" id="8196983">nil</span>&nbsp;<span class="op" id="8196987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8196991">t</span><span class="op" id="8196992">.</span><span class="ident" id="8196993">Skipf</span><span class="op" id="8196998">(</span><span class="string" id="8196999">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="8197049">,</span>&nbsp;<span class="ident" id="8197051">err</span><span class="op" id="8197054">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8197057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8197061">var</span>&nbsp;<span class="ident" id="8197065">wg</span>&nbsp;<span class="ident" id="8197068">sync</span><span class="op" id="8197072">.</span><span class="ident" id="8197073">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8197084">portnum</span><span class="op" id="8197091">,</span>&nbsp;<span class="ident" id="8197093">_</span><span class="op" id="8197094">,</span>&nbsp;<span class="ident" id="8197096">_</span>&nbsp;<span class="op" id="8197098">:=</span>&nbsp;<span class="ident" id="8197101">dtoi</span><span class="op" id="8197105">(</span><span class="ident" id="8197106">dss</span><span class="op" id="8197109">.</span><span class="ident" id="8197110">port</span><span class="op" id="8197114">,</span>&nbsp;<span class="num" id="8197116">0</span><span class="op" id="8197117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8197120">ras</span>&nbsp;<span class="op" id="8197124">:=</span>&nbsp;<span class="ident" id="8197127">addrList</span><span class="op" id="8197135">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8197139">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8197192">&amp;</span><span class="ident" id="8197193">TCPAddr</span><span class="op" id="8197200">{</span><span class="ident" id="8197201">IP</span><span class="op" id="8197203">:</span>&nbsp;<span class="ident" id="8197205">IPv4</span><span class="op" id="8197209">(</span><span class="num" id="8197210">198</span><span class="op" id="8197213">,</span>&nbsp;<span class="num" id="8197215">18</span><span class="op" id="8197217">,</span>&nbsp;<span class="num" id="8197219">0</span><span class="op" id="8197220">,</span>&nbsp;<span class="num" id="8197222">254</span><span class="op" id="8197225">)</span><span class="op" id="8197226">,</span>&nbsp;<span class="ident" id="8197228">Port</span><span class="op" id="8197232">:</span>&nbsp;<span class="ident" id="8197234">portnum</span><span class="op" id="8197241">}</span><span class="op" id="8197242">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8197246">&amp;</span><span class="ident" id="8197247">TCPAddr</span><span class="op" id="8197254">{</span><span class="ident" id="8197255">IP</span><span class="op" id="8197257">:</span>&nbsp;<span class="ident" id="8197259">ParseIP</span><span class="op" id="8197266">(</span><span class="string" id="8197267">&#34;2001:2::254&#34;</span><span class="op" id="8197280">)</span><span class="op" id="8197281">,</span>&nbsp;<span class="ident" id="8197283">Port</span><span class="op" id="8197287">:</span>&nbsp;<span class="ident" id="8197289">portnum</span><span class="op" id="8197296">}</span><span class="op" id="8197297">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8197302">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8197339">&amp;</span><span class="ident" id="8197340">TCPAddr</span><span class="op" id="8197347">{</span><span class="ident" id="8197348">IP</span><span class="op" id="8197350">:</span>&nbsp;<span class="ident" id="8197352">IPv4</span><span class="op" id="8197356">(</span><span class="num" id="8197357">127</span><span class="op" id="8197360">,</span>&nbsp;<span class="num" id="8197362">0</span><span class="op" id="8197363">,</span>&nbsp;<span class="num" id="8197365">0</span><span class="op" id="8197366">,</span>&nbsp;<span class="num" id="8197368">1</span><span class="op" id="8197369">)</span><span class="op" id="8197370">,</span>&nbsp;<span class="ident" id="8197372">Port</span><span class="op" id="8197376">:</span>&nbsp;<span class="ident" id="8197378">portnum</span><span class="op" id="8197385">}</span><span class="op" id="8197386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8197390">&amp;</span><span class="ident" id="8197391">TCPAddr</span><span class="op" id="8197398">{</span><span class="ident" id="8197399">IP</span><span class="op" id="8197401">:</span>&nbsp;<span class="ident" id="8197403">IPv6loopback</span><span class="op" id="8197415">,</span>&nbsp;<span class="ident" id="8197417">Port</span><span class="op" id="8197421">:</span>&nbsp;<span class="ident" id="8197423">portnum</span><span class="op" id="8197430">}</span><span class="op" id="8197431">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8197436">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8197488">&amp;</span><span class="ident" id="8197489">TCPAddr</span><span class="op" id="8197496">{</span><span class="ident" id="8197497">IP</span><span class="op" id="8197499">:</span>&nbsp;<span class="ident" id="8197501">IPv4</span><span class="op" id="8197505">(</span><span class="num" id="8197506">127</span><span class="op" id="8197509">,</span>&nbsp;<span class="num" id="8197511">0</span><span class="op" id="8197512">,</span>&nbsp;<span class="num" id="8197514">0</span><span class="op" id="8197515">,</span>&nbsp;<span class="num" id="8197517">1</span><span class="op" id="8197518">)</span><span class="op" id="8197519">,</span>&nbsp;<span class="ident" id="8197521">Port</span><span class="op" id="8197525">:</span>&nbsp;<span class="ident" id="8197527">portnum</span><span class="op" id="8197534">}</span><span class="op" id="8197535">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8197539">&amp;</span><span class="ident" id="8197540">TCPAddr</span><span class="op" id="8197547">{</span><span class="ident" id="8197548">IP</span><span class="op" id="8197550">:</span>&nbsp;<span class="ident" id="8197552">IPv6loopback</span><span class="op" id="8197564">,</span>&nbsp;<span class="ident" id="8197566">Port</span><span class="op" id="8197570">:</span>&nbsp;<span class="ident" id="8197572">portnum</span><span class="op" id="8197579">}</span><span class="op" id="8197580">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8197583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8197586">const</span>&nbsp;<span class="ident" id="8197592">T1</span>&nbsp;<span class="op" id="8197595">=</span>&nbsp;<span class="num" id="8197597">10</span>&nbsp;<span class="op" id="8197600">*</span>&nbsp;<span class="ident" id="8197602">time</span><span class="op" id="8197606">.</span><span class="ident" id="8197607">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8197620">const</span>&nbsp;<span class="ident" id="8197626">T2</span>&nbsp;<span class="op" id="8197629">=</span>&nbsp;<span class="num" id="8197631">2</span>&nbsp;<span class="op" id="8197633">*</span>&nbsp;<span class="ident" id="8197635">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8197639">const</span>&nbsp;<span class="ident" id="8197645">N</span>&nbsp;<span class="op" id="8197647">=</span>&nbsp;<span class="num" id="8197649">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8197653">for</span>&nbsp;<span class="ident" id="8197657">i</span>&nbsp;<span class="op" id="8197659">:=</span>&nbsp;<span class="num" id="8197662">0</span><span class="op" id="8197663">;</span>&nbsp;<span class="ident" id="8197665">i</span>&nbsp;<span class="op" id="8197667">&lt;</span>&nbsp;<span class="ident" id="8197669">N</span><span class="op" id="8197670">;</span>&nbsp;<span class="ident" id="8197672">i</span><span class="op" id="8197673">++</span>&nbsp;<span class="op" id="8197676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8197680">wg</span><span class="op" id="8197682">.</span><span class="ident" id="8197683">Add</span><span class="op" id="8197686">(</span><span class="num" id="8197687">1</span><span class="op" id="8197688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8197692">go</span>&nbsp;<span class="keyword" id="8197695">func</span><span class="op" id="8197699">(</span><span class="op" id="8197700">)</span>&nbsp;<span class="op" id="8197702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8197707">defer</span>&nbsp;<span class="ident" id="8197713">wg</span><span class="op" id="8197715">.</span><span class="ident" id="8197716">Done</span><span class="op" id="8197720">(</span><span class="op" id="8197721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8197726">if</span>&nbsp;<span class="ident" id="8197729">c</span><span class="op" id="8197730">,</span>&nbsp;<span class="ident" id="8197732">err</span>&nbsp;<span class="op" id="8197736">:=</span>&nbsp;<span class="ident" id="8197739">dialMulti</span><span class="op" id="8197748">(</span><span class="string" id="8197749">&#34;tcp&#34;</span><span class="op" id="8197754">,</span>&nbsp;<span class="string" id="8197756">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="8197776">,</span>&nbsp;<span class="ident" id="8197778">nil</span><span class="op" id="8197781">,</span>&nbsp;<span class="ident" id="8197783">ras</span><span class="op" id="8197786">,</span>&nbsp;<span class="ident" id="8197788">time</span><span class="op" id="8197792">.</span><span class="ident" id="8197793">Now</span><span class="op" id="8197796">(</span><span class="op" id="8197797">)</span><span class="op" id="8197798">.</span><span class="ident" id="8197799">Add</span><span class="op" id="8197802">(</span><span class="ident" id="8197803">T1</span><span class="op" id="8197805">)</span><span class="op" id="8197806">)</span><span class="op" id="8197807">;</span>&nbsp;<span class="ident" id="8197809">err</span>&nbsp;<span class="op" id="8197813">==</span>&nbsp;<span class="ident" id="8197816">nil</span>&nbsp;<span class="op" id="8197820">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8197826">c</span><span class="op" id="8197827">.</span><span class="ident" id="8197828">Close</span><span class="op" id="8197833">(</span><span class="op" id="8197834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8197839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8197843">}</span><span class="op" id="8197844">(</span><span class="op" id="8197845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8197848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8197851">wg</span><span class="op" id="8197853">.</span><span class="ident" id="8197854">Wait</span><span class="op" id="8197858">(</span><span class="op" id="8197859">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8197862">time</span><span class="op" id="8197866">.</span><span class="ident" id="8197867">Sleep</span><span class="op" id="8197872">(</span><span class="ident" id="8197873">T2</span><span class="op" id="8197875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8197879">ntcp</span><span class="op" id="8197883">,</span>&nbsp;<span class="ident" id="8197885">after</span><span class="op" id="8197890">,</span>&nbsp;<span class="ident" id="8197892">nclose</span><span class="op" id="8197898">,</span>&nbsp;<span class="ident" id="8197900">err</span>&nbsp;<span class="op" id="8197904">:=</span>&nbsp;<span class="ident" id="8197907">numTCP</span><span class="op" id="8197913">(</span><span class="op" id="8197914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8197917">if</span>&nbsp;<span class="ident" id="8197920">err</span>&nbsp;<span class="op" id="8197924">!=</span>&nbsp;<span class="ident" id="8197927">nil</span>&nbsp;<span class="op" id="8197931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8197935">t</span><span class="op" id="8197936">.</span><span class="ident" id="8197937">Skipf</span><span class="op" id="8197942">(</span><span class="string" id="8197943">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="8197993">,</span>&nbsp;<span class="ident" id="8197995">err</span><span class="op" id="8197998">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8198001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198004">t</span><span class="op" id="8198005">.</span><span class="ident" id="8198006">Logf</span><span class="op" id="8198010">(</span><span class="string" id="8198011">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="8198070">,</span>&nbsp;<span class="ident" id="8198072">ntcp</span><span class="op" id="8198076">,</span>&nbsp;<span class="ident" id="8198078">after</span><span class="op" id="8198083">,</span>&nbsp;<span class="ident" id="8198085">nclose</span><span class="op" id="8198091">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198095">if</span>&nbsp;<span class="ident" id="8198098">after</span>&nbsp;<span class="op" id="8198104">!=</span>&nbsp;<span class="ident" id="8198107">before</span>&nbsp;<span class="op" id="8198114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198118">t</span><span class="op" id="8198119">.</span><span class="ident" id="8198120">Fatalf</span><span class="op" id="8198126">(</span><span class="string" id="8198127">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="8198162">,</span>&nbsp;<span class="ident" id="8198164">after</span><span class="op" id="8198169">,</span>&nbsp;<span class="ident" id="8198171">before</span><span class="op" id="8198177">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8198180">}</span><br>
<span class="lineno"></span><span class="op" id="8198182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8198185">func</span>&nbsp;<span class="ident" id="8198190">numFD</span><span class="op" id="8198195">(</span><span class="op" id="8198196">)</span>&nbsp;<span class="builtintype" id="8198198">int</span>&nbsp;<span class="op" id="8198202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198205">if</span>&nbsp;<span class="ident" id="8198208">runtime</span><span class="op" id="8198215">.</span><span class="ident" id="8198216">GOOS</span>&nbsp;<span class="op" id="8198221">==</span>&nbsp;<span class="string" id="8198224">&#34;linux&#34;</span>&nbsp;<span class="op" id="8198232">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198236">f</span><span class="op" id="8198237">,</span>&nbsp;<span class="ident" id="8198239">err</span>&nbsp;<span class="op" id="8198243">:=</span>&nbsp;<span class="ident" id="8198246">os</span><span class="op" id="8198248">.</span><span class="ident" id="8198249">Open</span><span class="op" id="8198253">(</span><span class="string" id="8198254">&#34;/proc/self/fd&#34;</span><span class="op" id="8198269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198273">if</span>&nbsp;<span class="ident" id="8198276">err</span>&nbsp;<span class="op" id="8198280">!=</span>&nbsp;<span class="ident" id="8198283">nil</span>&nbsp;<span class="op" id="8198287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8198292">panic</span><span class="op" id="8198297">(</span><span class="ident" id="8198298">err</span><span class="op" id="8198301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8198305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198309">defer</span>&nbsp;<span class="ident" id="8198315">f</span><span class="op" id="8198316">.</span><span class="ident" id="8198317">Close</span><span class="op" id="8198322">(</span><span class="op" id="8198323">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198327">names</span><span class="op" id="8198332">,</span>&nbsp;<span class="ident" id="8198334">err</span>&nbsp;<span class="op" id="8198338">:=</span>&nbsp;<span class="ident" id="8198341">f</span><span class="op" id="8198342">.</span><span class="ident" id="8198343">Readdirnames</span><span class="op" id="8198355">(</span><span class="num" id="8198356">0</span><span class="op" id="8198357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198361">if</span>&nbsp;<span class="ident" id="8198364">err</span>&nbsp;<span class="op" id="8198368">!=</span>&nbsp;<span class="ident" id="8198371">nil</span>&nbsp;<span class="op" id="8198375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8198380">panic</span><span class="op" id="8198385">(</span><span class="ident" id="8198386">err</span><span class="op" id="8198389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8198393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198397">return</span>&nbsp;<span class="builtinfunc" id="8198404">len</span><span class="op" id="8198407">(</span><span class="ident" id="8198408">names</span><span class="op" id="8198413">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8198416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8198419">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8198475">panic</span><span class="op" id="8198480">(</span><span class="string" id="8198481">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="8198510">+</span>&nbsp;<span class="ident" id="8198512">runtime</span><span class="op" id="8198519">.</span><span class="ident" id="8198520">GOOS</span><span class="op" id="8198524">)</span><br>
<span class="lineno"></span><span class="op" id="8198526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="8198529">func</span>&nbsp;<span class="ident" id="8198534">TestDialer</span><span class="op" id="8198544">(</span><span class="ident" id="8198545">t</span>&nbsp;<span class="op" id="8198547">*</span><span class="ident" id="8198548">testing</span><span class="op" id="8198555">.</span><span class="ident" id="8198556">T</span><span class="op" id="8198557">)</span>&nbsp;<span class="op" id="8198559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198562">ln</span><span class="op" id="8198564">,</span>&nbsp;<span class="ident" id="8198566">err</span>&nbsp;<span class="op" id="8198570">:=</span>&nbsp;<span class="ident" id="8198573">Listen</span><span class="op" id="8198579">(</span><span class="string" id="8198580">&#34;tcp4&#34;</span><span class="op" id="8198586">,</span>&nbsp;<span class="string" id="8198588">&#34;127.0.0.1:0&#34;</span><span class="op" id="8198601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198604">if</span>&nbsp;<span class="ident" id="8198607">err</span>&nbsp;<span class="op" id="8198611">!=</span>&nbsp;<span class="ident" id="8198614">nil</span>&nbsp;<span class="op" id="8198618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198622">t</span><span class="op" id="8198623">.</span><span class="ident" id="8198624">Fatalf</span><span class="op" id="8198630">(</span><span class="string" id="8198631">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8198650">,</span>&nbsp;<span class="ident" id="8198652">err</span><span class="op" id="8198655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8198658">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198661">defer</span>&nbsp;<span class="ident" id="8198667">ln</span><span class="op" id="8198669">.</span><span class="ident" id="8198670">Close</span><span class="op" id="8198675">(</span><span class="op" id="8198676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198679">ch</span>&nbsp;<span class="op" id="8198682">:=</span>&nbsp;<span class="builtinfunc" id="8198685">make</span><span class="op" id="8198689">(</span><span class="keyword" id="8198690">chan</span>&nbsp;<span class="builtintype" id="8198695">error</span><span class="op" id="8198700">,</span>&nbsp;<span class="num" id="8198702">1</span><span class="op" id="8198703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198706">go</span>&nbsp;<span class="keyword" id="8198709">func</span><span class="op" id="8198713">(</span><span class="op" id="8198714">)</span>&nbsp;<span class="op" id="8198716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198720">c</span><span class="op" id="8198721">,</span>&nbsp;<span class="ident" id="8198723">err</span>&nbsp;<span class="op" id="8198727">:=</span>&nbsp;<span class="ident" id="8198730">ln</span><span class="op" id="8198732">.</span><span class="ident" id="8198733">Accept</span><span class="op" id="8198739">(</span><span class="op" id="8198740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198744">if</span>&nbsp;<span class="ident" id="8198747">err</span>&nbsp;<span class="op" id="8198751">!=</span>&nbsp;<span class="ident" id="8198754">nil</span>&nbsp;<span class="op" id="8198758">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198763">ch</span>&nbsp;<span class="op" id="8198766">&lt;-</span>&nbsp;<span class="ident" id="8198769">fmt</span><span class="op" id="8198772">.</span><span class="ident" id="8198773">Errorf</span><span class="op" id="8198779">(</span><span class="string" id="8198780">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8198799">,</span>&nbsp;<span class="ident" id="8198801">err</span><span class="op" id="8198804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198809">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8198818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198822">defer</span>&nbsp;<span class="ident" id="8198828">c</span><span class="op" id="8198829">.</span><span class="ident" id="8198830">Close</span><span class="op" id="8198835">(</span><span class="op" id="8198836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198840">ch</span>&nbsp;<span class="op" id="8198843">&lt;-</span>&nbsp;<span class="ident" id="8198846">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8198851">}</span><span class="op" id="8198852">(</span><span class="op" id="8198853">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198857">laddr</span><span class="op" id="8198862">,</span>&nbsp;<span class="ident" id="8198864">err</span>&nbsp;<span class="op" id="8198868">:=</span>&nbsp;<span class="ident" id="8198871">ResolveTCPAddr</span><span class="op" id="8198885">(</span><span class="string" id="8198886">&#34;tcp4&#34;</span><span class="op" id="8198892">,</span>&nbsp;<span class="string" id="8198894">&#34;127.0.0.1:0&#34;</span><span class="op" id="8198907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8198910">if</span>&nbsp;<span class="ident" id="8198913">err</span>&nbsp;<span class="op" id="8198917">!=</span>&nbsp;<span class="ident" id="8198920">nil</span>&nbsp;<span class="op" id="8198924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198928">t</span><span class="op" id="8198929">.</span><span class="ident" id="8198930">Fatalf</span><span class="op" id="8198936">(</span><span class="string" id="8198937">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8198964">,</span>&nbsp;<span class="ident" id="8198966">err</span><span class="op" id="8198969">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8198972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8198975">d</span>&nbsp;<span class="op" id="8198977">:=</span>&nbsp;<span class="op" id="8198980">&amp;</span><span class="ident" id="8198981">Dialer</span><span class="op" id="8198987">{</span><span class="ident" id="8198988">LocalAddr</span><span class="op" id="8198997">:</span>&nbsp;<span class="ident" id="8198999">laddr</span><span class="op" id="8199004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199007">c</span><span class="op" id="8199008">,</span>&nbsp;<span class="ident" id="8199010">err</span>&nbsp;<span class="op" id="8199014">:=</span>&nbsp;<span class="ident" id="8199017">d</span><span class="op" id="8199018">.</span><span class="ident" id="8199019">Dial</span><span class="op" id="8199023">(</span><span class="string" id="8199024">&#34;tcp4&#34;</span><span class="op" id="8199030">,</span>&nbsp;<span class="ident" id="8199032">ln</span><span class="op" id="8199034">.</span><span class="ident" id="8199035">Addr</span><span class="op" id="8199039">(</span><span class="op" id="8199040">)</span><span class="op" id="8199041">.</span><span class="ident" id="8199042">String</span><span class="op" id="8199048">(</span><span class="op" id="8199049">)</span><span class="op" id="8199050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199053">if</span>&nbsp;<span class="ident" id="8199056">err</span>&nbsp;<span class="op" id="8199060">!=</span>&nbsp;<span class="ident" id="8199063">nil</span>&nbsp;<span class="op" id="8199067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199071">t</span><span class="op" id="8199072">.</span><span class="ident" id="8199073">Fatalf</span><span class="op" id="8199079">(</span><span class="string" id="8199080">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8199097">,</span>&nbsp;<span class="ident" id="8199099">err</span><span class="op" id="8199102">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199108">defer</span>&nbsp;<span class="ident" id="8199114">c</span><span class="op" id="8199115">.</span><span class="ident" id="8199116">Close</span><span class="op" id="8199121">(</span><span class="op" id="8199122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199125">c</span><span class="op" id="8199126">.</span><span class="ident" id="8199127">Read</span><span class="op" id="8199131">(</span><span class="builtinfunc" id="8199132">make</span><span class="op" id="8199136">(</span><span class="op" id="8199137">[</span><span class="op" id="8199138">]</span><span class="builtintype" id="8199139">byte</span><span class="op" id="8199143">,</span>&nbsp;<span class="num" id="8199145">1</span><span class="op" id="8199146">)</span><span class="op" id="8199147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199150">err</span>&nbsp;<span class="op" id="8199154">=</span>&nbsp;<span class="op" id="8199156">&lt;-</span><span class="ident" id="8199158">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199162">if</span>&nbsp;<span class="ident" id="8199165">err</span>&nbsp;<span class="op" id="8199169">!=</span>&nbsp;<span class="ident" id="8199172">nil</span>&nbsp;<span class="op" id="8199176">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199180">t</span><span class="op" id="8199181">.</span><span class="ident" id="8199182">Error</span><span class="op" id="8199187">(</span><span class="ident" id="8199188">err</span><span class="op" id="8199191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199194">}</span><br>
<span class="lineno"></span><span class="op" id="8199196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8199199">func</span>&nbsp;<span class="ident" id="8199204">TestDialDualStackLocalhost</span><span class="op" id="8199230">(</span><span class="ident" id="8199231">t</span>&nbsp;<span class="op" id="8199233">*</span><span class="ident" id="8199234">testing</span><span class="op" id="8199241">.</span><span class="ident" id="8199242">T</span><span class="op" id="8199243">)</span>&nbsp;<span class="op" id="8199245">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199248">switch</span>&nbsp;<span class="ident" id="8199255">runtime</span><span class="op" id="8199262">.</span><span class="ident" id="8199263">GOOS</span>&nbsp;<span class="op" id="8199268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199271">case</span>&nbsp;<span class="string" id="8199276">&#34;nacl&#34;</span><span class="op" id="8199282">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199286">t</span><span class="op" id="8199287">.</span><span class="ident" id="8199288">Skipf</span><span class="op" id="8199293">(</span><span class="string" id="8199294">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="8199315">,</span>&nbsp;<span class="ident" id="8199317">runtime</span><span class="op" id="8199324">.</span><span class="ident" id="8199325">GOOS</span><span class="op" id="8199329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199336">if</span>&nbsp;<span class="ident" id="8199339">ips</span><span class="op" id="8199342">,</span>&nbsp;<span class="ident" id="8199344">err</span>&nbsp;<span class="op" id="8199348">:=</span>&nbsp;<span class="ident" id="8199351">LookupIP</span><span class="op" id="8199359">(</span><span class="string" id="8199360">&#34;localhost&#34;</span><span class="op" id="8199371">)</span><span class="op" id="8199372">;</span>&nbsp;<span class="ident" id="8199374">err</span>&nbsp;<span class="op" id="8199378">!=</span>&nbsp;<span class="ident" id="8199381">nil</span>&nbsp;<span class="op" id="8199385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199389">t</span><span class="op" id="8199390">.</span><span class="ident" id="8199391">Fatalf</span><span class="op" id="8199397">(</span><span class="string" id="8199398">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8199419">,</span>&nbsp;<span class="ident" id="8199421">err</span><span class="op" id="8199424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199427">}</span>&nbsp;<span class="keyword" id="8199429">else</span>&nbsp;<span class="keyword" id="8199434">if</span>&nbsp;<span class="builtinfunc" id="8199437">len</span><span class="op" id="8199440">(</span><span class="ident" id="8199441">ips</span><span class="op" id="8199444">)</span>&nbsp;<span class="op" id="8199446">&lt;</span>&nbsp;<span class="num" id="8199448">2</span>&nbsp;<span class="op" id="8199450">||</span>&nbsp;<span class="op" id="8199453">!</span><span class="ident" id="8199454">supportsIPv4</span>&nbsp;<span class="op" id="8199467">||</span>&nbsp;<span class="op" id="8199470">!</span><span class="ident" id="8199471">supportsIPv6</span>&nbsp;<span class="op" id="8199484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199488">t</span><span class="op" id="8199489">.</span><span class="ident" id="8199490">Skip</span><span class="op" id="8199494">(</span><span class="string" id="8199495">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="8199567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199570">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199574">touchAndByeServer</span>&nbsp;<span class="op" id="8199592">:=</span>&nbsp;<span class="keyword" id="8199595">func</span><span class="op" id="8199599">(</span><span class="ident" id="8199600">dss</span>&nbsp;<span class="op" id="8199604">*</span><span class="ident" id="8199605">dualStackServer</span><span class="op" id="8199620">,</span>&nbsp;<span class="ident" id="8199622">ln</span>&nbsp;<span class="ident" id="8199625">Listener</span><span class="op" id="8199633">)</span>&nbsp;<span class="op" id="8199635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199639">for</span>&nbsp;<span class="op" id="8199643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199648">if</span>&nbsp;<span class="ident" id="8199651">c</span><span class="op" id="8199652">,</span>&nbsp;<span class="ident" id="8199654">err</span>&nbsp;<span class="op" id="8199658">:=</span>&nbsp;<span class="ident" id="8199661">ln</span><span class="op" id="8199663">.</span><span class="ident" id="8199664">Accept</span><span class="op" id="8199670">(</span><span class="op" id="8199671">)</span><span class="op" id="8199672">;</span>&nbsp;<span class="ident" id="8199674">err</span>&nbsp;<span class="op" id="8199678">!=</span>&nbsp;<span class="ident" id="8199681">nil</span>&nbsp;<span class="op" id="8199685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199691">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199701">}</span>&nbsp;<span class="keyword" id="8199703">else</span>&nbsp;<span class="op" id="8199708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199714">c</span><span class="op" id="8199715">.</span><span class="ident" id="8199716">Close</span><span class="op" id="8199721">(</span><span class="op" id="8199722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199734">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199737">dss</span><span class="op" id="8199740">,</span>&nbsp;<span class="ident" id="8199742">err</span>&nbsp;<span class="op" id="8199746">:=</span>&nbsp;<span class="ident" id="8199749">newDualStackServer</span><span class="op" id="8199767">(</span><span class="op" id="8199768">[</span><span class="op" id="8199769">]</span><span class="ident" id="8199770">streamListener</span><span class="op" id="8199784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199788">{</span><span class="ident" id="8199789">net</span><span class="op" id="8199792">:</span>&nbsp;<span class="string" id="8199794">&#34;tcp4&#34;</span><span class="op" id="8199800">,</span>&nbsp;<span class="ident" id="8199802">addr</span><span class="op" id="8199806">:</span>&nbsp;<span class="string" id="8199808">&#34;127.0.0.1&#34;</span><span class="op" id="8199819">}</span><span class="op" id="8199820">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199824">{</span><span class="ident" id="8199825">net</span><span class="op" id="8199828">:</span>&nbsp;<span class="string" id="8199830">&#34;tcp6&#34;</span><span class="op" id="8199836">,</span>&nbsp;<span class="ident" id="8199838">addr</span><span class="op" id="8199842">:</span>&nbsp;<span class="string" id="8199844">&#34;[::1]&#34;</span><span class="op" id="8199851">}</span><span class="op" id="8199852">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199855">}</span><span class="op" id="8199856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199859">if</span>&nbsp;<span class="ident" id="8199862">err</span>&nbsp;<span class="op" id="8199866">!=</span>&nbsp;<span class="ident" id="8199869">nil</span>&nbsp;<span class="op" id="8199873">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8199877">t</span><span class="op" id="8199878">.</span><span class="ident" id="8199879">Fatalf</span><span class="op" id="8199885">(</span><span class="string" id="8199886">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8199917">,</span>&nbsp;<span class="ident" id="8199919">err</span><span class="op" id="8199922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8199925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199928">defer</span>&nbsp;<span class="ident" id="8199934">dss</span><span class="op" id="8199937">.</span><span class="ident" id="8199938">teardown</span><span class="op" id="8199946">(</span><span class="op" id="8199947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8199950">if</span>&nbsp;<span class="ident" id="8199953">err</span>&nbsp;<span class="op" id="8199957">:=</span>&nbsp;<span class="ident" id="8199960">dss</span><span class="op" id="8199963">.</span><span class="ident" id="8199964">buildup</span><span class="op" id="8199971">(</span><span class="ident" id="8199972">touchAndByeServer</span><span class="op" id="8199989">)</span><span class="op" id="8199990">;</span>&nbsp;<span class="ident" id="8199992">err</span>&nbsp;<span class="op" id="8199996">!=</span>&nbsp;<span class="ident" id="8199999">nil</span>&nbsp;<span class="op" id="8200003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200007">t</span><span class="op" id="8200008">.</span><span class="ident" id="8200009">Fatalf</span><span class="op" id="8200015">(</span><span class="string" id="8200016">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8200052">,</span>&nbsp;<span class="ident" id="8200054">err</span><span class="op" id="8200057">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200064">d</span>&nbsp;<span class="op" id="8200066">:=</span>&nbsp;<span class="op" id="8200069">&amp;</span><span class="ident" id="8200070">Dialer</span><span class="op" id="8200076">{</span><span class="ident" id="8200077">DualStack</span><span class="op" id="8200086">:</span>&nbsp;<span class="builtintype" id="8200088">true</span><span class="op" id="8200092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200095">for</span>&nbsp;<span class="keyword" id="8200099">range</span>&nbsp;<span class="ident" id="8200105">dss</span><span class="op" id="8200108">.</span><span class="ident" id="8200109">lns</span>&nbsp;<span class="op" id="8200113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200117">if</span>&nbsp;<span class="ident" id="8200120">c</span><span class="op" id="8200121">,</span>&nbsp;<span class="ident" id="8200123">err</span>&nbsp;<span class="op" id="8200127">:=</span>&nbsp;<span class="ident" id="8200130">d</span><span class="op" id="8200131">.</span><span class="ident" id="8200132">Dial</span><span class="op" id="8200136">(</span><span class="string" id="8200137">&#34;tcp&#34;</span><span class="op" id="8200142">,</span>&nbsp;<span class="string" id="8200144">&#34;localhost:&#34;</span><span class="op" id="8200156">+</span><span class="ident" id="8200157">dss</span><span class="op" id="8200160">.</span><span class="ident" id="8200161">port</span><span class="op" id="8200165">)</span><span class="op" id="8200166">;</span>&nbsp;<span class="ident" id="8200168">err</span>&nbsp;<span class="op" id="8200172">!=</span>&nbsp;<span class="ident" id="8200175">nil</span>&nbsp;<span class="op" id="8200179">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200184">t</span><span class="op" id="8200185">.</span><span class="ident" id="8200186">Errorf</span><span class="op" id="8200192">(</span><span class="string" id="8200193">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8200210">,</span>&nbsp;<span class="ident" id="8200212">err</span><span class="op" id="8200215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200219">}</span>&nbsp;<span class="keyword" id="8200221">else</span>&nbsp;<span class="op" id="8200226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200231">if</span>&nbsp;<span class="ident" id="8200234">addr</span>&nbsp;<span class="op" id="8200239">:=</span>&nbsp;<span class="ident" id="8200242">c</span><span class="op" id="8200243">.</span><span class="ident" id="8200244">LocalAddr</span><span class="op" id="8200253">(</span><span class="op" id="8200254">)</span><span class="op" id="8200255">.</span><span class="op" id="8200256">(</span><span class="op" id="8200257">*</span><span class="ident" id="8200258">TCPAddr</span><span class="op" id="8200265">)</span><span class="op" id="8200266">;</span>&nbsp;<span class="ident" id="8200268">addr</span><span class="op" id="8200272">.</span><span class="ident" id="8200273">IP</span><span class="op" id="8200275">.</span><span class="ident" id="8200276">To4</span><span class="op" id="8200279">(</span><span class="op" id="8200280">)</span>&nbsp;<span class="op" id="8200282">!=</span>&nbsp;<span class="ident" id="8200285">nil</span>&nbsp;<span class="op" id="8200289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200295">dss</span><span class="op" id="8200298">.</span><span class="ident" id="8200299">teardownNetwork</span><span class="op" id="8200314">(</span><span class="string" id="8200315">&#34;tcp4&#34;</span><span class="op" id="8200321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200326">}</span>&nbsp;<span class="keyword" id="8200328">else</span>&nbsp;<span class="keyword" id="8200333">if</span>&nbsp;<span class="ident" id="8200336">addr</span><span class="op" id="8200340">.</span><span class="ident" id="8200341">IP</span><span class="op" id="8200343">.</span><span class="ident" id="8200344">To16</span><span class="op" id="8200348">(</span><span class="op" id="8200349">)</span>&nbsp;<span class="op" id="8200351">!=</span>&nbsp;<span class="ident" id="8200354">nil</span>&nbsp;<span class="op" id="8200358">&amp;&amp;</span>&nbsp;<span class="ident" id="8200361">addr</span><span class="op" id="8200365">.</span><span class="ident" id="8200366">IP</span><span class="op" id="8200368">.</span><span class="ident" id="8200369">To4</span><span class="op" id="8200372">(</span><span class="op" id="8200373">)</span>&nbsp;<span class="op" id="8200375">==</span>&nbsp;<span class="ident" id="8200378">nil</span>&nbsp;<span class="op" id="8200382">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200388">dss</span><span class="op" id="8200391">.</span><span class="ident" id="8200392">teardownNetwork</span><span class="op" id="8200407">(</span><span class="string" id="8200408">&#34;tcp6&#34;</span><span class="op" id="8200414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200424">c</span><span class="op" id="8200425">.</span><span class="ident" id="8200426">Close</span><span class="op" id="8200431">(</span><span class="op" id="8200432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200439">}</span><br>
<span class="lineno">515</span><span class="op" id="8200441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8200444">func</span>&nbsp;<span class="ident" id="8200449">TestDialerKeepAlive</span><span class="op" id="8200468">(</span><span class="ident" id="8200469">t</span>&nbsp;<span class="op" id="8200471">*</span><span class="ident" id="8200472">testing</span><span class="op" id="8200479">.</span><span class="ident" id="8200480">T</span><span class="op" id="8200481">)</span>&nbsp;<span class="op" id="8200483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200486">ln</span>&nbsp;<span class="op" id="8200489">:=</span>&nbsp;<span class="ident" id="8200492">newLocalListener</span><span class="op" id="8200508">(</span><span class="ident" id="8200509">t</span><span class="op" id="8200510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200513">defer</span>&nbsp;<span class="ident" id="8200519">ln</span><span class="op" id="8200521">.</span><span class="ident" id="8200522">Close</span><span class="op" id="8200527">(</span><span class="op" id="8200528">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200531">defer</span>&nbsp;<span class="keyword" id="8200537">func</span><span class="op" id="8200541">(</span><span class="op" id="8200542">)</span>&nbsp;<span class="op" id="8200544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200548">testHookSetKeepAlive</span>&nbsp;<span class="op" id="8200569">=</span>&nbsp;<span class="keyword" id="8200571">func</span><span class="op" id="8200575">(</span><span class="op" id="8200576">)</span>&nbsp;<span class="op" id="8200578">{</span><span class="op" id="8200579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200582">}</span><span class="op" id="8200583">(</span><span class="op" id="8200584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200587">go</span>&nbsp;<span class="keyword" id="8200590">func</span><span class="op" id="8200594">(</span><span class="op" id="8200595">)</span>&nbsp;<span class="op" id="8200597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200601">for</span>&nbsp;<span class="op" id="8200605">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200610">c</span><span class="op" id="8200611">,</span>&nbsp;<span class="ident" id="8200613">err</span>&nbsp;<span class="op" id="8200617">:=</span>&nbsp;<span class="ident" id="8200620">ln</span><span class="op" id="8200622">.</span><span class="ident" id="8200623">Accept</span><span class="op" id="8200629">(</span><span class="op" id="8200630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200635">if</span>&nbsp;<span class="ident" id="8200638">err</span>&nbsp;<span class="op" id="8200642">!=</span>&nbsp;<span class="ident" id="8200645">nil</span>&nbsp;<span class="op" id="8200649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200655">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200670">c</span><span class="op" id="8200671">.</span><span class="ident" id="8200672">Close</span><span class="op" id="8200677">(</span><span class="op" id="8200678">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200685">}</span><span class="op" id="8200686">(</span><span class="op" id="8200687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200690">for</span>&nbsp;<span class="ident" id="8200694">_</span><span class="op" id="8200695">,</span>&nbsp;<span class="ident" id="8200697">keepAlive</span>&nbsp;<span class="op" id="8200707">:=</span>&nbsp;<span class="keyword" id="8200710">range</span>&nbsp;<span class="op" id="8200716">[</span><span class="op" id="8200717">]</span><span class="builtintype" id="8200718">bool</span><span class="op" id="8200722">{</span><span class="builtintype" id="8200723">false</span><span class="op" id="8200728">,</span>&nbsp;<span class="builtintype" id="8200730">true</span><span class="op" id="8200734">}</span>&nbsp;<span class="op" id="8200736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200740">got</span>&nbsp;<span class="op" id="8200744">:=</span>&nbsp;<span class="builtintype" id="8200747">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200755">testHookSetKeepAlive</span>&nbsp;<span class="op" id="8200776">=</span>&nbsp;<span class="keyword" id="8200778">func</span><span class="op" id="8200782">(</span><span class="op" id="8200783">)</span>&nbsp;<span class="op" id="8200785">{</span>&nbsp;<span class="ident" id="8200787">got</span>&nbsp;<span class="op" id="8200791">=</span>&nbsp;<span class="builtintype" id="8200793">true</span>&nbsp;<span class="op" id="8200798">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200802">var</span>&nbsp;<span class="ident" id="8200806">d</span>&nbsp;<span class="ident" id="8200808">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200817">if</span>&nbsp;<span class="ident" id="8200820">keepAlive</span>&nbsp;<span class="op" id="8200830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200835">d</span><span class="op" id="8200836">.</span><span class="ident" id="8200837">KeepAlive</span>&nbsp;<span class="op" id="8200847">=</span>&nbsp;<span class="num" id="8200849">30</span>&nbsp;<span class="op" id="8200852">*</span>&nbsp;<span class="ident" id="8200854">time</span><span class="op" id="8200858">.</span><span class="ident" id="8200859">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200872">c</span><span class="op" id="8200873">,</span>&nbsp;<span class="ident" id="8200875">err</span>&nbsp;<span class="op" id="8200879">:=</span>&nbsp;<span class="ident" id="8200882">d</span><span class="op" id="8200883">.</span><span class="ident" id="8200884">Dial</span><span class="op" id="8200888">(</span><span class="string" id="8200889">&#34;tcp&#34;</span><span class="op" id="8200894">,</span>&nbsp;<span class="ident" id="8200896">ln</span><span class="op" id="8200898">.</span><span class="ident" id="8200899">Addr</span><span class="op" id="8200903">(</span><span class="op" id="8200904">)</span><span class="op" id="8200905">.</span><span class="ident" id="8200906">String</span><span class="op" id="8200912">(</span><span class="op" id="8200913">)</span><span class="op" id="8200914">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200918">if</span>&nbsp;<span class="ident" id="8200921">err</span>&nbsp;<span class="op" id="8200925">!=</span>&nbsp;<span class="ident" id="8200928">nil</span>&nbsp;<span class="op" id="8200932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200937">t</span><span class="op" id="8200938">.</span><span class="ident" id="8200939">Fatal</span><span class="op" id="8200944">(</span><span class="ident" id="8200945">err</span><span class="op" id="8200948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8200952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200956">c</span><span class="op" id="8200957">.</span><span class="ident" id="8200958">Close</span><span class="op" id="8200963">(</span><span class="op" id="8200964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8200968">if</span>&nbsp;<span class="ident" id="8200971">got</span>&nbsp;<span class="op" id="8200975">!=</span>&nbsp;<span class="ident" id="8200978">keepAlive</span>&nbsp;<span class="op" id="8200988">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8200993">t</span><span class="op" id="8200994">.</span><span class="ident" id="8200995">Errorf</span><span class="op" id="8201001">(</span><span class="string" id="8201002">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8201060">,</span>&nbsp;<span class="ident" id="8201062">d</span><span class="op" id="8201063">.</span><span class="ident" id="8201064">KeepAlive</span><span class="op" id="8201073">,</span>&nbsp;<span class="ident" id="8201075">got</span><span class="op" id="8201078">,</span>&nbsp;<span class="op" id="8201080">!</span><span class="ident" id="8201081">got</span><span class="op" id="8201084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8201088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8201091">}</span><br>
<span class="lineno"></span><span class="op" id="8201093">}</span>
</div>
</body>
</html>
