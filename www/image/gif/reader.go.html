<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5477265">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5477320">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5477374">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5477425">//&nbsp;Package&nbsp;gif&nbsp;implements&nbsp;a&nbsp;GIF&nbsp;image&nbsp;decoder&nbsp;and&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="comment" id="5477484">//</span><br>
<span class="lineno"></span><span class="comment" id="5477487">//&nbsp;The&nbsp;GIF&nbsp;specification&nbsp;is&nbsp;at&nbsp;http://www.w3.org/Graphics/GIF/spec-gif89a.txt.</span><br>
<span class="lineno"></span><span class="keyword" id="5477566">package</span>&nbsp;<span class="ident" id="5477574">gif</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5477579">import</span>&nbsp;<span class="op" id="5477586">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5477589">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5477598">&#34;compress/lzw&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5477614">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5477624">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5477631">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5477640">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5477655">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5477660">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="5477663">var</span>&nbsp;<span class="op" id="5477667">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477670">errNotEnough</span>&nbsp;<span class="op" id="5477683">=</span>&nbsp;<span class="ident" id="5477685">errors</span><span class="op" id="5477691">.</span><span class="ident" id="5477692">New</span><span class="op" id="5477695">(</span><span class="string" id="5477696">&#34;gif:&nbsp;not&nbsp;enough&nbsp;image&nbsp;data&#34;</span><span class="op" id="5477724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477727">errTooMuch</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5477740">=</span>&nbsp;<span class="ident" id="5477742">errors</span><span class="op" id="5477748">.</span><span class="ident" id="5477749">New</span><span class="op" id="5477752">(</span><span class="string" id="5477753">&#34;gif:&nbsp;too&nbsp;much&nbsp;image&nbsp;data&#34;</span><span class="op" id="5477779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477782">errBadPixel</span>&nbsp;&nbsp;<span class="op" id="5477795">=</span>&nbsp;<span class="ident" id="5477797">errors</span><span class="op" id="5477803">.</span><span class="ident" id="5477804">New</span><span class="op" id="5477807">(</span><span class="string" id="5477808">&#34;gif:&nbsp;invalid&nbsp;pixel&nbsp;value&#34;</span><span class="op" id="5477834">)</span><br>
<span class="lineno"></span><span class="op" id="5477836">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="5477839">//&nbsp;If&nbsp;the&nbsp;io.Reader&nbsp;does&nbsp;not&nbsp;also&nbsp;have&nbsp;ReadByte,&nbsp;then&nbsp;decode&nbsp;will&nbsp;introduce&nbsp;its&nbsp;own&nbsp;buffering.</span><br>
<span class="lineno"></span><span class="keyword" id="5477934">type</span>&nbsp;<span class="ident" id="5477939">reader</span>&nbsp;<span class="keyword" id="5477946">interface</span>&nbsp;<span class="op" id="5477956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477959">io</span><span class="op" id="5477961">.</span><span class="ident" id="5477962">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477970">io</span><span class="op" id="5477972">.</span><span class="ident" id="5477973">ByteReader</span><br>
<span class="lineno">30</span><span class="op" id="5477984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5477987">//&nbsp;Masks&nbsp;etc.</span><br>
<span class="lineno"></span><span class="keyword" id="5478001">const</span>&nbsp;<span class="op" id="5478007">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5478010">//&nbsp;Fields.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478022">fColorMapFollows</span>&nbsp;<span class="op" id="5478039">=</span>&nbsp;<span class="num" id="5478041">1</span>&nbsp;<span class="op" id="5478043">&lt;&lt;</span>&nbsp;<span class="num" id="5478046">7</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5478050">//&nbsp;Image&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478068">ifLocalColorTable</span>&nbsp;<span class="op" id="5478086">=</span>&nbsp;<span class="num" id="5478088">1</span>&nbsp;<span class="op" id="5478090">&lt;&lt;</span>&nbsp;<span class="num" id="5478093">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478096">ifInterlace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5478114">=</span>&nbsp;<span class="num" id="5478116">1</span>&nbsp;<span class="op" id="5478118">&lt;&lt;</span>&nbsp;<span class="num" id="5478121">6</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478124">ifPixelSizeMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5478142">=</span>&nbsp;<span class="num" id="5478144">7</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5478148">//&nbsp;Graphic&nbsp;control&nbsp;flags.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478175">gcTransparentColorSet</span>&nbsp;<span class="op" id="5478197">=</span>&nbsp;<span class="num" id="5478199">1</span>&nbsp;<span class="op" id="5478201">&lt;&lt;</span>&nbsp;<span class="num" id="5478204">0</span><br>
<span class="lineno"></span><span class="op" id="5478206">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="5478209">//&nbsp;Section&nbsp;indicators.</span><br>
<span class="lineno"></span><span class="keyword" id="5478232">const</span>&nbsp;<span class="op" id="5478238">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478241">sExtension</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5478258">=</span>&nbsp;<span class="num" id="5478260">0x21</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478266">sImageDescriptor</span>&nbsp;<span class="op" id="5478283">=</span>&nbsp;<span class="num" id="5478285">0x2C</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478291">sTrailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5478308">=</span>&nbsp;<span class="num" id="5478310">0x3B</span><br>
<span class="lineno"></span><span class="op" id="5478315">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5478318">//&nbsp;Extensions.</span><br>
<span class="lineno"></span><span class="keyword" id="5478333">const</span>&nbsp;<span class="op" id="5478339">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478342">eText</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5478358">=</span>&nbsp;<span class="num" id="5478360">0x01</span>&nbsp;<span class="comment" id="5478365">//&nbsp;Plain&nbsp;Text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478380">eGraphicControl</span>&nbsp;<span class="op" id="5478396">=</span>&nbsp;<span class="num" id="5478398">0xF9</span>&nbsp;<span class="comment" id="5478403">//&nbsp;Graphic&nbsp;Control</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478423">eComment</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5478439">=</span>&nbsp;<span class="num" id="5478441">0xFE</span>&nbsp;<span class="comment" id="5478446">//&nbsp;Comment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478458">eApplication</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5478474">=</span>&nbsp;<span class="num" id="5478476">0xFF</span>&nbsp;<span class="comment" id="5478481">//&nbsp;Application</span><br>
<span class="lineno"></span><span class="op" id="5478496">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="5478499">//&nbsp;decoder&nbsp;is&nbsp;the&nbsp;type&nbsp;used&nbsp;to&nbsp;decode&nbsp;a&nbsp;GIF&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="5478549">type</span>&nbsp;<span class="ident" id="5478554">decoder</span>&nbsp;<span class="keyword" id="5478562">struct</span>&nbsp;<span class="op" id="5478569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478572">r</span>&nbsp;<span class="ident" id="5478574">reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5478583">//&nbsp;From&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478600">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5478616">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478624">width</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5478640">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478645">height</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5478661">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478666">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5478682">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478688">headerFields</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5478704">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478710">backgroundIndex</span>&nbsp;<span class="builtintype" id="5478726">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478732">loopCount</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5478748">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478753">delayTime</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5478769">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5478775">//&nbsp;Unused&nbsp;from&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478799">aspect</span>&nbsp;<span class="builtintype" id="5478806">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5478813">//&nbsp;From&nbsp;image&nbsp;descriptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478840">imageFields</span>&nbsp;<span class="builtintype" id="5478852">byte</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5478859">//&nbsp;From&nbsp;graphics&nbsp;control.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478886">transparentIndex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5478906">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478912">hasTransparentIndex</span>&nbsp;<span class="builtintype" id="5478932">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5478939">//&nbsp;Computed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478953">pixelSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5478968">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478974">globalColorMap</span>&nbsp;<span class="ident" id="5478989">color</span><span class="op" id="5478994">.</span><span class="ident" id="5478995">Palette</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5479005">//&nbsp;Used&nbsp;when&nbsp;decoding.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479029">delay</span>&nbsp;<span class="op" id="5479035">[</span><span class="op" id="5479036">]</span><span class="builtintype" id="5479037">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479042">image</span>&nbsp;<span class="op" id="5479048">[</span><span class="op" id="5479049">]</span><span class="op" id="5479050">*</span><span class="ident" id="5479051">image</span><span class="op" id="5479056">.</span><span class="ident" id="5479057">Paletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479067">tmp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5479073">[</span><span class="num" id="5479074">1024</span><span class="op" id="5479078">]</span><span class="builtintype" id="5479079">byte</span>&nbsp;<span class="comment" id="5479084">//&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;768&nbsp;so&nbsp;we&nbsp;can&nbsp;read&nbsp;color&nbsp;map</span><br>
<span class="lineno"></span><span class="op" id="5479133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="5479136">//&nbsp;blockReader&nbsp;parses&nbsp;the&nbsp;block&nbsp;structure&nbsp;of&nbsp;GIF&nbsp;image&nbsp;data,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="5479203">//&nbsp;comprises&nbsp;(n,&nbsp;(n&nbsp;bytes))&nbsp;blocks,&nbsp;with&nbsp;1&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;255.&nbsp;&nbsp;It&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5479270">//&nbsp;reader&nbsp;given&nbsp;to&nbsp;the&nbsp;LZW&nbsp;decoder,&nbsp;which&nbsp;is&nbsp;thus&nbsp;immune&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5479334">//&nbsp;blocking.&nbsp;&nbsp;After&nbsp;the&nbsp;LZW&nbsp;decoder&nbsp;completes,&nbsp;there&nbsp;will&nbsp;be&nbsp;a&nbsp;0-byte</span><br>
<span class="lineno"></span><span class="comment" id="5479404">//&nbsp;block&nbsp;remaining&nbsp;(0,&nbsp;()),&nbsp;which&nbsp;is&nbsp;consumed&nbsp;when&nbsp;checking&nbsp;that&nbsp;the</span><br>
<span class="lineno">100</span><span class="comment" id="5479473">//&nbsp;blockReader&nbsp;is&nbsp;exhausted.</span><br>
<span class="lineno"></span><span class="keyword" id="5479502">type</span>&nbsp;<span class="ident" id="5479507">blockReader</span>&nbsp;<span class="keyword" id="5479519">struct</span>&nbsp;<span class="op" id="5479526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479529">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5479535">reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479543">slice</span>&nbsp;<span class="op" id="5479549">[</span><span class="op" id="5479550">]</span><span class="builtintype" id="5479551">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479557">err</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5479563">error</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479570">tmp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5479576">[</span><span class="num" id="5479577">256</span><span class="op" id="5479580">]</span><span class="builtintype" id="5479581">byte</span><br>
<span class="lineno"></span><span class="op" id="5479586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5479589">func</span>&nbsp;<span class="op" id="5479594">(</span><span class="ident" id="5479595">b</span>&nbsp;<span class="op" id="5479597">*</span><span class="ident" id="5479598">blockReader</span><span class="op" id="5479609">)</span>&nbsp;<span class="ident" id="5479611">Read</span><span class="op" id="5479615">(</span><span class="ident" id="5479616">p</span>&nbsp;<span class="op" id="5479618">[</span><span class="op" id="5479619">]</span><span class="builtintype" id="5479620">byte</span><span class="op" id="5479624">)</span>&nbsp;<span class="op" id="5479626">(</span><span class="builtintype" id="5479627">int</span><span class="op" id="5479630">,</span>&nbsp;<span class="builtintype" id="5479632">error</span><span class="op" id="5479637">)</span>&nbsp;<span class="op" id="5479639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479642">if</span>&nbsp;<span class="ident" id="5479645">b</span><span class="op" id="5479646">.</span><span class="ident" id="5479647">err</span>&nbsp;<span class="op" id="5479651">!=</span>&nbsp;<span class="ident" id="5479654">nil</span>&nbsp;<span class="op" id="5479658">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479662">return</span>&nbsp;<span class="num" id="5479669">0</span><span class="op" id="5479670">,</span>&nbsp;<span class="ident" id="5479672">b</span><span class="op" id="5479673">.</span><span class="ident" id="5479674">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5479679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479682">if</span>&nbsp;<span class="builtinfunc" id="5479685">len</span><span class="op" id="5479688">(</span><span class="ident" id="5479689">p</span><span class="op" id="5479690">)</span>&nbsp;<span class="op" id="5479692">==</span>&nbsp;<span class="num" id="5479695">0</span>&nbsp;<span class="op" id="5479697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479701">return</span>&nbsp;<span class="num" id="5479708">0</span><span class="op" id="5479709">,</span>&nbsp;<span class="ident" id="5479711">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5479716">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479719">if</span>&nbsp;<span class="builtinfunc" id="5479722">len</span><span class="op" id="5479725">(</span><span class="ident" id="5479726">b</span><span class="op" id="5479727">.</span><span class="ident" id="5479728">slice</span><span class="op" id="5479733">)</span>&nbsp;<span class="op" id="5479735">==</span>&nbsp;<span class="num" id="5479738">0</span>&nbsp;<span class="op" id="5479740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479744">var</span>&nbsp;<span class="ident" id="5479748">blockLen</span>&nbsp;<span class="builtintype" id="5479757">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479765">blockLen</span><span class="op" id="5479773">,</span>&nbsp;<span class="ident" id="5479775">b</span><span class="op" id="5479776">.</span><span class="ident" id="5479777">err</span>&nbsp;<span class="op" id="5479781">=</span>&nbsp;<span class="ident" id="5479783">b</span><span class="op" id="5479784">.</span><span class="ident" id="5479785">r</span><span class="op" id="5479786">.</span><span class="ident" id="5479787">ReadByte</span><span class="op" id="5479795">(</span><span class="op" id="5479796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479800">if</span>&nbsp;<span class="ident" id="5479803">b</span><span class="op" id="5479804">.</span><span class="ident" id="5479805">err</span>&nbsp;<span class="op" id="5479809">!=</span>&nbsp;<span class="ident" id="5479812">nil</span>&nbsp;<span class="op" id="5479816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479821">return</span>&nbsp;<span class="num" id="5479828">0</span><span class="op" id="5479829">,</span>&nbsp;<span class="ident" id="5479831">b</span><span class="op" id="5479832">.</span><span class="ident" id="5479833">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5479839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479843">if</span>&nbsp;<span class="ident" id="5479846">blockLen</span>&nbsp;<span class="op" id="5479855">==</span>&nbsp;<span class="num" id="5479858">0</span>&nbsp;<span class="op" id="5479860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479865">b</span><span class="op" id="5479866">.</span><span class="ident" id="5479867">err</span>&nbsp;<span class="op" id="5479871">=</span>&nbsp;<span class="ident" id="5479873">io</span><span class="op" id="5479875">.</span><span class="ident" id="5479876">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479883">return</span>&nbsp;<span class="num" id="5479890">0</span><span class="op" id="5479891">,</span>&nbsp;<span class="ident" id="5479893">b</span><span class="op" id="5479894">.</span><span class="ident" id="5479895">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5479901">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479905">b</span><span class="op" id="5479906">.</span><span class="ident" id="5479907">slice</span>&nbsp;<span class="op" id="5479913">=</span>&nbsp;<span class="ident" id="5479915">b</span><span class="op" id="5479916">.</span><span class="ident" id="5479917">tmp</span><span class="op" id="5479920">[</span><span class="num" id="5479921">0</span><span class="op" id="5479922">:</span><span class="ident" id="5479923">blockLen</span><span class="op" id="5479931">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479935">if</span>&nbsp;<span class="ident" id="5479938">_</span><span class="op" id="5479939">,</span>&nbsp;<span class="ident" id="5479941">b</span><span class="op" id="5479942">.</span><span class="ident" id="5479943">err</span>&nbsp;<span class="op" id="5479947">=</span>&nbsp;<span class="ident" id="5479949">io</span><span class="op" id="5479951">.</span><span class="ident" id="5479952">ReadFull</span><span class="op" id="5479960">(</span><span class="ident" id="5479961">b</span><span class="op" id="5479962">.</span><span class="ident" id="5479963">r</span><span class="op" id="5479964">,</span>&nbsp;<span class="ident" id="5479966">b</span><span class="op" id="5479967">.</span><span class="ident" id="5479968">slice</span><span class="op" id="5479973">)</span><span class="op" id="5479974">;</span>&nbsp;<span class="ident" id="5479976">b</span><span class="op" id="5479977">.</span><span class="ident" id="5479978">err</span>&nbsp;<span class="op" id="5479982">!=</span>&nbsp;<span class="ident" id="5479985">nil</span>&nbsp;<span class="op" id="5479989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479994">return</span>&nbsp;<span class="num" id="5480001">0</span><span class="op" id="5480002">,</span>&nbsp;<span class="ident" id="5480004">b</span><span class="op" id="5480005">.</span><span class="ident" id="5480006">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480015">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480018">n</span>&nbsp;<span class="op" id="5480020">:=</span>&nbsp;<span class="builtinfunc" id="5480023">copy</span><span class="op" id="5480027">(</span><span class="ident" id="5480028">p</span><span class="op" id="5480029">,</span>&nbsp;<span class="ident" id="5480031">b</span><span class="op" id="5480032">.</span><span class="ident" id="5480033">slice</span><span class="op" id="5480038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480041">b</span><span class="op" id="5480042">.</span><span class="ident" id="5480043">slice</span>&nbsp;<span class="op" id="5480049">=</span>&nbsp;<span class="ident" id="5480051">b</span><span class="op" id="5480052">.</span><span class="ident" id="5480053">slice</span><span class="op" id="5480058">[</span><span class="ident" id="5480059">n</span><span class="op" id="5480060">:</span><span class="op" id="5480061">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480064">return</span>&nbsp;<span class="ident" id="5480071">n</span><span class="op" id="5480072">,</span>&nbsp;<span class="ident" id="5480074">nil</span><br>
<span class="lineno"></span><span class="op" id="5480078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="comment" id="5480081">//&nbsp;decode&nbsp;reads&nbsp;a&nbsp;GIF&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;stores&nbsp;the&nbsp;result&nbsp;in&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="5480144">func</span>&nbsp;<span class="op" id="5480149">(</span><span class="ident" id="5480150">d</span>&nbsp;<span class="op" id="5480152">*</span><span class="ident" id="5480153">decoder</span><span class="op" id="5480160">)</span>&nbsp;<span class="ident" id="5480162">decode</span><span class="op" id="5480168">(</span><span class="ident" id="5480169">r</span>&nbsp;<span class="ident" id="5480171">io</span><span class="op" id="5480173">.</span><span class="ident" id="5480174">Reader</span><span class="op" id="5480180">,</span>&nbsp;<span class="ident" id="5480182">configOnly</span>&nbsp;<span class="builtintype" id="5480193">bool</span><span class="op" id="5480197">)</span>&nbsp;<span class="builtintype" id="5480199">error</span>&nbsp;<span class="op" id="5480205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5480208">//&nbsp;Add&nbsp;buffering&nbsp;if&nbsp;r&nbsp;does&nbsp;not&nbsp;provide&nbsp;ReadByte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480258">if</span>&nbsp;<span class="ident" id="5480261">rr</span><span class="op" id="5480263">,</span>&nbsp;<span class="ident" id="5480265">ok</span>&nbsp;<span class="op" id="5480268">:=</span>&nbsp;<span class="ident" id="5480271">r</span><span class="op" id="5480272">.</span><span class="op" id="5480273">(</span><span class="ident" id="5480274">reader</span><span class="op" id="5480280">)</span><span class="op" id="5480281">;</span>&nbsp;<span class="ident" id="5480283">ok</span>&nbsp;<span class="op" id="5480286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480290">d</span><span class="op" id="5480291">.</span><span class="ident" id="5480292">r</span>&nbsp;<span class="op" id="5480294">=</span>&nbsp;<span class="ident" id="5480296">rr</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480300">}</span>&nbsp;<span class="keyword" id="5480302">else</span>&nbsp;<span class="op" id="5480307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480311">d</span><span class="op" id="5480312">.</span><span class="ident" id="5480313">r</span>&nbsp;<span class="op" id="5480315">=</span>&nbsp;<span class="ident" id="5480317">bufio</span><span class="op" id="5480322">.</span><span class="ident" id="5480323">NewReader</span><span class="op" id="5480332">(</span><span class="ident" id="5480333">r</span><span class="op" id="5480334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480341">err</span>&nbsp;<span class="op" id="5480345">:=</span>&nbsp;<span class="ident" id="5480348">d</span><span class="op" id="5480349">.</span><span class="ident" id="5480350">readHeaderAndScreenDescriptor</span><span class="op" id="5480379">(</span><span class="op" id="5480380">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480383">if</span>&nbsp;<span class="ident" id="5480386">err</span>&nbsp;<span class="op" id="5480390">!=</span>&nbsp;<span class="ident" id="5480393">nil</span>&nbsp;<span class="op" id="5480397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480401">return</span>&nbsp;<span class="ident" id="5480408">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480416">if</span>&nbsp;<span class="ident" id="5480419">configOnly</span>&nbsp;<span class="op" id="5480430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480434">return</span>&nbsp;<span class="ident" id="5480441">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480450">if</span>&nbsp;<span class="ident" id="5480453">d</span><span class="op" id="5480454">.</span><span class="ident" id="5480455">headerFields</span><span class="op" id="5480467">&amp;</span><span class="ident" id="5480468">fColorMapFollows</span>&nbsp;<span class="op" id="5480485">!=</span>&nbsp;<span class="num" id="5480488">0</span>&nbsp;<span class="op" id="5480490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480494">if</span>&nbsp;<span class="ident" id="5480497">d</span><span class="op" id="5480498">.</span><span class="ident" id="5480499">globalColorMap</span><span class="op" id="5480513">,</span>&nbsp;<span class="ident" id="5480515">err</span>&nbsp;<span class="op" id="5480519">=</span>&nbsp;<span class="ident" id="5480521">d</span><span class="op" id="5480522">.</span><span class="ident" id="5480523">readColorMap</span><span class="op" id="5480535">(</span><span class="op" id="5480536">)</span><span class="op" id="5480537">;</span>&nbsp;<span class="ident" id="5480539">err</span>&nbsp;<span class="op" id="5480543">!=</span>&nbsp;<span class="ident" id="5480546">nil</span>&nbsp;<span class="op" id="5480550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480555">return</span>&nbsp;<span class="ident" id="5480562">err</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480575">for</span>&nbsp;<span class="op" id="5480579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480583">c</span><span class="op" id="5480584">,</span>&nbsp;<span class="ident" id="5480586">err</span>&nbsp;<span class="op" id="5480590">:=</span>&nbsp;<span class="ident" id="5480593">d</span><span class="op" id="5480594">.</span><span class="ident" id="5480595">r</span><span class="op" id="5480596">.</span><span class="ident" id="5480597">ReadByte</span><span class="op" id="5480605">(</span><span class="op" id="5480606">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480610">if</span>&nbsp;<span class="ident" id="5480613">err</span>&nbsp;<span class="op" id="5480617">!=</span>&nbsp;<span class="ident" id="5480620">nil</span>&nbsp;<span class="op" id="5480624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480629">return</span>&nbsp;<span class="ident" id="5480636">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480646">switch</span>&nbsp;<span class="ident" id="5480653">c</span>&nbsp;<span class="op" id="5480655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480659">case</span>&nbsp;<span class="ident" id="5480664">sExtension</span><span class="op" id="5480674">:</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480679">if</span>&nbsp;<span class="ident" id="5480682">err</span>&nbsp;<span class="op" id="5480686">=</span>&nbsp;<span class="ident" id="5480688">d</span><span class="op" id="5480689">.</span><span class="ident" id="5480690">readExtension</span><span class="op" id="5480703">(</span><span class="op" id="5480704">)</span><span class="op" id="5480705">;</span>&nbsp;<span class="ident" id="5480707">err</span>&nbsp;<span class="op" id="5480711">!=</span>&nbsp;<span class="ident" id="5480714">nil</span>&nbsp;<span class="op" id="5480718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480724">return</span>&nbsp;<span class="ident" id="5480731">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480743">case</span>&nbsp;<span class="ident" id="5480748">sImageDescriptor</span><span class="op" id="5480764">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480769">m</span><span class="op" id="5480770">,</span>&nbsp;<span class="ident" id="5480772">err</span>&nbsp;<span class="op" id="5480776">:=</span>&nbsp;<span class="ident" id="5480779">d</span><span class="op" id="5480780">.</span><span class="ident" id="5480781">newImageFromDescriptor</span><span class="op" id="5480803">(</span><span class="op" id="5480804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480809">if</span>&nbsp;<span class="ident" id="5480812">err</span>&nbsp;<span class="op" id="5480816">!=</span>&nbsp;<span class="ident" id="5480819">nil</span>&nbsp;<span class="op" id="5480823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480829">return</span>&nbsp;<span class="ident" id="5480836">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480848">useLocalColorMap</span>&nbsp;<span class="op" id="5480865">:=</span>&nbsp;<span class="ident" id="5480868">d</span><span class="op" id="5480869">.</span><span class="ident" id="5480870">imageFields</span><span class="op" id="5480881">&amp;</span><span class="ident" id="5480882">fColorMapFollows</span>&nbsp;<span class="op" id="5480899">!=</span>&nbsp;<span class="num" id="5480902">0</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480907">if</span>&nbsp;<span class="ident" id="5480910">useLocalColorMap</span>&nbsp;<span class="op" id="5480927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480933">m</span><span class="op" id="5480934">.</span><span class="ident" id="5480935">Palette</span><span class="op" id="5480942">,</span>&nbsp;<span class="ident" id="5480944">err</span>&nbsp;<span class="op" id="5480948">=</span>&nbsp;<span class="ident" id="5480950">d</span><span class="op" id="5480951">.</span><span class="ident" id="5480952">readColorMap</span><span class="op" id="5480964">(</span><span class="op" id="5480965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480971">if</span>&nbsp;<span class="ident" id="5480974">err</span>&nbsp;<span class="op" id="5480978">!=</span>&nbsp;<span class="ident" id="5480981">nil</span>&nbsp;<span class="op" id="5480985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480992">return</span>&nbsp;<span class="ident" id="5480999">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5481007">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5481012">}</span>&nbsp;<span class="keyword" id="5481014">else</span>&nbsp;<span class="op" id="5481019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481025">m</span><span class="op" id="5481026">.</span><span class="ident" id="5481027">Palette</span>&nbsp;<span class="op" id="5481035">=</span>&nbsp;<span class="ident" id="5481037">d</span><span class="op" id="5481038">.</span><span class="ident" id="5481039">globalColorMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5481057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481062">if</span>&nbsp;<span class="ident" id="5481065">d</span><span class="op" id="5481066">.</span><span class="ident" id="5481067">hasTransparentIndex</span>&nbsp;<span class="op" id="5481087">&amp;&amp;</span>&nbsp;<span class="builtintype" id="5481090">int</span><span class="op" id="5481093">(</span><span class="ident" id="5481094">d</span><span class="op" id="5481095">.</span><span class="ident" id="5481096">transparentIndex</span><span class="op" id="5481112">)</span>&nbsp;<span class="op" id="5481114">&lt;</span>&nbsp;<span class="builtinfunc" id="5481116">len</span><span class="op" id="5481119">(</span><span class="ident" id="5481120">m</span><span class="op" id="5481121">.</span><span class="ident" id="5481122">Palette</span><span class="op" id="5481129">)</span>&nbsp;<span class="op" id="5481131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481137">if</span>&nbsp;<span class="op" id="5481140">!</span><span class="ident" id="5481141">useLocalColorMap</span>&nbsp;<span class="op" id="5481158">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5481165">//&nbsp;Clone&nbsp;the&nbsp;global&nbsp;color&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481201">m</span><span class="op" id="5481202">.</span><span class="ident" id="5481203">Palette</span>&nbsp;<span class="op" id="5481211">=</span>&nbsp;<span class="builtinfunc" id="5481213">append</span><span class="op" id="5481219">(</span><span class="ident" id="5481220">color</span><span class="op" id="5481225">.</span><span class="ident" id="5481226">Palette</span><span class="op" id="5481233">(</span><span class="ident" id="5481234">nil</span><span class="op" id="5481237">)</span><span class="op" id="5481238">,</span>&nbsp;<span class="ident" id="5481240">d</span><span class="op" id="5481241">.</span><span class="ident" id="5481242">globalColorMap</span><span class="op" id="5481256">...</span><span class="op" id="5481259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5481265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481271">m</span><span class="op" id="5481272">.</span><span class="ident" id="5481273">Palette</span><span class="op" id="5481280">[</span><span class="ident" id="5481281">d</span><span class="op" id="5481282">.</span><span class="ident" id="5481283">transparentIndex</span><span class="op" id="5481299">]</span>&nbsp;<span class="op" id="5481301">=</span>&nbsp;<span class="ident" id="5481303">color</span><span class="op" id="5481308">.</span><span class="ident" id="5481309">RGBA</span><span class="op" id="5481313">{</span><span class="op" id="5481314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5481319">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481324">litWidth</span><span class="op" id="5481332">,</span>&nbsp;<span class="ident" id="5481334">err</span>&nbsp;<span class="op" id="5481338">:=</span>&nbsp;<span class="ident" id="5481341">d</span><span class="op" id="5481342">.</span><span class="ident" id="5481343">r</span><span class="op" id="5481344">.</span><span class="ident" id="5481345">ReadByte</span><span class="op" id="5481353">(</span><span class="op" id="5481354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481359">if</span>&nbsp;<span class="ident" id="5481362">err</span>&nbsp;<span class="op" id="5481366">!=</span>&nbsp;<span class="ident" id="5481369">nil</span>&nbsp;<span class="op" id="5481373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481379">return</span>&nbsp;<span class="ident" id="5481386">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5481393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481398">if</span>&nbsp;<span class="ident" id="5481401">litWidth</span>&nbsp;<span class="op" id="5481410">&lt;</span>&nbsp;<span class="num" id="5481412">2</span>&nbsp;<span class="op" id="5481414">||</span>&nbsp;<span class="ident" id="5481417">litWidth</span>&nbsp;<span class="op" id="5481426">&gt;</span>&nbsp;<span class="num" id="5481428">8</span>&nbsp;<span class="op" id="5481430">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481436">return</span>&nbsp;<span class="ident" id="5481443">fmt</span><span class="op" id="5481446">.</span><span class="ident" id="5481447">Errorf</span><span class="op" id="5481453">(</span><span class="string" id="5481454">&#34;gif:&nbsp;pixel&nbsp;size&nbsp;in&nbsp;decode&nbsp;out&nbsp;of&nbsp;range:&nbsp;%d&#34;</span><span class="op" id="5481498">,</span>&nbsp;<span class="ident" id="5481500">litWidth</span><span class="op" id="5481508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5481513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5481518">//&nbsp;A&nbsp;wonderfully&nbsp;Go-like&nbsp;piece&nbsp;of&nbsp;magic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481562">br</span>&nbsp;<span class="op" id="5481565">:=</span>&nbsp;<span class="op" id="5481568">&amp;</span><span class="ident" id="5481569">blockReader</span><span class="op" id="5481580">{</span><span class="ident" id="5481581">r</span><span class="op" id="5481582">:</span>&nbsp;<span class="ident" id="5481584">d</span><span class="op" id="5481585">.</span><span class="ident" id="5481586">r</span><span class="op" id="5481587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481592">lzwr</span>&nbsp;<span class="op" id="5481597">:=</span>&nbsp;<span class="ident" id="5481600">lzw</span><span class="op" id="5481603">.</span><span class="ident" id="5481604">NewReader</span><span class="op" id="5481613">(</span><span class="ident" id="5481614">br</span><span class="op" id="5481616">,</span>&nbsp;<span class="ident" id="5481618">lzw</span><span class="op" id="5481621">.</span><span class="ident" id="5481622">LSB</span><span class="op" id="5481625">,</span>&nbsp;<span class="builtintype" id="5481627">int</span><span class="op" id="5481630">(</span><span class="ident" id="5481631">litWidth</span><span class="op" id="5481639">)</span><span class="op" id="5481640">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481645">defer</span>&nbsp;<span class="ident" id="5481651">lzwr</span><span class="op" id="5481655">.</span><span class="ident" id="5481656">Close</span><span class="op" id="5481661">(</span><span class="op" id="5481662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481667">if</span>&nbsp;<span class="ident" id="5481670">_</span><span class="op" id="5481671">,</span>&nbsp;<span class="ident" id="5481673">err</span>&nbsp;<span class="op" id="5481677">=</span>&nbsp;<span class="ident" id="5481679">io</span><span class="op" id="5481681">.</span><span class="ident" id="5481682">ReadFull</span><span class="op" id="5481690">(</span><span class="ident" id="5481691">lzwr</span><span class="op" id="5481695">,</span>&nbsp;<span class="ident" id="5481697">m</span><span class="op" id="5481698">.</span><span class="ident" id="5481699">Pix</span><span class="op" id="5481702">)</span><span class="op" id="5481703">;</span>&nbsp;<span class="ident" id="5481705">err</span>&nbsp;<span class="op" id="5481709">!=</span>&nbsp;<span class="ident" id="5481712">nil</span>&nbsp;<span class="op" id="5481716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481722">if</span>&nbsp;<span class="ident" id="5481725">err</span>&nbsp;<span class="op" id="5481729">!=</span>&nbsp;<span class="ident" id="5481732">io</span><span class="op" id="5481734">.</span><span class="ident" id="5481735">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5481752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481759">return</span>&nbsp;<span class="ident" id="5481766">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5481774">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481780">return</span>&nbsp;<span class="ident" id="5481787">errNotEnough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5481803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5481808">//&nbsp;Both&nbsp;lzwr&nbsp;and&nbsp;br&nbsp;should&nbsp;be&nbsp;exhausted.&nbsp;Reading&nbsp;from&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5481870">//&nbsp;should&nbsp;yield&nbsp;(0,&nbsp;io.EOF).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481902">if</span>&nbsp;<span class="ident" id="5481905">n</span><span class="op" id="5481906">,</span>&nbsp;<span class="ident" id="5481908">err</span>&nbsp;<span class="op" id="5481912">:=</span>&nbsp;<span class="ident" id="5481915">lzwr</span><span class="op" id="5481919">.</span><span class="ident" id="5481920">Read</span><span class="op" id="5481924">(</span><span class="ident" id="5481925">d</span><span class="op" id="5481926">.</span><span class="ident" id="5481927">tmp</span><span class="op" id="5481930">[</span><span class="op" id="5481931">:</span><span class="num" id="5481932">1</span><span class="op" id="5481933">]</span><span class="op" id="5481934">)</span><span class="op" id="5481935">;</span>&nbsp;<span class="ident" id="5481937">n</span>&nbsp;<span class="op" id="5481939">!=</span>&nbsp;<span class="num" id="5481942">0</span>&nbsp;<span class="op" id="5481944">||</span>&nbsp;<span class="ident" id="5481947">err</span>&nbsp;<span class="op" id="5481951">!=</span>&nbsp;<span class="ident" id="5481954">io</span><span class="op" id="5481956">.</span><span class="ident" id="5481957">EOF</span>&nbsp;<span class="op" id="5481961">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481967">if</span>&nbsp;<span class="ident" id="5481970">err</span>&nbsp;<span class="op" id="5481974">!=</span>&nbsp;<span class="ident" id="5481977">nil</span>&nbsp;<span class="op" id="5481981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481988">return</span>&nbsp;<span class="ident" id="5481995">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482009">return</span>&nbsp;<span class="ident" id="5482016">errTooMuch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482030">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482035">if</span>&nbsp;<span class="ident" id="5482038">n</span><span class="op" id="5482039">,</span>&nbsp;<span class="ident" id="5482041">err</span>&nbsp;<span class="op" id="5482045">:=</span>&nbsp;<span class="ident" id="5482048">br</span><span class="op" id="5482050">.</span><span class="ident" id="5482051">Read</span><span class="op" id="5482055">(</span><span class="ident" id="5482056">d</span><span class="op" id="5482057">.</span><span class="ident" id="5482058">tmp</span><span class="op" id="5482061">[</span><span class="op" id="5482062">:</span><span class="num" id="5482063">1</span><span class="op" id="5482064">]</span><span class="op" id="5482065">)</span><span class="op" id="5482066">;</span>&nbsp;<span class="ident" id="5482068">n</span>&nbsp;<span class="op" id="5482070">!=</span>&nbsp;<span class="num" id="5482073">0</span>&nbsp;<span class="op" id="5482075">||</span>&nbsp;<span class="ident" id="5482078">err</span>&nbsp;<span class="op" id="5482082">!=</span>&nbsp;<span class="ident" id="5482085">io</span><span class="op" id="5482087">.</span><span class="ident" id="5482088">EOF</span>&nbsp;<span class="op" id="5482092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482098">if</span>&nbsp;<span class="ident" id="5482101">err</span>&nbsp;<span class="op" id="5482105">!=</span>&nbsp;<span class="ident" id="5482108">nil</span>&nbsp;<span class="op" id="5482112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482119">return</span>&nbsp;<span class="ident" id="5482126">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482140">return</span>&nbsp;<span class="ident" id="5482147">errTooMuch</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5482167">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;color&nbsp;indexes&nbsp;are&nbsp;inside&nbsp;the&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482226">if</span>&nbsp;<span class="builtinfunc" id="5482229">len</span><span class="op" id="5482232">(</span><span class="ident" id="5482233">m</span><span class="op" id="5482234">.</span><span class="ident" id="5482235">Palette</span><span class="op" id="5482242">)</span>&nbsp;<span class="op" id="5482244">&lt;</span>&nbsp;<span class="num" id="5482246">256</span>&nbsp;<span class="op" id="5482250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482256">for</span>&nbsp;<span class="ident" id="5482260">_</span><span class="op" id="5482261">,</span>&nbsp;<span class="ident" id="5482263">pixel</span>&nbsp;<span class="op" id="5482269">:=</span>&nbsp;<span class="keyword" id="5482272">range</span>&nbsp;<span class="ident" id="5482278">m</span><span class="op" id="5482279">.</span><span class="ident" id="5482280">Pix</span>&nbsp;<span class="op" id="5482284">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482291">if</span>&nbsp;<span class="builtintype" id="5482294">int</span><span class="op" id="5482297">(</span><span class="ident" id="5482298">pixel</span><span class="op" id="5482303">)</span>&nbsp;<span class="op" id="5482305">&gt;=</span>&nbsp;<span class="builtinfunc" id="5482308">len</span><span class="op" id="5482311">(</span><span class="ident" id="5482312">m</span><span class="op" id="5482313">.</span><span class="ident" id="5482314">Palette</span><span class="op" id="5482321">)</span>&nbsp;<span class="op" id="5482323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482331">return</span>&nbsp;<span class="ident" id="5482338">errBadPixel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482366">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5482372">//&nbsp;Undo&nbsp;the&nbsp;interlacing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482413">if</span>&nbsp;<span class="ident" id="5482416">d</span><span class="op" id="5482417">.</span><span class="ident" id="5482418">imageFields</span><span class="op" id="5482429">&amp;</span><span class="ident" id="5482430">ifInterlace</span>&nbsp;<span class="op" id="5482442">!=</span>&nbsp;<span class="num" id="5482445">0</span>&nbsp;<span class="op" id="5482447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482453">uninterlace</span><span class="op" id="5482464">(</span><span class="ident" id="5482465">m</span><span class="op" id="5482466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482471">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482477">d</span><span class="op" id="5482478">.</span><span class="ident" id="5482479">image</span>&nbsp;<span class="op" id="5482485">=</span>&nbsp;<span class="builtinfunc" id="5482487">append</span><span class="op" id="5482493">(</span><span class="ident" id="5482494">d</span><span class="op" id="5482495">.</span><span class="ident" id="5482496">image</span><span class="op" id="5482501">,</span>&nbsp;<span class="ident" id="5482503">m</span><span class="op" id="5482504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482509">d</span><span class="op" id="5482510">.</span><span class="ident" id="5482511">delay</span>&nbsp;<span class="op" id="5482517">=</span>&nbsp;<span class="builtinfunc" id="5482519">append</span><span class="op" id="5482525">(</span><span class="ident" id="5482526">d</span><span class="op" id="5482527">.</span><span class="ident" id="5482528">delay</span><span class="op" id="5482533">,</span>&nbsp;<span class="ident" id="5482535">d</span><span class="op" id="5482536">.</span><span class="ident" id="5482537">delayTime</span><span class="op" id="5482546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5482551">//&nbsp;The&nbsp;GIF89a&nbsp;spec,&nbsp;Section&nbsp;23&nbsp;(Graphic&nbsp;Control&nbsp;Extension)&nbsp;says:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5482619">//&nbsp;&#34;The&nbsp;scope&nbsp;of&nbsp;this&nbsp;extension&nbsp;is&nbsp;the&nbsp;first&nbsp;graphic&nbsp;rendering&nbsp;block</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5482691">//&nbsp;to&nbsp;follow.&#34;&nbsp;We&nbsp;therefore&nbsp;reset&nbsp;the&nbsp;GCE&nbsp;fields&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482752">d</span><span class="op" id="5482753">.</span><span class="ident" id="5482754">delayTime</span>&nbsp;<span class="op" id="5482764">=</span>&nbsp;<span class="num" id="5482766">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482771">d</span><span class="op" id="5482772">.</span><span class="ident" id="5482773">hasTransparentIndex</span>&nbsp;<span class="op" id="5482793">=</span>&nbsp;<span class="ident" id="5482795">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482804">case</span>&nbsp;<span class="ident" id="5482809">sTrailer</span><span class="op" id="5482817">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482822">if</span>&nbsp;<span class="builtinfunc" id="5482825">len</span><span class="op" id="5482828">(</span><span class="ident" id="5482829">d</span><span class="op" id="5482830">.</span><span class="ident" id="5482831">image</span><span class="op" id="5482836">)</span>&nbsp;<span class="op" id="5482838">==</span>&nbsp;<span class="num" id="5482841">0</span>&nbsp;<span class="op" id="5482843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482849">return</span>&nbsp;<span class="ident" id="5482856">io</span><span class="op" id="5482858">.</span><span class="ident" id="5482859">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482884">return</span>&nbsp;<span class="ident" id="5482891">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482898">default</span><span class="op" id="5482905">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482910">return</span>&nbsp;<span class="ident" id="5482917">fmt</span><span class="op" id="5482920">.</span><span class="ident" id="5482921">Errorf</span><span class="op" id="5482927">(</span><span class="string" id="5482928">&#34;gif:&nbsp;unknown&nbsp;block&nbsp;type:&nbsp;0x%.2x&#34;</span><span class="op" id="5482961">,</span>&nbsp;<span class="ident" id="5482963">c</span><span class="op" id="5482964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482971">}</span><br>
<span class="lineno"></span><span class="op" id="5482973">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="5482976">func</span>&nbsp;<span class="op" id="5482981">(</span><span class="ident" id="5482982">d</span>&nbsp;<span class="op" id="5482984">*</span><span class="ident" id="5482985">decoder</span><span class="op" id="5482992">)</span>&nbsp;<span class="ident" id="5482994">readHeaderAndScreenDescriptor</span><span class="op" id="5483023">(</span><span class="op" id="5483024">)</span>&nbsp;<span class="builtintype" id="5483026">error</span>&nbsp;<span class="op" id="5483032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483035">_</span><span class="op" id="5483036">,</span>&nbsp;<span class="ident" id="5483038">err</span>&nbsp;<span class="op" id="5483042">:=</span>&nbsp;<span class="ident" id="5483045">io</span><span class="op" id="5483047">.</span><span class="ident" id="5483048">ReadFull</span><span class="op" id="5483056">(</span><span class="ident" id="5483057">d</span><span class="op" id="5483058">.</span><span class="ident" id="5483059">r</span><span class="op" id="5483060">,</span>&nbsp;<span class="ident" id="5483062">d</span><span class="op" id="5483063">.</span><span class="ident" id="5483064">tmp</span><span class="op" id="5483067">[</span><span class="num" id="5483068">0</span><span class="op" id="5483069">:</span><span class="num" id="5483070">13</span><span class="op" id="5483072">]</span><span class="op" id="5483073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5483076">if</span>&nbsp;<span class="ident" id="5483079">err</span>&nbsp;<span class="op" id="5483083">!=</span>&nbsp;<span class="ident" id="5483086">nil</span>&nbsp;<span class="op" id="5483090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5483094">return</span>&nbsp;<span class="ident" id="5483101">err</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5483106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483109">d</span><span class="op" id="5483110">.</span><span class="ident" id="5483111">vers</span>&nbsp;<span class="op" id="5483116">=</span>&nbsp;<span class="builtintype" id="5483118">string</span><span class="op" id="5483124">(</span><span class="ident" id="5483125">d</span><span class="op" id="5483126">.</span><span class="ident" id="5483127">tmp</span><span class="op" id="5483130">[</span><span class="num" id="5483131">0</span><span class="op" id="5483132">:</span><span class="num" id="5483133">6</span><span class="op" id="5483134">]</span><span class="op" id="5483135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5483138">if</span>&nbsp;<span class="ident" id="5483141">d</span><span class="op" id="5483142">.</span><span class="ident" id="5483143">vers</span>&nbsp;<span class="op" id="5483148">!=</span>&nbsp;<span class="string" id="5483151">&#34;GIF87a&#34;</span>&nbsp;<span class="op" id="5483160">&amp;&amp;</span>&nbsp;<span class="ident" id="5483163">d</span><span class="op" id="5483164">.</span><span class="ident" id="5483165">vers</span>&nbsp;<span class="op" id="5483170">!=</span>&nbsp;<span class="string" id="5483173">&#34;GIF89a&#34;</span>&nbsp;<span class="op" id="5483182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5483186">return</span>&nbsp;<span class="ident" id="5483193">fmt</span><span class="op" id="5483196">.</span><span class="ident" id="5483197">Errorf</span><span class="op" id="5483203">(</span><span class="string" id="5483204">&#34;gif:&nbsp;can&#39;t&nbsp;recognize&nbsp;format&nbsp;%s&#34;</span><span class="op" id="5483236">,</span>&nbsp;<span class="ident" id="5483238">d</span><span class="op" id="5483239">.</span><span class="ident" id="5483240">vers</span><span class="op" id="5483244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5483247">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483250">d</span><span class="op" id="5483251">.</span><span class="ident" id="5483252">width</span>&nbsp;<span class="op" id="5483258">=</span>&nbsp;<span class="builtintype" id="5483260">int</span><span class="op" id="5483263">(</span><span class="ident" id="5483264">d</span><span class="op" id="5483265">.</span><span class="ident" id="5483266">tmp</span><span class="op" id="5483269">[</span><span class="num" id="5483270">6</span><span class="op" id="5483271">]</span><span class="op" id="5483272">)</span>&nbsp;<span class="op" id="5483274">+</span>&nbsp;<span class="builtintype" id="5483276">int</span><span class="op" id="5483279">(</span><span class="ident" id="5483280">d</span><span class="op" id="5483281">.</span><span class="ident" id="5483282">tmp</span><span class="op" id="5483285">[</span><span class="num" id="5483286">7</span><span class="op" id="5483287">]</span><span class="op" id="5483288">)</span><span class="op" id="5483289">&lt;&lt;</span><span class="num" id="5483291">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483294">d</span><span class="op" id="5483295">.</span><span class="ident" id="5483296">height</span>&nbsp;<span class="op" id="5483303">=</span>&nbsp;<span class="builtintype" id="5483305">int</span><span class="op" id="5483308">(</span><span class="ident" id="5483309">d</span><span class="op" id="5483310">.</span><span class="ident" id="5483311">tmp</span><span class="op" id="5483314">[</span><span class="num" id="5483315">8</span><span class="op" id="5483316">]</span><span class="op" id="5483317">)</span>&nbsp;<span class="op" id="5483319">+</span>&nbsp;<span class="builtintype" id="5483321">int</span><span class="op" id="5483324">(</span><span class="ident" id="5483325">d</span><span class="op" id="5483326">.</span><span class="ident" id="5483327">tmp</span><span class="op" id="5483330">[</span><span class="num" id="5483331">9</span><span class="op" id="5483332">]</span><span class="op" id="5483333">)</span><span class="op" id="5483334">&lt;&lt;</span><span class="num" id="5483336">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483339">d</span><span class="op" id="5483340">.</span><span class="ident" id="5483341">headerFields</span>&nbsp;<span class="op" id="5483354">=</span>&nbsp;<span class="ident" id="5483356">d</span><span class="op" id="5483357">.</span><span class="ident" id="5483358">tmp</span><span class="op" id="5483361">[</span><span class="num" id="5483362">10</span><span class="op" id="5483364">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483367">d</span><span class="op" id="5483368">.</span><span class="ident" id="5483369">backgroundIndex</span>&nbsp;<span class="op" id="5483385">=</span>&nbsp;<span class="ident" id="5483387">d</span><span class="op" id="5483388">.</span><span class="ident" id="5483389">tmp</span><span class="op" id="5483392">[</span><span class="num" id="5483393">11</span><span class="op" id="5483395">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483398">d</span><span class="op" id="5483399">.</span><span class="ident" id="5483400">aspect</span>&nbsp;<span class="op" id="5483407">=</span>&nbsp;<span class="ident" id="5483409">d</span><span class="op" id="5483410">.</span><span class="ident" id="5483411">tmp</span><span class="op" id="5483414">[</span><span class="num" id="5483415">12</span><span class="op" id="5483417">]</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483420">d</span><span class="op" id="5483421">.</span><span class="ident" id="5483422">loopCount</span>&nbsp;<span class="op" id="5483432">=</span>&nbsp;<span class="op" id="5483434">-</span><span class="num" id="5483435">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483438">d</span><span class="op" id="5483439">.</span><span class="ident" id="5483440">pixelSize</span>&nbsp;<span class="op" id="5483450">=</span>&nbsp;<span class="builtintype" id="5483452">uint</span><span class="op" id="5483456">(</span><span class="ident" id="5483457">d</span><span class="op" id="5483458">.</span><span class="ident" id="5483459">headerFields</span><span class="op" id="5483471">&amp;</span><span class="num" id="5483472">7</span><span class="op" id="5483473">)</span>&nbsp;<span class="op" id="5483475">+</span>&nbsp;<span class="num" id="5483477">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5483480">return</span>&nbsp;<span class="ident" id="5483487">nil</span><br>
<span class="lineno"></span><span class="op" id="5483491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="5483494">func</span>&nbsp;<span class="op" id="5483499">(</span><span class="ident" id="5483500">d</span>&nbsp;<span class="op" id="5483502">*</span><span class="ident" id="5483503">decoder</span><span class="op" id="5483510">)</span>&nbsp;<span class="ident" id="5483512">readColorMap</span><span class="op" id="5483524">(</span><span class="op" id="5483525">)</span>&nbsp;<span class="op" id="5483527">(</span><span class="ident" id="5483528">color</span><span class="op" id="5483533">.</span><span class="ident" id="5483534">Palette</span><span class="op" id="5483541">,</span>&nbsp;<span class="builtintype" id="5483543">error</span><span class="op" id="5483548">)</span>&nbsp;<span class="op" id="5483550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5483553">if</span>&nbsp;<span class="ident" id="5483556">d</span><span class="op" id="5483557">.</span><span class="ident" id="5483558">pixelSize</span>&nbsp;<span class="op" id="5483568">&gt;</span>&nbsp;<span class="num" id="5483570">8</span>&nbsp;<span class="op" id="5483572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5483576">return</span>&nbsp;<span class="ident" id="5483583">nil</span><span class="op" id="5483586">,</span>&nbsp;<span class="ident" id="5483588">fmt</span><span class="op" id="5483591">.</span><span class="ident" id="5483592">Errorf</span><span class="op" id="5483598">(</span><span class="string" id="5483599">&#34;gif:&nbsp;can&#39;t&nbsp;handle&nbsp;%d&nbsp;bits&nbsp;per&nbsp;pixel&#34;</span><span class="op" id="5483636">,</span>&nbsp;<span class="ident" id="5483638">d</span><span class="op" id="5483639">.</span><span class="ident" id="5483640">pixelSize</span><span class="op" id="5483649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5483652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483655">numColors</span>&nbsp;<span class="op" id="5483665">:=</span>&nbsp;<span class="num" id="5483668">1</span>&nbsp;<span class="op" id="5483670">&lt;&lt;</span>&nbsp;<span class="ident" id="5483673">d</span><span class="op" id="5483674">.</span><span class="ident" id="5483675">pixelSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5483686">if</span>&nbsp;<span class="ident" id="5483689">d</span><span class="op" id="5483690">.</span><span class="ident" id="5483691">imageFields</span><span class="op" id="5483702">&amp;</span><span class="ident" id="5483703">ifLocalColorTable</span>&nbsp;<span class="op" id="5483721">!=</span>&nbsp;<span class="num" id="5483724">0</span>&nbsp;<span class="op" id="5483726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483730">numColors</span>&nbsp;<span class="op" id="5483740">=</span>&nbsp;<span class="num" id="5483742">1</span>&nbsp;<span class="op" id="5483744">&lt;&lt;</span>&nbsp;<span class="op" id="5483747">(</span><span class="op" id="5483748">(</span><span class="ident" id="5483749">d</span><span class="op" id="5483750">.</span><span class="ident" id="5483751">imageFields</span>&nbsp;<span class="op" id="5483763">&amp;</span>&nbsp;<span class="ident" id="5483765">ifPixelSizeMask</span><span class="op" id="5483780">)</span>&nbsp;<span class="op" id="5483782">+</span>&nbsp;<span class="num" id="5483784">1</span><span class="op" id="5483785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5483788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483791">numValues</span>&nbsp;<span class="op" id="5483801">:=</span>&nbsp;<span class="num" id="5483804">3</span>&nbsp;<span class="op" id="5483806">*</span>&nbsp;<span class="ident" id="5483808">numColors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483819">_</span><span class="op" id="5483820">,</span>&nbsp;<span class="ident" id="5483822">err</span>&nbsp;<span class="op" id="5483826">:=</span>&nbsp;<span class="ident" id="5483829">io</span><span class="op" id="5483831">.</span><span class="ident" id="5483832">ReadFull</span><span class="op" id="5483840">(</span><span class="ident" id="5483841">d</span><span class="op" id="5483842">.</span><span class="ident" id="5483843">r</span><span class="op" id="5483844">,</span>&nbsp;<span class="ident" id="5483846">d</span><span class="op" id="5483847">.</span><span class="ident" id="5483848">tmp</span><span class="op" id="5483851">[</span><span class="num" id="5483852">0</span><span class="op" id="5483853">:</span><span class="ident" id="5483854">numValues</span><span class="op" id="5483863">]</span><span class="op" id="5483864">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5483867">if</span>&nbsp;<span class="ident" id="5483870">err</span>&nbsp;<span class="op" id="5483874">!=</span>&nbsp;<span class="ident" id="5483877">nil</span>&nbsp;<span class="op" id="5483881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5483885">return</span>&nbsp;<span class="ident" id="5483892">nil</span><span class="op" id="5483895">,</span>&nbsp;<span class="ident" id="5483897">fmt</span><span class="op" id="5483900">.</span><span class="ident" id="5483901">Errorf</span><span class="op" id="5483907">(</span><span class="string" id="5483908">&#34;gif:&nbsp;short&nbsp;read&nbsp;on&nbsp;color&nbsp;map:&nbsp;%s&#34;</span><span class="op" id="5483942">,</span>&nbsp;<span class="ident" id="5483944">err</span><span class="op" id="5483947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5483950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483953">colorMap</span>&nbsp;<span class="op" id="5483962">:=</span>&nbsp;<span class="builtinfunc" id="5483965">make</span><span class="op" id="5483969">(</span><span class="ident" id="5483970">color</span><span class="op" id="5483975">.</span><span class="ident" id="5483976">Palette</span><span class="op" id="5483983">,</span>&nbsp;<span class="ident" id="5483985">numColors</span><span class="op" id="5483994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483997">j</span>&nbsp;<span class="op" id="5483999">:=</span>&nbsp;<span class="num" id="5484002">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484005">for</span>&nbsp;<span class="ident" id="5484009">i</span>&nbsp;<span class="op" id="5484011">:=</span>&nbsp;<span class="keyword" id="5484014">range</span>&nbsp;<span class="ident" id="5484020">colorMap</span>&nbsp;<span class="op" id="5484029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484033">colorMap</span><span class="op" id="5484041">[</span><span class="ident" id="5484042">i</span><span class="op" id="5484043">]</span>&nbsp;<span class="op" id="5484045">=</span>&nbsp;<span class="ident" id="5484047">color</span><span class="op" id="5484052">.</span><span class="ident" id="5484053">RGBA</span><span class="op" id="5484057">{</span><span class="ident" id="5484058">d</span><span class="op" id="5484059">.</span><span class="ident" id="5484060">tmp</span><span class="op" id="5484063">[</span><span class="ident" id="5484064">j</span><span class="op" id="5484065">+</span><span class="num" id="5484066">0</span><span class="op" id="5484067">]</span><span class="op" id="5484068">,</span>&nbsp;<span class="ident" id="5484070">d</span><span class="op" id="5484071">.</span><span class="ident" id="5484072">tmp</span><span class="op" id="5484075">[</span><span class="ident" id="5484076">j</span><span class="op" id="5484077">+</span><span class="num" id="5484078">1</span><span class="op" id="5484079">]</span><span class="op" id="5484080">,</span>&nbsp;<span class="ident" id="5484082">d</span><span class="op" id="5484083">.</span><span class="ident" id="5484084">tmp</span><span class="op" id="5484087">[</span><span class="ident" id="5484088">j</span><span class="op" id="5484089">+</span><span class="num" id="5484090">2</span><span class="op" id="5484091">]</span><span class="op" id="5484092">,</span>&nbsp;<span class="num" id="5484094">0xFF</span><span class="op" id="5484098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484102">j</span>&nbsp;<span class="op" id="5484104">+=</span>&nbsp;<span class="num" id="5484107">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5484110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484113">return</span>&nbsp;<span class="ident" id="5484120">colorMap</span><span class="op" id="5484128">,</span>&nbsp;<span class="ident" id="5484130">nil</span><br>
<span class="lineno">295</span><span class="op" id="5484134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5484137">func</span>&nbsp;<span class="op" id="5484142">(</span><span class="ident" id="5484143">d</span>&nbsp;<span class="op" id="5484145">*</span><span class="ident" id="5484146">decoder</span><span class="op" id="5484153">)</span>&nbsp;<span class="ident" id="5484155">readExtension</span><span class="op" id="5484168">(</span><span class="op" id="5484169">)</span>&nbsp;<span class="builtintype" id="5484171">error</span>&nbsp;<span class="op" id="5484177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484180">extension</span><span class="op" id="5484189">,</span>&nbsp;<span class="ident" id="5484191">err</span>&nbsp;<span class="op" id="5484195">:=</span>&nbsp;<span class="ident" id="5484198">d</span><span class="op" id="5484199">.</span><span class="ident" id="5484200">r</span><span class="op" id="5484201">.</span><span class="ident" id="5484202">ReadByte</span><span class="op" id="5484210">(</span><span class="op" id="5484211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484214">if</span>&nbsp;<span class="ident" id="5484217">err</span>&nbsp;<span class="op" id="5484221">!=</span>&nbsp;<span class="ident" id="5484224">nil</span>&nbsp;<span class="op" id="5484228">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484232">return</span>&nbsp;<span class="ident" id="5484239">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5484244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484247">size</span>&nbsp;<span class="op" id="5484252">:=</span>&nbsp;<span class="num" id="5484255">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484258">switch</span>&nbsp;<span class="ident" id="5484265">extension</span>&nbsp;<span class="op" id="5484275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484278">case</span>&nbsp;<span class="ident" id="5484283">eText</span><span class="op" id="5484288">:</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484292">size</span>&nbsp;<span class="op" id="5484297">=</span>&nbsp;<span class="num" id="5484299">13</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484303">case</span>&nbsp;<span class="ident" id="5484308">eGraphicControl</span><span class="op" id="5484323">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484327">return</span>&nbsp;<span class="ident" id="5484334">d</span><span class="op" id="5484335">.</span><span class="ident" id="5484336">readGraphicControl</span><span class="op" id="5484354">(</span><span class="op" id="5484355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484358">case</span>&nbsp;<span class="ident" id="5484363">eComment</span><span class="op" id="5484371">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5484375">//&nbsp;nothing&nbsp;to&nbsp;do&nbsp;but&nbsp;read&nbsp;the&nbsp;data.</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484412">case</span>&nbsp;<span class="ident" id="5484417">eApplication</span><span class="op" id="5484429">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484433">b</span><span class="op" id="5484434">,</span>&nbsp;<span class="ident" id="5484436">err</span>&nbsp;<span class="op" id="5484440">:=</span>&nbsp;<span class="ident" id="5484443">d</span><span class="op" id="5484444">.</span><span class="ident" id="5484445">r</span><span class="op" id="5484446">.</span><span class="ident" id="5484447">ReadByte</span><span class="op" id="5484455">(</span><span class="op" id="5484456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484460">if</span>&nbsp;<span class="ident" id="5484463">err</span>&nbsp;<span class="op" id="5484467">!=</span>&nbsp;<span class="ident" id="5484470">nil</span>&nbsp;<span class="op" id="5484474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484479">return</span>&nbsp;<span class="ident" id="5484486">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5484492">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5484496">//&nbsp;The&nbsp;spec&nbsp;requires&nbsp;size&nbsp;be&nbsp;11,&nbsp;but&nbsp;Adobe&nbsp;sometimes&nbsp;uses&nbsp;10.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484560">size</span>&nbsp;<span class="op" id="5484565">=</span>&nbsp;<span class="builtintype" id="5484567">int</span><span class="op" id="5484570">(</span><span class="ident" id="5484571">b</span><span class="op" id="5484572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484575">default</span><span class="op" id="5484582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484586">return</span>&nbsp;<span class="ident" id="5484593">fmt</span><span class="op" id="5484596">.</span><span class="ident" id="5484597">Errorf</span><span class="op" id="5484603">(</span><span class="string" id="5484604">&#34;gif:&nbsp;unknown&nbsp;extension&nbsp;0x%.2x&#34;</span><span class="op" id="5484635">,</span>&nbsp;<span class="ident" id="5484637">extension</span><span class="op" id="5484646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5484649">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484652">if</span>&nbsp;<span class="ident" id="5484655">size</span>&nbsp;<span class="op" id="5484660">&gt;</span>&nbsp;<span class="num" id="5484662">0</span>&nbsp;<span class="op" id="5484664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484668">if</span>&nbsp;<span class="ident" id="5484671">_</span><span class="op" id="5484672">,</span>&nbsp;<span class="ident" id="5484674">err</span>&nbsp;<span class="op" id="5484678">:=</span>&nbsp;<span class="ident" id="5484681">io</span><span class="op" id="5484683">.</span><span class="ident" id="5484684">ReadFull</span><span class="op" id="5484692">(</span><span class="ident" id="5484693">d</span><span class="op" id="5484694">.</span><span class="ident" id="5484695">r</span><span class="op" id="5484696">,</span>&nbsp;<span class="ident" id="5484698">d</span><span class="op" id="5484699">.</span><span class="ident" id="5484700">tmp</span><span class="op" id="5484703">[</span><span class="num" id="5484704">0</span><span class="op" id="5484705">:</span><span class="ident" id="5484706">size</span><span class="op" id="5484710">]</span><span class="op" id="5484711">)</span><span class="op" id="5484712">;</span>&nbsp;<span class="ident" id="5484714">err</span>&nbsp;<span class="op" id="5484718">!=</span>&nbsp;<span class="ident" id="5484721">nil</span>&nbsp;<span class="op" id="5484725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484730">return</span>&nbsp;<span class="ident" id="5484737">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5484743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5484746">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5484750">//&nbsp;Application&nbsp;Extension&nbsp;with&nbsp;&#34;NETSCAPE2.0&#34;&nbsp;as&nbsp;string&nbsp;and&nbsp;1&nbsp;in&nbsp;data&nbsp;means</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5484825">//&nbsp;this&nbsp;extension&nbsp;defines&nbsp;a&nbsp;loop&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484866">if</span>&nbsp;<span class="ident" id="5484869">extension</span>&nbsp;<span class="op" id="5484879">==</span>&nbsp;<span class="ident" id="5484882">eApplication</span>&nbsp;<span class="op" id="5484895">&amp;&amp;</span>&nbsp;<span class="builtintype" id="5484898">string</span><span class="op" id="5484904">(</span><span class="ident" id="5484905">d</span><span class="op" id="5484906">.</span><span class="ident" id="5484907">tmp</span><span class="op" id="5484910">[</span><span class="op" id="5484911">:</span><span class="ident" id="5484912">size</span><span class="op" id="5484916">]</span><span class="op" id="5484917">)</span>&nbsp;<span class="op" id="5484919">==</span>&nbsp;<span class="string" id="5484922">&#34;NETSCAPE2.0&#34;</span>&nbsp;<span class="op" id="5484936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5484940">n</span><span class="op" id="5484941">,</span>&nbsp;<span class="ident" id="5484943">err</span>&nbsp;<span class="op" id="5484947">:=</span>&nbsp;<span class="ident" id="5484950">d</span><span class="op" id="5484951">.</span><span class="ident" id="5484952">readBlock</span><span class="op" id="5484961">(</span><span class="op" id="5484962">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484966">if</span>&nbsp;<span class="ident" id="5484969">n</span>&nbsp;<span class="op" id="5484971">==</span>&nbsp;<span class="num" id="5484974">0</span>&nbsp;<span class="op" id="5484976">||</span>&nbsp;<span class="ident" id="5484979">err</span>&nbsp;<span class="op" id="5484983">!=</span>&nbsp;<span class="ident" id="5484986">nil</span>&nbsp;<span class="op" id="5484990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5484995">return</span>&nbsp;<span class="ident" id="5485002">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485012">if</span>&nbsp;<span class="ident" id="5485015">n</span>&nbsp;<span class="op" id="5485017">==</span>&nbsp;<span class="num" id="5485020">3</span>&nbsp;<span class="op" id="5485022">&amp;&amp;</span>&nbsp;<span class="ident" id="5485025">d</span><span class="op" id="5485026">.</span><span class="ident" id="5485027">tmp</span><span class="op" id="5485030">[</span><span class="num" id="5485031">0</span><span class="op" id="5485032">]</span>&nbsp;<span class="op" id="5485034">==</span>&nbsp;<span class="num" id="5485037">1</span>&nbsp;<span class="op" id="5485039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485044">d</span><span class="op" id="5485045">.</span><span class="ident" id="5485046">loopCount</span>&nbsp;<span class="op" id="5485056">=</span>&nbsp;<span class="builtintype" id="5485058">int</span><span class="op" id="5485061">(</span><span class="ident" id="5485062">d</span><span class="op" id="5485063">.</span><span class="ident" id="5485064">tmp</span><span class="op" id="5485067">[</span><span class="num" id="5485068">1</span><span class="op" id="5485069">]</span><span class="op" id="5485070">)</span>&nbsp;<span class="op" id="5485072">|</span>&nbsp;<span class="builtintype" id="5485074">int</span><span class="op" id="5485077">(</span><span class="ident" id="5485078">d</span><span class="op" id="5485079">.</span><span class="ident" id="5485080">tmp</span><span class="op" id="5485083">[</span><span class="num" id="5485084">2</span><span class="op" id="5485085">]</span><span class="op" id="5485086">)</span><span class="op" id="5485087">&lt;&lt;</span><span class="num" id="5485089">8</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485099">for</span>&nbsp;<span class="op" id="5485103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485107">n</span><span class="op" id="5485108">,</span>&nbsp;<span class="ident" id="5485110">err</span>&nbsp;<span class="op" id="5485114">:=</span>&nbsp;<span class="ident" id="5485117">d</span><span class="op" id="5485118">.</span><span class="ident" id="5485119">readBlock</span><span class="op" id="5485128">(</span><span class="op" id="5485129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485133">if</span>&nbsp;<span class="ident" id="5485136">n</span>&nbsp;<span class="op" id="5485138">==</span>&nbsp;<span class="num" id="5485141">0</span>&nbsp;<span class="op" id="5485143">||</span>&nbsp;<span class="ident" id="5485146">err</span>&nbsp;<span class="op" id="5485150">!=</span>&nbsp;<span class="ident" id="5485153">nil</span>&nbsp;<span class="op" id="5485157">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485162">return</span>&nbsp;<span class="ident" id="5485169">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485178">}</span><br>
<span class="lineno"></span><span class="op" id="5485180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="keyword" id="5485183">func</span>&nbsp;<span class="op" id="5485188">(</span><span class="ident" id="5485189">d</span>&nbsp;<span class="op" id="5485191">*</span><span class="ident" id="5485192">decoder</span><span class="op" id="5485199">)</span>&nbsp;<span class="ident" id="5485201">readGraphicControl</span><span class="op" id="5485219">(</span><span class="op" id="5485220">)</span>&nbsp;<span class="builtintype" id="5485222">error</span>&nbsp;<span class="op" id="5485228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485231">if</span>&nbsp;<span class="ident" id="5485234">_</span><span class="op" id="5485235">,</span>&nbsp;<span class="ident" id="5485237">err</span>&nbsp;<span class="op" id="5485241">:=</span>&nbsp;<span class="ident" id="5485244">io</span><span class="op" id="5485246">.</span><span class="ident" id="5485247">ReadFull</span><span class="op" id="5485255">(</span><span class="ident" id="5485256">d</span><span class="op" id="5485257">.</span><span class="ident" id="5485258">r</span><span class="op" id="5485259">,</span>&nbsp;<span class="ident" id="5485261">d</span><span class="op" id="5485262">.</span><span class="ident" id="5485263">tmp</span><span class="op" id="5485266">[</span><span class="num" id="5485267">0</span><span class="op" id="5485268">:</span><span class="num" id="5485269">6</span><span class="op" id="5485270">]</span><span class="op" id="5485271">)</span><span class="op" id="5485272">;</span>&nbsp;<span class="ident" id="5485274">err</span>&nbsp;<span class="op" id="5485278">!=</span>&nbsp;<span class="ident" id="5485281">nil</span>&nbsp;<span class="op" id="5485285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485289">return</span>&nbsp;<span class="ident" id="5485296">fmt</span><span class="op" id="5485299">.</span><span class="ident" id="5485300">Errorf</span><span class="op" id="5485306">(</span><span class="string" id="5485307">&#34;gif:&nbsp;can&#39;t&nbsp;read&nbsp;graphic&nbsp;control:&nbsp;%s&#34;</span><span class="op" id="5485344">,</span>&nbsp;<span class="ident" id="5485346">err</span><span class="op" id="5485349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485355">d</span><span class="op" id="5485356">.</span><span class="ident" id="5485357">flags</span>&nbsp;<span class="op" id="5485363">=</span>&nbsp;<span class="ident" id="5485365">d</span><span class="op" id="5485366">.</span><span class="ident" id="5485367">tmp</span><span class="op" id="5485370">[</span><span class="num" id="5485371">1</span><span class="op" id="5485372">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485375">d</span><span class="op" id="5485376">.</span><span class="ident" id="5485377">delayTime</span>&nbsp;<span class="op" id="5485387">=</span>&nbsp;<span class="builtintype" id="5485389">int</span><span class="op" id="5485392">(</span><span class="ident" id="5485393">d</span><span class="op" id="5485394">.</span><span class="ident" id="5485395">tmp</span><span class="op" id="5485398">[</span><span class="num" id="5485399">2</span><span class="op" id="5485400">]</span><span class="op" id="5485401">)</span>&nbsp;<span class="op" id="5485403">|</span>&nbsp;<span class="builtintype" id="5485405">int</span><span class="op" id="5485408">(</span><span class="ident" id="5485409">d</span><span class="op" id="5485410">.</span><span class="ident" id="5485411">tmp</span><span class="op" id="5485414">[</span><span class="num" id="5485415">3</span><span class="op" id="5485416">]</span><span class="op" id="5485417">)</span><span class="op" id="5485418">&lt;&lt;</span><span class="num" id="5485420">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485423">if</span>&nbsp;<span class="ident" id="5485426">d</span><span class="op" id="5485427">.</span><span class="ident" id="5485428">flags</span><span class="op" id="5485433">&amp;</span><span class="ident" id="5485434">gcTransparentColorSet</span>&nbsp;<span class="op" id="5485456">!=</span>&nbsp;<span class="num" id="5485459">0</span>&nbsp;<span class="op" id="5485461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485465">d</span><span class="op" id="5485466">.</span><span class="ident" id="5485467">transparentIndex</span>&nbsp;<span class="op" id="5485484">=</span>&nbsp;<span class="ident" id="5485486">d</span><span class="op" id="5485487">.</span><span class="ident" id="5485488">tmp</span><span class="op" id="5485491">[</span><span class="num" id="5485492">4</span><span class="op" id="5485493">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485497">d</span><span class="op" id="5485498">.</span><span class="ident" id="5485499">hasTransparentIndex</span>&nbsp;<span class="op" id="5485519">=</span>&nbsp;<span class="ident" id="5485521">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485527">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485530">return</span>&nbsp;<span class="ident" id="5485537">nil</span><br>
<span class="lineno"></span><span class="op" id="5485541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5485544">func</span>&nbsp;<span class="op" id="5485549">(</span><span class="ident" id="5485550">d</span>&nbsp;<span class="op" id="5485552">*</span><span class="ident" id="5485553">decoder</span><span class="op" id="5485560">)</span>&nbsp;<span class="ident" id="5485562">newImageFromDescriptor</span><span class="op" id="5485584">(</span><span class="op" id="5485585">)</span>&nbsp;<span class="op" id="5485587">(</span><span class="op" id="5485588">*</span><span class="ident" id="5485589">image</span><span class="op" id="5485594">.</span><span class="ident" id="5485595">Paletted</span><span class="op" id="5485603">,</span>&nbsp;<span class="builtintype" id="5485605">error</span><span class="op" id="5485610">)</span>&nbsp;<span class="op" id="5485612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485615">if</span>&nbsp;<span class="ident" id="5485618">_</span><span class="op" id="5485619">,</span>&nbsp;<span class="ident" id="5485621">err</span>&nbsp;<span class="op" id="5485625">:=</span>&nbsp;<span class="ident" id="5485628">io</span><span class="op" id="5485630">.</span><span class="ident" id="5485631">ReadFull</span><span class="op" id="5485639">(</span><span class="ident" id="5485640">d</span><span class="op" id="5485641">.</span><span class="ident" id="5485642">r</span><span class="op" id="5485643">,</span>&nbsp;<span class="ident" id="5485645">d</span><span class="op" id="5485646">.</span><span class="ident" id="5485647">tmp</span><span class="op" id="5485650">[</span><span class="num" id="5485651">0</span><span class="op" id="5485652">:</span><span class="num" id="5485653">9</span><span class="op" id="5485654">]</span><span class="op" id="5485655">)</span><span class="op" id="5485656">;</span>&nbsp;<span class="ident" id="5485658">err</span>&nbsp;<span class="op" id="5485662">!=</span>&nbsp;<span class="ident" id="5485665">nil</span>&nbsp;<span class="op" id="5485669">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5485673">return</span>&nbsp;<span class="ident" id="5485680">nil</span><span class="op" id="5485683">,</span>&nbsp;<span class="ident" id="5485685">fmt</span><span class="op" id="5485688">.</span><span class="ident" id="5485689">Errorf</span><span class="op" id="5485695">(</span><span class="string" id="5485696">&#34;gif:&nbsp;can&#39;t&nbsp;read&nbsp;image&nbsp;descriptor:&nbsp;%s&#34;</span><span class="op" id="5485734">,</span>&nbsp;<span class="ident" id="5485736">err</span><span class="op" id="5485739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5485742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485745">left</span>&nbsp;<span class="op" id="5485750">:=</span>&nbsp;<span class="builtintype" id="5485753">int</span><span class="op" id="5485756">(</span><span class="ident" id="5485757">d</span><span class="op" id="5485758">.</span><span class="ident" id="5485759">tmp</span><span class="op" id="5485762">[</span><span class="num" id="5485763">0</span><span class="op" id="5485764">]</span><span class="op" id="5485765">)</span>&nbsp;<span class="op" id="5485767">+</span>&nbsp;<span class="builtintype" id="5485769">int</span><span class="op" id="5485772">(</span><span class="ident" id="5485773">d</span><span class="op" id="5485774">.</span><span class="ident" id="5485775">tmp</span><span class="op" id="5485778">[</span><span class="num" id="5485779">1</span><span class="op" id="5485780">]</span><span class="op" id="5485781">)</span><span class="op" id="5485782">&lt;&lt;</span><span class="num" id="5485784">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485787">top</span>&nbsp;<span class="op" id="5485791">:=</span>&nbsp;<span class="builtintype" id="5485794">int</span><span class="op" id="5485797">(</span><span class="ident" id="5485798">d</span><span class="op" id="5485799">.</span><span class="ident" id="5485800">tmp</span><span class="op" id="5485803">[</span><span class="num" id="5485804">2</span><span class="op" id="5485805">]</span><span class="op" id="5485806">)</span>&nbsp;<span class="op" id="5485808">+</span>&nbsp;<span class="builtintype" id="5485810">int</span><span class="op" id="5485813">(</span><span class="ident" id="5485814">d</span><span class="op" id="5485815">.</span><span class="ident" id="5485816">tmp</span><span class="op" id="5485819">[</span><span class="num" id="5485820">3</span><span class="op" id="5485821">]</span><span class="op" id="5485822">)</span><span class="op" id="5485823">&lt;&lt;</span><span class="num" id="5485825">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485828">width</span>&nbsp;<span class="op" id="5485834">:=</span>&nbsp;<span class="builtintype" id="5485837">int</span><span class="op" id="5485840">(</span><span class="ident" id="5485841">d</span><span class="op" id="5485842">.</span><span class="ident" id="5485843">tmp</span><span class="op" id="5485846">[</span><span class="num" id="5485847">4</span><span class="op" id="5485848">]</span><span class="op" id="5485849">)</span>&nbsp;<span class="op" id="5485851">+</span>&nbsp;<span class="builtintype" id="5485853">int</span><span class="op" id="5485856">(</span><span class="ident" id="5485857">d</span><span class="op" id="5485858">.</span><span class="ident" id="5485859">tmp</span><span class="op" id="5485862">[</span><span class="num" id="5485863">5</span><span class="op" id="5485864">]</span><span class="op" id="5485865">)</span><span class="op" id="5485866">&lt;&lt;</span><span class="num" id="5485868">8</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485871">height</span>&nbsp;<span class="op" id="5485878">:=</span>&nbsp;<span class="builtintype" id="5485881">int</span><span class="op" id="5485884">(</span><span class="ident" id="5485885">d</span><span class="op" id="5485886">.</span><span class="ident" id="5485887">tmp</span><span class="op" id="5485890">[</span><span class="num" id="5485891">6</span><span class="op" id="5485892">]</span><span class="op" id="5485893">)</span>&nbsp;<span class="op" id="5485895">+</span>&nbsp;<span class="builtintype" id="5485897">int</span><span class="op" id="5485900">(</span><span class="ident" id="5485901">d</span><span class="op" id="5485902">.</span><span class="ident" id="5485903">tmp</span><span class="op" id="5485906">[</span><span class="num" id="5485907">7</span><span class="op" id="5485908">]</span><span class="op" id="5485909">)</span><span class="op" id="5485910">&lt;&lt;</span><span class="num" id="5485912">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5485915">d</span><span class="op" id="5485916">.</span><span class="ident" id="5485917">imageFields</span>&nbsp;<span class="op" id="5485929">=</span>&nbsp;<span class="ident" id="5485931">d</span><span class="op" id="5485932">.</span><span class="ident" id="5485933">tmp</span><span class="op" id="5485936">[</span><span class="num" id="5485937">8</span><span class="op" id="5485938">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5485942">//&nbsp;The&nbsp;GIF89a&nbsp;spec,&nbsp;Section&nbsp;20&nbsp;(Image&nbsp;Descriptor)&nbsp;says:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5485999">//&nbsp;&#34;Each&nbsp;image&nbsp;must&nbsp;fit&nbsp;within&nbsp;the&nbsp;boundaries&nbsp;of&nbsp;the&nbsp;Logical</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5486061">//&nbsp;Screen,&nbsp;as&nbsp;defined&nbsp;in&nbsp;the&nbsp;Logical&nbsp;Screen&nbsp;Descriptor.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5486119">bounds</span>&nbsp;<span class="op" id="5486126">:=</span>&nbsp;<span class="ident" id="5486129">image</span><span class="op" id="5486134">.</span><span class="ident" id="5486135">Rect</span><span class="op" id="5486139">(</span><span class="ident" id="5486140">left</span><span class="op" id="5486144">,</span>&nbsp;<span class="ident" id="5486146">top</span><span class="op" id="5486149">,</span>&nbsp;<span class="ident" id="5486151">left</span><span class="op" id="5486155">+</span><span class="ident" id="5486156">width</span><span class="op" id="5486161">,</span>&nbsp;<span class="ident" id="5486163">top</span><span class="op" id="5486166">+</span><span class="ident" id="5486167">height</span><span class="op" id="5486173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486176">if</span>&nbsp;<span class="ident" id="5486179">bounds</span>&nbsp;<span class="op" id="5486186">!=</span>&nbsp;<span class="ident" id="5486189">bounds</span><span class="op" id="5486195">.</span><span class="ident" id="5486196">Intersect</span><span class="op" id="5486205">(</span><span class="ident" id="5486206">image</span><span class="op" id="5486211">.</span><span class="ident" id="5486212">Rect</span><span class="op" id="5486216">(</span><span class="num" id="5486217">0</span><span class="op" id="5486218">,</span>&nbsp;<span class="num" id="5486220">0</span><span class="op" id="5486221">,</span>&nbsp;<span class="ident" id="5486223">d</span><span class="op" id="5486224">.</span><span class="ident" id="5486225">width</span><span class="op" id="5486230">,</span>&nbsp;<span class="ident" id="5486232">d</span><span class="op" id="5486233">.</span><span class="ident" id="5486234">height</span><span class="op" id="5486240">)</span><span class="op" id="5486241">)</span>&nbsp;<span class="op" id="5486243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486247">return</span>&nbsp;<span class="ident" id="5486254">nil</span><span class="op" id="5486257">,</span>&nbsp;<span class="ident" id="5486259">errors</span><span class="op" id="5486265">.</span><span class="ident" id="5486266">New</span><span class="op" id="5486269">(</span><span class="string" id="5486270">&#34;gif:&nbsp;frame&nbsp;bounds&nbsp;larger&nbsp;than&nbsp;image&nbsp;bounds&#34;</span><span class="op" id="5486314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5486317">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486320">return</span>&nbsp;<span class="ident" id="5486327">image</span><span class="op" id="5486332">.</span><span class="ident" id="5486333">NewPaletted</span><span class="op" id="5486344">(</span><span class="ident" id="5486345">bounds</span><span class="op" id="5486351">,</span>&nbsp;<span class="ident" id="5486353">nil</span><span class="op" id="5486356">)</span><span class="op" id="5486357">,</span>&nbsp;<span class="ident" id="5486359">nil</span><br>
<span class="lineno"></span><span class="op" id="5486363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5486366">func</span>&nbsp;<span class="op" id="5486371">(</span><span class="ident" id="5486372">d</span>&nbsp;<span class="op" id="5486374">*</span><span class="ident" id="5486375">decoder</span><span class="op" id="5486382">)</span>&nbsp;<span class="ident" id="5486384">readBlock</span><span class="op" id="5486393">(</span><span class="op" id="5486394">)</span>&nbsp;<span class="op" id="5486396">(</span><span class="builtintype" id="5486397">int</span><span class="op" id="5486400">,</span>&nbsp;<span class="builtintype" id="5486402">error</span><span class="op" id="5486407">)</span>&nbsp;<span class="op" id="5486409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5486412">n</span><span class="op" id="5486413">,</span>&nbsp;<span class="ident" id="5486415">err</span>&nbsp;<span class="op" id="5486419">:=</span>&nbsp;<span class="ident" id="5486422">d</span><span class="op" id="5486423">.</span><span class="ident" id="5486424">r</span><span class="op" id="5486425">.</span><span class="ident" id="5486426">ReadByte</span><span class="op" id="5486434">(</span><span class="op" id="5486435">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486438">if</span>&nbsp;<span class="ident" id="5486441">n</span>&nbsp;<span class="op" id="5486443">==</span>&nbsp;<span class="num" id="5486446">0</span>&nbsp;<span class="op" id="5486448">||</span>&nbsp;<span class="ident" id="5486451">err</span>&nbsp;<span class="op" id="5486455">!=</span>&nbsp;<span class="ident" id="5486458">nil</span>&nbsp;<span class="op" id="5486462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486466">return</span>&nbsp;<span class="num" id="5486473">0</span><span class="op" id="5486474">,</span>&nbsp;<span class="ident" id="5486476">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5486481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5486484">return</span>&nbsp;<span class="ident" id="5486491">io</span><span class="op" id="5486493">.</span><span class="ident" id="5486494">ReadFull</span><span class="op" id="5486502">(</span><span class="ident" id="5486503">d</span><span class="op" id="5486504">.</span><span class="ident" id="5486505">r</span><span class="op" id="5486506">,</span>&nbsp;<span class="ident" id="5486508">d</span><span class="op" id="5486509">.</span><span class="ident" id="5486510">tmp</span><span class="op" id="5486513">[</span><span class="num" id="5486514">0</span><span class="op" id="5486515">:</span><span class="ident" id="5486516">n</span><span class="op" id="5486517">]</span><span class="op" id="5486518">)</span><br>
<span class="lineno"></span><span class="op" id="5486520">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="comment" id="5486523">//&nbsp;interlaceScan&nbsp;defines&nbsp;the&nbsp;ordering&nbsp;for&nbsp;a&nbsp;pass&nbsp;of&nbsp;the&nbsp;interlace&nbsp;algorithm.</span><br>
<span class="lineno"></span><span class="keyword" id="5486600">type</span>&nbsp;<span class="ident" id="5486605">interlaceScan</span>&nbsp;<span class="keyword" id="5486619">struct</span>&nbsp;<span class="op" id="5486626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5486629">skip</span><span class="op" id="5486633">,</span>&nbsp;<span class="ident" id="5486635">start</span>&nbsp;<span class="builtintype" id="5486641">int</span><br>
<span class="lineno"></span><span class="op" id="5486645">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="5486648">//&nbsp;interlacing&nbsp;represents&nbsp;the&nbsp;set&nbsp;of&nbsp;scans&nbsp;in&nbsp;an&nbsp;interlaced&nbsp;GIF&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5486719">var</span>&nbsp;<span class="ident" id="5486723">interlacing</span>&nbsp;<span class="op" id="5486735">=</span>&nbsp;<span class="op" id="5486737">[</span><span class="op" id="5486738">]</span><span class="ident" id="5486739">interlaceScan</span><span class="op" id="5486752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5486755">{</span><span class="num" id="5486756">8</span><span class="op" id="5486757">,</span>&nbsp;<span class="num" id="5486759">0</span><span class="op" id="5486760">}</span><span class="op" id="5486761">,</span>&nbsp;<span class="comment" id="5486763">//&nbsp;Group&nbsp;1&nbsp;:&nbsp;Every&nbsp;8th.&nbsp;row,&nbsp;starting&nbsp;with&nbsp;row&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5486814">{</span><span class="num" id="5486815">8</span><span class="op" id="5486816">,</span>&nbsp;<span class="num" id="5486818">4</span><span class="op" id="5486819">}</span><span class="op" id="5486820">,</span>&nbsp;<span class="comment" id="5486822">//&nbsp;Group&nbsp;2&nbsp;:&nbsp;Every&nbsp;8th.&nbsp;row,&nbsp;starting&nbsp;with&nbsp;row&nbsp;4.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5486873">{</span><span class="num" id="5486874">4</span><span class="op" id="5486875">,</span>&nbsp;<span class="num" id="5486877">2</span><span class="op" id="5486878">}</span><span class="op" id="5486879">,</span>&nbsp;<span class="comment" id="5486881">//&nbsp;Group&nbsp;3&nbsp;:&nbsp;Every&nbsp;4th.&nbsp;row,&nbsp;starting&nbsp;with&nbsp;row&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5486932">{</span><span class="num" id="5486933">2</span><span class="op" id="5486934">,</span>&nbsp;<span class="num" id="5486936">1</span><span class="op" id="5486937">}</span><span class="op" id="5486938">,</span>&nbsp;<span class="comment" id="5486940">//&nbsp;Group&nbsp;4&nbsp;:&nbsp;Every&nbsp;2nd.&nbsp;row,&nbsp;starting&nbsp;with&nbsp;row&nbsp;1.</span><br>
<span class="lineno"></span><span class="op" id="5486990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5486993">//&nbsp;uninterlace&nbsp;rearranges&nbsp;the&nbsp;pixels&nbsp;in&nbsp;m&nbsp;to&nbsp;account&nbsp;for&nbsp;interlaced&nbsp;input.</span><br>
<span class="lineno">400</span><span class="keyword" id="5487068">func</span>&nbsp;<span class="ident" id="5487073">uninterlace</span><span class="op" id="5487084">(</span><span class="ident" id="5487085">m</span>&nbsp;<span class="op" id="5487087">*</span><span class="ident" id="5487088">image</span><span class="op" id="5487093">.</span><span class="ident" id="5487094">Paletted</span><span class="op" id="5487102">)</span>&nbsp;<span class="op" id="5487104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487107">var</span>&nbsp;<span class="ident" id="5487111">nPix</span>&nbsp;<span class="op" id="5487116">[</span><span class="op" id="5487117">]</span><span class="builtintype" id="5487118">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487125">dx</span>&nbsp;<span class="op" id="5487128">:=</span>&nbsp;<span class="ident" id="5487131">m</span><span class="op" id="5487132">.</span><span class="ident" id="5487133">Bounds</span><span class="op" id="5487139">(</span><span class="op" id="5487140">)</span><span class="op" id="5487141">.</span><span class="ident" id="5487142">Dx</span><span class="op" id="5487144">(</span><span class="op" id="5487145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487148">dy</span>&nbsp;<span class="op" id="5487151">:=</span>&nbsp;<span class="ident" id="5487154">m</span><span class="op" id="5487155">.</span><span class="ident" id="5487156">Bounds</span><span class="op" id="5487162">(</span><span class="op" id="5487163">)</span><span class="op" id="5487164">.</span><span class="ident" id="5487165">Dy</span><span class="op" id="5487167">(</span><span class="op" id="5487168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487171">nPix</span>&nbsp;<span class="op" id="5487176">=</span>&nbsp;<span class="builtinfunc" id="5487178">make</span><span class="op" id="5487182">(</span><span class="op" id="5487183">[</span><span class="op" id="5487184">]</span><span class="builtintype" id="5487185">uint8</span><span class="op" id="5487190">,</span>&nbsp;<span class="ident" id="5487192">dx</span><span class="op" id="5487194">*</span><span class="ident" id="5487195">dy</span><span class="op" id="5487197">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487200">offset</span>&nbsp;<span class="op" id="5487207">:=</span>&nbsp;<span class="num" id="5487210">0</span>&nbsp;<span class="comment" id="5487212">//&nbsp;steps&nbsp;through&nbsp;the&nbsp;input&nbsp;by&nbsp;sequential&nbsp;scan&nbsp;lines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487266">for</span>&nbsp;<span class="ident" id="5487270">_</span><span class="op" id="5487271">,</span>&nbsp;<span class="ident" id="5487273">pass</span>&nbsp;<span class="op" id="5487278">:=</span>&nbsp;<span class="keyword" id="5487281">range</span>&nbsp;<span class="ident" id="5487287">interlacing</span>&nbsp;<span class="op" id="5487299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487303">nOffset</span>&nbsp;<span class="op" id="5487311">:=</span>&nbsp;<span class="ident" id="5487314">pass</span><span class="op" id="5487318">.</span><span class="ident" id="5487319">start</span>&nbsp;<span class="op" id="5487325">*</span>&nbsp;<span class="ident" id="5487327">dx</span>&nbsp;<span class="comment" id="5487330">//&nbsp;steps&nbsp;through&nbsp;the&nbsp;output&nbsp;as&nbsp;defined&nbsp;by&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487380">for</span>&nbsp;<span class="ident" id="5487384">y</span>&nbsp;<span class="op" id="5487386">:=</span>&nbsp;<span class="ident" id="5487389">pass</span><span class="op" id="5487393">.</span><span class="ident" id="5487394">start</span><span class="op" id="5487399">;</span>&nbsp;<span class="ident" id="5487401">y</span>&nbsp;<span class="op" id="5487403">&lt;</span>&nbsp;<span class="ident" id="5487405">dy</span><span class="op" id="5487407">;</span>&nbsp;<span class="ident" id="5487409">y</span>&nbsp;<span class="op" id="5487411">+=</span>&nbsp;<span class="ident" id="5487414">pass</span><span class="op" id="5487418">.</span><span class="ident" id="5487419">skip</span>&nbsp;<span class="op" id="5487424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5487429">copy</span><span class="op" id="5487433">(</span><span class="ident" id="5487434">nPix</span><span class="op" id="5487438">[</span><span class="ident" id="5487439">nOffset</span><span class="op" id="5487446">:</span><span class="ident" id="5487447">nOffset</span><span class="op" id="5487454">+</span><span class="ident" id="5487455">dx</span><span class="op" id="5487457">]</span><span class="op" id="5487458">,</span>&nbsp;<span class="ident" id="5487460">m</span><span class="op" id="5487461">.</span><span class="ident" id="5487462">Pix</span><span class="op" id="5487465">[</span><span class="ident" id="5487466">offset</span><span class="op" id="5487472">:</span><span class="ident" id="5487473">offset</span><span class="op" id="5487479">+</span><span class="ident" id="5487480">dx</span><span class="op" id="5487482">]</span><span class="op" id="5487483">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487488">offset</span>&nbsp;<span class="op" id="5487495">+=</span>&nbsp;<span class="ident" id="5487498">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487504">nOffset</span>&nbsp;<span class="op" id="5487512">+=</span>&nbsp;<span class="ident" id="5487515">dx</span>&nbsp;<span class="op" id="5487518">*</span>&nbsp;<span class="ident" id="5487520">pass</span><span class="op" id="5487524">.</span><span class="ident" id="5487525">skip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5487532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5487535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487538">m</span><span class="op" id="5487539">.</span><span class="ident" id="5487540">Pix</span>&nbsp;<span class="op" id="5487544">=</span>&nbsp;<span class="ident" id="5487546">nPix</span><br>
<span class="lineno">415</span><span class="op" id="5487551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5487554">//&nbsp;Decode&nbsp;reads&nbsp;a&nbsp;GIF&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;the&nbsp;first&nbsp;embedded</span><br>
<span class="lineno"></span><span class="comment" id="5487620">//&nbsp;image&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="5487648">func</span>&nbsp;<span class="ident" id="5487653">Decode</span><span class="op" id="5487659">(</span><span class="ident" id="5487660">r</span>&nbsp;<span class="ident" id="5487662">io</span><span class="op" id="5487664">.</span><span class="ident" id="5487665">Reader</span><span class="op" id="5487671">)</span>&nbsp;<span class="op" id="5487673">(</span><span class="ident" id="5487674">image</span><span class="op" id="5487679">.</span><span class="ident" id="5487680">Image</span><span class="op" id="5487685">,</span>&nbsp;<span class="builtintype" id="5487687">error</span><span class="op" id="5487692">)</span>&nbsp;<span class="op" id="5487694">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487697">var</span>&nbsp;<span class="ident" id="5487701">d</span>&nbsp;<span class="ident" id="5487703">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487712">if</span>&nbsp;<span class="ident" id="5487715">err</span>&nbsp;<span class="op" id="5487719">:=</span>&nbsp;<span class="ident" id="5487722">d</span><span class="op" id="5487723">.</span><span class="ident" id="5487724">decode</span><span class="op" id="5487730">(</span><span class="ident" id="5487731">r</span><span class="op" id="5487732">,</span>&nbsp;<span class="ident" id="5487734">false</span><span class="op" id="5487739">)</span><span class="op" id="5487740">;</span>&nbsp;<span class="ident" id="5487742">err</span>&nbsp;<span class="op" id="5487746">!=</span>&nbsp;<span class="ident" id="5487749">nil</span>&nbsp;<span class="op" id="5487753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487757">return</span>&nbsp;<span class="ident" id="5487764">nil</span><span class="op" id="5487767">,</span>&nbsp;<span class="ident" id="5487769">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5487774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5487777">return</span>&nbsp;<span class="ident" id="5487784">d</span><span class="op" id="5487785">.</span><span class="ident" id="5487786">image</span><span class="op" id="5487791">[</span><span class="num" id="5487792">0</span><span class="op" id="5487793">]</span><span class="op" id="5487794">,</span>&nbsp;<span class="ident" id="5487796">nil</span><br>
<span class="lineno">425</span><span class="op" id="5487800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5487803">//&nbsp;GIF&nbsp;represents&nbsp;the&nbsp;possibly&nbsp;multiple&nbsp;images&nbsp;stored&nbsp;in&nbsp;a&nbsp;GIF&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="5487872">type</span>&nbsp;<span class="ident" id="5487877">GIF</span>&nbsp;<span class="keyword" id="5487881">struct</span>&nbsp;<span class="op" id="5487888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487891">Image</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5487901">[</span><span class="op" id="5487902">]</span><span class="op" id="5487903">*</span><span class="ident" id="5487904">image</span><span class="op" id="5487909">.</span><span class="ident" id="5487910">Paletted</span>&nbsp;<span class="comment" id="5487919">//&nbsp;The&nbsp;successive&nbsp;images.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5487946">Delay</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5487956">[</span><span class="op" id="5487957">]</span><span class="builtintype" id="5487958">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5487974">//&nbsp;The&nbsp;successive&nbsp;delay&nbsp;times,&nbsp;one&nbsp;per&nbsp;frame,&nbsp;in&nbsp;100ths&nbsp;of&nbsp;a&nbsp;second.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488044">LoopCount</span>&nbsp;<span class="builtintype" id="5488054">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5488072">//&nbsp;The&nbsp;loop&nbsp;count.</span><br>
<span class="lineno"></span><span class="op" id="5488091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5488094">//&nbsp;DecodeAll&nbsp;reads&nbsp;a&nbsp;GIF&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;the&nbsp;sequential&nbsp;frames</span><br>
<span class="lineno">435</span><span class="comment" id="5488166">//&nbsp;and&nbsp;timing&nbsp;information.</span><br>
<span class="lineno"></span><span class="keyword" id="5488193">func</span>&nbsp;<span class="ident" id="5488198">DecodeAll</span><span class="op" id="5488207">(</span><span class="ident" id="5488208">r</span>&nbsp;<span class="ident" id="5488210">io</span><span class="op" id="5488212">.</span><span class="ident" id="5488213">Reader</span><span class="op" id="5488219">)</span>&nbsp;<span class="op" id="5488221">(</span><span class="op" id="5488222">*</span><span class="ident" id="5488223">GIF</span><span class="op" id="5488226">,</span>&nbsp;<span class="builtintype" id="5488228">error</span><span class="op" id="5488233">)</span>&nbsp;<span class="op" id="5488235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488238">var</span>&nbsp;<span class="ident" id="5488242">d</span>&nbsp;<span class="ident" id="5488244">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488253">if</span>&nbsp;<span class="ident" id="5488256">err</span>&nbsp;<span class="op" id="5488260">:=</span>&nbsp;<span class="ident" id="5488263">d</span><span class="op" id="5488264">.</span><span class="ident" id="5488265">decode</span><span class="op" id="5488271">(</span><span class="ident" id="5488272">r</span><span class="op" id="5488273">,</span>&nbsp;<span class="ident" id="5488275">false</span><span class="op" id="5488280">)</span><span class="op" id="5488281">;</span>&nbsp;<span class="ident" id="5488283">err</span>&nbsp;<span class="op" id="5488287">!=</span>&nbsp;<span class="ident" id="5488290">nil</span>&nbsp;<span class="op" id="5488294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488298">return</span>&nbsp;<span class="ident" id="5488305">nil</span><span class="op" id="5488308">,</span>&nbsp;<span class="ident" id="5488310">err</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5488315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488318">gif</span>&nbsp;<span class="op" id="5488322">:=</span>&nbsp;<span class="op" id="5488325">&amp;</span><span class="ident" id="5488326">GIF</span><span class="op" id="5488329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488333">Image</span><span class="op" id="5488338">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5488344">d</span><span class="op" id="5488345">.</span><span class="ident" id="5488346">image</span><span class="op" id="5488351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488355">LoopCount</span><span class="op" id="5488364">:</span>&nbsp;<span class="ident" id="5488366">d</span><span class="op" id="5488367">.</span><span class="ident" id="5488368">loopCount</span><span class="op" id="5488377">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488381">Delay</span><span class="op" id="5488386">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5488392">d</span><span class="op" id="5488393">.</span><span class="ident" id="5488394">delay</span><span class="op" id="5488399">,</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5488402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488405">return</span>&nbsp;<span class="ident" id="5488412">gif</span><span class="op" id="5488415">,</span>&nbsp;<span class="ident" id="5488417">nil</span><br>
<span class="lineno"></span><span class="op" id="5488421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5488424">//&nbsp;DecodeConfig&nbsp;returns&nbsp;the&nbsp;global&nbsp;color&nbsp;model&nbsp;and&nbsp;dimensions&nbsp;of&nbsp;a&nbsp;GIF&nbsp;image</span><br>
<span class="lineno">450</span><span class="comment" id="5488501">//&nbsp;without&nbsp;decoding&nbsp;the&nbsp;entire&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5488539">func</span>&nbsp;<span class="ident" id="5488544">DecodeConfig</span><span class="op" id="5488556">(</span><span class="ident" id="5488557">r</span>&nbsp;<span class="ident" id="5488559">io</span><span class="op" id="5488561">.</span><span class="ident" id="5488562">Reader</span><span class="op" id="5488568">)</span>&nbsp;<span class="op" id="5488570">(</span><span class="ident" id="5488571">image</span><span class="op" id="5488576">.</span><span class="ident" id="5488577">Config</span><span class="op" id="5488583">,</span>&nbsp;<span class="builtintype" id="5488585">error</span><span class="op" id="5488590">)</span>&nbsp;<span class="op" id="5488592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488595">var</span>&nbsp;<span class="ident" id="5488599">d</span>&nbsp;<span class="ident" id="5488601">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488610">if</span>&nbsp;<span class="ident" id="5488613">err</span>&nbsp;<span class="op" id="5488617">:=</span>&nbsp;<span class="ident" id="5488620">d</span><span class="op" id="5488621">.</span><span class="ident" id="5488622">decode</span><span class="op" id="5488628">(</span><span class="ident" id="5488629">r</span><span class="op" id="5488630">,</span>&nbsp;<span class="ident" id="5488632">true</span><span class="op" id="5488636">)</span><span class="op" id="5488637">;</span>&nbsp;<span class="ident" id="5488639">err</span>&nbsp;<span class="op" id="5488643">!=</span>&nbsp;<span class="ident" id="5488646">nil</span>&nbsp;<span class="op" id="5488650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488654">return</span>&nbsp;<span class="ident" id="5488661">image</span><span class="op" id="5488666">.</span><span class="ident" id="5488667">Config</span><span class="op" id="5488673">{</span><span class="op" id="5488674">}</span><span class="op" id="5488675">,</span>&nbsp;<span class="ident" id="5488677">err</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5488682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5488685">return</span>&nbsp;<span class="ident" id="5488692">image</span><span class="op" id="5488697">.</span><span class="ident" id="5488698">Config</span><span class="op" id="5488704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488708">ColorModel</span><span class="op" id="5488718">:</span>&nbsp;<span class="ident" id="5488720">d</span><span class="op" id="5488721">.</span><span class="ident" id="5488722">globalColorMap</span><span class="op" id="5488736">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488740">Width</span><span class="op" id="5488745">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5488752">d</span><span class="op" id="5488753">.</span><span class="ident" id="5488754">width</span><span class="op" id="5488759">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488763">Height</span><span class="op" id="5488769">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5488775">d</span><span class="op" id="5488776">.</span><span class="ident" id="5488777">height</span><span class="op" id="5488783">,</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5488786">}</span><span class="op" id="5488787">,</span>&nbsp;<span class="ident" id="5488789">nil</span><br>
<span class="lineno"></span><span class="op" id="5488793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5488796">func</span>&nbsp;<span class="ident" id="5488801">init</span><span class="op" id="5488805">(</span><span class="op" id="5488806">)</span>&nbsp;<span class="op" id="5488808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5488811">image</span><span class="op" id="5488816">.</span><span class="ident" id="5488817">RegisterFormat</span><span class="op" id="5488831">(</span><span class="string" id="5488832">&#34;gif&#34;</span><span class="op" id="5488837">,</span>&nbsp;<span class="string" id="5488839">&#34;GIF8?a&#34;</span><span class="op" id="5488847">,</span>&nbsp;<span class="ident" id="5488849">Decode</span><span class="op" id="5488855">,</span>&nbsp;<span class="ident" id="5488857">DecodeConfig</span><span class="op" id="5488869">)</span><br>
<span class="lineno">465</span><span class="op" id="5488871">}</span>
</div>
</body>
</html>
